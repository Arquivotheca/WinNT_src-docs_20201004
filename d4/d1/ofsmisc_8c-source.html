<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: ofsmisc.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>ofsmisc.c</h1><a href="../../d3/d2/ofsmisc_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">//+--------------------------------------------------------------------------- </span>
00002 <span class="comment">// </span>
00003 <span class="comment">// Microsoft Windows </span>
00004 <span class="comment">// Copyright (C) Microsoft Corporation, 1992-1992 </span>
00005 <span class="comment">// </span>
00006 <span class="comment">// File:        ofsmisc.c</span>
00007 <span class="comment">//</span>
00008 <span class="comment">// Contents:    Miscellaneous OFS interfaces</span>
00009 <span class="comment">//</span>
00010 <span class="comment">//---------------------------------------------------------------------------</span>
00011 
00012 <span class="preprocessor">#include &lt;nt.h&gt;</span>
00013 <span class="preprocessor">#include &lt;ntrtl.h&gt;</span>
00014 <span class="preprocessor">#include &lt;nturtl.h&gt;</span>
00015 <span class="preprocessor">#include &lt;windows.h&gt;</span>
00016 <span class="preprocessor">#include &lt;ole2.h&gt;</span>
00017 
00018 
00019 <span class="comment">//+---------------------------------------------------------------------------</span>
00020 <span class="comment">// Function:    SynchronousNtFsControlFile</span>
00021 <span class="comment">//</span>
00022 <span class="comment">// Synopsis:    Call NtFsControlFile and wait if handle is asynchronous</span>
00023 <span class="comment">//</span>
00024 <span class="comment">// Arguments:   [h]             -- handle to file/directory/volume</span>
00025 <span class="comment">//              [pisb]          -- pointer to IO_STATUS_BLOCK</span>
00026 <span class="comment">//              [FsControlCode] -- FsControl code</span>
00027 <span class="comment">//              [pvIn]          -- optional input buffer</span>
00028 <span class="comment">//              [cbIn]          -- input buffer size</span>
00029 <span class="comment">//              [pvOut]         -- optional output buffer</span>
00030 <span class="comment">//              [cbOut]         -- output buffer size</span>
00031 <span class="comment">//</span>
00032 <span class="comment">// Returns:     Status code</span>
00033 <span class="comment">//---------------------------------------------------------------------------</span>
00034 
00035 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00036"></a><a class="code" href="../../d3/d2/ofsmisc_8c.html#a0">00036</a> <a class="code" href="../../d3/d2/ofsmisc_8c.html#a0">SynchronousNtFsControlFile</a>(
00037     IN HANDLE h,
00038     OUT IO_STATUS_BLOCK *pisb,
00039     IN ULONG FsControlCode,
00040     IN VOID *pvIn OPTIONAL,
00041     IN ULONG cbIn,
00042     OUT VOID *pvOut OPTIONAL,
00043     IN ULONG cbOut)
00044 {
00045     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00046 
00047     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d7/io_2fsctrl_8c.html#a0">NtFsControlFile</a>(
00048                     h,
00049                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00050                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00051                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00052                     pisb,
00053                     FsControlCode,
00054                     pvIn,
00055                     cbIn,
00056                     pvOut,
00057                     cbOut);
00058 
00059     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_PENDING)
00060     {
00061         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/obwait_8c.html#a4">NtWaitForSingleObject</a>(h, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00062     }
00063     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00064 }
00065 
00066 
00067 <span class="comment">//+---------------------------------------------------------------------------</span>
00068 <span class="comment">// Function:    UsnFsctl, private</span>
00069 <span class="comment">//</span>
00070 <span class="comment">// Synopsis:    Return a USN according to the passed FsControlCode</span>
00071 <span class="comment">//</span>
00072 <span class="comment">// Arguments:   [hf]            -- handle to any file/directory in volume</span>
00073 <span class="comment">//              [pusn]          -- pointer to USN to be returned</span>
00074 <span class="comment">//              [FsControlCode] -- FSCTL_OFS_USN_GENERATE or FSCTL_OFS_USN_GET_CLOSE.</span>
00075 <span class="comment">//</span>
00076 <span class="comment">// Returns:     Status code</span>
00077 <span class="comment">//---------------------------------------------------------------------------</span>
00078 
00079 <span class="preprocessor">#if defined(_CAIRO_) || DBG</span>
00080 <span class="preprocessor"></span>
00081 <span class="preprocessor">#include "iofs.h"</span>
00082 
00083 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00084 UsnFsctl(
00085     IN HANDLE hf,
00086     OUT USN *pusn,
00087     IN ULONG FsControlCode)
00088 {
00089     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00090     IO_STATUS_BLOCK isb;
00091 
00092     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d2/ofsmisc_8c.html#a0">SynchronousNtFsControlFile</a>(
00093                 hf,
00094                 &amp;isb,
00095                 FsControlCode,
00096                 NULL,                           <span class="comment">// input buffer</span>
00097                 0,                              <span class="comment">// input buffer length</span>
00098                 pusn,                           <span class="comment">// output buffer</span>
00099                 <span class="keyword">sizeof</span>(*pusn));                 <span class="comment">// output buffer length</span>
00100     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) || isb.Information == <span class="keyword">sizeof</span>(*pusn));
00101     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00102 }
00103 
00104 
00105 <span class="comment">//+---------------------------------------------------------------------------</span>
00106 <span class="comment">// Function:    OFSGetCloseUsn, public</span>
00107 <span class="comment">//</span>
00108 <span class="comment">// Synopsis:    Determine the USN associated with the passed handle.</span>
00109 <span class="comment">//</span>
00110 <span class="comment">// Arguments:   [hf]            -- handle to any file/directory in volume</span>
00111 <span class="comment">//              [pusn]          -- pointer to USN to be returned</span>
00112 <span class="comment">//</span>
00113 <span class="comment">// Returns:     Status code</span>
00114 <span class="comment">//---------------------------------------------------------------------------</span>
00115 
00116 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> NTSYSAPI NTAPI
00117 OFSGetCloseUsn(
00118     IN HANDLE hf,
00119     OUT USN *pusn)
00120 {
00121     <span class="keywordflow">return</span>(UsnFsctl(hf, pusn, FSCTL_OFS_USN_GET_CLOSE));
00122 }
00123 
00124 
00125 <span class="comment">//+---------------------------------------------------------------------------</span>
00126 <span class="comment">// Function:    RtlGenerateUsn, public</span>
00127 <span class="comment">//</span>
00128 <span class="comment">// Synopsis:    Generate and return the next USN associated with a volume.</span>
00129 <span class="comment">//</span>
00130 <span class="comment">// Arguments:   [hf]            -- handle to any file/directory in volume</span>
00131 <span class="comment">//              [pusn]          -- pointer to USN to be returned</span>
00132 <span class="comment">//</span>
00133 <span class="comment">// Returns:     Status code</span>
00134 <span class="comment">//---------------------------------------------------------------------------</span>
00135 
00136 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> NTSYSAPI NTAPI
00137 RtlGenerateUsn(
00138     IN HANDLE hf,
00139     OUT USN *pusn)
00140 {
00141     <span class="keywordflow">return</span>(UsnFsctl(hf, pusn, FSCTL_OFS_USN_GENERATE));
00142 }
00143 
00144 
00145 <span class="comment">//+---------------------------------------------------------------------------</span>
00146 <span class="comment">// Function:    OFSGetVersion, public</span>
00147 <span class="comment">//</span>
00148 <span class="comment">// Synopsis:    Determine if the passed handle resides on an OFS volume.</span>
00149 <span class="comment">//              If pversion != NULL, return the format version number.</span>
00150 <span class="comment">//</span>
00151 <span class="comment">// Arguments:   [hf]            -- handle to any file/directory in volume</span>
00152 <span class="comment">//              [pversion]      -- pointer to version (may be NULL)</span>
00153 <span class="comment">//</span>
00154 <span class="comment">// Returns:     Status code</span>
00155 <span class="comment">//</span>
00156 <span class="comment">//---------------------------------------------------------------------------</span>
00157 
00158 <span class="preprocessor">#define QuadAlign(n) (((n) + (sizeof(LONGLONG) - 1)) &amp; ~(sizeof(LONGLONG) - 1))</span>
00159 <span class="preprocessor"></span>
00160 <span class="preprocessor">#define CSTRUCT(n, type, cchname)                                       \</span>
00161 <span class="preprocessor">        (((n) * QuadAlign(sizeof(type) + (cchname) * sizeof(WCHAR)) +   \</span>
00162 <span class="preprocessor">          sizeof(type) - 1) /                                           \</span>
00163 <span class="preprocessor">         sizeof(type))</span>
00164 <span class="preprocessor"></span>
00165 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> NTSYSAPI NTAPI
00166 OFSGetVersion(HANDLE hf, ULONG *pversion)
00167 {
00168     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00169     IO_STATUS_BLOCK isb;
00170 
00171     FILE_FS_ATTRIBUTE_INFORMATION *pfai;
00172     LARGE_INTEGER faibuf[CSTRUCT(1, FILE_FS_ATTRIBUTE_INFORMATION, 32)];
00173 
00174     pfai = (FILE_FS_ATTRIBUTE_INFORMATION *) faibuf;
00175 
00176     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d2/qsfs_8c.html#a0">NtQueryVolumeInformationFile</a>(
00177                  hf,
00178                  &amp;isb,
00179                  pfai,
00180                  <span class="keyword">sizeof</span>(faibuf),
00181                  FileFsAttributeInformation);
00182     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
00183     {
00184         <span class="keywordflow">if</span> (pfai-&gt;FileSystemNameLength != 3 * <span class="keyword">sizeof</span>(WCHAR) ||
00185             pfai-&gt;FileSystemName[0] != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'O'</span> ||
00186             pfai-&gt;FileSystemName[1] != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'F'</span> ||
00187             pfai-&gt;FileSystemName[2] != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'S'</span>)
00188         {
00189             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNRECOGNIZED_VOLUME;
00190         }
00191         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pversion != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00192         {
00193 
00194             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d2/ofsmisc_8c.html#a0">SynchronousNtFsControlFile</a>(
00195                 hf,
00196                 &amp;isb,
00197                 FSCTL_OFS_VERSION,
00198                 NULL,                           <span class="comment">// input buffer</span>
00199                 0,                              <span class="comment">// input buffer length</span>
00200                 pversion,                       <span class="comment">// output buffer</span>
00201                 <span class="keyword">sizeof</span>(*pversion));             <span class="comment">// output buffer length</span>
00202 
00203             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) || isb.Information == <span class="keyword">sizeof</span>(*pversion));
00204         }
00205     }
00206     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00207 }
00208 
00209 
00210 <span class="comment">//+---------------------------------------------------------------------------</span>
00211 <span class="comment">// Function:    RtlNameToOleId, public</span>
00212 <span class="comment">//</span>
00213 <span class="comment">// Synopsis:    Translate OLENAMEs to ids</span>
00214 <span class="comment">//</span>
00215 <span class="comment">// Arguments:   [hf]            -- handle to *volume*</span>
00216 <span class="comment">//              [cbNames]       -- OLENAMES size</span>
00217 <span class="comment">//              [pon]           -- pointer to OLENAMES</span>
00218 <span class="comment">//              [pOleId]        -- pointer to output array of OleIds</span>
00219 <span class="comment">//</span>
00220 <span class="comment">// Returns:     Status code</span>
00221 <span class="comment">//</span>
00222 <span class="comment">//---------------------------------------------------------------------------</span>
00223 
00224 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> NTSYSAPI NTAPI
00225 RtlNameToOleId(
00226     IN HANDLE hf,                               <span class="comment">// must be volume handle</span>
00227     IN ULONG cbNames,
00228     IN OLENAMES <span class="keyword">const</span> *pon,
00229     OUT ULONG *pOleId)
00230 {
00231     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00232     IO_STATUS_BLOCK isb;
00233 
00234     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d2/ofsmisc_8c.html#a0">SynchronousNtFsControlFile</a>(
00235                 hf,
00236                 &amp;isb,
00237                 FSCTL_OFS_TRANSLATE_OLENAMES,
00238                 (VOID *) pon,                   <span class="comment">// input buffer</span>
00239                 cbNames,                        <span class="comment">// input buffer length</span>
00240                 pOleId,                         <span class="comment">// output buffer</span>
00241                 pon-&gt;cNames * <span class="keyword">sizeof</span>(*pOleId)); <span class="comment">// output buffer length</span>
00242     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00243 }
00244 
00245 
00246 <span class="comment">//+---------------------------------------------------------------------------</span>
00247 <span class="comment">// Function:    RtlOleIdToName, public</span>
00248 <span class="comment">//</span>
00249 <span class="comment">// Synopsis:    Translate OLEIDs to names</span>
00250 <span class="comment">//</span>
00251 <span class="comment">// Arguments:   [hf]            -- handle to *volume*</span>
00252 <span class="comment">//              [cOleId]        -- count of OleIds in array</span>
00253 <span class="comment">//              [pOleId]        -- pointer to array of OleIds</span>
00254 <span class="comment">//              [pcbNameBuf]    -- pointer to OLENAMES buffer size (updated)</span>
00255 <span class="comment">//              [pon]           -- pointer to OLENAMES buffer</span>
00256 <span class="comment">//</span>
00257 <span class="comment">// Returns:     Status code</span>
00258 <span class="comment">//</span>
00259 <span class="comment">//---------------------------------------------------------------------------</span>
00260 
00261 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> NTSYSAPI NTAPI
00262 RtlOleIdToName(
00263     IN HANDLE hf,                               <span class="comment">// must be volume handle</span>
00264     IN ULONG cOleId,
00265     IN ULONG <span class="keyword">const</span> *pOleId,
00266     IN OUT ULONG *pcbNameBuf,
00267     OUT OLENAMES *pon)
00268 {
00269     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00270     IO_STATUS_BLOCK isb;
00271 
00272     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d2/ofsmisc_8c.html#a0">SynchronousNtFsControlFile</a>(
00273                 hf,
00274                 &amp;isb,
00275                 FSCTL_OFS_TRANSLATE_OLEIDS,
00276                 (VOID *) pOleId,          <span class="comment">// input buffer</span>
00277                 cOleId * <span class="keyword">sizeof</span>(*pOleId), <span class="comment">// input buffer length</span>
00278                 pon,                      <span class="comment">// output buffer</span>
00279                 *pcbNameBuf);             <span class="comment">// output buffer length</span>
00280     *pcbNameBuf = isb.Information;
00281     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00282 }
00283 
00284 
00285 <span class="comment">//+---------------------------------------------------------------------------</span>
00286 <span class="comment">// Function:    RtlQueryQuota, public</span>
00287 <span class="comment">//</span>
00288 <span class="comment">// Synopsis:    Query Quota information for specific users</span>
00289 <span class="comment">//</span>
00290 <span class="comment">// Arguments:   [hf]    -- handle to *volume*</span>
00291 <span class="comment">//              [pcb]   -- length of buffer on input and output</span>
00292 <span class="comment">//              [pfqi]  -- pointer quota information to be filled in</span>
00293 <span class="comment">//</span>
00294 <span class="comment">// Returns:     Status code</span>
00295 <span class="comment">//</span>
00296 <span class="comment">//---------------------------------------------------------------------------</span>
00297 
00298 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> NTSYSAPI NTAPI
00299 RtlQueryQuota(
00300     IN HANDLE hf,                               <span class="comment">// must be volume handle</span>
00301     IN OUT ULONG *pcb,
00302     IN OUT FILE_QUOTA_INFORMATION *pfqi)
00303 {
00304     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00305     IO_STATUS_BLOCK isb;
00306 
00307     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d2/ofsmisc_8c.html#a0">SynchronousNtFsControlFile</a>(
00308                 hf,
00309                 &amp;isb,
00310                 FSCTL_OFS_QUERY_QUOTA,
00311                 pfqi,                   <span class="comment">// input buffer</span>
00312                 *pcb,                   <span class="comment">// input buffer length</span>
00313                 pfqi,                   <span class="comment">// output buffer</span>
00314                 *pcb);                  <span class="comment">// output buffer length</span>
00315 
00316     *pcb = isb.Information;
00317     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00318 }
00319 
00320 
00321 <span class="comment">//+---------------------------------------------------------------------------</span>
00322 <span class="comment">// Function:    RtlQueryClassId, public</span>
00323 <span class="comment">//</span>
00324 <span class="comment">// Synopsis:    Fetch the ClassId for an open handle</span>
00325 <span class="comment">//</span>
00326 <span class="comment">// Arguments:   [hf]            -- handle to file</span>
00327 <span class="comment">//              [pclsid]        -- pointer to ClassId buffer</span>
00328 <span class="comment">//</span>
00329 <span class="comment">// Returns:     Status code</span>
00330 <span class="comment">//---------------------------------------------------------------------------</span>
00331 
00332 FILE_OBJECTID_INFORMATION foiiZero;
00333 
00334 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> NTSYSAPI NTAPI
00335 RtlQueryClassId(
00336     IN HANDLE hf,
00337     OUT GUID *pclsid)
00338 {
00339     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00340     IO_STATUS_BLOCK isb;
00341     FILE_OLE_INFORMATION foi;
00342 
00343     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<span class="keyword">sizeof</span>(GUID) == <span class="keyword">sizeof</span>(foiiZero.ObjectId.Lineage));
00344     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d2/qsinfo_8c.html#a3">NtQueryInformationFile</a>(
00345                  hf,
00346                  &amp;isb,
00347                  &amp;foi,
00348                  <span class="keyword">sizeof</span>(foi),
00349                  FileOleInformation);
00350     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
00351     {
00352         <span class="keywordflow">if</span> (RtlCompareMemory(
00353                 &amp;foiiZero.ObjectId.Lineage,
00354                 &amp;foi.OleClassIdInformation.ClassId,
00355                 <span class="keyword">sizeof</span>(foiiZero.ObjectId.Lineage)) ==
00356             <span class="keyword">sizeof</span>(foiiZero.ObjectId.Lineage))
00357         {
00358             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NOT_FOUND;
00359         }
00360         <span class="keywordflow">else</span>
00361         {
00362             *pclsid = foi.OleClassIdInformation.ClassId;
00363         }
00364     }
00365     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00366 }
00367 
00368 
00369 <span class="comment">//+---------------------------------------------------------------------------</span>
00370 <span class="comment">// Function:    RtlSetClassId, public</span>
00371 <span class="comment">//</span>
00372 <span class="comment">// Synopsis:    Set the ClassId for an open handle</span>
00373 <span class="comment">//</span>
00374 <span class="comment">// Arguments:   [hf]            -- handle to file</span>
00375 <span class="comment">//              [pclsid]        -- pointer to ClassId -- NULL means delete</span>
00376 <span class="comment">//</span>
00377 <span class="comment">// Returns:     Status code</span>
00378 <span class="comment">//---------------------------------------------------------------------------</span>
00379 
00380 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> NTSYSAPI NTAPI
00381 RtlSetClassId(
00382     IN HANDLE hf,
00383     OPTIONAL IN GUID <span class="keyword">const</span> *pclsid)
00384 {
00385     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00386     IO_STATUS_BLOCK isb;
00387 
00388     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<span class="keyword">sizeof</span>(foiiZero.ObjectId.Lineage) == <span class="keyword">sizeof</span>(*pclsid));
00389     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d2/qsinfo_8c.html#a4">NtSetInformationFile</a>(
00390                  hf,
00391                  &amp;isb,
00392                  pclsid == NULL? &amp;foiiZero.ObjectId.Lineage : (VOID *) pclsid,
00393                  <span class="keyword">sizeof</span>(foiiZero.ObjectId.Lineage),
00394                  FileOleClassIdInformation);
00395     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00396 }
00397 
00398 
00399 <span class="comment">//+---------------------------------------------------------------------------</span>
00400 <span class="comment">// Function:    RtlQueryObjectId, public</span>
00401 <span class="comment">//</span>
00402 <span class="comment">// Synopsis:    Fetch the ObjectId for an open handle</span>
00403 <span class="comment">//</span>
00404 <span class="comment">// Arguments:   [hf]            -- handle to file</span>
00405 <span class="comment">//              [poid]          -- pointer to ObjectId buffer</span>
00406 <span class="comment">//</span>
00407 <span class="comment">// Returns:     Status code</span>
00408 <span class="comment">//---------------------------------------------------------------------------</span>
00409 
00410 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> NTSYSAPI NTAPI
00411 RtlQueryObjectId(
00412     IN HANDLE hf,
00413     OUT OBJECTID *poid)
00414 {
00415     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00416     IO_STATUS_BLOCK isb;
00417     FILE_OLE_INFORMATION foi;
00418 
00419     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d2/qsinfo_8c.html#a3">NtQueryInformationFile</a>(
00420                  hf,
00421                  &amp;isb,
00422                  &amp;foi,
00423                  <span class="keyword">sizeof</span>(foi),
00424                  FileOleInformation);
00425     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
00426     {
00427         <span class="keywordflow">if</span> (RtlCompareMemory(
00428                 &amp;foiiZero.ObjectId,
00429                 &amp;foi.ObjectIdInformation.ObjectId,
00430                 <span class="keyword">sizeof</span>(foiiZero.ObjectId)) == <span class="keyword">sizeof</span>(foiiZero.ObjectId))
00431         {
00432             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NOT_FOUND;
00433         }
00434         <span class="keywordflow">else</span>
00435         {
00436             *poid = foi.ObjectIdInformation.ObjectId;
00437         }
00438     }
00439     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00440 }
00441 
00442 
00443 <span class="comment">//+---------------------------------------------------------------------------</span>
00444 <span class="comment">// Function:    RtlSetObjectId, public</span>
00445 <span class="comment">//</span>
00446 <span class="comment">// Synopsis:    Set the ObjectId for an open handle</span>
00447 <span class="comment">//</span>
00448 <span class="comment">// Arguments:   [hf]            -- handle to file</span>
00449 <span class="comment">//              [poid]          -- pointer to ObjectId -- NULL means delete</span>
00450 <span class="comment">//</span>
00451 <span class="comment">// Returns:     Status code</span>
00452 <span class="comment">//---------------------------------------------------------------------------</span>
00453 
00454 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> NTSYSAPI NTAPI
00455 RtlSetObjectId(
00456     IN HANDLE hf,
00457     OPTIONAL IN OBJECTID <span class="keyword">const</span> *poid)
00458 {
00459     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00460     IO_STATUS_BLOCK isb;
00461 
00462     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<span class="keyword">sizeof</span>(foiiZero) == <span class="keyword">sizeof</span>(*poid));
00463     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d2/qsinfo_8c.html#a4">NtSetInformationFile</a>(
00464                  hf,
00465                  &amp;isb,
00466                  poid == NULL? &amp;foiiZero : (VOID *) poid,
00467                  <span class="keyword">sizeof</span>(foiiZero),
00468                  FileObjectIdInformation);
00469     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00470 }
00471 
00472 
00473 <span class="comment">//+---------------------------------------------------------------------------</span>
00474 <span class="comment">// Function:    RtlSetTunnelMode, public</span>
00475 <span class="comment">//</span>
00476 <span class="comment">// Synopsis:    Set the ObjectId tunnel mode for an OFS volume.</span>
00477 <span class="comment">//</span>
00478 <span class="comment">// Arguments:   [hVolume]       -- handle to volume</span>
00479 <span class="comment">//              [ulFlags]       -- Bits to set</span>
00480 <span class="comment">//              [ulMask]        -- Mask of bits to change</span>
00481 <span class="comment">//              [pulOld]        -- pointer to store Old flags</span>
00482 <span class="comment">//</span>
00483 <span class="comment">// Returns:     Status code</span>
00484 <span class="comment">//---------------------------------------------------------------------------</span>
00485 
00486 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00487 RtlSetTunnelMode(
00488     IN HANDLE hVolume,
00489     IN ULONG ulFlags,
00490     IN ULONG ulMask,
00491     OUT ULONG *pulOld)
00492 {
00493     TUNNELMODE tm;
00494     TUNNELMODEOUT tmo;
00495     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00496     IO_STATUS_BLOCK isb;
00497 
00498     tm.ulFlags = ulFlags;
00499     tm.ulMask = ulMask;
00500 
00501     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d2/ofsmisc_8c.html#a0">SynchronousNtFsControlFile</a>(
00502                     hVolume,                    <span class="comment">// Handle</span>
00503                     &amp;isb,                       <span class="comment">// I/O Status block</span>
00504                     FSCTL_OFS_TUNNEL_MODE,      <span class="comment">// Control code</span>
00505                     &amp;tm,                        <span class="comment">// Input buffer</span>
00506                     <span class="keyword">sizeof</span>(tm),                 <span class="comment">// Input length</span>
00507                     &amp;tmo,                       <span class="comment">// Output buffer</span>
00508                     <span class="keyword">sizeof</span>(tmo));               <span class="comment">// Output length</span>
00509 
00510     *pulOld = tmo.ulFlags;
00511     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00512 }
00513 
00514 
00515 <span class="comment">//+---------------------------------------------------------------------------</span>
00516 <span class="comment">// Function:    RtlSearchVolume, public</span>
00517 <span class="comment">//</span>
00518 <span class="comment">// Synopsis:    Search an OFS volume for files with passed ObjectId</span>
00519 <span class="comment">//</span>
00520 <span class="comment">// Arguments:   [hAncestor]     -- handle to file</span>
00521 <span class="comment">//              [poid]          -- pointer to ObjectId</span>
00522 <span class="comment">//              [cLineage]      -- Lineage count/flags</span>
00523 <span class="comment">//              [fContinue]     -- TRUE if should continue</span>
00524 <span class="comment">//              [usBufLen]      -- output buffer length</span>
00525 <span class="comment">//              [pResults]      -- output buffer</span>
00526 <span class="comment">//</span>
00527 <span class="comment">// Returns:     Status code</span>
00528 <span class="comment">//---------------------------------------------------------------------------</span>
00529 
00530 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> NTSYSAPI NTAPI
00531 RtlSearchVolume(
00532     IN HANDLE hAncestor,
00533     IN OBJECTID <span class="keyword">const</span> *poid,
00534     IN USHORT cLineage,
00535     IN BOOLEAN fContinue,
00536     IN ULONG usBufLen,
00537     OUT FINDOBJECTOUT *pfoo)
00538 {
00539     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00540     IO_STATUS_BLOCK isb;
00541 
00542     ((FINDOBJECT *) pfoo)-&gt;oid = *poid;
00543     ((FINDOBJECT *) pfoo)-&gt;cLineage = cLineage;
00544     ((FINDOBJECT *) pfoo)-&gt;ulFlags = fContinue? FO_CONTINUE_ENUM : 0;
00545 
00546     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d2/ofsmisc_8c.html#a0">SynchronousNtFsControlFile</a>(
00547                     hAncestor,                  <span class="comment">// Handle</span>
00548                     &amp;isb,                       <span class="comment">// I/O Status block</span>
00549                     FSCTL_OFS_FINDOBJECT,       <span class="comment">// Control code</span>
00550                     pfoo,                       <span class="comment">// Input buffer</span>
00551                     <span class="keyword">sizeof</span>(FINDOBJECT),         <span class="comment">// Input length</span>
00552                     pfoo,                       <span class="comment">// Output buffer</span>
00553                     usBufLen);                  <span class="comment">// Output length</span>
00554     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00555 }
00556 
00557 
00558 <span class="comment">//+---------------------------------------------------------------------------</span>
00559 <span class="comment">// Function:    RtlGenerateRelatedObjectId, public</span>
00560 <span class="comment">//</span>
00561 <span class="comment">// Synopsis:    Generate an object id which is related to the one passed in.</span>
00562 <span class="comment">//</span>
00563 <span class="comment">// Arguments:   [poidOld]       -- pointer to original ObjectId</span>
00564 <span class="comment">//              [poidNew]       -- pointer to buffer for new ObjectId</span>
00565 <span class="comment">//</span>
00566 <span class="comment">// Returns:     Status code</span>
00567 <span class="comment">//---------------------------------------------------------------------------</span>
00568 
00569 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> NTSYSAPI NTAPI
00570 RtlGenerateRelatedObjectId(
00571     IN OBJECTID <span class="keyword">const</span> *poidOld,
00572     OUT OBJECTID *poidNew)
00573 {       
00574     poidNew-&gt;Lineage = poidOld-&gt;Lineage;
00575     <span class="keywordflow">do</span>
00576     {
00577         poidNew-&gt;Uniquifier = rand();
00578     } <span class="keywordflow">while</span> (poidNew-&gt;Uniquifier == poidOld-&gt;Uniquifier);
00579 }
00580 
00581 
00582 <span class="comment">//+---------------------------------------------------------------------------</span>
00583 <span class="comment">// Function:    RtlSetReplicationState, public</span>
00584 <span class="comment">//</span>
00585 <span class="comment">// Synopsis:    Generate an object id which is related to the one passed in.</span>
00586 <span class="comment">//</span>
00587 <span class="comment">// Arguments:   [hf]            -- handle</span>
00588 <span class="comment">//</span>
00589 <span class="comment">// Returns:     Status code</span>
00590 <span class="comment">//---------------------------------------------------------------------------</span>
00591 
00592 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> NTSYSAPI NTAPI
00593 RtlSetReplicationState(
00594     IN HANDLE hf)
00595 {       
00596     IO_STATUS_BLOCK isb;
00597 
00598     <span class="keywordflow">return</span>(<a class="code" href="../../d3/d2/ofsmisc_8c.html#a0">SynchronousNtFsControlFile</a>(
00599                     hf,                         <span class="comment">// Handle</span>
00600                     &amp;isb,                       <span class="comment">// I/O Status block</span>
00601                     FSCTL_SET_REPLICATION_STATE,<span class="comment">// Control code</span>
00602                     NULL,                       <span class="comment">// Input buffer</span>
00603                     0,                          <span class="comment">// Input length</span>
00604                     NULL,                       <span class="comment">// Output buffer</span>
00605                     0));                        <span class="comment">// Output length</span>
00606 }
00607 
00608 <span class="preprocessor">#endif // _CAIRO_</span>
00609 <span class="preprocessor"></span>
00610 <span class="comment">//+---------------------------------------------------------------------------</span>
00611 <span class="comment">// Function:    _purecall, private</span>
00612 <span class="comment">//</span>
00613 <span class="comment">// Synopsis:    C++ stub</span>
00614 <span class="comment">//</span>
00615 <span class="comment">// Arguments:   NONE</span>
00616 <span class="comment">//</span>
00617 <span class="comment">// Returns:     NONE</span>
00618 <span class="comment">//</span>
00619 <span class="comment">//---------------------------------------------------------------------------</span>
00620 
00621 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> __cdecl
<a name="l00622"></a><a class="code" href="../../d3/d2/ofsmisc_8c.html#a1">00622</a> <a class="code" href="../../d6/d8/ex_2harderr_8c.html#a14">_purecall</a>(VOID)
00623 {
00624     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a8">ASSERTMSG</a>(<span class="stringliteral">"_purecall() was called"</span>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00625     <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(STATUS_NOT_IMPLEMENTED);
00626 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:06 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
