<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: cmdline.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>cmdline.c</h1><a href="../../d3/d1/server_2cmdline_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    cmdline.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">        This file implements command line editing and aliasing.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Therese Stowell (thereses) 22-Mar-1991</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:</span>
00018 <span class="comment"></span>
00019 <span class="comment">Notes:</span>
00020 <span class="comment"></span>
00021 <span class="comment">    The input model for the command line editing popups is complex.</span>
00022 <span class="comment">    Here is the relevant pseudocode:</span>
00023 <span class="comment"></span>
00024 <span class="comment">    CookedReadWaitRoutine</span>
00025 <span class="comment">        if (CookedRead-&gt;Popup)</span>
00026 <span class="comment">            Status = (*CookedRead-&gt;Popup-&gt;PopupInputRoutine)();</span>
00027 <span class="comment">            if (Status == CONSOLE_STATUS_READ_COMPLETE)</span>
00028 <span class="comment">                return STATUS_SUCCESS;</span>
00029 <span class="comment">            return Status;</span>
00030 <span class="comment"></span>
00031 <span class="comment">    CookedRead</span>
00032 <span class="comment">        if (Command Line Editing Key)</span>
00033 <span class="comment">            ProcessCommandLine</span>
00034 <span class="comment">        else</span>
00035 <span class="comment">            process regular key</span>
00036 <span class="comment"></span>
00037 <span class="comment">    ProcessCommandLine</span>
00038 <span class="comment">        if F7</span>
00039 <span class="comment">            return CommandLinePopup</span>
00040 <span class="comment"></span>
00041 <span class="comment">    CommandLinePopup</span>
00042 <span class="comment">        draw popup</span>
00043 <span class="comment">        return ProcessCommandListInput</span>
00044 <span class="comment"></span>
00045 <span class="comment">    ProcessCommandListInput</span>
00046 <span class="comment">        while (TRUE)</span>
00047 <span class="comment">            GetChar</span>
00048 <span class="comment">            if (wait)</span>
00049 <span class="comment">                return wait</span>
00050 <span class="comment">            switch (char)</span>
00051 <span class="comment">                .</span>
00052 <span class="comment">                .</span>
00053 <span class="comment">                .</span>
00054 <span class="comment"></span>
00055 <span class="comment"></span>
00056 <span class="comment">--*/</span>
00057 
00058 <span class="preprocessor">#include "<a class="code" href="../../d6/d3/w32_2ntcon_2server_2precomp_8h.html">precomp.h</a>"</span>
00059 <span class="preprocessor">#pragma hdrstop</span>
00060 <span class="preprocessor"></span>
<a name="l00061"></a><a class="code" href="../../d3/d1/server_2cmdline_8c.html#a0">00061</a> <span class="preprocessor">#define COPY_TO_CHAR_PROMPT_LENGTH 26</span>
<a name="l00062"></a><a class="code" href="../../d3/d1/server_2cmdline_8c.html#a1">00062</a> <span class="preprocessor"></span><span class="preprocessor">#define COPY_FROM_CHAR_PROMPT_LENGTH 28</span>
00063 <span class="preprocessor"></span>
<a name="l00064"></a><a class="code" href="../../d3/d1/server_2cmdline_8c.html#a2">00064</a> <span class="preprocessor">#define COMMAND_NUMBER_PROMPT_LENGTH 22</span>
<a name="l00065"></a><a class="code" href="../../d3/d1/server_2cmdline_8c.html#a3">00065</a> <span class="preprocessor"></span><span class="preprocessor">#define COMMAND_NUMBER_LENGTH 5</span>
<a name="l00066"></a><a class="code" href="../../d3/d1/server_2cmdline_8c.html#a4">00066</a> <span class="preprocessor"></span><span class="preprocessor">#define MINIMUM_COMMAND_PROMPT_SIZE COMMAND_NUMBER_LENGTH</span>
00067 <span class="preprocessor"></span>
00068 <span class="preprocessor">#if defined(FE_SB)</span>
00069 <span class="preprocessor"></span><span class="preprocessor">#define CHAR_COUNT(cch) cch</span>
00070 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00071"></a><a class="code" href="../../d3/d1/server_2cmdline_8c.html#a5">00071</a> <span class="preprocessor"></span><span class="preprocessor">#define CHAR_COUNT(cch) ((cch)/sizeof(WCHAR))</span>
00072 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00073 <span class="preprocessor"></span>
00074 
<a name="l00075"></a><a class="code" href="../../d3/d1/server_2cmdline_8c.html#a6">00075</a> <span class="preprocessor">#define ALT_PRESSED     (RIGHT_ALT_PRESSED | LEFT_ALT_PRESSED)</span>
<a name="l00076"></a><a class="code" href="../../d3/d1/server_2cmdline_8c.html#a7">00076</a> <span class="preprocessor"></span><span class="preprocessor">#define CTRL_PRESSED    (RIGHT_CTRL_PRESSED | LEFT_CTRL_PRESSED)</span>
00077 <span class="preprocessor"></span>
<a name="l00078"></a><a class="code" href="../../d3/d1/server_2cmdline_8c.html#a8">00078</a> <span class="preprocessor">#define CTRL_BUT_NOT_ALT(n) \</span>
00079 <span class="preprocessor">        (((n) &amp; (LEFT_CTRL_PRESSED | RIGHT_CTRL_PRESSED)) &amp;&amp; \</span>
00080 <span class="preprocessor">        !((n) &amp; (LEFT_ALT_PRESSED | RIGHT_ALT_PRESSED)))</span>
00081 <span class="preprocessor"></span>
00082 <span class="comment">//</span>
00083 <span class="comment">// Extended Edit Key</span>
00084 <span class="comment">//</span>
00085 
<a name="l00086"></a><a class="code" href="../../d3/d1/server_2cmdline_8c.html#a12">00086</a> ExtKeyDefTable <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a12">gaKeyDef</a>;
00087 
<a name="l00088"></a><a class="code" href="../../d3/d1/server_2cmdline_8c.html#a13">00088</a> CONST ExtKeyDefTable <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a13">gaDefaultKeyDef</a> = {
00089     {   <span class="comment">// A</span>
00090         0,                  VK_HOME,        0,      <span class="comment">// Ctrl</span>
00091         LEFT_CTRL_PRESSED,  VK_HOME,        0,      <span class="comment">// Alt</span>
00092         0,                  0,              0,      <span class="comment">// Ctrl+Alt</span>
00093     },
00094     {   <span class="comment">// B</span>
00095         0,                  VK_LEFT,        0,      <span class="comment">// Ctrl</span>
00096         LEFT_CTRL_PRESSED,  VK_LEFT,        0,      <span class="comment">// Alt</span>
00097     },
00098     {   <span class="comment">// C</span>
00099         0,
00100     },
00101     {   <span class="comment">// D</span>
00102         0,                  VK_DELETE,      0,      <span class="comment">// Ctrl</span>
00103         LEFT_CTRL_PRESSED,  VK_DELETE,      0,      <span class="comment">// Alt</span>
00104         0,                  0,              0,      <span class="comment">// Ctrl+Alt</span>
00105     },
00106     {   <span class="comment">// E</span>
00107         0,                  VK_END,         0,      <span class="comment">// Ctrl</span>
00108         LEFT_CTRL_PRESSED,  VK_END,         0,      <span class="comment">// Alt</span>
00109         0,                  0,              0,      <span class="comment">// Ctrl+Alt</span>
00110     },
00111     {   <span class="comment">// F</span>
00112         0,                  VK_RIGHT,       0,      <span class="comment">// Ctrl</span>
00113         LEFT_CTRL_PRESSED,  VK_RIGHT,       0,      <span class="comment">// Alt</span>
00114         0,                  0,              0,      <span class="comment">// Ctrl+Alt</span>
00115     },
00116     {   <span class="comment">// G</span>
00117         0,
00118     },
00119     {   <span class="comment">// H</span>
00120         0,
00121     },
00122     {   <span class="comment">// I</span>
00123         0,
00124     },
00125     {   <span class="comment">// J</span>
00126         0,
00127     },
00128     {   <span class="comment">// K</span>
00129         LEFT_CTRL_PRESSED,  VK_END,         0,      <span class="comment">// Ctrl</span>
00130     },
00131     {   <span class="comment">// L</span>
00132         0,
00133     },
00134     {   <span class="comment">// M</span>
00135         0,
00136     },
00137     {   <span class="comment">// N</span>
00138         0,                  VK_DOWN,        0,      <span class="comment">// Ctrl</span>
00139     },
00140     {   <span class="comment">// O</span>
00141         0,
00142     },
00143     {   <span class="comment">// P</span>
00144         0,                  VK_UP,          0,      <span class="comment">// Ctrl</span>
00145     },
00146     {   <span class="comment">// Q</span>
00147         0,
00148     },
00149     {   <span class="comment">// R</span>
00150         0,                  VK_F8,          0,      <span class="comment">// Ctrl</span>
00151     },
00152     {   <span class="comment">// S</span>
00153         0,                  VK_PAUSE,       0,      <span class="comment">// Ctrl</span>
00154     },
00155     {   <span class="comment">// T</span>
00156         LEFT_CTRL_PRESSED,  VK_DELETE,      0,      <span class="comment">// Ctrl</span>
00157     },
00158     {   <span class="comment">// U</span>
00159         0,                  VK_ESCAPE,      0,      <span class="comment">// Ctrl</span>
00160     },
00161     {   <span class="comment">// V</span>
00162         0,
00163     },
00164     {   <span class="comment">// W</span>
00165         LEFT_CTRL_PRESSED,  VK_BACK,        EXTKEY_ERASE_PREV_WORD,    <span class="comment">// Ctrl</span>
00166     },
00167     {   <span class="comment">// X</span>
00168         0,
00169     },
00170     {   <span class="comment">// Y</span>
00171         0,
00172     },
00173     {   <span class="comment">// Z</span>
00174         0,
00175     },
00176 };
00177 
00178 <span class="comment">//</span>
00179 <span class="comment">// InitExtendedEditKeys</span>
00180 <span class="comment">//</span>
00181 <span class="comment">// Initialize the extended edit key table.</span>
00182 <span class="comment">// If pKeyDefbuf is NULL, the internal default table is used.</span>
00183 <span class="comment">// Otherwise, lpbyte should point to a valid ExtKeyDefBuf.</span>
00184 <span class="comment">//</span>
00185 
<a name="l00186"></a><a class="code" href="../../d4/d1/cmdline_8h.html#a63">00186</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/cmdline_8h.html#a63">InitExtendedEditKeys</a>(CONST ExtKeyDefBuf* pKeyDefBuf)
00187 {
00188     CONST <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>* lpbyte;
00189     <span class="keywordtype">int</span> i;
00190     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwCheckSum;
00191 
00192     <span class="comment">//</span>
00193     <span class="comment">// Sanity check</span>
00194     <span class="comment">// If pKeyDefBuf is NULL, give it the default value.</span>
00195     <span class="comment">// If the version is not supported, just use the default and bail.</span>
00196     <span class="comment">//</span>
00197     <span class="keywordflow">if</span> (pKeyDefBuf == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || pKeyDefBuf-&gt;dwVersion != 0) {
00198 <span class="preprocessor">#if DBG</span>
00199 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (pKeyDefBuf != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00200             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"InitExtendedEditKeys: Unsupported version number(%d)\n"</span>, pKeyDefBuf-&gt;dwVersion);
00201         }
00202 <span class="preprocessor">#endif</span>
00203 <span class="preprocessor"></span>retry_clean:
00204         memcpy(<a class="code" href="../../d3/d1/server_2cmdline_8c.html#a12">gaKeyDef</a>, <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a13">gaDefaultKeyDef</a>, <span class="keyword">sizeof</span> <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a12">gaKeyDef</a>);
00205         <span class="keywordflow">return</span>;
00206     }
00207 
00208     <span class="comment">//</span>
00209     <span class="comment">// Calculate check sum</span>
00210     <span class="comment">//</span>
00211     dwCheckSum = 0;
00212     <span class="keywordflow">for</span> (lpbyte = (CONST <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>*)pKeyDefBuf, i = FIELD_OFFSET(ExtKeyDefBuf, table); i &lt; <span class="keyword">sizeof</span> *pKeyDefBuf; ++i) {
00213         dwCheckSum += lpbyte[i];
00214     }
00215     <span class="keywordflow">if</span> (dwCheckSum != pKeyDefBuf-&gt;dwCheckSum) {
00216 <span class="preprocessor">#if DBG</span>
00217 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"InitExtendedEditKeys: Checksum(%d) does not match.\n"</span>, pKeyDefBuf-&gt;dwCheckSum);
00218 <span class="preprocessor">#endif</span>
00219 <span class="preprocessor"></span>        <span class="keywordflow">goto</span> retry_clean;
00220     }
00221 
00222     <span class="comment">//</span>
00223     <span class="comment">// Copy the entity</span>
00224     <span class="comment">//</span>
00225 
00226     memcpy(<a class="code" href="../../d3/d1/server_2cmdline_8c.html#a12">gaKeyDef</a>, pKeyDefBuf-&gt;table, <span class="keyword">sizeof</span> <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a12">gaKeyDef</a>);
00227 }
00228 
<a name="l00229"></a><a class="code" href="../../d3/d1/server_2cmdline_8c.html#a17">00229</a> CONST ExtKeySubst* <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a17">ParseEditKeyInfo</a>(IN OUT PKEY_EVENT_RECORD pKeyEvent)
00230 {
00231     CONST ExtKeyDef* pKeyDef;
00232     CONST ExtKeySubst* pKeySubst;
00233 
00234     <span class="comment">//</span>
00235     <span class="comment">// If not extended mode, or Control key or Alt key is not pressed,</span>
00236     <span class="comment">// or virtual keycode is out of range, just bail.</span>
00237     <span class="comment">//</span>
00238     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a24">gExtendedEditKey</a> ||
00239             (pKeyEvent-&gt;dwControlKeyState &amp; (<a class="code" href="../../d3/d1/server_2cmdline_8c.html#a7">CTRL_PRESSED</a> | <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a6">ALT_PRESSED</a>)) == 0 ||
00240             pKeyEvent-&gt;wVirtualKeyCode &lt; <span class="charliteral">'A'</span> || pKeyEvent-&gt;wVirtualKeyCode &gt; <span class="charliteral">'Z'</span>) {
00241 
00242         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00243     }
00244 
00245     <span class="comment">//</span>
00246     <span class="comment">// Get the corresponding KeyDef.</span>
00247     <span class="comment">//</span>
00248     pKeyDef = &amp;<a class="code" href="../../d3/d1/server_2cmdline_8c.html#a12">gaKeyDef</a>[pKeyEvent-&gt;wVirtualKeyCode - <span class="charliteral">'A'</span>];
00249 
00250     <span class="comment">//</span>
00251     <span class="comment">// Get the KeySubst based on the modifier status.</span>
00252     <span class="comment">//</span>
00253     <span class="keywordflow">if</span> (pKeyEvent-&gt;dwControlKeyState &amp; <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a6">ALT_PRESSED</a>) {
00254         <span class="keywordflow">if</span> (pKeyEvent-&gt;dwControlKeyState &amp; <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a7">CTRL_PRESSED</a>) {
00255             pKeySubst = &amp;pKeyDef-&gt;keys[2];
00256         } <span class="keywordflow">else</span> {
00257             pKeySubst = &amp;pKeyDef-&gt;keys[1];
00258         }
00259     } <span class="keywordflow">else</span> {
00260         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pKeyEvent-&gt;dwControlKeyState &amp; <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a7">CTRL_PRESSED</a>);
00261         pKeySubst = &amp;pKeyDef-&gt;keys[0];
00262     }
00263 
00264     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pKeySubst);
00265 
00266     <span class="comment">//</span>
00267     <span class="comment">// If the conbination is not defined, just bail.</span>
00268     <span class="comment">//</span>
00269     <span class="keywordflow">if</span> (pKeySubst-&gt;wVirKey == 0) {
00270         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00271     }
00272 
00273     <span class="comment">//</span>
00274     <span class="comment">// Substitute the input with ext key.</span>
00275     <span class="comment">//</span>
00276     pKeyEvent-&gt;dwControlKeyState = pKeySubst-&gt;wMod;
00277     pKeyEvent-&gt;wVirtualKeyCode = pKeySubst-&gt;wVirKey;
00278     pKeyEvent-&gt;uChar.UnicodeChar = pKeySubst-&gt;wUnicodeChar;
00279 
00280     <span class="keywordflow">return</span> pKeySubst;
00281 }
00282 
00283 <span class="comment">//</span>
00284 <span class="comment">// IsPauseKey</span>
00285 <span class="comment">// returns TRUE if pKeyEvent is pause.</span>
00286 <span class="comment">// The default key is Ctrl-S if extended edit keys are not specified.</span>
00287 <span class="comment">//</span>
00288 
<a name="l00289"></a><a class="code" href="../../d4/d1/cmdline_8h.html#a64">00289</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/cmdline_8h.html#a64">IsPauseKey</a>(IN PKEY_EVENT_RECORD pKeyEvent)
00290 {
00291     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a24">gExtendedEditKey</a>) {
00292         KEY_EVENT_RECORD KeyEvent = *pKeyEvent;
00293         CONST ExtKeySubst* pKeySubst = <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a17">ParseEditKeyInfo</a>(&amp;KeyEvent);
00294 
00295         <span class="keywordflow">return</span> pKeySubst != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; pKeySubst-&gt;wVirKey == VK_PAUSE;
00296     }
00297 
00298     <span class="keywordflow">return</span> pKeyEvent-&gt;wVirtualKeyCode == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'S'</span> &amp;&amp; <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a8">CTRL_BUT_NOT_ALT</a>(pKeyEvent-&gt;dwControlKeyState);
00299 }
00300 
00301 
00302 <span class="comment">//</span>
00303 <span class="comment">// Word delimiters</span>
00304 <span class="comment">//</span>
00305 
<a name="l00306"></a><a class="code" href="../../d3/d1/server_2cmdline_8c.html#a14">00306</a> WCHAR <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a14">gaWordDelimChars</a>[<a class="code" href="../../d4/d1/cmdline_8h.html#a24">WORD_DELIM_MAX</a>];
<a name="l00307"></a><a class="code" href="../../d3/d1/server_2cmdline_8c.html#a15">00307</a> CONST WCHAR <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a15">gaWordDelimCharsDefault</a>[<a class="code" href="../../d4/d1/cmdline_8h.html#a24">WORD_DELIM_MAX</a>] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\"</span> <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"+!:=/.&lt;&gt;;|&amp;"</span>;
00308 
<a name="l00309"></a><a class="code" href="../../d4/d1/cmdline_8h.html#a65">00309</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/cmdline_8h.html#a65">IsWordDelim</a>(WCHAR wch)
00310 {
00311     <span class="keywordtype">int</span> i;
00312 
00313     <span class="comment">//</span>
00314     <span class="comment">// Before it reaches here, L' ' case should have beeen already detected,</span>
00315     <span class="comment">// and gaWordDelimChars is specified.</span>
00316     <span class="comment">//</span>
00317     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(wch != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">' '</span> &amp;&amp; <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a14">gaWordDelimChars</a>[0]);
00318 
00319     <span class="keywordflow">for</span> (i = 0; <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a14">gaWordDelimChars</a>[i] &amp;&amp; i &lt; <a class="code" href="../../d4/d1/cmdline_8h.html#a24">WORD_DELIM_MAX</a>; ++i) {
00320         <span class="keywordflow">if</span> (wch == <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a14">gaWordDelimChars</a>[i]) {
00321             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00322         }
00323     }
00324 
00325     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00326 }
00327 
00328 <a class="code" href="../../d6/d8/struct__EXE__ALIAS__LIST.html">PEXE_ALIAS_LIST</a>
<a name="l00329"></a><a class="code" href="../../d3/d1/server_2cmdline_8c.html#a20">00329</a> <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a20">AddExeAliasList</a>(
00330     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
00331     IN LPVOID ExeName,
00332     IN USHORT ExeLength, <span class="comment">// in bytes</span>
00333     IN BOOLEAN UnicodeExe
00334     )
00335 {
00336     <a class="code" href="../../d6/d8/struct__EXE__ALIAS__LIST.html">PEXE_ALIAS_LIST</a> AliasList;
00337 
00338     AliasList = (<a class="code" href="../../d6/d8/struct__EXE__ALIAS__LIST.html">PEXE_ALIAS_LIST</a>)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a11">ALIAS_TAG</a> ),<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d8/struct__EXE__ALIAS__LIST.html">EXE_ALIAS_LIST</a>));
00339     <span class="keywordflow">if</span> (AliasList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00340         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00341     }
00342     <span class="keywordflow">if</span> (UnicodeExe) {
00343         AliasList-&gt;<a class="code" href="../../d6/d8/struct__EXE__ALIAS__LIST.html#o2">ExeName</a> = (PWCHAR)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a11">ALIAS_TAG</a> ),ExeLength);
00344         <span class="keywordflow">if</span> (AliasList-&gt;<a class="code" href="../../d6/d8/struct__EXE__ALIAS__LIST.html#o2">ExeName</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00345             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(AliasList);
00346             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00347         }
00348         RtlCopyMemory(AliasList-&gt;<a class="code" href="../../d6/d8/struct__EXE__ALIAS__LIST.html#o2">ExeName</a>,ExeName,ExeLength);
00349         AliasList-&gt;<a class="code" href="../../d6/d8/struct__EXE__ALIAS__LIST.html#o1">ExeLength</a> = ExeLength;
00350     } <span class="keywordflow">else</span> {
00351         AliasList-&gt;<a class="code" href="../../d6/d8/struct__EXE__ALIAS__LIST.html#o2">ExeName</a> = (PWCHAR)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a11">ALIAS_TAG</a> ),ExeLength*<span class="keyword">sizeof</span>(WCHAR));
00352         <span class="keywordflow">if</span> (AliasList-&gt;<a class="code" href="../../d6/d8/struct__EXE__ALIAS__LIST.html#o2">ExeName</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00353             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(AliasList);
00354             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00355         }
00356         AliasList-&gt;<a class="code" href="../../d6/d8/struct__EXE__ALIAS__LIST.html#o1">ExeLength</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a36">ConvertInputToUnicode</a>(Console-&gt;CP,
00357                                                  ExeName,
00358                                                  ExeLength,
00359                                                  AliasList-&gt;<a class="code" href="../../d6/d8/struct__EXE__ALIAS__LIST.html#o2">ExeName</a>,
00360                                                  ExeLength);
00361         AliasList-&gt;<a class="code" href="../../d6/d8/struct__EXE__ALIAS__LIST.html#o1">ExeLength</a> *= 2;
00362     }
00363     InitializeListHead(&amp;AliasList-&gt;<a class="code" href="../../d6/d8/struct__EXE__ALIAS__LIST.html#o3">AliasList</a>);
00364     InsertHeadList(&amp;Console-&gt;ExeAliasList,&amp;AliasList-&gt;<a class="code" href="../../d6/d8/struct__EXE__ALIAS__LIST.html#o0">ListLink</a>);
00365     <span class="keywordflow">return</span> AliasList;
00366 }
00367 
00368 <span class="keywordtype">int</span>
<a name="l00369"></a><a class="code" href="../../d8/d5/consrv_8h.html#a262">00369</a> <a class="code" href="../../d8/d5/consrv_8h.html#a262">MyStringCompareW</a>(
00370     IN LPWSTR Str1,
00371     IN LPWSTR Str2,
00372     IN USHORT Length, <span class="comment">// in bytes</span>
00373     IN BOOLEAN bCaseInsensitive
00374     )
00375 {
00376     UNICODE_STRING <a class="code" href="../../d9/d9/tcmpmem_8c.html#a1">String1</a>;
00377     UNICODE_STRING <a class="code" href="../../d9/d9/tcmpmem_8c.html#a2">String2</a>;
00378 
00379     <a class="code" href="../../d9/d9/tcmpmem_8c.html#a1">String1</a>.Length = Length;
00380     <a class="code" href="../../d9/d9/tcmpmem_8c.html#a1">String1</a>.MaximumLength = Length;
00381     <a class="code" href="../../d9/d9/tcmpmem_8c.html#a1">String1</a>.Buffer = Str1;
00382     <a class="code" href="../../d9/d9/tcmpmem_8c.html#a2">String2</a>.Length = Length;
00383     <a class="code" href="../../d9/d9/tcmpmem_8c.html#a2">String2</a>.MaximumLength = Length;
00384     <a class="code" href="../../d9/d9/tcmpmem_8c.html#a2">String2</a>.Buffer = Str2;
00385     <span class="keywordflow">return</span> <a class="code" href="../../d6/d6/nls_8c.html#a41">RtlCompareUnicodeString</a>(&amp;<a class="code" href="../../d9/d9/tcmpmem_8c.html#a1">String1</a>,
00386                                    &amp;<a class="code" href="../../d9/d9/tcmpmem_8c.html#a2">String2</a>,
00387                                    bCaseInsensitive);
00388 }
00389 
<a name="l00390"></a><a class="code" href="../../d3/d1/server_2cmdline_8c.html#a9">00390</a> <span class="preprocessor">#define my_wcsncmpi(p1, p2, n) MyStringCompareW(p1, p2, n, TRUE)</span>
<a name="l00391"></a><a class="code" href="../../d3/d1/server_2cmdline_8c.html#a10">00391</a> <span class="preprocessor"></span><span class="preprocessor">#define my_wcsncmp(p1, p2, n)  MyStringCompareW(p1, p2, n, FALSE)</span>
00392 <span class="preprocessor"></span>
00393 <a class="code" href="../../d6/d8/struct__EXE__ALIAS__LIST.html">PEXE_ALIAS_LIST</a>
<a name="l00394"></a><a class="code" href="../../d3/d1/server_2cmdline_8c.html#a22">00394</a> <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a22">FindExe</a>(
00395     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
00396     IN LPVOID ExeName,
00397     IN USHORT ExeLength, <span class="comment">// in bytes</span>
00398     IN BOOLEAN UnicodeExe
00399     )
00400 
00401 <span class="comment">/*++</span>
00402 <span class="comment"></span>
00403 <span class="comment">    This routine searches for the specified exe alias list.  It returns</span>
00404 <span class="comment">    a pointer to the exe list if found, NULL if not found.</span>
00405 <span class="comment"></span>
00406 <span class="comment">--*/</span>
00407 
00408 {
00409     <a class="code" href="../../d6/d8/struct__EXE__ALIAS__LIST.html">PEXE_ALIAS_LIST</a> AliasList;
00410     PLIST_ENTRY ListHead, ListNext;
00411     LPWSTR UnicodeExeName;
00412 
00413 
00414     <span class="keywordflow">if</span> (UnicodeExe) {
00415         UnicodeExeName = ExeName;
00416     } <span class="keywordflow">else</span> {
00417         UnicodeExeName = (LPWSTR)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a9">TMP_TAG</a> ),ExeLength*<span class="keyword">sizeof</span>(WCHAR));
00418         <span class="keywordflow">if</span> (UnicodeExeName == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00419             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00420         ExeLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a36">ConvertInputToUnicode</a>(Console-&gt;CP,
00421                                       ExeName,
00422                                       ExeLength,
00423                                       UnicodeExeName,
00424                                       ExeLength);
00425         ExeLength *= 2;
00426     }
00427     ListHead = &amp;Console-&gt;ExeAliasList;
00428     ListNext = ListHead-&gt;Flink;
00429     <span class="keywordflow">while</span> (ListNext != ListHead) {
00430         AliasList = CONTAINING_RECORD( ListNext, <a class="code" href="../../d6/d8/struct__EXE__ALIAS__LIST.html">EXE_ALIAS_LIST</a>, ListLink );
00431         <span class="keywordflow">if</span> (AliasList-&gt;<a class="code" href="../../d6/d8/struct__EXE__ALIAS__LIST.html#o1">ExeLength</a> == ExeLength &amp;&amp;
00432             !<a class="code" href="../../d3/d1/server_2cmdline_8c.html#a9">my_wcsncmpi</a>(AliasList-&gt;<a class="code" href="../../d6/d8/struct__EXE__ALIAS__LIST.html#o2">ExeName</a>,UnicodeExeName,ExeLength)) {
00433             <span class="keywordflow">if</span> (!UnicodeExe) {
00434                 <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(UnicodeExeName);
00435             }
00436             <span class="keywordflow">return</span> AliasList;
00437         }
00438         ListNext = ListNext-&gt;Flink;
00439     }
00440     <span class="keywordflow">if</span> (!UnicodeExe) {
00441         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(UnicodeExeName);
00442     }
00443     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00444 }
00445 
00446 <a class="code" href="../../d1/d6/struct__ALIAS.html">PALIAS</a>
<a name="l00447"></a><a class="code" href="../../d3/d1/server_2cmdline_8c.html#a23">00447</a> <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a23">FindAlias</a>(
00448     IN <a class="code" href="../../d6/d8/struct__EXE__ALIAS__LIST.html">PEXE_ALIAS_LIST</a> AliasList,
00449     IN LPWSTR AliasName,
00450     IN USHORT AliasLength <span class="comment">// in bytes</span>
00451     )
00452 
00453 <span class="comment">/*++</span>
00454 <span class="comment"></span>
00455 <span class="comment">    This routine searches for the specified alias.  If it finds one,</span>
00456 <span class="comment">    it moves it to the head of the list and returns a pointer to the</span>
00457 <span class="comment">    alias. Otherwise it returns NULL.</span>
00458 <span class="comment"></span>
00459 <span class="comment">--*/</span>
00460 
00461 {
00462     <a class="code" href="../../d1/d6/struct__ALIAS.html">PALIAS</a> Alias;
00463     PLIST_ENTRY ListHead, ListNext;
00464 
00465     ListHead = &amp;AliasList-&gt;AliasList;
00466     ListNext = ListHead-&gt;Flink;
00467     <span class="keywordflow">while</span> (ListNext != ListHead) {
00468         Alias = CONTAINING_RECORD( ListNext, <a class="code" href="../../d1/d6/struct__ALIAS.html">ALIAS</a>, ListLink );
00469         <span class="keywordflow">if</span> (Alias-&gt;<a class="code" href="../../d1/d6/struct__ALIAS.html#o1">SourceLength</a> == AliasLength &amp;&amp;
00470             !<a class="code" href="../../d3/d1/server_2cmdline_8c.html#a9">my_wcsncmpi</a>(Alias-&gt;<a class="code" href="../../d1/d6/struct__ALIAS.html#o3">Source</a>,AliasName,AliasLength)) {
00471             <span class="keywordflow">if</span> (ListNext != ListHead-&gt;Flink) {
00472                 RemoveEntryList(ListNext);
00473                 InsertHeadList(ListHead,ListNext);
00474             }
00475             <span class="keywordflow">return</span> Alias;
00476         }
00477         ListNext = ListNext-&gt;Flink;
00478     }
00479     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00480 }
00481 
00482 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00483"></a><a class="code" href="../../d3/d1/server_2cmdline_8c.html#a24">00483</a> <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a24">AddAlias</a>(
00484     IN <a class="code" href="../../d6/d8/struct__EXE__ALIAS__LIST.html">PEXE_ALIAS_LIST</a> ExeAliasList,
00485     IN LPWSTR Source,
00486     IN USHORT SourceLength,  <span class="comment">// in bytes</span>
00487     IN LPWSTR Target,
00488     IN USHORT TargetLength   <span class="comment">// in bytes</span>
00489     )
00490 
00491 <span class="comment">/*++</span>
00492 <span class="comment"></span>
00493 <span class="comment">    This routine creates an alias and inserts it into the exe alias list.</span>
00494 <span class="comment"></span>
00495 <span class="comment">--*/</span>
00496 
00497 {
00498     <a class="code" href="../../d1/d6/struct__ALIAS.html">PALIAS</a> Alias;
00499 
00500     Alias = (<a class="code" href="../../d1/d6/struct__ALIAS.html">PALIAS</a>)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a11">ALIAS_TAG</a> ),<span class="keyword">sizeof</span>(<a class="code" href="../../d1/d6/struct__ALIAS.html">ALIAS</a>));
00501     <span class="keywordflow">if</span> (Alias == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00502         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00503     }
00504     Alias-&gt;<a class="code" href="../../d1/d6/struct__ALIAS.html#o3">Source</a> = (LPWSTR)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a11">ALIAS_TAG</a> ),SourceLength);
00505     <span class="keywordflow">if</span> (Alias-&gt;<a class="code" href="../../d1/d6/struct__ALIAS.html#o3">Source</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00506         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(Alias);
00507         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00508     }
00509     Alias-&gt;<a class="code" href="../../d1/d6/struct__ALIAS.html#o4">Target</a> = (LPWSTR)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a11">ALIAS_TAG</a> ),TargetLength);
00510     <span class="keywordflow">if</span> (Alias-&gt;<a class="code" href="../../d1/d6/struct__ALIAS.html#o4">Target</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00511         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(Alias-&gt;<a class="code" href="../../d1/d6/struct__ALIAS.html#o3">Source</a>);
00512         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(Alias);
00513         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00514     }
00515     Alias-&gt;<a class="code" href="../../d1/d6/struct__ALIAS.html#o1">SourceLength</a> = SourceLength;
00516     Alias-&gt;<a class="code" href="../../d1/d6/struct__ALIAS.html#o2">TargetLength</a> = TargetLength;
00517     RtlCopyMemory(Alias-&gt;<a class="code" href="../../d1/d6/struct__ALIAS.html#o3">Source</a>,Source,SourceLength);
00518     RtlCopyMemory(Alias-&gt;<a class="code" href="../../d1/d6/struct__ALIAS.html#o4">Target</a>,Target,TargetLength);
00519     InsertHeadList(&amp;ExeAliasList-&gt;AliasList,&amp;Alias-&gt;<a class="code" href="../../d1/d6/struct__ALIAS.html#o0">ListLink</a>);
00520     <span class="keywordflow">return</span> STATUS_SUCCESS;
00521 }
00522 
00523 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00524"></a><a class="code" href="../../d3/d1/server_2cmdline_8c.html#a25">00524</a> <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a25">ReplaceAlias</a>(
00525     IN <a class="code" href="../../d1/d6/struct__ALIAS.html">PALIAS</a> Alias,
00526     IN LPWSTR Target,
00527     IN USHORT TargetLength <span class="comment">// in bytes</span>
00528     )
00529 
00530 <span class="comment">/*++</span>
00531 <span class="comment"></span>
00532 <span class="comment">    This routine replaces an existing target with a new target.</span>
00533 <span class="comment"></span>
00534 <span class="comment">--*/</span>
00535 
00536 {
00537     LPWSTR NewTarget;
00538 
00539     NewTarget = (LPWSTR)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a11">ALIAS_TAG</a> ),TargetLength);
00540     <span class="keywordflow">if</span> (NewTarget == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00541         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00542     }
00543     <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(Alias-&gt;Target);
00544     Alias-&gt;Target = NewTarget;
00545     Alias-&gt;TargetLength = TargetLength;
00546     RtlCopyMemory(Alias-&gt;Target,Target,TargetLength);
00547     <span class="keywordflow">return</span> STATUS_SUCCESS;
00548 }
00549 
00550 
00551 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00552"></a><a class="code" href="../../d3/d1/server_2cmdline_8c.html#a26">00552</a> <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a26">RemoveAlias</a>(
00553     IN <a class="code" href="../../d1/d6/struct__ALIAS.html">PALIAS</a> Alias
00554     )
00555 
00556 <span class="comment">/*++</span>
00557 <span class="comment"></span>
00558 <span class="comment">    This routine removes an alias.</span>
00559 <span class="comment"></span>
00560 <span class="comment">--*/</span>
00561 
00562 {
00563     RemoveEntryList(&amp;Alias-&gt;ListLink);
00564     <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(Alias-&gt;Source);
00565     <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(Alias-&gt;Target);
00566     <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(Alias);
00567     <span class="keywordflow">return</span> STATUS_SUCCESS;
00568 }
00569 
00570 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00571"></a><a class="code" href="../../d3/d1/server_2cmdline_8c.html#a27">00571</a> <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a27">FreeAliasList</a>(
00572     IN <a class="code" href="../../d6/d8/struct__EXE__ALIAS__LIST.html">PEXE_ALIAS_LIST</a> ExeAliasList
00573     )
00574 {
00575     PLIST_ENTRY ListHead, ListNext;
00576     <a class="code" href="../../d1/d6/struct__ALIAS.html">PALIAS</a> Alias;
00577 
00578     ListHead = &amp;ExeAliasList-&gt;AliasList;
00579     ListNext = ListHead-&gt;Flink;
00580     <span class="keywordflow">while</span> (ListNext != ListHead) {
00581         Alias = CONTAINING_RECORD( ListNext, <a class="code" href="../../d1/d6/struct__ALIAS.html">ALIAS</a>, ListLink );
00582         ListNext = ListNext-&gt;Flink;
00583         <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a26">RemoveAlias</a>(Alias);
00584     }
00585     RemoveEntryList(&amp;ExeAliasList-&gt;ListLink);
00586     <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(ExeAliasList-&gt;ExeName);
00587     <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(ExeAliasList);
00588 }
00589 
00590 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00591"></a><a class="code" href="../../d8/d5/consrv_8h.html#a258">00591</a> <a class="code" href="../../d8/d5/consrv_8h.html#a258">FreeAliasBuffers</a>(
00592     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console
00593     )
00594 {
00595     <a class="code" href="../../d6/d8/struct__EXE__ALIAS__LIST.html">PEXE_ALIAS_LIST</a> AliasList;
00596     PLIST_ENTRY ListHead, ListNext;
00597 
00598     ListHead = &amp;Console-&gt;ExeAliasList;
00599     ListNext = ListHead-&gt;Flink;
00600     <span class="keywordflow">while</span> (ListNext != ListHead) {
00601         AliasList = CONTAINING_RECORD( ListNext, <a class="code" href="../../d6/d8/struct__EXE__ALIAS__LIST.html">EXE_ALIAS_LIST</a>, ListLink );
00602         ListNext = ListNext-&gt;Flink;
00603         <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a27">FreeAliasList</a>(AliasList);
00604     }
00605 }
00606 
00607 ULONG
<a name="l00608"></a><a class="code" href="../../d8/d5/consrv_8h.html#a240">00608</a> <a class="code" href="../../d8/d5/consrv_8h.html#a240">SrvAddConsoleAlias</a>(
00609     IN OUT PCSR_API_MSG m,
00610     IN OUT PCSR_REPLY_STATUS ReplyStatus
00611     )
00612 
00613 <span class="comment">/*++</span>
00614 <span class="comment"></span>
00615 <span class="comment">Routine Description:</span>
00616 <span class="comment"></span>
00617 <span class="comment">    This routine adds a command line alias to the global set.</span>
00618 <span class="comment"></span>
00619 <span class="comment">Arguments:</span>
00620 <span class="comment"></span>
00621 <span class="comment">    m - message containing api parameters</span>
00622 <span class="comment"></span>
00623 <span class="comment">    ReplyStatus - Indicates whether to reply to the dll port.</span>
00624 <span class="comment"></span>
00625 <span class="comment">Return Value:</span>
00626 <span class="comment"></span>
00627 <span class="comment">--*/</span>
00628 
00629 {
00630 
00631     <a class="code" href="../../d2/d9/struct__CONSOLE__ADDALIAS__MSG.html">PCONSOLE_ADDALIAS_MSG</a> a = (<a class="code" href="../../d2/d9/struct__CONSOLE__ADDALIAS__MSG.html">PCONSOLE_ADDALIAS_MSG</a>)&amp;m-&gt;u.ApiMessageData;
00632     <a class="code" href="../../d1/d6/struct__ALIAS.html">PALIAS</a> Alias;
00633     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
00634     <a class="code" href="../../d6/d8/struct__EXE__ALIAS__LIST.html">PEXE_ALIAS_LIST</a> ExeAliasList;
00635     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00636     LPWSTR Source,Target;
00637 
00638     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a33">ApiPreamble</a>(a-&gt;<a class="code" href="../../d2/d9/struct__CONSOLE__ADDALIAS__MSG.html#o0">ConsoleHandle</a>,
00639                          &amp;Console
00640                         );
00641     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00642         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00643     }
00644 
00645     <span class="keywordflow">if</span> (!CsrValidateMessageBuffer(m, &amp;a-&gt;<a class="code" href="../../d2/d9/struct__CONSOLE__ADDALIAS__MSG.html#o4">Source</a>, a-&gt;<a class="code" href="../../d2/d9/struct__CONSOLE__ADDALIAS__MSG.html#o1">SourceLength</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)) ||
00646         !CsrValidateMessageBuffer(m, &amp;a-&gt;<a class="code" href="../../d2/d9/struct__CONSOLE__ADDALIAS__MSG.html#o5">Target</a>,a-&gt;<a class="code" href="../../d2/d9/struct__CONSOLE__ADDALIAS__MSG.html#o2">TargetLength</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)) ||
00647         !CsrValidateMessageBuffer(m, &amp;a-&gt;<a class="code" href="../../d2/d9/struct__CONSOLE__ADDALIAS__MSG.html#o6">Exe</a>, a-&gt;<a class="code" href="../../d2/d9/struct__CONSOLE__ADDALIAS__MSG.html#o3">ExeLength</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>))) {
00648 
00649         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
00650         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00651     }
00652 
00653     <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d2/d9/struct__CONSOLE__ADDALIAS__MSG.html#o7">Unicode</a>) {
00654         Source = a-&gt;<a class="code" href="../../d2/d9/struct__CONSOLE__ADDALIAS__MSG.html#o4">Source</a>;
00655         Target = a-&gt;<a class="code" href="../../d2/d9/struct__CONSOLE__ADDALIAS__MSG.html#o5">Target</a>;
00656     } <span class="keywordflow">else</span> {
00657         Source = (LPWSTR)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a9">TMP_TAG</a> ),a-&gt;<a class="code" href="../../d2/d9/struct__CONSOLE__ADDALIAS__MSG.html#o1">SourceLength</a>*<span class="keyword">sizeof</span>(WCHAR));
00658         <span class="keywordflow">if</span> (Source == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00659             <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
00660             <span class="keywordflow">return</span> (ULONG)STATUS_NO_MEMORY;
00661         }
00662         Target = (LPWSTR)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a9">TMP_TAG</a> ),a-&gt;<a class="code" href="../../d2/d9/struct__CONSOLE__ADDALIAS__MSG.html#o2">TargetLength</a>*<span class="keyword">sizeof</span>(WCHAR));
00663         <span class="keywordflow">if</span> (Target == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00664             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(Source);
00665             <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
00666             <span class="keywordflow">return</span> (ULONG)STATUS_NO_MEMORY;
00667         }
00668         a-&gt;<a class="code" href="../../d2/d9/struct__CONSOLE__ADDALIAS__MSG.html#o1">SourceLength</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a36">ConvertInputToUnicode</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o61">CP</a>,
00669                                             a-&gt;<a class="code" href="../../d2/d9/struct__CONSOLE__ADDALIAS__MSG.html#o4">Source</a>,
00670                                             a-&gt;<a class="code" href="../../d2/d9/struct__CONSOLE__ADDALIAS__MSG.html#o1">SourceLength</a>,
00671                                             Source,
00672                                             a-&gt;<a class="code" href="../../d2/d9/struct__CONSOLE__ADDALIAS__MSG.html#o1">SourceLength</a>);
00673         a-&gt;<a class="code" href="../../d2/d9/struct__CONSOLE__ADDALIAS__MSG.html#o1">SourceLength</a> *= 2;
00674         a-&gt;<a class="code" href="../../d2/d9/struct__CONSOLE__ADDALIAS__MSG.html#o2">TargetLength</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a36">ConvertInputToUnicode</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o61">CP</a>,
00675                                             a-&gt;<a class="code" href="../../d2/d9/struct__CONSOLE__ADDALIAS__MSG.html#o5">Target</a>,
00676                                             a-&gt;<a class="code" href="../../d2/d9/struct__CONSOLE__ADDALIAS__MSG.html#o2">TargetLength</a>,
00677                                             Target,
00678                                             a-&gt;<a class="code" href="../../d2/d9/struct__CONSOLE__ADDALIAS__MSG.html#o2">TargetLength</a>);
00679         a-&gt;<a class="code" href="../../d2/d9/struct__CONSOLE__ADDALIAS__MSG.html#o2">TargetLength</a> *= 2;
00680     }
00681 
00682     <span class="comment">//</span>
00683     <span class="comment">// find specified exe.  if it's not there, add it if we're not</span>
00684     <span class="comment">// removing an alias.</span>
00685     <span class="comment">//</span>
00686 
00687     ExeAliasList = <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a22">FindExe</a>(Console,a-&gt;<a class="code" href="../../d2/d9/struct__CONSOLE__ADDALIAS__MSG.html#o6">Exe</a>,a-&gt;<a class="code" href="../../d2/d9/struct__CONSOLE__ADDALIAS__MSG.html#o3">ExeLength</a>,a-&gt;<a class="code" href="../../d2/d9/struct__CONSOLE__ADDALIAS__MSG.html#o8">UnicodeExe</a>);
00688     <span class="keywordflow">if</span> (ExeAliasList) {
00689         Alias = <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a23">FindAlias</a>(ExeAliasList,Source,a-&gt;<a class="code" href="../../d2/d9/struct__CONSOLE__ADDALIAS__MSG.html#o1">SourceLength</a>);
00690         <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d2/d9/struct__CONSOLE__ADDALIAS__MSG.html#o2">TargetLength</a>) {
00691             <span class="keywordflow">if</span> (Alias) {
00692                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a25">ReplaceAlias</a>(Alias,
00693                                       Target,
00694                                       a-&gt;<a class="code" href="../../d2/d9/struct__CONSOLE__ADDALIAS__MSG.html#o2">TargetLength</a>);
00695             } <span class="keywordflow">else</span> {
00696                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a24">AddAlias</a>(ExeAliasList,
00697                                   Source,
00698                                   a-&gt;<a class="code" href="../../d2/d9/struct__CONSOLE__ADDALIAS__MSG.html#o1">SourceLength</a>,
00699                                   Target,
00700                                   a-&gt;<a class="code" href="../../d2/d9/struct__CONSOLE__ADDALIAS__MSG.html#o2">TargetLength</a>);
00701             }
00702         } <span class="keywordflow">else</span> {
00703             <span class="keywordflow">if</span> (Alias) {
00704                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a26">RemoveAlias</a>(Alias);
00705             }
00706         }
00707     } <span class="keywordflow">else</span> {
00708         <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d2/d9/struct__CONSOLE__ADDALIAS__MSG.html#o2">TargetLength</a>) {
00709             ExeAliasList = <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a20">AddExeAliasList</a>(Console,a-&gt;<a class="code" href="../../d2/d9/struct__CONSOLE__ADDALIAS__MSG.html#o6">Exe</a>,a-&gt;<a class="code" href="../../d2/d9/struct__CONSOLE__ADDALIAS__MSG.html#o3">ExeLength</a>,a-&gt;<a class="code" href="../../d2/d9/struct__CONSOLE__ADDALIAS__MSG.html#o8">UnicodeExe</a>);
00710             <span class="keywordflow">if</span> (ExeAliasList) {
00711                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a24">AddAlias</a>(ExeAliasList,
00712                                   Source,
00713                                   a-&gt;<a class="code" href="../../d2/d9/struct__CONSOLE__ADDALIAS__MSG.html#o1">SourceLength</a>,
00714                                   Target,
00715                                   a-&gt;<a class="code" href="../../d2/d9/struct__CONSOLE__ADDALIAS__MSG.html#o2">TargetLength</a>);
00716             } <span class="keywordflow">else</span> {
00717                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
00718             }
00719         }
00720     }
00721     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
00722     <span class="keywordflow">if</span> (!a-&gt;<a class="code" href="../../d2/d9/struct__CONSOLE__ADDALIAS__MSG.html#o7">Unicode</a>) {
00723         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(Source);
00724         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(Target);
00725     }
00726     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00727     UNREFERENCED_PARAMETER(ReplyStatus);
00728 }
00729 
00730 ULONG
<a name="l00731"></a><a class="code" href="../../d8/d5/consrv_8h.html#a241">00731</a> <a class="code" href="../../d8/d5/consrv_8h.html#a241">SrvGetConsoleAlias</a>(
00732     IN OUT PCSR_API_MSG m,
00733     IN OUT PCSR_REPLY_STATUS ReplyStatus
00734     )
00735 
00736 <span class="comment">/*++</span>
00737 <span class="comment"></span>
00738 <span class="comment">Routine Description:</span>
00739 <span class="comment"></span>
00740 <span class="comment">    This routine get a command line alias from the global set.</span>
00741 <span class="comment"></span>
00742 <span class="comment">Arguments:</span>
00743 <span class="comment"></span>
00744 <span class="comment">    m - message containing api parameters</span>
00745 <span class="comment"></span>
00746 <span class="comment">    ReplyStatus - Indicates whether to reply to the dll port.</span>
00747 <span class="comment"></span>
00748 <span class="comment">Return Value:</span>
00749 <span class="comment"></span>
00750 <span class="comment">--*/</span>
00751 
00752 {
00753 
00754     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00755     <a class="code" href="../../d5/d0/struct__CONSOLE__GETALIAS__MSG.html">PCONSOLE_GETALIAS_MSG</a> a = (<a class="code" href="../../d5/d0/struct__CONSOLE__GETALIAS__MSG.html">PCONSOLE_GETALIAS_MSG</a>)&amp;m-&gt;u.ApiMessageData;
00756     <a class="code" href="../../d1/d6/struct__ALIAS.html">PALIAS</a> Alias;
00757     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
00758     <a class="code" href="../../d6/d8/struct__EXE__ALIAS__LIST.html">PEXE_ALIAS_LIST</a> ExeAliasList;
00759     LPWSTR Source,Target;
00760 
00761     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a33">ApiPreamble</a>(a-&gt;<a class="code" href="../../d5/d0/struct__CONSOLE__GETALIAS__MSG.html#o0">ConsoleHandle</a>,
00762                          &amp;Console
00763                         );
00764     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00765         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00766     }
00767 
00768     <span class="keywordflow">if</span> (!CsrValidateMessageBuffer(m, &amp;a-&gt;<a class="code" href="../../d5/d0/struct__CONSOLE__GETALIAS__MSG.html#o4">Source</a>, a-&gt;<a class="code" href="../../d5/d0/struct__CONSOLE__GETALIAS__MSG.html#o1">SourceLength</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)) ||
00769         !CsrValidateMessageBuffer(m, &amp;a-&gt;<a class="code" href="../../d5/d0/struct__CONSOLE__GETALIAS__MSG.html#o5">Target</a>, a-&gt;<a class="code" href="../../d5/d0/struct__CONSOLE__GETALIAS__MSG.html#o2">TargetLength</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)) ||
00770         !CsrValidateMessageBuffer(m, &amp;a-&gt;<a class="code" href="../../d5/d0/struct__CONSOLE__GETALIAS__MSG.html#o6">Exe</a>, a-&gt;<a class="code" href="../../d5/d0/struct__CONSOLE__GETALIAS__MSG.html#o3">ExeLength</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>))) {
00771 
00772         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
00773         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00774     }
00775 
00776     <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d5/d0/struct__CONSOLE__GETALIAS__MSG.html#o7">Unicode</a>) {
00777         Source = a-&gt;<a class="code" href="../../d5/d0/struct__CONSOLE__GETALIAS__MSG.html#o4">Source</a>;
00778         Target = a-&gt;<a class="code" href="../../d5/d0/struct__CONSOLE__GETALIAS__MSG.html#o5">Target</a>;
00779     } <span class="keywordflow">else</span> {
00780         Source = (LPWSTR)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a9">TMP_TAG</a> ),a-&gt;<a class="code" href="../../d5/d0/struct__CONSOLE__GETALIAS__MSG.html#o1">SourceLength</a>*<span class="keyword">sizeof</span>(WCHAR));
00781         <span class="keywordflow">if</span> (Source == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00782             <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
00783             <span class="keywordflow">return</span> (ULONG)STATUS_NO_MEMORY;
00784         }
00785         Target = (LPWSTR)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a9">TMP_TAG</a> ),a-&gt;<a class="code" href="../../d5/d0/struct__CONSOLE__GETALIAS__MSG.html#o2">TargetLength</a>*<span class="keyword">sizeof</span>(WCHAR));
00786         <span class="keywordflow">if</span> (Target == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00787             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(Source);
00788             <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
00789             <span class="keywordflow">return</span> (ULONG)STATUS_NO_MEMORY;
00790         }
00791         a-&gt;<a class="code" href="../../d5/d0/struct__CONSOLE__GETALIAS__MSG.html#o2">TargetLength</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(a-&gt;<a class="code" href="../../d5/d0/struct__CONSOLE__GETALIAS__MSG.html#o2">TargetLength</a> * <span class="keyword">sizeof</span>(WCHAR));
00792         a-&gt;<a class="code" href="../../d5/d0/struct__CONSOLE__GETALIAS__MSG.html#o1">SourceLength</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a36">ConvertInputToUnicode</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o61">CP</a>,
00793                                             a-&gt;<a class="code" href="../../d5/d0/struct__CONSOLE__GETALIAS__MSG.html#o4">Source</a>,
00794                                             a-&gt;<a class="code" href="../../d5/d0/struct__CONSOLE__GETALIAS__MSG.html#o1">SourceLength</a>,
00795                                             Source,
00796                                             a-&gt;<a class="code" href="../../d5/d0/struct__CONSOLE__GETALIAS__MSG.html#o1">SourceLength</a>);
00797         a-&gt;<a class="code" href="../../d5/d0/struct__CONSOLE__GETALIAS__MSG.html#o1">SourceLength</a> *= 2;
00798     }
00799     ExeAliasList = <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a22">FindExe</a>(Console,a-&gt;<a class="code" href="../../d5/d0/struct__CONSOLE__GETALIAS__MSG.html#o6">Exe</a>,a-&gt;<a class="code" href="../../d5/d0/struct__CONSOLE__GETALIAS__MSG.html#o3">ExeLength</a>,a-&gt;<a class="code" href="../../d5/d0/struct__CONSOLE__GETALIAS__MSG.html#o8">UnicodeExe</a>);
00800     <span class="keywordflow">if</span> (ExeAliasList) {
00801         Alias = <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a23">FindAlias</a>(ExeAliasList,Source,a-&gt;<a class="code" href="../../d5/d0/struct__CONSOLE__GETALIAS__MSG.html#o1">SourceLength</a>);
00802         <span class="keywordflow">if</span> (Alias) {
00803             <span class="keywordflow">if</span> (Alias-&gt;<a class="code" href="../../d1/d6/struct__ALIAS.html#o2">TargetLength</a> + <span class="keyword">sizeof</span>(WCHAR) &gt; a-&gt;<a class="code" href="../../d5/d0/struct__CONSOLE__GETALIAS__MSG.html#o2">TargetLength</a>) {
00804                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_BUFFER_TOO_SMALL;
00805             } <span class="keywordflow">else</span> {
00806                 a-&gt;<a class="code" href="../../d5/d0/struct__CONSOLE__GETALIAS__MSG.html#o2">TargetLength</a> = Alias-&gt;<a class="code" href="../../d1/d6/struct__ALIAS.html#o2">TargetLength</a> + <span class="keyword">sizeof</span>(WCHAR);
00807                 RtlCopyMemory(Target,Alias-&gt;<a class="code" href="../../d1/d6/struct__ALIAS.html#o4">Target</a>,Alias-&gt;<a class="code" href="../../d1/d6/struct__ALIAS.html#o2">TargetLength</a>);
00808                 Target[Alias-&gt;<a class="code" href="../../d1/d6/struct__ALIAS.html#o2">TargetLength</a>/<span class="keyword">sizeof</span>(WCHAR)] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00809             }
00810         } <span class="keywordflow">else</span> {
00811             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
00812         }
00813     } <span class="keywordflow">else</span> {
00814         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
00815     }
00816     <span class="keywordflow">if</span> (!a-&gt;<a class="code" href="../../d5/d0/struct__CONSOLE__GETALIAS__MSG.html#o7">Unicode</a>) {
00817         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00818             a-&gt;<a class="code" href="../../d5/d0/struct__CONSOLE__GETALIAS__MSG.html#o2">TargetLength</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a35">ConvertToOem</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o61">CP</a>,
00819                                              Target,
00820                                              a-&gt;<a class="code" href="../../d5/d0/struct__CONSOLE__GETALIAS__MSG.html#o2">TargetLength</a> / <span class="keyword">sizeof</span>(WCHAR),
00821                                              a-&gt;<a class="code" href="../../d5/d0/struct__CONSOLE__GETALIAS__MSG.html#o5">Target</a>,
00822                                              <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a5">CHAR_COUNT</a>(a-&gt;<a class="code" href="../../d5/d0/struct__CONSOLE__GETALIAS__MSG.html#o2">TargetLength</a>)
00823                                              );
00824         }
00825         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(Source);
00826         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(Target);
00827     }
00828     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
00829     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00830     UNREFERENCED_PARAMETER(ReplyStatus);
00831 }
00832 
00833 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>
<a name="l00834"></a><a class="code" href="../../d8/d5/consrv_8h.html#a242">00834</a> <a class="code" href="../../d8/d5/consrv_8h.html#a242">SrvGetConsoleAliasesLength</a>(
00835     IN OUT PCSR_API_MSG m,
00836     IN OUT PCSR_REPLY_STATUS ReplyStatus
00837     )
00838 {
00839     <a class="code" href="../../d7/d0/struct__CONSOLE__GETALIASESLENGTH__MSG.html">PCONSOLE_GETALIASESLENGTH_MSG</a> a = (<a class="code" href="../../d7/d0/struct__CONSOLE__GETALIASESLENGTH__MSG.html">PCONSOLE_GETALIASESLENGTH_MSG</a>)&amp;m-&gt;u.ApiMessageData;
00840     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
00841     <a class="code" href="../../d6/d8/struct__EXE__ALIAS__LIST.html">PEXE_ALIAS_LIST</a> ExeAliasList;
00842     <a class="code" href="../../d1/d6/struct__ALIAS.html">PALIAS</a> Alias;
00843     PLIST_ENTRY ListHead, ListNext;
00844     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00845 
00846     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a33">ApiPreamble</a>(a-&gt;<a class="code" href="../../d7/d0/struct__CONSOLE__GETALIASESLENGTH__MSG.html#o0">ConsoleHandle</a>,
00847                          &amp;Console
00848                         );
00849     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00850         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00851     }
00852 
00853     <span class="keywordflow">if</span> (!CsrValidateMessageBuffer(m, &amp;a-&gt;<a class="code" href="../../d7/d0/struct__CONSOLE__GETALIASESLENGTH__MSG.html#o2">Exe</a>, a-&gt;<a class="code" href="../../d7/d0/struct__CONSOLE__GETALIASESLENGTH__MSG.html#o1">ExeLength</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>))) {
00854         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
00855         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00856     }
00857 
00858     a-&gt;<a class="code" href="../../d7/d0/struct__CONSOLE__GETALIASESLENGTH__MSG.html#o3">AliasesLength</a> = 0;
00859     ExeAliasList = <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a22">FindExe</a>(Console,a-&gt;<a class="code" href="../../d7/d0/struct__CONSOLE__GETALIASESLENGTH__MSG.html#o2">Exe</a>,a-&gt;<a class="code" href="../../d7/d0/struct__CONSOLE__GETALIASESLENGTH__MSG.html#o1">ExeLength</a>,a-&gt;<a class="code" href="../../d7/d0/struct__CONSOLE__GETALIASESLENGTH__MSG.html#o5">UnicodeExe</a>);
00860     <span class="keywordflow">if</span> (ExeAliasList) {
00861         ListHead = &amp;ExeAliasList-&gt;<a class="code" href="../../d6/d8/struct__EXE__ALIAS__LIST.html#o3">AliasList</a>;
00862         ListNext = ListHead-&gt;Flink;
00863         <span class="keywordflow">while</span> (ListNext != ListHead) {
00864             Alias = CONTAINING_RECORD( ListNext, <a class="code" href="../../d1/d6/struct__ALIAS.html">ALIAS</a>, ListLink );
00865             a-&gt;<a class="code" href="../../d7/d0/struct__CONSOLE__GETALIASESLENGTH__MSG.html#o3">AliasesLength</a> += Alias-&gt;<a class="code" href="../../d1/d6/struct__ALIAS.html#o1">SourceLength</a> + Alias-&gt;<a class="code" href="../../d1/d6/struct__ALIAS.html#o2">TargetLength</a> + (2*<span class="keyword">sizeof</span>(WCHAR));  <span class="comment">// +2 is for = and term null</span>
00866             ListNext = ListNext-&gt;Flink;
00867         }
00868     }
00869     <span class="keywordflow">if</span> (!a-&gt;<a class="code" href="../../d7/d0/struct__CONSOLE__GETALIASESLENGTH__MSG.html#o4">Unicode</a>) {
00870         a-&gt;<a class="code" href="../../d7/d0/struct__CONSOLE__GETALIASESLENGTH__MSG.html#o3">AliasesLength</a> /= <span class="keyword">sizeof</span>(WCHAR);
00871     }
00872     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
00873     <span class="keywordflow">return</span> STATUS_SUCCESS;
00874     UNREFERENCED_PARAMETER(ReplyStatus);
00875 }
00876 
00877 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00878"></a><a class="code" href="../../d3/d1/server_2cmdline_8c.html#a32">00878</a> <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a32">ClearAliases</a>(
00879     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console
00880     )
00881 {
00882     <a class="code" href="../../d6/d8/struct__EXE__ALIAS__LIST.html">PEXE_ALIAS_LIST</a> ExeAliasList;
00883     PLIST_ENTRY ListHead, ListNext;
00884     <a class="code" href="../../d1/d6/struct__ALIAS.html">PALIAS</a> Alias;
00885 
00886     ExeAliasList = <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a22">FindExe</a>(Console,
00887                            <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"cmd.exe"</span>,
00888                            14,
00889                            <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00890     <span class="keywordflow">if</span> (ExeAliasList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00891         <span class="keywordflow">return</span>;
00892     }
00893     ListHead = &amp;ExeAliasList-&gt;<a class="code" href="../../d6/d8/struct__EXE__ALIAS__LIST.html#o3">AliasList</a>;
00894     ListNext = ListHead-&gt;Flink;
00895     <span class="keywordflow">while</span> (ListNext != ListHead) {
00896         Alias = CONTAINING_RECORD( ListNext, <a class="code" href="../../d1/d6/struct__ALIAS.html">ALIAS</a>, ListLink );
00897         ListNext = ListNext-&gt;Flink;
00898         <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a26">RemoveAlias</a>(Alias);
00899     }
00900 }
00901 
00902 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>
<a name="l00903"></a><a class="code" href="../../d8/d5/consrv_8h.html#a244">00903</a> <a class="code" href="../../d8/d5/consrv_8h.html#a244">SrvGetConsoleAliases</a>(
00904     IN OUT PCSR_API_MSG m,
00905     IN OUT PCSR_REPLY_STATUS ReplyStatus
00906     )
00907 {
00908     <a class="code" href="../../d6/d0/struct__CONSOLE__GETALIASES__MSG.html">PCONSOLE_GETALIASES_MSG</a> a = (<a class="code" href="../../d6/d0/struct__CONSOLE__GETALIASES__MSG.html">PCONSOLE_GETALIASES_MSG</a>)&amp;m-&gt;u.ApiMessageData;
00909     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
00910     <a class="code" href="../../d6/d8/struct__EXE__ALIAS__LIST.html">PEXE_ALIAS_LIST</a> ExeAliasList;
00911     <a class="code" href="../../d1/d6/struct__ALIAS.html">PALIAS</a> Alias;
00912     PLIST_ENTRY ListHead, ListNext;
00913     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> AliasesBufferLength;
00914     LPWSTR AliasesBufferPtrW;
00915     LPSTR  AliasesBufferPtrA;
00916     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00917 
00918     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a33">ApiPreamble</a>(a-&gt;<a class="code" href="../../d6/d0/struct__CONSOLE__GETALIASES__MSG.html#o0">ConsoleHandle</a>,
00919                          &amp;Console
00920                         );
00921     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00922         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00923     }
00924 
00925     <span class="keywordflow">if</span> (!CsrValidateMessageBuffer(m, &amp;a-&gt;<a class="code" href="../../d6/d0/struct__CONSOLE__GETALIASES__MSG.html#o6">AliasesBuffer</a>, a-&gt;<a class="code" href="../../d6/d0/struct__CONSOLE__GETALIASES__MSG.html#o5">AliasesBufferLength</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)) ||
00926         !CsrValidateMessageBuffer(m, &amp;a-&gt;<a class="code" href="../../d6/d0/struct__CONSOLE__GETALIASES__MSG.html#o2">Exe</a>, a-&gt;<a class="code" href="../../d6/d0/struct__CONSOLE__GETALIASES__MSG.html#o1">ExeLength</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>))) {
00927 
00928         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
00929         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00930     }
00931 
00932     AliasesBufferLength = a-&gt;<a class="code" href="../../d6/d0/struct__CONSOLE__GETALIASES__MSG.html#o5">AliasesBufferLength</a>;
00933     <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d6/d0/struct__CONSOLE__GETALIASES__MSG.html#o3">Unicode</a>) {
00934         AliasesBufferPtrW = a-&gt;<a class="code" href="../../d6/d0/struct__CONSOLE__GETALIASES__MSG.html#o6">AliasesBuffer</a>;
00935     } <span class="keywordflow">else</span> {
00936         AliasesBufferPtrA = a-&gt;<a class="code" href="../../d6/d0/struct__CONSOLE__GETALIASES__MSG.html#o6">AliasesBuffer</a>;
00937     }
00938     a-&gt;<a class="code" href="../../d6/d0/struct__CONSOLE__GETALIASES__MSG.html#o5">AliasesBufferLength</a> = 0;
00939     ExeAliasList = <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a22">FindExe</a>(Console,a-&gt;<a class="code" href="../../d6/d0/struct__CONSOLE__GETALIASES__MSG.html#o2">Exe</a>,a-&gt;<a class="code" href="../../d6/d0/struct__CONSOLE__GETALIASES__MSG.html#o1">ExeLength</a>,a-&gt;<a class="code" href="../../d6/d0/struct__CONSOLE__GETALIASES__MSG.html#o4">UnicodeExe</a>);
00940     <span class="keywordflow">if</span> (ExeAliasList) {
00941         ListHead = &amp;ExeAliasList-&gt;<a class="code" href="../../d6/d8/struct__EXE__ALIAS__LIST.html#o3">AliasList</a>;
00942         ListNext = ListHead-&gt;Flink;
00943         <span class="keywordflow">while</span> (ListNext != ListHead) {
00944             Alias = CONTAINING_RECORD( ListNext, <a class="code" href="../../d1/d6/struct__ALIAS.html">ALIAS</a>, ListLink );
00945             <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d6/d0/struct__CONSOLE__GETALIASES__MSG.html#o3">Unicode</a>) {
00946                 <span class="keywordflow">if</span> ((a-&gt;<a class="code" href="../../d6/d0/struct__CONSOLE__GETALIASES__MSG.html#o5">AliasesBufferLength</a> + Alias-&gt;<a class="code" href="../../d1/d6/struct__ALIAS.html#o1">SourceLength</a> + Alias-&gt;<a class="code" href="../../d1/d6/struct__ALIAS.html#o2">TargetLength</a> + (2*<span class="keyword">sizeof</span>(WCHAR)))
00947                     &lt;= AliasesBufferLength) {
00948                     RtlCopyMemory(AliasesBufferPtrW,Alias-&gt;<a class="code" href="../../d1/d6/struct__ALIAS.html#o3">Source</a>,Alias-&gt;<a class="code" href="../../d1/d6/struct__ALIAS.html#o1">SourceLength</a>);
00949                     AliasesBufferPtrW+=Alias-&gt;<a class="code" href="../../d1/d6/struct__ALIAS.html#o1">SourceLength</a>/<span class="keyword">sizeof</span>(WCHAR);
00950                     *AliasesBufferPtrW++= (WCHAR)<span class="charliteral">'='</span>;
00951                     RtlCopyMemory(AliasesBufferPtrW,Alias-&gt;<a class="code" href="../../d1/d6/struct__ALIAS.html#o4">Target</a>,Alias-&gt;<a class="code" href="../../d1/d6/struct__ALIAS.html#o2">TargetLength</a>);
00952                     AliasesBufferPtrW+=Alias-&gt;<a class="code" href="../../d1/d6/struct__ALIAS.html#o2">TargetLength</a>/<span class="keyword">sizeof</span>(WCHAR);
00953                     *AliasesBufferPtrW++= (WCHAR)<span class="charliteral">'\0'</span>;
00954                     a-&gt;<a class="code" href="../../d6/d0/struct__CONSOLE__GETALIASES__MSG.html#o5">AliasesBufferLength</a> += Alias-&gt;<a class="code" href="../../d1/d6/struct__ALIAS.html#o1">SourceLength</a> + Alias-&gt;<a class="code" href="../../d1/d6/struct__ALIAS.html#o2">TargetLength</a> + (2*<span class="keyword">sizeof</span>(WCHAR));  <span class="comment">// +2 is for = and term null</span>
00955                 } <span class="keywordflow">else</span> {
00956                     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
00957                     <span class="keywordflow">return</span> (ULONG)STATUS_BUFFER_OVERFLOW;
00958                 }
00959             } <span class="keywordflow">else</span> {
00960                 <span class="keywordflow">if</span> ((a-&gt;<a class="code" href="../../d6/d0/struct__CONSOLE__GETALIASES__MSG.html#o5">AliasesBufferLength</a> + ((Alias-&gt;<a class="code" href="../../d1/d6/struct__ALIAS.html#o1">SourceLength</a> + Alias-&gt;<a class="code" href="../../d1/d6/struct__ALIAS.html#o2">TargetLength</a>)/<span class="keyword">sizeof</span>(WCHAR)) + (2*<span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>)))
00961                     &lt;= AliasesBufferLength) {
00962                     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> SourceLength,TargetLength;
00963                     SourceLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a35">ConvertToOem</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o61">CP</a>,
00964                                                  Alias-&gt;<a class="code" href="../../d1/d6/struct__ALIAS.html#o3">Source</a>,
00965                                                  Alias-&gt;<a class="code" href="../../d1/d6/struct__ALIAS.html#o1">SourceLength</a> / <span class="keyword">sizeof</span>(WCHAR),
00966                                                  AliasesBufferPtrA,
00967                                                  <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a5">CHAR_COUNT</a>(Alias-&gt;<a class="code" href="../../d1/d6/struct__ALIAS.html#o1">SourceLength</a>)
00968                                                  );
00969                     AliasesBufferPtrA+=SourceLength;
00970                     *AliasesBufferPtrA++ = <span class="charliteral">'='</span>;
00971                     TargetLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a35">ConvertToOem</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o61">CP</a>,
00972                                                  Alias-&gt;<a class="code" href="../../d1/d6/struct__ALIAS.html#o4">Target</a>,
00973                                                  Alias-&gt;<a class="code" href="../../d1/d6/struct__ALIAS.html#o2">TargetLength</a> / <span class="keyword">sizeof</span>(WCHAR),
00974                                                  AliasesBufferPtrA,
00975                                                  <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a5">CHAR_COUNT</a>(Alias-&gt;<a class="code" href="../../d1/d6/struct__ALIAS.html#o2">TargetLength</a>)
00976                                                  );
00977                     AliasesBufferPtrA+=TargetLength;
00978                     *AliasesBufferPtrA++= <span class="charliteral">'\0'</span>;
00979                     a-&gt;<a class="code" href="../../d6/d0/struct__CONSOLE__GETALIASES__MSG.html#o5">AliasesBufferLength</a> += SourceLength + TargetLength + (2*<span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>));  <span class="comment">// +2 is for = and term null</span>
00980                 } <span class="keywordflow">else</span> {
00981                     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
00982                     <span class="keywordflow">return</span> (ULONG)STATUS_BUFFER_OVERFLOW;
00983                 }
00984             }
00985             ListNext = ListNext-&gt;Flink;
00986         }
00987     }
00988     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
00989     <span class="keywordflow">return</span> STATUS_SUCCESS;
00990     UNREFERENCED_PARAMETER(ReplyStatus);
00991 }
00992 
00993 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>
<a name="l00994"></a><a class="code" href="../../d8/d5/consrv_8h.html#a243">00994</a> <a class="code" href="../../d8/d5/consrv_8h.html#a243">SrvGetConsoleAliasExesLength</a>(
00995     IN OUT PCSR_API_MSG m,
00996     IN OUT PCSR_REPLY_STATUS ReplyStatus
00997     )
00998 {
00999     <a class="code" href="../../d9/d0/struct__CONSOLE__GETALIASEXESLENGTH__MSG.html">PCONSOLE_GETALIASEXESLENGTH_MSG</a> a = (<a class="code" href="../../d9/d0/struct__CONSOLE__GETALIASEXESLENGTH__MSG.html">PCONSOLE_GETALIASEXESLENGTH_MSG</a>)&amp;m-&gt;u.ApiMessageData;
01000     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
01001     <a class="code" href="../../d6/d8/struct__EXE__ALIAS__LIST.html">PEXE_ALIAS_LIST</a> AliasList;
01002     PLIST_ENTRY ListHead, ListNext;
01003     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01004 
01005     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a33">ApiPreamble</a>(a-&gt;<a class="code" href="../../d9/d0/struct__CONSOLE__GETALIASEXESLENGTH__MSG.html#o0">ConsoleHandle</a>,
01006                          &amp;Console
01007                         );
01008     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01009         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01010     }
01011 
01012     a-&gt;<a class="code" href="../../d9/d0/struct__CONSOLE__GETALIASEXESLENGTH__MSG.html#o1">AliasExesLength</a> = 0;
01013     ListHead = &amp;Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o21">ExeAliasList</a>;
01014     ListNext = ListHead-&gt;Flink;
01015     <span class="keywordflow">while</span> (ListNext != ListHead) {
01016         AliasList = CONTAINING_RECORD( ListNext, <a class="code" href="../../d6/d8/struct__EXE__ALIAS__LIST.html">EXE_ALIAS_LIST</a>, ListLink );
01017         a-&gt;<a class="code" href="../../d9/d0/struct__CONSOLE__GETALIASEXESLENGTH__MSG.html#o1">AliasExesLength</a> += AliasList-&gt;<a class="code" href="../../d6/d8/struct__EXE__ALIAS__LIST.html#o1">ExeLength</a> + (1*<span class="keyword">sizeof</span>(WCHAR)); <span class="comment">// +1 for term null</span>
01018         ListNext = ListNext-&gt;Flink;
01019     }
01020     <span class="keywordflow">if</span> (!a-&gt;<a class="code" href="../../d9/d0/struct__CONSOLE__GETALIASEXESLENGTH__MSG.html#o2">Unicode</a>) {
01021         a-&gt;<a class="code" href="../../d9/d0/struct__CONSOLE__GETALIASEXESLENGTH__MSG.html#o1">AliasExesLength</a> /= <span class="keyword">sizeof</span>(WCHAR);
01022     }
01023     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01024     <span class="keywordflow">return</span> STATUS_SUCCESS;
01025     UNREFERENCED_PARAMETER(ReplyStatus);
01026 }
01027 
01028 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>
<a name="l01029"></a><a class="code" href="../../d8/d5/consrv_8h.html#a245">01029</a> <a class="code" href="../../d8/d5/consrv_8h.html#a245">SrvGetConsoleAliasExes</a>(
01030     IN OUT PCSR_API_MSG m,
01031     IN OUT PCSR_REPLY_STATUS ReplyStatus
01032     )
01033 {
01034     <a class="code" href="../../d8/d0/struct__CONSOLE__GETALIASEXES__MSG.html">PCONSOLE_GETALIASEXES_MSG</a> a = (<a class="code" href="../../d8/d0/struct__CONSOLE__GETALIASEXES__MSG.html">PCONSOLE_GETALIASEXES_MSG</a>)&amp;m-&gt;u.ApiMessageData;
01035     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
01036     <a class="code" href="../../d6/d8/struct__EXE__ALIAS__LIST.html">PEXE_ALIAS_LIST</a> AliasList;
01037     PLIST_ENTRY ListHead, ListNext;
01038     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> AliasExesBufferLength;
01039     LPWSTR AliasExesBufferPtrW;
01040     LPSTR  AliasExesBufferPtrA;
01041     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01042 
01043     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a33">ApiPreamble</a>(a-&gt;<a class="code" href="../../d8/d0/struct__CONSOLE__GETALIASEXES__MSG.html#o0">ConsoleHandle</a>,
01044                          &amp;Console
01045                         );
01046     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01047         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01048     }
01049 
01050     <span class="keywordflow">if</span> (!CsrValidateMessageBuffer(m, &amp;a-&gt;<a class="code" href="../../d8/d0/struct__CONSOLE__GETALIASEXES__MSG.html#o2">AliasExesBuffer</a>, a-&gt;<a class="code" href="../../d8/d0/struct__CONSOLE__GETALIASEXES__MSG.html#o1">AliasExesBufferLength</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>))) {
01051         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01052         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01053     }
01054 
01055     AliasExesBufferLength = a-&gt;<a class="code" href="../../d8/d0/struct__CONSOLE__GETALIASEXES__MSG.html#o1">AliasExesBufferLength</a>;
01056     <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d8/d0/struct__CONSOLE__GETALIASEXES__MSG.html#o3">Unicode</a>) {
01057         AliasExesBufferPtrW = a-&gt;<a class="code" href="../../d8/d0/struct__CONSOLE__GETALIASEXES__MSG.html#o2">AliasExesBuffer</a>;
01058     } <span class="keywordflow">else</span> {
01059         AliasExesBufferPtrA = a-&gt;<a class="code" href="../../d8/d0/struct__CONSOLE__GETALIASEXES__MSG.html#o2">AliasExesBuffer</a>;
01060     }
01061     a-&gt;<a class="code" href="../../d8/d0/struct__CONSOLE__GETALIASEXES__MSG.html#o1">AliasExesBufferLength</a> = 0;
01062     ListHead = &amp;Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o21">ExeAliasList</a>;
01063     ListNext = ListHead-&gt;Flink;
01064     <span class="keywordflow">while</span> (ListNext != ListHead) {
01065         AliasList = CONTAINING_RECORD( ListNext, <a class="code" href="../../d6/d8/struct__EXE__ALIAS__LIST.html">EXE_ALIAS_LIST</a>, ListLink );
01066         <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d8/d0/struct__CONSOLE__GETALIASEXES__MSG.html#o3">Unicode</a>) {
01067             <span class="keywordflow">if</span> ((a-&gt;<a class="code" href="../../d8/d0/struct__CONSOLE__GETALIASEXES__MSG.html#o1">AliasExesBufferLength</a> + AliasList-&gt;<a class="code" href="../../d6/d8/struct__EXE__ALIAS__LIST.html#o1">ExeLength</a> + (1*<span class="keyword">sizeof</span>(WCHAR)))
01068                 &lt;= AliasExesBufferLength) {
01069                 RtlCopyMemory(AliasExesBufferPtrW,AliasList-&gt;<a class="code" href="../../d6/d8/struct__EXE__ALIAS__LIST.html#o2">ExeName</a>,AliasList-&gt;<a class="code" href="../../d6/d8/struct__EXE__ALIAS__LIST.html#o1">ExeLength</a>);
01070                 AliasExesBufferPtrW+=AliasList-&gt;<a class="code" href="../../d6/d8/struct__EXE__ALIAS__LIST.html#o1">ExeLength</a>/<span class="keyword">sizeof</span>(WCHAR);
01071                 *AliasExesBufferPtrW++= (WCHAR)<span class="charliteral">'\0'</span>;
01072                 a-&gt;<a class="code" href="../../d8/d0/struct__CONSOLE__GETALIASEXES__MSG.html#o1">AliasExesBufferLength</a> += AliasList-&gt;<a class="code" href="../../d6/d8/struct__EXE__ALIAS__LIST.html#o1">ExeLength</a> + (1*<span class="keyword">sizeof</span>(WCHAR));  <span class="comment">// +1 is term null</span>
01073             } <span class="keywordflow">else</span> {
01074                 <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01075                 <span class="keywordflow">return</span> (ULONG)STATUS_BUFFER_OVERFLOW;
01076             }
01077         } <span class="keywordflow">else</span> {
01078             <span class="keywordflow">if</span> ((a-&gt;<a class="code" href="../../d8/d0/struct__CONSOLE__GETALIASEXES__MSG.html#o1">AliasExesBufferLength</a> + (AliasList-&gt;<a class="code" href="../../d6/d8/struct__EXE__ALIAS__LIST.html#o1">ExeLength</a>/<span class="keyword">sizeof</span>(WCHAR)) + (1*<span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>)))
01079                 &lt;= AliasExesBufferLength) {
01080                 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> Length;
01081                 Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a35">ConvertToOem</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o61">CP</a>,
01082                                         AliasList-&gt;<a class="code" href="../../d6/d8/struct__EXE__ALIAS__LIST.html#o2">ExeName</a>,
01083                                         AliasList-&gt;<a class="code" href="../../d6/d8/struct__EXE__ALIAS__LIST.html#o1">ExeLength</a> / <span class="keyword">sizeof</span>(WCHAR),
01084                                         AliasExesBufferPtrA,
01085                                         <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a5">CHAR_COUNT</a>(AliasList-&gt;<a class="code" href="../../d6/d8/struct__EXE__ALIAS__LIST.html#o1">ExeLength</a>)
01086                                         );
01087                 AliasExesBufferPtrA+=Length;
01088                 *AliasExesBufferPtrA++= (WCHAR)<span class="charliteral">'\0'</span>;
01089                 a-&gt;<a class="code" href="../../d8/d0/struct__CONSOLE__GETALIASEXES__MSG.html#o1">AliasExesBufferLength</a> += Length + (1*<span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>));  <span class="comment">// +1 is term null</span>
01090             } <span class="keywordflow">else</span> {
01091                 <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01092                 <span class="keywordflow">return</span> (ULONG)STATUS_BUFFER_OVERFLOW;
01093             }
01094         }
01095         ListNext = ListNext-&gt;Flink;
01096     }
01097     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01098     <span class="keywordflow">return</span> STATUS_SUCCESS;
01099     UNREFERENCED_PARAMETER(ReplyStatus);
01100 }
01101 
<a name="l01102"></a><a class="code" href="../../d3/d1/server_2cmdline_8c.html#a11">01102</a> <span class="preprocessor">#define MAX_ARGS 9</span>
01103 <span class="preprocessor"></span>
01104 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01105"></a><a class="code" href="../../d8/d5/consrv_8h.html#a251">01105</a> <a class="code" href="../../d8/d5/consrv_8h.html#a251">MatchandCopyAlias</a>(
01106     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
01107     IN PWCHAR Source,
01108     IN USHORT SourceLength,
01109     OUT PWCHAR TargetBuffer,
01110     IN OUT PUSHORT TargetLength,
01111     IN LPWSTR Exe,
01112     IN USHORT ExeLength,
01113     OUT PDWORD LineCount
01114     )
01115 
01116 <span class="comment">/*++</span>
01117 <span class="comment"></span>
01118 <span class="comment">Routine Description:</span>
01119 <span class="comment"></span>
01120 <span class="comment">    This routine matches the input string with an alias and copies the</span>
01121 <span class="comment">    alias to the input buffer.</span>
01122 <span class="comment"></span>
01123 <span class="comment">Arguments:</span>
01124 <span class="comment"></span>
01125 <span class="comment">    Source - string to match</span>
01126 <span class="comment"></span>
01127 <span class="comment">    SourceLength - length of Source in bytes</span>
01128 <span class="comment"></span>
01129 <span class="comment">    TargetBuffer - where to store matched string</span>
01130 <span class="comment"></span>
01131 <span class="comment">    TargetLength - on input, contains size of TargetBuffer.  On output,</span>
01132 <span class="comment">    contains length of alias stored in TargetBuffer.</span>
01133 <span class="comment"></span>
01134 <span class="comment">    SourceIsCommandLine - if true, source buffer is a command line, where</span>
01135 <span class="comment">        the first blank separate token is to be check for an alias, and if</span>
01136 <span class="comment">        it matches, replaced with the value of the alias.  if false, then</span>
01137 <span class="comment">        the source string is a null terminated alias name.</span>
01138 <span class="comment"></span>
01139 <span class="comment">    LineCount - aliases can contain multiple commands.  $T is the command</span>
01140 <span class="comment">        separator</span>
01141 <span class="comment"></span>
01142 <span class="comment">Return Value:</span>
01143 <span class="comment"></span>
01144 <span class="comment">    SUCCESS - match was found and alias was copied to buffer.</span>
01145 <span class="comment"></span>
01146 <span class="comment">--*/</span>
01147 
01148 {
01149     <a class="code" href="../../d1/d6/struct__ALIAS.html">PALIAS</a> Alias;
01150     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01151     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> SourceUpToFirstBlank=0;  <span class="comment">// in chars</span>
01152     PWCHAR Tmp;
01153     <a class="code" href="../../d6/d8/struct__EXE__ALIAS__LIST.html">PEXE_ALIAS_LIST</a> ExeAliasList;
01154     LPWSTR Args[<a class="code" href="../../d3/d1/server_2cmdline_8c.html#a11">MAX_ARGS</a>];
01155     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> ArgsLength[<a class="code" href="../../d3/d1/server_2cmdline_8c.html#a11">MAX_ARGS</a>];    <span class="comment">// in bytes</span>
01156     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> NumSourceArgs;
01157     LPWSTR SourcePtr;
01158     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> ArgCount,i,j,NewTargetLength;
01159     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> SourceRemainderLength;   <span class="comment">// in chars</span>
01160     PWCHAR <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,TargetAlias;
01161     PWCHAR TmpBuffer;
01162 
01163     <span class="comment">//</span>
01164     <span class="comment">// alloc of exename may have failed.</span>
01165     <span class="comment">//</span>
01166 
01167     <span class="keywordflow">if</span> (Exe == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01168         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
01169 
01170     <span class="comment">//</span>
01171     <span class="comment">// find exe</span>
01172     <span class="comment">//</span>
01173 
01174     ExeAliasList = <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a22">FindExe</a>(Console,Exe,ExeLength,<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01175     <span class="keywordflow">if</span> (!ExeAliasList) {
01176         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
01177     }
01178 
01179     <span class="comment">//</span>
01180     <span class="comment">// find first blank</span>
01181     <span class="comment">//</span>
01182 
01183     <span class="keywordflow">for</span> (Tmp=Source,SourceUpToFirstBlank=0;
01184          *Tmp!=(WCHAR)<span class="charliteral">' '</span> &amp;&amp; SourceUpToFirstBlank&lt;(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(SourceLength/<span class="keyword">sizeof</span>(WCHAR));
01185          Tmp++,SourceUpToFirstBlank++) ;
01186 
01187     <span class="comment">//</span>
01188     <span class="comment">// find char past first blank</span>
01189     <span class="comment">//</span>
01190 
01191     j=SourceUpToFirstBlank;
01192     <span class="keywordflow">while</span> (j&lt;(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(SourceLength/<span class="keyword">sizeof</span>(WCHAR)) &amp;&amp; *Tmp==(WCHAR)<span class="charliteral">' '</span>) {
01193         Tmp++;
01194         j++;
01195     }
01196     SourcePtr = Tmp;
01197     SourceRemainderLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)((SourceLength/<span class="keyword">sizeof</span>(WCHAR)) - j);
01198 
01199     <span class="comment">//</span>
01200     <span class="comment">// find alias</span>
01201     <span class="comment">//</span>
01202 
01203     Alias = <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a23">FindAlias</a>(ExeAliasList,Source,(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(SourceUpToFirstBlank*<span class="keyword">sizeof</span>(WCHAR)));
01204     <span class="keywordflow">if</span> (!Alias) {
01205         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
01206     }
01207 
01208     TmpBuffer = (PWCHAR)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a9">TMP_TAG</a> ),*TargetLength);
01209     <span class="keywordflow">if</span> (!TmpBuffer)
01210         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01211 
01212     <span class="comment">//</span>
01213     <span class="comment">// count args in target</span>
01214     <span class="comment">//</span>
01215 
01216     ArgCount=0;
01217     *LineCount=1;
01218     Tmp=Alias-&gt;<a class="code" href="../../d1/d6/struct__ALIAS.html#o4">Target</a>;
01219     <span class="keywordflow">for</span> (i=0;(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(i+1)&lt;(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(Alias-&gt;<a class="code" href="../../d1/d6/struct__ALIAS.html#o2">TargetLength</a>/<span class="keyword">sizeof</span>(WCHAR));i++) {
01220         <span class="keywordflow">if</span> (*Tmp == (WCHAR)<span class="charliteral">'$'</span> &amp;&amp; *(Tmp+1) &gt;= (WCHAR)<span class="charliteral">'1'</span> &amp;&amp; *(Tmp+1) &lt;= (WCHAR)<span class="charliteral">'9'</span>) {
01221             <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> ArgNum = *(Tmp+1) - (WCHAR)<span class="charliteral">'0'</span>;
01222             <span class="keywordflow">if</span> (ArgNum &gt; ArgCount) {
01223                 ArgCount = ArgNum;
01224             }
01225             Tmp++;
01226             i++;
01227         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*Tmp == (WCHAR)<span class="charliteral">'$'</span> &amp;&amp; *(Tmp+1) == (WCHAR)<span class="charliteral">'*'</span>) {
01228             <span class="keywordflow">if</span> (ArgCount==0) {
01229                 ArgCount = 1;
01230             }
01231             Tmp++;
01232             i++;
01233         }
01234         Tmp++;
01235     }
01236 
01237     <span class="comment">//</span>
01238     <span class="comment">// package up space separated strings in source into array</span>
01239     <span class="comment">// of args</span>
01240     <span class="comment">//</span>
01241     <span class="comment">//</span>
01242 
01243     NumSourceArgs=0;
01244     Tmp = SourcePtr;
01245     <span class="keywordflow">for</span> (i=0,j=0;i&lt;ArgCount;i++) {
01246         <span class="keywordflow">if</span> (j&lt;SourceRemainderLength) {
01247             Args[NumSourceArgs] = Tmp;
01248             ArgsLength[NumSourceArgs] = 0;
01249             <span class="keywordflow">while</span> (j++&lt;SourceRemainderLength &amp;&amp; *Tmp++ != (WCHAR)<span class="charliteral">' '</span>) {
01250                 ArgsLength[NumSourceArgs] += <span class="keyword">sizeof</span>(WCHAR);
01251             }
01252             <span class="keywordflow">while</span> (j&lt;SourceRemainderLength &amp;&amp; *Tmp == (WCHAR)<span class="charliteral">' '</span>) {
01253                 j++;
01254                 Tmp++;
01255             }
01256             NumSourceArgs++;
01257         } <span class="keywordflow">else</span> {
01258             <span class="keywordflow">break</span>;
01259         }
01260     }
01261 
01262     <span class="comment">//</span>
01263     <span class="comment">// put together the target string</span>
01264     <span class="comment">//</span>
01265     <span class="comment">// while (target)</span>
01266     <span class="comment">//     if ($)</span>
01267     <span class="comment">//        if arg &amp;&amp; arg# &lt;= ArgCount</span>
01268     <span class="comment">//            copy arg</span>
01269     <span class="comment">//        else if *</span>
01270     <span class="comment">//            copy arg</span>
01271     <span class="comment">//        else</span>
01272     <span class="comment">//            replace with &lt; &gt; etc</span>
01273     <span class="comment">//     else</span>
01274     <span class="comment">//        copy text up to next ' '</span>
01275     <span class="comment">//</span>
01276 
01277     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = TmpBuffer;
01278     NewTargetLength = 2*<span class="keyword">sizeof</span>(WCHAR);    <span class="comment">// for CRLF</span>
01279     TargetAlias=Alias-&gt;<a class="code" href="../../d1/d6/struct__ALIAS.html#o4">Target</a>;
01280     <span class="keywordflow">for</span> (i=0;i&lt;(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(Alias-&gt;<a class="code" href="../../d1/d6/struct__ALIAS.html#o2">TargetLength</a>/<span class="keyword">sizeof</span>(WCHAR));i++) {
01281         <span class="keywordflow">if</span> (NewTargetLength &gt;= *TargetLength) {
01282             *TargetLength = NewTargetLength;
01283             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_BUFFER_TOO_SMALL;
01284             <span class="keywordflow">break</span>;
01285         }
01286         <span class="keywordflow">if</span> (*TargetAlias == (WCHAR)<span class="charliteral">'$'</span> &amp;&amp; (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(i+1)&lt;(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(Alias-&gt;<a class="code" href="../../d1/d6/struct__ALIAS.html#o2">TargetLength</a>/<span class="keyword">sizeof</span>(WCHAR))) {
01287             TargetAlias++;
01288             i++;
01289             <span class="keywordflow">if</span> (*TargetAlias &gt;= (WCHAR)<span class="charliteral">'1'</span> &amp;&amp; *TargetAlias &lt;= (WCHAR)<span class="charliteral">'9'</span>) {
01290 
01291                 <span class="comment">//</span>
01292                 <span class="comment">// do numbered parameter substitution</span>
01293                 <span class="comment">//</span>
01294 
01295                 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> ArgNumber;
01296 
01297                 ArgNumber = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(*TargetAlias - (WCHAR)<span class="charliteral">'1'</span>);
01298                 <span class="keywordflow">if</span> (ArgNumber &lt; NumSourceArgs) {
01299                     <span class="keywordflow">if</span> ((NewTargetLength+ArgsLength[ArgNumber])&lt;=*TargetLength) {
01300                         RtlCopyMemory(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,Args[ArgNumber],ArgsLength[ArgNumber]);
01301                         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>+=ArgsLength[ArgNumber]/<span class="keyword">sizeof</span>(WCHAR);
01302                         NewTargetLength+=ArgsLength[ArgNumber];
01303                     } <span class="keywordflow">else</span> {
01304                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_BUFFER_TOO_SMALL;
01305                         <span class="keywordflow">break</span>;
01306                     }
01307                 }
01308             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*TargetAlias == (WCHAR)<span class="charliteral">'*'</span>) {
01309 
01310                 <span class="comment">//</span>
01311                 <span class="comment">// do * parameter substitution</span>
01312                 <span class="comment">//</span>
01313 
01314                 <span class="keywordflow">if</span> (NumSourceArgs) {
01315                     <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(NewTargetLength+(SourceRemainderLength*<span class="keyword">sizeof</span>(WCHAR)))&lt;=*TargetLength) {
01316                         RtlCopyMemory(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,Args[0],SourceRemainderLength*<span class="keyword">sizeof</span>(WCHAR));
01317                         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>+=SourceRemainderLength;
01318                         NewTargetLength+=SourceRemainderLength*<span class="keyword">sizeof</span>(WCHAR);
01319                     } <span class="keywordflow">else</span> {
01320                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_BUFFER_TOO_SMALL;
01321                         <span class="keywordflow">break</span>;
01322                     }
01323                 }
01324             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*TargetAlias == (WCHAR)<span class="charliteral">'l'</span> || *TargetAlias == (WCHAR)<span class="charliteral">'L'</span>) {
01325 
01326                 <span class="comment">//</span>
01327                 <span class="comment">// do &lt; substitution</span>
01328                 <span class="comment">//</span>
01329 
01330                 *<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>++ = (WCHAR)<span class="charliteral">'&lt;'</span>;
01331                 NewTargetLength+=<span class="keyword">sizeof</span>(WCHAR);
01332             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*TargetAlias == (WCHAR)<span class="charliteral">'g'</span> || *TargetAlias == (WCHAR)<span class="charliteral">'G'</span>) {
01333 
01334                 <span class="comment">//</span>
01335                 <span class="comment">// do &gt; substitution</span>
01336                 <span class="comment">//</span>
01337 
01338                 *<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>++ = (WCHAR)<span class="charliteral">'&gt;'</span>;
01339                 NewTargetLength+=<span class="keyword">sizeof</span>(WCHAR);
01340             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*TargetAlias == (WCHAR)<span class="charliteral">'b'</span> || *TargetAlias == (WCHAR)<span class="charliteral">'B'</span>) {
01341 
01342                 <span class="comment">//</span>
01343                 <span class="comment">// do | substitution</span>
01344                 <span class="comment">//</span>
01345 
01346                 *<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>++ = (WCHAR)<span class="charliteral">'|'</span>;
01347                 NewTargetLength+=<span class="keyword">sizeof</span>(WCHAR);
01348             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*TargetAlias == (WCHAR)<span class="charliteral">'t'</span> || *TargetAlias == (WCHAR)<span class="charliteral">'T'</span>) {
01349 
01350                 <span class="comment">//</span>
01351                 <span class="comment">// do newline substitution</span>
01352                 <span class="comment">//</span>
01353 
01354                 <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(NewTargetLength+(<span class="keyword">sizeof</span>(WCHAR)*2))&gt;*TargetLength) {
01355                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_BUFFER_TOO_SMALL;
01356                 }
01357 
01358                 *LineCount += 1;
01359                 *<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>++ = <a class="code" href="../../d4/d5/conimep_8h.html#a53">UNICODE_CARRIAGERETURN</a>;
01360                 *<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>++ = <a class="code" href="../../d4/d5/conimep_8h.html#a54">UNICODE_LINEFEED</a>;
01361                 NewTargetLength+=<span class="keyword">sizeof</span>(WCHAR)*2;
01362             } <span class="keywordflow">else</span> {
01363 
01364                 <span class="comment">//</span>
01365                 <span class="comment">// copy $X</span>
01366                 <span class="comment">//</span>
01367 
01368                 *<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>++ = (WCHAR)<span class="charliteral">'$'</span>;
01369                 NewTargetLength+=<span class="keyword">sizeof</span>(WCHAR);
01370                 *<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>++ = *TargetAlias;
01371                 NewTargetLength+=<span class="keyword">sizeof</span>(WCHAR);
01372             }
01373             TargetAlias++;
01374         } <span class="keywordflow">else</span> {
01375 
01376             <span class="comment">//</span>
01377             <span class="comment">// copy char</span>
01378             <span class="comment">//</span>
01379 
01380             *<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>++ = *TargetAlias++;
01381             NewTargetLength+=<span class="keyword">sizeof</span>(WCHAR);
01382         }
01383     }
01384     *<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>++ = <a class="code" href="../../d4/d5/conimep_8h.html#a53">UNICODE_CARRIAGERETURN</a>;
01385     *<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>++ = <a class="code" href="../../d4/d5/conimep_8h.html#a54">UNICODE_LINEFEED</a>;
01386     RtlCopyMemory(TargetBuffer,TmpBuffer,NewTargetLength);
01387     <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(TmpBuffer);
01388     *TargetLength = NewTargetLength;
01389     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01390 }
01391 
01392 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>
<a name="l01393"></a><a class="code" href="../../d8/d5/consrv_8h.html#a246">01393</a> <a class="code" href="../../d8/d5/consrv_8h.html#a246">SrvExpungeConsoleCommandHistory</a>(
01394     IN OUT PCSR_API_MSG m,
01395     IN OUT PCSR_REPLY_STATUS ReplyStatus
01396     )
01397 {
01398     <a class="code" href="../../d1/d0/struct__CONSOLE__EXPUNGECOMMANDHISTORY__MSG.html">PCONSOLE_EXPUNGECOMMANDHISTORY_MSG</a> a = (<a class="code" href="../../d1/d0/struct__CONSOLE__EXPUNGECOMMANDHISTORY__MSG.html">PCONSOLE_EXPUNGECOMMANDHISTORY_MSG</a>)&amp;m-&gt;u.ApiMessageData;
01399     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
01400     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01401 
01402     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a33">ApiPreamble</a>(a-&gt;<a class="code" href="../../d1/d0/struct__CONSOLE__EXPUNGECOMMANDHISTORY__MSG.html#o0">ConsoleHandle</a>,
01403                          &amp;Console
01404                         );
01405     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01406         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01407     }
01408 
01409     <span class="keywordflow">if</span> (!CsrValidateMessageBuffer(m, &amp;a-&gt;<a class="code" href="../../d1/d0/struct__CONSOLE__EXPUNGECOMMANDHISTORY__MSG.html#o2">Exe</a>, a-&gt;<a class="code" href="../../d1/d0/struct__CONSOLE__EXPUNGECOMMANDHISTORY__MSG.html#o1">ExeLength</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>))) {
01410         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01411         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01412     }
01413 
01414     <a class="code" href="../../d4/d1/cmdline_8h.html#a43">EmptyCommandHistory</a>(<a class="code" href="../../d4/d1/cmdline_8h.html#a45">FindExeCommandHistory</a>(Console,
01415                                               a-&gt;<a class="code" href="../../d1/d0/struct__CONSOLE__EXPUNGECOMMANDHISTORY__MSG.html#o2">Exe</a>,
01416                                               a-&gt;<a class="code" href="../../d1/d0/struct__CONSOLE__EXPUNGECOMMANDHISTORY__MSG.html#o1">ExeLength</a>,
01417                                               a-&gt;<a class="code" href="../../d1/d0/struct__CONSOLE__EXPUNGECOMMANDHISTORY__MSG.html#o4">UnicodeExe</a>));
01418     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01419     <span class="keywordflow">return</span> STATUS_SUCCESS;
01420     UNREFERENCED_PARAMETER(ReplyStatus);
01421 }
01422 
01423 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>
<a name="l01424"></a><a class="code" href="../../d8/d5/consrv_8h.html#a247">01424</a> <a class="code" href="../../d8/d5/consrv_8h.html#a247">SrvSetConsoleNumberOfCommands</a>(
01425     IN OUT PCSR_API_MSG m,
01426     IN OUT PCSR_REPLY_STATUS ReplyStatus
01427     )
01428 {
01429     <a class="code" href="../../d2/d6/struct__CONSOLE__SETNUMBEROFCOMMANDS__MSG.html">PCONSOLE_SETNUMBEROFCOMMANDS_MSG</a> a = (<a class="code" href="../../d2/d6/struct__CONSOLE__SETNUMBEROFCOMMANDS__MSG.html">PCONSOLE_SETNUMBEROFCOMMANDS_MSG</a>)&amp;m-&gt;u.ApiMessageData;
01430     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
01431     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01432 
01433     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a33">ApiPreamble</a>(a-&gt;<a class="code" href="../../d2/d6/struct__CONSOLE__SETNUMBEROFCOMMANDS__MSG.html#o0">ConsoleHandle</a>,
01434                          &amp;Console
01435                         );
01436     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01437         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01438     }
01439 
01440     <span class="keywordflow">if</span> (!CsrValidateMessageBuffer(m, &amp;a-&gt;<a class="code" href="../../d2/d6/struct__CONSOLE__SETNUMBEROFCOMMANDS__MSG.html#o3">Exe</a>, a-&gt;<a class="code" href="../../d2/d6/struct__CONSOLE__SETNUMBEROFCOMMANDS__MSG.html#o2">ExeLength</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>))) {
01441         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01442         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01443     }
01444 
01445     <a class="code" href="../../d4/d1/cmdline_8h.html#a44">ReallocCommandHistory</a>(Console,
01446                           <a class="code" href="../../d4/d1/cmdline_8h.html#a45">FindExeCommandHistory</a>(Console,
01447                                                 a-&gt;<a class="code" href="../../d2/d6/struct__CONSOLE__SETNUMBEROFCOMMANDS__MSG.html#o3">Exe</a>,
01448                                                 a-&gt;<a class="code" href="../../d2/d6/struct__CONSOLE__SETNUMBEROFCOMMANDS__MSG.html#o2">ExeLength</a>,
01449                                                 a-&gt;<a class="code" href="../../d2/d6/struct__CONSOLE__SETNUMBEROFCOMMANDS__MSG.html#o5">UnicodeExe</a>),
01450                           a-&gt;<a class="code" href="../../d2/d6/struct__CONSOLE__SETNUMBEROFCOMMANDS__MSG.html#o1">NumCommands</a>
01451                          );
01452     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01453     <span class="keywordflow">return</span> STATUS_SUCCESS;
01454     UNREFERENCED_PARAMETER(ReplyStatus);
01455 }
01456 
01457 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>
<a name="l01458"></a><a class="code" href="../../d8/d5/consrv_8h.html#a248">01458</a> <a class="code" href="../../d8/d5/consrv_8h.html#a248">SrvGetConsoleCommandHistoryLength</a>(
01459     IN OUT PCSR_API_MSG m,
01460     IN OUT PCSR_REPLY_STATUS ReplyStatus
01461     )
01462 {
01463     <a class="code" href="../../d1/d1/struct__CONSOLE__GETCOMMANDHISTORYLENGTH__MSG.html">PCONSOLE_GETCOMMANDHISTORYLENGTH_MSG</a> a = (<a class="code" href="../../d1/d1/struct__CONSOLE__GETCOMMANDHISTORYLENGTH__MSG.html">PCONSOLE_GETCOMMANDHISTORYLENGTH_MSG</a>)&amp;m-&gt;u.ApiMessageData;
01464     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
01465     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01466     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> i;
01467     <a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html">PCOMMAND_HISTORY</a> CommandHistory;
01468 
01469     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a33">ApiPreamble</a>(a-&gt;<a class="code" href="../../d1/d1/struct__CONSOLE__GETCOMMANDHISTORYLENGTH__MSG.html#o0">ConsoleHandle</a>,
01470                          &amp;Console
01471                         );
01472     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01473         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01474     }
01475 
01476     <span class="keywordflow">if</span> (!CsrValidateMessageBuffer(m, &amp;a-&gt;<a class="code" href="../../d1/d1/struct__CONSOLE__GETCOMMANDHISTORYLENGTH__MSG.html#o3">Exe</a>, a-&gt;<a class="code" href="../../d1/d1/struct__CONSOLE__GETCOMMANDHISTORYLENGTH__MSG.html#o2">ExeLength</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>))) {
01477         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01478         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01479     }
01480 
01481     a-&gt;<a class="code" href="../../d1/d1/struct__CONSOLE__GETCOMMANDHISTORYLENGTH__MSG.html#o1">CommandHistoryLength</a>=0;
01482     CommandHistory=<a class="code" href="../../d4/d1/cmdline_8h.html#a45">FindExeCommandHistory</a>(Console,
01483                                          a-&gt;<a class="code" href="../../d1/d1/struct__CONSOLE__GETCOMMANDHISTORYLENGTH__MSG.html#o3">Exe</a>,
01484                                          a-&gt;<a class="code" href="../../d1/d1/struct__CONSOLE__GETCOMMANDHISTORYLENGTH__MSG.html#o2">ExeLength</a>,
01485                                          a-&gt;<a class="code" href="../../d1/d1/struct__CONSOLE__GETCOMMANDHISTORYLENGTH__MSG.html#o5">UnicodeExe</a>);
01486     <span class="keywordflow">if</span> (CommandHistory) {
01487         <span class="keywordflow">for</span> (i=0;i&lt;CommandHistory-&gt;<a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html#o3">NumberOfCommands</a>;i++) {
01488             a-&gt;<a class="code" href="../../d1/d1/struct__CONSOLE__GETCOMMANDHISTORYLENGTH__MSG.html#o1">CommandHistoryLength</a>+=CommandHistory-&gt;<a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html#o10">Commands</a>[i]-&gt;<a class="code" href="../../d8/d7/struct__COMMAND.html#o0">CommandLength</a>+<span class="keyword">sizeof</span>(WCHAR);
01489         }
01490     }
01491     <span class="keywordflow">if</span> (!a-&gt;<a class="code" href="../../d1/d1/struct__CONSOLE__GETCOMMANDHISTORYLENGTH__MSG.html#o4">Unicode</a>) {
01492         a-&gt;<a class="code" href="../../d1/d1/struct__CONSOLE__GETCOMMANDHISTORYLENGTH__MSG.html#o1">CommandHistoryLength</a> /= <span class="keyword">sizeof</span>(WCHAR);
01493     }
01494     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01495     <span class="keywordflow">return</span> STATUS_SUCCESS;
01496     UNREFERENCED_PARAMETER(ReplyStatus);
01497 }
01498 
01499 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>
<a name="l01500"></a><a class="code" href="../../d8/d5/consrv_8h.html#a249">01500</a> <a class="code" href="../../d8/d5/consrv_8h.html#a249">SrvGetConsoleCommandHistory</a>(
01501     IN OUT PCSR_API_MSG m,
01502     IN OUT PCSR_REPLY_STATUS ReplyStatus
01503     )
01504 {
01505     <a class="code" href="../../d0/d1/struct__CONSOLE__GETCOMMANDHISTORY__MSG.html">PCONSOLE_GETCOMMANDHISTORY_MSG</a> a = (<a class="code" href="../../d0/d1/struct__CONSOLE__GETCOMMANDHISTORY__MSG.html">PCONSOLE_GETCOMMANDHISTORY_MSG</a>)&amp;m-&gt;u.ApiMessageData;
01506     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
01507     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01508     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> i,CommandHistoryLength;
01509     <a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html">PCOMMAND_HISTORY</a> CommandHistory;
01510     PWCHAR CommandBufferW;
01511     PCHAR CommandBufferA;
01512 
01513     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a33">ApiPreamble</a>(a-&gt;<a class="code" href="../../d0/d1/struct__CONSOLE__GETCOMMANDHISTORY__MSG.html#o0">ConsoleHandle</a>,
01514                          &amp;Console
01515                         );
01516     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01517         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01518     }
01519 
01520     <span class="keywordflow">if</span> (!CsrValidateMessageBuffer(m, &amp;a-&gt;<a class="code" href="../../d0/d1/struct__CONSOLE__GETCOMMANDHISTORY__MSG.html#o2">CommandBuffer</a>, a-&gt;<a class="code" href="../../d0/d1/struct__CONSOLE__GETCOMMANDHISTORY__MSG.html#o1">CommandBufferLength</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)) ||
01521         !CsrValidateMessageBuffer(m, &amp;a-&gt;<a class="code" href="../../d0/d1/struct__CONSOLE__GETCOMMANDHISTORY__MSG.html#o4">Exe</a>, a-&gt;<a class="code" href="../../d0/d1/struct__CONSOLE__GETCOMMANDHISTORY__MSG.html#o3">ExeLength</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>))) {
01522 
01523         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01524         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01525     }
01526 
01527     <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d0/d1/struct__CONSOLE__GETCOMMANDHISTORY__MSG.html#o5">Unicode</a>) {
01528         CommandBufferW=a-&gt;<a class="code" href="../../d0/d1/struct__CONSOLE__GETCOMMANDHISTORY__MSG.html#o2">CommandBuffer</a>;
01529     } <span class="keywordflow">else</span> {
01530         CommandBufferA=a-&gt;<a class="code" href="../../d0/d1/struct__CONSOLE__GETCOMMANDHISTORY__MSG.html#o2">CommandBuffer</a>;
01531     }
01532     CommandHistoryLength=0;
01533     CommandHistory=<a class="code" href="../../d4/d1/cmdline_8h.html#a45">FindExeCommandHistory</a>(Console,
01534                                          a-&gt;<a class="code" href="../../d0/d1/struct__CONSOLE__GETCOMMANDHISTORY__MSG.html#o4">Exe</a>,
01535                                          a-&gt;<a class="code" href="../../d0/d1/struct__CONSOLE__GETCOMMANDHISTORY__MSG.html#o3">ExeLength</a>,
01536                                          a-&gt;<a class="code" href="../../d0/d1/struct__CONSOLE__GETCOMMANDHISTORY__MSG.html#o6">UnicodeExe</a>);
01537     <span class="keywordflow">if</span> (CommandHistory) {
01538         <span class="keywordflow">for</span> (i=0;i&lt;CommandHistory-&gt;<a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html#o3">NumberOfCommands</a>;i++) {
01539             <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d0/d1/struct__CONSOLE__GETCOMMANDHISTORY__MSG.html#o5">Unicode</a>) {
01540                 <span class="keywordflow">if</span> ((CommandHistoryLength+CommandHistory-&gt;<a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html#o10">Commands</a>[i]-&gt;<a class="code" href="../../d8/d7/struct__COMMAND.html#o0">CommandLength</a>+<span class="keyword">sizeof</span>(WCHAR)) &lt;= a-&gt;<a class="code" href="../../d0/d1/struct__CONSOLE__GETCOMMANDHISTORY__MSG.html#o1">CommandBufferLength</a>) {
01541                     RtlCopyMemory(CommandBufferW,CommandHistory-&gt;<a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html#o10">Commands</a>[i]-&gt;<a class="code" href="../../d8/d7/struct__COMMAND.html#o1">Command</a>,CommandHistory-&gt;<a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html#o10">Commands</a>[i]-&gt;<a class="code" href="../../d8/d7/struct__COMMAND.html#o0">CommandLength</a>);
01542                     CommandBufferW+=CommandHistory-&gt;<a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html#o10">Commands</a>[i]-&gt;<a class="code" href="../../d8/d7/struct__COMMAND.html#o0">CommandLength</a>/<span class="keyword">sizeof</span>(WCHAR);
01543                     *CommandBufferW++=(WCHAR)<span class="charliteral">'\0'</span>;
01544                     CommandHistoryLength+=CommandHistory-&gt;<a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html#o10">Commands</a>[i]-&gt;<a class="code" href="../../d8/d7/struct__COMMAND.html#o0">CommandLength</a>+<span class="keyword">sizeof</span>(WCHAR);
01545                 } <span class="keywordflow">else</span> {
01546                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_BUFFER_OVERFLOW;
01547                     <span class="keywordflow">break</span>;
01548                 }
01549             } <span class="keywordflow">else</span> {
01550                 <span class="keywordflow">if</span> ((CommandHistoryLength+(CommandHistory-&gt;<a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html#o10">Commands</a>[i]-&gt;<a class="code" href="../../d8/d7/struct__COMMAND.html#o0">CommandLength</a>/<span class="keyword">sizeof</span>(WCHAR))+<span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>)) &lt;= a-&gt;<a class="code" href="../../d0/d1/struct__CONSOLE__GETCOMMANDHISTORY__MSG.html#o1">CommandBufferLength</a>) {
01551                     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> Length;
01552                     Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a35">ConvertToOem</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o61">CP</a>,
01553                                             CommandHistory-&gt;<a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html#o10">Commands</a>[i]-&gt;<a class="code" href="../../d8/d7/struct__COMMAND.html#o1">Command</a>,
01554                                             CommandHistory-&gt;<a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html#o10">Commands</a>[i]-&gt;<a class="code" href="../../d8/d7/struct__COMMAND.html#o0">CommandLength</a> / <span class="keyword">sizeof</span>(WCHAR),
01555                                             CommandBufferA,
01556                                             <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a5">CHAR_COUNT</a>(CommandHistory-&gt;<a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html#o10">Commands</a>[i]-&gt;<a class="code" href="../../d8/d7/struct__COMMAND.html#o0">CommandLength</a>)
01557                                             );
01558                     CommandBufferA+=Length;
01559                     *CommandBufferA++=(WCHAR)<span class="charliteral">'\0'</span>;
01560                     CommandHistoryLength+=CommandHistory-&gt;<a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html#o10">Commands</a>[i]-&gt;<a class="code" href="../../d8/d7/struct__COMMAND.html#o0">CommandLength</a>+<span class="keyword">sizeof</span>(WCHAR);
01561                 } <span class="keywordflow">else</span> {
01562                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_BUFFER_OVERFLOW;
01563                     <span class="keywordflow">break</span>;
01564                 }
01565             }
01566         }
01567     }
01568     a-&gt;<a class="code" href="../../d0/d1/struct__CONSOLE__GETCOMMANDHISTORY__MSG.html#o1">CommandBufferLength</a>=CommandHistoryLength;
01569     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01570     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01571     UNREFERENCED_PARAMETER(ReplyStatus);
01572 }
01573 
01574 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>
<a name="l01575"></a><a class="code" href="../../d8/d5/consrv_8h.html#a250">01575</a> <a class="code" href="../../d8/d5/consrv_8h.html#a250">SrvSetConsoleCommandHistoryMode</a>(
01576     IN OUT PCSR_API_MSG m,
01577     IN OUT PCSR_REPLY_STATUS ReplyStatus
01578     )
01579 {
01580     <a class="code" href="../../d0/d5/struct__CONSOLE__SETCOMMANDHISTORYMODE__MSG.html">PCONSOLE_SETCOMMANDHISTORYMODE_MSG</a> a = (<a class="code" href="../../d0/d5/struct__CONSOLE__SETCOMMANDHISTORYMODE__MSG.html">PCONSOLE_SETCOMMANDHISTORYMODE_MSG</a>)&amp;m-&gt;u.ApiMessageData;
01581     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
01582     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01583 
01584     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a33">ApiPreamble</a>(a-&gt;<a class="code" href="../../d0/d5/struct__CONSOLE__SETCOMMANDHISTORYMODE__MSG.html#o0">ConsoleHandle</a>,
01585                          &amp;Console
01586                         );
01587     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01588         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01589     }
01590     Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o43">InsertMode</a> = (BOOLEAN) (a-&gt;<a class="code" href="../../d0/d5/struct__CONSOLE__SETCOMMANDHISTORYMODE__MSG.html#o1">Flags</a> != CONSOLE_OVERSTRIKE);
01591     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01592     <span class="keywordflow">return</span> STATUS_SUCCESS;
01593     UNREFERENCED_PARAMETER(ReplyStatus);
01594 }
01595 
01596 <a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html">PCOMMAND_HISTORY</a>
<a name="l01597"></a><a class="code" href="../../d4/d1/cmdline_8h.html#a44">01597</a> <a class="code" href="../../d4/d1/cmdline_8h.html#a44">ReallocCommandHistory</a>(
01598     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
01599     IN <a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html">PCOMMAND_HISTORY</a> CurrentCommandHistory,
01600     IN DWORD NumCommands
01601     )
01602 {
01603     <a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html">PCOMMAND_HISTORY</a> <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>;
01604     <span class="keywordtype">int</span> i;
01605 
01606     <span class="keywordflow">if</span> (CurrentCommandHistory == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
01607         CurrentCommandHistory-&gt;MaximumNumberOfCommands==(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)NumCommands) {
01608         <span class="keywordflow">return</span> CurrentCommandHistory;
01609     }
01610     <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a> = (<a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html">PCOMMAND_HISTORY</a>)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a12">HISTORY_TAG</a> ),<span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html">COMMAND_HISTORY</a>) + ((NumCommands-1) * <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d7/struct__COMMAND.html">PCOMMAND</a>)));
01611     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01612         <span class="keywordflow">return</span> CurrentCommandHistory;
01613     }
01614     *<a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>=*CurrentCommandHistory;
01615     <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>-&gt;Flags |= <a class="code" href="../../d4/d1/cmdline_8h.html#a5">CLE_RESET</a>;
01616     <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>-&gt;NumberOfCommands = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(<a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>-&gt;NumberOfCommands, (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)NumCommands);
01617     <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>-&gt;LastAdded = <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>-&gt;NumberOfCommands - 1;
01618     <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>-&gt;LastDisplayed = <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>-&gt;NumberOfCommands - 1;
01619     <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>-&gt;FirstCommand = 0;
01620     <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>-&gt;MaximumNumberOfCommands=(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)NumCommands;
01621     <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>-&gt;NumberOfCommands; i++) {
01622         <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>-&gt;Commands[i] = CurrentCommandHistory-&gt;Commands[<a class="code" href="../../d4/d1/cmdline_8h.html#a8">COMMAND_NUM_TO_INDEX</a>(i,CurrentCommandHistory)];
01623     }
01624     <span class="keywordflow">for</span> (; i&lt;CurrentCommandHistory-&gt;NumberOfCommands; i++) {
01625         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(CurrentCommandHistory-&gt;Commands[<a class="code" href="../../d4/d1/cmdline_8h.html#a8">COMMAND_NUM_TO_INDEX</a>(i,CurrentCommandHistory)]);
01626     }
01627 
01628     RemoveEntryList(&amp;CurrentCommandHistory-&gt;ListLink);
01629     InitializeListHead(&amp;<a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>-&gt;PopupList);
01630     InsertHeadList(&amp;Console-&gt;CommandHistoryList,&amp;<a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>-&gt;ListLink);
01631 
01632     <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(CurrentCommandHistory);
01633     <span class="keywordflow">return</span> <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>;
01634 }
01635 
01636 <a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html">PCOMMAND_HISTORY</a>
<a name="l01637"></a><a class="code" href="../../d4/d1/cmdline_8h.html#a45">01637</a> <a class="code" href="../../d4/d1/cmdline_8h.html#a45">FindExeCommandHistory</a>(
01638     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
01639     IN PVOID AppName,
01640     IN DWORD AppNameLength,
01641     IN BOOLEAN Unicode
01642     )
01643 {
01644     <a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html">PCOMMAND_HISTORY</a> <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>;
01645     PLIST_ENTRY ListHead, ListNext;
01646     PWCHAR AppNamePtr;
01647 
01648     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a>) {
01649         AppNamePtr = (PWCHAR)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a9">TMP_TAG</a> ),AppNameLength * <span class="keyword">sizeof</span>(WCHAR));
01650         <span class="keywordflow">if</span> (AppNamePtr == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01651             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01652         }
01653         AppNameLength = <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a36">ConvertInputToUnicode</a>(Console-&gt;CP,
01654                                   AppName,
01655                                   AppNameLength,
01656                                   AppNamePtr,
01657                                   AppNameLength);
01658         AppNameLength *= 2;
01659     } <span class="keywordflow">else</span> {
01660         AppNamePtr = AppName;
01661     }
01662     ListHead = &amp;Console-&gt;CommandHistoryList;
01663     ListNext = ListHead-&gt;Flink;
01664     <span class="keywordflow">while</span> (ListNext != ListHead) {
01665         <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a> = CONTAINING_RECORD( ListNext, <a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html">COMMAND_HISTORY</a>, ListLink );
01666         ListNext = ListNext-&gt;Flink;
01667 
01668         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>-&gt;Flags &amp; <a class="code" href="../../d4/d1/cmdline_8h.html#a4">CLE_ALLOCATED</a> &amp;&amp;
01669             !<a class="code" href="../../d3/d1/server_2cmdline_8c.html#a9">my_wcsncmpi</a>(<a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>-&gt;AppName,AppNamePtr,(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)AppNameLength)) {
01670             <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a>) {
01671                 <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(AppNamePtr);
01672             }
01673             <span class="keywordflow">return</span> <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>;
01674         }
01675     }
01676     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a>) {
01677         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(AppNamePtr);
01678     }
01679     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01680 }
01681 
01682 <a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html">PCOMMAND_HISTORY</a>
<a name="l01683"></a><a class="code" href="../../d8/d5/consrv_8h.html#a254">01683</a> <a class="code" href="../../d8/d5/consrv_8h.html#a254">AllocateCommandHistory</a>(
01684     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
01685     IN DWORD AppNameLength,
01686     IN PWCHAR AppName,
01687     IN HANDLE ProcessHandle
01688     )
01689 
01690 <span class="comment">/*++</span>
01691 <span class="comment"></span>
01692 <span class="comment">Routine Description:</span>
01693 <span class="comment"></span>
01694 <span class="comment">    This routine returns the LRU command history buffer, or the command history</span>
01695 <span class="comment">    buffer that corresponds to the app name.</span>
01696 <span class="comment"></span>
01697 <span class="comment">Arguments:</span>
01698 <span class="comment"></span>
01699 <span class="comment">    Console - pointer to console.</span>
01700 <span class="comment"></span>
01701 <span class="comment">Return Value:</span>
01702 <span class="comment"></span>
01703 <span class="comment">    Pointer to command history buffer.  if none are available, returns NULL.</span>
01704 <span class="comment"></span>
01705 <span class="comment">--*/</span>
01706 
01707 {
01708     <a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html">PCOMMAND_HISTORY</a> <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>,BestCandidate;
01709     PLIST_ENTRY ListHead, ListNext;
01710     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> SameApp;
01711 
01712     <span class="comment">//</span>
01713     <span class="comment">// Reuse a history buffer.  The buffer must be !CLE_ALLOCATED.</span>
01714     <span class="comment">// If possible, the buffer should have the same app name.</span>
01715     <span class="comment">//</span>
01716 
01717     ListHead = &amp;Console-&gt;CommandHistoryList;
01718     ListNext = ListHead-&gt;Blink;
01719     BestCandidate = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01720     SameApp = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01721     <span class="keywordflow">while</span> (ListNext != ListHead) {
01722         <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a> = CONTAINING_RECORD( ListNext, <a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html">COMMAND_HISTORY</a>, ListLink );
01723         ListNext = ListNext-&gt;Blink;
01724 
01725         <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>-&gt;Flags &amp; <a class="code" href="../../d4/d1/cmdline_8h.html#a4">CLE_ALLOCATED</a>) == 0) {
01726 
01727             <span class="comment">//</span>
01728             <span class="comment">// use LRU history buffer with same app name</span>
01729             <span class="comment">//</span>
01730 
01731             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>-&gt;AppName &amp;&amp; !<a class="code" href="../../d3/d1/server_2cmdline_8c.html#a9">my_wcsncmpi</a>(<a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>-&gt;AppName,AppName,(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)AppNameLength)) {
01732                 BestCandidate = <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>;
01733                 SameApp = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01734                 <span class="keywordflow">break</span>;
01735             }
01736 
01737             <span class="comment">//</span>
01738             <span class="comment">// second best choice is LRU history buffer</span>
01739             <span class="comment">//</span>
01740 
01741             <span class="keywordflow">if</span> (BestCandidate == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01742                 BestCandidate = <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>;
01743             }
01744         }
01745     }
01746 
01747     <span class="comment">//</span>
01748     <span class="comment">// if there isn't a free buffer for the app name and the maximum number of</span>
01749     <span class="comment">// command history buffers hasn't been allocated, allocate a new one.</span>
01750     <span class="comment">//</span>
01751 
01752     <span class="keywordflow">if</span> (!SameApp &amp;&amp; Console-&gt;NumCommandHistories &lt; Console-&gt;MaxCommandHistories) {
01753         <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a> = (<a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html">PCOMMAND_HISTORY</a>)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a12">HISTORY_TAG</a> ),<span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html">COMMAND_HISTORY</a>) + ((Console-&gt;CommandHistorySize-1) * <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d7/struct__COMMAND.html">PCOMMAND</a>)));
01754         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01755             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01756         }
01757         <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>-&gt;AppName = (LPWSTR)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a12">HISTORY_TAG</a> ),AppNameLength);
01758         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>-&gt;AppName == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01759             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(<a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>);
01760             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01761         }
01762         RtlCopyMemory(<a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>-&gt;AppName,AppName,AppNameLength);
01763         <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>-&gt;Flags = <a class="code" href="../../d4/d1/cmdline_8h.html#a4">CLE_ALLOCATED</a>;
01764         <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>-&gt;NumberOfCommands = 0;
01765         <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>-&gt;LastAdded = -1;
01766         <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>-&gt;LastDisplayed = -1;
01767         <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>-&gt;FirstCommand = 0;
01768         <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>-&gt;MaximumNumberOfCommands = Console-&gt;CommandHistorySize;
01769         InsertHeadList(&amp;Console-&gt;CommandHistoryList,&amp;<a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>-&gt;ListLink);
01770         Console-&gt;NumCommandHistories+=1;
01771         <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>-&gt;ProcessHandle = ProcessHandle;
01772         InitializeListHead(&amp;<a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>-&gt;PopupList);
01773         <span class="keywordflow">return</span> <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>;
01774     }
01775 
01776     <span class="comment">//</span>
01777     <span class="comment">// if the app name doesn't match, copy in the new app name and free the old commands.</span>
01778     <span class="comment">//</span>
01779 
01780     <span class="keywordflow">if</span> (BestCandidate) {
01781         <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a> = BestCandidate;
01782         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d4/d1/cmdline_8h.html#a14">CLE_NO_POPUPS</a>(<a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>));
01783         <span class="keywordflow">if</span> (!SameApp) {
01784             <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> i;
01785             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>-&gt;AppName) {
01786                 <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"Reusing %ls command history\n"</span>, <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>-&gt;AppName));
01787                 <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(<a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>-&gt;AppName);
01788             }
01789             <span class="keywordflow">for</span> (i=0;i&lt;<a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>-&gt;NumberOfCommands;i++) {
01790                 <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(<a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>-&gt;Commands[i]);
01791             }
01792             <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>-&gt;NumberOfCommands = 0;
01793             <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>-&gt;LastAdded = -1;
01794             <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>-&gt;LastDisplayed = -1;
01795             <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>-&gt;FirstCommand = 0;
01796             <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>-&gt;AppName = (LPWSTR)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a12">HISTORY_TAG</a> ),AppNameLength);
01797             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>-&gt;AppName == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01798                 <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>-&gt;Flags &amp;= ~<a class="code" href="../../d4/d1/cmdline_8h.html#a4">CLE_ALLOCATED</a>;
01799                 <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01800             }
01801             RtlCopyMemory(<a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>-&gt;AppName,AppName,AppNameLength);
01802         }
01803         <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>-&gt;ProcessHandle = ProcessHandle;
01804         <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>-&gt;Flags |= <a class="code" href="../../d4/d1/cmdline_8h.html#a4">CLE_ALLOCATED</a>;
01805 
01806         <span class="comment">//</span>
01807         <span class="comment">// move to the front of the list</span>
01808         <span class="comment">//</span>
01809 
01810         RemoveEntryList(&amp;BestCandidate-&gt;ListLink);
01811         InsertHeadList(&amp;Console-&gt;CommandHistoryList,&amp;BestCandidate-&gt;ListLink);
01812     }
01813     <span class="keywordflow">return</span> BestCandidate;
01814 }
01815 
01816 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01817"></a><a class="code" href="../../d3/d1/server_2cmdline_8c.html#a45">01817</a> <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a45">BeginPopup</a>(
01818     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
01819     IN <a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html">PCOMMAND_HISTORY</a> CommandHistory,
01820     IN COORD PopupSize
01821     )
01822 {
01823     COORD Origin;
01824     COORD <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
01825     <a class="code" href="../../d1/d0/struct__CLE__POPUP.html">PCLE_POPUP</a> Popup;
01826     SMALL_RECT TargetRect;
01827 
01828     <span class="comment">// determine popup dimensions</span>
01829 
01830     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = PopupSize;
01831     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.X += 2;    <span class="comment">// add borders</span>
01832     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.Y += 2;    <span class="comment">// add borders</span>
01833     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.X &gt;= (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(<a class="code" href="../../d7/d2/output_8h.html#a17">CONSOLE_WINDOW_SIZE_X</a>(ScreenInfo))) {
01834         <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.X = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(<a class="code" href="../../d7/d2/output_8h.html#a17">CONSOLE_WINDOW_SIZE_X</a>(ScreenInfo));
01835     }
01836     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.Y &gt;= (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(<a class="code" href="../../d7/d2/output_8h.html#a18">CONSOLE_WINDOW_SIZE_Y</a>(ScreenInfo))) {
01837         <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.Y = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(<a class="code" href="../../d7/d2/output_8h.html#a18">CONSOLE_WINDOW_SIZE_Y</a>(ScreenInfo));
01838     }
01839 
01840     <span class="comment">// make sure there's enough room for the popup borders</span>
01841 
01842     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.X &lt; 2 || <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.Y &lt; 2) {
01843         <span class="keywordflow">return</span> STATUS_BUFFER_TOO_SMALL;
01844     }
01845 
01846     <span class="comment">// determine origin.  center popup on window</span>
01847     Origin.X = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)((<a class="code" href="../../d7/d2/output_8h.html#a17">CONSOLE_WINDOW_SIZE_X</a>(ScreenInfo) - <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.X) / 2 + ScreenInfo-&gt;Window.Left);
01848     Origin.Y = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)((<a class="code" href="../../d7/d2/output_8h.html#a18">CONSOLE_WINDOW_SIZE_Y</a>(ScreenInfo) - <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.Y) / 2 + ScreenInfo-&gt;Window.Top);
01849 
01850     <span class="comment">// allocate a popup structure</span>
01851 
01852     Popup = (<a class="code" href="../../d1/d0/struct__CLE__POPUP.html">PCLE_POPUP</a>)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a9">TMP_TAG</a> ),<span class="keyword">sizeof</span>(<a class="code" href="../../d1/d0/struct__CLE__POPUP.html">CLE_POPUP</a>));
01853     <span class="keywordflow">if</span> (Popup == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01854         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01855     }
01856 
01857     <span class="comment">// allocate a buffer</span>
01858 
01859 <span class="preprocessor">#if !defined(FE_SB)</span>
01860 <span class="preprocessor"></span>    Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o4">OldContents</a> = (PCHAR_INFO)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a9">TMP_TAG</a> ),<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.X * <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.Y * <span class="keyword">sizeof</span>(CHAR_INFO));
01861 <span class="preprocessor">#else</span>
01862 <span class="preprocessor"></span>    Popup-&gt;OldScreenSize = ScreenInfo-&gt;ScreenBufferSize;
01863     Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o4">OldContents</a> = (PCHAR_INFO)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a9">TMP_TAG</a> ),Popup-&gt;OldScreenSize.X * <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.Y * <span class="keyword">sizeof</span>(CHAR_INFO));
01864 <span class="preprocessor">#endif</span>
01865 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o4">OldContents</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01866         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(Popup);
01867         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01868     }
01869     <span class="keywordflow">if</span> ((ScreenInfo-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a2">CONSOLE_OEMFONT_DISPLAY</a>) &amp;&amp;
01870             !(ScreenInfo-&gt;Console-&gt;FullScreenFlags &amp; CONSOLE_FULLSCREEN)) {
01871         Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o3">Flags</a> |= <a class="code" href="../../d4/d1/cmdline_8h.html#a0">CLEPF_FALSE_UNICODE</a>;
01872     } <span class="keywordflow">else</span> {
01873         Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o3">Flags</a> &amp;= ~<a class="code" href="../../d4/d1/cmdline_8h.html#a0">CLEPF_FALSE_UNICODE</a>;
01874     }
01875 
01876     <span class="comment">//</span>
01877     <span class="comment">// fill in popup structure</span>
01878     <span class="comment">//</span>
01879 
01880     InsertHeadList(&amp;CommandHistory-&gt;PopupList,&amp;Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o0">ListLink</a>);
01881     Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o1">Region</a>.Left = Origin.X;
01882     Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o1">Region</a>.Top = Origin.Y;
01883     Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o1">Region</a>.Right = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(Origin.X + <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.X - 1);
01884     Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o1">Region</a>.Bottom = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(Origin.Y + <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.Y - 1);
01885     Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o2">Attributes</a> = ScreenInfo-&gt;PopupAttributes;
01886     Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o5">BottomIndex</a> = <a class="code" href="../../d4/d1/cmdline_8h.html#a9">COMMAND_INDEX_TO_NUM</a>(CommandHistory-&gt;LastDisplayed,CommandHistory);
01887 
01888     <span class="comment">//</span>
01889     <span class="comment">// copy old contents</span>
01890     <span class="comment">//</span>
01891 
01892 <span class="preprocessor">#if !defined(FE_SB)</span>
01893 <span class="preprocessor"></span>    TargetRect = Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o1">Region</a>;
01894 <span class="preprocessor">#else</span>
01895 <span class="preprocessor"></span>    TargetRect.Left = 0;
01896     TargetRect.Top = Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o1">Region</a>.Top;
01897     TargetRect.Right = Popup-&gt;OldScreenSize.X - 1;
01898     TargetRect.Bottom = Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o1">Region</a>.Bottom;
01899 <span class="preprocessor">#endif</span>
01900 <span class="preprocessor"></span>    <a class="code" href="../../d6/d2/output_8c.html#a52">ReadScreenBuffer</a>(ScreenInfo,
01901                      Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o4">OldContents</a>,
01902                      &amp;TargetRect);
01903 
01904     ScreenInfo-&gt;Console-&gt;PopupCount++;
01905     <a class="code" href="../../d4/d1/cmdline_8h.html#a54">DrawCommandListBorder</a>(Popup,ScreenInfo);
01906     <span class="keywordflow">return</span> STATUS_SUCCESS;
01907 }
01908 
01909 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01910"></a><a class="code" href="../../d3/d1/server_2cmdline_8c.html#a46">01910</a> <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a46">EndPopup</a>(
01911     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
01912     IN <a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html">PCOMMAND_HISTORY</a> CommandHistory
01913     )
01914 {
01915     COORD <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
01916     SMALL_RECT SourceRect;
01917     <a class="code" href="../../d1/d0/struct__CLE__POPUP.html">PCLE_POPUP</a> Popup;
01918 
01919     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!<a class="code" href="../../d4/d1/cmdline_8h.html#a14">CLE_NO_POPUPS</a>(CommandHistory));
01920     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/cmdline_8h.html#a14">CLE_NO_POPUPS</a>(CommandHistory))
01921         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
01922 
01923     <a class="code" href="../../d6/d1/ntcon_2server_2cursor_8c.html#a3">ConsoleHideCursor</a>(ScreenInfo);
01924     Popup = CONTAINING_RECORD( CommandHistory-&gt;PopupList.Flink, <a class="code" href="../../d1/d0/struct__CLE__POPUP.html">CLE_POPUP</a>, ListLink );
01925 
01926     <span class="comment">//</span>
01927     <span class="comment">// restore previous contents to screen</span>
01928     <span class="comment">//</span>
01929 
01930 <span class="preprocessor">#if !defined(FE_SB)</span>
01931 <span class="preprocessor"></span>    <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.X = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o1">Region</a>.Right - Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o1">Region</a>.Left + 1);
01932     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.Y = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o1">Region</a>.Bottom - Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o1">Region</a>.Top + 1);
01933     SourceRect = Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o1">Region</a>;
01934 <span class="preprocessor">#else</span>
01935 <span class="preprocessor"></span>    <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.X = Popup-&gt;OldScreenSize.X;
01936     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.Y = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o1">Region</a>.Bottom - Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o1">Region</a>.Top + 1);
01937     SourceRect.Left = 0;
01938     SourceRect.Top = Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o1">Region</a>.Top;
01939     SourceRect.Right = Popup-&gt;OldScreenSize.X - 1;
01940     SourceRect.Bottom = Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o1">Region</a>.Bottom;
01941 <span class="preprocessor">#endif</span>
01942 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ((ScreenInfo-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a2">CONSOLE_OEMFONT_DISPLAY</a>) &amp;&amp;
01943             !(ScreenInfo-&gt;Console-&gt;FullScreenFlags &amp; CONSOLE_FULLSCREEN)) {
01944         <span class="comment">/*</span>
01945 <span class="comment">         * Screen buffer wants fake Unicode</span>
01946 <span class="comment">         */</span>
01947         <span class="keywordflow">if</span> (!(Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o3">Flags</a> &amp; <a class="code" href="../../d4/d1/cmdline_8h.html#a0">CLEPF_FALSE_UNICODE</a>)) {
01948 <span class="preprocessor">#if !defined(FE_SB)</span>
01949 <span class="preprocessor"></span>            <a class="code" href="../../d6/d8/dispatch_8h.html#a13">TranslateOutputToAnsiUnicode</a>(ScreenInfo-&gt;Console,
01950                     Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o4">OldContents</a>, <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>);
01951 <span class="preprocessor">#else</span>
01952 <span class="preprocessor"></span>            <a class="code" href="../../d6/d8/dispatch_8h.html#a13">TranslateOutputToAnsiUnicode</a>(ScreenInfo-&gt;Console,
01953                     Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o4">OldContents</a>, <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>,
01954                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01955 <span class="preprocessor">#endif</span>
01956 <span class="preprocessor"></span>        }
01957     } <span class="keywordflow">else</span> {
01958         <span class="comment">/*</span>
01959 <span class="comment">         * Screen buffer wants real Unicode</span>
01960 <span class="comment">         */</span>
01961         <span class="keywordflow">if</span> (Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o3">Flags</a> &amp; <a class="code" href="../../d4/d1/cmdline_8h.html#a0">CLEPF_FALSE_UNICODE</a>) {
01962 <span class="preprocessor">#if !defined(FE_SB)</span>
01963 <span class="preprocessor"></span>            <a class="code" href="../../d6/d8/dispatch_8h.html#a16">TranslateOutputToOemUnicode</a>(ScreenInfo-&gt;Console,
01964                     Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o4">OldContents</a>, <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>);
01965 <span class="preprocessor">#else</span>
01966 <span class="preprocessor"></span>            <a class="code" href="../../d6/d8/dispatch_8h.html#a16">TranslateOutputToOemUnicode</a>(ScreenInfo-&gt;Console,
01967                     Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o4">OldContents</a>, <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01968 <span class="preprocessor">#endif</span>
01969 <span class="preprocessor"></span>        }
01970     }
01971     <a class="code" href="../../d6/d2/output_8c.html#a53">WriteScreenBuffer</a>(ScreenInfo,
01972                       Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o4">OldContents</a>,
01973                       &amp;SourceRect
01974                      );
01975     <a class="code" href="../../d6/d8/dispatch_8h.html#a4">WriteToScreen</a>(ScreenInfo,
01976                   &amp;SourceRect
01977                  );
01978 
01979     <a class="code" href="../../d6/d1/ntcon_2server_2cursor_8c.html#a2">ConsoleShowCursor</a>(ScreenInfo);
01980 
01981     <span class="comment">//</span>
01982     <span class="comment">// free popup structure</span>
01983     <span class="comment">//</span>
01984 
01985     RemoveEntryList(&amp;Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o0">ListLink</a>);
01986     <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o4">OldContents</a>);
01987     <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(Popup);
01988     ScreenInfo-&gt;Console-&gt;PopupCount--;
01989     <span class="keywordflow">return</span> STATUS_SUCCESS;
01990 }
01991 
01992 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01993"></a><a class="code" href="../../d4/d1/cmdline_8h.html#a52">01993</a> <a class="code" href="../../d4/d1/cmdline_8h.html#a52">CleanUpPopups</a>(
01994     IN <a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html">PCOOKED_READ_DATA</a> CookedReadData
01995     )
01996 {
01997     <a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html">PCOMMAND_HISTORY</a> CommandHistory;
01998 
01999     CommandHistory = CookedReadData-&gt;CommandHistory;
02000     <span class="keywordflow">if</span> (!CommandHistory)
02001         <span class="keywordflow">return</span>;
02002     <span class="keywordflow">while</span> (!<a class="code" href="../../d4/d1/cmdline_8h.html#a14">CLE_NO_POPUPS</a>(CommandHistory)) {
02003         <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a46">EndPopup</a>(CookedReadData-&gt;ScreenInfo,CommandHistory);
02004     }
02005 }
02006 
02007 
02008 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02009"></a><a class="code" href="../../d4/d1/cmdline_8h.html#a41">02009</a> <a class="code" href="../../d4/d1/cmdline_8h.html#a41">DeleteCommandLine</a>(
02010     IN OUT <a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html">PCOOKED_READ_DATA</a> CookedReadData,
02011     IN BOOL UpdateFields
02012     )
02013 {
02014     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> CharsToWrite = CookedReadData-&gt;NumberOfVisibleChars;
02015     COORD Coord = CookedReadData-&gt;OriginalCursorPosition;
02016 
02017     <span class="comment">//</span>
02018     <span class="comment">// catch the case where the current command has scrolled off the</span>
02019     <span class="comment">// top of the screen.</span>
02020     <span class="comment">//</span>
02021 
02022     <span class="keywordflow">if</span> (Coord.Y &lt; 0) {
02023         CharsToWrite += CookedReadData-&gt;ScreenInfo-&gt;ScreenBufferSize.X * Coord.Y;
02024         CharsToWrite += CookedReadData-&gt;OriginalCursorPosition.X;   <span class="comment">// account for prompt</span>
02025         CookedReadData-&gt;OriginalCursorPosition.X = 0;
02026         CookedReadData-&gt;OriginalCursorPosition.Y = 0;
02027         Coord.X = 0;
02028         Coord.Y = 0;
02029     }
02030 <span class="preprocessor">#if defined(FE_SB)</span>
02031 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (CONSOLE_IS_DBCS_OUTPUTCP(CookedReadData-&gt;ScreenInfo-&gt;Console) &amp;&amp;
02032         !CheckBisectStringW(CookedReadData-&gt;ScreenInfo,
02033                            CookedReadData-&gt;ScreenInfo-&gt;Console-&gt;CP,
02034                            CookedReadData-&gt;BackupLimit,
02035                            CharsToWrite,
02036                            CookedReadData-&gt;ScreenInfo-&gt;ScreenBufferSize.X
02037                             -CookedReadData-&gt;OriginalCursorPosition.X
02038                            )) {
02039         CharsToWrite++;
02040     }
02041 <span class="preprocessor">#endif</span>
02042 <span class="preprocessor"></span>    <a class="code" href="../../d6/d8/dispatch_8h.html#a6">FillOutput</a>(CookedReadData-&gt;ScreenInfo,
02043                (WCHAR)<span class="charliteral">' '</span>,
02044                Coord,
02045                <a class="code" href="../../d5/d5/conmsg_8h.html#a12">CONSOLE_FALSE_UNICODE</a>, <span class="comment">// faster than real unicode</span>
02046                &amp;CharsToWrite
02047               );
02048     <span class="keywordflow">if</span> (UpdateFields) {
02049         CookedReadData-&gt;BufPtr=CookedReadData-&gt;BackupLimit;
02050         CookedReadData-&gt;BytesRead=0;
02051         CookedReadData-&gt;CurrentPosition=0;
02052         CookedReadData-&gt;NumberOfVisibleChars = 0;
02053     }
02054     <a class="code" href="../../d6/d1/ntcon_2server_2cursor_8c.html#a7">SetCursorPosition</a>(CookedReadData-&gt;ScreenInfo,
02055                       CookedReadData-&gt;OriginalCursorPosition,
02056                       <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
02057                      );
02058 }
02059 
02060 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02061"></a><a class="code" href="../../d3/d1/server_2cmdline_8c.html#a49">02061</a> <a class="code" href="../../d4/d1/cmdline_8h.html#a42">RedrawCommandLine</a>(
02062     IN OUT <a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html">PCOOKED_READ_DATA</a> CookedReadData
02063     )
02064 {
02065     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02066     COORD CursorPosition;
02067     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> ScrollY=0;
02068 
02069     <span class="keywordflow">if</span> (CookedReadData-&gt;Echo) {
02070         <span class="comment">//</span>
02071         <span class="comment">// Draw the command line</span>
02072         <span class="comment">//</span>
02073         CookedReadData-&gt;OriginalCursorPosition = CookedReadData-&gt;ScreenInfo-&gt;BufferInfo.TextInfo.CursorPosition;
02074         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d7/server_2stream_8c.html#a38">WriteCharsFromInput</a>(CookedReadData-&gt;ScreenInfo,
02075                                      CookedReadData-&gt;BackupLimit,
02076                                      CookedReadData-&gt;BackupLimit,
02077                                      CookedReadData-&gt;BackupLimit,
02078                                      &amp;CookedReadData-&gt;BytesRead,
02079                                      &amp;CookedReadData-&gt;NumberOfVisibleChars,
02080                                      CookedReadData-&gt;OriginalCursorPosition.X,
02081                                      <a class="code" href="../../d4/d1/cmdline_8h.html#a17">WC_DESTRUCTIVE_BACKSPACE</a> | <a class="code" href="../../d4/d1/cmdline_8h.html#a18">WC_KEEP_CURSOR_VISIBLE</a> | <a class="code" href="../../d4/d1/cmdline_8h.html#a19">WC_ECHO</a>,
02082                                      &amp;ScrollY);
02083         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
02084         CookedReadData-&gt;OriginalCursorPosition.Y += ScrollY;
02085 
02086         <span class="comment">//</span>
02087         <span class="comment">// Move the cursor back to the right position</span>
02088         <span class="comment">//</span>
02089         CursorPosition = CookedReadData-&gt;OriginalCursorPosition;
02090         CursorPosition.X += (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)<a class="code" href="../../d0/d7/server_2stream_8c.html#a21">RetrieveTotalNumberOfSpaces</a>(CookedReadData-&gt;OriginalCursorPosition.X,
02091                                                    CookedReadData-&gt;BackupLimit,
02092                                                    CookedReadData-&gt;CurrentPosition,
02093                                                    CookedReadData-&gt;ScreenInfo-&gt;Console);
02094         <span class="keywordflow">if</span> (CheckBisectStringW(CookedReadData-&gt;ScreenInfo,
02095                                CookedReadData-&gt;ScreenInfo-&gt;Console-&gt;CP,
02096                                CookedReadData-&gt;BackupLimit,
02097                                CookedReadData-&gt;CurrentPosition,
02098                                CookedReadData-&gt;ScreenInfo-&gt;ScreenBufferSize.X
02099                                 -CookedReadData-&gt;OriginalCursorPosition.X)) {
02100             CursorPosition.X++;
02101         }
02102         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d8/dispatch_8h.html#a10">AdjustCursorPosition</a>(CookedReadData-&gt;ScreenInfo,
02103                                       CursorPosition,
02104                                       <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
02105                                       <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02106         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
02107     }
02108 }
02109 
02110 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02111"></a><a class="code" href="../../d3/d1/server_2cmdline_8c.html#a50">02111</a> <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a50">RetrieveNthCommand</a>(
02112     IN <a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html">PCOMMAND_HISTORY</a> CommandHistory,
02113     IN SHORT Index, <span class="comment">// index, not command number</span>
02114     IN PWCHAR Buffer,
02115     IN ULONG BufferSize,
02116     OUT PULONG CommandSize
02117     )
02118 {
02119     <a class="code" href="../../d8/d7/struct__COMMAND.html">PCOMMAND</a> CommandRecord;
02120 
02121     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Index &lt; CommandHistory-&gt;NumberOfCommands);
02122     CommandHistory-&gt;LastDisplayed = <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
02123     CommandRecord = CommandHistory-&gt;Commands[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
02124     <span class="keywordflow">if</span> (CommandRecord-&gt;<a class="code" href="../../d8/d7/struct__COMMAND.html#o0">CommandLength</a> &gt; (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>) {
02125         *CommandSize = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>;  <span class="comment">// room for CRLF?</span>
02126     }
02127     <span class="keywordflow">else</span> {
02128         *CommandSize = CommandRecord-&gt;<a class="code" href="../../d8/d7/struct__COMMAND.html#o0">CommandLength</a>;
02129     }
02130     RtlCopyMemory(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,CommandRecord-&gt;<a class="code" href="../../d8/d7/struct__COMMAND.html#o1">Command</a>,*CommandSize);
02131     <span class="keywordflow">return</span> STATUS_SUCCESS;
02132 }
02133 
02134 
02135 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02136"></a><a class="code" href="../../d3/d1/server_2cmdline_8c.html#a51">02136</a> <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a51">SetCurrentCommandLine</a>(
02137     IN <a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html">PCOOKED_READ_DATA</a> CookedReadData,
02138     IN SHORT Index  <span class="comment">// index, not command number</span>
02139     )
02140 <span class="comment">/*++</span>
02141 <span class="comment"></span>
02142 <span class="comment">    This routine copies the commandline specified by Index</span>
02143 <span class="comment">    into the cooked read buffer</span>
02144 <span class="comment"></span>
02145 <span class="comment">--*/</span>
02146 {
02147     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> CharsToWrite;
02148     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02149     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> ScrollY=0;
02150 
02151     <a class="code" href="../../d4/d1/cmdline_8h.html#a41">DeleteCommandLine</a>(CookedReadData,
02152                       <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02153     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a50">RetrieveNthCommand</a>(CookedReadData-&gt;CommandHistory,
02154                                 <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>,
02155                                 CookedReadData-&gt;BackupLimit,
02156                                 CookedReadData-&gt;BufferSize,
02157                                 &amp;CookedReadData-&gt;BytesRead);
02158     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
02159     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(CookedReadData-&gt;BackupLimit == CookedReadData-&gt;BufPtr);
02160     <span class="keywordflow">if</span> (CookedReadData-&gt;Echo) {
02161         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d7/server_2stream_8c.html#a38">WriteCharsFromInput</a>(CookedReadData-&gt;ScreenInfo,
02162                 CookedReadData-&gt;BackupLimit,
02163                 CookedReadData-&gt;BufPtr,
02164                 CookedReadData-&gt;BufPtr,
02165                 &amp;CookedReadData-&gt;BytesRead,
02166                 (PLONG)&amp;CookedReadData-&gt;NumberOfVisibleChars,
02167                 CookedReadData-&gt;OriginalCursorPosition.X,
02168                 <a class="code" href="../../d4/d1/cmdline_8h.html#a17">WC_DESTRUCTIVE_BACKSPACE</a> | <a class="code" href="../../d4/d1/cmdline_8h.html#a18">WC_KEEP_CURSOR_VISIBLE</a> | <a class="code" href="../../d4/d1/cmdline_8h.html#a19">WC_ECHO</a>,
02169                 &amp;ScrollY);
02170         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
02171         CookedReadData-&gt;OriginalCursorPosition.Y += ScrollY;
02172     }
02173     CharsToWrite = CookedReadData-&gt;BytesRead/<span class="keyword">sizeof</span>(WCHAR);
02174     CookedReadData-&gt;CurrentPosition = CharsToWrite;
02175     CookedReadData-&gt;BufPtr = CookedReadData-&gt;BackupLimit + CharsToWrite;
02176 }
02177 
02178 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l02179"></a><a class="code" href="../../d4/d1/cmdline_8h.html#a50">02179</a> <a class="code" href="../../d4/d1/cmdline_8h.html#a50">IsCommandLinePopupKey</a>(
02180     IN OUT PKEY_EVENT_RECORD KeyEvent
02181     )
02182 {
02183     <span class="keywordflow">if</span> (!(KeyEvent-&gt;dwControlKeyState &amp;
02184             (RIGHT_ALT_PRESSED | LEFT_ALT_PRESSED |
02185              RIGHT_CTRL_PRESSED | LEFT_CTRL_PRESSED))) {
02186         <span class="keywordflow">switch</span> (KeyEvent-&gt;wVirtualKeyCode) {
02187         <span class="keywordflow">case</span> VK_ESCAPE:
02188         <span class="keywordflow">case</span> VK_PRIOR:
02189         <span class="keywordflow">case</span> VK_NEXT:
02190         <span class="keywordflow">case</span> VK_END:
02191         <span class="keywordflow">case</span> VK_HOME:
02192         <span class="keywordflow">case</span> VK_LEFT:
02193         <span class="keywordflow">case</span> VK_UP:
02194         <span class="keywordflow">case</span> VK_RIGHT:
02195         <span class="keywordflow">case</span> VK_DOWN:
02196         <span class="keywordflow">case</span> VK_F9:
02197             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02198         <span class="keywordflow">default</span>:
02199             <span class="keywordflow">break</span>;
02200         }
02201     }
02202 
02203     <span class="comment">//</span>
02204     <span class="comment">// Extended key handling</span>
02205     <span class="comment">//</span>
02206     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a24">gExtendedEditKey</a> &amp;&amp; <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a17">ParseEditKeyInfo</a>(KeyEvent)) {
02207         <span class="keywordflow">return</span> KeyEvent-&gt;uChar.UnicodeChar == 0;
02208     }
02209 
02210     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02211 }
02212 
02213 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l02214"></a><a class="code" href="../../d3/d1/server_2cmdline_8c.html#a53">02214</a> <a class="code" href="../../d4/d1/cmdline_8h.html#a51">IsCommandLineEditingKey</a>(
02215     IN PKEY_EVENT_RECORD KeyEvent
02216     )
02217 {
02218     <span class="keywordflow">if</span> (!(KeyEvent-&gt;dwControlKeyState &amp;
02219             (RIGHT_ALT_PRESSED | LEFT_ALT_PRESSED |
02220              RIGHT_CTRL_PRESSED | LEFT_CTRL_PRESSED))) {
02221         <span class="keywordflow">switch</span> (KeyEvent-&gt;wVirtualKeyCode) {
02222         <span class="keywordflow">case</span> VK_ESCAPE:
02223         <span class="keywordflow">case</span> VK_PRIOR:
02224         <span class="keywordflow">case</span> VK_NEXT:
02225         <span class="keywordflow">case</span> VK_END:
02226         <span class="keywordflow">case</span> VK_HOME:
02227         <span class="keywordflow">case</span> VK_LEFT:
02228         <span class="keywordflow">case</span> VK_UP:
02229         <span class="keywordflow">case</span> VK_RIGHT:
02230         <span class="keywordflow">case</span> VK_DOWN:
02231         <span class="keywordflow">case</span> VK_INSERT:
02232         <span class="keywordflow">case</span> VK_DELETE:
02233         <span class="keywordflow">case</span> VK_F1:
02234         <span class="keywordflow">case</span> VK_F2:
02235         <span class="keywordflow">case</span> VK_F3:
02236         <span class="keywordflow">case</span> VK_F4:
02237         <span class="keywordflow">case</span> VK_F5:
02238         <span class="keywordflow">case</span> VK_F6:
02239         <span class="keywordflow">case</span> VK_F7:
02240         <span class="keywordflow">case</span> VK_F8:
02241         <span class="keywordflow">case</span> VK_F9:
02242             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02243         <span class="keywordflow">default</span>:
02244             <span class="keywordflow">break</span>;
02245         }
02246     }
02247     <span class="keywordflow">if</span> ((KeyEvent-&gt;dwControlKeyState &amp;
02248             (RIGHT_CTRL_PRESSED | LEFT_CTRL_PRESSED))) {
02249         <span class="keywordflow">switch</span> (KeyEvent-&gt;wVirtualKeyCode) {
02250         <span class="keywordflow">case</span> VK_END:
02251         <span class="keywordflow">case</span> VK_HOME:
02252         <span class="keywordflow">case</span> VK_LEFT:
02253         <span class="keywordflow">case</span> VK_RIGHT:
02254             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02255         <span class="keywordflow">default</span>:
02256             <span class="keywordflow">break</span>;
02257         }
02258     }
02259 
02260     <span class="comment">//</span>
02261     <span class="comment">// Extended edit key handling</span>
02262     <span class="comment">//</span>
02263     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a24">gExtendedEditKey</a> &amp;&amp; <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a17">ParseEditKeyInfo</a>(KeyEvent)) {
02264         <span class="comment">//</span>
02265         <span class="comment">// If wUnicodeChar is specified in KeySubst,</span>
02266         <span class="comment">// the key should be handled as a normal key.</span>
02267         <span class="comment">// Basically this is for VK_BACK keys.</span>
02268         <span class="comment">//</span>
02269         <span class="keywordflow">return</span> KeyEvent-&gt;uChar.UnicodeChar == 0;
02270     }
02271 
02272     <span class="keywordflow">if</span> ((KeyEvent-&gt;dwControlKeyState &amp;
02273             (RIGHT_ALT_PRESSED | LEFT_ALT_PRESSED))) {
02274         <span class="keywordflow">switch</span> (KeyEvent-&gt;wVirtualKeyCode) {
02275         <span class="keywordflow">case</span> VK_F7:
02276         <span class="keywordflow">case</span> VK_F10:
02277             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02278         <span class="keywordflow">default</span>:
02279             <span class="keywordflow">break</span>;
02280         }
02281     }
02282     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02283 }
02284 
02285 
02286 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02287"></a><a class="code" href="../../d3/d1/server_2cmdline_8c.html#a54">02287</a> <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a54">ProcessCommandListInput</a>(
02288     IN PVOID CookedReadDataPtr,
02289     IN PCSR_API_MSG WaitReplyMessage,
02290     IN PCSR_THREAD WaitingThread,
02291     IN BOOLEAN WaitRoutine
02292     )
02293 
02294 <span class="comment">/*++</span>
02295 <span class="comment"></span>
02296 <span class="comment">    This routine handles the command list popup.  It returns</span>
02297 <span class="comment">    when we're out of input or the user has selected a command line.</span>
02298 <span class="comment"></span>
02299 <span class="comment">    Return Value:</span>
02300 <span class="comment"></span>
02301 <span class="comment">        CONSOLE_STATUS_WAIT - we ran out of input, so</span>
02302 <span class="comment">            a wait block was created</span>
02303 <span class="comment"></span>
02304 <span class="comment">        CONSOLE_STATUS_READ_COMPLETE - user hit return</span>
02305 <span class="comment"></span>
02306 <span class="comment">--*/</span>
02307 
02308 {
02309     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02310     <a class="code" href="../../d1/d0/struct__CLE__POPUP.html">PCLE_POPUP</a> Popup;
02311     <a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html">PCOMMAND_HISTORY</a> CommandHistory;
02312     <a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html">PCOOKED_READ_DATA</a> CookedReadData=(<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html">PCOOKED_READ_DATA</a>)CookedReadDataPtr;
02313     WCHAR Char;
02314     BOOLEAN CommandLinePopupKeys = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02315     <a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html">PCONSOLE_READCONSOLE_MSG</a> a;
02316     <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> HandleData;
02317     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
02318 
02319     CommandHistory = CookedReadData-&gt;<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o13">CommandHistory</a>;
02320     Popup = CONTAINING_RECORD( CommandHistory-&gt;<a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html#o9">PopupList</a>.Flink, <a class="code" href="../../d1/d0/struct__CLE__POPUP.html">CLE_POPUP</a>, ListLink );
02321     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a30">DereferenceIoHandleNoCheck</a>(CookedReadData-&gt;<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o18">ProcessData</a>,
02322                                         CookedReadData-&gt;<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o19">HandleIndex</a>,
02323                                         &amp;HandleData
02324                                        );
02325     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
02326     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02327         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d7/server_2stream_8c.html#a19">GetChar</a>(CookedReadData-&gt;<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o0">InputInfo</a>,
02328                          &amp;Char,
02329                          <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
02330                          CookedReadData-&gt;<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o2">Console</a>,
02331                          HandleData,
02332                          WaitReplyMessage,
02333                          <a class="code" href="../../d4/d1/cmdline_8h.html#a58">CookedReadWaitRoutine</a>,
02334                          CookedReadData,
02335                          <span class="keyword">sizeof</span>(*CookedReadData),
02336                          WaitRoutine,
02337                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02338                          &amp;CommandLinePopupKeys,
02339                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02340                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02341                         );
02342         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02343             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != <a class="code" href="../../d1/d7/server_8h.html#a64">CONSOLE_STATUS_WAIT</a>) {
02344                 CookedReadData-&gt;BytesRead = 0;
02345             }
02346             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02347         }
02348 
02349         <span class="keywordflow">if</span> (CommandLinePopupKeys) {
02350             <span class="keywordflow">switch</span> (Char) {
02351             <span class="keywordflow">case</span> VK_F9:
02352 
02353                 <span class="comment">//</span>
02354                 <span class="comment">// prompt the user to enter the desired command number.</span>
02355                 <span class="comment">// copy that command to the command line.</span>
02356                 <span class="comment">//</span>
02357 
02358                 {
02359                 COORD PopupSize;
02360 
02361                 <span class="keywordflow">if</span> (CookedReadData-&gt;CommandHistory &amp;&amp;
02362                     CookedReadData-&gt;ScreenInfo-&gt;ScreenBufferSize.X &gt;= <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a4">MINIMUM_COMMAND_PROMPT_SIZE</a>+2) {  <span class="comment">// 2 is for border</span>
02363                     PopupSize.X = <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a2">COMMAND_NUMBER_PROMPT_LENGTH</a>+<a class="code" href="../../d3/d1/server_2cmdline_8c.html#a3">COMMAND_NUMBER_LENGTH</a>;
02364                     PopupSize.Y = 1;
02365                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a45">BeginPopup</a>(CookedReadData-&gt;ScreenInfo,
02366                                         CookedReadData-&gt;CommandHistory,
02367                                         PopupSize
02368                                        );
02369                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02370                         <span class="comment">// CommandNumberPopup does EndPopup call</span>
02371                         <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/cmdline_8h.html#a57">CommandNumberPopup</a>(CookedReadData,
02372                                                   WaitReplyMessage,
02373                                                   WaitingThread,
02374                                                   WaitRoutine
02375                                                  );
02376                     }
02377                 }
02378                 }
02379                 <span class="keywordflow">break</span>;
02380             <span class="keywordflow">case</span> VK_ESCAPE:
02381                 <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a46">EndPopup</a>(CookedReadData-&gt;ScreenInfo,CommandHistory);
02382                 HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o6">InputReadData</a>-&gt;<a class="code" href="../../d8/d2/struct__INPUT__READ__HANDLE__DATA.html#o1">ReadCount</a> += 1;
02383                 <span class="keywordflow">return</span> <a class="code" href="../../d1/d7/server_8h.html#a66">CONSOLE_STATUS_WAIT_NO_BLOCK</a>;
02384             <span class="keywordflow">case</span> VK_UP:
02385                 <a class="code" href="../../d4/d1/cmdline_8h.html#a62">UpdateCommandListPopup</a>(-1,
02386                                        &amp;Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o6">CurrentCommand</a>,
02387                                        CommandHistory,
02388                                        Popup,
02389                                        CookedReadData-&gt;ScreenInfo, 0);
02390                 <span class="keywordflow">break</span>;
02391             <span class="keywordflow">case</span> VK_DOWN:
02392                 <a class="code" href="../../d4/d1/cmdline_8h.html#a62">UpdateCommandListPopup</a>(1,
02393                                        &amp;Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o6">CurrentCommand</a>,
02394                                        CommandHistory,
02395                                        Popup,
02396                                        CookedReadData-&gt;ScreenInfo, 0);
02397                 <span class="keywordflow">break</span>;
02398             <span class="keywordflow">case</span> VK_END:
02399                 <span class="comment">/*</span>
02400 <span class="comment">                 * Move waaay forward, UpdateCommandListPopup() can handle it.</span>
02401 <span class="comment">                 */</span>
02402                 <a class="code" href="../../d4/d1/cmdline_8h.html#a62">UpdateCommandListPopup</a>((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(CommandHistory-&gt;<a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html#o3">NumberOfCommands</a>),
02403                                        &amp;Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o6">CurrentCommand</a>,
02404                                        CommandHistory,
02405                                        Popup,
02406                                        CookedReadData-&gt;ScreenInfo, 0);
02407                 <span class="keywordflow">break</span>;
02408             <span class="keywordflow">case</span> VK_HOME:
02409                 <span class="comment">/*</span>
02410 <span class="comment">                 * Move waaay back, UpdateCommandListPopup() can handle it.</span>
02411 <span class="comment">                 */</span>
02412                 <a class="code" href="../../d4/d1/cmdline_8h.html#a62">UpdateCommandListPopup</a>((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)-(CommandHistory-&gt;<a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html#o3">NumberOfCommands</a>),
02413                                        &amp;Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o6">CurrentCommand</a>,
02414                                        CommandHistory,
02415                                        Popup,
02416                                        CookedReadData-&gt;ScreenInfo, 0);
02417                 <span class="keywordflow">break</span>;
02418             <span class="keywordflow">case</span> VK_PRIOR:
02419                 <a class="code" href="../../d4/d1/cmdline_8h.html#a62">UpdateCommandListPopup</a>((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)-<a class="code" href="../../d4/d1/cmdline_8h.html#a2">POPUP_SIZE_Y</a>(Popup),
02420                                        &amp;Popup-&gt;CurrentCommand,
02421                                        CommandHistory,
02422                                        Popup,
02423                                        CookedReadData-&gt;ScreenInfo, 0);
02424                 <span class="keywordflow">break</span>;
02425             <span class="keywordflow">case</span> VK_NEXT:
02426                 <a class="code" href="../../d4/d1/cmdline_8h.html#a62">UpdateCommandListPopup</a>(<a class="code" href="../../d4/d1/cmdline_8h.html#a2">POPUP_SIZE_Y</a>(Popup),
02427                                        &amp;Popup-&gt;CurrentCommand,
02428                                        CommandHistory,
02429                                        Popup,
02430                                        CookedReadData-&gt;ScreenInfo, 0);
02431                 <span class="keywordflow">break</span>;
02432             <span class="keywordflow">case</span> VK_LEFT:
02433             <span class="keywordflow">case</span> VK_RIGHT:
02434                 <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = Popup-&gt;CurrentCommand;
02435                 <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a46">EndPopup</a>(CookedReadData-&gt;ScreenInfo,CommandHistory);
02436                 <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a51">SetCurrentCommandLine</a>(CookedReadData,<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>);
02437                 HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o6">InputReadData</a>-&gt;<a class="code" href="../../d8/d2/struct__INPUT__READ__HANDLE__DATA.html#o1">ReadCount</a> += 1;
02438                 <span class="keywordflow">return</span> <a class="code" href="../../d1/d7/server_8h.html#a66">CONSOLE_STATUS_WAIT_NO_BLOCK</a>;
02439             <span class="keywordflow">default</span>:
02440                 <span class="keywordflow">break</span>;
02441             }
02442         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Char == <a class="code" href="../../d4/d5/conimep_8h.html#a53">UNICODE_CARRIAGERETURN</a>) {
02443             ULONG i,lStringLength;
02444             <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> LineCount=1;
02445             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o6">CurrentCommand</a>;
02446             <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a46">EndPopup</a>(CookedReadData-&gt;ScreenInfo,CommandHistory);
02447             <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a51">SetCurrentCommandLine</a>(CookedReadData,<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>);
02448             lStringLength = CookedReadData-&gt;BytesRead;
02449             <a class="code" href="../../d0/d7/server_2stream_8c.html#a23">ProcessCookedReadInput</a>(CookedReadData,
02450                                    <a class="code" href="../../d4/d5/conimep_8h.html#a53">UNICODE_CARRIAGERETURN</a>,
02451                                    0,
02452                                    &amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02453             <span class="comment">//</span>
02454             <span class="comment">// complete read</span>
02455             <span class="comment">//</span>
02456 
02457             <span class="keywordflow">if</span> (CookedReadData-&gt;Echo) {
02458 
02459                 <span class="comment">//</span>
02460                 <span class="comment">// check for alias</span>
02461                 <span class="comment">//</span>
02462 
02463                 i = CookedReadData-&gt;BufferSize;
02464                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d8/d5/consrv_8h.html#a251">MatchandCopyAlias</a>(CookedReadData-&gt;Console,
02465                                                  CookedReadData-&gt;BackupLimit,
02466                                                  (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)lStringLength,
02467                                                  CookedReadData-&gt;BackupLimit,
02468                                                  (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)&amp;i,
02469                                                  CookedReadData-&gt;ExeName,
02470                                                  CookedReadData-&gt;ExeNameLength,
02471                                                  &amp;LineCount
02472                                                 ))) {
02473                   CookedReadData-&gt;BytesRead = i;
02474                 }
02475                 <a class="code" href="../../d0/d7/server_2stream_8c.html#a36">CloseOutputHandle</a>(<a class="code" href="../../d1/d7/server_8h.html#a83">CONSOLE_FROMTHREADPERPROCESSDATA</a>(WaitingThread),
02476                                   CookedReadData-&gt;Console,
02477                                   &amp;CookedReadData-&gt;TempHandle,
02478                                   <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02479                                   <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
02480                                  );
02481             }
02482             WaitReplyMessage-&gt;ReturnValue = STATUS_SUCCESS;
02483             a = (<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html">PCONSOLE_READCONSOLE_MSG</a>)&amp;WaitReplyMessage-&gt;u.ApiMessageData;
02484             <span class="keywordflow">if</span> (CookedReadData-&gt;BytesRead &gt; CookedReadData-&gt;UserBufferSize || LineCount &gt; 1) {
02485                 <span class="keywordflow">if</span> (LineCount &gt; 1) {
02486                     PWSTR Tmp;
02487                     HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o6">InputReadData</a>-&gt;<a class="code" href="../../d8/d2/struct__INPUT__READ__HANDLE__DATA.html#o2">InputHandleFlags</a> |= <a class="code" href="../../d1/d7/server_8h.html#a53">HANDLE_MULTI_LINE_INPUT</a>;
02488                     <span class="keywordflow">for</span> (Tmp=CookedReadData-&gt;BackupLimit;*Tmp!=<a class="code" href="../../d4/d5/conimep_8h.html#a54">UNICODE_LINEFEED</a>;Tmp++)
02489                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Tmp&lt;(CookedReadData-&gt;BackupLimit+CookedReadData-&gt;BytesRead));
02490                     a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o5">NumBytes</a> = (ULONG)(Tmp-CookedReadData-&gt;BackupLimit+1)*<span class="keyword">sizeof</span>(*Tmp);
02491                 } <span class="keywordflow">else</span> {
02492                     a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o5">NumBytes</a> = CookedReadData-&gt;UserBufferSize;
02493                 }
02494                 HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o6">InputReadData</a>-&gt;<a class="code" href="../../d8/d2/struct__INPUT__READ__HANDLE__DATA.html#o2">InputHandleFlags</a> |= <a class="code" href="../../d1/d7/server_8h.html#a52">HANDLE_INPUT_PENDING</a>;
02495                 HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o6">InputReadData</a>-&gt;<a class="code" href="../../d8/d2/struct__INPUT__READ__HANDLE__DATA.html#o5">BufPtr</a> = CookedReadData-&gt;BackupLimit;
02496                 HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o6">InputReadData</a>-&gt;<a class="code" href="../../d8/d2/struct__INPUT__READ__HANDLE__DATA.html#o3">BytesAvailable</a> = CookedReadData-&gt;BytesRead - a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o5">NumBytes</a>;
02497                 HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o6">InputReadData</a>-&gt;<a class="code" href="../../d8/d2/struct__INPUT__READ__HANDLE__DATA.html#o4">CurrentBufPtr</a>=(PWCHAR)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)CookedReadData-&gt;BackupLimit+a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o5">NumBytes</a>);
02498                 RtlCopyMemory(CookedReadData-&gt;UserBuffer,CookedReadData-&gt;BackupLimit,a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o5">NumBytes</a>);
02499             }
02500             <span class="keywordflow">else</span> {
02501                 a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o5">NumBytes</a> = CookedReadData-&gt;BytesRead;
02502                 RtlCopyMemory(CookedReadData-&gt;UserBuffer,CookedReadData-&gt;BackupLimit,a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o5">NumBytes</a>);
02503             }
02504             <span class="keywordflow">if</span> (!a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o10">Unicode</a>) {
02505 
02506                 <span class="comment">//</span>
02507                 <span class="comment">// if ansi, translate string.</span>
02508                 <span class="comment">//</span>
02509 
02510                 PCHAR TransBuffer;
02511 
02512                 TransBuffer = (PCHAR)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a9">TMP_TAG</a> ), <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a5">CHAR_COUNT</a>(a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o5">NumBytes</a>));
02513                 <span class="keywordflow">if</span> (TransBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02514                     <span class="keywordflow">return</span> STATUS_NO_MEMORY;
02515                 }
02516 
02517                 a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o5">NumBytes</a> = (ULONG)<a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a35">ConvertToOem</a>(CookedReadData-&gt;Console-&gt;CP,
02518                                             CookedReadData-&gt;UserBuffer,
02519                                             a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o5">NumBytes</a> / <span class="keyword">sizeof</span>(WCHAR),
02520                                             TransBuffer,
02521                                             <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a5">CHAR_COUNT</a>(a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o5">NumBytes</a>)
02522                                             );
02523                 RtlCopyMemory(CookedReadData-&gt;UserBuffer,TransBuffer,a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o5">NumBytes</a>);
02524                 <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(TransBuffer);
02525             }
02526 
02527             <span class="keywordflow">return</span> <a class="code" href="../../d1/d7/server_8h.html#a65">CONSOLE_STATUS_READ_COMPLETE</a>;
02528 
02529         } <span class="keywordflow">else</span> {
02530             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = <a class="code" href="../../d4/d1/cmdline_8h.html#a56">FindMatchingCommand</a>(CookedReadData-&gt;CommandHistory,
02531                     &amp;Char, 1 * <span class="keyword">sizeof</span>(WCHAR),
02532                     Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o6">CurrentCommand</a>, <a class="code" href="../../d4/d1/cmdline_8h.html#a16">FMCFL_JUST_LOOKING</a>);
02533             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> != -1) {
02534                 <a class="code" href="../../d4/d1/cmdline_8h.html#a62">UpdateCommandListPopup</a>(
02535                         (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> - Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o6">CurrentCommand</a>),
02536                         &amp;Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o6">CurrentCommand</a>,
02537                         CommandHistory,
02538                         Popup,
02539                         CookedReadData-&gt;ScreenInfo, <a class="code" href="../../d4/d1/cmdline_8h.html#a22">UCLP_WRAP</a>);
02540             }
02541         }
02542     }
02543 }
02544 
02545 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02546"></a><a class="code" href="../../d3/d1/server_2cmdline_8c.html#a55">02546</a> <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a55">ProcessCopyFromCharInput</a>(
02547     IN PVOID CookedReadDataPtr,
02548     IN PCSR_API_MSG WaitReplyMessage,
02549     IN PCSR_THREAD WaitingThread,
02550     IN BOOLEAN WaitRoutine
02551     )
02552 
02553 <span class="comment">/*++</span>
02554 <span class="comment"></span>
02555 <span class="comment">    This routine handles the delete from cursor to char char popup.  It returns</span>
02556 <span class="comment">    when we're out of input or the user has entered a char.</span>
02557 <span class="comment"></span>
02558 <span class="comment">    Return Value:</span>
02559 <span class="comment"></span>
02560 <span class="comment">        CONSOLE_STATUS_WAIT - we ran out of input, so</span>
02561 <span class="comment">            a wait block was created</span>
02562 <span class="comment"></span>
02563 <span class="comment">        CONSOLE_STATUS_READ_COMPLETE - user hit return</span>
02564 <span class="comment"></span>
02565 <span class="comment">--*/</span>
02566 
02567 {
02568     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02569     <a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html">PCOOKED_READ_DATA</a> CookedReadData=(<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html">PCOOKED_READ_DATA</a>)CookedReadDataPtr;
02570     WCHAR Char;
02571     <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> HandleData;
02572     <span class="keywordtype">int</span> i;  <span class="comment">// char index (not byte)</span>
02573 
02574     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a30">DereferenceIoHandleNoCheck</a>(CookedReadData-&gt;<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o18">ProcessData</a>,
02575                                         CookedReadData-&gt;<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o19">HandleIndex</a>,
02576                                         &amp;HandleData
02577                                        );
02578     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
02579     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02580         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d7/server_2stream_8c.html#a19">GetChar</a>(CookedReadData-&gt;<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o0">InputInfo</a>,
02581                          &amp;Char,
02582                          <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
02583                          CookedReadData-&gt;<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o2">Console</a>,
02584                          HandleData,
02585                          WaitReplyMessage,
02586                          <a class="code" href="../../d4/d1/cmdline_8h.html#a58">CookedReadWaitRoutine</a>,
02587                          CookedReadData,
02588                          <span class="keyword">sizeof</span>(*CookedReadData),
02589                          WaitRoutine,
02590                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02591                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02592                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02593                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02594                         );
02595         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02596             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != <a class="code" href="../../d1/d7/server_8h.html#a64">CONSOLE_STATUS_WAIT</a>) {
02597                 CookedReadData-&gt;BytesRead = 0;
02598             }
02599             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02600         }
02601 
02602         <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a46">EndPopup</a>(CookedReadData-&gt;ScreenInfo,CookedReadData-&gt;CommandHistory);
02603 
02604         <span class="comment">//</span>
02605         <span class="comment">// delete from cursor up to specified char</span>
02606         <span class="comment">//</span>
02607 
02608         <span class="keywordflow">for</span> (i=CookedReadData-&gt;CurrentPosition+1;
02609              i&lt;(<span class="keywordtype">int</span>)(CookedReadData-&gt;BytesRead/<span class="keyword">sizeof</span>(WCHAR));
02610              i++) {
02611             <span class="keywordflow">if</span> (CookedReadData-&gt;BackupLimit[i] == Char) {
02612                 <span class="keywordflow">break</span>;
02613             }
02614         }
02615         <span class="keywordflow">if</span> (i!=(<span class="keywordtype">int</span>)(CookedReadData-&gt;BytesRead/<span class="keyword">sizeof</span>(WCHAR)+1)) {
02616                 COORD CursorPosition;
02617 
02618                 <span class="comment">//</span>
02619                 <span class="comment">// save cursor position</span>
02620                 <span class="comment">//</span>
02621 
02622                 CursorPosition = CookedReadData-&gt;ScreenInfo-&gt;BufferInfo.TextInfo.CursorPosition;
02623 
02624                 <span class="comment">//</span>
02625                 <span class="comment">// deletecommandline</span>
02626                 <span class="comment">//</span>
02627 
02628                 <a class="code" href="../../d4/d1/cmdline_8h.html#a41">DeleteCommandLine</a>(CookedReadData,
02629                                   <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02630                 <span class="comment">//</span>
02631                 <span class="comment">// delete chars</span>
02632                 <span class="comment">//</span>
02633 
02634                 RtlCopyMemory(&amp;CookedReadData-&gt;BackupLimit[CookedReadData-&gt;CurrentPosition],
02635                               &amp;CookedReadData-&gt;BackupLimit[i],
02636                               CookedReadData-&gt;BytesRead-(i*<span class="keyword">sizeof</span>(WCHAR))
02637                               );
02638                 CookedReadData-&gt;BytesRead -= (i-CookedReadData-&gt;CurrentPosition)*<span class="keyword">sizeof</span>(WCHAR);
02639 
02640                 <span class="comment">//</span>
02641                 <span class="comment">// write commandline</span>
02642                 <span class="comment">//</span>
02643 
02644                 <span class="keywordflow">if</span> (CookedReadData-&gt;Echo) {
02645                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d7/server_2stream_8c.html#a38">WriteCharsFromInput</a>(CookedReadData-&gt;ScreenInfo,
02646                                         CookedReadData-&gt;BackupLimit,
02647                                         CookedReadData-&gt;BackupLimit,
02648                                         CookedReadData-&gt;BackupLimit,
02649                                         &amp;CookedReadData-&gt;BytesRead,
02650                                         (PLONG)&amp;CookedReadData-&gt;NumberOfVisibleChars,
02651                                         CookedReadData-&gt;OriginalCursorPosition.X,
02652                                         <a class="code" href="../../d4/d1/cmdline_8h.html#a17">WC_DESTRUCTIVE_BACKSPACE</a> |
02653                                                 <a class="code" href="../../d4/d1/cmdline_8h.html#a18">WC_KEEP_CURSOR_VISIBLE</a> | <a class="code" href="../../d4/d1/cmdline_8h.html#a19">WC_ECHO</a>,
02654                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02655                                         );
02656                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
02657                 }
02658 
02659                 <span class="comment">//</span>
02660                 <span class="comment">// restore cursor position</span>
02661                 <span class="comment">//</span>
02662 
02663                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d1/ntcon_2server_2cursor_8c.html#a7">SetCursorPosition</a>(CookedReadData-&gt;ScreenInfo,
02664                                            CursorPosition,
02665                                            <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
02666                                           );
02667                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
02668         }
02669 
02670         HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o6">InputReadData</a>-&gt;<a class="code" href="../../d8/d2/struct__INPUT__READ__HANDLE__DATA.html#o1">ReadCount</a> += 1;
02671         <span class="keywordflow">return</span> <a class="code" href="../../d1/d7/server_8h.html#a66">CONSOLE_STATUS_WAIT_NO_BLOCK</a>;
02672     }
02673     UNREFERENCED_PARAMETER(WaitingThread);
02674 }
02675 
02676 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02677"></a><a class="code" href="../../d3/d1/server_2cmdline_8c.html#a56">02677</a> <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a56">ProcessCopyToCharInput</a>(
02678     IN PVOID CookedReadDataPtr,
02679     IN PCSR_API_MSG WaitReplyMessage,
02680     IN PCSR_THREAD WaitingThread,
02681     IN BOOLEAN WaitRoutine
02682     )
02683 
02684 <span class="comment">/*++</span>
02685 <span class="comment"></span>
02686 <span class="comment">    This routine handles the delete char popup.  It returns</span>
02687 <span class="comment">    when we're out of input or the user has entered a char.</span>
02688 <span class="comment"></span>
02689 <span class="comment">    Return Value:</span>
02690 <span class="comment"></span>
02691 <span class="comment">        CONSOLE_STATUS_WAIT - we ran out of input, so</span>
02692 <span class="comment">            a wait block was created</span>
02693 <span class="comment"></span>
02694 <span class="comment">        CONSOLE_STATUS_READ_COMPLETE - user hit return</span>
02695 <span class="comment"></span>
02696 <span class="comment">--*/</span>
02697 
02698 {
02699     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02700     <a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html">PCOOKED_READ_DATA</a> CookedReadData=(<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html">PCOOKED_READ_DATA</a>)CookedReadDataPtr;
02701     WCHAR Char;
02702     <a class="code" href="../../d8/d7/struct__COMMAND.html">PCOMMAND</a> LastCommand;
02703     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> NumSpaces;
02704     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> ScrollY=0;
02705     <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> HandleData;
02706 
02707     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a30">DereferenceIoHandleNoCheck</a>(CookedReadData-&gt;<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o18">ProcessData</a>,
02708                                         CookedReadData-&gt;<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o19">HandleIndex</a>,
02709                                         &amp;HandleData
02710                                        );
02711     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
02712     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02713         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d7/server_2stream_8c.html#a19">GetChar</a>(CookedReadData-&gt;<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o0">InputInfo</a>,
02714                          &amp;Char,
02715                          <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
02716                          CookedReadData-&gt;<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o2">Console</a>,
02717                          HandleData,
02718                          WaitReplyMessage,
02719                          <a class="code" href="../../d4/d1/cmdline_8h.html#a58">CookedReadWaitRoutine</a>,
02720                          CookedReadData,
02721                          <span class="keyword">sizeof</span>(*CookedReadData),
02722                          WaitRoutine,
02723                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02724                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02725                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02726                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02727                         );
02728         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02729             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != <a class="code" href="../../d1/d7/server_8h.html#a64">CONSOLE_STATUS_WAIT</a>) {
02730                 CookedReadData-&gt;BytesRead = 0;
02731             }
02732             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02733         }
02734 
02735         <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a46">EndPopup</a>(CookedReadData-&gt;ScreenInfo,CookedReadData-&gt;CommandHistory);
02736 
02737         <span class="comment">//</span>
02738         <span class="comment">// copy up to specified char</span>
02739         <span class="comment">//</span>
02740 
02741         LastCommand = <a class="code" href="../../d4/d1/cmdline_8h.html#a55">GetLastCommand</a>(CookedReadData-&gt;CommandHistory);
02742         <span class="keywordflow">if</span> (LastCommand) {
02743             <span class="keywordtype">int</span> i,j;
02744 
02745             <span class="comment">//</span>
02746             <span class="comment">// find specified char in last command</span>
02747             <span class="comment">//</span>
02748 
02749             <span class="keywordflow">for</span> (i=CookedReadData-&gt;CurrentPosition+1;i&lt;(<span class="keywordtype">int</span>)(LastCommand-&gt;<a class="code" href="../../d8/d7/struct__COMMAND.html#o0">CommandLength</a>/<span class="keyword">sizeof</span>(WCHAR));i++) {
02750                 <span class="keywordflow">if</span> (LastCommand-&gt;<a class="code" href="../../d8/d7/struct__COMMAND.html#o1">Command</a>[i] == Char)
02751                     <span class="keywordflow">break</span>;
02752             }
02753 
02754             <span class="comment">//</span>
02755             <span class="comment">// if we found it, copy up to it</span>
02756             <span class="comment">//</span>
02757 
02758             <span class="keywordflow">if</span> (i&lt;(<span class="keywordtype">int</span>)(LastCommand-&gt;<a class="code" href="../../d8/d7/struct__COMMAND.html#o0">CommandLength</a>/<span class="keyword">sizeof</span>(WCHAR)) &amp;&amp; (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(LastCommand-&gt;<a class="code" href="../../d8/d7/struct__COMMAND.html#o0">CommandLength</a>/<span class="keyword">sizeof</span>(WCHAR)) &gt; (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)CookedReadData-&gt;CurrentPosition) {
02759                 j=i-CookedReadData-&gt;CurrentPosition;
02760                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(j&gt;0);
02761                 RtlCopyMemory(CookedReadData-&gt;BufPtr,
02762                        &amp;LastCommand-&gt;<a class="code" href="../../d8/d7/struct__COMMAND.html#o1">Command</a>[CookedReadData-&gt;CurrentPosition],
02763                        j*<span class="keyword">sizeof</span>(WCHAR));
02764                 CookedReadData-&gt;CurrentPosition += j;
02765                 j*=<span class="keyword">sizeof</span>(WCHAR);
02766                 CookedReadData-&gt;BytesRead += j;
02767                 <span class="keywordflow">if</span> (CookedReadData-&gt;Echo) {
02768                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d7/server_2stream_8c.html#a38">WriteCharsFromInput</a>(CookedReadData-&gt;ScreenInfo,
02769                                         CookedReadData-&gt;BackupLimit,
02770                                         CookedReadData-&gt;BufPtr,
02771                                         CookedReadData-&gt;BufPtr,
02772                                         (PDWORD) &amp;j,
02773                                         (PLONG)&amp;NumSpaces,
02774                                         CookedReadData-&gt;OriginalCursorPosition.X,
02775                                         <a class="code" href="../../d4/d1/cmdline_8h.html#a17">WC_DESTRUCTIVE_BACKSPACE</a> |
02776                                                 <a class="code" href="../../d4/d1/cmdline_8h.html#a18">WC_KEEP_CURSOR_VISIBLE</a> | <a class="code" href="../../d4/d1/cmdline_8h.html#a19">WC_ECHO</a>,
02777                                         &amp;ScrollY
02778                                         );
02779                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
02780                     CookedReadData-&gt;OriginalCursorPosition.Y += ScrollY;
02781                     CookedReadData-&gt;NumberOfVisibleChars += NumSpaces;
02782                 }
02783                 CookedReadData-&gt;BufPtr+=j/<span class="keyword">sizeof</span>(WCHAR);
02784             }
02785         }
02786         HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o6">InputReadData</a>-&gt;<a class="code" href="../../d8/d2/struct__INPUT__READ__HANDLE__DATA.html#o1">ReadCount</a> += 1;
02787         <span class="keywordflow">return</span> <a class="code" href="../../d1/d7/server_8h.html#a66">CONSOLE_STATUS_WAIT_NO_BLOCK</a>;
02788     }
02789     UNREFERENCED_PARAMETER(WaitingThread);
02790 }
02791 
02792 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02793"></a><a class="code" href="../../d3/d1/server_2cmdline_8c.html#a57">02793</a> <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a57">ProcessCommandNumberInput</a>(
02794     IN PVOID CookedReadDataPtr,
02795     IN PCSR_API_MSG WaitReplyMessage,
02796     IN PCSR_THREAD WaitingThread,
02797     IN BOOLEAN WaitRoutine
02798     )
02799 
02800 <span class="comment">/*++</span>
02801 <span class="comment"></span>
02802 <span class="comment">    This routine handles the delete char popup.  It returns</span>
02803 <span class="comment">    when we're out of input or the user has entered a char.</span>
02804 <span class="comment"></span>
02805 <span class="comment">    Return Value:</span>
02806 <span class="comment"></span>
02807 <span class="comment">        CONSOLE_STATUS_WAIT - we ran out of input, so</span>
02808 <span class="comment">            a wait block was created</span>
02809 <span class="comment"></span>
02810 <span class="comment">        CONSOLE_STATUS_READ_COMPLETE - user hit return</span>
02811 <span class="comment"></span>
02812 <span class="comment">--*/</span>
02813 
02814 {
02815     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02816     <a class="code" href="../../d1/d0/struct__CLE__POPUP.html">PCLE_POPUP</a> Popup;
02817     <a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html">PCOMMAND_HISTORY</a> CommandHistory;
02818     <a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html">PCOOKED_READ_DATA</a> CookedReadData=(<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html">PCOOKED_READ_DATA</a>)CookedReadDataPtr;
02819     WCHAR Char;
02820     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> NumSpaces;
02821     BOOLEAN CommandLinePopupKeys;
02822     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> CommandNumber;
02823     <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> HandleData;
02824 
02825     CommandHistory = CookedReadData-&gt;<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o13">CommandHistory</a>;
02826     Popup = CONTAINING_RECORD( CommandHistory-&gt;<a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html#o9">PopupList</a>.Flink, <a class="code" href="../../d1/d0/struct__CLE__POPUP.html">CLE_POPUP</a>, ListLink );
02827     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a30">DereferenceIoHandleNoCheck</a>(CookedReadData-&gt;<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o18">ProcessData</a>,
02828                                         CookedReadData-&gt;<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o19">HandleIndex</a>,
02829                                         &amp;HandleData
02830                                        );
02831     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
02832     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02833         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d7/server_2stream_8c.html#a19">GetChar</a>(CookedReadData-&gt;<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o0">InputInfo</a>,
02834                          &amp;Char,
02835                          <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
02836                          CookedReadData-&gt;<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o2">Console</a>,
02837                          HandleData,
02838                          WaitReplyMessage,
02839                          <a class="code" href="../../d4/d1/cmdline_8h.html#a58">CookedReadWaitRoutine</a>,
02840                          CookedReadData,
02841                          <span class="keyword">sizeof</span>(*CookedReadData),
02842                          WaitRoutine,
02843                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02844                          &amp;CommandLinePopupKeys,
02845                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02846                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02847                         );
02848         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02849             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != <a class="code" href="../../d1/d7/server_8h.html#a64">CONSOLE_STATUS_WAIT</a>) {
02850                 CookedReadData-&gt;BytesRead = 0;
02851             }
02852             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02853         }
02854 
02855         <span class="keywordflow">if</span> (Char &gt;= (WCHAR)0x30 &amp;&amp; Char &lt;= (WCHAR)0x39) {
02856             <span class="keywordflow">if</span> (Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o8">NumberRead</a> &lt; 5) {
02857                 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> CharsToWrite;
02858                 WORD RealAttributes;
02859 
02860                 RealAttributes = CookedReadData-&gt;ScreenInfo-&gt;Attributes;
02861                 CookedReadData-&gt;ScreenInfo-&gt;Attributes = Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o2">Attributes</a>;
02862                 CharsToWrite = <span class="keyword">sizeof</span>(WCHAR);
02863                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d7/server_2stream_8c.html#a38">WriteCharsFromInput</a>(CookedReadData-&gt;ScreenInfo,
02864                                     Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o7">NumberBuffer</a>,
02865                                     &amp;Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o7">NumberBuffer</a>[Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o8">NumberRead</a>],
02866                                     &amp;Char,
02867                                     &amp;CharsToWrite,
02868                                     (PLONG)&amp;NumSpaces,
02869                                     CookedReadData-&gt;OriginalCursorPosition.X,
02870                                     <a class="code" href="../../d4/d1/cmdline_8h.html#a17">WC_DESTRUCTIVE_BACKSPACE</a> |
02871                                             <a class="code" href="../../d4/d1/cmdline_8h.html#a18">WC_KEEP_CURSOR_VISIBLE</a> | <a class="code" href="../../d4/d1/cmdline_8h.html#a19">WC_ECHO</a>,
02872                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02873                                     );
02874                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
02875                 CookedReadData-&gt;ScreenInfo-&gt;Attributes = RealAttributes;
02876                 Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o7">NumberBuffer</a>[Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o8">NumberRead</a>] = Char;
02877                 Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o8">NumberRead</a> += 1;
02878             }
02879         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Char == <a class="code" href="../../d4/d5/conimep_8h.html#a51">UNICODE_BACKSPACE</a>) {
02880             <span class="keywordflow">if</span> (Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o8">NumberRead</a> &gt; 0) {
02881                 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> CharsToWrite;
02882                 WORD RealAttributes;
02883 
02884                 RealAttributes = CookedReadData-&gt;ScreenInfo-&gt;Attributes;
02885                 CookedReadData-&gt;ScreenInfo-&gt;Attributes = Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o2">Attributes</a>;
02886                 CharsToWrite = <span class="keyword">sizeof</span>(WCHAR);
02887                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d7/server_2stream_8c.html#a38">WriteCharsFromInput</a>(CookedReadData-&gt;ScreenInfo,
02888                                     Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o7">NumberBuffer</a>,
02889                                     &amp;Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o7">NumberBuffer</a>[Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o8">NumberRead</a>],
02890                                     &amp;Char,
02891                                     &amp;CharsToWrite,
02892                                     (PLONG)&amp;NumSpaces,
02893                                     CookedReadData-&gt;OriginalCursorPosition.X,
02894                                     <a class="code" href="../../d4/d1/cmdline_8h.html#a17">WC_DESTRUCTIVE_BACKSPACE</a> |
02895                                             <a class="code" href="../../d4/d1/cmdline_8h.html#a18">WC_KEEP_CURSOR_VISIBLE</a> | <a class="code" href="../../d4/d1/cmdline_8h.html#a19">WC_ECHO</a>,
02896                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02897                                     );
02898                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
02899                 CookedReadData-&gt;ScreenInfo-&gt;Attributes = RealAttributes;
02900                 Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o7">NumberBuffer</a>[Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o8">NumberRead</a>] = (WCHAR)<span class="charliteral">' '</span>;
02901                 Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o8">NumberRead</a> -= 1;
02902             }
02903         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Char == (WCHAR)VK_ESCAPE) {
02904             <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a46">EndPopup</a>(CookedReadData-&gt;ScreenInfo,CookedReadData-&gt;CommandHistory);
02905             <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/cmdline_8h.html#a14">CLE_NO_POPUPS</a>(CommandHistory)) {
02906                 <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a46">EndPopup</a>(CookedReadData-&gt;ScreenInfo,CookedReadData-&gt;CommandHistory);
02907             }
02908             <a class="code" href="../../d4/d1/cmdline_8h.html#a41">DeleteCommandLine</a>(CookedReadData,
02909                               <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02910         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Char == <a class="code" href="../../d4/d5/conimep_8h.html#a53">UNICODE_CARRIAGERETURN</a>) {
02911             <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> NumberBuffer[6];
02912             <span class="keywordtype">int</span> i;
02913 
02914             <span class="keywordflow">for</span> (i=0;i&lt;Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o8">NumberRead</a>;i++) {
02915                 NumberBuffer[i] = (<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>)Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o7">NumberBuffer</a>[i];
02916             }
02917             NumberBuffer[i] = 0;
02918             CommandNumber = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)atoi(NumberBuffer);
02919             <span class="keywordflow">if</span> ((WORD)CommandNumber &gt;= (WORD)CookedReadData-&gt;CommandHistory-&gt;NumberOfCommands) {
02920                 CommandNumber = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(CookedReadData-&gt;CommandHistory-&gt;NumberOfCommands-1);
02921             }
02922             <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a46">EndPopup</a>(CookedReadData-&gt;ScreenInfo,CookedReadData-&gt;CommandHistory);
02923             <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/cmdline_8h.html#a14">CLE_NO_POPUPS</a>(CommandHistory)) {
02924                 <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a46">EndPopup</a>(CookedReadData-&gt;ScreenInfo,CookedReadData-&gt;CommandHistory);
02925             }
02926             <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a51">SetCurrentCommandLine</a>(CookedReadData,<a class="code" href="../../d4/d1/cmdline_8h.html#a8">COMMAND_NUM_TO_INDEX</a>(CommandNumber,CookedReadData-&gt;CommandHistory));
02927         }
02928         HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o6">InputReadData</a>-&gt;<a class="code" href="../../d8/d2/struct__INPUT__READ__HANDLE__DATA.html#o1">ReadCount</a> += 1;
02929         <span class="keywordflow">return</span> <a class="code" href="../../d1/d7/server_8h.html#a66">CONSOLE_STATUS_WAIT_NO_BLOCK</a>;
02930     }
02931     UNREFERENCED_PARAMETER(WaitingThread);
02932 }
02933 
02934 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02935"></a><a class="code" href="../../d3/d1/server_2cmdline_8c.html#a58">02935</a> <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a58">CommandListPopup</a>(
02936     IN <a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html">PCOOKED_READ_DATA</a> CookedReadData,
02937     IN PCSR_API_MSG WaitReplyMessage,
02938     IN PCSR_THREAD WaitingThread,
02939     IN BOOLEAN WaitRoutine
02940     )
02941 
02942 <span class="comment">/*++</span>
02943 <span class="comment"></span>
02944 <span class="comment">    This routine handles the command list popup.  It puts up the</span>
02945 <span class="comment">    popup, then calls ProcessCommandListInput to get and process</span>
02946 <span class="comment">    input.</span>
02947 <span class="comment"></span>
02948 <span class="comment">    Return Value:</span>
02949 <span class="comment"></span>
02950 <span class="comment">        CONSOLE_STATUS_WAIT - we ran out of input, so</span>
02951 <span class="comment">            a wait block was created</span>
02952 <span class="comment"></span>
02953 <span class="comment">        STATUS_SUCCESS - read was fully completed (user hit return)</span>
02954 <span class="comment"></span>
02955 <span class="comment">--*/</span>
02956 
02957 {
02958     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> CurrentCommand;
02959     <a class="code" href="../../d1/d0/struct__CLE__POPUP.html">PCLE_POPUP</a> Popup;
02960     <a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html">PCOMMAND_HISTORY</a> CommandHistory;
02961 
02962     CommandHistory = CookedReadData-&gt;CommandHistory;
02963     Popup = CONTAINING_RECORD( CommandHistory-&gt;<a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html#o9">PopupList</a>.Flink, <a class="code" href="../../d1/d0/struct__CLE__POPUP.html">CLE_POPUP</a>, ListLink );
02964 
02965     CurrentCommand = <a class="code" href="../../d4/d1/cmdline_8h.html#a9">COMMAND_INDEX_TO_NUM</a>(CommandHistory-&gt;<a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html#o5">LastDisplayed</a>,CommandHistory);
02966 
02967     <span class="keywordflow">if</span> (CurrentCommand &lt; (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(CommandHistory-&gt;<a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html#o3">NumberOfCommands</a> - <a class="code" href="../../d4/d1/cmdline_8h.html#a2">POPUP_SIZE_Y</a>(Popup))) {
02968         Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o5">BottomIndex</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(<a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(CurrentCommand,<a class="code" href="../../d4/d1/cmdline_8h.html#a2">POPUP_SIZE_Y</a>(Popup)-1));
02969     } <span class="keywordflow">else</span> {
02970         Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o5">BottomIndex</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(CommandHistory-&gt;<a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html#o3">NumberOfCommands</a>-1);
02971     }
02972     Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o6">CurrentCommand</a> = CommandHistory-&gt;<a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html#o5">LastDisplayed</a>;
02973     <a class="code" href="../../d4/d1/cmdline_8h.html#a61">DrawCommandListPopup</a>(Popup,
02974                          CommandHistory-&gt;<a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html#o5">LastDisplayed</a>,
02975                          CommandHistory,
02976                          CookedReadData-&gt;ScreenInfo);
02977     Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o9">PopupInputRoutine</a> = (<a class="code" href="../../d4/d1/cmdline_8h.html#a27">PCLE_POPUP_INPUT_ROUTINE</a>) <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a54">ProcessCommandListInput</a>;
02978     <span class="keywordflow">return</span> <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a54">ProcessCommandListInput</a>(CookedReadData,
02979                                    WaitReplyMessage,
02980                                    WaitingThread,
02981                                    WaitRoutine
02982                                   );
02983 }
02984 
02985 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02986"></a><a class="code" href="../../d3/d1/server_2cmdline_8c.html#a59">02986</a> <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a59">DrawPromptPopup</a>(
02987     IN <a class="code" href="../../d1/d0/struct__CLE__POPUP.html">PCLE_POPUP</a> Popup,
02988     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
02989     IN PWCHAR Prompt,
02990     IN ULONG PromptLength   <span class="comment">// in chars</span>
02991     )
02992 {
02993     ULONG lStringLength;
02994     COORD WriteCoord;
02995     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> i;
02996 
02997     <span class="comment">//</span>
02998     <span class="comment">// draw empty popup</span>
02999     <span class="comment">//</span>
03000 
03001     WriteCoord.X = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(Popup-&gt;Region.Left+1);
03002     WriteCoord.Y = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(Popup-&gt;Region.Top+1);
03003     lStringLength = <a class="code" href="../../d4/d1/cmdline_8h.html#a1">POPUP_SIZE_X</a>(Popup);
03004     <span class="keywordflow">for</span> (i=0;i&lt;<a class="code" href="../../d4/d1/cmdline_8h.html#a2">POPUP_SIZE_Y</a>(Popup);i++) {
03005         <a class="code" href="../../d6/d8/dispatch_8h.html#a6">FillOutput</a>(ScreenInfo,
03006                    Popup-&gt;Attributes,
03007                    WriteCoord,
03008                    <a class="code" href="../../d5/d5/conmsg_8h.html#a11">CONSOLE_ATTRIBUTE</a>,
03009                    &amp;lStringLength
03010                   );
03011         <a class="code" href="../../d6/d8/dispatch_8h.html#a6">FillOutput</a>(ScreenInfo,
03012                    (WCHAR)<span class="charliteral">' '</span>,
03013                    WriteCoord,
03014                    <a class="code" href="../../d5/d5/conmsg_8h.html#a12">CONSOLE_FALSE_UNICODE</a>, <span class="comment">// faster that real unicode</span>
03015                    &amp;lStringLength
03016                   );
03017         WriteCoord.Y += 1;
03018     }
03019 
03020     WriteCoord.X = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(Popup-&gt;Region.Left+1);
03021     WriteCoord.Y = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(Popup-&gt;Region.Top+1);
03022 
03023     <span class="comment">//</span>
03024     <span class="comment">// write prompt to screen</span>
03025     <span class="comment">//</span>
03026 
03027     lStringLength = PromptLength;
03028     <span class="keywordflow">if</span> (lStringLength &gt; (ULONG)<a class="code" href="../../d4/d1/cmdline_8h.html#a1">POPUP_SIZE_X</a>(Popup))
03029     lStringLength = (ULONG)(<a class="code" href="../../d4/d1/cmdline_8h.html#a1">POPUP_SIZE_X</a>(Popup));
03030     <a class="code" href="../../d6/d8/dispatch_8h.html#a2">WriteOutputString</a>(ScreenInfo,
03031                       Prompt,
03032                       WriteCoord,
03033                       <a class="code" href="../../d5/d5/conmsg_8h.html#a10">CONSOLE_REAL_UNICODE</a>,
03034                       &amp;lStringLength,
03035                       <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
03036                      );
03037 }
03038 
03039 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03040"></a><a class="code" href="../../d3/d1/server_2cmdline_8c.html#a60">03040</a> <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a60">CopyFromCharPopup</a>(
03041     IN <a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html">PCOOKED_READ_DATA</a> CookedReadData,
03042     IN PCSR_API_MSG WaitReplyMessage,
03043     IN PCSR_THREAD WaitingThread,
03044     IN BOOLEAN WaitRoutine
03045     )
03046 
03047 <span class="comment">/*++</span>
03048 <span class="comment"></span>
03049 <span class="comment">    This routine handles the "delete up to this char" popup.  It puts up the</span>
03050 <span class="comment">    popup, then calls ProcessCopyFromCharInput to get and process</span>
03051 <span class="comment">    input.</span>
03052 <span class="comment"></span>
03053 <span class="comment">    Return Value:</span>
03054 <span class="comment"></span>
03055 <span class="comment">        CONSOLE_STATUS_WAIT - we ran out of input, so</span>
03056 <span class="comment">            a wait block was created</span>
03057 <span class="comment"></span>
03058 <span class="comment">        STATUS_SUCCESS - read was fully completed (user hit return)</span>
03059 <span class="comment"></span>
03060 <span class="comment">--*/</span>
03061 
03062 {
03063     <a class="code" href="../../d1/d0/struct__CLE__POPUP.html">PCLE_POPUP</a> Popup;
03064     <a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html">PCOMMAND_HISTORY</a> CommandHistory;
03065     WCHAR ItemString[70];
03066     <span class="keywordtype">int</span> ItemLength;
03067     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03068     LANGID   LangId;
03069 
03070     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d5/srvinit_8c.html#a45">GetConsoleLangId</a>(CookedReadData-&gt;ScreenInfo-&gt;Console-&gt;OutputCP, &amp;LangId);
03071     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03072         ItemLength = <a class="code" href="../../d8/d5/consrv_8h.html#a34">LoadStringEx</a>(<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a4">ghInstance</a>,<a class="code" href="../../d6/d7/menu_8h.html#a3">msgCmdLineF4</a>,ItemString,70,LangId);
03073     }
03074     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) || ItemLength == 0) {
03075         ItemLength = LoadString(<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a4">ghInstance</a>,<a class="code" href="../../d6/d7/menu_8h.html#a3">msgCmdLineF4</a>,ItemString,70);
03076     }
03077 
03078     CommandHistory = CookedReadData-&gt;CommandHistory;
03079     Popup = CONTAINING_RECORD( CommandHistory-&gt;<a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html#o9">PopupList</a>.Flink, <a class="code" href="../../d1/d0/struct__CLE__POPUP.html">CLE_POPUP</a>, ListLink );
03080 
03081     <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a59">DrawPromptPopup</a>(Popup,
03082                     CookedReadData-&gt;ScreenInfo,
03083                     ItemString,
03084                     ItemLength
03085                    );
03086     Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o9">PopupInputRoutine</a> = (<a class="code" href="../../d4/d1/cmdline_8h.html#a27">PCLE_POPUP_INPUT_ROUTINE</a>) <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a55">ProcessCopyFromCharInput</a>;
03087     <span class="keywordflow">return</span> <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a55">ProcessCopyFromCharInput</a>(CookedReadData,
03088                                   WaitReplyMessage,
03089                                   WaitingThread,
03090                                   WaitRoutine
03091                                  );
03092 }
03093 
03094 
03095 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03096"></a><a class="code" href="../../d3/d1/server_2cmdline_8c.html#a61">03096</a> <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a61">CopyToCharPopup</a>(
03097     IN <a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html">PCOOKED_READ_DATA</a> CookedReadData,
03098     IN PCSR_API_MSG WaitReplyMessage,
03099     IN PCSR_THREAD WaitingThread,
03100     IN BOOLEAN WaitRoutine
03101     )
03102 
03103 <span class="comment">/*++</span>
03104 <span class="comment"></span>
03105 <span class="comment">    This routine handles the "delete up to this char" popup.  It puts up the</span>
03106 <span class="comment">    popup, then calls ProcessCopyToCharInput to get and process</span>
03107 <span class="comment">    input.</span>
03108 <span class="comment"></span>
03109 <span class="comment">    Return Value:</span>
03110 <span class="comment"></span>
03111 <span class="comment">        CONSOLE_STATUS_WAIT - we ran out of input, so</span>
03112 <span class="comment">            a wait block was created</span>
03113 <span class="comment"></span>
03114 <span class="comment">        STATUS_SUCCESS - read was fully completed (user hit return)</span>
03115 <span class="comment"></span>
03116 <span class="comment">--*/</span>
03117 
03118 {
03119     <a class="code" href="../../d1/d0/struct__CLE__POPUP.html">PCLE_POPUP</a> Popup;
03120     <a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html">PCOMMAND_HISTORY</a> CommandHistory;
03121     WCHAR ItemString[70];
03122     <span class="keywordtype">int</span> ItemLength;
03123     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03124     LANGID   LangId;
03125 
03126     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d5/srvinit_8c.html#a45">GetConsoleLangId</a>(CookedReadData-&gt;ScreenInfo-&gt;Console-&gt;OutputCP, &amp;LangId);
03127     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03128         ItemLength = <a class="code" href="../../d8/d5/consrv_8h.html#a34">LoadStringEx</a>(<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a4">ghInstance</a>,<a class="code" href="../../d6/d7/menu_8h.html#a2">msgCmdLineF2</a>,ItemString,70,LangId);
03129     }
03130     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) || ItemLength == 0) {
03131         ItemLength = LoadString(<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a4">ghInstance</a>,<a class="code" href="../../d6/d7/menu_8h.html#a2">msgCmdLineF2</a>,ItemString,70);
03132     }
03133 
03134     CommandHistory = CookedReadData-&gt;CommandHistory;
03135     Popup = CONTAINING_RECORD( CommandHistory-&gt;<a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html#o9">PopupList</a>.Flink, <a class="code" href="../../d1/d0/struct__CLE__POPUP.html">CLE_POPUP</a>, ListLink );
03136     <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a59">DrawPromptPopup</a>(Popup,
03137                     CookedReadData-&gt;ScreenInfo,
03138                     ItemString,
03139                     ItemLength
03140                    );
03141     Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o9">PopupInputRoutine</a> = (<a class="code" href="../../d4/d1/cmdline_8h.html#a27">PCLE_POPUP_INPUT_ROUTINE</a>) <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a56">ProcessCopyToCharInput</a>;
03142     <span class="keywordflow">return</span> <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a56">ProcessCopyToCharInput</a>(CookedReadData,
03143                                   WaitReplyMessage,
03144                                   WaitingThread,
03145                                   WaitRoutine
03146                                  );
03147 }
03148 
03149 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03150"></a><a class="code" href="../../d4/d1/cmdline_8h.html#a57">03150</a> <a class="code" href="../../d4/d1/cmdline_8h.html#a57">CommandNumberPopup</a>(
03151     IN <a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html">PCOOKED_READ_DATA</a> CookedReadData,
03152     IN PCSR_API_MSG WaitReplyMessage,
03153     IN PCSR_THREAD WaitingThread,
03154     IN BOOLEAN WaitRoutine
03155     )
03156 
03157 <span class="comment">/*++</span>
03158 <span class="comment"></span>
03159 <span class="comment">    This routine handles the "enter command number" popup.  It puts up the</span>
03160 <span class="comment">    popup, then calls ProcessCommandNumberInput to get and process</span>
03161 <span class="comment">    input.</span>
03162 <span class="comment"></span>
03163 <span class="comment">    Return Value:</span>
03164 <span class="comment"></span>
03165 <span class="comment">        CONSOLE_STATUS_WAIT - we ran out of input, so</span>
03166 <span class="comment">            a wait block was created</span>
03167 <span class="comment"></span>
03168 <span class="comment">        STATUS_SUCCESS - read was fully completed (user hit return)</span>
03169 <span class="comment"></span>
03170 <span class="comment">--*/</span>
03171 
03172 {
03173     <a class="code" href="../../d1/d0/struct__CLE__POPUP.html">PCLE_POPUP</a> Popup;
03174     <a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html">PCOMMAND_HISTORY</a> CommandHistory;
03175     COORD CursorPosition;
03176     WCHAR ItemString[70];
03177     <span class="keywordtype">int</span> ItemLength;
03178     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03179     LANGID   LangId;
03180 
03181     CommandHistory = CookedReadData-&gt;CommandHistory;
03182     Popup = CONTAINING_RECORD( CommandHistory-&gt;<a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html#o9">PopupList</a>.Flink, <a class="code" href="../../d1/d0/struct__CLE__POPUP.html">CLE_POPUP</a>, ListLink );
03183 
03184     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d5/srvinit_8c.html#a45">GetConsoleLangId</a>(CookedReadData-&gt;ScreenInfo-&gt;Console-&gt;OutputCP, &amp;LangId);
03185     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03186         ItemLength = <a class="code" href="../../d8/d5/consrv_8h.html#a34">LoadStringEx</a>(<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a4">ghInstance</a>,<a class="code" href="../../d6/d7/menu_8h.html#a4">msgCmdLineF9</a>,ItemString,70,LangId);
03187     }
03188     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) || ItemLength == 0) {
03189         ItemLength = LoadString(<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a4">ghInstance</a>,<a class="code" href="../../d6/d7/menu_8h.html#a4">msgCmdLineF9</a>,ItemString,70);
03190     }
03191 
03192     <span class="keywordflow">if</span> (ItemLength &gt; <a class="code" href="../../d4/d1/cmdline_8h.html#a1">POPUP_SIZE_X</a>(Popup) - <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a3">COMMAND_NUMBER_LENGTH</a>) {
03193         ItemLength = <a class="code" href="../../d4/d1/cmdline_8h.html#a1">POPUP_SIZE_X</a>(Popup) - <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a3">COMMAND_NUMBER_LENGTH</a>;
03194     }
03195     <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a59">DrawPromptPopup</a>(Popup,
03196                     CookedReadData-&gt;ScreenInfo,
03197                     ItemString,
03198                     ItemLength
03199                    );
03200     CursorPosition.X = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o1">Region</a>.Right - <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a4">MINIMUM_COMMAND_PROMPT_SIZE</a>);
03201     CursorPosition.Y = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o1">Region</a>.Top+1);
03202     <a class="code" href="../../d6/d1/ntcon_2server_2cursor_8c.html#a7">SetCursorPosition</a>(CookedReadData-&gt;ScreenInfo,
03203                       CursorPosition,
03204                       <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
03205                      );
03206     Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o8">NumberRead</a>=0;
03207     Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o9">PopupInputRoutine</a> = (<a class="code" href="../../d4/d1/cmdline_8h.html#a27">PCLE_POPUP_INPUT_ROUTINE</a>) <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a57">ProcessCommandNumberInput</a>;
03208     <span class="keywordflow">return</span> <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a57">ProcessCommandNumberInput</a>(CookedReadData,
03209                                      WaitReplyMessage,
03210                                      WaitingThread,
03211                                      WaitRoutine
03212                                     );
03213 }
03214 
03215 
03216 <a class="code" href="../../d8/d7/struct__COMMAND.html">PCOMMAND</a>
<a name="l03217"></a><a class="code" href="../../d4/d1/cmdline_8h.html#a55">03217</a> <a class="code" href="../../d4/d1/cmdline_8h.html#a55">GetLastCommand</a>(
03218     IN <a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html">PCOMMAND_HISTORY</a> CommandHistory
03219     )
03220 {
03221     <span class="keywordflow">if</span> (CommandHistory-&gt;NumberOfCommands == 0)
03222         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03223     <span class="keywordflow">return</span> CommandHistory-&gt;Commands[CommandHistory-&gt;LastDisplayed];
03224 }
03225 
03226 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03227"></a><a class="code" href="../../d4/d1/cmdline_8h.html#a43">03227</a> <a class="code" href="../../d4/d1/cmdline_8h.html#a43">EmptyCommandHistory</a>(
03228     IN <a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html">PCOMMAND_HISTORY</a> CommandHistory
03229     )
03230 {
03231     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> i;
03232     <span class="keywordflow">if</span> (CommandHistory==<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
03233         <span class="keywordflow">return</span>;
03234     <span class="keywordflow">for</span> (i=0;i&lt;CommandHistory-&gt;NumberOfCommands;i++) {
03235         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(CommandHistory-&gt;Commands[i]);
03236     }
03237     CommandHistory-&gt;NumberOfCommands = 0;
03238     CommandHistory-&gt;LastAdded = -1;
03239     CommandHistory-&gt;LastDisplayed = -1;
03240     CommandHistory-&gt;FirstCommand = 0;
03241     CommandHistory-&gt;Flags = <a class="code" href="../../d4/d1/cmdline_8h.html#a5">CLE_RESET</a>;
03242 }
03243 
03244 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l03245"></a><a class="code" href="../../d3/d1/server_2cmdline_8c.html#a65">03245</a> <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a65">AtFirstCommand</a>(
03246     IN <a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html">PCOMMAND_HISTORY</a> CommandHistory
03247     )
03248 {
03249     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> i;
03250 
03251     <span class="keywordflow">if</span> (CommandHistory==<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
03252         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03253     <span class="keywordflow">if</span> (CommandHistory-&gt;Flags &amp; <a class="code" href="../../d4/d1/cmdline_8h.html#a5">CLE_RESET</a>)
03254         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03255     i = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(CommandHistory-&gt;LastDisplayed - 1);
03256     <span class="keywordflow">if</span> (i==-1)
03257         i=(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(CommandHistory-&gt;NumberOfCommands-1);
03258     <span class="keywordflow">return</span> (i == CommandHistory-&gt;LastAdded);
03259 }
03260 
03261 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l03262"></a><a class="code" href="../../d3/d1/server_2cmdline_8c.html#a66">03262</a> <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a66">AtLastCommand</a>(
03263     IN <a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html">PCOMMAND_HISTORY</a> CommandHistory
03264     )
03265 {
03266     <span class="keywordflow">if</span> (CommandHistory==<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
03267         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03268     <span class="keywordflow">return</span> (CommandHistory-&gt;LastDisplayed == CommandHistory-&gt;LastAdded);
03269 }
03270 
03271 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03272"></a><a class="code" href="../../d4/d1/cmdline_8h.html#a40">03272</a> <a class="code" href="../../d4/d1/cmdline_8h.html#a40">ProcessCommandLine</a>(
03273     IN
03274     <a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html">PCOOKED_READ_DATA</a> CookedReadData,
03275     IN WCHAR Char,
03276     IN DWORD KeyState,
03277     IN PCSR_API_MSG WaitReplyMessage,
03278     IN PCSR_THREAD WaitingThread,
03279     IN BOOLEAN WaitRoutine
03280     )
03281 
03282 <span class="comment">/*++</span>
03283 <span class="comment"></span>
03284 <span class="comment">    This routine process command line editing keys.</span>
03285 <span class="comment"></span>
03286 <span class="comment">    Return Value:</span>
03287 <span class="comment"></span>
03288 <span class="comment">    CONSOLE_STATUS_WAIT - CommandListPopup ran out of input</span>
03289 <span class="comment">    CONSOLE_STATUS_READ_COMPLETE - user hit &lt;enter&gt; in CommandListPopup</span>
03290 <span class="comment">    STATUS_SUCCESS - everything's cool</span>
03291 <span class="comment"></span>
03292 <span class="comment">--*/</span>
03293 
03294 {
03295     COORD CurrentPosition;
03296     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> CharsToWrite;
03297     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03298     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> UpdateCursorPosition;
03299     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> ScrollY=0;
03300     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fStartFromDelim;
03301 
03302     UpdateCursorPosition = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03303     <span class="keywordflow">if</span> (Char == VK_F7 &amp;&amp;
03304         !(KeyState &amp; (RIGHT_CTRL_PRESSED | LEFT_CTRL_PRESSED | RIGHT_ALT_PRESSED | LEFT_ALT_PRESSED))) {
03305         COORD PopupSize;
03306 
03307         <span class="keywordflow">if</span> (CookedReadData-&gt;CommandHistory &amp;&amp;
03308             CookedReadData-&gt;CommandHistory-&gt;NumberOfCommands) {
03309             PopupSize.X = 40;
03310             PopupSize.Y = 10;
03311             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a45">BeginPopup</a>(CookedReadData-&gt;ScreenInfo,
03312                        CookedReadData-&gt;CommandHistory,
03313                        PopupSize
03314                       );
03315             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03316                 <span class="comment">// CommandListPopup does EndPopup call</span>
03317                 <span class="keywordflow">return</span> <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a58">CommandListPopup</a>(CookedReadData,
03318                                         WaitReplyMessage,
03319                                         WaitingThread,
03320                                         WaitRoutine
03321                                        );
03322             }
03323         }
03324     } <span class="keywordflow">else</span> {
03325         <span class="keywordflow">switch</span> (Char) {
03326             <span class="keywordflow">case</span> VK_ESCAPE:
03327                 <a class="code" href="../../d4/d1/cmdline_8h.html#a41">DeleteCommandLine</a>(CookedReadData,
03328                                   <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03329                 <span class="keywordflow">break</span>;
03330             <span class="keywordflow">case</span> VK_UP:
03331             <span class="keywordflow">case</span> VK_DOWN:
03332             <span class="keywordflow">case</span> VK_F5:
03333                 <span class="keywordflow">if</span> (Char == VK_F5)
03334                     Char = VK_UP;
03335                 <span class="comment">// for doskey compatibility, buffer isn't circular</span>
03336                 <span class="keywordflow">if</span> (Char==VK_UP &amp;&amp; !<a class="code" href="../../d3/d1/server_2cmdline_8c.html#a65">AtFirstCommand</a>(CookedReadData-&gt;CommandHistory) ||
03337                     Char==VK_DOWN &amp;&amp; !<a class="code" href="../../d3/d1/server_2cmdline_8c.html#a66">AtLastCommand</a>(CookedReadData-&gt;CommandHistory)) {
03338                     <a class="code" href="../../d4/d1/cmdline_8h.html#a41">DeleteCommandLine</a>(CookedReadData,
03339                                       <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03340                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d5/consrv_8h.html#a253">RetrieveCommand</a>(CookedReadData-&gt;CommandHistory,
03341                                              Char,
03342                                              CookedReadData-&gt;BackupLimit,
03343                                              CookedReadData-&gt;BufferSize,
03344                                              &amp;CookedReadData-&gt;BytesRead);
03345                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(CookedReadData-&gt;BackupLimit == CookedReadData-&gt;BufPtr);
03346                     <span class="keywordflow">if</span> (CookedReadData-&gt;Echo) {
03347                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d7/server_2stream_8c.html#a38">WriteCharsFromInput</a>(CookedReadData-&gt;ScreenInfo,
03348                                 CookedReadData-&gt;BackupLimit,
03349                                 CookedReadData-&gt;BufPtr,
03350                                 CookedReadData-&gt;BufPtr,
03351                                 &amp;CookedReadData-&gt;BytesRead,
03352                                 (PLONG)&amp;CookedReadData-&gt;NumberOfVisibleChars,
03353                                 CookedReadData-&gt;OriginalCursorPosition.X,
03354                                 <a class="code" href="../../d4/d1/cmdline_8h.html#a17">WC_DESTRUCTIVE_BACKSPACE</a> |
03355                                         <a class="code" href="../../d4/d1/cmdline_8h.html#a18">WC_KEEP_CURSOR_VISIBLE</a> | <a class="code" href="../../d4/d1/cmdline_8h.html#a19">WC_ECHO</a>,
03356                                 &amp;ScrollY );
03357                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
03358                         CookedReadData-&gt;OriginalCursorPosition.Y += ScrollY;
03359                     }
03360                     CharsToWrite = CookedReadData-&gt;BytesRead/<span class="keyword">sizeof</span>(WCHAR);
03361                     CookedReadData-&gt;CurrentPosition = CharsToWrite;
03362                     CookedReadData-&gt;BufPtr = CookedReadData-&gt;BackupLimit + CharsToWrite;
03363                 }
03364                 <span class="keywordflow">break</span>;
03365             <span class="keywordflow">case</span> VK_PRIOR:
03366             <span class="keywordflow">case</span> VK_NEXT:
03367                 <span class="keywordflow">if</span> (CookedReadData-&gt;CommandHistory &amp;&amp;
03368                     CookedReadData-&gt;CommandHistory-&gt;NumberOfCommands) {
03369 
03370                 <span class="comment">//</span>
03371                 <span class="comment">// display oldest or newest command</span>
03372                 <span class="comment">//</span>
03373 
03374                 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> CommandNumber;
03375                 <span class="keywordflow">if</span> (Char == VK_PRIOR) {
03376                     CommandNumber = 0;
03377                 } <span class="keywordflow">else</span> {
03378                     CommandNumber = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(CookedReadData-&gt;CommandHistory-&gt;NumberOfCommands-1);
03379                 }
03380                 <a class="code" href="../../d4/d1/cmdline_8h.html#a41">DeleteCommandLine</a>(CookedReadData,
03381                                   <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03382                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a50">RetrieveNthCommand</a>(CookedReadData-&gt;CommandHistory,
03383                                             <a class="code" href="../../d4/d1/cmdline_8h.html#a8">COMMAND_NUM_TO_INDEX</a>(CommandNumber,CookedReadData-&gt;CommandHistory),
03384                                             CookedReadData-&gt;BackupLimit,
03385                                             CookedReadData-&gt;BufferSize,
03386                                             &amp;CookedReadData-&gt;BytesRead);
03387                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(CookedReadData-&gt;BackupLimit == CookedReadData-&gt;BufPtr);
03388                 <span class="keywordflow">if</span> (CookedReadData-&gt;Echo) {
03389                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d7/server_2stream_8c.html#a38">WriteCharsFromInput</a>(CookedReadData-&gt;ScreenInfo,
03390                                         CookedReadData-&gt;BackupLimit,
03391                                         CookedReadData-&gt;BufPtr,
03392                                         CookedReadData-&gt;BufPtr,
03393                                         &amp;CookedReadData-&gt;BytesRead,
03394                                         (PLONG)&amp;CookedReadData-&gt;NumberOfVisibleChars,
03395                                         CookedReadData-&gt;OriginalCursorPosition.X,
03396                                         <a class="code" href="../../d4/d1/cmdline_8h.html#a17">WC_DESTRUCTIVE_BACKSPACE</a> |
03397                                                 <a class="code" href="../../d4/d1/cmdline_8h.html#a18">WC_KEEP_CURSOR_VISIBLE</a> | <a class="code" href="../../d4/d1/cmdline_8h.html#a19">WC_ECHO</a>,
03398                                         &amp;ScrollY
03399                                         );
03400                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
03401                     CookedReadData-&gt;OriginalCursorPosition.Y += ScrollY;
03402                 }
03403                 CharsToWrite = CookedReadData-&gt;BytesRead/<span class="keyword">sizeof</span>(WCHAR);
03404                 CookedReadData-&gt;CurrentPosition = CharsToWrite;
03405                 CookedReadData-&gt;BufPtr = CookedReadData-&gt;BackupLimit + CharsToWrite;
03406                 }
03407                 <span class="keywordflow">break</span>;
03408             <span class="keywordflow">case</span> VK_END:
03409                 <span class="keywordflow">if</span> (KeyState &amp; (RIGHT_CTRL_PRESSED | LEFT_CTRL_PRESSED)) {
03410                     <a class="code" href="../../d4/d1/cmdline_8h.html#a41">DeleteCommandLine</a>(CookedReadData,
03411                                       <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03412                     CookedReadData-&gt;BytesRead = CookedReadData-&gt;CurrentPosition*<span class="keyword">sizeof</span>(WCHAR);
03413                     <span class="keywordflow">if</span> (CookedReadData-&gt;Echo) {
03414                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d7/server_2stream_8c.html#a38">WriteCharsFromInput</a>(CookedReadData-&gt;ScreenInfo,
03415                                             CookedReadData-&gt;BackupLimit,
03416                                             CookedReadData-&gt;BackupLimit,
03417                                             CookedReadData-&gt;BackupLimit,
03418                                             &amp;CookedReadData-&gt;BytesRead,
03419                                             (PLONG)&amp;CookedReadData-&gt;NumberOfVisibleChars,
03420                                             CookedReadData-&gt;OriginalCursorPosition.X,
03421                                             <a class="code" href="../../d4/d1/cmdline_8h.html#a17">WC_DESTRUCTIVE_BACKSPACE</a> |
03422                                                 <a class="code" href="../../d4/d1/cmdline_8h.html#a18">WC_KEEP_CURSOR_VISIBLE</a> | <a class="code" href="../../d4/d1/cmdline_8h.html#a19">WC_ECHO</a>,
03423                                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
03424                                             );
03425                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
03426                     }
03427                 } <span class="keywordflow">else</span> {
03428                     CookedReadData-&gt;CurrentPosition = CookedReadData-&gt;BytesRead/<span class="keyword">sizeof</span>(WCHAR);
03429                     CookedReadData-&gt;BufPtr = CookedReadData-&gt;BackupLimit + CookedReadData-&gt;CurrentPosition;
03430                     CurrentPosition.X = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(CookedReadData-&gt;OriginalCursorPosition.X + CookedReadData-&gt;NumberOfVisibleChars);
03431                     CurrentPosition.Y = CookedReadData-&gt;OriginalCursorPosition.Y;
03432 <span class="preprocessor">#if defined(FE_SB)</span>
03433 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (CheckBisectProcessW(CookedReadData-&gt;ScreenInfo,
03434                                             CookedReadData-&gt;ScreenInfo-&gt;Console-&gt;CP,
03435                                             CookedReadData-&gt;BackupLimit,
03436                                             CookedReadData-&gt;CurrentPosition,
03437                                             CookedReadData-&gt;ScreenInfo-&gt;ScreenBufferSize.X-CookedReadData-&gt;OriginalCursorPosition.X,
03438                                             CookedReadData-&gt;OriginalCursorPosition.X,
03439                                             <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
03440                         CurrentPosition.X++;
03441                     }
03442 <span class="preprocessor">#endif</span>
03443 <span class="preprocessor"></span>                    UpdateCursorPosition = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03444                 }
03445                 <span class="keywordflow">break</span>;
03446             <span class="keywordflow">case</span> VK_HOME:
03447                 <span class="keywordflow">if</span> (KeyState &amp; (RIGHT_CTRL_PRESSED | LEFT_CTRL_PRESSED)) {
03448                     <a class="code" href="../../d4/d1/cmdline_8h.html#a41">DeleteCommandLine</a>(CookedReadData,
03449                                       <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03450                     CookedReadData-&gt;BytesRead -= CookedReadData-&gt;CurrentPosition*<span class="keyword">sizeof</span>(WCHAR);
03451                     CookedReadData-&gt;CurrentPosition = 0;
03452                     RtlCopyMemory(CookedReadData-&gt;BackupLimit,
03453                            CookedReadData-&gt;BufPtr,
03454                            CookedReadData-&gt;BytesRead
03455                            );
03456                     CookedReadData-&gt;BufPtr = CookedReadData-&gt;BackupLimit;
03457                     <span class="keywordflow">if</span> (CookedReadData-&gt;Echo) {
03458                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d7/server_2stream_8c.html#a38">WriteCharsFromInput</a>(CookedReadData-&gt;ScreenInfo,
03459                                             CookedReadData-&gt;BackupLimit,
03460                                             CookedReadData-&gt;BackupLimit,
03461                                             CookedReadData-&gt;BackupLimit,
03462                                             &amp;CookedReadData-&gt;BytesRead,
03463                                             (PLONG)&amp;CookedReadData-&gt;NumberOfVisibleChars,
03464                                             CookedReadData-&gt;OriginalCursorPosition.X,
03465                                             <a class="code" href="../../d4/d1/cmdline_8h.html#a17">WC_DESTRUCTIVE_BACKSPACE</a> |
03466                                                 <a class="code" href="../../d4/d1/cmdline_8h.html#a18">WC_KEEP_CURSOR_VISIBLE</a> | <a class="code" href="../../d4/d1/cmdline_8h.html#a19">WC_ECHO</a>,
03467                                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
03468                                             );
03469                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
03470                     }
03471                     CurrentPosition = CookedReadData-&gt;OriginalCursorPosition;
03472                     UpdateCursorPosition = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03473                 } <span class="keywordflow">else</span> {
03474                     CookedReadData-&gt;CurrentPosition = 0;
03475                     CookedReadData-&gt;BufPtr = CookedReadData-&gt;BackupLimit;
03476                     CurrentPosition = CookedReadData-&gt;OriginalCursorPosition;
03477                     UpdateCursorPosition = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03478                 }
03479                 <span class="keywordflow">break</span>;
03480             <span class="keywordflow">case</span> VK_LEFT:
03481                 <span class="keywordflow">if</span> (KeyState &amp; (RIGHT_CTRL_PRESSED | LEFT_CTRL_PRESSED)) {
03482                     PWCHAR LastWord;
03483                     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> NonSpaceCharSeen=<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03484                     <span class="keywordflow">if</span> (CookedReadData-&gt;BufPtr != CookedReadData-&gt;BackupLimit) {
03485                         LastWord = CookedReadData-&gt;BufPtr-1;
03486                         <span class="keywordflow">while</span> (LastWord != CookedReadData-&gt;BackupLimit) {
03487                             <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/cmdline_8h.html#a23">IS_WORD_DELIM</a>(*LastWord))
03488                                 NonSpaceCharSeen=<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03489                             <span class="keywordflow">else</span>
03490                                 <span class="keywordflow">if</span> (NonSpaceCharSeen)
03491                                     <span class="keywordflow">break</span>;
03492                             LastWord--;
03493                         }
03494                         <span class="keywordflow">if</span> (LastWord != CookedReadData-&gt;BackupLimit) {
03495                             CookedReadData-&gt;BufPtr = LastWord+1;
03496                         } <span class="keywordflow">else</span> {
03497                             CookedReadData-&gt;BufPtr = LastWord;
03498                         }
03499                         CookedReadData-&gt;CurrentPosition=(ULONG)(CookedReadData-&gt;BufPtr-CookedReadData-&gt;BackupLimit);
03500                         CurrentPosition = CookedReadData-&gt;OriginalCursorPosition;
03501 <span class="preprocessor">#if defined(FE_SB)</span>
03502 <span class="preprocessor"></span>                        CurrentPosition.X = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(CurrentPosition.X +
03503                             <a class="code" href="../../d0/d7/server_2stream_8c.html#a21">RetrieveTotalNumberOfSpaces</a>(CookedReadData-&gt;OriginalCursorPosition.X,
03504                                                         CookedReadData-&gt;BackupLimit,
03505                                                         CookedReadData-&gt;CurrentPosition,
03506                                                         CookedReadData-&gt;ScreenInfo-&gt;Console));
03507                         <span class="keywordflow">if</span> (CheckBisectStringW(CookedReadData-&gt;ScreenInfo,
03508                                                CookedReadData-&gt;ScreenInfo-&gt;Console-&gt;CP,
03509                                                CookedReadData-&gt;BackupLimit,
03510                                                CookedReadData-&gt;CurrentPosition+1,
03511                                                CookedReadData-&gt;ScreenInfo-&gt;ScreenBufferSize.X
03512                                                 -CookedReadData-&gt;OriginalCursorPosition.X
03513                                                )) {
03514                             CurrentPosition.X++;
03515                         }
03516 <span class="preprocessor">#else</span>
03517 <span class="preprocessor"></span>                        CurrentPosition.X = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(CurrentPosition.X + <a class="code" href="../../d0/d7/server_2stream_8c.html#a21">RetrieveTotalNumberOfSpaces</a>(CookedReadData-&gt;OriginalCursorPosition.X,
03518                                                                          CookedReadData-&gt;BackupLimit,
03519                                                                          CookedReadData-&gt;CurrentPosition));
03520 <span class="preprocessor">#endif</span>
03521 <span class="preprocessor"></span>                        UpdateCursorPosition = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03522                     }
03523                 } <span class="keywordflow">else</span> {
03524                     <span class="keywordflow">if</span> (CookedReadData-&gt;BufPtr != CookedReadData-&gt;BackupLimit) {
03525                         CookedReadData-&gt;BufPtr--;
03526                         CookedReadData-&gt;CurrentPosition--;
03527                         CurrentPosition.X = CookedReadData-&gt;ScreenInfo-&gt;BufferInfo.TextInfo.CursorPosition.X;
03528                         CurrentPosition.Y = CookedReadData-&gt;ScreenInfo-&gt;BufferInfo.TextInfo.CursorPosition.Y;
03529 <span class="preprocessor">#if defined(FE_SB)</span>
03530 <span class="preprocessor"></span>                        CurrentPosition.X = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(CurrentPosition.X -
03531                             <a class="code" href="../../d0/d7/server_2stream_8c.html#a22">RetrieveNumberOfSpaces</a>(CookedReadData-&gt;OriginalCursorPosition.X,
03532                                                    CookedReadData-&gt;BackupLimit,
03533                                                    CookedReadData-&gt;CurrentPosition,
03534                                                    CookedReadData-&gt;ScreenInfo-&gt;Console,
03535                                                    CookedReadData-&gt;ScreenInfo-&gt;Console-&gt;CP));
03536                         <span class="keywordflow">if</span> (CheckBisectProcessW(CookedReadData-&gt;ScreenInfo,
03537                                                 CookedReadData-&gt;ScreenInfo-&gt;Console-&gt;CP,
03538                                                 CookedReadData-&gt;BackupLimit,
03539                                                 CookedReadData-&gt;CurrentPosition+2,
03540                                                 CookedReadData-&gt;ScreenInfo-&gt;ScreenBufferSize.X
03541                                                  -CookedReadData-&gt;OriginalCursorPosition.X,
03542                                                 CookedReadData-&gt;OriginalCursorPosition.X,
03543                                                 <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
03544                             <span class="keywordflow">if</span> ((CurrentPosition.X == -2) ||
03545                                 (CurrentPosition.X == -1)) {
03546                                 CurrentPosition.X--;
03547                             }
03548                         }
03549 <span class="preprocessor">#else</span>
03550 <span class="preprocessor"></span>                        CurrentPosition.X = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(CurrentPosition.X - <a class="code" href="../../d0/d7/server_2stream_8c.html#a22">RetrieveNumberOfSpaces</a>(CookedReadData-&gt;OriginalCursorPosition.X,
03551                                                                     CookedReadData-&gt;BackupLimit,
03552                                                                     CookedReadData-&gt;CurrentPosition));
03553 <span class="preprocessor">#endif</span>
03554 <span class="preprocessor"></span>                        UpdateCursorPosition = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03555                     }
03556                 }
03557                 <span class="keywordflow">break</span>;
03558             <span class="keywordflow">case</span> VK_RIGHT:
03559             <span class="keywordflow">case</span> VK_F1:
03560 
03561                 <span class="comment">//</span>
03562                 <span class="comment">// we don't need to check for end of buffer here because we've</span>
03563                 <span class="comment">// already done it.</span>
03564                 <span class="comment">//</span>
03565 
03566                 <span class="keywordflow">if</span> (KeyState &amp; (RIGHT_CTRL_PRESSED | LEFT_CTRL_PRESSED)) {
03567                     <span class="keywordflow">if</span> (Char != VK_F1) {
03568                         PWCHAR NextWord;
03569                         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> i;
03570                         <span class="keywordflow">if</span> (CookedReadData-&gt;CurrentPosition &lt; (CookedReadData-&gt;BytesRead/<span class="keyword">sizeof</span>(WCHAR))) {
03571                             NextWord = CookedReadData-&gt;BufPtr;
03572                             <span class="keywordflow">for</span> (i=(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(CookedReadData-&gt;CurrentPosition);
03573                                  i&lt;(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)((CookedReadData-&gt;BytesRead-1)/<span class="keyword">sizeof</span>(WCHAR));
03574                                  i++) {
03575                                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/cmdline_8h.html#a23">IS_WORD_DELIM</a>(*NextWord)) {
03576                                     i++;
03577                                     NextWord++;
03578                                     <span class="keywordflow">while</span> ((i&lt;(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)((CookedReadData-&gt;BytesRead-1)/<span class="keyword">sizeof</span>(WCHAR))) &amp;&amp;
03579                                             <a class="code" href="../../d4/d1/cmdline_8h.html#a23">IS_WORD_DELIM</a>(*NextWord)) {
03580                                         i++;
03581                                         NextWord++;
03582                                     }
03583                                     <span class="keywordflow">break</span>;
03584                                 }
03585                                 NextWord++;
03586                             }
03587                             CookedReadData-&gt;BufPtr = NextWord;
03588                             CookedReadData-&gt;CurrentPosition=(ULONG)(CookedReadData-&gt;BufPtr-CookedReadData-&gt;BackupLimit);
03589 <span class="preprocessor">#if defined(FE_SB)</span>
03590 <span class="preprocessor"></span>                            CurrentPosition = CookedReadData-&gt;OriginalCursorPosition;
03591                             CurrentPosition.X = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(CurrentPosition.X +
03592                                 <a class="code" href="../../d0/d7/server_2stream_8c.html#a21">RetrieveTotalNumberOfSpaces</a>(CookedReadData-&gt;OriginalCursorPosition.X,
03593                                                             CookedReadData-&gt;BackupLimit,
03594                                                             CookedReadData-&gt;CurrentPosition,
03595                                                             CookedReadData-&gt;ScreenInfo-&gt;Console));
03596                             <span class="keywordflow">if</span> (CheckBisectStringW(CookedReadData-&gt;ScreenInfo,
03597                                                    CookedReadData-&gt;ScreenInfo-&gt;Console-&gt;CP,
03598                                                    CookedReadData-&gt;BackupLimit,
03599                                                    CookedReadData-&gt;CurrentPosition+1,
03600                                                    CookedReadData-&gt;ScreenInfo-&gt;ScreenBufferSize.X
03601                                                     -CookedReadData-&gt;OriginalCursorPosition.X
03602                                                    )) {
03603                                 CurrentPosition.X++;
03604                             }
03605 <span class="preprocessor">#else</span>
03606 <span class="preprocessor"></span>                            CurrentPosition = CookedReadData-&gt;OriginalCursorPosition;
03607                             CurrentPosition.X = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(CurrentPosition.X + <a class="code" href="../../d0/d7/server_2stream_8c.html#a21">RetrieveTotalNumberOfSpaces</a>(CookedReadData-&gt;OriginalCursorPosition.X,
03608                                                                              CookedReadData-&gt;BackupLimit,
03609                                                                              CookedReadData-&gt;CurrentPosition));
03610 <span class="preprocessor">#endif</span>
03611 <span class="preprocessor"></span>                            UpdateCursorPosition = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03612                         }
03613                     }
03614                 } <span class="keywordflow">else</span> {
03615 
03616                     <span class="comment">//</span>
03617                     <span class="comment">// if not at the end of the line, move cursor position right</span>
03618                     <span class="comment">//</span>
03619 
03620                     <span class="keywordflow">if</span> (CookedReadData-&gt;CurrentPosition &lt; (CookedReadData-&gt;BytesRead/<span class="keyword">sizeof</span>(WCHAR))) {
03621                         CurrentPosition = CookedReadData-&gt;ScreenInfo-&gt;BufferInfo.TextInfo.CursorPosition;
03622 <span class="preprocessor">#if defined(FE_SB)</span>
03623 <span class="preprocessor"></span>                        CurrentPosition.X = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(CurrentPosition.X +
03624                             <a class="code" href="../../d0/d7/server_2stream_8c.html#a22">RetrieveNumberOfSpaces</a>(CookedReadData-&gt;OriginalCursorPosition.X,
03625                                                    CookedReadData-&gt;BackupLimit,
03626                                                    CookedReadData-&gt;CurrentPosition,
03627                                                    CookedReadData-&gt;ScreenInfo-&gt;Console,
03628                                                    CookedReadData-&gt;ScreenInfo-&gt;Console-&gt;CP));
03629                         <span class="keywordflow">if</span> (CheckBisectProcessW(CookedReadData-&gt;ScreenInfo,
03630                                                 CookedReadData-&gt;ScreenInfo-&gt;Console-&gt;CP,
03631                                                 CookedReadData-&gt;BackupLimit,
03632                                                 CookedReadData-&gt;CurrentPosition+2,
03633                                                 CookedReadData-&gt;ScreenInfo-&gt;ScreenBufferSize.X
03634                                                  -CookedReadData-&gt;OriginalCursorPosition.X,
03635                                                 CookedReadData-&gt;OriginalCursorPosition.X,
03636                                                 <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
03637                             <span class="keywordflow">if</span> (CurrentPosition.X == (CookedReadData-&gt;ScreenInfo-&gt;ScreenBufferSize.X-1))
03638                                 CurrentPosition.X++;
03639                         }
03640 <span class="preprocessor">#else</span>
03641 <span class="preprocessor"></span>                        CurrentPosition.X = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(CurrentPosition.X + <a class="code" href="../../d0/d7/server_2stream_8c.html#a22">RetrieveNumberOfSpaces</a>(CookedReadData-&gt;OriginalCursorPosition.X,
03642                                                                     CookedReadData-&gt;BackupLimit,
03643                                                                     CookedReadData-&gt;CurrentPosition));
03644 <span class="preprocessor">#endif</span>
03645 <span class="preprocessor"></span>                        CookedReadData-&gt;BufPtr++;
03646                         CookedReadData-&gt;CurrentPosition++;
03647                         UpdateCursorPosition = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03648 
03649                     <span class="comment">//</span>
03650                     <span class="comment">// if at the end of the line, copy a character from the</span>
03651                     <span class="comment">// same position in the last command</span>
03652                     <span class="comment">//</span>
03653 
03654                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (CookedReadData-&gt;CommandHistory) {
03655                         <a class="code" href="../../d8/d7/struct__COMMAND.html">PCOMMAND</a> LastCommand;
03656                         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> NumSpaces;
03657                         LastCommand = <a class="code" href="../../d4/d1/cmdline_8h.html#a55">GetLastCommand</a>(CookedReadData-&gt;CommandHistory);
03658                         <span class="keywordflow">if</span> (LastCommand &amp;&amp; (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(LastCommand-&gt;<a class="code" href="../../d8/d7/struct__COMMAND.html#o0">CommandLength</a>/<span class="keyword">sizeof</span>(WCHAR)) &gt; (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)CookedReadData-&gt;CurrentPosition) {
03659                             *CookedReadData-&gt;BufPtr = LastCommand-&gt;<a class="code" href="../../d8/d7/struct__COMMAND.html#o1">Command</a>[CookedReadData-&gt;CurrentPosition];
03660                             CookedReadData-&gt;BytesRead += <span class="keyword">sizeof</span>(WCHAR);
03661                             CookedReadData-&gt;CurrentPosition++;
03662                             <span class="keywordflow">if</span> (CookedReadData-&gt;Echo) {
03663                                 CharsToWrite = <span class="keyword">sizeof</span>(WCHAR);
03664                                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d7/server_2stream_8c.html#a38">WriteCharsFromInput</a>(
03665                                         CookedReadData-&gt;ScreenInfo,
03666                                         CookedReadData-&gt;BackupLimit,
03667                                         CookedReadData-&gt;BufPtr,
03668                                         CookedReadData-&gt;BufPtr,
03669                                         &amp;CharsToWrite,
03670                                         (PLONG)&amp;NumSpaces,
03671                                         CookedReadData-&gt;OriginalCursorPosition.X,
03672                                         <a class="code" href="../../d4/d1/cmdline_8h.html#a17">WC_DESTRUCTIVE_BACKSPACE</a> |
03673                                                 <a class="code" href="../../d4/d1/cmdline_8h.html#a18">WC_KEEP_CURSOR_VISIBLE</a> | <a class="code" href="../../d4/d1/cmdline_8h.html#a19">WC_ECHO</a>,
03674                                         &amp;ScrollY);
03675                                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
03676                                 CookedReadData-&gt;OriginalCursorPosition.Y += ScrollY;
03677                                 CookedReadData-&gt;NumberOfVisibleChars += NumSpaces;
03678                             }
03679                             CookedReadData-&gt;BufPtr+=1;
03680                         }
03681                     }
03682                 }
03683                 <span class="keywordflow">break</span>;
03684             <span class="keywordflow">case</span> VK_F2:
03685 
03686                 <span class="comment">//</span>
03687                 <span class="comment">// copy the previous command to the current command, up to but</span>
03688                 <span class="comment">// not including the character specified by the user.  the user</span>
03689                 <span class="comment">// is prompted via popup to enter a character.</span>
03690                 <span class="comment">//</span>
03691 
03692                 <span class="keywordflow">if</span> (CookedReadData-&gt;CommandHistory) {
03693                     COORD PopupSize;
03694 
03695                     PopupSize.X = <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a0">COPY_TO_CHAR_PROMPT_LENGTH</a>+2;
03696                     PopupSize.Y = 1;
03697                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a45">BeginPopup</a>(CookedReadData-&gt;ScreenInfo,
03698                                CookedReadData-&gt;CommandHistory,
03699                                PopupSize
03700                               );
03701                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03702                         <span class="comment">// CopyToCharPopup does EndPopup call</span>
03703                         <span class="keywordflow">return</span> <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a61">CopyToCharPopup</a>(CookedReadData,
03704                                                WaitReplyMessage,
03705                                                WaitingThread,
03706                                                WaitRoutine
03707                                               );
03708                     }
03709                 }
03710                 <span class="keywordflow">break</span>;
03711             <span class="keywordflow">case</span> VK_F3:
03712 
03713                 <span class="comment">//</span>
03714                 <span class="comment">// copy the remainder of the previous command to the current command.</span>
03715                 <span class="comment">//</span>
03716 
03717                 <span class="keywordflow">if</span> (CookedReadData-&gt;CommandHistory) {
03718                     <a class="code" href="../../d8/d7/struct__COMMAND.html">PCOMMAND</a> LastCommand;
03719                     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> NumSpaces;
03720                     <span class="keywordtype">int</span> j;  <span class="comment">// chars, not bytes</span>
03721                     LastCommand = <a class="code" href="../../d4/d1/cmdline_8h.html#a55">GetLastCommand</a>(CookedReadData-&gt;CommandHistory);
03722                     <span class="keywordflow">if</span> (LastCommand &amp;&amp; (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(LastCommand-&gt;<a class="code" href="../../d8/d7/struct__COMMAND.html#o0">CommandLength</a>/<span class="keyword">sizeof</span>(WCHAR)) &gt; (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)CookedReadData-&gt;CurrentPosition) {
03723                         j = (LastCommand-&gt;<a class="code" href="../../d8/d7/struct__COMMAND.html#o0">CommandLength</a>/<span class="keyword">sizeof</span>(WCHAR)) - CookedReadData-&gt;CurrentPosition;
03724                         RtlCopyMemory(CookedReadData-&gt;BufPtr,
03725                                 &amp;LastCommand-&gt;<a class="code" href="../../d8/d7/struct__COMMAND.html#o1">Command</a>[CookedReadData-&gt;CurrentPosition],
03726                                 j*<span class="keyword">sizeof</span>(WCHAR)
03727                                );
03728                         CookedReadData-&gt;CurrentPosition += j;
03729                         j *= <span class="keyword">sizeof</span>(WCHAR);
03730                         CookedReadData-&gt;BytesRead += j;
03731                         <span class="keywordflow">if</span> (CookedReadData-&gt;Echo) {
03732                             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d7/server_2stream_8c.html#a38">WriteCharsFromInput</a>(CookedReadData-&gt;ScreenInfo,
03733                                     CookedReadData-&gt;BackupLimit,
03734                                     CookedReadData-&gt;BufPtr,
03735                                     CookedReadData-&gt;BufPtr,
03736                                     (PDWORD) &amp;j,
03737                                     (PLONG)&amp;NumSpaces,
03738                                     CookedReadData-&gt;OriginalCursorPosition.X,
03739                                     <a class="code" href="../../d4/d1/cmdline_8h.html#a17">WC_DESTRUCTIVE_BACKSPACE</a> |
03740                                             <a class="code" href="../../d4/d1/cmdline_8h.html#a18">WC_KEEP_CURSOR_VISIBLE</a> | <a class="code" href="../../d4/d1/cmdline_8h.html#a19">WC_ECHO</a>,
03741                                     &amp;ScrollY);
03742                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
03743                             CookedReadData-&gt;OriginalCursorPosition.Y += ScrollY;
03744                             CookedReadData-&gt;NumberOfVisibleChars += NumSpaces;
03745                         }
03746                         CookedReadData-&gt;BufPtr+=j/<span class="keyword">sizeof</span>(WCHAR);
03747                     }
03748                 }
03749                 <span class="keywordflow">break</span>;
03750             <span class="keywordflow">case</span> VK_F4:
03751 
03752                 <span class="comment">//</span>
03753                 <span class="comment">// copy the previous command to the current command, from</span>
03754                 <span class="comment">// the letter specified by the user.   the user</span>
03755                 <span class="comment">// is prompted via popup to enter a character.</span>
03756                 <span class="comment">//</span>
03757 
03758                 <span class="keywordflow">if</span> (CookedReadData-&gt;CommandHistory) {
03759                     COORD PopupSize;
03760 
03761                     PopupSize.X = <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a1">COPY_FROM_CHAR_PROMPT_LENGTH</a>+2;
03762                     PopupSize.Y = 1;
03763                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a45">BeginPopup</a>(CookedReadData-&gt;ScreenInfo,
03764                                CookedReadData-&gt;CommandHistory,
03765                                PopupSize
03766                               );
03767                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03768                         <span class="comment">// CopyFromCharPopup does EndPopup call</span>
03769                         <span class="keywordflow">return</span> <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a60">CopyFromCharPopup</a>(CookedReadData,
03770                                                WaitReplyMessage,
03771                                                WaitingThread,
03772                                                WaitRoutine
03773                                               );
03774                     }
03775                 }
03776                 <span class="keywordflow">break</span>;
03777             <span class="keywordflow">case</span> VK_F6:
03778 
03779                 <span class="comment">//</span>
03780                 <span class="comment">// place a ctrl-z in the current command line</span>
03781                 <span class="comment">//</span>
03782 
03783                 {
03784                 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> NumSpaces;
03785                 *CookedReadData-&gt;BufPtr = (WCHAR)0x1a; <span class="comment">// ctrl-z</span>
03786                 CookedReadData-&gt;BytesRead += <span class="keyword">sizeof</span>(WCHAR);
03787                 CookedReadData-&gt;CurrentPosition++;
03788                 <span class="keywordflow">if</span> (CookedReadData-&gt;Echo) {
03789                     CharsToWrite = <span class="keyword">sizeof</span>(WCHAR);
03790                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d7/server_2stream_8c.html#a38">WriteCharsFromInput</a>(CookedReadData-&gt;ScreenInfo,
03791                                         CookedReadData-&gt;BackupLimit,
03792                                         CookedReadData-&gt;BufPtr,
03793                                         CookedReadData-&gt;BufPtr,
03794                                         &amp;CharsToWrite,
03795                                         (PLONG)&amp;NumSpaces,
03796                                         CookedReadData-&gt;OriginalCursorPosition.X,
03797                                         <a class="code" href="../../d4/d1/cmdline_8h.html#a17">WC_DESTRUCTIVE_BACKSPACE</a> |
03798                                                 <a class="code" href="../../d4/d1/cmdline_8h.html#a18">WC_KEEP_CURSOR_VISIBLE</a> | <a class="code" href="../../d4/d1/cmdline_8h.html#a19">WC_ECHO</a>,
03799                                         &amp;ScrollY
03800                                         );
03801                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
03802                     CookedReadData-&gt;OriginalCursorPosition.Y += ScrollY;
03803                     CookedReadData-&gt;NumberOfVisibleChars += NumSpaces;
03804                 }
03805                 CookedReadData-&gt;BufPtr+=1;
03806                 }
03807                 <span class="keywordflow">break</span>;
03808             <span class="keywordflow">case</span> VK_F7:
03809                 <span class="keywordflow">if</span> (KeyState &amp; (RIGHT_ALT_PRESSED | LEFT_ALT_PRESSED)) {
03810                     <a class="code" href="../../d4/d1/cmdline_8h.html#a43">EmptyCommandHistory</a>(CookedReadData-&gt;CommandHistory);
03811                     CookedReadData-&gt;CommandHistory-&gt;Flags |= <a class="code" href="../../d4/d1/cmdline_8h.html#a4">CLE_ALLOCATED</a>;
03812                 }
03813                 <span class="keywordflow">break</span>;
03814             <span class="keywordflow">case</span> VK_F8:
03815                 <span class="keywordflow">if</span> (CookedReadData-&gt;CommandHistory) {
03816                     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> i;
03817 
03818                     <span class="comment">//</span>
03819                     <span class="comment">// cycles through the stored commands that start with</span>
03820                     <span class="comment">// the characters in the current command</span>
03821                     <span class="comment">//</span>
03822 
03823                     i = <a class="code" href="../../d4/d1/cmdline_8h.html#a56">FindMatchingCommand</a>(CookedReadData-&gt;CommandHistory,
03824                             CookedReadData-&gt;BackupLimit,
03825                             CookedReadData-&gt;CurrentPosition*<span class="keyword">sizeof</span>(WCHAR),
03826                             CookedReadData-&gt;CommandHistory-&gt;LastDisplayed, 0);
03827                     <span class="keywordflow">if</span> (i!=-1) {
03828                         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> CurrentPosition;
03829                         COORD CursorPosition;
03830 
03831                         <span class="comment">//</span>
03832                         <span class="comment">// save cursor position</span>
03833                         <span class="comment">//</span>
03834 
03835                         CurrentPosition = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)CookedReadData-&gt;CurrentPosition;
03836                         CursorPosition = CookedReadData-&gt;ScreenInfo-&gt;BufferInfo.TextInfo.CursorPosition;
03837 
03838                         <a class="code" href="../../d4/d1/cmdline_8h.html#a41">DeleteCommandLine</a>(CookedReadData,
03839                                           <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03840                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a50">RetrieveNthCommand</a>(CookedReadData-&gt;CommandHistory,
03841                                                     i,
03842                                                     CookedReadData-&gt;BackupLimit,
03843                                                     CookedReadData-&gt;BufferSize,
03844                                                     &amp;CookedReadData-&gt;BytesRead);
03845                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(CookedReadData-&gt;BackupLimit == CookedReadData-&gt;BufPtr);
03846                         <span class="keywordflow">if</span> (CookedReadData-&gt;Echo) {
03847                             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d7/server_2stream_8c.html#a38">WriteCharsFromInput</a>(CookedReadData-&gt;ScreenInfo,
03848                                     CookedReadData-&gt;BackupLimit,
03849                                     CookedReadData-&gt;BufPtr,
03850                                     CookedReadData-&gt;BufPtr,
03851                                     &amp;CookedReadData-&gt;BytesRead,
03852                                     (PLONG)&amp;CookedReadData-&gt;NumberOfVisibleChars,
03853                                     CookedReadData-&gt;OriginalCursorPosition.X,
03854                                     <a class="code" href="../../d4/d1/cmdline_8h.html#a17">WC_DESTRUCTIVE_BACKSPACE</a> |
03855                                             <a class="code" href="../../d4/d1/cmdline_8h.html#a18">WC_KEEP_CURSOR_VISIBLE</a> | <a class="code" href="../../d4/d1/cmdline_8h.html#a19">WC_ECHO</a>,
03856                                     &amp;ScrollY);
03857                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
03858                             CookedReadData-&gt;OriginalCursorPosition.Y += ScrollY;
03859                         }
03860                         CursorPosition.Y += ScrollY;
03861 
03862                         <span class="comment">//</span>
03863                         <span class="comment">// restore cursor position</span>
03864                         <span class="comment">//</span>
03865 
03866                         CookedReadData-&gt;BufPtr = CookedReadData-&gt;BackupLimit + CurrentPosition;
03867                         CookedReadData-&gt;CurrentPosition = CurrentPosition;
03868                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d1/ntcon_2server_2cursor_8c.html#a7">SetCursorPosition</a>(CookedReadData-&gt;ScreenInfo,
03869                                                    CursorPosition,
03870                                                    <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
03871                                                   );
03872                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
03873                     }
03874                 }
03875                 <span class="keywordflow">break</span>;
03876             <span class="keywordflow">case</span> VK_F9:
03877 
03878                 <span class="comment">//</span>
03879                 <span class="comment">// prompt the user to enter the desired command number.</span>
03880                 <span class="comment">// copy that command to the command line.</span>
03881                 <span class="comment">//</span>
03882 
03883                 {
03884                 COORD PopupSize;
03885 
03886                 <span class="keywordflow">if</span> (CookedReadData-&gt;CommandHistory &amp;&amp;
03887                     CookedReadData-&gt;CommandHistory-&gt;NumberOfCommands &amp;&amp;
03888                     CookedReadData-&gt;ScreenInfo-&gt;ScreenBufferSize.X &gt;= <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a4">MINIMUM_COMMAND_PROMPT_SIZE</a>+2) {  <span class="comment">// 2 is for border</span>
03889                     PopupSize.X = <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a2">COMMAND_NUMBER_PROMPT_LENGTH</a>+<a class="code" href="../../d3/d1/server_2cmdline_8c.html#a3">COMMAND_NUMBER_LENGTH</a>;
03890                     PopupSize.Y = 1;
03891                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a45">BeginPopup</a>(CookedReadData-&gt;ScreenInfo,
03892                                         CookedReadData-&gt;CommandHistory,
03893                                         PopupSize
03894                                        );
03895                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03896                         <span class="comment">// CommandNumberPopup does EndPopup call</span>
03897                         <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/cmdline_8h.html#a57">CommandNumberPopup</a>(CookedReadData,
03898                                                   WaitReplyMessage,
03899                                                   WaitingThread,
03900                                                   WaitRoutine
03901                                                  );
03902                     }
03903                 }
03904                 }
03905                 <span class="keywordflow">break</span>;
03906             <span class="keywordflow">case</span> VK_F10:
03907                 <span class="keywordflow">if</span> (KeyState &amp; (RIGHT_ALT_PRESSED | LEFT_ALT_PRESSED)) {
03908                     <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a32">ClearAliases</a>(CookedReadData-&gt;Console);
03909                 }
03910                 <span class="keywordflow">break</span>;
03911             <span class="keywordflow">case</span> VK_INSERT:
03912                 CookedReadData-&gt;InsertMode = !CookedReadData-&gt;InsertMode;
03913                 <a class="code" href="../../d6/d1/ntcon_2server_2cursor_8c.html#a5">SetCursorMode</a>(CookedReadData-&gt;ScreenInfo,
03914                               (BOOLEAN)(CookedReadData-&gt;InsertMode != CookedReadData-&gt;Console-&gt;InsertMode));
03915                 <span class="keywordflow">break</span>;
03916         <span class="keywordflow">case</span> VK_DELETE:
03917                 <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d3/input_8h.html#a12">AT_EOL</a>(CookedReadData)) {
03918                     COORD CursorPosition;
03919 
03920                     fStartFromDelim = <a class="code" href="../../d4/d1/cmdline_8h.html#a23">IS_WORD_DELIM</a>(*CookedReadData-&gt;BufPtr);
03921 
03922 del_repeat:
03923                     <span class="comment">//</span>
03924                     <span class="comment">// save cursor position</span>
03925                     <span class="comment">//</span>
03926 
03927                     CursorPosition = CookedReadData-&gt;ScreenInfo-&gt;BufferInfo.TextInfo.CursorPosition;
03928 
03929                     <span class="comment">//</span>
03930                     <span class="comment">// deletecommandline</span>
03931                     <span class="comment">//</span>
03932 
03933                     <a class="code" href="../../d4/d1/cmdline_8h.html#a41">DeleteCommandLine</a>(CookedReadData,
03934                                       <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03935                     <span class="comment">//</span>
03936                     <span class="comment">// delete char</span>
03937                     <span class="comment">//</span>
03938 
03939                     CookedReadData-&gt;BytesRead -= <span class="keyword">sizeof</span>(WCHAR);
03940                     RtlCopyMemory(CookedReadData-&gt;BufPtr,
03941                            CookedReadData-&gt;BufPtr+1,
03942                            CookedReadData-&gt;BytesRead - (CookedReadData-&gt;CurrentPosition*<span class="keyword">sizeof</span>(WCHAR))
03943                           );
03944 
03945 <span class="preprocessor">#if defined(FE_SB)</span>
03946 <span class="preprocessor"></span>                    {
03947                         PWCHAR buf = (PWCHAR)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)CookedReadData-&gt;BackupLimit +
03948                                                      CookedReadData-&gt;BytesRead    );
03949                         *buf = (WCHAR)<span class="charliteral">' '</span>;
03950                     }
03951 <span class="preprocessor">#endif</span>
03952 <span class="preprocessor"></span>                    <span class="comment">//</span>
03953                     <span class="comment">// write commandline</span>
03954                     <span class="comment">//</span>
03955 
03956                     <span class="keywordflow">if</span> (CookedReadData-&gt;Echo) {
03957                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d7/server_2stream_8c.html#a38">WriteCharsFromInput</a>(CookedReadData-&gt;ScreenInfo,
03958                                 CookedReadData-&gt;BackupLimit,
03959                                 CookedReadData-&gt;BackupLimit,
03960                                 CookedReadData-&gt;BackupLimit,
03961                                 &amp;CookedReadData-&gt;BytesRead,
03962                                 (PLONG)&amp;CookedReadData-&gt;NumberOfVisibleChars,
03963                                 CookedReadData-&gt;OriginalCursorPosition.X,
03964                                 <a class="code" href="../../d4/d1/cmdline_8h.html#a17">WC_DESTRUCTIVE_BACKSPACE</a> |
03965                                         <a class="code" href="../../d4/d1/cmdline_8h.html#a18">WC_KEEP_CURSOR_VISIBLE</a> | <a class="code" href="../../d4/d1/cmdline_8h.html#a19">WC_ECHO</a>,
03966                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03967                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
03968                     }
03969 
03970                     <span class="comment">//</span>
03971                     <span class="comment">// restore cursor position</span>
03972                     <span class="comment">//</span>
03973 
03974                     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/consrv_8h.html#a32">CONSOLE_IS_DBCS_ENABLED</a>() &amp;&amp; CONSOLE_IS_DBCS_CP(CookedReadData-&gt;Console)) {
03975                         <span class="keywordflow">if</span> (CheckBisectProcessW(CookedReadData-&gt;ScreenInfo,
03976                                                 CookedReadData-&gt;ScreenInfo-&gt;Console-&gt;CP,
03977                                                 CookedReadData-&gt;BackupLimit,
03978                                                 CookedReadData-&gt;CurrentPosition+1,
03979                                                 CookedReadData-&gt;ScreenInfo-&gt;ScreenBufferSize.X
03980                                                  -CookedReadData-&gt;OriginalCursorPosition.X,
03981                                                 CookedReadData-&gt;OriginalCursorPosition.X,
03982                                                 <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
03983                             CursorPosition.X++;
03984                         }
03985                         CurrentPosition = CursorPosition;
03986                         <span class="keywordflow">if</span> (CookedReadData-&gt;Echo) {
03987                             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d8/dispatch_8h.html#a10">AdjustCursorPosition</a>(CookedReadData-&gt;ScreenInfo,
03988                                                           CurrentPosition,
03989                                                           <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
03990                                                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03991                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
03992                         }
03993                     }
03994                     <span class="keywordflow">else</span> {
03995                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d1/ntcon_2server_2cursor_8c.html#a7">SetCursorPosition</a>(CookedReadData-&gt;ScreenInfo,
03996                                                    CursorPosition,
03997                                                    <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
03998                                                   );
03999                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
04000                     }
04001 
04002                     <span class="comment">// If Ctrl key is pressed, delete a word.</span>
04003                     <span class="comment">// If the start point was word delimiter, just remove delimiters portion only.</span>
04004                     <span class="keywordflow">if</span> ((KeyState &amp; <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a7">CTRL_PRESSED</a>) &amp;&amp; !<a class="code" href="../../d9/d3/input_8h.html#a12">AT_EOL</a>(CookedReadData) &amp;&amp;
04005                             fStartFromDelim ^ !<a class="code" href="../../d4/d1/cmdline_8h.html#a23">IS_WORD_DELIM</a>(*CookedReadData-&gt;BufPtr)) {
04006                         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"Repeating it(%x).\n"</span>, *CookedReadData-&gt;BufPtr));
04007                         <span class="keywordflow">goto</span> del_repeat;
04008                     }
04009                 }
04010                 <span class="keywordflow">break</span>;
04011             <span class="keywordflow">default</span>:
04012                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04013                 <span class="keywordflow">break</span>;
04014         }
04015     }
04016     <span class="keywordflow">if</span> (UpdateCursorPosition &amp;&amp; CookedReadData-&gt;Echo) {
04017         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d8/dispatch_8h.html#a10">AdjustCursorPosition</a>(CookedReadData-&gt;ScreenInfo,
04018                                       CurrentPosition,
04019                                       <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
04020                                       <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04021         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
04022     }
04023     <span class="keywordflow">return</span> STATUS_SUCCESS;
04024 }
04025 
<a name="l04026"></a><a class="code" href="../../d3/d1/server_2cmdline_8c.html#a68">04026</a> <a class="code" href="../../d8/d7/struct__COMMAND.html">PCOMMAND</a> <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a68">RemoveCommand</a>(
04027     IN <a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html">PCOMMAND_HISTORY</a> CommandHistory,
04028     IN SHORT iDel)
04029 {
04030     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> iFirst, iLast, iDisp, nDel;
04031     <a class="code" href="../../d8/d7/struct__COMMAND.html">PCOMMAND</a> *ppcFirst, *ppcDel, pcmdDel;
04032 
04033     iFirst = CommandHistory-&gt;FirstCommand;
04034     iLast = CommandHistory-&gt;LastAdded;
04035     iDisp = CommandHistory-&gt;LastDisplayed;
04036 
04037     <span class="keywordflow">if</span> (CommandHistory-&gt;NumberOfCommands == 0) {
04038         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04039     }
04040 
04041     nDel = <a class="code" href="../../d4/d1/cmdline_8h.html#a9">COMMAND_INDEX_TO_NUM</a>(iDel, CommandHistory);
04042     <span class="keywordflow">if</span> ((nDel &lt; <a class="code" href="../../d4/d1/cmdline_8h.html#a9">COMMAND_INDEX_TO_NUM</a>(iFirst, CommandHistory)) ||
04043             (nDel &gt; <a class="code" href="../../d4/d1/cmdline_8h.html#a9">COMMAND_INDEX_TO_NUM</a>(iLast, CommandHistory))) {
04044         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04045     }
04046 
04047     <span class="keywordflow">if</span> (iDisp == iDel) {
04048         CommandHistory-&gt;LastDisplayed = -1;
04049     }
04050 
04051     ppcFirst = &amp;(CommandHistory-&gt;Commands[iFirst]);
04052     ppcDel = &amp;(CommandHistory-&gt;Commands[iDel]);
04053     pcmdDel = *ppcDel;
04054 
04055     <span class="keywordflow">if</span> (iDel &lt; iLast) {
04056         RtlCopyMemory(ppcDel, ppcDel+1, (iLast - iDel) * <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d7/struct__COMMAND.html">PCOMMAND</a>));
04057         <span class="keywordflow">if</span> ((iDisp &gt; iDel) &amp;&amp; (iDisp &lt;= iLast)) {
04058             <a class="code" href="../../d4/d1/cmdline_8h.html#a12">COMMAND_IND_DEC</a>(iDisp, CommandHistory);
04059         }
04060         <a class="code" href="../../d4/d1/cmdline_8h.html#a12">COMMAND_IND_DEC</a>(iLast, CommandHistory);
04061     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (iFirst &lt;= iDel) {
04062         RtlMoveMemory(ppcFirst+1, ppcFirst, (iDel - iFirst) * <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d7/struct__COMMAND.html">PCOMMAND</a>));
04063         <span class="keywordflow">if</span> ((iDisp &gt;= iFirst) &amp;&amp; (iDisp &lt; iDel)) {
04064             <a class="code" href="../../d4/d1/cmdline_8h.html#a13">COMMAND_IND_INC</a>(iDisp, CommandHistory);
04065         }
04066         <a class="code" href="../../d4/d1/cmdline_8h.html#a13">COMMAND_IND_INC</a>(iFirst, CommandHistory);
04067     }
04068 
04069     CommandHistory-&gt;FirstCommand = iFirst;
04070     CommandHistory-&gt;LastAdded = iLast;
04071     CommandHistory-&gt;LastDisplayed = iDisp;
04072     CommandHistory-&gt;NumberOfCommands--;
04073     <span class="keywordflow">return</span> pcmdDel;
04074 }
04075 
04076 
04077 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>
<a name="l04078"></a><a class="code" href="../../d4/d1/cmdline_8h.html#a56">04078</a> <a class="code" href="../../d4/d1/cmdline_8h.html#a56">FindMatchingCommand</a>(
04079     IN <a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html">PCOMMAND_HISTORY</a> CommandHistory,
04080     IN PWCHAR pwszIn,
04081     IN ULONG cbIn,                   <span class="comment">// in bytes (!)</span>
04082     IN SHORT CommandIndex,           <span class="comment">// where to start from</span>
04083     IN DWORD Flags
04084     )
04085 
04086 <span class="comment">/*++</span>
04087 <span class="comment"></span>
04088 <span class="comment">    this routine finds the most recent command that starts with</span>
04089 <span class="comment">    the letters already in the current command.  it returns the</span>
04090 <span class="comment">    array index (no mod needed).</span>
04091 <span class="comment"></span>
04092 <span class="comment">--*/</span>
04093 
04094 {
04095     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> i;
04096 
04097     <span class="keywordflow">if</span> (CommandHistory-&gt;NumberOfCommands == 0) {
04098         <span class="keywordflow">return</span> -1;
04099     }
04100     <span class="keywordflow">if</span> (!(Flags &amp; <a class="code" href="../../d4/d1/cmdline_8h.html#a16">FMCFL_JUST_LOOKING</a>) &amp;&amp; (CommandHistory-&gt;Flags &amp; <a class="code" href="../../d4/d1/cmdline_8h.html#a5">CLE_RESET</a>)) {
04101         CommandHistory-&gt;Flags &amp;= ~<a class="code" href="../../d4/d1/cmdline_8h.html#a5">CLE_RESET</a>;
04102     } <span class="keywordflow">else</span> {
04103         <a class="code" href="../../d4/d1/cmdline_8h.html#a10">COMMAND_IND_PREV</a>(CommandIndex, CommandHistory);
04104     }
04105     <span class="keywordflow">if</span> (cbIn == 0) {
04106         <span class="keywordflow">return</span> CommandIndex;
04107     }
04108     <span class="keywordflow">for</span> (i=0;i&lt;CommandHistory-&gt;NumberOfCommands;i++) {
04109         <a class="code" href="../../d8/d7/struct__COMMAND.html">PCOMMAND</a> pcmdT = CommandHistory-&gt;Commands[CommandIndex];
04110 
04111         <span class="keywordflow">if</span> ((!(Flags &amp; <a class="code" href="../../d4/d1/cmdline_8h.html#a15">FMCFL_EXACT_MATCH</a>) &amp;&amp; (cbIn &lt;= pcmdT-&gt;<a class="code" href="../../d8/d7/struct__COMMAND.html#o0">CommandLength</a>)) ||
04112                 ((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)cbIn == pcmdT-&gt;<a class="code" href="../../d8/d7/struct__COMMAND.html#o0">CommandLength</a>)) {
04113             <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d1/server_2cmdline_8c.html#a10">my_wcsncmp</a>(pcmdT-&gt;<a class="code" href="../../d8/d7/struct__COMMAND.html#o1">Command</a>, pwszIn, (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)cbIn)) {
04114                 <span class="keywordflow">return</span> CommandIndex;
04115             }
04116         }
04117         <a class="code" href="../../d4/d1/cmdline_8h.html#a10">COMMAND_IND_PREV</a>(CommandIndex, CommandHistory);
04118     }
04119     <span class="keywordflow">return</span> -1;
04120 }
04121 
04122 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04123"></a><a class="code" href="../../d4/d1/cmdline_8h.html#a54">04123</a> <a class="code" href="../../d4/d1/cmdline_8h.html#a54">DrawCommandListBorder</a>(
04124     IN <a class="code" href="../../d1/d0/struct__CLE__POPUP.html">PCLE_POPUP</a> Popup,
04125     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo
04126     )
04127 {
04128     COORD WriteCoord;
04129     ULONG Length;
04130     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> i;
04131 
04132     <span class="comment">//</span>
04133     <span class="comment">// fill attributes of top line</span>
04134     <span class="comment">//</span>
04135     WriteCoord.X = Popup-&gt;Region.Left;
04136     WriteCoord.Y = Popup-&gt;Region.Top;
04137     Length = <a class="code" href="../../d4/d1/cmdline_8h.html#a1">POPUP_SIZE_X</a>(Popup) + 2;
04138     <a class="code" href="../../d6/d8/dispatch_8h.html#a6">FillOutput</a>(ScreenInfo,
04139                Popup-&gt;Attributes,
04140                WriteCoord,
04141                <a class="code" href="../../d5/d5/conmsg_8h.html#a11">CONSOLE_ATTRIBUTE</a>,
04142                &amp;Length
04143               );
04144     <span class="comment">//</span>
04145     <span class="comment">// draw upper left corner</span>
04146     <span class="comment">//</span>
04147     Length = 1;
04148     <a class="code" href="../../d6/d8/dispatch_8h.html#a6">FillOutput</a>(ScreenInfo,
04149 #<span class="keywordflow">if</span> defined(FE_SB)
04150                ScreenInfo-&gt;LineChar[UPPER_LEFT_CORNER],
04151 #<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a85">else</a>
04152                (WCHAR)0x250c,
04153 #endif
04154                WriteCoord,
04155                <a class="code" href="../../d5/d5/conmsg_8h.html#a10">CONSOLE_REAL_UNICODE</a>,
04156                &amp;Length
04157               );
04158 
04159     <span class="comment">//</span>
04160     <span class="comment">// draw upper bar</span>
04161     <span class="comment">//</span>
04162 
04163     WriteCoord.X += 1;
04164     Length = <a class="code" href="../../d4/d1/cmdline_8h.html#a1">POPUP_SIZE_X</a>(Popup);
04165     <a class="code" href="../../d6/d8/dispatch_8h.html#a6">FillOutput</a>(ScreenInfo,
04166 #<span class="keywordflow">if</span> defined(FE_SB)
04167                ScreenInfo-&gt;LineChar[HORIZONTAL_LINE],
04168 #<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a85">else</a>
04169                (WCHAR)0x2500,
04170 #endif
04171                WriteCoord,
04172                <a class="code" href="../../d5/d5/conmsg_8h.html#a10">CONSOLE_REAL_UNICODE</a>,
04173                &amp;Length
04174               );
04175 
04176     <span class="comment">//</span>
04177     <span class="comment">// draw upper right corner</span>
04178     <span class="comment">//</span>
04179 
04180     WriteCoord.X = Popup-&gt;Region.Right;
04181     Length = 1;
04182     <a class="code" href="../../d6/d8/dispatch_8h.html#a6">FillOutput</a>(ScreenInfo,
04183 #<span class="keywordflow">if</span> defined(FE_SB)
04184                ScreenInfo-&gt;LineChar[UPPER_RIGHT_CORNER],
04185 #<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a85">else</a>
04186                (WCHAR)0x2510,
04187 #endif
04188                WriteCoord,
04189                <a class="code" href="../../d5/d5/conmsg_8h.html#a10">CONSOLE_REAL_UNICODE</a>,
04190                &amp;Length
04191               );
04192 
04193     <span class="keywordflow">for</span> (i=0;i&lt;<a class="code" href="../../d4/d1/cmdline_8h.html#a2">POPUP_SIZE_Y</a>(Popup);i++) {
04194         WriteCoord.Y += 1;
04195         WriteCoord.X = Popup-&gt;Region.Left;
04196 
04197         <span class="comment">//</span>
04198         <span class="comment">// fill attributes</span>
04199         <span class="comment">//</span>
04200 
04201         Length = <a class="code" href="../../d4/d1/cmdline_8h.html#a1">POPUP_SIZE_X</a>(Popup) + 2;
04202         <a class="code" href="../../d6/d8/dispatch_8h.html#a6">FillOutput</a>(ScreenInfo,
04203                    Popup-&gt;Attributes,
04204                    WriteCoord,
04205                    <a class="code" href="../../d5/d5/conmsg_8h.html#a11">CONSOLE_ATTRIBUTE</a>,
04206                    &amp;Length
04207                   );
04208         Length = 1;
04209         <a class="code" href="../../d6/d8/dispatch_8h.html#a6">FillOutput</a>(ScreenInfo,
04210 #<span class="keywordflow">if</span> defined(FE_SB)
04211                    ScreenInfo-&gt;LineChar[VERTICAL_LINE],
04212 #<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a85">else</a>
04213                    (WCHAR)0x2502,
04214 #endif
04215                    WriteCoord,
04216                    <a class="code" href="../../d5/d5/conmsg_8h.html#a10">CONSOLE_REAL_UNICODE</a>,
04217                    &amp;Length
04218                   );
04219         WriteCoord.X = Popup-&gt;Region.Right;
04220         Length = 1;
04221         <a class="code" href="../../d6/d8/dispatch_8h.html#a6">FillOutput</a>(ScreenInfo,
04222 #<span class="keywordflow">if</span> defined(FE_SB)
04223                    ScreenInfo-&gt;LineChar[VERTICAL_LINE],
04224 #<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a85">else</a>
04225                    (WCHAR)0x2502,
04226 #endif
04227                    WriteCoord,
04228                    <a class="code" href="../../d5/d5/conmsg_8h.html#a10">CONSOLE_REAL_UNICODE</a>,
04229                    &amp;Length
04230                   );
04231     }
04232 
04233     <span class="comment">//</span>
04234     <span class="comment">// draw bottom line</span>
04235     <span class="comment">//</span>
04236     <span class="comment">// fill attributes of top line</span>
04237     <span class="comment">//</span>
04238 
04239     WriteCoord.X = Popup-&gt;Region.Left;
04240     WriteCoord.Y = Popup-&gt;Region.Bottom;
04241     Length = <a class="code" href="../../d4/d1/cmdline_8h.html#a1">POPUP_SIZE_X</a>(Popup) + 2;
04242     <a class="code" href="../../d6/d8/dispatch_8h.html#a6">FillOutput</a>(ScreenInfo,
04243                Popup-&gt;Attributes,
04244                WriteCoord,
04245                <a class="code" href="../../d5/d5/conmsg_8h.html#a11">CONSOLE_ATTRIBUTE</a>,
04246                &amp;Length
04247               );
04248     <span class="comment">//</span>
04249     <span class="comment">// draw bottom left corner</span>
04250     <span class="comment">//</span>
04251 
04252     Length = 1;
04253     WriteCoord.X = Popup-&gt;Region.Left;
04254     <a class="code" href="../../d6/d8/dispatch_8h.html#a6">FillOutput</a>(ScreenInfo,
04255 #<span class="keywordflow">if</span> defined(FE_SB)
04256                ScreenInfo-&gt;LineChar[BOTTOM_LEFT_CORNER],
04257 #<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a85">else</a>
04258                (WCHAR)0x2514,
04259 #endif
04260                WriteCoord,
04261                <a class="code" href="../../d5/d5/conmsg_8h.html#a10">CONSOLE_REAL_UNICODE</a>,
04262                &amp;Length
04263               );
04264 
04265     <span class="comment">//</span>
04266     <span class="comment">// draw lower bar</span>
04267     <span class="comment">//</span>
04268 
04269     WriteCoord.X += 1;
04270     Length = <a class="code" href="../../d4/d1/cmdline_8h.html#a1">POPUP_SIZE_X</a>(Popup);
04271     <a class="code" href="../../d6/d8/dispatch_8h.html#a6">FillOutput</a>(ScreenInfo,
04272 #<span class="keywordflow">if</span> defined(FE_SB)
04273                ScreenInfo-&gt;LineChar[HORIZONTAL_LINE],
04274 #<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a85">else</a>
04275                (WCHAR)0x2500,
04276 #endif
04277                WriteCoord,
04278                <a class="code" href="../../d5/d5/conmsg_8h.html#a10">CONSOLE_REAL_UNICODE</a>,
04279                &amp;Length
04280               );
04281 
04282     <span class="comment">//</span>
04283     <span class="comment">// draw lower right corner</span>
04284     <span class="comment">//</span>
04285 
04286     WriteCoord.X = Popup-&gt;Region.Right;
04287     Length = 1;
04288     <a class="code" href="../../d6/d8/dispatch_8h.html#a6">FillOutput</a>(ScreenInfo,
04289 #<span class="keywordflow">if</span> defined(FE_SB)
04290                ScreenInfo-&gt;LineChar[BOTTOM_RIGHT_CORNER],
04291 #<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a85">else</a>
04292                (WCHAR)0x2518,
04293 #endif
04294                WriteCoord,
04295                <a class="code" href="../../d5/d5/conmsg_8h.html#a10">CONSOLE_REAL_UNICODE</a>,
04296                &amp;Length
04297               );
04298 }
04299 
04300 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04301"></a><a class="code" href="../../d3/d1/server_2cmdline_8c.html#a71">04301</a> <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a71">UpdateHighlight</a>(
04302     IN <a class="code" href="../../d1/d0/struct__CLE__POPUP.html">PCLE_POPUP</a> Popup,
04303     IN SHORT OldCurrentCommand, <span class="comment">// command number, not index</span>
04304     IN SHORT NewCurrentCommand,
04305     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo
04306     )
04307 {
04308     COORD WriteCoord;
04309     ULONG lStringLength;
04310     WORD Attributes;
04311     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> TopIndex;
04312 
04313     <span class="keywordflow">if</span> (Popup-&gt;BottomIndex &lt; <a class="code" href="../../d4/d1/cmdline_8h.html#a2">POPUP_SIZE_Y</a>(Popup)) {
04314         TopIndex = 0;
04315     } <span class="keywordflow">else</span> {
04316         TopIndex = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(Popup-&gt;BottomIndex-<a class="code" href="../../d4/d1/cmdline_8h.html#a2">POPUP_SIZE_Y</a>(Popup)+1);
04317     }
04318     WriteCoord.X = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(Popup-&gt;Region.Left+1);
04319     lStringLength = <a class="code" href="../../d4/d1/cmdline_8h.html#a1">POPUP_SIZE_X</a>(Popup);
04320 
04321     WriteCoord.Y = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(Popup-&gt;Region.Top+1+OldCurrentCommand-TopIndex);
04322     <a class="code" href="../../d6/d8/dispatch_8h.html#a6">FillOutput</a>(ScreenInfo,
04323                Popup-&gt;Attributes,
04324                WriteCoord,
04325                <a class="code" href="../../d5/d5/conmsg_8h.html#a11">CONSOLE_ATTRIBUTE</a>,
04326                &amp;lStringLength
04327               );
04328 
04329     <span class="comment">//</span>
04330     <span class="comment">// highlight new command</span>
04331     <span class="comment">//</span>
04332 
04333     WriteCoord.Y = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(Popup-&gt;Region.Top+1+NewCurrentCommand-TopIndex);
04334     <span class="comment">// inverted attributes</span>
04335     Attributes = (WORD)(((Popup-&gt;Attributes &lt;&lt; 4) &amp; 0xf0) |
04336                         ((Popup-&gt;Attributes &gt;&gt; 4) &amp; 0x0f));
04337     <a class="code" href="../../d6/d8/dispatch_8h.html#a6">FillOutput</a>(ScreenInfo,
04338                Attributes,
04339                WriteCoord,
04340                <a class="code" href="../../d5/d5/conmsg_8h.html#a11">CONSOLE_ATTRIBUTE</a>,
04341                &amp;lStringLength
04342               );
04343 }
04344 
04345 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04346"></a><a class="code" href="../../d4/d1/cmdline_8h.html#a61">04346</a> <a class="code" href="../../d4/d1/cmdline_8h.html#a61">DrawCommandListPopup</a>(
04347     IN <a class="code" href="../../d1/d0/struct__CLE__POPUP.html">PCLE_POPUP</a> Popup,
04348     IN SHORT CurrentCommand,
04349     IN <a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html">PCOMMAND_HISTORY</a> CommandHistory,
04350     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo
04351     )
04352 {
04353     WORD Attributes;
04354     ULONG lStringLength,CommandNumberLength;
04355     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> CommandNumber[<a class="code" href="../../d4/d1/cmdline_8h.html#a3">COMMAND_NUMBER_SIZE</a>];
04356     PCHAR CommandNumberPtr;
04357     COORD WriteCoord;
04358     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> i;
04359 
04360     <span class="comment">//</span>
04361     <span class="comment">// draw empty popup</span>
04362     <span class="comment">//</span>
04363 
04364     WriteCoord.X = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(Popup-&gt;Region.Left+1);
04365     WriteCoord.Y = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(Popup-&gt;Region.Top+1);
04366     lStringLength = <a class="code" href="../../d4/d1/cmdline_8h.html#a1">POPUP_SIZE_X</a>(Popup);
04367     <span class="keywordflow">for</span> (i=0;i&lt;<a class="code" href="../../d4/d1/cmdline_8h.html#a2">POPUP_SIZE_Y</a>(Popup);i++) {
04368         <a class="code" href="../../d6/d8/dispatch_8h.html#a6">FillOutput</a>(ScreenInfo,
04369                    Popup-&gt;Attributes,
04370                    WriteCoord,
04371                    <a class="code" href="../../d5/d5/conmsg_8h.html#a11">CONSOLE_ATTRIBUTE</a>,
04372                    &amp;lStringLength
04373                   );
04374         <a class="code" href="../../d6/d8/dispatch_8h.html#a6">FillOutput</a>(ScreenInfo,
04375                    (WCHAR)<span class="charliteral">' '</span>,
04376                    WriteCoord,
04377                    <a class="code" href="../../d5/d5/conmsg_8h.html#a12">CONSOLE_FALSE_UNICODE</a>, <span class="comment">// faster than real unicode</span>
04378                    &amp;lStringLength
04379                   );
04380         WriteCoord.Y += 1;
04381     }
04382 
04383     WriteCoord.Y = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(Popup-&gt;Region.Top+1);
04384     <span class="keywordflow">for</span> (i=<a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(Popup-&gt;BottomIndex-<a class="code" href="../../d4/d1/cmdline_8h.html#a2">POPUP_SIZE_Y</a>(Popup)+1),0);i&lt;=Popup-&gt;BottomIndex;i++) {
04385 
04386         <span class="comment">//</span>
04387         <span class="comment">// write command number to screen</span>
04388         <span class="comment">//</span>
04389 
04390         CommandNumberPtr = _itoa(i,CommandNumber,10);
04391         CommandNumberLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)lstrlenA(CommandNumberPtr);
04392         CommandNumber[CommandNumberLength] = <span class="charliteral">':'</span>;
04393         CommandNumber[CommandNumberLength+1] = <span class="charliteral">' '</span>;
04394         CommandNumberLength+=2;
04395         <span class="keywordflow">if</span> (CommandNumberLength &gt; (ULONG)<a class="code" href="../../d4/d1/cmdline_8h.html#a1">POPUP_SIZE_X</a>(Popup))
04396             CommandNumberLength = (ULONG)<a class="code" href="../../d4/d1/cmdline_8h.html#a1">POPUP_SIZE_X</a>(Popup);
04397         WriteCoord.X = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(Popup-&gt;Region.Left+1);
04398         <a class="code" href="../../d6/d8/dispatch_8h.html#a2">WriteOutputString</a>(ScreenInfo,
04399                           CommandNumberPtr,
04400                           WriteCoord,
04401                           <a class="code" href="../../d5/d5/conmsg_8h.html#a9">CONSOLE_ASCII</a>,
04402                           &amp;CommandNumberLength,
04403                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
04404                          );
04405 
04406         <span class="comment">//</span>
04407         <span class="comment">// write command to screen</span>
04408         <span class="comment">//</span>
04409 
04410         lStringLength = CommandHistory-&gt;Commands[<a class="code" href="../../d4/d1/cmdline_8h.html#a8">COMMAND_NUM_TO_INDEX</a>(i,CommandHistory)]-&gt;CommandLength/<span class="keyword">sizeof</span>(WCHAR);
04411 <span class="preprocessor">#if defined(FE_SB)</span>
04412 <span class="preprocessor"></span>        {
04413             <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> lTmpStringLength;
04414             LONG lPopupLength;
04415             LPWSTR lpStr;
04416 
04417             lTmpStringLength = lStringLength;
04418             lPopupLength = <a class="code" href="../../d4/d1/cmdline_8h.html#a1">POPUP_SIZE_X</a>(Popup) - CommandNumberLength;
04419             lpStr = CommandHistory-&gt;Commands[<a class="code" href="../../d4/d1/cmdline_8h.html#a8">COMMAND_NUM_TO_INDEX</a>(i,CommandHistory)]-&gt;Command;
04420             <span class="keywordflow">while</span> (lTmpStringLength--) {
04421                 <span class="keywordflow">if</span> (IsConsoleFullWidth(ScreenInfo-&gt;Console-&gt;hDC,
04422                                        ScreenInfo-&gt;Console-&gt;OutputCP,*lpStr++)) {
04423                     lPopupLength -= 2;
04424                 }
04425                 <span class="keywordflow">else</span> {
04426                     lPopupLength--;
04427                 }
04428                 <span class="keywordflow">if</span> (lPopupLength &lt;= 0) {
04429                     lStringLength -= lTmpStringLength;
04430                     <span class="keywordflow">if</span> (lPopupLength &lt; 0)
04431                         lStringLength--;
04432                     <span class="keywordflow">break</span>;
04433                 }
04434             }
04435         }
04436 <span class="preprocessor">#else</span>
04437 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ((lStringLength+CommandNumberLength) &gt; (ULONG)<a class="code" href="../../d4/d1/cmdline_8h.html#a1">POPUP_SIZE_X</a>(Popup))
04438             lStringLength = (ULONG)(<a class="code" href="../../d4/d1/cmdline_8h.html#a1">POPUP_SIZE_X</a>(Popup)-CommandNumberLength);
04439 <span class="preprocessor">#endif</span>
04440 <span class="preprocessor"></span>        WriteCoord.X = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(WriteCoord.X + CommandNumberLength);
04441 <span class="preprocessor">#if defined(FE_SB)</span>
04442 <span class="preprocessor"></span>        {
04443             PWCHAR TransBuffer;
04444 
04445             TransBuffer = <a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( TMP_DBCS_TAG ),lStringLength * <span class="keyword">sizeof</span>(WCHAR));
04446             <span class="keywordflow">if</span> (TransBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04447                 <span class="keywordflow">return</span>;
04448             }
04449 
04450             RtlCopyMemory(TransBuffer,CommandHistory-&gt;Commands[<a class="code" href="../../d4/d1/cmdline_8h.html#a8">COMMAND_NUM_TO_INDEX</a>(i,CommandHistory)]-&gt;Command,lStringLength * <span class="keyword">sizeof</span>(WCHAR));
04451             <a class="code" href="../../d6/d8/dispatch_8h.html#a2">WriteOutputString</a>(ScreenInfo,
04452                               TransBuffer,
04453                               WriteCoord,
04454                               <a class="code" href="../../d5/d5/conmsg_8h.html#a10">CONSOLE_REAL_UNICODE</a>,
04455                               &amp;lStringLength,
04456                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
04457                              );
04458             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(TransBuffer);
04459         }
04460 <span class="preprocessor">#else</span>
04461 <span class="preprocessor"></span>        <a class="code" href="../../d6/d8/dispatch_8h.html#a2">WriteOutputString</a>(ScreenInfo,
04462                           CommandHistory-&gt;Commands[<a class="code" href="../../d4/d1/cmdline_8h.html#a8">COMMAND_NUM_TO_INDEX</a>(i,CommandHistory)]-&gt;Command,
04463                           WriteCoord,
04464                           <a class="code" href="../../d5/d5/conmsg_8h.html#a10">CONSOLE_REAL_UNICODE</a>,
04465                           &amp;lStringLength,
04466                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
04467                          );
04468         <span class="comment">// convert back to true unicode (got converted by WriteOutputString)</span>
04469         <span class="keywordflow">if</span> ((ScreenInfo-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a2">CONSOLE_OEMFONT_DISPLAY</a>) &amp;&amp;
04470                 !(ScreenInfo-&gt;Console-&gt;FullScreenFlags &amp; CONSOLE_FULLSCREEN)) {
04471             <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a43">FalseUnicodeToRealUnicode</a>(CommandHistory-&gt;Commands[<a class="code" href="../../d4/d1/cmdline_8h.html#a8">COMMAND_NUM_TO_INDEX</a>(i,CommandHistory)]-&gt;Command,
04472                     lStringLength,
04473                     ScreenInfo-&gt;Console-&gt;OutputCP);
04474         }
04475 <span class="preprocessor">#endif</span>
04476 <span class="preprocessor"></span>
04477         <span class="comment">//</span>
04478         <span class="comment">// write attributes to screen</span>
04479         <span class="comment">//</span>
04480 
04481         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/cmdline_8h.html#a8">COMMAND_NUM_TO_INDEX</a>(i,CommandHistory) == CurrentCommand) {
04482             WriteCoord.X = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(Popup-&gt;Region.Left+1);
04483             <span class="comment">// inverted attributes</span>
04484             Attributes = (WORD)(((Popup-&gt;Attributes &lt;&lt; 4) &amp; 0xf0) |
04485                                 ((Popup-&gt;Attributes &gt;&gt; 4) &amp; 0x0f));
04486             lStringLength = <a class="code" href="../../d4/d1/cmdline_8h.html#a1">POPUP_SIZE_X</a>(Popup);
04487             <a class="code" href="../../d6/d8/dispatch_8h.html#a6">FillOutput</a>(ScreenInfo,
04488                        Attributes,
04489                        WriteCoord,
04490                        <a class="code" href="../../d5/d5/conmsg_8h.html#a11">CONSOLE_ATTRIBUTE</a>,
04491                        &amp;lStringLength
04492                       );
04493         }
04494 
04495         WriteCoord.Y += 1;
04496     }
04497 }
04498 
04499 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04500"></a><a class="code" href="../../d4/d1/cmdline_8h.html#a62">04500</a> <a class="code" href="../../d4/d1/cmdline_8h.html#a62">UpdateCommandListPopup</a>(
04501     IN SHORT Delta,
04502     IN OUT PSHORT CurrentCommand,   <span class="comment">// real index, not command #</span>
04503     IN <a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html">PCOMMAND_HISTORY</a> CommandHistory,
04504     IN <a class="code" href="../../d1/d0/struct__CLE__POPUP.html">PCLE_POPUP</a> Popup,
04505     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
04506     IN DWORD Flags
04507     )
04508 {
04509     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
04510     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> CurCmdNum;
04511     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> NewCmdNum;
04512     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> Scroll=<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04513 
04514     <span class="keywordflow">if</span> (Delta == 0) {
04515         <span class="keywordflow">return</span>;
04516     }
04517     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = <a class="code" href="../../d4/d1/cmdline_8h.html#a2">POPUP_SIZE_Y</a>(Popup);
04518 
04519     <span class="keywordflow">if</span> (Flags &amp; <a class="code" href="../../d4/d1/cmdline_8h.html#a22">UCLP_WRAP</a>) {
04520         CurCmdNum = *CurrentCommand;
04521         NewCmdNum = CurCmdNum + Delta;
04522         NewCmdNum = <a class="code" href="../../d4/d1/cmdline_8h.html#a9">COMMAND_INDEX_TO_NUM</a>(NewCmdNum, CommandHistory);
04523         CurCmdNum = <a class="code" href="../../d4/d1/cmdline_8h.html#a9">COMMAND_INDEX_TO_NUM</a>(CurCmdNum, CommandHistory);
04524     } <span class="keywordflow">else</span> {
04525         CurCmdNum = <a class="code" href="../../d4/d1/cmdline_8h.html#a9">COMMAND_INDEX_TO_NUM</a>(*CurrentCommand, CommandHistory);
04526         NewCmdNum = CurCmdNum + Delta;
04527         <span class="keywordflow">if</span> (NewCmdNum &gt;= CommandHistory-&gt;NumberOfCommands) {
04528             NewCmdNum = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(CommandHistory-&gt;NumberOfCommands-1);
04529         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NewCmdNum &lt; 0) {
04530             NewCmdNum = 0;
04531         }
04532     }
04533     Delta = NewCmdNum - CurCmdNum;
04534 
04535     <span class="comment">// determine amount to scroll, if any</span>
04536 
04537     <span class="keywordflow">if</span> (NewCmdNum &lt;= Popup-&gt;BottomIndex-<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>) {
04538         Popup-&gt;BottomIndex += Delta;
04539         <span class="keywordflow">if</span> (Popup-&gt;BottomIndex &lt; (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>-1)) {
04540             Popup-&gt;BottomIndex = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>-1);
04541         }
04542         Scroll = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04543     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NewCmdNum &gt; Popup-&gt;BottomIndex) {
04544         Popup-&gt;BottomIndex += Delta;
04545         <span class="keywordflow">if</span> (Popup-&gt;BottomIndex &gt;= CommandHistory-&gt;NumberOfCommands) {
04546             Popup-&gt;BottomIndex = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(CommandHistory-&gt;NumberOfCommands-1);
04547         }
04548         Scroll = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04549     }
04550 
04551 
04552     <span class="comment">//</span>
04553     <span class="comment">// write commands to popup</span>
04554     <span class="comment">//</span>
04555     <span class="keywordflow">if</span> (Scroll) {
04556         <a class="code" href="../../d4/d1/cmdline_8h.html#a61">DrawCommandListPopup</a>(Popup,<a class="code" href="../../d4/d1/cmdline_8h.html#a8">COMMAND_NUM_TO_INDEX</a>(NewCmdNum,CommandHistory),CommandHistory,ScreenInfo);
04557     } <span class="keywordflow">else</span> {
04558         <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a71">UpdateHighlight</a>(Popup,<a class="code" href="../../d4/d1/cmdline_8h.html#a9">COMMAND_INDEX_TO_NUM</a>((*CurrentCommand),CommandHistory),NewCmdNum,ScreenInfo);
04559     }
04560     *CurrentCommand = <a class="code" href="../../d4/d1/cmdline_8h.html#a8">COMMAND_NUM_TO_INDEX</a>(NewCmdNum,CommandHistory);
04561 }
04562 
04563 <a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html">PCOMMAND_HISTORY</a>
<a name="l04564"></a><a class="code" href="../../d4/d1/cmdline_8h.html#a46">04564</a> <a class="code" href="../../d4/d1/cmdline_8h.html#a46">FindCommandHistory</a>(
04565     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
04566     IN HANDLE ProcessHandle
04567     )
04568 
04569 <span class="comment">/*++</span>
04570 <span class="comment"></span>
04571 <span class="comment">Routine Description:</span>
04572 <span class="comment"></span>
04573 <span class="comment">    This routine marks the command history buffer freed.</span>
04574 <span class="comment"></span>
04575 <span class="comment">Arguments:</span>
04576 <span class="comment"></span>
04577 <span class="comment">    Console - pointer to console.</span>
04578 <span class="comment"></span>
04579 <span class="comment">    ProcessHandle - handle to client process.</span>
04580 <span class="comment"></span>
04581 <span class="comment">Return Value:</span>
04582 <span class="comment"></span>
04583 <span class="comment">    none.</span>
04584 <span class="comment"></span>
04585 <span class="comment">--*/</span>
04586 
04587 {
04588     <a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html">PCOMMAND_HISTORY</a> <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>;
04589     PLIST_ENTRY ListHead, ListNext;
04590 
04591     ListHead = &amp;Console-&gt;CommandHistoryList;
04592     ListNext = ListHead-&gt;Flink;
04593     <span class="keywordflow">while</span> (ListNext != ListHead) {
04594         <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a> = CONTAINING_RECORD( ListNext, <a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html">COMMAND_HISTORY</a>, ListLink );
04595         ListNext = ListNext-&gt;Flink;
04596         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>-&gt;ProcessHandle == ProcessHandle) {
04597             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>-&gt;Flags &amp; <a class="code" href="../../d4/d1/cmdline_8h.html#a4">CLE_ALLOCATED</a>);
04598             <span class="keywordflow">return</span> <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>;
04599         }
04600     }
04601     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04602 }
04603 
04604 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04605"></a><a class="code" href="../../d8/d5/consrv_8h.html#a259">04605</a> <a class="code" href="../../d8/d5/consrv_8h.html#a259">FreeCommandHistory</a>(
04606     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
04607     IN HANDLE ProcessHandle
04608     )
04609 
04610 <span class="comment">/*++</span>
04611 <span class="comment"></span>
04612 <span class="comment">Routine Description:</span>
04613 <span class="comment"></span>
04614 <span class="comment">    This routine marks the command history buffer freed.</span>
04615 <span class="comment"></span>
04616 <span class="comment">Arguments:</span>
04617 <span class="comment"></span>
04618 <span class="comment">    Console - pointer to console.</span>
04619 <span class="comment"></span>
04620 <span class="comment">    ProcessHandle - handle to client process.</span>
04621 <span class="comment"></span>
04622 <span class="comment">Return Value:</span>
04623 <span class="comment"></span>
04624 <span class="comment">    none.</span>
04625 <span class="comment"></span>
04626 <span class="comment">--*/</span>
04627 
04628 {
04629     <a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html">PCOMMAND_HISTORY</a> <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>;
04630 
04631     <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a> = <a class="code" href="../../d4/d1/cmdline_8h.html#a46">FindCommandHistory</a>(Console,ProcessHandle);
04632     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>) {
04633         <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>-&gt;Flags &amp;= ~<a class="code" href="../../d4/d1/cmdline_8h.html#a4">CLE_ALLOCATED</a>;
04634         <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>-&gt;ProcessHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04635     }
04636 }
04637 
04638 
04639 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04640"></a><a class="code" href="../../d8/d5/consrv_8h.html#a260">04640</a> <a class="code" href="../../d8/d5/consrv_8h.html#a260">FreeCommandHistoryBuffers</a>(
04641     IN OUT <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console
04642     )
04643 {
04644     <a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html">PCOMMAND_HISTORY</a> <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>;
04645     PLIST_ENTRY ListHead, ListNext;
04646     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> i;
04647 
04648     ListHead = &amp;Console-&gt;CommandHistoryList;
04649     ListNext = ListHead-&gt;Flink;
04650     <span class="keywordflow">while</span> (ListNext != ListHead) {
04651         <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a> = CONTAINING_RECORD( ListNext, <a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html">COMMAND_HISTORY</a>, ListLink );
04652         ListNext = ListNext-&gt;Flink;
04653         RemoveEntryList(&amp;<a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>-&gt;ListLink);
04654         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>-&gt;AppName) {
04655             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(<a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>-&gt;AppName);
04656         }
04657         <span class="keywordflow">for</span> (i=0;i&lt;<a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>-&gt;NumberOfCommands;i++) {
04658             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(<a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>-&gt;Commands[i]);
04659         }
04660         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(<a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>);
04661     }
04662 }
04663 
04664 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04665"></a><a class="code" href="../../d8/d5/consrv_8h.html#a261">04665</a> <a class="code" href="../../d8/d5/consrv_8h.html#a261">ResizeCommandHistoryBuffers</a>(
04666     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
04667     IN UINT NumCommands
04668     )
04669 {
04670     <a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html">PCOMMAND_HISTORY</a> <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>;
04671     PLIST_ENTRY ListHead, ListNext;
04672 <span class="preprocessor">#if defined(FE_SB)</span>
04673 <span class="preprocessor"></span>    <a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html">PCOOKED_READ_DATA</a> CookedReadData;
04674     <a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html">PCOMMAND_HISTORY</a> NewHistory;
04675 <span class="preprocessor">#endif</span>
04676 <span class="preprocessor"></span>
04677     Console-&gt;CommandHistorySize = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)NumCommands;
04678 
04679     ListHead = &amp;Console-&gt;CommandHistoryList;
04680     ListNext = ListHead-&gt;Flink;
04681     <span class="keywordflow">while</span> (ListNext != ListHead) {
04682         <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a> = CONTAINING_RECORD( ListNext, <a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html">COMMAND_HISTORY</a>, ListLink );
04683         ListNext = ListNext-&gt;Flink;
04684 
04685 <span class="preprocessor">#if defined(FE_SB)</span>
04686 <span class="preprocessor"></span>        NewHistory = <a class="code" href="../../d4/d1/cmdline_8h.html#a44">ReallocCommandHistory</a>(Console, <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>, NumCommands);
04687         CookedReadData = Console-&gt;lpCookedReadData;
04688         <span class="keywordflow">if</span> (CookedReadData &amp;&amp; CookedReadData-&gt;<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o13">CommandHistory</a> == <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>) {
04689             CookedReadData-&gt;<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o13">CommandHistory</a> = NewHistory;
04690         }
04691 <span class="preprocessor">#else</span>
04692 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (!(<a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>-&gt;Flags &amp; <a class="code" href="../../d4/d1/cmdline_8h.html#a4">CLE_ALLOCATED</a>)) {
04693             <a class="code" href="../../d4/d1/cmdline_8h.html#a44">ReallocCommandHistory</a>(Console, <a class="code" href="../../d1/d9/icmui_8def.html#a3">History</a>, NumCommands);
04694          }
04695 <span class="preprocessor">#endif</span>
04696 <span class="preprocessor"></span>    }
04697 }
04698 
04699 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04700"></a><a class="code" href="../../d8/d5/consrv_8h.html#a239">04700</a> <a class="code" href="../../d8/d5/consrv_8h.html#a239">InitializeConsoleCommandData</a>(
04701     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console
04702     )
04703 
04704 <span class="comment">/*++</span>
04705 <span class="comment"></span>
04706 <span class="comment">Routine Description:</span>
04707 <span class="comment"></span>
04708 <span class="comment">    This routine initializes the per-console commandline recall data structures.</span>
04709 <span class="comment"></span>
04710 <span class="comment">Arguments:</span>
04711 <span class="comment"></span>
04712 <span class="comment">    Console - pointer to console.</span>
04713 <span class="comment"></span>
04714 <span class="comment">Return Value:</span>
04715 <span class="comment"></span>
04716 <span class="comment">    none</span>
04717 <span class="comment"></span>
04718 <span class="comment">--*/</span>
04719 
04720 {
04721     Console-&gt;NumCommandHistories = 0;
04722     InitializeListHead(&amp;Console-&gt;CommandHistoryList);
04723 }
04724 
04725 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04726"></a><a class="code" href="../../d8/d5/consrv_8h.html#a255">04726</a> <a class="code" href="../../d8/d5/consrv_8h.html#a255">ResetCommandHistory</a>(
04727     IN <a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html">PCOMMAND_HISTORY</a> CommandHistory
04728     )
04729 
04730 <span class="comment">/*++</span>
04731 <span class="comment">    This routine is called when escape is entered or a command is added.</span>
04732 <span class="comment"></span>
04733 <span class="comment">--*/</span>
04734 
04735 {
04736     <span class="keywordflow">if</span> (CommandHistory == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04737         <span class="keywordflow">return</span>;
04738     }
04739     CommandHistory-&gt;LastDisplayed = CommandHistory-&gt;LastAdded;
04740     CommandHistory-&gt;Flags |= <a class="code" href="../../d4/d1/cmdline_8h.html#a5">CLE_RESET</a>;
04741 }
04742 
04743 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l04744"></a><a class="code" href="../../d8/d5/consrv_8h.html#a252">04744</a> <a class="code" href="../../d8/d5/consrv_8h.html#a252">AddCommand</a>(
04745     IN <a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html">PCOMMAND_HISTORY</a> CommandHistory,
04746     IN PWCHAR Command,
04747     IN USHORT Length,
04748     IN BOOL HistoryNoDup
04749     )
04750 {
04751     <a class="code" href="../../d8/d7/struct__COMMAND.html">PCOMMAND</a> *ppCmd;
04752     <span class="comment">//PWCHAR LastChar;</span>
04753 
04754     <span class="comment">// only add if doesn't match current command</span>
04755 
04756     <span class="keywordflow">if</span> (CommandHistory == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || CommandHistory-&gt;MaximumNumberOfCommands == 0) {
04757         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
04758     }
04759     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(CommandHistory-&gt;Flags &amp; <a class="code" href="../../d4/d1/cmdline_8h.html#a4">CLE_ALLOCATED</a>);
04760 
04761     <span class="comment">//</span>
04762     <span class="comment">// don't remove trailing blanks - prompt "asdf  " won't work.</span>
04763     <span class="comment">//</span>
04764     <span class="comment">//LastChar=Command+(Length/sizeof(WCHAR))-1;</span>
04765     <span class="comment">//while (Length &amp;&amp; *LastChar--==(WCHAR)' ') Length-=2;</span>
04766 
04767     <span class="keywordflow">if</span> (Length == 0) {
04768         <span class="keywordflow">return</span> STATUS_SUCCESS;
04769     }
04770 
04771     <span class="keywordflow">if</span> (CommandHistory-&gt;NumberOfCommands == 0 ||
04772         CommandHistory-&gt;Commands[CommandHistory-&gt;LastAdded]-&gt;CommandLength != Length ||
04773         memcmp(CommandHistory-&gt;Commands[CommandHistory-&gt;LastAdded]-&gt;Command,Command,Length)) {
04774 
04775         <a class="code" href="../../d8/d7/struct__COMMAND.html">PCOMMAND</a> pCmdReuse = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04776 
04777         <span class="keywordflow">if</span> (HistoryNoDup) {
04778             <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> i;
04779             i = <a class="code" href="../../d4/d1/cmdline_8h.html#a56">FindMatchingCommand</a>(CommandHistory, Command, Length,
04780                     CommandHistory-&gt;LastDisplayed, <a class="code" href="../../d4/d1/cmdline_8h.html#a15">FMCFL_EXACT_MATCH</a>);
04781             <span class="keywordflow">if</span> (i != -1) {
04782                 pCmdReuse = <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a68">RemoveCommand</a>(CommandHistory, i);
04783             }
04784         }
04785 
04786 
04787         <span class="comment">//</span>
04788         <span class="comment">// find free record.  if all records are used, free the lru one.</span>
04789         <span class="comment">//</span>
04790 
04791         <span class="keywordflow">if</span> (CommandHistory-&gt;NumberOfCommands &lt; CommandHistory-&gt;MaximumNumberOfCommands) {
04792             CommandHistory-&gt;LastAdded += 1;
04793             CommandHistory-&gt;NumberOfCommands++;
04794         }
04795         <span class="keywordflow">else</span> {
04796             <a class="code" href="../../d4/d1/cmdline_8h.html#a13">COMMAND_IND_INC</a>(CommandHistory-&gt;LastAdded, CommandHistory);
04797             <a class="code" href="../../d4/d1/cmdline_8h.html#a13">COMMAND_IND_INC</a>(CommandHistory-&gt;FirstCommand, CommandHistory);
04798             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(CommandHistory-&gt;Commands[CommandHistory-&gt;LastAdded]);
04799             <span class="keywordflow">if</span> (CommandHistory-&gt;LastDisplayed == CommandHistory-&gt;LastAdded) {
04800                 CommandHistory-&gt;LastDisplayed = -1;
04801             }
04802         }
04803 
04804         <span class="keywordflow">if</span> (CommandHistory-&gt;LastDisplayed == -1 ||
04805             CommandHistory-&gt;Commands[CommandHistory-&gt;LastDisplayed]-&gt;CommandLength != Length ||
04806                 memcmp(CommandHistory-&gt;Commands[CommandHistory-&gt;LastDisplayed]-&gt;Command,Command,Length)) {
04807             <a class="code" href="../../d8/d5/consrv_8h.html#a255">ResetCommandHistory</a>(CommandHistory);
04808         }
04809 
04810         <span class="comment">//</span>
04811         <span class="comment">// add command to array</span>
04812         <span class="comment">//</span>
04813 
04814         ppCmd = &amp;CommandHistory-&gt;Commands[CommandHistory-&gt;LastAdded];
04815         <span class="keywordflow">if</span> (pCmdReuse) {
04816             *ppCmd = pCmdReuse;
04817         } <span class="keywordflow">else</span> {
04818             *ppCmd = (<a class="code" href="../../d8/d7/struct__COMMAND.html">PCOMMAND</a>)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>( <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>(<a class="code" href="../../d8/d5/consrv_8h.html#a12">HISTORY_TAG</a>),
04819                     Length - <span class="keyword">sizeof</span>(WCHAR) + <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d7/struct__COMMAND.html">COMMAND</a>));
04820             <span class="keywordflow">if</span> (*ppCmd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04821                 <a class="code" href="../../d4/d1/cmdline_8h.html#a10">COMMAND_IND_PREV</a>(CommandHistory-&gt;LastAdded, CommandHistory);
04822                 CommandHistory-&gt;NumberOfCommands -= 1;
04823                 <span class="keywordflow">return</span> STATUS_NO_MEMORY;
04824             }
04825             (*ppCmd)-&gt;CommandLength = Length;
04826             RtlCopyMemory((*ppCmd)-&gt;Command,Command,Length);
04827         }
04828     }
04829     CommandHistory-&gt;Flags |= <a class="code" href="../../d4/d1/cmdline_8h.html#a5">CLE_RESET</a>; <span class="comment">// remember that we've returned a cmd</span>
04830     <span class="keywordflow">return</span> STATUS_SUCCESS;
04831 }
04832 
04833 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l04834"></a><a class="code" href="../../d8/d5/consrv_8h.html#a253">04834</a> <a class="code" href="../../d8/d5/consrv_8h.html#a253">RetrieveCommand</a>(
04835     IN <a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html">PCOMMAND_HISTORY</a> CommandHistory,
04836     IN WORD VirtualKeyCode,
04837     IN PWCHAR Buffer,
04838     IN ULONG BufferSize,
04839     OUT PULONG CommandSize
04840     )
04841 {
04842 
04843     <span class="keywordflow">if</span> (CommandHistory == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04844         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
04845     }
04846     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(CommandHistory-&gt;Flags &amp; <a class="code" href="../../d4/d1/cmdline_8h.html#a4">CLE_ALLOCATED</a>);
04847     <span class="keywordflow">if</span> (CommandHistory-&gt;NumberOfCommands == 0) {
04848         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
04849     }
04850     <span class="keywordflow">if</span> (CommandHistory-&gt;NumberOfCommands == 1) {
04851         CommandHistory-&gt;LastDisplayed = 0;
04852     }
04853     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (VirtualKeyCode == VK_UP) {
04854 
04855         <span class="comment">//</span>
04856         <span class="comment">// if this is the first time for this read that a command has</span>
04857         <span class="comment">// been retrieved, return the current command.  otherwise, return</span>
04858         <span class="comment">// the previous command.</span>
04859         <span class="comment">//</span>
04860 
04861         <span class="keywordflow">if</span> (CommandHistory-&gt;Flags &amp; <a class="code" href="../../d4/d1/cmdline_8h.html#a5">CLE_RESET</a>) {
04862             CommandHistory-&gt;Flags &amp;= ~<a class="code" href="../../d4/d1/cmdline_8h.html#a5">CLE_RESET</a>;
04863         } <span class="keywordflow">else</span> {
04864             <a class="code" href="../../d4/d1/cmdline_8h.html#a10">COMMAND_IND_PREV</a>(CommandHistory-&gt;LastDisplayed, CommandHistory);
04865         }
04866     }
04867     <span class="keywordflow">else</span> {
04868         <a class="code" href="../../d4/d1/cmdline_8h.html#a11">COMMAND_IND_NEXT</a>(CommandHistory-&gt;LastDisplayed, CommandHistory);
04869     }
04870     <span class="keywordflow">return</span> <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a50">RetrieveNthCommand</a>(CommandHistory,
04871                               CommandHistory-&gt;LastDisplayed,
04872                               <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
04873                               <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>,
04874                               CommandSize
04875                              );
04876 }
04877 
04878 ULONG
<a name="l04879"></a><a class="code" href="../../d8/d5/consrv_8h.html#a256">04879</a> <a class="code" href="../../d8/d5/consrv_8h.html#a256">SrvGetConsoleTitle</a>(
04880     IN OUT PCSR_API_MSG m,
04881     IN OUT PCSR_REPLY_STATUS ReplyStatus
04882     )
04883 {
04884     <a class="code" href="../../d9/d2/struct__CONSOLE__GETTITLE__MSG.html">PCONSOLE_GETTITLE_MSG</a> a = (<a class="code" href="../../d9/d2/struct__CONSOLE__GETTITLE__MSG.html">PCONSOLE_GETTITLE_MSG</a>)&amp;m-&gt;u.ApiMessageData;
04885     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04886     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
04887 
04888     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a33">ApiPreamble</a>(a-&gt;<a class="code" href="../../d9/d2/struct__CONSOLE__GETTITLE__MSG.html#o0">ConsoleHandle</a>,
04889                          &amp;Console
04890                         );
04891     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
04892         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04893     }
04894 
04895     <span class="keywordflow">if</span> (!CsrValidateMessageBuffer(m, &amp;a-&gt;<a class="code" href="../../d9/d2/struct__CONSOLE__GETTITLE__MSG.html#o2">Title</a>, a-&gt;<a class="code" href="../../d9/d2/struct__CONSOLE__GETTITLE__MSG.html#o1">TitleLength</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>))) {
04896         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
04897         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
04898     }
04899 
04900     <span class="comment">// a-&gt;TitleLength contains length in bytes</span>
04901     <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d9/d2/struct__CONSOLE__GETTITLE__MSG.html#o3">Unicode</a>) {
04902         <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)a-&gt;<a class="code" href="../../d9/d2/struct__CONSOLE__GETTITLE__MSG.html#o1">TitleLength</a> &gt; Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o26">TitleLength</a>) {
04903             a-&gt;<a class="code" href="../../d9/d2/struct__CONSOLE__GETTITLE__MSG.html#o1">TitleLength</a> = Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o26">TitleLength</a>;
04904         }
04905         RtlCopyMemory(a-&gt;<a class="code" href="../../d9/d2/struct__CONSOLE__GETTITLE__MSG.html#o2">Title</a>,Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o28">Title</a>,a-&gt;<a class="code" href="../../d9/d2/struct__CONSOLE__GETTITLE__MSG.html#o1">TitleLength</a>);
04906     } <span class="keywordflow">else</span> {
04907 <span class="preprocessor">#if defined(FE_SB)</span>
04908 <span class="preprocessor"></span>        a-&gt;<a class="code" href="../../d9/d2/struct__CONSOLE__GETTITLE__MSG.html#o1">TitleLength</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a35">ConvertToOem</a>(<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a2">OEMCP</a>,
04909                                         Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o28">Title</a>,
04910                                         Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o26">TitleLength</a> / <span class="keyword">sizeof</span>(WCHAR),
04911                                         a-&gt;<a class="code" href="../../d9/d2/struct__CONSOLE__GETTITLE__MSG.html#o2">Title</a>,
04912                                         a-&gt;<a class="code" href="../../d9/d2/struct__CONSOLE__GETTITLE__MSG.html#o1">TitleLength</a>
04913                                         );
04914 <span class="preprocessor">#else</span>
04915 <span class="preprocessor"></span>        a-&gt;<a class="code" href="../../d9/d2/struct__CONSOLE__GETTITLE__MSG.html#o1">TitleLength</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a35">ConvertToOem</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o61">CP</a>,
04916                                         Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o28">Title</a>,
04917                                         Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o26">TitleLength</a> / <span class="keyword">sizeof</span>(WCHAR),
04918                                         a-&gt;<a class="code" href="../../d9/d2/struct__CONSOLE__GETTITLE__MSG.html#o2">Title</a>,
04919                                         a-&gt;<a class="code" href="../../d9/d2/struct__CONSOLE__GETTITLE__MSG.html#o1">TitleLength</a>
04920                                         );
04921 <span class="preprocessor">#endif</span>
04922 <span class="preprocessor"></span>    }
04923     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
04924     <span class="keywordflow">return</span> STATUS_SUCCESS;
04925     UNREFERENCED_PARAMETER(ReplyStatus);    <span class="comment">// get rid of unreferenced parameter warning message</span>
04926 }
04927 
04928 ULONG
<a name="l04929"></a><a class="code" href="../../d8/d5/consrv_8h.html#a257">04929</a> <a class="code" href="../../d8/d5/consrv_8h.html#a257">SrvSetConsoleTitle</a>(
04930     IN OUT PCSR_API_MSG m,
04931     IN OUT PCSR_REPLY_STATUS ReplyStatus
04932     )
04933 {
04934     <a class="code" href="../../d6/d6/struct__CONSOLE__SETTITLE__MSG.html">PCONSOLE_SETTITLE_MSG</a> a = (<a class="code" href="../../d6/d6/struct__CONSOLE__SETTITLE__MSG.html">PCONSOLE_SETTITLE_MSG</a>)&amp;m-&gt;u.ApiMessageData;
04935     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04936     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
04937     LPWSTR NewTitle;
04938 
04939     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a33">ApiPreamble</a>(a-&gt;<a class="code" href="../../d6/d6/struct__CONSOLE__SETTITLE__MSG.html#o0">ConsoleHandle</a>,
04940                          &amp;Console
04941                         );
04942     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
04943         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04944     }
04945 
04946     <span class="keywordflow">if</span> (!CsrValidateMessageBuffer(m, &amp;a-&gt;<a class="code" href="../../d6/d6/struct__CONSOLE__SETTITLE__MSG.html#o2">Title</a>, a-&gt;<a class="code" href="../../d6/d6/struct__CONSOLE__SETTITLE__MSG.html#o1">TitleLength</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>))) {
04947         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
04948         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
04949     }
04950 
04951     <span class="keywordflow">if</span> (!a-&gt;<a class="code" href="../../d6/d6/struct__CONSOLE__SETTITLE__MSG.html#o3">Unicode</a>) {
04952         NewTitle = (LPWSTR)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a13">TITLE_TAG</a> ),a-&gt;<a class="code" href="../../d6/d6/struct__CONSOLE__SETTITLE__MSG.html#o1">TitleLength</a>*<span class="keyword">sizeof</span>(WCHAR)+<span class="keyword">sizeof</span>(WCHAR));
04953         <span class="keywordflow">if</span> (NewTitle == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04954             <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
04955             <span class="keywordflow">return</span> (ULONG)STATUS_NO_MEMORY;
04956         }
04957 
04958         <span class="comment">// convert title to unicode</span>
04959 
04960 <span class="preprocessor">#if defined(FE_SB)</span>
04961 <span class="preprocessor"></span>        Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o26">TitleLength</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a36">ConvertInputToUnicode</a>(<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a2">OEMCP</a>,
04962                                                  a-&gt;<a class="code" href="../../d6/d6/struct__CONSOLE__SETTITLE__MSG.html#o2">Title</a>,
04963                                                  a-&gt;<a class="code" href="../../d6/d6/struct__CONSOLE__SETTITLE__MSG.html#o1">TitleLength</a>,
04964                                                  NewTitle,
04965                                                  a-&gt;<a class="code" href="../../d6/d6/struct__CONSOLE__SETTITLE__MSG.html#o1">TitleLength</a>);
04966 <span class="preprocessor">#else</span>
04967 <span class="preprocessor"></span>        Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o26">TitleLength</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a36">ConvertInputToUnicode</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o61">CP</a>,
04968                                                  a-&gt;<a class="code" href="../../d6/d6/struct__CONSOLE__SETTITLE__MSG.html#o2">Title</a>,
04969                                                  a-&gt;<a class="code" href="../../d6/d6/struct__CONSOLE__SETTITLE__MSG.html#o1">TitleLength</a>,
04970                                                  NewTitle,
04971                                                  a-&gt;<a class="code" href="../../d6/d6/struct__CONSOLE__SETTITLE__MSG.html#o1">TitleLength</a>);
04972 <span class="preprocessor">#endif</span>
04973 <span class="preprocessor"></span>        Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o26">TitleLength</a> *= 2;
04974     } <span class="keywordflow">else</span> {
04975         <span class="comment">// a-&gt;TitleLength contains length in bytes</span>
04976 
04977         NewTitle = (LPWSTR)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a13">TITLE_TAG</a> ),a-&gt;<a class="code" href="../../d6/d6/struct__CONSOLE__SETTITLE__MSG.html#o1">TitleLength</a>+<span class="keyword">sizeof</span>(WCHAR));
04978         <span class="keywordflow">if</span> (NewTitle == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04979             <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
04980             <span class="keywordflow">return</span> (ULONG)STATUS_NO_MEMORY;
04981         }
04982         Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o26">TitleLength</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)a-&gt;<a class="code" href="../../d6/d6/struct__CONSOLE__SETTITLE__MSG.html#o1">TitleLength</a>;
04983         RtlCopyMemory(NewTitle,a-&gt;<a class="code" href="../../d6/d6/struct__CONSOLE__SETTITLE__MSG.html#o2">Title</a>,a-&gt;<a class="code" href="../../d6/d6/struct__CONSOLE__SETTITLE__MSG.html#o1">TitleLength</a>);
04984     }
04985     NewTitle[Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o26">TitleLength</a>/<span class="keyword">sizeof</span>(WCHAR)] = 0;   <span class="comment">// NULL terminate</span>
04986     <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o28">Title</a>);
04987     Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o28">Title</a> = NewTitle;
04988     <a class="code" href="../../d0/d8/ntcftxt_8h.html#a20">PostMessage</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o8">hWnd</a>, <a class="code" href="../../d1/d7/server_8h.html#a72">CM_UPDATE_TITLE</a>, 0, 0);
04989     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
04990     <span class="keywordflow">return</span> STATUS_SUCCESS;
04991     UNREFERENCED_PARAMETER(ReplyStatus);    <span class="comment">// get rid of unreferenced parameter warning message</span>
04992 }
04993 
04994 <span class="keywordtype">int</span>
<a name="l04995"></a><a class="code" href="../../d8/d5/consrv_8h.html#a263">04995</a> <a class="code" href="../../d8/d5/consrv_8h.html#a263">LoadStringExW</a>(
04996     IN HINSTANCE hModule,
04997     IN UINT      wID,
04998     OUT LPWSTR   lpBuffer,
04999     IN <span class="keywordtype">int</span>       cchBufferMax,
05000     IN WORD      wLangId
05001     )
05002 {
05003     HANDLE hResInfo;
05004     HANDLE hStringSeg;
05005     LPTSTR lpsz;
05006     <span class="keywordtype">int</span> cch;
05007 
05008     <span class="comment">/*</span>
05009 <span class="comment">     * Make sure the parms are valid.</span>
05010 <span class="comment">     */</span>
05011     <span class="keywordflow">if</span> (lpBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05012         <span class="keywordflow">return</span> 0;
05013     }
05014 
05015     cch = 0;
05016 
05017     <span class="comment">/*</span>
05018 <span class="comment">     * String Tables are broken up into 16 string segments.  Find the segment</span>
05019 <span class="comment">     * containing the string we are interested in.</span>
05020 <span class="comment">     */</span>
05021     <span class="keywordflow">if</span> (hResInfo = FindResourceEx(hModule,
05022                                   RT_STRING,
05023                                   (LPTSTR)((LONG)(((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)wID &gt;&gt; 4) + 1)),
05024                                   wLangId)) {
05025 
05026         <span class="comment">/*</span>
05027 <span class="comment">         * Load that segment.</span>
05028 <span class="comment">         */</span>
05029         hStringSeg = LoadResource(hModule, hResInfo);
05030 
05031         <span class="comment">/*</span>
05032 <span class="comment">         * Lock the resource.</span>
05033 <span class="comment">         */</span>
05034         <span class="keywordflow">if</span> (lpsz = (LPTSTR)LockResource(hStringSeg)) {
05035 
05036             <span class="comment">/*</span>
05037 <span class="comment">             * Move past the other strings in this segment.</span>
05038 <span class="comment">             * (16 strings in a segment -&gt; &amp; 0x0F)</span>
05039 <span class="comment">             */</span>
05040             wID &amp;= 0x0F;
05041             <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
05042                 cch = *((<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1">UTCHAR</a> *)lpsz++);      <span class="comment">// PASCAL like string count</span>
05043                                                 <span class="comment">// first UTCHAR is count if TCHARs</span>
05044                 <span class="keywordflow">if</span> (wID-- == 0) <span class="keywordflow">break</span>;
05045                 lpsz += cch;                    <span class="comment">// Step to start if next string</span>
05046             }
05047 
05048             <span class="comment">/*</span>
05049 <span class="comment">             * chhBufferMax == 0 means return a pointer to the read-only resource buffer.</span>
05050 <span class="comment">             */</span>
05051             <span class="keywordflow">if</span> (cchBufferMax == 0) {
05052                 *(LPTSTR *)lpBuffer = lpsz;
05053             } <span class="keywordflow">else</span> {
05054 
05055                 <span class="comment">/*</span>
05056 <span class="comment">                 * Account for the NULL</span>
05057 <span class="comment">                 */</span>
05058                 cchBufferMax--;
05059 
05060                 <span class="comment">/*</span>
05061 <span class="comment">                 * Don't copy more than the max allowed.</span>
05062 <span class="comment">                 */</span>
05063                 <span class="keywordflow">if</span> (cch &gt; cchBufferMax)
05064                     cch = cchBufferMax;
05065 
05066                 <span class="comment">/*</span>
05067 <span class="comment">                 * Copy the string into the buffer.</span>
05068 <span class="comment">                 */</span>
05069                 RtlCopyMemory(lpBuffer, lpsz, cch*<span class="keyword">sizeof</span>(WCHAR));
05070             }
05071         }
05072     }
05073 
05074     <span class="comment">/*</span>
05075 <span class="comment">     * Append a NULL.</span>
05076 <span class="comment">     */</span>
05077     <span class="keywordflow">if</span> (cchBufferMax != 0) {
05078         lpBuffer[cch] = 0;
05079     }
05080 
05081     <span class="keywordflow">return</span> cch;
05082 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:27 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
