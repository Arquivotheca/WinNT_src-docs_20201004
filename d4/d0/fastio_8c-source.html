<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: fastio.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>fastio.c</h1><a href="../../d3/d1/fastio_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    FastIo.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    The Fast I/O path is used to avoid calling the file systems directly to</span>
00012 <span class="comment">    do a cached read.  This module is only used if the file object indicates</span>
00013 <span class="comment">    that caching is enabled (i.e., the private cache map is not null).</span>
00014 <span class="comment"></span>
00015 <span class="comment">Author:</span>
00016 <span class="comment"></span>
00017 <span class="comment">    Gary Kimura     [GaryKi]    25-Feb-1991</span>
00018 <span class="comment"></span>
00019 <span class="comment">Revision History:</span>
00020 <span class="comment"></span>
00021 <span class="comment">    Tom Miller      [TomM]      14-Apr-1991 Added Fast Write routines</span>
00022 <span class="comment"></span>
00023 <span class="comment">--*/</span>
00024 
00025 <span class="preprocessor">#include "FsRtlP.h"</span>
00026 
00027 <span class="comment">//</span>
00028 <span class="comment">//  Trace level for the module</span>
00029 <span class="comment">//</span>
00030 
<a name="l00031"></a><a class="code" href="../../d3/d1/fastio_8c.html#a0">00031</a> <span class="preprocessor">#define Dbg                              (0x04000000)</span>
00032 <span class="preprocessor"></span>
00033 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00034 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, FsRtlCopyRead)</span>
00035 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, FsRtlCopyWrite)</span>
00036 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, FsRtlMdlRead)</span>
00037 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, FsRtlMdlReadDev)</span>
00038 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, FsRtlPrepareMdlWrite)</span>
00039 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, FsRtlPrepareMdlWriteDev)</span>
00040 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, FsRtlMdlWriteComplete)</span>
00041 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, FsRtlMdlWriteCompleteDev)</span>
00042 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, FsRtlAcquireFileForModWrite)</span>
00043 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, FsRtlReleaseFileForModWrite)</span>
00044 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, FsRtlAcquireFileForCcFlush)</span>
00045 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, FsRtlReleaseFileForCcFlush)</span>
00046 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, FsRtlAcquireFileExclusive)</span>
00047 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, FsRtlReleaseFile)</span>
00048 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, FsRtlGetFileSize)</span>
00049 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, FsRtlSetFileSize)</span>
00050 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00051 <span class="preprocessor"></span>
00052 
00053 BOOLEAN
<a name="l00054"></a><a class="code" href="../../d1/d8/fsrtl_8h.html#a93">00054</a> <a class="code" href="../../d1/d8/fsrtl_8h.html#a93">FsRtlCopyRead</a> (
00055     IN <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject,
00056     IN PLARGE_INTEGER FileOffset,
00057     IN ULONG Length,
00058     IN BOOLEAN Wait,
00059     IN ULONG LockKey,
00060     OUT PVOID Buffer,
00061     OUT PIO_STATUS_BLOCK IoStatus,
00062     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject
00063     )
00064 
00065 <span class="comment">/*++</span>
00066 <span class="comment"></span>
00067 <span class="comment">Routine Description:</span>
00068 <span class="comment"></span>
00069 <span class="comment">    This routine does a fast cached read bypassing the usual file system</span>
00070 <span class="comment">    entry routine (i.e., without the Irp).  It is used to do a copy read</span>
00071 <span class="comment">    of a cached file object.  For a complete description of the arguments</span>
00072 <span class="comment">    see CcCopyRead.</span>
00073 <span class="comment"></span>
00074 <span class="comment">Arguments:</span>
00075 <span class="comment"></span>
00076 <span class="comment">    FileObject - Pointer to the file object being read.</span>
00077 <span class="comment"></span>
00078 <span class="comment">    FileOffset - Byte offset in file for desired data.</span>
00079 <span class="comment"></span>
00080 <span class="comment">    Length - Length of desired data in bytes.</span>
00081 <span class="comment"></span>
00082 <span class="comment">    Wait - FALSE if caller may not block, TRUE otherwise</span>
00083 <span class="comment"></span>
00084 <span class="comment">    Buffer - Pointer to output buffer to which data should be copied.</span>
00085 <span class="comment"></span>
00086 <span class="comment">    IoStatus - Pointer to standard I/O status block to receive the status</span>
00087 <span class="comment">               for the transfer.</span>
00088 <span class="comment"></span>
00089 <span class="comment">Return Value:</span>
00090 <span class="comment"></span>
00091 <span class="comment">    FALSE - if Wait was supplied as FALSE and the data was not delivered, or</span>
00092 <span class="comment">        if there is an I/O error.</span>
00093 <span class="comment"></span>
00094 <span class="comment">    TRUE - if the data is being delivered</span>
00095 <span class="comment"></span>
00096 <span class="comment">--*/</span>
00097 
00098 {
00099     <a class="code" href="../../d1/d1/struct__FSRTL__COMMON__FCB__HEADER.html">PFSRTL_COMMON_FCB_HEADER</a> <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>;
00100     BOOLEAN <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00101     ULONG PageCount = <a class="code" href="../../d2/d1/mm_8h.html#a9">COMPUTE_PAGES_SPANNED</a>( FileOffset-&gt;QuadPart, Length );
00102     LARGE_INTEGER BeyondLastByte;
00103     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> targetVdo;
00104 
00105     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00106 
00107     <span class="comment">//</span>
00108     <span class="comment">//  Special case a read of zero length</span>
00109     <span class="comment">//</span>
00110 
00111     <span class="keywordflow">if</span> (Length != 0) {
00112 
00113         <span class="comment">//</span>
00114         <span class="comment">//  Check for overflow. Returning false here will re-route this request through the</span>
00115         <span class="comment">//  IRP based path, but this isn't performance critical.</span>
00116         <span class="comment">//</span>
00117 
00118         <span class="keywordflow">if</span> (MAXLONGLONG - FileOffset-&gt;QuadPart &lt; (LONGLONG)Length) {
00119 
00120             IoStatus-&gt;Status = STATUS_INVALID_PARAMETER;
00121             IoStatus-&gt;Information = 0;
00122             
00123             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00124         }
00125         
00126         BeyondLastByte.QuadPart = FileOffset-&gt;QuadPart + (LONGLONG)Length;
00127         <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a> = (<a class="code" href="../../d1/d1/struct__FSRTL__COMMON__FCB__HEADER.html">PFSRTL_COMMON_FCB_HEADER</a>)FileObject-&gt;FsContext;
00128 
00129         <span class="comment">//</span>
00130         <span class="comment">//  Enter the file system</span>
00131         <span class="comment">//</span>
00132 
00133         <a class="code" href="../../d1/d8/fsrtl_8h.html#a48">FsRtlEnterFileSystem</a>();
00134 
00135         <span class="comment">//</span>
00136         <span class="comment">//  Increment performance counters and get the resource</span>
00137         <span class="comment">//</span>
00138 
00139         <span class="keywordflow">if</span> (Wait) {
00140 
00141             <a class="code" href="../../d0/d9/ntosdef_8h.html#a11">HOT_STATISTIC</a>(<a class="code" href="../../d5/d2/cachedat_8c.html#a45">CcFastReadWait</a>) += 1;
00142 
00143             <span class="comment">//</span>
00144             <span class="comment">//  Acquired shared on the common fcb header</span>
00145             <span class="comment">//</span>
00146 
00147             (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00148 
00149         } <span class="keywordflow">else</span> {
00150 
00151             <a class="code" href="../../d0/d9/ntosdef_8h.html#a11">HOT_STATISTIC</a>(<a class="code" href="../../d5/d2/cachedat_8c.html#a44">CcFastReadNoWait</a>) += 1;
00152 
00153             <span class="comment">//</span>
00154             <span class="comment">//  Acquired shared on the common fcb header, and return if we</span>
00155             <span class="comment">//  don't get it</span>
00156             <span class="comment">//</span>
00157 
00158             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> )) {
00159 
00160                 <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
00161 
00162                 <a class="code" href="../../d5/d2/cachedat_8c.html#a46">CcFastReadResourceMiss</a> += 1;
00163 
00164                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00165             }
00166         }
00167 
00168         <span class="comment">//</span>
00169         <span class="comment">//  Now that the File is acquired shared, we can safely test if it</span>
00170         <span class="comment">//  is really cached and if we can do fast i/o and if not, then</span>
00171         <span class="comment">//  release the fcb and return.</span>
00172         <span class="comment">//</span>
00173 
00174         <span class="keywordflow">if</span> ((FileObject-&gt;PrivateCacheMap == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
00175             (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;IsFastIoPossible == <a class="code" href="../../d1/d8/fsrtl_8h.html#a188a86">FastIoIsNotPossible</a>)) {
00176 
00177             <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource );
00178             <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
00179 
00180             <a class="code" href="../../d0/d9/ntosdef_8h.html#a11">HOT_STATISTIC</a>(<a class="code" href="../../d5/d2/cachedat_8c.html#a47">CcFastReadNotPossible</a>) += 1;
00181 
00182             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00183         }
00184 
00185         <span class="comment">//</span>
00186         <span class="comment">//  Check if fast I/O is questionable and if so then go ask the</span>
00187         <span class="comment">//  file system the answer</span>
00188         <span class="comment">//</span>
00189 
00190         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;IsFastIoPossible == <a class="code" href="../../d1/d8/fsrtl_8h.html#a188a88">FastIoIsQuestionable</a>) {
00191 
00192             <a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">PFAST_IO_DISPATCH</a> FastIoDispatch;
00193 
00194             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!KeIsExecutingDpc());
00195 
00196             targetVdo = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( FileObject );
00197             FastIoDispatch = targetVdo-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o10">FastIoDispatch</a>;
00198 
00199 
00200             <span class="comment">//</span>
00201             <span class="comment">//  All file systems that set "Is Questionable" had better support</span>
00202             <span class="comment">// fast I/O</span>
00203             <span class="comment">//</span>
00204 
00205             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FastIoDispatch != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00206             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o1">FastIoCheckIfPossible</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00207 
00208             <span class="comment">//</span>
00209             <span class="comment">//  Call the file system to check for fast I/O.  If the answer is</span>
00210             <span class="comment">//  anything other than GoForIt then we cannot take the fast I/O</span>
00211             <span class="comment">//  path.</span>
00212             <span class="comment">//</span>
00213 
00214             <span class="keywordflow">if</span> (!FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o1">FastIoCheckIfPossible</a>( FileObject,
00215                                                         FileOffset,
00216                                                         Length,
00217                                                         Wait,
00218                                                         LockKey,
00219                                                         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <span class="comment">// read operation</span>
00220                                                         IoStatus,
00221                                                         targetVdo )) {
00222 
00223                 <span class="comment">//</span>
00224                 <span class="comment">//  Fast I/O is not possible so release the Fcb and return.</span>
00225                 <span class="comment">//</span>
00226 
00227                 <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource );
00228                 <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
00229 
00230                 <a class="code" href="../../d0/d9/ntosdef_8h.html#a11">HOT_STATISTIC</a>(<a class="code" href="../../d5/d2/cachedat_8c.html#a47">CcFastReadNotPossible</a>) += 1;
00231 
00232                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00233             }
00234         }
00235 
00236         <span class="comment">//</span>
00237         <span class="comment">//  Check for read past file size.</span>
00238         <span class="comment">//</span>
00239 
00240         <span class="keywordflow">if</span> ( BeyondLastByte.QuadPart &gt; <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize.QuadPart ) {
00241 
00242             <span class="keywordflow">if</span> ( FileOffset-&gt;QuadPart &gt;= <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize.QuadPart ) {
00243                 IoStatus-&gt;Status = STATUS_END_OF_FILE;
00244                 IoStatus-&gt;Information = 0;
00245 
00246                 <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource );
00247                 <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
00248 
00249                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00250             }
00251 
00252             Length = (ULONG)( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize.QuadPart - FileOffset-&gt;QuadPart );
00253         }
00254 
00255         <span class="comment">//</span>
00256         <span class="comment">//  We can do fast i/o so call the cc routine to do the work and then</span>
00257         <span class="comment">//  release the fcb when we've done.  If for whatever reason the</span>
00258         <span class="comment">//  copy read fails, then return FALSE to our caller.</span>
00259         <span class="comment">//</span>
00260         <span class="comment">//  Also mark this as the top level "Irp" so that lower file system</span>
00261         <span class="comment">//  levels will not attempt a pop-up</span>
00262         <span class="comment">//</span>
00263 
00264         <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;TopLevelIrp = <a class="code" href="../../d1/d8/fsrtl_8h.html#a14">FSRTL_FAST_IO_TOP_LEVEL_IRP</a>;
00265 
00266         <span class="keywordflow">try</span> {
00267 
00268             <span class="keywordflow">if</span> (Wait &amp;&amp; ((BeyondLastByte.HighPart | <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize.HighPart) == 0)) {
00269 
00270                 <a class="code" href="../../d4/d2/cache_8h.html#a75">CcFastCopyRead</a>( FileObject,
00271                                 FileOffset-&gt;LowPart,
00272                                 Length,
00273                                 PageCount,
00274                                 <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00275                                 IoStatus );
00276 
00277                 FileObject-&gt;Flags |= <a class="code" href="../../d0/d5/io_8h.html#a169">FO_FILE_FAST_IO_READ</a>;
00278 
00279                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (IoStatus-&gt;Status == STATUS_END_OF_FILE) ||
00280                         ((FileOffset-&gt;LowPart + IoStatus-&gt;Information) &lt;= <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize.LowPart));
00281 
00282             } <span class="keywordflow">else</span> {
00283 
00284                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d2/cache_8h.html#a74">CcCopyRead</a>( FileObject,
00285                                      FileOffset,
00286                                      Length,
00287                                      Wait,
00288                                      <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00289                                      IoStatus );
00290 
00291                 FileObject-&gt;Flags |= <a class="code" href="../../d0/d5/io_8h.html#a169">FO_FILE_FAST_IO_READ</a>;
00292 
00293                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( !<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> || (IoStatus-&gt;Status == STATUS_END_OF_FILE) ||
00294                         ((LONGLONG)(FileOffset-&gt;QuadPart + IoStatus-&gt;Information) &lt;= <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize.QuadPart));
00295             }
00296 
00297             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) {
00298 
00299                 FileObject-&gt;CurrentByteOffset.QuadPart = FileOffset-&gt;QuadPart + IoStatus-&gt;Information;
00300             }
00301 
00302         } except( <a class="code" href="../../d1/d8/fsrtl_8h.html#a137">FsRtlIsNtstatusExpected</a>(GetExceptionCode())
00303                                         ? <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>
00304                                         : <a class="code" href="../../d6/d7/halmips_8h.html#a34">EXCEPTION_CONTINUE_SEARCH</a> ) {
00305 
00306             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00307         }
00308 
00309         <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;TopLevelIrp = 0;
00310 
00311         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource );
00312         <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
00313         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00314 
00315     } <span class="keywordflow">else</span> {
00316 
00317         <span class="comment">//</span>
00318         <span class="comment">//  A zero length transfer was requested.</span>
00319         <span class="comment">//</span>
00320 
00321         IoStatus-&gt;Status = STATUS_SUCCESS;
00322         IoStatus-&gt;Information = 0;
00323 
00324         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00325     }
00326 }
00327 
00328 
00329 BOOLEAN
<a name="l00330"></a><a class="code" href="../../d1/d8/fsrtl_8h.html#a94">00330</a> <a class="code" href="../../d1/d8/fsrtl_8h.html#a94">FsRtlCopyWrite</a> (
00331     IN <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject,
00332     IN PLARGE_INTEGER FileOffset,
00333     IN ULONG Length,
00334     IN BOOLEAN Wait,
00335     IN ULONG LockKey,
00336     IN PVOID Buffer,
00337     OUT PIO_STATUS_BLOCK IoStatus,
00338     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject
00339     )
00340 
00341 <span class="comment">/*++</span>
00342 <span class="comment"></span>
00343 <span class="comment">Routine Description:</span>
00344 <span class="comment"></span>
00345 <span class="comment">    This routine does a fast cached write bypassing the usual file system</span>
00346 <span class="comment">    entry routine (i.e., without the Irp).  It is used to do a copy write</span>
00347 <span class="comment">    of a cached file object.  For a complete description of the arguments</span>
00348 <span class="comment">    see CcCopyWrite.</span>
00349 <span class="comment"></span>
00350 <span class="comment">Arguments:</span>
00351 <span class="comment"></span>
00352 <span class="comment">    FileObject - Pointer to the file object being write.</span>
00353 <span class="comment"></span>
00354 <span class="comment">    FileOffset - Byte offset in file for desired data.</span>
00355 <span class="comment"></span>
00356 <span class="comment">    Length - Length of desired data in bytes.</span>
00357 <span class="comment"></span>
00358 <span class="comment">    Wait - FALSE if caller may not block, TRUE otherwise</span>
00359 <span class="comment"></span>
00360 <span class="comment">    Buffer - Pointer to output buffer to which data should be copied.</span>
00361 <span class="comment"></span>
00362 <span class="comment">    IoStatus - Pointer to standard I/O status block to receive the status</span>
00363 <span class="comment">               for the transfer.</span>
00364 <span class="comment"></span>
00365 <span class="comment">Return Value:</span>
00366 <span class="comment"></span>
00367 <span class="comment">    FALSE - if Wait was supplied as FALSE and the data was not delivered, or</span>
00368 <span class="comment">        if there is an I/O error.</span>
00369 <span class="comment"></span>
00370 <span class="comment">    TRUE - if the data is being delivered</span>
00371 <span class="comment"></span>
00372 <span class="comment">--*/</span>
00373 
00374 {
00375     <a class="code" href="../../d1/d1/struct__FSRTL__COMMON__FCB__HEADER.html">PFSRTL_COMMON_FCB_HEADER</a> <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>;
00376     BOOLEAN AcquiredShared = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00377     BOOLEAN <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00378     BOOLEAN FileSizeChanged = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00379     BOOLEAN WriteToEndOfFile = (BOOLEAN)((FileOffset-&gt;LowPart == FILE_WRITE_TO_END_OF_FILE) &amp;&amp;
00380                                          (FileOffset-&gt;HighPart == -1));
00381 
00382     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00383 
00384     <span class="comment">//</span>
00385     <span class="comment">//  Get a real pointer to the common fcb header</span>
00386     <span class="comment">//</span>
00387 
00388     <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a> = (<a class="code" href="../../d1/d1/struct__FSRTL__COMMON__FCB__HEADER.html">PFSRTL_COMMON_FCB_HEADER</a>)FileObject-&gt;FsContext;
00389 
00390     <span class="comment">//</span>
00391     <span class="comment">//  Do we need to verify the volume?  If so, we must go to the file</span>
00392     <span class="comment">//  system.  Also return FALSE if FileObject is write through, the</span>
00393     <span class="comment">//  File System must do that.</span>
00394     <span class="comment">//</span>
00395 
00396     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d2/cache_8h.html#a72">CcCanIWrite</a>( FileObject, Length, Wait, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ) &amp;&amp;
00397         !<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>(FileObject-&gt;Flags, <a class="code" href="../../d0/d5/io_8h.html#a154">FO_WRITE_THROUGH</a>) &amp;&amp;
00398         <a class="code" href="../../d4/d2/cache_8h.html#a4">CcCopyWriteWontFlush</a>(FileObject, FileOffset, Length)) {
00399 
00400         <span class="comment">//</span>
00401         <span class="comment">//  Assume our transfer will work</span>
00402         <span class="comment">//</span>
00403 
00404         IoStatus-&gt;Status = STATUS_SUCCESS;
00405         IoStatus-&gt;Information = Length;
00406 
00407         <span class="comment">//</span>
00408         <span class="comment">//  Special case the zero byte length</span>
00409         <span class="comment">//</span>
00410 
00411         <span class="keywordflow">if</span> (Length != 0) {
00412 
00413             <span class="comment">//</span>
00414             <span class="comment">//  Enter the file system</span>
00415             <span class="comment">//</span>
00416 
00417             <a class="code" href="../../d1/d8/fsrtl_8h.html#a48">FsRtlEnterFileSystem</a>();
00418 
00419             <span class="comment">//</span>
00420             <span class="comment">//  Split into separate paths for increased performance.  First</span>
00421             <span class="comment">//  we have the faster path which only supports Wait == TRUE and</span>
00422             <span class="comment">//  32 bits.  We will make an unsafe test on whether the fast path</span>
00423             <span class="comment">//  is ok, then just return FALSE later if we were wrong.  This</span>
00424             <span class="comment">//  should virtually never happen.</span>
00425             <span class="comment">//</span>
00426             <span class="comment">//  IMPORTANT NOTE: It is very important that any changes made to</span>
00427             <span class="comment">//                  this path also be applied to the 64-bit path</span>
00428             <span class="comment">//                  which is the else of this test!</span>
00429             <span class="comment">//</span>
00430 
00431             <span class="keywordflow">if</span> (Wait &amp;&amp; (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;AllocationSize.HighPart == 0)) {
00432 
00433                 ULONG <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>, NewFileSize;
00434                 ULONG OldFileSize;
00435                 ULONG OldValidDataLength;
00436                 BOOLEAN Wrapped;
00437 
00438                 <span class="comment">//</span>
00439                 <span class="comment">//  Make our best guess on whether we need the file exclusive</span>
00440                 <span class="comment">//  or shared.  Note that we do not check FileOffset-&gt;HighPart</span>
00441                 <span class="comment">//  until below.</span>
00442                 <span class="comment">//</span>
00443 
00444                 NewFileSize = FileOffset-&gt;LowPart + Length;
00445 
00446                 <span class="keywordflow">if</span> (WriteToEndOfFile || (NewFileSize &gt; <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength.LowPart)) {
00447 
00448                     <span class="comment">//</span>
00449                     <span class="comment">//  Acquired shared on the common fcb header</span>
00450                     <span class="comment">//</span>
00451 
00452                     <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00453 
00454                 } <span class="keywordflow">else</span> {
00455 
00456                     <span class="comment">//</span>
00457                     <span class="comment">//  Acquired shared on the common fcb header</span>
00458                     <span class="comment">//</span>
00459 
00460                     <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00461 
00462                     AcquiredShared = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00463                 }
00464 
00465                 <span class="comment">//</span>
00466                 <span class="comment">//  We have the fcb shared now check if we can do fast i/o</span>
00467                 <span class="comment">//  and if the file space is allocated, and if not then</span>
00468                 <span class="comment">//  release the fcb and return.</span>
00469                 <span class="comment">//</span>
00470 
00471                 <span class="keywordflow">if</span> (WriteToEndOfFile) {
00472 
00473                     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize.LowPart;
00474                     NewFileSize = <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize.LowPart + Length;
00475                     Wrapped = NewFileSize &lt; <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize.LowPart;
00476 
00477                 } <span class="keywordflow">else</span> {
00478 
00479                     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = FileOffset-&gt;LowPart;
00480                     NewFileSize = FileOffset-&gt;LowPart + Length;
00481                     Wrapped = (NewFileSize &lt; FileOffset-&gt;LowPart) || (FileOffset-&gt;HighPart != 0);
00482                 }
00483 
00484                 <span class="comment">//</span>
00485                 <span class="comment">//  Now that the File is acquired shared, we can safely test</span>
00486                 <span class="comment">//  if it is really cached and if we can do fast i/o and we</span>
00487                 <span class="comment">//  do not have to extend. If not then release the fcb and</span>
00488                 <span class="comment">//  return.</span>
00489                 <span class="comment">//</span>
00490                 <span class="comment">//  Get out if we have too much to zero.  This case is not important</span>
00491                 <span class="comment">//  for performance, and a file system supporting sparseness may have</span>
00492                 <span class="comment">//  a way to do this more efficiently.</span>
00493                 <span class="comment">//</span>
00494 
00495                 <span class="keywordflow">if</span> ((FileObject-&gt;PrivateCacheMap == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
00496                     (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;IsFastIoPossible == <a class="code" href="../../d1/d8/fsrtl_8h.html#a188a86">FastIoIsNotPossible</a>) ||
00497                     (NewFileSize &gt; <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;AllocationSize.LowPart) ||
00498                     (<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> &gt;= (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength.LowPart + 0x2000)) ||
00499                     (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;AllocationSize.HighPart != 0) || Wrapped) {
00500 
00501                     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource );
00502                     <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
00503 
00504                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00505                 }
00506 
00507                 <span class="comment">//</span>
00508                 <span class="comment">//  If we will be extending ValidDataLength, we will have to</span>
00509                 <span class="comment">//  get the Fcb exclusive, and make sure that FastIo is still</span>
00510                 <span class="comment">//  possible.  We should only execute this block of code very</span>
00511                 <span class="comment">//  rarely, when the unsafe test for ValidDataLength failed</span>
00512                 <span class="comment">//  above.</span>
00513                 <span class="comment">//</span>
00514 
00515                 <span class="keywordflow">if</span> (AcquiredShared &amp;&amp; (NewFileSize &gt; <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength.LowPart)) {
00516 
00517                     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource );
00518 
00519                     <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00520 
00521                     <span class="comment">//</span>
00522                     <span class="comment">// If writing to end of file, we must recalculate new size.</span>
00523                     <span class="comment">//</span>
00524 
00525                     <span class="keywordflow">if</span> (WriteToEndOfFile) {
00526 
00527                         <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize.LowPart;
00528                         NewFileSize = <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize.LowPart + Length;
00529                         Wrapped = NewFileSize &lt; <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize.LowPart;
00530                     }
00531 
00532                     <span class="keywordflow">if</span> ((FileObject-&gt;PrivateCacheMap == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
00533                         (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;IsFastIoPossible == <a class="code" href="../../d1/d8/fsrtl_8h.html#a188a86">FastIoIsNotPossible</a>) ||
00534                         (NewFileSize &gt; <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;AllocationSize.LowPart) ||
00535                         (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;AllocationSize.HighPart != 0) || Wrapped) {
00536 
00537                         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource );
00538                         <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
00539 
00540                         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00541                     }
00542                 }
00543 
00544                 <span class="comment">//</span>
00545                 <span class="comment">//  Check if fast I/O is questionable and if so then go ask</span>
00546                 <span class="comment">//  the file system the answer</span>
00547                 <span class="comment">//</span>
00548 
00549                 <span class="keywordflow">if</span> (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;IsFastIoPossible == <a class="code" href="../../d1/d8/fsrtl_8h.html#a188a88">FastIoIsQuestionable</a>) {
00550 
00551                     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> targetVdo = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( FileObject );
00552                     <a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">PFAST_IO_DISPATCH</a> FastIoDispatch = targetVdo-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o10">FastIoDispatch</a>;
00553                     IO_STATUS_BLOCK IoStatus;
00554 
00555                     <span class="comment">//</span>
00556                     <span class="comment">//  All file system then set "Is Questionable" had better</span>
00557                     <span class="comment">//  support fast I/O</span>
00558                     <span class="comment">//</span>
00559 
00560                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FastIoDispatch != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00561                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o1">FastIoCheckIfPossible</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00562 
00563                     <span class="comment">//</span>
00564                     <span class="comment">//  Call the file system to check for fast I/O.  If the</span>
00565                     <span class="comment">//  answer is anything other than GoForIt then we cannot</span>
00566                     <span class="comment">//  take the fast I/O path.</span>
00567                     <span class="comment">//</span>
00568 
00569                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FILE_WRITE_TO_END_OF_FILE == 0xffffffff);
00570 
00571                     <span class="keywordflow">if</span> (!FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o1">FastIoCheckIfPossible</a>( FileObject,
00572                                                                 FileOffset-&gt;QuadPart != (LONGLONG)-1 ?
00573                                                                   FileOffset : &amp;<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize,
00574                                                                 Length,
00575                                                                 <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00576                                                                 LockKey,
00577                                                                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <span class="comment">// write operation</span>
00578                                                                 &amp;IoStatus,
00579                                                                 targetVdo )) {
00580 
00581                         <span class="comment">//</span>
00582                         <span class="comment">//  Fast I/O is not possible so release the Fcb and</span>
00583                         <span class="comment">//  return.</span>
00584                         <span class="comment">//</span>
00585 
00586                         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource );
00587                         <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
00588 
00589                         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00590                     }
00591                 }
00592 
00593                 <span class="comment">//</span>
00594                 <span class="comment">//  Now see if we will change FileSize.  We have to do it now</span>
00595                 <span class="comment">//  so that our reads are not nooped.</span>
00596                 <span class="comment">//</span>
00597 
00598                 <span class="keywordflow">if</span> (NewFileSize &gt; <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize.LowPart) {
00599 
00600                     FileSizeChanged = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00601                     OldFileSize = <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize.LowPart;
00602                     OldValidDataLength = <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength.LowPart;
00603                     <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize.LowPart = NewFileSize;
00604                 }
00605 
00606                 <span class="comment">//</span>
00607                 <span class="comment">//  We can do fast i/o so call the cc routine to do the work</span>
00608                 <span class="comment">//  and then release the fcb when we've done.  If for whatever</span>
00609                 <span class="comment">//  reason the copy write fails, then return FALSE to our</span>
00610                 <span class="comment">//  caller.</span>
00611                 <span class="comment">//</span>
00612                 <span class="comment">//  Also mark this as the top level "Irp" so that lower file</span>
00613                 <span class="comment">//  system levels will not attempt a pop-up</span>
00614                 <span class="comment">//</span>
00615 
00616                 <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;TopLevelIrp = <a class="code" href="../../d1/d8/fsrtl_8h.html#a14">FSRTL_FAST_IO_TOP_LEVEL_IRP</a>;
00617 
00618                 <span class="keywordflow">try</span> {
00619 
00620                     <span class="comment">//</span>
00621                     <span class="comment">//  See if we have to do some zeroing</span>
00622                     <span class="comment">//</span>
00623 
00624                     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> &gt; <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength.LowPart) {
00625 
00626                         LARGE_INTEGER ZeroEnd;
00627 
00628                         ZeroEnd.LowPart = <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
00629                         ZeroEnd.HighPart = 0;
00630 
00631                         <a class="code" href="../../d4/d2/cache_8h.html#a66">CcZeroData</a>( FileObject,
00632                                     &amp;<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength,
00633                                     &amp;ZeroEnd,
00634                                     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00635                     }
00636 
00637                     <a class="code" href="../../d4/d2/cache_8h.html#a77">CcFastCopyWrite</a>( FileObject,
00638                                      <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>,
00639                                      Length,
00640                                      <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> );
00641 
00642                 } except( <a class="code" href="../../d1/d8/fsrtl_8h.html#a137">FsRtlIsNtstatusExpected</a>(GetExceptionCode())
00643                                                 ? <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>
00644                                                 : <a class="code" href="../../d6/d7/halmips_8h.html#a34">EXCEPTION_CONTINUE_SEARCH</a> ) {
00645 
00646                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00647                 }
00648 
00649                 <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;TopLevelIrp = 0;
00650 
00651                 <span class="comment">//</span>
00652                 <span class="comment">//  If we succeeded, see if we have to update FileSize or</span>
00653                 <span class="comment">//  ValidDataLength.</span>
00654                 <span class="comment">//</span>
00655 
00656                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) {
00657 
00658                     <span class="comment">//</span>
00659                     <span class="comment">//  In the case of ValidDataLength, we really have to</span>
00660                     <span class="comment">//  check again since we did not do this when we acquired</span>
00661                     <span class="comment">//  the resource exclusive.</span>
00662                     <span class="comment">//</span>
00663 
00664                     <span class="keywordflow">if</span> (NewFileSize &gt; <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength.LowPart) {
00665 
00666                         <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength.LowPart = NewFileSize;
00667                     }
00668 
00669                     <span class="comment">//</span>
00670                     <span class="comment">//  Set this handle as having modified the file</span>
00671                     <span class="comment">//</span>
00672 
00673                     FileObject-&gt;Flags |= <a class="code" href="../../d0/d5/io_8h.html#a162">FO_FILE_MODIFIED</a>;
00674 
00675                     <span class="keywordflow">if</span> (FileSizeChanged) {
00676 
00677                         <a class="code" href="../../d4/d2/cache_8h.html#a3">CcGetFileSizePointer</a>(FileObject)-&gt;LowPart = NewFileSize;
00678 
00679                         FileObject-&gt;Flags |= <a class="code" href="../../d0/d5/io_8h.html#a163">FO_FILE_SIZE_CHANGED</a>;
00680                     }
00681 
00682                     <span class="comment">//</span>
00683                     <span class="comment">//  Also update the file position pointer</span>
00684                     <span class="comment">//</span>
00685 
00686                     FileObject-&gt;CurrentByteOffset.LowPart = <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> + Length;
00687                     FileObject-&gt;CurrentByteOffset.HighPart = 0;
00688 
00689                 <span class="comment">//</span>
00690                 <span class="comment">//  If we did not succeed, then we must restore the original</span>
00691                 <span class="comment">//  FileSize while holding the PagingIoResource exclusive if</span>
00692                 <span class="comment">//  it exists.</span>
00693                 <span class="comment">//</span>
00694 
00695                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (FileSizeChanged) {
00696 
00697                     <span class="keywordflow">if</span> ( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00698 
00699                         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00700                         <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize.LowPart = OldFileSize;
00701                         <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength.LowPart = OldValidDataLength;
00702                         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource );
00703 
00704                     } <span class="keywordflow">else</span> {
00705 
00706                         <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize.LowPart = OldFileSize;
00707                         <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength.LowPart = OldValidDataLength;
00708                     }
00709                 }
00710 
00711             <span class="comment">//</span>
00712             <span class="comment">//  Here is the 64-bit or no-wait path.</span>
00713             <span class="comment">//</span>
00714 
00715             } <span class="keywordflow">else</span> {
00716 
00717                 LARGE_INTEGER <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>, NewFileSize;
00718                 LARGE_INTEGER OldFileSize;
00719                 LARGE_INTEGER OldValidDataLength;
00720 
00721                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!KeIsExecutingDpc());
00722 
00723                 <span class="comment">//</span>
00724                 <span class="comment">//  Make our best guess on whether we need the file exclusive</span>
00725                 <span class="comment">//  or shared.</span>
00726                 <span class="comment">//</span>
00727 
00728                 NewFileSize.QuadPart = FileOffset-&gt;QuadPart + (LONGLONG)Length;
00729 
00730                 <span class="keywordflow">if</span> (WriteToEndOfFile || (NewFileSize.QuadPart &gt; <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength.QuadPart)) {
00731 
00732                     <span class="comment">//</span>
00733                     <span class="comment">//  Acquired shared on the common fcb header, and return</span>
00734                     <span class="comment">//  if we don't get it.</span>
00735                     <span class="comment">//</span>
00736 
00737                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource, Wait )) {
00738 
00739                         <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
00740 
00741                         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00742                     }
00743 
00744                 } <span class="keywordflow">else</span> {
00745 
00746                     <span class="comment">//</span>
00747                     <span class="comment">//  Acquired shared on the common fcb header, and return</span>
00748                     <span class="comment">//  if we don't get it.</span>
00749                     <span class="comment">//</span>
00750 
00751                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource, Wait )) {
00752 
00753                         <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
00754 
00755                         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00756                     }
00757 
00758                     AcquiredShared = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00759                 }
00760 
00761 
00762                 <span class="comment">//</span>
00763                 <span class="comment">//  We have the fcb shared now check if we can do fast i/o</span>
00764                 <span class="comment">//  and if the file space is allocated, and if not then</span>
00765                 <span class="comment">//  release the fcb and return.</span>
00766                 <span class="comment">//</span>
00767 
00768                 <span class="keywordflow">if</span> (WriteToEndOfFile) {
00769 
00770                     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize;
00771                     NewFileSize.QuadPart = <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize.QuadPart + (LONGLONG)Length;
00772 
00773                 } <span class="keywordflow">else</span> {
00774 
00775                     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = *FileOffset;
00776                     NewFileSize.QuadPart = FileOffset-&gt;QuadPart + (LONGLONG)Length;
00777                 }
00778 
00779                 <span class="comment">//</span>
00780                 <span class="comment">//  Now that the File is acquired shared, we can safely test</span>
00781                 <span class="comment">//  if it is really cached and if we can do fast i/o and we</span>
00782                 <span class="comment">//  do not have to extend. If not then release the fcb and</span>
00783                 <span class="comment">//  return.</span>
00784                 <span class="comment">//</span>
00785                 <span class="comment">//  Get out if we are about to zero too much as well, as commented above.</span>
00786                 <span class="comment">//  Likewise, for NewFileSizes that exceed MAXLONGLONG.</span>
00787                 <span class="comment">//</span>
00788 
00789                 <span class="keywordflow">if</span> ((FileObject-&gt;PrivateCacheMap == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
00790                     (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;IsFastIoPossible == <a class="code" href="../../d1/d8/fsrtl_8h.html#a188a86">FastIoIsNotPossible</a>) ||
00791                       (<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>.QuadPart &gt;= (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength.QuadPart + 0x2000)) ||
00792                       (MAXLONGLONG - <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>.QuadPart &lt; (LONGLONG)Length) ||
00793                       (NewFileSize.QuadPart &gt; <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;AllocationSize.QuadPart) ) {
00794 
00795                     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource );
00796                     <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
00797 
00798                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00799                 }
00800 
00801                 <span class="comment">//</span>
00802                 <span class="comment">//  If we will be extending ValidDataLength, we will have to</span>
00803                 <span class="comment">//  get the Fcb exclusive, and make sure that FastIo is still</span>
00804                 <span class="comment">//  possible.  We should only execute this block of code very</span>
00805                 <span class="comment">//  rarely, when the unsafe test for ValidDataLength failed</span>
00806                 <span class="comment">//  above.</span>
00807                 <span class="comment">//</span>
00808 
00809                 <span class="keywordflow">if</span> (AcquiredShared &amp;&amp; ( NewFileSize.QuadPart &gt; <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength.QuadPart )) {
00810 
00811                     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource );
00812 
00813                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource, Wait )) {
00814 
00815                         <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
00816 
00817                         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00818                     }
00819 
00820                     <span class="comment">//</span>
00821                     <span class="comment">// If writing to end of file, we must recalculate new size.</span>
00822                     <span class="comment">//</span>
00823 
00824                     <span class="keywordflow">if</span> (WriteToEndOfFile) {
00825 
00826                         <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize;
00827                         NewFileSize.QuadPart = <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize.QuadPart + (LONGLONG)Length;
00828                     }
00829 
00830                     <span class="keywordflow">if</span> ((FileObject-&gt;PrivateCacheMap == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
00831                         (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;IsFastIoPossible == <a class="code" href="../../d1/d8/fsrtl_8h.html#a188a86">FastIoIsNotPossible</a>) ||
00832                         ( NewFileSize.QuadPart &gt; <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;AllocationSize.QuadPart ) ) {
00833 
00834                         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource );
00835                         <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
00836 
00837                         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00838                     }
00839                 }
00840 
00841                 <span class="comment">//</span>
00842                 <span class="comment">//  Check if fast I/O is questionable and if so then go ask</span>
00843                 <span class="comment">//  the file system the answer</span>
00844                 <span class="comment">//</span>
00845 
00846                 <span class="keywordflow">if</span> (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;IsFastIoPossible == <a class="code" href="../../d1/d8/fsrtl_8h.html#a188a88">FastIoIsQuestionable</a>) {
00847 
00848                     <a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">PFAST_IO_DISPATCH</a> FastIoDispatch = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( FileObject )-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o10">FastIoDispatch</a>;
00849                     IO_STATUS_BLOCK IoStatus;
00850 
00851                     <span class="comment">//</span>
00852                     <span class="comment">//  All file system then set "Is Questionable" had better</span>
00853                     <span class="comment">//  support fast I/O</span>
00854                     <span class="comment">//</span>
00855 
00856                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FastIoDispatch != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00857                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o1">FastIoCheckIfPossible</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00858 
00859                     <span class="comment">//</span>
00860                     <span class="comment">//  Call the file system to check for fast I/O.  If the</span>
00861                     <span class="comment">//  answer is anything other than GoForIt then we cannot</span>
00862                     <span class="comment">//  take the fast I/O path.</span>
00863                     <span class="comment">//</span>
00864 
00865                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FILE_WRITE_TO_END_OF_FILE == 0xffffffff);
00866 
00867                     <span class="keywordflow">if</span> (!FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o1">FastIoCheckIfPossible</a>( FileObject,
00868                                                                 FileOffset-&gt;QuadPart != (LONGLONG)-1 ?
00869                                                                   FileOffset : &amp;<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize,
00870                                                                 Length,
00871                                                                 Wait,
00872                                                                 LockKey,
00873                                                                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <span class="comment">// write operation</span>
00874                                                                 &amp;IoStatus,
00875                                                                 DeviceObject )) {
00876 
00877                         <span class="comment">//</span>
00878                         <span class="comment">//  Fast I/O is not possible so release the Fcb and</span>
00879                         <span class="comment">//  return.</span>
00880                         <span class="comment">//</span>
00881 
00882                         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource );
00883                         <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
00884 
00885                         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00886                     }
00887                 }
00888 
00889                 <span class="comment">//</span>
00890                 <span class="comment">//  Now see if we will change FileSize.  We have to do it now</span>
00891                 <span class="comment">//  so that our reads are not nooped.</span>
00892                 <span class="comment">//</span>
00893 
00894                 <span class="keywordflow">if</span> ( NewFileSize.QuadPart &gt; <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize.QuadPart ) {
00895 
00896                     FileSizeChanged = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00897                     OldFileSize = <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize;
00898                     OldValidDataLength = <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength;
00899 
00900                     <span class="comment">//</span>
00901                     <span class="comment">//  Deal with an extremely rare pathalogical case here the</span>
00902                     <span class="comment">//  file size wraps.</span>
00903                     <span class="comment">//</span>
00904 
00905                     <span class="keywordflow">if</span> ( (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize.HighPart != NewFileSize.HighPart) &amp;&amp;
00906                          (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ) {
00907 
00908                         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00909                         <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize = NewFileSize;
00910                         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource );
00911 
00912                     } <span class="keywordflow">else</span> {
00913 
00914                         <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize = NewFileSize;
00915                     }
00916                 }
00917 
00918                 <span class="comment">//</span>
00919                 <span class="comment">//  We can do fast i/o so call the cc routine to do the work</span>
00920                 <span class="comment">//  and then release the fcb when we've done.  If for whatever</span>
00921                 <span class="comment">//  reason the copy write fails, then return FALSE to our</span>
00922                 <span class="comment">//  caller.</span>
00923                 <span class="comment">//</span>
00924                 <span class="comment">//  Also mark this as the top level "Irp" so that lower file</span>
00925                 <span class="comment">//  system levels will not attempt a pop-up</span>
00926                 <span class="comment">//</span>
00927 
00928                 <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;TopLevelIrp = <a class="code" href="../../d1/d8/fsrtl_8h.html#a14">FSRTL_FAST_IO_TOP_LEVEL_IRP</a>;
00929 
00930                 <span class="keywordflow">try</span> {
00931 
00932                     <span class="comment">//</span>
00933                     <span class="comment">//  See if we have to do some zeroing</span>
00934                     <span class="comment">//</span>
00935 
00936                     <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>.QuadPart &gt; <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength.QuadPart ) {
00937 
00938                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d2/cache_8h.html#a66">CcZeroData</a>( FileObject,
00939                                              &amp;<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength,
00940                                              &amp;<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>,
00941                                              Wait );
00942                     }
00943 
00944                     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) {
00945 
00946                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d2/cache_8h.html#a76">CcCopyWrite</a>( FileObject,
00947                                               &amp;<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>,
00948                                               Length,
00949                                               Wait,
00950                                               <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> );
00951                     }
00952 
00953                 } except( <a class="code" href="../../d1/d8/fsrtl_8h.html#a137">FsRtlIsNtstatusExpected</a>(GetExceptionCode())
00954                                                 ? <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>
00955                                                 : <a class="code" href="../../d6/d7/halmips_8h.html#a34">EXCEPTION_CONTINUE_SEARCH</a> ) {
00956 
00957                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00958                 }
00959 
00960                 <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;TopLevelIrp = 0;
00961 
00962                 <span class="comment">//</span>
00963                 <span class="comment">//  If we succeeded, see if we have to update FileSize or</span>
00964                 <span class="comment">//  ValidDataLength.</span>
00965                 <span class="comment">//</span>
00966 
00967                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) {
00968 
00969                     <span class="comment">//</span>
00970                     <span class="comment">//  In the case of ValidDataLength, we really have to</span>
00971                     <span class="comment">//  check again since we did not do this when we acquired</span>
00972                     <span class="comment">//  the resource exclusive.</span>
00973                     <span class="comment">//</span>
00974 
00975                     <span class="keywordflow">if</span> ( NewFileSize.QuadPart &gt; <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength.QuadPart ) {
00976 
00977                         <span class="comment">//</span>
00978                         <span class="comment">//  Deal with an extremely rare pathalogical case here</span>
00979                         <span class="comment">//  the ValidDataLength wraps.</span>
00980                         <span class="comment">//</span>
00981 
00982                         <span class="keywordflow">if</span> ( (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength.HighPart != NewFileSize.HighPart) &amp;&amp;
00983                              (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ) {
00984 
00985                             (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00986                             <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength = NewFileSize;
00987                             <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource );
00988 
00989                         } <span class="keywordflow">else</span> {
00990 
00991                             <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength = NewFileSize;
00992                         }
00993                     }
00994 
00995                     <span class="comment">//</span>
00996                     <span class="comment">//  Set this handle as having modified the file</span>
00997                     <span class="comment">//</span>
00998 
00999                     FileObject-&gt;Flags |= <a class="code" href="../../d0/d5/io_8h.html#a162">FO_FILE_MODIFIED</a>;
01000 
01001                     <span class="keywordflow">if</span> (FileSizeChanged) {
01002 
01003                         *<a class="code" href="../../d4/d2/cache_8h.html#a3">CcGetFileSizePointer</a>(FileObject) = NewFileSize;
01004 
01005                         FileObject-&gt;Flags |= <a class="code" href="../../d0/d5/io_8h.html#a163">FO_FILE_SIZE_CHANGED</a>;
01006                     }
01007 
01008                     <span class="comment">//</span>
01009                     <span class="comment">//  Also update the current file position pointer</span>
01010                     <span class="comment">//</span>
01011 
01012                     FileObject-&gt;CurrentByteOffset.QuadPart = <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>.QuadPart + Length;
01013 
01014                 <span class="comment">//</span>
01015                 <span class="comment">// If we did not succeed, then we must restore the original</span>
01016                 <span class="comment">// FileSize while holding the PagingIoResource exclusive if</span>
01017                 <span class="comment">// it exists.</span>
01018                 <span class="comment">//</span>
01019 
01020                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (FileSizeChanged) {
01021 
01022                     <span class="keywordflow">if</span> ( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01023 
01024                         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
01025                         <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize = OldFileSize;
01026                         <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength = OldValidDataLength;
01027                         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource );
01028 
01029                     } <span class="keywordflow">else</span> {
01030 
01031                         <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize = OldFileSize;
01032                         <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength = OldValidDataLength;
01033                     }
01034                 }
01035 
01036             }
01037 
01038             <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource );
01039             <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
01040 
01041             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01042 
01043         } <span class="keywordflow">else</span> {
01044 
01045             <span class="comment">//</span>
01046             <span class="comment">//  A zero length transfer was requested.</span>
01047             <span class="comment">//</span>
01048 
01049             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01050         }
01051 
01052     } <span class="keywordflow">else</span> {
01053 
01054         <span class="comment">//</span>
01055         <span class="comment">// The volume must be verified or the file is write through.</span>
01056         <span class="comment">//</span>
01057 
01058         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01059     }
01060 }
01061 
01062 
01063 BOOLEAN
<a name="l01064"></a><a class="code" href="../../d1/d8/fsrtl_8h.html#a99">01064</a> <a class="code" href="../../d1/d8/fsrtl_8h.html#a99">FsRtlMdlReadDev</a> (
01065     IN <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject,
01066     IN PLARGE_INTEGER FileOffset,
01067     IN ULONG Length,
01068     IN ULONG LockKey,
01069     OUT <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> *MdlChain,
01070     OUT PIO_STATUS_BLOCK IoStatus,
01071     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject
01072     )
01073 
01074 <span class="comment">/*++</span>
01075 <span class="comment"></span>
01076 <span class="comment">Routine Description:</span>
01077 <span class="comment"></span>
01078 <span class="comment">    This routine does a fast cached mdl read bypassing the usual file system</span>
01079 <span class="comment">    entry routine (i.e., without the Irp).  It is used to do a copy read</span>
01080 <span class="comment">    of a cached file object.  For a complete description of the arguments</span>
01081 <span class="comment">    see CcMdlRead.</span>
01082 <span class="comment"></span>
01083 <span class="comment">Arguments:</span>
01084 <span class="comment"></span>
01085 <span class="comment">    FileObject - Pointer to the file object being read.</span>
01086 <span class="comment"></span>
01087 <span class="comment">    FileOffset - Byte offset in file for desired data.</span>
01088 <span class="comment"></span>
01089 <span class="comment">    Length - Length of desired data in bytes.</span>
01090 <span class="comment"></span>
01091 <span class="comment">    MdlChain - On output it returns a pointer to an MDL chain describing</span>
01092 <span class="comment">        the desired data.</span>
01093 <span class="comment"></span>
01094 <span class="comment">    IoStatus - Pointer to standard I/O status block to receive the status</span>
01095 <span class="comment">               for the transfer.</span>
01096 <span class="comment"></span>
01097 <span class="comment">    DeviceObject - Supplies DeviceObject for callee.</span>
01098 <span class="comment"></span>
01099 <span class="comment">Return Value:</span>
01100 <span class="comment"></span>
01101 <span class="comment">    FALSE - if the data was not delivered, or if there is an I/O error.</span>
01102 <span class="comment"></span>
01103 <span class="comment">    TRUE - if the data is being delivered</span>
01104 <span class="comment"></span>
01105 <span class="comment">--*/</span>
01106 
01107 {
01108     <a class="code" href="../../d1/d1/struct__FSRTL__COMMON__FCB__HEADER.html">PFSRTL_COMMON_FCB_HEADER</a> <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>;
01109     BOOLEAN <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01110     LARGE_INTEGER BeyondLastByte;
01111 
01112     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01113 
01114     <span class="comment">//</span>
01115     <span class="comment">//  Special case a read of zero length</span>
01116     <span class="comment">//</span>
01117 
01118     <span class="keywordflow">if</span> (Length == 0) {
01119 
01120         IoStatus-&gt;Status = STATUS_SUCCESS;
01121         IoStatus-&gt;Information = 0;
01122 
01123         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01124     }
01125 
01126     <span class="comment">//</span>
01127     <span class="comment">//  Overflows should've been handled by caller.</span>
01128     <span class="comment">//</span>
01129 
01130     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(MAXLONGLONG - FileOffset-&gt;QuadPart &gt;= (LONGLONG)Length);
01131 
01132        
01133     <span class="comment">//</span>
01134     <span class="comment">//  Get a real pointer to the common fcb header</span>
01135     <span class="comment">//</span>
01136 
01137     BeyondLastByte.QuadPart = FileOffset-&gt;QuadPart + (LONGLONG)Length;
01138     <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a> = (<a class="code" href="../../d1/d1/struct__FSRTL__COMMON__FCB__HEADER.html">PFSRTL_COMMON_FCB_HEADER</a>)FileObject-&gt;FsContext;
01139 
01140     <span class="comment">//</span>
01141     <span class="comment">//  Enter the file system</span>
01142     <span class="comment">//</span>
01143 
01144     <a class="code" href="../../d1/d8/fsrtl_8h.html#a48">FsRtlEnterFileSystem</a>();
01145 
01146     <a class="code" href="../../d5/d2/cachedat_8c.html#a49">CcFastMdlReadWait</a> += 1;
01147 
01148     <span class="comment">//</span>
01149     <span class="comment">//  Acquired shared on the common fcb header</span>
01150     <span class="comment">//</span>
01151 
01152     (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
01153 
01154     <span class="comment">//</span>
01155     <span class="comment">//  Now that the File is acquired shared, we can safely test if it is</span>
01156     <span class="comment">//  really cached and if we can do fast i/o and if not</span>
01157     <span class="comment">//  then release the fcb and return.</span>
01158     <span class="comment">//</span>
01159 
01160     <span class="keywordflow">if</span> ((FileObject-&gt;PrivateCacheMap == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
01161         (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;IsFastIoPossible == <a class="code" href="../../d1/d8/fsrtl_8h.html#a188a86">FastIoIsNotPossible</a>)) {
01162 
01163         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource );
01164         <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
01165 
01166         <a class="code" href="../../d5/d2/cachedat_8c.html#a51">CcFastMdlReadNotPossible</a> += 1;
01167 
01168         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01169     }
01170 
01171     <span class="comment">//</span>
01172     <span class="comment">//  Check if fast I/O is questionable and if so then go ask the file system</span>
01173     <span class="comment">//  the answer</span>
01174     <span class="comment">//</span>
01175 
01176     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;IsFastIoPossible == <a class="code" href="../../d1/d8/fsrtl_8h.html#a188a88">FastIoIsQuestionable</a>) {
01177 
01178         <a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">PFAST_IO_DISPATCH</a> FastIoDispatch;
01179 
01180         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!KeIsExecutingDpc());
01181 
01182         FastIoDispatch = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( FileObject )-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o10">FastIoDispatch</a>;
01183 
01184 
01185         <span class="comment">//</span>
01186         <span class="comment">//  All file system then set "Is Questionable" had better support fast I/O</span>
01187         <span class="comment">//</span>
01188 
01189         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FastIoDispatch != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01190         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o1">FastIoCheckIfPossible</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01191 
01192         <span class="comment">//</span>
01193         <span class="comment">//  Call the file system to check for fast I/O.  If the answer is anything</span>
01194         <span class="comment">//  other than GoForIt then we cannot take the fast I/O path.</span>
01195         <span class="comment">//</span>
01196 
01197         <span class="keywordflow">if</span> (!FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o1">FastIoCheckIfPossible</a>( FileObject,
01198                                                     FileOffset,
01199                                                     Length,
01200                                                     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01201                                                     LockKey,
01202                                                     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <span class="comment">// read operation</span>
01203                                                     IoStatus,
01204                                                     <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( FileObject ) )) {
01205 
01206             <span class="comment">//</span>
01207             <span class="comment">//  Fast I/O is not possible so release the Fcb and return.</span>
01208             <span class="comment">//</span>
01209 
01210             <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource );
01211             <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
01212 
01213             <a class="code" href="../../d5/d2/cachedat_8c.html#a51">CcFastMdlReadNotPossible</a> += 1;
01214 
01215             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01216         }
01217     }
01218 
01219     <span class="comment">//</span>
01220     <span class="comment">//  Check for read past file size.</span>
01221     <span class="comment">//</span>
01222 
01223     <span class="keywordflow">if</span> ( BeyondLastByte.QuadPart &gt; <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize.QuadPart ) {
01224 
01225         <span class="keywordflow">if</span> ( FileOffset-&gt;QuadPart &gt;= <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize.QuadPart ) {
01226             IoStatus-&gt;Status = STATUS_END_OF_FILE;
01227             IoStatus-&gt;Information = 0;
01228 
01229             <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource );
01230             <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
01231 
01232             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01233         }
01234 
01235         Length = (ULONG)( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize.QuadPart - FileOffset-&gt;QuadPart );
01236     }
01237 
01238     <span class="comment">//</span>
01239     <span class="comment">//  We can do fast i/o so call the cc routine to do the work and then</span>
01240     <span class="comment">//  release the fcb when we've done.  If for whatever reason the</span>
01241     <span class="comment">//  mdl read fails, then return FALSE to our caller.</span>
01242     <span class="comment">//</span>
01243     <span class="comment">//</span>
01244     <span class="comment">//  Also mark this as the top level "Irp" so that lower file system levels</span>
01245     <span class="comment">//  will not attempt a pop-up</span>
01246     <span class="comment">//</span>
01247 
01248     <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;TopLevelIrp = <a class="code" href="../../d1/d8/fsrtl_8h.html#a14">FSRTL_FAST_IO_TOP_LEVEL_IRP</a>;
01249 
01250     <span class="keywordflow">try</span> {
01251 
01252         <a class="code" href="../../d4/d2/cache_8h.html#a78">CcMdlRead</a>( FileObject, FileOffset, Length, MdlChain, IoStatus );
01253 
01254         FileObject-&gt;Flags |= <a class="code" href="../../d0/d5/io_8h.html#a169">FO_FILE_FAST_IO_READ</a>;
01255 
01256     } except( <a class="code" href="../../d1/d8/fsrtl_8h.html#a137">FsRtlIsNtstatusExpected</a>(GetExceptionCode())
01257                                    ? <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>
01258                                    : <a class="code" href="../../d6/d7/halmips_8h.html#a34">EXCEPTION_CONTINUE_SEARCH</a> ) {
01259 
01260         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01261     }
01262 
01263     <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;TopLevelIrp = 0;
01264 
01265     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource );
01266     <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
01267 
01268     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01269 }
01270 
01271 
01272 <span class="comment">//</span>
01273 <span class="comment">//  The old routine will either dispatch or call FsRtlMdlReadDev</span>
01274 <span class="comment">//</span>
01275 
01276 BOOLEAN
<a name="l01277"></a><a class="code" href="../../d1/d8/fsrtl_8h.html#a95">01277</a> <a class="code" href="../../d1/d8/fsrtl_8h.html#a95">FsRtlMdlRead</a> (
01278     IN <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject,
01279     IN PLARGE_INTEGER FileOffset,
01280     IN ULONG Length,
01281     IN ULONG LockKey,
01282     OUT <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> *MdlChain,
01283     OUT PIO_STATUS_BLOCK IoStatus
01284     )
01285 
01286 <span class="comment">/*++</span>
01287 <span class="comment"></span>
01288 <span class="comment">Routine Description:</span>
01289 <span class="comment"></span>
01290 <span class="comment">    This routine does a fast cached mdl read bypassing the usual file system</span>
01291 <span class="comment">    entry routine (i.e., without the Irp).  It is used to do a copy read</span>
01292 <span class="comment">    of a cached file object.  For a complete description of the arguments</span>
01293 <span class="comment">    see CcMdlRead.</span>
01294 <span class="comment"></span>
01295 <span class="comment">Arguments:</span>
01296 <span class="comment"></span>
01297 <span class="comment">    FileObject - Pointer to the file object being read.</span>
01298 <span class="comment"></span>
01299 <span class="comment">    FileOffset - Byte offset in file for desired data.</span>
01300 <span class="comment"></span>
01301 <span class="comment">    Length - Length of desired data in bytes.</span>
01302 <span class="comment"></span>
01303 <span class="comment">    MdlChain - On output it returns a pointer to an MDL chain describing</span>
01304 <span class="comment">        the desired data.</span>
01305 <span class="comment"></span>
01306 <span class="comment">    IoStatus - Pointer to standard I/O status block to receive the status</span>
01307 <span class="comment">               for the transfer.</span>
01308 <span class="comment"></span>
01309 <span class="comment">Return Value:</span>
01310 <span class="comment"></span>
01311 <span class="comment">    FALSE - if the data was not delivered, or if there is an I/O error.</span>
01312 <span class="comment"></span>
01313 <span class="comment">    TRUE - if the data is being delivered</span>
01314 <span class="comment"></span>
01315 <span class="comment">--*/</span>
01316 
01317 {
01318     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, VolumeDeviceObject;
01319     <a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">PFAST_IO_DISPATCH</a> FastIoDispatch;
01320 
01321     DeviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( FileObject );
01322     FastIoDispatch = DeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o10">FastIoDispatch</a>;
01323 
01324     <span class="comment">//</span>
01325     <span class="comment">//  See if the (top-level) FileSystem has a FastIo routine, and if so, call it.</span>
01326     <span class="comment">//</span>
01327 
01328     <span class="keywordflow">if</span> ((FastIoDispatch != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01329         (FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o0">SizeOfFastIoDispatch</a> &gt; FIELD_OFFSET(<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">FAST_IO_DISPATCH</a>, MdlRead)) &amp;&amp;
01330         (FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o16">MdlRead</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01331 
01332         <span class="keywordflow">return</span> FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o16">MdlRead</a>( FileObject, FileOffset, Length, LockKey, MdlChain, IoStatus, DeviceObject );
01333 
01334     } <span class="keywordflow">else</span> {
01335 
01336         <span class="comment">//</span>
01337         <span class="comment">//  Get the DeviceObject for the volume.  If that DeviceObject is different, and</span>
01338         <span class="comment">//  it specifies the FastIo routine, then we have to return FALSE here and cause</span>
01339         <span class="comment">//  an Irp to get generated.</span>
01340         <span class="comment">//</span>
01341 
01342         VolumeDeviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a68">IoGetBaseFileSystemDeviceObject</a>( FileObject );
01343         <span class="keywordflow">if</span> ((VolumeDeviceObject != DeviceObject) &amp;&amp;
01344             (FastIoDispatch = VolumeDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o10">FastIoDispatch</a>) &amp;&amp;
01345             (FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o0">SizeOfFastIoDispatch</a> &gt; FIELD_OFFSET(<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">FAST_IO_DISPATCH</a>, MdlRead)) &amp;&amp;
01346             (FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o16">MdlRead</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01347 
01348             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01349 
01350         <span class="comment">//</span>
01351         <span class="comment">//  Otherwise, call the default routine.</span>
01352         <span class="comment">//</span>
01353 
01354         } <span class="keywordflow">else</span> {
01355 
01356             <span class="keywordflow">return</span> <a class="code" href="../../d1/d8/fsrtl_8h.html#a99">FsRtlMdlReadDev</a>( FileObject, FileOffset, Length, LockKey, MdlChain, IoStatus, DeviceObject );
01357         }
01358     }
01359 }
01360 
01361 
01362 <span class="comment">//</span>
01363 <span class="comment">//  The old routine will either dispatch or call FsRtlMdlReadCompleteDev</span>
01364 <span class="comment">//</span>
01365 
01366 BOOLEAN
<a name="l01367"></a><a class="code" href="../../d1/d8/fsrtl_8h.html#a96">01367</a> <a class="code" href="../../d1/d8/fsrtl_8h.html#a96">FsRtlMdlReadComplete</a> (
01368     IN <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject,
01369     IN <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> MdlChain
01370     )
01371 
01372 <span class="comment">/*++</span>
01373 <span class="comment"></span>
01374 <span class="comment">Routine Description:</span>
01375 <span class="comment"></span>
01376 <span class="comment">    This routine does a fast cached mdl read bypassing the usual file system</span>
01377 <span class="comment">    entry routine (i.e., without the Irp).  It is used to do a copy read</span>
01378 <span class="comment">    of a cached file object.</span>
01379 <span class="comment"></span>
01380 <span class="comment">Arguments:</span>
01381 <span class="comment"></span>
01382 <span class="comment">    FileObject - Pointer to the file object being read.</span>
01383 <span class="comment"></span>
01384 <span class="comment">    MdlChain - Supplies a pointer to an MDL chain returned from CcMdlRead.</span>
01385 <span class="comment"></span>
01386 <span class="comment">Return Value:</span>
01387 <span class="comment"></span>
01388 <span class="comment">    None</span>
01389 <span class="comment"></span>
01390 <span class="comment">--*/</span>
01391 
01392 {
01393     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, VolumeDeviceObject;
01394     <a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">PFAST_IO_DISPATCH</a> FastIoDispatch;
01395 
01396     DeviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( FileObject );
01397     FastIoDispatch = DeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o10">FastIoDispatch</a>;
01398 
01399     <span class="comment">//</span>
01400     <span class="comment">//  See if the (top-level) FileSystem has a FastIo routine, and if so, call it.</span>
01401     <span class="comment">//</span>
01402 
01403     <span class="keywordflow">if</span> ((FastIoDispatch != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01404         (FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o0">SizeOfFastIoDispatch</a> &gt; FIELD_OFFSET(<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">FAST_IO_DISPATCH</a>, MdlReadComplete)) &amp;&amp;
01405         (FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o17">MdlReadComplete</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01406 
01407         <span class="keywordflow">return</span> FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o17">MdlReadComplete</a>( FileObject, MdlChain, DeviceObject );
01408 
01409     } <span class="keywordflow">else</span> {
01410 
01411         <span class="comment">//</span>
01412         <span class="comment">//  Get the DeviceObject for the volume.  If that DeviceObject is different, and</span>
01413         <span class="comment">//  it specifies the FastIo routine, then we have to return FALSE here and cause</span>
01414         <span class="comment">//  an Irp to get generated.</span>
01415         <span class="comment">//</span>
01416 
01417         VolumeDeviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a68">IoGetBaseFileSystemDeviceObject</a>( FileObject );
01418         <span class="keywordflow">if</span> ((VolumeDeviceObject != DeviceObject) &amp;&amp;
01419             (FastIoDispatch = VolumeDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o10">FastIoDispatch</a>) &amp;&amp;
01420             (FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o0">SizeOfFastIoDispatch</a> &gt; FIELD_OFFSET(<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">FAST_IO_DISPATCH</a>, MdlReadComplete)) &amp;&amp;
01421             (FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o17">MdlReadComplete</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01422 
01423             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01424 
01425         <span class="comment">//</span>
01426         <span class="comment">//  Otherwise, call the default routine.</span>
01427         <span class="comment">//</span>
01428 
01429         } <span class="keywordflow">else</span> {
01430 
01431             <span class="keywordflow">return</span> <a class="code" href="../../d1/d8/fsrtl_8h.html#a100">FsRtlMdlReadCompleteDev</a>( FileObject, MdlChain, DeviceObject );
01432         }
01433     }
01434 }
01435 
01436 
01437 BOOLEAN
<a name="l01438"></a><a class="code" href="../../d1/d8/fsrtl_8h.html#a100">01438</a> <a class="code" href="../../d1/d8/fsrtl_8h.html#a100">FsRtlMdlReadCompleteDev</a> (
01439     IN <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject,
01440     IN <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> MdlChain,
01441     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject
01442     )
01443 
01444 <span class="comment">/*++</span>
01445 <span class="comment"></span>
01446 <span class="comment">Routine Description:</span>
01447 <span class="comment"></span>
01448 <span class="comment">    This routine does a fast cached mdl read bypassing the usual file system</span>
01449 <span class="comment">    entry routine (i.e., without the Irp).  It is used to do a copy read</span>
01450 <span class="comment">    of a cached file object.</span>
01451 <span class="comment"></span>
01452 <span class="comment">Arguments:</span>
01453 <span class="comment"></span>
01454 <span class="comment">    FileObject - Pointer to the file object being read.</span>
01455 <span class="comment"></span>
01456 <span class="comment">    MdlChain - Supplies a pointer to an MDL chain returned from CcMdlRead.</span>
01457 <span class="comment"></span>
01458 <span class="comment">    DeviceObject - Supplies the DeviceObject for the callee.</span>
01459 <span class="comment"></span>
01460 <span class="comment">Return Value:</span>
01461 <span class="comment"></span>
01462 <span class="comment">    None</span>
01463 <span class="comment"></span>
01464 <span class="comment">--*/</span>
01465 
01466 
01467 {
01468     <a class="code" href="../../d4/d2/cache_8h.html#a80">CcMdlReadComplete2</a>( FileObject, MdlChain );
01469     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01470 }
01471 
01472 
01473 BOOLEAN
<a name="l01474"></a><a class="code" href="../../d1/d8/fsrtl_8h.html#a101">01474</a> <a class="code" href="../../d1/d8/fsrtl_8h.html#a101">FsRtlPrepareMdlWriteDev</a> (
01475     IN <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject,
01476     IN PLARGE_INTEGER FileOffset,
01477     IN ULONG Length,
01478     IN ULONG LockKey,
01479     OUT <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> *MdlChain,
01480     OUT PIO_STATUS_BLOCK IoStatus,
01481     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject
01482     )
01483 
01484 <span class="comment">/*++</span>
01485 <span class="comment"></span>
01486 <span class="comment">Routine Description:</span>
01487 <span class="comment"></span>
01488 <span class="comment">    This routine does a fast cached mdl read bypassing the usual file system</span>
01489 <span class="comment">    entry routine (i.e., without the Irp).  It is used to do a copy read</span>
01490 <span class="comment">    of a cached file object.  For a complete description of the arguments</span>
01491 <span class="comment">    see CcMdlRead.</span>
01492 <span class="comment"></span>
01493 <span class="comment">Arguments:</span>
01494 <span class="comment"></span>
01495 <span class="comment">    FileObject - Pointer to the file object being read.</span>
01496 <span class="comment"></span>
01497 <span class="comment">    FileOffset - Byte offset in file for desired data.</span>
01498 <span class="comment"></span>
01499 <span class="comment">    Length - Length of desired data in bytes.</span>
01500 <span class="comment"></span>
01501 <span class="comment">    MdlChain - On output it returns a pointer to an MDL chain describing</span>
01502 <span class="comment">        the desired data.</span>
01503 <span class="comment"></span>
01504 <span class="comment">    IoStatus - Pointer to standard I/O status block to receive the status</span>
01505 <span class="comment">               for the transfer.</span>
01506 <span class="comment"></span>
01507 <span class="comment">    DeviceObject - Supplies the DeviceObject for the callee.</span>
01508 <span class="comment"></span>
01509 <span class="comment">Return Value:</span>
01510 <span class="comment"></span>
01511 <span class="comment">    FALSE - if the data was not written, or if there is an I/O error.</span>
01512 <span class="comment"></span>
01513 <span class="comment">    TRUE - if the data is being written</span>
01514 <span class="comment"></span>
01515 <span class="comment">--*/</span>
01516 
01517 {
01518     <a class="code" href="../../d1/d1/struct__FSRTL__COMMON__FCB__HEADER.html">PFSRTL_COMMON_FCB_HEADER</a> <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>;
01519     LARGE_INTEGER <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>, NewFileSize;
01520     LARGE_INTEGER OldFileSize;
01521     LARGE_INTEGER OldValidDataLength;
01522     BOOLEAN <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01523     BOOLEAN AcquiredShared = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01524     BOOLEAN FileSizeChanged = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01525     BOOLEAN WriteToEndOfFile = (BOOLEAN)((FileOffset-&gt;LowPart == FILE_WRITE_TO_END_OF_FILE) &amp;&amp;
01526                                          (FileOffset-&gt;HighPart == -1));
01527 
01528     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01529 
01530     <span class="comment">//</span>
01531     <span class="comment">//  Call CcCanIWrite.  Also return FALSE if FileObject is write through,</span>
01532     <span class="comment">//  the File System must do that.</span>
01533     <span class="comment">//</span>
01534 
01535     <span class="keywordflow">if</span> ( !<a class="code" href="../../d4/d2/cache_8h.html#a72">CcCanIWrite</a>( FileObject, Length, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ) ||
01536          <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( FileObject-&gt;Flags, <a class="code" href="../../d0/d5/io_8h.html#a154">FO_WRITE_THROUGH</a> )) {
01537 
01538         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01539     }
01540 
01541     <span class="comment">//</span>
01542     <span class="comment">//  Assume our transfer will work</span>
01543     <span class="comment">//</span>
01544 
01545     IoStatus-&gt;Status = STATUS_SUCCESS;
01546 
01547     <span class="comment">//</span>
01548     <span class="comment">//  Special case the zero byte length</span>
01549     <span class="comment">//</span>
01550 
01551     <span class="keywordflow">if</span> (Length == 0) {
01552 
01553         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01554     }
01555 
01556     <span class="comment">//</span>
01557     <span class="comment">//  Get a real pointer to the common fcb header</span>
01558     <span class="comment">//</span>
01559 
01560     <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a> = (<a class="code" href="../../d1/d1/struct__FSRTL__COMMON__FCB__HEADER.html">PFSRTL_COMMON_FCB_HEADER</a>)FileObject-&gt;FsContext;
01561 
01562     <span class="comment">//</span>
01563     <span class="comment">//  Enter the file system</span>
01564     <span class="comment">//</span>
01565 
01566     <a class="code" href="../../d1/d8/fsrtl_8h.html#a48">FsRtlEnterFileSystem</a>();
01567 
01568     <span class="comment">//</span>
01569     <span class="comment">//  Make our best guess on whether we need the file exclusive or</span>
01570     <span class="comment">//  shared.</span>
01571     <span class="comment">//</span>
01572 
01573     NewFileSize.QuadPart = FileOffset-&gt;QuadPart + (LONGLONG)Length;
01574 
01575     <span class="keywordflow">if</span> (WriteToEndOfFile || (NewFileSize.QuadPart &gt; <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength.QuadPart)) {
01576 
01577         <span class="comment">//</span>
01578         <span class="comment">//  Acquired exclusive on the common fcb header, and return if we don't</span>
01579         <span class="comment">//  get it.</span>
01580         <span class="comment">//</span>
01581 
01582         <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
01583 
01584     } <span class="keywordflow">else</span> {
01585 
01586         <span class="comment">//</span>
01587         <span class="comment">//  Acquired shared on the common fcb header, and return if we don't</span>
01588         <span class="comment">//  get it.</span>
01589         <span class="comment">//</span>
01590 
01591         <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
01592 
01593         AcquiredShared = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01594     }
01595 
01596 
01597     <span class="comment">//</span>
01598     <span class="comment">//  We have the fcb shared now check if we can do fast i/o  and if the file</span>
01599     <span class="comment">//  space is allocated, and if not then release the fcb and return.</span>
01600     <span class="comment">//</span>
01601 
01602     <span class="keywordflow">if</span> (WriteToEndOfFile) {
01603 
01604         <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize;
01605         NewFileSize.QuadPart = <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize.QuadPart + (LONGLONG)Length;
01606 
01607     } <span class="keywordflow">else</span> {
01608 
01609         <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = *FileOffset;
01610         NewFileSize.QuadPart = FileOffset-&gt;QuadPart + (LONGLONG)Length;
01611     }
01612 
01613     <span class="comment">//</span>
01614     <span class="comment">//  Now that the File is acquired shared, we can safely test if it is</span>
01615     <span class="comment">//  really cached and if we can do fast i/o and we do not have to extend.</span>
01616     <span class="comment">//  If not then release the fcb and return.</span>
01617     <span class="comment">//</span>
01618 
01619     <span class="keywordflow">if</span> ((FileObject-&gt;PrivateCacheMap == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
01620         (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;IsFastIoPossible == <a class="code" href="../../d1/d8/fsrtl_8h.html#a188a86">FastIoIsNotPossible</a>) ||
01621         (MAXLONGLONG - <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>.QuadPart &lt; (LONGLONG)Length) ||
01622         ( NewFileSize.QuadPart &gt; <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;AllocationSize.QuadPart ) ) {
01623 
01624         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource );
01625         <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
01626 
01627         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01628     }
01629 
01630     <span class="comment">//</span>
01631     <span class="comment">//  If we will be extending ValidDataLength, we will have to get the</span>
01632     <span class="comment">//  Fcb exclusive, and make sure that FastIo is still possible.</span>
01633     <span class="comment">//</span>
01634 
01635     <span class="keywordflow">if</span> (AcquiredShared &amp;&amp; ( NewFileSize.QuadPart &gt; <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength.QuadPart )) {
01636 
01637         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource );
01638 
01639         <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
01640 
01641         AcquiredShared = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01642 
01643         <span class="comment">//</span>
01644         <span class="comment">//  If writing to end of file, we must recalculate new size.</span>
01645         <span class="comment">//</span>
01646 
01647         <span class="keywordflow">if</span> (WriteToEndOfFile) {
01648 
01649             <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize;
01650             NewFileSize.QuadPart = <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize.QuadPart + (LONGLONG)Length;
01651         }
01652 
01653         <span class="keywordflow">if</span> ((FileObject-&gt;PrivateCacheMap == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
01654             (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;IsFastIoPossible == <a class="code" href="../../d1/d8/fsrtl_8h.html#a188a86">FastIoIsNotPossible</a>) ||
01655             ( NewFileSize.QuadPart &gt; <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;AllocationSize.QuadPart )) {
01656 
01657             <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource );
01658             <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
01659 
01660             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01661         }
01662     }
01663 
01664     <span class="comment">//</span>
01665     <span class="comment">//  Check if fast I/O is questionable and if so then go ask the file system</span>
01666     <span class="comment">//  the answer</span>
01667     <span class="comment">//</span>
01668 
01669     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;IsFastIoPossible == <a class="code" href="../../d1/d8/fsrtl_8h.html#a188a88">FastIoIsQuestionable</a>) {
01670 
01671         <a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">PFAST_IO_DISPATCH</a> FastIoDispatch = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( FileObject )-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o10">FastIoDispatch</a>;
01672 
01673         <span class="comment">//</span>
01674         <span class="comment">//  All file system then set "Is Questionable" had better support fast I/O</span>
01675         <span class="comment">//</span>
01676 
01677         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FastIoDispatch != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01678         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o1">FastIoCheckIfPossible</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01679 
01680         <span class="comment">//</span>
01681         <span class="comment">//  Call the file system to check for fast I/O.  If the answer is anything</span>
01682         <span class="comment">//  other than GoForIt then we cannot take the fast I/O path.</span>
01683         <span class="comment">//</span>
01684 
01685         <span class="keywordflow">if</span> (!FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o1">FastIoCheckIfPossible</a>( FileObject,
01686                                                     FileOffset,
01687                                                     Length,
01688                                                     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01689                                                     LockKey,
01690                                                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <span class="comment">// write operation</span>
01691                                                     IoStatus,
01692                                                     <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( FileObject ) )) {
01693 
01694             <span class="comment">//</span>
01695             <span class="comment">//  Fast I/O is not possible so release the Fcb and return.</span>
01696             <span class="comment">//</span>
01697 
01698             <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource );
01699             <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
01700 
01701             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01702         }
01703     }
01704 
01705     <span class="comment">//</span>
01706     <span class="comment">// Now see if we will change FileSize.  We have to do it now so that our</span>
01707     <span class="comment">// reads are not nooped.</span>
01708     <span class="comment">//</span>
01709 
01710     <span class="keywordflow">if</span> ( NewFileSize.QuadPart &gt; <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize.QuadPart ) {
01711 
01712         FileSizeChanged = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01713         OldFileSize = <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize;
01714         OldValidDataLength = <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength;
01715 
01716         <span class="comment">//</span>
01717         <span class="comment">//  Deal with an extremely rare pathalogical case here the file</span>
01718         <span class="comment">//  size wraps.</span>
01719         <span class="comment">//</span>
01720 
01721         <span class="keywordflow">if</span> ( (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize.HighPart != NewFileSize.HighPart) &amp;&amp;
01722              (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ) {
01723 
01724             (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
01725             <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize = NewFileSize;
01726             <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource );
01727 
01728         } <span class="keywordflow">else</span> {
01729 
01730             <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize = NewFileSize;
01731         }
01732     }
01733 
01734     <span class="comment">//</span>
01735     <span class="comment">//  We can do fast i/o so call the cc routine to do the work and then</span>
01736     <span class="comment">//  release the fcb when we've done.  If for whatever reason the</span>
01737     <span class="comment">//  copy write fails, then return FALSE to our caller.</span>
01738     <span class="comment">//</span>
01739     <span class="comment">//</span>
01740     <span class="comment">//  Also mark this as the top level "Irp" so that lower file system levels</span>
01741     <span class="comment">//  will not attempt a pop-up</span>
01742     <span class="comment">//</span>
01743 
01744     <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;TopLevelIrp = <a class="code" href="../../d1/d8/fsrtl_8h.html#a14">FSRTL_FAST_IO_TOP_LEVEL_IRP</a>;
01745 
01746     <span class="keywordflow">try</span> {
01747 
01748         <span class="comment">//</span>
01749         <span class="comment">//  See if we have to do some zeroing</span>
01750         <span class="comment">//</span>
01751 
01752         <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>.QuadPart &gt; <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength.QuadPart ) {
01753 
01754             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d2/cache_8h.html#a66">CcZeroData</a>( FileObject,
01755                                  &amp;<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength,
01756                                  &amp;<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>,
01757                                  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
01758         }
01759 
01760         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) {
01761 
01762             <a class="code" href="../../d4/d2/cache_8h.html#a81">CcPrepareMdlWrite</a>( FileObject, &amp;<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>, Length, MdlChain, IoStatus );
01763         }
01764 
01765     } except( <a class="code" href="../../d1/d8/fsrtl_8h.html#a137">FsRtlIsNtstatusExpected</a>(GetExceptionCode())
01766                                     ? <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>
01767                                     : <a class="code" href="../../d6/d7/halmips_8h.html#a34">EXCEPTION_CONTINUE_SEARCH</a> ) {
01768 
01769         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01770     }
01771 
01772     <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;TopLevelIrp = 0;
01773 
01774     <span class="comment">//</span>
01775     <span class="comment">//  If we succeeded, see if we have to update FileSize or ValidDataLength.</span>
01776     <span class="comment">//</span>
01777 
01778     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) {
01779 
01780         <span class="comment">//</span>
01781         <span class="comment">// In the case of ValidDataLength, we really have to check again</span>
01782         <span class="comment">// since we did not do this when we acquired the resource exclusive.</span>
01783         <span class="comment">//</span>
01784 
01785         <span class="keywordflow">if</span> ( NewFileSize.QuadPart &gt; <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength.QuadPart ) {
01786 
01787             <span class="comment">//</span>
01788             <span class="comment">//  Deal with an extremely rare pathalogical case here the</span>
01789             <span class="comment">//  ValidDataLength wraps.</span>
01790             <span class="comment">//</span>
01791 
01792             <span class="keywordflow">if</span> ( (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength.HighPart != NewFileSize.HighPart) &amp;&amp;
01793                  (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ) {
01794 
01795                 (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
01796                 <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength = NewFileSize;
01797                 <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource );
01798 
01799             } <span class="keywordflow">else</span> {
01800 
01801                 <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength = NewFileSize;
01802             }
01803         }
01804 
01805         <span class="comment">//</span>
01806         <span class="comment">//  Set this handle as having modified the file</span>
01807         <span class="comment">//</span>
01808 
01809         FileObject-&gt;Flags |= <a class="code" href="../../d0/d5/io_8h.html#a162">FO_FILE_MODIFIED</a>;
01810 
01811         <span class="keywordflow">if</span> (FileSizeChanged) {
01812 
01813             *<a class="code" href="../../d4/d2/cache_8h.html#a3">CcGetFileSizePointer</a>(FileObject) = NewFileSize;
01814 
01815             FileObject-&gt;Flags |= <a class="code" href="../../d0/d5/io_8h.html#a163">FO_FILE_SIZE_CHANGED</a>;
01816         }
01817 
01818     <span class="comment">//</span>
01819     <span class="comment">//  If we did not succeed, then we must restore the original FileSize</span>
01820     <span class="comment">//  and release the resource.  In the success path, the cache manager</span>
01821     <span class="comment">//  will release the resource.</span>
01822     <span class="comment">//</span>
01823 
01824     } <span class="keywordflow">else</span> {
01825 
01826         <span class="keywordflow">if</span> (FileSizeChanged) {
01827 
01828             <span class="keywordflow">if</span> ( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01829 
01830                 (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
01831                 <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize = OldFileSize;
01832                 <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength = OldValidDataLength;
01833                 <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource );
01834 
01835             } <span class="keywordflow">else</span> {
01836 
01837                 <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize = OldFileSize;
01838                 <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength = OldValidDataLength;
01839             }
01840         }
01841     }
01842 
01843     <span class="comment">//</span>
01844     <span class="comment">//  Now we can release the resource.</span>
01845     <span class="comment">//</span>
01846 
01847     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource );
01848 
01849     <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
01850 
01851     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01852 }
01853 
01854 
01855 <span class="comment">//</span>
01856 <span class="comment">//  The old routine will either dispatch or call FsRtlPrepareMdlWriteDev</span>
01857 <span class="comment">//</span>
01858 
01859 BOOLEAN
<a name="l01860"></a><a class="code" href="../../d1/d8/fsrtl_8h.html#a97">01860</a> <a class="code" href="../../d1/d8/fsrtl_8h.html#a97">FsRtlPrepareMdlWrite</a> (
01861     IN <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject,
01862     IN PLARGE_INTEGER FileOffset,
01863     IN ULONG Length,
01864     IN ULONG LockKey,
01865     OUT <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> *MdlChain,
01866     OUT PIO_STATUS_BLOCK IoStatus
01867     )
01868 
01869 <span class="comment">/*++</span>
01870 <span class="comment"></span>
01871 <span class="comment">Routine Description:</span>
01872 <span class="comment"></span>
01873 <span class="comment">    This routine does a fast cached mdl read bypassing the usual file system</span>
01874 <span class="comment">    entry routine (i.e., without the Irp).  It is used to do a copy read</span>
01875 <span class="comment">    of a cached file object.  For a complete description of the arguments</span>
01876 <span class="comment">    see CcMdlRead.</span>
01877 <span class="comment"></span>
01878 <span class="comment">Arguments:</span>
01879 <span class="comment"></span>
01880 <span class="comment">    FileObject - Pointer to the file object being read.</span>
01881 <span class="comment"></span>
01882 <span class="comment">    FileOffset - Byte offset in file for desired data.</span>
01883 <span class="comment"></span>
01884 <span class="comment">    Length - Length of desired data in bytes.</span>
01885 <span class="comment"></span>
01886 <span class="comment">    MdlChain - On output it returns a pointer to an MDL chain describing</span>
01887 <span class="comment">        the desired data.</span>
01888 <span class="comment"></span>
01889 <span class="comment">    IoStatus - Pointer to standard I/O status block to receive the status</span>
01890 <span class="comment">               for the transfer.</span>
01891 <span class="comment"></span>
01892 <span class="comment">Return Value:</span>
01893 <span class="comment"></span>
01894 <span class="comment">    FALSE - if the data was not written, or if there is an I/O error.</span>
01895 <span class="comment"></span>
01896 <span class="comment">    TRUE - if the data is being written</span>
01897 <span class="comment"></span>
01898 <span class="comment">--*/</span>
01899 
01900 {
01901     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, VolumeDeviceObject;
01902     <a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">PFAST_IO_DISPATCH</a> FastIoDispatch;
01903 
01904     DeviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( FileObject );
01905     FastIoDispatch = DeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o10">FastIoDispatch</a>;
01906 
01907     <span class="comment">//</span>
01908     <span class="comment">//  See if the (top-level) FileSystem has a FastIo routine, and if so, call it.</span>
01909     <span class="comment">//</span>
01910 
01911     <span class="keywordflow">if</span> ((FastIoDispatch != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01912         (FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o0">SizeOfFastIoDispatch</a> &gt; FIELD_OFFSET(<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">FAST_IO_DISPATCH</a>, PrepareMdlWrite)) &amp;&amp;
01913         (FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o18">PrepareMdlWrite</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01914 
01915         <span class="keywordflow">return</span> FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o18">PrepareMdlWrite</a>( FileObject, FileOffset, Length, LockKey, MdlChain, IoStatus, DeviceObject );
01916 
01917     } <span class="keywordflow">else</span> {
01918 
01919         <span class="comment">//</span>
01920         <span class="comment">//  Get the DeviceObject for the volume.  If that DeviceObject is different, and</span>
01921         <span class="comment">//  it specifies the FastIo routine, then we have to return FALSE here and cause</span>
01922         <span class="comment">//  an Irp to get generated.</span>
01923         <span class="comment">//</span>
01924 
01925         VolumeDeviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a68">IoGetBaseFileSystemDeviceObject</a>( FileObject );
01926         <span class="keywordflow">if</span> ((VolumeDeviceObject != DeviceObject) &amp;&amp;
01927             (FastIoDispatch = VolumeDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o10">FastIoDispatch</a>) &amp;&amp;
01928             (FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o0">SizeOfFastIoDispatch</a> &gt; FIELD_OFFSET(<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">FAST_IO_DISPATCH</a>, PrepareMdlWrite)) &amp;&amp;
01929             (FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o18">PrepareMdlWrite</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01930 
01931             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01932 
01933         <span class="comment">//</span>
01934         <span class="comment">//  Otherwise, call the default routine.</span>
01935         <span class="comment">//</span>
01936 
01937         } <span class="keywordflow">else</span> {
01938 
01939             <span class="keywordflow">return</span> <a class="code" href="../../d1/d8/fsrtl_8h.html#a101">FsRtlPrepareMdlWriteDev</a>( FileObject, FileOffset, Length, LockKey, MdlChain, IoStatus, DeviceObject );
01940         }
01941     }
01942 }
01943 
01944 
01945 <span class="comment">//</span>
01946 <span class="comment">//  The old routine will either dispatch or call FsRtlMdlWriteCompleteDev</span>
01947 <span class="comment">//</span>
01948 
01949 BOOLEAN
<a name="l01950"></a><a class="code" href="../../d1/d8/fsrtl_8h.html#a98">01950</a> <a class="code" href="../../d1/d8/fsrtl_8h.html#a98">FsRtlMdlWriteComplete</a> (
01951     IN <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject,
01952     IN PLARGE_INTEGER FileOffset,
01953     IN <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> MdlChain
01954     )
01955 
01956 <span class="comment">/*++</span>
01957 <span class="comment"></span>
01958 <span class="comment">Routine Description:</span>
01959 <span class="comment"></span>
01960 <span class="comment">    This routine completes an Mdl write.</span>
01961 <span class="comment"></span>
01962 <span class="comment">Arguments:</span>
01963 <span class="comment"></span>
01964 <span class="comment">    FileObject - Pointer to the file object being read.</span>
01965 <span class="comment"></span>
01966 <span class="comment">    MdlChain - Supplies a pointer to an MDL chain returned from CcMdlPrepareMdlWrite.</span>
01967 <span class="comment"></span>
01968 <span class="comment">Return Value:</span>
01969 <span class="comment"></span>
01970 <span class="comment"></span>
01971 <span class="comment"></span>
01972 <span class="comment">--*/</span>
01973 
01974 {
01975     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, VolumeDeviceObject;
01976     <a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">PFAST_IO_DISPATCH</a> FastIoDispatch;
01977 
01978     DeviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( FileObject );
01979     FastIoDispatch = DeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o10">FastIoDispatch</a>;
01980 
01981     <span class="comment">//</span>
01982     <span class="comment">//  See if the (top-level) FileSystem has a FastIo routine, and if so, call it.</span>
01983     <span class="comment">//</span>
01984 
01985     <span class="keywordflow">if</span> ((FastIoDispatch != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01986         (FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o0">SizeOfFastIoDispatch</a> &gt; FIELD_OFFSET(<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">FAST_IO_DISPATCH</a>, MdlWriteComplete)) &amp;&amp;
01987         (FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o19">MdlWriteComplete</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01988 
01989         <span class="keywordflow">return</span> FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o19">MdlWriteComplete</a>( FileObject, FileOffset, MdlChain, DeviceObject );
01990 
01991     } <span class="keywordflow">else</span> {
01992 
01993         <span class="comment">//</span>
01994         <span class="comment">//  Get the DeviceObject for the volume.  If that DeviceObject is different, and</span>
01995         <span class="comment">//  it specifies the FastIo routine, then we have to return FALSE here and cause</span>
01996         <span class="comment">//  an Irp to get generated.</span>
01997         <span class="comment">//</span>
01998 
01999         VolumeDeviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a68">IoGetBaseFileSystemDeviceObject</a>( FileObject );
02000         <span class="keywordflow">if</span> ((VolumeDeviceObject != DeviceObject) &amp;&amp;
02001             (FastIoDispatch = VolumeDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o10">FastIoDispatch</a>) &amp;&amp;
02002             (FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o0">SizeOfFastIoDispatch</a> &gt; FIELD_OFFSET(<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">FAST_IO_DISPATCH</a>, MdlWriteComplete)) &amp;&amp;
02003             (FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o19">MdlWriteComplete</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
02004 
02005             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02006 
02007         <span class="comment">//</span>
02008         <span class="comment">//  Otherwise, call the default routine.</span>
02009         <span class="comment">//</span>
02010 
02011         } <span class="keywordflow">else</span> {
02012 
02013             <span class="keywordflow">return</span> <a class="code" href="../../d1/d8/fsrtl_8h.html#a102">FsRtlMdlWriteCompleteDev</a>( FileObject, FileOffset, MdlChain, DeviceObject );
02014         }
02015     }
02016 }
02017 
02018 
02019 BOOLEAN
<a name="l02020"></a><a class="code" href="../../d1/d8/fsrtl_8h.html#a102">02020</a> <a class="code" href="../../d1/d8/fsrtl_8h.html#a102">FsRtlMdlWriteCompleteDev</a> (
02021     IN <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject,
02022     IN PLARGE_INTEGER FileOffset,
02023     IN <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> MdlChain,
02024     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject
02025     )
02026 
02027 <span class="comment">/*++</span>
02028 <span class="comment"></span>
02029 <span class="comment">Routine Description:</span>
02030 <span class="comment"></span>
02031 <span class="comment">    This routine completes an Mdl write.</span>
02032 <span class="comment"></span>
02033 <span class="comment">Arguments:</span>
02034 <span class="comment"></span>
02035 <span class="comment">    FileObject - Pointer to the file object being read.</span>
02036 <span class="comment"></span>
02037 <span class="comment">    MdlChain - Supplies a pointer to an MDL chain returned from CcMdlPrepareMdlWrite.</span>
02038 <span class="comment"></span>
02039 <span class="comment">    DeviceObject - Supplies the DeviceObject for the callee.</span>
02040 <span class="comment"></span>
02041 <span class="comment">Return Value:</span>
02042 <span class="comment"></span>
02043 <span class="comment"></span>
02044 <span class="comment"></span>
02045 <span class="comment">--*/</span>
02046 
02047 
02048 {
02049     <span class="comment">//</span>
02050     <span class="comment">//  Do not support WRITE_THROUGH in the fast path call.</span>
02051     <span class="comment">//</span>
02052 
02053     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( FileObject-&gt;Flags, <a class="code" href="../../d0/d5/io_8h.html#a154">FO_WRITE_THROUGH</a> )) {
02054         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02055     }
02056 
02057     <a class="code" href="../../d4/d2/cache_8h.html#a83">CcMdlWriteComplete2</a>( FileObject, FileOffset, MdlChain );
02058     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02059 }
02060 
02061 
02062 <a class="code" href="../../d0/d9/ntosdef_8h.html#a29">NTKERNELAPI</a>
02063 BOOLEAN
<a name="l02064"></a><a class="code" href="../../d1/d8/fsrtl_8h.html#a103">02064</a> <a class="code" href="../../d1/d8/fsrtl_8h.html#a103">FsRtlAcquireFileForModWrite</a> (
02065     IN <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject,
02066     IN PLARGE_INTEGER EndingOffset,
02067     OUT <a class="code" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> *ResourceToRelease
02068     )
02069 
02070 <span class="comment">/*++</span>
02071 <span class="comment"></span>
02072 <span class="comment">Routine Description:</span>
02073 <span class="comment"></span>
02074 <span class="comment">    This routine decides which file system resource the modified page</span>
02075 <span class="comment">    writer should acquire and acquires it if possible.  Wait is always</span>
02076 <span class="comment">    specified as FALSE.  We pass back the resource Mm has to release</span>
02077 <span class="comment">    when the write completes.</span>
02078 <span class="comment"></span>
02079 <span class="comment">Arguments:</span>
02080 <span class="comment"></span>
02081 <span class="comment">    FileObject - Pointer to the file object being written.</span>
02082 <span class="comment"></span>
02083 <span class="comment">    EndingOffset - The offset of the last byte being written + 1.</span>
02084 <span class="comment"></span>
02085 <span class="comment">    ByteCount - Length of data in bytes.</span>
02086 <span class="comment"></span>
02087 <span class="comment">    ResourceToRelease - Returns the resource to release.  Not defined if</span>
02088 <span class="comment">        FALSE is returned.</span>
02089 <span class="comment"></span>
02090 <span class="comment">Return Value:</span>
02091 <span class="comment"></span>
02092 <span class="comment">    FALSE - The resource could not be acquired without waiting.</span>
02093 <span class="comment"></span>
02094 <span class="comment">    TRUE - The returned resource has been acquired.</span>
02095 <span class="comment"></span>
02096 <span class="comment">--*/</span>
02097 
02098 {
02099     <a class="code" href="../../d1/d1/struct__FSRTL__COMMON__FCB__HEADER.html">PFSRTL_COMMON_FCB_HEADER</a> <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>;
02100     <a class="code" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> ResourceAcquired;
02101     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject;
02102     <a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">PFAST_IO_DISPATCH</a> FastIoDispatch;
02103 
02104     BOOLEAN <a class="code" href="../../d3/d8/udfprocs_8h.html#a264a119">AcquireExclusive</a>;
02105 
02106     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02107 
02108     <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a> = (<a class="code" href="../../d1/d1/struct__FSRTL__COMMON__FCB__HEADER.html">PFSRTL_COMMON_FCB_HEADER</a>)FileObject-&gt;FsContext;
02109 
02110     <span class="comment">//</span>
02111     <span class="comment">//  First see if we have to call the file system.</span>
02112     <span class="comment">//</span>
02113 
02114     DeviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a68">IoGetBaseFileSystemDeviceObject</a>( FileObject );
02115 
02116     FastIoDispatch = DeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o10">FastIoDispatch</a>;
02117     <span class="keywordflow">if</span> ((FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o0">SizeOfFastIoDispatch</a> &gt;
02118          FIELD_OFFSET( <a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">FAST_IO_DISPATCH</a>, AcquireForModWrite )) &amp;&amp;
02119         (FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o15">AcquireForModWrite</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
02120 
02121         <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02122 
02123         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o15">AcquireForModWrite</a>(FileObject,
02124                                                   EndingOffset,
02125                                                   ResourceToRelease,
02126                                                   DeviceObject);
02127 
02128         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS) {
02129             <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
02130         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_CANT_WAIT) {
02131             <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
02132         } <span class="keywordflow">else</span> {
02133 
02134             <span class="comment">//</span>
02135             <span class="comment">// Fall through. When dealing with layered file systems, it might</span>
02136             <span class="comment">// be the case that the layered file system has the above dispatch</span>
02137             <span class="comment">// routine, but the FS it is layered on top of does not. In that</span>
02138             <span class="comment">// case, the layered file system will return an error code other</span>
02139             <span class="comment">// than STATUS_SUCCESS or STATUS_CANT_WAIT, and we simply handle</span>
02140             <span class="comment">// it as if the file system did not have the dispatch routine to</span>
02141             <span class="comment">// begin with.</span>
02142             <span class="comment">//</span>
02143 
02144             NOTHING;
02145         }
02146     }
02147 
02148     <span class="comment">//</span>
02149     <span class="comment">//  We follow the following rules to determine which resource</span>
02150     <span class="comment">//  to acquire.  We use the flags in the common header.  These</span>
02151     <span class="comment">//  flags can't change once we have acquired any resource.</span>
02152     <span class="comment">//  This means we can do an unsafe test and optimisticly</span>
02153     <span class="comment">//  acquire a resource.  At that point we can test the bits</span>
02154     <span class="comment">//  to see if we have what we want.</span>
02155     <span class="comment">//</span>
02156     <span class="comment">//  0 - If there is no main resource, acquire nothing.</span>
02157     <span class="comment">//</span>
02158     <span class="comment">//  1 - Acquire the main resource exclusively if the</span>
02159     <span class="comment">//      ACQUIRE_MAIN_RSRC_EX flag is set or we are extending</span>
02160     <span class="comment">//      valid data.</span>
02161     <span class="comment">//</span>
02162     <span class="comment">//  2 - Acquire the main resource shared if there is</span>
02163     <span class="comment">//      no paging io resource or the</span>
02164     <span class="comment">//      ACQUIRE_MAIN_RSRC_SH flag is set.</span>
02165     <span class="comment">//</span>
02166     <span class="comment">//  3 - Otherwise acquire the paging io resource shared.</span>
02167     <span class="comment">//</span>
02168 
02169     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02170 
02171         *ResourceToRelease = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02172 
02173         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02174     }
02175 
02176     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Flags, <a class="code" href="../../d1/d8/fsrtl_8h.html#a3">FSRTL_FLAG_ACQUIRE_MAIN_RSRC_EX</a> ) ||
02177         (EndingOffset-&gt;QuadPart &gt; <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength.QuadPart &amp;&amp;
02178          <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength.QuadPart != <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize.QuadPart)) {
02179 
02180         ResourceAcquired = <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource;
02181         <a class="code" href="../../d3/d8/udfprocs_8h.html#a264a119">AcquireExclusive</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02182 
02183     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Flags, <a class="code" href="../../d1/d8/fsrtl_8h.html#a4">FSRTL_FLAG_ACQUIRE_MAIN_RSRC_SH</a> ) ||
02184                <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02185 
02186         ResourceAcquired = <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource;
02187         <a class="code" href="../../d3/d8/udfprocs_8h.html#a264a119">AcquireExclusive</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02188 
02189     } <span class="keywordflow">else</span> {
02190 
02191         ResourceAcquired = <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource;
02192         <a class="code" href="../../d3/d8/udfprocs_8h.html#a264a119">AcquireExclusive</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02193     }
02194 
02195     <span class="comment">//</span>
02196     <span class="comment">//  Perform the following in a loop in case we need to back and</span>
02197     <span class="comment">//  check the state of the resource acquisition.  In most cases</span>
02198     <span class="comment">//  the initial checks will succeed and we can proceed immediately.</span>
02199     <span class="comment">//  We have to worry about the two FsRtl bits changing but</span>
02200     <span class="comment">//  if there is no paging io resource before there won't ever be</span>
02201     <span class="comment">//  one.</span>
02202     <span class="comment">//</span>
02203 
02204     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02205 
02206         <span class="comment">//</span>
02207         <span class="comment">//  Now acquire the desired resource.</span>
02208         <span class="comment">//</span>
02209 
02210         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/udfprocs_8h.html#a264a119">AcquireExclusive</a>) {
02211 
02212             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>( ResourceAcquired, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> )) {
02213 
02214                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02215             }
02216 
02217         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d8/ex_8h.html#a271">ExAcquireSharedWaitForExclusive</a>( ResourceAcquired, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> )) {
02218 
02219             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02220         }
02221 
02222         <span class="comment">//</span>
02223         <span class="comment">//  If the valid data length is changing or the exclusive bit is</span>
02224         <span class="comment">//  set and we don't have the main resource exclusive then</span>
02225         <span class="comment">//  release the current resource and acquire the main resource</span>
02226         <span class="comment">//  exclusively and move to the top of the loop.</span>
02227         <span class="comment">//</span>
02228 
02229         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Flags, <a class="code" href="../../d1/d8/fsrtl_8h.html#a3">FSRTL_FLAG_ACQUIRE_MAIN_RSRC_EX</a> ) ||
02230             (EndingOffset-&gt;QuadPart &gt; <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength.QuadPart &amp;&amp;
02231              <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ValidDataLength.QuadPart != <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FileSize.QuadPart)) {
02232 
02233             <span class="comment">//</span>
02234             <span class="comment">//  If we don't have the main resource exclusively then</span>
02235             <span class="comment">//  release the current resource and attempt to acquire</span>
02236             <span class="comment">//  the main resource exclusively.</span>
02237             <span class="comment">//</span>
02238 
02239             <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d8/udfprocs_8h.html#a264a119">AcquireExclusive</a>) {
02240 
02241                 <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( ResourceAcquired );
02242                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a264a119">AcquireExclusive</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02243                 ResourceAcquired = <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource;
02244                 <span class="keywordflow">continue</span>;
02245             }
02246 
02247             <span class="comment">//</span>
02248             <span class="comment">//  We have the correct resource.  Exit the loop.</span>
02249             <span class="comment">//</span>
02250 
02251         <span class="comment">//</span>
02252         <span class="comment">//  If we should be acquiring the main resource shared then move</span>
02253         <span class="comment">//  to acquire the correct resource and proceed to the top of the loop.</span>
02254         <span class="comment">//</span>
02255 
02256         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Flags, <a class="code" href="../../d1/d8/fsrtl_8h.html#a4">FSRTL_FLAG_ACQUIRE_MAIN_RSRC_SH</a> )) {
02257 
02258             <span class="comment">//</span>
02259             <span class="comment">//  If we have the main resource exclusively then downgrade to</span>
02260             <span class="comment">//  shared and exit the loop.</span>
02261             <span class="comment">//</span>
02262 
02263             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/udfprocs_8h.html#a264a119">AcquireExclusive</a>) {
02264 
02265                 <a class="code" href="../../d5/d8/ex_8h.html#a72">ExConvertExclusiveToShared</a>( ResourceAcquired );
02266 
02267             <span class="comment">//</span>
02268             <span class="comment">//  If we have the paging io resource then give up this resource</span>
02269             <span class="comment">//  and acquire the main resource exclusively.  This is going</span>
02270             <span class="comment">//  at it with a large hammer but is guaranteed to be resolved</span>
02271             <span class="comment">//  in the next pass through the loop.</span>
02272             <span class="comment">//</span>
02273 
02274             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ResourceAcquired != <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource) {
02275 
02276                 <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( ResourceAcquired );
02277                 ResourceAcquired = <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource;
02278                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a264a119">AcquireExclusive</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02279                 <span class="keywordflow">continue</span>;
02280             }
02281 
02282             <span class="comment">//</span>
02283             <span class="comment">//  We have the correct resource.  Exit the loop.</span>
02284             <span class="comment">//</span>
02285 
02286         <span class="comment">//</span>
02287         <span class="comment">//  At this point we should have the paging Io resource shared</span>
02288         <span class="comment">//  if it exists.  If not then acquire it shared and release the</span>
02289         <span class="comment">//  other resource and exit the loop.</span>
02290         <span class="comment">//</span>
02291 
02292         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02293                    &amp;&amp; ResourceAcquired != <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource) {
02294 
02295             ResourceAcquired = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02296 
02297             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d8/ex_8h.html#a271">ExAcquireSharedWaitForExclusive</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> )) {
02298 
02299                 ResourceAcquired = <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource;
02300             }
02301 
02302             <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource );
02303 
02304             <span class="keywordflow">if</span> (ResourceAcquired == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02305 
02306                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02307             }
02308 
02309             <span class="comment">//</span>
02310             <span class="comment">//  We now have the correct resource.  Exit the loop.</span>
02311             <span class="comment">//</span>
02312 
02313         <span class="comment">//</span>
02314         <span class="comment">//  We should have the main resource shared.  If we don't then</span>
02315         <span class="comment">//  degrade our lock to shared access.</span>
02316         <span class="comment">//</span>
02317 
02318         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/udfprocs_8h.html#a264a119">AcquireExclusive</a>) {
02319 
02320             <a class="code" href="../../d5/d8/ex_8h.html#a72">ExConvertExclusiveToShared</a>( ResourceAcquired );
02321 
02322             <span class="comment">//</span>
02323             <span class="comment">//  We now have the correct resource.  Exit the loop.</span>
02324             <span class="comment">//</span>
02325         }
02326 
02327         <span class="comment">//</span>
02328         <span class="comment">//  We have the correct resource.  Exit the loop.</span>
02329         <span class="comment">//</span>
02330 
02331         <span class="keywordflow">break</span>;
02332     }
02333 
02334     *ResourceToRelease = ResourceAcquired;
02335 
02336     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02337 }
02338 
02339 
02340 <a class="code" href="../../d0/d9/ntosdef_8h.html#a29">NTKERNELAPI</a>
02341 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02342"></a><a class="code" href="../../d1/d8/fsrtl_8h.html#a104">02342</a> <a class="code" href="../../d1/d8/fsrtl_8h.html#a104">FsRtlReleaseFileForModWrite</a> (
02343     IN <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject,
02344     IN <a class="code" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> ResourceToRelease
02345     )
02346 
02347 <span class="comment">/*++</span>
02348 <span class="comment"></span>
02349 <span class="comment">Routine Description:</span>
02350 <span class="comment"></span>
02351 <span class="comment">    This routine releases a file system resource previously acquired for</span>
02352 <span class="comment">    the modified page writer.</span>
02353 <span class="comment"></span>
02354 <span class="comment">Arguments:</span>
02355 <span class="comment"></span>
02356 <span class="comment">    FileObject - Pointer to the file object being written.</span>
02357 <span class="comment"></span>
02358 <span class="comment">    ResourceToRelease - Supplies the resource to release.  Not defined if</span>
02359 <span class="comment">        FALSE is returned.</span>
02360 <span class="comment"></span>
02361 <span class="comment">Return Value:</span>
02362 <span class="comment"></span>
02363 <span class="comment">    None.</span>
02364 <span class="comment"></span>
02365 <span class="comment">--*/</span>
02366 
02367 {
02368     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject;
02369     <a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">PFAST_IO_DISPATCH</a> FastIoDispatch;
02370     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_DEVICE_REQUEST;
02371 
02372     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02373 
02374     <span class="comment">//</span>
02375     <span class="comment">//  First see if we have to call the file system. Note that in the case</span>
02376     <span class="comment">//  of layered file systems, the layered file system might have the</span>
02377     <span class="comment">//  dispatch routine, but the file system on which it is layered on may</span>
02378     <span class="comment">//  not. In that case, the layered file system will return</span>
02379     <span class="comment">//  STATUS_INVALID_DEVICE_REQUEST.</span>
02380     <span class="comment">//</span>
02381 
02382     DeviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a68">IoGetBaseFileSystemDeviceObject</a>( FileObject );
02383 
02384     FastIoDispatch = DeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o10">FastIoDispatch</a>;
02385     <span class="keywordflow">if</span> ((FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o0">SizeOfFastIoDispatch</a> &gt;
02386          FIELD_OFFSET( <a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">FAST_IO_DISPATCH</a>, ReleaseForModWrite )) &amp;&amp;
02387         (FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o25">ReleaseForModWrite</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
02388 
02389         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o25">ReleaseForModWrite</a>( FileObject, ResourceToRelease, DeviceObject );
02390     }
02391 
02392     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS) || (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_INVALID_DEVICE_REQUEST) );
02393 
02394     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_INVALID_DEVICE_REQUEST) {
02395         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( ResourceToRelease );
02396     }
02397 }
02398 
02399 
02400 <a class="code" href="../../d0/d9/ntosdef_8h.html#a29">NTKERNELAPI</a>
02401 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02402"></a><a class="code" href="../../d1/d8/fsrtl_8h.html#a105">02402</a> <a class="code" href="../../d1/d8/fsrtl_8h.html#a105">FsRtlAcquireFileForCcFlush</a> (
02403     IN <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject
02404     )
02405 
02406 <span class="comment">/*++</span>
02407 <span class="comment"></span>
02408 <span class="comment">Routine Description:</span>
02409 <span class="comment"></span>
02410 <span class="comment">    This routine acquires a file system resource prior to a call to CcFlush.</span>
02411 <span class="comment"></span>
02412 <span class="comment">Arguments:</span>
02413 <span class="comment"></span>
02414 <span class="comment">    FileObject - Pointer to the file object being written.</span>
02415 <span class="comment"></span>
02416 <span class="comment">Return Value:</span>
02417 <span class="comment"></span>
02418 <span class="comment">    None.</span>
02419 <span class="comment"></span>
02420 <span class="comment">--*/</span>
02421 
02422 {
02423     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject;
02424     <a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">PFAST_IO_DISPATCH</a> FastIoDispatch;
02425     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_DEVICE_REQUEST;
02426 
02427     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02428 
02429     <span class="comment">//</span>
02430     <span class="comment">//  First see if we have to call the file system. Note that in the case</span>
02431     <span class="comment">//  of layered file systems, the layered file system might have the</span>
02432     <span class="comment">//  dispatch routine, but the file system on which it is layered on may</span>
02433     <span class="comment">//  not. In that case, the layered file system will return</span>
02434     <span class="comment">//  STATUS_INVALID_DEVICE_REQUEST.</span>
02435     <span class="comment">//</span>
02436 
02437     DeviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a68">IoGetBaseFileSystemDeviceObject</a>( FileObject );
02438 
02439     <a class="code" href="../../d1/d8/fsrtl_8h.html#a48">FsRtlEnterFileSystem</a>();
02440 
02441     <span class="keywordflow">if</span> ((FastIoDispatch = DeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o10">FastIoDispatch</a>) &amp;&amp;
02442         (FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o0">SizeOfFastIoDispatch</a> &gt;
02443          FIELD_OFFSET( <a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">FAST_IO_DISPATCH</a>, AcquireForCcFlush )) &amp;&amp;
02444         (FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o26">AcquireForCcFlush</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
02445 
02446         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o26">AcquireForCcFlush</a>( FileObject, DeviceObject );
02447 
02448     }
02449 
02450 
02451     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS) || (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_INVALID_DEVICE_REQUEST) );
02452 
02453     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_INVALID_DEVICE_REQUEST) {
02454 
02455         <a class="code" href="../../d1/d1/struct__FSRTL__COMMON__FCB__HEADER.html">PFSRTL_COMMON_FCB_HEADER</a> <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a> = FileObject-&gt;FsContext;
02456 
02457         <span class="comment">//</span>
02458         <span class="comment">//  If not already owned get the main resource exclusive because me may</span>
02459         <span class="comment">//  extend ValidDataLength.  Otherwise acquire it one more time recursively.</span>
02460         <span class="comment">//</span>
02461 
02462         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02463             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d8/ex_8h.html#a75">ExIsResourceAcquiredShared</a>(<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource)) {
02464                 <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
02465             } <span class="keywordflow">else</span> {
02466                 <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
02467             }
02468         }
02469 
02470         <span class="comment">//</span>
02471         <span class="comment">//  Also get the paging I/O resource ahead of any MM resources.</span>
02472         <span class="comment">//</span>
02473 
02474         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02475             <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
02476         }
02477     }
02478 }
02479 
02480 
02481 <a class="code" href="../../d0/d9/ntosdef_8h.html#a29">NTKERNELAPI</a>
02482 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02483"></a><a class="code" href="../../d1/d8/fsrtl_8h.html#a106">02483</a> <a class="code" href="../../d1/d8/fsrtl_8h.html#a106">FsRtlReleaseFileForCcFlush</a> (
02484     IN <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject
02485     )
02486 
02487 <span class="comment">/*++</span>
02488 <span class="comment"></span>
02489 <span class="comment">Routine Description:</span>
02490 <span class="comment"></span>
02491 <span class="comment">    This routine releases a file system resource previously acquired for</span>
02492 <span class="comment">    the CcFlush.</span>
02493 <span class="comment"></span>
02494 <span class="comment">Arguments:</span>
02495 <span class="comment"></span>
02496 <span class="comment">    FileObject - Pointer to the file object being written.</span>
02497 <span class="comment"></span>
02498 <span class="comment">Return Value:</span>
02499 <span class="comment"></span>
02500 <span class="comment">    None.</span>
02501 <span class="comment"></span>
02502 <span class="comment">--*/</span>
02503 
02504 {
02505     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject;
02506     <a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">PFAST_IO_DISPATCH</a> FastIoDispatch;
02507     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_DEVICE_REQUEST;
02508 
02509     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02510 
02511     <span class="comment">//</span>
02512     <span class="comment">//  First see if we have to call the file system. Note that in the case</span>
02513     <span class="comment">//  of layered file systems, the layered file system might have the</span>
02514     <span class="comment">//  dispatch routine, but the file system on which it is layered on may</span>
02515     <span class="comment">//  not. In that case, the layered file system will return</span>
02516     <span class="comment">//  STATUS_INVALID_DEVICE_REQUEST.</span>
02517     <span class="comment">//</span>
02518 
02519     DeviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a68">IoGetBaseFileSystemDeviceObject</a>( FileObject );
02520 
02521     <span class="keywordflow">if</span> ((FastIoDispatch = DeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o10">FastIoDispatch</a>) &amp;&amp;
02522         (FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o0">SizeOfFastIoDispatch</a> &gt;
02523          FIELD_OFFSET( <a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">FAST_IO_DISPATCH</a>, ReleaseForCcFlush )) &amp;&amp;
02524         (FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o27">ReleaseForCcFlush</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
02525 
02526         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o27">ReleaseForCcFlush</a>( FileObject, DeviceObject );
02527 
02528     }
02529 
02530     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS) || (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_INVALID_DEVICE_REQUEST) );
02531 
02532     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_INVALID_DEVICE_REQUEST) {
02533 
02534         <a class="code" href="../../d1/d1/struct__FSRTL__COMMON__FCB__HEADER.html">PFSRTL_COMMON_FCB_HEADER</a> <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a> = FileObject-&gt;FsContext;
02535 
02536         <span class="comment">//</span>
02537         <span class="comment">//  Free whatever we acquired.</span>
02538         <span class="comment">//</span>
02539 
02540         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02541             <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;PagingIoResource );
02542         }
02543 
02544         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02545             <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource );
02546         }
02547     }
02548 
02549     <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
02550 }
02551 
02552 
02553 <a class="code" href="../../d0/d9/ntosdef_8h.html#a29">NTKERNELAPI</a>
02554 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02555"></a><a class="code" href="../../d1/d8/fsrtl_8h.html#a107">02555</a> <a class="code" href="../../d1/d8/fsrtl_8h.html#a107">FsRtlAcquireFileExclusive</a> (
02556     IN <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject
02557     )
02558 
02559 <span class="comment">/*++</span>
02560 <span class="comment"></span>
02561 <span class="comment">Routine Description:</span>
02562 <span class="comment"></span>
02563 <span class="comment">    This routine is used by NtCreateSection to pre-acquire file system</span>
02564 <span class="comment">    resources in order to avoid deadlocks.  If there is a FastIo entry</span>
02565 <span class="comment">    for AcquireFileForNtCreateSection then that routine will be called.</span>
02566 <span class="comment">    Otherwise, we will simply acquire the main file resource exclusive.</span>
02567 <span class="comment">    If there is no main resource then we acquire nothing and return</span>
02568 <span class="comment">    FALSE.  In the cases that we acquire a resource, we also set the</span>
02569 <span class="comment">    TopLevelIrp field in the thread local storage to indicate to file</span>
02570 <span class="comment">    systems beneath us that we have acquired file system resources.</span>
02571 <span class="comment"></span>
02572 <span class="comment">Arguments:</span>
02573 <span class="comment"></span>
02574 <span class="comment">    FileObject - Pointer to the file object being written.</span>
02575 <span class="comment"></span>
02576 <span class="comment">Return Value:</span>
02577 <span class="comment"></span>
02578 <span class="comment">    NONE</span>
02579 <span class="comment"></span>
02580 <span class="comment">--*/</span>
02581 
02582 {
02583     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject;
02584     <a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">PFAST_IO_DISPATCH</a> FastIoDispatch;
02585     <a class="code" href="../../d1/d1/struct__FSRTL__COMMON__FCB__HEADER.html">PFSRTL_COMMON_FCB_HEADER</a> <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>;
02586 
02587     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02588 
02589     <span class="comment">//</span>
02590     <span class="comment">//  First see if we have to call the file system.</span>
02591     <span class="comment">//</span>
02592 
02593     DeviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a68">IoGetBaseFileSystemDeviceObject</a>( FileObject );
02594 
02595     <span class="keywordflow">if</span> ((FastIoDispatch = DeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o10">FastIoDispatch</a>) &amp;&amp;
02596         (FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o0">SizeOfFastIoDispatch</a> &gt;
02597          FIELD_OFFSET( <a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">FAST_IO_DISPATCH</a>, AcquireFileForNtCreateSection )) &amp;&amp;
02598         (FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o11">AcquireFileForNtCreateSection</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
02599 
02600         <a class="code" href="../../d1/d8/fsrtl_8h.html#a48">FsRtlEnterFileSystem</a>();
02601         FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o11">AcquireFileForNtCreateSection</a>( FileObject );
02602 
02603         <span class="keywordflow">return</span>;
02604     }
02605 
02606     <span class="comment">//</span>
02607     <span class="comment">//  If there is a main file resource, acquire that.</span>
02608     <span class="comment">//</span>
02609 
02610     <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a> = (<a class="code" href="../../d1/d1/struct__FSRTL__COMMON__FCB__HEADER.html">PFSRTL_COMMON_FCB_HEADER</a>)FileObject-&gt;FsContext) &amp;&amp;
02611         (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
02612 
02613         <a class="code" href="../../d1/d8/fsrtl_8h.html#a48">FsRtlEnterFileSystem</a>();
02614         <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
02615 
02616         <span class="keywordflow">return</span>;
02617     }
02618 
02619     <span class="comment">//</span>
02620     <span class="comment">//  Nothing to acquire.</span>
02621     <span class="comment">//</span>
02622 
02623     <span class="keywordflow">return</span>;
02624 }
02625 
02626 <a class="code" href="../../d0/d9/ntosdef_8h.html#a29">NTKERNELAPI</a>
02627 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02628"></a><a class="code" href="../../d1/d8/fsrtl_8h.html#a108">02628</a> <a class="code" href="../../d1/d8/fsrtl_8h.html#a108">FsRtlReleaseFile</a> (
02629     IN <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject
02630     )
02631 
02632 <span class="comment">/*++</span>
02633 <span class="comment"></span>
02634 <span class="comment">Routine Description:</span>
02635 <span class="comment"></span>
02636 <span class="comment">    This routine releases resources acquired by FsRtlAcquireFileExclusive.</span>
02637 <span class="comment"></span>
02638 <span class="comment">Arguments:</span>
02639 <span class="comment"></span>
02640 <span class="comment">    FileObject - Pointer to the file object being written.</span>
02641 <span class="comment"></span>
02642 <span class="comment">Return Value:</span>
02643 <span class="comment"></span>
02644 <span class="comment">    None.</span>
02645 <span class="comment"></span>
02646 <span class="comment">--*/</span>
02647 
02648 {
02649     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject;
02650     <a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">PFAST_IO_DISPATCH</a> FastIoDispatch;
02651     <a class="code" href="../../d1/d1/struct__FSRTL__COMMON__FCB__HEADER.html">PFSRTL_COMMON_FCB_HEADER</a> <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>;
02652 
02653     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02654 
02655     <span class="comment">//</span>
02656     <span class="comment">//  First see if we have to call the file system.</span>
02657     <span class="comment">//</span>
02658 
02659     DeviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a68">IoGetBaseFileSystemDeviceObject</a>( FileObject );
02660 
02661     <span class="keywordflow">if</span> ((FastIoDispatch = DeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o10">FastIoDispatch</a>) &amp;&amp;
02662         (FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o0">SizeOfFastIoDispatch</a> &gt;
02663          FIELD_OFFSET( <a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">FAST_IO_DISPATCH</a>, ReleaseFileForNtCreateSection )) &amp;&amp;
02664         (FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o12">ReleaseFileForNtCreateSection</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
02665 
02666         FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o12">ReleaseFileForNtCreateSection</a>( FileObject );
02667         <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
02668         <span class="keywordflow">return</span>;
02669     }
02670 
02671     <span class="comment">//</span>
02672     <span class="comment">//  If there is a main file resource, release that.</span>
02673     <span class="comment">//</span>
02674 
02675     <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a> = (<a class="code" href="../../d1/d1/struct__FSRTL__COMMON__FCB__HEADER.html">PFSRTL_COMMON_FCB_HEADER</a>)FileObject-&gt;FsContext) &amp;&amp;
02676         (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
02677 
02678         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Resource );
02679         <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
02680         <span class="keywordflow">return</span>;
02681     }
02682 
02683     <span class="comment">//</span>
02684     <span class="comment">//  Nothing to release.</span>
02685     <span class="comment">//</span>
02686 
02687     <span class="keywordflow">return</span>;
02688 }
02689 
02690 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02691"></a><a class="code" href="../../d1/d8/fsrtl_8h.html#a109">02691</a> <a class="code" href="../../d1/d8/fsrtl_8h.html#a109">FsRtlGetFileSize</a>(
02692     IN <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject,
02693     IN OUT PLARGE_INTEGER FileSize
02694     )
02695 
02696 <span class="comment">/*++</span>
02697 <span class="comment"></span>
02698 <span class="comment">Routine Description:</span>
02699 <span class="comment"></span>
02700 <span class="comment">    This routine is used to call the File System to get the FileSize</span>
02701 <span class="comment">    for a file.</span>
02702 <span class="comment"></span>
02703 <span class="comment">    It does this without acquiring the file object lock on synchronous file</span>
02704 <span class="comment">    objects.  This routine is therefore safe to call if you already own</span>
02705 <span class="comment">    file system resources, while IoQueryFileInformation could (and does)</span>
02706 <span class="comment">    lead to deadlocks.</span>
02707 <span class="comment"></span>
02708 <span class="comment">Arguments:</span>
02709 <span class="comment"></span>
02710 <span class="comment">    FileObject - The file to query</span>
02711 <span class="comment">    FileSize - Receives the file size.</span>
02712 <span class="comment"></span>
02713 <span class="comment">Return Value:</span>
02714 <span class="comment"></span>
02715 <span class="comment">    NTSTATUS - The final I/O status of the operation.  If the FileObject</span>
02716 <span class="comment">        refers to a directory, STATUS_FILE_IS_A_DIRECTORY is returned.</span>
02717 <span class="comment"></span>
02718 <span class="comment">--*/</span>
02719 {
02720     IO_STATUS_BLOCK IoStatus;
02721     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject;
02722     <a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">PFAST_IO_DISPATCH</a> FastIoDispatch;
02723     FILE_STANDARD_INFORMATION FileInformation;
02724 
02725     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02726 
02727     <span class="comment">//</span>
02728     <span class="comment">// Get the address of the target device object.</span>
02729     <span class="comment">//</span>
02730 
02731     DeviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( FileObject );
02732 
02733     <span class="comment">//</span>
02734     <span class="comment">// Try the fast query call if it exists.</span>
02735     <span class="comment">//</span>
02736 
02737     FastIoDispatch = DeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o10">FastIoDispatch</a>;
02738 
02739     <span class="keywordflow">if</span> (FastIoDispatch &amp;&amp;
02740         FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o5">FastIoQueryStandardInfo</a> &amp;&amp;
02741         FastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o5">FastIoQueryStandardInfo</a>( FileObject,
02742                                                  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
02743                                                  &amp;FileInformation,
02744                                                  &amp;IoStatus,
02745                                                  DeviceObject )) {
02746         <span class="comment">//</span>
02747         <span class="comment">//  Cool, it worked.</span>
02748         <span class="comment">//</span>
02749 
02750     } <span class="keywordflow">else</span> {
02751 
02752         <span class="comment">//</span>
02753         <span class="comment">//  Life's tough, take the long path.</span>
02754         <span class="comment">//</span>
02755 
02756         <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>;
02757         <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
02758         <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02759         <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp;
02760 
02761         <span class="comment">//</span>
02762         <span class="comment">//  Initialize the event.</span>
02763         <span class="comment">//</span>
02764 
02765         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>, NotificationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
02766 
02767         <span class="comment">//</span>
02768         <span class="comment">//  Allocate an I/O Request Packet (IRP) for this in-page operation.</span>
02769         <span class="comment">//</span>
02770 
02771         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> = <a class="code" href="../../d4/d6/iosubs_8c.html#a17">IoAllocateIrp</a>( DeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o13">StackSize</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
02772         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02773 
02774             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
02775         }
02776 
02777         <span class="comment">//</span>
02778         <span class="comment">//  Get a pointer to the first stack location in the packet.  This location</span>
02779         <span class="comment">//  will be used to pass the function codes and parameters to the first</span>
02780         <span class="comment">//  driver.</span>
02781         <span class="comment">//</span>
02782 
02783         IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
02784 
02785         <span class="comment">//</span>
02786         <span class="comment">//  Fill in the IRP according to this request, setting the flags to</span>
02787         <span class="comment">//  just cause IO to set the event and deallocate the Irp.</span>
02788         <span class="comment">//</span>
02789 
02790         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> = <a class="code" href="../../d0/d5/io_8h.html#a174">IRP_PAGING_IO</a> | <a class="code" href="../../d0/d5/io_8h.html#a181">IRP_SYNCHRONOUS_PAGING_IO</a>;
02791         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o10">RequestorMode</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>;
02792         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a> = &amp;IoStatus;
02793         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a> = &amp;<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
02794         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.OriginalFileObject = FileObject;
02795         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
02796         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer = &amp;FileInformation;
02797 
02798         <span class="comment">//</span>
02799         <span class="comment">//  Fill in the normal query parameters.</span>
02800         <span class="comment">//</span>
02801 
02802         IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a18">IRP_MJ_QUERY_INFORMATION</a>;
02803         IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a> = FileObject;
02804         IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o57">DeviceObject</a> = DeviceObject;
02805         IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.SetFile.Length = <span class="keyword">sizeof</span>(FILE_STANDARD_INFORMATION);
02806         IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.SetFile.FileInformationClass = FileStandardInformation;
02807 
02808         <span class="comment">//</span>
02809         <span class="comment">//  Queue the packet to the appropriate driver based.  This routine</span>
02810         <span class="comment">//  should not raise.</span>
02811         <span class="comment">//</span>
02812 
02813         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( DeviceObject, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
02814 
02815         <span class="comment">//</span>
02816         <span class="comment">//  If pending is returned (which is a successful status),</span>
02817         <span class="comment">//  we must wait for the request to complete.</span>
02818         <span class="comment">//</span>
02819 
02820         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_PENDING) {
02821             <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>,
02822                                    <a class="code" href="../../d6/d7/halmips_8h.html#a455">Executive</a>,
02823                                    <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
02824                                    <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
02825                                    (PLARGE_INTEGER)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02826         }
02827 
02828         <span class="comment">//</span>
02829         <span class="comment">//  If we got an error back in Status, then the Iosb</span>
02830         <span class="comment">//  was not written, so we will just copy the status</span>
02831         <span class="comment">//  there, then test the final status after that.</span>
02832         <span class="comment">//</span>
02833 
02834         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02835             IoStatus.Status = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02836         }
02837     }
02838 
02839     <span class="comment">//</span>
02840     <span class="comment">//  If the call worked, check to make sure it wasn't a directory and</span>
02841     <span class="comment">//  if not, fill in the FileSize parameter.</span>
02842     <span class="comment">//</span>
02843 
02844     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IoStatus.Status)) {
02845 
02846         <span class="keywordflow">if</span> (FileInformation.Directory) {
02847 
02848             <span class="comment">//</span>
02849             <span class="comment">// Can't get file size for a directory. Return error.</span>
02850             <span class="comment">//</span>
02851 
02852             IoStatus.Status = STATUS_FILE_IS_A_DIRECTORY;
02853 
02854         } <span class="keywordflow">else</span> {
02855 
02856             *FileSize = FileInformation.EndOfFile;
02857         }
02858     }
02859 
02860     <span class="keywordflow">return</span> IoStatus.Status;
02861 }
02862 
02863 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02864"></a><a class="code" href="../../d1/d8/fsrtl_8h.html#a110">02864</a> <a class="code" href="../../d1/d8/fsrtl_8h.html#a110">FsRtlSetFileSize</a>(
02865     IN <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject,
02866     IN OUT PLARGE_INTEGER FileSize
02867     )
02868 
02869 <span class="comment">/*++</span>
02870 <span class="comment"></span>
02871 <span class="comment">Routine Description:</span>
02872 <span class="comment"></span>
02873 <span class="comment">    This routine is used to call the File System to update FileSize</span>
02874 <span class="comment">    for a file.</span>
02875 <span class="comment"></span>
02876 <span class="comment">    It does this without acquiring the file object lock on synchronous file</span>
02877 <span class="comment">    objects.  This routine is therefore safe to call if you already own</span>
02878 <span class="comment">    file system resources, while IoSetInformation could (and does) lead</span>
02879 <span class="comment">    to deadlocks.</span>
02880 <span class="comment"></span>
02881 <span class="comment">Arguments:</span>
02882 <span class="comment"></span>
02883 <span class="comment">    FileObject - A pointer to a referenced file object.</span>
02884 <span class="comment"></span>
02885 <span class="comment">    ValidDataLength - Pointer to new FileSize.</span>
02886 <span class="comment"></span>
02887 <span class="comment">Return Value:</span>
02888 <span class="comment"></span>
02889 <span class="comment">    Status of operation.</span>
02890 <span class="comment"></span>
02891 <span class="comment">--*/</span>
02892 
02893 {
02894     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp;
02895     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject;
02896     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02897     FILE_END_OF_FILE_INFORMATION <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
02898     IO_STATUS_BLOCK IoStatus;
02899     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
02900     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>;
02901 
02902     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02903 
02904     <span class="comment">//</span>
02905     <span class="comment">//  Copy FileSize to our buffer.</span>
02906     <span class="comment">//</span>
02907 
02908     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>.EndOfFile = *FileSize;
02909 
02910     <span class="comment">//</span>
02911     <span class="comment">//  Initialize the event.</span>
02912     <span class="comment">//</span>
02913 
02914     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>, NotificationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
02915 
02916     <span class="comment">//</span>
02917     <span class="comment">//  Begin by getting a pointer to the device object that the file resides</span>
02918     <span class="comment">//  on.</span>
02919     <span class="comment">//</span>
02920 
02921     DeviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( FileObject );
02922 
02923     <span class="comment">//</span>
02924     <span class="comment">//  Allocate an I/O Request Packet (IRP) for this in-page operation.</span>
02925     <span class="comment">//</span>
02926 
02927     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> = <a class="code" href="../../d4/d6/iosubs_8c.html#a17">IoAllocateIrp</a>( DeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o13">StackSize</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
02928     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02929 
02930         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
02931     }
02932 
02933     <span class="comment">//</span>
02934     <span class="comment">//  Get a pointer to the first stack location in the packet.  This location</span>
02935     <span class="comment">//  will be used to pass the function codes and parameters to the first</span>
02936     <span class="comment">//  driver.</span>
02937     <span class="comment">//</span>
02938 
02939     IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
02940 
02941     <span class="comment">//</span>
02942     <span class="comment">//  Fill in the IRP according to this request, setting the flags to</span>
02943     <span class="comment">//  just cause IO to set the event and deallocate the Irp.</span>
02944     <span class="comment">//</span>
02945 
02946     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> = <a class="code" href="../../d0/d5/io_8h.html#a174">IRP_PAGING_IO</a> | <a class="code" href="../../d0/d5/io_8h.html#a181">IRP_SYNCHRONOUS_PAGING_IO</a>;
02947     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o10">RequestorMode</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>;
02948     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a> = &amp;IoStatus;
02949     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a> = &amp;<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
02950     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.OriginalFileObject = FileObject;
02951     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
02952     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer = &amp;<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
02953 
02954     <span class="comment">//</span>
02955     <span class="comment">//  Fill in the normal set file parameters.</span>
02956     <span class="comment">//</span>
02957 
02958     IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a19">IRP_MJ_SET_INFORMATION</a>;
02959     IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a> = FileObject;
02960     IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o57">DeviceObject</a> = DeviceObject;
02961     IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.SetFile.Length = <span class="keyword">sizeof</span>(FILE_END_OF_FILE_INFORMATION);
02962     IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.SetFile.FileInformationClass = FileEndOfFileInformation;
02963 
02964     <span class="comment">//</span>
02965     <span class="comment">//  Queue the packet to the appropriate driver based on whether or not there</span>
02966     <span class="comment">//  is a VPB associated with the device.  This routine should not raise.</span>
02967     <span class="comment">//</span>
02968 
02969     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( DeviceObject, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
02970 
02971     <span class="comment">//</span>
02972     <span class="comment">//  If pending is returned (which is a successful status),</span>
02973     <span class="comment">//  we must wait for the request to complete.</span>
02974     <span class="comment">//</span>
02975 
02976     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_PENDING) {
02977         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>,
02978                                <a class="code" href="../../d6/d7/halmips_8h.html#a455">Executive</a>,
02979                                <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
02980                                <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
02981                                (PLARGE_INTEGER)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02982     }
02983 
02984     <span class="comment">//</span>
02985     <span class="comment">//  If we got an error back in Status, then the Iosb</span>
02986     <span class="comment">//  was not written, so we will just copy the status</span>
02987     <span class="comment">//  there, then test the final status after that.</span>
02988     <span class="comment">//</span>
02989 
02990     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02991         IoStatus.Status = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02992     }
02993 
02994     <span class="keywordflow">return</span> IoStatus.Status;
02995 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:58 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
