<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: psctxalp.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>psctxalp.c File Reference</h1><code>#include "<a class="el" href="../../d9/d0/psp_8h-source.html">psp.h</a>"</code><br>

<p>
<a href="../../d5/d9/psctxalp_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d0/psctxalp_8c.html#a0">PspGetContext</a> (IN PKTRAP_FRAME TrapFrame, IN PKNONVOLATILE_CONTEXT_POINTERS ContextPointers, IN OUT PCONTEXT ContextRecord)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d0/psctxalp_8c.html#a1">PspSetContext</a> (IN OUT PKTRAP_FRAME TrapFrame, IN PKNONVOLATILE_CONTEXT_POINTERS ContextPointers, IN PCONTEXT ContextRecord, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> ProcessorMode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d0/psctxalp_8c.html#a2">PspGetSetContextSpecialApcMain</a> (IN <a class="el" href="../../d1/d5/struct__KAPC.html">PKAPC</a> Apc, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a> *NormalRoutine, IN PVOID *NormalContext, IN PVOID *SystemArgument1, IN PVOID *SystemArgument2)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a0" doxytag="psctxalp.c::PspGetContext" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID PspGetContext           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PKTRAP_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>TrapFrame</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PKNONVOLATILE_CONTEXT_POINTERS&nbsp;</td>
          <td class="mdname" nowrap> <em>ContextPointers</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>ContextRecord</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d9/psctxalp_8c-source.html#l00029">29</a> of file <a class="el" href="../../d5/d9/psctxalp_8c-source.html">psctxalp.c</a>.
<p>
<pre class="fragment"><div>00037                    :
00038 
00039     This function selectively moves <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> contents of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified trap frame
00040     and nonvolatile context to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified context record.
00041 
00042 Arguments:
00043 
00044     TrapFrame - Supplies a pointer to a trap frame.
00045 
00046     ContextPointers - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of context pointers record.
00047 
00048     ContextRecord - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of a context record.
00049 
00050 Return Value:
00051 
00052     None.
00053 
00054 --*/
00055 
00056 {
00057 
00058     <span class="comment">//</span>
00059     <span class="comment">// Get control information if specified.</span>
00060     <span class="comment">//</span>
00061 
00062     <span class="keywordflow">if</span> ((ContextRecord-&gt;ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a153">CONTEXT_CONTROL</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a153">CONTEXT_CONTROL</a>) {
00063 
00064         <span class="comment">//</span>
00065         <span class="comment">// Get integer registers gp, ra, sp, FIR, and PSR from trap frame.</span>
00066         <span class="comment">//</span>
00067 
00068         ContextRecord-&gt;IntGp = TrapFrame-&gt;IntGp;
00069         ContextRecord-&gt;IntSp = TrapFrame-&gt;IntSp;
00070         ContextRecord-&gt;IntRa = TrapFrame-&gt;IntRa;
00071         ContextRecord-&gt;Fir = TrapFrame-&gt;Fir;
00072         ContextRecord-&gt;Psr = TrapFrame-&gt;Psr;
00073     }
00074 
00075     <span class="comment">//</span>
00076     <span class="comment">// Get integer register contents if specified.</span>
00077     <span class="comment">//</span>
00078 
00079     <span class="keywordflow">if</span> ((ContextRecord-&gt;ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a155">CONTEXT_INTEGER</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a155">CONTEXT_INTEGER</a>) {
00080 
00081         <span class="comment">//</span>
00082         <span class="comment">// Get volatile integer registers v0 and t0 - t7 from trap frame.</span>
00083         <span class="comment">//</span>
00084 
00085         ContextRecord-&gt;IntV0 = TrapFrame-&gt;IntV0;
00086         ContextRecord-&gt;IntT0 = TrapFrame-&gt;IntT0;
00087         ContextRecord-&gt;IntT1 = TrapFrame-&gt;IntT1;
00088         ContextRecord-&gt;IntT2 = TrapFrame-&gt;IntT2;
00089         ContextRecord-&gt;IntT3 = TrapFrame-&gt;IntT3;
00090         ContextRecord-&gt;IntT4 = TrapFrame-&gt;IntT4;
00091         ContextRecord-&gt;IntT5 = TrapFrame-&gt;IntT5;
00092         ContextRecord-&gt;IntT6 = TrapFrame-&gt;IntT6;
00093         ContextRecord-&gt;IntT7 = TrapFrame-&gt;IntT7;
00094 
00095         <span class="comment">//</span>
00096         <span class="comment">// Get nonvolatile integer registers s0 - s5 through context pointers.</span>
00097         <span class="comment">//</span>
00098 
00099         ContextRecord-&gt;IntS0 = *ContextPointers-&gt;IntS0;
00100         ContextRecord-&gt;IntS1 = *ContextPointers-&gt;IntS1;
00101         ContextRecord-&gt;IntS2 = *ContextPointers-&gt;IntS2;
00102         ContextRecord-&gt;IntS3 = *ContextPointers-&gt;IntS3;
00103         ContextRecord-&gt;IntS4 = *ContextPointers-&gt;IntS4;
00104         ContextRecord-&gt;IntS5 = *ContextPointers-&gt;IntS5;
00105 
00106         <span class="comment">//</span>
00107         <span class="comment">// Get volatile integer registers fp/s6, a0 - a5, and t8 - t12 from</span>
00108         <span class="comment">// trap frame.</span>
00109         <span class="comment">//</span>
00110 
00111         ContextRecord-&gt;IntFp = TrapFrame-&gt;IntFp;
00112 
00113         ContextRecord-&gt;IntA0 = TrapFrame-&gt;IntA0;
00114         ContextRecord-&gt;IntA1 = TrapFrame-&gt;IntA1;
00115         ContextRecord-&gt;IntA2 = TrapFrame-&gt;IntA2;
00116         ContextRecord-&gt;IntA3 = TrapFrame-&gt;IntA3;
00117         ContextRecord-&gt;IntA4 = TrapFrame-&gt;IntA4;
00118         ContextRecord-&gt;IntA5 = TrapFrame-&gt;IntA5;
00119 
00120         ContextRecord-&gt;IntT8 = TrapFrame-&gt;IntT8;
00121         ContextRecord-&gt;IntT9 = TrapFrame-&gt;IntT9;
00122         ContextRecord-&gt;IntT10 = TrapFrame-&gt;IntT10;
00123         ContextRecord-&gt;IntT11 = TrapFrame-&gt;IntT11;
00124         ContextRecord-&gt;IntT12 = TrapFrame-&gt;IntT12;
00125 
00126         <span class="comment">//</span>
00127         <span class="comment">// Get volatile integer register AT from trap frame.</span>
00128         <span class="comment">// Get integer register zero.</span>
00129         <span class="comment">//</span>
00130 
00131         ContextRecord-&gt;IntAt = TrapFrame-&gt;IntAt;
00132         ContextRecord-&gt;IntZero = 0;
00133     }
00134 
00135     <span class="comment">//</span>
00136     <span class="comment">// Get floating register contents if specified.</span>
00137     <span class="comment">//</span>
00138 
00139     <span class="keywordflow">if</span> ((ContextRecord-&gt;ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a154">CONTEXT_FLOATING_POINT</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a154">CONTEXT_FLOATING_POINT</a>) {
00140 
00141         <span class="comment">//</span>
00142         <span class="comment">// Get volatile floating registers f0 - f1 from trap frame.</span>
00143         <span class="comment">//</span>
00144 
00145         ContextRecord-&gt;FltF0 = TrapFrame-&gt;FltF0;
00146         ContextRecord-&gt;FltF1 = TrapFrame-&gt;FltF1;
00147 
00148         <span class="comment">//</span>
00149         <span class="comment">// Get volatile floating registers f10 - f30 from trap frame.</span>
00150         <span class="comment">// This assumes that f10 - f30 are contiguous in the trap frame.</span>
00151         <span class="comment">//</span>
00152 
00153         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((&amp;ContextRecord-&gt;FltF30 - &amp;ContextRecord-&gt;FltF10) == 20);
00154         RtlMoveMemory(&amp;ContextRecord-&gt;FltF10, &amp;TrapFrame-&gt;FltF10,
00155                       <span class="keyword">sizeof</span>(ULONGLONG) * 21);
00156 
00157         ContextRecord-&gt;FltF31 = 0;
00158 
00159         <span class="comment">//</span>
00160         <span class="comment">// Get nonvolatile floating registers f2 - f9 through context pointers.</span>
00161         <span class="comment">//</span>
00162 
00163         ContextRecord-&gt;FltF2 = *ContextPointers-&gt;FltF2;
00164         ContextRecord-&gt;FltF3 = *ContextPointers-&gt;FltF3;
00165         ContextRecord-&gt;FltF4 = *ContextPointers-&gt;FltF4;
00166         ContextRecord-&gt;FltF5 = *ContextPointers-&gt;FltF5;
00167         ContextRecord-&gt;FltF6 = *ContextPointers-&gt;FltF6;
00168         ContextRecord-&gt;FltF7 = *ContextPointers-&gt;FltF7;
00169         ContextRecord-&gt;FltF8 = *ContextPointers-&gt;FltF8;
00170         ContextRecord-&gt;FltF9 = *ContextPointers-&gt;FltF9;
00171 
00172         <span class="comment">//</span>
00173         <span class="comment">// Get floating point control register from trap frame.</span>
00174         <span class="comment">// Get the current software FPCR value from the TEB.</span>
00175         <span class="comment">//</span>
00176 
00177         ContextRecord-&gt;Fpcr = TrapFrame-&gt;Fpcr;
00178         <span class="keywordflow">try</span> {
00179             ContextRecord-&gt;SoftFpcr =
00180                 (ULONGLONG)(NtCurrentTeb()-&gt;FpSoftwareStatusRegister);
00181 
00182         } except (EXCEPTION_EXECUTE_HANDLER) {
00183             ContextRecord-&gt;SoftFpcr = 0;
00184         }
00185     }
00186 
00187     <span class="keywordflow">return</span>;
00188 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="psctxalp.c::PspGetSetContextSpecialApcMain" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID PspGetSetContextSpecialApcMain           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d5/struct__KAPC.html">PKAPC</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Apc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>NormalRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>NormalContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument2</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d9/psctxalp_8c-source.html#l00349">349</a> of file <a class="el" href="../../d5/d9/psctxalp_8c-source.html">psctxalp.c</a>.
<p>
References <a class="el" href="../../d9/d0/psp_8h-source.html#l00080">_GETSETCONTEXT::Context</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00556">_KTHREAD::InitialStack</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d9/d0/psp_8h-source.html#l00078">_GETSETCONTEXT::Mode</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d9/d0/psp_8h-source.html#l00079">_GETSETCONTEXT::OperationComplete</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d5/d9/psctxalp_8c-source.html#l00029">PspGetContext()</a>, <a class="el" href="../../d4/d9/psctx386_8c-source.html#l00088">PspSetContext()</a>, <a class="el" href="../../d0/d9/ppc_2exdsptch_8c-source.html#l00348">RtlLookupFunctionEntry()</a>, <a class="el" href="../../d1/d6/ppc_2vunwind_8c-source.html#l00467">RtlVirtualUnwind()</a>, and <a class="el" href="../../d2/d8/ps_8h-source.html#l00347">_ETHREAD::Tcb</a>.
<p>
<pre class="fragment"><div>00359                    :
00360 
00361     This function either captures <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user mode state of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current
00362     thread, or sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user mode state of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current thread. The
00363     operation <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> determined by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value of SystemArgument1. <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a>
00364     zero value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used <span class="keywordflow">for</span> get context, and a nonzero value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used
00365     <span class="keywordflow">for</span> set context.
00366 
00367 Arguments:
00368 
00369     Apc - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> object that caused entry
00370           into <span class="keyword">this</span> routine.
00371 
00372     NormalRoutine - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> normal routine function that
00373         was specified when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC was initialized. This parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not
00374         used.
00375 
00376     NormalContext - Supplies a pointer to an arbitrary data structure that
00377         was specified when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC was initialized. This parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not
00378         used.
00379 
00380     SystemArgument1, SystemArgument2 - Supplies a set of two pointer to two
00381         arguments that contain untyped data. These parameters are not used.
00382 
00383 Return Value:
00384 
00385     None.
00386 
00387 --*/
00388 
00389 {
00390 
00391     <a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html">PGETSETCONTEXT</a> ContextBlock;
00392     KNONVOLATILE_CONTEXT_POINTERS ContextPointers;
00393     CONTEXT ContextRecord;
00394     ULONG_PTR ControlPc;
00395     FRAME_POINTERS EstablisherFrame;
00396     PRUNTIME_FUNCTION FunctionEntry;
00397     BOOLEAN InFunction;
00398     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
00399     ULONGLONG TrapFrame1;
00400     ULONGLONG TrapFrame2;
00401 
00402     <span class="comment">//</span>
00403     <span class="comment">// Get the address of the context block and compute the address of the</span>
00404     <span class="comment">// system entry trap frame.</span>
00405     <span class="comment">//</span>
00406 
00407     ContextBlock = CONTAINING_RECORD(Apc, <a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html">GETSETCONTEXT</a>, Apc);
00408     Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00409     TrapFrame1 = (ULONGLONG)(LONG_PTR)Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o2">InitialStack</a> - KTRAP_FRAME_LENGTH;
00410 
00411     <span class="comment">//</span>
00412     <span class="comment">// The lower bounds for locating the first system service trap frame on</span>
00413     <span class="comment">// the kernel stack is one trap frame below TrapFrame1.</span>
00414     <span class="comment">//</span>
00415 
00416     TrapFrame2 = TrapFrame1 - KTRAP_FRAME_LENGTH;
00417 
00418     <span class="comment">//</span>
00419     <span class="comment">// Capture the current thread context and set the initial control PC</span>
00420     <span class="comment">// value.</span>
00421     <span class="comment">//</span>
00422 
00423     RtlCaptureContext(&amp;ContextRecord);
00424     ControlPc = (ULONG_PTR)ContextRecord.IntRa;
00425 
00426     <span class="comment">//</span>
00427     <span class="comment">// Initialize context pointers for the nonvolatile integer and floating</span>
00428     <span class="comment">// registers.</span>
00429     <span class="comment">//</span>
00430 
00431     ContextPointers.IntS0 = &amp;ContextRecord.IntS0;
00432     ContextPointers.IntS1 = &amp;ContextRecord.IntS1;
00433     ContextPointers.IntS2 = &amp;ContextRecord.IntS2;
00434     ContextPointers.IntS3 = &amp;ContextRecord.IntS3;
00435     ContextPointers.IntS4 = &amp;ContextRecord.IntS4;
00436     ContextPointers.IntS5 = &amp;ContextRecord.IntS5;
00437 
00438     ContextPointers.FltF2 = &amp;ContextRecord.FltF2;
00439     ContextPointers.FltF3 = &amp;ContextRecord.FltF3;
00440     ContextPointers.FltF4 = &amp;ContextRecord.FltF4;
00441     ContextPointers.FltF5 = &amp;ContextRecord.FltF5;
00442     ContextPointers.FltF6 = &amp;ContextRecord.FltF6;
00443     ContextPointers.FltF7 = &amp;ContextRecord.FltF7;
00444     ContextPointers.FltF8 = &amp;ContextRecord.FltF8;
00445     ContextPointers.FltF9 = &amp;ContextRecord.FltF9;
00446 
00447     <span class="comment">//</span>
00448     <span class="comment">// Start with the frame specified by the context record and virtually</span>
00449     <span class="comment">// unwind call frames until the system entry trap frame is encountered.</span>
00450     <span class="comment">//</span>
00451 
00452     <span class="keywordflow">do</span> {
00453 
00454         <span class="comment">//</span>
00455         <span class="comment">// Lookup the function table entry using the point at which control</span>
00456         <span class="comment">// left the procedure.</span>
00457         <span class="comment">//</span>
00458 
00459         FunctionEntry = <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a8">RtlLookupFunctionEntry</a>(ControlPc);
00460 
00461         <span class="comment">//</span>
00462         <span class="comment">// If there is a function table entry for the routine, then virtually</span>
00463         <span class="comment">// unwind to the caller of the current routine to obtain the address</span>
00464         <span class="comment">// where control left the caller. Otherwise, the function is a leaf</span>
00465         <span class="comment">// function and the return address register contains the address of</span>
00466         <span class="comment">// where control left the caller.</span>
00467         <span class="comment">//</span>
00468 
00469         <span class="keywordflow">if</span> (FunctionEntry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00470             ControlPc = <a class="code" href="../../d0/d7/ppc_2vunwind_8c.html#a38">RtlVirtualUnwind</a>(ControlPc,
00471                                          FunctionEntry,
00472                                          &amp;ContextRecord,
00473                                          &amp;InFunction,
00474                                          &amp;EstablisherFrame,
00475                                          &amp;ContextPointers);
00476 
00477         } <span class="keywordflow">else</span> {
00478             ControlPc = (ULONG_PTR)ContextRecord.IntRa;
00479         }
00480 
00481         <span class="comment">//</span>
00482         <span class="comment">// N.B. The virtual frame pointer of the kernel frame just below the</span>
00483         <span class="comment">// trap frame may not be exactly equal to TrapFrame1 since the trap</span>
00484         <span class="comment">// code can allocate additional stack space (for local variables or</span>
00485         <span class="comment">// system service arguments). Therefore we must check for a range of</span>
00486         <span class="comment">// values at or below TrapFrame1, but also above TrapFrame2 (so in</span>
00487         <span class="comment">// case there is more than one trap frame on the stack, we get the</span>
00488         <span class="comment">// one at the top.</span>
00489         <span class="comment">//</span>
00490 
00491     } <span class="keywordflow">while</span> ((ContextRecord.IntSp != TrapFrame1) &amp;&amp;
00492              ((ContextRecord.IntSp &lt; TrapFrame2) ||
00493               (ControlPc &lt; PCR-&gt;SystemServiceDispatchStart) ||
00494               (ControlPc &gt;= PCR-&gt;SystemServiceDispatchEnd)));
00495 
00496     <span class="comment">//</span>
00497     <span class="comment">// If system argument one is nonzero, then set the context of the current</span>
00498     <span class="comment">// thread. Otherwise, get the context of the current thread.</span>
00499     <span class="comment">//</span>
00500 
00501     <span class="keywordflow">if</span> (Apc-&gt;SystemArgument1 != 0) {
00502 
00503         <span class="comment">//</span>
00504         <span class="comment">// Set context of current thread.</span>
00505         <span class="comment">//</span>
00506 
00507         <a class="code" href="../../d8/d1/psp_8h.html#a72">PspSetContext</a>((PKTRAP_FRAME)TrapFrame1,
00508                       &amp;ContextPointers,
00509                       &amp;ContextBlock-&gt;<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o3">Context</a>,
00510                       ContextBlock-&gt;<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o1">Mode</a>);
00511 
00512     } <span class="keywordflow">else</span> {
00513 
00514         <span class="comment">//</span>
00515         <span class="comment">// Get context of current thread.</span>
00516         <span class="comment">//</span>
00517 
00518         <a class="code" href="../../d8/d1/psp_8h.html#a73">PspGetContext</a>((PKTRAP_FRAME)TrapFrame1,
00519                       &amp;ContextPointers,
00520                       &amp;ContextBlock-&gt;<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o3">Context</a>);
00521     }
00522 
00523     <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(&amp;ContextBlock-&gt;<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o2">OperationComplete</a>, 0, FALSE);
00524     <span class="keywordflow">return</span>;
00525 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="psctxalp.c::PspSetContext" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID PspSetContext           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PKTRAP_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>TrapFrame</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PKNONVOLATILE_CONTEXT_POINTERS&nbsp;</td>
          <td class="mdname" nowrap> <em>ContextPointers</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>ContextRecord</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessorMode</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d9/psctxalp_8c-source.html#l00191">191</a> of file <a class="el" href="../../d5/d9/psctxalp_8c-source.html">psctxalp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00240">CONTEXT_CONTROL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00241">CONTEXT_FLOATING_POINT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00242">CONTEXT_INTEGER</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>.
<p>
<pre class="fragment"><div>00200                    :
00201 
00202     This function selectively moves <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> contents of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified context
00203     record to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified trap frame and nonvolatile context.
00204 
00205 Arguments:
00206 
00207     TrapFrame - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of a trap frame.
00208 
00209     ContextPointers - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of a context pointers record.
00210 
00211     ContextRecord - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of a context record.
00212 
00213     ProcessorMode - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> processor mode to use when sanitizing
00214         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d9/d2/festate_8h.html#a2">PSR</a> and FSR.
00215 
00216 Return Value:
00217 
00218     None.
00219 
00220 --*/
00221 
00222 {
00223 
00224     <span class="comment">//</span>
00225     <span class="comment">// Set control information if specified.</span>
00226     <span class="comment">//</span>
00227 
00228     <span class="keywordflow">if</span> ((ContextRecord-&gt;ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a153">CONTEXT_CONTROL</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a153">CONTEXT_CONTROL</a>) {
00229 
00230         <span class="comment">//</span>
00231         <span class="comment">// Set integer registers gp, sp, ra, FIR, and PSR in trap frame.</span>
00232         <span class="comment">//</span>
00233 
00234         TrapFrame-&gt;IntGp = ContextRecord-&gt;IntGp;
00235         TrapFrame-&gt;IntSp = ContextRecord-&gt;IntSp;
00236         TrapFrame-&gt;IntRa = ContextRecord-&gt;IntRa;
00237         TrapFrame-&gt;Fir = ContextRecord-&gt;Fir;
00238         TrapFrame-&gt;Psr = SANITIZE_PSR(ContextRecord-&gt;Psr, ProcessorMode);
00239     }
00240 
00241     <span class="comment">//</span>
00242     <span class="comment">// Set integer register contents if specified.</span>
00243     <span class="comment">//</span>
00244 
00245     <span class="keywordflow">if</span> ((ContextRecord-&gt;ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a155">CONTEXT_INTEGER</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a155">CONTEXT_INTEGER</a>) {
00246 
00247         <span class="comment">//</span>
00248         <span class="comment">// Set volatile integer registers v0 and t0 - t7 in trap frame.</span>
00249         <span class="comment">//</span>
00250 
00251         TrapFrame-&gt;IntV0 = ContextRecord-&gt;IntV0;
00252         TrapFrame-&gt;IntT0 = ContextRecord-&gt;IntT0;
00253         TrapFrame-&gt;IntT1 = ContextRecord-&gt;IntT1;
00254         TrapFrame-&gt;IntT2 = ContextRecord-&gt;IntT2;
00255         TrapFrame-&gt;IntT3 = ContextRecord-&gt;IntT3;
00256         TrapFrame-&gt;IntT4 = ContextRecord-&gt;IntT4;
00257         TrapFrame-&gt;IntT5 = ContextRecord-&gt;IntT5;
00258         TrapFrame-&gt;IntT6 = ContextRecord-&gt;IntT6;
00259         TrapFrame-&gt;IntT7 = ContextRecord-&gt;IntT7;
00260 
00261         <span class="comment">//</span>
00262         <span class="comment">// Set nonvolatile integer registers s0 - s5 through context pointers.</span>
00263         <span class="comment">//</span>
00264 
00265         *ContextPointers-&gt;IntS0 = ContextRecord-&gt;IntS0;
00266         *ContextPointers-&gt;IntS1 = ContextRecord-&gt;IntS1;
00267         *ContextPointers-&gt;IntS2 = ContextRecord-&gt;IntS2;
00268         *ContextPointers-&gt;IntS3 = ContextRecord-&gt;IntS3;
00269         *ContextPointers-&gt;IntS4 = ContextRecord-&gt;IntS4;
00270         *ContextPointers-&gt;IntS5 = ContextRecord-&gt;IntS5;
00271 
00272         <span class="comment">//</span>
00273         <span class="comment">// Set volatile integer registers fp/s6, a0 - a5, t8 - t12, and AT</span>
00274         <span class="comment">// in trap frame.</span>
00275         <span class="comment">//</span>
00276 
00277         TrapFrame-&gt;IntFp = ContextRecord-&gt;IntFp;
00278 
00279         TrapFrame-&gt;IntA0 = ContextRecord-&gt;IntA0;
00280         TrapFrame-&gt;IntA1 = ContextRecord-&gt;IntA1;
00281         TrapFrame-&gt;IntA2 = ContextRecord-&gt;IntA2;
00282         TrapFrame-&gt;IntA3 = ContextRecord-&gt;IntA3;
00283         TrapFrame-&gt;IntA4 = ContextRecord-&gt;IntA4;
00284         TrapFrame-&gt;IntA5 = ContextRecord-&gt;IntA5;
00285 
00286         TrapFrame-&gt;IntT8 = ContextRecord-&gt;IntT8;
00287         TrapFrame-&gt;IntT9 = ContextRecord-&gt;IntT9;
00288         TrapFrame-&gt;IntT10 = ContextRecord-&gt;IntT10;
00289         TrapFrame-&gt;IntT11 = ContextRecord-&gt;IntT11;
00290         TrapFrame-&gt;IntT12 = ContextRecord-&gt;IntT12;
00291 
00292         TrapFrame-&gt;IntAt = ContextRecord-&gt;IntAt;
00293     }
00294 
00295     <span class="comment">//</span>
00296     <span class="comment">// Set floating register contents if specified.</span>
00297     <span class="comment">//</span>
00298 
00299     <span class="keywordflow">if</span> ((ContextRecord-&gt;ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a154">CONTEXT_FLOATING_POINT</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a154">CONTEXT_FLOATING_POINT</a>) {
00300 
00301         <span class="comment">//</span>
00302         <span class="comment">// Set volatile floating registers f0 - f1 in trap frame.</span>
00303         <span class="comment">//</span>
00304 
00305         TrapFrame-&gt;FltF0 = ContextRecord-&gt;FltF0;
00306         TrapFrame-&gt;FltF1 = ContextRecord-&gt;FltF1;
00307 
00308         <span class="comment">//</span>
00309         <span class="comment">// Set volatile floating registers f10 - f30 in trap frame.</span>
00310         <span class="comment">// This assumes that f10 - f30 are contiguous in the trap frame.</span>
00311         <span class="comment">//</span>
00312 
00313         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((&amp;ContextRecord-&gt;FltF30 - &amp;ContextRecord-&gt;FltF10) == 20);
00314         RtlMoveMemory(&amp;TrapFrame-&gt;FltF10, &amp;ContextRecord-&gt;FltF10,
00315                       <span class="keyword">sizeof</span>(ULONGLONG) * 21);
00316 
00317         <span class="comment">//</span>
00318         <span class="comment">// Set nonvolatile floating registers f2 - f9 through context pointers.</span>
00319         <span class="comment">//</span>
00320 
00321         *ContextPointers-&gt;FltF2 = ContextRecord-&gt;FltF2;
00322         *ContextPointers-&gt;FltF3 = ContextRecord-&gt;FltF3;
00323         *ContextPointers-&gt;FltF4 = ContextRecord-&gt;FltF4;
00324         *ContextPointers-&gt;FltF5 = ContextRecord-&gt;FltF5;
00325         *ContextPointers-&gt;FltF6 = ContextRecord-&gt;FltF6;
00326         *ContextPointers-&gt;FltF7 = ContextRecord-&gt;FltF7;
00327         *ContextPointers-&gt;FltF8 = ContextRecord-&gt;FltF8;
00328         *ContextPointers-&gt;FltF9 = ContextRecord-&gt;FltF9;
00329 
00330         <span class="comment">//</span>
00331         <span class="comment">// Set floating point control register in trap frame.</span>
00332         <span class="comment">// Set the current software FPCR value in the TEB.</span>
00333         <span class="comment">//</span>
00334 
00335         TrapFrame-&gt;Fpcr = ContextRecord-&gt;Fpcr;
00336         <span class="keywordflow">try</span> {
00337             NtCurrentTeb()-&gt;FpSoftwareStatusRegister =
00338                 (ULONG)ContextRecord-&gt;SoftFpcr;
00339 
00340         } except (EXCEPTION_EXECUTE_HANDLER) {
00341             NOTHING;
00342         }
00343     }
00344 
00345     <span class="keywordflow">return</span>;
00346 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:22 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
