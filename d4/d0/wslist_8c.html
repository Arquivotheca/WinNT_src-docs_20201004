<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: wslist.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>wslist.c File Reference</h1><code>#include "<a class="el" href="../../d5/d7/mi_8h-source.html">mi.h</a>"</code><br>

<p>
<a href="../../d5/d9/wslist_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d0/wslist_8c.html#a0">MM_SYSTEM_CACHE_THRESHOLD</a>&nbsp;&nbsp;&nbsp;((1024*1024) / PAGE_SIZE)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d0/wslist_8c.html#a1">MM_RETRY_COUNT</a>&nbsp;&nbsp;&nbsp;2</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d0/wslist_8c.html#a12">MiDoReplacement</a> (IN <a class="el" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> WsInfo, IN BOOLEAN MustReplace)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d0/wslist_8c.html#a13">MiReplaceWorkingSetEntryUsingFaultInfo</a> (IN <a class="el" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> WsInfo, IN BOOLEAN MustReplace)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d0/wslist_8c.html#a14">MiCheckWsleHash</a> (IN <a class="el" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a> WorkingSetList)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d0/wslist_8c.html#a15">MiEliminateWorkingSetEntry</a> (IN ULONG WorkingSetIndex, IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte, IN <a class="el" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn, IN <a class="el" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a> Wsle)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d0/wslist_8c.html#a16">MiAddWorkingSetPage</a> (IN <a class="el" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> WsInfo)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d0/wslist_8c.html#a17">MiRemoveWorkingSetPages</a> (IN <a class="el" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a> WorkingSetList, IN <a class="el" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> WsInfo)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d0/wslist_8c.html#a18">MiCheckNullIndex</a> (IN <a class="el" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a> WorkingSetList)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d0/wslist_8c.html#a19">MiDumpWsleInCacheBlock</a> (IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> CachePte)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d0/wslist_8c.html#a20">MiDumpPteInCacheBlock</a> (IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d0/wslist_8c.html#a21">MiLocateAndReserveWsle</a> (IN <a class="el" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> WsInfo)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LOGICAL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d0/wslist_8c.html#a22">MmEnforceWorkingSetLimit</a> (IN <a class="el" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> WsInfo, IN LOGICAL Enable)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d0/wslist_8c.html#a23">MiRemovePageFromWorkingSet</a> (IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte, IN <a class="el" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1, IN <a class="el" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> WsInfo)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d0/wslist_8c.html#a24">MiReleaseWsle</a> (IN <a class="el" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> WorkingSetIndex, IN <a class="el" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> WsInfo)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d0/wslist_8c.html#a25">MiUpdateWsle</a> (IN OUT <a class="el" href="../../d4/d8/mi_8h.html#a436">PWSLE_NUMBER</a> DesiredIndex, IN PVOID VirtualAddress, <a class="el" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a> WorkingSetList, IN <a class="el" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d0/wslist_8c.html#a26">MiFreeWsle</a> (IN <a class="el" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> WorkingSetIndex, IN <a class="el" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> WsInfo, IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d0/wslist_8c.html#a27">MiInitializeWorkingSetList</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d0/wslist_8c.html#a28">MiInitializeSessionWsSupport</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d0/wslist_8c.html#a29">MiSessionInitializeWorkingSetList</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LOGICAL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d0/wslist_8c.html#a30">MmAssignProcessToJob</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d0/wslist_8c.html#a31">MmAdjustWorkingSetSize</a> (IN SIZE_T WorkingSetMinimumInBytes, IN SIZE_T WorkingSetMaximumInBytes, IN ULONG SystemCache)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LOGICAL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d0/wslist_8c.html#a32">MiAddWsleHash</a> (IN <a class="el" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> WsInfo, IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d0/wslist_8c.html#a33">MiGrowWsleHash</a> (IN <a class="el" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> WsInfo)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d0/wslist_8c.html#a34">MiTrimWorkingSet</a> (ULONG Reduction, IN <a class="el" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> WsInfo, IN ULONG ForcedReductionOrTrimAge)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d0/wslist_8c.html#a35">MiEmptyWorkingSet</a> (IN <a class="el" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> WsInfo, IN LOGICAL WaitOk)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d0/wslist_8c.html#a2">MmMaximumWorkingSetSize</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d0/wslist_8c.html#a3">MmFaultsTakenToGoAboveMaxWs</a> = 100</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d0/wslist_8c.html#a4">MmFaultsTakenToGoAboveMinWs</a> = 16</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d0/wslist_8c.html#a5">MmSystemCodePage</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d0/wslist_8c.html#a6">MmSystemCachePage</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d0/wslist_8c.html#a7">MmPagedPoolPage</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d0/wslist_8c.html#a8">MmSystemDriverPage</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d0/wslist_8c.html#a9">MmTransitionSharedPages</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d0/wslist_8c.html#a10">MmTransitionSharedPagesPeak</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LOGICAL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d0/wslist_8c.html#a11">MiTrimRemovalPagesOnly</a></td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a1" doxytag="wslist.c::MM_RETRY_COUNT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MM_RETRY_COUNT&nbsp;&nbsp;&nbsp;2          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d9/wslist_8c-source.html#l00045">45</a> of file <a class="el" href="../../d5/d9/wslist_8c-source.html">wslist.c</a>.
<p>
Referenced by <a class="el" href="../../d5/d9/wslist_8c-source.html#l02450">MmAdjustWorkingSetSize()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="wslist.c::MM_SYSTEM_CACHE_THRESHOLD" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MM_SYSTEM_CACHE_THRESHOLD&nbsp;&nbsp;&nbsp;((1024*1024) / PAGE_SIZE)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d9/wslist_8c-source.html#l00029">29</a> of file <a class="el" href="../../d5/d9/wslist_8c-source.html">wslist.c</a>.
<p>
Referenced by <a class="el" href="../../d5/d9/wslist_8c-source.html#l00254">MiDoReplacement()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a16" doxytag="wslist.c::MiAddWorkingSetPage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG MiAddWorkingSetPage           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>WsInfo</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d9/wslist_8c-source.html#l02824">2824</a> of file <a class="el" href="../../d5/d9/wslist_8c-source.html">wslist.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05471">_MM_SESSION_SPACE::CommittedPages</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00875">CONSISTENCY_LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00876">CONSISTENCY_UNLOCK_PFN</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01600">_MMWSL::FirstDynamic</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01599">_MMWSL::FirstFree</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01607">_MMWSL::HashTable</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01610">_MMWSL::HashTableStart</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01601">_MMWSL::LastEntry</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01605">_MMWSL::LastInitializedWsle</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00982">LOCK_EXPANSION_IF_ALPHA</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01013">MI_GET_PAGE_COLOR_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00494">MI_MAKE_VALID_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00710">MI_SET_PTE_DIRTY</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00641">MI_SET_PTE_IN_WORKING_SET</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02459">MI_WRITE_VALID_PTE</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00329">MiChargeCommitmentCantExpand()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03398">MiInitializePfn()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l01177">MiRemoveZeroPage()</a>, <a class="el" href="../../d8/d9/wstree_8c-source.html#l00576">MiSwapWslEntries()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l01078">MiUpdateWsle()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04317">MM_BUMP_COUNTER</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05361">MM_BUMP_SESS_COUNTER</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04273">MM_DBG_COMMIT_SESSION_ADDITIONAL_WS_PAGES</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05314">MM_DBG_SESSION_WS_PAGE_ALLOC_GROWTH</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00418">MM_DEMAND_ZERO_WRITE_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00076">MM_FREE_WSLE_SHIFT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00119">MM_GROW_WSLE_HASH</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00137">MM_READWRITE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01017">MM_SYSTEM_WS_LOCK_ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04221">MM_TRACK_COMMIT</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00134">MmAvailablePages</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04506">MmPagesAboveWsMinimum</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00086">MmResidentAvailablePages</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05609">MmSessionSpace</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00064">MmSystemCacheWs</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05463">_MM_SESSION_SPACE::NonPagablePages</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01598">_MMWSL::Quota</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o5">_MMPFN::u1</a>, <a class="el" href="../../d1/d8/struct__MMWSLE.html#o3">_MMWSLE::u1</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00991">UNLOCK_EXPANSION_IF_ALPHA</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01603">_MMWSL::Wsle</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00078">WSLE_NULL_INDEX</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l01231">WSLE_NUMBER</a>.
<p>
Referenced by <a class="el" href="../../d5/d9/wslist_8c-source.html#l00117">MiLocateAndReserveWsle()</a>, and <a class="el" href="../../d5/d9/wslist_8c-source.html#l02450">MmAdjustWorkingSetSize()</a>.
<p>
<pre class="fragment"><div>02830                    :
02831 
02832     This function grows <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set list above working set
02833     maximum during working set adjustment.  At most one page
02834     can be added at a time.
02835 
02836 Arguments:
02837 
02838     None.
02839 
02840 Return Value:
02841 
02842     Returns <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> no working set page could be added.
02843 
02844 Environment:
02845 
02846     Kernel mode, APCs disabled, working set mutexes held.
02847 
02848 --*/
02849 
02850 {
02851     ULONG SwapEntry;
02852     ULONG CurrentEntry;
02853     <a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a> WslEntry;
02854     ULONG i;
02855     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
02856     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
02857     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> Va;
02858     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
02859     <a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> NumberOfEntriesMapped;
02860     PFN_NUMBER WorkingSetPage;
02861     <a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> WorkingSetIndex;
02862     <a class="code" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a> WorkingSetList;
02863     <a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a> Wsle;
02864     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
02865     KIRQL OldIrql;
02866     LOGICAL PageTablePageAllocated;
02867 
02868     WorkingSetList = WsInfo-&gt;VmWorkingSetList;
02869     Wsle = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o5">Wsle</a>;
02870 
02871 <span class="preprocessor">#if DBG</span>
02872 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (WsInfo == &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>) {
02873         <a class="code" href="../../d4/d8/mi_8h.html#a147">MM_SYSTEM_WS_LOCK_ASSERT</a>();
02874     }
02875 <span class="preprocessor">#endif //DBG</span>
02876 <span class="preprocessor"></span>
02877     <span class="comment">//</span>
02878     <span class="comment">// The maximum size of the working set is being increased, check</span>
02879     <span class="comment">// to ensure the proper number of pages are mapped to cover</span>
02880     <span class="comment">// the complete working set list.</span>
02881     <span class="comment">//</span>
02882 
02883     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (&amp;Wsle[WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a>]);
02884 
02885     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
02886 
02887     PointerPte += 1;
02888 
02889     Va = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
02890 
02891     <span class="keywordflow">if</span> ((PVOID)Va &gt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o12">HashTableStart</a>) {
02892 
02893         <span class="comment">//</span>
02894         <span class="comment">// Adding this entry would overrun the hash table.  The caller</span>
02895         <span class="comment">// must replace instead.</span>
02896         <span class="comment">//</span>
02897 
02898         WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a> = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a>;
02899         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02900     }
02901 
02902     PageTablePageAllocated = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02903 
02904 <span class="preprocessor">#if defined (_WIN64)</span>
02905 <span class="preprocessor"></span>    PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPte);
02906     <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
02907 
02908         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WsInfo-&gt;u.Flags.SessionSpace == 0);
02909 
02910         <span class="comment">//</span>
02911         <span class="comment">// Map in a new working set page.</span>
02912         <span class="comment">//</span>
02913     
02914         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02915         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &lt; 21) {
02916     
02917             <span class="comment">//</span>
02918             <span class="comment">// No pages are available, set the quota to the last</span>
02919             <span class="comment">// initialized WSLE and return.</span>
02920             <span class="comment">//</span>
02921     
02922             WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a> = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a>;
02923             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02924             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02925         }
02926     
02927         PageTablePageAllocated = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02928         WorkingSetPage = <a class="code" href="../../d7/d5/pfnlist_8c.html#a14">MiRemoveZeroPage</a> (MI_GET_PAGE_COLOR_FROM_PTE (PointerPde));
02929         PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a95">MM_DEMAND_ZERO_WRITE_PTE</a>;
02930         <a class="code" href="../../d8/d2/pagfault_8c.html#a22">MiInitializePfn</a> (WorkingSetPage, PointerPde, 1);
02931         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02932     
02933         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a105">MI_MAKE_VALID_PTE</a> (TempPte,
02934                            WorkingSetPage,
02935                            MM_READWRITE,
02936                            PointerPde);
02937     
02938         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a112">MI_SET_PTE_DIRTY</a> (TempPte);
02939         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPde, TempPte);
02940     
02941         <span class="comment">//</span>
02942         <span class="comment">// Further down in this routine (once an actual working set page</span>
02943         <span class="comment">// has been allocated) the quota will be increased by 1 to reflect</span>
02944         <span class="comment">// the working set size entry for the new page table page.</span>
02945         <span class="comment">// The page table page will be put in a working set entry which will</span>
02946         <span class="comment">// be locked into the working set.</span>
02947         <span class="comment">//</span>
02948     }
02949 <span class="preprocessor">#endif</span>
02950 <span class="preprocessor"></span>
02951     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
02952 
02953     NumberOfEntriesMapped = (<a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>)(((<a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a>)((PCHAR)Va + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>)) - Wsle);
02954 
02955     <span class="comment">//</span>
02956     <span class="comment">// Map in a new working set page.</span>
02957     <span class="comment">//</span>
02958 
02959     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02960     <span class="keywordflow">if</span> ((PageTablePageAllocated == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp; (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &lt; 20)) {
02961 
02962         <span class="comment">//</span>
02963         <span class="comment">// No pages are available, set the quota to the last</span>
02964         <span class="comment">// initialized WSLE and return.</span>
02965         <span class="comment">//</span>
02966 
02967         WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a> = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a>;
02968         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02969         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02970     }
02971 
02972     WorkingSetPage = <a class="code" href="../../d7/d5/pfnlist_8c.html#a14">MiRemoveZeroPage</a> (MI_GET_PAGE_COLOR_FROM_PTE (PointerPte));
02973     PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a95">MM_DEMAND_ZERO_WRITE_PTE</a>;
02974     <a class="code" href="../../d8/d2/pagfault_8c.html#a22">MiInitializePfn</a> (WorkingSetPage, PointerPte, 1);
02975     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02976 
02977     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a105">MI_MAKE_VALID_PTE</a> (TempPte,
02978                        WorkingSetPage,
02979                        MM_READWRITE,
02980                        PointerPte);
02981 
02982     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a112">MI_SET_PTE_DIRTY</a> (TempPte);
02983     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPte, TempPte);
02984 
02985     <span class="keywordflow">if</span> (WsInfo-&gt;u.Flags.SessionSpace == 1) {
02986         <a class="code" href="../../d4/d8/mi_8h.html#a384">MM_BUMP_SESS_COUNTER</a> (MM_DBG_SESSION_WS_PAGE_ALLOC_GROWTH, 1);
02987         <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o13">NonPagablePages</a> += 1;
02988         <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o14">CommittedPages</a> += 1;
02989         <a class="code" href="../../d6/d1/mmquota_8c.html#a18">MiChargeCommitmentCantExpand</a> (1, TRUE);
02990         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02991         <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a> (48, 1);
02992         <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> -= 1;
02993         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02994         <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_SESSION_ADDITIONAL_WS_PAGES, 1);
02995     }
02996 
02997     CurrentEntry = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a> + 1;
02998 
02999     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NumberOfEntriesMapped &gt; CurrentEntry);
03000 
03001     WslEntry = &amp;Wsle[CurrentEntry - 1];
03002 
03003     <span class="keywordflow">for</span> (i = CurrentEntry; i &lt; NumberOfEntriesMapped; i += 1) {
03004 
03005         <span class="comment">//</span>
03006         <span class="comment">// Build the free list, note that the first working</span>
03007         <span class="comment">// set entries (CurrentEntry) are not on the free list.</span>
03008         <span class="comment">// These entries are reserved for the pages which</span>
03009         <span class="comment">// map the working set and the page which contains the PDE.</span>
03010         <span class="comment">//</span>
03011 
03012         WslEntry += 1;
03013         WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.Long = (i + 1) &lt;&lt; <a class="code" href="../../d4/d8/mi_8h.html#a9">MM_FREE_WSLE_SHIFT</a>;
03014     }
03015 
03016     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.Long = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> &lt;&lt; <a class="code" href="../../d4/d8/mi_8h.html#a9">MM_FREE_WSLE_SHIFT</a>;
03017 
03018     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (CurrentEntry &gt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>);
03019 
03020     WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> = CurrentEntry;
03021 
03022     WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a> = (NumberOfEntriesMapped - 1);
03023 
03024     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> &lt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a>) ||
03025             (WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> == WSLE_NULL_INDEX));
03026 
03027     <span class="comment">//</span>
03028     <span class="comment">// As we are growing the working set, make sure the quota is</span>
03029     <span class="comment">// above the working set size by adding 1 to the quota.</span>
03030     <span class="comment">//</span>
03031 
03032     WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a> += 1;
03033 
03034     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
03035 
03036     <a class="code" href="../../d4/d8/mi_8h.html#a121">CONSISTENCY_LOCK_PFN</a> (OldIrql);
03037 
03038     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Event = (PVOID)<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
03039 
03040     <a class="code" href="../../d4/d8/mi_8h.html#a122">CONSISTENCY_UNLOCK_PFN</a> (OldIrql);
03041 
03042     <span class="comment">//</span>
03043     <span class="comment">// Get a working set entry.</span>
03044     <span class="comment">//</span>
03045 
03046     WsInfo-&gt;WorkingSetSize += 1;
03047 
03048     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> != WSLE_NULL_INDEX);
03049     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> &gt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>);
03050 
03051     WorkingSetIndex = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a>;
03052     WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> = (<a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>)(Wsle[WorkingSetIndex].u1.Long &gt;&gt; <a class="code" href="../../d4/d8/mi_8h.html#a9">MM_FREE_WSLE_SHIFT</a>);
03053     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> &lt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a>) ||
03054             (WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> == WSLE_NULL_INDEX));
03055 
03056     <span class="keywordflow">if</span> (WsInfo-&gt;WorkingSetSize &gt; WsInfo-&gt;MinimumWorkingSetSize) {
03057         <a class="code" href="../../d4/d8/mi_8h.html#a590">MmPagesAboveWsMinimum</a> += 1;
03058     }
03059     <span class="keywordflow">if</span> (WorkingSetIndex &gt; WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o3">LastEntry</a>) {
03060         WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o3">LastEntry</a> = WorkingSetIndex;
03061     }
03062 
03063     <a class="code" href="../../d4/d0/wslist_8c.html#a25">MiUpdateWsle</a> (&amp;WorkingSetIndex, Va, WorkingSetList, Pfn1);
03064 
03065     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a109">MI_SET_PTE_IN_WORKING_SET</a> (PointerPte, WorkingSetIndex);
03066 
03067     <span class="comment">//</span>
03068     <span class="comment">// Lock any created page table pages into the working set.</span>
03069     <span class="comment">//</span>
03070 
03071     <span class="keywordflow">if</span> (WorkingSetIndex &gt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>) {
03072 
03073         SwapEntry = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>;
03074 
03075         <span class="keywordflow">if</span> (WorkingSetIndex != WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>) {
03076 
03077             <span class="comment">//</span>
03078             <span class="comment">// Swap this entry with the one at first dynamic.</span>
03079             <span class="comment">//</span>
03080 
03081             <a class="code" href="../../d7/d0/wstree_8c.html#a9">MiSwapWslEntries</a> (WorkingSetIndex, SwapEntry, WsInfo);
03082         }
03083 
03084         WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a> += 1;
03085 
03086         Wsle[SwapEntry].u1.e1.LockedInWs = 1;
03087         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Wsle[SwapEntry].u1.e1.Valid == 1);
03088     }
03089 
03090 <span class="preprocessor">#if defined (_WIN64)</span>
03091 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (PageTablePageAllocated == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
03092     
03093         <span class="comment">//</span>
03094         <span class="comment">// As we are growing the working set, make sure the quota is</span>
03095         <span class="comment">// above the working set size by adding 1 to the quota.</span>
03096         <span class="comment">//</span>
03097     
03098         WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a> += 1;
03099     
03100         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
03101     
03102         <a class="code" href="../../d4/d8/mi_8h.html#a121">CONSISTENCY_LOCK_PFN</a> (OldIrql);
03103     
03104         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Event = (PVOID)<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
03105     
03106         <a class="code" href="../../d4/d8/mi_8h.html#a122">CONSISTENCY_UNLOCK_PFN</a> (OldIrql);
03107     
03108         <span class="comment">//</span>
03109         <span class="comment">// Get a working set entry.</span>
03110         <span class="comment">//</span>
03111     
03112         WsInfo-&gt;WorkingSetSize += 1;
03113     
03114         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> != WSLE_NULL_INDEX);
03115         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> &gt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>);
03116     
03117         WorkingSetIndex = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a>;
03118         WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> = (<a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>)(Wsle[WorkingSetIndex].u1.Long &gt;&gt; <a class="code" href="../../d4/d8/mi_8h.html#a9">MM_FREE_WSLE_SHIFT</a>);
03119         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> &lt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a>) ||
03120                 (WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> == WSLE_NULL_INDEX));
03121     
03122         <span class="keywordflow">if</span> (WsInfo-&gt;WorkingSetSize &gt; WsInfo-&gt;MinimumWorkingSetSize) {
03123             <a class="code" href="../../d4/d8/mi_8h.html#a590">MmPagesAboveWsMinimum</a> += 1;
03124         }
03125         <span class="keywordflow">if</span> (WorkingSetIndex &gt; WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o3">LastEntry</a>) {
03126             WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o3">LastEntry</a> = WorkingSetIndex;
03127         }
03128     
03129         <a class="code" href="../../d4/d0/wslist_8c.html#a25">MiUpdateWsle</a> (&amp;WorkingSetIndex, PointerPte, WorkingSetList, Pfn1);
03130     
03131         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a109">MI_SET_PTE_IN_WORKING_SET</a> (PointerPde, WorkingSetIndex);
03132     
03133         <span class="comment">//</span>
03134         <span class="comment">// Lock the created page table page into the working set.</span>
03135         <span class="comment">//</span>
03136     
03137         <span class="keywordflow">if</span> (WorkingSetIndex &gt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>) {
03138     
03139             SwapEntry = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>;
03140     
03141             <span class="keywordflow">if</span> (WorkingSetIndex != WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>) {
03142     
03143                 <span class="comment">//</span>
03144                 <span class="comment">// Swap this entry with the one at first dynamic.</span>
03145                 <span class="comment">//</span>
03146     
03147                 <a class="code" href="../../d7/d0/wstree_8c.html#a9">MiSwapWslEntries</a> (WorkingSetIndex, SwapEntry, WsInfo);
03148             }
03149     
03150             WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a> += 1;
03151     
03152             Wsle[SwapEntry].u1.e1.LockedInWs = 1;
03153             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Wsle[SwapEntry].u1.e1.Valid == 1);
03154         }
03155     }
03156 <span class="preprocessor">#endif</span>
03157 <span class="preprocessor"></span>
03158     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(&amp;Wsle[WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a>]))-&gt;u.Hard.Valid == 1);
03159 
03160     <span class="keywordflow">if</span> ((WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o9">HashTable</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
03161         (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &gt; 20)) {
03162 
03163         <span class="comment">//</span>
03164         <span class="comment">// Add a hash table to support shared pages in the working set to</span>
03165         <span class="comment">// eliminate costly lookups.</span>
03166         <span class="comment">//</span>
03167 
03168         <a class="code" href="../../d4/d8/mi_8h.html#a142">LOCK_EXPANSION_IF_ALPHA</a> (OldIrql);
03169         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WsInfo-&gt;AllowWorkingSetAdjustment != FALSE);
03170         WsInfo-&gt;AllowWorkingSetAdjustment = <a class="code" href="../../d4/d8/mi_8h.html#a32">MM_GROW_WSLE_HASH</a>;
03171         <a class="code" href="../../d4/d8/mi_8h.html#a143">UNLOCK_EXPANSION_IF_ALPHA</a> (OldIrql);
03172     }
03173 
03174     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WsInfo-&gt;WorkingSetSize &lt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a>);
03175     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03176 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a32" doxytag="wslist.c::MiAddWsleHash" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LOGICAL MiAddWsleHash           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>WsInfo</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PointerPte</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d9/wslist_8c-source.html#l03179">3179</a> of file <a class="el" href="../../d5/d9/wslist_8c-source.html">wslist.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05471">_MM_SESSION_SPACE::CommittedPages</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00875">CONSISTENCY_LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00876">CONSISTENCY_UNLOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01585">_MMWSLE::e1</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01600">_MMWSL::FirstDynamic</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01013">MI_GET_PAGE_COLOR_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00494">MI_MAKE_VALID_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00710">MI_SET_PTE_DIRTY</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00641">MI_SET_PTE_IN_WORKING_SET</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02459">MI_WRITE_VALID_PTE</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00329">MiChargeCommitmentCantExpand()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03398">MiInitializePfn()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l00117">MiLocateAndReserveWsle()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l01177">MiRemoveZeroPage()</a>, <a class="el" href="../../d8/d9/wstree_8c-source.html#l00576">MiSwapWslEntries()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l01078">MiUpdateWsle()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05361">MM_BUMP_SESS_COUNTER</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04274">MM_DBG_COMMIT_SESSION_ADDITIONAL_WS_HASHPAGES</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05320">MM_DBG_SESSION_WS_HASHPAGE_ALLOC</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00418">MM_DEMAND_ZERO_WRITE_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00137">MM_READWRITE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04221">MM_TRACK_COMMIT</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00134">MmAvailablePages</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05609">MmSessionSpace</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05463">_MM_SESSION_SPACE::NonPagablePages</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d8/struct__MMWSLE.html#o3">_MMWSLE::u1</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o5">_MMPFN::u1</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01568">_MMWSLENTRY::Valid</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01603">_MMWSL::Wsle</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l01231">WSLE_NUMBER</a>.
<p>
Referenced by <a class="el" href="../../d5/d9/wslist_8c-source.html#l03300">MiGrowWsleHash()</a>.
<p>
<pre class="fragment"><div>03186                    :
03187 
03188     This function adds a page directory, page table or actual mapping page
03189     <span class="keywordflow">for</span> hash table creation (or expansion) <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current process.
03190 
03191 Arguments:
03192 
03193     WsInfo - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set info block <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03194              process (or system cache).
03195 
03196     PointerPte - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PTE to be filled.
03197 
03198 Return Value:
03199 
03200     None.
03201 
03202 Environment:
03203 
03204     Kernel mode, APCs disabled, working set lock held.
03205 
03206 --*/
03207 {
03208     KIRQL OldIrql;
03209     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
03210     ULONG SwapEntry;
03211     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
03212     PVOID Va;
03213     <a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a> Wsle;
03214     PFN_NUMBER WorkingSetPage;
03215     <a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> WorkingSetIndex;
03216     <a class="code" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a> WorkingSetList;
03217 
03218     WorkingSetList = WsInfo-&gt;VmWorkingSetList;
03219     Wsle = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o5">Wsle</a>;
03220 
03221     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;u.Hard.Valid == 0);
03222 
03223     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
03224 
03225     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &lt; 10) {
03226         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03227         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03228     }
03229 
03230     WorkingSetPage = <a class="code" href="../../d7/d5/pfnlist_8c.html#a14">MiRemoveZeroPage</a> (
03231                                 MI_GET_PAGE_COLOR_FROM_PTE (PointerPte));
03232 
03233     PointerPte-&gt;u.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a95">MM_DEMAND_ZERO_WRITE_PTE</a>;
03234     <a class="code" href="../../d8/d2/pagfault_8c.html#a22">MiInitializePfn</a> (WorkingSetPage, PointerPte, 1);
03235 
03236     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a105">MI_MAKE_VALID_PTE</a> (TempPte,
03237                        WorkingSetPage,
03238                        MM_READWRITE,
03239                        PointerPte );
03240 
03241     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a112">MI_SET_PTE_DIRTY</a> (TempPte);
03242     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPte, TempPte);
03243 
03244     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03245 
03246     <span class="comment">//</span>
03247     <span class="comment">// As we are growing the working set, we know that quota</span>
03248     <span class="comment">// is above the current working set size.  Just take the</span>
03249     <span class="comment">// next free WSLE from the list and use it.</span>
03250     <span class="comment">//</span>
03251 
03252     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPte-&gt;u.Hard.PageFrameNumber);
03253 
03254     <a class="code" href="../../d4/d8/mi_8h.html#a121">CONSISTENCY_LOCK_PFN</a> (OldIrql);
03255 
03256     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Event = (PVOID)<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
03257 
03258     <a class="code" href="../../d4/d8/mi_8h.html#a122">CONSISTENCY_UNLOCK_PFN</a> (OldIrql);
03259 
03260     Va = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
03261 
03262     WorkingSetIndex = <a class="code" href="../../d4/d0/wslist_8c.html#a21">MiLocateAndReserveWsle</a> (WsInfo);
03263     <a class="code" href="../../d4/d0/wslist_8c.html#a25">MiUpdateWsle</a> (&amp;WorkingSetIndex, Va, WorkingSetList, Pfn1);
03264     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a109">MI_SET_PTE_IN_WORKING_SET</a> (PointerPte, WorkingSetIndex);
03265 
03266     <span class="comment">//</span>
03267     <span class="comment">// Lock any created page table pages into the working set.</span>
03268     <span class="comment">//</span>
03269 
03270     <span class="keywordflow">if</span> (WorkingSetIndex &gt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>) {
03271 
03272         SwapEntry = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>;
03273 
03274         <span class="keywordflow">if</span> (WorkingSetIndex != WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>) {
03275 
03276             <span class="comment">//</span>
03277             <span class="comment">// Swap this entry with the one at first dynamic.</span>
03278             <span class="comment">//</span>
03279 
03280             <a class="code" href="../../d7/d0/wstree_8c.html#a9">MiSwapWslEntries</a> (WorkingSetIndex, SwapEntry, WsInfo);
03281         }
03282 
03283         WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a> += 1;
03284 
03285         Wsle[SwapEntry].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.LockedInWs = 1;
03286         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Wsle[SwapEntry].u1.e1.Valid == 1);
03287     }
03288 
03289     <span class="keywordflow">if</span> (WsInfo-&gt;u.Flags.SessionSpace == 1) {
03290         <a class="code" href="../../d4/d8/mi_8h.html#a384">MM_BUMP_SESS_COUNTER</a> (MM_DBG_SESSION_WS_HASHPAGE_ALLOC, 1);
03291         <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o13">NonPagablePages</a> += 1;
03292         <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o14">CommittedPages</a> += 1;
03293         <a class="code" href="../../d6/d1/mmquota_8c.html#a18">MiChargeCommitmentCantExpand</a> (1, TRUE);
03294         <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_SESSION_ADDITIONAL_WS_HASHPAGES, 1);
03295     }
03296     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03297 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="wslist.c::MiCheckNullIndex" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiCheckNullIndex           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>WorkingSetList</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d5/d9/wslist_8c-source.html#l04228">MiRemoveWorkingSetPages()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="wslist.c::MiCheckWsleHash" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiCheckWsleHash           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>WorkingSetList</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="wslist.c::MiDoReplacement" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG MiDoReplacement           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>WsInfo</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>MustReplace</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d9/wslist_8c-source.html#l00254">254</a> of file <a class="el" href="../../d5/d9/wslist_8c-source.html">wslist.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l00153">KeQuerySystemTime()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00982">LOCK_EXPANSION_IF_ALPHA</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00043">MEMORY_PRIORITY_FOREGROUND</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01704">MI_BACKGROUND_CLAIM_AVAILABLE_SHIFT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01698">MI_FOREGROUND_CLAIM_AVAILABLE_SHIFT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01682">MI_PASS0_TRIM_AGE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01686">MI_PASS4_TRIM_AGE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05241">MI_SESSION_MAXIMUM_WORKING_SET</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01977">MI_WS_GROWING_TOO_FAST</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l00790">MiReplaceWorkingSetEntryUsingFaultInfo()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l03612">MiTrimWorkingSet()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00117">MM_FORCE_TRIM</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00364">MM_MAXIMUM_WORKING_SET</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00099">MM_NO_WS_EXPANSION</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l00029">MM_SYSTEM_CACHE_THRESHOLD</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01017">MM_SYSTEM_WS_LOCK_ASSERT</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00134">MmAvailablePages</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l00034">MmFaultsTakenToGoAboveMinWs</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04486">MmMoreThanEnoughFreePages</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00064">MmSystemCacheWs</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04533">MmWorkingSetSizeExpansion</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04527">MmWorkingSetSizeIncrement</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04540">MmWsAdjustThreshold</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04547">MmWsExpandThreshold</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01598">_MMWSL::Quota</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00991">UNLOCK_EXPANSION_IF_ALPHA</a>.
<p>
Referenced by <a class="el" href="../../d5/d9/wslist_8c-source.html#l00117">MiLocateAndReserveWsle()</a>.
<p>
<pre class="fragment"><div>00261                    :
00262 
00263     This function determines whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set should be
00264     grown or <span class="keywordflow">if</span> a page should be replaced.  Replacement <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00265     done here <span class="keywordflow">if</span> deemed necessary.
00266 
00267 Arguments:
00268 
00269     WsInfo - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set information structure to replace within.
00270 
00271     MustReplace - Supplies <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> replacement must succeed.
00272 
00273 Return Value:
00274 
00275     Quota increment <span class="keywordflow">if</span> growth <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> necessary.
00276 
00277 Environment:
00278 
00279     Kernel mode, APCs disabled, working set lock.  PFN lock NOT held.
00280 
00281 --*/
00282 
00283 {
00284     <a class="code" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a> WorkingSetList;
00285     ULONG CurrentSize;
00286     LARGE_INTEGER CurrentTime;
00287 <span class="preprocessor">#if defined(_ALPHA_) &amp;&amp; !defined(_AXP64_)</span>
00288 <span class="preprocessor"></span>    KIRQL OldIrql;
00289 <span class="preprocessor">#endif</span>
00290 <span class="preprocessor"></span>    ULONG QuotaIncrement;
00291     PFN_NUMBER AvailablePageThreshold;
00292 <span class="preprocessor">#ifdef _MI_USE_CLAIMS_</span>
00293 <span class="preprocessor"></span>    <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ProcessToTrim;
00294     ULONG Dummy1;
00295     ULONG Dummy2;
00296     ULONG Trim;
00297     ULONG TrimAge;
00298 <span class="preprocessor">#endif</span>
00299 <span class="preprocessor"></span>
00300     WorkingSetList = WsInfo-&gt;VmWorkingSetList;
00301 
00302     <span class="keywordflow">if</span> (WsInfo == &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>) {
00303         <a class="code" href="../../d4/d8/mi_8h.html#a147">MM_SYSTEM_WS_LOCK_ASSERT</a>();
00304         AvailablePageThreshold = <a class="code" href="../../d4/d0/wslist_8c.html#a0">MM_SYSTEM_CACHE_THRESHOLD</a>;
00305     }
00306 
00307     <span class="comment">//</span>
00308     <span class="comment">// Determine the number of pages that need to be available to</span>
00309     <span class="comment">// grow the working set and how much the quota should be</span>
00310     <span class="comment">// boosted if the working set grows over it.</span>
00311     <span class="comment">//</span>
00312     <span class="comment">// If below the Minimum use the defaults.</span>
00313     <span class="comment">//</span>
00314 
00315 recheck:
00316 
00317     AvailablePageThreshold = 0;
00318     QuotaIncrement = 1;
00319 
00320     <span class="keywordflow">if</span> (WsInfo-&gt;WorkingSetSize &gt;= WsInfo-&gt;MinimumWorkingSetSize) {
00321 
00322         <span class="keywordflow">if</span> (WsInfo-&gt;AllowWorkingSetAdjustment == <a class="code" href="../../d4/d8/mi_8h.html#a31">MM_FORCE_TRIM</a>) {
00323 
00324             <span class="comment">//</span>
00325             <span class="comment">// The working set manager cannot attach to this process</span>
00326             <span class="comment">// to trim it.  Force a trim now and update the working</span>
00327             <span class="comment">// set manager's fields properly to indicate a trim occurred.</span>
00328             <span class="comment">//</span>
00329 
00330 <span class="preprocessor">#ifdef _MI_USE_CLAIMS_</span>
00331 <span class="preprocessor"></span>
00332             Trim = WsInfo-&gt;Claim &gt;&gt;
00333                             ((WsInfo-&gt;MemoryPriority == <a class="code" href="../../d1/d9/ps_8h.html#a3">MEMORY_PRIORITY_FOREGROUND</a>)
00334                                 ? <a class="code" href="../../d4/d8/mi_8h.html#a206">MI_FOREGROUND_CLAIM_AVAILABLE_SHIFT</a>
00335                                 : <a class="code" href="../../d4/d8/mi_8h.html#a207">MI_BACKGROUND_CLAIM_AVAILABLE_SHIFT</a>);
00336 
00337             <span class="keywordflow">if</span> (WsInfo == &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>) {
00338                 ProcessToTrim = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00339             }
00340             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (WsInfo-&gt;u.Flags.SessionSpace == 0) {
00341                 ProcessToTrim = CONTAINING_RECORD(WsInfo, <a class="code" href="../../d0/d4/struct__EPROCESS.html">EPROCESS</a>, Vm);
00342             }
00343             <span class="keywordflow">else</span> {
00344                 ProcessToTrim = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;       <span class="comment">// Hydra session.</span>
00345             }
00346 
00347             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &lt; 100) {
00348                 <span class="keywordflow">if</span> (WsInfo-&gt;WorkingSetSize &gt; WsInfo-&gt;MinimumWorkingSetSize) {
00349                     Trim = (WsInfo-&gt;WorkingSetSize - WsInfo-&gt;MinimumWorkingSetSize) &gt;&gt; 2;
00350                 }
00351                 TrimAge = <a class="code" href="../../d4/d8/mi_8h.html#a204">MI_PASS4_TRIM_AGE</a>;
00352             }
00353             <span class="keywordflow">else</span> {
00354                 TrimAge = <a class="code" href="../../d4/d8/mi_8h.html#a200">MI_PASS0_TRIM_AGE</a>;
00355             }
00356 
00357             <a class="code" href="../../d4/d0/wslist_8c.html#a34">MiTrimWorkingSet</a> (Trim, WsInfo, TrimAge);
00358 
00359             MiAgeAndEstimateAvailableInWorkingSet (WsInfo,
00360                                                    TRUE,
00361                                                    &amp;Dummy1,
00362                                                    &amp;Dummy2
00363                                                    );
00364 <span class="preprocessor">#else</span>
00365 <span class="preprocessor"></span>            <a class="code" href="../../d4/d0/wslist_8c.html#a34">MiTrimWorkingSet</a>(20, WsInfo, FALSE);
00366 <span class="preprocessor">#endif</span>
00367 <span class="preprocessor"></span>
00368             <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a> (&amp;CurrentTime);
00369             WsInfo-&gt;LastTrimTime = CurrentTime;
00370             WsInfo-&gt;LastTrimFaultCount = WsInfo-&gt;PageFaultCount;
00371 <span class="preprocessor">#if defined(_ALPHA_) &amp;&amp; !defined(_AXP64_)</span>
00372 <span class="preprocessor"></span>            <a class="code" href="../../d4/d8/mi_8h.html#a142">LOCK_EXPANSION_IF_ALPHA</a> (OldIrql);
00373 <span class="preprocessor">#endif</span>
00374 <span class="preprocessor"></span>            WsInfo-&gt;AllowWorkingSetAdjustment = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00375 <span class="preprocessor">#if defined(_ALPHA_) &amp;&amp; !defined(_AXP64_)</span>
00376 <span class="preprocessor"></span>            <a class="code" href="../../d4/d8/mi_8h.html#a143">UNLOCK_EXPANSION_IF_ALPHA</a> (OldIrql);
00377 <span class="preprocessor">#endif</span>
00378 <span class="preprocessor"></span>
00379             <span class="comment">//</span>
00380             <span class="comment">// Set the quota to the current size.</span>
00381             <span class="comment">//</span>
00382 
00383             WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a> = WsInfo-&gt;WorkingSetSize;
00384             <span class="keywordflow">if</span> (WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a> &lt; WsInfo-&gt;MinimumWorkingSetSize) {
00385                 WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a> = WsInfo-&gt;MinimumWorkingSetSize;
00386             }
00387 
00388             <span class="keywordflow">goto</span> recheck;
00389         }
00390 
00391         CurrentSize = WsInfo-&gt;WorkingSetSize;
00392         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (CurrentSize &lt;= (WorkingSetList-&gt;LastInitializedWsle + 1));
00393 
00394         <span class="keywordflow">if</span> ((WsInfo-&gt;u.Flags.WorkingSetHard) &amp;&amp; (CurrentSize &gt;= WsInfo-&gt;MaximumWorkingSetSize)) {
00395 
00396             <span class="comment">//</span>
00397             <span class="comment">// This is an enforced working set maximum triggering a replace.</span>
00398             <span class="comment">//</span>
00399 
00400 <span class="preprocessor">#ifdef _MI_USE_CLAIMS_</span>
00401 <span class="preprocessor"></span>            MiReplaceWorkingSetEntryUsingClaim (WsInfo, MustReplace);
00402 <span class="preprocessor">#else</span>
00403 <span class="preprocessor"></span>            <a class="code" href="../../d4/d0/wslist_8c.html#a13">MiReplaceWorkingSetEntryUsingFaultInfo</a> (WsInfo, MustReplace);
00404 <span class="preprocessor">#endif</span>
00405 <span class="preprocessor"></span>            <span class="keywordflow">return</span> 0;
00406         }
00407 
00408 <span class="preprocessor">#ifdef _MI_USE_CLAIMS_</span>
00409 <span class="preprocessor"></span>
00410         <span class="comment">//</span>
00411         <span class="comment">// If using claims, don't grow if</span>
00412         <span class="comment">//      - we're over the max</span>
00413         <span class="comment">//      - there aren't any pages to take</span>
00414         <span class="comment">//      - or if we are growing too much in this</span>
00415         <span class="comment">//        time interval and there isn't much</span>
00416         <span class="comment">//        memory available</span>
00417         <span class="comment">//</span>
00418 
00419         <span class="keywordflow">if</span> (CurrentSize &gt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a70">MM_MAXIMUM_WORKING_SET</a> || <a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> == 0 || MustReplace == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00420 
00421             <span class="comment">//</span>
00422             <span class="comment">// Can't grow this one.</span>
00423             <span class="comment">//</span>
00424 
00425             AvailablePageThreshold = 0xffffffff;
00426             MiReplacing = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00427         }
00428 <span class="preprocessor">#if defined (_X86PAE_)</span>
00429 <span class="preprocessor"></span>        <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((WsInfo-&gt;u.Flags.SessionSpace == 1) &amp;&amp; (CurrentSize &gt; <a class="code" href="../../d4/d8/mi_8h.html#a340">MI_SESSION_MAXIMUM_WORKING_SET</a>)) {
00430 
00431             <span class="comment">//</span>
00432             <span class="comment">// Can't grow this one.</span>
00433             <span class="comment">//</span>
00434 
00435             AvailablePageThreshold = 0xffffffff;
00436             MiReplacing = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00437         }
00438 <span class="preprocessor">#endif</span>
00439 <span class="preprocessor"></span>        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &lt; 10000 &amp;&amp; <a class="code" href="../../d4/d8/mi_8h.html#a216">MI_WS_GROWING_TOO_FAST</a>(WsInfo)) {
00440 
00441             <span class="comment">//</span>
00442             <span class="comment">// Can't grow this one either.</span>
00443             <span class="comment">//</span>
00444 
00445             AvailablePageThreshold = 0xffffffff;
00446             MiReplacing = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00447         }
00448 <span class="preprocessor">#else</span>
00449 <span class="preprocessor"></span>        <span class="comment">//</span>
00450         <span class="comment">// Not using claims, base the growth on how much faulting</span>
00451         <span class="comment">// the process is doing.</span>
00452         <span class="comment">//</span>
00453 
00454         <span class="keywordflow">if</span> (MustReplace == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00455             AvailablePageThreshold = 0xffffffff;
00456         }
00457         <span class="keywordflow">if</span> (CurrentSize &lt; WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a>) {
00458 
00459             <span class="comment">//</span>
00460             <span class="comment">// Working set is below quota, allow it to grow with few pages</span>
00461             <span class="comment">// available.</span>
00462             <span class="comment">//</span>
00463 
00464             AvailablePageThreshold = 10;
00465             QuotaIncrement = 1;
00466         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (CurrentSize &lt; WsInfo-&gt;MaximumWorkingSetSize) {
00467 
00468             <span class="comment">//</span>
00469             <span class="comment">// Working set is between min and max.  Allow it to grow if enough</span>
00470             <span class="comment">// faults have been taken since last adjustment.</span>
00471             <span class="comment">//</span>
00472 
00473             <span class="keywordflow">if</span> ((WsInfo-&gt;PageFaultCount - WsInfo-&gt;LastTrimFaultCount) &lt;
00474                     <a class="code" href="../../d4/d0/wslist_8c.html#a4">MmFaultsTakenToGoAboveMinWs</a>) {
00475                 AvailablePageThreshold = <a class="code" href="../../d4/d8/mi_8h.html#a588">MmMoreThanEnoughFreePages</a> + 200;
00476                 <span class="keywordflow">if</span> (WsInfo-&gt;MemoryPriority == <a class="code" href="../../d1/d9/ps_8h.html#a3">MEMORY_PRIORITY_FOREGROUND</a>) {
00477                     AvailablePageThreshold -= 250;
00478                 }
00479             } <span class="keywordflow">else</span> {
00480                 AvailablePageThreshold = <a class="code" href="../../d4/d8/mi_8h.html#a595">MmWsAdjustThreshold</a>;
00481             }
00482             QuotaIncrement = (ULONG)<a class="code" href="../../d4/d8/mi_8h.html#a593">MmWorkingSetSizeIncrement</a>;
00483         } <span class="keywordflow">else</span> {
00484 
00485             <span class="comment">//</span>
00486             <span class="comment">// Working set is above max.</span>
00487             <span class="comment">//</span>
00488 
00489             <span class="keywordflow">if</span> ((WsInfo-&gt;PageFaultCount - WsInfo-&gt;LastTrimFaultCount) &lt;
00490                     (CurrentSize &gt;&gt; 3))
00491             {
00492                 AvailablePageThreshold = <a class="code" href="../../d4/d8/mi_8h.html#a588">MmMoreThanEnoughFreePages</a> + 200;
00493                 <span class="keywordflow">if</span> (WsInfo-&gt;MemoryPriority == <a class="code" href="../../d1/d9/ps_8h.html#a3">MEMORY_PRIORITY_FOREGROUND</a>) {
00494                     AvailablePageThreshold -= 250;
00495                 }
00496             } <span class="keywordflow">else</span> {
00497                 AvailablePageThreshold += <a class="code" href="../../d4/d8/mi_8h.html#a596">MmWsExpandThreshold</a>;
00498             }
00499             QuotaIncrement = (ULONG)<a class="code" href="../../d4/d8/mi_8h.html#a594">MmWorkingSetSizeExpansion</a>;
00500 
00501             <span class="keywordflow">if</span> (CurrentSize &gt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a70">MM_MAXIMUM_WORKING_SET</a>) {
00502                 AvailablePageThreshold = 0xffffffff;
00503                 QuotaIncrement = 1;
00504             }
00505 <span class="preprocessor">#if defined (_X86PAE_)</span>
00506 <span class="preprocessor"></span>            <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((WsInfo-&gt;u.Flags.SessionSpace == 1) &amp;&amp; (CurrentSize &gt; <a class="code" href="../../d4/d8/mi_8h.html#a340">MI_SESSION_MAXIMUM_WORKING_SET</a>)) {
00507                 AvailablePageThreshold = 0xffffffff;
00508                 QuotaIncrement = 1;
00509             }
00510 <span class="preprocessor">#endif</span>
00511 <span class="preprocessor"></span>        }
00512 <span class="preprocessor">#endif</span>
00513 <span class="preprocessor"></span>    }
00514 
00515     <span class="comment">//</span>
00516     <span class="comment">// If there isn't enough memory to allow growth, find a good page</span>
00517     <span class="comment">// to remove and remove it.</span>
00518     <span class="comment">//</span>
00519 
00520     <span class="keywordflow">if</span> (WsInfo-&gt;AddressSpaceBeingDeleted == 0 &amp;&amp; AvailablePageThreshold != 0) {
00521         <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &lt;= AvailablePageThreshold) ||
00522              (WsInfo-&gt;WorkingSetExpansionLinks.Flink == <a class="code" href="../../d4/d8/mi_8h.html#a20">MM_NO_WS_EXPANSION</a>)) {
00523 
00524 <span class="preprocessor">#ifdef _MI_USE_CLAIMS_</span>
00525 <span class="preprocessor"></span>            MiReplaceWorkingSetEntryUsingClaim (WsInfo, MustReplace);
00526 <span class="preprocessor">#else</span>
00527 <span class="preprocessor"></span>            <a class="code" href="../../d4/d0/wslist_8c.html#a13">MiReplaceWorkingSetEntryUsingFaultInfo</a> (WsInfo, MustReplace);
00528 <span class="preprocessor">#endif</span>
00529 <span class="preprocessor"></span>        }
00530         <span class="keywordflow">else</span> {
00531             WsInfo-&gt;GrowthSinceLastEstimate += 1;
00532         }
00533     }
00534     <span class="keywordflow">else</span> {
00535         WsInfo-&gt;GrowthSinceLastEstimate += 1;
00536     }
00537 
00538     <span class="keywordflow">return</span> QuotaIncrement;
00539 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="wslist.c::MiDumpPteInCacheBlock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG MiDumpPteInCacheBlock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>PointerPte</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="wslist.c::MiDumpWsleInCacheBlock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiDumpWsleInCacheBlock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>CachePte</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d5/d9/wslist_8c-source.html#l01326">MiFreeWsle()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="wslist.c::MiEliminateWorkingSetEntry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiEliminateWorkingSetEntry           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>WorkingSetIndex</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PointerPte</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Pfn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Wsle</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d9/wslist_8c-source.html#l03974">3974</a> of file <a class="el" href="../../d5/d9/wslist_8c-source.html">wslist.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d1/d5/ppc_2flushtb_8c-source.html#l00188">KeFlushSingleTb()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02228">MI_CAPTURE_DIRTY_BIT_TO_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02841">MI_FLUSH_SINGLE_SESSION_TB</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01589">MI_GET_PROTECTION_FROM_WSLE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00757">MI_IS_PTE_DIRTY</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05287">MI_IS_SESSION_IMAGE_ADDRESS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00535">MI_MAKE_VALID_PTE_TRANSITION</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02074">MI_MAKING_VALID_PTE_INVALID</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02336">MI_PTE_LOOKUP_NEEDED</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01521">MI_ZERO_WSINDEX</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02440">MiActiveWriteWatch</a>, <a class="el" href="../../d4/d8/mi_8h.html#a772">MiCaptureWriteWatchDirtyBit()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03125">MiCheckPdeForPagedPool()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02759">MiDecrementShareAndValidCount</a>, <a class="el" href="../../d7/d4/pfndec_8c-source.html#l00030">MiDecrementShareCount()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01495">MiProtoAddressForPte</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00951">MM_PFN_LOCK_ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04754">MmSystemCacheWsle</a>, <a class="el" href="../../d1/d8/miglobal_8c-source.html#l00444">MmWsle</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d3/d6/struct__MMSUPPORT.html#o15">_MMSUPPORT::u</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, and <a class="el" href="../../d2/d8/ps_8h-source.html#l00196">_EPROCESS::Vm</a>.
<p>
Referenced by <a class="el" href="../../d5/d9/wslist_8c-source.html#l01326">MiFreeWsle()</a>, and <a class="el" href="../../d5/d9/wslist_8c-source.html#l00899">MiRemovePageFromWorkingSet()</a>.
<p>
<pre class="fragment"><div>03983                    :
03984 
03985     This routine removes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified working set list entry
03986     from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set, flushes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> TB <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page, decrements
03987     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> share count <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical page, and, <span class="keywordflow">if</span> necessary turns
03988     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PTE into a transition PTE.
03989 
03990 Arguments:
03991 
03992     WorkingSetIndex - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set index to remove.
03993 
03994     PointerPte - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PTE corresponding to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span>
03995                  address in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set.
03996 
03997     Pfn - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PFN element corresponding to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PTE.
03998 
03999     Wsle - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first working set list entry <span class="keywordflow">for</span> <span class="keyword">this</span>
04000            working set.
04001 
04002 Return Value:
04003 
04004     None.
04005 
04006 Environment:
04007 
04008     Kernel mode, Working set lock and PFN lock held, APCs disabled.
04009 
04010 --*/
04011 
04012 {
04013     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> ContainingPageTablePage;
04014     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
04015     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PreviousPte;
04016     PFN_NUMBER PageFrameIndex;
04017     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
04018     PVOID VirtualAddress;
04019 
04020     <span class="comment">//</span>
04021     <span class="comment">// Remove the page from the working set.</span>
04022     <span class="comment">//</span>
04023 
04024     <a class="code" href="../../d4/d8/mi_8h.html#a136">MM_PFN_LOCK_ASSERT</a> ();
04025 
04026     TempPte = *PointerPte;
04027     PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (&amp;TempPte);
04028 
04029 <span class="preprocessor">#ifdef _X86_</span>
04030 <span class="preprocessor"></span><span class="preprocessor">#if DBG</span>
04031 <span class="preprocessor"></span><span class="preprocessor">#if !defined(NT_UP)</span>
04032 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Writable == 1) {
04033         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Dirty == 1);
04034     }
04035     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Accessed == 1);
04036 <span class="preprocessor">#endif //NTUP</span>
04037 <span class="preprocessor"></span><span class="preprocessor">#endif //DBG</span>
04038 <span class="preprocessor"></span><span class="preprocessor">#endif //X86</span>
04039 <span class="preprocessor"></span>
04040     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a172">MI_MAKING_VALID_PTE_INVALID</a> (FALSE);
04041 
04042     <span class="keywordflow">if</span> (Pfn-&gt;u3.e1.PrototypePte) {
04043 
04044         <span class="comment">//</span>
04045         <span class="comment">// This is a prototype PTE.  The PFN database does not contain</span>
04046         <span class="comment">// the contents of this PTE it contains the contents of the</span>
04047         <span class="comment">// prototype PTE.  This PTE must be reconstructed to contain</span>
04048         <span class="comment">// a pointer to the prototype PTE.</span>
04049         <span class="comment">//</span>
04050         <span class="comment">// The working set list entry contains information about</span>
04051         <span class="comment">// how to reconstruct the PTE.</span>
04052         <span class="comment">//</span>
04053 
04054         <span class="keywordflow">if</span> (Wsle[WorkingSetIndex].u1.e1.SameProtectAsProto == 0) {
04055 
04056             <span class="comment">//</span>
04057             <span class="comment">// The protection for the prototype PTE is in the</span>
04058             <span class="comment">// WSLE.</span>
04059             <span class="comment">//</span>
04060 
04061             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Wsle[WorkingSetIndex].u1.e1.Protection != 0);
04062 
04063             <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d8/mi_8h.html#a352">MI_IS_SESSION_IMAGE_ADDRESS</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPte))) {
04064                 TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = 0;
04065                 TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection =
04066                     <a class="code" href="../../d4/d8/mi_8h.html#a192">MI_GET_PROTECTION_FROM_WSLE</a> (&amp;Wsle[WorkingSetIndex]);
04067                 TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.PageFileHigh = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a181">MI_PTE_LOOKUP_NEEDED</a>;
04068             }
04069             <span class="keywordflow">else</span> {
04070 
04071                 <span class="comment">//</span>
04072                 <span class="comment">// The session PTE protection must be carefully preserved.</span>
04073                 <span class="comment">//</span>
04074     
04075                 TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a145">MiProtoAddressForPte</a> (Pfn-&gt;PteAddress);
04076             }
04077         } <span class="keywordflow">else</span> {
04078 
04079             <span class="comment">//</span>
04080             <span class="comment">// The protection is in the prototype PTE.</span>
04081             <span class="comment">//</span>
04082 
04083             TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a145">MiProtoAddressForPte</a> (Pfn-&gt;PteAddress);
04084 
04085             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a352">MI_IS_SESSION_IMAGE_ADDRESS</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPte))) {
04086     
04087                 <span class="comment">//</span>
04088                 <span class="comment">// The session PTE protection must be carefully preserved.</span>
04089                 <span class="comment">//</span>
04090     
04091                 TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Proto.ReadOnly = 1;
04092             }
04093         }
04094     
04095         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Proto.Prototype = 1;
04096 
04097         <span class="comment">//</span>
04098         <span class="comment">// Decrement the share count of the containing page table</span>
04099         <span class="comment">// page as the PTE for the removed page is no longer valid</span>
04100         <span class="comment">// or in transition</span>
04101         <span class="comment">//</span>
04102 
04103         ContainingPageTablePage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPte);
04104 <span class="preprocessor">#if defined (_WIN64)</span>
04105 <span class="preprocessor"></span>        <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ContainingPageTablePage-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
04106 <span class="preprocessor">#else</span>
04107 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (ContainingPageTablePage-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
04108             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(MiCheckPdeForPagedPool (PointerPte))) {
04109                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (MEMORY_MANAGEMENT,
04110                               0x61940, 
04111                               (ULONG_PTR)PointerPte,
04112                               (ULONG_PTR)ContainingPageTablePage-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long,
04113                               (ULONG_PTR)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPte));
04114             }
04115         }
04116 <span class="preprocessor">#endif</span>
04117 <span class="preprocessor"></span>        <a class="code" href="../../d4/d8/mi_8h.html#a242">MiDecrementShareAndValidCount</a> (MI_GET_PAGE_FRAME_FROM_PTE (ContainingPageTablePage));
04118 
04119     } <span class="keywordflow">else</span> {
04120 
04121         <span class="comment">//</span>
04122         <span class="comment">// This is a private page, make it transition.</span>
04123         <span class="comment">//</span>
04124 
04125         <span class="comment">//</span>
04126         <span class="comment">// Assert that the share count is 1 for all user mode pages.</span>
04127         <span class="comment">//</span>
04128 
04129         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((Pfn-&gt;u2.ShareCount == 1) ||
04130                 (Wsle[WorkingSetIndex].u1.VirtualAddress &gt;
04131                         (PVOID)MM_HIGHEST_USER_ADDRESS));
04132 
04133         <span class="comment">//</span>
04134         <span class="comment">// Set the working set index to zero.  This allows page table</span>
04135         <span class="comment">// pages to be brought back in with the proper WSINDEX.</span>
04136         <span class="comment">//</span>
04137 
04138         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn-&gt;u1.WsIndex != 0);
04139         <a class="code" href="../../d4/d8/mi_8h.html#a190">MI_ZERO_WSINDEX</a> (Pfn);
04140         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a106">MI_MAKE_VALID_PTE_TRANSITION</a> (TempPte,
04141                                       Pfn-&gt;OriginalPte.u.Soft.Protection);
04142     }
04143 
04144     <span class="keywordflow">if</span> (Wsle == <a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>) {
04145         PreviousPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush = <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a2">KeFlushSingleTb</a> (
04146                                     Wsle[WorkingSetIndex].u1.VirtualAddress,
04147                                     TRUE,
04148                                     FALSE,
04149                                     (PHARDWARE_PTE)PointerPte,
04150                                     TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush);
04151     }
04152     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Wsle == <a class="code" href="../../d4/d8/mi_8h.html#a658">MmSystemCacheWsle</a>) {
04153 
04154         <span class="comment">//</span>
04155         <span class="comment">// Must be the system cache.</span>
04156         <span class="comment">//</span>
04157 
04158         PreviousPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush = <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a2">KeFlushSingleTb</a> (
04159                                     Wsle[WorkingSetIndex].u1.VirtualAddress,
04160                                     TRUE,
04161                                     TRUE,
04162                                     (PHARDWARE_PTE)PointerPte,
04163                                     TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush);
04164     }
04165     <span class="keywordflow">else</span> {
04166 
04167         <span class="comment">//</span>
04168         <span class="comment">// Must be a session space.</span>
04169         <span class="comment">//</span>
04170 
04171         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a199">MI_FLUSH_SINGLE_SESSION_TB</a> (Wsle[WorkingSetIndex].u1.VirtualAddress,
04172                                     TRUE,
04173                                     FALSE,
04174                                     (PHARDWARE_PTE)PointerPte,
04175                                     TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush,
04176                                     PreviousPte);
04177     }
04178 
04179     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PreviousPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
04180 
04181     <span class="comment">//</span>
04182     <span class="comment">// A page is being removed from the working set, on certain</span>
04183     <span class="comment">// hardware the dirty bit should be ORed into the modify bit in</span>
04184     <span class="comment">// the PFN element.</span>
04185     <span class="comment">//</span>
04186 
04187     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a177">MI_CAPTURE_DIRTY_BIT_TO_PFN</a> (&amp;PreviousPte, Pfn);
04188 
04189     <span class="comment">//</span>
04190     <span class="comment">// If the PTE indicates the page has been modified (this is different</span>
04191     <span class="comment">// from the PFN indicating this), then ripple it back to the write watch</span>
04192     <span class="comment">// bitmap now since we are still in the correct process context.</span>
04193     <span class="comment">//</span>
04194 
04195     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a495">MiActiveWriteWatch</a> != 0) {
04196         <span class="keywordflow">if</span> ((Pfn-&gt;u3.e1.PrototypePte == 0) &amp;&amp;
04197             (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a114">MI_IS_PTE_DIRTY</a>(PreviousPte))) {
04198 
04199             Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
04200 
04201             <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.WriteWatch == 1) {
04202 
04203                 <span class="comment">//</span>
04204                 <span class="comment">// This process has (or had) write watch VADs.  Search now</span>
04205                 <span class="comment">// for a write watch region encapsulating the PTE being</span>
04206                 <span class="comment">// invalidated.</span>
04207                 <span class="comment">//</span>
04208 
04209                 VirtualAddress = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
04210                 <a class="code" href="../../d4/d8/mi_8h.html#a772">MiCaptureWriteWatchDirtyBit</a> (Process, VirtualAddress);
04211             }
04212         }
04213     }
04214 
04215     <span class="comment">//</span>
04216     <span class="comment">// Flush the translation buffer and decrement the number of valid</span>
04217     <span class="comment">// PTEs within the containing page table page.  Note that for a</span>
04218     <span class="comment">// private page, the page table page is still needed because the</span>
04219     <span class="comment">// page is in transition.</span>
04220     <span class="comment">//</span>
04221 
04222     <a class="code" href="../../d6/d5/pfndec_8c.html#a1">MiDecrementShareCount</a> (PageFrameIndex);
04223 
04224     <span class="keywordflow">return</span>;
04225 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a35" doxytag="wslist.c::MiEmptyWorkingSet" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MiEmptyWorkingSet           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>WsInfo</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LOGICAL&nbsp;</td>
          <td class="mdname" nowrap> <em>WaitOk</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d9/wslist_8c-source.html#l04726">4726</a> of file <a class="el" href="../../d5/d9/wslist_8c-source.html">wslist.c</a>.
<p>
References <a class="el" href="../../d2/d8/ps_8h-source.html#l00216">_EPROCESS::AddressSpaceDeleted</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00051">Count</a>, <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l00598">ExTryToAcquireResourceExclusiveLite()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01600">_MMWSL::FirstDynamic</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01599">_MMWSL::FirstFree</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00140">KeDelayExecutionThread()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01601">_MMWSL::LastEntry</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01605">_MMWSL::LastInitializedWsle</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05688">LOCK_SESSION_SPACE_WS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00998">LOCK_SYSTEM_WS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01039">LOCK_WS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l01326">MiFreeWsle()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04438">MiHydra</a>, <a class="el" href="../../d4/d0/wslist_8c.html#a17">MiRemoveWorkingSetPages()</a>, <a class="el" href="../../d0/d3/dynmem_8c-source.html#l00026">MiTrimRemovalPagesOnly</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00076">MM_FREE_WSLE_SHIFT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05677">MM_SET_SESSION_RESOURCE_OWNER</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00215">MmShortTime</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00064">MmSystemCacheWs</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00996">MmSystemLockOwner</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04887">MmSystemWsLock</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01602">_MMWSL::NextSlot</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02174">PERFINFO_GET_PAGE_INFO</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02195">PERFINFO_LOG_WS_REMOVAL</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02201">PERFINFO_PAGE_INFO_DECL</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01298">_MMPFN::PteFrame</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01598">_MMWSL::Quota</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d3/d6/struct__MMSUPPORT.html#o15">_MMSUPPORT::u</a>, <a class="el" href="../../d1/d8/struct__MMWSLE.html#o3">_MMWSLE::u1</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05694">UNLOCK_SESSION_SPACE_WS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01005">UNLOCK_SYSTEM_WS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01081">UNLOCK_WS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01583">_MMWSLE::VirtualAddress</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00211">_EPROCESS::WorkingSetLock</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01603">_MMWSL::Wsle</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00078">WSLE_NULL_INDEX</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l05559">_MM_SESSION_SPACE::WsLock</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l02788">MiEmptyAllWorkingSetsWorker()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l02450">MmAdjustWorkingSetSize()</a>, and <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l02986">MmTrimAllSystemPagableMemory()</a>.
<p>
<pre class="fragment"><div>04733                    :
04734 
04735     This routine frees all pages from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set.
04736 
04737 Arguments:
04738 
04739     WsInfo - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set information entry to trim.
04740 
04741     WaitOk - Supplies <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller can wait, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> not.
04742 
04743 Return Value:
04744 
04745     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> of operation.
04746 
04747 Environment:
04748 
04749     Kernel mode. No locks.  For session operations, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> responsible
04750     <span class="keywordflow">for</span> attaching into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> proper session.
04751 
04752 --*/
04753 
04754 {
04755     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
04756     KIRQL OldIrql;
04757     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
04758     ULONG Entry;
04759     ULONG <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
04760     ULONG LastFreed;
04761     <a class="code" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a> WorkingSetList;
04762     <a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a> Wsle;
04763     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
04764     PFN_NUMBER PageFrameIndex;
04765     ULONG Last;
04766     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04767     <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html">PMM_SESSION_SPACE</a> SessionSpace;
04768 
04769     <span class="keywordflow">if</span> (WsInfo == &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>) {
04770         <span class="keywordflow">if</span> (WaitOk == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
04771             <a class="code" href="../../d4/d8/mi_8h.html#a144">LOCK_SYSTEM_WS</a> (OldIrql);
04772         }
04773         <span class="keywordflow">else</span> {
04774             <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a> (APC_LEVEL, &amp;OldIrql);
04775             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d8/ex_8h.html#a272">ExTryToAcquireResourceExclusiveLite</a> (&amp;MmSystemWsLock)) {
04776 
04777                 <span class="comment">//</span>
04778                 <span class="comment">// System working set lock was not granted, don't trim</span>
04779                 <span class="comment">// the system cache.</span>
04780                 <span class="comment">//</span>
04781 
04782                 <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a> (OldIrql);
04783                 <span class="keywordflow">return</span> STATUS_SUCCESS;
04784             }
04785 
04786             <a class="code" href="../../d4/d8/mi_8h.html#a434">MmSystemLockOwner</a> = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
04787         }
04788     }
04789     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (WsInfo-&gt;u.Flags.SessionSpace == 0) {
04790         Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a> ();
04791         <span class="keywordflow">if</span> (WaitOk == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
04792             <a class="code" href="../../d4/d8/mi_8h.html#a154">LOCK_WS</a> (Process);
04793         }
04794         <span class="keywordflow">else</span> {
04795             <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = 0;
04796             <span class="keywordflow">do</span> {
04797                 <span class="keywordflow">if</span> (ExTryToAcquireFastMutex(&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o22">WorkingSetLock</a>) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
04798                     <span class="keywordflow">break</span>;
04799                 }
04800                 <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a> (KernelMode, FALSE, &amp;MmShortTime);
04801                 <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> += 1;
04802                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> == 5) {
04803 
04804                     <span class="comment">//</span>
04805                     <span class="comment">// Could not get the lock, don't trim this process.</span>
04806                     <span class="comment">//</span>
04807 
04808                     <span class="keywordflow">return</span> STATUS_SUCCESS;
04809                 }
04810             } <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
04811         }
04812         <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o27">AddressSpaceDeleted</a> != 0) {
04813             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_PROCESS_IS_TERMINATING;
04814             <span class="keywordflow">goto</span> Deleted;
04815         }
04816     }
04817     <span class="keywordflow">else</span> {
04818         <span class="keywordflow">if</span> (WaitOk == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
04819             <a class="code" href="../../d4/d8/mi_8h.html#a407">LOCK_SESSION_SPACE_WS</a> (OldIrql);
04820         }
04821         <span class="keywordflow">else</span> {
04822             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MiHydra == TRUE);
04823             SessionSpace = CONTAINING_RECORD(WsInfo,
04824                                              <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html">MM_SESSION_SPACE</a>,
04825                                              Vm);
04826 
04827             <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a> (APC_LEVEL, &amp;OldIrql);
04828 
04829             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d8/ex_8h.html#a272">ExTryToAcquireResourceExclusiveLite</a> (&amp;SessionSpace-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o32">WsLock</a>)) {
04830 
04831                 <span class="comment">//</span>
04832                 <span class="comment">// This session space's working set lock was not</span>
04833                 <span class="comment">// granted, don't trim it.</span>
04834                 <span class="comment">//</span>
04835 
04836                 <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a> (OldIrql);
04837                 <span class="keywordflow">return</span> STATUS_SUCCESS;
04838             }
04839 
04840             <a class="code" href="../../d4/d8/mi_8h.html#a404">MM_SET_SESSION_RESOURCE_OWNER</a>();
04841         }
04842     }
04843 
04844     WorkingSetList = WsInfo-&gt;VmWorkingSetList;
04845     Wsle = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o5">Wsle</a>;
04846 
04847     <span class="comment">//</span>
04848     <span class="comment">// Attempt to remove the pages starting at the bottom.</span>
04849     <span class="comment">//</span>
04850 
04851     LastFreed = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o3">LastEntry</a>;
04852     <span class="keywordflow">for</span> (Entry = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>; Entry &lt;= LastFreed; Entry += 1) {
04853 
04854         <span class="keywordflow">if</span> (Wsle[Entry].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid != 0) {
04855             <a class="code" href="../../d2/d1/mm_8h.html#a80">PERFINFO_PAGE_INFO_DECL</a>();
04856 
04857             PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (Wsle[Entry].u1.VirtualAddress);
04858 
04859             <a class="code" href="../../d2/d1/mm_8h.html#a53">PERFINFO_GET_PAGE_INFO</a>(PointerPte);
04860 
04861             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/dynmem_8c.html#a2">MiTrimRemovalPagesOnly</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
04862                 PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
04863                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
04864                 <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.RemovalRequested == 0) {
04865                     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
04866                     <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.RemovalRequested == 0) {
04867 <span class="preprocessor">#if defined (_WIN64)</span>
04868 <span class="preprocessor"></span>                        Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
04869                         <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.RemovalRequested == 0) {
04870                             <span class="keywordflow">continue</span>;
04871                         }
04872 <span class="preprocessor">#else</span>
04873 <span class="preprocessor"></span>                        <span class="keywordflow">continue</span>;
04874 <span class="preprocessor">#endif</span>
04875 <span class="preprocessor"></span>                    }
04876                 }
04877             }
04878 
04879             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/wslist_8c.html#a26">MiFreeWsle</a> (Entry, WsInfo, PointerPte)) {
04880                 <a class="code" href="../../d2/d1/mm_8h.html#a74">PERFINFO_LOG_WS_REMOVAL</a>(PERFINFO_LOG_TYPE_OUTWS_EMPTYQ, WsInfo);
04881             }
04882         }
04883     }
04884 
04885     <span class="keywordflow">if</span> (WsInfo != &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a> &amp;&amp; WsInfo-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionSpace == 0) {
04886         <a class="code" href="../../d4/d0/wslist_8c.html#a17">MiRemoveWorkingSetPages</a> (WorkingSetList,WsInfo);
04887     }
04888     WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a> = WsInfo-&gt;WorkingSetSize;
04889     WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o4">NextSlot</a> = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>;
04890 
04891     <span class="comment">//</span>
04892     <span class="comment">// Attempt to remove the pages from the front to the end.</span>
04893     <span class="comment">//</span>
04894 
04895     <span class="comment">//</span>
04896     <span class="comment">// Reorder the free list.</span>
04897     <span class="comment">//</span>
04898 
04899     Last = 0;
04900     Entry = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>;
04901     LastFreed = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a>;
04902     <span class="keywordflow">while</span> (Entry &lt;= LastFreed) {
04903         <span class="keywordflow">if</span> (Wsle[Entry].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid == 0) {
04904             <span class="keywordflow">if</span> (Last == 0) {
04905                 WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> = Entry;
04906             } <span class="keywordflow">else</span> {
04907                 Wsle[Last].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.Long = Entry &lt;&lt; <a class="code" href="../../d4/d8/mi_8h.html#a9">MM_FREE_WSLE_SHIFT</a>;
04908             }
04909             Last = Entry;
04910         }
04911         Entry += 1;
04912     }
04913     <span class="keywordflow">if</span> (Last != 0) {
04914         Wsle[Last].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.Long = <a class="code" href="../../d4/d8/mi_8h.html#a10">WSLE_NULL_INDEX</a> &lt;&lt; <a class="code" href="../../d4/d8/mi_8h.html#a9">MM_FREE_WSLE_SHIFT</a>;  <span class="comment">// End of list.</span>
04915     }
04916     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
04917 Deleted:
04918 
04919     <span class="keywordflow">if</span> (WsInfo == &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>) {
04920         <a class="code" href="../../d4/d8/mi_8h.html#a145">UNLOCK_SYSTEM_WS</a> (OldIrql);
04921     }
04922     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (WsInfo-&gt;u.Flags.SessionSpace == 0) {
04923         <a class="code" href="../../d4/d8/mi_8h.html#a158">UNLOCK_WS</a> (Process);
04924     }
04925     <span class="keywordflow">else</span> {
04926         <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a> (OldIrql);
04927     }
04928 
04929     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04930 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="wslist.c::MiFreeWsle" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG MiFreeWsle           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>WorkingSetIndex</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>WsInfo</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PointerPte</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d9/wslist_8c-source.html#l01326">1326</a> of file <a class="el" href="../../d5/d9/wslist_8c-source.html">wslist.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01585">_MMWSLE::e1</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01600">_MMWSL::FirstDynamic</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01599">_MMWSL::FirstFree</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01605">_MMWSL::LastInitializedWsle</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05293">MI_IS_SESSION_ADDRESS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d4/d0/wslist_8c.html#a19">MiDumpWsleInCacheBlock()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l03974">MiEliminateWorkingSetEntry()</a>, <a class="el" href="../../d8/d9/wstree_8c-source.html#l00464">MiRemoveWsle()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00076">MM_FREE_WSLE_SHIFT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01017">MM_SYSTEM_WS_LOCK_ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04506">MmPagesAboveWsMinimum</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00064">MmSystemCacheWs</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00124">PDE_TOP</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d8/struct__MMWSLE.html#o3">_MMWSLE::u1</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o10">_MMPFN::u2</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01568">_MMWSLENTRY::Valid</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01583">_MMWSLE::VirtualAddress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01603">_MMWSL::Wsle</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00078">WSLE_NULL_INDEX</a>.
<p>
Referenced by <a class="el" href="../../d5/d9/wslist_8c-source.html#l04726">MiEmptyWorkingSet()</a>, <a class="el" href="../../d8/d9/wstree_8c-source.html#l00051">MiInsertWsle()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l00790">MiReplaceWorkingSetEntryUsingFaultInfo()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l03612">MiTrimWorkingSet()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l02450">MmAdjustWorkingSetSize()</a>, and <a class="el" href="../../d4/d4/lockvm_8c-source.html#l00605">NtUnlockVirtualMemory()</a>.
<p>
<pre class="fragment"><div>01334                    :
01335 
01336     This routine frees <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified WSLE and decrements <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> share
01337     count <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> corresponding page, putting <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PTE into a transition
01338     state <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> share count goes to 0.
01339 
01340 Arguments:
01341 
01342     WorkingSetIndex - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> index of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set entry to free.
01343 
01344     WsInfo - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set structure (process or
01345              system cache).
01346 
01347     PointerPte - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PTE <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set entry.
01348 
01349 Return Value:
01350 
01351     Returns <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> WSLE was removed, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> was not removed.
01352         Pages with valid PTEs are not removed (i.e. page table pages
01353         that contain valid or transition PTEs).
01354 
01355 Environment:
01356 
01357     Kernel mode, APCs disabled, working set lock.  PFN lock NOT held.
01358 
01359 --*/
01360 
01361 {
01362     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
01363     <a class="code" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a> WorkingSetList;
01364     <a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a> Wsle;
01365     KIRQL OldIrql;
01366 
01367     WorkingSetList = WsInfo-&gt;VmWorkingSetList;
01368     Wsle = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o5">Wsle</a>;
01369 
01370 <span class="preprocessor">#if DBG</span>
01371 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (WsInfo == &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>) {
01372         <a class="code" href="../../d4/d8/mi_8h.html#a147">MM_SYSTEM_WS_LOCK_ASSERT</a>();
01373     }
01374 <span class="preprocessor">#endif //DBG</span>
01375 <span class="preprocessor"></span>
01376     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Wsle[WorkingSetIndex].u1.e1.Valid == 1);
01377 
01378     <span class="comment">//</span>
01379     <span class="comment">// Check to see if the located entry is eligible for removal.</span>
01380     <span class="comment">//</span>
01381 
01382     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;u.Hard.Valid == 1);
01383 
01384     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WorkingSetIndex &gt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>);
01385 
01386     <span class="comment">//</span>
01387     <span class="comment">// Check to see if this is a page table with valid PTEs.</span>
01388     <span class="comment">//</span>
01389     <span class="comment">// Note, don't clear the access bit for page table pages</span>
01390     <span class="comment">// with valid PTEs as this could cause an access trap fault which</span>
01391     <span class="comment">// would not be handled (it is only handled for PTEs not PDEs).</span>
01392     <span class="comment">//</span>
01393 
01394     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPte-&gt;u.Hard.PageFrameNumber);
01395 
01396     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01397 
01398     <span class="comment">//</span>
01399     <span class="comment">// If the PTE is a page table page with non-zero share count or</span>
01400     <span class="comment">// within the system cache with its reference count greater</span>
01401     <span class="comment">// than 0, don't remove it.</span>
01402     <span class="comment">//</span>
01403 
01404     <span class="keywordflow">if</span> (WsInfo == &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>) {
01405         <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount &gt; 1) {
01406             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01407             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01408         }
01409     } <span class="keywordflow">else</span> {
01410         <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount &gt; 1) &amp;&amp;
01411             (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PrototypePte == 0)) {
01412 
01413 <span class="preprocessor">#if DBG</span>
01414 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (WsInfo-&gt;u.Flags.SessionSpace == 1) {
01415                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MI_IS_SESSION_ADDRESS (Wsle[WorkingSetIndex].u1.VirtualAddress));
01416             }
01417             <span class="keywordflow">else</span> {
01418                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((Wsle[WorkingSetIndex].u1.VirtualAddress &gt;= (PVOID)PTE_BASE) &amp;&amp;
01419                  (Wsle[WorkingSetIndex].u1.VirtualAddress&lt;= (PVOID)PDE_TOP));
01420             }
01421 <span class="preprocessor">#endif</span>
01422 <span class="preprocessor"></span>
01423             <span class="comment">//</span>
01424             <span class="comment">// Don't remove page table pages from the working set until</span>
01425             <span class="comment">// all transition pages have exited.</span>
01426             <span class="comment">//</span>
01427 
01428             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01429             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01430         }
01431     }
01432 
01433     <span class="comment">//</span>
01434     <span class="comment">// Found a candidate, remove the page from the working set.</span>
01435     <span class="comment">//</span>
01436 
01437     <a class="code" href="../../d4/d0/wslist_8c.html#a15">MiEliminateWorkingSetEntry</a> (WorkingSetIndex,
01438                                 PointerPte,
01439                                 Pfn1,
01440                                 Wsle);
01441 
01442     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01443 
01444     <span class="comment">//</span>
01445     <span class="comment">// Remove the working set entry from the working set.</span>
01446     <span class="comment">//</span>
01447 
01448     <a class="code" href="../../d7/d0/wstree_8c.html#a8">MiRemoveWsle</a> (WorkingSetIndex, WorkingSetList);
01449 
01450     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> &gt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>);
01451 
01452     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WorkingSetIndex &gt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>);
01453 
01454     <span class="comment">//</span>
01455     <span class="comment">// Put the entry on the free list and decrement the current</span>
01456     <span class="comment">// size.</span>
01457     <span class="comment">//</span>
01458 
01459     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> &lt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a>) ||
01460             (WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> == WSLE_NULL_INDEX));
01461     Wsle[WorkingSetIndex].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.Long = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> &lt;&lt; <a class="code" href="../../d4/d8/mi_8h.html#a9">MM_FREE_WSLE_SHIFT</a>;
01462     WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> = WorkingSetIndex;
01463     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> &lt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a>) ||
01464             (WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> == WSLE_NULL_INDEX));
01465 
01466     <span class="keywordflow">if</span> (WsInfo-&gt;WorkingSetSize &gt; WsInfo-&gt;MinimumWorkingSetSize) {
01467         <a class="code" href="../../d4/d8/mi_8h.html#a590">MmPagesAboveWsMinimum</a> -= 1;
01468     }
01469     WsInfo-&gt;WorkingSetSize -= 1;
01470 
01471 <span class="preprocessor">#if 0</span>
01472 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ((WsInfo == &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>) &amp;&amp;
01473        (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified == 1))  {
01474         <a class="code" href="../../d4/d0/wslist_8c.html#a19">MiDumpWsleInCacheBlock</a> (PointerPte);
01475     }
01476 <span class="preprocessor">#endif //0</span>
01477 <span class="preprocessor"></span>    <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01478 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a33" doxytag="wslist.c::MiGrowWsleHash" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiGrowWsleHash           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>WsInfo</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d9/wslist_8c-source.html#l03300">3300</a> of file <a class="el" href="../../d5/d9/wslist_8c-source.html">wslist.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00058">ASSERT32</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00059">ASSERT64</a>, <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00051">Count</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01607">_MMWSL::HashTable</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01608">_MMWSL::HashTableSize</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01610">_MMWSL::HashTableStart</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01611">_MMWSL::HighestPermittedHashAddress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01605">_MMWSL::LastInitializedWsle</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01584">_MMWSLE::Long</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01559">MI_WSLE_HASH</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l03179">MiAddWsleHash()</a>, <a class="el" href="../../d7/d0/wstree_8c.html#a5">MiCheckWsleHash()</a>, <a class="el" href="../../d9/d5/deleteva_8c-source.html#l00506">MiDeletePte()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01643">MiGetPdeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01619">MiGetPpeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01945">MiIsPteOnPdeBoundary</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00064">MmSystemCacheWs</a>, <a class="el" href="../../d4/d8/mi_8h.html#a444">MMWSLE_HASH</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01606">_MMWSL::NonDirectCount</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00230">_EPROCESS::NumberOfPrivatePages</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00190">PAGE_ALIGN</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d3/d6/struct__MMSUPPORT.html#o15">_MMSUPPORT::u</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d1/d8/struct__MMWSLE.html#o3">_MMWSLE::u1</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01583">_MMWSLE::VirtualAddress</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l01603">_MMWSL::Wsle</a>.
<p>
Referenced by <a class="el" href="../../d2/d4/mapcache_8c-source.html#l00814">MiInitializeSystemCache()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l01481">MiInitializeWorkingSetList()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l04034">MiMakeSpecialPoolPagable()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l01881">MiSessionInitializeWorkingSetList()</a>, <a class="el" href="../../d5/d0/mmfault_8c-source.html#l00041">MmAccessFault()</a>, and <a class="el" href="../../d5/d9/wslist_8c-source.html#l02450">MmAdjustWorkingSetSize()</a>.
<p>
<pre class="fragment"><div>03306                    :
03307 
03308     This function grows (or adds) a hash table to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set list
03309     to allow direct indexing <span class="keywordflow">for</span> WSLEs than cannot be located via <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03310     PFN database WSINDEX field.
03311 
03312     The hash table <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> located AFTER <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> WSLE array and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages are
03313     locked into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set just like standard WSLEs.
03314 
03315     Note that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hash table <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> expanded by setting <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hash table
03316     field in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set to <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, but leaving <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size as non-zero.
03317     This indicates that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hash should be expanded and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initial
03318     portion of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> table zeroed.
03319 
03320 Arguments:
03321 
03322     WsInfo - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set info block <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03323              process (or system cache).
03324 
03325 Return Value:
03326 
03327     None.
03328 
03329 Environment:
03330 
03331     Kernel mode, APCs disabled, working set lock held.
03332 
03333 --*/
03334 {
03335     LONG <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
03336     <a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a> Wsle;
03337     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartPte;
03338     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> EndPte;
03339     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
03340     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
03341     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe;
03342     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> AllocatedPde;
03343     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> AllocatedPpe;
03344     ULONG First;
03345     ULONG Hash;
03346     ULONG NewSize;
03347     <a class="code" href="../../d3/d8/struct__MMWSLE__HASH.html">PMMWSLE_HASH</a> Table;
03348     <a class="code" href="../../d3/d8/struct__MMWSLE__HASH.html">PMMWSLE_HASH</a> OriginalTable;
03349     ULONG j;
03350     <a class="code" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a> WorkingSetList;
03351     KIRQL OldIrql;
03352     ULONG <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
03353     LOGICAL LoopStart;
03354     PVOID EntryHashTableEnd;
03355     PVOID TempVa;
03356     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess;
03357 
03358     WorkingSetList = WsInfo-&gt;VmWorkingSetList;
03359     Wsle = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o5">Wsle</a>;
03360 
03361     Table = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o9">HashTable</a>;
03362     OriginalTable = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o9">HashTable</a>;
03363 
03364     First = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o10">HashTableSize</a>;
03365 
03366     <span class="keywordflow">if</span> (Table == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03367 
03368         NewSize = PtrToUlong(PAGE_ALIGN (((1 + WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o8">NonDirectCount</a>) *
03369                             2 * <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d8/struct__MMWSLE__HASH.html">MMWSLE_HASH</a>)) + PAGE_SIZE - 1));
03370 
03371         <span class="comment">//</span>
03372         <span class="comment">// Note that the Table may be NULL and the HashTableSize/PTEs nonzero</span>
03373         <span class="comment">// in the case where the hash has been contracted.</span>
03374         <span class="comment">//</span>
03375 
03376         j = First * <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d8/struct__MMWSLE__HASH.html">MMWSLE_HASH</a>);
03377 
03378         <span class="comment">//</span>
03379         <span class="comment">// Don't try for additional hash pages if we already have</span>
03380         <span class="comment">// the right amount (or too many).</span>
03381         <span class="comment">//</span>
03382 
03383         <span class="keywordflow">if</span> ((j + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> &gt; NewSize) &amp;&amp; (j != 0)) {
03384             <span class="keywordflow">return</span>;
03385         }
03386 
03387         Table = (<a class="code" href="../../d3/d8/struct__MMWSLE__HASH.html">PMMWSLE_HASH</a>)(WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o12">HashTableStart</a>);
03388         EntryHashTableEnd = &amp;Table[WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o10">HashTableSize</a>];
03389 
03390         WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o10">HashTableSize</a> = 0;
03391 
03392     } <span class="keywordflow">else</span> {
03393 
03394         <span class="comment">//</span>
03395         <span class="comment">// Attempt to add 4 pages, make sure the working set list has</span>
03396         <span class="comment">// 4 free entries.</span>
03397         <span class="comment">//</span>
03398 
03399         <span class="keywordflow">if</span> ((WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a> + 5) &gt; WsInfo-&gt;WorkingSetSize) {
03400             NewSize = <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> * 4;
03401         } <span class="keywordflow">else</span> {
03402             NewSize = <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
03403         }
03404         EntryHashTableEnd = &amp;Table[WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o10">HashTableSize</a>];
03405     }
03406 
03407     <span class="keywordflow">if</span> ((PCHAR)EntryHashTableEnd + NewSize &gt; (PCHAR)WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o13">HighestPermittedHashAddress</a>) {
03408         NewSize =
03409             (ULONG)((PCHAR)(WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o13">HighestPermittedHashAddress</a>) -
03410                 ((PCHAR)EntryHashTableEnd));
03411         <span class="keywordflow">if</span> (NewSize == 0) {
03412             <span class="keywordflow">if</span> (OriginalTable == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03413                 WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o10">HashTableSize</a> = First;
03414             }
03415             <span class="keywordflow">return</span>;
03416         }
03417     }
03418 
03419     <a class="code" href="../../d4/d8/mi_8h.html#a1">ASSERT64</a> ((<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a>(EntryHashTableEnd)-&gt;u.Hard.Valid == 0) ||
03420               (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(EntryHashTableEnd)-&gt;u.Hard.Valid == 0) ||
03421               (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(EntryHashTableEnd)-&gt;u.Hard.Valid == 0));
03422 
03423     <a class="code" href="../../d4/d8/mi_8h.html#a0">ASSERT32</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(EntryHashTableEnd)-&gt;u.Hard.Valid == 0);
03424 
03425     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = NewSize;
03426     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (EntryHashTableEnd);
03427     StartPte = PointerPte;
03428     EndPte = PointerPte + (NewSize &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
03429 
03430 <span class="preprocessor">#if defined (_WIN64)</span>
03431 <span class="preprocessor"></span>    LoopStart = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03432     AllocatedPde = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03433     AllocatedPpe = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03434 <span class="preprocessor">#endif</span>
03435 <span class="preprocessor"></span>
03436     <span class="keywordflow">do</span> {
03437 
03438 <span class="preprocessor">#if defined (_WIN64)</span>
03439 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (LoopStart == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> || <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a>(PointerPte)) {
03440 
03441             PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(PointerPte);
03442             PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(PointerPte);
03443 
03444             <span class="keywordflow">if</span> (PointerPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
03445                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/wslist_8c.html#a32">MiAddWsleHash</a> (WsInfo, PointerPpe) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
03446                     <span class="keywordflow">break</span>;
03447                 }
03448                 AllocatedPpe = PointerPpe;
03449             }
03450 
03451             <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
03452                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/wslist_8c.html#a32">MiAddWsleHash</a> (WsInfo, PointerPde) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
03453                     <span class="keywordflow">break</span>;
03454                 }
03455                 AllocatedPde = PointerPde;
03456             }
03457 
03458             LoopStart = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03459         }
03460         <span class="keywordflow">else</span> {
03461             AllocatedPde = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03462             AllocatedPpe = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03463         }
03464 <span class="preprocessor">#endif</span>
03465 <span class="preprocessor"></span>
03466         <span class="keywordflow">if</span> (PointerPte-&gt;u.Hard.Valid == 0) {
03467             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/wslist_8c.html#a32">MiAddWsleHash</a> (WsInfo, PointerPte) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
03468                 <span class="keywordflow">break</span>;
03469             }
03470         }
03471 
03472         PointerPte += 1;
03473         <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> -= <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
03474     } <span class="keywordflow">while</span> (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> &gt; 0);
03475 
03476     <span class="comment">//</span>
03477     <span class="comment">// If MiAddWsleHash was unable to allocate memory above, then roll back</span>
03478     <span class="comment">// any extra PPEs &amp; PDEs that may have been created.  Note NewSize must</span>
03479     <span class="comment">// be recalculated to handle the fact that memory may have run out.</span>
03480     <span class="comment">//</span>
03481 
03482 <span class="preprocessor">#if !defined (_WIN64)</span>
03483 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (PointerPte == StartPte) {
03484         <span class="keywordflow">if</span> (OriginalTable == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03485             WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o10">HashTableSize</a> = First;
03486         }
03487         <span class="keywordflow">return</span>;
03488     }
03489 <span class="preprocessor">#else</span>
03490 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (PointerPte != EndPte) {
03491 
03492         <span class="comment">//</span>
03493         <span class="comment">// Clean up the last allocated PPE/PDE as they are not needed.</span>
03494         <span class="comment">// Note that the system cache and the session space working sets</span>
03495         <span class="comment">// have no current process (which MiDeletePte requires) which is</span>
03496         <span class="comment">// needed for WSLE and PrivatePages adjustments.</span>
03497         <span class="comment">//</span>
03498 
03499         <span class="keywordflow">if</span> (WsInfo != &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a> &amp;&amp; WsInfo-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionSpace == 0) {
03500             CurrentProcess = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
03501     
03502             <span class="keywordflow">if</span> (AllocatedPde != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03503                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (AllocatedPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
03504                 TempVa = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(AllocatedPde);
03505                 <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
03506                 <a class="code" href="../../d4/d8/mi_8h.html#a886">MiDeletePte</a> (AllocatedPde,
03507                              TempVa,
03508                              FALSE,
03509                              CurrentProcess,
03510                              NULL,
03511                              NULL);
03512                 <span class="comment">//</span>
03513                 <span class="comment">// Add back in the private page MiDeletePte subtracted.</span>
03514                 <span class="comment">//</span>
03515 
03516                 CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o41">NumberOfPrivatePages</a> += 1;
03517                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03518             }
03519     
03520             <span class="keywordflow">if</span> (AllocatedPpe != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03521                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (AllocatedPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
03522                 TempVa = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(AllocatedPpe);
03523                 <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
03524                 <a class="code" href="../../d4/d8/mi_8h.html#a886">MiDeletePte</a> (AllocatedPpe,
03525                              TempVa,
03526                              FALSE,
03527                              CurrentProcess,
03528                              NULL,
03529                              NULL);
03530                 <span class="comment">//</span>
03531                 <span class="comment">// Add back in the private page MiDeletePte subtracted.</span>
03532                 <span class="comment">//</span>
03533 
03534                 CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o41">NumberOfPrivatePages</a> += 1;
03535                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03536             }
03537         }
03538 
03539         <span class="keywordflow">if</span> (PointerPte == StartPte) {
03540             <span class="keywordflow">if</span> (OriginalTable == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03541                 WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o10">HashTableSize</a> = First;
03542             }
03543         }
03544 
03545         <span class="keywordflow">return</span>;
03546     }
03547 <span class="preprocessor">#endif</span>
03548 <span class="preprocessor"></span>
03549     NewSize = (ULONG)((PointerPte - StartPte) &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
03550 
03551     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPte) == WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o13">HighestPermittedHashAddress</a>) ||
03552             (PointerPte-&gt;u.Hard.Valid == 0));
03553 
03554     WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o10">HashTableSize</a> = First + NewSize / <span class="keyword">sizeof</span> (<a class="code" href="../../d3/d8/struct__MMWSLE__HASH.html">MMWSLE_HASH</a>);
03555     WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o9">HashTable</a> = Table;
03556 
03557     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((&amp;Table[WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o10">HashTableSize</a>] == WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o13">HighestPermittedHashAddress</a>) ||
03558         (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(&amp;Table[WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o10">HashTableSize</a>])-&gt;u.Hard.Valid == 0));
03559 
03560     <span class="keywordflow">if</span> (First != 0) {
03561         RtlZeroMemory (Table, First * <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d8/struct__MMWSLE__HASH.html">MMWSLE_HASH</a>));
03562     }
03563 
03564     <span class="comment">//</span>
03565     <span class="comment">// Fill hash table</span>
03566     <span class="comment">//</span>
03567 
03568     j = 0;
03569     <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o8">NonDirectCount</a>;
03570 
03571     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o10">HashTableSize</a>;
03572 
03573     <span class="keywordflow">do</span> {
03574         <span class="keywordflow">if</span> ((Wsle[j].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid == 1) &amp;&amp;
03575             (Wsle[j].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Direct == 0)) {
03576 
03577             <span class="comment">//</span>
03578             <span class="comment">// Hash this.</span>
03579             <span class="comment">//</span>
03580 
03581             <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> -= 1;
03582 
03583             Hash = <a class="code" href="../../d4/d8/mi_8h.html#a191">MI_WSLE_HASH</a>(Wsle[j].u1.Long, WorkingSetList);
03584 
03585             <span class="keywordflow">while</span> (Table[Hash].<a class="code" href="../../d3/d8/struct__MMWSLE__HASH.html#o0">Key</a> != 0) {
03586                 Hash += 1;
03587                 <span class="keywordflow">if</span> (Hash &gt;= (ULONG)<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>) {
03588                     Hash = 0;
03589                 }
03590             }
03591 
03592             Table[Hash].<a class="code" href="../../d3/d8/struct__MMWSLE__HASH.html#o0">Key</a> = Wsle[j].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.Long &amp; ~(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1);
03593             Table[Hash].<a class="code" href="../../d3/d8/struct__MMWSLE__HASH.html#o1">Index</a> = j;
03594 <span class="preprocessor">#if DBG</span>
03595 <span class="preprocessor"></span>            PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(Wsle[j].u1.VirtualAddress);
03596             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;u.Hard.Valid);
03597 <span class="preprocessor">#endif //DBG</span>
03598 <span class="preprocessor"></span>
03599         }
03600         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (j &lt;= WorkingSetList-&gt;LastEntry);
03601         j += 1;
03602     } <span class="keywordflow">while</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>);
03603 
03604 <span class="preprocessor">#if DBG</span>
03605 <span class="preprocessor"></span>    <a class="code" href="../../d7/d0/wstree_8c.html#a5">MiCheckWsleHash</a> (WorkingSetList);
03606 <span class="preprocessor">#endif //DBG</span>
03607 <span class="preprocessor"></span>    <span class="keywordflow">return</span>;
03608 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a28" doxytag="wslist.c::MiInitializeSessionWsSupport" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiInitializeSessionWsSupport           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d9/wslist_8c-source.html#l01847">1847</a> of file <a class="el" href="../../d5/d9/wslist_8c-source.html">wslist.c</a>.
<p>
References <a class="el" href="../../d5/d7/mi_8h-source.html#l05771">MiSessionWsList</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/mminit_8c-source.html#l00184">MmInitSystem()</a>.
<p>
<pre class="fragment"><div>01853                    :
01854 
01855     This routine initializes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> session space working set support.
01856 
01857 Arguments:
01858 
01859     None.
01860 
01861 Return Value:
01862 
01863     None.
01864 
01865 Environment:
01866 
01867     Kernel mode, <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> or below, no mutexes held.
01868 
01869 --*/
01870 
01871 {
01872     <span class="comment">//</span>
01873     <span class="comment">// This is the list of all session spaces ordered in a working set list.</span>
01874     <span class="comment">//</span>
01875 
01876     InitializeListHead (&amp;MiSessionWsList);
01877 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a27" doxytag="wslist.c::MiInitializeWorkingSetList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiInitializeWorkingSetList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>CurrentProcess</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d9/wslist_8c-source.html#l01481">1481</a> of file <a class="el" href="../../d5/d9/wslist_8c-source.html">wslist.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00875">CONSISTENCY_LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00876">CONSISTENCY_UNLOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01600">_MMWSL::FirstDynamic</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01599">_MMWSL::FirstFree</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01607">_MMWSL::HashTable</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01608">_MMWSL::HashTableSize</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01610">_MMWSL::HashTableStart</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01611">_MMWSL::HighestPermittedHashAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00349">HYPER_SPACE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00170">HYPER_SPACE_END</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01601">_MMWSL::LastEntry</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01605">_MMWSL::LastInitializedWsle</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00494">MI_MAKE_VALID_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01089">MI_PAGE_COLOR_PTE_PROCESS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00710">MI_SET_PTE_DIRTY</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00641">MI_SET_PTE_IN_WORKING_SET</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02459">MI_WRITE_VALID_PTE</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00941">MiEnsureAvailablePageOrWait()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01643">MiGetPdeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01619">MiGetPpeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l03300">MiGrowWsleHash()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03398">MiInitializePfn()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l01177">MiRemoveZeroPage()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00418">MM_DEMAND_ZERO_WRITE_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00076">MM_FREE_WSLE_SHIFT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00364">MM_MAXIMUM_WORKING_SET</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00137">MM_READWRITE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00141">MM_SESSION_SPACE_DEFAULT</a>, <a class="el" href="../../d1/d8/miglobal_8c-source.html#l00442">MmWorkingSetList</a>, <a class="el" href="../../d1/d8/miglobal_8c-source.html#l00444">MmWsle</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01602">_MMWSL::NextSlot</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00190">PAGE_ALIGN</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01598">_MMWSL::Quota</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o5">_MMPFN::u1</a>, <a class="el" href="../../d1/d8/struct__MMWSLE.html#o3">_MMWSLE::u1</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01609">_MMWSL::WaitingForImageMapping</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00362">WORKING_SET_LIST</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01603">_MMWSL::Wsle</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00078">WSLE_NULL_INDEX</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l01231">WSLE_NUMBER</a>.
<p>
Referenced by <a class="el" href="../../d5/d4/procsup_8c-source.html#l00911">MmInitializeProcessAddressSpace()</a>.
<p>
<pre class="fragment"><div>01487                    :
01488 
01489     This routine initializes a process's working set to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> empty
01490     state.
01491 
01492 Arguments:
01493 
01494     CurrentProcess - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process to initialize.
01495 
01496 Return Value:
01497 
01498     None.
01499 
01500 Environment:
01501 
01502     Kernel mode, APCs disabled.
01503 
01504 --*/
01505 
01506 {
01507     ULONG i;
01508     <a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a> WslEntry;
01509     ULONG CurrentEntry;
01510     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
01511     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
01512     <a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> NumberOfEntriesMapped;
01513     ULONG_PTR CurrentVa;
01514     PFN_NUMBER WorkingSetPage;
01515     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
01516     KIRQL OldIrql;
01517 
01518     WslEntry = <a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>;
01519 
01520     <span class="comment">//</span>
01521     <span class="comment">// Initialize the temporary double mapping portion of hyperspace, if</span>
01522     <span class="comment">// it has not already been done.</span>
01523     <span class="comment">//</span>
01524     <span class="comment">// Initialize the working set list control cells.</span>
01525     <span class="comment">//</span>
01526 
01527     <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o3">LastEntry</a> = CurrentProcess-&gt;Vm.MinimumWorkingSetSize;
01528     <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a> = <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o3">LastEntry</a>;
01529     <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o11">WaitingForImageMapping</a> = (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01530     <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o9">HashTable</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01531     <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o10">HashTableSize</a> = 0;
01532     <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o5">Wsle</a> = <a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>;
01533     <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o12">HashTableStart</a> = 
01534        (PVOID)((PCHAR)<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> (&amp;MmWsle[MM_MAXIMUM_WORKING_SET]) + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
01535 
01536     <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o13">HighestPermittedHashAddress</a> = (PVOID)(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a26">HYPER_SPACE_END</a> + 1);
01537 
01538     <span class="comment">//</span>
01539     <span class="comment">// Fill in the reserved slots.  Start with the page directory page.</span>
01540     <span class="comment">//</span>
01541 
01542 <span class="preprocessor">#if !defined (_X86PAE_)</span>
01543 <span class="preprocessor"></span>
01544     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.Long = PDE_BASE;
01545     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid = 1;
01546     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.LockedInWs = 1;
01547     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Direct = 1;
01548 
01549     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress);
01550     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
01551 
01552     <a class="code" href="../../d4/d8/mi_8h.html#a121">CONSISTENCY_LOCK_PFN</a> (OldIrql);
01553 
01554 <span class="preprocessor">#if !defined (_WIN64)</span>
01555 <span class="preprocessor"></span>    Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Event = (PVOID)CurrentProcess;
01556 <span class="preprocessor">#endif</span>
01557 <span class="preprocessor"></span>
01558     <a class="code" href="../../d4/d8/mi_8h.html#a122">CONSISTENCY_UNLOCK_PFN</a> (OldIrql);
01559 
01560 <span class="preprocessor">#else</span>
01561 <span class="preprocessor"></span>
01562     <span class="comment">//</span>
01563     <span class="comment">// Fill in all the page directory entries.</span>
01564     <span class="comment">//</span>
01565 
01566     <span class="keywordflow">for</span> (i = 0; i &lt; PD_PER_SYSTEM; i += 1) {
01567 
01568         WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress = (PVOID)(PDE_BASE + i * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
01569         WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid = 1;
01570         WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.LockedInWs = 1;
01571         WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Direct = 1;
01572 
01573         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress);
01574         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
01575     
01576         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex == 0);
01577     
01578         <a class="code" href="../../d4/d8/mi_8h.html#a121">CONSISTENCY_LOCK_PFN</a> (OldIrql);
01579     
01580         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex = (<a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>)(WslEntry - <a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>);
01581     
01582         <a class="code" href="../../d4/d8/mi_8h.html#a122">CONSISTENCY_UNLOCK_PFN</a> (OldIrql);
01583 
01584         WslEntry += 1;
01585     }
01586     WslEntry -= 1;
01587 
01588 <span class="preprocessor">#endif</span>
01589 <span class="preprocessor"></span>
01590 
01591 <span class="preprocessor">#if defined (_WIN64)</span>
01592 <span class="preprocessor"></span>
01593     <span class="comment">//</span>
01594     <span class="comment">// Fill in the entry for the page directory parent page.</span>
01595     <span class="comment">//</span>
01596 
01597     WslEntry += 1;
01598 
01599     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.Long = PDE_TBASE;
01600     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid = 1;
01601     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.LockedInWs = 1;
01602     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Direct = 1;
01603 
01604     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress);
01605     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
01606 
01607     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex == 0);
01608 
01609     <a class="code" href="../../d4/d8/mi_8h.html#a121">CONSISTENCY_LOCK_PFN</a> (OldIrql);
01610 
01611     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex = (<a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>)(WslEntry - <a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>);
01612 
01613     <a class="code" href="../../d4/d8/mi_8h.html#a122">CONSISTENCY_UNLOCK_PFN</a> (OldIrql);
01614 
01615     <span class="comment">//</span>
01616     <span class="comment">// Fill in the entry for the hyper space page directory page.</span>
01617     <span class="comment">//</span>
01618 
01619     WslEntry += 1;
01620 
01621     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress = (PVOID)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (HYPER_SPACE);
01622     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid = 1;
01623     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.LockedInWs = 1;
01624     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Direct = 1;
01625 
01626     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress);
01627     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
01628 
01629     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex == 0);
01630 
01631     <a class="code" href="../../d4/d8/mi_8h.html#a121">CONSISTENCY_LOCK_PFN</a> (OldIrql);
01632 
01633     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex = (<a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>)(WslEntry - <a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>);
01634 
01635     <a class="code" href="../../d4/d8/mi_8h.html#a122">CONSISTENCY_UNLOCK_PFN</a> (OldIrql);
01636 
01637 <span class="preprocessor">#if defined (_IA64_)</span>
01638 <span class="preprocessor"></span>
01639     <span class="comment">//</span>
01640     <span class="comment">// Fill in the entry for the session space page directory parent page.</span>
01641     <span class="comment">//</span>
01642 
01643     WslEntry += 1;
01644 
01645     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress = (PVOID)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a> (MM_SESSION_SPACE_DEFAULT);
01646     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid = 1;
01647     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.LockedInWs = 1;
01648     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Direct = 1;
01649 
01650     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress);
01651     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
01652 
01653     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex == 0);
01654 
01655     <a class="code" href="../../d4/d8/mi_8h.html#a121">CONSISTENCY_LOCK_PFN</a> (OldIrql);
01656 
01657     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex = (<a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>)(WslEntry - <a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>);
01658 
01659     <a class="code" href="../../d4/d8/mi_8h.html#a122">CONSISTENCY_UNLOCK_PFN</a> (OldIrql);
01660     
01661 <span class="preprocessor">#endif</span>
01662 <span class="preprocessor"></span>
01663 <span class="preprocessor">#endif</span>
01664 <span class="preprocessor"></span>
01665     <span class="comment">//</span>
01666     <span class="comment">// Fill in the entry for the page table page which maps hyper space.</span>
01667     <span class="comment">//</span>
01668 
01669     WslEntry += 1;
01670 
01671     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress = (PVOID)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (HYPER_SPACE);
01672     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid = 1;
01673     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.LockedInWs = 1;
01674     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Direct = 1;
01675 
01676     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress);
01677     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
01678 
01679     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex == 0);
01680 
01681     <a class="code" href="../../d4/d8/mi_8h.html#a121">CONSISTENCY_LOCK_PFN</a> (OldIrql);
01682 
01683     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex = (<a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>)(WslEntry - <a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>);
01684 
01685     <a class="code" href="../../d4/d8/mi_8h.html#a122">CONSISTENCY_UNLOCK_PFN</a> (OldIrql);
01686 
01687 <span class="preprocessor">#if defined (_X86PAE_)</span>
01688 <span class="preprocessor"></span>
01689     <span class="comment">//</span>
01690     <span class="comment">// Fill in the entry for the second page table page which maps hyper space.</span>
01691     <span class="comment">//</span>
01692 
01693     WslEntry += 1;
01694 
01695     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress = (PVOID)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (HYPER_SPACE2);
01696     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid = 1;
01697     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.LockedInWs = 1;
01698     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Direct = 1;
01699 
01700     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress);
01701     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
01702 
01703     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex == 0);
01704 
01705     <a class="code" href="../../d4/d8/mi_8h.html#a121">CONSISTENCY_LOCK_PFN</a> (OldIrql);
01706 
01707     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex = (<a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>)(WslEntry - <a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>);
01708 
01709     <a class="code" href="../../d4/d8/mi_8h.html#a122">CONSISTENCY_UNLOCK_PFN</a> (OldIrql);
01710 
01711 <span class="preprocessor">#endif</span>
01712 <span class="preprocessor"></span>
01713     <span class="comment">//</span>
01714     <span class="comment">// Fill in the entry for the page which contains the working set list.</span>
01715     <span class="comment">//</span>
01716 
01717     WslEntry += 1;
01718 
01719     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress = (PVOID)<a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>;
01720     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid = 1;
01721     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.LockedInWs = 1;
01722     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Direct = 1;
01723 
01724     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress);
01725     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
01726 
01727     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex == 0);
01728 
01729     <a class="code" href="../../d4/d8/mi_8h.html#a121">CONSISTENCY_LOCK_PFN</a> (OldIrql);
01730 
01731     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex = (<a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>)(WslEntry - <a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>);
01732 
01733     <a class="code" href="../../d4/d8/mi_8h.html#a122">CONSISTENCY_UNLOCK_PFN</a> (OldIrql);
01734 
01735     CurrentEntry = (<a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>)((WslEntry - <a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>) + 1);
01736 
01737     <span class="comment">//</span>
01738     <span class="comment">// Check to see if more pages are required in the working set list</span>
01739     <span class="comment">// to map the current maximum working set size.</span>
01740     <span class="comment">//</span>
01741 
01742     NumberOfEntriesMapped = (<a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>)(((<a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a>)((PCHAR)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a69">WORKING_SET_LIST</a> + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>)) -
01743                                 <a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>);
01744 
01745     <span class="keywordflow">if</span> (CurrentProcess-&gt;Vm.MaximumWorkingSetSize &gt;= NumberOfEntriesMapped) {
01746 
01747         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (&amp;MmWsle[0]);
01748 
01749         CurrentVa = (ULONG_PTR)<a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a> + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
01750 
01751         <span class="comment">//</span>
01752         <span class="comment">// The working set requires more than a single page.</span>
01753         <span class="comment">//</span>
01754 
01755         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01756 
01757         <span class="keywordflow">do</span> {
01758 
01759             <a class="code" href="../../d7/d5/pfnlist_8c.html#a13">MiEnsureAvailablePageOrWait</a> (NULL, NULL);
01760 
01761             PointerPte += 1;
01762             WorkingSetPage = <a class="code" href="../../d7/d5/pfnlist_8c.html#a14">MiRemoveZeroPage</a> (
01763                                     MI_PAGE_COLOR_PTE_PROCESS (PointerPte,
01764                                               &amp;CurrentProcess-&gt;NextPageColor));
01765             PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a95">MM_DEMAND_ZERO_WRITE_PTE</a>;
01766 
01767             <a class="code" href="../../d8/d2/pagfault_8c.html#a22">MiInitializePfn</a> (WorkingSetPage, PointerPte, 1);
01768 
01769             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a105">MI_MAKE_VALID_PTE</a> (TempPte,
01770                                WorkingSetPage,
01771                                MM_READWRITE,
01772                                PointerPte );
01773 
01774             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a112">MI_SET_PTE_DIRTY</a> (TempPte);
01775 
01776             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a109">MI_SET_PTE_IN_WORKING_SET</a> (&amp;TempPte, CurrentEntry);
01777 
01778             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPte, TempPte);
01779 
01780             WslEntry += 1;
01781 
01782             WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.Long = CurrentVa;
01783             WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid = 1;
01784             WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.LockedInWs = 1;
01785             WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Direct = 1;
01786 
01787             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
01788 
01789             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex == 0);
01790             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex = CurrentEntry;
01791 
01792             <span class="comment">// MiInsertWsle(CurrentEntry, MmWorkingSetList);</span>
01793 
01794             CurrentEntry += 1;
01795             CurrentVa += <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
01796 
01797             NumberOfEntriesMapped += <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> / <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d8/struct__MMWSLE.html">MMWSLE</a>);
01798 
01799         } <span class="keywordflow">while</span> (CurrentProcess-&gt;Vm.MaximumWorkingSetSize &gt;= NumberOfEntriesMapped);
01800 
01801         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01802     }
01803 
01804     CurrentProcess-&gt;Vm.WorkingSetSize = CurrentEntry;
01805     <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> = CurrentEntry;
01806     <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a> = CurrentEntry;
01807     <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o4">NextSlot</a> = CurrentEntry;
01808 
01809     <span class="comment">//</span>
01810     <span class="comment">// Initialize the following slots as free.</span>
01811     <span class="comment">//</span>
01812 
01813     i = CurrentEntry + 1;
01814     <span class="keywordflow">do</span> {
01815 
01816         <span class="comment">//</span>
01817         <span class="comment">// Build the free list, note that the first working</span>
01818         <span class="comment">// set entries (CurrentEntry) are not on the free list.</span>
01819         <span class="comment">// These entries are reserved for the pages which</span>
01820         <span class="comment">// map the working set and the page which contains the PDE.</span>
01821         <span class="comment">//</span>
01822 
01823         WslEntry += 1;
01824         WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.Long = i &lt;&lt; <a class="code" href="../../d4/d8/mi_8h.html#a9">MM_FREE_WSLE_SHIFT</a>;
01825         i += 1;
01826     } <span class="keywordflow">while</span> (i &lt;= NumberOfEntriesMapped);
01827 
01828     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.Long = <a class="code" href="../../d4/d8/mi_8h.html#a10">WSLE_NULL_INDEX</a> &lt;&lt; <a class="code" href="../../d4/d8/mi_8h.html#a9">MM_FREE_WSLE_SHIFT</a>;  <span class="comment">// End of list.</span>
01829 
01830     <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a> =
01831                                 NumberOfEntriesMapped - 1;
01832 
01833     <span class="keywordflow">if</span> (CurrentProcess-&gt;Vm.MaximumWorkingSetSize &gt; ((1536*1024) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>)) {
01834 
01835         <span class="comment">//</span>
01836         <span class="comment">// The working set list consists of more than a single page.</span>
01837         <span class="comment">//</span>
01838 
01839         <a class="code" href="../../d4/d0/wslist_8c.html#a33">MiGrowWsleHash</a> (&amp;CurrentProcess-&gt;Vm);
01840     }
01841 
01842     <span class="keywordflow">return</span>;
01843 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="wslist.c::MiLocateAndReserveWsle" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> MiLocateAndReserveWsle           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>WsInfo</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d9/wslist_8c-source.html#l00117">117</a> of file <a class="el" href="../../d5/d9/wslist_8c-source.html">wslist.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01585">_MMWSLE::e1</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01600">_MMWSL::FirstDynamic</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01599">_MMWSL::FirstFree</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01601">_MMWSL::LastEntry</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01605">_MMWSL::LastInitializedWsle</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l02824">MiAddWorkingSetPage()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l00254">MiDoReplacement()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00076">MM_FREE_WSLE_SHIFT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00475">MmInfoCounters</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04506">MmPagesAboveWsMinimum</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00064">MmSystemCacheWs</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00065">MmTransitionSharedPages</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00066">MmTransitionSharedPagesPeak</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00458">_MMINFO_COUNTERS::PageFaultCount</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01598">_MMWSL::Quota</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d8/struct__MMWSLE.html#o3">_MMWSLE::u1</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01568">_MMWSLENTRY::Valid</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01603">_MMWSL::Wsle</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00078">WSLE_NULL_INDEX</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l01231">WSLE_NUMBER</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/pagfault_8c-source.html#l04056">MiAddValidPageToWorkingSet()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l03179">MiAddWsleHash()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06461">MiLockCode()</a>, <a class="el" href="../../d5/d0/mmfault_8c-source.html#l00041">MmAccessFault()</a>, <a class="el" href="../../d2/d4/mapcache_8c-source.html#l01016">MmCheckCachedPageState()</a>, and <a class="el" href="../../d2/d4/mapcache_8c-source.html#l01274">MmCopyToCachedPage()</a>.
<p>
<pre class="fragment"><div>00123                    :
00124 
00125     This function examines <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Working Set <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current
00126     process and locates an entry to contain a <span class="keyword">new</span> page.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00127     working set <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not currently at its quota, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> page <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00128     added without removing a page, <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> at its
00129     quota a page <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> removed from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span>
00130     page added in its place.
00131 
00132 Arguments:
00133 
00134     None.
00135 
00136 Return Value:
00137 
00138     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set index which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> now reserved <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00139     next page to be added.
00140 
00141 Environment:
00142 
00143     Kernel mode, APCs disabled, working set lock.  PFN lock NOT held.
00144 
00145 --*/
00146 
00147 {
00148     <a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> WorkingSetIndex;
00149     <a class="code" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a> WorkingSetList;
00150     <a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a> Wsle;
00151     ULONG QuotaIncrement;
00152     BOOLEAN MustReplace;
00153 
00154     MustReplace = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00155     WorkingSetList = WsInfo-&gt;VmWorkingSetList;
00156     Wsle = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o5">Wsle</a>;
00157 
00158     <span class="comment">//</span>
00159     <span class="comment">// Update page fault counts.</span>
00160     <span class="comment">//</span>
00161 
00162     WsInfo-&gt;PageFaultCount += 1;
00163     <a class="code" href="../../d2/d1/mm_8h.html#a145">MmInfoCounters</a>.<a class="code" href="../../d3/d2/struct__MMINFO__COUNTERS.html#o0">PageFaultCount</a> += 1;
00164 
00165     <span class="comment">//</span>
00166     <span class="comment">// Determine if a page should be removed from the working set to make</span>
00167     <span class="comment">// room for the new page.  If so, remove it.  In addition, determine</span>
00168     <span class="comment">// the size of the QuotaIncrement if the size needs to be boosted.</span>
00169     <span class="comment">//</span>
00170 
00171 retry_replacement:
00172 
00173     QuotaIncrement = <a class="code" href="../../d4/d0/wslist_8c.html#a12">MiDoReplacement</a>(WsInfo, MustReplace);
00174 
00175     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WsInfo-&gt;WorkingSetSize &lt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a>);
00176     WsInfo-&gt;WorkingSetSize += 1;
00177 
00178     <span class="keywordflow">if</span> (WsInfo-&gt;WorkingSetSize &gt; WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a>) {
00179 
00180         <span class="comment">//</span>
00181         <span class="comment">// Increment the quota and check boundary conditions.</span>
00182         <span class="comment">//</span>
00183 
00184         WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a> += QuotaIncrement;
00185 
00186         WsInfo-&gt;LastTrimFaultCount = WsInfo-&gt;PageFaultCount;
00187 
00188         <span class="keywordflow">if</span> (WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a> &gt; WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a>) {
00189 
00190             <span class="comment">//</span>
00191             <span class="comment">// Add more pages to the working set list structure.</span>
00192             <span class="comment">//</span>
00193 
00194             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/wslist_8c.html#a16">MiAddWorkingSetPage</a> (WsInfo) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00195                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WsInfo-&gt;WorkingSetSize &lt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a>);
00196             }
00197             <span class="keywordflow">else</span> {
00198 
00199                 <span class="comment">//</span>
00200                 <span class="comment">// No page was added to the working set list structure.</span>
00201                 <span class="comment">// We must replace a page within this working set.</span>
00202                 <span class="comment">//</span>
00203 
00204                 WsInfo-&gt;WorkingSetSize -= 1;
00205                 MustReplace = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00206                 <span class="keywordflow">goto</span> retry_replacement;
00207             }
00208         }
00209     }
00210 
00211     <span class="comment">//</span>
00212     <span class="comment">// Get the working set entry from the free list.</span>
00213     <span class="comment">//</span>
00214 
00215     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> &lt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a>);
00216 
00217     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> &gt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>);
00218 
00219     WorkingSetIndex = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a>;
00220     WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> = (<a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>)(Wsle[WorkingSetIndex].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.Long &gt;&gt; <a class="code" href="../../d4/d8/mi_8h.html#a9">MM_FREE_WSLE_SHIFT</a>);
00221 
00222     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> &lt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a>) ||
00223             (WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> == WSLE_NULL_INDEX));
00224 
00225     <span class="keywordflow">if</span> (WsInfo-&gt;WorkingSetSize &gt; WsInfo-&gt;MinimumWorkingSetSize) {
00226         <a class="code" href="../../d4/d8/mi_8h.html#a590">MmPagesAboveWsMinimum</a> += 1;
00227     }
00228 
00229     <span class="keywordflow">if</span> (WsInfo-&gt;WorkingSetSize &gt; WsInfo-&gt;PeakWorkingSetSize) {
00230         WsInfo-&gt;PeakWorkingSetSize = WsInfo-&gt;WorkingSetSize;
00231     }
00232 
00233     <span class="keywordflow">if</span> (WsInfo == &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>) {
00234         <span class="keywordflow">if</span> (WsInfo-&gt;WorkingSetSize + <a class="code" href="../../d6/d8/sysinfo_8c.html#a22">MmTransitionSharedPages</a> &gt; <a class="code" href="../../d6/d8/sysinfo_8c.html#a23">MmTransitionSharedPagesPeak</a>) {
00235             <a class="code" href="../../d6/d8/sysinfo_8c.html#a23">MmTransitionSharedPagesPeak</a> = WsInfo-&gt;WorkingSetSize + <a class="code" href="../../d6/d8/sysinfo_8c.html#a22">MmTransitionSharedPages</a>;
00236         }
00237     }
00238 
00239     <span class="keywordflow">if</span> (WorkingSetIndex &gt; WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o3">LastEntry</a>) {
00240         WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o3">LastEntry</a> = WorkingSetIndex;
00241     }
00242 
00243     <span class="comment">//</span>
00244     <span class="comment">// The returned entry is guaranteed to be available at this point.</span>
00245     <span class="comment">//</span>
00246 
00247     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Wsle[WorkingSetIndex].u1.e1.Valid == 0);
00248 
00249     <span class="keywordflow">return</span> WorkingSetIndex;
00250 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="wslist.c::MiReleaseWsle" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiReleaseWsle           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>WorkingSetIndex</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>WsInfo</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d9/wslist_8c-source.html#l01016">1016</a> of file <a class="el" href="../../d5/d9/wslist_8c-source.html">wslist.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01599">_MMWSL::FirstFree</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01605">_MMWSL::LastInitializedWsle</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00076">MM_FREE_WSLE_SHIFT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01017">MM_SYSTEM_WS_LOCK_ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04506">MmPagesAboveWsMinimum</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00064">MmSystemCacheWs</a>, <a class="el" href="../../d1/d8/struct__MMWSLE.html#o3">_MMWSLE::u1</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01603">_MMWSL::Wsle</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00078">WSLE_NULL_INDEX</a>.
<p>
Referenced by <a class="el" href="../../d4/d6/freevm_8c-source.html#l01161">MiDecommitPages()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l05006">MiDeleteAddressesInWorkingSet()</a>, <a class="el" href="../../d9/d5/deleteva_8c-source.html#l00506">MiDeletePte()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l04950">MiDeleteSystemPagableVm()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06461">MiLockCode()</a>, <a class="el" href="../../d2/d4/mapcache_8c-source.html#l00579">MiRemoveMappedPtes()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l00899">MiRemovePageFromWorkingSet()</a>, and <a class="el" href="../../d2/d4/mapcache_8c-source.html#l00381">MmUnmapViewInSystemCache()</a>.
<p>
<pre class="fragment"><div>01023                    :
01024 
01025     This function releases a previously reserved working set entry to
01026     be reused.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> release occurs when a page fault <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> retried due to
01027     changes in PTEs and working sets during an I/O operation.
01028 
01029 Arguments:
01030 
01031     WorkingSetIndex - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> index of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set entry to
01032                       release.
01033 
01034 Return Value:
01035 
01036     None.
01037 
01038 Environment:
01039 
01040     Kernel mode, APCs disabled, working set lock held and PFN lock held.
01041 
01042 --*/
01043 
01044 {
01045     <a class="code" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a> WorkingSetList;
01046     <a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a> Wsle;
01047 
01048     WorkingSetList = WsInfo-&gt;VmWorkingSetList;
01049     Wsle = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o5">Wsle</a>;
01050 <span class="preprocessor">#if DBG</span>
01051 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (WsInfo == &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>) {
01052         <a class="code" href="../../d4/d8/mi_8h.html#a147">MM_SYSTEM_WS_LOCK_ASSERT</a>();
01053     }
01054 <span class="preprocessor">#endif //DBG</span>
01055 <span class="preprocessor"></span>
01056     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WorkingSetIndex &lt;= WorkingSetList-&gt;LastInitializedWsle);
01057 
01058     <span class="comment">//</span>
01059     <span class="comment">// Put the entry on the free list and decrement the current</span>
01060     <span class="comment">// size.</span>
01061     <span class="comment">//</span>
01062 
01063     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> &lt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a>) ||
01064             (WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> == WSLE_NULL_INDEX));
01065     Wsle[WorkingSetIndex].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.Long = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> &lt;&lt; <a class="code" href="../../d4/d8/mi_8h.html#a9">MM_FREE_WSLE_SHIFT</a>;
01066     WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> = WorkingSetIndex;
01067     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> &lt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a>) ||
01068             (WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> == WSLE_NULL_INDEX));
01069     <span class="keywordflow">if</span> (WsInfo-&gt;WorkingSetSize &gt; WsInfo-&gt;MinimumWorkingSetSize) {
01070         <a class="code" href="../../d4/d8/mi_8h.html#a590">MmPagesAboveWsMinimum</a> -= 1;
01071     }
01072     WsInfo-&gt;WorkingSetSize -= 1;
01073     <span class="keywordflow">return</span>;
01074 
01075 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="wslist.c::MiRemovePageFromWorkingSet" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG MiRemovePageFromWorkingSet           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PointerPte</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Pfn1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>WsInfo</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d9/wslist_8c-source.html#l00899">899</a> of file <a class="el" href="../../d5/d9/wslist_8c-source.html">wslist.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01600">_MMWSL::FirstDynamic</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01570">_MMWSLENTRY::LockedInMemory</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01569">_MMWSLENTRY::LockedInWs</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l03974">MiEliminateWorkingSetEntry()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d8/d9/wstree_8c-source.html#l00248">MiLocateWsle()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l01016">MiReleaseWsle()</a>, <a class="el" href="../../d8/d9/wstree_8c-source.html#l00464">MiRemoveWsle()</a>, <a class="el" href="../../d8/d9/wstree_8c-source.html#l00576">MiSwapWslEntries()</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00190">PAGE_ALIGN</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d8/struct__MMWSLE.html#o3">_MMWSLE::u1</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01603">_MMWSL::Wsle</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00078">WSLE_NULL_INDEX</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l01231">WSLE_NUMBER</a>.
<p>
Referenced by <a class="el" href="../../d2/d5/allocpag_8c-source.html#l05278">MiProtectSpecialPool()</a>, <a class="el" href="../../d1/d8/protect_8c-source.html#l00344">MiProtectVirtualMemory()</a>, and <a class="el" href="../../d1/d8/protect_8c-source.html#l01110">MiSetProtectionOnSection()</a>.
<p>
<pre class="fragment"><div>00907                    :
00908 
00909     This function removes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page mapped by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified PTE from
00910     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process's working set list.
00911 
00912 Arguments:
00913 
00914     PointerPte - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PTE mapping <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page to
00915                  be removed from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set list.
00916 
00917     Pfn1 - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PFN database element referred to
00918            by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PointerPte.
00919 
00920 Return Value:
00921 
00922     Returns <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified page was locked in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set,
00923     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
00924 
00925 Environment:
00926 
00927     Kernel mode, APCs disabled, working set mutex held.
00928 
00929 --*/
00930 
00931 {
00932     <a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> WorkingSetIndex;
00933     PVOID VirtualAddress;
00934     <a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> Entry;
00935     PVOID SwapVa;
00936     <a class="code" href="../../d4/d8/struct__MMWSLENTRY.html">MMWSLENTRY</a> Locked;
00937     <a class="code" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a> WorkingSetList;
00938     <a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a> Wsle;
00939     KIRQL OldIrql;
00940 
00941     WorkingSetList = WsInfo-&gt;VmWorkingSetList;
00942     Wsle = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o5">Wsle</a>;
00943 
00944     VirtualAddress = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
00945     WorkingSetIndex = <a class="code" href="../../d7/d0/wstree_8c.html#a7">MiLocateWsle</a> (VirtualAddress,
00946                                     WorkingSetList,
00947                                     Pfn1-&gt;u1.WsIndex);
00948 
00949     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WorkingSetIndex != WSLE_NULL_INDEX);
00950     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00951     <a class="code" href="../../d4/d0/wslist_8c.html#a15">MiEliminateWorkingSetEntry</a> (WorkingSetIndex,
00952                                 PointerPte,
00953                                 Pfn1,
00954                                 Wsle);
00955 
00956     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00957 
00958     <span class="comment">//</span>
00959     <span class="comment">// Check to see if this entry is locked in the working set</span>
00960     <span class="comment">// or locked in memory.</span>
00961     <span class="comment">//</span>
00962 
00963     Locked = Wsle[WorkingSetIndex].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1;
00964     <a class="code" href="../../d7/d0/wstree_8c.html#a8">MiRemoveWsle</a> (WorkingSetIndex, WorkingSetList);
00965 
00966     <span class="comment">//</span>
00967     <span class="comment">// Add this entry to the list of free working set entries</span>
00968     <span class="comment">// and adjust the working set count.</span>
00969     <span class="comment">//</span>
00970 
00971     <a class="code" href="../../d4/d0/wslist_8c.html#a24">MiReleaseWsle</a> ((WSLE_NUMBER)WorkingSetIndex, WsInfo);
00972 
00973     <span class="keywordflow">if</span> ((Locked.<a class="code" href="../../d4/d8/struct__MMWSLENTRY.html#o1">LockedInWs</a> == 1) || (Locked.<a class="code" href="../../d4/d8/struct__MMWSLENTRY.html#o2">LockedInMemory</a> == 1)) {
00974 
00975         <span class="comment">//</span>
00976         <span class="comment">// This entry is locked.</span>
00977         <span class="comment">//</span>
00978 
00979         WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a> -= 1;
00980 
00981         <span class="keywordflow">if</span> (WorkingSetIndex != WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>) {
00982 
00983             SwapVa = Wsle[WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>].u1.VirtualAddress;
00984             SwapVa = <a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> (SwapVa);
00985 
00986             PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (SwapVa);
00987             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPte-&gt;u.Hard.PageFrameNumber);
00988 <span class="preprocessor">#if 0</span>
00989 <span class="preprocessor"></span>            Entry = MiLocateWsleAndParent (SwapVa,
00990                                            &amp;Parent,
00991                                            WorkingSetList,
00992                                            Pfn1-&gt;u1.WsIndex);
00993 
00994             <span class="comment">//</span>
00995             <span class="comment">// Swap the removed entry with the last locked entry</span>
00996             <span class="comment">// which is located at first dynamic.</span>
00997             <span class="comment">//</span>
00998 
00999             <a class="code" href="../../d7/d0/wstree_8c.html#a9">MiSwapWslEntries</a> (Entry, Parent, WorkingSetIndex, WorkingSetList);
01000 <span class="preprocessor">#endif //0</span>
01001 <span class="preprocessor"></span>
01002             Entry = <a class="code" href="../../d7/d0/wstree_8c.html#a7">MiLocateWsle</a> (SwapVa, WorkingSetList, Pfn1-&gt;u1.WsIndex);
01003 
01004             <a class="code" href="../../d7/d0/wstree_8c.html#a9">MiSwapWslEntries</a> (Entry, WorkingSetIndex, WsInfo);
01005 
01006         }
01007         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01008     } <span class="keywordflow">else</span> {
01009         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WorkingSetIndex &gt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>);
01010     }
01011     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01012 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="wslist.c::MiRemoveWorkingSetPages" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiRemoveWorkingSetPages           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>WorkingSetList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>WsInfo</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d5/d9/wslist_8c-source.html#l04726">MiEmptyWorkingSet()</a>, and <a class="el" href="../../d5/d9/wslist_8c-source.html#l03612">MiTrimWorkingSet()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="wslist.c::MiReplaceWorkingSetEntryUsingFaultInfo" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiReplaceWorkingSetEntryUsingFaultInfo           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>WsInfo</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>MustReplace</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d9/wslist_8c-source.html#l00790">790</a> of file <a class="el" href="../../d5/d9/wslist_8c-source.html">wslist.c</a>.
<p>
References <a class="el" href="../../d5/d7/mi_8h-source.html#l01600">_MMWSL::FirstDynamic</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01601">_MMWSL::LastEntry</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01336">MI_GET_ACCESSED_IN_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01313">MI_SET_ACCESSED_IN_PTE</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l01326">MiFreeWsle()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00086">MM_WORKING_SET_LIST_SEARCH</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01602">_MMWSL::NextSlot</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02175">PERFINFO_GET_PAGE_INFO_REPLACEMENT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02196">PERFINFO_LOG_WS_REPLACEMENT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02202">PERFINFO_PAGE_INFO_REPLACEMENT_DECL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d8/struct__MMWSLE.html#o3">_MMWSLE::u1</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01583">_MMWSLE::VirtualAddress</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l01603">_MMWSL::Wsle</a>.
<p>
Referenced by <a class="el" href="../../d5/d9/wslist_8c-source.html#l00254">MiDoReplacement()</a>.
<p>
<pre class="fragment"><div>00797                    :
00798 
00799     This function tries to find a reasonable working set entry to replace.
00800 
00801 Arguments:
00802 
00803     WsInfo - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set info pointer.
00804 
00805     MustReplace - Supplies <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> replacement must succeed.
00806 
00807 Return Value:
00808 
00809     None
00810 
00811 Environment:
00812 
00813     Kernel mode, APCs disabled, working set lock.  PFN lock NOT held.
00814 
00815 --*/
00816 
00817 {
00818     ULONG WorkingSetIndex;
00819     ULONG FirstDynamic;
00820     ULONG LastEntry;
00821     <a class="code" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a> WorkingSetList;
00822     <a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a> Wsle;
00823     ULONG NumberOfCandidates;
00824     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00825     ULONG TheNextSlot;
00826 
00827     WorkingSetList = WsInfo-&gt;VmWorkingSetList;
00828     Wsle = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o5">Wsle</a>;
00829 
00830     <span class="comment">//</span>
00831     <span class="comment">// Toss a page out of the working set.</span>
00832     <span class="comment">//</span>
00833 
00834     LastEntry = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o3">LastEntry</a>;
00835     FirstDynamic = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>;
00836     WorkingSetIndex = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o4">NextSlot</a>;
00837 
00838     <span class="keywordflow">if</span> ((WorkingSetIndex &gt; LastEntry) || (WorkingSetIndex &lt; FirstDynamic)) {
00839         WorkingSetIndex = FirstDynamic;
00840     }
00841 
00842     TheNextSlot = WorkingSetIndex;
00843     NumberOfCandidates = 0;
00844 
00845     <span class="keywordflow">do</span> {
00846 
00847         <span class="comment">//</span>
00848         <span class="comment">// Find a valid entry within the set.</span>
00849         <span class="comment">//</span>
00850 
00851         <span class="keywordflow">if</span> (Wsle[WorkingSetIndex].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid != 0) {
00852 
00853             PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (
00854                               Wsle[WorkingSetIndex].u1.VirtualAddress);
00855 
00856             <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a138">MI_GET_ACCESSED_IN_PTE</a>(PointerPte) == 0) ||
00857                 (NumberOfCandidates &gt; <a class="code" href="../../d4/d8/mi_8h.html#a14">MM_WORKING_SET_LIST_SEARCH</a>)) {
00858 
00859                 <a class="code" href="../../d2/d1/mm_8h.html#a81">PERFINFO_PAGE_INFO_REPLACEMENT_DECL</a>();
00860                 <a class="code" href="../../d2/d1/mm_8h.html#a54">PERFINFO_GET_PAGE_INFO_REPLACEMENT</a>(PointerPte);
00861 
00862                 <span class="comment">//</span>
00863                 <span class="comment">// Don't pick the same entry we replaced the last time</span>
00864                 <span class="comment">// unless we're under extreme pressure.</span>
00865                 <span class="comment">//</span>
00866 
00867                 <span class="keywordflow">if</span> ((WorkingSetIndex != TheNextSlot || MustReplace == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) &amp;&amp;
00868                     <a class="code" href="../../d4/d0/wslist_8c.html#a26">MiFreeWsle</a> (WorkingSetIndex, WsInfo, PointerPte)) {
00869 
00870                     <a class="code" href="../../d2/d1/mm_8h.html#a75">PERFINFO_LOG_WS_REPLACEMENT</a>(WsInfo);
00871 
00872                     <span class="comment">//</span>
00873                     <span class="comment">// This entry was removed.</span>
00874                     <span class="comment">//</span>
00875 
00876                     WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o4">NextSlot</a> = WorkingSetIndex + 1;
00877                     <span class="keywordflow">break</span>;
00878                 }
00879             }
00880             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a137">MI_SET_ACCESSED_IN_PTE</a> (PointerPte, 0);
00881             NumberOfCandidates += 1;
00882         }
00883 
00884         WorkingSetIndex += 1;
00885         <span class="keywordflow">if</span> (WorkingSetIndex &gt; LastEntry) {
00886             WorkingSetIndex = FirstDynamic;
00887         }
00888 
00889     } <span class="keywordflow">while</span> (WorkingSetIndex != TheNextSlot || MustReplace == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00890 
00891     <span class="comment">//</span>
00892     <span class="comment">// Entire working set list has been searched.  If an entry wasn't</span>
00893     <span class="comment">// removed, our caller can increase the working set size.</span>
00894     <span class="comment">//</span>
00895 }
<span class="preprocessor">#endif</span>
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a29" doxytag="wslist.c::MiSessionInitializeWorkingSetList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MiSessionInitializeWorkingSetList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d9/wslist_8c-source.html#l01881">1881</a> of file <a class="el" href="../../d5/d9/wslist_8c-source.html">wslist.c</a>.
<p>
References <a class="el" href="../../d2/d8/ps_8h-source.html#l00066">_MMSUPPORT::AllowWorkingSetAdjustment</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00141">BYTES_TO_PAGES</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05471">_MM_SESSION_SPACE::CommittedPages</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00875">CONSISTENCY_LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00876">CONSISTENCY_UNLOCK_PFN</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02478">ExDeleteResource</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02473">ExInitializeResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01600">_MMWSL::FirstDynamic</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01599">_MMWSL::FirstFree</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01607">_MMWSL::HashTable</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01608">_MMWSL::HashTableSize</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01610">_MMWSL::HashTableStart</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01611">_MMWSL::HighestPermittedHashAddress</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01601">_MMWSL::LastEntry</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01605">_MMWSL::LastInitializedWsle</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00957">LOCK_EXPANSION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00063">_MMSUPPORT::MaximumWorkingSetSize</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01038">MI_GET_PAGE_COLOR_FROM_VA</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04360">MI_NONPAGABLE_MEMORY_AVAILABLE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05241">MI_SESSION_MAXIMUM_WORKING_SET</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05644">MI_SESSION_SPACE_WORKING_SET_MAXIMUM</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05642">MI_SESSION_SPACE_WORKING_SET_MINIMUM</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05274">MI_SESSION_SPACE_WS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05276">MI_SESSION_VIEW_START</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00710">MI_SET_PTE_DIRTY</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00641">MI_SET_PTE_IN_WORKING_SET</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02459">MI_WRITE_VALID_PTE</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00191">MiChargeCommitment()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00941">MiEnsureAvailablePageOrWait()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02543">MiFillMemoryPte</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01643">MiGetPdeAddress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05733">MiGetPdeSessionIndex</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l03300">MiGrowWsleHash()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03398">MiInitializePfn()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03973">MiInitializePfnForOtherProcess()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00062">_MMSUPPORT::MinimumWorkingSetSize</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l01395">MiRemoveAnyPage()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l01177">MiRemoveZeroPage()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02814">MiRemoveZeroPageIfAny</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00442">MiReturnCommitment()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05771">MiSessionWsList</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l01184">MiZeroPhysicalPage()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04317">MM_BUMP_COUNTER</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05361">MM_BUMP_SESS_COUNTER</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05380">MM_BUMP_SESSION_FAILURES</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04300">MM_DBG_COMMIT_RETURN_SESSION_WSL_FAILURE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04272">MM_DBG_COMMIT_SESSION_WS_INIT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05313">MM_DBG_SESSION_WS_PAGE_ALLOC</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05310">MM_DBG_SESSION_WS_PAGETABLE_ALLOC</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00418">MM_DEMAND_ZERO_WRITE_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00076">MM_FREE_WSLE_SHIFT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05367">MM_SESSION_FAILURE_NO_COMMIT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05368">MM_SESSION_FAILURE_NO_RESIDENT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04221">MM_TRACK_COMMIT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00278">MM_VA_MAPPED_BY_PDE</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00086">MmResidentAvailablePages</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05609">MmSessionSpace</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01602">_MMWSL::NextSlot</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05463">_MM_SESSION_SPACE::NonPagablePages</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00190">PAGE_ALIGN</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05505">_MM_SESSION_SPACE::PagedPoolStart</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05491">_MM_SESSION_SPACE::PageTables</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01598">_MMWSL::Quota</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05300">SESSION_GLOBAL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05427">_MM_SESSION_SPACE::SessionPageDirectoryIndex</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o3">_MM_SESSION_SPACE::u</a>, <a class="el" href="../../d3/d6/struct__MMSUPPORT.html#o15">_MMSUPPORT::u</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d1/d8/struct__MMWSLE.html#o3">_MMWSLE::u1</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o5">_MMPFN::u1</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00961">UNLOCK_EXPANSION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01622">_MMWSL::UsedPageTableEntries</a>, <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00065">ValidKernelPdeLocal</a>, <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00043">ValidKernelPteLocal</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05556">_MM_SESSION_SPACE::Vm</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00064">_MMSUPPORT::VmWorkingSetList</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05586">_MM_SESSION_SPACE::WorkingSetLockOwner</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00061">_MMSUPPORT::WorkingSetSize</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01603">_MMWSL::Wsle</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05557">_MM_SESSION_SPACE::Wsle</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00078">WSLE_NULL_INDEX</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01231">WSLE_NUMBER</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05566">_MM_SESSION_SPACE::WsListEntry</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05559">_MM_SESSION_SPACE::WsLock</a>, and <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00036">ZeroKernelPte</a>.
<p>
Referenced by <a class="el" href="../../d4/d6/session_8c-source.html#l00974">MmSessionCreate()</a>.
<p>
<pre class="fragment"><div>01887                    :
01888 
01889     This function initializes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> session space and adds
01890     <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list of session space working sets.
01891 
01892 Arguments:
01893 
01894     None.
01895 
01896 Return Value:
01897 
01898     <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> <span class="keywordflow">if</span> success or STATUS_NO_MEMORY on <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>.
01899 
01900 Environment:
01901 
01902     Kernel mode, <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> or below, no mutexes held.
01903 
01904 --*/
01905 
01906 {
01907     ULONG i;
01908     KIRQL OldIrql;
01909     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
01910     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
01911     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>  TempPte;
01912     <a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a> WslEntry;
01913     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
01914     ULONG PageColor;
01915     PFN_NUMBER ResidentPages;
01916     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01917     PFN_NUMBER PageFrameIndex;
01918     ULONG CurrentEntry;
01919     ULONG NumberOfEntriesMapped;
01920     ULONG_PTR AdditionalBytes;
01921     ULONG NumberOfEntriesMappedByFirstPage;
01922     ULONG WorkingSetMaximum;
01923     <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html">PMM_SESSION_SPACE</a> SessionGlobal;
01924     LOGICAL AllocatedPageTable;
01925 
01926     <span class="comment">//</span>
01927     <span class="comment">// Use the global address for pointer references by</span>
01928     <span class="comment">// MmWorkingSetManager before it attaches to the address space.</span>
01929     <span class="comment">//</span>
01930 
01931     SessionGlobal = <a class="code" href="../../d4/d8/mi_8h.html#a356">SESSION_GLOBAL</a> (MmSessionSpace);
01932 
01933     <span class="comment">//</span>
01934     <span class="comment">// Set up the working set variables.</span>
01935     <span class="comment">//</span>
01936 
01937     WorkingSetMaximum = <a class="code" href="../../d4/d8/mi_8h.html#a403">MI_SESSION_SPACE_WORKING_SET_MAXIMUM</a>;
01938 
01939     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a> = (<a class="code" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a>)<a class="code" href="../../d4/d8/mi_8h.html#a348">MI_SESSION_SPACE_WS</a>;
01940 <span class="preprocessor">#if defined (_WIN64)</span>
01941 <span class="preprocessor"></span>    <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o31">Wsle</a> = (<a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a>)(<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a> + 1);
01942 <span class="preprocessor">#else</span>
01943 <span class="preprocessor"></span>    <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o31">Wsle</a> =
01944             (<a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a>)(&amp;<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o16">UsedPageTableEntries</a>[0]);
01945 <span class="preprocessor">#endif</span>
01946 <span class="preprocessor"></span>
01947     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o36">WorkingSetLockOwner</a> == NULL);
01948     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;WorkingSetLockOwnerCount == 0);
01949 
01950     <span class="comment">//</span>
01951     <span class="comment">// Build the PDE entry for the working set - note that the global bit</span>
01952     <span class="comment">// must be turned off.</span>
01953     <span class="comment">//</span>
01954 
01955     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>);
01956 
01957     <span class="comment">//</span>
01958     <span class="comment">// The page table page for the working set and its first data page</span>
01959     <span class="comment">// are charged against MmResidentAvailablePages and for commitment.</span>
01960     <span class="comment">//</span>
01961 
01962     <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
01963 
01964         <span class="comment">//</span>
01965         <span class="comment">// The page directory entry for the working set is the same</span>
01966         <span class="comment">// as for another range in the session space.  Share the PDE.</span>
01967         <span class="comment">//</span>
01968 
01969 <span class="preprocessor">#ifndef _IA64_</span>
01970 <span class="preprocessor"></span>        <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Global == 0);
01971 <span class="preprocessor">#endif</span>
01972 <span class="preprocessor"></span>        AllocatedPageTable = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01973         ResidentPages = 1;
01974     }
01975     <span class="keywordflow">else</span> {
01976         AllocatedPageTable = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01977         ResidentPages = 2;
01978     }
01979 
01980 
01981     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>);
01982 
01983     <span class="comment">//</span>
01984     <span class="comment">// The data pages needed to map up to maximum working set size are also</span>
01985     <span class="comment">// charged against MmResidentAvailablePages and for commitment.</span>
01986     <span class="comment">//</span>
01987 
01988     NumberOfEntriesMappedByFirstPage = (<a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>)(
01989         ((<a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a>)((ULONG_PTR)<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a> + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>)) -
01990             <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o31">Wsle</a>);
01991 
01992     <span class="keywordflow">if</span> (WorkingSetMaximum &gt; NumberOfEntriesMappedByFirstPage) {
01993         AdditionalBytes = (WorkingSetMaximum - NumberOfEntriesMappedByFirstPage) * <span class="keyword">sizeof</span> (<a class="code" href="../../d1/d8/struct__MMWSLE.html">MMWSLE</a>);
01994         ResidentPages += <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a> (AdditionalBytes);
01995     }
01996 
01997     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d1/mmquota_8c.html#a17">MiChargeCommitment</a> (ResidentPages, NULL) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01998 <span class="preprocessor">#if DBG</span>
01999 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MiSessionInitializeWorkingSetList: No commit for %d pages\n"</span>,
02000             ResidentPages);
02001 
02002 <span class="preprocessor">#endif</span>
02003 <span class="preprocessor"></span>        <a class="code" href="../../d4/d8/mi_8h.html#a396">MM_BUMP_SESSION_FAILURES</a> (MM_SESSION_FAILURE_NO_COMMIT);
02004         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
02005     }
02006 
02007     <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_SESSION_WS_INIT, ResidentPages);
02008 
02009     <span class="comment">//</span>
02010     <span class="comment">// Use the global address for resources since they are linked</span>
02011     <span class="comment">// into the global system wide resource list.</span>
02012     <span class="comment">//</span>
02013 
02014     <a class="code" href="../../d5/d8/ex_8h.html#a68">ExInitializeResource</a> (&amp;SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o32">WsLock</a>);
02015 
02016     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02017 
02018     <span class="comment">//</span>
02019     <span class="comment">// Check to make sure the physical pages are available.</span>
02020     <span class="comment">//</span>
02021 
02022     <span class="keywordflow">if</span> ((SPFN_NUMBER)ResidentPages &gt; <a class="code" href="../../d4/d8/mi_8h.html#a323">MI_NONPAGABLE_MEMORY_AVAILABLE</a>() - 20) {
02023 <span class="preprocessor">#if DBG</span>
02024 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MiSessionInitializeWorkingSetList: No Resident Pages %d, Need %d\n"</span>,
02025             MmResidentAvailablePages,
02026             ResidentPages);
02027 <span class="preprocessor">#endif</span>
02028 <span class="preprocessor"></span>        <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02029 
02030         <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (ResidentPages);
02031         <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_RETURN_SESSION_WSL_FAILURE, ResidentPages);
02032         <a class="code" href="../../d5/d8/ex_8h.html#a73">ExDeleteResource</a> (&amp;SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o32">WsLock</a>);
02033         <a class="code" href="../../d4/d8/mi_8h.html#a396">MM_BUMP_SESSION_FAILURES</a> (MM_SESSION_FAILURE_NO_RESIDENT);
02034         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
02035     }
02036 
02037     <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> -= ResidentPages;
02038 
02039     <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(50, ResidentPages);
02040 
02041     <span class="keywordflow">if</span> (AllocatedPageTable == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02042 
02043         <a class="code" href="../../d4/d8/mi_8h.html#a384">MM_BUMP_SESS_COUNTER</a> (MM_DBG_SESSION_WS_PAGETABLE_ALLOC, 1);
02044 
02045         <a class="code" href="../../d7/d5/pfnlist_8c.html#a13">MiEnsureAvailablePageOrWait</a> (NULL, NULL);
02046 
02047         PageColor = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a125">MI_GET_PAGE_COLOR_FROM_VA</a> (NULL);
02048 
02049         PageFrameIndex = <a class="code" href="../../d4/d8/mi_8h.html#a243">MiRemoveZeroPageIfAny</a> (PageColor);
02050         <span class="keywordflow">if</span> (PageFrameIndex == 0) {
02051             PageFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (PageColor);
02052             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02053             <a class="code" href="../../d0/d2/mmsup_8c.html#a14">MiZeroPhysicalPage</a> (PageFrameIndex, PageColor);
02054             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02055         }
02056 
02057         <span class="comment">//</span>
02058         <span class="comment">// The global bit is masked off since we need to make sure the TB entry</span>
02059         <span class="comment">// is flushed when we switch to a process in a different session space.</span>
02060         <span class="comment">//</span>
02061 
02062         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d4/d2/datalpha_8c.html#a8">ValidKernelPdeLocal</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
02063         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = PageFrameIndex;
02064         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPde, TempPte);
02065 
02066 <span class="preprocessor">#if !defined (_WIN64)</span>
02067 <span class="preprocessor"></span>
02068         <span class="comment">//</span>
02069         <span class="comment">// Add this to the session structure so other processes can fault it in.</span>
02070         <span class="comment">//</span>
02071 
02072         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = <a class="code" href="../../d4/d8/mi_8h.html#a409">MiGetPdeSessionIndex</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>);
02073 
02074         <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o16">PageTables</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] = TempPte;
02075 
02076 <span class="preprocessor">#endif</span>
02077 <span class="preprocessor"></span>
02078         <span class="comment">//</span>
02079         <span class="comment">// This page frame references the session space page table page.</span>
02080         <span class="comment">//</span>
02081 
02082         <a class="code" href="../../d8/d2/pagfault_8c.html#a27">MiInitializePfnForOtherProcess</a> (PageFrameIndex,
02083                                         PointerPde,
02084                                         <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o5">SessionPageDirectoryIndex</a>);
02085 
02086         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a189">MiFillMemoryPte</a> (PointerPte, PAGE_SIZE, <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long);
02087 
02088         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
02089 
02090         <span class="comment">//</span>
02091         <span class="comment">// This page is never paged, ensure that its WsIndex stays clear so the</span>
02092         <span class="comment">// release of the page will be handled correctly.</span>
02093         <span class="comment">//</span>
02094 
02095         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex == 0);
02096 
02097         KeFillEntryTb ((PHARDWARE_PTE) PointerPde, PointerPte, FALSE);
02098     }
02099 
02100     <a class="code" href="../../d7/d5/pfnlist_8c.html#a13">MiEnsureAvailablePageOrWait</a> (NULL, NULL);
02101 
02102     PageColor = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a125">MI_GET_PAGE_COLOR_FROM_VA</a> (NULL);
02103 
02104     PageFrameIndex = <a class="code" href="../../d4/d8/mi_8h.html#a243">MiRemoveZeroPageIfAny</a> (PageColor);
02105     <span class="keywordflow">if</span> (PageFrameIndex == 0) {
02106         PageFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (PageColor);
02107         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02108         <a class="code" href="../../d0/d2/mmsup_8c.html#a14">MiZeroPhysicalPage</a> (PageFrameIndex, PageColor);
02109         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02110     }
02111 
02112     <a class="code" href="../../d4/d8/mi_8h.html#a384">MM_BUMP_SESS_COUNTER</a> (MM_DBG_SESSION_WS_PAGE_ALLOC, ResidentPages - 1);
02113 
02114 <span class="preprocessor">#if DBG</span>
02115 <span class="preprocessor"></span>    Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
02116     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex == 0);
02117 <span class="preprocessor">#endif</span>
02118 <span class="preprocessor"></span>
02119     <span class="comment">//</span>
02120     <span class="comment">// The global bit is masked off since we need to make sure the TB entry</span>
02121     <span class="comment">// is flushed when we switch to a process in a different session space.</span>
02122     <span class="comment">//</span>
02123 
02124     TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d4/d2/datalpha_8c.html#a3">ValidKernelPteLocal</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
02125     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a112">MI_SET_PTE_DIRTY</a> (TempPte);
02126     TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = PageFrameIndex;
02127 
02128     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPte, TempPte);
02129 
02130     <a class="code" href="../../d8/d2/pagfault_8c.html#a22">MiInitializePfn</a> (PageFrameIndex, PointerPte, 1);
02131 
02132 <span class="preprocessor">#if DBG</span>
02133 <span class="preprocessor"></span>    Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
02134     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex == 0);
02135 <span class="preprocessor">#endif</span>
02136 <span class="preprocessor"></span>
02137     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02138 
02139     KeFillEntryTb ((PHARDWARE_PTE) PointerPte,
02140                    (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>,
02141                    FALSE);
02142 
02143     <span class="comment">//</span>
02144     <span class="comment">// Fill in the reserved slots starting with the session data page.</span>
02145     <span class="comment">//</span>
02146 
02147     WslEntry = <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o31">Wsle</a>;
02148 
02149     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress = (PVOID)<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>;
02150     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid = 1;
02151     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.LockedInWs = 1;
02152     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Direct = 1;
02153 
02154     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (MiGetPteAddress (WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress)-&gt;u.Hard.PageFrameNumber);
02155 
02156     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex == 0);
02157 
02158     <span class="comment">//</span>
02159     <span class="comment">// The next reserved slot is for the page table page mapping</span>
02160     <span class="comment">// the session data page.</span>
02161     <span class="comment">//</span>
02162 
02163     WslEntry += 1;
02164 
02165     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (MmSessionSpace);
02166     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid = 1;
02167     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.LockedInWs = 1;
02168     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Direct = 1;
02169 
02170     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (MiGetPteAddress (WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress)-&gt;u.Hard.PageFrameNumber);
02171 
02172     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex == 0);
02173 
02174     <a class="code" href="../../d4/d8/mi_8h.html#a121">CONSISTENCY_LOCK_PFN</a> (OldIrql);
02175 
02176     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex = (<a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>)(WslEntry - <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o31">Wsle</a>);
02177 
02178     <a class="code" href="../../d4/d8/mi_8h.html#a122">CONSISTENCY_UNLOCK_PFN</a> (OldIrql);
02179 
02180     <span class="comment">//</span>
02181     <span class="comment">// The next reserved slot is for the working set page.</span>
02182     <span class="comment">//</span>
02183 
02184     WslEntry += 1;
02185 
02186     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress = <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>;
02187     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid = 1;
02188     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.LockedInWs = 1;
02189     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Direct = 1;
02190 
02191     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
02192 
02193     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex == 0);
02194 
02195     <a class="code" href="../../d4/d8/mi_8h.html#a121">CONSISTENCY_LOCK_PFN</a> (OldIrql);
02196 
02197     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex = (<a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>)(WslEntry - <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o31">Wsle</a>);
02198 
02199     <a class="code" href="../../d4/d8/mi_8h.html#a122">CONSISTENCY_UNLOCK_PFN</a> (OldIrql);
02200 
02201     <span class="keywordflow">if</span> (AllocatedPageTable == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02202 
02203         <span class="comment">//</span>
02204         <span class="comment">// The next reserved slot is for the page table page</span>
02205         <span class="comment">// mapping the working set page.</span>
02206         <span class="comment">//</span>
02207 
02208         WslEntry += 1;
02209 
02210         WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress = (PVOID)PointerPte;
02211         WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid = 1;
02212         WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.LockedInWs = 1;
02213         WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Direct = 1;
02214 
02215         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (MiGetPteAddress (WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress)-&gt;u.Hard.PageFrameNumber);
02216 
02217         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex == 0);
02218 
02219         <a class="code" href="../../d4/d8/mi_8h.html#a121">CONSISTENCY_LOCK_PFN</a> (OldIrql);
02220 
02221         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex = (<a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>)(WslEntry - <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o31">Wsle</a>);
02222 
02223         <a class="code" href="../../d4/d8/mi_8h.html#a122">CONSISTENCY_UNLOCK_PFN</a> (OldIrql);
02224     }
02225 
02226     <span class="comment">//</span>
02227     <span class="comment">// The next reserved slot is for the page table page</span>
02228     <span class="comment">// mapping the first session paged pool page.</span>
02229     <span class="comment">//</span>
02230 
02231     WslEntry += 1;
02232 
02233     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress = (PVOID)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o18">PagedPoolStart</a>);
02234     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid = 1;
02235     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.LockedInWs = 1;
02236     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Direct = 1;
02237 
02238     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (MiGetPteAddress (WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress)-&gt;u.Hard.PageFrameNumber);
02239 
02240     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex == 0);
02241 
02242     <a class="code" href="../../d4/d8/mi_8h.html#a121">CONSISTENCY_LOCK_PFN</a> (OldIrql);
02243 
02244     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex = (<a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>)(WslEntry - <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o31">Wsle</a>);
02245 
02246     <a class="code" href="../../d4/d8/mi_8h.html#a122">CONSISTENCY_UNLOCK_PFN</a> (OldIrql);
02247 
02248     CurrentEntry = (<a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>)(WslEntry + 1 - <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o31">Wsle</a>);
02249 
02250     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionSpace = 1;
02251     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o5">MinimumWorkingSetSize</a> = <a class="code" href="../../d4/d8/mi_8h.html#a402">MI_SESSION_SPACE_WORKING_SET_MINIMUM</a>;
02252     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o6">MaximumWorkingSetSize</a> = WorkingSetMaximum;
02253 
02254     <span class="comment">//</span>
02255     <span class="comment">// Don't trim from this session till we're finished setting up and</span>
02256     <span class="comment">// it's got some pages in it...</span>
02257     <span class="comment">//</span>
02258 
02259     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o9">AllowWorkingSetAdjustment</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02260 
02261     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o3">LastEntry</a> = <a class="code" href="../../d4/d8/mi_8h.html#a402">MI_SESSION_SPACE_WORKING_SET_MINIMUM</a>;
02262     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a> = <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o3">LastEntry</a>;
02263     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o9">HashTable</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02264     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o10">HashTableSize</a> = 0;
02265     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o5">Wsle</a> = <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o31">Wsle</a>;
02266 
02267     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o12">HashTableStart</a> =
02268        (PVOID)((PCHAR)<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o31">Wsle</a>[MI_SESSION_MAXIMUM_WORKING_SET]) + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
02269 
02270 <span class="preprocessor">#if defined (_X86PAE_)</span>
02271 <span class="preprocessor"></span>
02272     <span class="comment">//</span>
02273     <span class="comment">// One less page table page is needed on PAE systems.</span>
02274     <span class="comment">//</span>
02275 
02276     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o13">HighestPermittedHashAddress</a> =
02277         (PVOID)(<a class="code" href="../../d4/d8/mi_8h.html#a349">MI_SESSION_VIEW_START</a> - <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a50">MM_VA_MAPPED_BY_PDE</a>);
02278 <span class="preprocessor">#else</span>
02279 <span class="preprocessor"></span>    <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o13">HighestPermittedHashAddress</a> =
02280         (PVOID)<a class="code" href="../../d4/d8/mi_8h.html#a349">MI_SESSION_VIEW_START</a>;
02281 <span class="preprocessor">#endif</span>
02282 <span class="preprocessor"></span>
02283     NumberOfEntriesMapped = (<a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>)(((<a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a>)((ULONG_PTR)<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a> +
02284                                 <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>)) - <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o31">Wsle</a>);
02285 
02286     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02287 
02288     <span class="keywordflow">while</span> (NumberOfEntriesMapped &lt; WorkingSetMaximum) {
02289 
02290         PointerPte += 1;
02291 
02292         <a class="code" href="../../d7/d5/pfnlist_8c.html#a13">MiEnsureAvailablePageOrWait</a> (NULL, NULL);
02293 
02294         PageFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a14">MiRemoveZeroPage</a>(MI_GET_PAGE_COLOR_FROM_VA (NULL));
02295 
02296         PointerPte-&gt;u.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a95">MM_DEMAND_ZERO_WRITE_PTE</a>;
02297 
02298         <a class="code" href="../../d8/d2/pagfault_8c.html#a22">MiInitializePfn</a> (PageFrameIndex, PointerPte, 1);
02299 
02300         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = PageFrameIndex;
02301 
02302         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a109">MI_SET_PTE_IN_WORKING_SET</a> (&amp;TempPte, CurrentEntry);
02303 
02304         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPte, TempPte);
02305 
02306         WslEntry += 1;
02307 
02308         WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
02309         WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid = 1;
02310         WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.LockedInWs = 1;
02311         WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Direct = 1;
02312 
02313         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPte-&gt;u.Hard.PageFrameNumber);
02314 
02315         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex == 0);
02316         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex = CurrentEntry;
02317 
02318         <span class="comment">// MiInsertWsle(CurrentEntry, MmWorkingSetList);</span>
02319 
02320         CurrentEntry += 1;
02321 
02322         NumberOfEntriesMapped += <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> / <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d8/struct__MMWSLE.html">MMWSLE</a>);
02323     }
02324 
02325     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02326 
02327     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> = CurrentEntry;
02328     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> = CurrentEntry;
02329     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a> = CurrentEntry;
02330     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o4">NextSlot</a> = CurrentEntry;
02331 
02332     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o13">NonPagablePages</a> += ResidentPages;
02333     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o14">CommittedPages</a> += ResidentPages;
02334 
02335     <span class="comment">//</span>
02336     <span class="comment">// Initialize the following slots as free.</span>
02337     <span class="comment">//</span>
02338 
02339     WslEntry = <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o31">Wsle</a> + CurrentEntry;
02340 
02341     <span class="keywordflow">for</span> (i = CurrentEntry + 1; i &lt; NumberOfEntriesMapped; i += 1) {
02342 
02343         <span class="comment">//</span>
02344         <span class="comment">// Build the free list, note that the first working</span>
02345         <span class="comment">// set entries (CurrentEntry) are not on the free list.</span>
02346         <span class="comment">// These entries are reserved for the pages which</span>
02347         <span class="comment">// map the working set and the page which contains the PDE.</span>
02348         <span class="comment">//</span>
02349 
02350         WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.Long = i &lt;&lt; <a class="code" href="../../d4/d8/mi_8h.html#a9">MM_FREE_WSLE_SHIFT</a>;
02351         WslEntry += 1;
02352     }
02353 
02354     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.Long = <a class="code" href="../../d4/d8/mi_8h.html#a10">WSLE_NULL_INDEX</a> &lt;&lt; <a class="code" href="../../d4/d8/mi_8h.html#a9">MM_FREE_WSLE_SHIFT</a>;  <span class="comment">// End of list.</span>
02355 
02356     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a> = NumberOfEntriesMapped - 1;
02357 
02358     <span class="keywordflow">if</span> (WorkingSetMaximum &gt; ((1536*1024) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>)) {
02359 
02360         <span class="comment">//</span>
02361         <span class="comment">// The working set list consists of more than a single page.</span>
02362         <span class="comment">//</span>
02363 
02364         <a class="code" href="../../d4/d0/wslist_8c.html#a33">MiGrowWsleHash</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>);
02365     }
02366 
02367     <span class="comment">//</span>
02368     <span class="comment">// Put this session's working set in lists using its global address.</span>
02369     <span class="comment">//</span>
02370 
02371     <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
02372 
02373     InsertTailList (&amp;MiSessionWsList, &amp;SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o33">WsListEntry</a>);
02374 
02375     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o3">u</a>.Flags.HasWsLock = 1;
02376 
02377     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o3">u</a>.Flags.SessionListInserted = 1;
02378 
02379     <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
02380 
02381     <span class="keywordflow">return</span> STATUS_SUCCESS;
02382 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a34" doxytag="wslist.c::MiTrimWorkingSet" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG MiTrimWorkingSet           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Reduction</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>WsInfo</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ForcedReductionOrTrimAge</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d9/wslist_8c-source.html#l03612">3612</a> of file <a class="el" href="../../d5/d9/wslist_8c-source.html">wslist.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01600">_MMWSL::FirstDynamic</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01601">_MMWSL::LastEntry</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01336">MI_GET_ACCESSED_IN_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01892">MI_GET_WSLE_AGE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01313">MI_SET_ACCESSED_IN_PTE</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l01326">MiFreeWsle()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d4/d0/wslist_8c.html#a17">MiRemoveWorkingSetPages()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01017">MM_SYSTEM_WS_LOCK_ASSERT</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00064">MmSystemCacheWs</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01602">_MMWSL::NextSlot</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02176">PERFINFO_GET_PAGE_INFO_WITH_DECL</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02195">PERFINFO_LOG_WS_REMOVAL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01598">_MMWSL::Quota</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d3/d6/struct__MMSUPPORT.html#o15">_MMSUPPORT::u</a>, <a class="el" href="../../d1/d8/struct__MMWSLE.html#o3">_MMWSLE::u1</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01583">_MMWSLE::VirtualAddress</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l01603">_MMWSL::Wsle</a>.
<p>
Referenced by <a class="el" href="../../d5/d9/wslist_8c-source.html#l00254">MiDoReplacement()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l05567">MmSetMemoryPriorityProcess()</a>, and <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00397">MmWorkingSetManager()</a>.
<p>
<pre class="fragment"><div>03620                    :
03621 
03622     This function reduces <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified amount.
03623 
03624 Arguments:
03625 
03626     Reduction - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of pages to remove from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working
03627                 set.
03628 
03629     WsInfo - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set information <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03630              process (or system cache) to trim.
03631 
03632     ForcedReductionOrTrimAge - If <span class="keyword">using</span> fault-based trimming, <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set to
03633                                <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> reduction <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being done to free up
03634                                pages in which <span class="keywordflow">case</span> we should <span class="keywordflow">try</span> to reduce
03635                                working set pages as well.  Set to <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> when
03636                                <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> reduction <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> trying to increase <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> fault
03637                                rates in which <span class="keywordflow">case</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> policy should be more
03638                                like locate and reserve.
03639 
03640                                If <span class="keyword">using</span> claim-based trimming, <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> age
03641                                value to use - ie: pages of <span class="keyword">this</span> age or older
03642                                will be removed.
03643 
03644 Return Value:
03645 
03646     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> actual number of pages removed.
03647 
03648 Environment:
03649 
03650     Kernel mode, APCs disabled, working set lock.  PFN lock NOT held.
03651 
03652 --*/
03653 
03654 {
03655     ULONG TryToFree;
03656     ULONG StartEntry;
03657     ULONG LastEntry;
03658     <a class="code" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a> WorkingSetList;
03659     <a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a> Wsle;
03660     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
03661     ULONG NumberLeftToRemove;
03662     ULONG LoopCount;
03663     ULONG EndCount;
03664     BOOLEAN StartFromZero;
03665 
03666     NumberLeftToRemove = Reduction;
03667     WorkingSetList = WsInfo-&gt;VmWorkingSetList;
03668     Wsle = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o5">Wsle</a>;
03669 
03670 <span class="preprocessor">#if DBG</span>
03671 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (WsInfo == &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>) {
03672         <a class="code" href="../../d4/d8/mi_8h.html#a147">MM_SYSTEM_WS_LOCK_ASSERT</a>();
03673     }
03674 <span class="preprocessor">#endif //DBG</span>
03675 <span class="preprocessor"></span>
03676     LastEntry = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o3">LastEntry</a>;
03677 
03678     TryToFree = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o4">NextSlot</a>;
03679     <span class="keywordflow">if</span> (TryToFree &gt; LastEntry || TryToFree &lt; WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>) {
03680         TryToFree = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>;
03681     }
03682 
03683     StartEntry = TryToFree;
03684 
03685 <span class="preprocessor">#ifdef _MI_USE_CLAIMS_</span>
03686 <span class="preprocessor"></span>
03687     <span class="keywordflow">while</span> (NumberLeftToRemove != 0) {
03688         <span class="keywordflow">if</span> (Wsle[TryToFree].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid == 1) {
03689             PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (Wsle[TryToFree].u1.VirtualAddress);
03690 
03691             <span class="keywordflow">if</span> ((ForcedReductionOrTrimAge == 0) ||
03692                 ((<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a138">MI_GET_ACCESSED_IN_PTE</a> (PointerPte) == 0) &amp;&amp;
03693                 (<a class="code" href="../../d4/d8/mi_8h.html#a213">MI_GET_WSLE_AGE</a>(PointerPte, &amp;Wsle[TryToFree]) &gt;= ForcedReductionOrTrimAge))) {
03694 
03695                 <a class="code" href="../../d2/d1/mm_8h.html#a55">PERFINFO_GET_PAGE_INFO_WITH_DECL</a>(PointerPte);
03696 
03697                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/wslist_8c.html#a26">MiFreeWsle</a> (TryToFree, WsInfo, PointerPte)) {
03698                     <a class="code" href="../../d2/d1/mm_8h.html#a74">PERFINFO_LOG_WS_REMOVAL</a>(PERFINFO_LOG_TYPE_OUTWS_VOLUNTRIM, WsInfo);
03699                     NumberLeftToRemove -= 1;
03700                 }
03701             }
03702         }
03703         TryToFree += 1;
03704 
03705         <span class="keywordflow">if</span> (TryToFree &gt; LastEntry) {
03706             TryToFree = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>;
03707         }
03708 
03709         <span class="keywordflow">if</span> (TryToFree == StartEntry) {
03710             <span class="keywordflow">break</span>;
03711         }
03712     }
03713 
03714 <span class="preprocessor">#else</span>
03715 <span class="preprocessor"></span>
03716     LoopCount = 0;
03717 
03718     <span class="keywordflow">if</span> (ForcedReductionOrTrimAge) {
03719         EndCount = 4;
03720     } <span class="keywordflow">else</span> {
03721         EndCount = 1;
03722     }
03723 
03724     StartFromZero = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03725 
03726     <span class="keywordflow">while</span> (NumberLeftToRemove != 0 &amp;&amp; LoopCount != EndCount) {
03727         <span class="keywordflow">while</span> ((NumberLeftToRemove != 0) &amp;&amp; (TryToFree &lt;= LastEntry)) {
03728 
03729             <span class="keywordflow">if</span> (Wsle[TryToFree].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid == 1) {
03730                 PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (Wsle[TryToFree].u1.VirtualAddress);
03731                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a138">MI_GET_ACCESSED_IN_PTE</a> (PointerPte)) {
03732 
03733                     <span class="comment">//</span>
03734                     <span class="comment">// If accessed bit is set, clear it.  If accessed</span>
03735                     <span class="comment">// bit is clear, remove from working set.</span>
03736                     <span class="comment">//</span>
03737 
03738                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a137">MI_SET_ACCESSED_IN_PTE</a> (PointerPte, 0);
03739                 } <span class="keywordflow">else</span> {
03740                     <a class="code" href="../../d2/d1/mm_8h.html#a55">PERFINFO_GET_PAGE_INFO_WITH_DECL</a>(PointerPte);
03741                     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/wslist_8c.html#a26">MiFreeWsle</a> (TryToFree, WsInfo, PointerPte)) {
03742                         <a class="code" href="../../d2/d1/mm_8h.html#a74">PERFINFO_LOG_WS_REMOVAL</a>(PERFINFO_LOG_TYPE_OUTWS_VOLUNTRIM, WsInfo);
03743                         NumberLeftToRemove -= 1;
03744                     }
03745                 }
03746             }
03747             TryToFree += 1;
03748 
03749             <span class="keywordflow">if</span> (StartFromZero == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> &amp;&amp; EndCount == 1 &amp;&amp; TryToFree &gt;= StartEntry) {
03750                 LoopCount = EndCount;
03751                 <span class="keywordflow">if</span> (TryToFree &gt; LastEntry) {
03752                     TryToFree = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>;
03753                 }
03754                 <span class="keywordflow">break</span>;
03755             }
03756         }
03757 
03758         <span class="keywordflow">if</span> (TryToFree &gt; LastEntry) {
03759             TryToFree = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>;
03760             <span class="keywordflow">if</span> (StartFromZero == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
03761 
03762                 <span class="comment">//</span>
03763                 <span class="comment">// We've already wrapped once but didn't get back to</span>
03764                 <span class="comment">// the StartEntry.  Use the first dynamic as our base now.</span>
03765                 <span class="comment">//</span>
03766 
03767                 StartEntry = TryToFree;
03768             }
03769             <span class="keywordflow">else</span> {
03770                 StartFromZero = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03771             }
03772 
03773             <span class="keywordflow">if</span> (TryToFree &gt;= StartEntry) {
03774 
03775                 <span class="comment">//</span>
03776                 <span class="comment">// We've wrapped. If this is not a forced trim, then bail</span>
03777                 <span class="comment">// now so we don't cannibalize entries we just cleared the</span>
03778                 <span class="comment">// access bit for because they haven't had a fair chance to</span>
03779                 <span class="comment">// be re-accessed yet.</span>
03780                 <span class="comment">//</span>
03781 
03782                 LoopCount += 1;
03783                 StartFromZero = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03784             }
03785         }
03786     }
03787 
03788 <span class="preprocessor">#endif</span>
03789 <span class="preprocessor"></span>
03790     WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o4">NextSlot</a> = TryToFree;
03791 
03792     <span class="comment">//</span>
03793     <span class="comment">// If this is not the system cache or a session working set, see if the</span>
03794     <span class="comment">// working set list can be contracted.</span>
03795     <span class="comment">//</span>
03796 
03797     <span class="keywordflow">if</span> (WsInfo != &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a> &amp;&amp; WsInfo-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionSpace == 0) {
03798 
03799         <span class="comment">//</span>
03800         <span class="comment">// Make sure we are at least a page above the working set maximum.</span>
03801         <span class="comment">//</span>
03802 
03803         <span class="keywordflow">if</span> (WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a> == WsInfo-&gt;WorkingSetSize) {
03804                 <a class="code" href="../../d4/d0/wslist_8c.html#a17">MiRemoveWorkingSetPages</a> (WorkingSetList, WsInfo);
03805         } <span class="keywordflow">else</span> {
03806 
03807             <span class="keywordflow">if</span> ((WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a> + 15 + (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> / <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d8/struct__MMWSLE.html">MMWSLE</a>))) &lt;
03808                                                     WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o3">LastEntry</a>) {
03809                 <span class="keywordflow">if</span> ((WsInfo-&gt;MaximumWorkingSetSize + 15 + (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> / <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d8/struct__MMWSLE.html">MMWSLE</a>))) &lt;
03810                      WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o3">LastEntry</a> ) {
03811                     <a class="code" href="../../d4/d0/wslist_8c.html#a17">MiRemoveWorkingSetPages</a> (WorkingSetList, WsInfo);
03812                 }
03813             }
03814         }
03815     }
03816     <span class="keywordflow">return</span> Reduction - NumberLeftToRemove;
03817 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="wslist.c::MiUpdateWsle" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiUpdateWsle           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT <a class="el" href="../../d4/d8/mi_8h.html#a436">PWSLE_NUMBER</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredIndex</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>VirtualAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>WorkingSetList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Pfn</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d9/wslist_8c-source.html#l01078">1078</a> of file <a class="el" href="../../d5/d9/wslist_8c-source.html">wslist.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00058">ASSERT32</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00875">CONSISTENCY_LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00876">CONSISTENCY_UNLOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01600">_MMWSL::FirstDynamic</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01599">_MMWSL::FirstFree</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01607">_MMWSL::HashTable</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01601">_MMWSL::LastEntry</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01605">_MMWSL::LastInitializedWsle</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05293">MI_IS_SESSION_ADDRESS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02717">MI_IS_SYSTEM_CACHE_ADDRESS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01521">MI_ZERO_WSINDEX</a>, <a class="el" href="../../d8/d9/wstree_8c-source.html#l00051">MiInsertWsle()</a>, <a class="el" href="../../d8/d9/wstree_8c-source.html#l00576">MiSwapWslEntries()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00076">MM_FREE_WSLE_SHIFT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00160">MM_PAGED_POOL_START</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00135">MM_SYSTEM_SPACE_START</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01017">MM_SYSTEM_WS_LOCK_ASSERT</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00063">MmNonPagedSystemStart</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00048">MmPagedPoolPage</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05609">MmSessionSpace</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00047">MmSystemCachePage</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00049">MmSystemCacheStart</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04752">MmSystemCacheWorkingSetList</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00064">MmSystemCacheWs</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04754">MmSystemCacheWsle</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00046">MmSystemCodePage</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00049">MmSystemDriverPage</a>, <a class="el" href="../../d1/d8/miglobal_8c-source.html#l00444">MmWsle</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00190">PAGE_ALIGN</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01231">PWSLE_NUMBER</a>, <a class="el" href="../../d1/d8/struct__MMWSLE.html#o3">_MMWSLE::u1</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05556">_MM_SESSION_SPACE::Vm</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01603">_MMWSL::Wsle</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00078">WSLE_NULL_INDEX</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l01231">WSLE_NUMBER</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/pagfault_8c-source.html#l04056">MiAddValidPageToWorkingSet()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l02824">MiAddWorkingSetPage()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l03179">MiAddWsleHash()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06461">MiLockCode()</a>, <a class="el" href="../../d5/d0/mmfault_8c-source.html#l00041">MmAccessFault()</a>, <a class="el" href="../../d2/d4/mapcache_8c-source.html#l01016">MmCheckCachedPageState()</a>, and <a class="el" href="../../d2/d4/mapcache_8c-source.html#l01274">MmCopyToCachedPage()</a>.
<p>
<pre class="fragment"><div>01087                    :
01088 
01089     This routine updates a reserved working set entry to place <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> into
01090     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> valid state.
01091 
01092 Arguments:
01093 
01094     DesiredIndex - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> index of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set entry to update.
01095 
01096     VirtualAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set
01097                      entry maps.
01098 
01099     WsInfo - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set info block <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01100              process (or system cache).
01101 
01102     Pfn - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PFN element <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page.
01103 
01104 Return Value:
01105 
01106     None.
01107 
01108 Environment:
01109 
01110     Kernel mode, APCs disabled, working set lock held and PFN lock held.
01111 
01112 --*/
01113 
01114 {
01115     <a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a> Wsle;
01116     <a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01117     <a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> WorkingSetIndex;
01118 <span class="preprocessor">#if PFN_CONSISTENCY</span>
01119 <span class="preprocessor"></span>    KIRQL OldIrql;
01120 <span class="preprocessor">#endif</span>
01121 <span class="preprocessor"></span>
01122     WorkingSetIndex = *DesiredIndex;
01123     Wsle = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o5">Wsle</a>;
01124 
01125     <span class="keywordflow">if</span> (WorkingSetList == <a class="code" href="../../d4/d8/mi_8h.html#a657">MmSystemCacheWorkingSetList</a>) {
01126 
01127         <span class="comment">//</span>
01128         <span class="comment">// This assert doesn't hold for NT64 as we can be adding page</span>
01129         <span class="comment">// directories and page tables for the system cache WSLE hash tables.</span>
01130         <span class="comment">//</span>
01131 
01132         <a class="code" href="../../d4/d8/mi_8h.html#a0">ASSERT32</a> ((VirtualAddress &lt; (PVOID)PTE_BASE) ||
01133                   (VirtualAddress &gt;= (PVOID)MM_SYSTEM_SPACE_START));
01134     } <span class="keywordflow">else</span> {
01135         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((VirtualAddress &lt; (PVOID)MM_SYSTEM_SPACE_START) ||
01136                (MI_IS_SESSION_ADDRESS (VirtualAddress)));
01137     }
01138 
01139     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WorkingSetIndex &gt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>);
01140 
01141     <span class="keywordflow">if</span> (WorkingSetList == <a class="code" href="../../d4/d8/mi_8h.html#a657">MmSystemCacheWorkingSetList</a>) {
01142 
01143         <a class="code" href="../../d4/d8/mi_8h.html#a147">MM_SYSTEM_WS_LOCK_ASSERT</a>();
01144 
01145         <span class="comment">//</span>
01146         <span class="comment">// count system space inserts and removals.</span>
01147         <span class="comment">//</span>
01148 
01149 <span class="preprocessor">#if defined(_X86_)</span>
01150 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a196">MI_IS_SYSTEM_CACHE_ADDRESS</a>(VirtualAddress)) {
01151             <a class="code" href="../../d6/d8/sysinfo_8c.html#a10">MmSystemCachePage</a> += 1;
01152         } <span class="keywordflow">else</span>
01153 <span class="preprocessor">#endif</span>
01154 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (VirtualAddress &lt; <a class="code" href="../../d8/d5/kddata_8c.html#a11">MmSystemCacheStart</a>) {
01155             <a class="code" href="../../d6/d8/sysinfo_8c.html#a9">MmSystemCodePage</a> += 1;
01156         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (VirtualAddress &lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a21">MM_PAGED_POOL_START</a>) {
01157             <a class="code" href="../../d6/d8/sysinfo_8c.html#a10">MmSystemCachePage</a> += 1;
01158         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (VirtualAddress &lt; <a class="code" href="../../d8/d5/kddata_8c.html#a22">MmNonPagedSystemStart</a>) {
01159             <a class="code" href="../../d6/d8/sysinfo_8c.html#a11">MmPagedPoolPage</a> += 1;
01160         } <span class="keywordflow">else</span> {
01161             <a class="code" href="../../d6/d8/sysinfo_8c.html#a12">MmSystemDriverPage</a> += 1;
01162         }
01163     }
01164 
01165     <span class="comment">//</span>
01166     <span class="comment">// Make the wsle valid, referring to the corresponding virtual</span>
01167     <span class="comment">// page number.</span>
01168     <span class="comment">//</span>
01169 
01170     <span class="comment">//</span>
01171     <span class="comment">// The value 0 is invalid.  This is due to the fact that the working</span>
01172     <span class="comment">// set lock is a process wide lock and two threads in different</span>
01173     <span class="comment">// processes could be adding the same physical page to their working</span>
01174     <span class="comment">// sets.  Each one could see the WsIndex field in the PFN as 0, and</span>
01175     <span class="comment">// set the direct bit.  To solve this, the WsIndex field is set to</span>
01176     <span class="comment">// the current thread pointer.</span>
01177     <span class="comment">//</span>
01178 
01179     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn-&gt;u1.WsIndex != 0);
01180 
01181 <span class="preprocessor">#if DBG</span>
01182 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (Pfn-&gt;u1.WsIndex &lt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a>) {
01183         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(VirtualAddress) !=
01184                 <a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(Wsle[Pfn-&gt;u1.WsIndex].u1.VirtualAddress)) ||
01185                 (Wsle[Pfn-&gt;u1.WsIndex].u1.e1.Valid == 0));
01186     }
01187 <span class="preprocessor">#endif //DBG</span>
01188 <span class="preprocessor"></span>
01189     Wsle[WorkingSetIndex].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress = VirtualAddress;
01190     Wsle[WorkingSetIndex].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.Long &amp;= ~(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1);
01191     Wsle[WorkingSetIndex].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid = 1;
01192 
01193     <span class="keywordflow">if</span> ((ULONG_PTR)Pfn-&gt;u1.Event == (ULONG_PTR)<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()) {
01194 
01195         <span class="comment">//</span>
01196         <span class="comment">// Directly index into the WSL for this entry via the PFN database</span>
01197         <span class="comment">// element.</span>
01198         <span class="comment">//</span>
01199 
01200         <a class="code" href="../../d4/d8/mi_8h.html#a121">CONSISTENCY_LOCK_PFN</a> (OldIrql);
01201 
01202 <span class="preprocessor">#if defined(_WIN64)</span>
01203 <span class="preprocessor"></span>
01204         <span class="comment">//</span>
01205         <span class="comment">// The entire working set index union must be zeroed on Win64 systems.</span>
01206         <span class="comment">//</span>
01207 
01208         <a class="code" href="../../d4/d8/mi_8h.html#a190">MI_ZERO_WSINDEX</a> (Pfn);
01209 
01210 <span class="preprocessor">#endif</span>
01211 <span class="preprocessor"></span>
01212         Pfn-&gt;u1.WsIndex = WorkingSetIndex;
01213 
01214         <a class="code" href="../../d4/d8/mi_8h.html#a122">CONSISTENCY_UNLOCK_PFN</a> (OldIrql);
01215 
01216         Wsle[WorkingSetIndex].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Direct = 1;
01217 
01218         <span class="keywordflow">return</span>;
01219 
01220     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o9">HashTable</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01221 
01222         <span class="comment">//</span>
01223         <span class="comment">// Try to insert at WsIndex.</span>
01224         <span class="comment">//</span>
01225 
01226         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = Pfn-&gt;u1.WsIndex;
01227 
01228         <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a>) &amp;&amp;
01229             (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &gt; WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>) &amp;&amp;
01230             (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> != WorkingSetIndex)) {
01231 
01232             <span class="keywordflow">if</span> (Wsle[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid) {
01233 
01234                 <span class="keywordflow">if</span> (Wsle[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Direct) {
01235 
01236                     <span class="comment">//</span>
01237                     <span class="comment">// Only move direct indexed entries.</span>
01238                     <span class="comment">//</span>
01239 
01240                     <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> WsInfo;
01241 
01242                     <span class="keywordflow">if</span> (Wsle == <a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>) {
01243                         WsInfo = &amp;<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Vm;
01244                     }
01245                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Wsle == <a class="code" href="../../d4/d8/mi_8h.html#a658">MmSystemCacheWsle</a>) {
01246                         WsInfo = &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>;
01247                     }
01248                     <span class="keywordflow">else</span> {
01249                         WsInfo = &amp;<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>;
01250                     }
01251 
01252                     <a class="code" href="../../d7/d0/wstree_8c.html#a9">MiSwapWslEntries</a> (Index, WorkingSetIndex, WsInfo);
01253                     WorkingSetIndex = <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01254                 }
01255             } <span class="keywordflow">else</span> {
01256 
01257                 <span class="comment">//</span>
01258                 <span class="comment">// On free list, try to remove quickly without walking</span>
01259                 <span class="comment">// all the free pages.</span>
01260                 <span class="comment">//</span>
01261 
01262                 ULONG FreeIndex;
01263                 <a class="code" href="../../d1/d8/struct__MMWSLE.html">MMWSLE</a> Temp;
01264 
01265                 FreeIndex = 0;
01266 
01267                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> &gt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>);
01268                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WorkingSetIndex &gt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>);
01269 
01270                 <span class="keywordflow">if</span> (WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> == <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>) {
01271                     WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> = WorkingSetIndex;
01272                     Temp = Wsle[WorkingSetIndex];
01273                     Wsle[WorkingSetIndex] = Wsle[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
01274                     Wsle[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] = Temp;
01275                     WorkingSetIndex = <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01276                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (((Wsle[WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a>].u1.Long &gt;&gt; MM_FREE_WSLE_SHIFT)
01277                                      &lt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a>) ||
01278                             ((Wsle[WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a>].u1.Long &gt;&gt; MM_FREE_WSLE_SHIFT)
01279                                     == WSLE_NULL_INDEX));
01280                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Wsle[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> - 1].u1.e1.Valid == 0) {
01281                     <span class="keywordflow">if</span> ((Wsle[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> - 1].u1.Long &gt;&gt; <a class="code" href="../../d4/d8/mi_8h.html#a9">MM_FREE_WSLE_SHIFT</a>) == <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>) {
01282                         FreeIndex = <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> - 1;
01283                     }
01284                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Wsle[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> + 1].u1.e1.Valid == 0) {
01285                     <span class="keywordflow">if</span> ((Wsle[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> + 1].u1.Long &gt;&gt; <a class="code" href="../../d4/d8/mi_8h.html#a9">MM_FREE_WSLE_SHIFT</a>) == <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>) {
01286                         FreeIndex = <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> + 1;
01287                     }
01288                 }
01289                 <span class="keywordflow">if</span> (FreeIndex != 0) {
01290 
01291                     <span class="comment">//</span>
01292                     <span class="comment">// Link the Wsle into the free list.</span>
01293                     <span class="comment">//</span>
01294 
01295                     Temp = Wsle[WorkingSetIndex];
01296                     Wsle[FreeIndex].u1.Long = WorkingSetIndex &lt;&lt; <a class="code" href="../../d4/d8/mi_8h.html#a9">MM_FREE_WSLE_SHIFT</a>;
01297                     Wsle[WorkingSetIndex] = Wsle[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
01298                     Wsle[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] = Temp;
01299                     WorkingSetIndex = <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01300 
01301                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (((Wsle[FreeIndex].u1.Long &gt;&gt; MM_FREE_WSLE_SHIFT)
01302                                      &lt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a>) ||
01303                             ((Wsle[FreeIndex].u1.Long &gt;&gt; MM_FREE_WSLE_SHIFT)
01304                                     == WSLE_NULL_INDEX));
01305                 }
01306 
01307             }
01308             *DesiredIndex = WorkingSetIndex;
01309 
01310             <span class="keywordflow">if</span> (WorkingSetIndex &gt; WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o3">LastEntry</a>) {
01311                 WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o3">LastEntry</a> = WorkingSetIndex;
01312             }
01313         }
01314     }
01315 
01316     <span class="comment">//</span>
01317     <span class="comment">// Insert the valid WSLE into the working set list.</span>
01318     <span class="comment">//</span>
01319 
01320     <a class="code" href="../../d7/d0/wstree_8c.html#a6">MiInsertWsle</a> (WorkingSetIndex, WorkingSetList);
01321     <span class="keywordflow">return</span>;
01322 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a31" doxytag="wslist.c::MmAdjustWorkingSetSize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MmAdjustWorkingSetSize           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>WorkingSetMinimumInBytes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>WorkingSetMaximumInBytes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemCache</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d9/wslist_8c-source.html#l02450">2450</a> of file <a class="el" href="../../d5/d9/wslist_8c-source.html">wslist.c</a>.
<p>
References <a class="el" href="../../d2/d8/ps_8h-source.html#l00216">_EPROCESS::AddressSpaceDeleted</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00066">_MMSUPPORT::AllowWorkingSetAdjustment</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l03321">ExPageLockHandle</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01600">_MMWSL::FirstDynamic</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01599">_MMWSL::FirstFree</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01607">_MMWSL::HashTable</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01601">_MMWSL::LastEntry</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01605">_MMWSL::LastInitializedWsle</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00998">LOCK_SYSTEM_WS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01039">LOCK_WS</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00063">_MMSUPPORT::MaximumWorkingSetSize</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04360">MI_NONPAGABLE_MEMORY_AVAILABLE</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l02824">MiAddWorkingSetPage()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l04726">MiEmptyWorkingSet()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l01326">MiFreeWsle()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l03300">MiGrowWsleHash()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00062">_MMSUPPORT::MinimumWorkingSetSize</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04317">MM_BUMP_COUNTER</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00088">MM_FLUID_WORKING_SET</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l00045">MM_RETRY_COUNT</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l04948">MmAllowWorkingSetExpansion()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00134">MmAvailablePages</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06284">MmLockPagableSectionByHandle()</a>, <a class="el" href="../../d1/d8/miglobal_8c-source.html#l00687">MmMaximumWorkingSetSize</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05152">MmMinimumWorkingSetSize</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04506">MmPagesAboveWsMinimum</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00086">MmResidentAvailablePages</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00064">MmSystemCacheWs</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07065">MmUnlockPagableImageSection()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02174">PERFINFO_GET_PAGE_INFO</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02195">PERFINFO_LOG_WS_REMOVAL</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02201">PERFINFO_PAGE_INFO_DECL</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01598">_MMWSL::Quota</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d8/struct__MMWSLE.html#o3">_MMWSLE::u1</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01005">UNLOCK_SYSTEM_WS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01081">UNLOCK_WS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01583">_MMWSLE::VirtualAddress</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00196">_EPROCESS::Vm</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00064">_MMSUPPORT::VmWorkingSetList</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00061">_MMSUPPORT::WorkingSetSize</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01603">_MMWSL::Wsle</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00078">WSLE_NULL_INDEX</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l01231">WSLE_NUMBER</a>.
<p>
Referenced by <a class="el" href="../../d2/d0/psjob_8c-source.html#l01323">NtSetInformationJobObject()</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l02264">NtSetSystemInformation()</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l00439">PspAddProcessToJob()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l01211">PspSetQuotaLimits()</a>, and <a class="el" href="../../d5/d8/minmax_8c-source.html#l01329">xxxMinMaximize()</a>.
<p>
<pre class="fragment"><div>02458                    :
02459 
02460     This routine adjusts <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current size of a process's working set
02461     list.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> maximum value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> above <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current maximum, pages
02462     are removed from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set list.
02463 
02464     An exception <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> raised <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> limit cannot be granted.  This
02465     could occur <span class="keywordflow">if</span> too many pages were locked in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process's
02466     working set.
02467 
02468     Note: <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d4/mrcf_8c.html#a3">minimum</a> and maximum are both (SIZE_T)-1, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set
02469           <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> purged, but <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">default</span> sizes are not changed.
02470 
02471 Arguments:
02472 
02473     WorkingSetMinimumInBytes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> <a class="code" href="../../d0/d4/mrcf_8c.html#a3">minimum</a> working set size in
02474                                bytes.
02475 
02476     WorkingSetMaximumInBytes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> maximum working set size in
02477                                bytes.
02478 
02479     SystemCache - Supplies <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system cache working set <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being
02480                   adjusted, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">for</span> all other working sets.
02481 
02482 Return Value:
02483 
02484     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>.
02485 
02486 Environment:
02487 
02488     Kernel mode, IRQL <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> or below.
02489 
02490 --*/
02491 
02492 
02493 {
02494     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess;
02495     ULONG Entry;
02496     ULONG LastFreed;
02497     <a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a> Wsle;
02498     KIRQL OldIrql;
02499     KIRQL OldIrql2;
02500     SPFN_NUMBER i;
02501     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
02502     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> ReturnStatus;
02503     LONG PagesAbove;
02504     LONG NewPagesAbove;
02505     ULONG FreeTryCount;
02506     <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> WsInfo;
02507     <a class="code" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a> WorkingSetList;
02508     <a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> WorkingSetMinimum;
02509     <a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> WorkingSetMaximum;
02510 
02511     <a class="code" href="../../d2/d1/mm_8h.html#a80">PERFINFO_PAGE_INFO_DECL</a>();
02512 
02513     FreeTryCount = 0;
02514 
02515     <span class="keywordflow">if</span> (SystemCache) {
02516         WsInfo = &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>;
02517     } <span class="keywordflow">else</span> {
02518         CurrentProcess = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a> ();
02519         WsInfo = &amp;CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>;
02520     }
02521 
02522     <span class="keywordflow">if</span> ((WorkingSetMinimumInBytes == (SIZE_T)-1) &amp;&amp;
02523         (WorkingSetMaximumInBytes == (SIZE_T)-1)) {
02524         <span class="keywordflow">return</span> <a class="code" href="../../d4/d0/wslist_8c.html#a35">MiEmptyWorkingSet</a> (WsInfo, TRUE);
02525     }
02526 
02527     <span class="keywordflow">if</span> (WorkingSetMinimumInBytes == 0) {
02528         WorkingSetMinimum = WsInfo-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o5">MinimumWorkingSetSize</a>;
02529     }
02530     <span class="keywordflow">else</span> {
02531         WorkingSetMinimum = (<a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>)(WorkingSetMinimumInBytes &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
02532     }
02533 
02534     <span class="keywordflow">if</span> (WorkingSetMaximumInBytes == 0) {
02535         WorkingSetMaximum = WsInfo-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o6">MaximumWorkingSetSize</a>;
02536     }
02537     <span class="keywordflow">else</span> {
02538         WorkingSetMaximum = (<a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>)(WorkingSetMaximumInBytes &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
02539     }
02540 
02541     <span class="keywordflow">if</span> (WorkingSetMinimum &gt; WorkingSetMaximum) {
02542         <span class="keywordflow">return</span> STATUS_BAD_WORKING_SET_LIMIT;
02543     }
02544 
02545     <a class="code" href="../../d5/d6/iosup_8c.html#a76">MmLockPagableSectionByHandle</a>(ExPageLockHandle);
02546 
02547     ReturnStatus = STATUS_SUCCESS;
02548 
02549     <span class="comment">//</span>
02550     <span class="comment">// Get the working set lock and disable APCs.</span>
02551     <span class="comment">//</span>
02552 
02553     <span class="keywordflow">if</span> (SystemCache) {
02554         <a class="code" href="../../d4/d8/mi_8h.html#a144">LOCK_SYSTEM_WS</a> (OldIrql2);
02555     } <span class="keywordflow">else</span> {
02556         <a class="code" href="../../d4/d8/mi_8h.html#a154">LOCK_WS</a> (CurrentProcess);
02557 
02558         <span class="keywordflow">if</span> (CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o27">AddressSpaceDeleted</a> != 0) {
02559             ReturnStatus = STATUS_PROCESS_IS_TERMINATING;
02560             <span class="keywordflow">goto</span> Returns;
02561         }
02562     }
02563 
02564     <span class="keywordflow">if</span> (WorkingSetMaximum &gt; <a class="code" href="../../d0/d9/miglobal_8c.html#a137">MmMaximumWorkingSetSize</a>) {
02565         WorkingSetMaximum = <a class="code" href="../../d0/d9/miglobal_8c.html#a137">MmMaximumWorkingSetSize</a>;
02566         ReturnStatus = STATUS_WORKING_SET_LIMIT_RANGE;
02567     }
02568 
02569     <span class="keywordflow">if</span> (WorkingSetMinimum &gt; <a class="code" href="../../d0/d9/miglobal_8c.html#a137">MmMaximumWorkingSetSize</a>) {
02570         WorkingSetMinimum = <a class="code" href="../../d0/d9/miglobal_8c.html#a137">MmMaximumWorkingSetSize</a>;
02571         ReturnStatus = STATUS_WORKING_SET_LIMIT_RANGE;
02572     }
02573 
02574     <span class="keywordflow">if</span> (WorkingSetMinimum &lt; <a class="code" href="../../d4/d8/mi_8h.html#a741">MmMinimumWorkingSetSize</a>) {
02575         WorkingSetMinimum = (ULONG)<a class="code" href="../../d4/d8/mi_8h.html#a741">MmMinimumWorkingSetSize</a>;
02576         ReturnStatus = STATUS_WORKING_SET_LIMIT_RANGE;
02577     }
02578 
02579     <span class="comment">//</span>
02580     <span class="comment">// Make sure that the number of locked pages will not</span>
02581     <span class="comment">// make the working set not fluid.</span>
02582     <span class="comment">//</span>
02583 
02584     <span class="keywordflow">if</span> ((WsInfo-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a> + <a class="code" href="../../d4/d8/mi_8h.html#a15">MM_FLUID_WORKING_SET</a>) &gt;=
02585          WorkingSetMaximum) {
02586         ReturnStatus = STATUS_BAD_WORKING_SET_LIMIT;
02587         <span class="keywordflow">goto</span> Returns;
02588     }
02589 
02590     WorkingSetList = WsInfo-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>;
02591     Wsle = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o5">Wsle</a>;
02592 
02593     <span class="comment">//</span>
02594     <span class="comment">// Check to make sure ample resident physical pages exist for</span>
02595     <span class="comment">// this operation.</span>
02596     <span class="comment">//</span>
02597 
02598     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02599 
02600     i = WorkingSetMinimum - WsInfo-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o5">MinimumWorkingSetSize</a>;
02601 
02602     <span class="keywordflow">if</span> (i &gt; 0) {
02603 
02604         <span class="comment">//</span>
02605         <span class="comment">// New minimum working set is greater than the old one.  Ensure that</span>
02606         <span class="comment">// we don't allow this process' working set minimum to increase to</span>
02607         <span class="comment">// a point where subsequent nonpaged pool allocations could cause</span>
02608         <span class="comment">// us to run out of pages.  Additionally, leave 100 extra pages around</span>
02609         <span class="comment">// so the user can later bring up tlist and kill processes if necessary.</span>
02610         <span class="comment">//</span>
02611 
02612         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &lt; (20 + (i / (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> / <span class="keyword">sizeof</span> (<a class="code" href="../../d1/d8/struct__MMWSLE.html">MMWSLE</a>))))) {
02613             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02614             ReturnStatus = STATUS_INSUFFICIENT_RESOURCES;
02615             <span class="keywordflow">goto</span> Returns;
02616         }
02617 
02618         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a323">MI_NONPAGABLE_MEMORY_AVAILABLE</a>() - 100 &lt; i) {
02619             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02620             ReturnStatus = STATUS_INSUFFICIENT_RESOURCES;
02621             <span class="keywordflow">goto</span> Returns;
02622         }
02623     }
02624 
02625     <span class="comment">//</span>
02626     <span class="comment">// Adjust the number of resident pages up or down dependent on</span>
02627     <span class="comment">// the size of the new minimum working set size versus the previous</span>
02628     <span class="comment">// minimum size.</span>
02629     <span class="comment">//</span>
02630 
02631     <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> -= i;
02632     <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(27, i);
02633 
02634     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02635 
02636     <span class="keywordflow">if</span> (WsInfo-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o9">AllowWorkingSetAdjustment</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
02637         <a class="code" href="../../d4/d5/procsup_8c.html#a43">MmAllowWorkingSetExpansion</a> ();
02638     }
02639 
02640     <span class="keywordflow">if</span> (WorkingSetMaximum &gt; WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a>) {
02641 
02642          <span class="keywordflow">do</span> {
02643 
02644             <span class="comment">//</span>
02645             <span class="comment">// The maximum size of the working set is being increased, check</span>
02646             <span class="comment">// to ensure the proper number of pages are mapped to cover</span>
02647             <span class="comment">// the complete working set list.</span>
02648             <span class="comment">//</span>
02649 
02650             <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d0/wslist_8c.html#a16">MiAddWorkingSetPage</a> (WsInfo)) {
02651                 WorkingSetMaximum = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a> - 1;
02652                 <span class="keywordflow">break</span>;
02653             }
02654         } <span class="keywordflow">while</span> (WorkingSetMaximum &gt; WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a>);
02655 
02656     } <span class="keywordflow">else</span> {
02657 
02658         <span class="comment">//</span>
02659         <span class="comment">// The new working set maximum is less than the current working set</span>
02660         <span class="comment">// maximum.</span>
02661         <span class="comment">//</span>
02662 
02663         <span class="keywordflow">if</span> (WsInfo-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> &gt; WorkingSetMaximum) {
02664 
02665             <span class="comment">//</span>
02666             <span class="comment">// Remove some pages from the working set.</span>
02667             <span class="comment">//</span>
02668 
02669             <span class="comment">//</span>
02670             <span class="comment">// Make sure that the number of locked pages will not</span>
02671             <span class="comment">// make the working set not fluid.</span>
02672             <span class="comment">//</span>
02673 
02674             <span class="keywordflow">if</span> ((WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a> + <a class="code" href="../../d4/d8/mi_8h.html#a15">MM_FLUID_WORKING_SET</a>) &gt;=
02675                  WorkingSetMaximum) {
02676 
02677                 ReturnStatus = STATUS_BAD_WORKING_SET_LIMIT;
02678 
02679                 <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02680 
02681                 <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> += i;
02682                 <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(54, i);
02683 
02684                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02685 
02686                 <span class="keywordflow">goto</span> Returns;
02687             }
02688 
02689             <span class="comment">//</span>
02690             <span class="comment">// Attempt to remove the pages from the Maximum downward.</span>
02691             <span class="comment">//</span>
02692 
02693             LastFreed = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o3">LastEntry</a>;
02694             <span class="keywordflow">if</span> (WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o3">LastEntry</a> &gt; WorkingSetMaximum) {
02695 
02696                 <span class="keywordflow">while</span> (LastFreed &gt;= WorkingSetMaximum) {
02697 
02698                     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(
02699                                         Wsle[LastFreed].u1.VirtualAddress);
02700 
02701                     <a class="code" href="../../d2/d1/mm_8h.html#a53">PERFINFO_GET_PAGE_INFO</a>(PointerPte);
02702 
02703                     <span class="keywordflow">if</span> ((Wsle[LastFreed].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid != 0) &amp;&amp;
02704                         (!<a class="code" href="../../d4/d0/wslist_8c.html#a26">MiFreeWsle</a> (LastFreed,
02705                                       WsInfo,
02706                                       PointerPte))) {
02707 
02708                         <span class="comment">//</span>
02709                         <span class="comment">// This LastFreed could not be removed.</span>
02710                         <span class="comment">//</span>
02711 
02712                         <span class="keywordflow">break</span>;
02713                     }
02714                     <a class="code" href="../../d2/d1/mm_8h.html#a74">PERFINFO_LOG_WS_REMOVAL</a>(PERFINFO_LOG_TYPE_OUTWS_ADJUSTWS, WsInfo);
02715                     LastFreed -= 1;
02716                 }
02717                 WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o3">LastEntry</a> = LastFreed;
02718             }
02719 
02720             <span class="comment">//</span>
02721             <span class="comment">// Remove pages.</span>
02722             <span class="comment">//</span>
02723 
02724             Entry = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>;
02725 
02726             <span class="keywordflow">while</span> (WsInfo-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> &gt; WorkingSetMaximum) {
02727                 <span class="keywordflow">if</span> (Wsle[Entry].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid != 0) {
02728                     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (
02729                                             Wsle[Entry].u1.VirtualAddress);
02730                     <a class="code" href="../../d2/d1/mm_8h.html#a53">PERFINFO_GET_PAGE_INFO</a>(PointerPte);
02731 
02732                     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/wslist_8c.html#a26">MiFreeWsle</a>(Entry, WsInfo, PointerPte)) {
02733                         <a class="code" href="../../d2/d1/mm_8h.html#a74">PERFINFO_LOG_WS_REMOVAL</a>(PERFINFO_LOG_TYPE_OUTWS_ADJUSTWS,
02734                                               WsInfo);
02735                     }
02736                 }
02737                 Entry += 1;
02738                 <span class="keywordflow">if</span> (Entry &gt; LastFreed) {
02739                     FreeTryCount += 1;
02740                     <span class="keywordflow">if</span> (FreeTryCount &gt; <a class="code" href="../../d4/d0/wslist_8c.html#a1">MM_RETRY_COUNT</a>) {
02741 
02742                         <span class="comment">//</span>
02743                         <span class="comment">// Page table pages are not becoming free, give up</span>
02744                         <span class="comment">// and return an error.</span>
02745                         <span class="comment">//</span>
02746 
02747                         ReturnStatus = STATUS_BAD_WORKING_SET_LIMIT;
02748 
02749                         <span class="keywordflow">break</span>;
02750                     }
02751                     Entry = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>;
02752                 }
02753             }
02754 
02755             <span class="keywordflow">if</span> (FreeTryCount &lt;= <a class="code" href="../../d4/d0/wslist_8c.html#a1">MM_RETRY_COUNT</a>) {
02756                 WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a> = WorkingSetMaximum;
02757             }
02758         }
02759     }
02760 
02761     <span class="comment">//</span>
02762     <span class="comment">// Adjust the number of pages above the working set minimum.</span>
02763     <span class="comment">//</span>
02764 
02765     PagesAbove = (LONG)WsInfo-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> -
02766                                (LONG)WsInfo-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o5">MinimumWorkingSetSize</a>;
02767     NewPagesAbove = (LONG)WsInfo-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> -
02768                                (LONG)WorkingSetMinimum;
02769 
02770     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02771     <span class="keywordflow">if</span> (PagesAbove &gt; 0) {
02772         <a class="code" href="../../d4/d8/mi_8h.html#a590">MmPagesAboveWsMinimum</a> -= (ULONG)PagesAbove;
02773     }
02774     <span class="keywordflow">if</span> (NewPagesAbove &gt; 0) {
02775         <a class="code" href="../../d4/d8/mi_8h.html#a590">MmPagesAboveWsMinimum</a> += (ULONG)NewPagesAbove;
02776     }
02777     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02778 
02779     <span class="keywordflow">if</span> (FreeTryCount &lt;= <a class="code" href="../../d4/d0/wslist_8c.html#a1">MM_RETRY_COUNT</a>) {
02780         WsInfo-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o6">MaximumWorkingSetSize</a> = WorkingSetMaximum;
02781         WsInfo-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o5">MinimumWorkingSetSize</a> = WorkingSetMinimum;
02782 
02783         <span class="keywordflow">if</span> (WorkingSetMinimum &gt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a>) {
02784             WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a> = WorkingSetMinimum;
02785         }
02786     }
02787     <span class="keywordflow">else</span> {
02788         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02789 
02790         <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> += i;
02791         <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(55, i);
02792 
02793         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02794     }
02795 
02796 
02797     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> &lt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a>) ||
02798             (WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> == WSLE_NULL_INDEX));
02799 
02800     <span class="keywordflow">if</span> ((WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o9">HashTable</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
02801         (WsInfo-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o6">MaximumWorkingSetSize</a> &gt; ((1536*1024) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>))) {
02802 
02803         <span class="comment">//</span>
02804         <span class="comment">// The working set list consists of more than a single page.</span>
02805         <span class="comment">//</span>
02806 
02807         <a class="code" href="../../d4/d0/wslist_8c.html#a33">MiGrowWsleHash</a> (WsInfo);
02808     }
02809 
02810 Returns:
02811 
02812     <span class="keywordflow">if</span> (SystemCache) {
02813         <a class="code" href="../../d4/d8/mi_8h.html#a145">UNLOCK_SYSTEM_WS</a> (OldIrql2);
02814     } <span class="keywordflow">else</span> {
02815         <a class="code" href="../../d4/d8/mi_8h.html#a158">UNLOCK_WS</a> (CurrentProcess);
02816     }
02817 
02818     <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(ExPageLockHandle);
02819 
02820     <span class="keywordflow">return</span> ReturnStatus;
02821 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a30" doxytag="wslist.c::MmAssignProcessToJob" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LOGICAL MmAssignProcessToJob           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Process</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d9/wslist_8c-source.html#l02386">2386</a> of file <a class="el" href="../../d5/d9/wslist_8c-source.html">wslist.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00166">KeAttachProcess()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00405">KeDetachProcess()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01093">LOCK_WS_AND_ADDRESS_SPACE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00318">PS_JOB_STATUS_REPORT_COMMIT_CHANGES</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l02823">PsChangeJobMemoryUsage()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l01097">UNLOCK_WS_AND_ADDRESS_SPACE</a>.
<p>
Referenced by <a class="el" href="../../d2/d0/psjob_8c-source.html#l00439">PspAddProcessToJob()</a>.
<p>
<pre class="fragment"><div>02392                    :
02393 
02394     This routine acquires <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set lock so a consistent snapshot of
02395     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> argument process' commit charges and working set size can be used
02396     when adding <span class="keyword">this</span> process to a job.
02397 
02398 Arguments:
02399 
02400     Process - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process to operate upon.
02401 
02402 Return Value:
02403 
02404     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allowed to join <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> job, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
02405 
02406     Note that <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> cannot be returned without changing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> code in ps.
02407 
02408 Environment:
02409 
02410     Kernel mode, IRQL <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> or below.  The caller provides protection
02411     from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target process going away.
02412 
02413 --*/
02414 
02415 {
02416     LOGICAL Attached;
02417     LOGICAL <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02418 
02419     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a> ();
02420 
02421     Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02422 
02423     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() != Process) {
02424         <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a> (&amp;Process-&gt;Pcb);
02425         Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02426     }
02427 
02428     <a class="code" href="../../d4/d8/mi_8h.html#a161">LOCK_WS_AND_ADDRESS_SPACE</a> (Process);
02429 
02430     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d1/psjob_8c.html#a20">PsChangeJobMemoryUsage</a> (Process-&gt;CommitCharge);
02431 
02432     <span class="comment">//</span>
02433     <span class="comment">// Join the job unconditionally.  If the process is over any limits, it</span>
02434     <span class="comment">// will be caught on its next request.</span>
02435     <span class="comment">//</span>
02436 
02437     Process-&gt;JobStatus |= <a class="code" href="../../d1/d9/ps_8h.html#a13">PS_JOB_STATUS_REPORT_COMMIT_CHANGES</a>;
02438 
02439     <a class="code" href="../../d4/d8/mi_8h.html#a162">UNLOCK_WS_AND_ADDRESS_SPACE</a> (Process);
02440 
02441     <span class="keywordflow">if</span> (Attached) {
02442         <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
02443     }
02444 
02445     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02446 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="wslist.c::MmEnforceWorkingSetLimit" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LOGICAL MmEnforceWorkingSetLimit           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>WsInfo</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LOGICAL&nbsp;</td>
          <td class="mdname" nowrap> <em>Enable</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d9/wslist_8c-source.html#l00543">543</a> of file <a class="el" href="../../d5/d9/wslist_8c-source.html">wslist.c</a>.
<p>
References <a class="el" href="../../d5/d7/mi_8h-source.html#l00957">LOCK_EXPANSION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00998">LOCK_SYSTEM_WS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01039">LOCK_WS</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00064">MmSystemCacheWs</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00961">UNLOCK_EXPANSION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01005">UNLOCK_SYSTEM_WS</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l01081">UNLOCK_WS</a>.
<p>
Referenced by <a class="el" href="../../d2/d0/psjob_8c-source.html#l01323">NtSetInformationJobObject()</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l00439">PspAddProcessToJob()</a>, and <a class="el" href="../../d2/d0/psjob_8c-source.html#l02262">PspApplyJobLimitsToProcess()</a>.
<p>
<pre class="fragment"><div>00550                    :
00551 
00552     This function enables hard enforcement of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set maximum <span class="keywordflow">for</span>
00553     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified WsInfo.
00554 
00555 Arguments:
00556 
00557     WsInfo - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set info pointer.
00558 
00559     Enable - Supplies <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> enabling hard enforcement, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> not.
00560 
00561 Return Value:
00562 
00563     The previous state of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set enforcement.
00564 
00565 Environment:
00566 
00567     Kernel mode, APCs disabled.  The working set lock must NOT be held.
00568     The caller guarantees that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target WsInfo cannot go away.
00569 
00570 --*/
00571 
00572 {
00573     KIRQL OldIrql;
00574 
00575     LOGICAL PreviousWorkingSetEnforcement;
00576 
00577     <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
00578 
00579     PreviousWorkingSetEnforcement = WsInfo-&gt;u.Flags.WorkingSetHard;
00580 
00581     WsInfo-&gt;u.Flags.WorkingSetHard = Enable;
00582 
00583     <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
00584 
00585 <span class="preprocessor">#if 0</span>
00586 <span class="preprocessor"></span>
00587     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess;
00588 
00589     <span class="comment">//</span>
00590     <span class="comment">// Get the working set lock and disable APCs.</span>
00591     <span class="comment">// The working set could be trimmed at this point if it is excessive.</span>
00592     <span class="comment">//</span>
00593     <span class="comment">// The working set lock cannot be acquired at this point without updating</span>
00594     <span class="comment">// ps in order to avoid deadlock.</span>
00595     <span class="comment">//</span>
00596 
00597     <span class="keywordflow">if</span> (WsInfo == &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>) {
00598         <a class="code" href="../../d4/d8/mi_8h.html#a144">LOCK_SYSTEM_WS</a> (OldIrql2);
00599         <a class="code" href="../../d4/d8/mi_8h.html#a145">UNLOCK_SYSTEM_WS</a> (OldIrql2);
00600     }
00601     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (WsInfo-&gt;u.Flags.SessionSpace == 0) {
00602         CurrentProcess = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a> ();
00603         <a class="code" href="../../d4/d8/mi_8h.html#a154">LOCK_WS</a> (CurrentProcess);
00604 
00605         <a class="code" href="../../d4/d8/mi_8h.html#a158">UNLOCK_WS</a> (CurrentProcess);
00606     }
00607 <span class="preprocessor">#endif</span>
00608 <span class="preprocessor"></span>
00609     <span class="keywordflow">return</span> PreviousWorkingSetEnforcement;
00610 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a11" doxytag="wslist.c::MiTrimRemovalPagesOnly" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LOGICAL <a class="el" href="../../d4/d0/wslist_8c.html#a11">MiTrimRemovalPagesOnly</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d9/wslist_8c-source.html#l00050">50</a> of file <a class="el" href="../../d5/d9/wslist_8c-source.html">wslist.c</a>.
<p>
Referenced by <a class="el" href="../../d5/d9/wslist_8c-source.html#l04726">MiEmptyWorkingSet()</a>, and <a class="el" href="../../d0/d3/dynmem_8c-source.html#l00437">MmRemovePhysicalMemory()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="wslist.c::MmFaultsTakenToGoAboveMaxWs" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d4/d0/wslist_8c.html#a3">MmFaultsTakenToGoAboveMaxWs</a> = 100          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d9/wslist_8c-source.html#l00033">33</a> of file <a class="el" href="../../d5/d9/wslist_8c-source.html">wslist.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="wslist.c::MmFaultsTakenToGoAboveMinWs" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d4/d0/wslist_8c.html#a4">MmFaultsTakenToGoAboveMinWs</a> = 16          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d9/wslist_8c-source.html#l00034">34</a> of file <a class="el" href="../../d5/d9/wslist_8c-source.html">wslist.c</a>.
<p>
Referenced by <a class="el" href="../../d5/d9/wslist_8c-source.html#l00254">MiDoReplacement()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="wslist.c::MmMaximumWorkingSetSize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d4/d0/wslist_8c.html#a2">MmMaximumWorkingSetSize</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d9/wslist_8c-source.html#l00031">31</a> of file <a class="el" href="../../d5/d9/wslist_8c-source.html">wslist.c</a>.
<p>
Referenced by <a class="el" href="../../d5/d9/wslist_8c-source.html#l02450">MmAdjustWorkingSetSize()</a>, and <a class="el" href="../../d6/d0/mminit_8c-source.html#l00184">MmInitSystem()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="wslist.c::MmPagedPoolPage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d7/d0/wstree_8c.html#a2">MmPagedPoolPage</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d9/wslist_8c-source.html#l00038">38</a> of file <a class="el" href="../../d5/d9/wslist_8c-source.html">wslist.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="wslist.c::MmSystemCachePage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d7/d0/wstree_8c.html#a1">MmSystemCachePage</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d9/wslist_8c-source.html#l00037">37</a> of file <a class="el" href="../../d5/d9/wslist_8c-source.html">wslist.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="wslist.c::MmSystemCodePage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d7/d0/wstree_8c.html#a0">MmSystemCodePage</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d9/wslist_8c-source.html#l00036">36</a> of file <a class="el" href="../../d5/d9/wslist_8c-source.html">wslist.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="wslist.c::MmSystemDriverPage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d7/d0/wstree_8c.html#a3">MmSystemDriverPage</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d9/wslist_8c-source.html#l00039">39</a> of file <a class="el" href="../../d5/d9/wslist_8c-source.html">wslist.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="wslist.c::MmTransitionSharedPages" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d4/d0/wslist_8c.html#a9">MmTransitionSharedPages</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d9/wslist_8c-source.html#l00047">47</a> of file <a class="el" href="../../d5/d9/wslist_8c-source.html">wslist.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="wslist.c::MmTransitionSharedPagesPeak" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d4/d0/wslist_8c.html#a10">MmTransitionSharedPagesPeak</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d9/wslist_8c-source.html#l00048">48</a> of file <a class="el" href="../../d5/d9/wslist_8c-source.html">wslist.c</a>.
<p>
Referenced by <a class="el" href="../../d5/d9/wslist_8c-source.html#l00117">MiLocateAndReserveWsle()</a>, and <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00941">NtQuerySystemInformation()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:46:10 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
