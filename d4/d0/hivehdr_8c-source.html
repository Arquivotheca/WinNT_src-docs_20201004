<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: hivehdr.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>hivehdr.c</h1><a href="../../d3/d1/hivehdr_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1991  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    hivehdr.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    Dump the header of a hive primary, alternate, or log file.</span>
00012 <span class="comment"></span>
00013 <span class="comment">    hivehdr filename filename filename ...</span>
00014 <span class="comment"></span>
00015 <span class="comment">Author:</span>
00016 <span class="comment"></span>
00017 <span class="comment">    Bryan Willman (bryanwi)  6-april-92</span>
00018 <span class="comment"></span>
00019 <span class="comment">Revision History:</span>
00020 <span class="comment"></span>
00021 <span class="comment">--*/</span>
00022 
00023 
<a name="l00024"></a><a class="code" href="../../d3/d1/hivehdr_8c.html#a0">00024</a> <span class="preprocessor">#define _ARCCODES_</span>
00025 <span class="preprocessor"></span>
00026 <span class="preprocessor">#include "<a class="code" href="../../d5/d7/regutil_8h.html">regutil.h</a>"</span>
00027 <span class="preprocessor">#include "<a class="code" href="../../d0/d5/edithive_8h.html">edithive.h</a>"</span>
00028 
00029 <span class="keywordtype">void</span>
00030 <a class="code" href="../../d3/d1/hivehdr_8c.html#a1">DoDump</a>(
00031     PUCHAR  Filename
00032     );
00033 
00034 <span class="keywordtype">void</span>
<a name="l00035"></a><a class="code" href="../../d3/d1/hivehdr_8c.html#a2">00035</a> __cdecl <a class="code" href="../../d2/d5/editreg_8c.html#a87">main</a>(
00036     <span class="keywordtype">int</span> argc,
00037     <span class="keywordtype">char</span> *argv[]
00038     )
00039 {
00040     <span class="keywordtype">int</span> i;
00041 
00042     <span class="keywordflow">if</span> (argc == 1) {
00043         fprintf(stderr, <span class="stringliteral">"Usage: hivehdr filename filename...\n"</span>, argv[0]);
00044         <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>(1);
00045     }
00046 
00047     <span class="keywordflow">for</span> (i = 1; i &lt; argc; i++) {
00048         <a class="code" href="../../d3/d1/hivehdr_8c.html#a1">DoDump</a>(argv[i]);
00049     }
00050 
00051     <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>(0);
00052 }
00053 
00054 <span class="keywordtype">void</span>
<a name="l00055"></a><a class="code" href="../../d3/d1/hivehdr_8c.html#a1">00055</a> <a class="code" href="../../d3/d1/hivehdr_8c.html#a1">DoDump</a>(
00056     PUCHAR  Filename
00057     )
00058 {
00059     HANDLE  infile;
00060     <span class="keyword">static</span> <span class="keywordtype">char</span> buffer[<a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>];
00061     <a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a> bbp;
00062     <span class="keywordtype">char</span>   *validstring[] = { <span class="stringliteral">"BAD"</span>, <span class="stringliteral">"OK"</span> };
00063     <span class="keywordtype">int</span>     valid;
00064     <span class="keywordtype">char</span>   *<span class="keyword">typename</span>[] = { <span class="stringliteral">"primary"</span>, <span class="stringliteral">"alternate"</span>, <span class="stringliteral">"log"</span>, <span class="stringliteral">"external"</span>, <span class="stringliteral">"unknown"</span> };
00065     <span class="keywordtype">int</span>     typeselect;
00066     <span class="keywordtype">int</span>     readcount;
00067     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> checksum;
00068     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> i;
00069 
00070     infile = (HANDLE)CreateFile(
00071             Filename,                           <span class="comment">// file name</span>
00072             GENERIC_READ,                       <span class="comment">// desired access</span>
00073             FILE_SHARE_READ | FILE_SHARE_WRITE, <span class="comment">// share mode</span>
00074             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                               <span class="comment">// security attributes</span>
00075             <a class="code" href="../../d4/d8/ntfsexp_8h.html#a141a69">OPEN_EXISTING</a>,                      <span class="comment">// creation disposition</span>
00076             FILE_FLAG_SEQUENTIAL_SCAN,          <span class="comment">// flags and attributes</span>
00077             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>                                <span class="comment">// template file</span>
00078     );
00079     <span class="keywordflow">if</span> (infile == <a class="code" href="../../d5/d4/rxact_8c.html#a0">INVALID_HANDLE_VALUE</a>) {
00080         fprintf(stderr, <span class="stringliteral">"hivehdr: Could not open '%s'\n"</span>, Filename);
00081         <span class="keywordflow">return</span>;
00082     }
00083 
00084     <span class="keywordflow">if</span> (!ReadFile(infile, buffer, <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>, &amp;readcount, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00085         fprintf(
00086             stderr, <span class="stringliteral">"hivehdr: '%s' - cannot read full base block\n"</span>, Filename);
00087         <span class="keywordflow">return</span>;
00088     }
00089     <span class="keywordflow">if</span> (readcount != <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>) {
00090         fprintf(
00091             stderr, <span class="stringliteral">"hivehdr: '%s' - cannot read full base block\n"</span>, Filename);
00092         <span class="keywordflow">return</span>;
00093     }
00094 
00095     bbp = (<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>)&amp;(buffer[0]);
00096 
00097     <span class="keywordflow">if</span> ((bbp-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o4">Major</a> != 1) || (bbp-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o5">Minor</a> != 1)) {
00098         printf(<span class="stringliteral">"WARNING: Hive file is newer than hivehdr, or is invalid\n"</span>);
00099     }
00100 
00101     printf(<span class="stringliteral">"         File: '%s'\n"</span>, Filename);
00102     printf(<span class="stringliteral">"    BaseBlock:\n"</span>);
00103 
00104     valid = (bbp-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o0">Signature</a> == <a class="code" href="../../d0/d1/hivedata_8h.html#a26">HBASE_BLOCK_SIGNATURE</a>);
00105     printf(<span class="stringliteral">"    Signature: %08lx  '%4.4s'\t\t%s\n"</span>,
00106             bbp-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o0">Signature</a>, (PUCHAR)&amp;(bbp-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o0">Signature</a>), validstring[valid]);
00107 
00108     valid = (bbp-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o1">Sequence1</a> == bbp-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o2">Sequence2</a>);
00109     printf(<span class="stringliteral">" Sequence1//2: %08lx//%08lx\t%s\n"</span>,
00110             bbp-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o1">Sequence1</a>, bbp-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o2">Sequence2</a>, validstring[valid]);
00111 
00112     printf(<span class="stringliteral">"    TimeStamp: %08lx:%08lx\n"</span>,
00113             bbp-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o3">TimeStamp</a>.HighPart, bbp-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o3">TimeStamp</a>.LowPart,
00114             (PUCHAR)&amp;(bbp-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o0">Signature</a>), validstring[valid]);
00115 
00116     valid = (bbp-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o4">Major</a> == <a class="code" href="../../d0/d1/hivedata_8h.html#a27">HSYS_MAJOR</a>);
00117     printf(<span class="stringliteral">"Major Version: %08lx\t\t\t%s\n"</span>,
00118             bbp-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o4">Major</a>, validstring[valid]);
00119 
00120     valid = (bbp-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o5">Minor</a> == <a class="code" href="../../d0/d1/hivedata_8h.html#a28">HSYS_MINOR</a>);
00121     printf(<span class="stringliteral">"Minor Version: %08lx\t\t\t%s\n"</span>,
00122             bbp-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o5">Minor</a>, validstring[valid]);
00123 
00124     valid = ( (bbp-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o6">Type</a> == <a class="code" href="../../d0/d1/hivedata_8h.html#a38">HFILE_TYPE_PRIMARY</a>) ||
00125               (bbp-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o6">Type</a> == <a class="code" href="../../d0/d1/hivedata_8h.html#a39">HFILE_TYPE_ALTERNATE</a>) ||
00126               (bbp-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o6">Type</a> == <a class="code" href="../../d0/d1/hivedata_8h.html#a40">HFILE_TYPE_LOG</a>) );
00127     <span class="keywordflow">if</span> (valid) {
00128         typeselect = bbp-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o6">Type</a>;
00129     } <span class="keywordflow">else</span> {
00130         typeselect = <a class="code" href="../../d0/d1/hivedata_8h.html#a42">HFILE_TYPE_MAX</a>;
00131     }
00132 
00133     printf(<span class="stringliteral">"         Type: %08lx %s\t\t%s\n"</span>,
00134             bbp-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o6">Type</a>, <span class="keyword">typename</span>[typeselect], validstring[valid]);
00135 
00136     valid = (bbp-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o7">Format</a> == <a class="code" href="../../d0/d1/hivedata_8h.html#a29">HBASE_FORMAT_MEMORY</a>);
00137     printf(<span class="stringliteral">"       Format: %08lx\t\t\t%s\n"</span>,
00138             bbp-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o7">Format</a>, validstring[valid]);
00139 
00140     printf(<span class="stringliteral">"     RootCell: %08lx\n"</span>, bbp-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o8">RootCell</a>);
00141 
00142     printf(<span class="stringliteral">"       Length: %08lx\n"</span>, bbp-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o9">Length</a>);
00143 
00144     printf(<span class="stringliteral">"      Cluster: %08lx\n"</span>, bbp-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o10">Cluster</a>);
00145 
00146     checksum = <a class="code" href="../../d9/d1/hivesum_8c.html#a0">HvpHeaderCheckSum</a>(bbp);
00147     valid = (checksum == bbp-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o13">CheckSum</a>);
00148     <span class="keywordflow">if</span> (checksum == bbp-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o13">CheckSum</a>) {
00149         printf(<span class="stringliteral">"     CheckSum: %08lx\t\t\t%s\n"</span>,
00150                 bbp-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o13">CheckSum</a>, validstring[<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>]);
00151     } <span class="keywordflow">else</span> {
00152         printf(<span class="stringliteral">"     CheckSum: %08lx\t\t\t%s\tCorrect: %08lx\n"</span>,
00153                 bbp-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o13">CheckSum</a>, validstring[<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>], checksum);
00154     }
00155 
00156     <span class="comment">//</span>
00157     <span class="comment">// print last part of file name, aid to identification</span>
00158     <span class="comment">//</span>
00159     printf(<span class="stringliteral">"Hive/FileName: "</span>);
00160 
00161     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d0/d1/hivedata_8h.html#a30">HBASE_NAME_ALLOC</a>;i+=<span class="keyword">sizeof</span>(WCHAR)) {
00162         printf(<span class="stringliteral">"%wc"</span>, bbp-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o11">FileName</a>[i]);
00163     }
00164 
00165 
00166     <span class="keywordflow">return</span>;
00167 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:17 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
