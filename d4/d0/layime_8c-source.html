<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: layime.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>layime.c</h1><a href="../../d3/d1/layime_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/**************************************************************************\</span>
00002 <span class="comment">* Module Name: layout.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* IMM User Mode Routines</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 03-Jan-1996 wkwok       Created</span>
00010 <span class="comment">\**************************************************************************/</span>
00011 
00012 <span class="preprocessor">#include "<a class="code" href="../../d8/d3/w32_2ntuser_2imm_2precomp_8h.html">precomp.h</a>"</span>
00013 <span class="preprocessor">#pragma hdrstop</span>
00014 <span class="preprocessor"></span>
00015 
<a name="l00016"></a><a class="code" href="../../d3/d1/layime_8c.html#a0">00016</a> <span class="preprocessor">#define VERSION_DLL       TEXT("version.dll")</span>
<a name="l00017"></a><a class="code" href="../../d3/d1/layime_8c.html#a1">00017</a> <span class="preprocessor"></span><span class="preprocessor">#define VER_FILE_VERSION  TEXT("FileVersion")</span>
00018 <span class="preprocessor"></span>
<a name="l00019"></a><a class="code" href="../../d3/d1/layime_8c.html#a2">00019</a> <span class="preprocessor">#define SZ_BACKSLASH      TEXT("\\")</span>
00020 <span class="preprocessor"></span>
<a name="l00021"></a><a class="code" href="../../d3/d1/layime_8c.html#a3">00021</a> <span class="preprocessor">#define WCHAR_BACKSLASH   L'\\'</span>
<a name="l00022"></a><a class="code" href="../../d3/d1/layime_8c.html#a4">00022</a> <span class="preprocessor"></span><span class="preprocessor">#define WCHAR_NULL        L'\0'</span>
00023 <span class="preprocessor"></span>
<a name="l00024"></a><a class="code" href="../../d3/d1/layime_8c.html#a5">00024</a> <span class="preprocessor">#define VERSION_GetFileVersionInfoW     "GetFileVersionInfoW"</span>
<a name="l00025"></a><a class="code" href="../../d3/d1/layime_8c.html#a6">00025</a> <span class="preprocessor"></span><span class="preprocessor">#define VERSION_GetFileVersionInfoSizeW "GetFileVersionInfoSizeW"</span>
<a name="l00026"></a><a class="code" href="../../d3/d1/layime_8c.html#a7">00026</a> <span class="preprocessor"></span><span class="preprocessor">#define VERSION_VerQueryValueW          "VerQueryValueW"</span>
00027 <span class="preprocessor"></span>
<a name="l00028"></a><a class="code" href="../../d3/d1/layime_8c.html#a9">00028</a> <span class="keyword">typedef</span> <a class="code" href="../../d0/d5/perfuser_8c.html#a20">BOOL</a>  (WINAPI *<a class="code" href="../../d3/d1/layime_8c.html#a9">LPFNGETFILEVERSIONINFOW</a>)(PWSTR, <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>, <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>, <a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>);
<a name="l00029"></a><a class="code" href="../../d3/d1/layime_8c.html#a10">00029</a> <span class="keyword">typedef</span> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> (WINAPI *<a class="code" href="../../d3/d1/layime_8c.html#a10">LPFNGETFILEVERSIONINFOSIZEW</a>)(PWSTR, LPDWORD);
<a name="l00030"></a><a class="code" href="../../d3/d1/layime_8c.html#a11">00030</a> <span class="keyword">typedef</span> <a class="code" href="../../d0/d5/perfuser_8c.html#a20">BOOL</a>  (WINAPI *<a class="code" href="../../d3/d1/layime_8c.html#a11">LPFNVERQUERYVALUEW</a>)(<span class="keyword">const</span> <a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>, PWSTR, <a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>*, LPDWORD);
<a name="l00031"></a><a class="code" href="../../d3/d1/layime_8c.html#a12">00031</a> <span class="keyword">typedef</span> VS_FIXEDFILEINFO *<a class="code" href="../../d3/d1/layime_8c.html#a12">PFIXEDFILEINFO</a>;
00032 
<a name="l00033"></a><a class="code" href="../../d3/d1/layime_8c.html#a13">00033</a> <span class="keyword">static</span> <a class="code" href="../../d3/d1/layime_8c.html#a9">LPFNGETFILEVERSIONINFOW</a>     <a class="code" href="../../d3/d1/layime_8c.html#a13">pfnGetFileVersionInfoW</a>;
<a name="l00034"></a><a class="code" href="../../d3/d1/layime_8c.html#a14">00034</a> <span class="keyword">static</span> <a class="code" href="../../d3/d1/layime_8c.html#a10">LPFNGETFILEVERSIONINFOSIZEW</a> <a class="code" href="../../d3/d1/layime_8c.html#a14">pfnGetFileVersionInfoSizeW</a>;
<a name="l00035"></a><a class="code" href="../../d3/d1/layime_8c.html#a15">00035</a> <span class="keyword">static</span> <a class="code" href="../../d3/d1/layime_8c.html#a11">LPFNVERQUERYVALUEW</a>          <a class="code" href="../../d3/d1/layime_8c.html#a15">pfnVerQueryValueW</a>;
00036 
00037 
<a name="l00038"></a><a class="code" href="../../d9/d0/immuser_8h.html#a41">00038</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d0/immuser_8h.html#a41">ImmLoadLayout</a>(
00039     HKL        hKL,
00040     <a class="code" href="../../d0/d8/structtagIMEINFOEX.html">PIMEINFOEX</a> piiex)
00041 {
00042     UNICODE_STRING strIme;
00043     WCHAR    wszIme[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
00044     HKEY     hKeyKbdLayout, hKeyIme;
00045     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00046     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>    dwTmp;
00047     LONG     lRet;
00048 
00049     strIme.Buffer = wszIme;
00050     strIme.MaximumLength = <span class="keyword">sizeof</span>(wszIme);
00051 
00052     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/cnvint_8c.html#a6">RtlIntegerToUnicodeString</a>(HandleToUlong(hKL), 16, &amp;strIme);
00053     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00054         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00055     }
00056 
00057     lRet = RegOpenKey(HKEY_LOCAL_MACHINE, <a class="code" href="../../d2/d6/ntuser_2imm_2globals_8c.html#a11">gszRegKbdLayout</a>, &amp;hKeyKbdLayout);
00058     <span class="keywordflow">if</span> ( lRet != ERROR_SUCCESS ) {
00059         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00060     }
00061 
00062     lRet = RegOpenKey(hKeyKbdLayout, strIme.Buffer, &amp;hKeyIme);
00063     <span class="keywordflow">if</span> ( lRet != ERROR_SUCCESS ) {
00064         RegCloseKey(hKeyKbdLayout);
00065         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00066     }
00067 
00068     dwTmp = <a class="code" href="../../d8/d0/immstruc_8h.html#a22">IM_FILE_SIZE</a>;
00069     lRet = RegQueryValueEx(hKeyIme,
00070                            <a class="code" href="../../d2/d6/ntuser_2imm_2globals_8c.html#a15">gszValImeFile</a>,
00071                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00072                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00073                            (LPBYTE)piiex-&gt;<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o9">wszImeFile</a>,
00074                            &amp;dwTmp);
00075 
00076     <span class="keywordflow">if</span> ( lRet != ERROR_SUCCESS ) {
00077         RegCloseKey(hKeyIme);
00078         RegCloseKey(hKeyKbdLayout);
00079         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00080     }
00081 
00082     piiex-&gt;<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o9">wszImeFile</a>[<a class="code" href="../../d8/d0/immstruc_8h.html#a22">IM_FILE_SIZE</a> - 1] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00083 
00084     RegCloseKey(hKeyIme);
00085     RegCloseKey(hKeyKbdLayout);
00086 
00087     piiex-&gt;<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o0">hkl</a> = hKL;
00088     piiex-&gt;<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o5">fLoadFlag</a> = <a class="code" href="../../d8/d0/immstruc_8h.html#a18">IMEF_NONLOAD</a>;
00089 
00090     <span class="keywordflow">return</span> <a class="code" href="../../d3/d1/layime_8c.html#a22">LoadVersionInfo</a>(piiex);
00091 }
00092 
00093 <span class="comment">// GetSystemPathName()</span>
00094 <span class="comment">// create "%windir%\system32\%filename"</span>
<a name="l00095"></a><a class="code" href="../../d3/d1/layime_8c.html#a17">00095</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d3/d1/layime_8c.html#a17">GetSystemPathName</a>(PWSTR <span class="comment">/*OUT*/</span> pwszPath, PWSTR pwszFileName, UINT maxChar)
00096 {
00097     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> fnLen = wcslen(pwszFileName);
00098     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> i = GetSystemDirectoryW(pwszPath, maxChar);
00099 
00100     UserAssert(fnLen + 1 &lt; maxChar);
00101     <span class="comment">// avoid error condition</span>
00102     <span class="keywordflow">if</span> (fnLen + 1 &gt;= maxChar) {
00103         *pwszPath = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00104         <span class="keywordflow">return</span>;
00105     }
00106     <span class="keywordflow">if</span> (i &gt; 0 || i &lt; maxChar - fnLen - 1) {
00107         pwszPath += i;
00108         <span class="keywordflow">if</span> (pwszPath[-1] != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>)
00109             *pwszPath++ = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>;
00110     }
00111     wcscpy(pwszPath, pwszFileName);
00112 }
00113 
00114 <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>
<a name="l00115"></a><a class="code" href="../../d3/d1/layime_8c.html#a18">00115</a> <a class="code" href="../../d3/d1/layime_8c.html#a18">ExtractColumn</a>(
00116     LPWSTR lpSrc,
00117     WCHAR  cSeparator,
00118     UINT   uiColumn
00119     )
00120 
00121 <span class="comment">/*++</span>
00122 <span class="comment"></span>
00123 <span class="comment">Routine Description:</span>
00124 <span class="comment"></span>
00125 <span class="comment"></span>
00126 <span class="comment">Arguments:</span>
00127 <span class="comment"></span>
00128 <span class="comment">    lpSrc - "YYYY.MM.DD" or "HH:MM:SS" or "MM.NN" pointer</span>
00129 <span class="comment"></span>
00130 <span class="comment">Return Value:</span>
00131 <span class="comment"></span>
00132 <span class="comment">    packed int</span>
00133 <span class="comment"></span>
00134 <span class="comment">--*/</span>
00135 
00136 {
00137     UNICODE_STRING uStr;
00138     WCHAR *pSep, *pStr;
00139     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> i;
00140 
00141     <span class="keywordflow">if</span> (!lpSrc) {
00142         <span class="keywordflow">return</span> 0;
00143     }
00144 
00145     pStr = pSep = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00146 
00147     <span class="keywordflow">while</span> (uiColumn--) {
00148         pStr = lpSrc;
00149 
00150         <span class="keywordflow">while</span> (*lpSrc &amp;&amp; *lpSrc != cSeparator) {
00151             lpSrc++;
00152         }
00153 
00154         <span class="keywordflow">if</span> (*lpSrc == cSeparator) {
00155             pSep = lpSrc;
00156             lpSrc++;
00157         }
00158     }
00159 
00160     <span class="keywordflow">if</span> (pStr) {
00161         <span class="keywordflow">if</span> (pSep) {
00162             *pSep = TEXT(<span class="charliteral">'\0'</span>);
00163             uStr.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)((pSep - pStr) * <span class="keyword">sizeof</span>(WCHAR));
00164         }
00165         <span class="keywordflow">else</span> {
00166             uStr.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(((lpSrc - pStr) + 1) * <span class="keyword">sizeof</span>(WCHAR));
00167         }
00168         uStr.Buffer = pStr;
00169         uStr.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(uStr.Length + <span class="keyword">sizeof</span>(WCHAR));
00170         <a class="code" href="../../d9/d3/cnvint_8c.html#a4">RtlUnicodeStringToInteger</a>(&amp;uStr, 0, &amp;i);
00171         <span class="keywordflow">if</span> (pSep) {
00172             *pSep = cSeparator;
00173         }
00174     } <span class="keywordflow">else</span> {
00175         i = 0;
00176     }
00177 
00178     <span class="keywordflow">return</span> i;
00179 }
00180 
00181 
<a name="l00182"></a><a class="code" href="../../d3/d1/layime_8c.html#a19">00182</a> PWSTR <a class="code" href="../../d3/d1/layime_8c.html#a19">GetVersionDatum</a>(
00183     PWSTR pszVersionBuffer,
00184     PWSTR pszVersionKey,
00185     PWSTR pszName)
00186 {
00187     ULONG ulSize;
00188     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> cbValue = 0;
00189     PWSTR pValue;
00190 
00191     ulSize = wcslen(pszVersionKey);
00192     wcscat(pszVersionKey, pszName);
00193 
00194     (*pfnVerQueryValueW)(pszVersionBuffer,
00195                           pszVersionKey,
00196                           (<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>*)&amp;pValue,
00197                           &amp;cbValue);
00198 
00199     pszVersionKey[ulSize] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00200     <span class="keywordflow">return</span> (cbValue != 0) ? pValue : (PWSTR)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00201 }
00202 
00203 
<a name="l00204"></a><a class="code" href="../../d3/d1/layime_8c.html#a20">00204</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d1/layime_8c.html#a20">LoadFixVersionInfo</a>(
00205     <a class="code" href="../../d0/d8/structtagIMEINFOEX.html">PIMEINFOEX</a> piiex,
00206     PWSTR      pszVersionBuffer)
00207 {
00208     <a class="code" href="../../d3/d1/layime_8c.html#a12">PFIXEDFILEINFO</a> pFixedVersionInfo;
00209     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>           fResult;
00210     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>          cbValue;
00211 
00212     fResult = (*pfnVerQueryValueW)(pszVersionBuffer,
00213                                    <a class="code" href="../../d3/d1/layime_8c.html#a2">SZ_BACKSLASH</a>,
00214                                    &amp;pFixedVersionInfo,
00215                                    &amp;cbValue);
00216 
00217     <span class="keywordflow">if</span> (!fResult || cbValue == 0)
00218         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00219 
00220     <span class="comment">/*</span>
00221 <span class="comment">     * Check for IME file type.</span>
00222 <span class="comment">     */</span>
00223     <span class="keywordflow">if</span> (pFixedVersionInfo-&gt;dwFileType != VFT_DRV ||
00224         pFixedVersionInfo-&gt;dwFileSubtype != VFT2_DRV_INPUTMETHOD) {
00225         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00226     }
00227 
00228     piiex-&gt;<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o6">dwProdVersion</a> = pFixedVersionInfo-&gt;dwProductVersionMS;
00229 
00230     <span class="comment">/*</span>
00231 <span class="comment">     * Currently, we only support 4.0 DLL based IME.</span>
00232 <span class="comment">     */</span>
00233     piiex-&gt;<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o7">dwImeWinVersion</a> = IMEVER_0400;
00234 
00235     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00236 }
00237 
<a name="l00238"></a><a class="code" href="../../d3/d1/layime_8c.html#a21">00238</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d1/layime_8c.html#a21">LoadVarVersionInfo</a>(
00239     <a class="code" href="../../d0/d8/structtagIMEINFOEX.html">PIMEINFOEX</a> piiex,
00240     PWSTR      pszVersionBuffer)
00241 {
00242     PWSTR   pDescription;
00243     WORD    wLangId;
00244     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    fResult;
00245     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a> puXlate;
00246     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>   cbValue;
00247     WCHAR   szVersionKey[80];
00248 
00249     fResult = (*pfnVerQueryValueW)(pszVersionBuffer,
00250                                    <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\VarFileInfo\\Translation"</span>,
00251                                    (<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a> *)&amp;puXlate,
00252                                    &amp;cbValue);
00253 
00254     <span class="keywordflow">if</span> (!fResult || cbValue == 0)
00255         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00256 
00257     wLangId = *puXlate;
00258 
00259     <span class="keywordflow">if</span> (piiex-&gt;<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o0">hkl</a> == 0) {
00260         <span class="comment">/*</span>
00261 <span class="comment">         * A newly installed IME, its HKL is not assigned yet.</span>
00262 <span class="comment">         */</span>
00263         piiex-&gt;<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o0">hkl</a> = (HKL)LongToHandle( MAKELONG(wLangId, 0) );
00264     }
00265 <span class="preprocessor">#if 0   // let unlocalized IME to work.</span>
00266 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (LOWORD(HandleToUlong(piiex-&gt;<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o0">hkl</a>)) != wLangId){
00267         <span class="comment">/*</span>
00268 <span class="comment">         * Mismatch in Lang ID, blow out</span>
00269 <span class="comment">         */</span>
00270         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00271     }
00272 <span class="preprocessor">#endif</span>
00273 <span class="preprocessor"></span>
00274     <span class="comment">/*</span>
00275 <span class="comment">     * First try the language we are currently in.</span>
00276 <span class="comment">     */</span>
00277     wsprintf(szVersionKey, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\StringFileInfo\\%04X04B0\\"</span>,
00278              LANGIDFROMLCID(GetThreadLocale()));
00279 
00280     pDescription = <a class="code" href="../../d3/d1/layime_8c.html#a19">GetVersionDatum</a>(pszVersionBuffer, szVersionKey,
00281             <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"FileDescription"</span>);
00282 
00283     <span class="keywordflow">if</span> (pDescription == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00284         <span class="comment">/*</span>
00285 <span class="comment">         * Now try the first translation specified in IME</span>
00286 <span class="comment">         */</span>
00287         wsprintf(szVersionKey, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\StringFileInfo\\%04X%04X\\"</span>,
00288                  *puXlate, *(puXlate+1));
00289 
00290         pDescription = <a class="code" href="../../d3/d1/layime_8c.html#a19">GetVersionDatum</a>(pszVersionBuffer, szVersionKey,
00291                 <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"FileDescription"</span>);
00292     }
00293 
00294     <span class="keywordflow">if</span> (pDescription != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00295         wcscpy(piiex-&gt;<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o8">wszImeDescription</a>, pDescription);
00296     }
00297     <span class="keywordflow">else</span> {
00298         piiex-&gt;<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o8">wszImeDescription</a>[0] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00299     }
00300 
00301     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00302 }
00303 
00304 
<a name="l00305"></a><a class="code" href="../../d3/d1/layime_8c.html#a22">00305</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d1/layime_8c.html#a22">LoadVersionInfo</a>(
00306     <a class="code" href="../../d0/d8/structtagIMEINFOEX.html">PIMEINFOEX</a> piiex)
00307 {
00308     WCHAR   szPath[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
00309     PWSTR   pszVersionBuffer;
00310     HANDLE  hVersion;
00311     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>   dwVersionSize;
00312     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>   dwHandle = 0;
00313     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    fUnload, fReturn = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00314 
00315     hVersion = GetModuleHandle(<a class="code" href="../../d3/d1/layime_8c.html#a0">VERSION_DLL</a>);
00316     <span class="keywordflow">if</span> (hVersion != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00317         fUnload = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00318     }
00319     <span class="keywordflow">else</span> {
00320         hVersion = LoadLibrary(<a class="code" href="../../d3/d1/layime_8c.html#a0">VERSION_DLL</a>);
00321         <span class="keywordflow">if</span> (hVersion == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00322             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00323         }
00324         fUnload = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00325     }
00326 
00327 <span class="preprocessor">#define GET_PROC(x) \</span>
00328 <span class="preprocessor">    if (!(pfn##x = (PVOID) GetProcAddress(hVersion, VERSION_##x))) { \</span>
00329 <span class="preprocessor">        goto LoadVerInfoUnload; }</span>
00330 <span class="preprocessor"></span>
00331     <a class="code" href="../../d3/d1/layime_8c.html#a8">GET_PROC</a>(GetFileVersionInfoW);
00332     <a class="code" href="../../d3/d1/layime_8c.html#a8">GET_PROC</a>(GetFileVersionInfoSizeW);
00333     <a class="code" href="../../d3/d1/layime_8c.html#a8">GET_PROC</a>(VerQueryValueW);
00334 
00335 <span class="preprocessor">#undef GET_PROC</span>
00336 <span class="preprocessor"></span>
00337     <span class="comment">// szPath = fully qualified IME file name</span>
00338     <a class="code" href="../../d3/d1/layime_8c.html#a17">GetSystemPathName</a>(szPath, piiex-&gt;<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o9">wszImeFile</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a2">ARRAY_SIZE</a>(szPath));
00339 
00340     dwVersionSize = (*pfnGetFileVersionInfoSizeW)(szPath, &amp;dwHandle);
00341 
00342     <span class="keywordflow">if</span> (dwVersionSize == 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>)
00343         <span class="keywordflow">goto</span> LoadVerInfoUnload;
00344 
00345     pszVersionBuffer = (PWSTR)<a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a22">ImmLocalAlloc</a>(0, dwVersionSize);
00346 
00347     <span class="keywordflow">if</span> (pszVersionBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)    <span class="comment">// can't get memory for version info, blow out</span>
00348         <span class="keywordflow">goto</span> LoadVerInfoUnload;
00349 
00350     <span class="keywordflow">if</span> (!(*pfnGetFileVersionInfoW)(szPath, dwHandle, dwVersionSize, pszVersionBuffer))
00351         <span class="keywordflow">goto</span> LoadVerInfoFree;
00352 
00353     <span class="comment">/*</span>
00354 <span class="comment">     * Get the fixed block version information.</span>
00355 <span class="comment">     */</span>
00356     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/layime_8c.html#a20">LoadFixVersionInfo</a>(piiex, pszVersionBuffer)) {
00357         <span class="comment">/*</span>
00358 <span class="comment">         * Get the variable block version information.</span>
00359 <span class="comment">         */</span>
00360         fReturn = <a class="code" href="../../d3/d1/layime_8c.html#a21">LoadVarVersionInfo</a>(piiex, pszVersionBuffer);
00361     }
00362 
00363 LoadVerInfoFree:
00364     <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>((HLOCAL)pszVersionBuffer);
00365 
00366 LoadVerInfoUnload:
00367     <span class="keywordflow">if</span> (fUnload)
00368         FreeLibrary(hVersion);
00369 
00370     <span class="keywordflow">return</span> fReturn;
00371 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:36 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
