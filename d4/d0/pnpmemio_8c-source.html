<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: pnpmemio.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>pnpmemio.c</h1><a href="../../d3/d1/pnpmemio_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1997  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    pnpmemio.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    Root IO Port and Memory arbiter</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Andy Thornton (andrewth) 04/17/97</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:</span>
00018 <span class="comment"></span>
00019 <span class="comment">--*/</span>
00020 
00021 <span class="preprocessor">#include "<a class="code" href="../../d0/d6/iop_8h.html">iop.h</a>"</span>
00022 <span class="preprocessor">#pragma hdrstop</span>
00023 <span class="preprocessor"></span>
<a name="l00024"></a><a class="code" href="../../d3/d1/pnpmemio_8c.html#a0">00024</a> <span class="preprocessor">#define BUGFEST_HACKS</span>
00025 <span class="preprocessor"></span>
00026 <span class="comment">//</span>
00027 <span class="comment">// Constants</span>
00028 <span class="comment">//</span>
00029 
<a name="l00030"></a><a class="code" href="../../d3/d1/pnpmemio_8c.html#a1">00030</a> <span class="preprocessor">#define MAX_ULONGLONG           ((ULONGLONG) -1)</span>
<a name="l00031"></a><a class="code" href="../../d3/d1/pnpmemio_8c.html#a2">00031</a> <span class="preprocessor"></span><span class="preprocessor">#define MAX_ALIAS_PORT          0x0000FFFF</span>
00032 <span class="preprocessor"></span>
<a name="l00033"></a><a class="code" href="../../d3/d9/struct__PORT__ARBITER__EXTENSION.html">00033</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d3/d9/struct__PORT__ARBITER__EXTENSION.html">_PORT_ARBITER_EXTENSION</a> {
00034 
<a name="l00035"></a><a class="code" href="../../d3/d9/struct__PORT__ARBITER__EXTENSION.html#o0">00035</a>     PRTL_RANGE_LIST <a class="code" href="../../d3/d9/struct__PORT__ARBITER__EXTENSION.html#o0">Aliases</a>;
<a name="l00036"></a><a class="code" href="../../d3/d9/struct__PORT__ARBITER__EXTENSION.html#o1">00036</a>     PRTL_RANGE_LIST <a class="code" href="../../d3/d9/struct__PORT__ARBITER__EXTENSION.html#o1">PossibleAliases</a>;
<a name="l00037"></a><a class="code" href="../../d3/d9/struct__PORT__ARBITER__EXTENSION.html#o2">00037</a>     RTL_RANGE_LIST <a class="code" href="../../d3/d9/struct__PORT__ARBITER__EXTENSION.html#o2">RangeLists</a>[2];
00038 
00039 } <a class="code" href="../../d3/d9/struct__PORT__ARBITER__EXTENSION.html">PORT_ARBITER_EXTENSION</a>, *<a class="code" href="../../d3/d9/struct__PORT__ARBITER__EXTENSION.html">PPORT_ARBITER_EXTENSION</a>;
00040 
00041 <span class="comment">//</span>
00042 <span class="comment">// Prototypes</span>
00043 <span class="comment">//</span>
00044 
00045 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00046 <a class="code" href="../../d3/d1/pnpmemio_8c.html#a12">IopPortBacktrackAllocation</a>(
00047      IN PARBITER_INSTANCE Arbiter,
00048      IN <a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html">PARBITER_ALLOCATION_STATE</a> State
00049      );
00050 
00051 BOOLEAN
00052 <a class="code" href="../../d3/d1/pnpmemio_8c.html#a13">IopPortGetNextAlias</a>(
00053     ULONG IoDescriptorFlags,
00054     ULONGLONG LastAlias,
00055     PULONGLONG NextAlias
00056     );
00057 
00058 BOOLEAN
00059 <a class="code" href="../../d3/d1/pnpmemio_8c.html#a14">IopPortFindSuitableRange</a>(
00060     PARBITER_INSTANCE Arbiter,
00061     <a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html">PARBITER_ALLOCATION_STATE</a> State
00062     );
00063 
00064 BOOLEAN
00065 <a class="code" href="../../d3/d1/pnpmemio_8c.html#a15">IopMemFindSuitableRange</a>(
00066     PARBITER_INSTANCE Arbiter,
00067     <a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html">PARBITER_ALLOCATION_STATE</a> State
00068     );
00069 
00070 
00071 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00072 <a class="code" href="../../d3/d1/pnpmemio_8c.html#a16">IopGenericUnpackRequirement</a>(
00073     IN PIO_RESOURCE_DESCRIPTOR Descriptor,
00074     OUT PULONGLONG Minimum,
00075     OUT PULONGLONG Maximum,
00076     OUT PULONG Length,
00077     OUT PULONG Alignment
00078     );
00079 
00080 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00081 <a class="code" href="../../d3/d1/pnpmemio_8c.html#a17">IopGenericPackResource</a>(
00082     IN PIO_RESOURCE_DESCRIPTOR Requirement,
00083     IN ULONGLONG Start,
00084     OUT PCM_PARTIAL_RESOURCE_DESCRIPTOR Descriptor
00085     );
00086 
00087 LONG
00088 <a class="code" href="../../d3/d1/pnpmemio_8c.html#a18">IopGenericScoreRequirement</a>(
00089     IN PIO_RESOURCE_DESCRIPTOR Descriptor
00090     );
00091 
00092 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00093 <a class="code" href="../../d3/d1/pnpmemio_8c.html#a19">IopGenericUnpackResource</a>(
00094     IN PCM_PARTIAL_RESOURCE_DESCRIPTOR Descriptor,
00095     OUT PULONGLONG Start,
00096     OUT PULONG Length
00097     );
00098 
00099 BOOLEAN
00100 <a class="code" href="../../d3/d1/pnpmemio_8c.html#a26">IopPortIsAliasedRangeAvailable</a>(
00101     IN PARBITER_INSTANCE Arbiter,
00102     IN <a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html">PARBITER_ALLOCATION_STATE</a> State
00103     );
00104 
00105 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00106 <a class="code" href="../../d3/d1/pnpmemio_8c.html#a21">IopMemInitialize</a>(
00107     VOID
00108     );
00109 
00110 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00111 <a class="code" href="../../d3/d1/pnpmemio_8c.html#a22">IopPortAddAllocation</a>(
00112     IN PARBITER_INSTANCE Arbiter,
00113     IN <a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html">PARBITER_ALLOCATION_STATE</a> State
00114     );
00115 
00116 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00117 <a class="code" href="../../d3/d1/pnpmemio_8c.html#a23">IopTranslateBusAddress</a>(
00118     IN PHYSICAL_ADDRESS SourceAddress,
00119     IN UCHAR SourceResourceType,
00120     OUT PPHYSICAL_ADDRESS TargetAddress,
00121     OUT PUCHAR TargetResourceType
00122     );
00123 
00124 
00125 <span class="comment">//</span>
00126 <span class="comment">// Make everything pageable</span>
00127 <span class="comment">//</span>
00128 
00129 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00130 <span class="preprocessor"></span>
00131 <span class="preprocessor">#pragma alloc_text(PAGE, IopPortInitialize)</span>
00132 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopMemInitialize)</span>
00133 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopGenericUnpackRequirement)</span>
00134 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopGenericPackResource)</span>
00135 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopGenericScoreRequirement)</span>
00136 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopGenericUnpackResource)</span>
00137 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopPortBacktrackAllocation)</span>
00138 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopPortFindSuitableRange)</span>
00139 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopMemFindSuitableRange)</span>
00140 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopPortGetNextAlias)</span>
00141 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopPortAddAllocation)</span>
00142 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopPortIsAliasedRangeAvailable)</span>
00143 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopTranslateBusAddress)</span>
00144 <span class="preprocessor"></span><span class="preprocessor">#endif // ALLOC_PRAGMA</span>
00145 <span class="preprocessor"></span>
00146 
<a name="l00147"></a><a class="code" href="../../d3/d1/pnpmemio_8c.html#a3">00147</a> <span class="preprocessor">#define ADDRESS_SPACE_MEMORY                0x0</span>
<a name="l00148"></a><a class="code" href="../../d3/d1/pnpmemio_8c.html#a4">00148</a> <span class="preprocessor"></span><span class="preprocessor">#define ADDRESS_SPACE_PORT                  0x1</span>
<a name="l00149"></a><a class="code" href="../../d3/d1/pnpmemio_8c.html#a5">00149</a> <span class="preprocessor"></span><span class="preprocessor">#define ADDRESS_SPACE_USER_MEMORY           0x2</span>
<a name="l00150"></a><a class="code" href="../../d3/d1/pnpmemio_8c.html#a6">00150</a> <span class="preprocessor"></span><span class="preprocessor">#define ADDRESS_SPACE_USER_PORT             0x3</span>
<a name="l00151"></a><a class="code" href="../../d3/d1/pnpmemio_8c.html#a7">00151</a> <span class="preprocessor"></span><span class="preprocessor">#define ADDRESS_SPACE_DENSE_MEMORY          0x4</span>
<a name="l00152"></a><a class="code" href="../../d3/d1/pnpmemio_8c.html#a8">00152</a> <span class="preprocessor"></span><span class="preprocessor">#define ADDRESS_SPACE_USER_DENSE_MEMORY     0x6</span>
00153 <span class="preprocessor"></span>
00154 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00155"></a><a class="code" href="../../d3/d1/pnpmemio_8c.html#a23">00155</a> <a class="code" href="../../d3/d1/pnpmemio_8c.html#a23">IopTranslateBusAddress</a>(
00156     IN PHYSICAL_ADDRESS SourceAddress,
00157     IN UCHAR SourceResourceType,
00158     OUT PPHYSICAL_ADDRESS TargetAddress,
00159     OUT PUCHAR TargetResourceType
00160     )
00161 <span class="comment">/*++</span>
00162 <span class="comment"></span>
00163 <span class="comment">Routine Description:</span>
00164 <span class="comment"></span>
00165 <span class="comment">    This routine translates addresses.</span>
00166 <span class="comment"></span>
00167 <span class="comment">Parameters:</span>
00168 <span class="comment"></span>
00169 <span class="comment">    SourceAddress - The address to translate</span>
00170 <span class="comment"></span>
00171 <span class="comment">    ResourceType - The resource type (IO or Memory) we are translaing.  If the</span>
00172 <span class="comment">        address space changes from IO-&gt;Memory this will be updated.</span>
00173 <span class="comment"></span>
00174 <span class="comment">    TargetAddress - Pointer to where the target should be translated to.</span>
00175 <span class="comment"></span>
00176 <span class="comment">Return Value:</span>
00177 <span class="comment"></span>
00178 <span class="comment">    STATUS_SUCCESS or an error status</span>
00179 <span class="comment"></span>
00180 <span class="comment">--*/</span>
00181 
00182 {
00183     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_UNSUCCESSFUL;
00184     ULONG sourceAddressSpace, targetAddressSpace;
00185     BOOLEAN translated;
00186 
00187     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00188 
00189     <span class="comment">//</span>
00190     <span class="comment">// Select the appropriate address space</span>
00191     <span class="comment">//</span>
00192 
00193     <span class="keywordflow">if</span> (SourceResourceType == CmResourceTypeMemory) {
00194         sourceAddressSpace = <a class="code" href="../../d3/d1/pnpmemio_8c.html#a3">ADDRESS_SPACE_MEMORY</a>;
00195     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (SourceResourceType == CmResourceTypePort) {
00196         sourceAddressSpace = <a class="code" href="../../d3/d1/pnpmemio_8c.html#a4">ADDRESS_SPACE_PORT</a>;
00197     } <span class="keywordflow">else</span> {
00198         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00199     }
00200 
00201     <a class="code" href="../../d9/d8/arbiter_8h.html#a1">ARB_PRINT</a>(
00202         2,
00203         (<span class="stringliteral">"Translating %s address 0x%I64x =&gt; "</span>,
00204         SourceResourceType == CmResourceTypeMemory ? <span class="stringliteral">"Memory"</span> : <span class="stringliteral">"I/O"</span>,
00205         SourceAddress.QuadPart
00206        ));
00207 
00208     <span class="comment">//</span>
00209     <span class="comment">// HACKHACK Ask the HAL to translate on ISA bus - if we can't then just</span>
00210     <span class="comment">// don't translate because this must be a PCI system so the root arbiters</span>
00211     <span class="comment">// don't do much (Yes it's a steaming hack but it'll work for beta 1)</span>
00212     <span class="comment">//</span>
00213 
00214     targetAddressSpace = sourceAddressSpace;
00215     translated = <a class="code" href="../../d2/d7/hal_8h.html#a184">HalTranslateBusAddress</a>(
00216                      Isa,
00217                      0,
00218                      SourceAddress,
00219                      &amp;targetAddressSpace,
00220                      TargetAddress
00221                      );
00222 
00223     <span class="keywordflow">if</span> (!translated) {
00224         <a class="code" href="../../d9/d8/arbiter_8h.html#a1">ARB_PRINT</a>(2,(<span class="stringliteral">"Translation failed!\n"</span>));
00225         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
00226     }
00227 
00228     <span class="comment">//</span>
00229     <span class="comment">// Update the resource type in the target if we have gone from Io to Memory</span>
00230     <span class="comment">//</span>
00231 
00232 
00233     <span class="comment">//</span>
00234     <span class="comment">// BUBBUG - update the length for IO -&gt; Memory (Dense vs Sparse)</span>
00235     <span class="comment">// I think the answer is dense -&gt; spares is multiply length by 32</span>
00236     <span class="comment">//</span>
00237 
00238     <span class="keywordflow">if</span> (targetAddressSpace == <a class="code" href="../../d3/d1/pnpmemio_8c.html#a3">ADDRESS_SPACE_MEMORY</a>
00239     ||  targetAddressSpace == <a class="code" href="../../d3/d1/pnpmemio_8c.html#a5">ADDRESS_SPACE_USER_MEMORY</a>
00240     ||  targetAddressSpace == <a class="code" href="../../d3/d1/pnpmemio_8c.html#a7">ADDRESS_SPACE_DENSE_MEMORY</a>
00241     ||  targetAddressSpace == <a class="code" href="../../d3/d1/pnpmemio_8c.html#a8">ADDRESS_SPACE_USER_DENSE_MEMORY</a>) {
00242         *TargetResourceType = CmResourceTypeMemory;
00243     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (targetAddressSpace == <a class="code" href="../../d3/d1/pnpmemio_8c.html#a4">ADDRESS_SPACE_PORT</a>
00244            ||  targetAddressSpace == <a class="code" href="../../d3/d1/pnpmemio_8c.html#a6">ADDRESS_SPACE_USER_PORT</a>) {
00245         *TargetResourceType = CmResourceTypePort;
00246     } <span class="keywordflow">else</span> {
00247         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(0 &amp;&amp; <span class="stringliteral">"Translation has returned an unknown address space"</span>);
00248     }
00249 
00250     <a class="code" href="../../d9/d8/arbiter_8h.html#a1">ARB_PRINT</a>(
00251         2,
00252         (<span class="stringliteral">"%s address 0x%I64x\n"</span>,
00253         *TargetResourceType == CmResourceTypeMemory ? <span class="stringliteral">"Memory"</span> : <span class="stringliteral">"I/O"</span>,
00254         TargetAddress-&gt;QuadPart
00255         ));
00256 
00257     <span class="keywordflow">return</span> STATUS_SUCCESS;
00258 
00259 }
00260 
00261 
00262 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00263"></a><a class="code" href="../../d3/d1/pnpmemio_8c.html#a24">00263</a> <a class="code" href="../../d3/d1/pnpmemio_8c.html#a24">IopGenericTranslateOrdering</a>(
00264     OUT PIO_RESOURCE_DESCRIPTOR Target,
00265     IN PIO_RESOURCE_DESCRIPTOR Source
00266     )
00267 
00268 <span class="comment">/*</span>
00269 <span class="comment"></span>
00270 <span class="comment">Routine Description:</span>
00271 <span class="comment"></span>
00272 <span class="comment">    This routine is called during arbiter initialization to translate the</span>
00273 <span class="comment">    orderings.</span>
00274 <span class="comment"></span>
00275 <span class="comment">Parameters:</span>
00276 <span class="comment"></span>
00277 <span class="comment">    Target - Place to put the translated descriptor</span>
00278 <span class="comment"></span>
00279 <span class="comment">    Source - Descriptor to translate</span>
00280 <span class="comment"></span>
00281 <span class="comment">Return Value:</span>
00282 <span class="comment"></span>
00283 <span class="comment">    STATUS_SUCCESS</span>
00284 <span class="comment"></span>
00285 <span class="comment"></span>
00286 <span class="comment"></span>
00287 <span class="comment">*/</span>
00288 
00289 {
00290     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00291     UCHAR initialResourceType, minResourceType, maxResourceType;
00292     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00293 
00294 
00295     *Target = *Source;
00296 
00297     <span class="keywordflow">if</span> (Source-&gt;Type != CmResourceTypeMemory
00298     &amp;&amp; Source-&gt;Type != CmResourceTypePort) {
00299         <span class="keywordflow">return</span> STATUS_SUCCESS;
00300     }
00301 
00302     initialResourceType = Source-&gt;Type;
00303 
00304     <span class="comment">//</span>
00305     <span class="comment">// Translate the minimum</span>
00306     <span class="comment">//</span>
00307 
00308     status = <a class="code" href="../../d3/d1/pnpmemio_8c.html#a23">IopTranslateBusAddress</a>(Source-&gt;u.Generic.MinimumAddress,
00309                                     initialResourceType,
00310                                     &amp;Target-&gt;u.Generic.MinimumAddress,
00311                                     &amp;minResourceType
00312                                     );
00313 
00314     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00315 
00316         <span class="comment">//</span>
00317         <span class="comment">// Translate the maximum iff we could translate the minimum</span>
00318         <span class="comment">//</span>
00319 
00320         status = <a class="code" href="../../d3/d1/pnpmemio_8c.html#a23">IopTranslateBusAddress</a>(Source-&gt;u.Generic.MaximumAddress,
00321                                         initialResourceType,
00322                                         &amp;Target-&gt;u.Generic.MaximumAddress,
00323                                         &amp;maxResourceType
00324                                         );
00325 
00326     }
00327 
00328     <span class="comment">//</span>
00329     <span class="comment">// If we couldn't translate both ends of the range then we want to skip this</span>
00330     <span class="comment">// range - set it's type to CmResourceTypeNull</span>
00331     <span class="comment">//</span>
00332 
00333     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00334         Target-&gt;Type = CmResourceTypeNull;
00335     } <span class="keywordflow">else</span> {
00336         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(minResourceType == maxResourceType);
00337         Target-&gt;Type = minResourceType;
00338     }
00339 
00340     <span class="keywordflow">return</span> STATUS_SUCCESS;
00341 
00342 }
00343 
00344 <span class="comment">//</span>
00345 <span class="comment">// Implementation</span>
00346 <span class="comment">//</span>
00347 
00348 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00349"></a><a class="code" href="../../d3/d1/pnpmemio_8c.html#a25">00349</a> <a class="code" href="../../d3/d1/pnpmemio_8c.html#a25">IopPortInitialize</a>(
00350     VOID
00351     )
00352 
00353 <span class="comment">/*++</span>
00354 <span class="comment"></span>
00355 <span class="comment">Routine Description:</span>
00356 <span class="comment"></span>
00357 <span class="comment">    This routine initializes the arbiter</span>
00358 <span class="comment"></span>
00359 <span class="comment">Parameters:</span>
00360 <span class="comment"></span>
00361 <span class="comment">    None</span>
00362 <span class="comment"></span>
00363 <span class="comment">Return Value:</span>
00364 <span class="comment"></span>
00365 <span class="comment">    None</span>
00366 <span class="comment"></span>
00367 <span class="comment">--*/</span>
00368 
00369 {
00370     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00371 
00372     <span class="comment">//</span>
00373     <span class="comment">// Fill in the non-default action handlers</span>
00374     <span class="comment">//</span>
00375 
00376     <a class="code" href="../../d1/d0/pnpdata_8c.html#a30">IopRootPortArbiter</a>.<a class="code" href="../../d8/d7/struct__ARBITER__INSTANCE.html#o28">FindSuitableRange</a>    = <a class="code" href="../../d3/d1/pnpmemio_8c.html#a14">IopPortFindSuitableRange</a>;
00377     <a class="code" href="../../d1/d0/pnpdata_8c.html#a30">IopRootPortArbiter</a>.<a class="code" href="../../d8/d7/struct__ARBITER__INSTANCE.html#o29">AddAllocation</a>        = <a class="code" href="../../d3/d1/pnpmemio_8c.html#a22">IopPortAddAllocation</a>;
00378     <a class="code" href="../../d1/d0/pnpdata_8c.html#a30">IopRootPortArbiter</a>.<a class="code" href="../../d8/d7/struct__ARBITER__INSTANCE.html#o30">BacktrackAllocation</a>  = <a class="code" href="../../d3/d1/pnpmemio_8c.html#a12">IopPortBacktrackAllocation</a>;
00379 
00380     <a class="code" href="../../d1/d0/pnpdata_8c.html#a30">IopRootPortArbiter</a>.<a class="code" href="../../d8/d7/struct__ARBITER__INSTANCE.html#o12">UnpackRequirement</a>    = <a class="code" href="../../d3/d1/pnpmemio_8c.html#a16">IopGenericUnpackRequirement</a>;
00381     <a class="code" href="../../d1/d0/pnpdata_8c.html#a30">IopRootPortArbiter</a>.<a class="code" href="../../d8/d7/struct__ARBITER__INSTANCE.html#o13">PackResource</a>         = <a class="code" href="../../d3/d1/pnpmemio_8c.html#a17">IopGenericPackResource</a>;
00382     <a class="code" href="../../d1/d0/pnpdata_8c.html#a30">IopRootPortArbiter</a>.<a class="code" href="../../d8/d7/struct__ARBITER__INSTANCE.html#o14">UnpackResource</a>       = <a class="code" href="../../d3/d1/pnpmemio_8c.html#a19">IopGenericUnpackResource</a>;
00383     <a class="code" href="../../d1/d0/pnpdata_8c.html#a30">IopRootPortArbiter</a>.<a class="code" href="../../d8/d7/struct__ARBITER__INSTANCE.html#o15">ScoreRequirement</a>     = <a class="code" href="../../d3/d1/pnpmemio_8c.html#a18">IopGenericScoreRequirement</a>;
00384 
00385     <span class="keywordflow">return</span> <a class="code" href="../../d9/d8/arbiter_8h.html#a67">ArbInitializeArbiterInstance</a>(&amp;<a class="code" href="../../d1/d0/pnpdata_8c.html#a30">IopRootPortArbiter</a>,
00386                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,     <span class="comment">// Indicates ROOT arbiter</span>
00387                                         CmResourceTypePort,
00388                                         <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"RootPort"</span>,
00389                                         <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Root"</span>,
00390                                         <a class="code" href="../../d3/d1/pnpmemio_8c.html#a24">IopGenericTranslateOrdering</a>
00391                                         );
00392 
00393 }
00394 
00395 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00396"></a><a class="code" href="../../d9/d0/pnpiop_8h.html#a366">00396</a> <a class="code" href="../../d3/d1/pnpmemio_8c.html#a21">IopMemInitialize</a>(
00397     VOID
00398     )
00399 
00400 <span class="comment">/*++</span>
00401 <span class="comment"></span>
00402 <span class="comment">Routine Description:</span>
00403 <span class="comment"></span>
00404 <span class="comment">    This routine initializes the arbiter</span>
00405 <span class="comment"></span>
00406 <span class="comment">Parameters:</span>
00407 <span class="comment"></span>
00408 <span class="comment">    None</span>
00409 <span class="comment"></span>
00410 <span class="comment">Return Value:</span>
00411 <span class="comment"></span>
00412 <span class="comment">    None</span>
00413 <span class="comment"></span>
00414 <span class="comment">--*/</span>
00415 
00416 {
00417     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00418 
00419     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00420 
00421     <a class="code" href="../../d1/d0/pnpdata_8c.html#a31">IopRootMemArbiter</a>.<a class="code" href="../../d8/d7/struct__ARBITER__INSTANCE.html#o12">UnpackRequirement</a> = <a class="code" href="../../d3/d1/pnpmemio_8c.html#a16">IopGenericUnpackRequirement</a>;
00422     <a class="code" href="../../d1/d0/pnpdata_8c.html#a31">IopRootMemArbiter</a>.<a class="code" href="../../d8/d7/struct__ARBITER__INSTANCE.html#o13">PackResource</a>      = <a class="code" href="../../d3/d1/pnpmemio_8c.html#a17">IopGenericPackResource</a>;
00423     <a class="code" href="../../d1/d0/pnpdata_8c.html#a31">IopRootMemArbiter</a>.<a class="code" href="../../d8/d7/struct__ARBITER__INSTANCE.html#o14">UnpackResource</a>    = <a class="code" href="../../d3/d1/pnpmemio_8c.html#a19">IopGenericUnpackResource</a>;
00424     <a class="code" href="../../d1/d0/pnpdata_8c.html#a31">IopRootMemArbiter</a>.<a class="code" href="../../d8/d7/struct__ARBITER__INSTANCE.html#o15">ScoreRequirement</a>  = <a class="code" href="../../d3/d1/pnpmemio_8c.html#a18">IopGenericScoreRequirement</a>;
00425 
00426     <a class="code" href="../../d1/d0/pnpdata_8c.html#a31">IopRootMemArbiter</a>.<a class="code" href="../../d8/d7/struct__ARBITER__INSTANCE.html#o28">FindSuitableRange</a>    = <a class="code" href="../../d3/d1/pnpmemio_8c.html#a15">IopMemFindSuitableRange</a>;
00427 
00428     status = <a class="code" href="../../d9/d8/arbiter_8h.html#a67">ArbInitializeArbiterInstance</a>(&amp;<a class="code" href="../../d1/d0/pnpdata_8c.html#a31">IopRootMemArbiter</a>,
00429                                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,     <span class="comment">// Indicates ROOT arbiter</span>
00430                                           CmResourceTypeMemory,
00431                                           <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"RootMemory"</span>,
00432                                           <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Root"</span>,
00433                                           <a class="code" href="../../d3/d1/pnpmemio_8c.html#a24">IopGenericTranslateOrdering</a>
00434                                           );
00435 
00436     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00437         <span class="keywordflow">return</span> status;
00438     }
00439 
00440     <span class="comment">//</span>
00441     <span class="comment">// Allocate the first page of physical memory as the firmware uses it and</span>
00442     <span class="comment">// doesn't report it as so Mm doesn't reuse it.</span>
00443     <span class="comment">//</span>
00444 
00445     status = <a class="code" href="../../d2/d5/range_8c.html#a16">RtlAddRange</a>(<a class="code" href="../../d1/d0/pnpdata_8c.html#a31">IopRootMemArbiter</a>.<a class="code" href="../../d8/d7/struct__ARBITER__INSTANCE.html#o4">Allocation</a>,
00446                          0,
00447                          <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>,
00448                          0, <span class="comment">// RangeAttributes</span>
00449                          0, <span class="comment">// Flags</span>
00450                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00451                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00452                          );
00453     <span class="keywordflow">return</span> status;
00454 
00455 }
00456 
00457 
00458 <span class="comment">//</span>
00459 <span class="comment">// Arbiter callbacks</span>
00460 <span class="comment">//</span>
00461 
00462 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00463"></a><a class="code" href="../../d3/d1/pnpmemio_8c.html#a16">00463</a> <a class="code" href="../../d3/d1/pnpmemio_8c.html#a16">IopGenericUnpackRequirement</a>(
00464     IN PIO_RESOURCE_DESCRIPTOR Descriptor,
00465     OUT PULONGLONG Minimum,
00466     OUT PULONGLONG Maximum,
00467     OUT PULONG Length,
00468     OUT PULONG Alignment
00469     )
00470 
00471 <span class="comment">/*++</span>
00472 <span class="comment"></span>
00473 <span class="comment">Routine Description:</span>
00474 <span class="comment"></span>
00475 <span class="comment">    This routine unpacks an resource requirement descriptor.</span>
00476 <span class="comment"></span>
00477 <span class="comment">Arguments:</span>
00478 <span class="comment"></span>
00479 <span class="comment">    Descriptor - The descriptor describing the requirement to unpack.</span>
00480 <span class="comment"></span>
00481 <span class="comment">    Minimum - Pointer to where the minimum acceptable start value should be</span>
00482 <span class="comment">        unpacked to.</span>
00483 <span class="comment"></span>
00484 <span class="comment">    Maximum - Pointer to where the maximum acceptable end value should be</span>
00485 <span class="comment">        unpacked to.</span>
00486 <span class="comment"></span>
00487 <span class="comment">    Length - Pointer to where the required length should be unpacked to.</span>
00488 <span class="comment"></span>
00489 <span class="comment">    Minimum - Pointer to where the required alignment should be unpacked to.</span>
00490 <span class="comment"></span>
00491 <span class="comment">Return Value:</span>
00492 <span class="comment"></span>
00493 <span class="comment">    Returns the status of this operation.</span>
00494 <span class="comment"></span>
00495 <span class="comment">--*/</span>
00496 
00497 {
00498     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00499     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Descriptor);
00500     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Descriptor-&gt;Type == CmResourceTypePort
00501            || Descriptor-&gt;Type == CmResourceTypeMemory);
00502 
00503 
00504     *Minimum = (ULONGLONG) Descriptor-&gt;u.Generic.MinimumAddress.QuadPart;
00505     *Maximum = (ULONGLONG) Descriptor-&gt;u.Generic.MaximumAddress.QuadPart;
00506     *Length = Descriptor-&gt;u.Generic.Length;
00507     *Alignment = Descriptor-&gt;u.Generic.Alignment;
00508 
00509     <span class="comment">//</span>
00510     <span class="comment">// Fix the broken hardware that reports 0 alignment</span>
00511     <span class="comment">//</span>
00512 
00513     <span class="keywordflow">if</span> (*Alignment == 0) {
00514         *Alignment = 1;
00515     }
00516 
00517     <span class="comment">//</span>
00518     <span class="comment">// Fix broken INF's that report they support 24bit memory &gt; 0xFFFFFF</span>
00519     <span class="comment">//</span>
00520 
00521     <span class="keywordflow">if</span> (Descriptor-&gt;Type == CmResourceTypeMemory
00522     &amp;&amp; Descriptor-&gt;Flags &amp; CM_RESOURCE_MEMORY_24
00523     &amp;&amp; Descriptor-&gt;u.Memory.MaximumAddress.QuadPart &gt; 0xFFFFFF) {
00524         *Maximum = 0xFFFFFF;
00525     }
00526 
00527     <a class="code" href="../../d9/d8/arbiter_8h.html#a1">ARB_PRINT</a>(2,
00528                 (<span class="stringliteral">"Unpacking %s requirement %p =&gt; 0x%I64x-0x%I64x length 0x%x alignment 0x%x\n"</span>,
00529                 Descriptor-&gt;Type == CmResourceTypePort ? <span class="stringliteral">"port"</span> : <span class="stringliteral">"memory"</span>,
00530                 Descriptor,
00531                 *Minimum,
00532                 *Maximum,
00533                 *Length,
00534                 *Alignment
00535                 ));
00536 
00537     <span class="keywordflow">return</span> STATUS_SUCCESS;
00538 
00539 }
00540 
00541 LONG
<a name="l00542"></a><a class="code" href="../../d3/d1/pnpmemio_8c.html#a18">00542</a> <a class="code" href="../../d3/d1/pnpmemio_8c.html#a18">IopGenericScoreRequirement</a>(
00543     IN PIO_RESOURCE_DESCRIPTOR Descriptor
00544     )
00545 
00546 <span class="comment">/*++</span>
00547 <span class="comment"></span>
00548 <span class="comment">Routine Description:</span>
00549 <span class="comment"></span>
00550 <span class="comment">    This routine scores a requirement based on how flexible it is.  The least</span>
00551 <span class="comment">    flexible devices are scored the least and so when the arbitration list is</span>
00552 <span class="comment">    sorted we try to allocate their resources first.</span>
00553 <span class="comment"></span>
00554 <span class="comment">Arguments:</span>
00555 <span class="comment"></span>
00556 <span class="comment">    Descriptor - The descriptor describing the requirement to score.</span>
00557 <span class="comment"></span>
00558 <span class="comment"></span>
00559 <span class="comment">Return Value:</span>
00560 <span class="comment"></span>
00561 <span class="comment">    The score.</span>
00562 <span class="comment"></span>
00563 <span class="comment">--*/</span>
00564 
00565 {
00566     LONG score;
00567     ULONGLONG start, end;
00568     LONGLONG bigscore;
00569     ULONG alignment;
00570 
00571     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00572 
00573 <span class="preprocessor">#define MAX_SCORE MAXLONG</span>
00574 <span class="preprocessor"></span>
00575     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Descriptor);
00576     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((Descriptor-&gt;Type == CmResourceTypePort) ||
00577            (Descriptor-&gt;Type == CmResourceTypeMemory));
00578 
00579     alignment = Descriptor-&gt;u.Generic.Alignment;
00580 
00581     <span class="comment">//</span>
00582     <span class="comment">// Fix the broken hardware that reports 0 alignment</span>
00583     <span class="comment">// Since this is not a PCI device, set the alignment to 1.</span>
00584     <span class="comment">//</span>
00585     <span class="comment">//</span>
00586 
00587     <span class="keywordflow">if</span> (alignment == 0 &amp;&amp;
00588         ((Descriptor-&gt;Type == CmResourceTypePort) ||
00589          (Descriptor-&gt;Type == CmResourceTypeMemory))) {
00590         alignment = 1;
00591     }
00592 
00593 
00594 
00595     start = <a class="code" href="../../d9/d8/arbiter_8h.html#a4">ALIGN_ADDRESS_UP</a>(
00596                 Descriptor-&gt;u.Generic.MinimumAddress.QuadPart,
00597                 alignment
00598                 );
00599 
00600     end = Descriptor-&gt;u.Generic.MaximumAddress.QuadPart;
00601 
00602     <span class="comment">//</span>
00603     <span class="comment">// The score is the number of possible allocations that could be made</span>
00604     <span class="comment">// given the alignment and length constraints</span>
00605     <span class="comment">//</span>
00606 
00607     bigscore = (((end - Descriptor-&gt;u.Generic.Length + 1) - start)
00608                     / alignment) + 1;
00609 
00610     score = (LONG)bigscore;
00611     <span class="keywordflow">if</span> (bigscore &lt; 0) {
00612         score = -1;
00613     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bigscore &gt; <a class="code" href="../../d3/d1/pnpmemio_8c.html#a9">MAX_SCORE</a>) {
00614         score = <a class="code" href="../../d3/d1/pnpmemio_8c.html#a9">MAX_SCORE</a>;
00615     }
00616 
00617     <a class="code" href="../../d9/d8/arbiter_8h.html#a1">ARB_PRINT</a>(2,
00618                 (<span class="stringliteral">"Scoring port resource %p(0x%I64x-0x%I64x) =&gt; %i\n"</span>,
00619                 Descriptor-&gt;Type == CmResourceTypePort ? <span class="stringliteral">"port"</span> : <span class="stringliteral">"memory"</span>,
00620                 Descriptor,
00621                 Descriptor-&gt;u.Generic.MinimumAddress.QuadPart,
00622                 end,
00623                 score
00624                 ));
00625 
00626     <span class="keywordflow">return</span> score;
00627 }
00628 
00629 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00630"></a><a class="code" href="../../d3/d1/pnpmemio_8c.html#a17">00630</a> <a class="code" href="../../d3/d1/pnpmemio_8c.html#a17">IopGenericPackResource</a>(
00631     IN PIO_RESOURCE_DESCRIPTOR Requirement,
00632     IN ULONGLONG Start,
00633     OUT PCM_PARTIAL_RESOURCE_DESCRIPTOR Descriptor
00634     )
00635 
00636 <span class="comment">/*++</span>
00637 <span class="comment"></span>
00638 <span class="comment">Routine Description:</span>
00639 <span class="comment"></span>
00640 <span class="comment">    This routine packs an resource descriptor.</span>
00641 <span class="comment"></span>
00642 <span class="comment">Arguments:</span>
00643 <span class="comment"></span>
00644 <span class="comment">    Requirement - The requirement from which this resource was chosen.</span>
00645 <span class="comment"></span>
00646 <span class="comment">    Start - The start value of the resource.</span>
00647 <span class="comment"></span>
00648 <span class="comment">    Descriptor - Pointer to the descriptor to pack into.</span>
00649 <span class="comment"></span>
00650 <span class="comment">Return Value:</span>
00651 <span class="comment"></span>
00652 <span class="comment">    Returns the status of this operation.</span>
00653 <span class="comment"></span>
00654 <span class="comment">--*/</span>
00655 
00656 {
00657 
00658     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00659     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Descriptor);
00660     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Requirement);
00661     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Requirement-&gt;Type == CmResourceTypePort
00662            || Requirement-&gt;Type == CmResourceTypeMemory);
00663 
00664     Descriptor-&gt;Type = Requirement-&gt;Type;
00665     Descriptor-&gt;Flags = Requirement-&gt;Flags;
00666     Descriptor-&gt;ShareDisposition = Requirement-&gt;ShareDisposition;
00667     Descriptor-&gt;u.Generic.Start.QuadPart = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>;
00668     Descriptor-&gt;u.Generic.Length = Requirement-&gt;u.Generic.Length;
00669 
00670     <a class="code" href="../../d9/d8/arbiter_8h.html#a1">ARB_PRINT</a>(2,
00671                 (<span class="stringliteral">"Packing %s resource %p =&gt; 0x%I64x length 0x%x\n"</span>,
00672                 Descriptor-&gt;Type == CmResourceTypePort ? <span class="stringliteral">"port"</span> : <span class="stringliteral">"memory"</span>,
00673                 Descriptor,
00674                 Descriptor-&gt;u.Port.Start.QuadPart,
00675                 Descriptor-&gt;u.Port.Length
00676                 ));
00677 
00678     <span class="keywordflow">return</span> STATUS_SUCCESS;
00679 }
00680 
00681 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00682"></a><a class="code" href="../../d3/d1/pnpmemio_8c.html#a19">00682</a> <a class="code" href="../../d3/d1/pnpmemio_8c.html#a19">IopGenericUnpackResource</a>(
00683     IN PCM_PARTIAL_RESOURCE_DESCRIPTOR Descriptor,
00684     OUT PULONGLONG Start,
00685     OUT PULONG Length
00686     )
00687 
00688 <span class="comment">/*++</span>
00689 <span class="comment"></span>
00690 <span class="comment">Routine Description:</span>
00691 <span class="comment"></span>
00692 <span class="comment">    This routine unpacks an resource descriptor.</span>
00693 <span class="comment"></span>
00694 <span class="comment">Arguments:</span>
00695 <span class="comment"></span>
00696 <span class="comment">    Descriptor - The descriptor describing the resource to unpack.</span>
00697 <span class="comment"></span>
00698 <span class="comment">    Start - Pointer to where the start value should be unpacked to.</span>
00699 <span class="comment"></span>
00700 <span class="comment">    Length - Pointer to where the length value should be unpacked to.</span>
00701 <span class="comment"></span>
00702 <span class="comment">Return Value:</span>
00703 <span class="comment"></span>
00704 <span class="comment">    Returns the status of this operation.</span>
00705 <span class="comment"></span>
00706 <span class="comment">--*/</span>
00707 
00708 {
00709 
00710     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00711     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Descriptor);
00712     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Descriptor-&gt;Type == CmResourceTypePort
00713            || Descriptor-&gt;Type == CmResourceTypeMemory);
00714 
00715     *<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> = Descriptor-&gt;u.Generic.Start.QuadPart;
00716     *Length = Descriptor-&gt;u.Generic.Length;
00717 
00718     <a class="code" href="../../d9/d8/arbiter_8h.html#a1">ARB_PRINT</a>(2,
00719                 (<span class="stringliteral">"Unpacking %s resource %p =&gt; 0x%I64x Length 0x%x\n"</span>,
00720                 Descriptor-&gt;Type == CmResourceTypePort ? <span class="stringliteral">"port"</span> : <span class="stringliteral">"memory"</span>,
00721                 Descriptor,
00722                 *<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>,
00723                 *Length
00724                 ));
00725 
00726     <span class="keywordflow">return</span> STATUS_SUCCESS;
00727 
00728 }
00729 <span class="preprocessor">#if 0</span>
00730 <span class="preprocessor"></span><a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00731 IopPortRetestAllocation(
00732     IN PARBITER_INSTANCE Arbiter,
00733     IN OUT PLIST_ENTRY ArbitrationList
00734     )
00735 
00736 <span class="comment">/*++</span>
00737 <span class="comment"></span>
00738 <span class="comment">Routine Description:</span>
00739 <span class="comment"></span>
00740 <span class="comment">    This providesa port specific implementation of the RetestAllocation action</span>
00741 <span class="comment">    which takes into account ISA aliases and adds them where appropriate.</span>
00742 <span class="comment">    It walks the arbitration list and updates the possible allocation to reflect</span>
00743 <span class="comment">    the allocation entries of the list.  For these entries to be valid</span>
00744 <span class="comment">    TestAllocation must have been performed on this arbitration list.</span>
00745 <span class="comment"></span>
00746 <span class="comment">Parameters:</span>
00747 <span class="comment"></span>
00748 <span class="comment">    Arbiter - The arbiter instance data for the arbiter being called.</span>
00749 <span class="comment"></span>
00750 <span class="comment">    ArbitrationList - A list of ARBITER_LIST_ENTRY entries which contain the</span>
00751 <span class="comment">        requirements and associated devices.  TestAllocation for this arbiter</span>
00752 <span class="comment">        should have been called on this list.</span>
00753 <span class="comment"></span>
00754 <span class="comment">Return Value:</span>
00755 <span class="comment"></span>
00756 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
00757 <span class="comment"></span>
00758 <span class="comment">--*/</span>
00759 
00760 {
00761     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00762     <a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html">PARBITER_LIST_ENTRY</a> current;
00763     PIO_RESOURCE_DESCRIPTOR alternative;
00764     ULONGLONG start;
00765     ULONG length;
00766 
00767     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00768 
00769     <span class="comment">//</span>
00770     <span class="comment">// Copy the current allocation and reserved</span>
00771     <span class="comment">//</span>
00772 
00773     <a class="code" href="../../d9/d8/arbiter_8h.html#a1">ARB_PRINT</a>(3, (<span class="stringliteral">"Retest: Copy current allocation\n"</span>));
00774     status = <a class="code" href="../../d2/d5/range_8c.html#a19">RtlCopyRangeList</a>(Arbiter-&gt;PossibleAllocation, Arbiter-&gt;Allocation);
00775 
00776     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00777         <span class="keywordflow">goto</span> cleanup;
00778     }
00779 
00780     <span class="comment">//</span>
00781     <span class="comment">// Free all the resources currently allocated to all the devices we</span>
00782     <span class="comment">// are arbitrating for</span>
00783     <span class="comment">//</span>
00784 
00785     <a class="code" href="../../d1/d5/translate_8c.html#a0">FOR_ALL_IN_LIST</a>(<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html">ARBITER_LIST_ENTRY</a>, ArbitrationList, current) {
00786 
00787         <a class="code" href="../../d9/d8/arbiter_8h.html#a1">ARB_PRINT</a>(2, (<span class="stringliteral">"Retest: Delete 0x%08x's resources\n"</span>, current-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o3">PhysicalDeviceObject</a>));
00788 
00789         status = <a class="code" href="../../d2/d5/range_8c.html#a18">RtlDeleteOwnersRanges</a>(Arbiter-&gt;PossibleAllocation,
00790                                        (PVOID) current-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o3">PhysicalDeviceObject</a>
00791                                        );
00792 
00793         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00794             <span class="keywordflow">goto</span> cleanup;
00795         }
00796     }
00797 
00798     <span class="comment">//</span>
00799     <span class="comment">// Copy the previous allocation into the range list</span>
00800     <span class="comment">//</span>
00801 
00802     <a class="code" href="../../d1/d5/translate_8c.html#a0">FOR_ALL_IN_LIST</a>(<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html">ARBITER_LIST_ENTRY</a>, ArbitrationList, current) {
00803 
00804         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(current-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o10">Assignment</a>);
00805 
00806         status = Arbiter-&gt;UnpackResource(current-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o10">Assignment</a>,
00807                                          &amp;start,
00808                                          &amp;length
00809                                          );
00810 
00811         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status));
00812 
00813         <span class="comment">//</span>
00814         <span class="comment">// If we had a requirement for length 0 then that will be seen as</span>
00815         <span class="comment">// end == start - 1 here so don't attempt to add the range - it will</span>
00816         <span class="comment">// fail!</span>
00817         <span class="comment">//</span>
00818 
00819         <span class="keywordflow">if</span> (length != 0) {
00820 
00821             status = <a class="code" href="../../d2/d5/range_8c.html#a16">RtlAddRange</a>(
00822                 Arbiter-&gt;PossibleAllocation,
00823                 start,
00824                 start + length - 1,
00825                 0,
00826                 RTL_RANGE_LIST_ADD_IF_CONFLICT +
00827                     (current-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o10">Assignment</a>-&gt;ShareDisposition == CmResourceShareShared ?
00828                         RTL_RANGE_LIST_ADD_SHARED : 0),
00829                 NULL,
00830                 current-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o3">PhysicalDeviceObject</a>
00831                 );
00832 
00833             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status));
00834 
00835             <span class="comment">//</span>
00836             <span class="comment">// Retireve the alternative from which the assignment was chosen from</span>
00837             <span class="comment">// then</span>
00838             <span class="comment">//</span>
00839 
00840             alternative = current-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o11">SelectedAlternative</a>;
00841 
00842             <span class="comment">//</span>
00843             <span class="comment">// Add the aliases</span>
00844             <span class="comment">//</span>
00845 
00846             <span class="keywordflow">if</span> (alternative-&gt;Flags &amp; CM_RESOURCE_PORT_10_BIT_DECODE
00847             || alternative-&gt;Flags &amp; CM_RESOURCE_PORT_12_BIT_DECODE) {
00848 
00849                 ULONGLONG alias = start;
00850                 BOOLEAN shared = current-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o10">Assignment</a>-&gt;ShareDisposition ==
00851                                      CmResourceShareShared;
00852 
00853                 <a class="code" href="../../d9/d8/arbiter_8h.html#a1">ARB_PRINT</a>(3, (<span class="stringliteral">"Adding aliases\n"</span>));
00854 
00855                 <span class="keywordflow">while</span> (<a class="code" href="../../d3/d1/pnpmemio_8c.html#a13">IopPortGetNextAlias</a>(alternative-&gt;Flags,
00856                                            alias,
00857                                            &amp;alias)) {
00858 
00859                     status = <a class="code" href="../../d2/d5/range_8c.html#a16">RtlAddRange</a>(
00860                                  Arbiter-&gt;PossibleAllocation,
00861                                  alias,
00862                                  alias + length - 1,
00863                                  ARBITER_RANGE_ALIAS,
00864                                  RTL_RANGE_LIST_ADD_IF_CONFLICT +
00865                                     (shared ? RTL_RANGE_LIST_SHARED_OK : 0),
00866                                  NULL,
00867                                  current-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o3">PhysicalDeviceObject</a>
00868                                  );
00869 
00870                     <span class="comment">//</span>
00871                     <span class="comment">// We have already checked if these ranges are available</span>
00872                     <span class="comment">// so we should not fail...</span>
00873                     <span class="comment">//</span>
00874 
00875                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status));
00876                 }
00877             }
00878         }
00879     }
00880 
00881     <span class="keywordflow">return</span> status;
00882 
00883 cleanup:
00884 
00885     <a class="code" href="../../d2/d5/range_8c.html#a20">RtlFreeRangeList</a>(Arbiter-&gt;PossibleAllocation);
00886     <span class="keywordflow">return</span> status;
00887 }
00888 <span class="preprocessor">#endif</span>
00889 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00890"></a><a class="code" href="../../d3/d1/pnpmemio_8c.html#a12">00890</a> <a class="code" href="../../d3/d1/pnpmemio_8c.html#a12">IopPortBacktrackAllocation</a>(
00891      IN PARBITER_INSTANCE Arbiter,
00892      IN <a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html">PARBITER_ALLOCATION_STATE</a> State
00893      )
00894 
00895 <span class="comment">/*++</span>
00896 <span class="comment"></span>
00897 <span class="comment">Routine Description:</span>
00898 <span class="comment"></span>
00899 <span class="comment">    This routine is called from AllocateEntry if the possible solution</span>
00900 <span class="comment">    (State-&gt;Start - State-&gt;End) does not allow us to allocate resources to</span>
00901 <span class="comment">    the rest of the devices being considered.  It deletes the ranges that were</span>
00902 <span class="comment">    added to Arbiter-&gt;PossibleAllocation by AddAllocation including those</span>
00903 <span class="comment">    associated with ISA aliases.</span>
00904 <span class="comment"></span>
00905 <span class="comment">Arguments:</span>
00906 <span class="comment"></span>
00907 <span class="comment">    Arbiter - The instance data of the arbiter who was called.</span>
00908 <span class="comment"></span>
00909 <span class="comment">    State - The state of the current arbitration.</span>
00910 <span class="comment"></span>
00911 <span class="comment">Return Value:</span>
00912 <span class="comment"></span>
00913 <span class="comment">    None.</span>
00914 <span class="comment"></span>
00915 <span class="comment">--*/</span>
00916 
00917 
00918 {
00919 
00920     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00921     ULONGLONG alias = State-&gt;Start;
00922 
00923     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00924 
00925     <span class="comment">//</span>
00926     <span class="comment">// Delete the aliases</span>
00927     <span class="comment">//</span>
00928 
00929     <a class="code" href="../../d9/d8/arbiter_8h.html#a1">ARB_PRINT</a>(2, (<span class="stringliteral">"\t\tDeleting aliases\n"</span>));
00930 
00931     <span class="keywordflow">while</span> (<a class="code" href="../../d3/d1/pnpmemio_8c.html#a13">IopPortGetNextAlias</a>(State-&gt;CurrentAlternative-&gt;Flags,
00932                                alias,
00933                                &amp;alias)) {
00934 
00935         status = <a class="code" href="../../d2/d5/range_8c.html#a17">RtlDeleteRange</a>(
00936                      Arbiter-&gt;PossibleAllocation,
00937                      alias,
00938                      alias + State-&gt;CurrentAlternative-&gt;Length - 1,
00939                      State-&gt;Entry-&gt;PhysicalDeviceObject
00940                      );
00941 
00942         <span class="comment">//</span>
00943         <span class="comment">// We should not fail...</span>
00944         <span class="comment">//</span>
00945 
00946         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status));
00947     }
00948 
00949     <span class="comment">//</span>
00950     <span class="comment">// Now call the original function to delete the base range</span>
00951     <span class="comment">//</span>
00952 
00953     <a class="code" href="../../d9/d8/arbiter_8h.html#a81">ArbBacktrackAllocation</a>(Arbiter, State);
00954 
00955 }
00956 
00957 
00958 BOOLEAN
<a name="l00959"></a><a class="code" href="../../d3/d1/pnpmemio_8c.html#a14">00959</a> <a class="code" href="../../d3/d1/pnpmemio_8c.html#a14">IopPortFindSuitableRange</a>(
00960     PARBITER_INSTANCE Arbiter,
00961     <a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html">PARBITER_ALLOCATION_STATE</a> State
00962     )
00963 <span class="comment">/*++</span>
00964 <span class="comment"></span>
00965 <span class="comment">Routine Description:</span>
00966 <span class="comment"></span>
00967 <span class="comment">    This routine is called from AllocateEntry once we have decided where we want</span>
00968 <span class="comment">    to allocate from.  It tries to find a free range that matches the</span>
00969 <span class="comment">    requirements in State while restricting its possible solutions to the range</span>
00970 <span class="comment">    State-&gt;Start to State-&gt;CurrentMaximum.  On success State-&gt;Start and</span>
00971 <span class="comment">    State-&gt;End represent this range.  Conflicts with ISA aliases are considered.</span>
00972 <span class="comment"></span>
00973 <span class="comment">Arguments:</span>
00974 <span class="comment"></span>
00975 <span class="comment">    Arbiter - The instance data of the arbiter who was called.</span>
00976 <span class="comment"></span>
00977 <span class="comment">    State - The state of the current arbitration.</span>
00978 <span class="comment"></span>
00979 <span class="comment">Return Value:</span>
00980 <span class="comment"></span>
00981 <span class="comment">    TRUE if we found a range, FALSE otherwise.</span>
00982 <span class="comment"></span>
00983 <span class="comment">--*/</span>
00984 {
00985     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00986     UCHAR userFlagsMask = 0;
00987 
00988     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00989 
00990     <span class="comment">//</span>
00991     <span class="comment">// If we are asking for zero ports then trivially succeed with the minimum</span>
00992     <span class="comment">// value</span>
00993     <span class="comment">//</span>
00994 
00995     <span class="keywordflow">if</span> (State-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o5">CurrentAlternative</a>-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o2">Length</a> == 0) {
00996         State-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o1">End</a> = State-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o0">Start</a>;
00997         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00998     }
00999 
01000     <span class="comment">//</span>
01001     <span class="comment">// For legacy requests from IoAssignResources (directly or by way of</span>
01002     <span class="comment">// HalAssignSlotResources) or IoReportResourceUsage we consider preallocated</span>
01003     <span class="comment">// resources to be available for backward compatibility reasons.</span>
01004     <span class="comment">//</span>
01005     <span class="comment">// If we are allocating a devices boot config then we consider all other</span>
01006     <span class="comment">// boot configs to be available.</span>
01007     <span class="comment">//</span>
01008 
01009     <span class="keywordflow">if</span> (State-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o4">Entry</a>-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o4">RequestSource</a> == <a class="code" href="../../d6/d9/pnp_8h.html#a174a126">ArbiterRequestLegacyReported</a>
01010         || State-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o4">Entry</a>-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o4">RequestSource</a> == <a class="code" href="../../d6/d9/pnp_8h.html#a174a128">ArbiterRequestLegacyAssigned</a>
01011         || State-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o4">Entry</a>-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o5">Flags</a> &amp; <a class="code" href="../../d6/d9/pnp_8h.html#a8">ARBITER_FLAG_BOOT_CONFIG</a>) {
01012 
01013         userFlagsMask = <a class="code" href="../../d9/d8/arbiter_8h.html#a13">ARBITER_RANGE_BOOT_ALLOCATED</a>;
01014     }
01015 
01016     <span class="comment">//</span>
01017     <span class="comment">// Try to satisfy the request</span>
01018     <span class="comment">//</span>
01019 
01020     <span class="keywordflow">while</span> (State-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o2">CurrentMinimum</a> &lt;= State-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o3">CurrentMaximum</a>) {
01021 
01022         <span class="comment">//</span>
01023         <span class="comment">// Select the first free alternative from the current alternative</span>
01024         <span class="comment">//</span>
01025 
01026         status = <a class="code" href="../../d2/d5/range_8c.html#a22">RtlFindRange</a>(
01027                      Arbiter-&gt;PossibleAllocation,
01028                      State-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o2">CurrentMinimum</a>,
01029                      State-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o3">CurrentMaximum</a>,
01030                      State-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o5">CurrentAlternative</a>-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o2">Length</a>,
01031                      State-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o5">CurrentAlternative</a>-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o3">Alignment</a>,
01032                      State-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o5">CurrentAlternative</a>-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o5">Flags</a> &amp;
01033                         <a class="code" href="../../d9/d8/arbiter_8h.html#a6">ARBITER_ALTERNATIVE_FLAG_SHARED</a> ?
01034                             RTL_RANGE_LIST_SHARED_OK : 0,
01035                      userFlagsMask,
01036                      Arbiter-&gt;ConflictCallbackContext,
01037                      Arbiter-&gt;ConflictCallback,
01038                      &amp;State-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o0">Start</a>
01039                      );
01040 
01041 
01042         <span class="comment">//</span>
01043         <span class="comment">// Did we find a range and if not can we override any conflict</span>
01044         <span class="comment">//</span>
01045         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)
01046         || Arbiter-&gt;OverrideConflict(Arbiter, State)) {
01047 
01048             State-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o1">End</a> = State-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o0">Start</a> + State-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o5">CurrentAlternative</a>-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o2">Length</a> - 1;
01049 
01050             <span class="comment">//</span>
01051             <span class="comment">// Check if the aliases are available</span>
01052             <span class="comment">//</span>
01053             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/pnpmemio_8c.html#a26">IopPortIsAliasedRangeAvailable</a>(Arbiter, State)) {
01054 
01055                 <span class="comment">//</span>
01056                 <span class="comment">// We found a suitable range so return</span>
01057                 <span class="comment">//</span>
01058 
01059                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01060 
01061             } <span class="keywordflow">else</span> {
01062 
01063                 <span class="comment">//</span>
01064                 <span class="comment">// This range's aliases arn't available so try the next range</span>
01065                 <span class="comment">//</span>
01066 
01067                 State-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o0">Start</a> += State-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o5">CurrentAlternative</a>-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o2">Length</a>;
01068 
01069                 <span class="keywordflow">continue</span>;
01070             }
01071         } <span class="keywordflow">else</span> {
01072 
01073             <span class="comment">//</span>
01074             <span class="comment">// We couldn't find a base range</span>
01075             <span class="comment">//</span>
01076 
01077             <span class="keywordflow">break</span>;
01078         }
01079     }
01080 
01081     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01082 }
01083 
01084 
01085 
01086 BOOLEAN
<a name="l01087"></a><a class="code" href="../../d3/d1/pnpmemio_8c.html#a13">01087</a> <a class="code" href="../../d3/d1/pnpmemio_8c.html#a13">IopPortGetNextAlias</a>(
01088     ULONG IoDescriptorFlags,
01089     ULONGLONG LastAlias,
01090     PULONGLONG NextAlias
01091     )
01092 <span class="comment">/*++</span>
01093 <span class="comment"></span>
01094 <span class="comment">Routine Description:</span>
01095 <span class="comment"></span>
01096 <span class="comment">    This routine calculates the next alias of an IO port up to MAX_ALIAS_PORT.</span>
01097 <span class="comment"></span>
01098 <span class="comment">Arguments:</span>
01099 <span class="comment"></span>
01100 <span class="comment">    IoDescriptorFlags - The flags from the requirement descriptor indicating the</span>
01101 <span class="comment">        type of alias if any.</span>
01102 <span class="comment"></span>
01103 <span class="comment">    LastAlias - The alias previous to this one.</span>
01104 <span class="comment"></span>
01105 <span class="comment">    NextAlias - Point to where the next alias should be returned</span>
01106 <span class="comment"></span>
01107 <span class="comment">Return Value:</span>
01108 <span class="comment"></span>
01109 <span class="comment">    TRUE if we found an alias, FALSE otherwise.</span>
01110 <span class="comment"></span>
01111 <span class="comment">--*/</span>
01112 
01113 {
01114     ULONGLONG next;
01115 
01116     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01117 
01118     <span class="keywordflow">if</span> (IoDescriptorFlags &amp; CM_RESOURCE_PORT_10_BIT_DECODE) {
01119         next = LastAlias + (1 &lt;&lt; 10);
01120     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IoDescriptorFlags &amp; CM_RESOURCE_PORT_12_BIT_DECODE) {
01121         next = LastAlias + (1 &lt;&lt; 12);
01122     } <span class="keywordflow">else</span> {
01123 
01124         <span class="comment">// BUGBUG - should CM_RESOURCE_PORT_16_BIT_DECODE be set?</span>
01125         <span class="comment">//</span>
01126         <span class="comment">// There are no aliases</span>
01127         <span class="comment">//</span>
01128 
01129         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01130     }
01131 
01132     <span class="comment">//</span>
01133     <span class="comment">// Check that we are below the maximum aliased port</span>
01134     <span class="comment">//</span>
01135 
01136     <span class="keywordflow">if</span> (next &gt; <a class="code" href="../../d3/d1/pnpmemio_8c.html#a2">MAX_ALIAS_PORT</a>) {
01137         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01138     } <span class="keywordflow">else</span> {
01139         *NextAlias = next;
01140         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01141     }
01142 }
01143 
01144 
01145 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01146"></a><a class="code" href="../../d3/d1/pnpmemio_8c.html#a22">01146</a> <a class="code" href="../../d3/d1/pnpmemio_8c.html#a22">IopPortAddAllocation</a>(
01147     IN PARBITER_INSTANCE Arbiter,
01148     IN <a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html">PARBITER_ALLOCATION_STATE</a> State
01149     )
01150 
01151 <span class="comment">/*++</span>
01152 <span class="comment"></span>
01153 <span class="comment">Routine Description:</span>
01154 <span class="comment"></span>
01155 <span class="comment">    This routine is called from AllocateEntry once we have found a possible</span>
01156 <span class="comment">    solution (State-&gt;Start - State-&gt;End).  It adds the ranges that will not be</span>
01157 <span class="comment">    available if we commit to this solution to Arbiter-&gt;PossibleAllocation.</span>
01158 <span class="comment"></span>
01159 <span class="comment">Arguments:</span>
01160 <span class="comment"></span>
01161 <span class="comment">    Arbiter - The instance data of the arbiter who was called.</span>
01162 <span class="comment"></span>
01163 <span class="comment">    State - The state of the current arbitration.</span>
01164 <span class="comment"></span>
01165 <span class="comment">Return Value:</span>
01166 <span class="comment"></span>
01167 <span class="comment">    None.</span>
01168 <span class="comment"></span>
01169 <span class="comment">--*/</span>
01170 
01171 {
01172     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01173     ULONGLONG alias;
01174     BOOLEAN isAlias;
01175 
01176     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01177 
01178     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Arbiter);
01179     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(State);
01180 
01181     status = <a class="code" href="../../d2/d5/range_8c.html#a16">RtlAddRange</a>(Arbiter-&gt;PossibleAllocation,
01182                  State-&gt;Start,
01183                  State-&gt;End,
01184                  State-&gt;RangeAttributes,
01185                  RTL_RANGE_LIST_ADD_IF_CONFLICT +
01186                     (State-&gt;CurrentAlternative-&gt;Flags &amp; <a class="code" href="../../d9/d8/arbiter_8h.html#a6">ARBITER_ALTERNATIVE_FLAG_SHARED</a>
01187                         ? RTL_RANGE_LIST_ADD_SHARED : 0),
01188                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01189                  State-&gt;Entry-&gt;PhysicalDeviceObject
01190                  );
01191 
01192     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status));
01193 
01194     <span class="comment">//</span>
01195     <span class="comment">// Add any aliases</span>
01196     <span class="comment">//</span>
01197 
01198     alias = State-&gt;Start;
01199     <a class="code" href="../../d9/d8/arbiter_8h.html#a1">ARB_PRINT</a>(2, (<span class="stringliteral">"Adding aliases\n"</span>));
01200 
01201     <span class="keywordflow">while</span> (<a class="code" href="../../d3/d1/pnpmemio_8c.html#a13">IopPortGetNextAlias</a>(State-&gt;CurrentAlternative-&gt;Descriptor-&gt;Flags,
01202                              alias,
01203                              &amp;alias)) {
01204 
01205         status = <a class="code" href="../../d2/d5/range_8c.html#a16">RtlAddRange</a>(Arbiter-&gt;PossibleAllocation,
01206                      alias,
01207                      alias + State-&gt;CurrentAlternative-&gt;Length - 1,
01208                      (UCHAR) (State-&gt;RangeAttributes | <a class="code" href="../../d9/d8/arbiter_8h.html#a14">ARBITER_RANGE_ALIAS</a>),
01209                      RTL_RANGE_LIST_ADD_IF_CONFLICT +
01210                         (State-&gt;CurrentAlternative-&gt;Flags &amp; <a class="code" href="../../d9/d8/arbiter_8h.html#a6">ARBITER_ALTERNATIVE_FLAG_SHARED</a>
01211                             ? RTL_RANGE_LIST_ADD_SHARED : 0),
01212                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01213                      State-&gt;Entry-&gt;PhysicalDeviceObject
01214                      );
01215 
01216         <span class="comment">//</span>
01217         <span class="comment">// We have already checked if these ranges are available</span>
01218         <span class="comment">// so we should not fail...</span>
01219         <span class="comment">//</span>
01220 
01221         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status));
01222     }
01223 }
01224 
01225 
01226 BOOLEAN
<a name="l01227"></a><a class="code" href="../../d3/d1/pnpmemio_8c.html#a26">01227</a> <a class="code" href="../../d3/d1/pnpmemio_8c.html#a26">IopPortIsAliasedRangeAvailable</a>(
01228     PARBITER_INSTANCE Arbiter,
01229     <a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html">PARBITER_ALLOCATION_STATE</a> State
01230     )
01231 
01232 <span class="comment">/*++</span>
01233 <span class="comment"></span>
01234 <span class="comment">Routine Description:</span>
01235 <span class="comment"></span>
01236 <span class="comment">    This routine determines if the range (Start-(Length-1)) is available taking</span>
01237 <span class="comment">    into account any aliases.</span>
01238 <span class="comment"></span>
01239 <span class="comment">Arguments:</span>
01240 <span class="comment"></span>
01241 <span class="comment">    Arbiter - The instance data of the arbiter who was called.</span>
01242 <span class="comment"></span>
01243 <span class="comment">    State - The state of the current arbitration.</span>
01244 <span class="comment"></span>
01245 <span class="comment">Return Value:</span>
01246 <span class="comment"></span>
01247 <span class="comment">    TRUE if the range is available, FALSE otherwise.</span>
01248 <span class="comment"></span>
01249 <span class="comment">--*/</span>
01250 
01251 {
01252     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01253     ULONGLONG alias = State-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o0">Start</a>;
01254     BOOLEAN aliasAvailable;
01255     UCHAR userFlagsMask = 0;
01256 
01257     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01258 
01259 <span class="preprocessor">#if defined(BUGFEST_HACKS)</span>
01260 <span class="preprocessor"></span>    <span class="comment">//</span>
01261     <span class="comment">// For the purposes of the Bug^H^H^HPlugFest don't mind is aliases conflict</span>
01262     <span class="comment">// with any devices but still add them...</span>
01263     <span class="comment">//</span>
01264     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01265 <span class="preprocessor">#endif</span>
01266 <span class="preprocessor"></span>
01267     <span class="comment">//</span>
01268     <span class="comment">// For legacy requests from IoAssignResources (directly or by way of</span>
01269     <span class="comment">// HalAssignSlotResources) or IoReportResourceUsage we consider preallocated</span>
01270     <span class="comment">// resources to be available for backward compatibility reasons.</span>
01271     <span class="comment">//</span>
01272     <span class="keywordflow">if</span> (State-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o4">Entry</a>-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o4">RequestSource</a> == <a class="code" href="../../d6/d9/pnp_8h.html#a174a126">ArbiterRequestLegacyReported</a>
01273         || State-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o4">Entry</a>-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o4">RequestSource</a> == <a class="code" href="../../d6/d9/pnp_8h.html#a174a128">ArbiterRequestLegacyAssigned</a>) {
01274 
01275         userFlagsMask |= <a class="code" href="../../d9/d8/arbiter_8h.html#a13">ARBITER_RANGE_BOOT_ALLOCATED</a>;
01276     }
01277 
01278     <span class="keywordflow">while</span> (<a class="code" href="../../d3/d1/pnpmemio_8c.html#a13">IopPortGetNextAlias</a>(State-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o5">CurrentAlternative</a>-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o6">Descriptor</a>-&gt;Flags,
01279                              alias,
01280                              &amp;alias)) {
01281 
01282         status = <a class="code" href="../../d2/d5/range_8c.html#a21">RtlIsRangeAvailable</a>(
01283                      Arbiter-&gt;PossibleAllocation,
01284                      alias,
01285                      alias + State-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o5">CurrentAlternative</a>-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o2">Length</a> - 1,
01286                      State-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o5">CurrentAlternative</a>-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o5">Flags</a> &amp; <a class="code" href="../../d9/d8/arbiter_8h.html#a6">ARBITER_ALTERNATIVE_FLAG_SHARED</a> ?
01287                         RTL_RANGE_LIST_SHARED_OK : 0,
01288                      userFlagsMask,
01289                      Arbiter-&gt;ConflictCallbackContext,
01290                      Arbiter-&gt;ConflictCallback,
01291                      &amp;aliasAvailable
01292                      );
01293 
01294         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status));
01295 
01296         <span class="keywordflow">if</span> (!aliasAvailable) {
01297 
01298             <a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html">ARBITER_ALLOCATION_STATE</a> tempState;
01299 
01300             <span class="comment">//</span>
01301             <span class="comment">// Check if we allow this conflict by calling OverrideConflict -</span>
01302             <span class="comment">// we will need to falsify ourselves an allocation state first</span>
01303             <span class="comment">//</span>
01304             <span class="comment">// BUGBUG - this works but relies on knowing what OverrideConflict</span>
01305             <span class="comment">// looks at.  A better fix invloves storing the aliases in another</span>
01306             <span class="comment">// list but this it too much of a change for Win2k</span>
01307             <span class="comment">//</span>
01308 
01309             RtlCopyMemory(&amp;tempState, State, <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html">ARBITER_ALLOCATION_STATE</a>));
01310 
01311             tempState.<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o2">CurrentMinimum</a> = alias;
01312             tempState.<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o3">CurrentMaximum</a> = alias + State-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o5">CurrentAlternative</a>-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o2">Length</a> - 1;
01313 
01314             <span class="keywordflow">if</span> (Arbiter-&gt;OverrideConflict(Arbiter, &amp;tempState)) {
01315                 <span class="comment">//</span>
01316                 <span class="comment">// We decided this conflict was ok so contine checking the rest</span>
01317                 <span class="comment">// of the aliases</span>
01318                 <span class="comment">//</span>
01319 
01320                 <span class="keywordflow">continue</span>;
01321 
01322             }
01323 
01324             <span class="comment">//</span>
01325             <span class="comment">// An alias isn't available - get another possibility</span>
01326             <span class="comment">//</span>
01327 
01328             <a class="code" href="../../d9/d8/arbiter_8h.html#a1">ARB_PRINT</a>(2,
01329                         (<span class="stringliteral">"\t\tAlias 0x%x-0x%x not available\n"</span>,
01330                         alias,
01331                         alias + State-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o5">CurrentAlternative</a>-&gt;<a class="code" href="../../d6/d7/struct__ARBITER__ALTERNATIVE.html#o2">Length</a> - 1
01332                         ));
01333 
01334             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01335         }
01336     }
01337 
01338     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01339 }
01340 
01341 BOOLEAN
<a name="l01342"></a><a class="code" href="../../d3/d1/pnpmemio_8c.html#a15">01342</a> <a class="code" href="../../d3/d1/pnpmemio_8c.html#a15">IopMemFindSuitableRange</a>(
01343     PARBITER_INSTANCE Arbiter,
01344     <a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html">PARBITER_ALLOCATION_STATE</a> State
01345     )
01346 <span class="comment">/*++</span>
01347 <span class="comment"></span>
01348 <span class="comment">Routine Description:</span>
01349 <span class="comment"></span>
01350 <span class="comment">    This routine is called from AllocateEntry once we have decided where we want</span>
01351 <span class="comment">    to allocate from.  It tries to find a free range that matches the</span>
01352 <span class="comment">    requirements in State while restricting its possible solutions to the range</span>
01353 <span class="comment">    State-&gt;Start to State-&gt;CurrentMaximum.  On success State-&gt;Start and</span>
01354 <span class="comment">    State-&gt;End represent this range.  Conflicts between boot configs are allowed</span>
01355 <span class="comment"></span>
01356 <span class="comment">Arguments:</span>
01357 <span class="comment"></span>
01358 <span class="comment">    Arbiter - The instance data of the arbiter who was called.</span>
01359 <span class="comment"></span>
01360 <span class="comment">    State - The state of the current arbitration.</span>
01361 <span class="comment"></span>
01362 <span class="comment">Return Value:</span>
01363 <span class="comment"></span>
01364 <span class="comment">    TRUE if we found a range, FALSE otherwise.</span>
01365 <span class="comment"></span>
01366 <span class="comment">--*/</span>
01367 {
01368     <span class="comment">//</span>
01369     <span class="comment">// If this was a boot config then consider other boot configs to be</span>
01370     <span class="comment">// available</span>
01371     <span class="comment">//</span>
01372 
01373     <span class="keywordflow">if</span> (State-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o4">Entry</a>-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o5">Flags</a> &amp; <a class="code" href="../../d6/d9/pnp_8h.html#a8">ARBITER_FLAG_BOOT_CONFIG</a>) {
01374         State-&gt;<a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html#o10">RangeAvailableAttributes</a> |= <a class="code" href="../../d9/d8/arbiter_8h.html#a13">ARBITER_RANGE_BOOT_ALLOCATED</a>;
01375     }
01376 
01377     <span class="comment">//</span>
01378     <span class="comment">// Do the default thing</span>
01379     <span class="comment">//</span>
01380 
01381     <span class="keywordflow">return</span> <a class="code" href="../../d9/d8/arbiter_8h.html#a83">ArbFindSuitableRange</a>(Arbiter, State);
01382 }
01383 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:19 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
