<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: client.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>client.c</h1><a href="../../d3/d8/client_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/**************************************************************************\</span>
00002 <span class="comment">* Module Name: client.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Client/Server call related routines.</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 04-Dec-1990 SMeans    Created.</span>
00010 <span class="comment">\**************************************************************************/</span>
00011 
00012 <span class="preprocessor">#include "<a class="code" href="../../d7/d3/w32_2ntuser_2client_2precomp_8h.html">precomp.h</a>"</span>
00013 <span class="preprocessor">#pragma hdrstop</span>
00014 <span class="preprocessor"></span>
00015 <span class="preprocessor">#include "kbd.h"</span>
00016 
00017 <span class="comment">/*</span>
00018 <span class="comment"> *  NOTE --  this table must match the FNID list in user.h.  It provides a WOWCLASS for each FNID.</span>
00019 <span class="comment"> */</span>
00020 
<a name="l00021"></a><a class="code" href="../../d3/d8/client_8c.html#a7">00021</a> <span class="keywordtype">int</span> <a class="code" href="../../d3/d8/client_8c.html#a7">aiClassWow</a>[] = {
00022     WOWCLASS_SCROLLBAR,
00023     WOWCLASS_ICONTITLE,
00024     WOWCLASS_MENU,
00025     WOWCLASS_DESKTOP,
00026     WOWCLASS_WIN16,
00027     WOWCLASS_BUTTON,
00028     WOWCLASS_COMBOBOX,
00029     WOWCLASS_COMBOLBOX,
00030     WOWCLASS_DIALOG,
00031     WOWCLASS_EDIT,
00032     WOWCLASS_LISTBOX,
00033     WOWCLASS_MDICLIENT,
00034     WOWCLASS_STATIC,
00035     WOWCLASS_WIN16,    <span class="comment">// 2A7</span>
00036     WOWCLASS_WIN16,
00037     WOWCLASS_WIN16,
00038     WOWCLASS_WIN16,
00039     WOWCLASS_WIN16,
00040     WOWCLASS_WIN16,
00041     WOWCLASS_WIN16,
00042     WOWCLASS_WIN16,
00043     WOWCLASS_WIN16,     <span class="comment">// 2b0</span>
00044     WOWCLASS_WIN16,
00045     WOWCLASS_WIN16,
00046     WOWCLASS_WIN16,
00047     WOWCLASS_SWITCHWND
00048 
00049     };
00050 
00051 HBITMAP <a class="code" href="../../d4/d9/clres_8c.html#a101">WOWLoadBitmapA</a>(HINSTANCE hmod, LPCSTR lpName, LPBYTE pResData, DWORD cbResData);
00052 HMENU <a class="code" href="../../d4/d9/clres_8c.html#a103">WowServerLoadCreateMenu</a>(HANDLE hMod, LPTSTR lpName, CONST LPMENUTEMPLATE pmt,
00053     DWORD cb, BOOL fCallClient);
00054 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d3/d8/handles_8c.html#a13">GetFullUserHandle</a>(WORD wHandle);
00055 
00056 <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d3/d8/client_8c.html#a28">GetClipboardCodePage</a>(LCID, LCTYPE);
00057 
00058 <span class="keyword">extern</span> HANDLE <a class="code" href="../../d4/d9/clres_8c.html#a100">WOWFindResourceExWCover</a>(HANDLE hmod, LPCWSTR rt, LPCWSTR lpUniName, WORD LangId);
00059 
00060 <span class="keyword">extern</span> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d1/d1/bench_8c.html#a0">APIENTRY</a> <a class="code" href="../../d3/d8/client_8c.html#a30">EnableEUDC</a>();
00061 
<a name="l00062"></a><a class="code" href="../../d3/d8/client_8c.html#a8">00062</a> CONST WCHAR <a class="code" href="../../d3/d8/client_8c.html#a8">szKLKey</a>[]  = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Control\\Keyboard Layouts\\"</span>;
<a name="l00063"></a><a class="code" href="../../d3/d8/client_8c.html#a9">00063</a> CONST WCHAR <a class="code" href="../../d3/d8/client_8c.html#a9">szKLFile</a>[] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Layout File"</span>;
<a name="l00064"></a><a class="code" href="../../d3/d8/client_8c.html#a10">00064</a> CONST WCHAR <a class="code" href="../../d3/d8/client_8c.html#a10">szKLAttributes</a>[] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Attributes"</span>;
<a name="l00065"></a><a class="code" href="../../d3/d8/client_8c.html#a11">00065</a> CONST WCHAR <a class="code" href="../../d3/d8/client_8c.html#a11">szKLId</a>[]   = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Layout ID"</span>;
<a name="l00066"></a><a class="code" href="../../d3/d8/client_8c.html#a0">00066</a> <span class="preprocessor">#define NSZKLKEY   (sizeof szKLKey + 16)</span>
00067 <span class="preprocessor"></span>
00068 
<a name="l00069"></a><a class="code" href="../../d3/d8/client_8c.html#a12">00069</a> CONST LPWSTR <a class="code" href="../../d3/d8/client_8c.html#a12">pwszKLLibSafety</a>     = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"kbdus.dll"</span>;
<a name="l00070"></a><a class="code" href="../../d3/d8/client_8c.html#a13">00070</a> CONST <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>   <a class="code" href="../../d3/d8/client_8c.html#a13">wKbdLocaleSafety</a>    = 0x04090409;
<a name="l00071"></a><a class="code" href="../../d3/d8/client_8c.html#a14">00071</a> CONST LPWSTR <a class="code" href="../../d3/d8/client_8c.html#a14">pwszKLLibSafetyJPN</a>  = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"kbdjpn.dll"</span>;
<a name="l00072"></a><a class="code" href="../../d3/d8/client_8c.html#a15">00072</a> CONST <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>   <a class="code" href="../../d3/d8/client_8c.html#a15">wKbdLocaleSafetyJPN</a> = 0x04110411;
<a name="l00073"></a><a class="code" href="../../d3/d8/client_8c.html#a16">00073</a> CONST LPWSTR <a class="code" href="../../d3/d8/client_8c.html#a16">pwszKLLibSafetyKOR</a>  = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"kbdkor.dll"</span>;
<a name="l00074"></a><a class="code" href="../../d3/d8/client_8c.html#a17">00074</a> CONST <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>   <a class="code" href="../../d3/d8/client_8c.html#a17">wKbdLocaleSafetyKOR</a> = 0x04120412;
00075 
<a name="l00076"></a><a class="code" href="../../d3/d8/client_8c.html#a1">00076</a> <span class="preprocessor">#define CCH_KL_LIBNAME 256</span>
<a name="l00077"></a><a class="code" href="../../d3/d8/client_8c.html#a2">00077</a> <span class="preprocessor"></span><span class="preprocessor">#define CCH_KL_ID 16</span>
00078 <span class="preprocessor"></span>
<a name="l00079"></a><a class="code" href="../../d3/d8/client_8c.html#a18">00079</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d8/client_8c.html#a18">gfLogonProcess</a>;
00080 
<a name="l00081"></a><a class="code" href="../../d3/d8/client_8c.html#a19">00081</a> UNICODE_STRING <a class="code" href="../../d3/d8/client_8c.html#a19">strRootDirectory</a>;
00082 
00083 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d3/d8/client_8c.html#a31">CheckValidLayoutName</a>( LPWSTR lpszName );
00084 
<a name="l00085"></a><a class="code" href="../../d3/d8/client_8c.html#a32">00085</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d8/client_8c.html#a32">WOWModuleUnload</a>(HANDLE hModule) {
00086     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a174">NtUserCallOneParam</a>((ULONG_PTR)hModule,
00087                                     SFI__WOWMODULEUNLOAD);
00088 }
00089 
<a name="l00090"></a><a class="code" href="../../d3/d8/client_8c.html#a33">00090</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d8/client_8c.html#a33">WOWCleanup</a>(HANDLE hInstance, DWORD hTaskWow) {
00091     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a180">NtUserCallTwoParam</a>((ULONG_PTR)hInstance,
00092                                     (ULONG_PTR)hTaskWow,
00093                                     SFI__WOWCLEANUP);
00094 }
00095 
00096 
00097 <span class="comment">/***************************************************************************\</span>
00098 <span class="comment">* BringWindowToTop (API)</span>
00099 <span class="comment">*</span>
00100 <span class="comment">*</span>
00101 <span class="comment">* History:</span>
00102 <span class="comment">* 11-Jul-1991 DarrinM   Ported from Win 3.1 sources.</span>
00103 <span class="comment">\***************************************************************************/</span>
00104 
<a name="l00105"></a><a class="code" href="../../d3/d8/client_8c.html#a34">00105</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d8/client_8c.html#a34">BringWindowToTop</a>(
00106     HWND hwnd)
00107 {
00108     <span class="keywordflow">return</span> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a115">NtUserSetWindowPos</a>(hwnd,
00109                               HWND_TOP,
00110                               0,
00111                               0,
00112                               0,
00113                               0,
00114                               SWP_NOSIZE | SWP_NOMOVE);
00115 }
00116 
<a name="l00117"></a><a class="code" href="../../d3/d8/client_8c.html#a35">00117</a> HWND <a class="code" href="../../d3/d8/client_8c.html#a35">ChildWindowFromPoint</a>(
00118     HWND  hwndParent,
00119     POINT point)
00120 {
00121     <span class="comment">/*</span>
00122 <span class="comment">     * Cool Hack Alert... Corel Ventura 5.0</span>
00123 <span class="comment">     * Dies after it calls ChildWindowFromPoint, and</span>
00124 <span class="comment">     * the combobox doesn't have its edit window at 1,1...</span>
00125 <span class="comment">     */</span>
00126     <span class="keywordflow">if</span> ((point.x == 1) &amp;&amp; (point.y == 1)) {
00127         <a class="code" href="../../d7/d9/structtagCBox.html">PCBOX</a> pcCombo;
00128         <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
00129 
00130         pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hwndParent);
00131         <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00132             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00133 
00134         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a593">WFWIN40COMPAT</a>)   &amp;&amp;
00135             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a232">GETFNID</a>(pwnd) == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a201">FNID_COMBOBOX</a> &amp;&amp;
00136             <a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a16">TestWindowProcess</a>(pwnd) &amp;&amp;
00137             ((pcCombo = ((<a class="code" href="../../d0/d1/structtagCOMBOWND.html">PCOMBOWND</a>)pwnd)-&gt;pcbox) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00138             !(pcCombo-&gt;fNoEdit)) {
00139 
00140             RIPMSG0(RIP_WARNING, <span class="stringliteral">"ChildWindowFromPoint: Combobox @1,1. Returning spwndEdit"</span>);
00141             <span class="keywordflow">return</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pcCombo-&gt;spwndEdit);
00142         }
00143 
00144     }
00145 
00146     <span class="keywordflow">return</span> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a151">NtUserChildWindowFromPointEx</a>(hwndParent, point, 0);
00147 }
00148 
00149 
<a name="l00150"></a><a class="code" href="../../d3/d8/client_8c.html#a36">00150</a> HICON <a class="code" href="../../d3/d8/client_8c.html#a36">CopyIcon</a>(
00151     HICON hicon)
00152 {
00153     HICON    hIconT = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00154     ICONINFO ii;
00155 
00156     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/clres_8c.html#a61">GetIconInfo</a>(hicon, &amp;ii)) {
00157         hIconT = <a class="code" href="../../d4/d9/clres_8c.html#a60">CreateIconIndirect</a>(&amp;ii);
00158 
00159         DeleteObject(ii.hbmMask);
00160 
00161         <span class="keywordflow">if</span> (ii.hbmColor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00162             DeleteObject(ii.hbmColor);
00163     }
00164 
00165     <span class="keywordflow">return</span> hIconT;
00166 }
00167 
00168 <span class="comment">/***************************************************************************\</span>
00169 <span class="comment">* AdjustWindowRect (API)</span>
00170 <span class="comment">*</span>
00171 <span class="comment">* History:</span>
00172 <span class="comment">* 01-Jul-1991 MikeKe    Created.</span>
00173 <span class="comment">\***************************************************************************/</span>
00174 
<a name="l00175"></a><a class="code" href="../../d3/d8/client_8c.html#a37">00175</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d3/d8/client_8c.html#a37">AdjustWindowRect</a>(
00176     LPRECT lprc,
00177     DWORD  style,
00178     BOOL   fMenu)
00179 {
00180     <a class="code" href="../../d1/d0/inc_2user_8h.html#a848">ConnectIfNecessary</a>();
00181 
00182     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/inc_2user_8h.html#a1195">_AdjustWindowRectEx</a>(lprc, style, fMenu, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
00183 }
00184 
00185 <span class="comment">/***************************************************************************\</span>
00186 <span class="comment">* TranslateAcceleratorA/W</span>
00187 <span class="comment">*</span>
00188 <span class="comment">* Put here so we can check for NULL on client side, and before validation</span>
00189 <span class="comment">* for both DOS and NT cases.</span>
00190 <span class="comment">*</span>
00191 <span class="comment">* 05-29-91 ScottLu Created.</span>
00192 <span class="comment">* 01-05-93 IanJa   Unicode/ANSI.</span>
00193 <span class="comment">\***************************************************************************/</span>
00194 
<a name="l00195"></a><a class="code" href="../../d3/d8/client_8c.html#a38">00195</a> <span class="keywordtype">int</span> WINAPI <a class="code" href="../../d3/d8/client_8c.html#a38">TranslateAcceleratorW</a>(
00196     HWND hwnd,
00197     HACCEL hAccel,
00198     LPMSG lpMsg)
00199 {
00200     <span class="comment">/*</span>
00201 <span class="comment">     * NULL pwnd is a valid case - since this is called from the center</span>
00202 <span class="comment">     * of main loops, pwnd == NULL happens all the time, and we shouldn't</span>
00203 <span class="comment">     * generate a warning because of it.</span>
00204 <span class="comment">     */</span>
00205     <span class="keywordflow">if</span> (hwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00206         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00207 
00208     <span class="comment">/*</span>
00209 <span class="comment">     * We only need to pass key-down messages to the server,</span>
00210 <span class="comment">     * everything else ends up returning 0/FALSE from this function.</span>
00211 <span class="comment">     */</span>
00212     <span class="keywordflow">switch</span> (lpMsg-&gt;message) {
00213 
00214     <span class="keywordflow">case</span> WM_KEYDOWN:
00215     <span class="keywordflow">case</span> WM_SYSKEYDOWN:
00216     <span class="keywordflow">case</span> WM_CHAR:
00217     <span class="keywordflow">case</span> WM_SYSCHAR:
00218         <span class="keywordflow">return</span> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a112">NtUserTranslateAccelerator</a>(hwnd, hAccel, lpMsg);
00219 
00220     <span class="keywordflow">default</span>:
00221         <span class="keywordflow">return</span> 0;
00222     }
00223 }
00224 
<a name="l00225"></a><a class="code" href="../../d3/d8/client_8c.html#a39">00225</a> <span class="keywordtype">int</span> WINAPI <a class="code" href="../../d3/d8/client_8c.html#a39">TranslateAcceleratorA</a>(
00226     HWND   hwnd,
00227     HACCEL hAccel,
00228     LPMSG  lpMsg)
00229 {
00230     WPARAM wParamT;
00231     <span class="keywordtype">int</span> iT;
00232 
00233     <span class="comment">/*</span>
00234 <span class="comment">     * NULL pwnd is a valid case - since this is called from the center</span>
00235 <span class="comment">     * of main loops, pwnd == NULL happens all the time, and we shouldn't</span>
00236 <span class="comment">     * generate a warning because of it.</span>
00237 <span class="comment">     */</span>
00238     <span class="keywordflow">if</span> (hwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00239         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00240 
00241     <span class="comment">/*</span>
00242 <span class="comment">     * We only need to pass key-down messages to the server,</span>
00243 <span class="comment">     * everything else ends up returning 0/FALSE from this function.</span>
00244 <span class="comment">     */</span>
00245     <span class="keywordflow">switch</span> (lpMsg-&gt;message) {
00246 
00247     <span class="keywordflow">case</span> WM_KEYDOWN:
00248     <span class="keywordflow">case</span> WM_SYSKEYDOWN:
00249     <span class="keywordflow">case</span> WM_CHAR:
00250     <span class="keywordflow">case</span> WM_SYSCHAR:
00251         wParamT = lpMsg-&gt;wParam;
00252         <a class="code" href="../../d5/d6/chartran_8c.html#a5">RtlMBMessageWParamCharToWCS</a>(lpMsg-&gt;message, &amp;(lpMsg-&gt;wParam));
00253         iT = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a112">NtUserTranslateAccelerator</a>(hwnd, hAccel, lpMsg);
00254         lpMsg-&gt;wParam = wParamT;
00255         <span class="keywordflow">return</span> iT;
00256 
00257     <span class="keywordflow">default</span>:
00258         <span class="keywordflow">return</span> 0;
00259     }
00260 }
00261 
00262 <span class="comment">/***************************************************************************\</span>
00263 <span class="comment">* Clipboard functions</span>
00264 <span class="comment">*</span>
00265 <span class="comment">* 11-Oct-1991 mikeke Created.</span>
00266 <span class="comment">\***************************************************************************/</span>
00267 
<a name="l00268"></a><a class="code" href="../../d3/d4/struct__HANDLENODE.html">00268</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d3/d4/struct__HANDLENODE.html">_HANDLENODE</a> {
<a name="l00269"></a><a class="code" href="../../d3/d4/struct__HANDLENODE.html#o0">00269</a>     <span class="keyword">struct </span><a class="code" href="../../d3/d4/struct__HANDLENODE.html">_HANDLENODE</a> *<a class="code" href="../../d3/d4/struct__HANDLENODE.html#o0">pnext</a>;
<a name="l00270"></a><a class="code" href="../../d3/d4/struct__HANDLENODE.html#o1">00270</a>     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>   <a class="code" href="../../d3/d4/struct__HANDLENODE.html#o1">fmt</a>;
<a name="l00271"></a><a class="code" href="../../d3/d4/struct__HANDLENODE.html#o2">00271</a>     HANDLE <a class="code" href="../../d3/d4/struct__HANDLENODE.html#o2">handleServer</a>;
<a name="l00272"></a><a class="code" href="../../d3/d4/struct__HANDLENODE.html#o3">00272</a>     HANDLE <a class="code" href="../../d3/d4/struct__HANDLENODE.html#o3">handleClient</a>;
<a name="l00273"></a><a class="code" href="../../d3/d4/struct__HANDLENODE.html#o4">00273</a>     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>   <a class="code" href="../../d3/d4/struct__HANDLENODE.html#o4">fGlobalHandle</a>;
00274 } <a class="code" href="../../d3/d4/struct__HANDLENODE.html">HANDLENODE</a>;
<a name="l00275"></a><a class="code" href="../../d3/d8/client_8c.html#a21">00275</a> <span class="keyword">typedef</span> <a class="code" href="../../d3/d4/struct__HANDLENODE.html">HANDLENODE</a> *<a class="code" href="../../d3/d4/struct__HANDLENODE.html">PHANDLENODE</a>;
00276 
<a name="l00277"></a><a class="code" href="../../d3/d8/client_8c.html#a22">00277</a> <a class="code" href="../../d3/d8/client_8c.html#a21">PHANDLENODE</a> <a class="code" href="../../d3/d8/client_8c.html#a22">gphn</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00278 
00279 <span class="comment">/***************************************************************************\</span>
00280 <span class="comment">* DeleteClientClipboardHandle</span>
00281 <span class="comment">*</span>
00282 <span class="comment">* 11-Oct-1991 MikeKe    Created.</span>
00283 <span class="comment">\***************************************************************************/</span>
00284 
<a name="l00285"></a><a class="code" href="../../d3/d8/client_8c.html#a40">00285</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d8/client_8c.html#a40">DeleteClientClipboardHandle</a>(
00286     PHANDLENODE phn)
00287 {
00288     LPMETAFILEPICT lpMFP;
00289 
00290     UserAssert(phn-&gt;<a class="code" href="../../d3/d4/struct__HANDLENODE.html#o3">handleClient</a> != (HANDLE)0);
00291 
00292     <span class="keywordflow">switch</span> (phn-&gt;<a class="code" href="../../d3/d4/struct__HANDLENODE.html#o1">fmt</a>) {
00293     <span class="keywordflow">case</span> CF_BITMAP:
00294     <span class="keywordflow">case</span> CF_DSPBITMAP:
00295     <span class="keywordflow">case</span> CF_PALETTE:
00296         <span class="comment">// Does nothing (should remove).</span>
00297         <span class="comment">//</span>
00298         <span class="comment">//GdiDeleteLocalObject((ULONG)hobjDelete);</span>
00299         <span class="keywordflow">break</span>;
00300 
00301     <span class="keywordflow">case</span> CF_METAFILEPICT:
00302     <span class="keywordflow">case</span> CF_DSPMETAFILEPICT:
00303         <a class="code" href="../../d6/d0/usercli_8h.html#a4">USERGLOBALLOCK</a>(phn-&gt;<a class="code" href="../../d3/d4/struct__HANDLENODE.html#o3">handleClient</a>, lpMFP);
00304         <span class="keywordflow">if</span> (lpMFP) {
00305             DeleteMetaFile(lpMFP-&gt;hMF);
00306             <a class="code" href="../../d6/d0/usercli_8h.html#a1">USERGLOBALUNLOCK</a>(phn-&gt;<a class="code" href="../../d3/d4/struct__HANDLENODE.html#o3">handleClient</a>);
00307             <a class="code" href="../../d6/d0/usercli_8h.html#a2">UserGlobalFree</a>(phn-&gt;<a class="code" href="../../d3/d4/struct__HANDLENODE.html#o3">handleClient</a>);
00308         } <span class="keywordflow">else</span> {
00309             RIPMSG1(RIP_ERROR,<span class="stringliteral">"DeleteClientClipboardHandle, can't lock client handle %#p\n"</span>,phn-&gt;<a class="code" href="../../d3/d4/struct__HANDLENODE.html#o3">handleClient</a>);
00310             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00311         }
00312         <span class="keywordflow">break</span>;
00313 
00314     <span class="keywordflow">case</span> CF_ENHMETAFILE:
00315     <span class="keywordflow">case</span> CF_DSPENHMETAFILE:
00316         DeleteEnhMetaFile((HENHMETAFILE)phn-&gt;<a class="code" href="../../d3/d4/struct__HANDLENODE.html#o3">handleClient</a>);
00317         <span class="keywordflow">break</span>;
00318 
00319     <span class="keywordflow">default</span>:
00320     <span class="comment">//case CF_TEXT:</span>
00321     <span class="comment">//case CF_OEMTEXT:</span>
00322     <span class="comment">//case CF_UNICODETEXT:</span>
00323     <span class="comment">//case CF_LOCALE:</span>
00324     <span class="comment">//case CF_DSPTEXT:</span>
00325     <span class="comment">//case CF_DIB:</span>
00326     <span class="comment">//case CF_DIBV5:</span>
00327         <span class="keywordflow">if</span> (phn-&gt;<a class="code" href="../../d3/d4/struct__HANDLENODE.html#o4">fGlobalHandle</a>) {
00328             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a2">UserGlobalFree</a>(phn-&gt;<a class="code" href="../../d3/d4/struct__HANDLENODE.html#o3">handleClient</a>)) {
00329              RIPMSG1(RIP_WARNING, <span class="stringliteral">"CloseClipboard UserGlobalFree(%#p) Failed\n"</span>, phn-&gt;<a class="code" href="../../d3/d4/struct__HANDLENODE.html#o3">handleClient</a>);
00330                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00331             }
00332         } <span class="keywordflow">else</span> {
00333             UserAssert(GlobalFlags(phn-&gt;<a class="code" href="../../d3/d4/struct__HANDLENODE.html#o3">handleClient</a>) == GMEM_INVALID_HANDLE);
00334         }
00335         <span class="keywordflow">break</span>;
00336     }
00337 
00338     <span class="comment">/*</span>
00339 <span class="comment">     * Deleted successfully</span>
00340 <span class="comment">     */</span>
00341     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00342 
00343 }
00344 
00345 <span class="comment">/***************************************************************************\</span>
00346 <span class="comment">* ClientEmptyClipboard</span>
00347 <span class="comment">*</span>
00348 <span class="comment">* Empties the client side clipboard list.</span>
00349 <span class="comment">*</span>
00350 <span class="comment">* 01-15-93 ScottLu      Created.</span>
00351 <span class="comment">\***************************************************************************/</span>
00352 
<a name="l00353"></a><a class="code" href="../../d6/d0/usercli_8h.html#a602">00353</a> <span class="keywordtype">void</span> <a class="code" href="../../d3/d8/client_8c.html#a41">ClientEmptyClipboard</a>(<span class="keywordtype">void</span>)
00354 {
00355     <a class="code" href="../../d3/d8/client_8c.html#a21">PHANDLENODE</a> phnNext;
00356     <a class="code" href="../../d3/d8/client_8c.html#a21">PHANDLENODE</a> phnT;
00357 
00358     RtlEnterCriticalSection(&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a24">gcsClipboard</a>);
00359 
00360     phnT = <a class="code" href="../../d3/d8/client_8c.html#a22">gphn</a>;
00361     <span class="keywordflow">while</span> (phnT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00362         phnNext = phnT-&gt;<a class="code" href="../../d3/d4/struct__HANDLENODE.html#o0">pnext</a>;
00363 
00364         <span class="keywordflow">if</span> (phnT-&gt;<a class="code" href="../../d3/d4/struct__HANDLENODE.html#o3">handleClient</a> != (HANDLE)0)
00365             <a class="code" href="../../d3/d8/client_8c.html#a40">DeleteClientClipboardHandle</a>(phnT);
00366 
00367         LocalFree(phnT);
00368 
00369         phnT = phnNext;
00370     }
00371     <a class="code" href="../../d3/d8/client_8c.html#a22">gphn</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00372 
00373     <span class="comment">/*</span>
00374 <span class="comment">     * Tell wow to cleanup it's clipboard stuff</span>
00375 <span class="comment">     */</span>
00376     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/clglobal_8c.html#a52">pfnWowEmptyClipBoard</a>) {
00377         <a class="code" href="../../d8/d6/ntuser_2client_2globals_8h.html#a62">pfnWowEmptyClipBoard</a>();
00378     }
00379 
00380     RtlLeaveCriticalSection(&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a24">gcsClipboard</a>);
00381 }
00382 
00383 
00384 <span class="comment">/***************************************************************************\</span>
00385 <span class="comment">* GetClipboardData</span>
00386 <span class="comment">*</span>
00387 <span class="comment">* 11-Oct-1991 mikeke Created.</span>
00388 <span class="comment">\***************************************************************************/</span>
00389 
<a name="l00390"></a><a class="code" href="../../d3/d8/client_8c.html#a42">00390</a> HANDLE WINAPI <a class="code" href="../../d3/d8/client_8c.html#a42">GetClipboardData</a>(
00391     UINT uFmt)
00392 {
00393     HANDLE       handleClient;
00394     HANDLE       handleServer;
00395     <a class="code" href="../../d3/d8/client_8c.html#a21">PHANDLENODE</a>  phn;
00396     <a class="code" href="../../d3/d8/client_8c.html#a21">PHANDLENODE</a>  phnNew;
00397     <a class="code" href="../../d6/d5/structtagGETCLIPBDATA.html">GETCLIPBDATA</a> gcd;
00398 
00399     <span class="comment">/*</span>
00400 <span class="comment">     * Get the Server's Data; return if there is no data.</span>
00401 <span class="comment">     */</span>
00402     <span class="keywordflow">if</span> (!(handleServer = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a157">NtUserGetClipboardData</a>(uFmt, &amp;gcd)))
00403         <span class="keywordflow">return</span> (HANDLE)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00404 
00405     <span class="comment">/*</span>
00406 <span class="comment">     * Handle any translation that must be done for text items.  The</span>
00407 <span class="comment">     * format returned will only differ for text items.  Metafile and</span>
00408 <span class="comment">     * Enhanced-Metafiles are handled through GDI for their converstions.</span>
00409 <span class="comment">     * And Bitmap color space convertion also nessesary for CF_BITMAP,</span>
00410 <span class="comment">     * CF_DIB and CF_DIBV5 with color space.</span>
00411 <span class="comment">     */</span>
00412     <span class="keywordflow">if</span> (uFmt != gcd.<a class="code" href="../../d6/d5/structtagGETCLIPBDATA.html#o0">uFmtRet</a>) {
00413 
00414         LPBYTE       lpSrceData = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00415         LPBYTE       lpDestData = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00416         LPBYTE       lptData = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00417         LPDWORD      lpLocale;
00418         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>        uLocale;
00419         <span class="keywordtype">int</span>          iSrce;
00420         <span class="keywordtype">int</span>          iDest;
00421         <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>         uCPage;
00422         <a class="code" href="../../d3/d6/structtagSETCLIPBDATA.html">SETCLIPBDATA</a> scd;
00423         <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>         cbNULL = 0;
00424 
00425         <span class="comment">/*</span>
00426 <span class="comment">         * Make sure handleServer is server-side memory handle</span>
00427 <span class="comment">         */</span>
00428         <span class="keywordflow">if</span> ((gcd.<a class="code" href="../../d6/d5/structtagGETCLIPBDATA.html#o0">uFmtRet</a> == CF_TEXT)        || (gcd.<a class="code" href="../../d6/d5/structtagGETCLIPBDATA.html#o0">uFmtRet</a> == CF_OEMTEXT) ||
00429             (gcd.<a class="code" href="../../d6/d5/structtagGETCLIPBDATA.html#o0">uFmtRet</a> == CF_UNICODETEXT) ||
00430             (gcd.<a class="code" href="../../d6/d5/structtagGETCLIPBDATA.html#o0">uFmtRet</a> == CF_DIB)         || (gcd.<a class="code" href="../../d6/d5/structtagGETCLIPBDATA.html#o0">uFmtRet</a> == CF_DIBV5)) {
00431 
00432             lpSrceData = <a class="code" href="../../d6/d0/usercli_8h.html#a628">CreateLocalMemHandle</a>(handleServer);
00433 
00434             <span class="comment">/*</span>
00435 <span class="comment">             * Allocate space for the converted TEXT data.</span>
00436 <span class="comment">             */</span>
00437             <span class="keywordflow">if</span> (!(iSrce = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)GlobalSize(lpSrceData)))
00438                 <span class="keywordflow">goto</span> AbortDummyHandle;
00439 
00440             <span class="comment">/*</span>
00441 <span class="comment">             * Only CF_xxxTEXT may have locale information.</span>
00442 <span class="comment">             */</span>
00443             <span class="keywordflow">if</span> ((gcd.<a class="code" href="../../d6/d5/structtagGETCLIPBDATA.html#o0">uFmtRet</a> == CF_TEXT) || (gcd.<a class="code" href="../../d6/d5/structtagGETCLIPBDATA.html#o0">uFmtRet</a> == CF_OEMTEXT) ||
00444                 (gcd.<a class="code" href="../../d6/d5/structtagGETCLIPBDATA.html#o0">uFmtRet</a> == CF_UNICODETEXT)) {
00445 
00446                 <span class="comment">/*</span>
00447 <span class="comment">                 * Get the locale out of the parameter-struct.  We will</span>
00448 <span class="comment">                 * use this to get the codepage for text-translation.</span>
00449 <span class="comment">                 */</span>
00450                 <span class="keywordflow">if</span> (lpLocale = (LPDWORD)<a class="code" href="../../d6/d0/usercli_8h.html#a628">CreateLocalMemHandle</a>(gcd.<a class="code" href="../../d6/d5/structtagGETCLIPBDATA.html#o2">hLocale</a>)) {
00451 
00452                     uLocale = *lpLocale;
00453                     GlobalFree(lpLocale);
00454                 } <span class="keywordflow">else</span> {
00455                     uLocale = 0;
00456                 }
00457 
00458                 <span class="comment">/*</span>
00459 <span class="comment">                 * And also, pre-allocate translated buffer in same size as source.</span>
00460 <span class="comment">                 */</span>
00461                 <span class="keywordflow">if</span> ((lpDestData = GlobalAlloc(LPTR, iSrce)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00462                     <span class="keywordflow">goto</span> AbortDummyHandle;
00463                 }
00464             }
00465 
00466             <span class="keywordflow">switch</span> (uFmt) {
00467                 <span class="keywordflow">case</span> CF_TEXT:
00468                 cbNULL = 1;
00469                 <span class="keywordflow">if</span> (gcd.<a class="code" href="../../d6/d5/structtagGETCLIPBDATA.html#o0">uFmtRet</a> == CF_OEMTEXT) {
00470 
00471                     <span class="comment">/*</span>
00472 <span class="comment">                     * CF_OEMTEXT --&gt; CF_TEXT conversion</span>
00473 <span class="comment">                     */</span>
00474                     OemToAnsi((LPSTR)lpSrceData, (LPSTR)lpDestData);
00475                 } <span class="keywordflow">else</span> {
00476 
00477                     uCPage = <a class="code" href="../../d3/d8/client_8c.html#a28">GetClipboardCodePage</a>(uLocale,
00478                                                   LOCALE_IDEFAULTANSICODEPAGE);
00479 
00480                     <span class="comment">/*</span>
00481 <span class="comment">                     * CF_UNICODETEXT --&gt; CF_TEXT conversion</span>
00482 <span class="comment">                     */</span>
00483                     iDest = 0;
00484                     <span class="keywordflow">if</span> ((iDest = WideCharToMultiByte(uCPage,
00485                                                      (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)0,
00486                                                      (LPWSTR)lpSrceData,
00487                                                      (<span class="keywordtype">int</span>)(iSrce / <span class="keyword">sizeof</span>(WCHAR)),
00488                                                      (LPSTR)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00489                                                      (<span class="keywordtype">int</span>)iDest,
00490                                                      (LPSTR)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00491                                                      (LPBOOL)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) == 0) {
00492 AbortGetClipData:
00493                         <a class="code" href="../../d6/d0/usercli_8h.html#a2">UserGlobalFree</a>(lpDestData);
00494 AbortDummyHandle:
00495                         <a class="code" href="../../d6/d0/usercli_8h.html#a2">UserGlobalFree</a>(lpSrceData);
00496                         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00497                     }
00498 
00499                     <span class="keywordflow">if</span> (!(lptData = GlobalReAlloc( lpDestData, iDest, LPTR | <a class="code" href="../../d2/d3/ldrsnap_8c.html#a21">LMEM_MOVEABLE</a>)))
00500                         <span class="keywordflow">goto</span> AbortGetClipData;
00501 
00502                     lpDestData = lptData;
00503 
00504                     <span class="keywordflow">if</span> (WideCharToMultiByte(uCPage,
00505                                             (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)0,
00506                                             (LPWSTR)lpSrceData,
00507                                             (<span class="keywordtype">int</span>)(iSrce / <span class="keyword">sizeof</span>(WCHAR)),
00508                                             (LPSTR)lpDestData,
00509                                             (<span class="keywordtype">int</span>)iDest,
00510                                             (LPSTR)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00511                                             (LPBOOL)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) == 0)
00512                         <span class="keywordflow">goto</span> AbortGetClipData;
00513                 }
00514                 <span class="keywordflow">break</span>;
00515 
00516             <span class="keywordflow">case</span> CF_OEMTEXT:
00517                 cbNULL = 1;
00518                 <span class="keywordflow">if</span> (gcd.<a class="code" href="../../d6/d5/structtagGETCLIPBDATA.html#o0">uFmtRet</a> == CF_TEXT) {
00519 
00520                     <span class="comment">/*</span>
00521 <span class="comment">                     * CF_TEXT --&gt; CF_OEMTEXT conversion</span>
00522 <span class="comment">                     */</span>
00523                     AnsiToOem((LPSTR)lpSrceData, (LPSTR)lpDestData);
00524                 } <span class="keywordflow">else</span> {
00525 
00526                     uCPage = <a class="code" href="../../d3/d8/client_8c.html#a28">GetClipboardCodePage</a>(uLocale,
00527                                                   LOCALE_IDEFAULTCODEPAGE);
00528 
00529                     <span class="comment">/*</span>
00530 <span class="comment">                     * CF_UNICODETEXT --&gt; CF_OEMTEXT conversion</span>
00531 <span class="comment">                     */</span>
00532                     iDest = 0;
00533                     <span class="keywordflow">if</span> ((iDest = WideCharToMultiByte(uCPage,
00534                                                      (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)0,
00535                                                      (LPWSTR)lpSrceData,
00536                                                      (<span class="keywordtype">int</span>)(iSrce / <span class="keyword">sizeof</span>(WCHAR)),
00537                                                      (LPSTR)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00538                                                      (<span class="keywordtype">int</span>)iDest,
00539                                                      (LPSTR)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00540                                                      (LPBOOL)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) == 0)
00541                         <span class="keywordflow">goto</span> AbortGetClipData;
00542 
00543                     <span class="keywordflow">if</span> (!(lptData = GlobalReAlloc( lpDestData, iDest, LPTR | <a class="code" href="../../d2/d3/ldrsnap_8c.html#a21">LMEM_MOVEABLE</a>)))
00544                         <span class="keywordflow">goto</span> AbortGetClipData;
00545 
00546                     lpDestData = lptData;
00547 
00548                     <span class="keywordflow">if</span> (WideCharToMultiByte(uCPage,
00549                                             (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)0,
00550                                             (LPWSTR)lpSrceData,
00551                                             (<span class="keywordtype">int</span>)(iSrce / <span class="keyword">sizeof</span>(WCHAR)),
00552                                             (LPSTR)lpDestData,
00553                                             (<span class="keywordtype">int</span>)iDest,
00554                                             (LPSTR)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00555                                             (LPBOOL)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) == 0)
00556                         <span class="keywordflow">goto</span> AbortGetClipData;
00557                 }
00558                 <span class="keywordflow">break</span>;
00559 
00560             <span class="keywordflow">case</span> CF_UNICODETEXT:
00561                 cbNULL = 2;
00562                 <span class="keywordflow">if</span> (gcd.<a class="code" href="../../d6/d5/structtagGETCLIPBDATA.html#o0">uFmtRet</a> == CF_TEXT) {
00563 
00564                     uCPage = <a class="code" href="../../d3/d8/client_8c.html#a28">GetClipboardCodePage</a>(uLocale,
00565                                                   LOCALE_IDEFAULTANSICODEPAGE);
00566 
00567                     <span class="comment">/*</span>
00568 <span class="comment">                     * CF_TEXT --&gt; CF_UNICODETEXT conversion</span>
00569 <span class="comment">                     */</span>
00570                     iDest = 0;
00571                     <span class="keywordflow">if</span> ((iDest = MultiByteToWideChar(uCPage,
00572                                                      (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)MB_PRECOMPOSED,
00573                                                      (LPSTR)lpSrceData,
00574                                                      (<span class="keywordtype">int</span>)iSrce,
00575                                                      (LPWSTR)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00576                                                      (<span class="keywordtype">int</span>)iDest)) == 0)
00577                         <span class="keywordflow">goto</span> AbortGetClipData;
00578 
00579                     <span class="keywordflow">if</span> (!(lptData = GlobalReAlloc(lpDestData,
00580                             iDest * <span class="keyword">sizeof</span>(WCHAR), LPTR | <a class="code" href="../../d2/d3/ldrsnap_8c.html#a21">LMEM_MOVEABLE</a>)))
00581                         <span class="keywordflow">goto</span> AbortGetClipData;
00582 
00583                     lpDestData = lptData;
00584 
00585                     <span class="keywordflow">if</span> (MultiByteToWideChar(uCPage,
00586                                             (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)MB_PRECOMPOSED,
00587                                             (LPSTR)lpSrceData,
00588                                             (<span class="keywordtype">int</span>)iSrce,
00589                                             (LPWSTR)lpDestData,
00590                                             (<span class="keywordtype">int</span>)iDest) == 0)
00591                         <span class="keywordflow">goto</span> AbortGetClipData;
00592 
00593                 } <span class="keywordflow">else</span> {
00594 
00595                     uCPage = <a class="code" href="../../d3/d8/client_8c.html#a28">GetClipboardCodePage</a>(uLocale,
00596                                                   LOCALE_IDEFAULTCODEPAGE);
00597 
00598                     <span class="comment">/*</span>
00599 <span class="comment">                     * CF_OEMTEXT --&gt; CF_UNICDOETEXT conversion</span>
00600 <span class="comment">                     */</span>
00601                     iDest = 0;
00602                     <span class="keywordflow">if</span> ((iDest = MultiByteToWideChar(uCPage,
00603                                                      (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)MB_PRECOMPOSED,
00604                                                      (LPSTR)lpSrceData,
00605                                                      (<span class="keywordtype">int</span>)iSrce,
00606                                                      (LPWSTR)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00607                                                      (<span class="keywordtype">int</span>)iDest)) == 0)
00608                         <span class="keywordflow">goto</span> AbortGetClipData;
00609 
00610                     <span class="keywordflow">if</span> (!(lptData = GlobalReAlloc(lpDestData,
00611                             iDest * <span class="keyword">sizeof</span>(WCHAR), LPTR | <a class="code" href="../../d2/d3/ldrsnap_8c.html#a21">LMEM_MOVEABLE</a>)))
00612                         <span class="keywordflow">goto</span> AbortGetClipData;
00613 
00614                     lpDestData = lptData;
00615 
00616                     <span class="keywordflow">if</span> (MultiByteToWideChar(uCPage,
00617                                             (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)MB_PRECOMPOSED,
00618                                             (LPSTR)lpSrceData,
00619                                             (<span class="keywordtype">int</span>)iSrce,
00620                                             (LPWSTR)lpDestData,
00621                                             (<span class="keywordtype">int</span>)iDest) == 0)
00622                         <span class="keywordflow">goto</span> AbortGetClipData;
00623                 }
00624                 <span class="keywordflow">break</span>;
00625 
00626             <span class="keywordflow">case</span> CF_BITMAP:
00627                 <span class="keywordflow">if</span> (gcd.<a class="code" href="../../d6/d5/structtagGETCLIPBDATA.html#o0">uFmtRet</a> == CF_DIBV5) {
00628 
00629                     <span class="comment">/*</span>
00630 <span class="comment">                     * CF_DIBV5 --&gt; CF_BITMAP (sRGB)</span>
00631 <span class="comment">                     *</span>
00632 <span class="comment">                     * The GDI bitmap handle will be returned in handleServer.</span>
00633 <span class="comment">                     */</span>
00634                     <span class="keywordflow">if</span> ((handleServer = GdiConvertBitmapV5(lpSrceData,iSrce,
00635                                                            gcd.<a class="code" href="../../d6/d5/structtagGETCLIPBDATA.html#o3">hPalette</a>,CF_BITMAP)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00636 
00637                         <span class="comment">/*</span>
00638 <span class="comment">                         * GDI failed to convert.</span>
00639 <span class="comment">                         */</span>
00640                         RIPMSG0(RIP_ERROR, <span class="stringliteral">"GetClipboardData: Failed CF_DIBV5 -&gt; CF_BITMAP\n"</span>);
00641                         <span class="keywordflow">goto</span> AbortDummyHandle;
00642                     }
00643                 } <span class="keywordflow">else</span> {
00644 
00645                     RIPMSG0(RIP_ERROR, <span class="stringliteral">"GetClipboardData: bad conversion request\n"</span>);
00646                     <span class="keywordflow">goto</span> AbortDummyHandle;
00647                 }
00648                 <span class="keywordflow">break</span>;
00649 
00650             <span class="keywordflow">case</span> CF_DIB:
00651                 <span class="keywordflow">if</span> (gcd.<a class="code" href="../../d6/d5/structtagGETCLIPBDATA.html#o0">uFmtRet</a> == CF_DIBV5) {
00652 
00653                     <span class="comment">/*</span>
00654 <span class="comment">                     * CF_DIBV5 --&gt; CF_DIB (sRGB)</span>
00655 <span class="comment">                     *</span>
00656 <span class="comment">                     * The local memory handle will be returned in lpDestData.</span>
00657 <span class="comment">                     */</span>
00658                     <span class="keywordflow">if</span> ((lpDestData = (LPBYTE) GdiConvertBitmapV5(lpSrceData,iSrce,
00659                                                                   gcd.<a class="code" href="../../d6/d5/structtagGETCLIPBDATA.html#o3">hPalette</a>,CF_DIB)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00660 
00661                         <span class="comment">/*</span>
00662 <span class="comment">                         * GDI failed to convert.</span>
00663 <span class="comment">                         */</span>
00664                         RIPMSG0(RIP_ERROR, <span class="stringliteral">"GetClipboardData: Failed CF_DIBV5 -&gt; CF_DIB\n"</span>);
00665                         <span class="keywordflow">goto</span> AbortDummyHandle;
00666                     }
00667                 } <span class="keywordflow">else</span> {
00668 
00669                     RIPMSG0(RIP_ERROR, <span class="stringliteral">"GetClipboardData: bad conversion request\n"</span>);
00670                     <span class="keywordflow">goto</span> AbortDummyHandle;
00671                 }
00672                 <span class="keywordflow">break</span>;
00673             }
00674         }
00675 
00676         <span class="keywordflow">if</span> (lpDestData) {
00677             <span class="comment">/*</span>
00678 <span class="comment">             * Replace the dummy user-mode memory handle with the actual handle.</span>
00679 <span class="comment">             */</span>
00680             handleServer = <a class="code" href="../../d6/d0/usercli_8h.html#a629">ConvertMemHandle</a>(lpDestData, cbNULL);
00681             <span class="keywordflow">if</span> (handleServer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00682                 <span class="keywordflow">goto</span> AbortGetClipData;
00683         }
00684 
00685         <span class="comment">/*</span>
00686 <span class="comment">         * Update the server.  If that is successfull update the client</span>
00687 <span class="comment">         */</span>
00688         RtlEnterCriticalSection(&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a24">gcsClipboard</a>);
00689         scd.<a class="code" href="../../d3/d6/structtagSETCLIPBDATA.html#o0">fGlobalHandle</a>    = gcd.<a class="code" href="../../d6/d5/structtagGETCLIPBDATA.html#o1">fGlobalHandle</a>;
00690         scd.<a class="code" href="../../d3/d6/structtagSETCLIPBDATA.html#o1">fIncSerialNumber</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00691         <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a131">NtUserSetClipboardData</a>(uFmt, handleServer, &amp;scd)) {
00692             handleServer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00693         }
00694         RtlLeaveCriticalSection(&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a24">gcsClipboard</a>);
00695 
00696         <span class="keywordflow">if</span> (lpDestData)
00697             <a class="code" href="../../d6/d0/usercli_8h.html#a2">UserGlobalFree</a>(lpDestData);
00698         <span class="keywordflow">if</span> (lpSrceData)
00699             <a class="code" href="../../d6/d0/usercli_8h.html#a2">UserGlobalFree</a>(lpSrceData);
00700 
00701         <span class="keywordflow">if</span> (handleServer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00702             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00703     }
00704 
00705     <span class="comment">/*</span>
00706 <span class="comment">     * See if we already have a client side handle; validate the format</span>
00707 <span class="comment">     * as well because some server objects, metafile for example, are dual mode</span>
00708 <span class="comment">     * and yield two kinds of client objects enhanced and regular metafiles</span>
00709 <span class="comment">     */</span>
00710     handleClient = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00711     RtlEnterCriticalSection(&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a24">gcsClipboard</a>);
00712 
00713     phn = <a class="code" href="../../d3/d8/client_8c.html#a22">gphn</a>;
00714     <span class="keywordflow">while</span> (phn) {
00715         <span class="keywordflow">if</span> ((phn-&gt;<a class="code" href="../../d3/d4/struct__HANDLENODE.html#o2">handleServer</a> == handleServer) &amp;&amp; (phn-&gt;<a class="code" href="../../d3/d4/struct__HANDLENODE.html#o1">fmt</a> == uFmt)) {
00716             handleClient = phn-&gt;<a class="code" href="../../d3/d4/struct__HANDLENODE.html#o3">handleClient</a>;
00717             <span class="keywordflow">goto</span> Exit;
00718         }
00719         phn = phn-&gt;<a class="code" href="../../d3/d4/struct__HANDLENODE.html#o0">pnext</a>;
00720     }
00721 
00722     <span class="comment">/*</span>
00723 <span class="comment">     * We don't have a handle cached so we'll create one</span>
00724 <span class="comment">     */</span>
00725     phnNew = (<a class="code" href="../../d3/d8/client_8c.html#a21">PHANDLENODE</a>)LocalAlloc(LPTR, <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d4/struct__HANDLENODE.html">HANDLENODE</a>));
00726     <span class="keywordflow">if</span> (phnNew == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00727         <span class="keywordflow">goto</span> Exit;
00728 
00729     phnNew-&gt;<a class="code" href="../../d3/d4/struct__HANDLENODE.html#o2">handleServer</a>  = handleServer;
00730     phnNew-&gt;<a class="code" href="../../d3/d4/struct__HANDLENODE.html#o1">fmt</a>           = gcd.<a class="code" href="../../d6/d5/structtagGETCLIPBDATA.html#o0">uFmtRet</a>;
00731     phnNew-&gt;<a class="code" href="../../d3/d4/struct__HANDLENODE.html#o4">fGlobalHandle</a> = gcd.<a class="code" href="../../d6/d5/structtagGETCLIPBDATA.html#o1">fGlobalHandle</a>;
00732 
00733     <span class="keywordflow">switch</span> (uFmt) {
00734 
00735         <span class="comment">/*</span>
00736 <span class="comment">         * Misc GDI Handles</span>
00737 <span class="comment">         */</span>
00738         <span class="keywordflow">case</span> CF_BITMAP:
00739         <span class="keywordflow">case</span> CF_DSPBITMAP:
00740         <span class="keywordflow">case</span> CF_PALETTE:
00741             phnNew-&gt;<a class="code" href="../../d3/d4/struct__HANDLENODE.html#o3">handleClient</a> = handleServer;
00742             <span class="keywordflow">break</span>;
00743 
00744         <span class="keywordflow">case</span> CF_METAFILEPICT:
00745         <span class="keywordflow">case</span> CF_DSPMETAFILEPICT:
00746             phnNew-&gt;<a class="code" href="../../d3/d4/struct__HANDLENODE.html#o3">handleClient</a> = GdiCreateLocalMetaFilePict(handleServer);
00747             <span class="keywordflow">break</span>;
00748 
00749         <span class="keywordflow">case</span> CF_ENHMETAFILE:
00750         <span class="keywordflow">case</span> CF_DSPENHMETAFILE:
00751             phnNew-&gt;<a class="code" href="../../d3/d4/struct__HANDLENODE.html#o3">handleClient</a> = GdiCreateLocalEnhMetaFile(handleServer);
00752             <span class="keywordflow">break</span>;
00753 
00754         <span class="comment">/*</span>
00755 <span class="comment">         * GlobalHandle Cases</span>
00756 <span class="comment">         */</span>
00757         <span class="keywordflow">case</span> CF_TEXT:
00758         <span class="keywordflow">case</span> CF_OEMTEXT:
00759         <span class="keywordflow">case</span> CF_UNICODETEXT:
00760         <span class="keywordflow">case</span> CF_LOCALE:
00761         <span class="keywordflow">case</span> CF_DSPTEXT:
00762         <span class="keywordflow">case</span> CF_DIB:
00763         <span class="keywordflow">case</span> CF_DIBV5:
00764             phnNew-&gt;<a class="code" href="../../d3/d4/struct__HANDLENODE.html#o3">handleClient</a> = <a class="code" href="../../d6/d0/usercli_8h.html#a628">CreateLocalMemHandle</a>(handleServer);
00765             phnNew-&gt;<a class="code" href="../../d3/d4/struct__HANDLENODE.html#o4">fGlobalHandle</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00766             <span class="keywordflow">break</span>;
00767 
00768         <span class="keywordflow">default</span>:
00769             <span class="comment">/*</span>
00770 <span class="comment">             * Private Data Format; If this is global data, create a copy of that</span>
00771 <span class="comment">             * data here on the client. If it isn't global data, it is just a dword</span>
00772 <span class="comment">             * in which case we just return a dword. If it is global data and</span>
00773 <span class="comment">             * the server fails to give us that memory, return NULL. If it isn't</span>
00774 <span class="comment">             * global data, handleClient is just a dword.</span>
00775 <span class="comment">             */</span>
00776             <span class="keywordflow">if</span> (phnNew-&gt;<a class="code" href="../../d3/d4/struct__HANDLENODE.html#o4">fGlobalHandle</a>) {
00777                 phnNew-&gt;<a class="code" href="../../d3/d4/struct__HANDLENODE.html#o3">handleClient</a> = <a class="code" href="../../d6/d0/usercli_8h.html#a628">CreateLocalMemHandle</a>(handleServer);
00778             } <span class="keywordflow">else</span> {
00779                 phnNew-&gt;<a class="code" href="../../d3/d4/struct__HANDLENODE.html#o3">handleClient</a> = handleServer;
00780             }
00781             <span class="keywordflow">break</span>;
00782     }
00783 
00784     <span class="keywordflow">if</span> (phnNew-&gt;<a class="code" href="../../d3/d4/struct__HANDLENODE.html#o3">handleClient</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00785         <span class="comment">/*</span>
00786 <span class="comment">         * Something bad happened, gdi didn't give us back a</span>
00787 <span class="comment">         * handle. Since gdi has logged the error, we'll just</span>
00788 <span class="comment">         * clean up and return an error.</span>
00789 <span class="comment">         */</span>
00790         RIPMSG1(RIP_WARNING, <span class="stringliteral">"GetClipboardData unable to convert server handle %#p to client handle\n"</span>, handleServer);
00791 
00792         LocalFree(phnNew);
00793         <span class="keywordflow">goto</span> Exit;
00794     }
00795 
00796 <span class="preprocessor">#if DBG</span>
00797 <span class="preprocessor"></span>    <span class="comment">/*</span>
00798 <span class="comment">     * If handleClient came from a GlobalAlloc, then fGlobalHandle must be TRUE.</span>
00799 <span class="comment">     * Some formats are acutally global handles but require special cleanup.</span>
00800 <span class="comment">     */</span>
00801     <span class="keywordflow">switch</span> (phnNew-&gt;<a class="code" href="../../d3/d4/struct__HANDLENODE.html#o1">fmt</a>) {
00802         <span class="keywordflow">case</span> CF_METAFILEPICT:
00803         <span class="keywordflow">case</span> CF_DSPMETAFILEPICT:
00804             <span class="keywordflow">break</span>;
00805 
00806         <span class="keywordflow">default</span>:
00807             UserAssert(phnNew-&gt;<a class="code" href="../../d3/d4/struct__HANDLENODE.html#o4">fGlobalHandle</a>
00808                        ^ (GlobalFlags(phnNew-&gt;<a class="code" href="../../d3/d4/struct__HANDLENODE.html#o3">handleClient</a>) == GMEM_INVALID_HANDLE));
00809             <span class="keywordflow">break</span>;
00810     }
00811 <span class="preprocessor">#endif</span>
00812 <span class="preprocessor"></span>
00813     <span class="comment">/*</span>
00814 <span class="comment">     * Cache the new handle by linking it into our list</span>
00815 <span class="comment">     */</span>
00816     phnNew-&gt;<a class="code" href="../../d3/d4/struct__HANDLENODE.html#o0">pnext</a> = <a class="code" href="../../d3/d8/client_8c.html#a22">gphn</a>;
00817     <a class="code" href="../../d3/d8/client_8c.html#a22">gphn</a> = phnNew;
00818     handleClient = phnNew-&gt;<a class="code" href="../../d3/d4/struct__HANDLENODE.html#o3">handleClient</a>;
00819 
00820 Exit:
00821     RtlLeaveCriticalSection(&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a24">gcsClipboard</a>);
00822     <span class="keywordflow">return</span> handleClient;
00823 }
00824 
00825 <span class="comment">/***************************************************************************\</span>
00826 <span class="comment">* GetClipboardCodePage (internal)</span>
00827 <span class="comment">*</span>
00828 <span class="comment">*   This routine returns the code-page associated with the given locale.</span>
00829 <span class="comment">*</span>
00830 <span class="comment">* 24-Aug-1995 ChrisWil  Created.</span>
00831 <span class="comment">\***************************************************************************/</span>
00832 
<a name="l00833"></a><a class="code" href="../../d3/d8/client_8c.html#a3">00833</a> <span class="preprocessor">#define GETCCP_SIZE 8</span>
00834 <span class="preprocessor"></span>
<a name="l00835"></a><a class="code" href="../../d3/d8/client_8c.html#a28">00835</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d3/d8/client_8c.html#a28">GetClipboardCodePage</a>(
00836     LCID   uLocale,
00837     LCTYPE uLocaleType)
00838 {
00839     WCHAR wszCodePage[<a class="code" href="../../d3/d8/client_8c.html#a3">GETCCP_SIZE</a>];
00840     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> uCPage;
00841 
00842     <span class="keywordflow">if</span> (GetLocaleInfoW(uLocale, uLocaleType, wszCodePage, <a class="code" href="../../d3/d8/client_8c.html#a3">GETCCP_SIZE</a>)) {
00843 
00844         uCPage = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)wcstol(wszCodePage, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 10);
00845 
00846     } <span class="keywordflow">else</span> {
00847 
00848         <span class="keywordflow">switch</span>(uLocaleType) {
00849 
00850         <span class="keywordflow">case</span> LOCALE_IDEFAULTCODEPAGE:
00851             uCPage = CP_OEMCP;
00852             <span class="keywordflow">break</span>;
00853 
00854         <span class="keywordflow">case</span> LOCALE_IDEFAULTANSICODEPAGE:
00855             uCPage = CP_ACP;
00856             <span class="keywordflow">break</span>;
00857 
00858         <span class="keywordflow">default</span>:
00859             uCPage = CP_MACCP;
00860             <span class="keywordflow">break</span>;
00861         }
00862     }
00863 
00864     <span class="keywordflow">return</span> uCPage;
00865 }
00866 
00867 <span class="comment">/***************************************************************************\</span>
00868 <span class="comment">* SetClipboardData</span>
00869 <span class="comment">*</span>
00870 <span class="comment">* Stub routine needs to exist on the client side so any global data gets</span>
00871 <span class="comment">* allocated DDESHARE.</span>
00872 <span class="comment">*</span>
00873 <span class="comment">* 05-20-91 ScottLu Created.</span>
00874 <span class="comment">\***************************************************************************/</span>
00875 
<a name="l00876"></a><a class="code" href="../../d3/d8/client_8c.html#a43">00876</a> HANDLE WINAPI <a class="code" href="../../d3/d8/client_8c.html#a43">SetClipboardData</a>(
00877     UINT   wFmt,
00878     HANDLE hMem)
00879 {
00880     <a class="code" href="../../d3/d8/client_8c.html#a21">PHANDLENODE</a>  phnNew;
00881     HANDLE       hServer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00882     <a class="code" href="../../d3/d6/structtagSETCLIPBDATA.html">SETCLIPBDATA</a> scd;
00883     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>         fGlobalHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00884 
00885     <span class="keywordflow">if</span> (hMem != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00886 
00887         <span class="keywordflow">switch</span>(wFmt) {
00888 
00889             <span class="keywordflow">case</span> CF_BITMAP:
00890             <span class="keywordflow">case</span> CF_DSPBITMAP:
00891             <span class="keywordflow">case</span> CF_PALETTE:
00892                 hServer = hMem;
00893                 <span class="keywordflow">break</span>;
00894 
00895             <span class="keywordflow">case</span> CF_METAFILEPICT:
00896             <span class="keywordflow">case</span> CF_DSPMETAFILEPICT:
00897                 hServer = GdiConvertMetaFilePict(hMem);
00898                 <span class="keywordflow">break</span>;
00899 
00900             <span class="keywordflow">case</span> CF_ENHMETAFILE:
00901             <span class="keywordflow">case</span> CF_DSPENHMETAFILE:
00902                 hServer = GdiConvertEnhMetaFile(hMem);
00903                 <span class="keywordflow">break</span>;
00904 
00905             <span class="comment">/*</span>
00906 <span class="comment">             * Must have a valid hMem (GlobalHandle)</span>
00907 <span class="comment">             */</span>
00908             <span class="keywordflow">case</span> CF_TEXT:
00909             <span class="keywordflow">case</span> CF_OEMTEXT:
00910             <span class="keywordflow">case</span> CF_LOCALE:
00911             <span class="keywordflow">case</span> CF_DSPTEXT:
00912                 hServer = <a class="code" href="../../d6/d0/usercli_8h.html#a629">ConvertMemHandle</a>(hMem, 1);
00913                 fGlobalHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00914                 <span class="keywordflow">break</span>;
00915 
00916             <span class="keywordflow">case</span> CF_UNICODETEXT:
00917                 hServer = <a class="code" href="../../d6/d0/usercli_8h.html#a629">ConvertMemHandle</a>(hMem, 2);
00918                 fGlobalHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00919                 <span class="keywordflow">break</span>;
00920 
00921             <span class="keywordflow">case</span> CF_DIB:
00922             <span class="keywordflow">case</span> CF_DIBV5:
00923                 hServer = <a class="code" href="../../d6/d0/usercli_8h.html#a629">ConvertMemHandle</a>(hMem, 0);
00924                 fGlobalHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00925                 <span class="keywordflow">break</span>;
00926 
00927             <span class="comment">/*</span>
00928 <span class="comment">             * hMem should have been NULL but Write sends non-null when told</span>
00929 <span class="comment">             * to render</span>
00930 <span class="comment">             */</span>
00931             <span class="keywordflow">case</span> CF_OWNERDISPLAY:
00932                 <span class="comment">// Fall Through;</span>
00933 
00934             <span class="comment">/*</span>
00935 <span class="comment">             * May have an hMem (GlobalHandle) or may be private handle\info</span>
00936 <span class="comment">             */</span>
00937             <span class="keywordflow">default</span>:
00938                 <span class="keywordflow">if</span> (GlobalFlags(hMem) == GMEM_INVALID_HANDLE) {
00939                     hServer = hMem;    <span class="comment">// No server equivalent; private data</span>
00940                     <span class="keywordflow">goto</span> SCD_AFTERNULLCHECK;
00941                 } <span class="keywordflow">else</span> {
00942                     fGlobalHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00943                     hServer = <a class="code" href="../../d6/d0/usercli_8h.html#a629">ConvertMemHandle</a>(hMem, 0);
00944                 }
00945                 <span class="keywordflow">break</span>;
00946         }
00947 
00948         <span class="keywordflow">if</span> (hServer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00949             <span class="comment">/*</span>
00950 <span class="comment">             * Something bad happened, gdi didn't give us back a</span>
00951 <span class="comment">             * handle. Since gdi has logged the error, we'll just</span>
00952 <span class="comment">             * clean up and return an error.</span>
00953 <span class="comment">             */</span>
00954             RIPMSG0(RIP_WARNING, <span class="stringliteral">"SetClipboardData: bad handle\n"</span>);
00955             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00956         }
00957     }
00958 
00959 SCD_AFTERNULLCHECK:
00960 
00961     RtlEnterCriticalSection(&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a24">gcsClipboard</a>);
00962 
00963     <span class="comment">/*</span>
00964 <span class="comment">     * Update the server if that is successfull update the client</span>
00965 <span class="comment">     */</span>
00966     scd.<a class="code" href="../../d3/d6/structtagSETCLIPBDATA.html#o0">fGlobalHandle</a>    = fGlobalHandle;
00967     scd.<a class="code" href="../../d3/d6/structtagSETCLIPBDATA.html#o1">fIncSerialNumber</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00968 
00969     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a131">NtUserSetClipboardData</a>(wFmt, hServer, &amp;scd)) {
00970         RtlLeaveCriticalSection(&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a24">gcsClipboard</a>);
00971         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00972     }
00973 
00974     <span class="comment">/*</span>
00975 <span class="comment">     * See if we already have a client handle of this type.  If so</span>
00976 <span class="comment">     * delete it.</span>
00977 <span class="comment">     */</span>
00978     phnNew = <a class="code" href="../../d3/d8/client_8c.html#a22">gphn</a>;
00979     <span class="keywordflow">while</span> (phnNew) {
00980         <span class="keywordflow">if</span> (phnNew-&gt;<a class="code" href="../../d3/d4/struct__HANDLENODE.html#o1">fmt</a> == wFmt) {
00981             <span class="keywordflow">if</span> (phnNew-&gt;<a class="code" href="../../d3/d4/struct__HANDLENODE.html#o3">handleClient</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00982                 <a class="code" href="../../d3/d8/client_8c.html#a40">DeleteClientClipboardHandle</a>(phnNew);
00983                 <span class="comment">/*</span>
00984 <span class="comment">                 * Notify WOW to clear its associated cached h16 for this format</span>
00985 <span class="comment">                 * so that OLE32 thunked calls, which bypass the WOW cache will work.</span>
00986 <span class="comment">                 */</span>
00987                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/clglobal_8c.html#a56">pfnWowCBStoreHandle</a>) {
00988                     <a class="code" href="../../d8/d6/ntuser_2client_2globals_8h.html#a66">pfnWowCBStoreHandle</a>((WORD)wFmt, 0);
00989                 }
00990             }
00991             <span class="keywordflow">break</span>;
00992         }
00993 
00994         phnNew = phnNew-&gt;<a class="code" href="../../d3/d4/struct__HANDLENODE.html#o0">pnext</a>;
00995     }
00996 
00997     <span class="comment">/*</span>
00998 <span class="comment">     * If we aren't re-using an old client cache entry alloc a new one</span>
00999 <span class="comment">     */</span>
01000     <span class="keywordflow">if</span> (!phnNew) {
01001         phnNew = (<a class="code" href="../../d3/d8/client_8c.html#a21">PHANDLENODE</a>)LocalAlloc(LPTR, <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d4/struct__HANDLENODE.html">HANDLENODE</a>));
01002 
01003         <span class="keywordflow">if</span> (phnNew == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01004             RIPMSG0(RIP_WARNING, <span class="stringliteral">"SetClipboardData: not enough memory\n"</span>);
01005 
01006             RtlLeaveCriticalSection(&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a24">gcsClipboard</a>);
01007             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01008         }
01009 
01010         <span class="comment">/*</span>
01011 <span class="comment">         * Link in the newly allocated cache entry</span>
01012 <span class="comment">         */</span>
01013         phnNew-&gt;<a class="code" href="../../d3/d4/struct__HANDLENODE.html#o0">pnext</a> = <a class="code" href="../../d3/d8/client_8c.html#a22">gphn</a>;
01014         <a class="code" href="../../d3/d8/client_8c.html#a22">gphn</a> = phnNew;
01015     }
01016 
01017     phnNew-&gt;<a class="code" href="../../d3/d4/struct__HANDLENODE.html#o2">handleServer</a>  = hServer;
01018     phnNew-&gt;<a class="code" href="../../d3/d4/struct__HANDLENODE.html#o3">handleClient</a>  = hMem;
01019     phnNew-&gt;<a class="code" href="../../d3/d4/struct__HANDLENODE.html#o1">fmt</a>           = wFmt;
01020     phnNew-&gt;<a class="code" href="../../d3/d4/struct__HANDLENODE.html#o4">fGlobalHandle</a> = fGlobalHandle;
01021 
01022     RtlLeaveCriticalSection(&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a24">gcsClipboard</a>);
01023 
01024     <span class="keywordflow">return</span> hMem;
01025 }
01026 
01027 <span class="comment">/**************************************************************************\</span>
01028 <span class="comment">* SetDeskWallpaper</span>
01029 <span class="comment">*</span>
01030 <span class="comment">* 22-Jul-1991 mikeke Created</span>
01031 <span class="comment">* 01-Mar-1992 GregoryW Modified to call SystemParametersInfo.</span>
01032 <span class="comment">\**************************************************************************/</span>
01033 
<a name="l01034"></a><a class="code" href="../../d3/d8/client_8c.html#a44">01034</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d8/client_8c.html#a44">SetDeskWallpaper</a>(
01035     IN LPCSTR pString OPTIONAL)
01036 {
01037     <span class="keywordflow">return</span> SystemParametersInfoA(SPI_SETDESKWALLPAPER, 0, (PVOID)pString, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01038 }
01039 
01040 <span class="comment">/***************************************************************************\</span>
01041 <span class="comment">* ReleaseDC (API)</span>
01042 <span class="comment">*</span>
01043 <span class="comment">* A complete Thank cannot be generated for ReleaseDC because its first</span>
01044 <span class="comment">* parameter (hwnd) unnecessary and should be discarded before calling the</span>
01045 <span class="comment">* server-side routine _ReleaseDC.</span>
01046 <span class="comment">*</span>
01047 <span class="comment">* History:</span>
01048 <span class="comment">* 03-28-91 SMeans Created.</span>
01049 <span class="comment">* 06-17-91 ChuckWh Added support for local DCs.</span>
01050 <span class="comment">\***************************************************************************/</span>
01051 
<a name="l01052"></a><a class="code" href="../../d3/d8/client_8c.html#a45">01052</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d3/d8/client_8c.html#a45">ReleaseDC</a>(
01053     HWND hwnd,
01054     HDC hdc)
01055 {
01056 
01057     <span class="comment">/*</span>
01058 <span class="comment">     * NOTE: This is a smart stub that calls _ReleaseDC so there is</span>
01059 <span class="comment">     * no need for a separate ReleaseDC layer or client-server stub.</span>
01060 <span class="comment">     * _ReleaseDC has simpler layer and client-server stubs since the</span>
01061 <span class="comment">     * hwnd can be ignored.</span>
01062 <span class="comment">     */</span>
01063 
01064     UNREFERENCED_PARAMETER(hwnd);
01065 
01066     <span class="comment">/*</span>
01067 <span class="comment">     * Translate the handle.</span>
01068 <span class="comment">     */</span>
01069     <span class="keywordflow">if</span> (hdc == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01070         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01071 
01072     <span class="comment">/*</span>
01073 <span class="comment">     *  call GDI to release user mode DC resources</span>
01074 <span class="comment">     */</span>
01075 
01076     GdiReleaseDC(hdc);
01077 
01078     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a174">NtUserCallOneParam</a>((ULONG_PTR)hdc, SFI__RELEASEDC);
01079 }
01080 
01081 <span class="keywordtype">int</span> WINAPI
<a name="l01082"></a><a class="code" href="../../d3/d8/client_8c.html#a46">01082</a> <a class="code" href="../../d3/d8/client_8c.html#a46">ToAscii</a>(
01083     UINT wVirtKey,
01084     UINT wScanCode,
01085     CONST BYTE *lpKeyState,
01086     LPWORD lpChar,
01087     UINT wFlags
01088     )
01089 {
01090     WCHAR UnicodeChar[2];
01091     <span class="keywordtype">int</span> cch, retval;
01092 
01093     retval = <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a24">ToUnicode</a>(wVirtKey, wScanCode, lpKeyState, UnicodeChar,2, wFlags);
01094     cch = (retval &lt; 0) ? -retval : retval;
01095     <span class="keywordflow">if</span> (cch != 0) {
01096         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d9/d6/nlsxlat_8c.html#a37">RtlUnicodeToMultiByteN</a>(
01097                 (LPSTR)lpChar,
01098                 (ULONG) <span class="keyword">sizeof</span>(*lpChar),
01099                 (PULONG)&amp;cch,
01100                 UnicodeChar,
01101                 cch * <span class="keyword">sizeof</span>(WCHAR)))) {
01102             <span class="keywordflow">return</span> 0;
01103         }
01104     }
01105     <span class="keywordflow">return</span> (retval &lt; 0) ? -cch : cch;
01106 }
01107 
<a name="l01108"></a><a class="code" href="../../d3/d8/client_8c.html#a23">01108</a> <span class="keyword">static</span> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d3/d8/client_8c.html#a23">uCachedCP</a> = 0;
<a name="l01109"></a><a class="code" href="../../d3/d8/client_8c.html#a24">01109</a> <span class="keyword">static</span> HKL  <a class="code" href="../../d3/d8/client_8c.html#a24">hCachedHKL</a> = 0;
01110 
01111 <span class="keywordtype">int</span> WINAPI
<a name="l01112"></a><a class="code" href="../../d3/d8/client_8c.html#a47">01112</a> <a class="code" href="../../d3/d8/client_8c.html#a47">ToAsciiEx</a>(
01113     UINT wVirtKey,
01114     UINT wScanCode,
01115     CONST BYTE *lpKeyState,
01116     LPWORD lpChar,
01117     UINT wFlags,
01118     HKL hkl
01119     )
01120 {
01121     WCHAR UnicodeChar[2];
01122     <span class="keywordtype">int</span> cch, retval;
01123     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fUsedDefaultChar;
01124 
01125     retval = <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a25">ToUnicodeEx</a>(wVirtKey, wScanCode, lpKeyState, UnicodeChar,2, wFlags, hkl);
01126     cch = (retval &lt; 0) ? -retval : retval;
01127     <span class="keywordflow">if</span> (cch != 0) {
01128         <span class="keywordflow">if</span> (hkl != <a class="code" href="../../d3/d8/client_8c.html#a24">hCachedHKL</a>) {
01129             <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwCodePage;
01130             <span class="keywordflow">if</span> (!GetLocaleInfoW(
01131                      HandleToUlong(hkl) &amp; 0xffff,
01132                      LOCALE_IDEFAULTANSICODEPAGE | LOCALE_RETURN_NUMBER,
01133                      (LPWSTR)&amp;dwCodePage,
01134                      <span class="keyword">sizeof</span>(dwCodePage) / <span class="keyword">sizeof</span>(WCHAR)
01135                      )) {
01136                 <span class="keywordflow">return</span> 0;
01137             }
01138             <a class="code" href="../../d3/d8/client_8c.html#a23">uCachedCP</a> = dwCodePage;
01139             <a class="code" href="../../d3/d8/client_8c.html#a24">hCachedHKL</a> = hkl;
01140         }
01141         <span class="keywordflow">if</span> (!WideCharToMultiByte(
01142                  <a class="code" href="../../d3/d8/client_8c.html#a23">uCachedCP</a>,
01143                  0,
01144                  UnicodeChar,
01145                  cch,
01146                  (LPSTR)lpChar,
01147                  <span class="keyword">sizeof</span>(*lpChar),
01148                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01149                  &amp;fUsedDefaultChar)) {
01150             <span class="keywordflow">return</span> 0;
01151         }
01152     }
01153     <span class="keywordflow">return</span> (retval &lt; 0) ? -cch : cch;
01154 }
01155 
01156 <span class="comment">/**************************************************************************\</span>
01157 <span class="comment">* ScrollDC *</span>
01158 <span class="comment">* DrawIcon *</span>
01159 <span class="comment">* ExcludeUpdateRgn *</span>
01160 <span class="comment">* ValidateRgn *</span>
01161 <span class="comment">* DrawFocusRect *</span>
01162 <span class="comment">* FrameRect *</span>
01163 <span class="comment">* ReleaseDC *</span>
01164 <span class="comment">* GetUpdateRgn *</span>
01165 <span class="comment">* *</span>
01166 <span class="comment">* These USER entry points all need handles translated before the call is *</span>
01167 <span class="comment">* passed to the server side handler. *</span>
01168 <span class="comment">* *</span>
01169 <span class="comment">* History: *</span>
01170 <span class="comment">* Mon 17-Jun-1991 22:51:45 -by- Charles Whitmer [chuckwh] *</span>
01171 <span class="comment">* Wrote the stubs. The final form of these routines depends strongly on *</span>
01172 <span class="comment">* what direction the user stubs take in general. *</span>
01173 <span class="comment">\**************************************************************************/</span>
01174 
01175 
<a name="l01176"></a><a class="code" href="../../d3/d8/client_8c.html#a48">01176</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d3/d8/client_8c.html#a48">ScrollDC</a>(
01177     HDC hDC,
01178     <span class="keywordtype">int</span> dx,
01179     <span class="keywordtype">int</span> dy,
01180     CONST RECT *lprcScroll,
01181     CONST RECT *lprcClip,
01182     HRGN hrgnUpdate,
01183     LPRECT lprcUpdate)
01184 {
01185     <span class="keywordflow">if</span> (hDC == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01186         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01187 
01188     <span class="comment">/*</span>
01189 <span class="comment">     * If we're not scrolling, just empty the update region and return.</span>
01190 <span class="comment">     */</span>
01191     <span class="keywordflow">if</span> (dx == 0 &amp;&amp; dy == 0) {
01192         <span class="keywordflow">if</span> (hrgnUpdate)
01193             SetRectRgn(hrgnUpdate, 0, 0, 0, 0);
01194         <span class="keywordflow">if</span> (lprcUpdate)
01195             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a35">SetRectEmpty</a>(lprcUpdate);
01196         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01197     }
01198 
01199     <span class="keywordflow">return</span> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a257">NtUserScrollDC</a>(hDC, dx, dy, lprcScroll, lprcClip,
01200             hrgnUpdate, lprcUpdate);
01201 }
01202 
01203 
<a name="l01204"></a><a class="code" href="../../d3/d8/client_8c.html#a49">01204</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d3/d8/client_8c.html#a49">DrawIcon</a>(HDC hdc,<span class="keywordtype">int</span> x,<span class="keywordtype">int</span> y,HICON hicon)
01205 {
01206     <span class="keywordflow">return</span> <a class="code" href="../../d3/d8/client_8c.html#a50">DrawIconEx</a>(hdc, x, y, hicon, 0, 0, 0, 0, DI_NORMAL | DI_COMPAT | DI_DEFAULTSIZE );
01207 }
01208 
01209 
<a name="l01210"></a><a class="code" href="../../d3/d8/client_8c.html#a50">01210</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d8/client_8c.html#a50">DrawIconEx</a>( HDC hdc, <span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y, HICON hIcon,
01211                  <span class="keywordtype">int</span> cx, <span class="keywordtype">int</span> cy, UINT istepIfAniCur,
01212                  HBRUSH hbrFlickerFreeDraw, UINT diFlags)
01213 {
01214     <a class="code" href="../../d9/d8/struct__DRAWICONEXDATA.html">DRAWICONEXDATA</a> did;
01215     HBITMAP hbmT;
01216     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> retval = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01217     HDC hdcr;
01218 
01219     <span class="keywordflow">if</span> (diFlags &amp; ~DI_VALID) {
01220         RIPERR0(ERROR_INVALID_PARAMETER, RIP_VERBOSE, <span class="stringliteral">""</span>);
01221         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01222     }
01223 
01224     <span class="keywordflow">if</span> (diFlags &amp; DI_DEFAULTSIZE) {
01225         cx = 0;
01226         <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> = 0;
01227     }
01228 
01229     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d0/usercli_8h.html#a547">IsMetaFile</a>(hdc)) {
01230         hdcr = GdiConvertAndCheckDC(hdc);
01231         <span class="keywordflow">if</span> (hdcr == (HDC)0)
01232             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01233 
01234         <span class="keywordflow">return</span> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a107">NtUserDrawIconEx</a>(hdcr, x, y, hIcon, cx, <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>, istepIfAniCur,
01235                                 hbrFlickerFreeDraw, diFlags, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;did);
01236     }
01237 
01238     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a107">NtUserDrawIconEx</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, 0, hIcon, cx, <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>, 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, &amp;did)) {
01239         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01240     }
01241 
01242     <span class="keywordflow">if</span> (diFlags == 0)
01243         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01244 
01245     RtlEnterCriticalSection(&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a23">gcsHdc</a>);
01246 
01247     <span class="comment">/*</span>
01248 <span class="comment">     * Setup the attributes</span>
01249 <span class="comment">     */</span>
01250     <span class="keywordflow">if</span> (!cx)
01251         cx = did.<a class="code" href="../../d9/d8/struct__DRAWICONEXDATA.html#o2">cx</a>;
01252     <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>)
01253         <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> = did.<a class="code" href="../../d9/d8/struct__DRAWICONEXDATA.html#o3">cy</a> / 2;
01254 
01255     SetTextColor(hdc, 0x00000000L);
01256     SetBkColor(hdc, 0x00FFFFFFL);
01257 
01258     <span class="keywordflow">if</span> (diFlags &amp; DI_MASK) {
01259 
01260         <span class="keywordflow">if</span> (did.<a class="code" href="../../d9/d8/struct__DRAWICONEXDATA.html#o0">hbmMask</a>) {
01261 
01262             hbmT = SelectObject(<a class="code" href="../../d1/d8/clglobal_8c.html#a26">ghdcBits2</a>, did.<a class="code" href="../../d9/d8/struct__DRAWICONEXDATA.html#o0">hbmMask</a>);
01263             StretchBlt(hdc,
01264                        x,
01265                        y,
01266                        cx,
01267                        <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>,
01268                        <a class="code" href="../../d1/d8/clglobal_8c.html#a26">ghdcBits2</a>,
01269                        0,
01270                        0,
01271                        did.<a class="code" href="../../d9/d8/struct__DRAWICONEXDATA.html#o2">cx</a>,
01272                        did.<a class="code" href="../../d9/d8/struct__DRAWICONEXDATA.html#o3">cy</a> / 2,
01273                        SRCAND);
01274             SelectObject(<a class="code" href="../../d1/d8/clglobal_8c.html#a26">ghdcBits2</a>,hbmT);
01275             retval = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01276         }
01277     }
01278 
01279     <span class="keywordflow">if</span> (diFlags &amp; DI_IMAGE) {
01280 
01281         <span class="keywordflow">if</span> (did.<a class="code" href="../../d9/d8/struct__DRAWICONEXDATA.html#o1">hbmColor</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01282             hbmT = SelectObject(<a class="code" href="../../d1/d8/clglobal_8c.html#a26">ghdcBits2</a>, did.<a class="code" href="../../d9/d8/struct__DRAWICONEXDATA.html#o1">hbmColor</a>);
01283             StretchBlt(hdc,
01284                        x,
01285                        y,
01286                        cx,
01287                        <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>,
01288                        <a class="code" href="../../d1/d8/clglobal_8c.html#a26">ghdcBits2</a>,
01289                        0,
01290                        0,
01291                        did.<a class="code" href="../../d9/d8/struct__DRAWICONEXDATA.html#o2">cx</a>,
01292                        did.<a class="code" href="../../d9/d8/struct__DRAWICONEXDATA.html#o3">cy</a> / 2,
01293                        SRCINVERT);
01294             SelectObject(<a class="code" href="../../d1/d8/clglobal_8c.html#a26">ghdcBits2</a>, hbmT);
01295             retval = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01296         } <span class="keywordflow">else</span> {
01297             <span class="keywordflow">if</span> (did.<a class="code" href="../../d9/d8/struct__DRAWICONEXDATA.html#o0">hbmMask</a>) {
01298                 hbmT = SelectObject(<a class="code" href="../../d1/d8/clglobal_8c.html#a26">ghdcBits2</a>, did.<a class="code" href="../../d9/d8/struct__DRAWICONEXDATA.html#o0">hbmMask</a>);
01299                 StretchBlt(hdc,
01300                            x,
01301                            y,
01302                            cx,
01303                            <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>,
01304                            <a class="code" href="../../d1/d8/clglobal_8c.html#a26">ghdcBits2</a>,
01305                            0,
01306                            did.<a class="code" href="../../d9/d8/struct__DRAWICONEXDATA.html#o3">cy</a> / 2,
01307                            did.<a class="code" href="../../d9/d8/struct__DRAWICONEXDATA.html#o2">cx</a>,
01308                            did.<a class="code" href="../../d9/d8/struct__DRAWICONEXDATA.html#o3">cy</a> / 2,
01309                            SRCINVERT);
01310                 SelectObject(<a class="code" href="../../d1/d8/clglobal_8c.html#a26">ghdcBits2</a>, hbmT);
01311                 retval = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01312             }
01313         }
01314     }
01315     RtlLeaveCriticalSection(&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a23">gcsHdc</a>);
01316 
01317     <span class="keywordflow">return</span> retval;
01318 }
01319 
01320 
01321 
<a name="l01322"></a><a class="code" href="../../d3/d8/client_8c.html#a51">01322</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d3/d8/client_8c.html#a51">ValidateRgn</a>(HWND hWnd,HRGN hRgn)
01323 {
01324     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a179">NtUserCallHwndParamLock</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, (ULONG_PTR)hRgn,
01325                                          SFI_XXXVALIDATERGN);
01326 }
01327 
<a name="l01328"></a><a class="code" href="../../d3/d8/client_8c.html#a52">01328</a> <span class="keywordtype">int</span> WINAPI <a class="code" href="../../d3/d8/client_8c.html#a52">GetUpdateRgn</a>(HWND hWnd, HRGN hRgn, BOOL bErase)
01329 {
01330     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
01331 
01332     <span class="keywordflow">if</span> (hRgn == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01333         RIPERR1(ERROR_INVALID_HANDLE, RIP_WARNING, <span class="stringliteral">"Invalid region %#p"</span>, hRgn);
01334         <span class="keywordflow">return</span> ERROR;
01335     }
01336 
01337     <span class="keywordflow">if</span> ((pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01338         <span class="keywordflow">return</span> ERROR;
01339     }
01340 
01341     <span class="comment">/*</span>
01342 <span class="comment">     * Check for the simple case where nothing needs to be done.</span>
01343 <span class="comment">     */</span>
01344     <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
01345             !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a560">WFSENDERASEBKGND</a>) &amp;&amp;
01346             !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a562">WFSENDNCPAINT</a>) &amp;&amp;
01347             !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a564">WFUPDATEDIRTY</a>) &amp;&amp;
01348             !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a573">WFPAINTNOTPROCESSED</a>)) {
01349         SetRectRgn(hRgn, 0, 0, 0, 0);
01350         <span class="keywordflow">return</span> NULLREGION;
01351     }
01352 
01353     <span class="keywordflow">return</span> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a253">NtUserGetUpdateRgn</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, hRgn, bErase);
01354 }
01355 
01356 
<a name="l01357"></a><a class="code" href="../../d3/d8/client_8c.html#a53">01357</a> <span class="keywordtype">int</span> WINAPI <a class="code" href="../../d3/d8/client_8c.html#a53">GetUpdateRect</a>(HWND hWnd, LPRECT lprc, BOOL bErase)
01358 {
01359     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
01360 
01361     <span class="keywordflow">if</span> ((pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01362         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01363     }
01364 
01365     <span class="comment">/*</span>
01366 <span class="comment">     * Check for the simple case where nothing needs to be done.</span>
01367 <span class="comment">     */</span>
01368     <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
01369             !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a560">WFSENDERASEBKGND</a>) &amp;&amp;
01370             !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a562">WFSENDNCPAINT</a>) &amp;&amp;
01371             !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a564">WFUPDATEDIRTY</a>) &amp;&amp;
01372             !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a573">WFPAINTNOTPROCESSED</a>)) {
01373         <span class="keywordflow">if</span> (lprc)
01374             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a35">SetRectEmpty</a>(lprc);
01375         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01376     }
01377 
01378     <span class="keywordflow">return</span> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a203">NtUserGetUpdateRect</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, lprc, bErase);
01379 }
01380 
01381 
01382 <span class="comment">/***************************************************************************\</span>
01383 <span class="comment">* ScrollWindow (API)</span>
01384 <span class="comment">*</span>
01385 <span class="comment">*</span>
01386 <span class="comment">* History:</span>
01387 <span class="comment">* 18-Jul-1991 DarrinM   Ported from Win 3.1 sources.</span>
01388 <span class="comment">\***************************************************************************/</span>
01389 
<a name="l01390"></a><a class="code" href="../../d3/d8/client_8c.html#a4">01390</a> <span class="preprocessor">#define SW_FLAG_RC  (SW_SCROLLWINDOW | SW_INVALIDATE | SW_ERASE | SW_SCROLLCHILDREN)</span>
<a name="l01391"></a><a class="code" href="../../d3/d8/client_8c.html#a5">01391</a> <span class="preprocessor"></span><span class="preprocessor">#define SW_FLAG_NRC (SW_SCROLLWINDOW | SW_INVALIDATE | SW_ERASE)</span>
01392 <span class="preprocessor"></span>
01393 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI
<a name="l01394"></a><a class="code" href="../../d3/d8/client_8c.html#a54">01394</a> <a class="code" href="../../d3/d8/client_8c.html#a54">ScrollWindow</a>(
01395     HWND hwnd,
01396     <span class="keywordtype">int</span> dx,
01397     <span class="keywordtype">int</span> dy,
01398     CONST RECT *prcScroll,
01399     CONST RECT *prcClip)
01400 {
01401     <span class="keywordflow">return</span> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a219">NtUserScrollWindowEx</a>(
01402             hwnd,
01403             dx,
01404             dy,
01405             prcScroll,
01406             prcClip,
01407             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01408             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01409             !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a98">IS_PTR</a>(prcScroll) ? <a class="code" href="../../d3/d8/client_8c.html#a4">SW_FLAG_RC</a> : <a class="code" href="../../d3/d8/client_8c.html#a5">SW_FLAG_NRC</a>) != ERROR;
01410 }
01411 
01412 <span class="comment">/***************************************************************************\</span>
01413 <span class="comment">*</span>
01414 <span class="comment">*  SwitchToThisWindow()</span>
01415 <span class="comment">*</span>
01416 <span class="comment">\***************************************************************************/</span>
01417 
<a name="l01418"></a><a class="code" href="../../d3/d8/client_8c.html#a55">01418</a> <span class="keywordtype">void</span> WINAPI <a class="code" href="../../d3/d8/client_8c.html#a55">SwitchToThisWindow</a>(
01419     HWND hwnd,
01420     BOOL fAltTab)
01421 {
01422     (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a179">NtUserCallHwndParamLock</a>(hwnd, fAltTab, SFI_XXXSWITCHTOTHISWINDOW);
01423 }
01424 
01425 
01426 <span class="comment">/***************************************************************************\</span>
01427 <span class="comment">* WaitForInputIdle</span>
01428 <span class="comment">*</span>
01429 <span class="comment">* Waits for a given process to go idle.</span>
01430 <span class="comment">*</span>
01431 <span class="comment">* 09-18-91 ScottLu Created.</span>
01432 <span class="comment">\***************************************************************************/</span>
01433 
<a name="l01434"></a><a class="code" href="../../d3/d8/client_8c.html#a56">01434</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d3/d8/client_8c.html#a56">WaitForInputIdle</a>(
01435     HANDLE hProcess,
01436     DWORD dwMilliseconds)
01437 {
01438     PROCESS_BASIC_INFORMATION processinfo;
01439     ULONG_PTR idProcess;
01440     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01441     <span class="comment">/*</span>
01442 <span class="comment">     * First get the process id from the hProcess.</span>
01443 <span class="comment">     */</span>
01444     status = <a class="code" href="../../d9/d1/psquery_8c.html#a18">NtQueryInformationProcess</a>(hProcess, ProcessBasicInformation,
01445             &amp;processinfo, <span class="keyword">sizeof</span>(processinfo), <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01446     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01447         <span class="keywordflow">if</span> (status == STATUS_OBJECT_TYPE_MISMATCH) {
01448             <span class="keywordflow">if</span> ((ULONG_PTR)hProcess &amp; 0x2) {
01449             <span class="comment">/*</span>
01450 <span class="comment">             * WOW Process handles are really semaphore handles.</span>
01451 <span class="comment">             * CreateProcess ORs in a 0x2 (the low 2 bits of handles</span>
01452 <span class="comment">             * are not used) so we can identify it more clearly.</span>
01453 <span class="comment">             */</span>
01454                 idProcess = ((ULONG_PTR)hProcess &amp; ~0x03);
01455                 <span class="keywordflow">return</span> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a244">NtUserWaitForInputIdle</a>(idProcess, dwMilliseconds, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01456             }
01457 
01458             <span class="comment">/*</span>
01459 <span class="comment">             * VDM (DOS) Process handles are really semaphore handles.</span>
01460 <span class="comment">             * CreateProcess ORs in a 0x1 (the low 2 bits of handles</span>
01461 <span class="comment">             * are not used) so we can identify and return immidiately.</span>
01462 <span class="comment">             */</span>
01463             <span class="keywordflow">if</span> ((ULONG_PTR)hProcess &amp; 0x1) {
01464                 <span class="keywordflow">return</span> 0;
01465             }
01466         }
01467 
01468         RIPERR1(ERROR_INVALID_HANDLE, RIP_WARNING, <span class="stringliteral">"WaitForInputIdle invalid process"</span>, hProcess);
01469         <span class="keywordflow">return</span> (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)-1;
01470     }
01471     idProcess = processinfo.UniqueProcessId;
01472     <span class="keywordflow">return</span> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a244">NtUserWaitForInputIdle</a>(idProcess, dwMilliseconds, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01473 }
01474 
<a name="l01475"></a><a class="code" href="../../d3/d8/client_8c.html#a57">01475</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> WINAPI <a class="code" href="../../d3/d8/client_8c.html#a57">MsgWaitForMultipleObjects</a>(
01476     DWORD nCount,
01477     CONST HANDLE *pHandles,
01478     BOOL fWaitAll,
01479     DWORD dwMilliseconds,
01480     DWORD dwWakeMask)
01481 {
01482     <span class="keywordflow">return</span>  <a class="code" href="../../d3/d8/client_8c.html#a58">MsgWaitForMultipleObjectsEx</a>(nCount, pHandles,
01483                 dwMilliseconds, dwWakeMask, fWaitAll?MWMO_WAITALL:0);
01484 }
01485 
<a name="l01486"></a><a class="code" href="../../d3/d8/client_8c.html#a58">01486</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> WINAPI <a class="code" href="../../d3/d8/client_8c.html#a58">MsgWaitForMultipleObjectsEx</a>(
01487     DWORD nCount,
01488     CONST HANDLE *pHandles,
01489     DWORD dwMilliseconds,
01490     DWORD dwWakeMask,
01491     DWORD dwFlags)
01492 {
01493     HANDLE hEventInput;
01494     PHANDLE ph;
01495     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwIndex;
01496     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  ReenterWowScheduler;
01497     <a class="code" href="../../d2/d2/struct__CLIENTINFO.html">PCLIENTINFO</a> pci;
01498     HANDLE rgHandles[ 8 + 1 ];
01499     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fWaitAll = ((<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; MWMO_WAITALL) != 0);
01500     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fAlertable = ((<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; MWMO_ALERTABLE) != 0);
01501     <a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html">PCLIENTTHREADINFO</a> pcti;
01502 
01503     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; ~MWMO_VALID) {
01504         RIPERR1(ERROR_INVALID_PARAMETER, RIP_ERROR, <span class="stringliteral">"MsgWaitForMultipleObjectsEx, invalid flags 0x%08lx\n"</span>, <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>);
01505         <span class="keywordflow">return</span> (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)-1;
01506     }
01507 
01508     pci = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a16">GetClientInfo</a>();
01509     <span class="keywordflow">if</span> (pci == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01510         <span class="keywordflow">return</span> (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)-1;
01511 
01512     <span class="comment">/*</span>
01513 <span class="comment">     * If we have a pcti, see if we can return immediately.</span>
01514 <span class="comment">     * pcti migth be NULL if this is the first W32 call made by this thread.</span>
01515 <span class="comment">     */</span>
01516 
01517     pcti = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a16">GetClientInfo</a>()-&gt;pClientThreadInfo;
01518     <span class="keywordflow">if</span> (pcti &amp;&amp; (!fWaitAll || !nCount)) {
01519         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/inc_2user_8h.html#a1143">GetInputBits</a>(pcti, LOWORD(dwWakeMask), (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; MWMO_INPUTAVAILABLE))) {
01520             <span class="keywordflow">return</span> nCount;
01521         }
01522     }
01523 
01524     <span class="comment">/*</span>
01525 <span class="comment">     * Note -- the wake mask is a WORD, and only 3 flags are defined, so</span>
01526 <span class="comment">     * they can be combined for the call.</span>
01527 <span class="comment">     */</span>
01528 
01529     hEventInput = (HANDLE)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a174">NtUserCallOneParam</a>(MAKELONG(dwWakeMask, <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>), SFI_XXXGETINPUTEVENT);
01530 
01531     <span class="keywordflow">if</span> (hEventInput == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01532         RIPMSG0(RIP_WARNING, <span class="stringliteral">"MsgWaitForMultipleObjectsEx, GetInputEvent failed\n"</span>);
01533         <span class="keywordflow">return</span> (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)-1;
01534     }
01535 
01536     <span class="comment">/*</span>
01537 <span class="comment">     * If needed, allocate a new array of handles that will include</span>
01538 <span class="comment">     * the input event handle.</span>
01539 <span class="comment">     */</span>
01540     ph = rgHandles;
01541     <span class="keywordflow">if</span> (pHandles) {
01542 
01543         <span class="keywordflow">if</span> (nCount &gt; 8) {
01544             ph = (PHANDLE)LocalAlloc(LPTR, <span class="keyword">sizeof</span>(HANDLE) * (nCount + 1));
01545             <span class="keywordflow">if</span> (ph == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01546                 <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a173">NtUserCallNoParam</a>(SFI_CLEARWAKEMASK);
01547                 <span class="keywordflow">return</span> (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)-1;
01548             }
01549         }
01550 
01551         RtlCopyMemory((PVOID)ph, pHandles, <span class="keyword">sizeof</span>(HANDLE) * nCount);
01552 
01553     } <span class="keywordflow">else</span> {
01554         <span class="comment">// if this isn't Zero, the function parameters are invalid</span>
01555         nCount = 0;
01556     }
01557 
01558     ph[nCount] = hEventInput;
01559 
01560 
01561     <span class="comment">/*</span>
01562 <span class="comment">     *  WowApps must exit the Wow scheduler otherwise other tasks</span>
01563 <span class="comment">     *  in this Wow scheduler can't run. The only exception is if</span>
01564 <span class="comment">     *  the timeout is Zero.  We pass HEVENT_REMOVEME as the handle so we will go</span>
01565 <span class="comment">     *  into the sleeptask AND return without going to sleep but letting</span>
01566 <span class="comment">     *  other apps run.</span>
01567 <span class="comment">     */</span>
01568     <span class="keywordflow">if</span> ((pci-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o4">dwTIFlags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>) &amp;&amp; dwMilliseconds) {
01569         ReenterWowScheduler = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01570         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a103">NtUserWaitForMsgAndEvent</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a17">HEVENT_REMOVEME</a>);
01571         <span class="comment">/*</span>
01572 <span class="comment">         * If our wait condition is satisfied, make sure we won't wait.</span>
01573 <span class="comment">         * We must have a pcti now since we just went to the kernel</span>
01574 <span class="comment">         */</span>
01575         pcti = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a16">GetClientInfo</a>()-&gt;pClientThreadInfo;
01576         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/inc_2user_8h.html#a1143">GetInputBits</a>(pcti, LOWORD(dwWakeMask), (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; MWMO_INPUTAVAILABLE))) {
01577             SetEvent(hEventInput);
01578         }
01579     } <span class="keywordflow">else</span> {
01580         ReenterWowScheduler = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01581     }
01582 
01583     dwIndex = WaitForMultipleObjectsEx(nCount + 1, ph, fWaitAll, dwMilliseconds, fAlertable);
01584 
01585     <span class="comment">/*</span>
01586 <span class="comment">     * Clear the wake mask since we're done waiting on these events.</span>
01587 <span class="comment">     */</span>
01588     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a173">NtUserCallNoParam</a>(SFI_CLEARWAKEMASK);
01589 
01590     <span class="comment">/*</span>
01591 <span class="comment">     *  If needed reenter the wow scheduler</span>
01592 <span class="comment">     */</span>
01593     <span class="keywordflow">if</span> (ReenterWowScheduler) {
01594         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a174">NtUserCallOneParam</a>(DY_OLDYIELD, SFI_XXXDIRECTEDYIELD);
01595     }
01596 
01597     <span class="keywordflow">if</span> (ph != rgHandles) {
01598         LocalFree(ph);
01599     }
01600 
01601     <span class="keywordflow">return</span> dwIndex;
01602 }
01603 
01604 <span class="comment">/***************************************************************************\</span>
01605 <span class="comment">* GrayString</span>
01606 <span class="comment">*</span>
01607 <span class="comment">* GrayStingA used to convert the string and call GrayStringW but that</span>
01608 <span class="comment">* did not work in a number of special cases such as the app passing in</span>
01609 <span class="comment">* a pointer to a zero length string.  Eventually GrayStringA had almost as</span>
01610 <span class="comment">* much code as GrayStringW so now they are one.</span>
01611 <span class="comment">*</span>
01612 <span class="comment">* History:</span>
01613 <span class="comment">* 06-11-91 JimA     Created.</span>
01614 <span class="comment">* 06-17-91 ChuckWh  Added GDI handle conversion.</span>
01615 <span class="comment">* 02-12-92 mikeke   Made it completely client side</span>
01616 <span class="comment">\***************************************************************************/</span>
01617 
<a name="l01618"></a><a class="code" href="../../d3/d8/client_8c.html#a59">01618</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d8/client_8c.html#a59">InnerGrayStringAorW</a>(
01619     HDC            hdc,
01620     HBRUSH         hbr,
01621     GRAYSTRINGPROC lpfnPrint,
01622     LPARAM         lParam,
01623     <span class="keywordtype">int</span>            cch,
01624     <span class="keywordtype">int</span>            x,
01625     <span class="keywordtype">int</span>            y,
01626     <span class="keywordtype">int</span>            cx,
01627     <span class="keywordtype">int</span>            cy,
01628     BOOL           bAnsi)
01629 {
01630     HBITMAP hbm;
01631     HBITMAP hbmOld;
01632     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    fResult;
01633     HFONT   hFontSave = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01634     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    fReturn = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01635 <span class="preprocessor">#ifdef USE_MIRRORING</span>
01636 <span class="preprocessor"></span>    <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>   dwOldLayout = GDI_ERROR;
01637 <span class="preprocessor">#endif</span>
01638 <span class="preprocessor"></span>    <span class="comment">/*</span>
01639 <span class="comment">     * Win 3.1 tries to calc the size even if we don't know if it is a string.</span>
01640 <span class="comment">     */</span>
01641     <span class="keywordflow">if</span> (cch == 0) {
01642 
01643         <span class="keywordflow">try</span> {
01644 
01645             cch = bAnsi ? <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>((LPSTR)lParam) : wcslen((LPWSTR)lParam);
01646 
01647         } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, RIP_WARNING)) {
01648             fReturn = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01649         }
01650 
01651         <span class="keywordflow">if</span> (fReturn)
01652             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01653     }
01654 
01655     <span class="keywordflow">if</span> (cx == 0 || <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> == 0) {
01656 
01657        SIZE size;
01658 
01659         <span class="comment">/*</span>
01660 <span class="comment">         * We use the caller supplied hdc (instead of hdcBits) since we may be</span>
01661 <span class="comment">         * graying a font which is different than the system font and we want to</span>
01662 <span class="comment">         * get the proper text extents.</span>
01663 <span class="comment">         */</span>
01664         <span class="keywordflow">try</span> {
01665             <span class="keywordflow">if</span> (bAnsi) {
01666                 GetTextExtentPointA(hdc, (LPSTR)lParam, cch, &amp;size);
01667             } <span class="keywordflow">else</span> {
01668                 GetTextExtentPointW(hdc, (LPWSTR)lParam, cch, &amp;size);
01669             }
01670 
01671             cx = size.cx;
01672             <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> = size.cy;
01673 
01674         } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, RIP_WARNING)) {
01675             fReturn = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01676         }
01677 
01678         <span class="keywordflow">if</span> (fReturn)
01679             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01680     }
01681 
01682     UserAssert (<a class="code" href="../../d1/d8/clglobal_8c.html#a27">ghdcGray</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01683 
01684     RtlEnterCriticalSection(&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a23">gcsHdc</a>);
01685 
01686     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/clglobal_8c.html#a30">gcxGray</a> &lt; cx || <a class="code" href="../../d1/d8/clglobal_8c.html#a31">gcyGray</a> &lt; <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>) {
01687 
01688         <span class="keywordflow">if</span> ((hbm = CreateBitmap(cx, <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>, 1, 1, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01689 
01690             hbmOld = SelectObject(<a class="code" href="../../d1/d8/clglobal_8c.html#a27">ghdcGray</a>, hbm);
01691             DeleteObject(hbmOld);
01692 
01693             <a class="code" href="../../d1/d8/clglobal_8c.html#a30">gcxGray</a> = cx;
01694             <a class="code" href="../../d1/d8/clglobal_8c.html#a31">gcyGray</a> = <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>;
01695 
01696         } <span class="keywordflow">else</span> {
01697             cx = <a class="code" href="../../d1/d8/clglobal_8c.html#a30">gcxGray</a>;
01698             <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> = <a class="code" href="../../d1/d8/clglobal_8c.html#a31">gcyGray</a>;
01699         }
01700     }
01701 
01702 <span class="preprocessor">#ifdef USE_MIRRORING</span>
01703 <span class="preprocessor"></span>    <span class="comment">/*</span>
01704 <span class="comment">     * If the caller hdc is mirrored then mirror ghdcGray.</span>
01705 <span class="comment">     */</span>
01706     <span class="keywordflow">if</span> (MIRRORED_HDC(hdc)) {
01707         dwOldLayout = SetLayoutWidth(<a class="code" href="../../d1/d8/clglobal_8c.html#a27">ghdcGray</a>, cx, LAYOUT_RTL);
01708     }
01709 <span class="preprocessor">#endif</span>
01710 <span class="preprocessor"></span>
01711     <span class="comment">/*</span>
01712 <span class="comment">     * Force the ghdcGray font to be the same as hDC; ghdcGray is always</span>
01713 <span class="comment">     * the system font</span>
01714 <span class="comment">     */</span>
01715     hFontSave = SelectObject(hdc, <a class="code" href="../../d1/d8/clglobal_8c.html#a28">ghFontSys</a>);
01716 
01717     <span class="keywordflow">if</span> (hFontSave != <a class="code" href="../../d1/d8/clglobal_8c.html#a28">ghFontSys</a>) {
01718         SelectObject(hdc, hFontSave);
01719         hFontSave = SelectObject(<a class="code" href="../../d1/d8/clglobal_8c.html#a27">ghdcGray</a>, hFontSave);
01720     }
01721 
01722     <span class="keywordflow">if</span> (lpfnPrint != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01723         PatBlt(<a class="code" href="../../d1/d8/clglobal_8c.html#a27">ghdcGray</a>, 0, 0, cx, <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>, WHITENESS);
01724         fResult = (*lpfnPrint)(<a class="code" href="../../d1/d8/clglobal_8c.html#a27">ghdcGray</a>, lParam, cch);
01725     } <span class="keywordflow">else</span> {
01726 
01727         <span class="keywordflow">if</span> (bAnsi) {
01728             fResult = TextOutA(<a class="code" href="../../d1/d8/clglobal_8c.html#a27">ghdcGray</a>, 0, 0, (LPSTR)lParam, cch);
01729         } <span class="keywordflow">else</span> {
01730             fResult = TextOutW(<a class="code" href="../../d1/d8/clglobal_8c.html#a27">ghdcGray</a>, 0, 0, (LPWSTR)lParam, cch);
01731         }
01732     }
01733 
01734     <span class="keywordflow">if</span> (fResult)
01735         PatBlt(<a class="code" href="../../d1/d8/clglobal_8c.html#a27">ghdcGray</a>, 0, 0, cx, <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a24">DESTINATION</a> | <a class="code" href="../../d9/d4/localrtl_8c.html#a0">PATTERN</a>);
01736 
01737     <span class="keywordflow">if</span> (fResult || cch == -1) {
01738 
01739         HBRUSH hbrSave;
01740         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>  textColorSave;
01741         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>  bkColorSave;
01742 
01743         textColorSave = SetTextColor(hdc, 0x00000000L);
01744         bkColorSave = SetBkColor(hdc, 0x00FFFFFFL);
01745 
01746         hbrSave = SelectObject(hdc, hbr ? hbr : <a class="code" href="../../d1/d8/clglobal_8c.html#a29">ghbrWindowText</a>);
01747 
01748         BitBlt(hdc,
01749                x,
01750                y,
01751                cx,
01752                <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>,
01753                <a class="code" href="../../d1/d8/clglobal_8c.html#a27">ghdcGray</a>,
01754                0,
01755                0,
01756                (((<a class="code" href="../../d9/d4/localrtl_8c.html#a0">PATTERN</a> ^ <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a24">DESTINATION</a>) &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a25">SOURCE</a>) ^ <a class="code" href="../../d9/d4/localrtl_8c.html#a0">PATTERN</a>));
01757 
01758         SelectObject(hdc, hbrSave);
01759 
01760         <span class="comment">/*</span>
01761 <span class="comment">         * Restore saved colors</span>
01762 <span class="comment">         */</span>
01763         SetTextColor(hdc, textColorSave);
01764         SetBkColor(hdc, bkColorSave);
01765     }
01766 
01767     SelectObject(<a class="code" href="../../d1/d8/clglobal_8c.html#a27">ghdcGray</a>, hFontSave);
01768 <span class="preprocessor">#ifdef USE_MIRRORING</span>
01769 <span class="preprocessor"></span>    <span class="comment">/*</span>
01770 <span class="comment">     * Restore ghdcGray layout state.</span>
01771 <span class="comment">     */</span>
01772     <span class="keywordflow">if</span> (dwOldLayout != GDI_ERROR) {
01773         SetLayoutWidth(<a class="code" href="../../d1/d8/clglobal_8c.html#a27">ghdcGray</a>, cx, dwOldLayout);
01774     }
01775 <span class="preprocessor">#endif</span>
01776 <span class="preprocessor"></span>    RtlLeaveCriticalSection(&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a23">gcsHdc</a>);
01777 
01778     <span class="keywordflow">return</span> fResult;
01779 }
01780 
<a name="l01781"></a><a class="code" href="../../d3/d8/client_8c.html#a60">01781</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d8/client_8c.html#a60">GrayStringA</a>(
01782     HDC            hdc,
01783     HBRUSH         hbr,
01784     GRAYSTRINGPROC lpfnPrint,
01785     LPARAM         lParam,
01786     <span class="keywordtype">int</span>            cch,
01787     <span class="keywordtype">int</span>            x,
01788     <span class="keywordtype">int</span>            y,
01789     <span class="keywordtype">int</span>            cx,
01790     <span class="keywordtype">int</span>            cy)
01791 {
01792     <span class="keywordflow">return</span> (<a class="code" href="../../d3/d8/client_8c.html#a59">InnerGrayStringAorW</a>(hdc,
01793                                 hbr,
01794                                 lpfnPrint,
01795                                 lParam,
01796                                 cch,
01797                                 x,
01798                                 y,
01799                                 cx,
01800                                 <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>,
01801                                 <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>));
01802 }
01803 
<a name="l01804"></a><a class="code" href="../../d3/d8/client_8c.html#a61">01804</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d8/client_8c.html#a61">GrayStringW</a>(
01805     HDC            hdc,
01806     HBRUSH         hbr,
01807     GRAYSTRINGPROC lpfnPrint,
01808     LPARAM         lParam,
01809     <span class="keywordtype">int</span>            cch,
01810     <span class="keywordtype">int</span>            x,
01811     <span class="keywordtype">int</span>            y,
01812     <span class="keywordtype">int</span>            cx,
01813     <span class="keywordtype">int</span>            cy)
01814 {
01815     <span class="keywordflow">return</span> (<a class="code" href="../../d3/d8/client_8c.html#a59">InnerGrayStringAorW</a>(hdc,
01816                                 hbr,
01817                                 lpfnPrint,
01818                                 lParam,
01819                                 cch,
01820                                 x,
01821                                 y,
01822                                 cx,
01823                                 <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>,
01824                                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>));
01825 }
01826 
01827 
01828 <span class="comment">/***************************************************************************\</span>
01829 <span class="comment">* GetUserObjectSecurity (API)</span>
01830 <span class="comment">*</span>
01831 <span class="comment">* Gets the security descriptor of an object</span>
01832 <span class="comment">*</span>
01833 <span class="comment">* History:</span>
01834 <span class="comment">* 07-01-91 JimA         Created.</span>
01835 <span class="comment">\***************************************************************************/</span>
01836 
<a name="l01837"></a><a class="code" href="../../d3/d8/client_8c.html#a62">01837</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d8/client_8c.html#a62">GetUserObjectSecurity</a>(
01838     HANDLE hObject,
01839     PSECURITY_INFORMATION pRequestedInformation,
01840     PSECURITY_DESCRIPTOR pSecurityDescriptor,
01841     DWORD nLength,
01842     LPDWORD lpnLengthRequired)
01843 {
01844     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01845 
01846     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/obse_8c.html#a2">NtQuerySecurityObject</a>(hObject,
01847                                    *pRequestedInformation,
01848                                    pSecurityDescriptor,
01849                                    nLength,
01850                                    lpnLengthRequired);
01851     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01852         RIPNTERR0(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>, RIP_VERBOSE, <span class="stringliteral">""</span>);
01853         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01854     }
01855     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01856 }
01857 
01858 
01859 <span class="comment">/***************************************************************************\</span>
01860 <span class="comment">* SetUserObjectSecurity (API)</span>
01861 <span class="comment">*</span>
01862 <span class="comment">* Sets the security descriptor of an object</span>
01863 <span class="comment">*</span>
01864 <span class="comment">* History:</span>
01865 <span class="comment">* 07-01-91 JimA         Created.</span>
01866 <span class="comment">\***************************************************************************/</span>
01867 
<a name="l01868"></a><a class="code" href="../../d3/d8/client_8c.html#a63">01868</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d8/client_8c.html#a63">SetUserObjectSecurity</a>(
01869     HANDLE hObject,
01870     PSECURITY_INFORMATION pRequestedInformation,
01871     PSECURITY_DESCRIPTOR pSecurityDescriptor)
01872 {
01873     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01874 
01875     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/obse_8c.html#a0">NtSetSecurityObject</a>(hObject,
01876                                  *pRequestedInformation,
01877                                  pSecurityDescriptor);
01878     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01879         RIPNTERR0(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>, RIP_VERBOSE, <span class="stringliteral">""</span>);
01880         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01881     }
01882     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01883 }
01884 
01885 
01886 <span class="comment">/***************************************************************************\</span>
01887 <span class="comment">* GetUserObjectInformation (API)</span>
01888 <span class="comment">*</span>
01889 <span class="comment">* Gets information about an object</span>
01890 <span class="comment">*</span>
01891 <span class="comment">* History:</span>
01892 <span class="comment">\***************************************************************************/</span>
01893 
<a name="l01894"></a><a class="code" href="../../d3/d8/client_8c.html#a64">01894</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d8/client_8c.html#a64">GetUserObjectInformationA</a>(
01895     HANDLE hObject,
01896     <span class="keywordtype">int</span> nIndex,
01897     PVOID pvInfo,
01898     DWORD nLength,
01899     LPDWORD pnLengthNeeded)
01900 {
01901     PVOID pvInfoW;
01902     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> nLengthW;
01903     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fSuccess;
01904 
01905     <span class="keywordflow">if</span> (nIndex == UOI_NAME || nIndex == UOI_TYPE) {
01906         nLengthW = nLength * <span class="keyword">sizeof</span>(WCHAR);
01907         pvInfoW = LocalAlloc(LPTR, nLengthW);
01908         fSuccess = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a83">NtUserGetObjectInformation</a>(hObject, nIndex, pvInfoW,
01909                 nLengthW, pnLengthNeeded);
01910         <span class="keywordflow">if</span> (fSuccess) {
01911             <span class="keywordflow">if</span> (pnLengthNeeded != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01912                  *pnLengthNeeded /= <span class="keyword">sizeof</span>(WCHAR);
01913             WCSToMB(pvInfoW, -1, &amp;(PCHAR)pvInfo, nLength, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01914         }
01915         LocalFree(pvInfoW);
01916         <span class="keywordflow">return</span> fSuccess;
01917     } <span class="keywordflow">else</span> {
01918         <span class="keywordflow">return</span> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a83">NtUserGetObjectInformation</a>(hObject, nIndex, pvInfo,
01919                 nLength, pnLengthNeeded);
01920     }
01921 }
01922 
<a name="l01923"></a><a class="code" href="../../d3/d8/client_8c.html#a65">01923</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d8/client_8c.html#a65">GetWinStationInfo</a>(
01924     WSINFO* pWsInfo)
01925 {
01926     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a174">NtUserCallOneParam</a>((ULONG_PTR)pWsInfo, SFI__GETWINSTATIONINFO);
01927 }
01928 
01929 
01930 
<a name="l01931"></a><a class="code" href="../../d3/d8/client_8c.html#a66">01931</a> BOOLEAN <a class="code" href="../../d3/d8/client_8c.html#a66">WinStaQueryInformationW</a>(
01932         HANDLE hServer,
01933         ULONG ulLogonId,
01934         WINSTATIONINFOCLASS WinStationInformationClass,
01935         PVOID pWinStationInformation,
01936         ULONG ulWinStationInformationLength,
01937         PULONG pulReturnLength)
01938 {
01939     PWINSTATIONQUERYINFORMATIONW pfnWinStationQueryInformationW;
01940     HMODULE hwinsta;
01941     BOOLEAN fRet = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01942 
01943     <span class="comment">/*</span>
01944 <span class="comment">     *  Get handle to winsta.dll</span>
01945 <span class="comment">     */</span>
01946     <span class="keywordflow">if</span> ((hwinsta = LoadLibraryA(<span class="stringliteral">"WINSTA"</span>)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01947         <span class="keywordflow">if</span> ((pfnWinStationQueryInformationW = (PWINSTATIONQUERYINFORMATIONW)
01948              GetProcAddress(hwinsta, <span class="stringliteral">"WinStationQueryInformationW"</span>)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01949 
01950                 <span class="comment">/*</span>
01951 <span class="comment">                 * Fetch the WinStation's basic information</span>
01952 <span class="comment">                 */</span>
01953                 fRet = (*pfnWinStationQueryInformationW)(hServer,
01954                            ulLogonId,
01955                            WinStationInformationClass,
01956                            pWinStationInformation,
01957                            ulWinStationInformationLength,
01958                            pulReturnLength);
01959         }
01960         FreeLibrary(hwinsta);
01961     }
01962 
01963 
01964     <span class="keywordflow">return</span> fRet;
01965 }
01966 
01967 <span class="comment">/***************************************************************************\</span>
01968 <span class="comment">* GetServerIMEKeyboardLayout</span>
01969 <span class="comment">*</span>
01970 <span class="comment">* This routine finds HKL matches the IME module name sent from the Hydra</span>
01971 <span class="comment">* client at its session startup.</span>
01972 <span class="comment">* Hydra server tries to load the same IME module in the client, rather</span>
01973 <span class="comment">* than to use the same HKL: that's because, on FE machines,</span>
01974 <span class="comment">* the same IME might have different HKL dependent to each system.</span>
01975 <span class="comment">*</span>
01976 <span class="comment">* If the same IME name is found in registry, then it returns the HKL.</span>
01977 <span class="comment">* If it cannot find, return value is 0.</span>
01978 <span class="comment">*</span>
01979 <span class="comment">* History:</span>
01980 <span class="comment">\***************************************************************************/</span>
01981 
01982 ULONG
<a name="l01983"></a><a class="code" href="../../d3/d8/client_8c.html#a67">01983</a> <a class="code" href="../../d3/d8/client_8c.html#a67">GetServerIMEKeyboardLayout</a>(
01984     LPTSTR pszImeFileName)
01985 {
01986     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fFound = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01987     ULONG wLayoutId;
01988     UNICODE_STRING UnicodeStringKLKey;
01989     UNICODE_STRING UnicodeStringSubKLKey;
01990     UNICODE_STRING UnicodeStringIME;
01991     OBJECT_ATTRIBUTES OA;
01992     HANDLE hKey;
01993     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01994     WCHAR awchKLRegKey[<a class="code" href="../../d3/d8/client_8c.html#a0">NSZKLKEY</a>];
01995     LPWSTR lpszKLRegKey = awchKLRegKey;
01996     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01997 
01998     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeStringKLKey, <a class="code" href="../../d3/d8/client_8c.html#a8">szKLKey</a>);
01999     InitializeObjectAttributes(&amp;OA, &amp;UnicodeStringKLKey, OBJ_CASE_INSENSITIVE, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02000 
02001     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(&amp;hKey, KEY_READ, &amp;OA))) {
02002 
02003         <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>++) {
02004 
02005             <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> KeyBuffer[<span class="keyword">sizeof</span>(KEY_BASIC_INFORMATION) + KL_NAMELENGTH * <span class="keyword">sizeof</span>(WCHAR)];
02006             PKEY_BASIC_INFORMATION pKeyInfo;
02007             ULONG ResultLength;
02008 
02009             pKeyInfo = (PKEY_BASIC_INFORMATION)KeyBuffer;
02010             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a17">NtEnumerateKey</a>(hKey,
02011                                     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>,
02012                                     KeyBasicInformation,
02013                                     pKeyInfo,
02014                                     <span class="keyword">sizeof</span>(KeyBuffer),
02015                                     &amp;ResultLength);
02016 
02017             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02018                 UnicodeStringSubKLKey.Buffer = (PWSTR)&amp;(pKeyInfo-&gt;Name[0]);
02019                 UnicodeStringSubKLKey.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)pKeyInfo-&gt;NameLength;
02020                 UnicodeStringSubKLKey.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)pKeyInfo-&gt;NameLength;
02021                 <a class="code" href="../../d9/d3/cnvint_8c.html#a4">RtlUnicodeStringToInteger</a>(&amp;UnicodeStringSubKLKey, 16, &amp;wLayoutId);
02022 
02023                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d5/conimep_8h.html#a49">IS_IME_KBDLAYOUT</a>(wLayoutId)) {
02024 
02025                     HANDLE hSubKey;
02026 
02027                     wcscpy(lpszKLRegKey, <a class="code" href="../../d3/d8/client_8c.html#a8">szKLKey</a>);
02028                     wcsncat(lpszKLRegKey, UnicodeStringSubKLKey.Buffer,
02029                                           UnicodeStringSubKLKey.Length / <span class="keyword">sizeof</span>(WCHAR));
02030                     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeStringKLKey, lpszKLRegKey);
02031                     InitializeObjectAttributes(&amp;OA, &amp;UnicodeStringKLKey, OBJ_CASE_INSENSITIVE, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02032 
02033                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(&amp;hSubKey, KEY_READ, &amp;OA))) {
02034                         <span class="comment">/*</span>
02035 <span class="comment">                         * GetIME file name from "HKLM\...&lt;Index&gt;\IME File"</span>
02036 <span class="comment">                         */</span>
02037                         <span class="keyword">static</span> CONST WCHAR szIMEfile[]  = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"IME file"</span>;
02038                         <span class="keyword">struct </span>{
02039                             KEY_VALUE_PARTIAL_INFORMATION KeyInfo;
02040                             WCHAR awchImeName[<a class="code" href="../../d3/d8/client_8c.html#a1">CCH_KL_LIBNAME</a>];
02041                         } IMEfile;
02042                         LPWSTR pwszIME;
02043                         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> cbSize;
02044 
02045                         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeStringIME, szIMEfile);
02046 
02047                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(hSubKey,
02048                                                  &amp;UnicodeStringIME,
02049                                                  KeyValuePartialInformation,
02050                                                  &amp;IMEfile,
02051                                                  <span class="keyword">sizeof</span> IMEfile,
02052                                                  &amp;cbSize);
02053                         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hSubKey);
02054 
02055                         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02056                             pwszIME = (LPWSTR)IMEfile.KeyInfo.Data;
02057                             pwszIME[<a class="code" href="../../d3/d8/client_8c.html#a1">CCH_KL_LIBNAME</a> - 1] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
02058                             <span class="keywordflow">if</span> (!lstrcmpi(pwszIME, pszImeFileName)) {
02059                                 <span class="comment">/*</span>
02060 <span class="comment">                                 * IME file name match !!</span>
02061 <span class="comment">                                 */</span>
02062                                 fFound = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02063                                 <span class="keywordflow">break</span>;
02064                             }
02065                         }
02066                     }
02067                 }
02068             }
02069             <span class="keywordflow">else</span> {
02070                 <span class="keywordflow">break</span>;
02071             }
02072         }
02073         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hKey);
02074     }
02075 
02076     <span class="keywordflow">if</span> (fFound)
02077         <span class="keywordflow">return</span> wLayoutId;
02078 
02079     <span class="keywordflow">return</span> 0;
02080 }
02081 
02082 <span class="comment">/***************************************************************************\</span>
02083 <span class="comment">* GetRemoteKeyboardLayout</span>
02084 <span class="comment">*</span>
02085 <span class="comment">* Returns TRUE if the client winstation specified a keyboard layout.</span>
02086 <span class="comment">* If TRUE, the LayoutBuf contains the name of the keyboard layout.</span>
02087 <span class="comment">* History:</span>
02088 <span class="comment">\***************************************************************************/</span>
02089 
02090 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l02091"></a><a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a1">02091</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a1">GetRemoteKeyboardLayout</a>(
02092     PWCHAR LayoutBuf)
02093 {
02094     ULONG                        KeyboardLayout;
02095     ULONG                        Length;
02096     WINSTATIONCONFIG             ConfigData;
02097 
02098     <span class="comment">/*</span>
02099 <span class="comment">     * Skip if this is the main session</span>
02100 <span class="comment">     */</span>
02101     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d0/usercli_8h.html#a30">ISREMOTESESSION</a>()) {
02102         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02103     }
02104 
02105     <span class="comment">/*</span>
02106 <span class="comment">     * Fetch the WinStation's basic information</span>
02107 <span class="comment">     */</span>
02108     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d8/client_8c.html#a66">WinStaQueryInformationW</a>(SERVERNAME_CURRENT,
02109                                 LOGONID_CURRENT,
02110                                 WinStationConfiguration,
02111                                 &amp;ConfigData,
02112                                 <span class="keyword">sizeof</span>(ConfigData),
02113                                 &amp;Length)) {
02114 
02115         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02116     }
02117 
02118     KeyboardLayout = ConfigData.User.KeyboardLayout;
02119 
02120     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a126">IS_IME_ENABLED</a>()) {
02121         WINSTATIONCLIENTW ClientData;
02122 
02123         <span class="comment">// Fetch the WinStation's basic information</span>
02124         <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d8/client_8c.html#a66">WinStaQueryInformationW</a>(SERVERNAME_CURRENT,
02125                                            LOGONID_CURRENT,
02126                                            WinStationClient,
02127                                            &amp;ClientData,
02128                                            <span class="keyword">sizeof</span>(ClientData),
02129                                            &amp;Length)) {
02130             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02131         }
02132 
02133         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d5/conimep_8h.html#a49">IS_IME_KBDLAYOUT</a>(ConfigData.User.KeyboardLayout)) {
02134             KeyboardLayout = <a class="code" href="../../d3/d8/client_8c.html#a67">GetServerIMEKeyboardLayout</a>(ClientData.imeFileName);
02135         }
02136     }
02137 
02138     <span class="keywordflow">if</span> (KeyboardLayout != 0) {
02139         <a class="code" href="../../d6/d0/wsprintf_8c.html#a10">wsprintfW</a>(LayoutBuf, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"%8.8lx"</span>, KeyboardLayout);
02140         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02141     }
02142 
02143     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02144 }
02145 
02146 <span class="comment">/***************************************************************************\</span>
02147 <span class="comment">* CreateWindowStation (API)</span>
02148 <span class="comment">*</span>
02149 <span class="comment">* Creates a windowstation object</span>
02150 <span class="comment">*</span>
02151 <span class="comment">* History:</span>
02152 <span class="comment">\***************************************************************************/</span>
02153 
<a name="l02154"></a><a class="code" href="../../d3/d8/client_8c.html#a69">02154</a> HWINSTA <a class="code" href="../../d3/d8/client_8c.html#a69">CommonCreateWindowStation</a>(
02155     PUNICODE_STRING         pstrName,
02156     ACCESS_MASK             amRequest,
02157     PSECURITY_ATTRIBUTES    lpsa)
02158 {
02159     OBJECT_ATTRIBUTES   Obja;
02160     HANDLE              hRootDirectory;
02161     HWINSTA             hwinstaNew = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02162     WCHAR               pwszKLID[KL_NAMELENGTH];
02163     HANDLE              hKeyboardFile = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02164     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>               offTable;
02165     UNICODE_STRING      strKLID;
02166     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>                uKbdInputLocale, uFlags;
02167     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02168 
02169     <span class="comment">/*</span>
02170 <span class="comment">     * Load initial keyboard layout.  Continue even if</span>
02171 <span class="comment">     * this fails (esp. important with KLF_INITTIME set)</span>
02172 <span class="comment">     */</span>
02173     ULONG               KeyboardLayout = 0;
02174     ULONG               Length;
02175     WINSTATIONCONFIG    ConfigData;
02176     BOOLEAN             bResult;
02177 
02178     <span class="keyword">extern</span> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d2/d8/api_8c.html#a24">CtxInitUser32</a>(<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>);
02179 
02180     hKeyboardFile = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02181 
02182     <span class="comment">/*</span>
02183 <span class="comment">     * Get winstation info</span>
02184 <span class="comment">     */</span>
02185     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a30">ISREMOTESESSION</a>()) {
02186 
02187         bResult = <a class="code" href="../../d3/d8/client_8c.html#a66">WinStaQueryInformationW</a>(SERVERNAME_CURRENT,
02188                                                        LOGONID_CURRENT,
02189                                                        WinStationConfiguration,
02190                                                        &amp;ConfigData,
02191                                                        <span class="keyword">sizeof</span>(ConfigData),
02192                                                        &amp;Length);
02193         <span class="keywordflow">if</span> (bResult) {
02194             KeyboardLayout = ConfigData.User.KeyboardLayout;
02195 
02196             <span class="keywordflow">if</span> (KeyboardLayout) {
02197                 <a class="code" href="../../d6/d0/wsprintf_8c.html#a10">wsprintfW</a>(pwszKLID, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"%8.8lx"</span>, KeyboardLayout);
02198                 uFlags = KLF_ACTIVATE | KLF_INITTIME;
02199 
02200                 hKeyboardFile = <a class="code" href="../../d6/d0/usercli_8h.html#a604">OpenKeyboardLayoutFile</a>(pwszKLID,
02201                             &amp;uFlags, &amp;offTable, &amp;uKbdInputLocale);
02202 
02203                 RIPMSG0(RIP_WARNING, <span class="stringliteral">"OpenKeyboardLayoutFile() failed. Will use the fallback keyboard layout"</span>);
02204             }
02205         }
02206     }
02207 
02208     <span class="keywordflow">if</span> (hKeyboardFile == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02209 
02210         <a class="code" href="../../d6/d0/usercli_8h.html#a603">GetActiveKeyboardName</a>(pwszKLID);
02211 retry:
02212         uFlags = KLF_ACTIVATE | KLF_INITTIME;
02213         hKeyboardFile = <a class="code" href="../../d6/d0/usercli_8h.html#a604">OpenKeyboardLayoutFile</a>(pwszKLID,
02214                 &amp;uFlags, &amp;offTable, &amp;uKbdInputLocale);
02215         <span class="keywordflow">if</span> (hKeyboardFile == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02216             <span class="keywordflow">if</span> (wcscmp(pwszKLID, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"00000409"</span>)) {
02217                 wcscpy(pwszKLID, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"00000409"</span>);
02218                 RIPMSG0(RIP_WARNING, <span class="stringliteral">"OpendKeyboardLayoutFile() failed: will use the fallback keyboard layout."</span>);
02219                 <span class="keywordflow">goto</span> retry;
02220             }
02221             uKbdInputLocale = 0x04090409;
02222         }
02223     }
02224 
02225 
02226     <span class="comment">/*</span>
02227 <span class="comment">     * Finish the rest of the DLL initialization for WinStations.</span>
02228 <span class="comment">     * Until this point we had no video driver.</span>
02229 <span class="comment">     *</span>
02230 <span class="comment">     * clupu: We have to prevent this for NOIO windowstations !!!</span>
02231 <span class="comment">     */</span>
02232     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/inc_2user_8h.html#a882">ISTS</a>()) {
02233         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d8/api_8c.html#a24">CtxInitUser32</a>()) {
02234             RIPMSG0(RIP_WARNING, <span class="stringliteral">"CtxInitUser32 failed"</span>);
02235             <span class="keywordflow">goto</span> Exit;
02236         }
02237     }
02238 
02239     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;strKLID, pwszKLID);
02240 
02241     <span class="comment">/*</span>
02242 <span class="comment">     * If a name was specified, open the parent directory.  Be sure</span>
02243 <span class="comment">     * to test the length rather than the buffer because for NULL</span>
02244 <span class="comment">     * string RtlCreateUnicodeStringFromAsciiz will allocate a</span>
02245 <span class="comment">     * buffer pointing to an empty string.</span>
02246 <span class="comment">     */</span>
02247     <span class="keywordflow">if</span> (pstrName-&gt;Length != 0) {
02248         InitializeObjectAttributes(&amp;Obja,
02249                                    (PUNICODE_STRING)&amp;<a class="code" href="../../d3/d8/client_8c.html#a19">strRootDirectory</a>,
02250                                    OBJ_CASE_INSENSITIVE,
02251                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02252         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d0/obdir_8c.html#a1">NtOpenDirectoryObject</a>(&amp;hRootDirectory,
02253                 DIRECTORY_CREATE_OBJECT, &amp;Obja);
02254         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02255             RIPNTERR0(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>, RIP_VERBOSE, <span class="stringliteral">""</span>);
02256             <span class="keywordflow">goto</span> Exit;
02257         }
02258     } <span class="keywordflow">else</span> {
02259         pstrName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02260         hRootDirectory = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02261     }
02262 
02263     InitializeObjectAttributes(&amp;Obja, pstrName,
02264             OBJ_CASE_INSENSITIVE  | OBJ_OPENIF |
02265                 ((lpsa &amp;&amp; lpsa-&gt;bInheritHandle) ? OBJ_INHERIT : 0),
02266             hRootDirectory, lpsa ? lpsa-&gt;lpSecurityDescriptor : <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02267 
02268     <span class="comment">/*</span>
02269 <span class="comment">     * NULL hKeyboardFile will let the kernel to utilize</span>
02270 <span class="comment">     * the kbdnull layout which is a built in as a fallback layout</span>
02271 <span class="comment">     * in Win32k.sys.</span>
02272 <span class="comment">     */</span>
02273     hwinstaNew = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a87">NtUserCreateWindowStation</a>(
02274                             &amp;Obja,
02275                             amRequest,
02276                             hKeyboardFile,
02277                             offTable,
02278                             &amp;strKLID,
02279                             uKbdInputLocale);
02280 
02281     <span class="keywordflow">if</span> (hRootDirectory != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02282         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hRootDirectory);
02283 Exit:
02284     <span class="keywordflow">if</span> (hKeyboardFile) {
02285         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hKeyboardFile);
02286     }
02287 
02288     <span class="keywordflow">return</span> hwinstaNew;
02289 }
02290 
<a name="l02291"></a><a class="code" href="../../d3/d8/client_8c.html#a70">02291</a> HWINSTA <a class="code" href="../../d3/d8/client_8c.html#a70">CreateWindowStationA</a>(
02292     LPCSTR      pwinsta,
02293     DWORD       dwReserved,
02294     ACCESS_MASK amRequest,
02295     PSECURITY_ATTRIBUTES lpsa)
02296 {
02297     UNICODE_STRING UnicodeString;
02298     HWINSTA hwinsta;
02299 
02300     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d7/string_8c.html#a13">RtlCreateUnicodeStringFromAsciiz</a>(&amp;UnicodeString, pwinsta))
02301         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02302 
02303     hwinsta = <a class="code" href="../../d3/d8/client_8c.html#a69">CommonCreateWindowStation</a>(&amp;UnicodeString, amRequest, lpsa);
02304 
02305     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;UnicodeString);
02306 
02307     <span class="keywordflow">return</span> hwinsta;
02308 
02309     UNREFERENCED_PARAMETER(dwReserved);
02310 }
02311 
<a name="l02312"></a><a class="code" href="../../d3/d8/client_8c.html#a71">02312</a> HWINSTA <a class="code" href="../../d3/d8/client_8c.html#a71">CreateWindowStationW</a>(
02313     LPCWSTR     pwinsta,
02314     DWORD       dwReserved,
02315     ACCESS_MASK amRequest,
02316     PSECURITY_ATTRIBUTES lpsa)
02317 {
02318     UNICODE_STRING strWinSta;
02319 
02320     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;strWinSta, pwinsta);
02321 
02322     <span class="keywordflow">return</span> <a class="code" href="../../d3/d8/client_8c.html#a69">CommonCreateWindowStation</a>(&amp;strWinSta, amRequest, lpsa);
02323 
02324     UNREFERENCED_PARAMETER(dwReserved);
02325 }
02326 
02327 
02328 <span class="comment">/***************************************************************************\</span>
02329 <span class="comment">* OpenWindowStation (API)</span>
02330 <span class="comment">*</span>
02331 <span class="comment">* Opens a windowstation object</span>
02332 <span class="comment">*</span>
02333 <span class="comment">* History:</span>
02334 <span class="comment">\***************************************************************************/</span>
02335 
<a name="l02336"></a><a class="code" href="../../d3/d8/client_8c.html#a72">02336</a> HWINSTA <a class="code" href="../../d3/d8/client_8c.html#a72">CommonOpenWindowStation</a>(
02337     CONST UNICODE_STRING *pstrName,
02338     BOOL fInherit,
02339     ACCESS_MASK amRequest)
02340 {
02341     WCHAR awchName[<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a94">WINSTA_NAME</a>) / <span class="keyword">sizeof</span>(WCHAR)];
02342     UNICODE_STRING strDefaultName;
02343     OBJECT_ATTRIBUTES ObjA;
02344     HANDLE hRootDirectory;
02345     HWINSTA hwinsta;
02346     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02347 
02348     InitializeObjectAttributes(&amp;ObjA,
02349                                (PUNICODE_STRING)&amp;<a class="code" href="../../d3/d8/client_8c.html#a19">strRootDirectory</a>,
02350                                OBJ_CASE_INSENSITIVE,
02351                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02352     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d0/obdir_8c.html#a1">NtOpenDirectoryObject</a>(&amp;hRootDirectory,
02353                                    DIRECTORY_TRAVERSE,
02354                                    &amp;ObjA);
02355     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02356         RIPNTERR0(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>, RIP_VERBOSE, <span class="stringliteral">""</span>);
02357         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02358     }
02359 
02360     <span class="keywordflow">if</span> (pstrName-&gt;Length == 0) {
02361         RtlCopyMemory(awchName, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a94">WINSTA_NAME</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a94">WINSTA_NAME</a>));
02362         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;strDefaultName, awchName);
02363         pstrName = &amp;strDefaultName;
02364     }
02365 
02366     InitializeObjectAttributes( &amp;ObjA,
02367                                 (PUNICODE_STRING)pstrName,
02368                                 OBJ_CASE_INSENSITIVE,
02369                                 hRootDirectory,
02370                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02371                                 );
02372     <span class="keywordflow">if</span> (fInherit)
02373         ObjA.Attributes |= OBJ_INHERIT;
02374 
02375     hwinsta = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a88">NtUserOpenWindowStation</a>(&amp;ObjA, amRequest);
02376 
02377     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hRootDirectory);
02378 
02379     <span class="keywordflow">return</span> hwinsta;
02380 }
02381 
<a name="l02382"></a><a class="code" href="../../d3/d8/client_8c.html#a73">02382</a> HWINSTA <a class="code" href="../../d3/d8/client_8c.html#a73">OpenWindowStationA</a>(
02383     LPCSTR pwinsta,
02384     BOOL fInherit,
02385     ACCESS_MASK amRequest)
02386 {
02387     UNICODE_STRING UnicodeString;
02388     HWINSTA hwinsta;
02389 
02390     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d7/string_8c.html#a13">RtlCreateUnicodeStringFromAsciiz</a>(&amp;UnicodeString, pwinsta))
02391         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02392 
02393     hwinsta = <a class="code" href="../../d3/d8/client_8c.html#a72">CommonOpenWindowStation</a>(&amp;UnicodeString, fInherit, amRequest);
02394 
02395     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;UnicodeString);
02396 
02397     <span class="keywordflow">return</span> hwinsta;
02398 }
02399 
<a name="l02400"></a><a class="code" href="../../d3/d8/client_8c.html#a74">02400</a> HWINSTA <a class="code" href="../../d3/d8/client_8c.html#a74">OpenWindowStationW</a>(
02401     LPCWSTR pwinsta,
02402     BOOL fInherit,
02403     ACCESS_MASK amRequest)
02404 {
02405     UNICODE_STRING strWinSta;
02406 
02407     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;strWinSta, pwinsta);
02408 
02409     <span class="keywordflow">return</span> <a class="code" href="../../d3/d8/client_8c.html#a72">CommonOpenWindowStation</a>(&amp;strWinSta, fInherit, amRequest);
02410 }
02411 
02412 <span class="comment">/***************************************************************************\</span>
02413 <span class="comment">* CommonCreateDesktop (API)</span>
02414 <span class="comment">*</span>
02415 <span class="comment">* Creates a desktop object</span>
02416 <span class="comment">*</span>
02417 <span class="comment">* History:</span>
02418 <span class="comment">\***************************************************************************/</span>
02419 
<a name="l02420"></a><a class="code" href="../../d3/d8/client_8c.html#a75">02420</a> HDESK <a class="code" href="../../d3/d8/client_8c.html#a75">CommonCreateDesktop</a>(
02421     PUNICODE_STRING pstrDesktop,
02422     PUNICODE_STRING pstrDevice,
02423     LPDEVMODEW      pDevmode,
02424     DWORD           dwFlags,
02425     ACCESS_MASK     amRequest,
02426     PSECURITY_ATTRIBUTES lpsa)
02427 {
02428     OBJECT_ATTRIBUTES Obja;
02429     HDESK hdesk = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02430 
02431     InitializeObjectAttributes(&amp;Obja,
02432                                pstrDesktop,
02433                                OBJ_CASE_INSENSITIVE | OBJ_OPENIF |
02434                                    ((lpsa &amp;&amp; lpsa-&gt;bInheritHandle) ? OBJ_INHERIT : 0),
02435                                <a class="code" href="../../d0/d0/ntuser_8h.html#a14">NtUserGetProcessWindowStation</a>(),
02436                                lpsa ? lpsa-&gt;lpSecurityDescriptor : <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02437 
02438     hdesk = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a93">NtUserCreateDesktop</a>(&amp;Obja,
02439                                 pstrDevice,
02440                                 pDevmode,
02441                                 <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>,
02442                                 amRequest);
02443 
02444     <span class="keywordflow">return</span> hdesk;
02445 }
02446 
02447 <span class="comment">/***************************************************************************\</span>
02448 <span class="comment">* CreateDesktopA (API)</span>
02449 <span class="comment">*</span>
02450 <span class="comment">* Creates a desktop object</span>
02451 <span class="comment">*</span>
02452 <span class="comment">* History:</span>
02453 <span class="comment">\***************************************************************************/</span>
02454 
<a name="l02455"></a><a class="code" href="../../d3/d8/client_8c.html#a76">02455</a> HDESK <a class="code" href="../../d3/d8/client_8c.html#a76">CreateDesktopA</a>(
02456     LPCSTR pDesktop,
02457     LPCSTR pDevice,
02458     LPDEVMODEA pDevmode,
02459     DWORD dwFlags,
02460     ACCESS_MASK amRequest,
02461     PSECURITY_ATTRIBUTES lpsa)
02462 {
02463     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02464     ANSI_STRING AnsiString;
02465     UNICODE_STRING UnicodeDesktop;
02466     UNICODE_STRING UnicodeDevice;
02467     PUNICODE_STRING pUnicodeDevice = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02468     LPDEVMODEW lpDevModeW = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02469     HDESK hdesk;
02470 
02471     <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(&amp;AnsiString, pDesktop);
02472     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;UnicodeDesktop, &amp;AnsiString, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02473 
02474     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02475         RIPNTERR1(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>, RIP_VERBOSE, <span class="stringliteral">"CreateDesktop fails with Status = 0x%x"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02476         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02477     }
02478 
02479     <span class="keywordflow">if</span> (pDevice) {
02480 
02481         pUnicodeDevice = &amp;UnicodeDevice;
02482         <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(&amp;AnsiString, pDevice);
02483         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;UnicodeDevice, &amp;AnsiString, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
02484 
02485         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02486             RIPNTERR0(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>, RIP_VERBOSE, <span class="stringliteral">""</span>);
02487             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;UnicodeDesktop);
02488             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02489         }
02490     }
02491 
02492     <span class="keywordflow">if</span> (pDevmode) {
02493 
02494         lpDevModeW = GdiConvertToDevmodeW(pDevmode);
02495 
02496     }
02497 
02498     hdesk = <a class="code" href="../../d3/d8/client_8c.html#a75">CommonCreateDesktop</a>(&amp;UnicodeDesktop,
02499                                 pUnicodeDevice,
02500                                 lpDevModeW,
02501                                 <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>,
02502                                 amRequest,
02503                                 lpsa);
02504 
02505     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;UnicodeDesktop);
02506     <span class="keywordflow">if</span> (pDevice) {
02507         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;UnicodeDevice);
02508     }
02509 
02510     <span class="keywordflow">if</span> (lpDevModeW) {
02511         LocalFree(lpDevModeW);
02512     }
02513 
02514     <span class="keywordflow">return</span> hdesk;
02515 }
02516 
02517 <span class="comment">/***************************************************************************\</span>
02518 <span class="comment">* CreateDesktopW (API)</span>
02519 <span class="comment">*</span>
02520 <span class="comment">* Creates a desktop object</span>
02521 <span class="comment">*</span>
02522 <span class="comment">* History:</span>
02523 <span class="comment">\***************************************************************************/</span>
02524 
<a name="l02525"></a><a class="code" href="../../d3/d8/client_8c.html#a77">02525</a> HDESK <a class="code" href="../../d3/d8/client_8c.html#a77">CreateDesktopW</a>(
02526     LPCWSTR pDesktop,
02527     LPCWSTR pDevice,
02528     LPDEVMODEW pDevmode,
02529     DWORD dwFlags,
02530     ACCESS_MASK amRequest,
02531     PSECURITY_ATTRIBUTES lpsa)
02532 {
02533     UNICODE_STRING strDesktop;
02534     UNICODE_STRING strDevice;
02535 
02536     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;strDesktop, pDesktop);
02537     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;strDevice, pDevice);
02538 
02539     <span class="keywordflow">return</span> <a class="code" href="../../d3/d8/client_8c.html#a75">CommonCreateDesktop</a>(&amp;strDesktop,
02540                                pDevice ? &amp;strDevice : <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02541                                pDevmode,
02542                                <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>,
02543                                amRequest,
02544                                lpsa);
02545 }
02546 
02547 <span class="comment">/***************************************************************************\</span>
02548 <span class="comment">* OpenDesktop (API)</span>
02549 <span class="comment">*</span>
02550 <span class="comment">* Opens a desktop object</span>
02551 <span class="comment">*</span>
02552 <span class="comment">* History:</span>
02553 <span class="comment">\***************************************************************************/</span>
02554 
<a name="l02555"></a><a class="code" href="../../d3/d8/client_8c.html#a78">02555</a> HDESK <a class="code" href="../../d3/d8/client_8c.html#a78">CommonOpenDesktop</a>(
02556     PUNICODE_STRING pstrDesktop,
02557     DWORD dwFlags,
02558     BOOL fInherit,
02559     ACCESS_MASK amRequest)
02560 {
02561     OBJECT_ATTRIBUTES ObjA;
02562 
02563     InitializeObjectAttributes( &amp;ObjA,
02564                                 pstrDesktop,
02565                                 OBJ_CASE_INSENSITIVE,
02566                                 <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a91">NtUserGetProcessWindowStation</a>(),
02567                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02568                                 );
02569     <span class="keywordflow">if</span> (fInherit)
02570         ObjA.Attributes |= OBJ_INHERIT;
02571 
02572     <span class="keywordflow">return</span> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a94">NtUserOpenDesktop</a>(&amp;ObjA, <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>, amRequest);
02573 }
02574 
<a name="l02575"></a><a class="code" href="../../d3/d8/client_8c.html#a79">02575</a> HDESK <a class="code" href="../../d3/d8/client_8c.html#a79">OpenDesktopA</a>(
02576     LPCSTR pdesktop,
02577     DWORD dwFlags,
02578     BOOL fInherit,
02579     ACCESS_MASK amRequest)
02580 {
02581     UNICODE_STRING UnicodeString;
02582     HDESK hdesk;
02583 
02584     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d7/string_8c.html#a13">RtlCreateUnicodeStringFromAsciiz</a>(&amp;UnicodeString, pdesktop))
02585         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02586 
02587     hdesk = <a class="code" href="../../d3/d8/client_8c.html#a78">CommonOpenDesktop</a>(&amp;UnicodeString, <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>, fInherit, amRequest);
02588 
02589     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;UnicodeString);
02590 
02591     <span class="keywordflow">return</span> hdesk;
02592 }
02593 
<a name="l02594"></a><a class="code" href="../../d3/d8/client_8c.html#a80">02594</a> HDESK <a class="code" href="../../d3/d8/client_8c.html#a80">OpenDesktopW</a>(
02595     LPCWSTR pdesktop,
02596     DWORD dwFlags,
02597     BOOL fInherit,
02598     ACCESS_MASK amRequest)
02599 {
02600     UNICODE_STRING strDesktop;
02601 
02602     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;strDesktop, pdesktop);
02603 
02604     <span class="keywordflow">return</span> <a class="code" href="../../d3/d8/client_8c.html#a78">CommonOpenDesktop</a>(&amp;strDesktop, <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>, fInherit, amRequest);
02605 }
02606 
02607 <span class="comment">/***************************************************************************\</span>
02608 <span class="comment">* RegisterClassWOW(API)</span>
02609 <span class="comment">*</span>
02610 <span class="comment">* History:</span>
02611 <span class="comment">* 28-Jul-1992 ChandanC Created.</span>
02612 <span class="comment">\***************************************************************************/</span>
02613 ATOM
02614 WINAPI
<a name="l02615"></a><a class="code" href="../../d3/d8/client_8c.html#a81">02615</a> <a class="code" href="../../d3/d8/client_8c.html#a81">RegisterClassWOWA</a>(
02616     WNDCLASSA *lpWndClass,
02617     LPDWORD pdwWOWstuff)
02618 {
02619     WNDCLASSEXA wc;
02620 
02621     <span class="comment">/*</span>
02622 <span class="comment">     * On 64-bit plaforms we'll have 32 bits of padding between style and</span>
02623 <span class="comment">     * lpfnWndProc in WNDCLASS, so start the copy from the first 64-bit</span>
02624 <span class="comment">     * aligned field and hand copy the rest.</span>
02625 <span class="comment">     */</span>
02626     RtlCopyMemory(&amp;(wc.lpfnWndProc), &amp;(lpWndClass-&gt;lpfnWndProc), <span class="keyword">sizeof</span>(WNDCLASSA) - FIELD_OFFSET(WNDCLASSA, lpfnWndProc));
02627     wc.style = lpWndClass-&gt;style;
02628     wc.hIconSm = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02629     wc.cbSize = <span class="keyword">sizeof</span>(WNDCLASSEXA);
02630 
02631     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a635">RegisterClassExWOWA</a>(&amp;wc, pdwWOWstuff, 0);
02632 }
02633 
02634 
02635 <span class="comment">/**************************************************************************\</span>
02636 <span class="comment">* WowGetDefWindowProcBits - Fills in bit array for WOW</span>
02637 <span class="comment">*</span>
02638 <span class="comment">* 22-Jul-1991 mikeke    Created</span>
02639 <span class="comment">\**************************************************************************/</span>
02640 
<a name="l02641"></a><a class="code" href="../../d3/d8/client_8c.html#a82">02641</a> WORD <a class="code" href="../../d3/d8/client_8c.html#a82">WowGetDefWindowProcBits</a>(
02642     PBYTE    pDefWindowProcBits,
02643     WORD     cbDefWindowProcBits)
02644 {
02645     WORD  wMaxMsg;
02646     <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a> pbSrc, pbDst, pbDstEnd;
02647 
02648     UNREFERENCED_PARAMETER(cbDefWindowProcBits);
02649 
02650     <span class="comment">/*</span>
02651 <span class="comment">     * Merge the bits from gpsi-&gt;gabDefWindowMsgs and</span>
02652 <span class="comment">     * gpsi-&gt;gabDefWindowSpecMsgs into WOW's DefWindowProcBits.  These two</span>
02653 <span class="comment">     * indicate which messages must go directly to the server and which</span>
02654 <span class="comment">     * can be handled with some special code in DefWindowProcWorker.</span>
02655 <span class="comment">     * Bitwise OR'ing the two gives a bit array with 1 in the bit field</span>
02656 <span class="comment">     * for each message that must go to user32's DefWindowProc, and 0</span>
02657 <span class="comment">     * for those that can be returned back to the client immediately.</span>
02658 <span class="comment">     *</span>
02659 <span class="comment">     * For speed we assume WOW has zeroed the buffer, in fact it's in</span>
02660 <span class="comment">     * USER.EXE's code segment and is zeroed in the image.</span>
02661 <span class="comment">     */</span>
02662 
02663     wMaxMsg = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(<a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o6">DefWindowMsgs</a>.<a class="code" href="../../d1/d9/struct__WNDMSG.html#o0">maxMsgs</a>,
02664             <a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o7">DefWindowSpecMsgs</a>.<a class="code" href="../../d1/d9/struct__WNDMSG.html#o0">maxMsgs</a>);
02665 
02666     UserAssert((wMaxMsg / 8 + 1) &lt;= cbDefWindowProcBits);
02667 
02668     <span class="comment">//</span>
02669     <span class="comment">// If the above assertion fires, the size of the DWPBits array in</span>
02670     <span class="comment">// \nt\private\mvdm\wow16\user\user.asm needs to be increased.</span>
02671     <span class="comment">//</span>
02672 
02673     <span class="comment">/* First copy the bits from DefWindowMsgs */</span>
02674 
02675     RtlCopyMemory(
02676         pDefWindowProcBits,
02677         <a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o6">DefWindowMsgs</a>.<a class="code" href="../../d1/d9/struct__WNDMSG.html#o1">abMsgs</a>,
02678         <a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o6">DefWindowMsgs</a>.<a class="code" href="../../d1/d9/struct__WNDMSG.html#o0">maxMsgs</a> / 8 + 1
02679         );
02680 
02681     <span class="comment">/* Next OR in the bits from DefWindowSpecMsgs */</span>
02682 
02683     pbSrc = <a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o7">DefWindowSpecMsgs</a>.<a class="code" href="../../d1/d9/struct__WNDMSG.html#o1">abMsgs</a>;
02684     pbDst = pDefWindowProcBits;
02685     pbDstEnd = pbDst + (<a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o7">DefWindowSpecMsgs</a>.<a class="code" href="../../d1/d9/struct__WNDMSG.html#o0">maxMsgs</a> / 8 + 1);
02686 
02687     <span class="keywordflow">while</span> (pbDst &lt; pbDstEnd)
02688     {
02689         *pbDst++ |= *pbSrc++;
02690     }
02691 
02692     <span class="keywordflow">return</span> wMaxMsg;
02693 }
02694 
02695 
<a name="l02696"></a><a class="code" href="../../d3/d8/client_8c.html#a83">02696</a> ULONG_PTR <a class="code" href="../../d3/d8/client_8c.html#a83">UserRegisterWowHandlers</a>(
02697     APFNWOWHANDLERSIN apfnWowIn,
02698     APFNWOWHANDLERSOUT apfnWowOut)
02699 {
02700 
02701     <span class="comment">// In'ees</span>
02702     <a class="code" href="../../d1/d8/clglobal_8c.html#a43">pfnLocalAlloc</a> = apfnWowIn-&gt;pfnLocalAlloc;
02703     <a class="code" href="../../d1/d8/clglobal_8c.html#a44">pfnLocalReAlloc</a> = apfnWowIn-&gt;pfnLocalReAlloc;
02704     <a class="code" href="../../d1/d8/clglobal_8c.html#a45">pfnLocalLock</a> = apfnWowIn-&gt;pfnLocalLock;
02705     <a class="code" href="../../d1/d8/clglobal_8c.html#a46">pfnLocalUnlock</a> = apfnWowIn-&gt;pfnLocalUnlock;
02706     <a class="code" href="../../d1/d8/clglobal_8c.html#a47">pfnLocalSize</a> = apfnWowIn-&gt;pfnLocalSize;
02707     <a class="code" href="../../d1/d8/clglobal_8c.html#a48">pfnLocalFree</a> = apfnWowIn-&gt;pfnLocalFree;
02708     <a class="code" href="../../d1/d8/clglobal_8c.html#a49">pfnGetExpWinVer</a> = apfnWowIn-&gt;pfnGetExpWinVer;
02709     <a class="code" href="../../d1/d8/clglobal_8c.html#a50">pfn16GlobalAlloc</a> = apfnWowIn-&gt;pfn16GlobalAlloc;
02710     <a class="code" href="../../d1/d8/clglobal_8c.html#a51">pfn16GlobalFree</a> = apfnWowIn-&gt;pfn16GlobalFree;
02711     <a class="code" href="../../d1/d8/clglobal_8c.html#a52">pfnWowEmptyClipBoard</a> = apfnWowIn-&gt;pfnEmptyCB;
02712     <a class="code" href="../../d1/d8/clglobal_8c.html#a55">pfnWowEditNextWord</a> = apfnWowIn-&gt;pfnWowEditNextWord;
02713     <a class="code" href="../../d1/d8/clglobal_8c.html#a56">pfnWowCBStoreHandle</a> = apfnWowIn-&gt;pfnWowCBStoreHandle;
02714     <a class="code" href="../../d1/d8/clglobal_8c.html#a36">pfnFindResourceExA</a> = apfnWowIn-&gt;pfnFindResourceEx;
02715     <a class="code" href="../../d1/d8/clglobal_8c.html#a38">pfnLoadResource</a> = apfnWowIn-&gt;pfnLoadResource;
02716     <a class="code" href="../../d1/d8/clglobal_8c.html#a39">pfnLockResource</a> = apfnWowIn-&gt;pfnLockResource;
02717     <a class="code" href="../../d1/d8/clglobal_8c.html#a40">pfnUnlockResource</a> = apfnWowIn-&gt;pfnUnlockResource;
02718     <a class="code" href="../../d1/d8/clglobal_8c.html#a41">pfnFreeResource</a> = apfnWowIn-&gt;pfnFreeResource;
02719     <a class="code" href="../../d1/d8/clglobal_8c.html#a42">pfnSizeofResource</a> = apfnWowIn-&gt;pfnSizeofResource;
02720     <a class="code" href="../../d1/d8/clglobal_8c.html#a37">pfnFindResourceExW</a> = <a class="code" href="../../d3/d8/client_8c.html#a29">WOWFindResourceExWCover</a>;
02721     <a class="code" href="../../d1/d8/clglobal_8c.html#a54">pfnWowDlgProcEx</a> = apfnWowIn-&gt;pfnWowDlgProcEx;
02722     <a class="code" href="../../d1/d8/clglobal_8c.html#a53">pfnWowWndProcEx</a> = apfnWowIn-&gt;pfnWowWndProcEx;
02723     <a class="code" href="../../d1/d8/clglobal_8c.html#a57">pfnWowGetProcModule</a> = apfnWowIn-&gt;pfnGetProcModule16;
02724     <a class="code" href="../../d1/d8/clglobal_8c.html#a58">pfnWOWTellWOWThehDlg</a> = apfnWowIn-&gt;pfnWOWTellWOWThehDlg;
02725     <a class="code" href="../../d1/d8/clglobal_8c.html#a59">pfnWowMsgBoxIndirectCallback</a> = apfnWowIn-&gt;pfnWowMsgBoxIndirectCallback;
02726     <a class="code" href="../../d1/d8/clglobal_8c.html#a60">pfnWowIlstrcmp</a> = apfnWowIn-&gt;pfnWowIlstrsmp;
02727 
02728     <span class="comment">// Out'ees</span>
02729 <span class="preprocessor">#if DBG</span>
02730 <span class="preprocessor"></span>    apfnWowOut-&gt;dwBldInfo = (WINVER &lt;&lt; 16) | 0x80000000;
02731 <span class="preprocessor">#else</span>
02732 <span class="preprocessor"></span>    apfnWowOut-&gt;dwBldInfo = (WINVER &lt;&lt; 16);
02733 <span class="preprocessor">#endif</span>
02734 <span class="preprocessor"></span>    apfnWowOut-&gt;pfnCsCreateWindowEx            = <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a31">_CreateWindowEx</a>;
02735     apfnWowOut-&gt;pfnDirectedYield               = <a class="code" href="../../d3/d8/client_8c.html#a96">DirectedYield</a>;
02736     apfnWowOut-&gt;pfnFreeDDEData                 = <a class="code" href="../../d0/d4/ddemlcli_8h.html#a125">FreeDDEData</a>;
02737     apfnWowOut-&gt;pfnGetClassWOWWords            = <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a6">GetClassWOWWords</a>;
02738     apfnWowOut-&gt;pfnInitTask                    = <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a7">InitTask</a>;
02739     apfnWowOut-&gt;pfnRegisterClassWOWA           = <a class="code" href="../../d3/d8/client_8c.html#a81">RegisterClassWOWA</a>;
02740     apfnWowOut-&gt;pfnRegisterUserHungAppHandlers = <a class="code" href="../../d3/d8/client_8c.html#a123">RegisterUserHungAppHandlers</a>;
02741     apfnWowOut-&gt;pfnServerCreateDialog          = <a class="code" href="../../d0/d9/dlgbegin_8c.html#a23">InternalCreateDialog</a>;
02742     apfnWowOut-&gt;pfnServerLoadCreateCursorIcon  = <a class="code" href="../../d4/d9/clres_8c.html#a102">WowServerLoadCreateCursorIcon</a>;
02743     apfnWowOut-&gt;pfnServerLoadCreateMenu        = <a class="code" href="../../d3/d8/client_8c.html#a26">WowServerLoadCreateMenu</a>;
02744     apfnWowOut-&gt;pfnWOWCleanup                  = <a class="code" href="../../d3/d8/client_8c.html#a33">WOWCleanup</a>;
02745     apfnWowOut-&gt;pfnWOWModuleUnload             = <a class="code" href="../../d3/d8/client_8c.html#a32">WOWModuleUnload</a>;
02746     apfnWowOut-&gt;pfnWOWFindWindow               = <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a3">WOWFindWindow</a>;
02747     apfnWowOut-&gt;pfnWOWLoadBitmapA              = <a class="code" href="../../d3/d8/client_8c.html#a25">WOWLoadBitmapA</a>;
02748     apfnWowOut-&gt;pfnWowWaitForMsgAndEvent       = <a class="code" href="../../d0/d0/ntuser_8h.html#a26">NtUserWaitForMsgAndEvent</a>;
02749     apfnWowOut-&gt;pfnYieldTask                   = <a class="code" href="../../d0/d0/ntuser_8h.html#a165">NtUserYieldTask</a>;
02750     apfnWowOut-&gt;pfnGetFullUserHandle           = <a class="code" href="../../d3/d8/client_8c.html#a27">GetFullUserHandle</a>;
02751     apfnWowOut-&gt;pfnGetMenuIndex                = <a class="code" href="../../d0/d0/ntuser_8h.html#a79">NtUserGetMenuIndex</a>;
02752     apfnWowOut-&gt;pfnWowGetDefWindowProcBits     = <a class="code" href="../../d3/d8/client_8c.html#a82">WowGetDefWindowProcBits</a>;
02753     apfnWowOut-&gt;pfnFillWindow                  = <a class="code" href="../../d6/d0/usercli_8h.html#a234">FillWindow</a>;
02754     apfnWowOut-&gt;aiWowClass                     = <a class="code" href="../../d3/d8/client_8c.html#a7">aiClassWow</a>;
02755     <span class="keywordflow">return</span> (ULONG_PTR)&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a>;
02756 }
02757 
02758 <span class="comment">/***************************************************************************\</span>
02759 <span class="comment">* GetEditDS</span>
02760 <span class="comment">*</span>
02761 <span class="comment">* This is a callback to WOW used to allocate a segment for DS_LOCALEDIT</span>
02762 <span class="comment">* edit controls.  The segment is disguised to look like a WOW hInstance.</span>
02763 <span class="comment">*</span>
02764 <span class="comment">* 06-19-92 sanfords Created</span>
02765 <span class="comment">\***************************************************************************/</span>
<a name="l02766"></a><a class="code" href="../../d3/d8/client_8c.html#a84">02766</a> HANDLE <a class="code" href="../../d3/d8/client_8c.html#a84">GetEditDS</a>()
02767 {
02768     UserAssert(<a class="code" href="../../d1/d8/clglobal_8c.html#a50">pfn16GlobalAlloc</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02769 
02770     <span class="keywordflow">return</span>((HANDLE)((*pfn16GlobalAlloc)(GHND | GMEM_SHARE, 256)));
02771 }
02772 
02773 
02774 
02775 <span class="comment">/***************************************************************************\</span>
02776 <span class="comment">* ReleaseEditDS</span>
02777 <span class="comment">*</span>
02778 <span class="comment">* This is a callback to WOW used to free a segment for DS_LOCALEDIT</span>
02779 <span class="comment">* edit controls.</span>
02780 <span class="comment">*</span>
02781 <span class="comment">* 06-19-92 sanfords Created</span>
02782 <span class="comment">\***************************************************************************/</span>
<a name="l02783"></a><a class="code" href="../../d6/d0/usercli_8h.html#a764">02783</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d6/d0/usercli_8h.html#a764">ReleaseEditDS</a>(
02784 HANDLE h)
02785 {
02786     UserAssert(<a class="code" href="../../d1/d8/clglobal_8c.html#a51">pfn16GlobalFree</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02787 
02788     (*pfn16GlobalFree)(LOWORD(HandleToUlong(h)));
02789 }
02790 
02791 
02792 
02793 <span class="comment">/***************************************************************************\</span>
02794 <span class="comment">* TellWOWThehDlg</span>
02795 <span class="comment">*</span>
02796 <span class="comment">* This is a callback to WOW used to inform WOW of the hDlg of a newly</span>
02797 <span class="comment">* created dialog window.</span>
02798 <span class="comment">*</span>
02799 <span class="comment">* 08-31-97 cmjones  Created</span>
02800 <span class="comment">\***************************************************************************/</span>
<a name="l02801"></a><a class="code" href="../../d6/d0/usercli_8h.html#a765">02801</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d6/d0/usercli_8h.html#a765">TellWOWThehDlg</a>(
02802 HWND hDlg)
02803 {
02804     UserAssert(<a class="code" href="../../d1/d8/clglobal_8c.html#a58">pfnWOWTellWOWThehDlg</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02805 
02806     (*pfnWOWTellWOWThehDlg)(hDlg);
02807 }
02808 
02809 
02810 
02811 <span class="comment">/***************************************************************************\</span>
02812 <span class="comment">* DispatchMessage</span>
02813 <span class="comment">*</span>
02814 <span class="comment">* !!! Warning if this function becomes more complicated then look at the</span>
02815 <span class="comment">* server code for WrapCallProc</span>
02816 <span class="comment">*</span>
02817 <span class="comment">* pwnd is threadlocked in the kernel and thus always valid.</span>
02818 <span class="comment">*</span>
02819 <span class="comment">* 19-Aug-1992 mikeke   created</span>
02820 <span class="comment">\***************************************************************************/</span>
02821 
<a name="l02822"></a><a class="code" href="../../d6/d0/usercli_8h.html#a609">02822</a> LRESULT <a class="code" href="../../d6/d0/usercli_8h.html#a609">DispatchClientMessage</a>(
02823     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
02824     UINT message,
02825     WPARAM wParam,
02826     LPARAM lParam,
02827     ULONG_PTR pfn)
02828 {
02829     HWND hwnd = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a16">GetClientInfo</a>()-&gt;CallbackWnd.hwnd;
02830 
02831     <span class="comment">/*</span>
02832 <span class="comment">     * Assert that the header comment is legit (must be).</span>
02833 <span class="comment">     * for WM_TIMERs not associated to a window, pwnd can be NULL. So</span>
02834 <span class="comment">     *  don't rip validating the handle.</span>
02835 <span class="comment">     */</span>
02836     UserAssert(pwnd == <a class="code" href="../../d3/d9/client_2wow_8c.html#a1">ValidateHwndNoRip</a>(hwnd));
02837 
02838     <span class="comment">/*</span>
02839 <span class="comment">     * Add assert to catch dispatching messages to a thread not associated</span>
02840 <span class="comment">     * with a desktop.</span>
02841 <span class="comment">     */</span>
02842     UserAssert(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a16">GetClientInfo</a>()-&gt;ulClientDelta != 0);
02843 
02844     <span class="comment">/*</span>
02845 <span class="comment">     * More complicate then regular CALLPROC_WOWCHECK() we want to get the</span>
02846 <span class="comment">     * PWW so wow doesn't have to</span>
02847 <span class="comment">     */</span>
02848 
02849     <span class="comment">/* Bug 234292 - joejo</span>
02850 <span class="comment">     * Since the called window/dialog proc may have a different calling</span>
02851 <span class="comment">     * convention, we must wrap the call and, check esp and replace with</span>
02852 <span class="comment">     * a good esp when the call returns. This is what UserCallWinProc* does.</span>
02853 <span class="comment">    */</span>
02854 <span class="preprocessor">#ifdef _WIN64</span>
02855 <span class="preprocessor"></span>    UNREFERENCED_PARAMETER(pwnd);
02856 <span class="preprocessor">#endif</span>
02857 <span class="preprocessor"></span>
02858     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a19">CALLPROC_WOWCHECKPWW</a>((WNDPROC)pfn, hwnd, message, wParam, lParam, &amp;(pwnd-&gt;state));
02859 
02860 }
02861 
02862 <span class="comment">/**************************************************************************\</span>
02863 <span class="comment">* ArrangeIconicWindows</span>
02864 <span class="comment">*</span>
02865 <span class="comment">* 22-Jul-1991 mikeke    Created</span>
02866 <span class="comment">\**************************************************************************/</span>
02867 
<a name="l02868"></a><a class="code" href="../../d3/d8/client_8c.html#a88">02868</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d3/d8/client_8c.html#a88">ArrangeIconicWindows</a>(
02869     HWND hwnd)
02870 {
02871     <span class="keywordflow">return</span> (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a176">NtUserCallHwndLock</a>(hwnd, SFI_XXXARRANGEICONICWINDOWS);
02872 }
02873 
02874 <span class="comment">/**************************************************************************\</span>
02875 <span class="comment">* BeginDeferWindowPos</span>
02876 <span class="comment">*</span>
02877 <span class="comment">* 22-Jul-1991 mikeke    Created</span>
02878 <span class="comment">\**************************************************************************/</span>
02879 
<a name="l02880"></a><a class="code" href="../../d3/d8/client_8c.html#a89">02880</a> HANDLE <a class="code" href="../../d3/d8/client_8c.html#a89">BeginDeferWindowPos</a>(
02881     <span class="keywordtype">int</span> nNumWindows)
02882 {
02883     <span class="keywordflow">if</span> (nNumWindows &lt; 0) {
02884         RIPERR1(ERROR_INVALID_PARAMETER,
02885                 RIP_WARNING,
02886                 <span class="stringliteral">"Invalid parameter \"nNumWindows\" (%ld) to BeginDeferWindowPos"</span>,
02887                 nNumWindows);
02888 
02889         <span class="keywordflow">return</span> 0;
02890     }
02891 
02892     <span class="keywordflow">return</span> (HANDLE)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a174">NtUserCallOneParam</a>(nNumWindows, SFI__BEGINDEFERWINDOWPOS);
02893 }
02894 
02895 <span class="comment">/**************************************************************************\</span>
02896 <span class="comment">* EndDeferWindowPos</span>
02897 <span class="comment">*</span>
02898 <span class="comment">* 22-Jul-1991 mikeke    Created</span>
02899 <span class="comment">\**************************************************************************/</span>
02900 
<a name="l02901"></a><a class="code" href="../../d3/d8/client_8c.html#a90">02901</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d8/client_8c.html#a90">EndDeferWindowPos</a>(
02902     HDWP hWinPosInfo)
02903 {
02904     <span class="keywordflow">return</span> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a109">NtUserEndDeferWindowPosEx</a>(hWinPosInfo, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02905 }
02906 
02907 <span class="comment">/**************************************************************************\</span>
02908 <span class="comment">* CascadeChildWindows</span>
02909 <span class="comment">*</span>
02910 <span class="comment">* 22-Jul-1991 mikeke    Created</span>
02911 <span class="comment">\**************************************************************************/</span>
02912 
<a name="l02913"></a><a class="code" href="../../d3/d8/client_8c.html#a91">02913</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d8/client_8c.html#a91">CascadeChildWindows</a>(
02914     HWND hwndParent,
02915     UINT nCode)
02916 {
02917     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>) <a class="code" href="../../d6/d5/mdiwin_8c.html#a21">CascadeWindows</a>(hwndParent, nCode, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02918 }
02919 
02920 <span class="comment">/**************************************************************************\</span>
02921 <span class="comment">* CloseWindow</span>
02922 <span class="comment">*</span>
02923 <span class="comment">* 22-Jul-1991 mikeke    Created</span>
02924 <span class="comment">* 17-Feb-1998 MCostea   Use xxxShowWindow instead of xxxCloseWindow</span>
02925 <span class="comment">\**************************************************************************/</span>
02926 
<a name="l02927"></a><a class="code" href="../../d3/d8/client_8c.html#a92">02927</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d8/client_8c.html#a92">CloseWindow</a>(
02928     HWND hwnd)
02929 {
02930     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
02931 
02932     <span class="keywordflow">if</span> ((pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hwnd)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02933         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02934     }
02935     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>)) {
02936         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a237">NtUserShowWindow</a>(hwnd, SW_SHOWMINIMIZED);
02937     }
02938     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02939 }
02940 
02941 <span class="comment">/**************************************************************************\</span>
02942 <span class="comment">* CreateMenu</span>
02943 <span class="comment">*</span>
02944 <span class="comment">* 22-Jul-1991 mikeke    Created</span>
02945 <span class="comment">\**************************************************************************/</span>
02946 
<a name="l02947"></a><a class="code" href="../../d3/d8/client_8c.html#a93">02947</a> HMENU <a class="code" href="../../d3/d8/client_8c.html#a93">CreateMenu</a>()
02948 {
02949     <span class="keywordflow">return</span> (HMENU)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a173">NtUserCallNoParam</a>(SFI__CREATEMENU);
02950 }
02951 
02952 <span class="comment">/**************************************************************************\</span>
02953 <span class="comment">* CreatePopupMenu</span>
02954 <span class="comment">*</span>
02955 <span class="comment">* 22-Jul-1991 mikeke    Created</span>
02956 <span class="comment">\**************************************************************************/</span>
02957 
<a name="l02958"></a><a class="code" href="../../d3/d8/client_8c.html#a94">02958</a> HMENU <a class="code" href="../../d3/d8/client_8c.html#a94">CreatePopupMenu</a>()
02959 {
02960     <span class="keywordflow">return</span> (HMENU)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a173">NtUserCallNoParam</a>(SFI__CREATEPOPUPMENU);
02961 }
02962 
02963 <span class="comment">/**************************************************************************\</span>
02964 <span class="comment">* CurrentTaskLock</span>
02965 <span class="comment">*</span>
02966 <span class="comment">* 21-Apr-1992 jonpa    Created</span>
02967 <span class="comment">\**************************************************************************/</span>
02968 <span class="preprocessor">#if 0 </span><span class="comment">/* WOW is not using this but they might some day */</span>
02969 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> CurrentTaskLock(
02970     DWORD hlck)
02971 {
02972     <span class="keywordflow">return</span> (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a174">NtUserCallOneParam</a>(hlck, SFI_CURRENTTASKLOCK);
02973 }
02974 <span class="preprocessor">#endif</span>
02975 <span class="preprocessor"></span><span class="comment">/**************************************************************************\</span>
02976 <span class="comment">* DestroyCaret</span>
02977 <span class="comment">*</span>
02978 <span class="comment">* 22-Jul-1991 mikeke    Created</span>
02979 <span class="comment">\**************************************************************************/</span>
02980 
<a name="l02981"></a><a class="code" href="../../d3/d8/client_8c.html#a95">02981</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d8/client_8c.html#a95">DestroyCaret</a>()
02982 {
02983     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a173">NtUserCallNoParam</a>(SFI_ZZZDESTROYCARET);
02984 }
02985 
02986 <span class="comment">/**************************************************************************\</span>
02987 <span class="comment">* DirectedYield</span>
02988 <span class="comment">*</span>
02989 <span class="comment">* 22-Jul-1991 mikeke    Created</span>
02990 <span class="comment">\**************************************************************************/</span>
02991 
<a name="l02992"></a><a class="code" href="../../d3/d8/client_8c.html#a96">02992</a> <span class="keywordtype">void</span> <a class="code" href="../../d3/d8/client_8c.html#a96">DirectedYield</a>(
02993     DWORD dwThreadId)
02994 {
02995     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a174">NtUserCallOneParam</a>(dwThreadId, SFI_XXXDIRECTEDYIELD);
02996 }
02997 
02998 <span class="comment">/**************************************************************************\</span>
02999 <span class="comment">* DrawMenuBar</span>
03000 <span class="comment">*</span>
03001 <span class="comment">* 22-Jul-1991 mikeke    Created</span>
03002 <span class="comment">\**************************************************************************/</span>
03003 
<a name="l03004"></a><a class="code" href="../../d3/d8/client_8c.html#a97">03004</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d8/client_8c.html#a97">DrawMenuBar</a>(
03005     HWND hwnd)
03006 {
03007     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a176">NtUserCallHwndLock</a>(hwnd, SFI_XXXDRAWMENUBAR);
03008 }
03009 
03010 <span class="comment">/**************************************************************************\</span>
03011 <span class="comment">* EnableWindow</span>
03012 <span class="comment">*</span>
03013 <span class="comment">* 22-Jul-1991 mikeke    Created</span>
03014 <span class="comment">\**************************************************************************/</span>
03015 
<a name="l03016"></a><a class="code" href="../../d3/d8/client_8c.html#a98">03016</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d8/client_8c.html#a98">EnableWindow</a>(
03017     HWND hwnd,
03018     BOOL bEnable)
03019 {
03020     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a179">NtUserCallHwndParamLock</a>(hwnd, bEnable,
03021                                          SFI_XXXENABLEWINDOW);
03022 }
03023 
03024 <span class="comment">/**************************************************************************\</span>
03025 <span class="comment">* EnumClipboardFormats</span>
03026 <span class="comment">*</span>
03027 <span class="comment">* 22-Jul-1991 mikeke    Created</span>
03028 <span class="comment">\**************************************************************************/</span>
03029 
<a name="l03030"></a><a class="code" href="../../d3/d8/client_8c.html#a99">03030</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d3/d8/client_8c.html#a99">EnumClipboardFormats</a>(
03031     UINT fmt)
03032 {
03033     <span class="comment">/*</span>
03034 <span class="comment">     * So apps can tell if the API failed or just ran out of formats</span>
03035 <span class="comment">     * we "clear" the last error.</span>
03036 <span class="comment">     */</span>
03037     UserSetLastError(ERROR_SUCCESS);
03038 
03039     <span class="keywordflow">return</span> (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a174">NtUserCallOneParam</a>(fmt, SFI__ENUMCLIPBOARDFORMATS);
03040 }
03041 
03042 <span class="comment">/**************************************************************************\</span>
03043 <span class="comment">* FlashWindow</span>
03044 <span class="comment">*</span>
03045 <span class="comment">* 22-Jul-1991 mikeke    Created</span>
03046 <span class="comment">* 08-Aug-1997 Gerardob  Added FlashWindowEx.</span>
03047 <span class="comment">* 16-Nov-1997 MCostea   Make it use NtUserFlashWindowEx</span>
03048 <span class="comment">\**************************************************************************/</span>
03049 
<a name="l03050"></a><a class="code" href="../../d3/d8/client_8c.html#a100">03050</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d8/client_8c.html#a100">FlashWindow</a>(
03051     HWND hwnd,
03052     BOOL bInvert)
03053 {
03054     FLASHWINFO fwi = {
03055             <span class="keyword">sizeof</span>(FLASHWINFO), <span class="comment">// cbSize</span>
03056             hwnd,   <span class="comment">// hwnd</span>
03057             bInvert ? (FLASHW_CAPTION | FLASHW_TRAY) : 0,   <span class="comment">// flags</span>
03058             1,      <span class="comment">// uCount</span>
03059             0       <span class="comment">// dwTimeout</span>
03060         };
03061     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a405">NtUserFlashWindowEx</a>(&amp;fwi);
03062 }
03063 
03064 <span class="comment">/**************************************************************************\</span>
03065 <span class="comment">* GetDialogBaseUnits</span>
03066 <span class="comment">*</span>
03067 <span class="comment">* 22-Jul-1991 mikeke    Created</span>
03068 <span class="comment">\**************************************************************************/</span>
03069 
<a name="l03070"></a><a class="code" href="../../d3/d8/client_8c.html#a101">03070</a> <span class="keywordtype">long</span> <a class="code" href="../../d3/d8/client_8c.html#a101">GetDialogBaseUnits</a>()
03071 {
03072     <span class="keywordflow">return</span> MAKELONG(<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;cxSysFontChar, <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;cySysFontChar);
03073 }
03074 
03075 <span class="comment">/**************************************************************************\</span>
03076 <span class="comment">* GetInputDesktop</span>
03077 <span class="comment">*</span>
03078 <span class="comment">* 22-Jul-1991 mikeke    Created</span>
03079 <span class="comment">\**************************************************************************/</span>
03080 
<a name="l03081"></a><a class="code" href="../../d3/d8/client_8c.html#a102">03081</a> HDESK <a class="code" href="../../d3/d8/client_8c.html#a102">GetInputDesktop</a>()
03082 {
03083     <span class="keywordflow">return</span> (HDESK)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a173">NtUserCallNoParam</a>(SFI_XXXGETINPUTDESKTOP);
03084 }
03085 
03086 <span class="comment">/***************************************************************************\</span>
03087 <span class="comment">* GetClientKeyboardType</span>
03088 <span class="comment">*</span>
03089 <span class="comment">* This routine returns the keyboard type sent from the Hydra client.</span>
03090 <span class="comment">* Hydra client sends keyboard types at session startup.</span>
03091 <span class="comment">*</span>
03092 <span class="comment">* Returns the client winstation specified a keyboard type.</span>
03093 <span class="comment">* History:</span>
03094 <span class="comment">\***************************************************************************/</span>
03095 
03096 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l03097"></a><a class="code" href="../../d3/d8/client_8c.html#a103">03097</a> <a class="code" href="../../d3/d8/client_8c.html#a103">GetClientKeyboardType</a>(PCLIENTKEYBOARDTYPE KeyboardType)
03098 {
03099     ULONG Length;
03100     WINSTATIONCLIENTW ClientData;
03101     <span class="keyword">static</span> CLIENTKEYBOARDTYPE ClientKeyboard = { (ULONG)-1, (ULONG)-1, (ULONG)-1 };
03102 
03103     <span class="comment">//</span>
03104     <span class="comment">// Should be called only if this is a HYDRA remote session.</span>
03105     <span class="comment">//</span>
03106     UserAssert(<a class="code" href="../../d6/d0/usercli_8h.html#a30">ISREMOTESESSION</a>());
03107 
03108     <span class="comment">//  Skip if this is the console</span>
03109     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d0/usercli_8h.html#a30">ISREMOTESESSION</a>()) {
03110         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03111     }
03112 
03113     <span class="keywordflow">if</span> (ClientKeyboard.Type == (ULONG)-1) {
03114 
03115         <span class="comment">// Fetch the WinStation's basic information</span>
03116         <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d8/client_8c.html#a66">WinStaQueryInformationW</a>(SERVERNAME_CURRENT,
03117                                    LOGONID_CURRENT,
03118                                    WinStationClient,
03119                                    &amp;ClientData,
03120                                    <span class="keyword">sizeof</span>(ClientData),
03121                                    &amp;Length)) {
03122             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03123         }
03124 
03125         ClientKeyboard.Type        = ClientData.KeyboardType;
03126         ClientKeyboard.SubType     = ClientData.KeyboardSubType;
03127         ClientKeyboard.FunctionKey = ClientData.KeyboardFunctionKey;
03128 
03129     }
03130 
03131     *KeyboardType = ClientKeyboard;
03132 
03133     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03134 }
03135 
03136 
03137 <span class="comment">/**************************************************************************\</span>
03138 <span class="comment">* GetKeyboardType</span>
03139 <span class="comment">*</span>
03140 <span class="comment">* 22-Jul-1991 mikeke    Created</span>
03141 <span class="comment">\**************************************************************************/</span>
03142 
<a name="l03143"></a><a class="code" href="../../d3/d8/client_8c.html#a104">03143</a> <span class="keywordtype">int</span> <a class="code" href="../../d3/d8/client_8c.html#a104">GetKeyboardType</a>(
03144     <span class="keywordtype">int</span> nTypeFlags)
03145 {
03146     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a30">ISREMOTESESSION</a>()) {
03147         <span class="comment">//</span>
03148         <span class="comment">//  Get keyboard type from Hydra client if this is not the console</span>
03149         <span class="comment">//</span>
03150         CLIENTKEYBOARDTYPE KeyboardType;
03151 
03152         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/client_8c.html#a103">GetClientKeyboardType</a>(&amp;KeyboardType)) {
03153             <span class="keywordflow">switch</span> (nTypeFlags) {
03154             <span class="keywordflow">case</span> 0:
03155                 <span class="keywordflow">return</span> KeyboardType.Type;
03156             <span class="keywordflow">case</span> 1:
03157                 <span class="keywordflow">if</span> (KeyboardType.Type == 7) {               <span class="comment">/* 7 is a Japanese */</span>
03158                     <span class="comment">// Because HIWORD has been using private value</span>
03159                     <span class="comment">// for Japanese keyboard layout.</span>
03160                     <span class="keywordflow">return</span> LOWORD(KeyboardType.SubType);
03161                 }
03162                 <span class="keywordflow">else</span>
03163                     <span class="keywordflow">return</span> KeyboardType.SubType;
03164             <span class="keywordflow">case</span> 2:
03165                 <span class="keywordflow">return</span> KeyboardType.FunctionKey;
03166             <span class="keywordflow">default</span>:
03167                 <span class="keywordflow">break</span>;
03168             }
03169         }
03170         <span class="keywordflow">return</span> 0;
03171     }
03172     <span class="keywordflow">return</span> (<span class="keywordtype">int</span>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a174">NtUserCallOneParam</a>(nTypeFlags, SFI__GETKEYBOARDTYPE);
03173 }
03174 
03175 <span class="comment">/**************************************************************************\</span>
03176 <span class="comment">* GetMessagePos</span>
03177 <span class="comment">*</span>
03178 <span class="comment">* 22-Jul-1991 mikeke    Created</span>
03179 <span class="comment">\**************************************************************************/</span>
03180 
<a name="l03181"></a><a class="code" href="../../d3/d8/client_8c.html#a105">03181</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d3/d8/client_8c.html#a105">GetMessagePos</a>()
03182 {
03183     <span class="keywordflow">return</span> (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a173">NtUserCallNoParam</a>(SFI__GETMESSAGEPOS);
03184 }
03185 
03186 <span class="comment">/**************************************************************************\</span>
03187 <span class="comment">* GetQueueStatus</span>
03188 <span class="comment">*</span>
03189 <span class="comment">* 22-Jul-1991 mikeke    Created</span>
03190 <span class="comment">\**************************************************************************/</span>
03191 
<a name="l03192"></a><a class="code" href="../../d3/d8/client_8c.html#a106">03192</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d3/d8/client_8c.html#a106">GetQueueStatus</a>(
03193     UINT flags)
03194 {
03195     <span class="keywordflow">if</span> (flags &amp; ~QS_VALID) {
03196         RIPERR2(ERROR_INVALID_FLAGS, RIP_WARNING, <span class="stringliteral">"Invalid flags %x &amp; ~%x != 0"</span>,
03197               flags, QS_VALID);
03198         <span class="keywordflow">return</span> 0;
03199     }
03200 
03201     <span class="keywordflow">return</span> (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a174">NtUserCallOneParam</a>(flags, SFI__GETQUEUESTATUS);
03202 }
03203 
03204 <span class="comment">/**************************************************************************\</span>
03205 <span class="comment">* KillSystemTimer</span>
03206 <span class="comment">*</span>
03207 <span class="comment">* 7-Jul-1992 mikehar    Created</span>
03208 <span class="comment">\**************************************************************************/</span>
03209 
<a name="l03210"></a><a class="code" href="../../d3/d8/client_8c.html#a107">03210</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d8/client_8c.html#a107">KillSystemTimer</a>(
03211     HWND hwnd,
03212     UINT nIDEvent)
03213 {
03214     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a178">NtUserCallHwndParam</a>(hwnd, nIDEvent, SFI__KILLSYSTEMTIMER);
03215 }
03216 
03217 <span class="comment">/**************************************************************************\</span>
03218 <span class="comment">* LoadRemoteFonts</span>
03219 <span class="comment">*  02-Dec-1993 -by- Bodin Dresevic [BodinD]</span>
03220 <span class="comment">* Wrote it.</span>
03221 <span class="comment">\**************************************************************************/</span>
03222 
<a name="l03223"></a><a class="code" href="../../d3/d8/client_8c.html#a108">03223</a> <span class="keywordtype">void</span> <a class="code" href="../../d3/d8/client_8c.html#a108">LoadRemoteFonts</a>(<span class="keywordtype">void</span>)
03224 {
03225     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a174">NtUserCallOneParam</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,SFI_XXXLW_LOADFONTS);
03226 
03227     <span class="comment">/*</span>
03228 <span class="comment">     * After load remote fonts, let eudc enabled.</span>
03229 <span class="comment">     */</span>
03230     <a class="code" href="../../d3/d8/client_8c.html#a30">EnableEUDC</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03231 }
03232 
03233 
03234 <span class="comment">/**************************************************************************\</span>
03235 <span class="comment">* LoadLocalFonts</span>
03236 <span class="comment">*  31-Mar-1994 -by- Bodin Dresevic [gerritv]</span>
03237 <span class="comment">* Wrote it.</span>
03238 <span class="comment">\**************************************************************************/</span>
03239 
<a name="l03240"></a><a class="code" href="../../d3/d8/client_8c.html#a109">03240</a> <span class="keywordtype">void</span> <a class="code" href="../../d3/d8/client_8c.html#a109">LoadLocalFonts</a>(<span class="keywordtype">void</span>)
03241 {
03242     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a174">NtUserCallOneParam</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,SFI_XXXLW_LOADFONTS);
03243 }
03244 
03245 
03246 <span class="comment">/**************************************************************************\</span>
03247 <span class="comment">* MessageBeep</span>
03248 <span class="comment">*</span>
03249 <span class="comment">* 22-Jul-1991 mikeke    Created</span>
03250 <span class="comment">\**************************************************************************/</span>
03251 
<a name="l03252"></a><a class="code" href="../../d3/d8/client_8c.html#a110">03252</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d8/client_8c.html#a110">MessageBeep</a>(
03253     UINT wType)
03254 {
03255     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a174">NtUserCallOneParam</a>(wType, SFI_XXXMESSAGEBEEP);
03256 }
03257 
03258 <span class="comment">/**************************************************************************\</span>
03259 <span class="comment">* OpenIcon</span>
03260 <span class="comment">*</span>
03261 <span class="comment">* 22-Jul-1991 mikeke    Created</span>
03262 <span class="comment">* 17-Feb-1998 MCostea   Use xxxShowWindow instead of xxxCloseWindow</span>
03263 <span class="comment">\**************************************************************************/</span>
03264 
<a name="l03265"></a><a class="code" href="../../d3/d8/client_8c.html#a111">03265</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d8/client_8c.html#a111">OpenIcon</a>(
03266     HWND hwnd)
03267 {
03268     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
03269 
03270     <span class="keywordflow">if</span> ((pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hwnd)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03271         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03272     }
03273     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>)) {
03274         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a237">NtUserShowWindow</a>(hwnd, SW_NORMAL);
03275     }
03276     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03277 }
03278 
<a name="l03279"></a><a class="code" href="../../d3/d8/client_8c.html#a112">03279</a> HWND <a class="code" href="../../d3/d8/client_8c.html#a112">GetShellWindow</a>(<span class="keywordtype">void</span>) {
03280     <a class="code" href="../../d2/d2/struct__CLIENTINFO.html">PCLIENTINFO</a> pci;
03281     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
03282 
03283     <a class="code" href="../../d1/d0/inc_2user_8h.html#a848">ConnectIfNecessary</a>();
03284 
03285     pci = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a16">GetClientInfo</a>();
03286     pwnd = pci-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o5">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o5">spwndShell</a>;
03287     <span class="keywordflow">if</span> (pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03288         pwnd = (<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)((KERNEL_ULONG_PTR)pwnd - pci-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o6">ulClientDelta</a>);
03289         <span class="keywordflow">return</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwnd);
03290     }
03291     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03292 }
03293 
<a name="l03294"></a><a class="code" href="../../d3/d8/client_8c.html#a113">03294</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  <a class="code" href="../../d3/d8/client_8c.html#a113">SetShellWindow</a>(HWND hwnd) {
03295     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a116">NtUserSetShellWindowEx</a>(hwnd, hwnd);
03296 }
03297 
<a name="l03298"></a><a class="code" href="../../d3/d8/client_8c.html#a114">03298</a> HWND <a class="code" href="../../d3/d8/client_8c.html#a114">GetProgmanWindow</a>(<span class="keywordtype">void</span>) {
03299     <a class="code" href="../../d2/d2/struct__CLIENTINFO.html">PCLIENTINFO</a> pci;
03300     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
03301 
03302     <a class="code" href="../../d1/d0/inc_2user_8h.html#a848">ConnectIfNecessary</a>();
03303 
03304     pci = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a16">GetClientInfo</a>();
03305     pwnd = pci-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o5">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o9">spwndProgman</a>;
03306     <span class="keywordflow">if</span> (pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03307         pwnd = (<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)((KERNEL_ULONG_PTR)pwnd - pci-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o6">ulClientDelta</a>);
03308         <span class="keywordflow">return</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwnd);
03309     }
03310     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03311 }
03312 
<a name="l03313"></a><a class="code" href="../../d3/d8/client_8c.html#a115">03313</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  <a class="code" href="../../d3/d8/client_8c.html#a115">SetProgmanWindow</a>(
03314     HWND hwnd)
03315 {
03316     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a177">NtUserCallHwndOpt</a>(hwnd, SFI__SETPROGMANWINDOW);
03317 }
03318 
<a name="l03319"></a><a class="code" href="../../d3/d8/client_8c.html#a116">03319</a> HWND <a class="code" href="../../d3/d8/client_8c.html#a116">GetTaskmanWindow</a>(<span class="keywordtype">void</span>) {
03320     <a class="code" href="../../d2/d2/struct__CLIENTINFO.html">PCLIENTINFO</a> pci;
03321     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
03322 
03323     <a class="code" href="../../d1/d0/inc_2user_8h.html#a848">ConnectIfNecessary</a>();
03324 
03325     pci = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a16">GetClientInfo</a>();
03326     pwnd = pci-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o5">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o8">spwndTaskman</a>;
03327     <span class="keywordflow">if</span> (pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03328         pwnd = (<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)((KERNEL_ULONG_PTR)pwnd - pci-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o6">ulClientDelta</a>);
03329         <span class="keywordflow">return</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwnd);
03330     }
03331     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03332 }
03333 
<a name="l03334"></a><a class="code" href="../../d3/d8/client_8c.html#a117">03334</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  <a class="code" href="../../d3/d8/client_8c.html#a117">SetTaskmanWindow</a>(
03335     HWND hwnd)
03336 {
03337     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a177">NtUserCallHwndOpt</a>(hwnd, SFI__SETTASKMANWINDOW);
03338 }
03339 
03340 <span class="comment">/**************************************************************************\</span>
03341 <span class="comment">* SetWindowContextHelpId</span>
03342 <span class="comment">*</span>
03343 <span class="comment">* 22-Jul-1991 mikeke    Created</span>
03344 <span class="comment">\**************************************************************************/</span>
03345 
<a name="l03346"></a><a class="code" href="../../d3/d8/client_8c.html#a118">03346</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d8/client_8c.html#a118">SetWindowContextHelpId</a>(
03347     HWND hwnd,
03348     DWORD <span class="keywordtype">id</span>)
03349 {
03350     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a178">NtUserCallHwndParam</a>(hwnd, <span class="keywordtype">id</span>, SFI__SETWINDOWCONTEXTHELPID);
03351 }
03352 
03353 <span class="comment">/**************************************************************************\</span>
03354 <span class="comment">* GetWindowContextHelpId</span>
03355 <span class="comment">*</span>
03356 <span class="comment">* 22-Jul-1991 mikeke    Created</span>
03357 <span class="comment">\**************************************************************************/</span>
03358 
<a name="l03359"></a><a class="code" href="../../d3/d8/client_8c.html#a119">03359</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d3/d8/client_8c.html#a119">GetWindowContextHelpId</a>(
03360     HWND hwnd)
03361 {
03362     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a175">NtUserCallHwnd</a>(hwnd, SFI__GETWINDOWCONTEXTHELPID);
03363 }
03364 
<a name="l03365"></a><a class="code" href="../../d6/d0/usercli_8h.html#a606">03365</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1628">SetWindowState</a>(
03366     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
03367     UINT flags)
03368 {
03369     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, flags) != <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(flags))
03370         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a178">NtUserCallHwndParam</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwnd), flags, SFI_SETWINDOWSTATE);
03371 }
03372 
<a name="l03373"></a><a class="code" href="../../d6/d0/usercli_8h.html#a607">03373</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1629">ClearWindowState</a>(
03374     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
03375     UINT flags)
03376 {
03377     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, flags))
03378         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a178">NtUserCallHwndParam</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwnd), flags, SFI_CLEARWINDOWSTATE);
03379 }
03380 
03381 <span class="comment">/**************************************************************************\</span>
03382 <span class="comment">* PostQuitMessage</span>
03383 <span class="comment">*</span>
03384 <span class="comment">* 22-Jul-1991 mikeke    Created</span>
03385 <span class="comment">\**************************************************************************/</span>
03386 
<a name="l03387"></a><a class="code" href="../../d3/d8/client_8c.html#a122">03387</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d3/d8/client_8c.html#a122">PostQuitMessage</a>(
03388     <span class="keywordtype">int</span> nExitCode)
03389 {
03390     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a174">NtUserCallOneParam</a>(nExitCode, SFI__POSTQUITMESSAGE);
03391 }
03392 
03393 <span class="comment">/**************************************************************************\</span>
03394 <span class="comment">* REGISTERUSERHUNAPPHANDLERS</span>
03395 <span class="comment">*</span>
03396 <span class="comment">* 01-Apr-1992 jonpa    Created</span>
03397 <span class="comment">\**************************************************************************/</span>
03398 
<a name="l03399"></a><a class="code" href="../../d3/d8/client_8c.html#a123">03399</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d8/client_8c.html#a123">RegisterUserHungAppHandlers</a>(
03400     PFNW32ET pfnW32EndTask,
03401     HANDLE   hEventWowExec)
03402 {
03403     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a180">NtUserCallTwoParam</a>((ULONG_PTR)pfnW32EndTask,
03404                                     (ULONG_PTR)hEventWowExec,
03405                                     SFI_XXXREGISTERUSERHUNGAPPHANDLERS);
03406 }
03407 
03408 <span class="comment">/**************************************************************************\</span>
03409 <span class="comment">* ReleaseCapture</span>
03410 <span class="comment">*</span>
03411 <span class="comment">* 22-Jul-1991 mikeke    Created</span>
03412 <span class="comment">\**************************************************************************/</span>
03413 
<a name="l03414"></a><a class="code" href="../../d3/d8/client_8c.html#a124">03414</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d8/client_8c.html#a124">ReleaseCapture</a>()
03415 {
03416     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a173">NtUserCallNoParam</a>(SFI_XXXRELEASECAPTURE);
03417 }
03418 
03419 <span class="comment">/**************************************************************************\</span>
03420 <span class="comment">* ReplyMessage</span>
03421 <span class="comment">*</span>
03422 <span class="comment">* 22-Jul-1991 mikeke    Created</span>
03423 <span class="comment">\**************************************************************************/</span>
03424 
<a name="l03425"></a><a class="code" href="../../d3/d8/client_8c.html#a125">03425</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d8/client_8c.html#a125">ReplyMessage</a>(
03426     LRESULT pp1)
03427 {
03428     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a174">NtUserCallOneParam</a>(pp1, SFI__REPLYMESSAGE);
03429 }
03430 
03431 <span class="comment">/**************************************************************************\</span>
03432 <span class="comment">* RegisterSystemThread</span>
03433 <span class="comment">*</span>
03434 <span class="comment">* 21-Jun-1994 johnc    Created</span>
03435 <span class="comment">\**************************************************************************/</span>
03436 
<a name="l03437"></a><a class="code" href="../../d3/d8/client_8c.html#a126">03437</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d3/d8/client_8c.html#a126">RegisterSystemThread</a>(
03438     DWORD dwFlags, DWORD dwReserved)
03439 {
03440     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a180">NtUserCallTwoParam</a>(<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>, dwReserved, SFI_ZZZREGISTERSYSTEMTHREAD);
03441 }
03442 
03443 <span class="comment">/**************************************************************************\</span>
03444 <span class="comment">* SetCaretBlinkTime</span>
03445 <span class="comment">*</span>
03446 <span class="comment">* 22-Jul-1991 mikeke    Created</span>
03447 <span class="comment">\**************************************************************************/</span>
03448 
<a name="l03449"></a><a class="code" href="../../d3/d8/client_8c.html#a127">03449</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d8/client_8c.html#a127">SetCaretBlinkTime</a>(
03450     UINT wMSeconds)
03451 {
03452     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a174">NtUserCallOneParam</a>(wMSeconds, SFI__SETCARETBLINKTIME);
03453 }
03454 
03455 <span class="comment">/**************************************************************************\</span>
03456 <span class="comment">* SetCaretPos</span>
03457 <span class="comment">*</span>
03458 <span class="comment">* 22-Jul-1991 mikeke    Created</span>
03459 <span class="comment">\**************************************************************************/</span>
03460 
<a name="l03461"></a><a class="code" href="../../d3/d8/client_8c.html#a128">03461</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d8/client_8c.html#a128">SetCaretPos</a>(
03462     <span class="keywordtype">int</span> X,
03463     <span class="keywordtype">int</span> Y)
03464 {
03465     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a180">NtUserCallTwoParam</a>(X, Y, SFI_ZZZSETCARETPOS);
03466 }
03467 
03468 <span class="comment">/**************************************************************************\</span>
03469 <span class="comment">* SetCursorPos</span>
03470 <span class="comment">*</span>
03471 <span class="comment">* 22-Jul-1991 mikeke    Created</span>
03472 <span class="comment">\**************************************************************************/</span>
03473 
<a name="l03474"></a><a class="code" href="../../d3/d8/client_8c.html#a129">03474</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d8/client_8c.html#a129">SetCursorPos</a>(
03475     <span class="keywordtype">int</span> X,
03476     <span class="keywordtype">int</span> Y)
03477 {
03478     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a180">NtUserCallTwoParam</a>(X, Y, SFI_ZZZSETCURSORPOS);
03479 }
03480 
03481 <span class="comment">/**************************************************************************\</span>
03482 <span class="comment">* SetDoubleClickTime</span>
03483 <span class="comment">*</span>
03484 <span class="comment">* 22-Jul-1991 mikeke    Created</span>
03485 <span class="comment">\**************************************************************************/</span>
03486 
<a name="l03487"></a><a class="code" href="../../d3/d8/client_8c.html#a130">03487</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d8/client_8c.html#a130">SetDoubleClickTime</a>(
03488     UINT cms)
03489 {
03490     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a174">NtUserCallOneParam</a>(cms, SFI__SETDOUBLECLICKTIME);
03491 }
03492 
03493 <span class="comment">/**************************************************************************\</span>
03494 <span class="comment">* SetForegroundWindow</span>
03495 <span class="comment">*</span>
03496 <span class="comment">* 22-Jul-1991 mikeke    Created</span>
03497 <span class="comment">\**************************************************************************/</span>
03498 
<a name="l03499"></a><a class="code" href="../../d3/d8/client_8c.html#a131">03499</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d8/client_8c.html#a131">SetForegroundWindow</a>(
03500     HWND hwnd)
03501 {
03502     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a228">NtUserSetForegroundWindow</a>(hwnd);
03503 }
03504 <span class="comment">/**************************************************************************\</span>
03505 <span class="comment">* AllowSetForegroundWindow</span>
03506 <span class="comment">*</span>
03507 <span class="comment">* 28-Jan-1998 GerardoB    Created</span>
03508 <span class="comment">\**************************************************************************/</span>
<a name="l03509"></a><a class="code" href="../../d3/d8/client_8c.html#a132">03509</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d8/client_8c.html#a132">AllowSetForegroundWindow</a>(
03510     DWORD dwProcessId)
03511 {
03512     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a174">NtUserCallOneParam</a>(dwProcessId, SFI_XXXALLOWSETFOREGROUNDWINDOW);
03513 }
03514 <span class="comment">/**************************************************************************\</span>
03515 <span class="comment">* LockSetForegroundWindow</span>
03516 <span class="comment">*</span>
03517 <span class="comment">* 07-Apr-1998 GerardoB    Created</span>
03518 <span class="comment">\**************************************************************************/</span>
<a name="l03519"></a><a class="code" href="../../d3/d8/client_8c.html#a133">03519</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d8/client_8c.html#a133">LockSetForegroundWindow</a>(
03520     UINT uLockCode)
03521 {
03522     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a174">NtUserCallOneParam</a>(uLockCode, SFI__LOCKSETFOREGROUNDWINDOW);
03523 }
03524 
03525 <span class="comment">/**************************************************************************\</span>
03526 <span class="comment">* ShowCursor</span>
03527 <span class="comment">*</span>
03528 <span class="comment">* 22-Jul-1991 mikeke    Created</span>
03529 <span class="comment">\**************************************************************************/</span>
03530 
<a name="l03531"></a><a class="code" href="../../d3/d8/client_8c.html#a134">03531</a> <span class="keywordtype">int</span> <a class="code" href="../../d3/d8/client_8c.html#a134">ShowCursor</a>(
03532     BOOL bShow)
03533 {
03534     <span class="keywordflow">return</span> (<span class="keywordtype">int</span>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a174">NtUserCallOneParam</a>(bShow, SFI_ZZZSHOWCURSOR);
03535 }
03536 
03537 <span class="comment">/**************************************************************************\</span>
03538 <span class="comment">* ShowOwnedPopups</span>
03539 <span class="comment">*</span>
03540 <span class="comment">* 22-Jul-1991 mikeke    Created</span>
03541 <span class="comment">\**************************************************************************/</span>
03542 
<a name="l03543"></a><a class="code" href="../../d3/d8/client_8c.html#a135">03543</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d8/client_8c.html#a135">ShowOwnedPopups</a>(
03544     HWND hwnd,
03545     BOOL fShow)
03546 {
03547     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a179">NtUserCallHwndParamLock</a>(hwnd, fShow,
03548                                          SFI_XXXSHOWOWNEDPOPUPS);
03549 }
03550 
03551 <span class="comment">/**************************************************************************\</span>
03552 <span class="comment">* ShowStartGlass</span>
03553 <span class="comment">*</span>
03554 <span class="comment">* 10-Sep-1992 scottlu    Created</span>
03555 <span class="comment">\**************************************************************************/</span>
03556 
<a name="l03557"></a><a class="code" href="../../d3/d8/client_8c.html#a136">03557</a> <span class="keywordtype">void</span> <a class="code" href="../../d3/d8/client_8c.html#a136">ShowStartGlass</a>(
03558     DWORD dwTimeout)
03559 {
03560     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a174">NtUserCallOneParam</a>(dwTimeout, SFI_ZZZSHOWSTARTGLASS);
03561 }
03562 
03563 <span class="comment">/**************************************************************************\</span>
03564 <span class="comment">* SwapMouseButton</span>
03565 <span class="comment">*</span>
03566 <span class="comment">* 22-Jul-1991 mikeke    Created</span>
03567 <span class="comment">\**************************************************************************/</span>
03568 
<a name="l03569"></a><a class="code" href="../../d3/d8/client_8c.html#a137">03569</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d8/client_8c.html#a137">SwapMouseButton</a>(
03570     BOOL fSwap)
03571 {
03572     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a174">NtUserCallOneParam</a>(fSwap, SFI__SWAPMOUSEBUTTON);
03573 }
03574 
03575 <span class="comment">/**************************************************************************\</span>
03576 <span class="comment">* TileChildWindows</span>
03577 <span class="comment">*</span>
03578 <span class="comment">* 22-Jul-1991 mikeke    Created</span>
03579 <span class="comment">\**************************************************************************/</span>
03580 
<a name="l03581"></a><a class="code" href="../../d3/d8/client_8c.html#a138">03581</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d8/client_8c.html#a138">TileChildWindows</a>(
03582     HWND hwndParent,
03583     UINT flags)
03584 {
03585     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)<a class="code" href="../../d6/d5/mdiwin_8c.html#a23">TileWindows</a>(hwndParent, flags, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03586 }
03587 
03588 <span class="comment">/**************************************************************************\</span>
03589 <span class="comment">* UnhookWindowsHook</span>
03590 <span class="comment">*</span>
03591 <span class="comment">* 22-Jul-1991 mikeke    Created</span>
03592 <span class="comment">\**************************************************************************/</span>
03593 
<a name="l03594"></a><a class="code" href="../../d3/d8/client_8c.html#a139">03594</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d8/client_8c.html#a139">UnhookWindowsHook</a>(
03595     <span class="keywordtype">int</span> nCode,
03596     HOOKPROC pfnFilterProc)
03597 {
03598     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a180">NtUserCallTwoParam</a>(nCode, (ULONG_PTR)pfnFilterProc,
03599                                     SFI_ZZZUNHOOKWINDOWSHOOK);
03600 }
03601 
03602 <span class="comment">/**************************************************************************\</span>
03603 <span class="comment">* UpdateWindow</span>
03604 <span class="comment">*</span>
03605 <span class="comment">* 22-Jul-1991 mikeke    Created</span>
03606 <span class="comment">\**************************************************************************/</span>
03607 
<a name="l03608"></a><a class="code" href="../../d3/d8/client_8c.html#a140">03608</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d8/client_8c.html#a140">UpdateWindow</a>(
03609     HWND hwnd)
03610 {
03611     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
03612 
03613     <span class="keywordflow">if</span> ((pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hwnd)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03614         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03615     }
03616 
03617     <span class="comment">/*</span>
03618 <span class="comment">     * Don't need to do anything if this window does not need any painting</span>
03619 <span class="comment">     * and it has no child windows</span>
03620 <span class="comment">     */</span>
03621     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a501">NEEDSPAINT</a>(pwnd) &amp;&amp; (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
03622         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03623     }
03624 
03625     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a176">NtUserCallHwndLock</a>(hwnd, SFI_XXXUPDATEWINDOW);
03626 }
03627 
<a name="l03628"></a><a class="code" href="../../d3/d8/client_8c.html#a141">03628</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d8/client_8c.html#a141">RegisterShellHookWindow</a>(
03629     HWND hwnd)
03630 {
03631     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a175">NtUserCallHwnd</a>(hwnd, SFI__REGISTERSHELLHOOKWINDOW);
03632 }
03633 
<a name="l03634"></a><a class="code" href="../../d3/d8/client_8c.html#a142">03634</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d8/client_8c.html#a142">DeregisterShellHookWindow</a>(
03635     HWND hwnd)
03636 {
03637     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a175">NtUserCallHwnd</a>(hwnd, SFI__DEREGISTERSHELLHOOKWINDOW);
03638 }
03639 
03640 <span class="comment">/**************************************************************************\</span>
03641 <span class="comment">* UserRealizePalette</span>
03642 <span class="comment">*</span>
03643 <span class="comment">* 13-Nov-1992 mikeke     Created</span>
03644 <span class="comment">\**************************************************************************/</span>
03645 
<a name="l03646"></a><a class="code" href="../../d3/d8/client_8c.html#a143">03646</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d3/d8/client_8c.html#a143">UserRealizePalette</a>(
03647     HDC hdc)
03648 {
03649     <span class="keywordflow">return</span> (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a174">NtUserCallOneParam</a>((ULONG_PTR)hdc, SFI_XXXREALIZEPALETTE);
03650 }
03651 
03652 <span class="comment">/**************************************************************************\</span>
03653 <span class="comment">* WindowFromDC</span>
03654 <span class="comment">*</span>
03655 <span class="comment">* 22-Jul-1991 mikeke    Created</span>
03656 <span class="comment">\**************************************************************************/</span>
03657 
<a name="l03658"></a><a class="code" href="../../d3/d8/client_8c.html#a144">03658</a> HWND <a class="code" href="../../d3/d8/client_8c.html#a144">WindowFromDC</a>(
03659     HDC hdc)
03660 {
03661     <span class="keywordflow">return</span> (HWND)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a174">NtUserCallOneParam</a>((ULONG_PTR)hdc, SFI__WINDOWFROMDC);
03662 }
03663 
03664 <span class="comment">/***************************************************************************\</span>
03665 <span class="comment">* GetWindowRgn</span>
03666 <span class="comment">*</span>
03667 <span class="comment">* Parameters:</span>
03668 <span class="comment">*     hwnd    --  Window handle</span>
03669 <span class="comment">*     hrgn    --  Region to copy window region into</span>
03670 <span class="comment">*</span>
03671 <span class="comment">* Returns:</span>
03672 <span class="comment">*     Region complexity code</span>
03673 <span class="comment">*</span>
03674 <span class="comment">* Comments:</span>
03675 <span class="comment">*     hrgn gets returned in window rect coordinates (not client rect)</span>
03676 <span class="comment">*</span>
03677 <span class="comment">* 30-JUl-1994 ScottLu    Created.</span>
03678 <span class="comment">\***************************************************************************/</span>
03679 
<a name="l03680"></a><a class="code" href="../../d3/d8/client_8c.html#a145">03680</a> <span class="keywordtype">int</span> <a class="code" href="../../d3/d8/client_8c.html#a145">GetWindowRgn</a>(HWND hwnd, HRGN hrgn)
03681 {
03682     <span class="keywordtype">int</span> code;
03683     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
03684 
03685     <span class="keywordflow">if</span> (hrgn == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
03686         <span class="keywordflow">return</span> ERROR;
03687 
03688     <span class="keywordflow">if</span> ((pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hwnd)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03689         <span class="keywordflow">return</span> ERROR;
03690     }
03691 
03692     <span class="comment">/*</span>
03693 <span class="comment">     * If there is no region selected into this window, then return error</span>
03694 <span class="comment">     */</span>
03695     <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o19">hrgnClip</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a596">WFMAXFAKEREGIONAL</a>)) {
03696         <span class="keywordflow">return</span> ERROR;
03697     }
03698 
03699     code = CombineRgn(hrgn, pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o19">hrgnClip</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, RGN_COPY);
03700 
03701     <span class="keywordflow">if</span> (code == ERROR)
03702         <span class="keywordflow">return</span> ERROR;
03703 
03704     <span class="comment">/*</span>
03705 <span class="comment">     * Offset it to window rect coordinates (not client rect coordinates)</span>
03706 <span class="comment">     */</span>
03707      <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a232">GETFNID</a>(pwnd) != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a196">FNID_DESKTOP</a>) {
03708         code = OffsetRgn(hrgn, -pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left, -pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.top);
03709      }
03710 
03711 <span class="preprocessor">#ifdef USE_MIRRORING</span>
03712 <span class="preprocessor"></span>     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WEFLAYOUTRTL)) {
03713          MirrorRgn(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwnd), hrgn);
03714      }
03715 <span class="preprocessor">#endif</span>
03716 <span class="preprocessor"></span>
03717     <span class="keywordflow">return</span> code;
03718 }
03719 
03720 <span class="comment">/***************************************************************************\</span>
03721 <span class="comment">* GetActiveKeyboardName</span>
03722 <span class="comment">*</span>
03723 <span class="comment">* Retrieves the active keyboard layout ID from the registry.</span>
03724 <span class="comment">*</span>
03725 <span class="comment">* 01-11-95 JimA         Created.</span>
03726 <span class="comment">* 03-06-95 GregoryW     Modified to use new registry layout</span>
03727 <span class="comment">\***************************************************************************/</span>
03728 
<a name="l03729"></a><a class="code" href="../../d6/d0/usercli_8h.html#a603">03729</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d6/d0/usercli_8h.html#a603">GetActiveKeyboardName</a>(
03730     LPWSTR lpszName)
03731 {
03732     LPTSTR szKbdActive = TEXT(<span class="stringliteral">"Active"</span>);
03733     LPTSTR szKbdLayout = TEXT(<span class="stringliteral">"Keyboard Layout"</span>);
03734     LPTSTR szKbdLayoutPreload = TEXT(<span class="stringliteral">"Keyboard Layout\\Preload"</span>);
03735     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> rc;
03736     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> cbSize;
03737     HANDLE UserKeyHandle, hKey, hKeyPreload;
03738     OBJECT_ATTRIBUTES ObjA;
03739     UNICODE_STRING UnicodeString;
03740     ULONG CreateDisposition;
03741     <span class="keyword">struct </span>{
03742         KEY_VALUE_PARTIAL_INFORMATION KeyInfo;
03743         WCHAR KeyLayoutId[KL_NAMELENGTH];
03744     } KeyValueId;
03745 
03746     <span class="comment">/*</span>
03747 <span class="comment">     * Load initial keyboard name ( HKEY_CURRENT_USER\Keyboard Layout\Preload\1 )</span>
03748 <span class="comment">     */</span>
03749     rc = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a27">RtlOpenCurrentUser</a>( MAXIMUM_ALLOWED, &amp;UserKeyHandle );
03750     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( rc ))
03751     {
03752         RIPMSG1( RIP_WARNING, <span class="stringliteral">"GetActiveKeyboardName - Could NOT open HKEY_CURRENT_USER (%lx).\n"</span>, rc );
03753         wcscpy( lpszName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"00000409"</span> );
03754         <span class="keywordflow">return</span>;
03755     }
03756 
03757     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;UnicodeString, szKbdLayoutPreload );
03758     InitializeObjectAttributes( &amp;ObjA,
03759                                 &amp;UnicodeString,
03760                                 OBJ_CASE_INSENSITIVE,
03761                                 UserKeyHandle,
03762                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
03763     rc = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>( &amp;hKey,
03764                     KEY_ALL_ACCESS,
03765                     &amp;ObjA );
03766     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( rc ))
03767     {
03768         <span class="comment">/*</span>
03769 <span class="comment">         *  Query the value from the registry.</span>
03770 <span class="comment">         */</span>
03771         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;UnicodeString, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"1"</span> );
03772 
03773         rc = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>( hKey,
03774                               &amp;UnicodeString,
03775                               KeyValuePartialInformation,
03776                               &amp;KeyValueId,
03777                               <span class="keyword">sizeof</span>(KeyValueId),
03778                               &amp;cbSize );
03779 
03780         <span class="keywordflow">if</span> ( rc == STATUS_BUFFER_OVERFLOW ) {
03781             RIPMSG0(RIP_WARNING, <span class="stringliteral">"GetActiveKeyboardName - Buffer overflow."</span>);
03782             rc = STATUS_SUCCESS;
03783         }
03784         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( rc )) {
03785             <a class="code" href="../../d1/d5/w32_2ntuser_2rtl_2random_8c.html#a3">wcsncpycch</a>( lpszName, (LPWSTR)KeyValueId.KeyInfo.Data, KL_NAMELENGTH - 1 );
03786             lpszName[KL_NAMELENGTH - 1] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
03787         } <span class="keywordflow">else</span> {
03788             <span class="comment">/*</span>
03789 <span class="comment">             * Error reading value...use default</span>
03790 <span class="comment">             */</span>
03791             wcscpy( lpszName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"00000409"</span> );
03792         }
03793 
03794         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( hKey );
03795         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( UserKeyHandle );
03796         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a126">IS_IME_ENABLED</a>()) {
03797             <a class="code" href="../../d3/d8/client_8c.html#a31">CheckValidLayoutName</a>( lpszName );
03798         }
03799         <span class="keywordflow">return</span>;
03800     }
03801 
03802     <span class="comment">/*</span>
03803 <span class="comment">     * NOTE: The code below is only executed the first time a user logs</span>
03804 <span class="comment">     *       on after an upgrade from NT3.x to NT4.0.</span>
03805 <span class="comment">     */</span>
03806     <span class="comment">/*</span>
03807 <span class="comment">     * The Preload key does not exist in the registry.  Try reading the</span>
03808 <span class="comment">     * old registry entry "Keyboard Layout\Active".  If it exists, we</span>
03809 <span class="comment">     * convert it to the new style Preload key.</span>
03810 <span class="comment">     */</span>
03811     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;UnicodeString, szKbdLayout );
03812     InitializeObjectAttributes( &amp;ObjA,
03813                                 &amp;UnicodeString,
03814                                 OBJ_CASE_INSENSITIVE,
03815                                 UserKeyHandle,
03816                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
03817     rc = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>( &amp;hKey,
03818                     KEY_ALL_ACCESS,
03819                     &amp;ObjA );
03820 
03821     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( UserKeyHandle );
03822 
03823     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( rc ))
03824     {
03825         RIPMSG1( RIP_WARNING, <span class="stringliteral">"GetActiveKeyboardName - Could not determine active keyboard layout (%lx).\n"</span>, rc  );
03826         wcscpy( lpszName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"00000409"</span> );
03827         <span class="keywordflow">return</span>;
03828     }
03829 
03830     <span class="comment">/*</span>
03831 <span class="comment">     *  Query the value from the registry.</span>
03832 <span class="comment">     */</span>
03833     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;UnicodeString, szKbdActive );
03834 
03835     rc = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>( hKey,
03836                           &amp;UnicodeString,
03837                           KeyValuePartialInformation,
03838                           &amp;KeyValueId,
03839                           <span class="keyword">sizeof</span>(KeyValueId),
03840                           &amp;cbSize );
03841 
03842     <span class="keywordflow">if</span> ( rc == STATUS_BUFFER_OVERFLOW ) {
03843         RIPMSG0(RIP_WARNING, <span class="stringliteral">"GetActiveKeyboardName - Buffer overflow."</span>);
03844         rc = STATUS_SUCCESS;
03845     }
03846     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( rc )) {
03847         <a class="code" href="../../d1/d5/w32_2ntuser_2rtl_2random_8c.html#a3">wcsncpycch</a>( lpszName, (LPWSTR)KeyValueId.KeyInfo.Data, KL_NAMELENGTH - 1 );
03848         lpszName[KL_NAMELENGTH - 1] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
03849     } <span class="keywordflow">else</span> {
03850         <span class="comment">/*</span>
03851 <span class="comment">         * Error reading value...use default</span>
03852 <span class="comment">         */</span>
03853         RIPMSG1( RIP_WARNING, <span class="stringliteral">"GetActiveKeyboardName - Could not query active keyboard layout (%lx).\n"</span>, rc );
03854         wcscpy( lpszName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"00000409"</span> );
03855         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( hKey );
03856         <span class="keywordflow">return</span>;
03857     }
03858 
03859     <span class="comment">/*</span>
03860 <span class="comment">     * if 'Active' keyboard layout is for Japanese/Korean layout. just put</span>
03861 <span class="comment">     * IME prefix, because user prefer to have keyboard layout with IME as</span>
03862 <span class="comment">     * default.</span>
03863 <span class="comment">     */</span>
03864     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a126">IS_IME_ENABLED</a>()) {
03865         <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> wLanguageId = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)wcstoul(lpszName, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 16);
03866 
03867         <span class="comment">/*</span>
03868 <span class="comment">         * Default keyboard layout values.</span>
03869 <span class="comment">         *</span>
03870 <span class="comment">         * [LATER, if needed]</span>
03871 <span class="comment">         *</span>
03872 <span class="comment">         * The hard-codeed default value might be wanted</span>
03873 <span class="comment">         * come from registry or somewhere...</span>
03874 <span class="comment">         */</span>
03875         CONST LPWSTR lpszJapaneseDefaultLayout = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"E0010411"</span>;
03876         CONST LPWSTR lpszKoreanDefaultLayout   = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"E0010412"</span>;
03877 
03878         <span class="comment">/*</span>
03879 <span class="comment">         * Need to mask off hi-word to look up locale ID, because</span>
03880 <span class="comment">         * NEC PC-9800 Series version of Windows NT 3.5 contains</span>
03881 <span class="comment">         * bogus value in hi-word.</span>
03882 <span class="comment">         */</span>
03883         wLanguageId &amp;= 0x0000FFFF;
03884 
03885         <span class="keywordflow">if</span> (PRIMARYLANGID(wLanguageId) == LANG_JAPANESE) {
03886 
03887             <span class="comment">/*</span>
03888 <span class="comment">             * Set Japanese default layout Id.</span>
03889 <span class="comment">             */</span>
03890             wcscpy(lpszName,lpszJapaneseDefaultLayout);
03891 
03892         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PRIMARYLANGID(wLanguageId) == LANG_KOREAN) {
03893 
03894             <span class="comment">/*</span>
03895 <span class="comment">             * Set Korean default layout Id.</span>
03896 <span class="comment">             */</span>
03897             wcscpy(lpszName,lpszKoreanDefaultLayout);
03898         }
03899     }
03900 
03901     <span class="comment">/*</span>
03902 <span class="comment">     * We have the Active value.  Now create the Preload key.</span>
03903 <span class="comment">     */</span>
03904     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;UnicodeString, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Preload"</span> );
03905     InitializeObjectAttributes( &amp;ObjA,
03906                                 &amp;UnicodeString,
03907                                 OBJ_CASE_INSENSITIVE,
03908                                 hKey,
03909                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
03910     rc = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a>( &amp;hKeyPreload,
03911                       STANDARD_RIGHTS_WRITE |
03912                         KEY_QUERY_VALUE |
03913                         KEY_ENUMERATE_SUB_KEYS |
03914                         KEY_SET_VALUE |
03915                         KEY_CREATE_SUB_KEY,
03916                       &amp;ObjA,
03917                       0,
03918                       <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03919                       0,
03920                       &amp;CreateDisposition );
03921 
03922     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( rc ))
03923     {
03924         RIPMSG1( RIP_WARNING, <span class="stringliteral">"GetActiveKeyboardName - Could NOT create Preload key (%lx).\n"</span>, rc );
03925         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( hKey );
03926         <span class="keywordflow">return</span>;
03927     }
03928 
03929     <span class="comment">/*</span>
03930 <span class="comment">     * Set the new value entry.</span>
03931 <span class="comment">     */</span>
03932     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;UnicodeString, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"1"</span> );
03933     rc = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>( hKeyPreload,
03934                         &amp;UnicodeString,
03935                         0,
03936                         REG_SZ,
03937                         lpszName,
03938                         (wcslen(lpszName)+1) * <span class="keyword">sizeof</span>(WCHAR)
03939                       );
03940 
03941     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( rc ))
03942     {
03943         RIPMSG1( RIP_WARNING, <span class="stringliteral">"GetActiveKeyboardName - Could NOT create value entry 1 for Preload key (%lx).\n"</span>, rc );
03944         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( hKey );
03945         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( hKeyPreload );
03946         <span class="keywordflow">return</span>;
03947     }
03948 
03949     <span class="comment">/*</span>
03950 <span class="comment">     * Success: attempt to delete the Active value key.</span>
03951 <span class="comment">     */</span>
03952     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;UnicodeString, szKbdActive );
03953     rc = <a class="code" href="../../d7/d7/ntapi_8c.html#a16">NtDeleteValueKey</a>( hKey, &amp;UnicodeString );
03954 
03955     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( rc ))
03956     {
03957         RIPMSG1( RIP_WARNING, <span class="stringliteral">"GetActiveKeyboardName - Could NOT delete value key 'Active'.\n"</span>, rc );
03958     }
03959     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( hKey );
03960     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( hKeyPreload );
03961 }
03962 
03963 
03964 <span class="comment">/***************************************************************************\</span>
03965 <span class="comment">* LoadPreloadKeyboardLayouts</span>
03966 <span class="comment">*</span>
03967 <span class="comment">* Loads the keyboard layouts stored under the Preload key in the user's</span>
03968 <span class="comment">* registry. The first layout, the default, was already loaded.  Start with #2.</span>
03969 <span class="comment">*</span>
03970 <span class="comment">* 03-06-95 GregoryW     Created.</span>
03971 <span class="comment">\***************************************************************************/</span>
03972 
03973 <span class="comment">// size allows up to 999 preloaded!!!!!</span>
<a name="l03974"></a><a class="code" href="../../d3/d8/client_8c.html#a6">03974</a> <span class="preprocessor">#define NSIZEPRELOAD    (4)</span>
03975 <span class="preprocessor"></span>
<a name="l03976"></a><a class="code" href="../../d6/d0/usercli_8h.html#a605">03976</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d3/d8/client_8c.html#a147">LoadPreloadKeyboardLayouts</a>(<span class="keywordtype">void</span>)
03977 {
03978     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>  i;
03979     WCHAR szPreLoadee[<a class="code" href="../../d3/d8/client_8c.html#a6">NSIZEPRELOAD</a>];
03980     WCHAR lpszName[KL_NAMELENGTH];
03981 
03982     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d0/usercli_8h.html#a30">ISREMOTESESSION</a>()) {
03983         <span class="comment">/*</span>
03984 <span class="comment">         * Console doesn't have a client layout, so start from 2.</span>
03985 <span class="comment">         */</span>
03986         i = 2;
03987     } <span class="keywordflow">else</span> {
03988         <span class="comment">/*</span>
03989 <span class="comment">         * Client might have specified a keyboard layout, if this</span>
03990 <span class="comment">         * is so, then Preload\1 was not loaded, so start from 1.</span>
03991 <span class="comment">         */</span>
03992         i = 1;
03993     }
03994 
03995     <span class="keywordflow">for</span> (; i &lt; 1000; i++) {
03996         wsprintf(szPreLoadee, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"%d"</span>, i );
03997         <span class="keywordflow">if</span> ((GetPrivateProfileStringW(
03998                  <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Preload"</span>,
03999                  szPreLoadee,
04000                  <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">""</span>,                            <span class="comment">// default = NULL</span>
04001                  lpszName,                       <span class="comment">// output buffer</span>
04002                  KL_NAMELENGTH,
04003                  <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"keyboardlayout.ini"</span>) == -1 ) || (*lpszName == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>)) {
04004             <span class="keywordflow">break</span>;
04005         }
04006         <a class="code" href="../../d3/d8/client_8c.html#a151">LoadKeyboardLayoutW</a>(lpszName, KLF_REPLACELANG |KLF_SUBSTITUTE_OK |KLF_NOTELLSHELL);
04007     }
04008 }
04009 
04010 
04011 <span class="comment">/***************************************************************************\</span>
04012 <span class="comment">* OpenKeyboardLayoutFile</span>
04013 <span class="comment">*</span>
04014 <span class="comment">* Opens a layout file and computes the table offset.</span>
04015 <span class="comment">*</span>
04016 <span class="comment">* 01-11-95 JimA         Moved LoadLibrary code from server.</span>
04017 <span class="comment">\***************************************************************************/</span>
04018 
<a name="l04019"></a><a class="code" href="../../d6/d0/usercli_8h.html#a604">04019</a> HANDLE <a class="code" href="../../d6/d0/usercli_8h.html#a604">OpenKeyboardLayoutFile</a>(
04020     LPWSTR lpszKLName,
04021     <a class="code" href="../../d9/d5/ndismain_8h.html#a266">PUINT</a> puFlags,
04022     PUINT poffTable,
04023     PUINT pKbdInputLocale)
04024 {
04025     PKBDNLSTABLES (*pfnNls)();
04026     <a class="code" href="../../d0/d5/perfuser_8c.html#a20">BOOL</a> (*pfnDriverNT4)(LPWSTR);
04027     <a class="code" href="../../d0/d5/perfuser_8c.html#a20">BOOL</a> (*pfnDriver)(HKL, LPWSTR, PCLIENTKEYBOARDTYPE, <a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>);
04028     WCHAR awchRealLayoutFile[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
04029     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bMightBeKbdNlsDriver = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04030     WCHAR awchKL[KL_NAMELENGTH];
04031     WCHAR awchKLRegKey[<a class="code" href="../../d3/d8/client_8c.html#a0">NSZKLKEY</a>];
04032     LPWSTR lpszKLRegKey = &amp;awchKLRegKey[0];
04033     PKBDTABLES (*pfn)();
04034     LPWSTR pwszLib;
04035     LPWSTR pwszId;
04036     HANDLE hLibModule;
04037     WCHAR awchModName[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
04038     UNICODE_STRING UnicodeString;
04039     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> wLayoutId;
04040     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> wLanguageId;
04041     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04042     OBJECT_ATTRIBUTES OA;
04043     HANDLE hKey;
04044     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> cbSize;
04045     <span class="keyword">struct </span>{
04046         KEY_VALUE_PARTIAL_INFORMATION KeyInfo;
04047         WCHAR awchLibName[<a class="code" href="../../d3/d8/client_8c.html#a1">CCH_KL_LIBNAME</a>];
04048     } KeyFile;
04049     <span class="keyword">struct </span>{
04050         KEY_VALUE_PARTIAL_INFORMATION KeyInfo;
04051         WCHAR awchId[<a class="code" href="../../d3/d8/client_8c.html#a2">CCH_KL_ID</a>];
04052     } KeyId;
04053     <span class="keyword">struct </span>{
04054         KEY_VALUE_PARTIAL_INFORMATION KeyInfo;
04055         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> Attributes;
04056     } <a class="code" href="../../d2/d2/rtload_8c.html#a6">KeyAttributes</a>;
04057 
04058     wLanguageId = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)wcstoul(lpszKLName, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 16);
04059     <span class="comment">/*</span>
04060 <span class="comment">     * Substitute Layout if required.</span>
04061 <span class="comment">     */</span>
04062     <span class="keywordflow">if</span> (*puFlags &amp; KLF_SUBSTITUTE_OK) {
04063         GetPrivateProfileStringW(
04064                 <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Substitutes"</span>,
04065                 lpszKLName,
04066                 lpszKLName,        <span class="comment">// default == no change (no substitute found)</span>
04067                 awchKL,
04068                 <span class="keyword">sizeof</span>(awchKL)/<span class="keyword">sizeof</span>(WCHAR),
04069                 <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"keyboardlayout.ini"</span>);
04070 
04071         <span class="comment">/*</span>
04072 <span class="comment">         * #273562 : Flush the registry cache, because the cpanel applet</span>
04073 <span class="comment">         * destroys and recreates the Substitutes section a lot, which</span>
04074 <span class="comment">         * would otherwise leave us with STATUS_KEY_DELETED.</span>
04075 <span class="comment">         */</span>
04076         WritePrivateProfileStringW(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04077 
04078         awchKL[KL_NAMELENGTH - 1] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
04079         wcscpy(lpszKLName, awchKL);
04080     }
04081 
04082     wLayoutId = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)wcstoul(lpszKLName, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 16);
04083 
04084     <span class="comment">/*</span>
04085 <span class="comment">     * Get DLL name from the registry, load it, and get the entry point.</span>
04086 <span class="comment">     */</span>
04087     pwszLib = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04088     wcscpy(lpszKLRegKey, <a class="code" href="../../d3/d8/client_8c.html#a8">szKLKey</a>);
04089     wcscat(lpszKLRegKey, lpszKLName);
04090     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, lpszKLRegKey);
04091     InitializeObjectAttributes(&amp;OA, &amp;UnicodeString, OBJ_CASE_INSENSITIVE, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04092 
04093     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(&amp;hKey, KEY_READ, &amp;OA))) {
04094         <span class="comment">/*</span>
04095 <span class="comment">         * Read the "Layout File" value.</span>
04096 <span class="comment">         */</span>
04097         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, <a class="code" href="../../d3/d8/client_8c.html#a9">szKLFile</a>);
04098 
04099         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(hKey,
04100                 &amp;UnicodeString,
04101                 KeyValuePartialInformation,
04102                 &amp;KeyFile,
04103                 <span class="keyword">sizeof</span>(KeyFile),
04104                 &amp;cbSize);
04105 
04106         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_OVERFLOW) {
04107             RIPMSG0(RIP_WARNING, <span class="stringliteral">"OpenKeyboardLayoutFile (Layout File) - Buffer overflow."</span>);
04108             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
04109         }
04110         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
04111             pwszLib = (LPWSTR)KeyFile.KeyInfo.Data;
04112             pwszLib[<a class="code" href="../../d3/d8/client_8c.html#a1">CCH_KL_LIBNAME</a> - 1] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
04113 
04114         }
04115 
04116         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, <a class="code" href="../../d3/d8/client_8c.html#a10">szKLAttributes</a>);
04117         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(hKey,
04118                 &amp;UnicodeString,
04119                 KeyValuePartialInformation,
04120                 &amp;<a class="code" href="../../d2/d2/rtload_8c.html#a6">KeyAttributes</a>,
04121                 <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d2/rtload_8c.html#a6">KeyAttributes</a>),
04122                 &amp;cbSize);
04123 
04124         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
04125 <span class="preprocessor">#if DBG</span>
04126 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ((*((PDWORD)<a class="code" href="../../d2/d2/rtload_8c.html#a6">KeyAttributes</a>.KeyInfo.Data) &amp; ~KLF_ATTRMASK) != 0) {
04127                 RIPMSG1(RIP_WARNING,
04128                         <span class="stringliteral">"OpenKeyboardLayoutFile - Unexpected attributes %lx"</span>,
04129                         *((PDWORD)<a class="code" href="../../d2/d2/rtload_8c.html#a6">KeyAttributes</a>.KeyInfo.Data));
04130             }
04131 <span class="preprocessor">#endif</span>
04132 <span class="preprocessor"></span>            *puFlags |= (*(PDWORD)<a class="code" href="../../d2/d2/rtload_8c.html#a6">KeyAttributes</a>.KeyInfo.Data &amp; KLF_ATTRMASK);
04133         }
04134 
04135         <span class="comment">/*</span>
04136 <span class="comment">         * If the high word of wLayoutId is 0xE??? then this is an IME based</span>
04137 <span class="comment">         * keyboard layout.</span>
04138 <span class="comment">         */</span>
04139         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d5/conimep_8h.html#a49">IS_IME_KBDLAYOUT</a>(wLayoutId)) {
04140             wLayoutId = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)HIWORD(wLayoutId);
04141         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (HIWORD(wLayoutId)) {
04142             <span class="comment">/*</span>
04143 <span class="comment">             * If the high word of wLayoutId is non-null then read the "Layout ID" value.</span>
04144 <span class="comment">             * Layout IDs start at 1, increase sequentially and are unique.</span>
04145 <span class="comment">             */</span>
04146             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, <a class="code" href="../../d3/d8/client_8c.html#a11">szKLId</a>);
04147 
04148             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(hKey,
04149                     &amp;UnicodeString,
04150                     KeyValuePartialInformation,
04151                     &amp;KeyId,
04152                     <span class="keyword">sizeof</span>(KeyId),
04153                     &amp;cbSize);
04154 
04155             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_OVERFLOW) {
04156                 RIPMSG0(RIP_WARNING, <span class="stringliteral">"OpenKeyboardLayoutFile - Buffer overflow."</span>);
04157                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
04158             }
04159             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
04160                 pwszId = (LPWSTR)KeyId.KeyInfo.Data;
04161                 pwszId[<a class="code" href="../../d3/d8/client_8c.html#a2">CCH_KL_ID</a> - 1] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
04162                 wLayoutId = (wcstol(pwszId, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 16) &amp; 0x0fff) | 0xf000;
04163             } <span class="keywordflow">else</span> {
04164                 wLayoutId = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)0xfffe ;    <span class="comment">// error in layout ID, load separately</span>
04165             }
04166         }
04167         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hKey);
04168     } <span class="keywordflow">else</span> {
04169         <span class="comment">/*</span>
04170 <span class="comment">         * This is a temporary case to allow booting the new multilingual user on top of a</span>
04171 <span class="comment">         * Daytona registry.</span>
04172 <span class="comment">         */</span>
04173         <span class="comment">/*</span>
04174 <span class="comment">         * Get DLL name from the registry, load it, and get the entry point.</span>
04175 <span class="comment">         */</span>
04176         pwszLib = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04177         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString,
04178                 <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Control\\Keyboard Layout"</span>);
04179         InitializeObjectAttributes(&amp;OA, &amp;UnicodeString, OBJ_CASE_INSENSITIVE, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04180 
04181         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(&amp;hKey, KEY_READ, &amp;OA))) {
04182             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, lpszKLName);
04183 
04184             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(hKey,
04185                     &amp;UnicodeString,
04186                     KeyValuePartialInformation,
04187                     &amp;KeyFile,
04188                     <span class="keyword">sizeof</span>(KeyFile),
04189                     &amp;cbSize);
04190 
04191             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_OVERFLOW) {
04192                 RIPMSG0(RIP_WARNING, <span class="stringliteral">"OpenKeyboardLayoutFile - Buffer overflow."</span>);
04193                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
04194             }
04195             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
04196                 pwszLib = (LPWSTR)KeyFile.KeyInfo.Data;
04197                 pwszLib[<a class="code" href="../../d3/d8/client_8c.html#a1">CCH_KL_LIBNAME</a> - 1] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
04198             }
04199 
04200             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hKey);
04201         }
04202     }
04203 
04204     *pKbdInputLocale = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)MAKELONG(LOWORD(wLanguageId),LOWORD(wLayoutId));
04205 
04206     <span class="keywordflow">if</span> (pwszLib == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04207         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a30">ISREMOTESESSION</a>() &amp;&amp; <a class="code" href="../../d4/d5/conimep_8h.html#a49">IS_IME_KBDLAYOUT</a>(wLayoutId)) {
04208             <span class="comment">/*</span>
04209 <span class="comment">             * -- port from HYDRA --</span>
04210 <span class="comment">             * Could not find the keyboard KL for FE, so give them some reasonable one.</span>
04211 <span class="comment">             * If the high word of wLayoutId is 0xE??? then this is an IME based</span>
04212 <span class="comment">             * keyboard layout.</span>
04213 <span class="comment">             * And, the safe KL name is KBDJPN.DLL for Japanese.</span>
04214 <span class="comment">             *                       or KBDKOR.DLL for Korean</span>
04215 <span class="comment">             *                       or KBDUS.DLL  for other Far East</span>
04216 <span class="comment">             */</span>
04217             <span class="keywordflow">if</span> (PRIMARYLANGID(wLanguageId) == LANG_JAPANESE) {
04218                 pwszLib = <a class="code" href="../../d3/d8/client_8c.html#a14">pwszKLLibSafetyJPN</a>;
04219                 *pKbdInputLocale = <a class="code" href="../../d3/d8/client_8c.html#a15">wKbdLocaleSafetyJPN</a>;
04220             }
04221             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PRIMARYLANGID(wLanguageId) == LANG_KOREAN) {
04222                 pwszLib = <a class="code" href="../../d3/d8/client_8c.html#a16">pwszKLLibSafetyKOR</a>;
04223                 *pKbdInputLocale = <a class="code" href="../../d3/d8/client_8c.html#a17">wKbdLocaleSafetyKOR</a>;
04224             }
04225             <span class="keywordflow">else</span> {
04226                 pwszLib = <a class="code" href="../../d3/d8/client_8c.html#a12">pwszKLLibSafety</a>;
04227                 *pKbdInputLocale = MAKELONG(LOWORD(wLanguageId), LOWORD(wLanguageId));
04228             }
04229         }
04230         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*puFlags &amp; KLF_INITTIME) {
04231             pwszLib = <a class="code" href="../../d3/d8/client_8c.html#a12">pwszKLLibSafety</a>;
04232             *pKbdInputLocale = <a class="code" href="../../d3/d8/client_8c.html#a13">wKbdLocaleSafety</a>;
04233         } <span class="keywordflow">else</span> {
04234             RIPMSG1(RIP_WARNING, <span class="stringliteral">"no DLL name for %ws"</span>, lpszKLName);
04235             <span class="comment">/*</span>
04236 <span class="comment">             * We're going to use the fallback layout...</span>
04237 <span class="comment">             * This could happen when IMM32 is trying to unload the IME,</span>
04238 <span class="comment">             * by making any non IME keyboard layout tentatively active.</span>
04239 <span class="comment">             */</span>
04240             pwszLib = <a class="code" href="../../d3/d8/client_8c.html#a12">pwszKLLibSafety</a>;
04241             *pKbdInputLocale = <a class="code" href="../../d3/d8/client_8c.html#a13">wKbdLocaleSafety</a>;
04242 <span class="comment">//            return NULL;</span>
04243         }
04244     }
04245 
04246 RetryLoad:
04247     hLibModule = LoadLibraryW(pwszLib);
04248 
04249     <span class="keywordflow">if</span> (hLibModule == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04250         RIPMSG1(RIP_WARNING, <span class="stringliteral">"Keyboard Layout: cannot load %ws\n"</span>, pwszLib);
04251         <span class="comment">/*</span>
04252 <span class="comment">         * It is OK to fail to load DLL here:</span>
04253 <span class="comment">         * if this ever happens, the fallback keyboard layout built in</span>
04254 <span class="comment">         * win32k.sys shall be used.</span>
04255 <span class="comment">         */</span>
04256         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04257     }
04258 
04259     <span class="comment">/*</span>
04260 <span class="comment">     * if the layout driver is not "REAL" layout driver, the driver has</span>
04261 <span class="comment">     * "3" or "5" entry point, then we call this to get real layout driver..</span>
04262 <span class="comment">     * This is neccesary for Japanese and Korean systems. because their</span>
04263 <span class="comment">     * keyboard layout driver is "KBDJPN.DLL" or "KBDKOR.DLL", but its</span>
04264 <span class="comment">     * "REAL" driver becomes different depending their keyboard hardware.</span>
04265 <span class="comment">     */</span>
04266 
04267     <span class="comment">/*</span>
04268 <span class="comment">     * Get the entrypoints.</span>
04269 <span class="comment">     */</span>
04270     pfnDriver = (<a class="code" href="../../d0/d5/perfuser_8c.html#a20">BOOL</a>(*)(HKL, LPWSTR, PCLIENTKEYBOARDTYPE, <a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>))GetProcAddress(hLibModule, (LPCSTR)5);
04271     pfnDriverNT4 = (<a class="code" href="../../d0/d5/perfuser_8c.html#a20">BOOL</a>(*)(LPWSTR))GetProcAddress(hLibModule, (LPCSTR)3);
04272 
04273     <span class="keywordflow">if</span> (pfnDriver || pfnDriverNT4) {
04274         HKL hkl;
04275         CLIENTKEYBOARDTYPE clientKbdType;
04276         PCLIENTKEYBOARDTYPE pClientKbdType = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04277 
04278         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, lpszKLName);
04279         <a class="code" href="../../d9/d3/cnvint_8c.html#a4">RtlUnicodeStringToInteger</a>(&amp;UnicodeString, 0x10, (PULONG)&amp;hkl);
04280         <span class="comment">/*</span>
04281 <span class="comment">         * When we reach here, the layout DLL may have KBDNLSTABLE</span>
04282 <span class="comment">         * even if we fail from now on. Our temporary layout</span>
04283 <span class="comment">         * dll should have the fallback tables for just in case.</span>
04284 <span class="comment">         */</span>
04285         bMightBeKbdNlsDriver = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04286 
04287         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a30">ISREMOTESESSION</a>() &amp;&amp; <a class="code" href="../../d3/d8/client_8c.html#a103">GetClientKeyboardType</a>(&amp;clientKbdType)) {
04288             pClientKbdType = &amp;clientKbdType;
04289         }
04290 
04291         <span class="comment">/*</span>
04292 <span class="comment">         * Call the entry.</span>
04293 <span class="comment">         * a. NT5 / Hydra (oridinal=5)</span>
04294 <span class="comment">         * b. NT4 compatible (3)</span>
04295 <span class="comment">         */</span>
04296         <span class="keywordflow">if</span> ((pfnDriver &amp;&amp; pfnDriver(hkl, awchRealLayoutFile, pClientKbdType, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) ||
04297                 (pfnDriverNT4 &amp;&amp; pfnDriverNT4(awchRealLayoutFile))) {
04298 
04299             HANDLE hLibModuleNew;
04300             <span class="comment">/*</span>
04301 <span class="comment">             * Try to load "REAL" keyboard layout file.</span>
04302 <span class="comment">             */</span>
04303             RIPMSG1(RIP_VERBOSE, <span class="stringliteral">"awchRealLayoutFile='%S'\n"</span>, awchRealLayoutFile);
04304             <span class="keywordflow">if</span> (hLibModuleNew = LoadLibraryW(awchRealLayoutFile)) {
04305                 <span class="comment">/*</span>
04306 <span class="comment">                 * Set "REAL" layout file name.</span>
04307 <span class="comment">                 */</span>
04308                 pwszLib = awchRealLayoutFile;
04309                 <span class="comment">/*</span>
04310 <span class="comment">                 * Unload temporary layout driver.</span>
04311 <span class="comment">                 */</span>
04312                 FreeLibrary(hLibModule);
04313                 <span class="comment">/*</span>
04314 <span class="comment">                 * Updates it.</span>
04315 <span class="comment">                 */</span>
04316                 hLibModule = hLibModuleNew;
04317             }
04318         }
04319     }
04320 
04321     <span class="comment">/*</span>
04322 <span class="comment">     * HACK Part 1!  Get the pointer to the layout table and</span>
04323 <span class="comment">     * change it to a virtual offset.  The server will then</span>
04324 <span class="comment">     * use this offset when poking through the file header to</span>
04325 <span class="comment">     * locate the table within the file.</span>
04326 <span class="comment">     */</span>
04327     pfn = (PKBDTABLES(*)())GetProcAddress(hLibModule, (LPCSTR)1);
04328     <span class="keywordflow">if</span> (pfn == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04329         RIPMSG0(RIP_ERROR, <span class="stringliteral">"Keyboard Layout: cannot get proc addr"</span>);
04330         <span class="keywordflow">if</span> ((*puFlags &amp; KLF_INITTIME) &amp;&amp; (pwszLib != <a class="code" href="../../d3/d8/client_8c.html#a12">pwszKLLibSafety</a>)) {
04331             pwszLib = <a class="code" href="../../d3/d8/client_8c.html#a12">pwszKLLibSafety</a>;
04332             <span class="keywordflow">goto</span> RetryLoad;
04333         }
04334         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04335     }
04336     *poffTable = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pfn() - (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)hLibModule);
04337 
04338     <span class="keywordflow">if</span> (bMightBeKbdNlsDriver) {
04339         pfnNls = (PKBDNLSTABLES(*)())GetProcAddress(hLibModule, (LPCSTR)2);
04340         <span class="keywordflow">if</span> (pfnNls != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04341             <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> offNlsTable;
04342 
04343             offNlsTable = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pfnNls() - (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)hLibModule);
04344 
04345 <span class="preprocessor">#if DBG_FE</span>
04346 <span class="preprocessor"></span>            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"USER32:Offset to KBDTABLES    = %d (%x)\n"</span>,*poffTable,*poffTable);
04347             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"USER32:Offset to KBDNLSTABLES = %d (%x)\n"</span>,offNlsTable,offNlsTable);
04348 <span class="preprocessor">#endif // DBG_FE</span>
04349 <span class="preprocessor"></span>
04350             <span class="comment">/*</span>
04351 <span class="comment">             * Combine these offsets...</span>
04352 <span class="comment">             *</span>
04353 <span class="comment">             *  LOWORD(*poffTable) = Offset to KBDTABLES.</span>
04354 <span class="comment">             *  HIWORD(*poffTable) = Offset to KBDNLSTABLES.</span>
04355 <span class="comment">             */</span>
04356             *poffTable |= (offNlsTable &lt;&lt; 16);
04357         }
04358     }
04359 
04360     <span class="comment">/*</span>
04361 <span class="comment">     * Open the dll for read access.</span>
04362 <span class="comment">     */</span>
04363     GetModuleFileName(hLibModule, awchModName, <span class="keyword">sizeof</span>(awchModName));
04364     FreeLibrary(hLibModule);
04365     <span class="keywordflow">return</span> CreateFileW(
04366             awchModName,
04367             GENERIC_READ,
04368             FILE_SHARE_READ,
04369             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04370             <a class="code" href="../../d4/d8/ntfsexp_8h.html#a141a69">OPEN_EXISTING</a>,
04371             0,
04372             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04373 }
04374 
04375 
04376 <span class="comment">/***************************************************************************\</span>
04377 <span class="comment">* LoadKeyboardLayoutEx</span>
04378 <span class="comment">*</span>
04379 <span class="comment">* Loads a keyboard translation table from a dll, replacing the layout associated</span>
04380 <span class="comment">* with hkl.  This routine is needed to provide Win95 compatibility.</span>
04381 <span class="comment">*</span>
04382 <span class="comment">* 10-27-95 GregoryW    Created.</span>
04383 <span class="comment">\***************************************************************************/</span>
04384 
<a name="l04385"></a><a class="code" href="../../d6/d0/usercli_8h.html#a608">04385</a> HKL <a class="code" href="../../d6/d0/usercli_8h.html#a608">LoadKeyboardLayoutWorker</a>(
04386     HKL hkl,
04387     LPCWSTR lpszKLName,
04388     UINT uFlags,
04389     BOOL fFailSafe)
04390 {
04391     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> offTable;
04392     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> KbdInputLocale;
04393     HANDLE hFile;
04394     HKL hKbdLayout;
04395     WCHAR awchKL[KL_NAMELENGTH];
04396 
04397     TAGMSG1(DBGTAG_IMM, <span class="stringliteral">"LoadKeyboardLayoutWorker called with KLNAME=%S"</span>, lpszKLName);
04398 
04399     <span class="comment">/*</span>
04400 <span class="comment">     * If there is a substitute keyboard layout OpenKeyboardLayoutFile returns</span>
04401 <span class="comment">     * the substitute keyboard layout name to load.</span>
04402 <span class="comment">     */</span>
04403     wcsncpy(awchKL, lpszKLName, KL_NAMELENGTH - 1);
04404     awchKL[KL_NAMELENGTH - 1] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
04405 
04406     <span class="comment">/*</span>
04407 <span class="comment">     * Open the layout file</span>
04408 <span class="comment">     */</span>
04409     hFile = <a class="code" href="../../d6/d0/usercli_8h.html#a604">OpenKeyboardLayoutFile</a>(awchKL, &amp;uFlags, &amp;offTable, &amp;KbdInputLocale);
04410     <span class="keywordflow">if</span> (hFile == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04411         <span class="keywordflow">if</span> (!fFailSafe &amp;&amp; (uFlags &amp; KLF_FAILSAFE) == 0) {
04412             <span class="comment">// If not fail safe mode, just bail to fail.</span>
04413             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04414         }
04415         uFlags &amp;= ~KLF_SUBSTITUTE_OK;
04416         <span class="keywordflow">if</span> (wcscmp(awchKL, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"00000409"</span>)) {
04417             wcscpy(awchKL, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"00000409"</span>);
04418             hFile = <a class="code" href="../../d6/d0/usercli_8h.html#a604">OpenKeyboardLayoutFile</a>(awchKL, &amp;uFlags, &amp;offTable, &amp;KbdInputLocale);
04419         }
04420         <span class="keywordflow">if</span> (hFile == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04421             <span class="comment">// It's OK to pass NULL hFile. This lets the win32k prepare and</span>
04422             <span class="comment">// allocate the fallback keyboard layout.</span>
04423             <span class="comment">// kbdnul, which is a fallback keyboard layout stored in in win32k, will be used:</span>
04424         }
04425     }
04426 
04427     <span class="comment">/*</span>
04428 <span class="comment">     * Call the server to read the keyboard tables.  Note that</span>
04429 <span class="comment">     * the server will close the file handle when it is done.</span>
04430 <span class="comment">     */</span>
04431     hKbdLayout = <a class="code" href="../../d6/d0/usercli_8h.html#a625">_LoadKeyboardLayoutEx</a>(hFile, offTable, hkl, awchKL, KbdInputLocale, uFlags);
04432     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hFile);
04433 
04434     <a class="code" href="../../d6/d0/usercli_8h.html#a788">CliImmInitializeHotKeys</a>(<a class="code" href="../../d8/d0/immstruc_8h.html#a29">ISHK_ADD</a>, (HKL)IntToPtr( KbdInputLocale ));
04435 
04436     <span class="keywordflow">return</span> hKbdLayout;
04437 }
04438 
<a name="l04439"></a><a class="code" href="../../d3/d8/client_8c.html#a150">04439</a> HKL <a class="code" href="../../d3/d8/client_8c.html#a150">LoadKeyboardLayoutEx</a>(
04440     HKL hkl,
04441     LPCWSTR lpszKLName,
04442     UINT uFlags)
04443 {
04444     RIPMSG0(RIP_WARNING, <span class="stringliteral">"LoadKeyboardLayoutEx is called."</span>);
04445     <span class="comment">/*</span>
04446 <span class="comment">     * NULL hkl is not allowed.</span>
04447 <span class="comment">     */</span>
04448     <span class="keywordflow">if</span> (hkl == (HKL)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04449         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04450     }
04451 
04452     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a608">LoadKeyboardLayoutWorker</a>(hkl, lpszKLName, uFlags, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04453 }
04454 
04455 <span class="comment">/***************************************************************************\</span>
04456 <span class="comment">* LoadKeyboardLayout</span>
04457 <span class="comment">*</span>
04458 <span class="comment">* Loads a keyboard translation table from a dll.</span>
04459 <span class="comment">*</span>
04460 <span class="comment">* 01-09-95 JimA         Moved LoadLibrary code from server.</span>
04461 <span class="comment">\***************************************************************************/</span>
04462 
<a name="l04463"></a><a class="code" href="../../d3/d8/client_8c.html#a151">04463</a> HKL <a class="code" href="../../d3/d8/client_8c.html#a151">LoadKeyboardLayoutW</a>(
04464     LPCWSTR lpszKLName,
04465     UINT uFlags)
04466 {
04467     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a608">LoadKeyboardLayoutWorker</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, lpszKLName, uFlags, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04468 }
04469 
<a name="l04470"></a><a class="code" href="../../d3/d8/client_8c.html#a152">04470</a> HKL <a class="code" href="../../d3/d8/client_8c.html#a152">LoadKeyboardLayoutA</a>(
04471     LPCSTR lpszKLName,
04472     UINT uFlags)
04473 {
04474     WCHAR awchKLName[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
04475     LPWSTR lpBuffer = awchKLName;
04476 
04477     <span class="keywordflow">if</span> (!MBToWCS(lpszKLName, -1, &amp;lpBuffer, <span class="keyword">sizeof</span>(awchKLName), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>))
04478         <span class="keywordflow">return</span> (HKL)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04479 
04480     <span class="keywordflow">return</span> <a class="code" href="../../d3/d8/client_8c.html#a151">LoadKeyboardLayoutW</a>(awchKLName, uFlags);
04481 }
04482 
<a name="l04483"></a><a class="code" href="../../d3/d8/client_8c.html#a153">04483</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d8/client_8c.html#a153">UnloadKeyboardLayout</a>(IN HKL hkl)
04484 {
04485     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fRet = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a296">NtUserUnloadKeyboardLayout</a>(hkl);
04486 
04487     <span class="keywordflow">if</span> (fRet) {
04488         <a class="code" href="../../d6/d0/usercli_8h.html#a788">CliImmInitializeHotKeys</a>(<a class="code" href="../../d8/d0/immstruc_8h.html#a28">ISHK_REMOVE</a>, hkl);
04489         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04490     }
04491 
04492     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04493 }
04494 
04495 
04496 <span class="comment">/**************************************************************************\</span>
04497 <span class="comment">* GetKeyboardLayout()</span>
04498 <span class="comment">*</span>
04499 <span class="comment">* 01-17-95 GregoryW     Created</span>
04500 <span class="comment">\**************************************************************************/</span>
04501 
<a name="l04502"></a><a class="code" href="../../d3/d8/client_8c.html#a154">04502</a> HKL <a class="code" href="../../d3/d8/client_8c.html#a154">GetKeyboardLayout</a>(
04503     DWORD idThread)
04504 {
04505     <span class="keywordflow">return</span> (HKL)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a174">NtUserCallOneParam</a>(idThread, SFI__GETKEYBOARDLAYOUT);
04506 }
04507 
04508 
<a name="l04509"></a><a class="code" href="../../d3/d8/client_8c.html#a155">04509</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d3/d8/client_8c.html#a155">SetDebugErrorLevel</a>(DWORD dwLevel)
04510 {
04511     UNREFERENCED_PARAMETER(dwLevel);
04512 <span class="comment">//    NtUserCallNoParam(SFI__SETDEBUGERRORLEVEL);</span>
04513     <span class="keywordflow">return</span>;
04514 }
04515 
<a name="l04516"></a><a class="code" href="../../d3/d8/client_8c.html#a31">04516</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d3/d8/client_8c.html#a31">CheckValidLayoutName</a>( LPWSTR lpszKLName )
04517 {
04518     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> wLayoutId;
04519     WCHAR awchKLRegKey[<a class="code" href="../../d3/d8/client_8c.html#a0">NSZKLKEY</a>];
04520     LPWSTR lpszKLRegKey = &amp;awchKLRegKey[0];
04521     OBJECT_ATTRIBUTES OA;
04522     HANDLE hKey;
04523     UNICODE_STRING UnicodeString;
04524 
04525     UserAssert(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a126">IS_IME_ENABLED</a>());
04526 
04527     wLayoutId = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)wcstoul(lpszKLName, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 16);
04528 
04529     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d5/conimep_8h.html#a49">IS_IME_KBDLAYOUT</a>(wLayoutId)) {
04530     <span class="comment">//</span>
04531     <span class="comment">// if it's an IME layout, we need to check if</span>
04532     <span class="comment">// the layout name does exist in the HKEY_LOCAL_MACHINE.</span>
04533     <span class="comment">// if we've upgraded from NT 3.51 the corresponding</span>
04534     <span class="comment">// entry might be lost, because those process-type IMEs that</span>
04535     <span class="comment">// are supported on NT 3.51 are not supported NT 4.0 any more.</span>
04536     <span class="comment">//</span>
04537         wcscpy(lpszKLRegKey, <a class="code" href="../../d3/d8/client_8c.html#a8">szKLKey</a>);
04538         wcscat(lpszKLRegKey, lpszKLName);
04539         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, lpszKLRegKey);
04540         InitializeObjectAttributes(&amp;OA, &amp;UnicodeString, OBJ_CASE_INSENSITIVE, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04541 
04542         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(&amp;hKey, KEY_READ, &amp;OA))) {
04543             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( hKey );
04544         } <span class="keywordflow">else</span> {
04545             <span class="comment">// quick'n dirty way to make the fallback name...</span>
04546             lpszKLName[0] = lpszKLName[1] = lpszKLName[2] = lpszKLName[3] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'0'</span>;
04547 <span class="preprocessor">#ifdef LATER</span>
04548 <span class="preprocessor"></span>            <span class="comment">// display a message box to warn user</span>
04549 <span class="preprocessor">#endif</span>
04550 <span class="preprocessor"></span>        }
04551     }
04552 }
04553 
04554 <span class="preprocessor">#ifdef USE_MIRRORING</span>
04555 <span class="preprocessor"></span><span class="comment">/**************************************************************************\</span>
04556 <span class="comment">* GetProcessDefaultLayout</span>
04557 <span class="comment">*</span>
04558 <span class="comment">* 22-Jan-1998 SamerA    Created</span>
04559 <span class="comment">\**************************************************************************/</span>
04560 
04561 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI GetProcessDefaultLayout(DWORD *pdwDefaultLayout)
04562 {
04563     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a174">NtUserCallOneParam</a>((ULONG_PTR)pdwDefaultLayout,
04564                                     SFI__GETPROCESSDEFAULTLAYOUT);
04565 }
04566 
04567 <span class="comment">/**************************************************************************\</span>
04568 <span class="comment">* SetProcessDefaultLayout</span>
04569 <span class="comment">*</span>
04570 <span class="comment">* 22-Jan-1998 SamerA    Created</span>
04571 <span class="comment">\**************************************************************************/</span>
04572 
04573 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI SetProcessDefaultLayout(
04574     DWORD dwDefaultLayout)
04575 {
04576     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a174">NtUserCallOneParam</a>(dwDefaultLayout, SFI__SETPROCESSDEFAULTLAYOUT);
04577 }
04578 <span class="preprocessor">#endif</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:24 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
