<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: job.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>job.c</h1><a href="../../d3/d8/job_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: job.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* This module contains the code to implement the job object in NTUSER.</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 29-Jul-1997 CLupu   Created.</span>
00010 <span class="comment">\***************************************************************************/</span>
00011 
00012 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00013 
00014 <a class="code" href="../../d1/d9/structtagW32JOB.html">PW32JOB</a> <a class="code" href="../../d3/d8/job_8c.html#a0">CreateW32Job</a>(<a class="code" href="../../d0/d3/struct__EJOB.html">PEJOB</a> Job);
00015 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d3/d8/job_8c.html#a1">UpdateJob</a>(<a class="code" href="../../d1/d9/structtagW32JOB.html">PW32JOB</a> pW32Job);
00016 <span class="keywordtype">void</span> <a class="code" href="../../d3/d8/job_8c.html#a2">SetProcessFlags</a>(<a class="code" href="../../d1/d9/structtagW32JOB.html">PW32JOB</a> pW32Job, <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppi);
00017 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d8/job_8c.html#a3">JobCalloutAddProcess</a>(<a class="code" href="../../d1/d9/structtagW32JOB.html">PW32JOB</a>, <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a>);
00018 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d8/job_8c.html#a4">JobCalloutTerminate</a>(<a class="code" href="../../d1/d9/structtagW32JOB.html">PW32JOB</a>);
00019 
00020 <span class="comment">/***************************************************************************\</span>
00021 <span class="comment">* UserJobCallout</span>
00022 <span class="comment">*</span>
00023 <span class="comment">* History:</span>
00024 <span class="comment">* 29-Jul-1997 CLupu   Created.</span>
00025 <span class="comment">\***************************************************************************/</span>
<a name="l00026"></a><a class="code" href="../../d4/d1/userk_8h.html#a1144">00026</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d4/d1/userk_8h.html#a1144">UserJobCallout</a>(
00027     <a class="code" href="../../d4/d8/struct__WIN32__JOBCALLOUT__PARAMETERS.html">PKWIN32_JOBCALLOUT_PARAMETERS</a> Parm)
00028 {
00029     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00030     <a class="code" href="../../d1/d9/structtagW32JOB.html">PW32JOB</a>  pW32Job = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00031     <a class="code" href="../../d0/d3/struct__EJOB.html">PEJOB</a>    Job;
00032     <a class="code" href="../../d1/d9/ps_8h.html#a75">PSW32JOBCALLOUTTYPE</a> CalloutType;
00033     PVOID    Data;
00034 
00035 
00036     Job = Parm-&gt;<a class="code" href="../../d4/d8/struct__WIN32__JOBCALLOUT__PARAMETERS.html#o0">Job</a>;
00037     CalloutType = Parm-&gt;<a class="code" href="../../d4/d8/struct__WIN32__JOBCALLOUT__PARAMETERS.html#o1">CalloutType</a>;
00038     Data = Parm-&gt;<a class="code" href="../../d4/d8/struct__WIN32__JOBCALLOUT__PARAMETERS.html#o2">Data</a>;
00039 
00040     <span class="comment">/*</span>
00041 <span class="comment">     * The EJOB lock must be acquired at this time.</span>
00042 <span class="comment">     */</span>
00043     UserAssert(<a class="code" href="../../d5/d8/ex_8h.html#a281">ExIsResourceAcquiredExclusiveLite</a>(&amp;Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o3">JobLock</a>));
00044 
00045     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a278">gpresUser</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00046 
00047     BEGIN_REENTERCRIT();
00048 
00049     <a class="code" href="../../d4/d1/userk_8h.html#a159">BEGINATOMICCHECK</a>();
00050 
00051     <span class="comment">/*</span>
00052 <span class="comment">     * find the W32JOB in the global list (if any)</span>
00053 <span class="comment">     */</span>
00054     pW32Job = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a113">gpJobsList</a>;
00055 
00056     <span class="keywordflow">while</span> (pW32Job) {
00057         <span class="keywordflow">if</span> (pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o1">Job</a> == Job) {
00058             <span class="keywordflow">break</span>;
00059         }
00060         pW32Job = pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o0">pNext</a>;
00061     }
00062 
00063     <span class="keywordflow">switch</span> (CalloutType) {
00064     <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/ps_8h.html#a156a93">PsW32JobCalloutSetInformation</a>:
00065 
00066         <span class="keywordflow">if</span> (pW32Job == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00067 
00068             <span class="comment">/*</span>
00069 <span class="comment">             * The W32Job is not created yet. Assert that this is not</span>
00070 <span class="comment">             * a call to remove UI restrictions</span>
00071 <span class="comment">             */</span>
00072             UserAssert(Data != 0);
00073 
00074             <span class="keywordflow">if</span> ((pW32Job = <a class="code" href="../../d3/d8/job_8c.html#a0">CreateW32Job</a>(Job)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00075                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
00076                 <span class="keywordflow">break</span>;
00077             }
00078         } <span class="keywordflow">else</span> {
00079 
00080             <span class="comment">/*</span>
00081 <span class="comment">             * The W32Job structure is already created. Return if</span>
00082 <span class="comment">             * the restrictions are the same as before.</span>
00083 <span class="comment">             */</span>
00084             <span class="keywordflow">if</span> (PtrToUlong(Data) == pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o3">restrictions</a>) {
00085                 TAGMSG0(DBGTAG_Job, <span class="stringliteral">"UserJobCallout: SetInformation same as before"</span>);
00086                 <span class="keywordflow">break</span>;
00087             }
00088         }
00089 
00090         <span class="comment">/*</span>
00091 <span class="comment">         * Set the restrictions</span>
00092 <span class="comment">         */</span>
00093         pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o3">restrictions</a> = PtrToUlong(Data);
00094 
00095         <a class="code" href="../../d3/d8/job_8c.html#a1">UpdateJob</a>(pW32Job);
00096         <span class="keywordflow">break</span>;
00097 
00098     <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/ps_8h.html#a156a94">PsW32JobCalloutAddProcess</a>:
00099 
00100         <span class="comment">/*</span>
00101 <span class="comment">         * 'Data' parameter is a pointer to W32PROCESS. So this callout</span>
00102 <span class="comment">         * happens only for GUI processes.</span>
00103 <span class="comment">         */</span>
00104         UserAssert(Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o20">UIRestrictionsClass</a> != 0);
00105 
00106         <span class="comment">/*</span>
00107 <span class="comment">         * Assert that the W32JOB structure is already created.</span>
00108 <span class="comment">         */</span>
00109         UserAssert(pW32Job != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00110 
00111         TAGMSG3(DBGTAG_Job, <span class="stringliteral">"UserJobCallout: AddProcess Job 0x%x W32Job 0x%x Process 0x%x"</span>,
00112                 Job, pW32Job, (ULONG_PTR)Data);
00113 
00114         <span class="comment">/*</span>
00115 <span class="comment">         * this callout must be only for GUI processes</span>
00116 <span class="comment">         */</span>
00117         UserAssert(Data != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00118 
00119         <a class="code" href="../../d3/d8/job_8c.html#a3">JobCalloutAddProcess</a>(pW32Job, (<a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a>)Data);
00120 
00121         <span class="keywordflow">break</span>;
00122 
00123     <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/ps_8h.html#a156a95">PsW32JobCalloutTerminate</a>:
00124 
00125         TAGMSG2(DBGTAG_Job, <span class="stringliteral">"UserJobCallout: Terminate Job 0x%x W32Job 0x%x"</span>,
00126                 Job, pW32Job);
00127 
00128         <span class="keywordflow">if</span> (pW32Job) {
00129             <a class="code" href="../../d3/d8/job_8c.html#a4">JobCalloutTerminate</a>(pW32Job);
00130         }
00131         <span class="keywordflow">break</span>;
00132 
00133     <span class="keywordflow">default</span>:
00134         TAGMSG2(DBGTAG_Job, <span class="stringliteral">"UserJobCallout: Invalid callout 0x%x Job 0x%x"</span>,
00135                 CalloutType, Job);
00136 
00137         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NOT_IMPLEMENTED;
00138         <span class="keywordflow">break</span>;
00139     }
00140 
00141     <a class="code" href="../../d4/d1/userk_8h.html#a163">ENDATOMICCHECK</a>();
00142 
00143     END_REENTERCRIT();
00144 
00145     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00146 }
00147 
00148 <span class="comment">/***************************************************************************\</span>
00149 <span class="comment">* CreateW32Job</span>
00150 <span class="comment">*</span>
00151 <span class="comment">* Creates a W32Job</span>
00152 <span class="comment">*</span>
00153 <span class="comment">* History:</span>
00154 <span class="comment">* 18-Mar-1998 CLupu   Created.</span>
00155 <span class="comment">\***************************************************************************/</span>
<a name="l00156"></a><a class="code" href="../../d3/d8/job_8c.html#a0">00156</a> <a class="code" href="../../d1/d9/structtagW32JOB.html">PW32JOB</a> <a class="code" href="../../d3/d8/job_8c.html#a0">CreateW32Job</a>(
00157     <a class="code" href="../../d0/d3/struct__EJOB.html">PEJOB</a> Job)
00158 {
00159     <a class="code" href="../../d1/d9/structtagW32JOB.html">PW32JOB</a> pW32Job;
00160 
00161     TAGMSG1(DBGTAG_Job, <span class="stringliteral">"CreateW32Job: EJOB 0x%x"</span>, Job);
00162 
00163     pW32Job = UserAllocPoolZInit(<span class="keyword">sizeof</span>(<a class="code" href="../../d1/d9/structtagW32JOB.html">W32JOB</a>), TAG_W32JOB);
00164 
00165     <span class="keywordflow">if</span> (pW32Job == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00166         RIPMSG0(RIP_ERROR, <span class="stringliteral">"CreateW32Job: memory allocation error"</span>);
00167         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00168     }
00169 
00170     <span class="comment">/*</span>
00171 <span class="comment">     * Create the global atom table for this job</span>
00172 <span class="comment">     */</span>
00173     <a class="code" href="../../d8/d8/winsta_8c.html#a2">CreateGlobalAtomTable</a>(&amp;pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o2">pAtomTable</a>);
00174 
00175     <span class="keywordflow">if</span> (pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o2">pAtomTable</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00176         RIPMSG1(RIP_ERROR, <span class="stringliteral">"CreateW32Job: fail to create the atom table for job 0x%x"</span>,
00177                 pW32Job);
00178 
00179         UserFreePool(pW32Job);
00180         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00181     }
00182 
00183     <span class="comment">/*</span>
00184 <span class="comment">     * Link it in the W32 job's list</span>
00185 <span class="comment">     */</span>
00186     pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o0">pNext</a> = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a113">gpJobsList</a>;
00187     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a113">gpJobsList</a> = pW32Job;
00188 
00189     pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o1">Job</a> = Job;
00190 
00191     TAGMSG2(DBGTAG_Job, <span class="stringliteral">"CreateW32Job: pW32Job 0x%x created for EJOB 0x%x"</span>,
00192             pW32Job, Job);
00193 
00194     <span class="keywordflow">return</span> pW32Job;
00195 }
00196 
00197 <span class="comment">/***************************************************************************\</span>
00198 <span class="comment">* UpdateJob</span>
00199 <span class="comment">*</span>
00200 <span class="comment">* Walks the processinfo list in userk to update all the processes assigned</span>
00201 <span class="comment">* to this job .</span>
00202 <span class="comment">*</span>
00203 <span class="comment">* History:</span>
00204 <span class="comment">* 20-Mar-1998 CLupu   Created.</span>
00205 <span class="comment">\***************************************************************************/</span>
<a name="l00206"></a><a class="code" href="../../d3/d8/job_8c.html#a1">00206</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d3/d8/job_8c.html#a1">UpdateJob</a>(
00207     <a class="code" href="../../d1/d9/structtagW32JOB.html">PW32JOB</a> pW32Job)
00208 {
00209     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppi;
00210 
00211     UserAssert(<a class="code" href="../../d5/d8/ex_8h.html#a281">ExIsResourceAcquiredExclusiveLite</a>(&amp;pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o1">Job</a>-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o3">JobLock</a>));
00212     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00213 
00214     TAGMSG1(DBGTAG_Job, <span class="stringliteral">"UpdateJob: pW32Job 0x%x"</span>, pW32Job);
00215 
00216     <span class="comment">/*</span>
00217 <span class="comment">     * walk the GUI processes list to see if any new process got</span>
00218 <span class="comment">     * assigned to the current job.</span>
00219 <span class="comment">     */</span>
00220     ppi = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a110">gppiList</a>;
00221 
00222     <span class="keywordflow">while</span> (ppi) {
00223         <span class="keywordflow">if</span> (ppi-&gt;Process-&gt;Job == pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o1">Job</a>) {
00224 
00225             <span class="comment">/*</span>
00226 <span class="comment">             * the process is assigned to this job</span>
00227 <span class="comment">             */</span>
00228             <span class="keywordflow">if</span> (ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o25">pW32Job</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00229 
00230                 <span class="comment">/*</span>
00231 <span class="comment">                 * add the process to the W32 job</span>
00232 <span class="comment">                 */</span>
00233                 <a class="code" href="../../d3/d8/job_8c.html#a3">JobCalloutAddProcess</a>(pW32Job, ppi);
00234             } <span class="keywordflow">else</span> {
00235 
00236                 <span class="comment">/*</span>
00237 <span class="comment">                 * The process is already added to the job. Just</span>
00238 <span class="comment">                 * update the restrictions.</span>
00239 <span class="comment">                 */</span>
00240                 <a class="code" href="../../d3/d8/job_8c.html#a2">SetProcessFlags</a>(pW32Job, ppi);
00241             }
00242         }
00243         ppi = ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o8">ppiNextRunning</a>;
00244     }
00245 }
00246 
00247 <span class="comment">/***************************************************************************\</span>
00248 <span class="comment">* RemoveProcessFromJob</span>
00249 <span class="comment">*</span>
00250 <span class="comment">* This is called during the delete process callout.</span>
00251 <span class="comment">*</span>
00252 <span class="comment">* History:</span>
00253 <span class="comment">* 30-Jul-1997 CLupu   Created.</span>
00254 <span class="comment">\***************************************************************************/</span>
<a name="l00255"></a><a class="code" href="../../d4/d1/userk_8h.html#a1145">00255</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1145">RemoveProcessFromJob</a>(
00256     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppi)
00257 {
00258     <a class="code" href="../../d1/d9/structtagW32JOB.html">PW32JOB</a> pW32Job;
00259     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>    ip;
00260 
00261     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00262 
00263     pW32Job = ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o25">pW32Job</a>;
00264 
00265     TAGMSG2(DBGTAG_Job, <span class="stringliteral">"RemoveProcessFromJob: ppi 0x%x pW32Job 0x%x"</span>,
00266             ppi, pW32Job);
00267 
00268     <span class="comment">/*</span>
00269 <span class="comment">     * The job might not have UI restrictions</span>
00270 <span class="comment">     */</span>
00271     <span class="keywordflow">if</span> (pW32Job == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00272         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00273     }
00274 
00275     <span class="comment">/*</span>
00276 <span class="comment">     * remove the ppi from the job's ppi table</span>
00277 <span class="comment">     */</span>
00278     <span class="keywordflow">for</span> (ip = 0; ip &lt; pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o4">uProcessCount</a>; ip++) {
00279 
00280         UserAssert(pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o6">ppiTable</a>[ip]-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o25">pW32Job</a> == pW32Job);
00281 
00282         <span class="keywordflow">if</span> (ppi == pW32Job-&gt;ppiTable[ip]) {
00283 
00284             ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o25">pW32Job</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00285 
00286             RtlMoveMemory(pW32Job-&gt;ppiTable + ip,
00287                           pW32Job-&gt;ppiTable + ip + 1,
00288                           (pW32Job-&gt;uProcessCount - ip - 1) * <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a>));
00289 
00290             (pW32Job-&gt;uProcessCount)--;
00291 
00292             <span class="comment">/*</span>
00293 <span class="comment">             * free the process array if this is the last one.</span>
00294 <span class="comment">             */</span>
00295             <span class="keywordflow">if</span> (pW32Job-&gt;uProcessCount == 0) {
00296                 UserFreePool(pW32Job-&gt;ppiTable);
00297                 pW32Job-&gt;ppiTable = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00298                 pW32Job-&gt;uMaxProcesses = 0;
00299             }
00300             
00301             TAGMSG2(DBGTAG_Job, <span class="stringliteral">"RemoveProcessFromJob: ppi 0x%x removed from pW32Job 0x%x"</span>,
00302                     ppi, pW32Job);
00303 
00304             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00305         }
00306     }
00307     
00308     TAGMSG2(DBGTAG_Job, <span class="stringliteral">"RemoveProcessFromJob: ppi 0x%x not found in pW32Job 0x%x"</span>,
00309             ppi, pW32Job);
00310 
00311     UserAssert(0);
00312 
00313     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00314 }
00315 
00316 <span class="comment">/***************************************************************************\</span>
00317 <span class="comment">* SetProcessFlags</span>
00318 <span class="comment">*</span>
00319 <span class="comment">* History:</span>
00320 <span class="comment">* 29-Jul-1997 CLupu   Created.</span>
00321 <span class="comment">\***************************************************************************/</span>
<a name="l00322"></a><a class="code" href="../../d3/d8/job_8c.html#a2">00322</a> <span class="keywordtype">void</span> <a class="code" href="../../d3/d8/job_8c.html#a2">SetProcessFlags</a>(
00323     <a class="code" href="../../d1/d9/structtagW32JOB.html">PW32JOB</a>      pW32Job,
00324     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppi)
00325 {
00326     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti;
00327 
00328     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00329 
00330     TAGMSG3(DBGTAG_Job, <span class="stringliteral">"SetProcessFlags: pW32Job 0x%x ppi 0x%x restrictions 0x%x"</span>,
00331             pW32Job, ppi, pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o3">restrictions</a>);
00332 
00333     UserAssert(ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o25">pW32Job</a> == pW32Job);
00334 
00335     <span class="keywordflow">if</span> (pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o3">restrictions</a> == 0) {
00336         ((PW32PROCESS)ppi)-&gt;W32PF_Flags &amp;= ~W32PF_RESTRICTED;
00337     } <span class="keywordflow">else</span> {
00338         ((PW32PROCESS)ppi)-&gt;W32PF_Flags |= W32PF_RESTRICTED;
00339     }
00340 
00341     <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a>(&amp;ppi-&gt;Process-&gt;Pcb);
00342 
00343     <span class="comment">/*</span>
00344 <span class="comment">     * walk the pti list and set the restricted flag as appropriate</span>
00345 <span class="comment">     */</span>
00346     pti = ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o1">ptiList</a>;
00347 
00348     <span class="keywordflow">if</span> (pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o3">restrictions</a> == 0) {
00349         <span class="keywordflow">while</span> (pti) {
00350             pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a821">TIF_RESTRICTED</a>;
00351             pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o4">dwTIFlags</a> &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a821">TIF_RESTRICTED</a>;
00352             pti = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o29">ptiSibling</a>;
00353         }
00354     } <span class="keywordflow">else</span> {
00355         <span class="keywordflow">while</span> (pti) {
00356             pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a821">TIF_RESTRICTED</a>;
00357             pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o4">dwTIFlags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a821">TIF_RESTRICTED</a>;
00358             pti = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o29">ptiSibling</a>;
00359         }
00360     }
00361 
00362     <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00363 }
00364 
00365 <span class="comment">/***************************************************************************\</span>
00366 <span class="comment">* JobCalloutAddProcess</span>
00367 <span class="comment">*</span>
00368 <span class="comment">* History:</span>
00369 <span class="comment">* 30-Jul-1997 CLupu   Created.</span>
00370 <span class="comment">\***************************************************************************/</span>
<a name="l00371"></a><a class="code" href="../../d3/d8/job_8c.html#a3">00371</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d8/job_8c.html#a3">JobCalloutAddProcess</a>(
00372     <a class="code" href="../../d1/d9/structtagW32JOB.html">PW32JOB</a>      pW32Job,
00373     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppi)
00374 {
00375     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a>* ppiTable;
00376 
00377     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00378 
00379     UserAssert(pW32Job != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00380 
00381     <span class="comment">/*</span>
00382 <span class="comment">     * This process is not yet initialized</span>
00383 <span class="comment">     */</span>
00384     <span class="keywordflow">if</span> (ppi-&gt;Process == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00385         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00386     }
00387 
00388     <span class="keywordflow">if</span> (!(ppi-&gt;W32PF_Flags &amp; W32PF_PROCESSCONNECTED)) {
00389         TAGMSG2(DBGTAG_Job, <span class="stringliteral">"JobCalloutAddProcess: pW32Job 0x%x ppi 0x%x not yet initialized"</span>,
00390                 pW32Job, ppi);
00391         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00392     }
00393 
00394     TAGMSG2(DBGTAG_Job, <span class="stringliteral">"JobCalloutAddProcess: pW32Job 0x%x ppi 0x%x"</span>,
00395             pW32Job, ppi);
00396 
00397 <span class="preprocessor">#if DBG</span>
00398 <span class="preprocessor"></span>    <span class="comment">/*</span>
00399 <span class="comment">     * Make sure the process is not already in the job's process list</span>
00400 <span class="comment">     */</span>
00401     {
00402         <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> ip;
00403         <span class="keywordflow">for</span> (ip = 0; ip &lt; pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o4">uProcessCount</a>; ip++) {
00404 
00405             UserAssert(pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o6">ppiTable</a>[ip]-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o25">pW32Job</a> == pW32Job);
00406             UserAssert(ppi != pW32Job-&gt;ppiTable[ip]);
00407         }
00408     }
00409 <span class="preprocessor">#endif // DBG</span>
00410 <span class="preprocessor"></span>
00411     <span class="comment">/*</span>
00412 <span class="comment">     * save the pW32Job pointer in the process info</span>
00413 <span class="comment">     */</span>
00414     UserAssert(ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o25">pW32Job</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00415 
00416     ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o25">pW32Job</a> = pW32Job;
00417 
00418     <span class="keywordflow">if</span> (pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o4">uProcessCount</a> == pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o5">uMaxProcesses</a>) {
00419 
00420         <span class="comment">/*</span>
00421 <span class="comment">         * No more room. Allocate more space for the process table</span>
00422 <span class="comment">         */</span>
00423         <span class="keywordflow">if</span> (pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o5">uMaxProcesses</a> == 0) {
00424 
00425             UserAssert(pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o6">ppiTable</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00426 
00427             ppiTable = UserAllocPool(<a class="code" href="../../d4/d1/userk_8h.html#a387">JP_DELTA</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a>), TAG_W32JOBEXTRA);
00428 
00429         } <span class="keywordflow">else</span> {
00430             UserAssert(pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o6">ppiTable</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00431 
00432             ppiTable = UserReAllocPool(pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o6">ppiTable</a>,
00433                                        pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o5">uMaxProcesses</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a>),
00434                                        (pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o5">uMaxProcesses</a> + <a class="code" href="../../d4/d1/userk_8h.html#a387">JP_DELTA</a>) * <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a952">PPROCESSINFO</a>),
00435                                        TAG_W32JOBEXTRA);
00436         }
00437 
00438         <span class="keywordflow">if</span> (ppiTable == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00439             RIPMSG0(RIP_ERROR, <span class="stringliteral">"JobCalloutAddProcess: memory allocation error\n"</span>);
00440             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00441         }
00442 
00443         pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o6">ppiTable</a> = ppiTable;
00444         pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o5">uMaxProcesses</a> += <a class="code" href="../../d4/d1/userk_8h.html#a387">JP_DELTA</a>;
00445     }
00446 
00447     <span class="comment">/*</span>
00448 <span class="comment">     * now add the process to the job</span>
00449 <span class="comment">     */</span>
00450     pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o6">ppiTable</a>[pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o4">uProcessCount</a>] = ppi;
00451     (pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o4">uProcessCount</a>)++;
00452 
00453     <a class="code" href="../../d3/d8/job_8c.html#a2">SetProcessFlags</a>(pW32Job, ppi);
00454 
00455     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00456 }
00457 
00458 <span class="comment">/***************************************************************************\</span>
00459 <span class="comment">* JobCalloutTerminate</span>
00460 <span class="comment">*</span>
00461 <span class="comment">* This is called during the job object delete routine.</span>
00462 <span class="comment">*</span>
00463 <span class="comment">* History:</span>
00464 <span class="comment">* 30-Jul-1997 CLupu   Created.</span>
00465 <span class="comment">\***************************************************************************/</span>
<a name="l00466"></a><a class="code" href="../../d3/d8/job_8c.html#a4">00466</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d8/job_8c.html#a4">JobCalloutTerminate</a>(
00467     <a class="code" href="../../d1/d9/structtagW32JOB.html">PW32JOB</a> pW32Job)
00468 {
00469     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00470 
00471     UserAssert(pW32Job != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00472 
00473     TAGMSG1(DBGTAG_Job, <span class="stringliteral">"JobCalloutTerminate: pW32Job 0x%x"</span>, pW32Job);
00474 
00475     <span class="comment">/*</span>
00476 <span class="comment">     * No processes should be attached to this job</span>
00477 <span class="comment">     */</span>
00478     UserAssert(pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o6">ppiTable</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00479     UserAssert(pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o4">uProcessCount</a> == 0);
00480     UserAssert(pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o5">uMaxProcesses</a> == 0);
00481 
00482     <span class="keywordflow">if</span> (pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o9">pgh</a>) {
00483         UserAssert(pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o7">ughCrt</a> &gt; 0);
00484         UserAssert(pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o8">ughMax</a> &gt; 0);
00485 
00486         UserFreePool(pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o9">pgh</a>);
00487         pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o9">pgh</a>    = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00488         pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o7">ughCrt</a> = 0;
00489         pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o8">ughMax</a> = 0;
00490     }
00491 
00492     <span class="comment">/*</span>
00493 <span class="comment">     * remove the W32 job from the job's list</span>
00494 <span class="comment">     */</span>
00495     <a class="code" href="../../d4/d1/userk_8h.html#a752">REMOVE_FROM_LIST</a>(<a class="code" href="../../d1/d9/structtagW32JOB.html">W32JOB</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a113">gpJobsList</a>, pW32Job, pNext);
00496 
00497     <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a14">RtlDestroyAtomTable</a>(pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o2">pAtomTable</a>);
00498 
00499     UserFreePool(pW32Job);
00500 
00501     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00502 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:32 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
