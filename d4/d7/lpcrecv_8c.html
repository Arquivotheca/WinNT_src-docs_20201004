<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: lpcrecv.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>lpcrecv.c File Reference</h1><code>#include "<a class="el" href="../../d1/d6/lpcp_8h-source.html">lpcp.h</a>"</code><br>

<p>
<a href="../../d5/d6/lpcrecv_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d7/lpcrecv_8c.html#a0">NtReplyWaitReceivePort</a> (IN HANDLE <a class="el" href="../../d7/d7/uclient_8c.html#a3">PortHandle</a>, OUT PVOID *PortContext OPTIONAL, IN PPORT_MESSAGE ReplyMessage OPTIONAL, OUT PPORT_MESSAGE ReceiveMessage)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d7/lpcrecv_8c.html#a1">NtReplyWaitReceivePortEx</a> (IN HANDLE <a class="el" href="../../d7/d7/uclient_8c.html#a3">PortHandle</a>, OUT PVOID *PortContext OPTIONAL, IN PPORT_MESSAGE ReplyMessage OPTIONAL, OUT PPORT_MESSAGE ReceiveMessage, IN PLARGE_INTEGER Timeout OPTIONAL)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a0" doxytag="lpcrecv.c::NtReplyWaitReceivePort" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtReplyWaitReceivePort           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>PortHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *PortContext&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PPORT_MESSAGE ReplyMessage&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PPORT_MESSAGE&nbsp;</td>
          <td class="mdname" nowrap> <em>ReceiveMessage</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d6/lpcrecv_8c-source.html#l00029">29</a> of file <a class="el" href="../../d5/d6/lpcrecv_8c-source.html">lpcrecv.c</a>.
<p>
References <a class="el" href="../../d2/d8/ps_8h-source.html#l00388">_ETHREAD::Cid</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00134">CLIENT_COMMUNICATION_PORT</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00107">_LPCP_PORT_OBJECT::ConnectionPort</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00142">_LPCP_MESSAGE::Entry</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00106">_LPCP_PORT_OBJECT::Flags</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00639">IS_SYSTEM_THREAD</a>, <a class="el" href="../../d2/d5/semphobj_8c-source.html#l00118">KeReleaseSemaphore()</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00285">KeResetEvent()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00447">_ETHREAD::LpcExitThreadCalled</a>, <a class="el" href="../../d1/d6/lpcp_8h-source.html#l00093">LpcpAcquireLpcpLock</a>, <a class="el" href="../../d4/d6/lpcqueue_8c-source.html#l00558">LpcpAllocateFromPortZone()</a>, <a class="el" href="../../d4/d6/lpcqueue_8c-source.html#l00879">LpcpFreeDataInfoMessage()</a>, <a class="el" href="../../d4/d6/lpcqueue_8c-source.html#l00642">LpcpFreeToPortZone()</a>, <a class="el" href="../../d8/d5/lpcinit_8c-source.html#l00193">LpcpGetCreatorName()</a>, <a class="el" href="../../d0/d7/lpcp_8h.html#a31">LpcpMoveMessage()</a>, <a class="el" href="../../d1/d6/lpcp_8h-source.html#l00319">LpcpPrint</a>, <a class="el" href="../../d1/d6/lpcp_8h-source.html#l00278">LpcpReferencePortObject</a>, <a class="el" href="../../d1/d6/lpcp_8h-source.html#l00108">LpcpReleaseLpcpLock</a>, <a class="el" href="../../d4/d6/lpcqueue_8c-source.html#l00809">LpcpSaveDataInfoMessage()</a>, <a class="el" href="../../d1/d6/lpcp_8h-source.html#l00153">LpcpSaveThread</a>, <a class="el" href="../../d1/d6/lpcp_8h-source.html#l00320">LpcpTrace</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00445">_ETHREAD::LpcReceivedMessageId</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00449">_ETHREAD::LpcReceivedMsgIdValid</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00371">_ETHREAD::LpcReplyChain</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00395">_ETHREAD::LpcReplyMessage</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00396">_ETHREAD::LpcReplyMessageId</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00394">_ETHREAD::LpcReplySemaphore</a>, <a class="el" href="../../d0/d8/ntos_8h-source.html#l00092">LpcWaitablePortObjectType</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00114">_LPCP_PORT_OBJECT::MaxMessageLength</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00109">_LPCP_PORT_OBJECT::MsgQueue</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00130">PORT_TYPE</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00135">PORT_WAITABLE</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00153">_LPCP_MESSAGE::PortContext</a>, <a class="el" href="../../d8/d6/uclient_8c-source.html#l00027">PortHandle</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>, <a class="el" href="../../d0/d4/probe_8c-source.html#l00034">ProbeForWrite()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01649">ProbeForWriteUlong</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d2/d9/pscid_8c-source.html#l00027">PsLookupProcessThreadByCid()</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00081">_LPCP_PORT_QUEUE::ReceiveHead</a>, <a class="el" href="../../d4/d7/client_8c-source.html#l03425">ReplyMessage()</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00154">_LPCP_MESSAGE::Request</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00079">_LPCP_PORT_QUEUE::Semaphore</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00638">THREAD_TO_PROCESS</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00123">_LPCP_PORT_OBJECT::WaitEvent</a>, and <a class="el" href="../../d4/d9/ke_8h.html#a407a214">WrLpcReceive</a>.
<p>
Referenced by <a class="el" href="../../d4/d9/dllssstb_8c-source.html#l00737">DbgSspSrvApiLoop()</a>, <a class="el" href="../../d9/d5/lpclistn_8c-source.html#l00029">NtListenPort()</a>, <a class="el" href="../../d9/d0/userver_8c-source.html#l00173">ServerThread()</a>, <a class="el" href="../../d9/d6/udbgk_8c-source.html#l00069">UdbgTest1()</a>, and <a class="el" href="../../d9/d6/udbgk_8c-source.html#l00280">UdbgTest2()</a>.
<p>
<pre class="fragment"><div>00038                    :
00039 
00040     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> server process to wait <span class="keywordflow">for</span> a message from a
00041     client process
00042 
00043     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> client and server process can receive messages <span class="keyword">using</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00044     <a class="code" href="../../d4/d7/lpcrecv_8c.html#a0">NtReplyWaitReceivePort</a> service:
00045 
00046     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d8/client_8c.html#a125">ReplyMessage</a> parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> reply will be sent
00047     <span class="keyword">using</span> <a class="code" href="../../d5/d7/lpcreply_8c.html#a1">NtReplyPort</a>.
00048 
00049     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d7/d7/uclient_8c.html#a3">PortHandle</a> parameter specifies a connection port, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> receive
00050     will <span class="keywordflow">return</span> whenever a message <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> sent to a server communication port that
00051     does not have its own receive queue and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> message <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> therefore queued to
00052     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> receive queue of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> connection port.
00053 
00054     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d7/d7/uclient_8c.html#a3">PortHandle</a> parameter specifies a server communication port that
00055     does not have a receive queue, then behaves as <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> associated
00056     connection port handle was specified.  Otherwise <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> receive will <span class="keywordflow">return</span>
00057     whenever message <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> placed in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> receive queue associated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00058     server communication port.
00059 
00060     The received message will be returned in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> variable specified by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00061     ReceiveMessage parameter.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> MapInfoOffset field of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> reply message
00062     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> non-zero, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PORT_MAP_INFORMATION structure <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> points to will be
00063     processed and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> relevant pages will be mapped into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller's address
00064     space.  The service returns an error <span class="keywordflow">if</span> there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not enough room in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00065     caller's address space to accomodate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mappings.
00066 
00067 Arguments:
00068 
00069     <a class="code" href="../../d7/d7/uclient_8c.html#a3">PortHandle</a> - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> connection or communication port
00070         to <span class="keywordflow">do</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> receive from.
00071 
00072     PortContext - Specifies an optional pointer to a variable that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to
00073         receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context value associated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> communication port that
00074         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> message <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being received from.  This context variable was
00075         specified on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> call to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/lpccompl_8c.html#a1">NtAcceptConnectPort</a> service.
00076 
00077     <a class="code" href="../../d3/d8/client_8c.html#a125">ReplyMessage</a> - This optional parameter specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of a reply
00078         message to be sent.  The ClientId and MessageId fields determine which
00079         thread will get <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> reply.  See description of <a class="code" href="../../d5/d7/lpcreply_8c.html#a1">NtReplyPort</a> <span class="keywordflow">for</span> how <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00080         reply <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> sent.  The reply <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> sent before blocking <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> receive.
00081 
00082     ReceiveMessage - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00083         message.
00084 
00085 Return Value:
00086 
00087     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation was successful.
00088 
00089 --*/
00090 
00091 {
00092     <a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html">PLPCP_PORT_OBJECT</a> PortObject;
00093     <a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html">PLPCP_PORT_OBJECT</a> ReceivePort;
00094     PORT_MESSAGE CapturedReplyMessage;
00095     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00096     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> WaitMode;
00097     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00098     <a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html">PLPCP_MESSAGE</a> Msg;
00099     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> CurrentThread;
00100     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> WakeupThread;
00101 
00102     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00103 
00104     CurrentThread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00105 
00106     <span class="comment">//</span>
00107     <span class="comment">//  Get previous processor mode</span>
00108     <span class="comment">//</span>
00109 
00110     PreviousMode = KeGetPreviousMode();
00111     WaitMode = PreviousMode;
00112 
00113     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00114 
00115         <span class="keywordflow">try</span> {
00116 
00117             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( PortContext )) {
00118 
00119                 <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>( (PULONG)PortContext );
00120             }
00121 
00122             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ReplyMessage)) {
00123 
00124                 <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( ReplyMessage,
00125                               <span class="keyword">sizeof</span>( *ReplyMessage ),
00126                               <span class="keyword">sizeof</span>( ULONG ));
00127 
00128                 CapturedReplyMessage = *<a class="code" href="../../d3/d8/client_8c.html#a125">ReplyMessage</a>;
00129             }
00130 
00131             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>( ReceiveMessage,
00132                            <span class="keyword">sizeof</span>( *ReceiveMessage ),
00133                            <span class="keyword">sizeof</span>( ULONG ));
00134 
00135         } except( EXCEPTION_EXECUTE_HANDLER ) {
00136 
00137             <span class="keywordflow">return</span> GetExceptionCode();
00138         }
00139 
00140     } <span class="keywordflow">else</span> {
00141 
00142         <span class="comment">//</span>
00143         <span class="comment">//  Kernel mode threads call with wait mode of user so that their</span>
00144         <span class="comment">//  kernel stacks are swappable.  Main consumer of this is</span>
00145         <span class="comment">//  SepRmCommandThread</span>
00146         <span class="comment">//</span>
00147 
00148         <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d9/ps_8h.html#a18">IS_SYSTEM_THREAD</a>(CurrentThread) ) {
00149 
00150             WaitMode = <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>;
00151         }
00152 
00153         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ReplyMessage )) {
00154 
00155             CapturedReplyMessage = *<a class="code" href="../../d3/d8/client_8c.html#a125">ReplyMessage</a>;
00156         }
00157     }
00158 
00159     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ReplyMessage )) {
00160 
00161         <span class="comment">//</span>
00162         <span class="comment">//  Make sure DataLength is valid with respect to header size and total</span>
00163         <span class="comment">//  length</span>
00164         <span class="comment">//</span>
00165 
00166         <span class="keywordflow">if</span> ((((CLONG)CapturedReplyMessage.u1.s1.DataLength) + <span class="keyword">sizeof</span>( PORT_MESSAGE )) &gt;
00167             ((CLONG)CapturedReplyMessage.u1.s1.TotalLength)) {
00168 
00169             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00170         }
00171 
00172         <span class="comment">//</span>
00173         <span class="comment">//  Make sure the user didn't give us a bogus reply message id</span>
00174         <span class="comment">//</span>
00175 
00176         <span class="keywordflow">if</span> (CapturedReplyMessage.MessageId == 0) {
00177 
00178             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00179         }
00180     }
00181 
00182     <span class="comment">//</span>
00183     <span class="comment">//  Reference the port object by handle and if that doesn't work try</span>
00184     <span class="comment">//  a waitable port object type</span>
00185     <span class="comment">//</span>
00186 
00187     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d7/lpcp_8h.html#a10">LpcpReferencePortObject</a>( PortHandle,
00188                                       0,
00189                                       PreviousMode,
00190                                       &amp;PortObject );
00191 
00192     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00193 
00194         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( PortHandle,
00195                                             0,
00196                                             LpcWaitablePortObjectType,
00197                                             PreviousMode,
00198                                             &amp;PortObject,
00199                                             NULL );
00200 
00201         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00202 
00203             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00204         }
00205     }
00206 
00207     <a class="code" href="../../d0/d7/lpcp_8h.html#a7">LpcpSaveThread</a> (PortObject);
00208 
00209     <span class="comment">//</span>
00210     <span class="comment">//  Validate the message length</span>
00211     <span class="comment">//</span>
00212 
00213     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ReplyMessage )) {
00214 
00215         <span class="keywordflow">if</span> (((ULONG)CapturedReplyMessage.u1.s1.TotalLength &gt; PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o9">MaxMessageLength</a>) ||
00216             ((ULONG)CapturedReplyMessage.u1.s1.TotalLength &lt;= (ULONG)CapturedReplyMessage.u1.s1.DataLength)) {
00217 
00218             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( PortObject );
00219 
00220             <span class="keywordflow">return</span> STATUS_PORT_MESSAGE_TOO_LONG;
00221         }
00222     }
00223 
00224     <span class="comment">//</span>
00225     <span class="comment">//  The receive port we use is either the connection port for the port</span>
00226     <span class="comment">//  object we were given if we were given a client communication port then</span>
00227     <span class="comment">//  we expect to recieve the reply on the communication port itself.</span>
00228     <span class="comment">//</span>
00229 
00230     <span class="keywordflow">if</span> ((PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o1">Flags</a> &amp; <a class="code" href="../../d2/d6/lpc_8h.html#a3">PORT_TYPE</a>) != <a class="code" href="../../d2/d6/lpc_8h.html#a7">CLIENT_COMMUNICATION_PORT</a>) {
00231 
00232         ReceivePort = PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o2">ConnectionPort</a>;
00233 
00234     } <span class="keywordflow">else</span> {
00235 
00236         ReceivePort = PortObject;
00237     }
00238 
00239     <span class="comment">//</span>
00240     <span class="comment">//  If ReplyMessage argument present, then send reply</span>
00241     <span class="comment">//</span>
00242 
00243     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ReplyMessage )) {
00244 
00245         <span class="comment">//</span>
00246         <span class="comment">//  Translate the ClientId from the connection request into a</span>
00247         <span class="comment">//  thread pointer.  This is a referenced pointer to keep the thread</span>
00248         <span class="comment">//  from evaporating out from under us.</span>
00249         <span class="comment">//</span>
00250 
00251         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d0/pscid_8c.html#a0">PsLookupProcessThreadByCid</a>( &amp;CapturedReplyMessage.ClientId,
00252                                              NULL,
00253                                              &amp;WakeupThread );
00254 
00255         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00256 
00257             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( PortObject );
00258             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00259         }
00260 
00261         <span class="comment">//</span>
00262         <span class="comment">//  Acquire the global Lpc mutex that gaurds the LpcReplyMessage</span>
00263         <span class="comment">//  field of the thread and get the pointer to the message that</span>
00264         <span class="comment">//  the thread is waiting for a reply to.</span>
00265         <span class="comment">//</span>
00266 
00267         <a class="code" href="../../d0/d7/lpcp_8h.html#a3">LpcpAcquireLpcpLock</a>();
00268 
00269         Msg = (<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html">PLPCP_MESSAGE</a>)<a class="code" href="../../d3/d7/lpcqueue_8c.html#a4">LpcpAllocateFromPortZone</a>( CapturedReplyMessage.u1.s1.TotalLength );
00270 
00271         <span class="keywordflow">if</span> (Msg == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00272 
00273             <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
00274 
00275             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( WakeupThread );
00276             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( PortObject );
00277 
00278             <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00279         }
00280 
00281         <span class="comment">//</span>
00282         <span class="comment">//  See if the thread is waiting for a reply to the message</span>
00283         <span class="comment">//  specified on this call.  If not then a bogus message</span>
00284         <span class="comment">//  has been specified, so release the mutex, dereference the thread</span>
00285         <span class="comment">//  and return failure.</span>
00286         <span class="comment">//</span>
00287         <span class="comment">//  We also fail this request if the caller isn't replying to a request</span>
00288         <span class="comment">//  message.  For example, if the caller is replying to a connection</span>
00289         <span class="comment">//  request</span>
00290         <span class="comment">//</span>
00291 
00292         <span class="keywordflow">if</span> ((WakeupThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o15">LpcReplyMessageId</a> != CapturedReplyMessage.MessageId)
00293 
00294                 ||
00295 
00296             ((WakeupThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o14">LpcReplyMessage</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00297              (((<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html">PLPCP_MESSAGE</a>)(WakeupThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o14">LpcReplyMessage</a>))-&gt;Request.u2.s2.Type &amp; ~LPC_KERNELMODE_MESSAGE) != LPC_REQUEST)) {
00298 
00299             <a class="code" href="../../d0/d7/lpcp_8h.html#a12">LpcpPrint</a>(( <span class="stringliteral">"%s Attempted ReplyWaitReceive to Thread %lx (%s)\n"</span>,
00300                         <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;ImageFileName,
00301                         WakeupThread,
00302                         <a class="code" href="../../d1/d9/ps_8h.html#a17">THREAD_TO_PROCESS</a>( WakeupThread )-&gt;ImageFileName ));
00303 
00304             <a class="code" href="../../d0/d7/lpcp_8h.html#a12">LpcpPrint</a>(( <span class="stringliteral">"failed.  MessageId == %u  Client Id: %x.%x\n"</span>,
00305                         CapturedReplyMessage.MessageId,
00306                         CapturedReplyMessage.ClientId.UniqueProcess,
00307                         CapturedReplyMessage.ClientId.UniqueThread ));
00308 
00309             <a class="code" href="../../d0/d7/lpcp_8h.html#a12">LpcpPrint</a>(( <span class="stringliteral">"         Thread MessageId == %u  Client Id: %x.%x\n"</span>,
00310                         WakeupThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o15">LpcReplyMessageId</a>,
00311                         WakeupThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o12">Cid</a>.UniqueProcess,
00312                         WakeupThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o12">Cid</a>.UniqueThread ));
00313 
00314 <span class="preprocessor">#if DBG</span>
00315 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (LpcpStopOnReplyMismatch) {
00316 
00317                 DbgBreakPoint();
00318             }
00319 <span class="preprocessor">#endif</span>
00320 <span class="preprocessor"></span>
00321             <a class="code" href="../../d3/d7/lpcqueue_8c.html#a5">LpcpFreeToPortZone</a>( Msg, TRUE );
00322 
00323             <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
00324 
00325             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( WakeupThread );
00326             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( PortObject );
00327 
00328             <span class="keywordflow">return</span> STATUS_REPLY_MESSAGE_MISMATCH;
00329         }
00330 
00331         <span class="comment">//</span>
00332         <span class="comment">//  Copy the reply message to the request message buffer.  Do this before</span>
00333         <span class="comment">//  we actually fiddle with the wakeup threads fields.  Otherwise we</span>
00334         <span class="comment">//  could mess up its state</span>
00335         <span class="comment">//</span>
00336 
00337         <span class="keywordflow">try</span> {
00338 
00339             <a class="code" href="../../d0/d7/lpcp_8h.html#a31">LpcpMoveMessage</a>( &amp;Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>,
00340                              &amp;CapturedReplyMessage,
00341                              (ReplyMessage + 1),
00342                              LPC_REPLY,
00343                              NULL );
00344 
00345         } except( EXCEPTION_EXECUTE_HANDLER ) {
00346 
00347             <a class="code" href="../../d3/d7/lpcqueue_8c.html#a5">LpcpFreeToPortZone</a>( Msg, TRUE );
00348 
00349             <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
00350 
00351             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( WakeupThread );
00352             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( PortObject );
00353 
00354             <span class="keywordflow">return</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode());
00355         }
00356 
00357         <a class="code" href="../../d0/d7/lpcp_8h.html#a13">LpcpTrace</a>(( <span class="stringliteral">"%s Sending Reply Msg %lx (%u.%u, %x) [%08x %08x %08x %08x] to Thread %lx (%s)\n"</span>,
00358                     <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;ImageFileName,
00359                     Msg,
00360                     CapturedReplyMessage.MessageId,
00361                     CapturedReplyMessage.CallbackId,
00362                     CapturedReplyMessage.u2.s2.DataInfoOffset,
00363                     *((PULONG)(Msg+1)+0),
00364                     *((PULONG)(Msg+1)+1),
00365                     *((PULONG)(Msg+1)+2),
00366                     *((PULONG)(Msg+1)+3),
00367                     WakeupThread,
00368                     <a class="code" href="../../d1/d9/ps_8h.html#a17">THREAD_TO_PROCESS</a>( WakeupThread )-&gt;ImageFileName ));
00369 
00370         <span class="comment">//</span>
00371         <span class="comment">//  Locate and free the messsage from the port.  This call use to</span>
00372         <span class="comment">//  test for (CapturedReplyMessage.u2.s2.DataInfoOffset != 0) as a</span>
00373         <span class="comment">//  prerequisite for doing the call.</span>
00374         <span class="comment">//</span>
00375 
00376         <a class="code" href="../../d3/d7/lpcqueue_8c.html#a7">LpcpFreeDataInfoMessage</a>( PortObject,
00377                                  CapturedReplyMessage.MessageId,
00378                                  CapturedReplyMessage.CallbackId );
00379 
00380         <span class="comment">//</span>
00381         <span class="comment">//  Add an extra reference so LpcExitThread does not evaporate</span>
00382         <span class="comment">//  the pointer before we get to the wait below</span>
00383         <span class="comment">//</span>
00384 
00385         <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>( WakeupThread );
00386 
00387         <span class="comment">//</span>
00388         <span class="comment">//  Release the mutex that guards the LpcReplyMessage field</span>
00389         <span class="comment">//  after marking message as being replied to.</span>
00390         <span class="comment">//</span>
00391 
00392         Msg-&gt;RepliedToThread = WakeupThread;
00393 
00394         WakeupThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o15">LpcReplyMessageId</a> = 0;
00395         WakeupThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o14">LpcReplyMessage</a> = (PVOID)Msg;
00396 
00397         <span class="comment">//</span>
00398         <span class="comment">//  Remove the thread from the reply rundown list as we are sending the reply.</span>
00399         <span class="comment">//</span>
00400 
00401         <span class="keywordflow">if</span> (!WakeupThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o32">LpcExitThreadCalled</a> &amp;&amp; !IsListEmpty( &amp;WakeupThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o5">LpcReplyChain</a> )) {
00402 
00403             RemoveEntryList( &amp;WakeupThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o5">LpcReplyChain</a> );
00404 
00405             InitializeListHead( &amp;WakeupThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o5">LpcReplyChain</a> );
00406         }
00407 
00408         <span class="keywordflow">if</span> ((CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o34">LpcReceivedMsgIdValid</a>) &amp;&amp;
00409             (CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o31">LpcReceivedMessageId</a> == CapturedReplyMessage.MessageId)) {
00410 
00411             CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o31">LpcReceivedMessageId</a> = 0;
00412 
00413             CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o34">LpcReceivedMsgIdValid</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00414         }
00415 
00416         <a class="code" href="../../d0/d7/lpcp_8h.html#a13">LpcpTrace</a>(( <span class="stringliteral">"%s Waiting for message to Port %x (%s)\n"</span>,
00417                     <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;ImageFileName,
00418                     ReceivePort,
00419                     <a class="code" href="../../d0/d7/lpcp_8h.html#a33">LpcpGetCreatorName</a>( ReceivePort )));
00420 
00421         <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
00422 
00423         <span class="comment">//</span>
00424         <span class="comment">//  Wake up the thread that is waiting for an answer to its request</span>
00425         <span class="comment">//  inside of NtRequestWaitReplyPort or NtReplyWaitReplyPort</span>
00426         <span class="comment">//</span>
00427 
00428         <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>( &amp;WakeupThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o13">LpcReplySemaphore</a>,
00429                             1,
00430                             1,
00431                             FALSE );
00432 
00433         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( WakeupThread );
00434 
00435         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( ReceivePort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o4">MsgQueue</a>.<a class="code" href="../../d0/d5/struct__LPCP__PORT__QUEUE.html#o1">Semaphore</a>,
00436                                         WrLpcReceive,
00437                                         WaitMode,
00438                                         FALSE,
00439                                         NULL );
00440 
00441         <span class="comment">//</span>
00442         <span class="comment">//  Fall into receive code.  Client thread reference will be</span>
00443         <span class="comment">//  returned by the client when it wakes up.</span>
00444         <span class="comment">//</span>
00445 
00446     } <span class="keywordflow">else</span> {
00447 
00448         <span class="comment">//</span>
00449         <span class="comment">//  The user did not give us a reply message to send off</span>
00450         <span class="comment">//</span>
00451         <span class="comment">//  **** it looks like the only reason to have the then and else</span>
00452         <span class="comment">//       clause both do a wait it to have the lpcp trace denote</span>
00453         <span class="comment">//       the wait without a preceeding reply</span>
00454         <span class="comment">//</span>
00455         <span class="comment">//  Wait for a message</span>
00456         <span class="comment">//</span>
00457 
00458         <a class="code" href="../../d0/d7/lpcp_8h.html#a13">LpcpTrace</a>(( <span class="stringliteral">"%s Waiting for message to Port %x (%s)\n"</span>,
00459                     <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;ImageFileName,
00460                     ReceivePort,
00461                     <a class="code" href="../../d0/d7/lpcp_8h.html#a33">LpcpGetCreatorName</a>( ReceivePort )));
00462 
00463         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( ReceivePort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o4">MsgQueue</a>.<a class="code" href="../../d0/d5/struct__LPCP__PORT__QUEUE.html#o1">Semaphore</a>,
00464                                         WrLpcReceive,
00465                                         WaitMode,
00466                                         FALSE,
00467                                         NULL );
00468     }
00469 
00470     <span class="comment">//</span>
00471     <span class="comment">//  At this point we've awoke from our wait for a receive</span>
00472     <span class="comment">//</span>
00473 
00474     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS) {
00475 
00476         <a class="code" href="../../d0/d7/lpcp_8h.html#a3">LpcpAcquireLpcpLock</a>();
00477 
00478         <span class="comment">//</span>
00479         <span class="comment">//  See if we awoke without a message in our receive port</span>
00480         <span class="comment">//</span>
00481 
00482         <span class="keywordflow">if</span> (IsListEmpty( &amp;ReceivePort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o4">MsgQueue</a>.<a class="code" href="../../d0/d5/struct__LPCP__PORT__QUEUE.html#o2">ReceiveHead</a> )) {
00483 
00484             <span class="keywordflow">if</span> ( ReceivePort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o1">Flags</a> &amp; <a class="code" href="../../d2/d6/lpc_8h.html#a8">PORT_WAITABLE</a> ) {
00485 
00486                 <a class="code" href="../../d2/d8/eventobj_8c.html#a7">KeResetEvent</a>( &amp;ReceivePort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o18">WaitEvent</a> );
00487             }
00488 
00489             <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
00490 
00491             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( PortObject );
00492 
00493             <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
00494         }
00495 
00496         <span class="comment">//</span>
00497         <span class="comment">//  We have a message in our recieve port.  So let's pull it out</span>
00498         <span class="comment">//</span>
00499 
00500         Msg = (<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html">PLPCP_MESSAGE</a>)RemoveHeadList( &amp;ReceivePort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o4">MsgQueue</a>.<a class="code" href="../../d0/d5/struct__LPCP__PORT__QUEUE.html#o2">ReceiveHead</a> );
00501 
00502         <span class="keywordflow">if</span> ( IsListEmpty( &amp;ReceivePort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o4">MsgQueue</a>.<a class="code" href="../../d0/d5/struct__LPCP__PORT__QUEUE.html#o2">ReceiveHead</a>)) {
00503 
00504             <span class="keywordflow">if</span> ( ReceivePort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o1">Flags</a> &amp; <a class="code" href="../../d2/d6/lpc_8h.html#a8">PORT_WAITABLE</a> ) {
00505 
00506                 <a class="code" href="../../d2/d8/eventobj_8c.html#a7">KeResetEvent</a>( &amp;ReceivePort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o18">WaitEvent</a> );
00507             }
00508         }
00509 
00510         InitializeListHead( &amp;Msg-&gt;Entry );
00511 
00512         <a class="code" href="../../d0/d7/lpcp_8h.html#a13">LpcpTrace</a>(( <span class="stringliteral">"%s Receive Msg %lx (%u) from Port %lx (%s)\n"</span>,
00513                     <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;ImageFileName,
00514                     Msg,
00515                     Msg-&gt;Request.MessageId,
00516                     ReceivePort,
00517                     <a class="code" href="../../d7/d6/lpcinit_8c.html#a5">LpcpGetCreatorName</a>( ReceivePort )));
00518 
00519         <span class="comment">//</span>
00520         <span class="comment">//  Now make the thread state to be the message we're currently</span>
00521         <span class="comment">//  working on</span>
00522         <span class="comment">//</span>
00523 
00524         CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o31">LpcReceivedMessageId</a> = Msg-&gt;Request.MessageId;
00525         CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o34">LpcReceivedMsgIdValid</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00526 
00527         <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
00528 
00529         <span class="keywordflow">try</span> {
00530 
00531             <span class="comment">//</span>
00532             <span class="comment">//  Check if the message is a connection request</span>
00533             <span class="comment">//</span>
00534 
00535             <span class="keywordflow">if</span> ((Msg-&gt;Request.u2.s2.Type &amp; ~LPC_KERNELMODE_MESSAGE) == LPC_CONNECTION_REQUEST) {
00536 
00537                 <a class="code" href="../../d4/d4/struct__LPCP__CONNECTION__MESSAGE.html">PLPCP_CONNECTION_MESSAGE</a> ConnectMsg;
00538                 ULONG ConnectionInfoLength;
00539                 <a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html">PLPCP_MESSAGE</a> TempMsg;
00540 
00541                 ConnectMsg = (<a class="code" href="../../d4/d4/struct__LPCP__CONNECTION__MESSAGE.html">PLPCP_CONNECTION_MESSAGE</a>)(Msg + 1);
00542 
00543                 ConnectionInfoLength = Msg-&gt;Request.u1.s1.DataLength - <span class="keyword">sizeof</span>( *ConnectMsg );
00544 
00545                 <span class="comment">//</span>
00546                 <span class="comment">//  Dont free message until NtAcceptConnectPort called, and if it's never called</span>
00547                 <span class="comment">//  then we'll keep the message until the client exits.</span>
00548                 <span class="comment">//</span>
00549 
00550                 TempMsg = Msg;
00551                 Msg = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00552 
00553                 *ReceiveMessage = TempMsg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>;
00554 
00555                 ReceiveMessage-&gt;u1.s1.TotalLength = (CSHORT)(<span class="keyword">sizeof</span>( *ReceiveMessage ) + ConnectionInfoLength);
00556                 ReceiveMessage-&gt;u1.s1.DataLength = (CSHORT)ConnectionInfoLength;
00557 
00558                 RtlMoveMemory( ReceiveMessage+1,
00559                                ConnectMsg + 1,
00560                                ConnectionInfoLength );
00561 
00562                 <span class="keywordflow">if</span> (ARGUMENT_PRESENT( PortContext )) {
00563 
00564                     *PortContext = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00565                 }
00566 
00567             <span class="comment">//</span>
00568             <span class="comment">//  Check if the message is not a reply</span>
00569             <span class="comment">//</span>
00570 
00571             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((Msg-&gt;Request.u2.s2.Type &amp; ~LPC_KERNELMODE_MESSAGE) != LPC_REPLY) {
00572 
00573                 <a class="code" href="../../d0/d7/lpcp_8h.html#a31">LpcpMoveMessage</a>( ReceiveMessage,
00574                                  &amp;Msg-&gt;Request,
00575                                  (&amp;Msg-&gt;Request) + 1,
00576                                  0,
00577                                  NULL );
00578 
00579                 <span class="keywordflow">if</span> (ARGUMENT_PRESENT( PortContext )) {
00580 
00581                     *PortContext = Msg-&gt;PortContext;
00582                 }
00583 
00584                 <span class="comment">//</span>
00585                 <span class="comment">//  If message contains DataInfo for access via NtRead/WriteRequestData</span>
00586                 <span class="comment">//  then put the message on a list in the communication port and dont</span>
00587                 <span class="comment">//  free it.  It will be freed when the server replies to the message.</span>
00588                 <span class="comment">//</span>
00589 
00590                 <span class="keywordflow">if</span> (Msg-&gt;Request.u2.s2.DataInfoOffset != 0) {
00591 
00592                     <a class="code" href="../../d3/d7/lpcqueue_8c.html#a6">LpcpSaveDataInfoMessage</a>( PortObject, Msg );
00593                     Msg = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00594                 }
00595 
00596             <span class="comment">//</span>
00597             <span class="comment">//  Otherwise this is a reply message we just recieved</span>
00598             <span class="comment">//</span>
00599 
00600             } <span class="keywordflow">else</span> {
00601 
00602                 <a class="code" href="../../d0/d7/lpcp_8h.html#a12">LpcpPrint</a>(( <span class="stringliteral">"LPC: Bogus reply message (%08x) in receive queue of connection port %08x\n"</span>,
00603                             Msg, ReceivePort ));
00604 
00605                 KdBreakPoint();
00606             }
00607 
00608         } except( EXCEPTION_EXECUTE_HANDLER ) {
00609 
00610             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();    <span class="comment">// FIX, FIX</span>
00611         }
00612 
00613         <span class="comment">//</span>
00614         <span class="comment">//  Acquire the LPC mutex and decrement the reference count for the</span>
00615         <span class="comment">//  message.  If the reference count goes to zero the message will be</span>
00616         <span class="comment">//  deleted.</span>
00617         <span class="comment">//</span>
00618 
00619         <span class="keywordflow">if</span> (Msg != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00620 
00621             <a class="code" href="../../d3/d7/lpcqueue_8c.html#a5">LpcpFreeToPortZone</a>( Msg, FALSE );
00622         }
00623     }
00624 
00625     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( PortObject );
00626 
00627     <span class="comment">//</span>
00628     <span class="comment">//  And return to our caller</span>
00629     <span class="comment">//</span>
00630 
00631     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00632 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="lpcrecv.c::NtReplyWaitReceivePortEx" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtReplyWaitReceivePortEx           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>PortHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *PortContext&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PPORT_MESSAGE ReplyMessage&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PPORT_MESSAGE&nbsp;</td>
          <td class="mdname" nowrap> <em>ReceiveMessage</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER Timeout&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d6/lpcrecv_8c-source.html#l00635">635</a> of file <a class="el" href="../../d5/d6/lpcrecv_8c-source.html">lpcrecv.c</a>.
<p>
References <a class="el" href="../../d2/d8/ps_8h-source.html#l00388">_ETHREAD::Cid</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00134">CLIENT_COMMUNICATION_PORT</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00107">_LPCP_PORT_OBJECT::ConnectionPort</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00142">_LPCP_MESSAGE::Entry</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00106">_LPCP_PORT_OBJECT::Flags</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00639">IS_SYSTEM_THREAD</a>, <a class="el" href="../../d2/d5/semphobj_8c-source.html#l00118">KeReleaseSemaphore()</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00285">KeResetEvent()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00447">_ETHREAD::LpcExitThreadCalled</a>, <a class="el" href="../../d1/d6/lpcp_8h-source.html#l00093">LpcpAcquireLpcpLock</a>, <a class="el" href="../../d4/d6/lpcqueue_8c-source.html#l00558">LpcpAllocateFromPortZone()</a>, <a class="el" href="../../d4/d6/lpcqueue_8c-source.html#l00879">LpcpFreeDataInfoMessage()</a>, <a class="el" href="../../d4/d6/lpcqueue_8c-source.html#l00642">LpcpFreeToPortZone()</a>, <a class="el" href="../../d8/d5/lpcinit_8c-source.html#l00193">LpcpGetCreatorName()</a>, <a class="el" href="../../d0/d7/lpcp_8h.html#a31">LpcpMoveMessage()</a>, <a class="el" href="../../d1/d6/lpcp_8h-source.html#l00319">LpcpPrint</a>, <a class="el" href="../../d1/d6/lpcp_8h-source.html#l00278">LpcpReferencePortObject</a>, <a class="el" href="../../d1/d6/lpcp_8h-source.html#l00108">LpcpReleaseLpcpLock</a>, <a class="el" href="../../d4/d6/lpcqueue_8c-source.html#l00809">LpcpSaveDataInfoMessage()</a>, <a class="el" href="../../d1/d6/lpcp_8h-source.html#l00153">LpcpSaveThread</a>, <a class="el" href="../../d1/d6/lpcp_8h-source.html#l00320">LpcpTrace</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00445">_ETHREAD::LpcReceivedMessageId</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00449">_ETHREAD::LpcReceivedMsgIdValid</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00371">_ETHREAD::LpcReplyChain</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00395">_ETHREAD::LpcReplyMessage</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00396">_ETHREAD::LpcReplyMessageId</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00394">_ETHREAD::LpcReplySemaphore</a>, <a class="el" href="../../d0/d8/ntos_8h-source.html#l00092">LpcWaitablePortObjectType</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00109">_LPCP_PORT_OBJECT::MsgQueue</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00130">PORT_TYPE</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00135">PORT_WAITABLE</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00153">_LPCP_MESSAGE::PortContext</a>, <a class="el" href="../../d8/d6/uclient_8c-source.html#l00027">PortHandle</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01391">ProbeAndReadLargeInteger</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>, <a class="el" href="../../d0/d4/probe_8c-source.html#l00034">ProbeForWrite()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01649">ProbeForWriteUlong</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d2/d9/pscid_8c-source.html#l00027">PsLookupProcessThreadByCid()</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00081">_LPCP_PORT_QUEUE::ReceiveHead</a>, <a class="el" href="../../d4/d7/client_8c-source.html#l03425">ReplyMessage()</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00154">_LPCP_MESSAGE::Request</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00079">_LPCP_PORT_QUEUE::Semaphore</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00638">THREAD_TO_PROCESS</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00123">_LPCP_PORT_OBJECT::WaitEvent</a>, and <a class="el" href="../../d4/d9/ke_8h.html#a407a214">WrLpcReceive</a>.
<p>
Referenced by <a class="el" href="../../d8/d6/lpcsvr_8c-source.html#l00260">RtlpLpcServerCallback()</a>.
<p>
<pre class="fragment"><div>00645                    :
00646 
00647     See <a class="code" href="../../d4/d7/lpcrecv_8c.html#a0">NtReplyWaitReceivePort</a>.
00648 
00649 Arguments:
00650 
00651     See <a class="code" href="../../d4/d7/lpcrecv_8c.html#a0">NtReplyWaitReceivePort</a>.
00652 
00653     Timeout - Supplies an optional timeout value to use when waiting <span class="keywordflow">for</span> a
00654         receive.
00655 
00656 Return Value:
00657 
00658     See <a class="code" href="../../d4/d7/lpcrecv_8c.html#a0">NtReplyWaitReceivePort</a>.
00659 
00660 --*/
00661 
00662 {
00663     <a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html">PLPCP_PORT_OBJECT</a> PortObject;
00664     <a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html">PLPCP_PORT_OBJECT</a> ReceivePort;
00665     PORT_MESSAGE CapturedReplyMessage;
00666     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00667     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> WaitMode;
00668     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00669     <a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html">PLPCP_MESSAGE</a> Msg;
00670     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> CurrentThread;
00671     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> WakeupThread;
00672     LARGE_INTEGER TimeoutValue ;
00673 
00674     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00675 
00676     CurrentThread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00677 
00678     TimeoutValue.QuadPart = 0 ;
00679 
00680     <span class="comment">//</span>
00681     <span class="comment">//  Get previous processor mode</span>
00682     <span class="comment">//</span>
00683 
00684     PreviousMode = KeGetPreviousMode();
00685     WaitMode = PreviousMode;
00686 
00687     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00688 
00689         <span class="keywordflow">try</span> {
00690 
00691             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( PortContext )) {
00692 
00693                 <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>( (PULONG)PortContext );
00694             }
00695 
00696             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ReplyMessage)) {
00697 
00698                 <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( ReplyMessage,
00699                               <span class="keyword">sizeof</span>( *ReplyMessage ),
00700                               <span class="keyword">sizeof</span>( ULONG ));
00701 
00702                 CapturedReplyMessage = *<a class="code" href="../../d3/d8/client_8c.html#a125">ReplyMessage</a>;
00703             }
00704 
00705             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( Timeout )) {
00706 
00707                 TimeoutValue = <a class="code" href="../../d5/d8/ex_8h.html#a24">ProbeAndReadLargeInteger</a>( Timeout );
00708 
00709                 Timeout = &amp;TimeoutValue ;
00710             }
00711 
00712             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>( ReceiveMessage,
00713                            <span class="keyword">sizeof</span>( *ReceiveMessage ),
00714                            <span class="keyword">sizeof</span>( ULONG ));
00715 
00716         } except( EXCEPTION_EXECUTE_HANDLER ) {
00717 
00718             <span class="keywordflow">return</span> GetExceptionCode();
00719         }
00720 
00721     } <span class="keywordflow">else</span> {
00722 
00723         <span class="comment">//</span>
00724         <span class="comment">//  Kernel mode threads call with wait mode of user so that their</span>
00725         <span class="comment">//  kernel // stacks are swappable. Main consumer of this is</span>
00726         <span class="comment">//  SepRmCommandThread</span>
00727         <span class="comment">//</span>
00728 
00729         <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d9/ps_8h.html#a18">IS_SYSTEM_THREAD</a>(CurrentThread) ) {
00730 
00731             WaitMode = <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>;
00732         }
00733 
00734         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ReplyMessage)) {
00735 
00736             CapturedReplyMessage = *<a class="code" href="../../d3/d8/client_8c.html#a125">ReplyMessage</a>;
00737         }
00738     }
00739 
00740     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ReplyMessage)) {
00741 
00742         <span class="comment">//</span>
00743         <span class="comment">//  Make sure DataLength is valid with respect to header size and total</span>
00744         <span class="comment">//  length</span>
00745         <span class="comment">//</span>
00746 
00747         <span class="keywordflow">if</span> ((((CLONG)CapturedReplyMessage.u1.s1.DataLength) + <span class="keyword">sizeof</span>( PORT_MESSAGE )) &gt;
00748             ((CLONG)CapturedReplyMessage.u1.s1.TotalLength)) {
00749 
00750             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00751         }
00752 
00753         <span class="comment">//</span>
00754         <span class="comment">//  Make sure the user didn't give us a bogus reply message id</span>
00755         <span class="comment">//</span>
00756 
00757         <span class="keywordflow">if</span> (CapturedReplyMessage.MessageId == 0) {
00758 
00759             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00760         }
00761     }
00762 
00763     <span class="comment">//</span>
00764     <span class="comment">//  Reference the port object by handle and if that doesn't work try</span>
00765     <span class="comment">//  a waitable port object type</span>
00766     <span class="comment">//</span>
00767 
00768     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d7/lpcp_8h.html#a10">LpcpReferencePortObject</a>( PortHandle,
00769                                       0,
00770                                       PreviousMode,
00771                                       &amp;PortObject );
00772 
00773     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00774 
00775         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( PortHandle,
00776                                             0,
00777                                             LpcWaitablePortObjectType,
00778                                             PreviousMode,
00779                                             &amp;PortObject,
00780                                             NULL );
00781 
00782         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) ) {
00783 
00784             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00785         }
00786     }
00787 
00788     <a class="code" href="../../d0/d7/lpcp_8h.html#a7">LpcpSaveThread</a> (PortObject);
00789 
00790     <span class="comment">//</span>
00791     <span class="comment">//  The receive port we use is either the connection port for the port</span>
00792     <span class="comment">//  object we were given if we were given a client communication port then</span>
00793     <span class="comment">//  we expect to recieve the reply on the communication port itself.</span>
00794     <span class="comment">//</span>
00795 
00796     <span class="keywordflow">if</span> ((PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o1">Flags</a> &amp; <a class="code" href="../../d2/d6/lpc_8h.html#a3">PORT_TYPE</a>) != <a class="code" href="../../d2/d6/lpc_8h.html#a7">CLIENT_COMMUNICATION_PORT</a>) {
00797 
00798         ReceivePort = PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o2">ConnectionPort</a>;
00799 
00800     } <span class="keywordflow">else</span> {
00801 
00802         ReceivePort = PortObject;
00803     }
00804 
00805     <span class="comment">//</span>
00806     <span class="comment">//  If ReplyMessage argument present, then send reply</span>
00807     <span class="comment">//</span>
00808 
00809     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ReplyMessage )) {
00810 
00811         <span class="comment">//</span>
00812         <span class="comment">//  Translate the ClientId from the connection request into a</span>
00813         <span class="comment">//  thread pointer.  This is a referenced pointer to keep the thread</span>
00814         <span class="comment">//  from evaporating out from under us.</span>
00815         <span class="comment">//</span>
00816 
00817         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d0/pscid_8c.html#a0">PsLookupProcessThreadByCid</a>( &amp;CapturedReplyMessage.ClientId,
00818                                              NULL,
00819                                              &amp;WakeupThread );
00820 
00821         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00822 
00823             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( PortObject );
00824             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00825         }
00826 
00827         <span class="comment">//</span>
00828         <span class="comment">//  Acquire the global Lpc mutex that gaurds the LpcReplyMessage</span>
00829         <span class="comment">//  field of the thread and get the pointer to the message that</span>
00830         <span class="comment">//  the thread is waiting for a reply to.</span>
00831         <span class="comment">//</span>
00832 
00833         <a class="code" href="../../d0/d7/lpcp_8h.html#a3">LpcpAcquireLpcpLock</a>();
00834 
00835         Msg = (<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html">PLPCP_MESSAGE</a>)<a class="code" href="../../d3/d7/lpcqueue_8c.html#a4">LpcpAllocateFromPortZone</a>( CapturedReplyMessage.u1.s1.TotalLength );
00836 
00837         <span class="keywordflow">if</span> (Msg == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00838 
00839             <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
00840 
00841             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( WakeupThread );
00842             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( PortObject );
00843 
00844             <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00845         }
00846 
00847         <span class="comment">//</span>
00848         <span class="comment">//  See if the thread is waiting for a reply to the message</span>
00849         <span class="comment">//  specified on this call.  If not then a bogus message</span>
00850         <span class="comment">//  has been specified, so release the mutex, dereference the thread</span>
00851         <span class="comment">//  and return failure.</span>
00852         <span class="comment">//</span>
00853         <span class="comment">//  We also fail this request if the caller isn't replying to a request</span>
00854         <span class="comment">//  message.  For example, if the caller is replying to a connection</span>
00855         <span class="comment">//  request</span>
00856         <span class="comment">//</span>
00857 
00858         <span class="keywordflow">if</span> ((WakeupThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o15">LpcReplyMessageId</a> != CapturedReplyMessage.MessageId)
00859 
00860                 ||
00861 
00862             ((WakeupThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o14">LpcReplyMessage</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00863              (((<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html">PLPCP_MESSAGE</a>)(WakeupThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o14">LpcReplyMessage</a>))-&gt;Request.u2.s2.Type &amp; ~LPC_KERNELMODE_MESSAGE) != LPC_REQUEST)) {
00864 
00865             <a class="code" href="../../d0/d7/lpcp_8h.html#a12">LpcpPrint</a>(( <span class="stringliteral">"%s Attempted ReplyWaitReceive to Thread %lx (%s)\n"</span>,
00866                         <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;ImageFileName,
00867                         WakeupThread,
00868                         <a class="code" href="../../d1/d9/ps_8h.html#a17">THREAD_TO_PROCESS</a>( WakeupThread )-&gt;ImageFileName ));
00869 
00870             <a class="code" href="../../d0/d7/lpcp_8h.html#a12">LpcpPrint</a>(( <span class="stringliteral">"failed.  MessageId == %u  Client Id: %x.%x\n"</span>,
00871                         CapturedReplyMessage.MessageId,
00872                         CapturedReplyMessage.ClientId.UniqueProcess,
00873                         CapturedReplyMessage.ClientId.UniqueThread ));
00874 
00875             <a class="code" href="../../d0/d7/lpcp_8h.html#a12">LpcpPrint</a>(( <span class="stringliteral">"         Thread MessageId == %u  Client Id: %x.%x\n"</span>,
00876                         WakeupThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o15">LpcReplyMessageId</a>,
00877                         WakeupThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o12">Cid</a>.UniqueProcess,
00878                         WakeupThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o12">Cid</a>.UniqueThread ));
00879 
00880 <span class="preprocessor">#if DBG</span>
00881 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (LpcpStopOnReplyMismatch) {
00882 
00883                 DbgBreakPoint();
00884             }
00885 <span class="preprocessor">#endif</span>
00886 <span class="preprocessor"></span>
00887             <a class="code" href="../../d3/d7/lpcqueue_8c.html#a5">LpcpFreeToPortZone</a>( Msg, TRUE );
00888 
00889             <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
00890 
00891             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( WakeupThread );
00892             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( PortObject );
00893 
00894             <span class="keywordflow">return</span> STATUS_REPLY_MESSAGE_MISMATCH;
00895         }
00896 
00897         <span class="comment">//</span>
00898         <span class="comment">//  Copy the reply message to the request message buffer.  Do this before</span>
00899         <span class="comment">//  we actually fiddle with the wakeup threads fields.  Otherwise we</span>
00900         <span class="comment">//  could mess up its state</span>
00901         <span class="comment">//</span>
00902 
00903         <span class="keywordflow">try</span> {
00904 
00905             <a class="code" href="../../d0/d7/lpcp_8h.html#a31">LpcpMoveMessage</a>( &amp;Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>,
00906                              &amp;CapturedReplyMessage,
00907                              (ReplyMessage + 1),
00908                              LPC_REPLY,
00909                              NULL );
00910 
00911         } except( EXCEPTION_EXECUTE_HANDLER ) {
00912 
00913             <a class="code" href="../../d3/d7/lpcqueue_8c.html#a5">LpcpFreeToPortZone</a>( Msg, TRUE );
00914 
00915             <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
00916 
00917             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( WakeupThread );
00918             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( PortObject );
00919 
00920             <span class="keywordflow">return</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode());
00921         }
00922 
00923         <a class="code" href="../../d0/d7/lpcp_8h.html#a13">LpcpTrace</a>(( <span class="stringliteral">"%s Sending Reply Msg %lx (%u.%u, %x) [%08x %08x %08x %08x] to Thread %lx (%s)\n"</span>,
00924                     <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;ImageFileName,
00925                     Msg,
00926                     CapturedReplyMessage.MessageId,
00927                     CapturedReplyMessage.CallbackId,
00928                     CapturedReplyMessage.u2.s2.DataInfoOffset,
00929                     *((PULONG)(Msg+1)+0),
00930                     *((PULONG)(Msg+1)+1),
00931                     *((PULONG)(Msg+1)+2),
00932                     *((PULONG)(Msg+1)+3),
00933                     WakeupThread,
00934                     <a class="code" href="../../d1/d9/ps_8h.html#a17">THREAD_TO_PROCESS</a>( WakeupThread )-&gt;ImageFileName ));
00935 
00936         <span class="comment">//</span>
00937         <span class="comment">//  Locate and free the messsage from the port.  This call use to</span>
00938         <span class="comment">//  test for (CapturedReplyMessage.u2.s2.DataInfoOffset != 0) as a</span>
00939         <span class="comment">//  prerequisite for doing the call.</span>
00940         <span class="comment">//</span>
00941 
00942         <a class="code" href="../../d3/d7/lpcqueue_8c.html#a7">LpcpFreeDataInfoMessage</a>( PortObject,
00943                                  CapturedReplyMessage.MessageId,
00944                                  CapturedReplyMessage.CallbackId );
00945 
00946         <span class="comment">//</span>
00947         <span class="comment">//  Add an extra reference so LpcExitThread does not evaporate</span>
00948         <span class="comment">//  the pointer before we get to the wait below</span>
00949         <span class="comment">//</span>
00950 
00951         <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>( WakeupThread );
00952 
00953         <span class="comment">//</span>
00954         <span class="comment">//  Release the mutex that guards the LpcReplyMessage field</span>
00955         <span class="comment">//  after marking message as being replied to.</span>
00956         <span class="comment">//</span>
00957 
00958         Msg-&gt;RepliedToThread = WakeupThread;
00959 
00960         WakeupThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o15">LpcReplyMessageId</a> = 0;
00961         WakeupThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o14">LpcReplyMessage</a> = (PVOID)Msg;
00962 
00963         <span class="comment">//</span>
00964         <span class="comment">//  Remove the thread from the reply rundown list as we are sending the reply.</span>
00965         <span class="comment">//</span>
00966 
00967         <span class="keywordflow">if</span> ((!WakeupThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o32">LpcExitThreadCalled</a>) &amp;&amp; (!IsListEmpty( &amp;WakeupThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o5">LpcReplyChain</a> ))) {
00968 
00969             RemoveEntryList( &amp;WakeupThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o5">LpcReplyChain</a> );
00970 
00971             InitializeListHead( &amp;WakeupThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o5">LpcReplyChain</a> );
00972         }
00973 
00974         <span class="keywordflow">if</span> ((CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o34">LpcReceivedMsgIdValid</a>) &amp;&amp;
00975             (CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o31">LpcReceivedMessageId</a> == CapturedReplyMessage.MessageId)) {
00976 
00977             CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o31">LpcReceivedMessageId</a> = 0;
00978 
00979             CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o34">LpcReceivedMsgIdValid</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00980         }
00981 
00982         <a class="code" href="../../d0/d7/lpcp_8h.html#a13">LpcpTrace</a>(( <span class="stringliteral">"%s Waiting for message to Port %x (%s)\n"</span>,
00983                     <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;ImageFileName,
00984                     ReceivePort,
00985                     <a class="code" href="../../d0/d7/lpcp_8h.html#a33">LpcpGetCreatorName</a>( ReceivePort )));
00986 
00987         <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
00988 
00989         <span class="comment">//</span>
00990         <span class="comment">//  Wake up the thread that is waiting for an answer to its request</span>
00991         <span class="comment">//  inside of NtRequestWaitReplyPort or NtReplyWaitReplyPort</span>
00992         <span class="comment">//</span>
00993 
00994         <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>( &amp;WakeupThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o13">LpcReplySemaphore</a>,
00995                             1,
00996                             1,
00997                             FALSE );
00998 
00999         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( WakeupThread );
01000 
01001         <span class="comment">//</span>
01002         <span class="comment">//  **** the timeout on this wait and the next wait appear to be the</span>
01003         <span class="comment">//       only substantial difference between NtReplyWaitReceivePort</span>
01004         <span class="comment">//       and NtReplyWaitReceivePortEx</span>
01005 
01006         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( ReceivePort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o4">MsgQueue</a>.<a class="code" href="../../d0/d5/struct__LPCP__PORT__QUEUE.html#o1">Semaphore</a>,
01007                                         WrLpcReceive,
01008                                         WaitMode,
01009                                         FALSE,
01010                                         Timeout );
01011 
01012         <span class="comment">//</span>
01013         <span class="comment">//  Fall into receive code.  Client thread reference will be</span>
01014         <span class="comment">//  returned by the client when it wakes up.</span>
01015         <span class="comment">//</span>
01016 
01017     } <span class="keywordflow">else</span> {
01018 
01019         <span class="comment">//</span>
01020         <span class="comment">//  The user did not give us a reply message to send off</span>
01021         <span class="comment">//</span>
01022         <span class="comment">//  **** it looks like the only reason to have the then and else</span>
01023         <span class="comment">//       clause both do a wait it to have the lpcp trace denote</span>
01024         <span class="comment">//       the wait without a preceeding reply</span>
01025         <span class="comment">//</span>
01026         <span class="comment">//  Wait for a message</span>
01027         <span class="comment">//</span>
01028 
01029         <a class="code" href="../../d0/d7/lpcp_8h.html#a13">LpcpTrace</a>(( <span class="stringliteral">"%s Waiting for message to Port %x (%s)\n"</span>,
01030                     <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;ImageFileName,
01031                     ReceivePort,
01032                     <a class="code" href="../../d0/d7/lpcp_8h.html#a33">LpcpGetCreatorName</a>( ReceivePort )));
01033 
01034         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( ReceivePort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o4">MsgQueue</a>.<a class="code" href="../../d0/d5/struct__LPCP__PORT__QUEUE.html#o1">Semaphore</a>,
01035                                         WrLpcReceive,
01036                                         WaitMode,
01037                                         FALSE,
01038                                         Timeout );
01039     }
01040 
01041     <span class="comment">//</span>
01042     <span class="comment">//  At this point we've awoke from our wait for a receive</span>
01043     <span class="comment">//</span>
01044 
01045     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS) {
01046 
01047         <a class="code" href="../../d0/d7/lpcp_8h.html#a3">LpcpAcquireLpcpLock</a>();
01048 
01049         <span class="comment">//</span>
01050         <span class="comment">//  See if we awoke without a message in our receive port</span>
01051         <span class="comment">//</span>
01052 
01053         <span class="keywordflow">if</span> (IsListEmpty( &amp;ReceivePort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o4">MsgQueue</a>.<a class="code" href="../../d0/d5/struct__LPCP__PORT__QUEUE.html#o2">ReceiveHead</a> )) {
01054 
01055             <span class="keywordflow">if</span> ( ReceivePort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o1">Flags</a> &amp; <a class="code" href="../../d2/d6/lpc_8h.html#a8">PORT_WAITABLE</a> ) {
01056 
01057                 <a class="code" href="../../d2/d8/eventobj_8c.html#a7">KeResetEvent</a>( &amp;ReceivePort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o18">WaitEvent</a> );
01058             }
01059 
01060             <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
01061 
01062             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( PortObject );
01063 
01064             <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
01065         }
01066 
01067         <span class="comment">//</span>
01068         <span class="comment">//  We have a message in our recieve port.  So let's pull it out</span>
01069         <span class="comment">//</span>
01070 
01071         Msg = (<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html">PLPCP_MESSAGE</a>)RemoveHeadList( &amp;ReceivePort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o4">MsgQueue</a>.<a class="code" href="../../d0/d5/struct__LPCP__PORT__QUEUE.html#o2">ReceiveHead</a> );
01072 
01073         <span class="keywordflow">if</span> ( IsListEmpty( &amp;ReceivePort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o4">MsgQueue</a>.<a class="code" href="../../d0/d5/struct__LPCP__PORT__QUEUE.html#o2">ReceiveHead</a> ) ) {
01074 
01075             <span class="keywordflow">if</span> ( ReceivePort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o1">Flags</a> &amp; <a class="code" href="../../d2/d6/lpc_8h.html#a8">PORT_WAITABLE</a> ) {
01076 
01077                 <a class="code" href="../../d2/d8/eventobj_8c.html#a7">KeResetEvent</a>( &amp;ReceivePort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o18">WaitEvent</a> );
01078             }
01079         }
01080 
01081         InitializeListHead( &amp;Msg-&gt;Entry );
01082 
01083         <a class="code" href="../../d0/d7/lpcp_8h.html#a13">LpcpTrace</a>(( <span class="stringliteral">"%s Receive Msg %lx (%u) from Port %lx (%s)\n"</span>,
01084                     <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;ImageFileName,
01085                     Msg,
01086                     Msg-&gt;Request.MessageId,
01087                     ReceivePort,
01088                     <a class="code" href="../../d7/d6/lpcinit_8c.html#a5">LpcpGetCreatorName</a>( ReceivePort )));
01089 
01090         <span class="comment">//</span>
01091         <span class="comment">//  Now make the thread state to be the message we're currently</span>
01092         <span class="comment">//  working on</span>
01093         <span class="comment">//</span>
01094 
01095         CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o31">LpcReceivedMessageId</a> = Msg-&gt;Request.MessageId;
01096         CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o34">LpcReceivedMsgIdValid</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01097 
01098         <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
01099 
01100         <span class="keywordflow">try</span> {
01101 
01102             <span class="comment">//</span>
01103             <span class="comment">//  Check if the message is a connection request</span>
01104             <span class="comment">//</span>
01105 
01106             <span class="keywordflow">if</span> ((Msg-&gt;Request.u2.s2.Type &amp; ~LPC_KERNELMODE_MESSAGE) == LPC_CONNECTION_REQUEST) {
01107 
01108                 <a class="code" href="../../d4/d4/struct__LPCP__CONNECTION__MESSAGE.html">PLPCP_CONNECTION_MESSAGE</a> ConnectMsg;
01109                 ULONG ConnectionInfoLength;
01110                 <a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html">PLPCP_MESSAGE</a> TempMsg;
01111 
01112                 ConnectMsg = (<a class="code" href="../../d4/d4/struct__LPCP__CONNECTION__MESSAGE.html">PLPCP_CONNECTION_MESSAGE</a>)(Msg + 1);
01113 
01114                 ConnectionInfoLength = Msg-&gt;Request.u1.s1.DataLength - <span class="keyword">sizeof</span>( *ConnectMsg );
01115 
01116                 <span class="comment">//</span>
01117                 <span class="comment">//  Dont free message until NtAcceptConnectPort called, and if it's never called</span>
01118                 <span class="comment">//  then we'll keep the message until the client exits.</span>
01119                 <span class="comment">//</span>
01120 
01121                 TempMsg = Msg;
01122                 Msg = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01123 
01124                 *ReceiveMessage = TempMsg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>;
01125 
01126                 ReceiveMessage-&gt;u1.s1.TotalLength = (CSHORT)(<span class="keyword">sizeof</span>( *ReceiveMessage ) + ConnectionInfoLength);
01127                 ReceiveMessage-&gt;u1.s1.DataLength = (CSHORT)ConnectionInfoLength;
01128 
01129                 RtlMoveMemory( ReceiveMessage+1,
01130                                ConnectMsg + 1,
01131                                ConnectionInfoLength );
01132 
01133                 <span class="keywordflow">if</span> (ARGUMENT_PRESENT( PortContext )) {
01134 
01135                     *PortContext = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01136                 }
01137 
01138             <span class="comment">//</span>
01139             <span class="comment">//  Check if the message is not a reply</span>
01140             <span class="comment">//</span>
01141 
01142             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((Msg-&gt;Request.u2.s2.Type &amp; ~LPC_KERNELMODE_MESSAGE) != LPC_REPLY) {
01143 
01144                 <a class="code" href="../../d0/d7/lpcp_8h.html#a31">LpcpMoveMessage</a>( ReceiveMessage,
01145                                  &amp;Msg-&gt;Request,
01146                                  (&amp;Msg-&gt;Request) + 1,
01147                                  0,
01148                                  NULL );
01149 
01150                 <span class="keywordflow">if</span> (ARGUMENT_PRESENT( PortContext )) {
01151 
01152                     *PortContext = Msg-&gt;PortContext;
01153                 }
01154 
01155                 <span class="comment">//</span>
01156                 <span class="comment">//  If message contains DataInfo for access via NtRead/WriteRequestData</span>
01157                 <span class="comment">//  then put the message on a list in the communication port and dont</span>
01158                 <span class="comment">//  free it.  It will be freed when the server replies to the message.</span>
01159                 <span class="comment">//</span>
01160 
01161                 <span class="keywordflow">if</span> (Msg-&gt;Request.u2.s2.DataInfoOffset != 0) {
01162 
01163                     <a class="code" href="../../d3/d7/lpcqueue_8c.html#a6">LpcpSaveDataInfoMessage</a>( PortObject, Msg );
01164                     Msg = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01165                 }
01166 
01167             <span class="comment">//</span>
01168             <span class="comment">//  Otherwise this is a reply message we just recieved</span>
01169             <span class="comment">//</span>
01170 
01171             } <span class="keywordflow">else</span> {
01172 
01173                 <a class="code" href="../../d0/d7/lpcp_8h.html#a12">LpcpPrint</a>(( <span class="stringliteral">"LPC: Bogus reply message (%08x) in receive queue of connection port %08x\n"</span>,
01174                             Msg, ReceivePort ));
01175 
01176                 KdBreakPoint();
01177             }
01178 
01179         } except( EXCEPTION_EXECUTE_HANDLER ) {
01180 
01181             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();    <span class="comment">// FIX, FIX</span>
01182         }
01183 
01184         <span class="comment">//</span>
01185         <span class="comment">//  Acquire the LPC mutex and decrement the reference count for the</span>
01186         <span class="comment">//  message.  If the reference count goes to zero the message will be</span>
01187         <span class="comment">//  deleted.</span>
01188         <span class="comment">//</span>
01189 
01190         <span class="keywordflow">if</span> (Msg != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01191 
01192             <a class="code" href="../../d3/d7/lpcqueue_8c.html#a5">LpcpFreeToPortZone</a>( Msg, FALSE );
01193         }
01194     }
01195 
01196     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( PortObject );
01197 
01198     <span class="comment">//</span>
01199     <span class="comment">//  And return to our caller</span>
01200     <span class="comment">//</span>
01201 
01202     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01203 }
}
</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:34 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
