<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: create.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>create.c</h1><a href="../../d3/d8/udfs_2create_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    Create.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements the File Create routine for Udfs called by the</span>
00012 <span class="comment">    Fsd/Fsp dispatch routines.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Dan Lovinger    [DanLo]     9-October-1996</span>
00017 <span class="comment"></span>
00018 <span class="comment">Revision History:</span>
00019 <span class="comment"></span>
00020 <span class="comment">--*/</span>
00021 
00022 <span class="preprocessor">#include "UdfProcs.h"</span>
00023 
00024 <span class="comment">//</span>
00025 <span class="comment">//  The Bug check file id for this module</span>
00026 <span class="comment">//</span>
00027 
<a name="l00028"></a><a class="code" href="../../d3/d8/udfs_2create_8c.html#a0">00028</a> <span class="preprocessor">#define BugCheckFileId                   (UDFS_BUG_CHECK_CREATE)</span>
00029 <span class="preprocessor"></span>
00030 <span class="comment">//</span>
00031 <span class="comment">//  The local debug trace level</span>
00032 <span class="comment">//</span>
00033 
<a name="l00034"></a><a class="code" href="../../d3/d8/udfs_2create_8c.html#a1">00034</a> <span class="preprocessor">#define Dbg                              (UDFS_DEBUG_LEVEL_CREATE)</span>
00035 <span class="preprocessor"></span>
00036 <span class="comment">//</span>
00037 <span class="comment">//  Local support routines</span>
00038 <span class="comment">//</span>
00039 
00040 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00041 <a class="code" href="../../d3/d8/udfs_2create_8c.html#a2">UdfNormalizeFileNames</a> (
00042     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00043     IN <a class="code" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb,
00044     IN BOOLEAN OpenByFileId,
00045     IN BOOLEAN IgnoreCase,
00046     IN TYPE_OF_OPEN RelatedTypeOfOpen,
00047     IN <a class="code" href="../../d2/d9/struct__CCB.html">PCCB</a> RelatedCcb OPTIONAL,
00048     IN PUNICODE_STRING RelatedFileName OPTIONAL,
00049     IN OUT PUNICODE_STRING FileName,
00050     IN OUT PUNICODE_STRING RemainingName
00051     );
00052 
00053 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00054 <a class="code" href="../../d3/d8/udfs_2create_8c.html#a3">UdfOpenExistingFcb</a> (
00055     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00056     IN <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp,
00057     IN OUT <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> *CurrentFcb,
00058     IN <a class="code" href="../../d5/d9/struct__LCB.html">PLCB</a> OpenLcb,
00059     IN TYPE_OF_OPEN TypeOfOpen,
00060     IN BOOLEAN IgnoreCase,
00061     IN <a class="code" href="../../d2/d9/struct__CCB.html">PCCB</a> RelatedCcb OPTIONAL
00062     );
00063 
00064 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00065 <a class="code" href="../../d3/d8/udfs_2create_8c.html#a4">UdfOpenObjectByFileId</a> (
00066     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00067     IN <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp,
00068     IN <a class="code" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb,
00069     IN OUT <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> *CurrentFcb
00070     );
00071 
00072 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00073 <a class="code" href="../../d3/d8/udfs_2create_8c.html#a5">UdfOpenObjectFromDirContext</a> (
00074     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00075     IN <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp,
00076     IN <a class="code" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb,
00077     IN OUT <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> *CurrentFcb,
00078     IN BOOLEAN ShortNameMatch,                             
00079     IN BOOLEAN IgnoreCase,
00080     IN <a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html">PDIR_ENUM_CONTEXT</a> DirContext,
00081     IN BOOLEAN PerformUserOpen,
00082     IN <a class="code" href="../../d2/d9/struct__CCB.html">PCCB</a> RelatedCcb OPTIONAL
00083     );
00084 
00085 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00086 <a class="code" href="../../d3/d8/udfs_2create_8c.html#a6">UdfCompleteFcbOpen</a> (
00087     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00088     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp,
00089     IN <a class="code" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb,
00090     IN OUT <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> *CurrentFcb,
00091     IN <a class="code" href="../../d5/d9/struct__LCB.html">PLCB</a> OpenLcb,
00092     IN TYPE_OF_OPEN TypeOfOpen,
00093     IN ULONG UserCcbFlags,
00094     IN ACCESS_MASK DesiredAccess
00095     );
00096 
00097 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00098 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, UdfCommonCreate)</span>
00099 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, UdfCompleteFcbOpen)</span>
00100 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, UdfNormalizeFileNames)</span>
00101 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, UdfOpenObjectByFileId)</span>
00102 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, UdfOpenExistingFcb)</span>
00103 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, UdfOpenObjectFromDirContext)</span>
00104 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00105 <span class="preprocessor"></span>
00106 
00107 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00108"></a><a class="code" href="../../d3/d8/udfprocs_8h.html#a253">00108</a> <a class="code" href="../../d3/d8/udfprocs_8h.html#a253">UdfCommonCreate</a> (
00109     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00110     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp
00111     )
00112 
00113 <span class="comment">/*++</span>
00114 <span class="comment"></span>
00115 <span class="comment">Routine Description:</span>
00116 <span class="comment"></span>
00117 <span class="comment">    This is the common routine for opening a file called by both the</span>
00118 <span class="comment">    Fsp and Fsd threads.</span>
00119 <span class="comment"></span>
00120 <span class="comment">    The file can be opened either by name or by file Id either with or without</span>
00121 <span class="comment">    a relative name.  The file name field in the file object passed to this routine</span>
00122 <span class="comment">    contains either a unicode string or a 64 bit value which is the file Id.</span>
00123 <span class="comment">    If there is a related file object with a name then we will already have converted</span>
00124 <span class="comment">    that name to Oem. </span>
00125 <span class="comment"></span>
00126 <span class="comment">    We will store the full name for the file in the file object on a successful</span>
00127 <span class="comment">    open.  We will allocate a larger buffer if necessary and combine the</span>
00128 <span class="comment">    related and file object names.  The only exception is the relative open</span>
00129 <span class="comment">    when the related file object is for an OpenByFileId file.  If we need to</span>
00130 <span class="comment">    allocate a buffer for a case insensitive name then we allocate it at</span>
00131 <span class="comment">    the tail of the buffer we will store into the file object.  The upcased</span>
00132 <span class="comment">    portion will begin immediately after the name defined by the FileName</span>
00133 <span class="comment">    in the file object.</span>
00134 <span class="comment"></span>
00135 <span class="comment">    Once we have the full name in the file object we don't want to split the</span>
00136 <span class="comment">    name in the event of a retry.  We use a flag in the IrpContext to indicate</span>
00137 <span class="comment">    that the name has been split.</span>
00138 <span class="comment"></span>
00139 <span class="comment">Arguments:</span>
00140 <span class="comment"></span>
00141 <span class="comment">    Irp - Supplies the Irp to process</span>
00142 <span class="comment"></span>
00143 <span class="comment">Return Value:</span>
00144 <span class="comment"></span>
00145 <span class="comment">    NTSTATUS - This is the status from this open operation.</span>
00146 <span class="comment"></span>
00147 <span class="comment">--*/</span>
00148 
00149 {
00150     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00151     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00152 
00153     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject;
00154 
00155     <a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html">DIR_ENUM_CONTEXT</a> DirContext;
00156     BOOLEAN CleanupDirContext = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00157 
00158     BOOLEAN FoundEntry;
00159 
00160     <a class="code" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb;
00161 
00162     BOOLEAN OpenByFileId;
00163     BOOLEAN IgnoreCase;
00164     ULONG CreateDisposition;
00165 
00166     BOOLEAN ShortNameMatch;
00167 
00168     BOOLEAN VolumeOpen = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00169 
00170     <span class="comment">//</span>
00171     <span class="comment">//  We will be acquiring and releasing file Fcb's as we move down the</span>
00172     <span class="comment">//  directory tree during opens.  At any time we need to know the deepest</span>
00173     <span class="comment">//  point we have traversed down in the tree in case we need to cleanup</span>
00174     <span class="comment">//  any structures created here.</span>
00175     <span class="comment">//</span>
00176     <span class="comment">//  CurrentFcb - represents this point.  If non-null it means we have</span>
00177     <span class="comment">//      acquired it and need to release it in finally clause.</span>
00178     <span class="comment">//</span>
00179     <span class="comment">//  NextFcb - represents the NextFcb to walk to but haven't acquired yet.</span>
00180     <span class="comment">//</span>
00181     <span class="comment">//  CurrentLcb - represents the name of the CurrentFcb.</span>
00182     <span class="comment">//</span>
00183 
00184     <a class="code" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a> RelatedTypeOfOpen = <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a113">UnopenedFileObject</a>;
00185     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> RelatedFileObject;
00186     <a class="code" href="../../d2/d9/struct__CCB.html">PCCB</a> RelatedCcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00187 
00188     <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> NextFcb;
00189     <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> CurrentFcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00190 
00191     <a class="code" href="../../d5/d9/struct__LCB.html">PLCB</a> CurrentLcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00192 
00193     <span class="comment">//</span>
00194     <span class="comment">//  During the open we need to combine the related file object name</span>
00195     <span class="comment">//  with the remaining name.  We also may need to upcase the file name</span>
00196     <span class="comment">//  in order to do a case-insensitive name comparison.  We also need</span>
00197     <span class="comment">//  to restore the name in the file object in the event that we retry</span>
00198     <span class="comment">//  the request.  We use the following string variables to manage the</span>
00199     <span class="comment">//  name.  We will can put these strings into either Unicode or Ansi</span>
00200     <span class="comment">//  form.</span>
00201     <span class="comment">//</span>
00202     <span class="comment">//  FileName - Pointer to name as currently stored in the file</span>
00203     <span class="comment">//      object.  We store the full name into the file object early in</span>
00204     <span class="comment">//      the open operation.</span>
00205     <span class="comment">//</span>
00206     <span class="comment">//  RelatedFileName - Pointer to the name in the related file object.</span>
00207     <span class="comment">//</span>
00208     <span class="comment">//  RemainingName - String containing remaining name to parse.</span>
00209     <span class="comment">//</span>
00210 
00211     PUNICODE_STRING <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>;
00212     PUNICODE_STRING RelatedFileName;
00213 
00214     UNICODE_STRING RemainingName;
00215     UNICODE_STRING FinalName;
00216 
00217     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00218 
00219     <span class="comment">//</span>
00220     <span class="comment">//  If we were called with our file system device object instead of a</span>
00221     <span class="comment">//  volume device object, just complete this request with STATUS_SUCCESS.</span>
00222     <span class="comment">//</span>
00223 
00224     <span class="keywordflow">if</span> (IrpContext-&gt;Vcb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00225 
00226         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, STATUS_SUCCESS );
00227         <span class="keywordflow">return</span> STATUS_SUCCESS;
00228     }
00229 
00230     <span class="comment">//</span>
00231     <span class="comment">//  Get create parameters from the Irp.</span>
00232     <span class="comment">//</span>
00233 
00234     OpenByFileId = <a class="code" href="../../d5/d5/cc_8h.html#a59">BooleanFlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.Options, FILE_OPEN_BY_FILE_ID );
00235     IgnoreCase = !<a class="code" href="../../d5/d5/cc_8h.html#a59">BooleanFlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o2">Flags</a>, <a class="code" href="../../d0/d5/io_8h.html#a201">SL_CASE_SENSITIVE</a> );
00236     CreateDisposition = (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.Options &gt;&gt; 24) &amp; 0x000000ff;
00237 
00238     <span class="comment">//</span>
00239     <span class="comment">//  Do some preliminary checks to make sure the operation is supported.</span>
00240     <span class="comment">//  We fail in the following cases immediately.</span>
00241     <span class="comment">//</span>
00242     <span class="comment">//      - Open a paging file.</span>
00243     <span class="comment">//      - Open a target directory.</span>
00244     <span class="comment">//      - Open a file with Eas.</span>
00245     <span class="comment">//      - Create a file.</span>
00246     <span class="comment">//</span>
00247 
00248     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o2">Flags</a>, <a class="code" href="../../d0/d5/io_8h.html#a199">SL_OPEN_PAGING_FILE</a> | <a class="code" href="../../d0/d5/io_8h.html#a200">SL_OPEN_TARGET_DIRECTORY</a>) ||
00249         (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.EaLength != 0) ||
00250         (CreateDisposition == FILE_CREATE)) {
00251 
00252         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, STATUS_ACCESS_DENIED );
00253         <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
00254     }
00255 
00256     <span class="comment">//</span>
00257     <span class="comment">//  Copy the Vcb to a local.  Assume the starting directory is the root.</span>
00258     <span class="comment">//</span>
00259 
00260     Vcb = IrpContext-&gt;Vcb;
00261     NextFcb = Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o21">RootIndexFcb</a>;
00262 
00263     <span class="comment">//</span>
00264     <span class="comment">//  Reference our input parameters to make things easier</span>
00265     <span class="comment">//</span>
00266 
00267     FileObject = IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>;
00268     RelatedFileObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00269 
00270     <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a> = &amp;FileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o19">FileName</a>;
00271 
00272     <span class="comment">//</span>
00273     <span class="comment">//  Set up the file object's Vpb pointer in case anything happens.</span>
00274     <span class="comment">//  This will allow us to get a reasonable pop-up.</span>
00275     <span class="comment">//</span>
00276 
00277     <span class="keywordflow">if</span> ((FileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o9">RelatedFileObject</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; !OpenByFileId) {
00278 
00279         RelatedFileObject = FileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o9">RelatedFileObject</a>;
00280         FileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o3">Vpb</a> = RelatedFileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o3">Vpb</a>;
00281 
00282         RelatedTypeOfOpen = <a class="code" href="../../d3/d8/udfprocs_8h.html#a174">UdfDecodeFileObject</a>( RelatedFileObject, &amp;NextFcb, &amp;RelatedCcb );
00283 
00284         <span class="comment">//</span>
00285         <span class="comment">//  Fail the request if this is not a user file object.</span>
00286         <span class="comment">//</span>
00287 
00288         <span class="keywordflow">if</span> (RelatedTypeOfOpen &lt; <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a115">UserVolumeOpen</a>) {
00289 
00290             <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, STATUS_INVALID_PARAMETER );
00291             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00292         }
00293 
00294         <span class="comment">//</span>
00295         <span class="comment">//  Remember the name in the related file object.</span>
00296         <span class="comment">//</span>
00297 
00298         RelatedFileName = &amp;RelatedFileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o19">FileName</a>;
00299     }
00300 
00301     <span class="comment">//</span>
00302     <span class="comment">//  If we haven't initialized the names then make sure the strings are valid.</span>
00303     <span class="comment">//  If this an OpenByFileId then verify the file id buffer.</span>
00304     <span class="comment">//</span>
00305     <span class="comment">//  After this routine returns we know that the full name is in the</span>
00306     <span class="comment">//  FileName buffer and the buffer will hold the upcased portion</span>
00307     <span class="comment">//  of the name yet to parse immediately after the full name in the</span>
00308     <span class="comment">//  buffer.  Any trailing backslash has been removed and the flag</span>
00309     <span class="comment">//  in the IrpContext will indicate whether we removed the</span>
00310     <span class="comment">//  backslash.</span>
00311     <span class="comment">//</span>
00312 
00313     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfs_2create_8c.html#a2">UdfNormalizeFileNames</a>( IrpContext,
00314                                     Vcb,
00315                                     OpenByFileId,
00316                                     IgnoreCase,
00317                                     RelatedTypeOfOpen,
00318                                     RelatedCcb,
00319                                     RelatedFileName,
00320                                     <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>,
00321                                     &amp;RemainingName );
00322 
00323     <span class="comment">//</span>
00324     <span class="comment">//  Return the error code if not successful.</span>
00325     <span class="comment">//</span>
00326 
00327     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00328 
00329         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00330         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00331     }
00332 
00333     <span class="comment">//</span>
00334     <span class="comment">//  We want to acquire the Vcb.  Exclusively for a volume open, shared otherwise.</span>
00335     <span class="comment">//  The file name is empty for a volume open.</span>
00336     <span class="comment">//</span>
00337 
00338     <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length == 0) &amp;&amp;
00339         (RelatedTypeOfOpen &lt;= <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a115">UserVolumeOpen</a>) &amp;&amp;
00340         !OpenByFileId) {
00341 
00342         VolumeOpen = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00343         <a class="code" href="../../d3/d8/udfprocs_8h.html#a74">UdfAcquireVcbExclusive</a>( IrpContext, Vcb, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00344 
00345     } <span class="keywordflow">else</span> {
00346 
00347         <a class="code" href="../../d3/d8/udfprocs_8h.html#a75">UdfAcquireVcbShared</a>( IrpContext, Vcb, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00348     }
00349 
00350     <span class="comment">//</span>
00351     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00352     <span class="comment">//</span>
00353 
00354     <span class="keywordflow">try</span> {
00355 
00356         <span class="comment">//</span>
00357         <span class="comment">//  Verify that the Vcb is not in an unusable condition.  This routine</span>
00358         <span class="comment">//  will raise if not usable.</span>
00359         <span class="comment">//</span>
00360 
00361         <a class="code" href="../../d8/d5/udfs_2verfysup_8c.html#a5">UdfVerifyVcb</a>( IrpContext, Vcb );
00362 
00363         <span class="comment">//</span>
00364         <span class="comment">//  If the Vcb is locked then we cannot open another file</span>
00365         <span class="comment">//</span>
00366 
00367         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o7">VcbState</a>, <a class="code" href="../../d6/d8/udfstruc_8h.html#a5">VCB_STATE_LOCKED</a> )) {
00368 
00369             <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED );
00370         }
00371 
00372         <span class="comment">//</span>
00373         <span class="comment">//  If we are opening this file by FileId then process this immediately</span>
00374         <span class="comment">//  and exit.</span>
00375         <span class="comment">//</span>
00376 
00377         <span class="keywordflow">if</span> (OpenByFileId) {
00378 
00379             <span class="comment">//</span>
00380             <span class="comment">//  The only create disposition we allow is OPEN.</span>
00381             <span class="comment">//</span>
00382 
00383             <span class="keywordflow">if</span> ((CreateDisposition != FILE_OPEN) &amp;&amp;
00384                 (CreateDisposition != FILE_OPEN_IF)) {
00385 
00386                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED );
00387             }
00388 
00389             <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfs_2create_8c.html#a4">UdfOpenObjectByFileId</a>( IrpContext,
00390                                                        IrpSp,
00391                                                        Vcb,
00392                                                        &amp;CurrentFcb ));
00393         }
00394 
00395         <span class="comment">//</span>
00396         <span class="comment">//  If we are opening this volume Dasd then process this immediately</span>
00397         <span class="comment">//  and exit.</span>
00398         <span class="comment">//</span>
00399 
00400         <span class="keywordflow">if</span> (VolumeOpen) {
00401 
00402             <span class="comment">//</span>
00403             <span class="comment">//  The only create disposition we allow is OPEN.</span>
00404             <span class="comment">//</span>
00405 
00406             <span class="keywordflow">if</span> ((CreateDisposition != FILE_OPEN) &amp;&amp;
00407                 (CreateDisposition != FILE_OPEN_IF)) {
00408 
00409                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED );
00410             }
00411 
00412             <span class="comment">//</span>
00413             <span class="comment">//  If they wanted to open a directory, surprise.</span>
00414             <span class="comment">//</span>
00415             
00416             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.Options, FILE_DIRECTORY_FILE )) {
00417 
00418                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NOT_A_DIRECTORY );
00419             }
00420 
00421             <span class="comment">//</span>
00422             <span class="comment">//  Acquire the Fcb first.</span>
00423             <span class="comment">//</span>
00424 
00425             CurrentFcb = Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o20">VolumeDasdFcb</a>;
00426             <a class="code" href="../../d3/d8/udfprocs_8h.html#a83">UdfAcquireFcbExclusive</a>( IrpContext, CurrentFcb, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00427 
00428             <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfs_2create_8c.html#a3">UdfOpenExistingFcb</a>( IrpContext,
00429                                                     IrpSp,
00430                                                     &amp;CurrentFcb,
00431                                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00432                                                     <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a115">UserVolumeOpen</a>,
00433                                                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00434                                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ));
00435         }
00436 
00437         <span class="comment">//</span>
00438         <span class="comment">//  Acquire the Fcb at the beginning of our search to keep it from being</span>
00439         <span class="comment">//  deleted beneath us.</span>
00440         <span class="comment">//</span>
00441 
00442         <a class="code" href="../../d3/d8/udfprocs_8h.html#a83">UdfAcquireFcbExclusive</a>( IrpContext, NextFcb, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00443         CurrentFcb = NextFcb;
00444 
00445         <span class="comment">//</span>
00446         <span class="comment">//  Do a prefix search if there is more of the name to parse.</span>
00447         <span class="comment">//</span>
00448 
00449         <span class="keywordflow">if</span> (RemainingName.Length != 0) {
00450 
00451             <span class="comment">//</span>
00452             <span class="comment">//  Do the prefix search to find the longest matching name.</span>
00453             <span class="comment">//</span>
00454 
00455             CurrentLcb = <a class="code" href="../../d3/d8/udfprocs_8h.html#a192">UdfFindPrefix</a>( IrpContext,
00456                                         &amp;CurrentFcb,
00457                                         &amp;RemainingName,
00458                                         IgnoreCase );
00459         }
00460 
00461         <span class="comment">//</span>
00462         <span class="comment">//  At this point CurrentFcb points at the lowest Fcb in the tree for this</span>
00463         <span class="comment">//  file name, CurrentLcb is that name, and RemainingName is the rest of the</span>
00464         <span class="comment">//  name we have to do any directory traversals for.</span>
00465         <span class="comment">//</span>
00466 
00467         <span class="comment">//</span>
00468         <span class="comment">//  If the remaining name length is zero then we have found our</span>
00469         <span class="comment">//  target.</span>
00470         <span class="comment">//</span>
00471 
00472         <span class="keywordflow">if</span> (RemainingName.Length == 0) {
00473 
00474             <span class="comment">//</span>
00475             <span class="comment">//  If this is a file so verify the user didn't want to open</span>
00476             <span class="comment">//  a directory.</span>
00477             <span class="comment">//</span>
00478 
00479             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a12">SafeNodeType</a>( CurrentFcb ) == <a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a4">UDFS_NTC_FCB_DATA</a>) {
00480 
00481                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpContext-&gt;Flags, <a class="code" href="../../d6/d8/udfstruc_8h.html#a39">IRP_CONTEXT_FLAG_TRAIL_BACKSLASH</a> ) ||
00482                     <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.Options, FILE_DIRECTORY_FILE )) {
00483 
00484                     <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NOT_A_DIRECTORY );
00485                 }
00486 
00487                 <span class="comment">//</span>
00488                 <span class="comment">//  The only create disposition we allow is OPEN.</span>
00489                 <span class="comment">//</span>
00490 
00491                 <span class="keywordflow">if</span> ((CreateDisposition != FILE_OPEN) &amp;&amp;
00492                     (CreateDisposition != FILE_OPEN_IF)) {
00493 
00494                     <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED );
00495                 }
00496 
00497                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfs_2create_8c.html#a3">UdfOpenExistingFcb</a>( IrpContext,
00498                                                          IrpSp,
00499                                                          &amp;CurrentFcb,
00500                                                          CurrentLcb,
00501                                                          <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a>,
00502                                                          IgnoreCase,
00503                                                          RelatedCcb ));
00504 
00505             <span class="comment">//</span>
00506             <span class="comment">//  This is a directory.  Verify the user didn't want to open</span>
00507             <span class="comment">//  as a file.</span>
00508             <span class="comment">//</span>
00509 
00510             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.Options, FILE_NON_DIRECTORY_FILE )) {
00511 
00512                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_FILE_IS_A_DIRECTORY );
00513 
00514             <span class="comment">//</span>
00515             <span class="comment">//  Open the file as a directory.</span>
00516             <span class="comment">//</span>
00517 
00518             } <span class="keywordflow">else</span> {
00519 
00520                 <span class="comment">//</span>
00521                 <span class="comment">//  The only create disposition we allow is OPEN.</span>
00522                 <span class="comment">//</span>
00523 
00524                 <span class="keywordflow">if</span> ((CreateDisposition != FILE_OPEN) &amp;&amp;
00525                     (CreateDisposition != FILE_OPEN_IF)) {
00526 
00527                     <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED );
00528                 }
00529 
00530                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfs_2create_8c.html#a3">UdfOpenExistingFcb</a>( IrpContext,
00531                                                          IrpSp,
00532                                                          &amp;CurrentFcb,
00533                                                          CurrentLcb,
00534                                                          <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a116">UserDirectoryOpen</a>,
00535                                                          IgnoreCase,
00536                                                          RelatedCcb ));
00537             }
00538         }
00539 
00540         <span class="comment">//</span>
00541         <span class="comment">//  We have more work to do.  We have a starting Fcb which we own shared.</span>
00542         <span class="comment">//  We also have the remaining name to parse.  Walk through the name</span>
00543         <span class="comment">//  component by component looking for the full name.</span>
00544         <span class="comment">//</span>
00545 
00546         <span class="comment">//</span>
00547         <span class="comment">//  Our starting Fcb better be a directory.</span>
00548         <span class="comment">//</span>
00549 
00550         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( CurrentFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o11">FileAttributes</a>, FILE_ATTRIBUTE_DIRECTORY )) {
00551 
00552             <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OBJECT_PATH_NOT_FOUND );
00553         }
00554 
00555         <span class="comment">//</span>
00556         <span class="comment">//  If we can't wait then post this request.</span>
00557         <span class="comment">//</span>
00558 
00559         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpContext-&gt;Flags, <a class="code" href="../../d6/d8/udfstruc_8h.html#a30">IRP_CONTEXT_FLAG_WAIT</a> )) {
00560 
00561             <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_CANT_WAIT );
00562         }
00563 
00564         <span class="comment">//</span>
00565         <span class="comment">//  Prepare the enumeration context for use.</span>
00566         <span class="comment">//</span>
00567         
00568         <a class="code" href="../../d3/d8/udfprocs_8h.html#a167">UdfInitializeDirContext</a>( IrpContext, &amp;DirContext );
00569         CleanupDirContext = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00570 
00571         <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00572 
00573             ShortNameMatch = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00574 
00575             <span class="comment">//</span>
00576             <span class="comment">//  Split off the next component from the name.</span>
00577             <span class="comment">//</span>
00578 
00579             <a class="code" href="../../d3/d8/udfprocs_8h.html#a177">UdfDissectName</a>( IrpContext,
00580                             &amp;RemainingName,
00581                             &amp;FinalName );
00582 
00583             <span class="comment">//</span>
00584             <span class="comment">//  Go ahead and look this entry up in the directory.</span>
00585             <span class="comment">//</span>
00586 
00587             FoundEntry = <a class="code" href="../../d3/d8/udfprocs_8h.html#a172">UdfFindDirEntry</a>( IrpContext,
00588                                           CurrentFcb,
00589                                           &amp;FinalName,
00590                                           IgnoreCase,
00591                                           <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00592                                           &amp;DirContext );
00593 
00594             <span class="comment">//</span>
00595             <span class="comment">//  If we didn't find the entry then check if the current name</span>
00596             <span class="comment">//  is a possible short name.</span>
00597             <span class="comment">//</span>
00598 
00599             <span class="keywordflow">if</span> (!FoundEntry &amp;&amp; <a class="code" href="../../d3/d8/udfprocs_8h.html#a179">UdfCandidateShortName</a>( IrpContext, &amp;FinalName)) {
00600 
00601                 <span class="comment">//</span>
00602                 <span class="comment">//  If the name looks like it could be a short name, try to find</span>
00603                 <span class="comment">//  a matching real directory entry.</span>
00604                 <span class="comment">//</span>
00605 
00606                 ShortNameMatch =
00607                 FoundEntry = <a class="code" href="../../d3/d8/udfprocs_8h.html#a172">UdfFindDirEntry</a>( IrpContext,
00608                                               CurrentFcb,
00609                                               &amp;FinalName,
00610                                               IgnoreCase,
00611                                               <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00612                                               &amp;DirContext );
00613             }
00614 
00615             <span class="comment">//</span>
00616             <span class="comment">//  If we didn't find a match then check what the caller was trying to do to</span>
00617             <span class="comment">//  determine which error code to return.</span>
00618             <span class="comment">//</span>
00619     
00620             <span class="keywordflow">if</span> (!FoundEntry) {
00621     
00622                 <span class="keywordflow">if</span> ((CreateDisposition == FILE_OPEN) ||
00623                     (CreateDisposition == FILE_OVERWRITE)) {
00624     
00625                     <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OBJECT_NAME_NOT_FOUND );
00626                 }
00627     
00628                 <span class="comment">//</span>
00629                 <span class="comment">//  Any other operation return STATUS_ACCESS_DENIED.</span>
00630                 <span class="comment">//</span>
00631     
00632                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED );
00633             }
00634 
00635             <span class="comment">//</span>
00636             <span class="comment">//  If this is an ignore case open then copy the exact case</span>
00637             <span class="comment">//  in the file object name.</span>
00638             <span class="comment">//</span>
00639 
00640             <span class="keywordflow">if</span> (IgnoreCase &amp;&amp; !ShortNameMatch) {
00641 
00642                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( FinalName.Length == DirContext.<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o8">ObjectName</a>.Length );
00643                 
00644                 RtlCopyMemory( FinalName.Buffer,
00645                                DirContext.<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o8">ObjectName</a>.Buffer,
00646                                DirContext.<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o8">ObjectName</a>.Length );
00647             }
00648 
00649             <span class="comment">//</span>
00650             <span class="comment">//  If we have found the last component then break out to open for the caller.</span>
00651             <span class="comment">//</span>
00652 
00653             <span class="keywordflow">if</span> (RemainingName.Length == 0) {
00654 
00655                 <span class="keywordflow">break</span>;
00656             }
00657             
00658             <span class="comment">//</span>
00659             <span class="comment">//  The object we just found must be a directory.</span>
00660             <span class="comment">//</span>
00661 
00662             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( DirContext.<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o5">Fid</a>-&gt;<a class="code" href="../../d1/d2/structNSR__FID.html#o2">Flags</a>, <a class="code" href="../../d0/d7/iso13346_8h.html#a89">NSR_FID_F_DIRECTORY</a> )) {
00663 
00664                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OBJECT_PATH_NOT_FOUND );
00665             }
00666 
00667             <span class="comment">//</span>
00668             <span class="comment">//  Now open an Fcb for this intermediate index Fcb.</span>
00669             <span class="comment">//</span>
00670 
00671             <a class="code" href="../../d3/d8/udfs_2create_8c.html#a5">UdfOpenObjectFromDirContext</a>( IrpContext,
00672                                          IrpSp,
00673                                          Vcb,
00674                                          &amp;CurrentFcb,
00675                                          ShortNameMatch,
00676                                          IgnoreCase,
00677                                          &amp;DirContext,
00678                                          <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00679                                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00680         }
00681         
00682         <span class="comment">//</span>
00683         <span class="comment">//  Make sure our opener is about to get what they expect.</span>
00684         <span class="comment">//</span>
00685 
00686         <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpContext-&gt;Flags, <a class="code" href="../../d6/d8/udfstruc_8h.html#a39">IRP_CONTEXT_FLAG_TRAIL_BACKSLASH</a> ) ||
00687              <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.Options, FILE_DIRECTORY_FILE )) &amp;&amp;
00688             !<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( DirContext.<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o5">Fid</a>-&gt;<a class="code" href="../../d1/d2/structNSR__FID.html#o2">Flags</a>, <a class="code" href="../../d0/d7/iso13346_8h.html#a89">NSR_FID_F_DIRECTORY</a> )) {
00689 
00690             <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NOT_A_DIRECTORY );
00691         
00692         }
00693 
00694         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.Options, FILE_NON_DIRECTORY_FILE ) &amp;&amp;
00695             <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( DirContext.<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o5">Fid</a>-&gt;<a class="code" href="../../d1/d2/structNSR__FID.html#o2">Flags</a>, <a class="code" href="../../d0/d7/iso13346_8h.html#a89">NSR_FID_F_DIRECTORY</a> )) {
00696 
00697             <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_FILE_IS_A_DIRECTORY );
00698         }
00699 
00700         <span class="comment">//</span>
00701         <span class="comment">//  The only create disposition we allow is OPEN.</span>
00702         <span class="comment">//</span>
00703 
00704         <span class="keywordflow">if</span> ((CreateDisposition != FILE_OPEN) &amp;&amp;
00705             (CreateDisposition != FILE_OPEN_IF)) {
00706 
00707             <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED );
00708         }
00709 
00710         <span class="comment">//</span>
00711         <span class="comment">//  Open the object for the caller.</span>
00712         <span class="comment">//</span>
00713 
00714         <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfs_2create_8c.html#a5">UdfOpenObjectFromDirContext</a>( IrpContext,
00715                                                          IrpSp,
00716                                                          Vcb,
00717                                                          &amp;CurrentFcb,
00718                                                          ShortNameMatch,
00719                                                          IgnoreCase,
00720                                                          &amp;DirContext,
00721                                                          <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00722                                                          RelatedCcb ));
00723     } finally {
00724         
00725         <span class="comment">//</span>
00726         <span class="comment">//  Cleanup the enumeration context if initialized.</span>
00727         <span class="comment">//</span>
00728 
00729         <span class="keywordflow">if</span> (CleanupDirContext) {
00730 
00731             <a class="code" href="../../d3/d8/udfprocs_8h.html#a168">UdfCleanupDirContext</a>( IrpContext, &amp;DirContext );
00732         }
00733 
00734         <span class="comment">//</span>
00735         <span class="comment">//  The result of this open could be success, pending or some error</span>
00736         <span class="comment">//  condition.</span>
00737         <span class="comment">//</span>
00738 
00739         <span class="keywordflow">if</span> (AbnormalTermination()) {
00740 
00741 
00742             <span class="comment">//</span>
00743             <span class="comment">//  In the error path we start by calling our teardown routine if we</span>
00744             <span class="comment">//  have a CurrentFcb.</span>
00745             <span class="comment">//</span>
00746 
00747             <span class="keywordflow">if</span> (CurrentFcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00748 
00749                 BOOLEAN RemovedFcb;
00750 
00751                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a210">UdfTeardownStructures</a>( IrpContext, CurrentFcb, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;RemovedFcb );
00752 
00753                 <span class="keywordflow">if</span> (RemovedFcb) {
00754 
00755                     CurrentFcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00756                 }
00757             }
00758             
00759             <span class="comment">//</span>
00760             <span class="comment">//  No need to complete the request.</span>
00761             <span class="comment">//</span>
00762 
00763             IrpContext = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00764             <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00765 
00766         <span class="comment">//</span>
00767         <span class="comment">//  If we posted this request through the oplock package we need</span>
00768         <span class="comment">//  to show that there is no reason to complete the request.</span>
00769         <span class="comment">//</span>
00770 
00771         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_PENDING) {
00772 
00773             IrpContext = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00774             <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00775         }
00776 
00777         <span class="comment">//</span>
00778         <span class="comment">//  Release the Current Fcb if still acquired.</span>
00779         <span class="comment">//</span>
00780 
00781         <span class="keywordflow">if</span> (CurrentFcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00782 
00783             <a class="code" href="../../d3/d8/udfprocs_8h.html#a85">UdfReleaseFcb</a>( IrpContext, CurrentFcb );
00784         }
00785 
00786         <span class="comment">//</span>
00787         <span class="comment">//  Release the Vcb.</span>
00788         <span class="comment">//</span>
00789 
00790         <a class="code" href="../../d3/d8/udfprocs_8h.html#a76">UdfReleaseVcb</a>( IrpContext, Vcb );
00791 
00792         <span class="comment">//</span>
00793         <span class="comment">//  Call our completion routine.  It will handle the case where either</span>
00794         <span class="comment">//  the Irp and/or IrpContext are gone.</span>
00795         <span class="comment">//</span>
00796 
00797         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00798     }
00799 
00800     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00801 }
00802 
00803 
00804 <span class="comment">//</span>
00805 <span class="comment">//  Local support routine</span>
00806 <span class="comment">//</span>
00807 
00808 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00809"></a><a class="code" href="../../d3/d8/udfs_2create_8c.html#a2">00809</a> <a class="code" href="../../d3/d8/udfs_2create_8c.html#a2">UdfNormalizeFileNames</a> (
00810     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00811     IN <a class="code" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb,
00812     IN BOOLEAN OpenByFileId,
00813     IN BOOLEAN IgnoreCase,
00814     IN TYPE_OF_OPEN RelatedTypeOfOpen,
00815     IN <a class="code" href="../../d2/d9/struct__CCB.html">PCCB</a> RelatedCcb OPTIONAL,
00816     IN PUNICODE_STRING RelatedFileName OPTIONAL,
00817     IN OUT PUNICODE_STRING FileName,
00818     IN OUT PUNICODE_STRING RemainingName
00819     )
00820 
00821 <span class="comment">/*++</span>
00822 <span class="comment"></span>
00823 <span class="comment">Routine Description:</span>
00824 <span class="comment"></span>
00825 <span class="comment">    This routine is called to store the full name and upcased name into the</span>
00826 <span class="comment">    filename buffer.  We only upcase the portion yet to parse.  We also</span>
00827 <span class="comment">    check for a trailing backslash and lead-in double backslashes.  This</span>
00828 <span class="comment">    routine also verifies the mode of the related open against the name</span>
00829 <span class="comment">    currently in the filename.</span>
00830 <span class="comment"></span>
00831 <span class="comment">Arguments:</span>
00832 <span class="comment"></span>
00833 <span class="comment">    Vcb - Vcb for this volume.</span>
00834 <span class="comment"></span>
00835 <span class="comment">    OpenByFileId - Indicates if the filename should be a 64 bit FileId.</span>
00836 <span class="comment"></span>
00837 <span class="comment">    IgnoreCase - Indicates if this open is a case-insensitive operation.</span>
00838 <span class="comment"></span>
00839 <span class="comment">    RelatedTypeOfOpen - Indicates the type of the related file object.</span>
00840 <span class="comment"></span>
00841 <span class="comment">    RelatedCcb - Ccb for the related open.  Ignored if no relative open.</span>
00842 <span class="comment"></span>
00843 <span class="comment">    RelatedFileName - FileName buffer for related open.  Ignored if no</span>
00844 <span class="comment">        relative open.</span>
00845 <span class="comment"></span>
00846 <span class="comment">    FileName - FileName to update in this routine.  The name should</span>
00847 <span class="comment">        either be a 64-bit FileId or a Unicode string.</span>
00848 <span class="comment"></span>
00849 <span class="comment">    RemainingName - Name with the remaining portion of the name.  This</span>
00850 <span class="comment">        will begin after the related name and any separator.  For a</span>
00851 <span class="comment">        non-relative open we also step over the initial separator.</span>
00852 <span class="comment"></span>
00853 <span class="comment">Return Value:</span>
00854 <span class="comment"></span>
00855 <span class="comment">    NTSTATUS - STATUS_SUCCESS if the names are OK, appropriate error code</span>
00856 <span class="comment">        otherwise.</span>
00857 <span class="comment"></span>
00858 <span class="comment">--*/</span>
00859 
00860 {
00861     ULONG RemainingNameLength;
00862     ULONG RelatedNameLength = 0;
00863     ULONG SeparatorLength = 0;
00864 
00865     ULONG BufferLength;
00866 
00867     UNICODE_STRING NewFileName;
00868 
00869     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00870 
00871     <span class="comment">//</span>
00872     <span class="comment">//  If this is the first pass then we need to build the full name and</span>
00873     <span class="comment">//  check for name compatibility.</span>
00874     <span class="comment">//</span>
00875 
00876     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpContext-&gt;Flags, <a class="code" href="../../d6/d8/udfstruc_8h.html#a38">IRP_CONTEXT_FLAG_FULL_NAME</a> )) {
00877 
00878         <span class="comment">//</span>
00879         <span class="comment">//  Deal with the regular file name case first.</span>
00880         <span class="comment">//</span>
00881 
00882         <span class="keywordflow">if</span> (!OpenByFileId) {
00883 
00884             <span class="comment">//</span>
00885             <span class="comment">//  Here is the  "M A R K   L U C O V S K Y"  hack.</span>
00886             <span class="comment">//</span>
00887             <span class="comment">//  It's here because Mark says he can't avoid sending me double beginning</span>
00888             <span class="comment">//  backslashes via the Win32 layer.</span>
00889             <span class="comment">//</span>
00890 
00891             <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length &gt; <span class="keyword">sizeof</span>( WCHAR )) &amp;&amp;
00892                 (<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Buffer[1] == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>) &amp;&amp;
00893                 (<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Buffer[0] == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>)) {
00894 
00895                 <span class="comment">//</span>
00896                 <span class="comment">//  If there are still two beginning backslashes, the name is bogus.</span>
00897                 <span class="comment">//</span>
00898 
00899                 <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length &gt; 2 * <span class="keyword">sizeof</span>( WCHAR )) &amp;&amp;
00900                     (<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Buffer[2] == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>)) {
00901 
00902                     <span class="keywordflow">return</span> STATUS_OBJECT_NAME_INVALID;
00903                 }
00904 
00905                 <span class="comment">//</span>
00906                 <span class="comment">//  Slide the name down in the buffer.</span>
00907                 <span class="comment">//</span>
00908 
00909                 RtlMoveMemory( <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Buffer,
00910                                <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Buffer + 1,
00911                                <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length );
00912 
00913                 <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length -= <span class="keyword">sizeof</span>( WCHAR );
00914             }
00915 
00916             <span class="comment">//</span>
00917             <span class="comment">//  Check for a trailing backslash.  Don't strip off if only character</span>
00918             <span class="comment">//  in the full name or for relative opens where this is illegal.</span>
00919             <span class="comment">//</span>
00920 
00921             <span class="keywordflow">if</span> (((<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length &gt; <span class="keyword">sizeof</span>( WCHAR)) ||
00922                  ((<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length == <span class="keyword">sizeof</span>( WCHAR )) &amp;&amp; (RelatedTypeOfOpen == <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a116">UserDirectoryOpen</a>))) &amp;&amp;
00923                 (<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Buffer[ (<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length/2) - 1 ] == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>)) {
00924 
00925                 <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( IrpContext-&gt;Flags, <a class="code" href="../../d6/d8/udfstruc_8h.html#a39">IRP_CONTEXT_FLAG_TRAIL_BACKSLASH</a> );
00926                 <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length -= <span class="keyword">sizeof</span>( WCHAR );
00927             }
00928 
00929             <span class="comment">//</span>
00930             <span class="comment">//  Remember the length we need for this portion of the name.</span>
00931             <span class="comment">//</span>
00932 
00933             RemainingNameLength = <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length;
00934 
00935             <span class="comment">//</span>
00936             <span class="comment">//  If this is a related file object then we verify the compatibility</span>
00937             <span class="comment">//  of the name in the file object with the relative file object.</span>
00938             <span class="comment">//</span>
00939 
00940             <span class="keywordflow">if</span> (RelatedTypeOfOpen != <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a113">UnopenedFileObject</a>) {
00941 
00942                 <span class="comment">//</span>
00943                 <span class="comment">//  If the filename length was zero then it must be legal.</span>
00944                 <span class="comment">//  If there are characters then check with the related</span>
00945                 <span class="comment">//  type of open.</span>
00946                 <span class="comment">//</span>
00947 
00948                 <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length != 0) {
00949 
00950                     <span class="comment">//</span>
00951                     <span class="comment">//  The name length must always be zero for a volume open.</span>
00952                     <span class="comment">//</span>
00953 
00954                     <span class="keywordflow">if</span> (RelatedTypeOfOpen &lt;= <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a115">UserVolumeOpen</a>) {
00955 
00956                         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00957 
00958                     <span class="comment">//</span>
00959                     <span class="comment">//  The remaining name cannot begin with a backslash.</span>
00960                     <span class="comment">//</span>
00961 
00962                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Buffer[0] == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span> ) {
00963 
00964                         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00965 
00966                     <span class="comment">//</span>
00967                     <span class="comment">//  If the related file is a user file then there</span>
00968                     <span class="comment">//  is no file with this path.</span>
00969                     <span class="comment">//</span>
00970 
00971                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (RelatedTypeOfOpen == <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a>) {
00972 
00973                         <span class="keywordflow">return</span> STATUS_OBJECT_PATH_NOT_FOUND;
00974                     }
00975                 }
00976 
00977                 <span class="comment">//</span>
00978                 <span class="comment">//  Remember the length of the related name when building</span>
00979                 <span class="comment">//  the full name.  We leave the RelatedNameLength and</span>
00980                 <span class="comment">//  SeparatorLength at zero if the relative file is opened</span>
00981                 <span class="comment">//  by Id.</span>
00982                 <span class="comment">//</span>
00983 
00984                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( RelatedCcb-&gt;Flags, <a class="code" href="../../d6/d8/udfstruc_8h.html#a20">CCB_FLAG_OPEN_BY_ID</a> )) {
00985 
00986                     <span class="comment">//</span>
00987                     <span class="comment">//  Add a separator if the name length is non-zero</span>
00988                     <span class="comment">//  unless the relative Fcb is at the root.</span>
00989                     <span class="comment">//</span>
00990 
00991                     <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length != 0) &amp;&amp;
00992                         (RelatedCcb-&gt;Fcb != Vcb-&gt;RootIndexFcb)) {
00993 
00994                         SeparatorLength = <span class="keyword">sizeof</span>( WCHAR );
00995                     }
00996 
00997                     RelatedNameLength = RelatedFileName-&gt;Length;
00998                 }
00999 
01000             <span class="comment">//</span>
01001             <span class="comment">//  The full name is already in the filename.  It must either</span>
01002             <span class="comment">//  be length 0 or begin with a backslash.</span>
01003             <span class="comment">//</span>
01004 
01005             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length != 0) {
01006 
01007                 <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Buffer[0] != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>) {
01008 
01009                     <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01010                 }
01011 
01012                 <span class="comment">//</span>
01013                 <span class="comment">//  We will want to trim the leading backslash from the</span>
01014                 <span class="comment">//  remaining name we return.</span>
01015                 <span class="comment">//</span>
01016 
01017                 RemainingNameLength -= <span class="keyword">sizeof</span>( WCHAR );
01018                 SeparatorLength = <span class="keyword">sizeof</span>( WCHAR );
01019             }
01020 
01021             <span class="comment">//</span>
01022             <span class="comment">//  Now see if the buffer is large enough to hold the full name.</span>
01023             <span class="comment">//</span>
01024 
01025             BufferLength = RelatedNameLength + SeparatorLength + RemainingNameLength;
01026 
01027             <span class="comment">//</span>
01028             <span class="comment">//  Check for an overflow of the maximum filename size.</span>
01029             <span class="comment">//</span>
01030             
01031             <span class="keywordflow">if</span> (BufferLength &gt; MAXUSHORT) {
01032 
01033                 <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01034             }
01035 
01036             <span class="comment">//</span>
01037             <span class="comment">//  Now see if we need to allocate a new buffer.</span>
01038             <span class="comment">//</span>
01039 
01040             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;MaximumLength &lt; BufferLength) {
01041 
01042                 NewFileName.Buffer = <a class="code" href="../../d1/d8/fsrtl_8h.html#a37">FsRtlAllocatePoolWithTag</a>( <a class="code" href="../../d3/d8/udfprocs_8h.html#a65">UdfPagedPool</a>,
01043                                                                BufferLength,
01044                                                                <a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a75">TAG_FILE_NAME</a> );
01045 
01046                 NewFileName.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) BufferLength;
01047 
01048             } <span class="keywordflow">else</span> {
01049 
01050                 NewFileName.Buffer = <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Buffer;
01051                 NewFileName.MaximumLength = <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;MaximumLength;
01052             }
01053 
01054             <span class="comment">//</span>
01055             <span class="comment">//  If there is a related name then we need to slide the remaining bytes up and</span>
01056             <span class="comment">//  insert the related name.  Otherwise the name is in the correct position</span>
01057             <span class="comment">//  already.</span>
01058             <span class="comment">//</span>
01059 
01060             <span class="keywordflow">if</span> (RelatedNameLength != 0) {
01061 
01062                 <span class="comment">//</span>
01063                 <span class="comment">//  Store the remaining name in its correct position.</span>
01064                 <span class="comment">//</span>
01065 
01066                 <span class="keywordflow">if</span> (RemainingNameLength != 0) {
01067 
01068                     RtlMoveMemory( <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( NewFileName.Buffer, RelatedNameLength + SeparatorLength, PVOID ),
01069                                    <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Buffer,
01070                                    RemainingNameLength );
01071                 }
01072 
01073                 RtlCopyMemory( NewFileName.Buffer,
01074                                RelatedFileName-&gt;Buffer,
01075                                RelatedNameLength );
01076 
01077                 <span class="comment">//</span>
01078                 <span class="comment">//  Add the separator if needed.</span>
01079                 <span class="comment">//</span>
01080 
01081                 <span class="keywordflow">if</span> (SeparatorLength != 0) {
01082 
01083                     *(<a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( NewFileName.Buffer, RelatedNameLength, PWCHAR )) = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>;
01084                 }
01085 
01086                 <span class="comment">//</span>
01087                 <span class="comment">//  Update the filename value we got from the user.</span>
01088                 <span class="comment">//</span>
01089 
01090                 <span class="keywordflow">if</span> (NewFileName.Buffer != <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Buffer) {
01091 
01092                     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01093 
01094                         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Buffer );
01095                     }
01096 
01097                     <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Buffer = NewFileName.Buffer;
01098                     <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;MaximumLength = NewFileName.MaximumLength;
01099                 }
01100 
01101                 <span class="comment">//</span>
01102                 <span class="comment">//  Copy the name length to the user's filename.</span>
01103                 <span class="comment">//</span>
01104 
01105                 <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) (RelatedNameLength + SeparatorLength + RemainingNameLength);
01106             }
01107 
01108             <span class="comment">//</span>
01109             <span class="comment">//  Now update the remaining name to parse.</span>
01110             <span class="comment">//</span>
01111 
01112             RemainingName-&gt;MaximumLength =
01113             RemainingName-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) RemainingNameLength;
01114 
01115             RemainingName-&gt;Buffer = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Buffer,
01116                                              RelatedNameLength + SeparatorLength,
01117                                              PWCHAR );
01118 
01119             <span class="comment">//</span>
01120             <span class="comment">//  Upcase the name if necessary.</span>
01121             <span class="comment">//</span>
01122 
01123             <span class="keywordflow">if</span> (IgnoreCase &amp;&amp; (RemainingNameLength != 0)) {
01124 
01125                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a186">UdfUpcaseName</a>( IrpContext,
01126                                RemainingName,
01127                                RemainingName );
01128             }
01129 
01130             <span class="comment">//</span>
01131             <span class="comment">//  Do a quick check to make sure there are no wildcards.</span>
01132             <span class="comment">//</span>
01133 
01134             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/fsrtl_8h.html#a177">FsRtlDoesNameContainWildCards</a>( RemainingName )) {
01135 
01136                 <span class="keywordflow">return</span> STATUS_OBJECT_NAME_INVALID;
01137             }
01138 
01139         <span class="comment">//</span>
01140         <span class="comment">//  For the open by file Id case we verify the name really contains</span>
01141         <span class="comment">//  a 64 bit value.</span>
01142         <span class="comment">//</span>
01143 
01144         } <span class="keywordflow">else</span> {
01145 
01146             <span class="comment">//</span>
01147             <span class="comment">//  Check for validity of the buffer.</span>
01148             <span class="comment">//</span>
01149 
01150             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length != <span class="keyword">sizeof</span>( <a class="code" href="../../d6/d8/udfstruc_8h.html#a77">FILE_ID</a> )) {
01151 
01152                 <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01153             }
01154         }
01155 
01156         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( IrpContext-&gt;Flags, <a class="code" href="../../d6/d8/udfstruc_8h.html#a38">IRP_CONTEXT_FLAG_FULL_NAME</a> );
01157 
01158     <span class="comment">//</span>
01159     <span class="comment">//  If we are in the retry path then the full name is already in the</span>
01160     <span class="comment">//  file object name.  If this is a case-sensitive operation then</span>
01161     <span class="comment">//  we need to upcase the name from the end of any related file name already stored</span>
01162     <span class="comment">//  there.</span>
01163     <span class="comment">//</span>
01164 
01165     } <span class="keywordflow">else</span> {
01166 
01167         <span class="comment">//</span>
01168         <span class="comment">//  Assume there is no relative name.</span>
01169         <span class="comment">//</span>
01170 
01171         *RemainingName = *<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>;
01172 
01173         <span class="comment">//</span>
01174         <span class="comment">//  Nothing to do if the name length is zero.</span>
01175         <span class="comment">//</span>
01176 
01177         <span class="keywordflow">if</span> (RemainingName-&gt;Length != 0) {
01178 
01179             <span class="comment">//</span>
01180             <span class="comment">//  If there is a relative name then we need to walk past it.</span>
01181             <span class="comment">//</span>
01182 
01183             <span class="keywordflow">if</span> (RelatedTypeOfOpen != <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a113">UnopenedFileObject</a>) {
01184 
01185                 <span class="comment">//</span>
01186                 <span class="comment">//  Nothing to walk past if the RelatedCcb is opened by FileId.</span>
01187                 <span class="comment">//</span>
01188 
01189 
01190                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( RelatedCcb-&gt;Flags, <a class="code" href="../../d6/d8/udfstruc_8h.html#a20">CCB_FLAG_OPEN_BY_ID</a> )) {
01191 
01192                     <span class="comment">//</span>
01193                     <span class="comment">//  Related file name is a proper prefix of the full name.</span>
01194                     <span class="comment">//  We step over the related name and if we are then</span>
01195                     <span class="comment">//  pointing at a separator character we step over that.</span>
01196                     <span class="comment">//</span>
01197 
01198                     RemainingName-&gt;Buffer = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( RemainingName-&gt;Buffer,
01199                                                      RelatedFileName-&gt;Length,
01200                                                      PWCHAR );
01201 
01202                     RemainingName-&gt;Length -= RelatedFileName-&gt;Length;
01203                 }
01204             }
01205 
01206             <span class="comment">//</span>
01207             <span class="comment">//  If we are pointing at a separator character then step past that.</span>
01208             <span class="comment">//</span>
01209 
01210             <span class="keywordflow">if</span> (RemainingName-&gt;Length != 0) {
01211 
01212                 <span class="keywordflow">if</span> (*(RemainingName-&gt;Buffer) == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>) {
01213 
01214                     RemainingName-&gt;Buffer = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( RemainingName-&gt;Buffer,
01215                                                      <span class="keyword">sizeof</span>( WCHAR ),
01216                                                      PWCHAR );
01217 
01218                     RemainingName-&gt;Length -= <span class="keyword">sizeof</span>( WCHAR );
01219                 }
01220             }
01221         }
01222 
01223         <span class="comment">//</span>
01224         <span class="comment">//  Upcase the name if necessary.</span>
01225         <span class="comment">//</span>
01226 
01227         <span class="keywordflow">if</span> (IgnoreCase &amp;&amp; (RemainingName-&gt;Length != 0)) {
01228 
01229             <a class="code" href="../../d3/d8/udfprocs_8h.html#a186">UdfUpcaseName</a>( IrpContext,
01230                            RemainingName,
01231                            RemainingName );
01232         }
01233     }
01234 
01235     <span class="keywordflow">return</span> STATUS_SUCCESS;
01236 }
01237 
01238 
01239 <span class="comment">//</span>
01240 <span class="comment">//  Local support routine</span>
01241 <span class="comment">//</span>
01242 
01243 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01244"></a><a class="code" href="../../d3/d8/udfs_2create_8c.html#a4">01244</a> <a class="code" href="../../d3/d8/udfs_2create_8c.html#a4">UdfOpenObjectByFileId</a> (
01245     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
01246     IN <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp,
01247     IN <a class="code" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb,
01248     IN OUT <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> *CurrentFcb
01249     )
01250 
01251 <span class="comment">/*++</span>
01252 <span class="comment"></span>
01253 <span class="comment">Routine Description:</span>
01254 <span class="comment"></span>
01255 <span class="comment">    This routine is called to open a file by the FileId.  The file Id is in</span>
01256 <span class="comment">    the FileObject name buffer and has been verified to be 64 bits.</span>
01257 <span class="comment"></span>
01258 <span class="comment">    We extract the Id number and then check to see whether we are opening a</span>
01259 <span class="comment">    file or directory and compare that with the create options.  If this</span>
01260 <span class="comment">    generates no error then optimistically look up the Fcb in the Fcb Table.</span>
01261 <span class="comment"></span>
01262 <span class="comment">    If we don't find the Fcb then we take what is effectively a wild-a** guess.</span>
01263 <span class="comment">    Since we would need more than 64bits to contain the root extent length along</span>
01264 <span class="comment">    with the partition, lbn and dir/file flag we have to speculate that the</span>
01265 <span class="comment">    opener knows what they are doing and try to crack an ICB hierarchy at the</span>
01266 <span class="comment">    specified location.  This can fail for any number of reasons, which then have</span>
01267 <span class="comment">    to be mapped to an open failure.</span>
01268 <span class="comment">    </span>
01269 <span class="comment">    If found then build the Fcb from this entry and store the new Fcb in the</span>
01270 <span class="comment">    tree.</span>
01271 <span class="comment"></span>
01272 <span class="comment">    Finally we call our worker routine to complete the open on this Fcb.</span>
01273 <span class="comment"></span>
01274 <span class="comment">Arguments:</span>
01275 <span class="comment"></span>
01276 <span class="comment">    IrpSp - Stack location within the create Irp.</span>
01277 <span class="comment"></span>
01278 <span class="comment">    Vcb - Vcb for this volume.</span>
01279 <span class="comment"></span>
01280 <span class="comment">    CurrentFcb - Address to store the Fcb for this open.  We only store the</span>
01281 <span class="comment">        CurrentFcb here when we have acquired it so our caller knows to</span>
01282 <span class="comment">        free or deallocate it.</span>
01283 <span class="comment"></span>
01284 <span class="comment">Return Value:</span>
01285 <span class="comment"></span>
01286 <span class="comment">    NTSTATUS - Status indicating the result of the operation.</span>
01287 <span class="comment"></span>
01288 <span class="comment">--*/</span>
01289 
01290 {
01291     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED;
01292 
01293     BOOLEAN UnlockVcb = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01294     BOOLEAN Found;
01295     BOOLEAN FcbExisted;
01296 
01297     <a class="code" href="../../d9/d9/struct__ICB__SEARCH__CONTEXT.html">ICB_SEARCH_CONTEXT</a> IcbContext;
01298     BOOLEAN CleanupIcbContext = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01299 
01300     <a class="code" href="../../d0/d7/lfs_2nodetype_8h.html#a7">NODE_TYPE_CODE</a> NodeTypeCode;
01301     <a class="code" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a> TypeOfOpen;
01302 
01303     <a class="code" href="../../d6/d8/udfstruc_8h.html#a77">FILE_ID</a> FileId;
01304 
01305     <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> NextFcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01306 
01307     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01308 
01309     <span class="comment">//</span>
01310     <span class="comment">//  Check inputs.</span>
01311     <span class="comment">//</span>
01312 
01313     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
01314     <a class="code" href="../../d1/d8/udfdata_8h.html#a12">ASSERT_VCB</a>( Vcb );
01315 
01316     <span class="comment">//</span>
01317     <span class="comment">//  Extract the FileId from the FileObject.</span>
01318     <span class="comment">//</span>
01319 
01320     RtlCopyMemory( &amp;FileId, IrpSp-&gt;FileObject-&gt;FileName.Buffer, <span class="keyword">sizeof</span>( <a class="code" href="../../d6/d8/udfstruc_8h.html#a77">FILE_ID</a> ));
01321 
01322     <span class="comment">//</span>
01323     <span class="comment">//  Now do a quick check that the reserved, unused chunk of the fileid is</span>
01324     <span class="comment">//  unused in this specimen.</span>
01325     <span class="comment">//</span>
01326 
01327     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d8/udfstruc_8h.html#a47">UdfGetFidReservedZero</a>( FileId )) {
01328 
01329         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01330     }
01331 
01332     <span class="comment">//</span>
01333     <span class="comment">//  Go ahead and figure out the TypeOfOpen and NodeType.  We can</span>
01334     <span class="comment">//  get these from the input FileId.</span>
01335     <span class="comment">//</span>
01336 
01337     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d8/udfstruc_8h.html#a51">UdfIsFidDirectory</a>( FileId )) {
01338 
01339         TypeOfOpen = <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a116">UserDirectoryOpen</a>;
01340         NodeTypeCode = <a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a3">UDFS_NTC_FCB_INDEX</a>;
01341 
01342     } <span class="keywordflow">else</span> {
01343 
01344         TypeOfOpen = <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a>;
01345         NodeTypeCode = <a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a4">UDFS_NTC_FCB_DATA</a>;
01346     }
01347 
01348     <span class="comment">//</span>
01349     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
01350     <span class="comment">//</span>
01351 
01352     <span class="keywordflow">try</span> {
01353 
01354         <span class="comment">//</span>
01355         <span class="comment">//  Acquire the Vcb and check if there is already an Fcb.</span>
01356         <span class="comment">//  If not we will need to carefully hunt for the on-disc</span>
01357         <span class="comment">//  structures.</span>
01358         <span class="comment">//</span>
01359         <span class="comment">//  We will post the request if we don't find the Fcb and this</span>
01360         <span class="comment">//  request can't wait.</span>
01361         <span class="comment">//</span>
01362 
01363         <a class="code" href="../../d3/d8/udfprocs_8h.html#a88">UdfLockVcb</a>( IrpContext, Vcb );
01364         UnlockVcb = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01365 
01366         NextFcb = <a class="code" href="../../d3/d8/udfprocs_8h.html#a213">UdfCreateFcb</a>( IrpContext, FileId, NodeTypeCode, &amp;FcbExisted );
01367 
01368         <span class="comment">//</span>
01369         <span class="comment">//  Now, if the Fcb was not already here we have some work to do.</span>
01370         <span class="comment">//</span>
01371         
01372         <span class="keywordflow">if</span> (!FcbExisted) {
01373 
01374             <span class="comment">//</span>
01375             <span class="comment">//  If we can't wait then post this request.</span>
01376             <span class="comment">//</span>
01377     
01378             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpContext-&gt;Flags, <a class="code" href="../../d6/d8/udfstruc_8h.html#a30">IRP_CONTEXT_FLAG_WAIT</a> )) {
01379     
01380                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_CANT_WAIT );
01381             }
01382     
01383             <span class="comment">//</span>
01384             <span class="comment">//  Use a try-finally to transform errors we get as a result of going</span>
01385             <span class="comment">//  off on a wild goose chase into a simple open failure.</span>
01386             <span class="comment">//</span>
01387             
01388             <span class="keywordflow">try</span> {
01389 
01390                 NextFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o6">FileId</a> = FileId;
01391                 
01392                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a220">UdfInitializeIcbContextFromFcb</a>( IrpContext, &amp;IcbContext, NextFcb );
01393                 CleanupIcbContext = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01394     
01395                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a223">UdfLookupActiveIcb</a>( IrpContext, &amp;IcbContext );
01396                 
01397                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a215">UdfInitializeFcbFromIcbContext</a>( IrpContext,
01398                                                 NextFcb,
01399                                                 &amp;IcbContext );
01400     
01401                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a224">UdfCleanupIcbContext</a>( IrpContext, &amp;IcbContext );
01402                 CleanupIcbContext = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01403 
01404             } except( <a class="code" href="../../d3/d8/udfprocs_8h.html#a127">UdfExceptionFilter</a>( IrpContext, GetExceptionInformation() )) {
01405 
01406                 <span class="comment">//</span>
01407                 <span class="comment">//   Any error we receive is an indication that the given fileid is</span>
01408                 <span class="comment">//   not valid.</span>
01409                 <span class="comment">//</span>
01410 
01411                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
01412             }
01413 
01414             <span class="comment">//</span>
01415             <span class="comment">//  Do a little dance to leave the exception handler if we had problems.</span>
01416             <span class="comment">//</span>
01417             
01418             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_INVALID_PARAMETER) {
01419 
01420                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( NOTHING );
01421             }
01422         }
01423         
01424         <span class="comment">//</span>
01425         <span class="comment">//  We have the Fcb.  Check that the type of the file is compatible with</span>
01426         <span class="comment">//  the desired type of file to open.</span>
01427         <span class="comment">//</span>
01428 
01429         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( NextFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o11">FileAttributes</a>, FILE_ATTRIBUTE_DIRECTORY )) {
01430 
01431             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;Parameters.Create.Options, FILE_NON_DIRECTORY_FILE )) {
01432 
01433                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_FILE_IS_A_DIRECTORY );
01434             }
01435 
01436         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;Parameters.Create.Options, FILE_DIRECTORY_FILE )) {
01437 
01438             <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NOT_A_DIRECTORY );
01439         }
01440 
01441         <span class="comment">//</span>
01442         <span class="comment">//  We now know the Fcb and currently hold the Vcb lock.</span>
01443         <span class="comment">//  Try to acquire this Fcb without waiting.  Otherwise we</span>
01444         <span class="comment">//  need to reference it, drop the Vcb, acquire the Fcb, the</span>
01445         <span class="comment">//  Vcb and then dereference the Fcb.</span>
01446         <span class="comment">//</span>
01447 
01448         <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d8/udfprocs_8h.html#a83">UdfAcquireFcbExclusive</a>( IrpContext, NextFcb, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> )) {
01449 
01450             NextFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o8">FcbReference</a> += 1;
01451             <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, Vcb );
01452 
01453             <a class="code" href="../../d3/d8/udfprocs_8h.html#a83">UdfAcquireFcbExclusive</a>( IrpContext, NextFcb, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01454 
01455             <a class="code" href="../../d3/d8/udfprocs_8h.html#a88">UdfLockVcb</a>( IrpContext, Vcb );
01456             NextFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o8">FcbReference</a> -= 1;
01457         }
01458 
01459         <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, Vcb );
01460         UnlockVcb = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01461 
01462         <span class="comment">//</span>
01463         <span class="comment">//  Move to this Fcb.</span>
01464         <span class="comment">//</span>
01465 
01466         *CurrentFcb = NextFcb;
01467 
01468         <span class="comment">//</span>
01469         <span class="comment">//  Check the requested access on this Fcb.</span>
01470         <span class="comment">//</span>
01471 
01472         <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d8/udfprocs_8h.html#a145">UdfIllegalFcbAccess</a>( IrpContext,
01473                                   TypeOfOpen,
01474                                   IrpSp-&gt;Parameters.Create.SecurityContext-&gt;DesiredAccess )) {
01475 
01476             <span class="comment">//</span>
01477             <span class="comment">//  Call our worker routine to complete the open.</span>
01478             <span class="comment">//</span>
01479 
01480             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfs_2create_8c.html#a6">UdfCompleteFcbOpen</a>( IrpContext,
01481                                          IrpSp,
01482                                          Vcb,
01483                                          CurrentFcb,
01484                                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01485                                          TypeOfOpen,
01486                                          <a class="code" href="../../d6/d8/udfstruc_8h.html#a20">CCB_FLAG_OPEN_BY_ID</a>,
01487                                          IrpSp-&gt;Parameters.Create.SecurityContext-&gt;DesiredAccess );
01488         }
01489 
01490     } finally {
01491 
01492         <span class="keywordflow">if</span> (UnlockVcb) {
01493 
01494             <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, Vcb );
01495         }
01496 
01497         <span class="keywordflow">if</span> (CleanupIcbContext) {
01498 
01499             <a class="code" href="../../d3/d8/udfprocs_8h.html#a224">UdfCleanupIcbContext</a>( IrpContext, &amp;IcbContext );
01500         }
01501         
01502         <span class="comment">//</span>
01503         <span class="comment">//  Destroy the new Fcb if it was not fully initialized.</span>
01504         <span class="comment">//</span>
01505 
01506         <span class="keywordflow">if</span> (NextFcb &amp;&amp; !<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( NextFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o10">FcbState</a>, <a class="code" href="../../d6/d8/udfstruc_8h.html#a13">FCB_STATE_INITIALIZED</a> )) {
01507 
01508             <a class="code" href="../../d3/d8/udfprocs_8h.html#a214">UdfDeleteFcb</a>( IrpContext, NextFcb );
01509         }
01510 
01511     }
01512 
01513     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01514 }
01515 
01516 
01517 <span class="comment">//</span>
01518 <span class="comment">//  Local support routine</span>
01519 <span class="comment">//</span>
01520 
01521 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01522"></a><a class="code" href="../../d3/d8/udfs_2create_8c.html#a3">01522</a> <a class="code" href="../../d3/d8/udfs_2create_8c.html#a3">UdfOpenExistingFcb</a> (
01523     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
01524     IN <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp,
01525     IN OUT <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> *CurrentFcb,
01526     IN <a class="code" href="../../d5/d9/struct__LCB.html">PLCB</a> OpenLcb,
01527     IN TYPE_OF_OPEN TypeOfOpen,
01528     IN BOOLEAN IgnoreCase,
01529     IN <a class="code" href="../../d2/d9/struct__CCB.html">PCCB</a> RelatedCcb OPTIONAL
01530     )
01531 
01532 <span class="comment">/*++</span>
01533 <span class="comment"></span>
01534 <span class="comment">Routine Description:</span>
01535 <span class="comment"></span>
01536 <span class="comment">    This routine is called to open an Fcb which is already in the Fcb table.</span>
01537 <span class="comment">    We will verify the access to the file and then call our worker routine</span>
01538 <span class="comment">    to perform the final operations.</span>
01539 <span class="comment"></span>
01540 <span class="comment">Arguments:</span>
01541 <span class="comment"></span>
01542 <span class="comment">    IrpSp - Pointer to the stack location for this open.</span>
01543 <span class="comment"></span>
01544 <span class="comment">    CurrentFcb - Address of Fcb to open.  We will clear this if the Fcb</span>
01545 <span class="comment">        is released here.</span>
01546 <span class="comment">        </span>
01547 <span class="comment">    OpenLcb - Lcb used to find this Fcb.</span>
01548 <span class="comment"></span>
01549 <span class="comment">    TypeOfOpen - Indicates whether we are opening a file, directory or volume.</span>
01550 <span class="comment"></span>
01551 <span class="comment">    IgnoreCase - Indicates if this open is case-insensitive.</span>
01552 <span class="comment"></span>
01553 <span class="comment">    RelatedCcb - Ccb for related file object if relative open.  We use</span>
01554 <span class="comment">        this when setting the Ccb flags for this open.  It will tell</span>
01555 <span class="comment">        us whether the name currently in the file object is relative or</span>
01556 <span class="comment">        absolute.</span>
01557 <span class="comment"></span>
01558 <span class="comment">Return Value:</span>
01559 <span class="comment"></span>
01560 <span class="comment">    NTSTATUS - Status indicating the result of the operation.</span>
01561 <span class="comment"></span>
01562 <span class="comment">--*/</span>
01563 
01564 {
01565     ULONG CcbFlags = 0;
01566 
01567     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED;
01568 
01569     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01570 
01571     <span class="comment">//</span>
01572     <span class="comment">//  Check inputs.</span>
01573     <span class="comment">//</span>
01574 
01575     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
01576     <a class="code" href="../../d1/d8/udfdata_8h.html#a43">ASSERT_EXCLUSIVE_FCB</a>( *CurrentFcb );
01577     <a class="code" href="../../d1/d8/udfdata_8h.html#a23">ASSERT_OPTIONAL_CCB</a>( RelatedCcb );
01578 
01579     <span class="comment">//</span>
01580     <span class="comment">//  Check that the desired access is legal.</span>
01581     <span class="comment">//</span>
01582 
01583     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d8/udfprocs_8h.html#a145">UdfIllegalFcbAccess</a>( IrpContext,
01584                               TypeOfOpen,
01585                               IrpSp-&gt;Parameters.Create.SecurityContext-&gt;DesiredAccess )) {
01586 
01587         <span class="comment">//</span>
01588         <span class="comment">//  Set the Ignore case.</span>
01589         <span class="comment">//</span>
01590 
01591         <span class="keywordflow">if</span> (IgnoreCase) {
01592 
01593             <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( CcbFlags, <a class="code" href="../../d6/d8/udfstruc_8h.html#a22">CCB_FLAG_IGNORE_CASE</a> );
01594         }
01595 
01596         <span class="comment">//</span>
01597         <span class="comment">//  Check the related Ccb to see if this was an OpenByFileId and</span>
01598         <span class="comment">//  whether there was a version.</span>
01599         <span class="comment">//</span>
01600 
01601         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( RelatedCcb )) {
01602 
01603             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( RelatedCcb-&gt;Flags, <a class="code" href="../../d6/d8/udfstruc_8h.html#a20">CCB_FLAG_OPEN_BY_ID</a> | <a class="code" href="../../d6/d8/udfstruc_8h.html#a21">CCB_FLAG_OPEN_RELATIVE_BY_ID</a> )) {
01604 
01605                 <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( CcbFlags, <a class="code" href="../../d6/d8/udfstruc_8h.html#a21">CCB_FLAG_OPEN_RELATIVE_BY_ID</a> );
01606             }
01607         }
01608 
01609         <span class="comment">//</span>
01610         <span class="comment">//  Call our worker routine to complete the open.</span>
01611         <span class="comment">//</span>
01612 
01613         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfs_2create_8c.html#a6">UdfCompleteFcbOpen</a>( IrpContext,
01614                                      IrpSp,
01615                                      (*CurrentFcb)-&gt;Vcb,
01616                                      CurrentFcb,
01617                                      OpenLcb,
01618                                      TypeOfOpen,
01619                                      CcbFlags,
01620                                      IrpSp-&gt;Parameters.Create.SecurityContext-&gt;DesiredAccess );
01621     }
01622 
01623     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01624 }
01625 
01626 
01627 <span class="comment">//</span>
01628 <span class="comment">//  Local support routine</span>
01629 <span class="comment">//</span>
01630 
01631 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01632"></a><a class="code" href="../../d3/d8/udfs_2create_8c.html#a5">01632</a> <a class="code" href="../../d3/d8/udfs_2create_8c.html#a5">UdfOpenObjectFromDirContext</a> (
01633     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
01634     IN <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp,
01635     IN <a class="code" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb,
01636     IN OUT <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> *CurrentFcb,
01637     IN BOOLEAN ShortNameMatch,                             
01638     IN BOOLEAN IgnoreCase,
01639     IN <a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html">PDIR_ENUM_CONTEXT</a> DirContext,
01640     IN BOOLEAN PerformUserOpen,
01641     IN <a class="code" href="../../d2/d9/struct__CCB.html">PCCB</a> RelatedCcb OPTIONAL
01642     )
01643 
01644 <span class="comment">/*++</span>
01645 <span class="comment"></span>
01646 <span class="comment">Routine Description:</span>
01647 <span class="comment"></span>
01648 <span class="comment">    This routine is called to open an object found in a directory scan.  This</span>
01649 <span class="comment">    can be a directory or a file as indicated in the scan's results.</span>
01650 <span class="comment"></span>
01651 <span class="comment">    We first check that the desired access is legal for this file.  Then we</span>
01652 <span class="comment">    construct the FileId for this and do a check to see if it is the Fcb</span>
01653 <span class="comment">    Table.  It is always possible that either it was created since or simply</span>
01654 <span class="comment">    wasn't in the prefix table at the time of the prefix table search.</span>
01655 <span class="comment">    Lookup the active ICB, initialize the Fcb and store into the FcbTable</span>
01656 <span class="comment">    if not present.</span>
01657 <span class="comment"></span>
01658 <span class="comment">    Next we will add this to the prefix table of our parent if needed.</span>
01659 <span class="comment"></span>
01660 <span class="comment">    Once we know that the new Fcb has been initialized then we move our pointer</span>
01661 <span class="comment">    in the tree down to this position.</span>
01662 <span class="comment"></span>
01663 <span class="comment">    This routine does not own the Vcb lock on entry.  We must be sure to release</span>
01664 <span class="comment">    it on exit.</span>
01665 <span class="comment"></span>
01666 <span class="comment">Arguments:</span>
01667 <span class="comment"></span>
01668 <span class="comment">    IrpSp - Stack location for this request.</span>
01669 <span class="comment"></span>
01670 <span class="comment">    Vcb - Vcb for the current volume.</span>
01671 <span class="comment"></span>
01672 <span class="comment">    CurrentFcb - On input this is the parent of the Fcb to open.  On output we</span>
01673 <span class="comment">        store the Fcb for the file being opened.</span>
01674 <span class="comment">        </span>
01675 <span class="comment">    ShortNameMatch - Indicates whether this object was opened by the shortname.</span>
01676 <span class="comment"></span>
01677 <span class="comment">    IgnoreCase - Indicates the case sensitivity of the caller.</span>
01678 <span class="comment"></span>
01679 <span class="comment">    DirContext - This is the context used to find the object.</span>
01680 <span class="comment">    </span>
01681 <span class="comment">    PerformUserOpen - Indicates if we are at the object the user wants to finally open.</span>
01682 <span class="comment"></span>
01683 <span class="comment">    RelatedCcb - RelatedCcb for relative file object used to make this open.</span>
01684 <span class="comment"></span>
01685 <span class="comment">Return Value:</span>
01686 <span class="comment"></span>
01687 <span class="comment">    NTSTATUS - Status indicating the result of the operation.</span>
01688 <span class="comment"></span>
01689 <span class="comment">--*/</span>
01690 
01691 {
01692     ULONG CcbFlags = 0;
01693     <a class="code" href="../../d6/d8/udfstruc_8h.html#a77">FILE_ID</a> FileId;
01694 
01695     BOOLEAN UnlockVcb = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01696     BOOLEAN FcbExisted;
01697 
01698     <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> NextFcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01699     <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> ParentFcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01700 
01701     <a class="code" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a> TypeOfOpen;
01702     <a class="code" href="../../d0/d7/lfs_2nodetype_8h.html#a7">NODE_TYPE_CODE</a> NodeTypeCode;
01703 
01704     <a class="code" href="../../d9/d9/struct__ICB__SEARCH__CONTEXT.html">ICB_SEARCH_CONTEXT</a> IcbContext;
01705     BOOLEAN CleanupIcbContext = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01706 
01707     <a class="code" href="../../d5/d9/struct__LCB.html">PLCB</a> OpenLcb;
01708 
01709     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01710 
01711     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01712 
01713     <span class="comment">//</span>
01714     <span class="comment">//  Figure out what kind of open we will be performing here.  The caller has already insured</span>
01715     <span class="comment">//  that the user is expecting us to do this.</span>
01716     <span class="comment">//</span>
01717 
01718     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( DirContext-&gt;Fid-&gt;Flags, <a class="code" href="../../d0/d7/iso13346_8h.html#a89">NSR_FID_F_DIRECTORY</a> )) {
01719 
01720         TypeOfOpen = <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a116">UserDirectoryOpen</a>;
01721         NodeTypeCode = <a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a3">UDFS_NTC_FCB_INDEX</a>;
01722     
01723     } <span class="keywordflow">else</span> {
01724         
01725         TypeOfOpen = <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a>;
01726         NodeTypeCode = <a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a4">UDFS_NTC_FCB_DATA</a>;
01727     }
01728 
01729     <span class="comment">//</span>
01730     <span class="comment">//  Check for illegal access to this file.</span>
01731     <span class="comment">//</span>
01732 
01733     <span class="keywordflow">if</span> (PerformUserOpen &amp;&amp;
01734         <a class="code" href="../../d3/d8/udfprocs_8h.html#a145">UdfIllegalFcbAccess</a>( IrpContext,
01735                              TypeOfOpen,
01736                              IrpSp-&gt;Parameters.Create.SecurityContext-&gt;DesiredAccess )) {
01737 
01738         <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
01739     }
01740 
01741     <span class="comment">//</span>
01742     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
01743     <span class="comment">//</span>
01744 
01745     <span class="keywordflow">try</span> {
01746 
01747         <span class="comment">//</span>
01748         <span class="comment">//  Check the related Ccb to see if this was an OpenByFileId.</span>
01749         <span class="comment">//</span>
01750 
01751         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( RelatedCcb ) &amp;&amp;
01752             <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( RelatedCcb-&gt;Flags, <a class="code" href="../../d6/d8/udfstruc_8h.html#a20">CCB_FLAG_OPEN_BY_ID</a> | <a class="code" href="../../d6/d8/udfstruc_8h.html#a21">CCB_FLAG_OPEN_RELATIVE_BY_ID</a> )) {
01753 
01754             <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( CcbFlags, <a class="code" href="../../d6/d8/udfstruc_8h.html#a21">CCB_FLAG_OPEN_RELATIVE_BY_ID</a> );
01755         }
01756 
01757         <span class="keywordflow">if</span> (IgnoreCase) {
01758 
01759             <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( CcbFlags, <a class="code" href="../../d6/d8/udfstruc_8h.html#a22">CCB_FLAG_IGNORE_CASE</a> );
01760         }
01761 
01762         <span class="comment">//</span>
01763         <span class="comment">//  Build the file Id for this object.</span>
01764         <span class="comment">//</span>
01765         
01766         <a class="code" href="../../d6/d8/udfstruc_8h.html#a44">UdfSetFidFromLbAddr</a>( FileId, DirContext-&gt;Fid-&gt;Icb.Start );
01767 
01768         <span class="keywordflow">if</span> (TypeOfOpen == <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a116">UserDirectoryOpen</a>) {
01769 
01770             <a class="code" href="../../d6/d8/udfstruc_8h.html#a49">UdfSetFidDirectory</a>( FileId );
01771         }
01772 
01773         <span class="comment">//</span>
01774         <span class="comment">//  Lock the Vcb so we can examine the Fcb Table.</span>
01775         <span class="comment">//</span>
01776 
01777         <a class="code" href="../../d3/d8/udfprocs_8h.html#a88">UdfLockVcb</a>( IrpContext, Vcb );
01778         UnlockVcb = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01779 
01780         <span class="comment">//</span>
01781         <span class="comment">//  Get the Fcb for this file.</span>
01782         <span class="comment">//</span>
01783 
01784         NextFcb = <a class="code" href="../../d3/d8/udfprocs_8h.html#a213">UdfCreateFcb</a>( IrpContext, FileId, NodeTypeCode, &amp;FcbExisted );
01785 
01786         <span class="comment">//</span>
01787         <span class="comment">//  If the Fcb was created here then initialize from the values in the</span>
01788         <span class="comment">//  dirent.  We have optimistically assumed that there isn't any corrupt</span>
01789         <span class="comment">//  information to this point - we're about to discover it if there is.</span>
01790         <span class="comment">//</span>
01791 
01792         <span class="keywordflow">if</span> (!FcbExisted) {
01793 
01794             <span class="comment">//</span>
01795             <span class="comment">//  Set the root extent length and go get the active ICB, initialize.</span>
01796             <span class="comment">//</span>
01797 
01798             NextFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o5">RootExtentLength</a> = DirContext-&gt;Fid-&gt;Icb.Length.Length;
01799 
01800             <a class="code" href="../../d3/d8/udfprocs_8h.html#a220">UdfInitializeIcbContextFromFcb</a>( IrpContext, &amp;IcbContext, NextFcb );
01801             CleanupIcbContext = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01802 
01803             <a class="code" href="../../d3/d8/udfprocs_8h.html#a223">UdfLookupActiveIcb</a>( IrpContext, &amp;IcbContext );
01804             
01805             <a class="code" href="../../d3/d8/udfprocs_8h.html#a215">UdfInitializeFcbFromIcbContext</a>( IrpContext,
01806                                             NextFcb,
01807                                             &amp;IcbContext );
01808 
01809             <a class="code" href="../../d3/d8/udfprocs_8h.html#a224">UdfCleanupIcbContext</a>( IrpContext, &amp;IcbContext );
01810             CleanupIcbContext = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01811 
01812         }
01813 
01814         <span class="comment">//</span>
01815         <span class="comment">//  Now try to acquire the new Fcb without waiting.  We will reference</span>
01816         <span class="comment">//  the Fcb and retry with wait if unsuccessful.</span>
01817         <span class="comment">//</span>
01818 
01819         <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d8/udfprocs_8h.html#a83">UdfAcquireFcbExclusive</a>( IrpContext, NextFcb, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> )) {
01820 
01821             NextFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o8">FcbReference</a> += 1;
01822 
01823             <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, Vcb );
01824 
01825             <a class="code" href="../../d3/d8/udfprocs_8h.html#a85">UdfReleaseFcb</a>( IrpContext, *CurrentFcb );
01826             <a class="code" href="../../d3/d8/udfprocs_8h.html#a83">UdfAcquireFcbExclusive</a>( IrpContext, NextFcb, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01827             <a class="code" href="../../d3/d8/udfprocs_8h.html#a83">UdfAcquireFcbExclusive</a>( IrpContext, *CurrentFcb, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01828 
01829             <a class="code" href="../../d3/d8/udfprocs_8h.html#a88">UdfLockVcb</a>( IrpContext, Vcb );
01830             NextFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o8">FcbReference</a> -= 1;
01831         }
01832 
01833         <span class="comment">//</span>
01834         <span class="comment">//  Move down to this new Fcb.  Remember that we still own the parent however.</span>
01835         <span class="comment">//</span>
01836 
01837         ParentFcb = *CurrentFcb;
01838         *CurrentFcb = NextFcb;
01839 
01840         <span class="comment">//</span>
01841         <span class="comment">//  Store this name into the prefix table for the parent.</span>
01842         <span class="comment">//</span>
01843 
01844         OpenLcb = <a class="code" href="../../d3/d8/udfprocs_8h.html#a194">UdfInsertPrefix</a>( IrpContext,
01845                                    NextFcb,
01846                                    ( ShortNameMatch?
01847                                      &amp;DirContext-&gt;ShortObjectName :
01848                                      &amp;DirContext-&gt;CaseObjectName ),
01849                                    ShortNameMatch,
01850                                    IgnoreCase,
01851                                    ParentFcb );
01852 
01853         <span class="comment">//</span>
01854         <span class="comment">//  Now increment the reference counts for the parent and drop the Vcb.</span>
01855         <span class="comment">//</span>
01856 
01857         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>,
01858                      <span class="stringliteral">"UdfOpenObjectFromDirContext, PFcb %08x Vcb %d/%d Fcb %d/%d\n"</span>, ParentFcb,
01859                      Vcb-&gt;VcbReference,
01860                      Vcb-&gt;VcbUserReference,
01861                      ParentFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o8">FcbReference</a>,
01862                      ParentFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o9">FcbUserReference</a> ));
01863 
01864         <a class="code" href="../../d3/d8/udfprocs_8h.html#a98">UdfIncrementReferenceCounts</a>( IrpContext, ParentFcb, 1, 1 );
01865         
01866         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, 
01867                      <span class="stringliteral">"UdfOpenObjectFromDirContext, Vcb %d/%d Fcb %d/%d\n"</span>,
01868                      Vcb-&gt;VcbReference,
01869                      Vcb-&gt;VcbUserReference,
01870                      ParentFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o8">FcbReference</a>,
01871                      ParentFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o9">FcbUserReference</a> ));
01872 
01873         <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, Vcb );
01874         UnlockVcb = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01875 
01876         <span class="comment">//</span>
01877         <span class="comment">//  Perform initialization associated with the directory context.</span>
01878         <span class="comment">//</span>
01879             
01880         <a class="code" href="../../d3/d8/udfprocs_8h.html#a193">UdfInitializeLcbFromDirContext</a>( IrpContext,
01881                                         OpenLcb,
01882                                         DirContext );
01883 
01884         <span class="comment">//</span>
01885         <span class="comment">//  Release the parent Fcb at this point.</span>
01886         <span class="comment">//</span>
01887 
01888         <a class="code" href="../../d3/d8/udfprocs_8h.html#a85">UdfReleaseFcb</a>( IrpContext, ParentFcb );
01889         ParentFcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01890 
01891         <span class="comment">//</span>
01892         <span class="comment">//  Call our worker routine to complete the open.</span>
01893         <span class="comment">//</span>
01894 
01895         <span class="keywordflow">if</span> (PerformUserOpen) {
01896 
01897             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfs_2create_8c.html#a6">UdfCompleteFcbOpen</a>( IrpContext,
01898                                          IrpSp,
01899                                          Vcb,
01900                                          CurrentFcb,
01901                                          OpenLcb,
01902                                          TypeOfOpen,
01903                                          CcbFlags,
01904                                          IrpSp-&gt;Parameters.Create.SecurityContext-&gt;DesiredAccess );
01905         }
01906 
01907     } finally {
01908 
01909         <span class="comment">//</span>
01910         <span class="comment">//  Unlock the Vcb if held.</span>
01911         <span class="comment">//</span>
01912 
01913         <span class="keywordflow">if</span> (UnlockVcb) {
01914 
01915             <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, Vcb );
01916         }
01917 
01918         <span class="comment">//</span>
01919         <span class="comment">//  Release the parent if held.</span>
01920         <span class="comment">//</span>
01921 
01922         <span class="keywordflow">if</span> (ParentFcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01923 
01924             <a class="code" href="../../d3/d8/udfprocs_8h.html#a85">UdfReleaseFcb</a>( IrpContext, ParentFcb );
01925         }
01926 
01927         <span class="comment">//</span>
01928         <span class="comment">//  Destroy the new Fcb if it was not fully initialized.</span>
01929         <span class="comment">//</span>
01930 
01931         <span class="keywordflow">if</span> (NextFcb &amp;&amp; !<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( NextFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o10">FcbState</a>, <a class="code" href="../../d6/d8/udfstruc_8h.html#a13">FCB_STATE_INITIALIZED</a> )) {
01932 
01933             <a class="code" href="../../d3/d8/udfprocs_8h.html#a214">UdfDeleteFcb</a>( IrpContext, NextFcb );
01934         }
01935 
01936         <span class="comment">//</span>
01937         <span class="comment">//  Clean up the Icb context if used.</span>
01938         <span class="comment">//</span>
01939 
01940         <span class="keywordflow">if</span> (CleanupIcbContext) {
01941 
01942             <a class="code" href="../../d3/d8/udfprocs_8h.html#a224">UdfCleanupIcbContext</a>( IrpContext, &amp;IcbContext );
01943         }
01944     }
01945 
01946     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01947 }
01948 
01949 
01950 <span class="comment">//</span>
01951 <span class="comment">//  Local support routine</span>
01952 <span class="comment">//</span>
01953 
01954 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01955"></a><a class="code" href="../../d3/d8/udfs_2create_8c.html#a6">01955</a> <a class="code" href="../../d3/d8/udfs_2create_8c.html#a6">UdfCompleteFcbOpen</a> (
01956     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
01957     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp,
01958     IN <a class="code" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb,
01959     IN OUT <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> *CurrentFcb,
01960     IN <a class="code" href="../../d5/d9/struct__LCB.html">PLCB</a> OpenLcb OPTIONAL,
01961     IN TYPE_OF_OPEN TypeOfOpen,
01962     IN ULONG UserCcbFlags,
01963     IN ACCESS_MASK DesiredAccess
01964     )
01965 
01966 <span class="comment">/*++</span>
01967 <span class="comment"></span>
01968 <span class="comment">Routine Description:</span>
01969 <span class="comment"></span>
01970 <span class="comment">    This is the worker routine which takes an existing Fcb and completes</span>
01971 <span class="comment">    the open.  We will do any necessary oplock checks and sharing checks.</span>
01972 <span class="comment">    Finally we will create the Ccb and update the file object and any</span>
01973 <span class="comment">    file object flags.</span>
01974 <span class="comment"></span>
01975 <span class="comment">Arguments:</span>
01976 <span class="comment"></span>
01977 <span class="comment">    IrpSp - Stack location for the current request.</span>
01978 <span class="comment"></span>
01979 <span class="comment">    Vcb - Vcb for the current volume.</span>
01980 <span class="comment"></span>
01981 <span class="comment">    CurrentFcb - Address of pointer to Fcb to open.  We clear this field if</span>
01982 <span class="comment">        we release the resource for this file.</span>
01983 <span class="comment">        </span>
01984 <span class="comment">    OpenLcb - Lcb this Fcb is being opened by</span>
01985 <span class="comment"></span>
01986 <span class="comment">    TypeOfOpen - Type of open for this request.</span>
01987 <span class="comment"></span>
01988 <span class="comment">    UserCcbFlags - Flags to OR into the Ccb flags.</span>
01989 <span class="comment"></span>
01990 <span class="comment">    DesiredAccess - Desired access for this open.</span>
01991 <span class="comment"></span>
01992 <span class="comment">Return Value:</span>
01993 <span class="comment"></span>
01994 <span class="comment">    NTSTATUS - STATUS_SUCCESS if we complete this request, STATUS_PENDING if</span>
01995 <span class="comment">        the oplock package takes the Irp or SHARING_VIOLATION if there is a</span>
01996 <span class="comment">        sharing check conflict.</span>
01997 <span class="comment"></span>
01998 <span class="comment">--*/</span>
01999 
02000 {
02001     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02002     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> OplockStatus = STATUS_SUCCESS;
02003     ULONG Information = FILE_OPENED;
02004 
02005     BOOLEAN LockVolume = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02006 
02007     <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb = *CurrentFcb;
02008     <a class="code" href="../../d2/d9/struct__CCB.html">PCCB</a> Ccb;
02009 
02010     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02011 
02012     <span class="comment">//</span>
02013     <span class="comment">//  If this a volume open and the user wants to lock the volume then</span>
02014     <span class="comment">//  purge and lock the volume.</span>
02015     <span class="comment">//</span>
02016 
02017     <span class="keywordflow">if</span> ((TypeOfOpen &lt;= <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a115">UserVolumeOpen</a>) &amp;&amp;
02018         !<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.ShareAccess, FILE_SHARE_READ )) {
02019 
02020         <span class="comment">//</span>
02021         <span class="comment">//  If there are open handles then fail this immediately.</span>
02022         <span class="comment">//</span>
02023 
02024         <span class="keywordflow">if</span> (Vcb-&gt;VcbCleanup != 0) {
02025 
02026             <span class="keywordflow">return</span> STATUS_SHARING_VIOLATION;
02027         }
02028 
02029         <span class="comment">//</span>
02030         <span class="comment">//  If we can't wait then force this to be posted.</span>
02031         <span class="comment">//</span>
02032 
02033         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpContext-&gt;Flags, <a class="code" href="../../d6/d8/udfstruc_8h.html#a30">IRP_CONTEXT_FLAG_WAIT</a> )) {
02034 
02035             <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_CANT_WAIT );
02036         }
02037 
02038         LockVolume = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02039 
02040         <span class="comment">//</span>
02041         <span class="comment">//  Purge the volume and make sure all of the user references</span>
02042         <span class="comment">//  are gone.</span>
02043         <span class="comment">//</span>
02044 
02045         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a158">UdfPurgeVolume</a>( IrpContext, Vcb, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
02046 
02047         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) {
02048 
02049             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02050         }
02051 
02052         <span class="comment">//</span>
02053         <span class="comment">//  Now force all of the delayed close operations to go away.</span>
02054         <span class="comment">//</span>
02055 
02056         <a class="code" href="../../d3/d8/udfprocs_8h.html#a250">UdfFspClose</a>( Vcb );
02057 
02058         <span class="keywordflow">if</span> (Vcb-&gt;VcbUserReference &gt; Vcb-&gt;VcbResidualUserReference) {
02059 
02060             <span class="keywordflow">return</span> STATUS_SHARING_VIOLATION;
02061         }
02062     }
02063 
02064     <span class="comment">//</span>
02065     <span class="comment">//  If the Fcb already existed then we need to check the oplocks and</span>
02066     <span class="comment">//  the share access.</span>
02067     <span class="comment">//</span>
02068 
02069     <span class="keywordflow">if</span> (Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o7">FcbCleanup</a> != 0) {
02070 
02071         <span class="comment">//</span>
02072         <span class="comment">//  If this is a user file open then check whether there are any</span>
02073         <span class="comment">//  batch oplock.</span>
02074         <span class="comment">//</span>
02075 
02076         <span class="keywordflow">if</span> (TypeOfOpen == <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a>) {
02077 
02078             <span class="comment">//</span>
02079             <span class="comment">//  Store the address of the Fcb for a possible teardown into</span>
02080             <span class="comment">//  the IrpContext.  We will release this in the call to</span>
02081             <span class="comment">//  prepost the Irp.</span>
02082             <span class="comment">//</span>
02083 
02084             IrpContext-&gt;TeardownFcb = CurrentFcb;
02085 
02086             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/fsrtl_8h.html#a167">FsRtlCurrentBatchOplock</a>( &amp;Fcb-&gt;Oplock )) {
02087 
02088                 <span class="comment">//</span>
02089                 <span class="comment">//  We remember if a batch oplock break is underway for the</span>
02090                 <span class="comment">//  case where the sharing check fails.</span>
02091                 <span class="comment">//</span>
02092 
02093                 Information = FILE_OPBATCH_BREAK_UNDERWAY;
02094 
02095                 OplockStatus = <a class="code" href="../../d1/d8/fsrtl_8h.html#a165">FsRtlCheckOplock</a>( &amp;Fcb-&gt;Oplock,
02096                                                  IrpContext-&gt;Irp,
02097                                                  IrpContext,
02098                                                  <a class="code" href="../../d3/d8/udfprocs_8h.html#a247">UdfOplockComplete</a>,
02099                                                  <a class="code" href="../../d3/d8/udfprocs_8h.html#a246">UdfPrePostIrp</a> );
02100 
02101                 <span class="keywordflow">if</span> (OplockStatus == STATUS_PENDING) {
02102 
02103                     <span class="keywordflow">return</span> STATUS_PENDING;
02104                 }
02105             }
02106 
02107             <span class="comment">//</span>
02108             <span class="comment">//  Check the share access before breaking any exclusive oplocks.</span>
02109             <span class="comment">//</span>
02110 
02111             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d6/iosubs_8c.html#a38">IoCheckShareAccess</a>( DesiredAccess,
02112                                          IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.ShareAccess,
02113                                          IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>,
02114                                          &amp;Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o18">ShareAccess</a>,
02115                                          <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
02116 
02117             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
02118 
02119                 <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02120             }
02121 
02122             <span class="comment">//</span>
02123             <span class="comment">//  Now check that we can continue based on the oplock state of the</span>
02124             <span class="comment">//  file.</span>
02125             <span class="comment">//</span>
02126 
02127             OplockStatus = <a class="code" href="../../d1/d8/fsrtl_8h.html#a165">FsRtlCheckOplock</a>( &amp;Fcb-&gt;Oplock,
02128                                              IrpContext-&gt;Irp,
02129                                              IrpContext,
02130                                              <a class="code" href="../../d3/d8/udfprocs_8h.html#a247">UdfOplockComplete</a>,
02131                                              <a class="code" href="../../d3/d8/udfprocs_8h.html#a246">UdfPrePostIrp</a> );
02132 
02133             <span class="keywordflow">if</span> (OplockStatus == STATUS_PENDING) {
02134 
02135                 <span class="keywordflow">return</span> STATUS_PENDING;
02136             }
02137 
02138             IrpContext-&gt;TeardownFcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02139 
02140         <span class="comment">//</span>
02141         <span class="comment">//  Otherwise just do the sharing check.</span>
02142         <span class="comment">//</span>
02143 
02144         } <span class="keywordflow">else</span> {
02145 
02146             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d6/iosubs_8c.html#a38">IoCheckShareAccess</a>( DesiredAccess,
02147                                          IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.ShareAccess,
02148                                          IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>,
02149                                          &amp;Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o18">ShareAccess</a>,
02150                                          <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
02151 
02152             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
02153 
02154                 <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02155             }
02156         }
02157     }
02158 
02159     <span class="comment">//</span>
02160     <span class="comment">//  Create the Ccb now.</span>
02161     <span class="comment">//</span>
02162 
02163     Ccb = <a class="code" href="../../d3/d8/udfprocs_8h.html#a216">UdfCreateCcb</a>( IrpContext, Fcb, OpenLcb, UserCcbFlags );
02164 
02165     <span class="comment">//</span>
02166     <span class="comment">//  Update the share access.</span>
02167     <span class="comment">//</span>
02168 
02169     <span class="keywordflow">if</span> (Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o7">FcbCleanup</a> == 0) {
02170 
02171         <a class="code" href="../../d4/d6/iosubs_8c.html#a107">IoSetShareAccess</a>( DesiredAccess,
02172                           IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.ShareAccess,
02173                           IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>,
02174                           &amp;Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o18">ShareAccess</a> );
02175 
02176     } <span class="keywordflow">else</span> {
02177 
02178         <a class="code" href="../../d4/d6/iosubs_8c.html#a121">IoUpdateShareAccess</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>, &amp;Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o18">ShareAccess</a> );
02179     }
02180 
02181     <span class="comment">//</span>
02182     <span class="comment">//  Set the file object type.</span>
02183     <span class="comment">//</span>
02184 
02185     <a class="code" href="../../d3/d8/udfprocs_8h.html#a173">UdfSetFileObject</a>( IrpContext, IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>, TypeOfOpen, Fcb, Ccb );
02186 
02187     <span class="comment">//</span>
02188     <span class="comment">//  Set the appropriate cache flags for a user file object.</span>
02189     <span class="comment">//</span>
02190 
02191     <span class="keywordflow">if</span> (TypeOfOpen == <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a>) {
02192 
02193         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.Options, FILE_NO_INTERMEDIATE_BUFFERING )) {
02194 
02195             <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a>, <a class="code" href="../../d0/d5/io_8h.html#a153">FO_NO_INTERMEDIATE_BUFFERING</a> );
02196 
02197         } <span class="keywordflow">else</span> {
02198 
02199             <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a>, <a class="code" href="../../d0/d5/io_8h.html#a156">FO_CACHE_SUPPORTED</a> );
02200         }
02201     }
02202     <span class="comment">//</span>
02203     <span class="comment">//  Update the open and cleanup counts.  Check the fast io state here.</span>
02204     <span class="comment">//</span>
02205 
02206     <a class="code" href="../../d3/d8/udfprocs_8h.html#a88">UdfLockVcb</a>( IrpContext, Vcb );
02207 
02208     <a class="code" href="../../d3/d8/udfprocs_8h.html#a96">UdfIncrementCleanupCounts</a>( IrpContext, Fcb );
02209     
02210     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>,
02211                  <span class="stringliteral">"UdfCompleteFcbOpen, Fcb %08x Vcb %d/%d Fcb %d/%d\n"</span>, Fcb,
02212                  Vcb-&gt;VcbReference,
02213                  Vcb-&gt;VcbUserReference,
02214                  Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o8">FcbReference</a>,
02215                  Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o9">FcbUserReference</a> ));
02216 
02217     <a class="code" href="../../d3/d8/udfprocs_8h.html#a98">UdfIncrementReferenceCounts</a>( IrpContext, Fcb, 1, 1 );
02218     
02219     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>,
02220                  <span class="stringliteral">"UdfCompleteFcbOpen, Vcb %d/%d Fcb %d/%d\n"</span>,
02221                  Vcb-&gt;VcbReference,
02222                  Vcb-&gt;VcbUserReference,
02223                  Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o8">FcbReference</a>,
02224                  Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o9">FcbUserReference</a> ));
02225 
02226     <span class="keywordflow">if</span> (LockVolume) {
02227 
02228         Vcb-&gt;VolumeLockFileObject = IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>;
02229         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Vcb-&gt;VcbState, <a class="code" href="../../d6/d8/udfstruc_8h.html#a5">VCB_STATE_LOCKED</a> );
02230     }
02231 
02232     <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, Vcb );
02233 
02234     <a class="code" href="../../d3/d8/udfprocs_8h.html#a90">UdfLockFcb</a>( IrpContext, Fcb );
02235 
02236     <span class="keywordflow">if</span> (TypeOfOpen == <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a>) {
02237 
02238         Fcb-&gt;IsFastIoPossible = <a class="code" href="../../d3/d8/udfprocs_8h.html#a63">UdfIsFastIoPossible</a>( Fcb );
02239 
02240     } <span class="keywordflow">else</span> {
02241 
02242         Fcb-&gt;IsFastIoPossible = <a class="code" href="../../d1/d8/fsrtl_8h.html#a188a86">FastIoIsNotPossible</a>;
02243     }
02244 
02245     <a class="code" href="../../d3/d8/udfprocs_8h.html#a91">UdfUnlockFcb</a>( IrpContext, Fcb );
02246 
02247     <span class="comment">//</span>
02248     <span class="comment">//  Show that we opened the file.</span>
02249     <span class="comment">//</span>
02250 
02251     IrpContext-&gt;Irp-&gt;IoStatus.Information = Information;
02252 
02253     <span class="comment">//</span>
02254     <span class="comment">//  Point to the section object pointer in the non-paged Fcb.</span>
02255     <span class="comment">//</span>
02256 
02257     IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o6">SectionObjectPointer</a> = &amp;Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o17">FcbNonpaged</a>-&gt;<a class="code" href="../../d4/d0/struct__FCB__NONPAGED.html#o2">SegmentObject</a>;
02258     <span class="keywordflow">return</span> OplockStatus;
02259 }
02260 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:35 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
