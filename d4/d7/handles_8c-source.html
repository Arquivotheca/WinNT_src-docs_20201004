<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: handles.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>handles.c</h1><a href="../../d3/d8/handles_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: handles.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* HANDLES.C - Data handle manager</span>
00007 <span class="comment">*</span>
00008 <span class="comment">*</span>
00009 <span class="comment">* This module allows a 32 bit value to be converted into a handle that</span>
00010 <span class="comment">* can be validated with a high probability of correctness.</span>
00011 <span class="comment">*</span>
00012 <span class="comment">* A handle array is kept which contains the 32 bit data associated with</span>
00013 <span class="comment">* it, and a copy of the correect handle value. The handle itself is</span>
00014 <span class="comment">* composed of a combination of the index into the array for the associated</span>
00015 <span class="comment">* data, the instance value, a type value and a DDEML instance value.</span>
00016 <span class="comment">*</span>
00017 <span class="comment">* The HIWORD of a handle is guarenteed not to be 0.</span>
00018 <span class="comment">*</span>
00019 <span class="comment">* History:</span>
00020 <span class="comment">* 10-28-91 Sanfords Created</span>
00021 <span class="comment">\***************************************************************************/</span>
00022 
00023 <span class="preprocessor">#include "<a class="code" href="../../d7/d3/w32_2ntuser_2client_2precomp_8h.html">precomp.h</a>"</span>
00024 <span class="preprocessor">#pragma hdrstop</span>
00025 <span class="preprocessor"></span>
00026 <span class="comment">// globals</span>
00027 
<a name="l00028"></a><a class="code" href="../../d3/d8/handles_8c.html#a2">00028</a> <a class="code" href="../../d8/d9/structtagCHANDLEENTRY.html">PCHANDLEENTRY</a> <a class="code" href="../../d3/d8/handles_8c.html#a2">aHandleEntry</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00029 
00030 <span class="comment">// statics</span>
00031 
<a name="l00032"></a><a class="code" href="../../d3/d8/handles_8c.html#a3">00032</a> <span class="keywordtype">int</span> <a class="code" href="../../d3/d8/handles_8c.html#a3">cHandlesAllocated</a> = 0;
<a name="l00033"></a><a class="code" href="../../d3/d8/handles_8c.html#a4">00033</a> <span class="keywordtype">int</span> <a class="code" href="../../d3/d8/handles_8c.html#a4">iFirstFree</a> = 0;
<a name="l00034"></a><a class="code" href="../../d3/d8/handles_8c.html#a5">00034</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d3/d8/handles_8c.html#a5">nextId</a> = 1;
00035 
<a name="l00036"></a><a class="code" href="../../d3/d8/handles_8c.html#a0">00036</a> <span class="preprocessor">#define GROW_COUNT 16</span>
00037 <span class="preprocessor"></span><span class="comment">// #define TESTING</span>
00038 <span class="preprocessor">#ifdef TESTING</span>
00039 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d3/d8/handles_8c.html#a1">CheckHandleTable</a>()
00040 {
00041     <span class="keywordtype">int</span> i;
00042 
00043     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d3/d8/handles_8c.html#a3">cHandlesAllocated</a>; i++) {
00044         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/handles_8c.html#a2">aHandleEntry</a>[i].<a class="code" href="../../d8/d9/structtagCHANDLEENTRY.html#o0">handle</a> &amp;&amp; <a class="code" href="../../d3/d8/handles_8c.html#a2">aHandleEntry</a>[i].<a class="code" href="../../d8/d9/structtagCHANDLEENTRY.html#o1">dwData</a>) {
00045             <span class="keywordflow">switch</span> (<a class="code" href="../../d0/d4/ddemlcli_8h.html#a27">TypeFromHandle</a>(<a class="code" href="../../d3/d8/handles_8c.html#a2">aHandleEntry</a>[i].handle)) {
00046             <span class="keywordflow">case</span> <a class="code" href="../../d0/d4/ddemlcli_8h.html#a34">HTYPE_INSTANCE</a>:
00047                 UserAssert(((<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html">PCL_INSTANCE_INFO</a>)<a class="code" href="../../d3/d8/handles_8c.html#a2">aHandleEntry</a>[i].dwData)-&gt;hInstClient == <a class="code" href="../../d3/d8/handles_8c.html#a2">aHandleEntry</a>[i].handle);
00048                 <span class="keywordflow">break</span>;
00049 
00050             <span class="keywordflow">case</span> <a class="code" href="../../d0/d4/ddemlcli_8h.html#a36">HTYPE_CLIENT_CONVERSATION</a>:
00051             <span class="keywordflow">case</span> <a class="code" href="../../d0/d4/ddemlcli_8h.html#a35">HTYPE_SERVER_CONVERSATION</a>:
00052                 UserAssert(((<a class="code" href="../../d2/d1/structtagCONV__INFO.html">PCONV_INFO</a>)<a class="code" href="../../d3/d8/handles_8c.html#a2">aHandleEntry</a>[i].dwData)-&gt;hConv == (HCONV)<a class="code" href="../../d3/d8/handles_8c.html#a2">aHandleEntry</a>[i].handle ||
00053                         ((<a class="code" href="../../d2/d1/structtagCONV__INFO.html">PCONV_INFO</a>)<a class="code" href="../../d3/d8/handles_8c.html#a2">aHandleEntry</a>[i].dwData)-&gt;hConv == 0);
00054                 <span class="keywordflow">break</span>;
00055             }
00056         }
00057     }
00058 }
00059 <span class="preprocessor">#else</span>
<a name="l00060"></a><a class="code" href="../../d3/d8/handles_8c.html#a1">00060</a> <span class="preprocessor"></span><span class="preprocessor">#define CheckHandleTable()</span>
00061 <span class="preprocessor"></span><span class="preprocessor">#endif // TESTING</span>
00062 <span class="preprocessor"></span>
00063 
00064 <span class="comment">/***************************************************************************\</span>
00065 <span class="comment">* CreateHandle</span>
00066 <span class="comment">*</span>
00067 <span class="comment">* Description:</span>
00068 <span class="comment">* Creates a client side handle.</span>
00069 <span class="comment">*</span>
00070 <span class="comment">* Returns 0 on error.</span>
00071 <span class="comment">*</span>
00072 <span class="comment">* History:</span>
00073 <span class="comment">* 11-1-91 sanfords Created.</span>
00074 <span class="comment">\***************************************************************************/</span>
<a name="l00075"></a><a class="code" href="../../d3/d8/handles_8c.html#a6">00075</a> HANDLE <a class="code" href="../../d3/d8/handles_8c.html#a6">CreateHandle</a>(
00076 ULONG_PTR dwData,
00077 DWORD type,
00078 DWORD inst)
00079 {
00080     HANDLE h;
00081     <span class="keywordtype">int</span> i, iNextFree;
00082     <a class="code" href="../../d8/d9/structtagCHANDLEENTRY.html">PCHANDLEENTRY</a> phe;
00083 
00084     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/handles_8c.html#a4">iFirstFree</a> &gt;= <a class="code" href="../../d3/d8/handles_8c.html#a3">cHandlesAllocated</a>) {
00085         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/handles_8c.html#a3">cHandlesAllocated</a> == 0) {
00086            <a class="code" href="../../d3/d8/handles_8c.html#a2">aHandleEntry</a> = (<a class="code" href="../../d8/d9/structtagCHANDLEENTRY.html">PCHANDLEENTRY</a>)<a class="code" href="../../d0/d4/ddemlcli_8h.html#a0">DDEMLAlloc</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d8/d9/structtagCHANDLEENTRY.html">CHANDLEENTRY</a>) * <a class="code" href="../../d3/d8/handles_8c.html#a0">GROW_COUNT</a>);
00087         } <span class="keywordflow">else</span> {
00088            <a class="code" href="../../d3/d8/handles_8c.html#a2">aHandleEntry</a> = (<a class="code" href="../../d8/d9/structtagCHANDLEENTRY.html">PCHANDLEENTRY</a>)<a class="code" href="../../d0/d4/ddemlcli_8h.html#a1">DDEMLReAlloc</a>(<a class="code" href="../../d3/d8/handles_8c.html#a2">aHandleEntry</a>,
00089                <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d9/structtagCHANDLEENTRY.html">CHANDLEENTRY</a>) * (<a class="code" href="../../d3/d8/handles_8c.html#a3">cHandlesAllocated</a> + <a class="code" href="../../d3/d8/handles_8c.html#a0">GROW_COUNT</a>));
00090         }
00091         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/handles_8c.html#a2">aHandleEntry</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00092             <span class="keywordflow">return</span> (0);
00093         }
00094         i = <a class="code" href="../../d3/d8/handles_8c.html#a3">cHandlesAllocated</a>;
00095         <a class="code" href="../../d3/d8/handles_8c.html#a3">cHandlesAllocated</a> += <a class="code" href="../../d3/d8/handles_8c.html#a0">GROW_COUNT</a>;
00096         phe = &amp;<a class="code" href="../../d3/d8/handles_8c.html#a2">aHandleEntry</a>[i];
00097         <span class="keywordflow">while</span> (i &lt; <a class="code" href="../../d3/d8/handles_8c.html#a3">cHandlesAllocated</a>) {
00098            <span class="comment">// phe-&gt;handle = 0; // indicates empty - ZERO init.</span>
00099            phe-&gt;<a class="code" href="../../d8/d9/structtagCHANDLEENTRY.html#o1">dwData</a> = ++i; <span class="comment">// index to next free spot.</span>
00100            phe++;
00101         }
00102     }
00103     h = <a class="code" href="../../d3/d8/handles_8c.html#a2">aHandleEntry</a>[<a class="code" href="../../d3/d8/handles_8c.html#a4">iFirstFree</a>].<a class="code" href="../../d8/d9/structtagCHANDLEENTRY.html#o0">handle</a> = (HANDLE)LongToHandle(
00104          <a class="code" href="../../d0/d4/ddemlcli_8h.html#a29">HandleFromId</a>(<a class="code" href="../../d3/d8/handles_8c.html#a5">nextId</a>) |
00105          <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a0">HandleFromIndex</a>(<a class="code" href="../../d3/d8/handles_8c.html#a4">iFirstFree</a>) |
00106          <a class="code" href="../../d0/d4/ddemlcli_8h.html#a31">HandleFromType</a>(<a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>) |
00107          <a class="code" href="../../d0/d4/ddemlcli_8h.html#a32">HandleFromInst</a>(inst) );
00108     iNextFree = (<span class="keywordtype">int</span>)<a class="code" href="../../d3/d8/handles_8c.html#a2">aHandleEntry</a>[<a class="code" href="../../d3/d8/handles_8c.html#a4">iFirstFree</a>].<a class="code" href="../../d8/d9/structtagCHANDLEENTRY.html#o1">dwData</a>;
00109     <a class="code" href="../../d3/d8/handles_8c.html#a2">aHandleEntry</a>[<a class="code" href="../../d3/d8/handles_8c.html#a4">iFirstFree</a>].<a class="code" href="../../d8/d9/structtagCHANDLEENTRY.html#o1">dwData</a> = dwData;
00110     <a class="code" href="../../d3/d8/handles_8c.html#a5">nextId</a>++;
00111     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/handles_8c.html#a5">nextId</a> == 0) {     <span class="comment">// guarentees HIWORD of handle != 0</span>
00112        <a class="code" href="../../d3/d8/handles_8c.html#a5">nextId</a>++;
00113     }
00114     <a class="code" href="../../d3/d8/handles_8c.html#a4">iFirstFree</a> = iNextFree;
00115 
00116     <a class="code" href="../../d3/d8/handles_8c.html#a1">CheckHandleTable</a>();
00117     <span class="keywordflow">return</span> (h);
00118 }
00119 
00120 
00121 <span class="comment">/***************************************************************************\</span>
00122 <span class="comment">* DestroyHandle</span>
00123 <span class="comment">*</span>
00124 <span class="comment">* Description:</span>
00125 <span class="comment">* Frees up a handle.</span>
00126 <span class="comment">*</span>
00127 <span class="comment">* Assumptions:</span>
00128 <span class="comment">* The handle is valid.</span>
00129 <span class="comment">* Critical Section is entered.</span>
00130 <span class="comment">*</span>
00131 <span class="comment">* Returns:</span>
00132 <span class="comment">* Data in handle before destruction.</span>
00133 <span class="comment">*</span>
00134 <span class="comment">* History:</span>
00135 <span class="comment">* 11-1-91 sanfords Created.</span>
00136 <span class="comment">\***************************************************************************/</span>
<a name="l00137"></a><a class="code" href="../../d3/d8/handles_8c.html#a7">00137</a> ULONG_PTR <a class="code" href="../../d3/d8/handles_8c.html#a7">DestroyHandle</a>(
00138 HANDLE h)
00139 {
00140     <span class="keyword">register</span> <span class="keywordtype">int</span> i;
00141     <span class="keyword">register</span> ULONG_PTR dwRet;
00142 
00143     <a class="code" href="../../d3/d8/handles_8c.html#a1">CheckHandleTable</a>();
00144 
00145     i = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a1">IndexFromHandle</a>(h);
00146     UserAssert(<a class="code" href="../../d3/d8/handles_8c.html#a2">aHandleEntry</a>[i].handle == h);
00147     <a class="code" href="../../d3/d8/handles_8c.html#a2">aHandleEntry</a>[i].<a class="code" href="../../d8/d9/structtagCHANDLEENTRY.html#o0">handle</a> = 0;
00148     dwRet = <a class="code" href="../../d3/d8/handles_8c.html#a2">aHandleEntry</a>[i].<a class="code" href="../../d8/d9/structtagCHANDLEENTRY.html#o1">dwData</a>;
00149     <a class="code" href="../../d3/d8/handles_8c.html#a2">aHandleEntry</a>[i].<a class="code" href="../../d8/d9/structtagCHANDLEENTRY.html#o1">dwData</a> = <a class="code" href="../../d3/d8/handles_8c.html#a4">iFirstFree</a>;
00150     <a class="code" href="../../d3/d8/handles_8c.html#a4">iFirstFree</a> = i;
00151 
00152     <span class="keywordflow">return</span> (dwRet);
00153 }
00154 
00155 
00156 <span class="comment">/***************************************************************************\</span>
00157 <span class="comment">* GetHandleData</span>
00158 <span class="comment">*</span>
00159 <span class="comment">* Description:</span>
00160 <span class="comment">* A quick way to retrieve a valid handle's data</span>
00161 <span class="comment">*</span>
00162 <span class="comment">* History:</span>
00163 <span class="comment">* 11-19-91 sanfords Created.</span>
00164 <span class="comment">\***************************************************************************/</span>
<a name="l00165"></a><a class="code" href="../../d3/d8/handles_8c.html#a8">00165</a> ULONG_PTR <a class="code" href="../../d3/d8/handles_8c.html#a8">GetHandleData</a>(
00166 HANDLE h)
00167 {
00168     <span class="keyword">register</span> ULONG_PTR dwRet;
00169 
00170     <a class="code" href="../../d3/d8/handles_8c.html#a1">CheckHandleTable</a>();
00171     dwRet = <a class="code" href="../../d3/d8/handles_8c.html#a2">aHandleEntry</a>[<a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a1">IndexFromHandle</a>(h)].<a class="code" href="../../d8/d9/structtagCHANDLEENTRY.html#o1">dwData</a>;
00172     <span class="keywordflow">return</span> (dwRet);
00173 }
00174 
00175 
00176 <span class="comment">/***************************************************************************\</span>
00177 <span class="comment">* SetHandleData</span>
00178 <span class="comment">*</span>
00179 <span class="comment">* Description:</span>
00180 <span class="comment">* A quick way to change a valid handle's data.</span>
00181 <span class="comment">*</span>
00182 <span class="comment">* History:</span>
00183 <span class="comment">* 11-19-91 sanfords Created.</span>
00184 <span class="comment">\***************************************************************************/</span>
<a name="l00185"></a><a class="code" href="../../d3/d8/handles_8c.html#a9">00185</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d3/d8/handles_8c.html#a9">SetHandleData</a>(
00186 HANDLE h,
00187 ULONG_PTR dwData)
00188 {
00189     <a class="code" href="../../d3/d8/handles_8c.html#a2">aHandleEntry</a>[<a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a1">IndexFromHandle</a>(h)].<a class="code" href="../../d8/d9/structtagCHANDLEENTRY.html#o1">dwData</a> = dwData;
00190 }
00191 
00192 
00193 <span class="comment">/***************************************************************************\</span>
00194 <span class="comment">* ValidateCHandle</span>
00195 <span class="comment">*</span>
00196 <span class="comment">* Description:</span>
00197 <span class="comment">* General handle validation routine. ExpectedType or ExpectedInstance</span>
00198 <span class="comment">* can be HTYPE_ANY/HINST_ANY. (note Expected Instance is an instance</span>
00199 <span class="comment">* index into the aInstance array, NOT a instance handle.</span>
00200 <span class="comment">*</span>
00201 <span class="comment">* History:</span>
00202 <span class="comment">* 11-19-91 sanfords Created.</span>
00203 <span class="comment">\***************************************************************************/</span>
<a name="l00204"></a><a class="code" href="../../d3/d8/handles_8c.html#a10">00204</a> ULONG_PTR <a class="code" href="../../d3/d8/handles_8c.html#a10">ValidateCHandle</a>(
00205 HANDLE h,
00206 DWORD ExpectedType,
00207 DWORD ExpectedInstance)
00208 {
00209     <span class="keyword">register</span> <span class="keywordtype">int</span> i;
00210     <span class="keyword">register</span> ULONG_PTR dwRet;
00211 
00212     <a class="code" href="../../d3/d8/handles_8c.html#a1">CheckHandleTable</a>();
00213     dwRet = 0;
00214     i = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a1">IndexFromHandle</a>(h);
00215     <span class="keywordflow">if</span> (i &lt; <a class="code" href="../../d3/d8/handles_8c.html#a3">cHandlesAllocated</a> &amp;&amp;
00216           <a class="code" href="../../d3/d8/handles_8c.html#a2">aHandleEntry</a>[i].<a class="code" href="../../d8/d9/structtagCHANDLEENTRY.html#o0">handle</a> == h &amp;&amp;
00217           (ExpectedType == -1 || ExpectedType == <a class="code" href="../../d0/d4/ddemlcli_8h.html#a27">TypeFromHandle</a>(h)) &amp;&amp;
00218           (ExpectedInstance == -1 || ExpectedInstance == <a class="code" href="../../d0/d4/ddemlcli_8h.html#a28">InstFromHandle</a>(h))) {
00219        dwRet = <a class="code" href="../../d3/d8/handles_8c.html#a2">aHandleEntry</a>[i].<a class="code" href="../../d8/d9/structtagCHANDLEENTRY.html#o1">dwData</a>;
00220     }
00221 
00222     <span class="keywordflow">return</span> (dwRet);
00223 }
00224 
00225 
<a name="l00226"></a><a class="code" href="../../d3/d8/handles_8c.html#a11">00226</a> <a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html">PCL_INSTANCE_INFO</a> <a class="code" href="../../d3/d8/handles_8c.html#a11">PciiFromHandle</a>(
00227 HANDLE h)
00228 {
00229     <a class="code" href="../../d8/d9/structtagCHANDLEENTRY.html">PCHANDLEENTRY</a> phe;
00230 
00231     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a8">CheckDDECritIn</a>;
00232 
00233     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d8/handles_8c.html#a3">cHandlesAllocated</a>) {
00234         <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00235     }
00236     phe = &amp;<a class="code" href="../../d3/d8/handles_8c.html#a2">aHandleEntry</a>[<a class="code" href="../../d3/d8/handles_8c.html#a3">cHandlesAllocated</a>];
00237 
00238     <span class="keywordflow">do</span> {
00239         phe--;
00240         <span class="keywordflow">if</span> (phe-&gt;<a class="code" href="../../d8/d9/structtagCHANDLEENTRY.html#o0">handle</a> != 0 &amp;&amp;
00241                 <a class="code" href="../../d0/d4/ddemlcli_8h.html#a27">TypeFromHandle</a>(phe-&gt;<a class="code" href="../../d8/d9/structtagCHANDLEENTRY.html#o0">handle</a>) == <a class="code" href="../../d0/d4/ddemlcli_8h.html#a34">HTYPE_INSTANCE</a> &amp;&amp;
00242                 (<a class="code" href="../../d0/d4/ddemlcli_8h.html#a28">InstFromHandle</a>(phe-&gt;<a class="code" href="../../d8/d9/structtagCHANDLEENTRY.html#o0">handle</a>) == <a class="code" href="../../d0/d4/ddemlcli_8h.html#a28">InstFromHandle</a>(h))) {
00243             <span class="keywordflow">return</span>(((<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html">PCL_INSTANCE_INFO</a>)phe-&gt;<a class="code" href="../../d8/d9/structtagCHANDLEENTRY.html#o1">dwData</a>)-&gt;tid == GetCurrentThreadId() ?
00244                 (<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html">PCL_INSTANCE_INFO</a>)phe-&gt;<a class="code" href="../../d8/d9/structtagCHANDLEENTRY.html#o1">dwData</a> : <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00245         }
00246     } <span class="keywordflow">while</span> (phe != <a class="code" href="../../d3/d8/handles_8c.html#a2">aHandleEntry</a>);
00247     <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00248 }
00249 
00250 
00251 
00252 <span class="comment">/***************************************************************************\</span>
00253 <span class="comment">* ApplyFunctionToObjects</span>
00254 <span class="comment">*</span>
00255 <span class="comment">* Description:</span>
00256 <span class="comment">* Used for cleanup, this allows the handle array to be scanned for</span>
00257 <span class="comment">* handles meeting the ExpectedType and ExpectedInstance criteria</span>
00258 <span class="comment">* and apply the given function to each handle.</span>
00259 <span class="comment">*</span>
00260 <span class="comment">* History:</span>
00261 <span class="comment">* 11-19-91 sanfords Created.</span>
00262 <span class="comment">\***************************************************************************/</span>
<a name="l00263"></a><a class="code" href="../../d3/d8/handles_8c.html#a12">00263</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d3/d8/handles_8c.html#a12">ApplyFunctionToObjects</a>(
00264 DWORD ExpectedType,
00265 DWORD ExpectedInstance,
00266 PFNHANDLEAPPLY pfn)
00267 {
00268     <a class="code" href="../../d8/d9/structtagCHANDLEENTRY.html">PCHANDLEENTRY</a> phe;
00269 
00270     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a8">CheckDDECritIn</a>;
00271 
00272     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d8/handles_8c.html#a3">cHandlesAllocated</a>) {
00273         <span class="keywordflow">return</span>;
00274     }
00275     phe = &amp;<a class="code" href="../../d3/d8/handles_8c.html#a2">aHandleEntry</a>[<a class="code" href="../../d3/d8/handles_8c.html#a3">cHandlesAllocated</a>];
00276 
00277     <span class="keywordflow">do</span> {
00278         phe--;
00279         <span class="keywordflow">if</span> (phe-&gt;<a class="code" href="../../d8/d9/structtagCHANDLEENTRY.html#o0">handle</a> != 0 &amp;&amp;
00280                 (ExpectedType == <a class="code" href="../../d0/d4/ddemlcli_8h.html#a41">HTYPE_ANY</a> ||
00281                     ExpectedType == <a class="code" href="../../d0/d4/ddemlcli_8h.html#a27">TypeFromHandle</a>(phe-&gt;<a class="code" href="../../d8/d9/structtagCHANDLEENTRY.html#o0">handle</a>)) &amp;&amp;
00282                 (ExpectedInstance == <a class="code" href="../../d0/d4/ddemlcli_8h.html#a41">HTYPE_ANY</a> ||
00283                     ExpectedInstance == <a class="code" href="../../d0/d4/ddemlcli_8h.html#a28">InstFromHandle</a>(phe-&gt;<a class="code" href="../../d8/d9/structtagCHANDLEENTRY.html#o0">handle</a>))) {
00284             <a class="code" href="../../d0/d4/ddemlcli_8h.html#a7">LeaveDDECrit</a>;
00285             <a class="code" href="../../d0/d4/ddemlcli_8h.html#a9">CheckDDECritOut</a>;
00286             (*pfn)(phe-&gt;<a class="code" href="../../d8/d9/structtagCHANDLEENTRY.html#o0">handle</a>);
00287             <a class="code" href="../../d0/d4/ddemlcli_8h.html#a6">EnterDDECrit</a>;
00288         }
00289     } <span class="keywordflow">while</span> (phe != <a class="code" href="../../d3/d8/handles_8c.html#a2">aHandleEntry</a>);
00290 }
00291 
00292 
<a name="l00293"></a><a class="code" href="../../d3/d8/handles_8c.html#a13">00293</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d3/d8/handles_8c.html#a13">GetFullUserHandle</a>(WORD wHandle)
00294 {
00295     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwHandle;
00296     <a class="code" href="../../d2/d4/struct__HANDLEENTRY.html">PHE</a> phe;
00297 
00298     dwHandle = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a432">HMIndexFromHandle</a>(wHandle);
00299 
00300     <span class="keywordflow">if</span> (dwHandle &lt; <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o4">cHandleEntries</a>) {
00301 
00302         phe = &amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o1">aheList</a>[dwHandle];
00303 
00304         <span class="keywordflow">if</span> (phe-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o2">bType</a> == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a237">TYPE_WINDOW</a>)
00305             <span class="keywordflow">return</span>(MAKELONG(dwHandle, phe-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o4">wUniq</a>));
00306     }
00307 
00308     <span class="comment">/*</span>
00309 <span class="comment">     * object may be gone, but we must pass something.</span>
00310 <span class="comment">     * DDE terminates will fail if we don't map this right even after</span>
00311 <span class="comment">     * the window is dead!</span>
00312 <span class="comment">     *</span>
00313 <span class="comment">     * NOTE: This fix will only work for WOW apps, but since the 32bit</span>
00314 <span class="comment">     * tracking layer locks dde windows until the last terminate is</span>
00315 <span class="comment">     * received, we won't see this problem on the 32bit side.</span>
00316 <span class="comment">     *</span>
00317 <span class="comment">     * BUG: We WILL see a problem for OLE32 thunked DDE though.</span>
00318 <span class="comment">     */</span>
00319     <span class="keywordflow">return</span>(wHandle);
00320 }
00321 
00322 
00323 
00324 <span class="comment">/***************************************************************************\</span>
00325 <span class="comment">* BestSetLastDDEMLError</span>
00326 <span class="comment">*</span>
00327 <span class="comment">* Description:</span>
00328 <span class="comment">* This sets the LastError field of all instances that belong to the</span>
00329 <span class="comment">* current thread. This is used to get error information to applications</span>
00330 <span class="comment">* which generated an error where the exact instance could not be</span>
00331 <span class="comment">* determined.</span>
00332 <span class="comment">*</span>
00333 <span class="comment">* History:</span>
00334 <span class="comment">* 11-12-91 sanfords Created.</span>
00335 <span class="comment">\***************************************************************************/</span>
<a name="l00336"></a><a class="code" href="../../d3/d8/handles_8c.html#a14">00336</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d3/d8/handles_8c.html#a14">BestSetLastDDEMLError</a>(
00337 DWORD error)
00338 {
00339     <a class="code" href="../../d8/d9/structtagCHANDLEENTRY.html">PCHANDLEENTRY</a> phe;
00340 
00341     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a8">CheckDDECritIn</a>;
00342 
00343     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d8/handles_8c.html#a3">cHandlesAllocated</a>) {
00344         <span class="keywordflow">return</span>;
00345     }
00346     phe = &amp;<a class="code" href="../../d3/d8/handles_8c.html#a2">aHandleEntry</a>[<a class="code" href="../../d3/d8/handles_8c.html#a3">cHandlesAllocated</a>];
00347     <span class="keywordflow">do</span> {
00348         phe--;
00349         <span class="keywordflow">if</span> (phe-&gt;<a class="code" href="../../d8/d9/structtagCHANDLEENTRY.html#o0">handle</a> != 0 &amp;&amp; <a class="code" href="../../d0/d4/ddemlcli_8h.html#a27">TypeFromHandle</a>(phe-&gt;<a class="code" href="../../d8/d9/structtagCHANDLEENTRY.html#o0">handle</a>) == <a class="code" href="../../d0/d4/ddemlcli_8h.html#a34">HTYPE_INSTANCE</a>) {
00350             <a class="code" href="../../d0/d4/instance_8c.html#a8">SetLastDDEMLError</a>((<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html">PCL_INSTANCE_INFO</a>)phe-&gt;<a class="code" href="../../d8/d9/structtagCHANDLEENTRY.html#o1">dwData</a>, error);
00351         }
00352     } <span class="keywordflow">while</span> (phe != <a class="code" href="../../d3/d8/handles_8c.html#a2">aHandleEntry</a>);
00353 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:14 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
