<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: sessload.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>sessload.c File Reference</h1><code>#include "<a class="el" href="../../d5/d7/mi_8h-source.html">mi.h</a>"</code><br>

<p>
<a href="../../d5/d6/sessload_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Classes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html">_SESSIONWIDE_DRIVER_ADDRESS</a></td></tr>

<tr><td colspan=2><br><h2>Typedefs</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html">_SESSIONWIDE_DRIVER_ADDRESS</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d7/sessload_8c.html#a0">SESSIONWIDE_DRIVER_ADDRESS</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html">_SESSIONWIDE_DRIVER_ADDRESS</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d7/sessload_8c.html#a1">PSESSIONWIDE_DRIVER_ADDRESS</a></td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d7/sessload_8c.html#a5">MiSetProtectionOnTransitionPte</a> (IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte, IN ULONG ProtectionMask)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d7/sessload_8c.html#a6">MiSessionInsertImage</a> (IN PVOID BaseAddress)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d7/sessload_8c.html#a7">MiSessionRemoveImage</a> (IN PVOID BaseAddress)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d7/sessload_8c.html#a8">MiSessionWideInsertImageAddress</a> (IN PVOID BaseAddress, IN ULONG_PTR <a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>, IN ULONG WritablePages, IN PUNICODE_STRING ImageName, IN BOOLEAN AtPreferredAddress)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d7/sessload_8c.html#a9">MiSessionWideDereferenceImage</a> (IN PVOID BaseAddress)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PLDR_DATA_TABLE_ENTRY&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d7/sessload_8c.html#a10">MiLookupPsLoadedModule</a> (IN PVOID Address)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d7/sessload_8c.html#a11">MiShareSessionImage</a> (IN <a class="el" href="../../d4/d8/mi_8h.html#a480">PSECTION</a> Section, IN OUT PSIZE_T ViewSize)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d7/sessload_8c.html#a12">MiSessionRemoveImage</a> (PVOID BaseAddr)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html">PIMAGE_ENTRY_IN_SESSION</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d7/sessload_8c.html#a13">MiSessionLookupImage</a> (IN PVOID BaseAddress)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d7/sessload_8c.html#a14">MiSessionUnloadAllImages</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d7/sessload_8c.html#a15">MiSessionWideInitializeAddresses</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d7/sessload_8c.html#a16">MiSessionWideGetImageSize</a> (IN PVOID BaseAddress, OUT PSIZE_T NumberOfBytes OPTIONAL, OUT PSIZE_T CommitPages OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d7/sessload_8c.html#a17">MiSessionWideReserveImageAddress</a> (IN PUNICODE_STRING ImageName, IN <a class="el" href="../../d4/d8/mi_8h.html#a480">PSECTION</a> Section, IN ULONG_PTR Alignment, OUT PVOID *AssignedAddress, OUT PBOOLEAN AlreadyLoaded)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d7/sessload_8c.html#a18">MiRemoveImageSessionWide</a> (IN PVOID BaseAddress)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>LIST_ENTRY&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d7/sessload_8c.html#a2">MmSessionWideAddressList</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>KSPIN_LOCK&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d7/sessload_8c.html#a3">PsLoadedModuleSpinLock</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LIST_ENTRY&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d7/sessload_8c.html#a4">PsLoadedModuleList</a></td></tr>

</table>
<hr><h2>Typedef Documentation</h2>
<a class="anchor" name="a1" doxytag="sessload.c::PSESSIONWIDE_DRIVER_ADDRESS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html">_SESSIONWIDE_DRIVER_ADDRESS</a> * <a class="el" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html">PSESSIONWIDE_DRIVER_ADDRESS</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d5/d6/sessload_8c-source.html#l00802">MiSessionWideDereferenceImage()</a>, <a class="el" href="../../d5/d6/sessload_8c-source.html#l00866">MiSessionWideGetImageSize()</a>, <a class="el" href="../../d5/d6/sessload_8c-source.html#l00683">MiSessionWideInsertImageAddress()</a>, and <a class="el" href="../../d5/d6/sessload_8c-source.html#l00936">MiSessionWideReserveImageAddress()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="sessload.c::SESSIONWIDE_DRIVER_ADDRESS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html">_SESSIONWIDE_DRIVER_ADDRESS</a>  <a class="el" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html">SESSIONWIDE_DRIVER_ADDRESS</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d5/d6/sessload_8c-source.html#l00683">MiSessionWideInsertImageAddress()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a10" doxytag="sessload.c::MiLookupPsLoadedModule" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PLDR_DATA_TABLE_ENTRY MiLookupPsLoadedModule           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Address</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d6/sessload_8c-source.html#l01273">1273</a> of file <a class="el" href="../../d5/d6/sessload_8c-source.html">sessload.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02475">ExAcquireResourceExclusive</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d4/d4/mutntobj_8c-source.html#l00178">KeReleaseMutant()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00928">MmSystemLoadLock</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00582">PsLoadedModuleList</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00583">PsLoadedModuleResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d4/d9/ke_8h.html#a407a216">WrVirtualMemory</a>.
<p>
Referenced by <a class="el" href="../../d5/d6/sessload_8c-source.html#l00572">MiSessionUnloadAllImages()</a>.
<p>
<pre class="fragment"><div>01279                    :
01280 
01281     Lookup <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> loader data table entry <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image by its address.
01282 
01283 Arguments:
01284 
01285     BaseAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> loaded at.
01286 
01287 Return Value:
01288 
01289     Returns a non-<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> loader data table entry on success, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> on <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>.
01290 
01291 Environment:
01292 
01293     Kernel mode, <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> and below.
01294 
01295 --*/
01296 
01297 {
01298     PLIST_ENTRY NextEntry;
01299     PLDR_DATA_TABLE_ENTRY DataTableEntry;
01300     PLDR_DATA_TABLE_ENTRY FoundDataTableEntry;
01301 
01302     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Address);
01303 
01304     FoundDataTableEntry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01305 
01306     <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a> (&amp;MmSystemLoadLock,
01307                            WrVirtualMemory,
01308                            KernelMode,
01309                            FALSE,
01310                            (PLARGE_INTEGER)NULL);
01311 
01312     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
01313     <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a> (&amp;PsLoadedModuleResource, TRUE);
01314 
01315     NextEntry = <a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>.Flink;
01316     <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>) {
01317         DataTableEntry = CONTAINING_RECORD(NextEntry,
01318                                            LDR_DATA_TABLE_ENTRY,
01319                                            InLoadOrderLinks);
01320 
01321         <span class="keywordflow">if</span> (DataTableEntry-&gt;DllBase == Address) {
01322 
01323             FoundDataTableEntry = DataTableEntry;
01324             <span class="keywordflow">break</span>;
01325         }
01326 
01327         NextEntry = NextEntry-&gt;Flink;
01328     }
01329 
01330     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a> (&amp;PsLoadedModuleResource);
01331     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
01332 
01333     <a class="code" href="../../d3/d5/mutntobj_8c.html#a4">KeReleaseMutant</a> (&amp;MmSystemLoadLock, 1, FALSE, FALSE);
01334 
01335     <span class="keywordflow">return</span> FoundDataTableEntry;
01336 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="sessload.c::MiRemoveImageSessionWide" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MiRemoveImageSessionWide           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>BaseAddress</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d6/sessload_8c-source.html#l01223">1223</a> of file <a class="el" href="../../d5/d6/sessload_8c-source.html">sessload.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d6/sessload_8c-source.html#l00461">MiSessionRemoveImage()</a>, <a class="el" href="../../d5/d6/sessload_8c-source.html#l00802">MiSessionWideDereferenceImage()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03883">MmIsAddressValid()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05609">MmSessionSpace</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00933">SYSLOAD_LOCK_OWNED_BY_ME</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/sysload_8c-source.html#l01474">MiLoadImageSection()</a>, and <a class="el" href="../../d9/d7/sysload_8c-source.html#l02896">MmUnloadSystemImage()</a>.
<p>
<pre class="fragment"><div>01229                    :
01230 
01231     <a class="code" href="../../d9/d0/rtdelkey_8c.html#a5">Delete</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image space region from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current session space.
01232     This dereferences <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> globally allocated SessionWide region.
01233     
01234     The SessionWide region will be deleted <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> reference count goes to zero.
01235     
01236 Arguments:
01237 
01238     BaseAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> loaded at.
01239 
01240 Return Value:
01241 
01242     Returns STATUS_SUCCESS on success, STATUS_NOT_FOUND on <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>.
01243 
01244 Environment:
01245 
01246     Kernel mode, <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> and below, <a class="code" href="../../d4/d8/mi_8h.html#a432">MmSystemLoadLock</a> held.
01247 
01248 --*/
01249 
01250 {
01251     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01252 
01253     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01254 
01255     <a class="code" href="../../d4/d8/mi_8h.html#a135">SYSLOAD_LOCK_OWNED_BY_ME</a> ();
01256 
01257     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a>(MmSessionSpace) == TRUE);
01258 
01259     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d7/sessload_8c.html#a9">MiSessionWideDereferenceImage</a> (BaseAddress);
01260 
01261     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
01262 
01263     <span class="comment">//</span>
01264     <span class="comment">// Remove the image reference from the current session space.</span>
01265     <span class="comment">//</span>
01266 
01267     <a class="code" href="../../d4/d7/sessload_8c.html#a12">MiSessionRemoveImage</a> (BaseAddress);
01268 
01269     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01270 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="sessload.c::MiSessionInsertImage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MiSessionInsertImage           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>BaseAddress</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d6/sessload_8c-source.html#l00381">381</a> of file <a class="el" href="../../d5/d6/sessload_8c-source.html">sessload.c</a>.
<p>
References <a class="el" href="../../d5/d7/mi_8h-source.html#l05764">_IMAGE_ENTRY_IN_SESSION::Address</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d4/d8/mi_8h.html#a759">IMAGE_ENTRY_IN_SESSION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05766">_IMAGE_ENTRY_IN_SESSION::ImageCountInThisSession</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05532">_MM_SESSION_SPACE::ImageList</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05763">_IMAGE_ENTRY_IN_SESSION::Link</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05688">LOCK_SESSION_SPACE_WS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05380">MM_BUMP_SESSION_FAILURES</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05372">MM_SESSION_FAILURE_NO_NONPAGED_POOL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05609">MmSessionSpace</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00933">SYSLOAD_LOCK_OWNED_BY_ME</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l05694">UNLOCK_SESSION_SPACE_WS</a>.
<p>
Referenced by <a class="el" href="../../d5/d6/sessload_8c-source.html#l00936">MiSessionWideReserveImageAddress()</a>.
<p>
<pre class="fragment"><div>00387                    :
00388 
00389     This routine allocates an image entry <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified address in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00390     current session space.
00391 
00392 Arguments:
00393 
00394     BaseAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base address <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> executable image.
00395 
00396 Return Value:
00397 
00398     STATUS_SUCCESS or various <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> error codes on <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>.
00399 
00400 Environment:
00401 
00402     Kernel mode, <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> and below, <a class="code" href="../../d4/d8/mi_8h.html#a432">MmSystemLoadLock</a> held.
00403 
00404 --*/
00405 
00406 {
00407     PLIST_ENTRY NextEntry;
00408     <a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html">PIMAGE_ENTRY_IN_SESSION</a> Image;
00409     KIRQL OldIrql;
00410 
00411     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00412 
00413     <a class="code" href="../../d4/d8/mi_8h.html#a135">SYSLOAD_LOCK_OWNED_BY_ME</a> ();
00414 
00415     <span class="comment">//</span>
00416     <span class="comment">// Check to see if the address is already loaded.</span>
00417     <span class="comment">//</span>
00418 
00419     <a class="code" href="../../d4/d8/mi_8h.html#a407">LOCK_SESSION_SPACE_WS</a> (OldIrql);
00420 
00421     NextEntry = <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o24">ImageList</a>.Flink;
00422 
00423     <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o24">ImageList</a>) {
00424         Image = CONTAINING_RECORD (NextEntry, <a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html">IMAGE_ENTRY_IN_SESSION</a>, Link);
00425 
00426         <span class="keywordflow">if</span> (Image-&gt;<a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html#o1">Address</a> == BaseAddress) {
00427             Image-&gt;<a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html#o3">ImageCountInThisSession</a> += 1;
00428             <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a> (OldIrql);
00429             <span class="keywordflow">return</span> STATUS_ALREADY_COMMITTED;
00430         }
00431         NextEntry = NextEntry-&gt;Flink;
00432     }
00433 
00434     <span class="comment">//</span>
00435     <span class="comment">// Create and insert the image entry into the session space structure</span>
00436     <span class="comment">//</span>
00437 
00438     Image = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool,
00439                                    <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html">IMAGE_ENTRY_IN_SESSION</a>),
00440                                    'iHmM');
00441 
00442     <span class="keywordflow">if</span> (Image == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00443         <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a> (OldIrql);
00444         <a class="code" href="../../d4/d8/mi_8h.html#a396">MM_BUMP_SESSION_FAILURES</a> (MM_SESSION_FAILURE_NO_NONPAGED_POOL);
00445         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00446     }
00447 
00448     RtlZeroMemory (Image, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html">IMAGE_ENTRY_IN_SESSION</a>));
00449 
00450     Image-&gt;<a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html#o1">Address</a> = BaseAddress;
00451     Image-&gt;<a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html#o3">ImageCountInThisSession</a> = 1;
00452 
00453     InsertTailList (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o24">ImageList</a>, &amp;Image-&gt;<a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html#o0">Link</a>);
00454 
00455     <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a> (OldIrql);
00456     <span class="keywordflow">return</span> STATUS_SUCCESS;
00457 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="sessload.c::MiSessionLookupImage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html">PIMAGE_ENTRY_IN_SESSION</a> MiSessionLookupImage           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>BaseAddress</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d6/sessload_8c-source.html#l00518">518</a> of file <a class="el" href="../../d5/d6/sessload_8c-source.html">sessload.c</a>.
<p>
References <a class="el" href="../../d5/d7/mi_8h-source.html#l05764">_IMAGE_ENTRY_IN_SESSION::Address</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05532">_MM_SESSION_SPACE::ImageList</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05688">LOCK_SESSION_SPACE_WS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05609">MmSessionSpace</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00933">SYSLOAD_LOCK_OWNED_BY_ME</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l05694">UNLOCK_SESSION_SPACE_WS</a>.
<p>
Referenced by <a class="el" href="../../d5/d6/sessload_8c-source.html#l00119">MiShareSessionImage()</a>, and <a class="el" href="../../d9/d7/sysload_8c-source.html#l02896">MmUnloadSystemImage()</a>.
<p>
<pre class="fragment"><div>00524                    :
00525 
00526     This routine looks up <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image entry within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current session by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> 
00527     specified base address.
00528 
00529 Arguments:
00530 
00531     BaseAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base address <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> executable image.
00532 
00533 Return Value:
00534 
00535     The image entry within <span class="keyword">this</span> session on success or <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> on <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>.
00536 
00537 Environment:
00538 
00539     Kernel mode, <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> and below, <a class="code" href="../../d4/d8/mi_8h.html#a432">MmSystemLoadLock</a> held.
00540 
00541 --*/
00542 
00543 {
00544     PLIST_ENTRY NextEntry;
00545     <a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html">PIMAGE_ENTRY_IN_SESSION</a> Image;
00546     KIRQL OldIrql;
00547 
00548     <a class="code" href="../../d4/d8/mi_8h.html#a135">SYSLOAD_LOCK_OWNED_BY_ME</a> ();
00549 
00550     <a class="code" href="../../d4/d8/mi_8h.html#a407">LOCK_SESSION_SPACE_WS</a> (OldIrql);
00551 
00552     NextEntry = <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o24">ImageList</a>.Flink;
00553 
00554     <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o24">ImageList</a>) {
00555 
00556         Image = CONTAINING_RECORD(NextEntry, <a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html">IMAGE_ENTRY_IN_SESSION</a>, Link);
00557 
00558         <span class="keywordflow">if</span> (Image-&gt;<a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html#o1">Address</a> == BaseAddress) {
00559             <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a> (OldIrql);
00560             <span class="keywordflow">return</span> Image;
00561         }
00562 
00563         NextEntry = NextEntry-&gt;Flink;
00564     }
00565 
00566     <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a> (OldIrql);
00567     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00568 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="sessload.c::MiSessionRemoveImage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MiSessionRemoveImage           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>BaseAddr</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d6/sessload_8c-source.html#l00461">461</a> of file <a class="el" href="../../d5/d6/sessload_8c-source.html">sessload.c</a>.
<p>
References <a class="el" href="../../d5/d7/mi_8h-source.html#l05764">_IMAGE_ENTRY_IN_SESSION::Address</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05532">_MM_SESSION_SPACE::ImageList</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05688">LOCK_SESSION_SPACE_WS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05609">MmSessionSpace</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00933">SYSLOAD_LOCK_OWNED_BY_ME</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l05694">UNLOCK_SESSION_SPACE_WS</a>.
<p>
Referenced by <a class="el" href="../../d5/d6/sessload_8c-source.html#l01223">MiRemoveImageSessionWide()</a>.
<p>
<pre class="fragment"><div>00467                    :
00468 
00469     This routine removes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given image entry from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current session space.
00470 
00471 Arguments:
00472 
00473     BaseAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base address <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> executable image.
00474 
00475 Return Value:
00476 
00477     Returns STATUS_SUCCESS on success, STATUS_NOT_FOUND <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not
00478     in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current session space.
00479 
00480 Environment:
00481 
00482     Kernel mode, <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> and below.
00483 
00484 --*/
00485 
00486 {
00487     PLIST_ENTRY NextEntry;
00488     <a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html">PIMAGE_ENTRY_IN_SESSION</a> Image;
00489     KIRQL OldIrql;
00490 
00491     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00492 
00493     <a class="code" href="../../d4/d8/mi_8h.html#a135">SYSLOAD_LOCK_OWNED_BY_ME</a> ();
00494 
00495     <a class="code" href="../../d4/d8/mi_8h.html#a407">LOCK_SESSION_SPACE_WS</a> (OldIrql);
00496     NextEntry = <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o24">ImageList</a>.Flink;
00497 
00498     <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o24">ImageList</a>) {
00499 
00500         Image = CONTAINING_RECORD(NextEntry, <a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html">IMAGE_ENTRY_IN_SESSION</a>, Link);
00501 
00502         <span class="keywordflow">if</span> (Image-&gt;<a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html#o1">Address</a> == BaseAddr) {
00503             RemoveEntryList (NextEntry);
00504             <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a> (OldIrql);
00505             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Image);
00506             <span class="keywordflow">return</span> STATUS_SUCCESS;
00507         }
00508 
00509         NextEntry = NextEntry-&gt;Flink;
00510     }
00511 
00512     <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a> (OldIrql);
00513     <span class="keywordflow">return</span> STATUS_NOT_FOUND;
00514 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="sessload.c::MiSessionRemoveImage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MiSessionRemoveImage           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>BaseAddress</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="sessload.c::MiSessionUnloadAllImages" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiSessionUnloadAllImages           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d6/sessload_8c-source.html#l00572">572</a> of file <a class="el" href="../../d5/d6/sessload_8c-source.html">sessload.c</a>.
<p>
References <a class="el" href="../../d5/d7/mi_8h-source.html#l05764">_IMAGE_ENTRY_IN_SESSION::Address</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05532">_MM_SESSION_SPACE::ImageList</a>, <a class="el" href="../../d5/d6/sessload_8c-source.html#l01273">MiLookupPsLoadedModule()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05609">MmSessionSpace</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l02896">MmUnloadSystemImage()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05411">_MM_SESSION_SPACE::ReferenceCount</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d4/d6/session_8c-source.html#l01544">MiDereferenceSession()</a>.
<p>
<pre class="fragment"><div>00578                    :
00579 
00580     This routine dereferences each image that has been loaded in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00581     current session space.
00582 
00583     As each image <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> dereferenced, checks are <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a>:
00584 
00585     If <span class="keyword">this</span> session's reference count to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image reaches zero, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> VA
00586     range in <span class="keyword">this</span> session <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> deleted.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> reference count to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image
00587     in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SESSIONWIDE list drops to zero, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SESSIONWIDE's VA
00588     reservation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> removed and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address space <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> available to any
00589     <span class="keyword">new</span> image.
00590 
00591     If <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last systemwide reference to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver
00592     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> deleted from memory.
00593 
00594 Arguments:
00595 
00596     None.
00597 
00598 Return Value:
00599 
00600     None.
00601 
00602 Environment:
00603 
00604     Kernel mode.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called in one of two contexts:
00605         1. <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last thread in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last process of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current session space.
00606         2. or by any thread in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SMSS process.
00607 
00608 --*/
00609 
00610 {
00611     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00612     PLIST_ENTRY NextEntry;
00613     <a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html">PIMAGE_ENTRY_IN_SESSION</a> Module;
00614     PLDR_DATA_TABLE_ENTRY ImageHandle;
00615 
00616     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o0">ReferenceCount</a> == 1);
00617 
00618     <span class="comment">//</span>
00619     <span class="comment">// The session's working set lock does not need to be acquired here since</span>
00620     <span class="comment">// no thread can be faulting on these addresses.</span>
00621     <span class="comment">//</span>
00622 
00623     NextEntry = <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o24">ImageList</a>.Flink;
00624 
00625     <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o24">ImageList</a>) {
00626 
00627         Module = CONTAINING_RECORD(NextEntry, <a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html">IMAGE_ENTRY_IN_SESSION</a>, Link);
00628 
00629         <span class="comment">//</span>
00630         <span class="comment">// Lookup the image entry in the system PsLoadedModuleList,</span>
00631         <span class="comment">// unload the image and delete it.</span>
00632         <span class="comment">//</span>
00633 
00634         ImageHandle = <a class="code" href="../../d4/d7/sessload_8c.html#a10">MiLookupPsLoadedModule</a> (Module-&gt;<a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html#o1">Address</a>);
00635 
00636         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ImageHandle);
00637 
00638         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d8/sysload_8c.html#a59">MmUnloadSystemImage</a> (ImageHandle);
00639 
00640         <span class="comment">//</span>
00641         <span class="comment">// Restart the search at the beginning since the entry has been deleted.</span>
00642         <span class="comment">//</span>
00643 
00644         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o0">ReferenceCount</a> == 1);
00645 
00646         NextEntry = <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o24">ImageList</a>.Flink;
00647     }
00648 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="sessload.c::MiSessionWideDereferenceImage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MiSessionWideDereferenceImage           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>BaseAddress</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d6/sessload_8c-source.html#l00802">802</a> of file <a class="el" href="../../d5/d6/sessload_8c-source.html">sessload.c</a>.
<p>
References <a class="el" href="../../d5/d6/sessload_8c-source.html#l00045">_SESSIONWIDE_DRIVER_ADDRESS::Address</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d5/d6/sessload_8c-source.html#l00051">MmSessionWideAddressList</a>, <a class="el" href="../../d4/d7/sessload_8c.html#a1">PSESSIONWIDE_DRIVER_ADDRESS</a>, <a class="el" href="../../d5/d6/sessload_8c-source.html#l00044">_SESSIONWIDE_DRIVER_ADDRESS::ReferenceCount</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00933">SYSLOAD_LOCK_OWNED_BY_ME</a>.
<p>
Referenced by <a class="el" href="../../d5/d6/sessload_8c-source.html#l01223">MiRemoveImageSessionWide()</a>, and <a class="el" href="../../d5/d6/sessload_8c-source.html#l00936">MiSessionWideReserveImageAddress()</a>.
<p>
<pre class="fragment"><div>00808                    :
00809 
00810     Dereference <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SessionWide entry <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified address, potentially
00811     resulting in a deletion of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image.
00812 
00813 Arguments:
00814 
00815     BaseAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver to dereference.
00816 
00817 Return Value:
00818 
00819     Returns STATUS_SUCCESS on success, STATUS_NOT_FOUND on <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>.
00820 
00821 Environment:
00822 
00823     Kernel mode, <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> and below, <a class="code" href="../../d4/d8/mi_8h.html#a432">MmSystemLoadLock</a> held.
00824 
00825 --*/
00826 
00827 {
00828     PLIST_ENTRY NextEntry;
00829     <a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html">PSESSIONWIDE_DRIVER_ADDRESS</a> SessionWideImageEntry;
00830 
00831     <a class="code" href="../../d4/d8/mi_8h.html#a135">SYSLOAD_LOCK_OWNED_BY_ME</a> ();
00832 
00833     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (BaseAddress);
00834 
00835     NextEntry = <a class="code" href="../../d4/d7/sessload_8c.html#a2">MmSessionWideAddressList</a>.Flink;
00836 
00837     <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d4/d7/sessload_8c.html#a2">MmSessionWideAddressList</a>) {
00838 
00839         SessionWideImageEntry = CONTAINING_RECORD (NextEntry,
00840                                                    <a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html">SESSIONWIDE_DRIVER_ADDRESS</a>,
00841                                                    Link);
00842 
00843         <span class="keywordflow">if</span> (BaseAddress == SessionWideImageEntry-&gt;<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o2">Address</a>) {
00844     
00845             SessionWideImageEntry-&gt;<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o1">ReferenceCount</a> -= 1;
00846     
00847             <span class="comment">//</span>
00848             <span class="comment">// If reference count is 0, delete the node.</span>
00849             <span class="comment">//</span>
00850 
00851             <span class="keywordflow">if</span> (SessionWideImageEntry-&gt;<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o1">ReferenceCount</a> == 0) {
00852                 RemoveEntryList (NextEntry);
00853                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (SessionWideImageEntry);
00854             }
00855             <span class="keywordflow">return</span> STATUS_SUCCESS;
00856         }
00857 
00858         NextEntry = NextEntry-&gt;Flink;
00859     }
00860 
00861     <span class="keywordflow">return</span> STATUS_NOT_FOUND;
00862 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="sessload.c::MiSessionWideGetImageSize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MiSessionWideGetImageSize           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>BaseAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PSIZE_T NumberOfBytes&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PSIZE_T CommitPages&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d6/sessload_8c-source.html#l00866">866</a> of file <a class="el" href="../../d5/d6/sessload_8c-source.html">sessload.c</a>.
<p>
References <a class="el" href="../../d5/d6/sessload_8c-source.html#l00045">_SESSIONWIDE_DRIVER_ADDRESS::Address</a>, <a class="el" href="../../d5/d6/sessload_8c-source.html#l00051">MmSessionWideAddressList</a>, <a class="el" href="../../d4/d7/sessload_8c.html#a1">PSESSIONWIDE_DRIVER_ADDRESS</a>, <a class="el" href="../../d5/d6/sessload_8c-source.html#l00046">_SESSIONWIDE_DRIVER_ADDRESS::Size</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00933">SYSLOAD_LOCK_OWNED_BY_ME</a>, and <a class="el" href="../../d5/d6/sessload_8c-source.html#l00047">_SESSIONWIDE_DRIVER_ADDRESS::WritablePages</a>.
<p>
Referenced by <a class="el" href="../../d5/d6/sessload_8c-source.html#l00119">MiShareSessionImage()</a>, and <a class="el" href="../../d9/d7/sysload_8c-source.html#l02896">MmUnloadSystemImage()</a>.
<p>
<pre class="fragment"><div>00874                    :
00875 
00876     Lookup <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size allocated and committed <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base address.
00877     This ensures that we free every page that may have been allocated due
00878     to rounding up.
00879 
00880 Arguments:
00881 
00882     BaseAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> preferred address that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver has
00883                   been linked (rebased) at.  If this address is available,
00884                   the driver will require no relocation.
00885 
00886     NumberOfBytes - Supplies a pointer to store the image size into.
00887 
00888     CommitPages - Supplies a pointer to store the number of committed pages
00889                   that were charged for this image.
00890 
00891 Return Value:
00892 
00893     Returns STATUS_SUCCESS on success, STATUS_NOT_FOUND on failure.
00894 
00895 Environment:
00896 
00897     Kernel mode, APC_LEVEL and below, MmSystemLoadLock held.
00898 
00899 --*/
00900 
00901 {
00902     PLIST_ENTRY NextEntry;
00903     <a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html">PSESSIONWIDE_DRIVER_ADDRESS</a> SessionWideEntry;
00904 
00905     <a class="code" href="../../d4/d8/mi_8h.html#a135">SYSLOAD_LOCK_OWNED_BY_ME</a> ();
00906 
00907     NextEntry = <a class="code" href="../../d4/d7/sessload_8c.html#a2">MmSessionWideAddressList</a>.Flink;
00908 
00909     <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d4/d7/sessload_8c.html#a2">MmSessionWideAddressList</a>) {
00910 
00911         SessionWideEntry = CONTAINING_RECORD (NextEntry,
00912                                               <a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html">SESSIONWIDE_DRIVER_ADDRESS</a>,
00913                                               Link);
00914 
00915         <span class="keywordflow">if</span> (BaseAddress == SessionWideEntry-&gt;<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o2">Address</a>) {
00916 
00917             <span class="keywordflow">if</span> (ARGUMENT_PRESENT (NumberOfBytes)) {
00918                 *NumberOfBytes = SessionWideEntry-&gt;<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o3">Size</a>;
00919             }
00920 
00921             <span class="keywordflow">if</span> (ARGUMENT_PRESENT (CommitPages)) {
00922                 *CommitPages = SessionWideEntry-&gt;<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o4">WritablePages</a>;
00923             }
00924 
00925             <span class="keywordflow">return</span> STATUS_SUCCESS;
00926         }
00927 
00928         NextEntry = NextEntry-&gt;Flink;
00929     }
00930 
00931     <span class="keywordflow">return</span> STATUS_NOT_FOUND;
00932 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="sessload.c::MiSessionWideInitializeAddresses" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiSessionWideInitializeAddresses           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d6/sessload_8c-source.html#l00652">652</a> of file <a class="el" href="../../d5/d6/sessload_8c-source.html">sessload.c</a>.
<p>
References <a class="el" href="../../d5/d6/sessload_8c-source.html#l00051">MmSessionWideAddressList</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/mminit_8c-source.html#l00184">MmInitSystem()</a>.
<p>
<pre class="fragment"><div>00658                    :
00659 
00660     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called at system initialization to set up <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> group
00661     address list.
00662 
00663 Arguments:
00664 
00665     None.
00666 
00667 Return Value:
00668 
00669     None.
00670 
00671 Environment:
00672 
00673     Kernel mode.
00674 
00675 --*/
00676 
00677 {
00678     InitializeListHead (&amp;MmSessionWideAddressList);
00679 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="sessload.c::MiSessionWideInsertImageAddress" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MiSessionWideInsertImageAddress           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>BaseAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>Size</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>WritablePages</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ImageName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>AtPreferredAddress</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d6/sessload_8c-source.html#l00683">683</a> of file <a class="el" href="../../d5/d6/sessload_8c-source.html">sessload.c</a>.
<p>
References <a class="el" href="../../d5/d6/sessload_8c-source.html#l00045">_SESSIONWIDE_DRIVER_ADDRESS::Address</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d5/d6/sessload_8c-source.html#l00048">_SESSIONWIDE_DRIVER_ADDRESS::FullDllName</a>, <a class="el" href="../../d5/d6/sessload_8c-source.html#l00043">_SESSIONWIDE_DRIVER_ADDRESS::Link</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00334">MI_ROUND_TO_SIZE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05380">MM_BUMP_SESSION_FAILURES</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05372">MM_SESSION_FAILURE_NO_NONPAGED_POOL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05371">MM_SESSION_FAILURE_NO_PAGED_POOL</a>, <a class="el" href="../../d5/d6/sessload_8c-source.html#l00051">MmSessionWideAddressList</a>, <a class="el" href="../../d0/d2/rtreplac_8c-source.html#l00045">NewName</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d4/d7/sessload_8c.html#a1">PSESSIONWIDE_DRIVER_ADDRESS</a>, <a class="el" href="../../d5/d6/sessload_8c-source.html#l00044">_SESSIONWIDE_DRIVER_ADDRESS::ReferenceCount</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d4/d7/sessload_8c.html#a0">SESSIONWIDE_DRIVER_ADDRESS</a>, <a class="el" href="../../d5/d6/sessload_8c-source.html#l00046">_SESSIONWIDE_DRIVER_ADDRESS::Size</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00933">SYSLOAD_LOCK_OWNED_BY_ME</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d6/sessload_8c-source.html#l00047">_SESSIONWIDE_DRIVER_ADDRESS::WritablePages</a>.
<p>
Referenced by <a class="el" href="../../d5/d6/sessload_8c-source.html#l00936">MiSessionWideReserveImageAddress()</a>.
<p>
<pre class="fragment"><div>00693                    :
00694 
00695     Allocate and add a SessionWide Entry reference to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> global address
00696     allocation list <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current process' session space.
00697 
00698 Arguments:
00699 
00700     BaseAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base address to allocate an entry <span class="keywordflow">for</span>.
00701 
00702     NumberOfBytes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entry spans.
00703 
00704     WritablePages - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of pages to charge commit <span class="keywordflow">for</span>.
00705 
00706     ImageName - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>
00707                 that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> represented by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> region.
00708 
00709     AtPreferredAddress - Supplies <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> based at its preferred
00710                          address.
00711 
00712 Return Value:
00713 
00714     Returns STATUS_SUCCESS on success, STATUS_NO_MEMORY on <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>.
00715 
00716 Environment:
00717 
00718     Kernel mode, <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> and below, <a class="code" href="../../d4/d8/mi_8h.html#a432">MmSystemLoadLock</a> held.
00719 
00720 --*/
00721 
00722 {
00723     PVOID LastAddress;
00724     PLIST_ENTRY NextEntry;
00725     <a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html">PSESSIONWIDE_DRIVER_ADDRESS</a> Vaddr;
00726     <a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html">PSESSIONWIDE_DRIVER_ADDRESS</a> New;
00727     PWCHAR <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>;
00728 
00729     <a class="code" href="../../d4/d8/mi_8h.html#a135">SYSLOAD_LOCK_OWNED_BY_ME</a> ();
00730 
00731     New = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool,
00732                                  <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html">SESSIONWIDE_DRIVER_ADDRESS</a>),
00733                                  'vHmM');
00734 
00735     <span class="keywordflow">if</span> (New == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00736         <a class="code" href="../../d4/d8/mi_8h.html#a396">MM_BUMP_SESSION_FAILURES</a> (MM_SESSION_FAILURE_NO_NONPAGED_POOL);
00737         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00738     }
00739 
00740     RtlZeroMemory (New, <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html">SESSIONWIDE_DRIVER_ADDRESS</a>));
00741 
00742     New-&gt;<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o1">ReferenceCount</a> = 1;
00743     New-&gt;<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o2">Address</a> = BaseAddress;
00744     New-&gt;<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o3">Size</a> = NumberOfBytes;
00745     <span class="keywordflow">if</span> (AtPreferredAddress == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00746         New-&gt;<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o4">WritablePages</a> = WritablePages;
00747     }
00748     <span class="keywordflow">else</span> {
00749         New-&gt;<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o4">WritablePages</a> = (<a class="code" href="../../d4/d8/mi_8h.html#a90">MI_ROUND_TO_SIZE</a> (NumberOfBytes, PAGE_SIZE)) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
00750     }
00751 
00752     <span class="keywordflow">if</span> (ImageName) {
00753 
00754         <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a> = (PWCHAR) <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (PagedPool,
00755                                       ImageName-&gt;Length + <span class="keyword">sizeof</span>(UNICODE_NULL),
00756                                       'nHmM');
00757 
00758         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00759             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (New);
00760             <a class="code" href="../../d4/d8/mi_8h.html#a396">MM_BUMP_SESSION_FAILURES</a> (MM_SESSION_FAILURE_NO_PAGED_POOL);
00761             <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00762         }
00763 
00764         RtlMoveMemory (NewName, ImageName-&gt;Buffer, ImageName-&gt;Length);
00765         <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a> [ImageName-&gt;Length / <span class="keyword">sizeof</span>(WCHAR)] = UNICODE_NULL;
00766 
00767         New-&gt;<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o5">FullDllName</a>.Buffer = <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>;
00768         New-&gt;<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o5">FullDllName</a>.Length = ImageName-&gt;Length;
00769         New-&gt;<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o5">FullDllName</a>.MaximumLength = ImageName-&gt;Length;
00770     }
00771     <span class="keywordflow">else</span> {
00772         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;New-&gt;<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o5">FullDllName</a>, NULL);
00773     }
00774 
00775     <span class="comment">//</span>
00776     <span class="comment">// Insert the entry in the memory-ordered list.</span>
00777     <span class="comment">//</span>
00778 
00779     LastAddress = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00780     NextEntry = <a class="code" href="../../d4/d7/sessload_8c.html#a2">MmSessionWideAddressList</a>.Flink;
00781 
00782     <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d4/d7/sessload_8c.html#a2">MmSessionWideAddressList</a>) {
00783 
00784         Vaddr = CONTAINING_RECORD (NextEntry,
00785                                    <a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html">SESSIONWIDE_DRIVER_ADDRESS</a>,
00786                                    Link);
00787 
00788         <span class="keywordflow">if</span> (LastAddress &lt; Vaddr-&gt;<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o2">Address</a> &amp;&amp; Vaddr-&gt;<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o2">Address</a> &gt; New-&gt;<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o2">Address</a>) {
00789             <span class="keywordflow">break</span>;
00790         }
00791 
00792         LastAddress = Vaddr-&gt;<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o2">Address</a>;
00793         NextEntry = NextEntry-&gt;Flink;
00794     }
00795 
00796     InsertTailList (NextEntry, &amp;New-&gt;<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o0">Link</a>);
00797 
00798     <span class="keywordflow">return</span> STATUS_SUCCESS;
00799 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="sessload.c::MiSessionWideReserveImageAddress" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MiSessionWideReserveImageAddress           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ImageName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d8/mi_8h.html#a480">PSECTION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Section</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>Alignment</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>AssignedAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>AlreadyLoaded</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d6/sessload_8c-source.html#l00936">936</a> of file <a class="el" href="../../d5/d6/sessload_8c-source.html">sessload.c</a>.
<p>
References <a class="el" href="../../d5/d6/sessload_8c-source.html#l00045">_SESSIONWIDE_DRIVER_ADDRESS::Address</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d6/sessload_8c-source.html#l00048">_SESSIONWIDE_DRIVER_ADDRESS::FullDllName</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00334">MI_ROUND_TO_SIZE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05221">MI_SESSION_IMAGE_SIZE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05272">MI_SESSION_IMAGE_START</a>, <a class="el" href="../../d1/d7/creasect_8c-source.html#l04868">MiGetWritablePagesInSection()</a>, <a class="el" href="../../d5/d6/sessload_8c-source.html#l00381">MiSessionInsertImage()</a>, <a class="el" href="../../d5/d6/sessload_8c-source.html#l00802">MiSessionWideDereferenceImage()</a>, <a class="el" href="../../d5/d6/sessload_8c-source.html#l00683">MiSessionWideInsertImageAddress()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05380">MM_BUMP_SESSION_FAILURES</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00191">MM_DBG_SESSIONS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05373">MM_SESSION_FAILURE_NO_IMAGE_VA_SPACE</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03883">MmIsAddressValid()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05609">MmSessionSpace</a>, <a class="el" href="../../d5/d6/sessload_8c-source.html#l00051">MmSessionWideAddressList</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d4/d7/sessload_8c.html#a1">PSESSIONWIDE_DRIVER_ADDRESS</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d5/d6/sessload_8c-source.html#l00044">_SESSIONWIDE_DRIVER_ADDRESS::ReferenceCount</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01608">RtlEqualUnicodeString()</a>, <a class="el" href="../../d5/d6/sessload_8c-source.html#l00046">_SESSIONWIDE_DRIVER_ADDRESS::Size</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00933">SYSLOAD_LOCK_OWNED_BY_ME</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/sysload_8c-source.html#l01474">MiLoadImageSection()</a>.
<p>
<pre class="fragment"><div>00946                    :
00947 
00948     This routine allocates a range of <span class="keyword">virtual</span> address space within
00949     session space.  This address range <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> unique system-wide and in <span class="keyword">this</span>
00950     manner, code and pristine data of session drivers can be shared across
00951     multiple sessions.
00952 
00953     This routine does not actually commit pages, but reserves <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span>
00954     address region <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> named image.  An entry <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> created here and attached
00955     to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current session space to track <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> loaded image.  Thus <span class="keywordflow">if</span> all
00956     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> references to a given range go away, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> range can then be reused.
00957 
00958 Arguments:
00959 
00960     ImageName - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver that will be loaded into
00961                 <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocated space.
00962 
00963     Section - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section (and thus, the preferred address that the
00964               driver has been linked (rebased) at.  If <span class="keyword">this</span> address is
00965               available, the driver will require no relocation.  The section
00966               is also used to derive the number of bytes to reserve.
00967 
00968     Alignment - Supplies the <span class="keyword">virtual</span> address alignment <span class="keywordflow">for</span> the address.
00969 
00970     AssignedAddress - Supplies a pointer to a variable that receives the
00971                       allocated address <span class="keywordflow">if</span> the routine succeeds.
00972 
00973     AlreadyLoaded - Supplies a pointer to a variable that receives TRUE <span class="keywordflow">if</span> the
00974                     specified image name has already been loaded.
00975 
00976 Return Value:
00977 
00978     Returns STATUS_SUCCESS on success, various NTSTATUS codes on <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>.
00979 
00980 Environment:
00981 
00982     Kernel mode, APC_LEVEL and below, MmSystemLoadLock held.
00983 
00984 --*/
00985 
00986 {
00987     PLIST_ENTRY NextEntry;
00988     <a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html">PSESSIONWIDE_DRIVER_ADDRESS</a> Vaddr;
00989     NTSTATUS Status;
00990     PWCHAR pName;
00991     PVOID NewAddress;
00992     ULONG_PTR AvailableAddress;
00993     ULONG_PTR SessionSpaceEnd;
00994     PVOID PreferredAddress;
00995     ULONG_PTR NumberOfBytes;
00996     ULONG WritablePages;
00997     BOOLEAN AtPreferredAddress;
00998 
00999     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01000 
01001     SYSLOAD_LOCK_OWNED_BY_ME ();
01002 
01003     ASSERT (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Vm.u.Flags.ProcessInSession == 1);
01004     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MmIsAddressValid (MmSessionSpace) == TRUE);
01005 
01006     pName = NULL;
01007     *AlreadyLoaded = FALSE;
01008     PreferredAddress = Section-&gt;Segment-&gt;BasedAddress;
01009     NumberOfBytes = Section-&gt;Segment-&gt;TotalNumberOfPtes &lt;&lt; PAGE_SHIFT;
01010 
01011     AvailableAddress = MI_SESSION_IMAGE_START;
01012     NumberOfBytes = <a class="code" href="../../d4/d8/mi_8h.html#a90">MI_ROUND_TO_SIZE</a> (NumberOfBytes, Alignment);
01013     SessionSpaceEnd = AvailableAddress + MI_SESSION_IMAGE_SIZE;
01014 
01015     Status = <a class="code" href="../../d4/d8/mi_8h.html#a812">MiGetWritablePagesInSection</a>(Section, &amp;WritablePages);
01016 
01017     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01018         WritablePages = Section-&gt;Segment-&gt;TotalNumberOfPtes;
01019     }
01020 
01021     <span class="comment">//</span>
01022     <span class="comment">// If the requested address is not properly aligned or not in the session</span>
01023     <span class="comment">// space region, pick an address for it.  This image will not be shared.</span>
01024     <span class="comment">//</span>
01025 
01026     <span class="keywordflow">if</span> ((ULONG_PTR)PreferredAddress &amp; (Alignment - 1)) {
01027 
01028 <span class="preprocessor">#if DBG</span>
01029 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MiSessionWideReserveImageAddress: Bad alignment 0x%x for PreferredAddress 0x%x\n"</span>,
01030             Alignment,
01031             PreferredAddress);
01032 <span class="preprocessor">#endif</span>
01033 <span class="preprocessor"></span>
01034         PreferredAddress = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01035     }
01036     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((ULONG_PTR)PreferredAddress &lt; AvailableAddress ||
01037              ((ULONG_PTR)PreferredAddress + NumberOfBytes &gt;= SessionSpaceEnd)) {
01038 
01039 <span class="preprocessor">#if DBG</span>
01040 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a83">MM_DBG_SESSIONS</a>) {
01041             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MiSessionWideReserveImageAddress: PreferredAddress 0x%x not in session space\n"</span>, PreferredAddress);
01042         }
01043 <span class="preprocessor">#endif</span>
01044 <span class="preprocessor"></span>
01045         PreferredAddress = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01046     }
01047 
01048     <span class="comment">//</span>
01049     <span class="comment">// Check the system wide session space image list to see if the</span>
01050     <span class="comment">// image name has already been given a slot.</span>
01051     <span class="comment">//</span>
01052 
01053     NextEntry = <a class="code" href="../../d4/d7/sessload_8c.html#a2">MmSessionWideAddressList</a>.Flink;
01054 
01055     <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d4/d7/sessload_8c.html#a2">MmSessionWideAddressList</a>) {
01056 
01057         Vaddr = CONTAINING_RECORD (NextEntry,
01058                                    <a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html">SESSIONWIDE_DRIVER_ADDRESS</a>,
01059                                    Link);
01060 
01061         <span class="keywordflow">if</span> (Vaddr-&gt;FullDllName.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01062 
01063             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>(ImageName, &amp;Vaddr-&gt;FullDllName, TRUE)) {
01064 
01065                 <span class="comment">//</span>
01066                 <span class="comment">// The size requested should be the same.</span>
01067                 <span class="comment">//</span>
01068 
01069                 <span class="keywordflow">if</span> (Vaddr-&gt;Size &lt; NumberOfBytes) {
01070 <span class="preprocessor">#if DBG</span>
01071 <span class="preprocessor"></span>                    <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MiSessionWideReserveImageAddress: Size %d Larger than Entry %d, DLL %wZ\n"</span>,
01072                         NumberOfBytes,
01073                         Vaddr-&gt;Size,
01074                         ImageName);
01075 <span class="preprocessor">#endif</span>
01076 <span class="preprocessor"></span>
01077                     <span class="keywordflow">return</span> STATUS_CONFLICTING_ADDRESSES;
01078                 }
01079         
01080                 <span class="comment">//</span>
01081                 <span class="comment">// This image has already been loaded systemwide.  If it's</span>
01082                 <span class="comment">// already been loaded in this session space as well, just</span>
01083                 <span class="comment">// bump the reference count using the already allocated</span>
01084                 <span class="comment">// address.  Otherwise, insert it into this session space.</span>
01085                 <span class="comment">//</span>
01086 
01087                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d7/sessload_8c.html#a6">MiSessionInsertImage</a> (Vaddr-&gt;Address);
01088 
01089                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_ALREADY_COMMITTED) {
01090 
01091                     *AlreadyLoaded = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01092                     *AssignedAddress = Vaddr-&gt;Address;
01093 
01094                     <span class="keywordflow">return</span> STATUS_SUCCESS;
01095                 }
01096 
01097                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (Status)) {
01098                     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01099                 }
01100 
01101                 <span class="comment">//</span>
01102                 <span class="comment">// Bump the reference count as this is a new entry.</span>
01103                 <span class="comment">//</span>
01104 
01105                 Vaddr-&gt;ReferenceCount += 1;
01106 
01107                 *AssignedAddress = Vaddr-&gt;Address;
01108 
01109                 <span class="keywordflow">return</span> STATUS_SUCCESS;
01110             }
01111         }
01112 
01113         <span class="comment">//</span>
01114         <span class="comment">// Note this list must be sorted by ascending address.</span>
01115         <span class="comment">// See if the PreferredAddress and size collide with any entries.</span>
01116         <span class="comment">//</span>
01117 
01118         <span class="keywordflow">if</span> (PreferredAddress) {
01119 
01120             <span class="keywordflow">if</span> ((PreferredAddress &gt;= Vaddr-&gt;Address) &amp;&amp;
01121                  (PreferredAddress &lt; (PVOID)((ULONG_PTR)Vaddr-&gt;Address + Vaddr-&gt;Size))) {
01122                     PreferredAddress = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01123             }
01124             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((PreferredAddress &lt; Vaddr-&gt;Address) &amp;&amp;
01125                     ((PVOID)((ULONG_PTR)PreferredAddress + NumberOfBytes) &gt; Vaddr-&gt;Address)) {
01126                     PreferredAddress = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01127             }
01128         }
01129 
01130         <span class="comment">//</span>
01131         <span class="comment">// Check for an available general allocation slot.</span>
01132         <span class="comment">//</span>
01133 
01134         <span class="keywordflow">if</span> (((PVOID)AvailableAddress &gt;= Vaddr-&gt;Address) &amp;&amp;
01135             (AvailableAddress &lt;= (ULONG_PTR)Vaddr-&gt;Address + Vaddr-&gt;Size)) {
01136 
01137             AvailableAddress = (ULONG_PTR)Vaddr-&gt;Address + Vaddr-&gt;Size;
01138 
01139             <span class="keywordflow">if</span> (AvailableAddress &amp; (Alignment - 1)) {
01140                 AvailableAddress = <a class="code" href="../../d4/d8/mi_8h.html#a90">MI_ROUND_TO_SIZE</a> (AvailableAddress, Alignment);
01141             }
01142         }
01143         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (AvailableAddress + NumberOfBytes &gt; (ULONG_PTR)Vaddr-&gt;Address) {
01144 
01145             AvailableAddress = (ULONG_PTR)Vaddr-&gt;Address + Vaddr-&gt;Size;
01146 
01147             <span class="keywordflow">if</span> (AvailableAddress &amp; (Alignment - 1)) {
01148                 AvailableAddress = <a class="code" href="../../d4/d8/mi_8h.html#a90">MI_ROUND_TO_SIZE</a> (AvailableAddress, Alignment);
01149             }
01150         }
01151 
01152         NextEntry = NextEntry-&gt;Flink;
01153     }
01154 
01155     <span class="keywordflow">if</span> (PreferredAddress == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; (AvailableAddress + NumberOfBytes &gt; (<a class="code" href="../../d4/d8/mi_8h.html#a347">MI_SESSION_IMAGE_START</a> + <a class="code" href="../../d4/d8/mi_8h.html#a335">MI_SESSION_IMAGE_SIZE</a>))) {
01156         <a class="code" href="../../d4/d8/mi_8h.html#a396">MM_BUMP_SESSION_FAILURES</a> (MM_SESSION_FAILURE_NO_IMAGE_VA_SPACE);
01157         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01158     }
01159 
01160     <span class="comment">//</span>
01161     <span class="comment">// Try to put the module into its requested address so it can be shared.</span>
01162     <span class="comment">//</span>
01163 
01164     <span class="keywordflow">if</span> (PreferredAddress) {
01165 
01166 <span class="preprocessor">#if DBG</span>
01167 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a83">MM_DBG_SESSIONS</a>) {
01168             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MiSessionWideReserveImageAddress: Code Sharing on %wZ, Address 0x%x\n"</span>,ImageName,PreferredAddress);
01169         }
01170 <span class="preprocessor">#endif</span>
01171 <span class="preprocessor"></span>
01172         NewAddress = PreferredAddress;
01173     }
01174     <span class="keywordflow">else</span> {
01175         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (AvailableAddress != 0);
01176         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((AvailableAddress &amp; (Alignment - 1)) == 0);
01177 
01178 <span class="preprocessor">#if DBG</span>
01179 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MiSessionWideReserveImageAddress: NO Code Sharing on %wZ, Address 0x%x\n"</span>,ImageName,AvailableAddress);
01180 <span class="preprocessor">#endif</span>
01181 <span class="preprocessor"></span>
01182         NewAddress = (PVOID)AvailableAddress;
01183     }
01184 
01185     <span class="comment">//</span>
01186     <span class="comment">// Create a new node entry for the address range.</span>
01187     <span class="comment">//</span>
01188 
01189     <span class="keywordflow">if</span> (NewAddress == PreferredAddress) {
01190         AtPreferredAddress = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01191     }
01192     <span class="keywordflow">else</span> {
01193         AtPreferredAddress = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01194     }
01195 
01196     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d7/sessload_8c.html#a8">MiSessionWideInsertImageAddress</a> (NewAddress,
01197                                               NumberOfBytes,
01198                                               WritablePages,
01199                                               ImageName,
01200                                               AtPreferredAddress);
01201 
01202     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01203         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01204     }
01205 
01206     <span class="comment">//</span>
01207     <span class="comment">// Create an entry for this image in the current session space.</span>
01208     <span class="comment">//</span>
01209 
01210     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d7/sessload_8c.html#a6">MiSessionInsertImage</a> (NewAddress);
01211 
01212     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01213         <a class="code" href="../../d4/d7/sessload_8c.html#a9">MiSessionWideDereferenceImage</a> (NewAddress);
01214         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01215     }
01216 
01217     *AssignedAddress = NewAddress;
01218 
01219     <span class="keywordflow">return</span> STATUS_SUCCESS;
01220 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="sessload.c::MiSetProtectionOnTransitionPte" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG MiSetProtectionOnTransitionPte           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PointerPte</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ProtectionMask</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="sessload.c::MiShareSessionImage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MiShareSessionImage           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d8/mi_8h.html#a480">PSECTION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Section</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PSIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>ViewSize</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d6/sessload_8c-source.html#l00119">119</a> of file <a class="el" href="../../d5/d6/sessload_8c-source.html">sessload.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00141">BYTES_TO_PAGES</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05471">_MM_SESSION_SPACE::CommittedPages</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02001">_SEGMENT::ControlArea</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l03321">ExPageLockHandle</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05765">_IMAGE_ENTRY_IN_SESSION::LastAddress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05688">LOCK_SESSION_SPACE_WS</a>, <a class="el" href="../../d2/d4/mapcache_8c-source.html#l00287">MiAddMappedPtes()</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00191">MiChargeCommitment()</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l01823">MiCheckControlArea()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l02809">MiCheckPurgeAndUpMapCount()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00442">MiReturnCommitment()</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l02318">MiSessionCommitPageTables()</a>, <a class="el" href="../../d5/d6/sessload_8c-source.html#l00518">MiSessionLookupImage()</a>, <a class="el" href="../../d5/d6/sessload_8c-source.html#l00866">MiSessionWideGetImageSize()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l05376">MiSetImageProtect()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05361">MM_BUMP_SESS_COUNTER</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05380">MM_BUMP_SESSION_FAILURES</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04269">MM_DBG_COMMIT_SESSION_SHARED_IMAGE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05309">MM_DBG_SESSION_SYSMAPPED_PAGES_ALLOC</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05321">MM_DBG_SESSION_SYSMAPPED_PAGES_COMMITTED</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00136">MM_EXECUTE_READ</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05367">MM_SESSION_FAILURE_NO_COMMIT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04221">MM_TRACK_COMMIT</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03883">MmIsAddressValid()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06284">MmLockPagableSectionByHandle()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05609">MmSessionSpace</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07065">MmUnlockPagableImageSection()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02062">_CONTROL_AREA::NumberOfMappedViews</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02065">_CONTROL_AREA::NumberOfUserReferences</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05767">_IMAGE_ENTRY_IN_SESSION::PrototypePtes</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02058">_CONTROL_AREA::Segment</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00933">SYSLOAD_LOCK_OWNED_BY_ME</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d8/d7/struct__CONTROL__AREA.html#o10">_CONTROL_AREA::u</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l05694">UNLOCK_SESSION_SPACE_WS</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/sysload_8c-source.html#l01474">MiLoadImageSection()</a>.
<p>
<pre class="fragment"><div>00126                    :
00127 
00128     This routine maps <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given image into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current session space.
00129     This allows <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image to be executed backed by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00130     filesystem and allow code and read-<a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> data to be shared.
00131 
00132 Arguments:
00133 
00134     Section - Supplies a pointer to a section.
00135 
00136     ViewSize - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size in bytes of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view desired.
00137 
00138 Return Value:
00139 
00140     Returns STATUS_SUCCESS on success, various <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> codes on <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>.
00141 
00142 Environment:
00143 
00144     Kernel mode, <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> and below, <a class="code" href="../../d4/d8/mi_8h.html#a432">MmSystemLoadLock</a> held.
00145 
00146 --*/
00147 
00148 {
00149     KIRQL WsIrql;
00150     KIRQL OldIrql;
00151     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> Subsection;
00152     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
00153     ULONG NumberOfPtes;
00154     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartPte;
00155     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> EndPte;
00156     PVOID AllocationStart;
00157     SIZE_T AllocationSize;
00158     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00159     BOOLEAN FirstMapped;
00160     PVOID MappedBase;
00161     SIZE_T CommittedPages;
00162     <a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html">PIMAGE_ENTRY_IN_SESSION</a> DriverImage;
00163 
00164     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00165 
00166     <a class="code" href="../../d4/d8/mi_8h.html#a135">SYSLOAD_LOCK_OWNED_BY_ME</a> ();
00167 
00168     <span class="keywordflow">if</span> (*ViewSize == 0) {
00169         <span class="keywordflow">return</span> STATUS_SUCCESS;
00170     }
00171 
00172     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MmIsAddressValid (MmSessionSpace) == TRUE);
00173 
00174     MappedBase = Section-&gt;Segment-&gt;BasedAddress;
00175 
00176     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (((ULONG_PTR)MappedBase % PAGE_SIZE) == 0);
00177     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((*ViewSize % PAGE_SIZE) == 0);
00178 
00179     <a class="code" href="../../d5/d6/iosup_8c.html#a76">MmLockPagableSectionByHandle</a> (ExPageLockHandle);
00180 
00181     <a class="code" href="../../d4/d8/mi_8h.html#a407">LOCK_SESSION_SPACE_WS</a> (WsIrql);
00182 
00183     <span class="comment">//</span>
00184     <span class="comment">// Check to see if a purge operation is in progress and if so, wait</span>
00185     <span class="comment">// for the purge to complete.  In addition, up the count of mapped</span>
00186     <span class="comment">// views for this control area.</span>
00187     <span class="comment">//</span>
00188 
00189     ControlArea = Section-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o0">Segment</a>-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o0">ControlArea</a>;
00190 
00191     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.GlobalOnlyPerSession == 0);
00192 
00193     Subsection = (<a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a>)(ControlArea + 1);
00194 
00195     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a928">MiCheckPurgeAndUpMapCount</a> (ControlArea) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00196         <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a>(WsIrql);
00197         <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(ExPageLockHandle);
00198         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00199     }
00200 
00201     <span class="keywordflow">if</span> (*ViewSize == 0) {
00202 
00203         *ViewSize = Section-&gt;SizeOfSection.LowPart;
00204 
00205     }
00206     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*ViewSize &gt; Section-&gt;SizeOfSection.LowPart) {
00207 
00208         <span class="comment">//</span>
00209         <span class="comment">// Section offset or view size past size of section.</span>
00210         <span class="comment">//</span>
00211 
00212         <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a>(WsIrql);
00213         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00214         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o4">NumberOfMappedViews</a> -= 1;
00215         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o7">NumberOfUserReferences</a> -= 1;
00216 
00217         <span class="comment">//</span>
00218         <span class="comment">// Check to see if the control area (segment) should be deleted.</span>
00219         <span class="comment">// This routine releases the PFN lock.</span>
00220         <span class="comment">//</span>
00221     
00222         <a class="code" href="../../d5/d5/sectsup_8c.html#a24">MiCheckControlArea</a> (ControlArea, NULL, OldIrql);
00223 
00224         <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(ExPageLockHandle);
00225         <span class="keywordflow">return</span> STATUS_INVALID_VIEW_SIZE;
00226     }
00227 
00228     AllocationStart = MappedBase;
00229 
00230     AllocationSize = *ViewSize;
00231 
00232     <span class="comment">//</span>
00233     <span class="comment">// Calculate the PTE ranges and amount.</span>
00234     <span class="comment">//</span>
00235 
00236     StartPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (AllocationStart);
00237 
00238     EndPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> ((PCHAR)AllocationStart + AllocationSize);
00239 
00240     NumberOfPtes = <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a> (AllocationSize);
00241 
00242     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d7/sessload_8c.html#a16">MiSessionWideGetImageSize</a> (MappedBase,
00243                                         NULL,
00244                                         &amp;CommittedPages);
00245 
00246     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00247         CommittedPages = NumberOfPtes;
00248     }
00249 
00250     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00251 
00252     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d1/mmquota_8c.html#a17">MiChargeCommitment</a> (CommittedPages, NULL) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00253         <a class="code" href="../../d4/d8/mi_8h.html#a396">MM_BUMP_SESSION_FAILURES</a> (MM_SESSION_FAILURE_NO_COMMIT);
00254         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
00255     }
00256 
00257     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00258 
00259         <span class="comment">//</span>
00260         <span class="comment">// Don't bother releasing the page tables or their commit here, another</span>
00261         <span class="comment">// load will happen shortly or the whole session will go away.  On</span>
00262         <span class="comment">// session exit everything will be released automatically.</span>
00263         <span class="comment">//</span>
00264 
00265         <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a>(WsIrql);
00266 
00267         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00268         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o4">NumberOfMappedViews</a> -= 1;
00269         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o7">NumberOfUserReferences</a> -= 1;
00270 
00271         <span class="comment">//</span>
00272         <span class="comment">// Check to see if the control area (segment) should be deleted.</span>
00273         <span class="comment">// This routine releases the PFN lock.</span>
00274         <span class="comment">//</span>
00275     
00276         <a class="code" href="../../d5/d5/sectsup_8c.html#a24">MiCheckControlArea</a> (ControlArea, NULL, OldIrql);
00277 
00278         <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(ExPageLockHandle);
00279         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00280     }
00281 
00282     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o14">CommittedPages</a> += CommittedPages;
00283 
00284     <span class="comment">//</span>
00285     <span class="comment">// Make sure we have page tables for the PTE</span>
00286     <span class="comment">// entries we must fill in the session space structure.</span>
00287     <span class="comment">//</span>
00288 
00289     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d7/session_8c.html#a9">MiSessionCommitPageTables</a> (AllocationStart,
00290                                         (PVOID)((PCHAR)AllocationStart + AllocationSize));
00291 
00292     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00293 
00294         <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o14">CommittedPages</a> -= CommittedPages;
00295         <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a> (WsIrql);
00296 
00297         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00298         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o4">NumberOfMappedViews</a> -= 1;
00299         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o7">NumberOfUserReferences</a> -= 1;
00300 
00301         <span class="comment">//</span>
00302         <span class="comment">// Check to see if the control area (segment) should be deleted.</span>
00303         <span class="comment">// This routine releases the PFN lock.</span>
00304         <span class="comment">//</span>
00305     
00306         <a class="code" href="../../d5/d5/sectsup_8c.html#a24">MiCheckControlArea</a> (ControlArea, NULL, OldIrql);
00307 
00308         <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a> (ExPageLockHandle);
00309         <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (CommittedPages);
00310 
00311         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00312     }
00313 
00314     <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_SESSION_SHARED_IMAGE, CommittedPages);
00315 
00316     <a class="code" href="../../d4/d8/mi_8h.html#a384">MM_BUMP_SESS_COUNTER</a> (MM_DBG_SESSION_SYSMAPPED_PAGES_COMMITTED, CommittedPages);
00317 
00318     <a class="code" href="../../d4/d8/mi_8h.html#a384">MM_BUMP_SESS_COUNTER</a> (MM_DBG_SESSION_SYSMAPPED_PAGES_ALLOC, NumberOfPtes);
00319 
00320 <span class="preprocessor">#if DBG</span>
00321 <span class="preprocessor"></span>    <span class="keywordflow">while</span> (StartPte &lt; EndPte) {
00322         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (StartPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0);
00323         StartPte += 1;
00324     }
00325     StartPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (AllocationStart);
00326 <span class="preprocessor">#endif</span>
00327 <span class="preprocessor"></span>
00328     <span class="comment">//</span>
00329     <span class="comment">// Flag that the image is mapped into system space.</span>
00330     <span class="comment">//</span>
00331 
00332     <span class="keywordflow">if</span> (Section-&gt;u.Flags.Image) {
00333 
00334         FirstMapped = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00335 
00336         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00337         <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.ImageMappedInSystemSpace == 0) {
00338             FirstMapped = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00339             ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.ImageMappedInSystemSpace = 1;
00340         }
00341         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00342 
00343         <span class="comment">//</span>
00344         <span class="comment">// Initialize all of the pages to copy on write - later read only</span>
00345         <span class="comment">// protections will be set on the code pages.</span>
00346         <span class="comment">//</span>
00347     
00348         <span class="keywordflow">if</span> (FirstMapped == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00349             <a class="code" href="../../d8/d8/sysload_8c.html#a62">MiSetImageProtect</a> (Section-&gt;Segment, MM_EXECUTE_READ);
00350         }
00351     }
00352 
00353     <span class="comment">//</span>
00354     <span class="comment">// Initialize the PTEs as copy on write, pointing at the prototype PTEs.</span>
00355     <span class="comment">//</span>
00356 
00357     <a class="code" href="../../d4/d8/mi_8h.html#a816">MiAddMappedPtes</a> (StartPte,
00358                      NumberOfPtes,
00359                      ControlArea);
00360 
00361     <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a>(WsIrql);
00362 
00363     <span class="comment">//</span>
00364     <span class="comment">// No session space image faults may be taken until these fields of the</span>
00365     <span class="comment">// image entry are initialized.</span>
00366     <span class="comment">//</span>
00367 
00368     DriverImage = <a class="code" href="../../d4/d7/sessload_8c.html#a13">MiSessionLookupImage</a> (AllocationStart);
00369     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (DriverImage);
00370 
00371     DriverImage-&gt;<a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html#o2">LastAddress</a> = (PVOID)((PCHAR)AllocationStart + AllocationSize - 1);
00372     DriverImage-&gt;<a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html#o4">PrototypePtes</a> = Section-&gt;Segment-&gt;PrototypePte;
00373 
00374     <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(ExPageLockHandle);
00375 
00376     <span class="keywordflow">return</span> STATUS_SUCCESS;
00377 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a2" doxytag="sessload.c::MmSessionWideAddressList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LIST_ENTRY <a class="el" href="../../d4/d7/sessload_8c.html#a2">MmSessionWideAddressList</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d6/sessload_8c-source.html#l00051">51</a> of file <a class="el" href="../../d5/d6/sessload_8c-source.html">sessload.c</a>.
<p>
Referenced by <a class="el" href="../../d5/d6/sessload_8c-source.html#l00802">MiSessionWideDereferenceImage()</a>, <a class="el" href="../../d5/d6/sessload_8c-source.html#l00866">MiSessionWideGetImageSize()</a>, <a class="el" href="../../d5/d6/sessload_8c-source.html#l00652">MiSessionWideInitializeAddresses()</a>, <a class="el" href="../../d5/d6/sessload_8c-source.html#l00683">MiSessionWideInsertImageAddress()</a>, and <a class="el" href="../../d5/d6/sessload_8c-source.html#l00936">MiSessionWideReserveImageAddress()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="sessload.c::PsLoadedModuleList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LIST_ENTRY <a class="el" href="../../d8/d8/sysload_8c.html#a27">PsLoadedModuleList</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d6/sessload_8c-source.html#l00059">59</a> of file <a class="el" href="../../d5/d6/sessload_8c-source.html">sessload.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="sessload.c::PsLoadedModuleSpinLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> KSPIN_LOCK <a class="el" href="../../d8/d8/sysload_8c.html#a23">PsLoadedModuleSpinLock</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d6/sessload_8c-source.html#l00057">57</a> of file <a class="el" href="../../d5/d6/sessload_8c-source.html">sessload.c</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:38 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
