<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: winmgrc.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>winmgrc.c</h1><a href="../../d3/d8/winmgrc_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: winmgrc.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* This module contains</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 20-Feb-1992 DarrinM   Pulled functions from user\server.</span>
00010 <span class="comment">\***************************************************************************/</span>
00011 
00012 <span class="preprocessor">#include "<a class="code" href="../../d7/d3/w32_2ntuser_2client_2precomp_8h.html">precomp.h</a>"</span>
00013 <span class="preprocessor">#pragma hdrstop</span>
00014 <span class="preprocessor"></span>
<a name="l00015"></a><a class="code" href="../../d3/d8/winmgrc_8c.html#a0">00015</a> <span class="preprocessor">#define CONSOLE_WINDOW_CLASS (L"ConsoleWindowClass")</span>
00016 <span class="preprocessor"></span>
00017 <span class="comment">/***************************************************************************\</span>
00018 <span class="comment">* GetWindowWord (API)</span>
00019 <span class="comment">*</span>
00020 <span class="comment">* Return a window word.  Positive index values return application window words</span>
00021 <span class="comment">* while negative index values return system window words.  The negative</span>
00022 <span class="comment">* indices are published in WINDOWS.H.</span>
00023 <span class="comment">*</span>
00024 <span class="comment">* History:</span>
00025 <span class="comment">* 20-Feb-1992 DarrinM   Wrote.</span>
00026 <span class="comment">\***************************************************************************/</span>
00027 
<a name="l00028"></a><a class="code" href="../../d3/d8/winmgrc_8c.html#a7">00028</a> WORD <a class="code" href="../../d3/d8/winmgrc_8c.html#a7">GetWindowWord</a>(
00029     HWND hwnd,
00030     <span class="keywordtype">int</span>  index)
00031 {
00032     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
00033 
00034     pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hwnd);
00035 
00036     <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00037         <span class="keywordflow">return</span> 0;
00038 
00039     <span class="comment">/*</span>
00040 <span class="comment">     * If it's a dialog window the window data is on the server side</span>
00041 <span class="comment">     * We just call the "long" routine instead of have two thunks.</span>
00042 <span class="comment">     * We know there is enough data if its DWLP_USER so we won't fault.</span>
00043 <span class="comment">     */</span>
00044     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a567">WFDIALOGWINDOW</a>) &amp;&amp; (index == DWLP_USER)) {
00045         <span class="keywordflow">return</span> (WORD)<a class="code" href="../../d4/d1/userk_8h.html#a589">_GetWindowLong</a>(pwnd, index, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00046     }
00047 
00048     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a555">_GetWindowWord</a>(pwnd, index);
00049 }
00050 
00051 
<a name="l00052"></a><a class="code" href="../../d3/d8/winmgrc_8c.html#a8">00052</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d8/winmgrc_8c.html#a8">FChildVisible</a>(
00053     HWND hwnd)
00054 {
00055     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
00056 
00057     pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hwnd);
00058 
00059     <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00060         <span class="keywordflow">return</span> 0;
00061 
00062     <span class="keywordflow">return</span> (<a class="code" href="../../d2/d8/rtl_2winmgr_8c.html#a1">_FChildVisible</a>(pwnd));
00063 }
00064 
<a name="l00065"></a><a class="code" href="../../d3/d8/winmgrc_8c.html#a9">00065</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d3/d8/winmgrc_8c.html#a9">AdjustWindowRectEx</a>(
00066     LPRECT lpRect,
00067     DWORD dwStyle,
00068     BOOL bMenu,
00069     DWORD dwExStyle)
00070 {
00071     <a class="code" href="../../d1/d0/inc_2user_8h.html#a848">ConnectIfNecessary</a>();
00072 
00073     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/inc_2user_8h.html#a1195">_AdjustWindowRectEx</a>(lpRect, dwStyle, bMenu, dwExStyle);
00074 }
00075 
00076 
<a name="l00077"></a><a class="code" href="../../d3/d8/winmgrc_8c.html#a10">00077</a> <span class="keywordtype">int</span> WINAPI <a class="code" href="../../d3/d8/winmgrc_8c.html#a10">GetClassNameW</a>(
00078     HWND hwnd,
00079     LPWSTR lpClassName,
00080     <span class="keywordtype">int</span> nMaxCount)
00081 {
00082     UNICODE_STRING strClassName;
00083 
00084     strClassName.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(nMaxCount * <span class="keyword">sizeof</span>(WCHAR));
00085     strClassName.Buffer = lpClassName;
00086     <span class="keywordflow">return</span> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a308">NtUserGetClassName</a>(hwnd, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;strClassName);
00087 }
00088 
00089 
<a name="l00090"></a><a class="code" href="../../d3/d8/winmgrc_8c.html#a11">00090</a> HWND <a class="code" href="../../d3/d8/winmgrc_8c.html#a11">GetFocus</a>(VOID)
00091 {
00092     <span class="keywordflow">return</span> (HWND)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a287">NtUserGetThreadState</a>(UserThreadStateFocusWindow);
00093 }
00094 
00095 
<a name="l00096"></a><a class="code" href="../../d3/d8/winmgrc_8c.html#a12">00096</a> HWND <a class="code" href="../../d3/d8/winmgrc_8c.html#a12">GetCapture</a>(VOID)
00097 {
00098     <span class="comment">/*</span>
00099 <span class="comment">     * If no captures are currently taking place, just return NULL.</span>
00100 <span class="comment">     */</span>
00101     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;cCaptures == 0) {
00102         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00103     }
00104     <span class="keywordflow">return</span> (HWND)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a287">NtUserGetThreadState</a>(UserThreadStateCaptureWindow);
00105 }
00106 
00107 <span class="comment">/***************************************************************************\</span>
00108 <span class="comment">* AnyPopup (API)</span>
00109 <span class="comment">*</span>
00110 <span class="comment">*</span>
00111 <span class="comment">*</span>
00112 <span class="comment">* History:</span>
00113 <span class="comment">* 12-Nov-1990 DarrinM   Ported.</span>
00114 <span class="comment">\***************************************************************************/</span>
00115 
<a name="l00116"></a><a class="code" href="../../d3/d8/winmgrc_8c.html#a13">00116</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d8/winmgrc_8c.html#a13">AnyPopup</a>(VOID)
00117 {
00118     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd = <a class="code" href="../../d3/d9/client_2wow_8c.html#a3">_GetDesktopWindow</a>();
00119 
00120     <span class="keywordflow">for</span> (pwnd = <a class="code" href="../../d6/d0/usercli_8h.html#a27">REBASEPWND</a>(pwnd, spwndChild); pwnd; pwnd = <a class="code" href="../../d6/d0/usercli_8h.html#a27">REBASEPWND</a>(pwnd, spwndNext)) {
00121 
00122         <span class="keywordflow">if</span> ((pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>))
00123             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00124     }
00125 
00126     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00127 }
00128 
00129 <span class="comment">/***************************************************************************\</span>
00130 <span class="comment">* GetInputState</span>
00131 <span class="comment">*</span>
00132 <span class="comment">*</span>
00133 <span class="comment">*</span>
00134 <span class="comment">* History:</span>
00135 <span class="comment">\***************************************************************************/</span>
00136 
<a name="l00137"></a><a class="code" href="../../d3/d8/winmgrc_8c.html#a14">00137</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d8/winmgrc_8c.html#a14">GetInputState</a>(VOID)
00138 {
00139     <a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html">PCLIENTTHREADINFO</a> pcti = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a16">GetClientInfo</a>()-&gt;pClientThreadInfo;
00140 
00141     <span class="keywordflow">if</span> ((pcti == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (pcti-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o1">fsChangeBits</a> &amp; (QS_MOUSEBUTTON | QS_KEY)))
00142         <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a287">NtUserGetThreadState</a>(UserThreadStateInputState);
00143 
00144     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00145 }
00146 
00147 <span class="comment">/***************************************************************************\</span>
00148 <span class="comment">* MapWindowPoints</span>
00149 <span class="comment">*</span>
00150 <span class="comment">*</span>
00151 <span class="comment">*</span>
00152 <span class="comment">* History:</span>
00153 <span class="comment">\***************************************************************************/</span>
00154 
<a name="l00155"></a><a class="code" href="../../d3/d8/winmgrc_8c.html#a15">00155</a> <span class="keywordtype">int</span> <a class="code" href="../../d3/d8/winmgrc_8c.html#a15">MapWindowPoints</a>(
00156     HWND    hwndFrom,
00157     HWND    hwndTo,
00158     LPPOINT lppt,
00159     UINT    cpt)
00160 {
00161     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndFrom;
00162     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndTo;
00163 
00164     <span class="keywordflow">if</span> (hwndFrom != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00165 
00166         <span class="keywordflow">if</span> ((pwndFrom = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hwndFrom)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00167             <span class="keywordflow">return</span> 0;
00168 
00169     } <span class="keywordflow">else</span> {
00170 
00171         pwndFrom = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00172     }
00173 
00174     <span class="keywordflow">if</span> (hwndTo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00175 
00176 
00177         <span class="keywordflow">if</span> ((pwndTo = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hwndTo)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00178             <span class="keywordflow">return</span> 0;
00179 
00180     } <span class="keywordflow">else</span> {
00181 
00182         pwndTo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00183     }
00184 
00185     <span class="keywordflow">return</span> <a class="code" href="../../d2/d8/rtl_2winmgr_8c.html#a2">_MapWindowPoints</a>(pwndFrom, pwndTo, lppt, cpt);
00186 }
00187 
00188 <span class="comment">/***************************************************************************\</span>
00189 <span class="comment">* GetLastActivePopup</span>
00190 <span class="comment">*</span>
00191 <span class="comment">*</span>
00192 <span class="comment">*</span>
00193 <span class="comment">* History:</span>
00194 <span class="comment">\***************************************************************************/</span>
00195 
<a name="l00196"></a><a class="code" href="../../d3/d8/winmgrc_8c.html#a16">00196</a> HWND <a class="code" href="../../d3/d8/winmgrc_8c.html#a16">GetLastActivePopup</a>(
00197     HWND hwnd)
00198 {
00199     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hwnd);
00200 
00201     <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00202         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00203 
00204     pwnd = <a class="code" href="../../d2/d8/rtl_2winmgr_8c.html#a4">_GetLastActivePopup</a>(pwnd);
00205 
00206     <span class="keywordflow">return</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwnd);
00207 }
00208 
00209 <span class="comment">/**************************************************************************\</span>
00210 <span class="comment">* PtiWindow</span>
00211 <span class="comment">*</span>
00212 <span class="comment">* Gets the PTHREADINFO of window or NULL if not valid.</span>
00213 <span class="comment">*</span>
00214 <span class="comment">* 12-Feb-1997 JerrySh   Created.</span>
00215 <span class="comment">\**************************************************************************/</span>
00216 
<a name="l00217"></a><a class="code" href="../../d3/d8/winmgrc_8c.html#a17">00217</a> <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> <a class="code" href="../../d3/d8/winmgrc_8c.html#a17">PtiWindow</a>(
00218     HWND hwnd)
00219 {
00220     <a class="code" href="../../d2/d4/struct__HANDLEENTRY.html">PHE</a> phe;
00221     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dw;
00222     WORD uniq;
00223 
00224     dw = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a432">HMIndexFromHandle</a>(hwnd);
00225     <span class="keywordflow">if</span> (dw &lt; <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o4">cHandleEntries</a>) {
00226         phe = &amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o1">aheList</a>[dw];
00227         <span class="keywordflow">if</span> ((phe-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o2">bType</a> == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a237">TYPE_WINDOW</a>) &amp;&amp; !(phe-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o3">bFlags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a421">HANDLEF_DESTROY</a>)) {
00228             uniq = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a435">HMUniqFromHandle</a>(hwnd);
00229             <span class="keywordflow">if</span> (   uniq == phe-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o4">wUniq</a>
00230 <span class="preprocessor">#if !defined(_WIN64) &amp;&amp; !defined(BUILD_WOW6432)</span>
00231 <span class="preprocessor"></span>                || uniq == 0
00232                 || uniq == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a430">HMUNIQBITS</a>
00233 <span class="preprocessor">#endif</span>
00234 <span class="preprocessor"></span>                ) {
00235                 <span class="keywordflow">return</span> phe-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o1">pOwner</a>;
00236             }
00237         }
00238     }
00239     UserSetLastError(ERROR_INVALID_WINDOW_HANDLE);
00240     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00241 }
00242 
00243 <span class="comment">/***************************************************************************\</span>
00244 <span class="comment">* GetWindowThreadProcessId</span>
00245 <span class="comment">*</span>
00246 <span class="comment">* Get's windows process and thread ids.</span>
00247 <span class="comment">*</span>
00248 <span class="comment">* 24-Jun-1991 ScottLu   Created.</span>
00249 <span class="comment">\***************************************************************************/</span>
00250 
<a name="l00251"></a><a class="code" href="../../d3/d8/winmgrc_8c.html#a18">00251</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d3/d8/winmgrc_8c.html#a18">GetWindowThreadProcessId</a>(
00252     HWND    hwnd,
00253     LPDWORD lpdwProcessId)
00254 {
00255     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiWindow;
00256     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwThreadId;
00257 
00258     <span class="keywordflow">if</span> ((ptiWindow = <a class="code" href="../../d3/d8/winmgrc_8c.html#a17">PtiWindow</a>(hwnd)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00259         <span class="keywordflow">return</span> 0;
00260 
00261     <span class="comment">/*</span>
00262 <span class="comment">     * For non-system threads get the info from the thread info structure</span>
00263 <span class="comment">     */</span>
00264     <span class="keywordflow">if</span> (ptiWindow == <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()) {
00265 
00266         <span class="keywordflow">if</span> (lpdwProcessId != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00267             *lpdwProcessId = HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueProcess);
00268         dwThreadId = HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueThread);
00269 
00270     } <span class="keywordflow">else</span> {
00271 
00272         <span class="comment">/*</span>
00273 <span class="comment">         * Make this better later on.</span>
00274 <span class="comment">         */</span>
00275         <span class="keywordflow">if</span> (lpdwProcessId != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00276             *lpdwProcessId = HandleToUlong(<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a328">NtUserQueryWindow</a>(hwnd, WindowProcess));
00277         dwThreadId = HandleToUlong(<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a328">NtUserQueryWindow</a>(hwnd, WindowThread));
00278     }
00279 
00280     <span class="keywordflow">return</span> dwThreadId;
00281 }
00282 
00283 <span class="comment">/***************************************************************************\</span>
00284 <span class="comment">* GetScrollPos</span>
00285 <span class="comment">*</span>
00286 <span class="comment">* Returns the current position of a scroll bar</span>
00287 <span class="comment">*</span>
00288 <span class="comment">* !!! WARNING a similiar copy of this code is in server\sbapi.c</span>
00289 <span class="comment">*</span>
00290 <span class="comment">* History:</span>
00291 <span class="comment">\***************************************************************************/</span>
00292 
<a name="l00293"></a><a class="code" href="../../d3/d8/winmgrc_8c.html#a19">00293</a> <span class="keywordtype">int</span> <a class="code" href="../../d3/d8/winmgrc_8c.html#a19">GetScrollPos</a>(
00294     HWND hwnd,
00295     <span class="keywordtype">int</span>  code)
00296 {
00297     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
00298 
00299     <span class="keywordflow">if</span> ((pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hwnd)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00300         <span class="keywordflow">return</span> 0;
00301 
00302     <span class="keywordflow">switch</span> (code) {
00303     <span class="keywordflow">case</span> SB_CTL:
00304         <span class="keywordflow">return</span> (<span class="keywordtype">int</span>)<a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pwnd, SBM_GETPOS, 0, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00305 
00306     <span class="keywordflow">case</span> SB_HORZ:
00307     <span class="keywordflow">case</span> SB_VERT:
00308         <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o14">pSBInfo</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00309             <a class="code" href="../../d5/d5/structtagSBINFO.html">PSBINFO</a> pSBInfo = (<a class="code" href="../../d5/d5/structtagSBINFO.html">PSBINFO</a>)(<a class="code" href="../../d6/d0/usercli_8h.html#a24">REBASEALWAYS</a>(pwnd, pSBInfo));
00310             <span class="keywordflow">return</span> (code == SB_VERT) ? pSBInfo-&gt;<a class="code" href="../../d5/d5/structtagSBINFO.html#o2">Vert</a>.<a class="code" href="../../d4/d5/structtagSBDATA.html#o3">pos</a> : pSBInfo-&gt;<a class="code" href="../../d5/d5/structtagSBINFO.html#o1">Horz</a>.<a class="code" href="../../d4/d5/structtagSBDATA.html#o3">pos</a>;
00311         } <span class="keywordflow">else</span> {
00312             RIPERR0(ERROR_NO_SCROLLBARS, RIP_VERBOSE, <span class="stringliteral">""</span>);
00313         }
00314         <span class="keywordflow">break</span>;
00315 
00316     <span class="keywordflow">default</span>:
00317         <span class="comment">/*</span>
00318 <span class="comment">         * Win3.1 validation layer code.</span>
00319 <span class="comment">         */</span>
00320         RIPERR0(ERROR_INVALID_PARAMETER, RIP_VERBOSE, <span class="stringliteral">""</span>);
00321     }
00322 
00323     <span class="keywordflow">return</span> 0;
00324 }
00325 
00326 <span class="comment">/***************************************************************************\</span>
00327 <span class="comment">* GetScrollRange</span>
00328 <span class="comment">*</span>
00329 <span class="comment">* !!! WARNING a similiar copy of this code is in server\sbapi.c</span>
00330 <span class="comment">*</span>
00331 <span class="comment">* History:</span>
00332 <span class="comment">* 16-May-1991 mikeke    Changed to return BOOL</span>
00333 <span class="comment">\***************************************************************************/</span>
00334 
<a name="l00335"></a><a class="code" href="../../d3/d8/winmgrc_8c.html#a20">00335</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d8/winmgrc_8c.html#a20">GetScrollRange</a>(
00336     HWND  hwnd,
00337     <span class="keywordtype">int</span>   code,
00338     LPINT lpposMin,
00339     LPINT lpposMax)
00340 {
00341     <a class="code" href="../../d5/d5/structtagSBINFO.html">PSBINFO</a> pSBInfo;
00342     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>    pwnd;
00343 
00344     <span class="keywordflow">if</span> ((pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hwnd)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00345         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00346 
00347     <span class="keywordflow">switch</span> (code) {
00348     <span class="keywordflow">case</span> SB_CTL:
00349         <a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pwnd, SBM_GETRANGE, (WPARAM)lpposMin, (LPARAM)lpposMax, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00350         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00351 
00352     <span class="keywordflow">case</span> SB_VERT:
00353     <span class="keywordflow">case</span> SB_HORZ:
00354         <span class="keywordflow">if</span> (pSBInfo = <a class="code" href="../../d6/d0/usercli_8h.html#a26">REBASE</a>(pwnd, pSBInfo)) {
00355             <a class="code" href="../../d4/d5/structtagSBDATA.html">PSBDATA</a> pSBData;
00356             pSBData = (code == SB_VERT) ? &amp;pSBInfo-&gt;<a class="code" href="../../d5/d5/structtagSBINFO.html#o2">Vert</a> : &amp;pSBInfo-&gt;<a class="code" href="../../d5/d5/structtagSBINFO.html#o1">Horz</a>;
00357             *lpposMin = pSBData-&gt;<a class="code" href="../../d4/d5/structtagSBDATA.html#o0">posMin</a>;
00358             *lpposMax = pSBData-&gt;<a class="code" href="../../d4/d5/structtagSBDATA.html#o1">posMax</a>;
00359         } <span class="keywordflow">else</span> {
00360             RIPERR0(ERROR_NO_SCROLLBARS, RIP_VERBOSE, <span class="stringliteral">""</span>);
00361             *lpposMin = 0;
00362             *lpposMax = 0;
00363         }
00364 
00365         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00366 
00367     <span class="keywordflow">default</span>:
00368         <span class="comment">/*</span>
00369 <span class="comment">         * Win3.1 validation layer code.</span>
00370 <span class="comment">         */</span>
00371         RIPERR0(ERROR_INVALID_PARAMETER, RIP_VERBOSE, <span class="stringliteral">""</span>);
00372         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00373     }
00374 }
00375 
00376 <span class="comment">/***************************************************************************\</span>
00377 <span class="comment">* GetScrollInfo</span>
00378 <span class="comment">*</span>
00379 <span class="comment">* !!! WARNING a similiar copy of this code is in server\winmgrc.c</span>
00380 <span class="comment">*</span>
00381 <span class="comment">\***************************************************************************/</span>
00382 
<a name="l00383"></a><a class="code" href="../../d3/d8/winmgrc_8c.html#a21">00383</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d8/winmgrc_8c.html#a21">GetScrollInfo</a>(
00384     HWND         hwnd,
00385     <span class="keywordtype">int</span>          code,
00386     LPSCROLLINFO lpsi)
00387 {
00388     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>    pwnd;
00389     <a class="code" href="../../d5/d5/structtagSBINFO.html">PSBINFO</a> pSBInfo;
00390     <a class="code" href="../../d4/d5/structtagSBDATA.html">PSBDATA</a> pSBData;
00391 
00392     <span class="keywordflow">if</span> (lpsi-&gt;cbSize != <span class="keyword">sizeof</span>(SCROLLINFO)) {
00393 
00394         <span class="keywordflow">if</span> (lpsi-&gt;cbSize != <span class="keyword">sizeof</span>(SCROLLINFO) - 4) {
00395             RIPMSG0(RIP_WARNING, <span class="stringliteral">"SCROLLINFO: Invalid cbSize"</span>);
00396             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00397 
00398         } <span class="keywordflow">else</span> {
00399             RIPMSG0(RIP_WARNING, <span class="stringliteral">"SCROLLINFO: Invalid cbSize"</span>);
00400         }
00401     }
00402 
00403     <span class="keywordflow">if</span> (lpsi-&gt;fMask &amp; ~SIF_MASK) {
00404         RIPMSG0(RIP_WARNING, <span class="stringliteral">"SCROLLINFO: Invalid fMask"</span>);
00405         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00406     }
00407 
00408     <span class="keywordflow">if</span> ((pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hwnd)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00409         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00410 
00411     <span class="keywordflow">switch</span> (code) {
00412     <span class="keywordflow">case</span> SB_CTL:
00413         <a class="code" href="../../d6/d0/usercli_8h.html#a600">SendMessageWorker</a>(pwnd, SBM_GETSCROLLINFO, 0, (LPARAM)lpsi, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00414         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00415 
00416     <span class="keywordflow">case</span> SB_HORZ:
00417     <span class="keywordflow">case</span> SB_VERT:
00418         <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o14">pSBInfo</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00419             RIPERR0(ERROR_NO_SCROLLBARS, RIP_VERBOSE, <span class="stringliteral">""</span>);
00420             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00421         }
00422 
00423         <span class="comment">/*</span>
00424 <span class="comment">         * Rebase rgwScroll so probing will work</span>
00425 <span class="comment">         */</span>
00426         pSBInfo = (<a class="code" href="../../d5/d5/structtagSBINFO.html">PSBINFO</a>)<a class="code" href="../../d6/d0/usercli_8h.html#a24">REBASEALWAYS</a>(pwnd, pSBInfo);
00427 
00428         pSBData = (code == SB_VERT) ? &amp;pSBInfo-&gt;<a class="code" href="../../d5/d5/structtagSBINFO.html#o2">Vert</a> : &amp;pSBInfo-&gt;<a class="code" href="../../d5/d5/structtagSBINFO.html#o1">Horz</a>;
00429 
00430         <span class="keywordflow">return</span>(<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a329">NtUserSBGetParms</a>(hwnd, code, pSBData, lpsi));
00431 
00432     <span class="keywordflow">default</span>:
00433         <span class="comment">/*</span>
00434 <span class="comment">         * Win3.1 validation layer code.</span>
00435 <span class="comment">         */</span>
00436         RIPERR0(ERROR_INVALID_PARAMETER, RIP_VERBOSE, <span class="stringliteral">""</span>);
00437         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00438     }
00439 }
00440 
00441 <span class="comment">/****************************************************************************\</span>
00442 <span class="comment">* _GetActiveWindow (API)</span>
00443 <span class="comment">*</span>
00444 <span class="comment">*</span>
00445 <span class="comment">* 23-Oct-1990 MikeHar   Ported from Windows.</span>
00446 <span class="comment">* 12-Nov-1990 DarrinM   Moved from getset.c to here.</span>
00447 <span class="comment">\****************************************************************************/</span>
00448 
<a name="l00449"></a><a class="code" href="../../d3/d8/winmgrc_8c.html#a22">00449</a> HWND <a class="code" href="../../d3/d8/winmgrc_8c.html#a22">GetActiveWindow</a>(VOID)
00450 {
00451     <span class="keywordflow">return</span> (HWND)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a287">NtUserGetThreadState</a>(UserThreadStateActiveWindow);
00452 }
00453 
00454 <span class="comment">/****************************************************************************\</span>
00455 <span class="comment">* GetCursor</span>
00456 <span class="comment">*</span>
00457 <span class="comment">*</span>
00458 <span class="comment">* History:</span>
00459 <span class="comment">\****************************************************************************/</span>
00460 
<a name="l00461"></a><a class="code" href="../../d3/d8/winmgrc_8c.html#a23">00461</a> HCURSOR <a class="code" href="../../d3/d8/winmgrc_8c.html#a23">GetCursor</a>(VOID)
00462 {
00463     <span class="keywordflow">return</span> (HCURSOR)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a287">NtUserGetThreadState</a>(UserThreadStateCursor);
00464 }
00465 
00466 <span class="comment">/***************************************************************************\</span>
00467 <span class="comment">* BOOL IsMenu(HMENU);</span>
00468 <span class="comment">*</span>
00469 <span class="comment">* Verifies that the handle passed in is a menu handle.</span>
00470 <span class="comment">*</span>
00471 <span class="comment">* Histroy:</span>
00472 <span class="comment">* 10-Jul-1992 MikeHar   Created.</span>
00473 <span class="comment">\***************************************************************************/</span>
00474 
<a name="l00475"></a><a class="code" href="../../d3/d8/winmgrc_8c.html#a24">00475</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d8/winmgrc_8c.html#a24">IsMenu</a>(
00476    HMENU hMenu)
00477 {
00478    <span class="keywordflow">if</span> (<a class="code" href="../../d6/d9/rtl_2wow_8c.html#a6">HMValidateHandle</a>(hMenu, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a238">TYPE_MENU</a>))
00479       <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00480 
00481    <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00482 }
00483 
00484 <span class="comment">/***************************************************************************\</span>
00485 <span class="comment">* GetAppCompatFlags</span>
00486 <span class="comment">*</span>
00487 <span class="comment">* Compatibility flags for &lt; Win 3.1 apps running on 3.1</span>
00488 <span class="comment">*</span>
00489 <span class="comment">* History:</span>
00490 <span class="comment">* 01-Apr-1992 ScottLu   Created.</span>
00491 <span class="comment">* 04-May-1992 DarrinM   Moved to USERRTL.DLL.</span>
00492 <span class="comment">\***************************************************************************/</span>
00493 
<a name="l00494"></a><a class="code" href="../../d1/d0/inc_2user_8h.html#a1173">00494</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d6/d3/queue_8c.html#a34">GetAppCompatFlags</a>(
00495     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti)
00496 {
00497     UNREFERENCED_PARAMETER(pti);
00498 
00499     <a class="code" href="../../d1/d0/inc_2user_8h.html#a848">ConnectIfNecessary</a>();
00500 
00501     <span class="keywordflow">return</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a16">GetClientInfo</a>()-&gt;dwCompatFlags;
00502 }
00503 
00504 <span class="comment">/***************************************************************************\</span>
00505 <span class="comment">* GetAppCompatFlags2</span>
00506 <span class="comment">*</span>
00507 <span class="comment">* Compatibility flags for &lt;= wVer apps.  Newer apps will get no hacks</span>
00508 <span class="comment">* from this DWORD.</span>
00509 <span class="comment">*</span>
00510 <span class="comment">* History:</span>
00511 <span class="comment">* 06-29-98 MCostea      Created.</span>
00512 <span class="comment">\***************************************************************************/</span>
00513 
<a name="l00514"></a><a class="code" href="../../d1/d0/inc_2user_8h.html#a1174">00514</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d6/d3/queue_8c.html#a35">GetAppCompatFlags2</a>(
00515     WORD wVer)
00516 {
00517     <a class="code" href="../../d1/d0/inc_2user_8h.html#a848">ConnectIfNecessary</a>();
00518     <span class="comment">/*</span>
00519 <span class="comment">     * Newer apps should behave, so they get no hacks</span>
00520 <span class="comment">     */</span>
00521     <span class="keywordflow">if</span> (wVer &lt; <a class="code" href="../../d6/d0/usercli_8h.html#a150">GETAPPVER</a>()) {
00522         <span class="keywordflow">return</span> 0;
00523     }
00524     <span class="keywordflow">return</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a16">GetClientInfo</a>()-&gt;dwCompatFlags2;
00525 }
00526 
00527 <span class="comment">/**************************************************************************\</span>
00528 <span class="comment">* IsWindowUnicode</span>
00529 <span class="comment">*</span>
00530 <span class="comment">* 25-Feb-1992 IanJa     Created</span>
00531 <span class="comment">\**************************************************************************/</span>
00532 
<a name="l00533"></a><a class="code" href="../../d3/d8/winmgrc_8c.html#a27">00533</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d8/winmgrc_8c.html#a27">IsWindowUnicode</a>(
00534     IN HWND hwnd)
00535 {
00536     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
00537 
00538 
00539     <span class="keywordflow">if</span> ((pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hwnd)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00540         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00541 
00542     <span class="keywordflow">return</span> !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a570">WFANSIPROC</a>);
00543 }
00544 
00545 <span class="comment">/**************************************************************************\</span>
00546 <span class="comment">* TestWindowProcess</span>
00547 <span class="comment">*</span>
00548 <span class="comment">* 14-Nov-1994 JimA      Created.</span>
00549 <span class="comment">\**************************************************************************/</span>
00550 
<a name="l00551"></a><a class="code" href="../../d1/d0/inc_2user_8h.html#a1172">00551</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a16">TestWindowProcess</a>(
00552     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
00553 {
00554     <span class="comment">/*</span>
00555 <span class="comment">     * If the threads are the same, don't bother going to the kernel</span>
00556 <span class="comment">     * to get the window's process id.</span>
00557 <span class="comment">     */</span>
00558     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd) == <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()) {
00559         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00560     }
00561 
00562     <span class="keywordflow">return</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a12">GetWindowProcess</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwnd)) == <a class="code" href="../../d6/d0/usercli_8h.html#a13">GETPROCESSID</a>());
00563 }
00564 
00565 <span class="comment">/**************************************************************************\</span>
00566 <span class="comment">* IsHungAppWindow</span>
00567 <span class="comment">*</span>
00568 <span class="comment">* 11-14-94 JimA         Created.</span>
00569 <span class="comment">\**************************************************************************/</span>
00570 
<a name="l00571"></a><a class="code" href="../../d3/d8/winmgrc_8c.html#a29">00571</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d8/winmgrc_8c.html#a29">IsHungAppWindow</a>(
00572     HWND hwnd)
00573 {
00574     <span class="keywordflow">return</span> (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a328">NtUserQueryWindow</a>(hwnd, WindowIsHung) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00575 }
00576 
00577 <span class="comment">/***************************************************************************\</span>
00578 <span class="comment">* PtiCurrent</span>
00579 <span class="comment">*</span>
00580 <span class="comment">* Returns the THREADINFO structure for the current thread.</span>
00581 <span class="comment">* LATER: Get DLL_THREAD_ATTACH initialization working right and we won't</span>
00582 <span class="comment">*        need this connect code.</span>
00583 <span class="comment">*</span>
00584 <span class="comment">* History:</span>
00585 <span class="comment">* 10-28-90 DavidPe      Created.</span>
00586 <span class="comment">\***************************************************************************/</span>
00587 
<a name="l00588"></a><a class="code" href="../../d3/d8/winmgrc_8c.html#a30">00588</a> <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>(VOID)
00589 {
00590     <a class="code" href="../../d1/d0/inc_2user_8h.html#a848">ConnectIfNecessary</a>();
00591     <span class="keywordflow">return</span> (<a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>)NtCurrentTebShared()-&gt;Win32ThreadInfo;
00592 }
00593 
00594 
00595 <span class="comment">/***************************************************************************\</span>
00596 <span class="comment">* _AdjustWindowRectEx (API)</span>
00597 <span class="comment">*</span>
00598 <span class="comment">*</span>
00599 <span class="comment">*</span>
00600 <span class="comment">* History:</span>
00601 <span class="comment">* 10-24-90 darrinm      Ported from Win 3.0.</span>
00602 <span class="comment">\***************************************************************************/</span>
00603 
<a name="l00604"></a><a class="code" href="../../d1/d0/inc_2user_8h.html#a1195">00604</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d1/d0/inc_2user_8h.html#a1195">_AdjustWindowRectEx</a>(
00605     LPRECT lprc,
00606     LONG style,
00607     BOOL fMenu,
00608     DWORD dwExStyle)
00609 {
00610     <span class="comment">//</span>
00611     <span class="comment">// Here we add on the appropriate 3D borders for old and new apps.</span>
00612     <span class="comment">//</span>
00613     <span class="comment">// Rules:</span>
00614     <span class="comment">//   (1) Do nothing for windows that have 3D border styles.</span>
00615     <span class="comment">//   (2) If the window has a dlgframe border (has a caption or is a</span>
00616     <span class="comment">//          a dialog), then add on the window edge style.</span>
00617     <span class="comment">//   (3) We NEVER add on the CLIENT STYLE.  New apps can create</span>
00618     <span class="comment">//          it if they want.  This is because it screws up alignment</span>
00619     <span class="comment">//          when the app doesn't know about it.</span>
00620     <span class="comment">//</span>
00621 
00622     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d8/rtl_2winmgr_8c.html#a9">NeedsWindowEdge</a>(style, dwExStyle, <a class="code" href="../../d6/d0/usercli_8h.html#a150">GETAPPVER</a>() &gt;= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a101">VER40</a>))
00623         dwExStyle |= WS_EX_WINDOWEDGE;
00624     <span class="keywordflow">else</span>
00625         dwExStyle &amp;= ~WS_EX_WINDOWEDGE;
00626 
00627     <span class="comment">//</span>
00628     <span class="comment">// Space for a menu bar</span>
00629     <span class="comment">//</span>
00630     <span class="keywordflow">if</span> (fMenu)
00631         lprc-&gt;top -= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYMENU);
00632 
00633     <span class="comment">//</span>
00634     <span class="comment">// Space for a caption bar</span>
00635     <span class="comment">//</span>
00636     <span class="keywordflow">if</span> ((HIWORD(style) &amp; HIWORD(WS_CAPTION)) == HIWORD(WS_CAPTION)) {
00637         lprc-&gt;top -= (dwExStyle &amp; WS_EX_TOOLWINDOW) ? <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYSMCAPTION) : <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYCAPTION);
00638     }
00639 
00640     <span class="comment">//</span>
00641     <span class="comment">// Space for borders (window AND client)</span>
00642     <span class="comment">//</span>
00643     {
00644         <span class="keywordtype">int</span> cBorders;
00645 
00646         <span class="comment">//</span>
00647         <span class="comment">// Window AND Client borders</span>
00648         <span class="comment">//</span>
00649 
00650         <span class="keywordflow">if</span> (cBorders = <a class="code" href="../../d2/d8/rtl_2winmgr_8c.html#a7">GetWindowBorders</a>(style, dwExStyle, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>))
00651             <a class="code" href="../../d3/d6/rect_8c.html#a7">InflateRect</a>(lprc, cBorders*<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXBORDER), cBorders*<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYBORDER));
00652     }
00653 
00654     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00655 }
00656 
00657 <span class="comment">/***************************************************************************\</span>
00658 <span class="comment">* ShowWindowNoRepaint</span>
00659 <span class="comment">\***************************************************************************/</span>
00660 
<a name="l00661"></a><a class="code" href="../../d3/d8/winmgrc_8c.html#a32">00661</a> <span class="keywordtype">void</span> <a class="code" href="../../d3/d8/winmgrc_8c.html#a32">ShowWindowNoRepaint</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
00662 {
00663     HWND hwnd = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwnd);
00664     <a class="code" href="../../d7/d0/structtagCLS.html">PCLS</a> pcls = <a class="code" href="../../d6/d0/usercli_8h.html#a26">REBASE</a>(pwnd, pcls);
00665     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a115">NtUserSetWindowPos</a>(hwnd, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, 0, 0, 0, SWP_NOMOVE |
00666             SWP_NOSIZE | SWP_NOZORDER | SWP_NOOWNERZORDER |
00667             SWP_NOREDRAW | SWP_SHOWWINDOW | SWP_NOACTIVATE |
00668             ((pcls-&gt;style &amp; CS_SAVEBITS) ? SWP_CREATESPB : 0));
00669 }
00670 
00671 <span class="comment">/***************************************************************************\</span>
00672 <span class="comment">* AnimateBlend</span>
00673 <span class="comment">*</span>
00674 <span class="comment">* 6-Mar-1997    vadimg      created</span>
00675 <span class="comment">\***************************************************************************/</span>
00676 
<a name="l00677"></a><a class="code" href="../../d3/d8/winmgrc_8c.html#a1">00677</a> <span class="preprocessor">#define ALPHASTART 40</span>
<a name="l00678"></a><a class="code" href="../../d3/d8/winmgrc_8c.html#a2">00678</a> <span class="preprocessor"></span><span class="preprocessor">#define ONEFRAME 10</span>
00679 <span class="preprocessor"></span>
<a name="l00680"></a><a class="code" href="../../d3/d8/winmgrc_8c.html#a33">00680</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d8/winmgrc_8c.html#a33">AnimateBlend</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, HDC hdcScreen, HDC hdcImage, DWORD dwTime, BOOL fHide)
00681 {
00682     HWND hwnd = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwnd);
00683     SIZE size;
00684     POINT ptSrc = {0, 0}, ptDst;
00685     BLENDFUNCTION blend;
00686     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwElapsed;
00687     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> bAlpha = <a class="code" href="../../d3/d8/winmgrc_8c.html#a1">ALPHASTART</a>;
00688     LARGE_INTEGER liFreq, liStart, liDiff;
00689     LARGE_INTEGER liIter;
00690     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwIter;
00691 
00692     <span class="keywordflow">if</span> (QueryPerformanceFrequency(&amp;liFreq) == 0)
00693         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00694 
00695     <span class="keywordflow">if</span> (SetWindowLong(hwnd, GWL_EXSTYLE, GetWindowLong(hwnd, GWL_EXSTYLE) |
00696             WS_EX_LAYERED) == 0)
00697         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00698 
00699     <span class="keywordflow">if</span> (fHide) {
00700         <span class="comment">/*</span>
00701 <span class="comment">         * Give up the time slice and sleep just a touch to allow windows</span>
00702 <span class="comment">         * below invalidated by the SetWindowLong(WS_EX_LAYERED) call to</span>
00703 <span class="comment">         * repaint enough for the sprite to get good background image.</span>
00704 <span class="comment">         */</span>
00705         Sleep(10);
00706     }
00707 
00708     ptDst.x = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left;
00709     ptDst.y = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.top;
00710     size.cx = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.right - pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left;
00711     size.cy = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.bottom - pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.top;
00712 
00713     blend.BlendOp     = AC_SRC_OVER;
00714     blend.BlendFlags  = 0;
00715     blend.AlphaFormat = 0;
00716     blend.SourceConstantAlpha = fHide ? (255 - bAlpha) : bAlpha;
00717 
00718     <span class="comment">/*</span>
00719 <span class="comment">     * Copy the initial image with the initial alpha.</span>
00720 <span class="comment">     */</span>
00721     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a406">NtUserUpdateLayeredWindow</a>(hwnd, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;ptDst, &amp;size, hdcImage, &amp;ptSrc, 0,
00722             &amp;blend, ULW_ALPHA);
00723 
00724     <span class="keywordflow">if</span> (!fHide) {
00725         <a class="code" href="../../d3/d8/winmgrc_8c.html#a32">ShowWindowNoRepaint</a>(pwnd);
00726     }
00727 
00728     <span class="comment">/*</span>
00729 <span class="comment">     * Time and start the animation cycle.</span>
00730 <span class="comment">     */</span>
00731     dwElapsed = (dwTime * <a class="code" href="../../d3/d8/winmgrc_8c.html#a1">ALPHASTART</a> + 255) / 255 + 10;
00732     QueryPerformanceCounter(&amp;liStart);
00733     liStart.QuadPart = liStart.QuadPart - dwElapsed * liFreq.QuadPart / 1000;
00734 
00735     <span class="keywordflow">while</span> (dwElapsed &lt; dwTime) {
00736 
00737         <span class="keywordflow">if</span> (fHide) {
00738             blend.SourceConstantAlpha = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)((255 * (dwTime - dwElapsed)) / dwTime);
00739         } <span class="keywordflow">else</span> {
00740             blend.SourceConstantAlpha = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)((255 * dwElapsed) / dwTime);
00741         }
00742 
00743         QueryPerformanceCounter(&amp;liIter);
00744 
00745         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a406">NtUserUpdateLayeredWindow</a>(hwnd, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0,
00746                 &amp;blend, ULW_ALPHA);
00747 
00748         QueryPerformanceCounter(&amp;liDiff);
00749 
00750         <span class="comment">/*</span>
00751 <span class="comment">         * Calculate how long in ms the previous frame took.</span>
00752 <span class="comment">         */</span>
00753         liIter.QuadPart = liDiff.QuadPart - liIter.QuadPart;
00754         dwIter = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)((liIter.QuadPart * 1000) / liFreq.QuadPart);
00755 
00756         <span class="keywordflow">if</span> (dwIter &lt; <a class="code" href="../../d3/d8/winmgrc_8c.html#a2">ONEFRAME</a>) {
00757             Sleep(<a class="code" href="../../d3/d8/winmgrc_8c.html#a2">ONEFRAME</a> - dwIter);
00758         }
00759 
00760         liDiff.QuadPart -= liStart.QuadPart;
00761         dwElapsed = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)((liDiff.QuadPart * 1000) / liFreq.QuadPart);
00762     }
00763 
00764     <span class="comment">/*</span>
00765 <span class="comment">     * Hide the window before removing the layered bit to make sure that</span>
00766 <span class="comment">     * the bits for the window are not left on the screen.</span>
00767 <span class="comment">     */</span>
00768     <span class="keywordflow">if</span> (fHide) {
00769         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a115">NtUserSetWindowPos</a>(hwnd, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, 0, 0, 0, SWP_HIDEWINDOW |
00770                 SWP_NOMOVE | SWP_NOSIZE | SWP_NOZORDER | SWP_NOACTIVATE);
00771     }
00772 
00773     SetWindowLong(hwnd, GWL_EXSTYLE, GetWindowLong(hwnd, GWL_EXSTYLE) &amp;
00774             ~WS_EX_LAYERED);
00775 
00776     <span class="keywordflow">if</span> (!fHide) {
00777         BitBlt(hdcScreen, 0, 0, size.cx, size.cy, hdcImage, 0, 0, SRCCOPY | NOMIRRORBITMAP);
00778     }
00779 
00780     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00781 }
00782 
00783 <span class="comment">/***************************************************************************\</span>
00784 <span class="comment">* AnimateWindow (API)</span>
00785 <span class="comment">*</span>
00786 <span class="comment">* Hide animations are done by updating a la full-drag.  Uses window's window</span>
00787 <span class="comment">* region to do some of the magic.</span>
00788 <span class="comment">*</span>
00789 <span class="comment">* We have to put in the CLIPCHILDREN hack to work around a bug with the</span>
00790 <span class="comment">* DC cache resetting attributes even if DCX_USESTYLE is not used whe</span>
00791 <span class="comment">* the DC cache is invalidated.</span>
00792 <span class="comment">*</span>
00793 <span class="comment">* History:</span>
00794 <span class="comment">* 9-Sep-1996    vadimg      created</span>
00795 <span class="comment">\***************************************************************************/</span>
00796 
<a name="l00797"></a><a class="code" href="../../d3/d8/winmgrc_8c.html#a3">00797</a> <span class="preprocessor">#define AW_HOR          (AW_HOR_POSITIVE | AW_HOR_NEGATIVE | AW_CENTER)</span>
<a name="l00798"></a><a class="code" href="../../d3/d8/winmgrc_8c.html#a4">00798</a> <span class="preprocessor"></span><span class="preprocessor">#define AW_VER          (AW_VER_POSITIVE | AW_VER_NEGATIVE | AW_CENTER)</span>
00799 <span class="preprocessor"></span>
<a name="l00800"></a><a class="code" href="../../d3/d8/winmgrc_8c.html#a34">00800</a> __inline <span class="keywordtype">int</span> <a class="code" href="../../d3/d8/winmgrc_8c.html#a34">AnimInc</a>(<span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y, <span class="keywordtype">int</span> z)
00801 {
00802     <span class="keywordflow">return</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a141">MultDiv</a>(x, y, z);
00803 }
00804 
<a name="l00805"></a><a class="code" href="../../d3/d8/winmgrc_8c.html#a35">00805</a> __inline <span class="keywordtype">int</span> <a class="code" href="../../d3/d8/winmgrc_8c.html#a35">AnimDec</a>(<span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y, <span class="keywordtype">int</span> z)
00806 {
00807     <span class="keywordflow">return</span> x - <a class="code" href="../../d3/d8/winmgrc_8c.html#a34">AnimInc</a>(x, y, z);
00808 }
00809 
<a name="l00810"></a><a class="code" href="../../d3/d8/winmgrc_8c.html#a36">00810</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d3/d8/winmgrc_8c.html#a36">AnimateWindow</a>(HWND hwnd, DWORD dwTime, DWORD dwFlags)
00811 {
00812     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00813     HDC hdc = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, hdcMem = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00814     HRGN hrgnUpdate = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, hrgnOld = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, hrgnWin;
00815     HBITMAP hbmMem = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, hbmOld;
00816     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fHide = <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; AW_HIDE, fRet = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, fSlide = <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; AW_SLIDE;
00817     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fRemoveClipChildren = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00818     <span class="keywordtype">int</span> x, y, nx, ny, cx, <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>, ix, iy, ixLast, iyLast, xLast, yLast, xWin, yWin;
00819     <span class="keywordtype">int</span> xReal, yReal, xMem, yMem;
00820     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwStart, dwElapsed;
00821     RECT rcOld, rcNew, rcWin;
00822     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hwnd);
00823     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uBounds;
00824     RECT rcBounds;
00825 <span class="preprocessor">#ifdef USE_MIRRORING</span>
00826 <span class="preprocessor"></span>    <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwOldlayout = GDI_ERROR;
00827 <span class="preprocessor">#endif</span>
00828 <span class="preprocessor"></span>
00829     <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00830         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00831 
00832     <span class="comment">/*</span>
00833 <span class="comment">     * Nothing to do or the flags didn't validate. Send the jerk to hell.</span>
00834 <span class="comment">     */</span>
00835     <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; ~AW_VALID) != 0 || (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; (AW_HOR_POSITIVE |
00836             AW_HOR_NEGATIVE | AW_CENTER | AW_VER_POSITIVE |
00837             AW_VER_NEGATIVE | AW_BLEND)) == 0)
00838         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00839 
00840     <span class="keywordflow">if</span> (!(<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; AW_BLEND)) {
00841         <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o19">hrgnClip</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00842             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00843         }
00844     }
00845 
00846     <span class="comment">/*</span>
00847 <span class="comment">     * If already hidden and tring to hide, just bail out of here.</span>
00848 <span class="comment">     * (or already shown and trying to show...)</span>
00849 <span class="comment">     */</span>
00850     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d9/client_2wow_8c.html#a21">IsWindowVisible</a>(hwnd)) {
00851         <span class="keywordflow">if</span> (fHide) {
00852             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00853         }
00854     } <span class="keywordflow">else</span> {
00855         <span class="keywordflow">if</span> (!fHide) {
00856             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00857         }
00858     }
00859 
00860 
00861     <span class="keywordflow">if</span> ((hdc = <a class="code" href="../../d6/d0/usercli_8h.html#a237">GetDCEx</a>(hwnd, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, DCX_WINDOW | DCX_USESTYLE |
00862             DCX_CACHE)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00863         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00864     }
00865 
00866     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a649">WFCLIPCHILDREN</a>)) {
00867         fRemoveClipChildren = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00868         <a class="code" href="../../d4/d1/userk_8h.html#a1629">ClearWindowState</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a649">WFCLIPCHILDREN</a>);
00869     }
00870 
00871     <span class="comment">/*</span>
00872 <span class="comment">     * Precreate regions used for calculating paint updates.</span>
00873 <span class="comment">     */</span>
00874     <span class="keywordflow">if</span> (fHide) {
00875         <span class="keywordflow">if</span> ((hrgnUpdate = CreateRectRgn(0, 0, 0, 0)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00876             <span class="keywordflow">goto</span> Cleanup;
00877         }
00878         <span class="keywordflow">if</span> ((hrgnOld = CreateRectRgn(0, 0, 0, 0)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00879             <span class="keywordflow">goto</span> Cleanup;
00880         }
00881     }
00882 
00883     rcWin = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>;
00884     cx = rcWin.right - rcWin.left;
00885     <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> = rcWin.bottom - rcWin.top;
00886 
00887     <span class="comment">/*</span>
00888 <span class="comment">     * Set up the offscreen dc.</span>
00889 <span class="comment">     */</span>
00890     <span class="keywordflow">if</span> ((hbmMem = CreateCompatibleBitmap(hdc, cx, <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> | CCB_NOVIDEOMEMORY)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00891         <span class="keywordflow">goto</span> Cleanup;
00892     }
00893     <span class="keywordflow">if</span> ((hdcMem = CreateCompatibleDC(hdc)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00894         <span class="keywordflow">goto</span> Cleanup;
00895     }
00896 <span class="preprocessor">#ifdef USE_MIRRORING</span>
00897 <span class="preprocessor"></span>    <span class="comment">/*</span>
00898 <span class="comment">     * Turn off Mirroring.</span>
00899 <span class="comment">     */</span>
00900     dwOldlayout = SetLayout(hdcMem, 0);
00901 <span class="preprocessor">#endif</span>
00902 <span class="preprocessor"></span>    hbmOld = SelectBitmap(hdcMem, hbmMem);
00903 
00904     <span class="keywordflow">if</span> (!(<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; AW_BLEND)) {
00905         <span class="comment">/*</span>
00906 <span class="comment">         * Set window region to nothing, so that if the window draws during</span>
00907 <span class="comment">         * callbacks in WM_PRINT, it doesn't happen on screen.</span>
00908 <span class="comment">         */</span>
00909         <span class="keywordflow">if</span> ((hrgnWin = CreateRectRgn(0, 0, 0, 0)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00910             <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a22">SetWindowRgn</a>(hwnd, hrgnWin, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00911         }
00912 
00913         <span class="keywordflow">if</span> (!fHide) {
00914             <a class="code" href="../../d3/d8/winmgrc_8c.html#a32">ShowWindowNoRepaint</a>(pwnd);
00915         }
00916     }
00917 
00918     SetBoundsRect(hdcMem, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, DCB_RESET | DCB_ENABLE);
00919 
00920     <span class="comment">/*</span>
00921 <span class="comment">     * Get the actual image. The windows participating here must implement</span>
00922 <span class="comment">     * WM_PRINTCLIENT or they will look ugly.</span>
00923 <span class="comment">     */</span>
00924     <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(hwnd, WM_PRINT, (WPARAM)hdcMem, PRF_CLIENT | PRF_NONCLIENT |
00925             PRF_CHILDREN | PRF_ERASEBKGND);
00926 
00927     <span class="comment">/*</span>
00928 <span class="comment">     * If the window changes size during callbacks, like RAID does with combo</span>
00929 <span class="comment">     * boxes by resizing them on WM_CTLCOLOR from WM_ERASEBKGND, send WM_PRINT</span>
00930 <span class="comment">     * again to get the correctly sized image.</span>
00931 <span class="comment">     */</span>
00932     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a34">EqualRect</a>(&amp;rcWin, &amp;pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>)) {
00933         rcWin = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>;
00934         cx = rcWin.right - rcWin.left;
00935         <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> = rcWin.bottom - rcWin.top;
00936 
00937         SelectObject(hdcMem, hbmOld);
00938         DeleteObject(hbmMem);
00939 
00940         <span class="keywordflow">if</span> ((hbmMem = CreateCompatibleBitmap(hdc, cx, <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00941             <span class="keywordflow">goto</span> Cleanup;
00942         }
00943 
00944         SelectObject(hdcMem, hbmMem);
00945         <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(hwnd, WM_PRINT, (WPARAM)hdcMem, PRF_CLIENT |
00946                  PRF_NONCLIENT | PRF_CHILDREN | PRF_ERASEBKGND);
00947     }
00948 
00949     <span class="comment">/*</span>
00950 <span class="comment">     * Check to see if the app painted in our DC.  If not, do not animate the window</span>
00951 <span class="comment">     * SetBoundsRect() was called prior to SendMessage(WM_PRINT) for the hdcMem</span>
00952 <span class="comment">     * and in xxxLBPaint() (to fix bug#83743)</span>
00953 <span class="comment">     */</span>
00954     uBounds = GetBoundsRect(hdcMem, &amp;rcBounds, 0);
00955     <span class="keywordflow">if</span> ((uBounds &amp; DCB_RESET) &amp;&amp; (!(uBounds &amp; DCB_ACCUMULATE))) {
00956         <span class="keywordflow">if</span> (fHide) {
00957             <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a237">NtUserShowWindow</a>(hwnd, SW_HIDE);
00958         } <span class="keywordflow">else</span> {
00959             <a class="code" href="../../d6/d0/usercli_8h.html#a239">RedrawWindow</a>(hwnd, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, RDW_INVALIDATE | RDW_ERASE | RDW_FRAME |
00960                          RDW_ALLCHILDREN);
00961         }
00962         <span class="keywordflow">goto</span> Cleanup;
00963     }
00964 
00965     <span class="keywordflow">if</span> (dwTime == 0) {
00966         dwTime = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a916">CMS_QANIMATION</a>;
00967     }
00968     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; AW_BLEND) {
00969         fRet = <a class="code" href="../../d3/d8/winmgrc_8c.html#a33">AnimateBlend</a>(pwnd, hdc, hdcMem, dwTime, fHide);
00970         <span class="keywordflow">goto</span> ShowActivate;
00971     }
00972 
00973     xWin = rcWin.left;
00974     yWin = rcWin.top;
00975 
00976     ix = iy = xLast = yLast = 0;
00977     ixLast = cx;
00978     iyLast = <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>;
00979 
00980     <span class="comment">/*</span>
00981 <span class="comment">     * Calculate initial coordinates and multiples. x, y are the starting points</span>
00982 <span class="comment">     * for xReal, yReal calcs, nx, and ny are the directional multiples.</span>
00983 <span class="comment">     */</span>
00984     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; AW_CENTER) {
00985         x = cx / 2;
00986         nx = -1;
00987         fSlide = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00988     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; AW_HOR_POSITIVE) {
00989         x = fHide ? cx : 0;
00990         nx = fHide ? -1 : 0;
00991     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; AW_HOR_NEGATIVE) {
00992         x = fHide ? 0 : cx;
00993         nx = fHide ? 0 : -1;
00994     } <span class="keywordflow">else</span> {
00995         x = 0;
00996         nx = 0;
00997         ix = cx;
00998     }
00999 
01000     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; AW_CENTER) {
01001         y = <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> / 2;
01002         ny = -1;
01003     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; AW_VER_POSITIVE) {
01004         y = fHide ? <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> : 0;
01005         ny = fHide ? -1 : 0;
01006     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; AW_VER_NEGATIVE) {
01007         y = fHide ? 0 : <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>;
01008         ny = fHide ? 0 : -1;
01009     } <span class="keywordflow">else</span> {
01010         y = 0;
01011         ny = 0;
01012         iy = <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>;
01013     }
01014 
01015     dwStart = GetTickCount();
01016 
01017     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01018 
01019         dwElapsed = GetTickCount() - dwStart;
01020 
01021         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; <a class="code" href="../../d3/d8/winmgrc_8c.html#a3">AW_HOR</a>) {
01022             <span class="keywordflow">if</span> (fHide) {
01023                 ix = <a class="code" href="../../d3/d8/winmgrc_8c.html#a35">AnimDec</a>(cx, dwElapsed, dwTime);
01024             } <span class="keywordflow">else</span> {
01025                 ix = <a class="code" href="../../d3/d8/winmgrc_8c.html#a34">AnimInc</a>(cx, dwElapsed, dwTime);
01026             }
01027         }
01028 
01029         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; <a class="code" href="../../d3/d8/winmgrc_8c.html#a4">AW_VER</a>) {
01030             <span class="keywordflow">if</span> (fHide) {
01031                 iy = <a class="code" href="../../d3/d8/winmgrc_8c.html#a35">AnimDec</a>(<a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>, dwElapsed, dwTime);
01032             } <span class="keywordflow">else</span> {
01033                 iy = <a class="code" href="../../d3/d8/winmgrc_8c.html#a34">AnimInc</a>(<a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>, dwElapsed, dwTime);
01034             }
01035         }
01036 
01037         <span class="comment">/*</span>
01038 <span class="comment">         * Terminate when we are out of time or we're hiding and either</span>
01039 <span class="comment">         * dimenion has reached zero (i.e. the window is not visible) or</span>
01040 <span class="comment">         * we're showing and the window is completely visible.</span>
01041 <span class="comment">         */</span>
01042         <span class="keywordflow">if</span> (dwElapsed &gt; dwTime ||
01043                 (fHide &amp;&amp; (ix == 0 || iy == 0)) ||
01044                 (!fHide &amp;&amp; (ix == cx &amp;&amp; iy == <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>))) {
01045             <span class="keywordflow">break</span>;
01046         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ixLast == ix &amp;&amp; iyLast == iy) {
01047             Sleep(1);
01048         } <span class="keywordflow">else</span> {
01049             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; AW_CENTER) {
01050                 xReal = x + nx * (ix / 2);
01051                 yReal = y + ny * (iy / 2);
01052             } <span class="keywordflow">else</span> {
01053                 xReal = x + nx * ix;
01054                 yReal = y + ny * iy;
01055             }
01056 
01057             <span class="comment">/*</span>
01058 <span class="comment">             * Calculate new window area and set as the window rgn.</span>
01059 <span class="comment">             */</span>
01060             rcNew.left = xReal;
01061             rcNew.top = yReal;
01062             rcNew.right = rcNew.left + ix;
01063             rcNew.bottom = rcNew.top + iy;
01064 
01065             <span class="comment">/*</span>
01066 <span class="comment">             * Change the window region accordingly to the new rect to make</span>
01067 <span class="comment">             * sure that everything underneath paints properly.  If a region</span>
01068 <span class="comment">             * was selected in before, it will be destroyed in SetWindowRgn.</span>
01069 <span class="comment">             */</span>
01070             <span class="keywordflow">if</span> ((hrgnWin = CreateRectRgnIndirect(&amp;rcNew)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01071                 <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a22">SetWindowRgn</a>(hwnd, hrgnWin, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01072             }
01073 
01074             <span class="keywordflow">if</span> (fHide) {
01075                 <span class="comment">/*</span>
01076 <span class="comment">                 * Calculate the smallest possible update region.</span>
01077 <span class="comment">                 */</span>
01078                 rcOld.left = xLast;
01079                 rcOld.top = yLast;
01080                 rcOld.right = rcOld.left + ixLast;
01081                 rcOld.bottom = rcOld.top + iyLast;
01082 
01083                 SetRectRgn(hrgnOld, rcOld.left, rcOld.top, rcOld.right, rcOld.bottom);
01084                 SetRectRgn(hrgnUpdate, rcNew.left, rcNew.top, rcNew.right, rcNew.bottom);
01085                 CombineRgn(hrgnUpdate, hrgnOld, hrgnUpdate, RGN_DIFF);
01086 
01087                 OffsetRgn(hrgnUpdate, xWin, yWin);
01088                 <a class="code" href="../../d6/d0/usercli_8h.html#a239">RedrawWindow</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, hrgnUpdate, RDW_INVALIDATE | RDW_ERASE | RDW_FRAME |
01089                         RDW_ALLCHILDREN);
01090                 <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a179">NtUserCallHwndParamLock</a>(hwnd, (ULONG_PTR)hrgnUpdate, SFI_XXXUPDATEWINDOWS);
01091             }
01092 
01093             xMem = xReal;
01094             yMem = yReal;
01095 
01096             <span class="keywordflow">if</span> (fSlide) {
01097                 <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; AW_HOR_POSITIVE) {
01098                     xMem = fHide ? 0: cx - ix;
01099                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; AW_HOR_NEGATIVE) {
01100                     xMem = fHide ? cx - ix : 0;
01101                 }
01102                 <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; AW_VER_POSITIVE) {
01103                     yMem = fHide ? 0 : <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> - iy;
01104                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; AW_VER_NEGATIVE) {
01105                     yMem = fHide ? <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> - iy : 0;
01106                 }
01107             }
01108 
01109             BitBlt(hdc, xReal, yReal, ix, iy, hdcMem, xMem, yMem, SRCCOPY | NOMIRRORBITMAP);
01110 
01111             xLast = xReal;
01112             yLast = yReal;
01113             ixLast = ix;
01114             iyLast = iy;
01115         }
01116     }
01117 
01118     fRet = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01119 
01120     <span class="comment">/*</span>
01121 <span class="comment">     * One last update to make sure that everything is repainted properly.</span>
01122 <span class="comment">     */</span>
01123     <span class="keywordflow">if</span> (fHide) {
01124         <span class="keywordflow">if</span> (fRemoveClipChildren) {
01125             <a class="code" href="../../d4/d1/userk_8h.html#a1628">SetWindowState</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a649">WFCLIPCHILDREN</a>);
01126             fRemoveClipChildren = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01127         }
01128         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a115">NtUserSetWindowPos</a>(hwnd, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, 0, 0, 0, SWP_NOMOVE |
01129                 SWP_NOSIZE | SWP_NOZORDER | SWP_NOOWNERZORDER |
01130                 SWP_NOREDRAW | SWP_HIDEWINDOW |
01131                 (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; AW_ACTIVATE ? 0 : SWP_NOACTIVATE));
01132 
01133         <span class="comment">/*</span>
01134 <span class="comment">         * This way we won't get a flash, which we would if we allowed to draw</span>
01135 <span class="comment">         * in the call above.</span>
01136 <span class="comment">         */</span>
01137         <span class="keywordflow">if</span> (ixLast != 0 &amp;&amp; iyLast != 0) {
01138             rcWin.left = xLast + xWin;
01139             rcWin.top = yLast + yWin;
01140             rcWin.right = rcWin.left + ixLast;
01141             rcWin.bottom = rcWin.top + iyLast;
01142             SetRectRgn(hrgnUpdate, rcWin.left, rcWin.top, rcWin.right, rcWin.bottom);
01143             <a class="code" href="../../d6/d0/usercli_8h.html#a239">RedrawWindow</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, hrgnUpdate, RDW_INVALIDATE | RDW_ALLCHILDREN | RDW_ERASE |
01144                          RDW_FRAME);
01145             <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a179">NtUserCallHwndParamLock</a>(hwnd, (ULONG_PTR)hrgnUpdate, SFI_XXXUPDATEWINDOWS);
01146         }
01147     } <span class="keywordflow">else</span> {
01148         <span class="keywordflow">if</span> (ixLast != cx || iyLast != <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>) {
01149             <span class="keywordflow">if</span> ((hrgnWin = CreateRectRgn(0, 0, cx, <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01150                 <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a22">SetWindowRgn</a>(hwnd, hrgnWin, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01151             }
01152             BitBlt(hdc, 0, 0, cx, <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>, hdcMem, 0, 0, SRCCOPY | NOMIRRORBITMAP);
01153         }
01154         <span class="keywordflow">if</span> (fRemoveClipChildren) {
01155             <a class="code" href="../../d4/d1/userk_8h.html#a1628">SetWindowState</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a649">WFCLIPCHILDREN</a>);
01156             fRemoveClipChildren = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01157         }
01158 
01159 ShowActivate:
01160         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; AW_ACTIVATE) {
01161             <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a115">NtUserSetWindowPos</a>(hwnd, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, 0, 0, 0, SWP_NOMOVE |
01162                     SWP_NOSIZE | SWP_NOZORDER | SWP_NOOWNERZORDER);
01163         }
01164     }
01165 
01166 Cleanup:
01167     <span class="keywordflow">if</span> (fRemoveClipChildren) {
01168         <a class="code" href="../../d4/d1/userk_8h.html#a1628">SetWindowState</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a649">WFCLIPCHILDREN</a>);
01169     }
01170     <span class="keywordflow">if</span> (hdcMem != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01171 <span class="preprocessor">#ifdef USE_MIRRORING</span>
01172 <span class="preprocessor"></span>        <span class="comment">/*</span>
01173 <span class="comment">         * Restore old layout value.</span>
01174 <span class="comment">         */</span>
01175         <span class="keywordflow">if</span> (dwOldlayout != GDI_ERROR)
01176             SetLayout(hdcMem, dwOldlayout);
01177 <span class="preprocessor">#endif</span>
01178 <span class="preprocessor"></span>        DeleteDC(hdcMem);
01179     }
01180     <span class="keywordflow">if</span> (hbmMem != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01181         DeleteObject(hbmMem);
01182     }
01183     <span class="keywordflow">if</span> (hdc != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01184         <a class="code" href="../../d3/d8/client_8c.html#a45">ReleaseDC</a>(hwnd, hdc);
01185     }
01186     <span class="keywordflow">if</span> (fHide) {
01187         <span class="keywordflow">if</span> (hrgnUpdate != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01188             DeleteObject(hrgnUpdate);
01189         }
01190         <span class="keywordflow">if</span> (hrgnOld != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01191             DeleteObject(hrgnOld);
01192         }
01193     }
01194     <span class="keywordflow">if</span> (!(<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; AW_BLEND)) {
01195         <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a22">SetWindowRgn</a>(hwnd, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01196     }
01197     <span class="keywordflow">return</span> fRet;
01198 }
01199 
01200 <span class="comment">/***************************************************************************\</span>
01201 <span class="comment">* SmoothScrollWindowEx</span>
01202 <span class="comment">*</span>
01203 <span class="comment">* History:</span>
01204 <span class="comment">* 24-Sep-1996   vadimg      wrote</span>
01205 <span class="comment">\***************************************************************************/</span>
01206 
<a name="l01207"></a><a class="code" href="../../d3/d8/winmgrc_8c.html#a5">01207</a> <span class="preprocessor">#define MINSCROLL 10</span>
<a name="l01208"></a><a class="code" href="../../d3/d8/winmgrc_8c.html#a6">01208</a> <span class="preprocessor"></span><span class="preprocessor">#define MAXSCROLLTIME 200</span>
01209 <span class="preprocessor"></span>
<a name="l01210"></a><a class="code" href="../../d3/d8/winmgrc_8c.html#a37">01210</a> <span class="keywordtype">int</span> <a class="code" href="../../d3/d8/winmgrc_8c.html#a37">SmoothScrollWindowEx</a>(HWND hwnd, <span class="keywordtype">int</span> dx, <span class="keywordtype">int</span> dy, CONST RECT *prcScroll,
01211         CONST RECT *prcClip, HRGN hrgnUpdate, LPRECT prcUpdate, DWORD dwFlags,
01212         DWORD dwTime)
01213 {
01214     RECT rc, rcT, rcUpdate;
01215     <span class="keywordtype">int</span> dxStep, dyStep, dxDone, dyDone, xSrc, ySrc, xDst, yDst, dxBlt, dyBlt;
01216     <span class="keywordtype">int</span> nRet = ERROR, nClip;
01217     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fNegX = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, fNegY = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01218     HDC hdc, hdcMem = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01219     HBITMAP hbmMem = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, hbmOld;
01220     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwSleep;
01221     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fCalcSubscroll = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01222     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hwnd);
01223     HRGN hrgnScroll = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, hrgnErase = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01224     MSG <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>;
01225     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uBounds;
01226     RECT rcBounds;
01227 
01228     <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01229         <span class="keywordflow">return</span> ERROR;
01230     <span class="comment">/*</span>
01231 <span class="comment">     * Keep track of the signs so we don't have to mess with abs all the time.</span>
01232 <span class="comment">     */</span>
01233     <span class="keywordflow">if</span> (dx &lt; 0) {
01234         fNegX = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01235         dx = -dx;
01236     }
01237 
01238     <span class="keywordflow">if</span> (dy &lt; 0) {
01239         fNegY = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01240         dy = -dy;
01241     }
01242 
01243     <span class="comment">/*</span>
01244 <span class="comment">     * Set up the client rectangle.</span>
01245 <span class="comment">     */</span>
01246     <span class="keywordflow">if</span> (prcScroll != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01247         rc = *prcScroll;
01248     } <span class="keywordflow">else</span> {
01249         rc.left = rc.top = 0;
01250         rc.right = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.right - pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.left;
01251         rc.bottom = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.bottom - pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.top;
01252     }
01253 
01254     <span class="comment">/*</span>
01255 <span class="comment">     * If they want to scroll less than we can let them, or more than</span>
01256 <span class="comment">     * one page, or need repainting send them to the API.</span>
01257 <span class="comment">     */</span>
01258     <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || (dx == 0 &amp;&amp; dy == 0) ||
01259         (dx != 0 &amp;&amp; dx &gt; rc.right) ||
01260         (dy != 0 &amp;&amp; dy &gt; rc.bottom)) {
01261         <span class="keywordflow">return</span> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a219">NtUserScrollWindowEx</a>(hwnd, fNegX ? -dx : dx, fNegY ? -dy : dy,
01262                 prcScroll, prcClip, hrgnUpdate, prcUpdate,
01263                 <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> | SW_ERASE | SW_INVALIDATE);
01264     }
01265 
01266     <span class="keywordflow">if</span> ((hdc = <a class="code" href="../../d6/d0/usercli_8h.html#a237">GetDCEx</a>(hwnd, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, DCX_USESTYLE | DCX_CACHE)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01267         <span class="keywordflow">return</span> ERROR;
01268     }
01269 
01270     <span class="comment">/*</span>
01271 <span class="comment">     * Part of the window may be obscured, which means that more may be</span>
01272 <span class="comment">     * invisible and may need to be bltted. Take that into account by</span>
01273 <span class="comment">     * gettting the clip box.</span>
01274 <span class="comment">     */</span>
01275     nClip = GetClipBox(hdc, &amp;rcT);
01276     <span class="keywordflow">if</span> (nClip == ERROR || nClip == NULLREGION) {
01277         <span class="keywordflow">goto</span> Cleanup;
01278     }
01279 
01280     <span class="comment">/*</span>
01281 <span class="comment">     * Set up the offscreen dc and send WM_PRINT to get the image.</span>
01282 <span class="comment">     */</span>
01283     <span class="keywordflow">if</span> ((hbmMem = CreateCompatibleBitmap(hdc, rc.right, rc.bottom)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01284         <span class="keywordflow">goto</span> Cleanup;
01285     }
01286     <span class="keywordflow">if</span> ((hdcMem = CreateCompatibleDC(hdc)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01287         <span class="keywordflow">goto</span> Cleanup;
01288     }
01289     hbmOld = SelectBitmap(hdcMem, hbmMem);
01290 
01291     SetBoundsRect(hdcMem, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, DCB_RESET | DCB_ENABLE);
01292 
01293     <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(hwnd, WM_PRINT, (WPARAM)hdcMem, PRF_CLIENT |
01294             PRF_ERASEBKGND | ((<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; SW_SCROLLCHILDREN) ? PRF_CHILDREN : 0));
01295 
01296     <span class="comment">/*</span>
01297 <span class="comment">     * If the client rect changes during the callback, send WM_PRINT</span>
01298 <span class="comment">     * again to get the correctly sized image.</span>
01299 <span class="comment">     */</span>
01300     <span class="keywordflow">if</span> (prcScroll == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01301         rcT.left = rcT.top = 0;
01302         rcT.right = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.right - pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.left;
01303         rcT.bottom = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.bottom - pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.top;
01304 
01305         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a34">EqualRect</a>(&amp;rc, &amp;rcT)) {
01306             rc = rcT;
01307 
01308             SelectObject(hdcMem, hbmOld);
01309             DeleteObject(hbmMem);
01310 
01311             <span class="keywordflow">if</span> ((hbmMem = CreateCompatibleBitmap(hdc, rc.right, rc.bottom)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01312                 <span class="keywordflow">goto</span> Cleanup;
01313             }
01314 
01315             SelectObject(hdcMem, hbmMem);
01316             <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(hwnd, WM_PRINT, (WPARAM)hdcMem, PRF_CLIENT |
01317                     PRF_ERASEBKGND | ((<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; SW_SCROLLCHILDREN) ? PRF_CHILDREN : 0));
01318         }
01319     }
01320 
01321     <span class="comment">/*</span>
01322 <span class="comment">     * Check to see if the app painted in our DC.</span>
01323 <span class="comment">     */</span>
01324     uBounds = GetBoundsRect(hdcMem, &amp;rcBounds, 0);
01325     <span class="keywordflow">if</span> ((uBounds &amp; DCB_RESET) &amp;&amp; (!(uBounds &amp; DCB_ACCUMULATE))) {
01326         <span class="keywordflow">goto</span> Cleanup;
01327     }
01328 
01329     <span class="keywordflow">if</span> ((hrgnScroll = CreateRectRgn(0, 0, 0, 0)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01330         <span class="keywordflow">goto</span> Cleanup;
01331     }
01332     <span class="keywordflow">if</span> ((hrgnErase = CreateRectRgn(0, 0, 0, 0)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01333         <span class="keywordflow">goto</span> Cleanup;
01334     }
01335     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a35">SetRectEmpty</a>(&amp;rcUpdate);
01336 
01337     <span class="comment">/*</span>
01338 <span class="comment">     * Start off with MINSCROLL and adjust it based on available time after</span>
01339 <span class="comment">     * the first iteration. We should consider adding a NOTIMELIMIT flag.</span>
01340 <span class="comment">     */</span>
01341     xDst = xSrc = 0;
01342     yDst = ySrc = 0;
01343 
01344     dxBlt = rc.right;
01345     dyBlt = rc.bottom;
01346 
01347     <span class="keywordflow">if</span> (dx == 0) {
01348         dxDone = rc.right;
01349         dxStep = 0;
01350     } <span class="keywordflow">else</span> {
01351         dxDone = 0;
01352         dxStep = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(dx / <a class="code" href="../../d3/d8/winmgrc_8c.html#a5">MINSCROLL</a>, 1);
01353     }
01354 
01355     <span class="keywordflow">if</span> (dy == 0) {
01356         dyDone = rc.bottom;
01357         dyStep = 0;
01358     } <span class="keywordflow">else</span> {
01359         dyDone = 0;
01360         dyStep = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(dy / <a class="code" href="../../d3/d8/winmgrc_8c.html#a5">MINSCROLL</a>, 1);
01361     }
01362 
01363     <span class="keywordflow">if</span> (dwTime == 0) {
01364         dwTime = <a class="code" href="../../d3/d8/winmgrc_8c.html#a6">MAXSCROLLTIME</a>;
01365     }
01366     dwSleep = dwTime / <a class="code" href="../../d3/d8/winmgrc_8c.html#a5">MINSCROLL</a>;
01367 
01368     <span class="keywordflow">do</span> {
01369 
01370         <span class="comment">/*</span>
01371 <span class="comment">         * When the dc is scrolled, the part that's revealed cannot be</span>
01372 <span class="comment">         * updated properly. We set up the variables to blt just the part that</span>
01373 <span class="comment">         * was just uncovered.</span>
01374 <span class="comment">         */</span>
01375         <span class="keywordflow">if</span> (dx != 0) {
01376             <span class="keywordflow">if</span> (dxDone + dxStep &gt; dx) {
01377                 dxStep = dx - dxDone;
01378             }
01379             dxDone += dxStep;
01380 
01381             xDst = dx - dxDone;
01382             dxBlt = rc.right - xDst;
01383             <span class="keywordflow">if</span> (!fNegX) {
01384                 xSrc = xDst;
01385                 xDst = 0;
01386             }
01387         }
01388 
01389         <span class="keywordflow">if</span> (dy != 0) {
01390             <span class="keywordflow">if</span> (dyDone + dyStep &gt; dy) {
01391                 dyStep = dy - dyDone;
01392             }
01393             dyDone += dyStep;
01394 
01395             yDst = dy - dyDone;
01396             dyBlt = rc.bottom - yDst;
01397             <span class="keywordflow">if</span> (!fNegY) {
01398                 ySrc = yDst;
01399                 yDst = 0;
01400             }
01401         }
01402 
01403         <span class="comment">/*</span>
01404 <span class="comment">         * This is a hack for ReaderMode to be smoothly continuous. We'll make an</span>
01405 <span class="comment">         * attempt for the scrolling to take as close to dwTime</span>
01406 <span class="comment">         * as possible. We'll also dispatch MOUSEMOVEs to the ReaderMode window, so it</span>
01407 <span class="comment">         * can update mouse cursor.</span>
01408 <span class="comment">         */</span>
01409         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/client_8c.html#a57">MsgWaitForMultipleObjects</a>(0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, dwSleep, QS_MOUSEMOVE) == WAIT_OBJECT_0) {
01410             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d9/cltxt_8h.html#a14">PeekMessage</a>(&amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, WM_MOUSEMOVE, WM_MOUSEMOVE, MAKELONG(PM_NOREMOVE, QS_INPUT))) {
01411                 <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndPeek = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.hwnd);
01412                 <span class="keywordflow">if</span> (pwndPeek != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01413                     <a class="code" href="../../d7/d0/structtagCLS.html">PCLS</a> pcls = (<a class="code" href="../../d7/d0/structtagCLS.html">PCLS</a>)<a class="code" href="../../d6/d0/usercli_8h.html#a24">REBASEALWAYS</a>(pwndPeek, pcls);
01414                     <span class="keywordflow">if</span> (pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o1">atomClassName</a> == <a class="code" href="../../d8/d6/ntuser_2client_2globals_8h.html#a32">gatomReaderMode</a>) {
01415                         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d9/cltxt_8h.html#a14">PeekMessage</a>(&amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.hwnd, WM_MOUSEMOVE, WM_MOUSEMOVE, MAKELONG(PM_REMOVE, QS_INPUT))) {
01416                             <a class="code" href="../../d5/d9/cltxt_8h.html#a24">DispatchMessage</a>(&amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>);
01417                         }
01418                     }
01419                 }
01420             }
01421         }
01422 
01423         <span class="keywordflow">if</span> ((nRet = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a219">NtUserScrollWindowEx</a>(hwnd, fNegX ? -dxStep : dxStep,
01424                 fNegY ? -dyStep : dyStep, prcScroll, prcClip,
01425                 hrgnScroll, &amp;rcT, <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>)) == ERROR)
01426             <span class="keywordflow">goto</span> Cleanup;
01427 
01428         <a class="code" href="../../d3/d6/rect_8c.html#a9">UnionRect</a>(&amp;rcUpdate, &amp;rcUpdate, &amp;rcT);
01429 
01430         <span class="comment">/*</span>
01431 <span class="comment">         * Blt the uncovered part.</span>
01432 <span class="comment">         */</span>
01433         BitBlt(hdc, xDst, yDst, dxBlt, dyBlt, hdcMem, xSrc, ySrc, SRCCOPY | NOMIRRORBITMAP);
01434 
01435         SetRectRgn(hrgnErase, xDst, yDst, xDst + dxBlt, yDst + dyBlt);
01436         CombineRgn(hrgnErase, hrgnScroll, hrgnErase, RGN_DIFF);
01437         <a class="code" href="../../d6/d0/usercli_8h.html#a239">RedrawWindow</a>(hwnd, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, hrgnErase, RDW_ERASE | RDW_INVALIDATE | RDW_ERASENOW);
01438 
01439     } <span class="keywordflow">while</span> (dxDone &lt; dx || dyDone &lt; dy);
01440 
01441     <span class="keywordflow">if</span> (prcUpdate != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01442         *prcUpdate = rcUpdate;
01443     }
01444     <span class="keywordflow">if</span> (hrgnUpdate != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01445         SetRectRgn(hrgnUpdate, rcUpdate.left, rcUpdate.top,
01446                 rcUpdate.right, rcUpdate.bottom);
01447     }
01448 
01449 Cleanup:
01450     <span class="keywordflow">if</span> (hdcMem != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01451         DeleteDC(hdcMem);
01452     }
01453     <span class="keywordflow">if</span> (hbmMem != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01454         DeleteObject(hbmMem);
01455     }
01456     <span class="keywordflow">if</span> (hdc != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01457         <a class="code" href="../../d3/d8/client_8c.html#a45">ReleaseDC</a>(hwnd, hdc);
01458     }
01459     <span class="keywordflow">if</span> (hrgnErase != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01460         DeleteObject(hrgnErase);
01461     }
01462     <span class="keywordflow">if</span> (hrgnScroll != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01463         DeleteObject(hrgnScroll);
01464     }
01465     <span class="keywordflow">return</span> nRet;
01466 }
01467 
01468 <span class="comment">/***************************************************************************\</span>
01469 <span class="comment">* ScrollWindowEx (API)</span>
01470 <span class="comment">*</span>
01471 <span class="comment">\***************************************************************************/</span>
01472 
<a name="l01473"></a><a class="code" href="../../d3/d8/winmgrc_8c.html#a38">01473</a> <span class="keywordtype">int</span> <a class="code" href="../../d3/d8/winmgrc_8c.html#a38">ScrollWindowEx</a>(HWND hwnd, <span class="keywordtype">int</span> dx, <span class="keywordtype">int</span> dy, CONST RECT *prcScroll,
01474         CONST RECT *prcClip, HRGN hrgnUpdate, LPRECT prcUpdate,
01475         UINT dwFlags)
01476 {
01477     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; SW_SMOOTHSCROLL) {
01478         <span class="keywordflow">return</span> <a class="code" href="../../d3/d8/winmgrc_8c.html#a37">SmoothScrollWindowEx</a>(hwnd, dx, dy, prcScroll, prcClip,
01479                 hrgnUpdate, prcUpdate, LOWORD(<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>), HIWORD(<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>));
01480     } <span class="keywordflow">else</span> {
01481         <span class="keywordflow">return</span> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a219">NtUserScrollWindowEx</a>(hwnd, dx, dy, prcScroll, prcClip,
01482                 hrgnUpdate, prcUpdate, <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>);
01483     }
01484 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:42:25 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
