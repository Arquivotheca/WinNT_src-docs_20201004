<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: abiosc.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>abiosc.c</h1><a href="../../d3/d3/abiosc_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    abiosc.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements ABIOS support C routines for i386 NT.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Shie-Lin Tzong (shielint) 20-May-1991</span>
00016 <span class="comment"></span>
00017 <span class="comment">Environment:</span>
00018 <span class="comment"></span>
00019 <span class="comment">    Boot loader privileged, FLAT mode.</span>
00020 <span class="comment"></span>
00021 <span class="comment"></span>
00022 <span class="comment">Revision History:</span>
00023 <span class="comment"></span>
00024 <span class="comment">--*/</span>
00025 
00026 <span class="preprocessor">#include "<a class="code" href="../../d0/d0/ki_8h.html">ki.h</a>"</span>
00027 <span class="preprocessor">#pragma hdrstop</span>
00028 <span class="preprocessor"></span><span class="preprocessor">#include "<a class="code" href="../../d2/d3/abios_8h.html">abios.h</a>"</span>
00029 
<a name="l00030"></a><a class="code" href="../../d3/d3/abiosc_8c.html#a0">00030</a> <span class="keyword">extern</span> <a class="code" href="../../d5/d5/struct__KCOMMON__DATA__AREA.html">PKCOMMON_DATA_AREA</a> <a class="code" href="../../d3/d3/abiosc_8c.html#a0">KiCommonDataArea</a>;
<a name="l00031"></a><a class="code" href="../../d3/d3/abiosc_8c.html#a1">00031</a> <span class="keyword">extern</span> BOOLEAN <a class="code" href="../../d3/d3/abiosc_8c.html#a1">KiAbiosPresent</a>;
00032 
00033 <span class="comment">//</span>
00034 <span class="comment">// The reason of having these variables defined in here is to isolate</span>
00035 <span class="comment">// ABIOS from current system.</span>
00036 <span class="comment">//</span>
00037 
00038 <span class="comment">//</span>
00039 <span class="comment">// KiNumberFreeSelectors defines the number of available selectors for</span>
00040 <span class="comment">// ABIOS specific drivers.  This number should be the same accross all</span>
00041 <span class="comment">// the processors.</span>
00042 <span class="comment">//</span>
00043 
<a name="l00044"></a><a class="code" href="../../d3/d3/abiosc_8c.html#a2">00044</a> <span class="keyword">static</span> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> <a class="code" href="../../d3/d3/abiosc_8c.html#a2">KiNumberFreeSelectors</a> = 0;
00045 
00046 <span class="comment">//</span>
00047 <span class="comment">// KiFreeGdtListHead points to the head of free GDT list on the processor 0.</span>
00048 <span class="comment">//</span>
00049 
<a name="l00050"></a><a class="code" href="../../d3/d3/abiosc_8c.html#a3">00050</a> <span class="keyword">static</span> <a class="code" href="../../d8/d6/struct__KFREE__GDT__ENTRY.html">PKFREE_GDT_ENTRY</a> <a class="code" href="../../d3/d3/abiosc_8c.html#a3">KiFreeGdtListHead</a> = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00051 
00052 <span class="comment">//</span>
00053 <span class="comment">// Logica Id Table to control the ownership of logical Id.</span>
00054 <span class="comment">//</span>
00055 
<a name="l00056"></a><a class="code" href="../../d3/d3/abiosc_8c.html#a4">00056</a> <a class="code" href="../../d2/d7/struct__KLID__TABLE__ENTRY.html">PKLID_TABLE_ENTRY</a> <a class="code" href="../../d3/d3/abiosc_8c.html#a4">KiLogicalIdTable</a>;
00057 
00058 <span class="comment">//</span>
00059 <span class="comment">// KiAbiosGdt[] defines the Starting address of GDT for each processor.</span>
00060 <span class="comment">//</span>
00061 
<a name="l00062"></a><a class="code" href="../../d3/d3/abiosc_8c.html#a5">00062</a> ULONG <a class="code" href="../../d3/d3/abiosc_8c.html#a5">KiAbiosGdt</a>[<a class="code" href="../../d9/d5/ndismain_8h.html#a183">MAXIMUM_PROCESSORS</a>];
00063 
00064 <span class="comment">//</span>
00065 <span class="comment">// SpinLock for accessing GDTs</span>
00066 <span class="comment">//</span>
00067 
<a name="l00068"></a><a class="code" href="../../d3/d3/abiosc_8c.html#a6">00068</a> KSPIN_LOCK <a class="code" href="../../d3/d3/abiosc_8c.html#a6">KiAbiosGdtLock</a>;
00069 
00070 <span class="comment">//</span>
00071 <span class="comment">// Spinlock for accessing Logical Id Table</span>
00072 <span class="comment">//</span>
00073 
<a name="l00074"></a><a class="code" href="../../d3/d3/abiosc_8c.html#a7">00074</a> KSPIN_LOCK <a class="code" href="../../d3/d3/abiosc_8c.html#a7">KiAbiosLidTableLock</a>;
00075 
00076 <span class="comment">//</span>
00077 <span class="comment">// KiStack16GdtEntry defines the address of the gdt entry for 16 bit stack.</span>
00078 <span class="comment">//</span>
00079 
<a name="l00080"></a><a class="code" href="../../d3/d3/abiosc_8c.html#a8">00080</a> ULONG <a class="code" href="../../d2/d3/abios_8h.html#a26">KiStack16GdtEntry</a>;
00081 
00082 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00083"></a><a class="code" href="../../d3/d3/abiosc_8c.html#a9">00083</a> <a class="code" href="../../d3/d3/abiosc_8c.html#a9">KiInitializeAbiosGdtEntry</a> (
00084     OUT PKGDTENTRY GdtEntry,
00085     IN ULONG Base,
00086     IN ULONG Limit,
00087     IN USHORT Type
00088     )
00089 
00090 <span class="comment">/*++</span>
00091 <span class="comment"></span>
00092 <span class="comment">Routine Description:</span>
00093 <span class="comment"></span>
00094 <span class="comment">    This function initializes a GDT entry for abios specific code.  Base,</span>
00095 <span class="comment">    Limit, and Type (code, data) are set according to parameters.  All other</span>
00096 <span class="comment">    fields of the entry are set to match standard system values.</span>
00097 <span class="comment"></span>
00098 <span class="comment">    N.B. The BIG and GRANULARITY are always set to 0.</span>
00099 <span class="comment"></span>
00100 <span class="comment">Arguments:</span>
00101 <span class="comment"></span>
00102 <span class="comment">    GdtEntry - GDT descriptor to be filled in.</span>
00103 <span class="comment"></span>
00104 <span class="comment">    Base - Linear address of the first byte mapped by the selector.</span>
00105 <span class="comment"></span>
00106 <span class="comment">    Limit - Size of the selector in BYTE.</span>
00107 <span class="comment"></span>
00108 <span class="comment">    Type - Code or Data.  All code selectors are marked readable,</span>
00109 <span class="comment">            all data selectors are marked writeable.</span>
00110 <span class="comment"></span>
00111 <span class="comment">Return Value:</span>
00112 <span class="comment"></span>
00113 <span class="comment">    Pointer to the GDT entry.</span>
00114 <span class="comment"></span>
00115 <span class="comment">--*/</span>
00116 
00117 {
00118     GdtEntry-&gt;LimitLow = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(Limit &amp; 0xffff);
00119     GdtEntry-&gt;BaseLow = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(Base &amp; 0xffff);
00120     GdtEntry-&gt;HighWord.Bytes.BaseMid = (UCHAR)((Base &amp; 0xff0000) &gt;&gt; 16);
00121     GdtEntry-&gt;HighWord.Bits.Type = Type;
00122     GdtEntry-&gt;HighWord.Bits.Dpl = 0;
00123     GdtEntry-&gt;HighWord.Bits.Pres = 1;
00124     GdtEntry-&gt;HighWord.Bits.LimitHi = (Limit &amp; 0xf0000) &gt;&gt; 16;
00125     GdtEntry-&gt;HighWord.Bits.Sys = 0;
00126     GdtEntry-&gt;HighWord.Bits.Reserved_0 = 0;
00127     GdtEntry-&gt;HighWord.Bits.Default_Big = 0;
00128     GdtEntry-&gt;HighWord.Bits.Granularity = 0;
00129     GdtEntry-&gt;HighWord.Bytes.BaseHi = (UCHAR)((Base &amp; 0xff000000) &gt;&gt; 24);
00130 }
00131 
00132 ULONG
<a name="l00133"></a><a class="code" href="../../d3/d3/abiosc_8c.html#a10">00133</a> <a class="code" href="../../d3/d3/abiosc_8c.html#a10">KiI386SelectorBase</a> (
00134     IN USHORT Selector
00135     )
00136 
00137 <span class="comment">/*++</span>
00138 <span class="comment"></span>
00139 <span class="comment">Routine Description:</span>
00140 <span class="comment"></span>
00141 <span class="comment">    This function returns the base address of the specified GDT selector.</span>
00142 <span class="comment"></span>
00143 <span class="comment">Arguments:</span>
00144 <span class="comment"></span>
00145 <span class="comment">    Selector - Supplies the desired selector.</span>
00146 <span class="comment"></span>
00147 <span class="comment">Return Value:</span>
00148 <span class="comment"></span>
00149 <span class="comment">    SelectorBase - Return the base address of the specified selector;</span>
00150 <span class="comment">                   (return -1L if invalid selector)</span>
00151 <span class="comment"></span>
00152 <span class="comment"></span>
00153 <span class="comment">--*/</span>
00154 
00155 {
00156     PKGDTENTRY GdtEntry;
00157 
00158 
00159     GdtEntry = (PKGDTENTRY)(<a class="code" href="../../d2/d3/abios_8h.html#a29">KiAbiosGetGdt</a>() + Selector);
00160     <span class="keywordflow">if</span> (GdtEntry-&gt;HighWord.Bits.Pres) {
00161         <span class="keywordflow">return</span> ((ULONG)GdtEntry-&gt;BaseLow |
00162                 (ULONG)GdtEntry-&gt;HighWord.Bytes.BaseMid &lt;&lt; 16 |
00163                 (ULONG)GdtEntry-&gt;HighWord.Bytes.BaseHi &lt;&lt; 24);
00164     } <span class="keywordflow">else</span> {
00165         <span class="keywordflow">return</span> (ULONG)(-1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
00166     }
00167 }
00168 
00169 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00170"></a><a class="code" href="../../d3/d3/abiosc_8c.html#a11">00170</a> <a class="code" href="../../d3/d3/abiosc_8c.html#a11">KeI386GetLid</a>(
00171     IN USHORT DeviceId,
00172     IN USHORT RelativeLid,
00173     IN BOOLEAN SharedLid,
00174     IN <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject,
00175     OUT <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a> LogicalId
00176     )
00177 
00178 <span class="comment">/*++</span>
00179 <span class="comment"></span>
00180 <span class="comment">Routine Description:</span>
00181 <span class="comment"></span>
00182 <span class="comment">    This function searches Device Blocks and Common Data Area for the</span>
00183 <span class="comment">    Logical Id matching the specified Device Id.</span>
00184 <span class="comment"></span>
00185 <span class="comment">    N.B. (WARNING shielint) To speed the search, this routine ASSUMES that</span>
00186 <span class="comment">    the LIDs with the same Device ID always appear consecutively in the</span>
00187 <span class="comment">    Common Data Area.  IBM ABIOS doc does not explicitly specify this.</span>
00188 <span class="comment">    But from the way ABIOS initializes Device Block and Function Transfer</span>
00189 <span class="comment">    Table, I think the assumption is true.</span>
00190 <span class="comment"></span>
00191 <span class="comment">Arguments:</span>
00192 <span class="comment"></span>
00193 <span class="comment">    DeviceId - Desired Device Id.</span>
00194 <span class="comment"></span>
00195 <span class="comment">    RelativeLid - Specifies the Nth logical Id for this device Id.  A value</span>
00196 <span class="comment">                  of 0 indicates the first available Lid.</span>
00197 <span class="comment"></span>
00198 <span class="comment">    SharedLid - A boolean value indicates if it is a shared or exclusively</span>
00199 <span class="comment">                owned logical Id.</span>
00200 <span class="comment"></span>
00201 <span class="comment">    DriverObject - Supplies a 32-bit flat pointer of the requesting device</span>
00202 <span class="comment">                driver's driver object.  The DriverObject is used to establish</span>
00203 <span class="comment">                the ownership of the desired LID.</span>
00204 <span class="comment"></span>
00205 <span class="comment">    LogicalId - A pointer to a variable which will receive the Lid.</span>
00206 <span class="comment"></span>
00207 <span class="comment">Return Value:</span>
00208 <span class="comment"></span>
00209 <span class="comment">    STATUS_SUCCESS - If the requested LID is available.</span>
00210 <span class="comment"></span>
00211 <span class="comment">    STATUS_ABIOS_NOT_PRESENT - If there is no ABIOS support in the system.</span>
00212 <span class="comment"></span>
00213 <span class="comment">    STATUS_ABIOS_LID_NOT_EXIST - If the specified LID does not exist.</span>
00214 <span class="comment"></span>
00215 <span class="comment">    STATUS_ABIOS_LID_ALREADY_OWNED - If the caller requests an exclusively</span>
00216 <span class="comment">                                     owned LID.</span>
00217 <span class="comment"></span>
00218 <span class="comment">--*/</span>
00219 
00220 {
00221     <a class="code" href="../../d7/d5/struct__KDB__FTT__SECTION.html">PKDB_FTT_SECTION</a> CdaPointer;
00222     <a class="code" href="../../d8/d5/struct__KDEVICE__BLOCK.html">PKDEVICE_BLOCK</a> DeviceBlock;
00223     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> Lid, RelativeLidCount = 1;
00224     ULONG <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>;
00225     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> <a class="code" href="../../d6/d4/rtl_2random_8c.html#a1">Increment</a>;
00226     KIRQL OldIrql;
00227     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00228 
00229     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d3/abiosc_8c.html#a1">KiAbiosPresent</a>) {
00230         <span class="keywordflow">return</span> STATUS_ABIOS_NOT_PRESENT;
00231     }
00232 
00233     <span class="keywordflow">if</span> (SharedLid) {
00234         <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a> = <a class="code" href="../../d2/d3/abios_8h.html#a0">LID_NO_SPECIFIC_OWNER</a>;
00235         <a class="code" href="../../d6/d4/rtl_2random_8c.html#a1">Increment</a> = 1;
00236     } <span class="keywordflow">else</span> {
00237         <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a> = (ULONG)DriverObject;
00238         <a class="code" href="../../d6/d4/rtl_2random_8c.html#a1">Increment</a> = 0;
00239     }
00240 
00241     <span class="comment">//</span>
00242     <span class="comment">// If the Logical Id Table hasn't been created yet, create it now.</span>
00243     <span class="comment">//</span>
00244     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d3/abiosc_8c.html#a4">KiLogicalIdTable</a>==<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00245         <a class="code" href="../../d3/d3/abiosc_8c.html#a4">KiLogicalIdTable</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
00246                                           <a class="code" href="../../d2/d3/abios_8h.html#a1">NUMBER_LID_TABLE_ENTRIES</a> *
00247                                           <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/struct__KLID__TABLE__ENTRY.html">KLID_TABLE_ENTRY</a>),
00248                                           '  eK');
00249         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d3/abiosc_8c.html#a4">KiLogicalIdTable</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00250             <span class="keywordflow">return</span>(STATUS_NO_MEMORY);
00251         }
00252         RtlZeroMemory(<a class="code" href="../../d3/d3/abiosc_8c.html#a4">KiLogicalIdTable</a>, <a class="code" href="../../d2/d3/abios_8h.html#a1">NUMBER_LID_TABLE_ENTRIES</a>*<span class="keyword">sizeof</span>(<a class="code" href="../../d2/d3/abios_8h.html#a21">KLID_TABLE_ENTRY</a>));
00253     }
00254 
00255     <span class="comment">//</span>
00256     <span class="comment">// For each Lid defined in Common Data Area, we check if it has non</span>
00257     <span class="comment">// empty device block and function transfer table.  If yes, we proceed</span>
00258     <span class="comment">// to check the device id.  Otherwise, we skip the Lid.</span>
00259     <span class="comment">//</span>
00260 
00261     CdaPointer = (<a class="code" href="../../d7/d5/struct__KDB__FTT__SECTION.html">PKDB_FTT_SECTION</a>)<a class="code" href="../../d3/d3/abiosc_8c.html#a0">KiCommonDataArea</a> + 2;
00262     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ABIOS_LID_NOT_EXIST;
00263 
00264     ExAcquireSpinLock(&amp;<a class="code" href="../../d3/d3/abiosc_8c.html#a7">KiAbiosLidTableLock</a>, &amp;OldIrql);
00265 
00266     <span class="keywordflow">for</span> (Lid = 2; Lid &lt; <a class="code" href="../../d3/d3/abiosc_8c.html#a0">KiCommonDataArea</a>-&gt;<a class="code" href="../../d5/d5/struct__KCOMMON__DATA__AREA.html#o1">NumberLids</a>; Lid++) {
00267         <span class="keywordflow">if</span> (CdaPointer-&gt;<a class="code" href="../../d7/d5/struct__KDB__FTT__SECTION.html#o0">DeviceBlock</a>.<a class="code" href="../../d9/d4/struct__KABIOS__POINTER.html#o1">Selector</a> != 0 &amp;&amp;
00268             CdaPointer-&gt;<a class="code" href="../../d7/d5/struct__KDB__FTT__SECTION.html#o1">FunctionTransferTable</a>.<a class="code" href="../../d9/d4/struct__KABIOS__POINTER.html#o1">Selector</a> != 0) {
00269 
00270             DeviceBlock = (<a class="code" href="../../d8/d5/struct__KDEVICE__BLOCK.html">PKDEVICE_BLOCK</a>)(<a class="code" href="../../d3/d3/abiosc_8c.html#a10">KiI386SelectorBase</a>(
00271                                                CdaPointer-&gt;<a class="code" href="../../d7/d5/struct__KDB__FTT__SECTION.html#o0">DeviceBlock</a>.<a class="code" href="../../d9/d4/struct__KABIOS__POINTER.html#o1">Selector</a>)
00272                                            + (CdaPointer-&gt;<a class="code" href="../../d7/d5/struct__KDB__FTT__SECTION.html#o0">DeviceBlock</a>.<a class="code" href="../../d9/d4/struct__KABIOS__POINTER.html#o0">Offset</a>));
00273             <span class="keywordflow">if</span> (DeviceBlock-&gt;<a class="code" href="../../d8/d5/struct__KDEVICE__BLOCK.html#o4">DeviceId</a> == DeviceId) {
00274                 <span class="keywordflow">if</span> (RelativeLid == RelativeLidCount || RelativeLid == 0) {
00275                     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d3/abiosc_8c.html#a4">KiLogicalIdTable</a>[Lid].<a class="code" href="../../d2/d7/struct__KLID__TABLE__ENTRY.html#o0">Owner</a> == 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>) {
00276                         <a class="code" href="../../d3/d3/abiosc_8c.html#a4">KiLogicalIdTable</a>[Lid].<a class="code" href="../../d2/d7/struct__KLID__TABLE__ENTRY.html#o0">Owner</a> = <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>;
00277                         <a class="code" href="../../d3/d3/abiosc_8c.html#a4">KiLogicalIdTable</a>[Lid].<a class="code" href="../../d2/d7/struct__KLID__TABLE__ENTRY.html#o1">OwnerCount</a> += <a class="code" href="../../d6/d4/rtl_2random_8c.html#a1">Increment</a>;
00278                         *LogicalId = Lid;
00279                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00280                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d3/d3/abiosc_8c.html#a4">KiLogicalIdTable</a>[Lid].<a class="code" href="../../d2/d7/struct__KLID__TABLE__ENTRY.html#o0">Owner</a> == <a class="code" href="../../d2/d3/abios_8h.html#a0">LID_NO_SPECIFIC_OWNER</a>) {
00281                         <span class="keywordflow">if</span> (SharedLid) {
00282                             *LogicalId = Lid;
00283                             <a class="code" href="../../d3/d3/abiosc_8c.html#a4">KiLogicalIdTable</a>[Lid].<a class="code" href="../../d2/d7/struct__KLID__TABLE__ENTRY.html#o1">OwnerCount</a> += <a class="code" href="../../d6/d4/rtl_2random_8c.html#a1">Increment</a>;
00284                             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00285                         } <span class="keywordflow">else</span> {
00286                             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ABIOS_LID_ALREADY_OWNED;
00287                         }
00288                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d3/d3/abiosc_8c.html#a4">KiLogicalIdTable</a>[Lid].<a class="code" href="../../d2/d7/struct__KLID__TABLE__ENTRY.html#o0">Owner</a> == (ULONG)DriverObject) {
00289                         *LogicalId = Lid;
00290                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00291                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (RelativeLid != 0) {
00292                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ABIOS_LID_ALREADY_OWNED;
00293                     }
00294                     <span class="keywordflow">break</span>;
00295                 } <span class="keywordflow">else</span> {
00296                     RelativeLidCount++;
00297                 }
00298             }
00299         }
00300         CdaPointer++;
00301     }
00302 
00303     ExReleaseSpinLock(&amp;<a class="code" href="../../d3/d3/abiosc_8c.html#a7">KiAbiosLidTableLock</a>, OldIrql);
00304     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00305 }
00306 
00307 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00308"></a><a class="code" href="../../d3/d3/abiosc_8c.html#a12">00308</a> <a class="code" href="../../d3/d3/abiosc_8c.html#a12">KeI386ReleaseLid</a>(
00309     IN USHORT LogicalId,
00310     IN <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject
00311     )
00312 
00313 <span class="comment">/*++</span>
00314 <span class="comment"></span>
00315 <span class="comment">Routine Description:</span>
00316 <span class="comment"></span>
00317 <span class="comment">    This function releases a logical Id.  This routine is called at ABIOS</span>
00318 <span class="comment">    device driver destallation or termination.</span>
00319 <span class="comment"></span>
00320 <span class="comment">Arguments:</span>
00321 <span class="comment"></span>
00322 <span class="comment">    LogicalId - Logical Id to be released.</span>
00323 <span class="comment"></span>
00324 <span class="comment">    DriverObject - Supplies a 32-bit flat pointer of the requesting device</span>
00325 <span class="comment">                driver's driver object.  The DriverObject is used to check</span>
00326 <span class="comment">                the ownership of the specified LID.</span>
00327 <span class="comment"></span>
00328 <span class="comment">Return Value:</span>
00329 <span class="comment"></span>
00330 <span class="comment">    STATUS_SUCCESS - If the requested LID is released.</span>
00331 <span class="comment"></span>
00332 <span class="comment">    STATUS_ABIOS_NOT_PRESENT - If there is no ABIOS support in the system.</span>
00333 <span class="comment"></span>
00334 <span class="comment">    STATUS_ABIOS_NOT_LID_OWNER - If the caller does not own the LID.</span>
00335 <span class="comment"></span>
00336 <span class="comment">--*/</span>
00337 
00338 {
00339     KIRQL OldIrql;
00340     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00341 
00342     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d3/abiosc_8c.html#a1">KiAbiosPresent</a>) {
00343         <span class="keywordflow">return</span> STATUS_ABIOS_NOT_PRESENT;
00344     }
00345 
00346     ExAcquireSpinLock(&amp;<a class="code" href="../../d3/d3/abiosc_8c.html#a7">KiAbiosLidTableLock</a>, &amp;OldIrql);
00347 
00348     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d3/abiosc_8c.html#a4">KiLogicalIdTable</a>[LogicalId].<a class="code" href="../../d2/d7/struct__KLID__TABLE__ENTRY.html#o0">Owner</a> == (ULONG)DriverObject) {
00349         <a class="code" href="../../d3/d3/abiosc_8c.html#a4">KiLogicalIdTable</a>[LogicalId].<a class="code" href="../../d2/d7/struct__KLID__TABLE__ENTRY.html#o0">Owner</a> = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00350         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00351     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d3/d3/abiosc_8c.html#a4">KiLogicalIdTable</a>[LogicalId].<a class="code" href="../../d2/d7/struct__KLID__TABLE__ENTRY.html#o0">Owner</a> == <a class="code" href="../../d2/d3/abios_8h.html#a0">LID_NO_SPECIFIC_OWNER</a>) {
00352         <a class="code" href="../../d3/d3/abiosc_8c.html#a4">KiLogicalIdTable</a>[LogicalId].<a class="code" href="../../d2/d7/struct__KLID__TABLE__ENTRY.html#o1">OwnerCount</a>--;
00353         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d3/abiosc_8c.html#a4">KiLogicalIdTable</a>[LogicalId].<a class="code" href="../../d2/d7/struct__KLID__TABLE__ENTRY.html#o1">OwnerCount</a> == 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>) {
00354             <a class="code" href="../../d3/d3/abiosc_8c.html#a4">KiLogicalIdTable</a>[LogicalId].<a class="code" href="../../d2/d7/struct__KLID__TABLE__ENTRY.html#o0">Owner</a> = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00355         }
00356         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00357     } <span class="keywordflow">else</span> {
00358         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ABIOS_NOT_LID_OWNER;
00359     }
00360 
00361     ExReleaseSpinLock(&amp;<a class="code" href="../../d3/d3/abiosc_8c.html#a7">KiAbiosLidTableLock</a>, OldIrql);
00362 
00363     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00364 }
00365 
00366 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00367"></a><a class="code" href="../../d3/d3/abiosc_8c.html#a13">00367</a> <a class="code" href="../../d3/d3/abiosc_8c.html#a13">KeI386AbiosCall</a>(
00368     IN USHORT LogicalId,
00369     IN <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject,
00370     IN PUCHAR RequestBlock,
00371     IN USHORT EntryPoint
00372     )
00373 
00374 <span class="comment">/*++</span>
00375 <span class="comment"></span>
00376 <span class="comment">Routine Description:</span>
00377 <span class="comment"></span>
00378 <span class="comment">    This function calls an ABIOS service routine on behave of device driver</span>
00379 <span class="comment">    using Operating System Transfer Convension.</span>
00380 <span class="comment"></span>
00381 <span class="comment">Arguments:</span>
00382 <span class="comment"></span>
00383 <span class="comment">    LogicalId - Logical Id for the call.</span>
00384 <span class="comment"></span>
00385 <span class="comment">    DriverObject - Supplies a 32-bit flat pointer of the requesting device</span>
00386 <span class="comment">                driver's driver object.  The DriverObject is used to verify</span>
00387 <span class="comment">                the ownership of the desired LID.</span>
00388 <span class="comment"></span>
00389 <span class="comment">    RequestBlock - A 16:16 (selector:offset) pointer to the request block.</span>
00390 <span class="comment"></span>
00391 <span class="comment">    EntryPoint - Specifies which ABIOS entry point:</span>
00392 <span class="comment"></span>
00393 <span class="comment">                 0 - Start Routine</span>
00394 <span class="comment">                 1 - Interrupt Routine</span>
00395 <span class="comment">                 2 - Timeout Routine</span>
00396 <span class="comment"></span>
00397 <span class="comment">Return Value:</span>
00398 <span class="comment"></span>
00399 <span class="comment">    STATUS_SUCCESS - If no error.</span>
00400 <span class="comment"></span>
00401 <span class="comment">    STATUS_ABIOS_NOT_PRESENT - If there is no ABIOS support in the system.</span>
00402 <span class="comment"></span>
00403 <span class="comment">    STATUS_ABIOS_INVALID_COMMAND - if the specified entry point is not supported.</span>
00404 <span class="comment"></span>
00405 <span class="comment">    STATUS_ABIOS_INVALID_LID - If the Lid specified is invalid.</span>
00406 <span class="comment"></span>
00407 <span class="comment">    STATUS_ABIOS_NOT_LID_OWNER - If the caller does not own this Lid.</span>
00408 <span class="comment"></span>
00409 <span class="comment">    (Note that the request specific ABIOS returned code is in RequestBlock.)</span>
00410 <span class="comment"></span>
00411 <span class="comment">--*/</span>
00412 
00413 {
00414 
00415     <a class="code" href="../../d9/d4/struct__KABIOS__POINTER.html">KABIOS_POINTER</a> FuncTransferTable;
00416     <a class="code" href="../../d9/d4/struct__KABIOS__POINTER.html">KABIOS_POINTER</a> DeviceBlock;
00417     <a class="code" href="../../d9/d4/struct__KABIOS__POINTER.html">KABIOS_POINTER</a> AbiosFunction;
00418     <a class="code" href="../../d9/d6/struct__KFUNCTION__TRANSFER__TABLE.html">PKFUNCTION_TRANSFER_TABLE</a> FttPointer;
00419 
00420     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d3/abiosc_8c.html#a1">KiAbiosPresent</a>) {
00421         <span class="keywordflow">return</span> STATUS_ABIOS_NOT_PRESENT;
00422     }
00423 
00424     <span class="keywordflow">if</span> (LogicalId &gt;= <a class="code" href="../../d3/d3/abiosc_8c.html#a0">KiCommonDataArea</a>-&gt;<a class="code" href="../../d5/d5/struct__KCOMMON__DATA__AREA.html#o1">NumberLids</a>) {
00425         <span class="keywordflow">return</span> STATUS_ABIOS_INVALID_LID;
00426     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d3/d3/abiosc_8c.html#a4">KiLogicalIdTable</a>[LogicalId].<a class="code" href="../../d2/d7/struct__KLID__TABLE__ENTRY.html#o0">Owner</a> != (ULONG)DriverObject &amp;&amp;
00427                <a class="code" href="../../d3/d3/abiosc_8c.html#a4">KiLogicalIdTable</a>[LogicalId].<a class="code" href="../../d2/d7/struct__KLID__TABLE__ENTRY.html#o0">Owner</a> != <a class="code" href="../../d2/d3/abios_8h.html#a0">LID_NO_SPECIFIC_OWNER</a>) {
00428         <span class="keywordflow">return</span> STATUS_ABIOS_NOT_LID_OWNER;
00429     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (EntryPoint &gt; 2) {
00430         <span class="keywordflow">return</span> STATUS_ABIOS_INVALID_COMMAND;
00431     }
00432 
00433     FuncTransferTable = ((<a class="code" href="../../d7/d5/struct__KDB__FTT__SECTION.html">PKDB_FTT_SECTION</a>)<a class="code" href="../../d3/d3/abiosc_8c.html#a0">KiCommonDataArea</a> + LogicalId)-&gt;
00434                                                FunctionTransferTable;
00435     DeviceBlock = ((<a class="code" href="../../d7/d5/struct__KDB__FTT__SECTION.html">PKDB_FTT_SECTION</a>)<a class="code" href="../../d3/d3/abiosc_8c.html#a0">KiCommonDataArea</a> + LogicalId)-&gt;DeviceBlock;
00436     FttPointer = (<a class="code" href="../../d9/d6/struct__KFUNCTION__TRANSFER__TABLE.html">PKFUNCTION_TRANSFER_TABLE</a>)(<a class="code" href="../../d3/d3/abiosc_8c.html#a10">KiI386SelectorBase</a>(FuncTransferTable.<a class="code" href="../../d9/d4/struct__KABIOS__POINTER.html#o1">Selector</a>) +
00437                                              (ULONG)FuncTransferTable.<a class="code" href="../../d9/d4/struct__KABIOS__POINTER.html#o0">Offset</a>);
00438     AbiosFunction = FttPointer-&gt;<a class="code" href="../../d9/d6/struct__KFUNCTION__TRANSFER__TABLE.html#o0">CommonRoutine</a>[EntryPoint];
00439     <a class="code" href="../../d2/d3/abios_8h.html#a27">KiI386CallAbios</a>(AbiosFunction,
00440                     DeviceBlock,
00441                     FuncTransferTable,
00442                     *(<a class="code" href="../../d9/d4/struct__KABIOS__POINTER.html">PKABIOS_POINTER</a>)&amp;RequestBlock
00443                     );
00444 
00445     <span class="keywordflow">return</span> STATUS_SUCCESS;
00446 }
00447 
00448 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00449"></a><a class="code" href="../../d3/d3/abiosc_8c.html#a14">00449</a> <a class="code" href="../../d3/d3/abiosc_8c.html#a14">KeI386AllocateGdtSelectors</a>(
00450     OUT PUSHORT SelectorArray,
00451     IN USHORT NumberOfSelectors
00452     )
00453 
00454 <span class="comment">/*++</span>
00455 <span class="comment"></span>
00456 <span class="comment">Routine Description:</span>
00457 <span class="comment"></span>
00458 <span class="comment">    This function allocates a set of GDT selectors for a device driver to use.</span>
00459 <span class="comment">    Usually this allocation is performed at device driver initialization time</span>
00460 <span class="comment">    to reserve the selectors for later use.</span>
00461 <span class="comment"></span>
00462 <span class="comment">Arguments:</span>
00463 <span class="comment"></span>
00464 <span class="comment">    SelectorArray - Supplies a pointer to an array of USHORT to be filled</span>
00465 <span class="comment">                    in with the GDT selectors allocated.</span>
00466 <span class="comment"></span>
00467 <span class="comment">    NumberOfSelectors - Specifies the number of selectors to be allocated.</span>
00468 <span class="comment"></span>
00469 <span class="comment">Return Value:</span>
00470 <span class="comment"></span>
00471 <span class="comment">    STATUS_SUCCESS - If the requested selectors are allocated.</span>
00472 <span class="comment"></span>
00473 <span class="comment">    STATUS_ABIOS_SELECTOR_NOT_AVAILABLE - if systen can not allocate the number</span>
00474 <span class="comment">                               of selectors requested.</span>
00475 <span class="comment"></span>
00476 <span class="comment">--*/</span>
00477 
00478 {
00479     <a class="code" href="../../d8/d6/struct__KFREE__GDT__ENTRY.html">PKFREE_GDT_ENTRY</a> GdtEntry;
00480     KIRQL OldIrql;
00481 
00482     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d3/abiosc_8c.html#a2">KiNumberFreeSelectors</a> &gt;= NumberOfSelectors) {
00483         ExAcquireSpinLock(&amp;<a class="code" href="../../d3/d3/abiosc_8c.html#a6">KiAbiosGdtLock</a>, &amp;OldIrql);
00484 
00485         <span class="comment">//</span>
00486         <span class="comment">// The Free Gdt link list is maintained on Processor 0's GDT ONLY.</span>
00487         <span class="comment">// Because the 'selector' is an offset to the beginning of GDT and</span>
00488         <span class="comment">// it should be the same accross all the processors.</span>
00489         <span class="comment">//</span>
00490 
00491         <a class="code" href="../../d3/d3/abiosc_8c.html#a2">KiNumberFreeSelectors</a> -= NumberOfSelectors;
00492         GdtEntry = <a class="code" href="../../d3/d3/abiosc_8c.html#a3">KiFreeGdtListHead</a>;
00493         <span class="keywordflow">while</span> (NumberOfSelectors != 0) {
00494             *SelectorArray++ = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)((ULONG)GdtEntry - <a class="code" href="../../d3/d3/abiosc_8c.html#a5">KiAbiosGdt</a>[0]);
00495             GdtEntry = GdtEntry-&gt;<a class="code" href="../../d8/d6/struct__KFREE__GDT__ENTRY.html#o0">Flink</a>;
00496             NumberOfSelectors--;
00497         }
00498         <a class="code" href="../../d3/d3/abiosc_8c.html#a3">KiFreeGdtListHead</a> = GdtEntry;
00499         ExReleaseSpinLock(&amp;<a class="code" href="../../d3/d3/abiosc_8c.html#a6">KiAbiosGdtLock</a>, OldIrql);
00500         <span class="keywordflow">return</span> STATUS_SUCCESS;
00501     } <span class="keywordflow">else</span> {
00502         <span class="keywordflow">return</span> STATUS_ABIOS_SELECTOR_NOT_AVAILABLE;
00503     }
00504 }
00505 
00506 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00507"></a><a class="code" href="../../d3/d3/abiosc_8c.html#a15">00507</a> <a class="code" href="../../d3/d3/abiosc_8c.html#a15">KeI386ReleaseGdtSelectors</a>(
00508     OUT PUSHORT SelectorArray,
00509     IN USHORT NumberOfSelectors
00510     )
00511 
00512 <span class="comment">/*++</span>
00513 <span class="comment"></span>
00514 <span class="comment">Routine Description:</span>
00515 <span class="comment"></span>
00516 <span class="comment">    This function releases a set of GDT selectors for a device driver.</span>
00517 <span class="comment">    Usually this function is called at device driver termination or</span>
00518 <span class="comment">    deinstallation time.</span>
00519 <span class="comment"></span>
00520 <span class="comment">Arguments:</span>
00521 <span class="comment"></span>
00522 <span class="comment">    SelectorArray - Supplies a pointer to an array of USHORT selectors</span>
00523 <span class="comment">                    to be freed.</span>
00524 <span class="comment"></span>
00525 <span class="comment">    NumberOfSelectors - Specifies the number of selectors to be released.</span>
00526 <span class="comment"></span>
00527 <span class="comment">Return Value:</span>
00528 <span class="comment"></span>
00529 <span class="comment">    STATUS_SUCCESS - If the requested LID is released.</span>
00530 <span class="comment"></span>
00531 <span class="comment">--*/</span>
00532 {
00533     <a class="code" href="../../d8/d6/struct__KFREE__GDT__ENTRY.html">PKFREE_GDT_ENTRY</a> GdtEntry;
00534     KIRQL OldIrql;
00535     ULONG Gdt;
00536 
00537     ExAcquireSpinLock(&amp;<a class="code" href="../../d3/d3/abiosc_8c.html#a6">KiAbiosGdtLock</a>, &amp;OldIrql);
00538 
00539     <span class="comment">//</span>
00540     <span class="comment">// The Free Gdt link list is maintained on Processor 0's GDT ONLY.</span>
00541     <span class="comment">// Because the 'selector' is an offset to the beginning of GDT and</span>
00542     <span class="comment">// it should be the same accross all the processors.</span>
00543     <span class="comment">//</span>
00544 
00545     <a class="code" href="../../d3/d3/abiosc_8c.html#a2">KiNumberFreeSelectors</a> += NumberOfSelectors;
00546     Gdt = <a class="code" href="../../d3/d3/abiosc_8c.html#a5">KiAbiosGdt</a>[0];
00547     <span class="keywordflow">while</span> (NumberOfSelectors != 0) {
00548         GdtEntry = (<a class="code" href="../../d8/d6/struct__KFREE__GDT__ENTRY.html">PKFREE_GDT_ENTRY</a>)(Gdt + *SelectorArray++);
00549         GdtEntry-&gt;<a class="code" href="../../d8/d6/struct__KFREE__GDT__ENTRY.html#o0">Flink</a> = <a class="code" href="../../d3/d3/abiosc_8c.html#a3">KiFreeGdtListHead</a>;
00550         <a class="code" href="../../d3/d3/abiosc_8c.html#a3">KiFreeGdtListHead</a> = GdtEntry;
00551         NumberOfSelectors--;
00552     }
00553     ExReleaseSpinLock(&amp;<a class="code" href="../../d3/d3/abiosc_8c.html#a6">KiAbiosGdtLock</a>, OldIrql);
00554     <span class="keywordflow">return</span> STATUS_SUCCESS;
00555 }
00556 
00557 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00558"></a><a class="code" href="../../d3/d3/abiosc_8c.html#a16">00558</a> <a class="code" href="../../d3/d3/abiosc_8c.html#a16">KeI386FlatToGdtSelector</a>(
00559     IN ULONG SelectorBase,
00560     IN USHORT Length,
00561     IN USHORT Selector
00562     )
00563 
00564 <span class="comment">/*++</span>
00565 <span class="comment"></span>
00566 <span class="comment">Routine Description:</span>
00567 <span class="comment"></span>
00568 <span class="comment">    This function converts a 32-bit flat address to a GDT selector-offset</span>
00569 <span class="comment">    pair.  The segment set up is always 16-bit ring 0 data segment.</span>
00570 <span class="comment"></span>
00571 <span class="comment">Arguments:</span>
00572 <span class="comment"></span>
00573 <span class="comment">    SelectorBase - Supplies 32 bit flat address to be set as the base address</span>
00574 <span class="comment">                   of the desired selector.</span>
00575 <span class="comment"></span>
00576 <span class="comment">    Length - Supplies the Length of the segment.  The Length is a 16 bit value</span>
00577 <span class="comment">             and zero means 64KB.</span>
00578 <span class="comment"></span>
00579 <span class="comment">    Selector - Supplies the selector to be set up.</span>
00580 <span class="comment"></span>
00581 <span class="comment">Return Value:</span>
00582 <span class="comment"></span>
00583 <span class="comment">    STATUS_SUCCESS - If the requested LID is released.</span>
00584 <span class="comment"></span>
00585 <span class="comment">    STATUS_ABIOS_NOT_PRESENT - If there is no ABIOS support in the system.</span>
00586 <span class="comment"></span>
00587 <span class="comment">    STATUS_ABIOS_INVALID_SELECTOR - If the selector supplied is invalid.</span>
00588 <span class="comment"></span>
00589 <span class="comment"></span>
00590 <span class="comment">--*/</span>
00591 
00592 {
00593     PKGDTENTRY GdtEntry, GdtEntry1;
00594     KIRQL OldIrql;
00595     ULONG i;
00596 
00597     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d3/abiosc_8c.html#a1">KiAbiosPresent</a>) {
00598         <span class="keywordflow">return</span> STATUS_ABIOS_NOT_PRESENT;
00599     }
00600     <span class="keywordflow">if</span> (Selector &lt; <a class="code" href="../../d2/d3/abios_8h.html#a8">RESERVED_GDT_ENTRIES</a> * <span class="keyword">sizeof</span>(KGDTENTRY)) {
00601         <span class="keywordflow">return</span> STATUS_ABIOS_INVALID_SELECTOR;
00602     } <span class="keywordflow">else</span> {
00603         ExAcquireSpinLock(&amp;<a class="code" href="../../d3/d3/abiosc_8c.html#a6">KiAbiosGdtLock</a>, &amp;OldIrql);
00604         GdtEntry = (PKGDTENTRY)(<a class="code" href="../../d3/d3/abiosc_8c.html#a5">KiAbiosGdt</a>[0] + Selector);
00605         GdtEntry-&gt;LimitLow = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(Length - 1);
00606         GdtEntry-&gt;BaseLow = LOWWORD(SelectorBase);
00607         GdtEntry-&gt;HighWord.Bytes.BaseMid = <a class="code" href="../../d2/d3/abios_8h.html#a3">LOWBYTE</a>(HIGHWORD(SelectorBase));
00608         GdtEntry-&gt;HighWord.Bytes.BaseHi = <a class="code" href="../../d2/d3/abios_8h.html#a2">HIGHBYTE</a>(HIGHWORD(SelectorBase));
00609         GdtEntry-&gt;HighWord.Bits.Pres = 1;
00610         GdtEntry-&gt;HighWord.Bits.Type = TYPE_DATA;
00611         GdtEntry-&gt;HighWord.Bits.Dpl = DPL_SYSTEM;
00612         <span class="keywordflow">for</span> (i = 1; i &lt; (ULONG)<a class="code" href="../../d4/d9/ke_8h.html#a133">KeNumberProcessors</a>; i++) {
00613             GdtEntry1 = (PKGDTENTRY)(<a class="code" href="../../d3/d3/abiosc_8c.html#a5">KiAbiosGdt</a>[i] + Selector);
00614             *GdtEntry1 = *GdtEntry;
00615         }
00616         ExReleaseSpinLock(&amp;<a class="code" href="../../d3/d3/abiosc_8c.html#a6">KiAbiosGdtLock</a>, OldIrql);
00617         <span class="keywordflow">return</span> STATUS_SUCCESS;
00618     }
00619 }
00620 
00621 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00622"></a><a class="code" href="../../d3/d3/abiosc_8c.html#a17">00622</a> <a class="code" href="../../d3/d3/abiosc_8c.html#a17">Ki386InitializeGdtFreeList</a> (
00623     <a class="code" href="../../d8/d6/struct__KFREE__GDT__ENTRY.html">PKFREE_GDT_ENTRY</a> EndOfGdt
00624     )
00625 
00626 <span class="comment">/*++</span>
00627 <span class="comment"></span>
00628 <span class="comment">Routine Description:</span>
00629 <span class="comment"></span>
00630 <span class="comment">    This function initializes gdt free list by linking all the unused gdt</span>
00631 <span class="comment">    entries to a free list.</span>
00632 <span class="comment"></span>
00633 <span class="comment">Arguments:</span>
00634 <span class="comment"></span>
00635 <span class="comment">    EndOfGdt - Supplies the ending address of desired GDT.</span>
00636 <span class="comment"></span>
00637 <span class="comment">Return Value:</span>
00638 <span class="comment"></span>
00639 <span class="comment">    None.</span>
00640 <span class="comment"></span>
00641 <span class="comment">--*/</span>
00642 {
00643     <a class="code" href="../../d8/d6/struct__KFREE__GDT__ENTRY.html">PKFREE_GDT_ENTRY</a> GdtEntry;
00644 
00645     GdtEntry = EndOfGdt - 1;
00646     <a class="code" href="../../d3/d3/abiosc_8c.html#a3">KiFreeGdtListHead</a> = (<a class="code" href="../../d8/d6/struct__KFREE__GDT__ENTRY.html">PKFREE_GDT_ENTRY</a>)0;
00647     <span class="keywordflow">while</span> (GdtEntry != (<a class="code" href="../../d8/d6/struct__KFREE__GDT__ENTRY.html">PKFREE_GDT_ENTRY</a>)<a class="code" href="../../d2/d3/abios_8h.html#a29">KiAbiosGetGdt</a>() +
00648                         <a class="code" href="../../d2/d3/abios_8h.html#a8">RESERVED_GDT_ENTRIES</a> - 1) {
00649         <span class="keywordflow">if</span> (GdtEntry-&gt;<a class="code" href="../../d8/d6/struct__KFREE__GDT__ENTRY.html#o4">Present</a> == 0) {
00650             GdtEntry-&gt;<a class="code" href="../../d8/d6/struct__KFREE__GDT__ENTRY.html#o0">Flink</a> = <a class="code" href="../../d3/d3/abiosc_8c.html#a3">KiFreeGdtListHead</a>;
00651             <a class="code" href="../../d3/d3/abiosc_8c.html#a3">KiFreeGdtListHead</a> = GdtEntry;
00652             <a class="code" href="../../d3/d3/abiosc_8c.html#a2">KiNumberFreeSelectors</a>++;
00653         }
00654         GdtEntry--;
00655     }
00656 }
00657 
00658 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00659"></a><a class="code" href="../../d3/d3/abiosc_8c.html#a18">00659</a> <a class="code" href="../../d3/d3/abiosc_8c.html#a18">KiInitializeAbios</a> (
00660     IN UCHAR Processor
00661     )
00662 
00663 <span class="comment">/*++</span>
00664 <span class="comment"></span>
00665 <span class="comment">Routine Description:</span>
00666 <span class="comment"></span>
00667 <span class="comment">    This function initializes gdt free list and sets up selector for</span>
00668 <span class="comment">    KiI386AbiosCall (16-bit code).</span>
00669 <span class="comment"></span>
00670 <span class="comment">Arguments:</span>
00671 <span class="comment"></span>
00672 <span class="comment">    Processor - the processor who performs the initialization.</span>
00673 <span class="comment"></span>
00674 <span class="comment">Return Value:</span>
00675 <span class="comment"></span>
00676 <span class="comment">    None.</span>
00677 <span class="comment"></span>
00678 <span class="comment">--*/</span>
00679 
00680 {
00681 
00682     ULONG GdtLength;
00683     PKGDTENTRY AliasGdtSelectorEntry;
00684     <a class="code" href="../../d8/d6/struct__KFREE__GDT__ENTRY.html">PKFREE_GDT_ENTRY</a> EndOfGdt;
00685 
00686     <span class="comment">//</span>
00687     <span class="comment">// First check if abios is recognized by osloader.</span>
00688     <span class="comment">//</span>
00689 
00690     <a class="code" href="../../d3/d3/abiosc_8c.html#a0">KiCommonDataArea</a> = <a class="code" href="../../d4/d9/ke_8h.html#a130">KeLoaderBlock</a>-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o23">u</a>.I386.CommonDataArea;
00691 
00692     <span class="comment">//</span>
00693     <span class="comment">// NOTE For now we want to disable ABIOS support on MP.</span>
00694     <span class="comment">//</span>
00695 
00696     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d3/abiosc_8c.html#a0">KiCommonDataArea</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || Processor != 0) {
00697         <a class="code" href="../../d3/d3/abiosc_8c.html#a1">KiAbiosPresent</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00698     } <span class="keywordflow">else</span> {
00699         <a class="code" href="../../d3/d3/abiosc_8c.html#a1">KiAbiosPresent</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00700     }
00701 
00702     <span class="comment">//</span>
00703     <span class="comment">// Initialize the spinlocks for accessing GDTs and Lid Table.</span>
00704     <span class="comment">//</span>
00705 
00706     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>( &amp;<a class="code" href="../../d3/d3/abiosc_8c.html#a6">KiAbiosGdtLock</a> );
00707     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>( &amp;<a class="code" href="../../d3/d3/abiosc_8c.html#a7">KiAbiosLidTableLock</a> );
00708 
00709     <span class="comment">//</span>
00710     <span class="comment">// Determine the starting and ending addresses of GDT.</span>
00711     <span class="comment">//</span>
00712 
00713     <a class="code" href="../../d3/d3/abiosc_8c.html#a5">KiAbiosGdt</a>[Processor] = <a class="code" href="../../d2/d3/abios_8h.html#a29">KiAbiosGetGdt</a>();
00714 
00715     AliasGdtSelectorEntry = (PKGDTENTRY)(<a class="code" href="../../d2/d3/abios_8h.html#a29">KiAbiosGetGdt</a>() + <a class="code" href="../../d2/d3/abios_8h.html#a7">KGDT_GDT_ALIAS</a>);
00716     GdtLength = 1 + (ULONG)(AliasGdtSelectorEntry-&gt;LimitLow) +
00717                 (ULONG)(AliasGdtSelectorEntry-&gt;HighWord.Bits.LimitHi &lt;&lt; 16);
00718     EndOfGdt = (<a class="code" href="../../d8/d6/struct__KFREE__GDT__ENTRY.html">PKFREE_GDT_ENTRY</a>)(<a class="code" href="../../d2/d3/abios_8h.html#a29">KiAbiosGetGdt</a>() + GdtLength);
00719 
00720     <span class="comment">//</span>
00721     <span class="comment">// Prepare selector for 16 bit stack segment</span>
00722     <span class="comment">//</span>
00723 
00724     <a class="code" href="../../d2/d3/abios_8h.html#a26">KiStack16GdtEntry</a> = <a class="code" href="../../d2/d3/abios_8h.html#a29">KiAbiosGetGdt</a>() + <a class="code" href="../../d2/d3/abios_8h.html#a4">KGDT_STACK16</a>;
00725 
00726     <a class="code" href="../../d3/d3/abiosc_8c.html#a9">KiInitializeAbiosGdtEntry</a>(
00727                 (PKGDTENTRY)<a class="code" href="../../d2/d3/abios_8h.html#a26">KiStack16GdtEntry</a>,
00728                 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
00729                 0xffff,
00730                 TYPE_DATA
00731                 );
00732 
00733     <span class="comment">//</span>
00734     <span class="comment">// Establish the addressability of Common Data Area selector.</span>
00735     <span class="comment">//</span>
00736 
00737     <a class="code" href="../../d3/d3/abiosc_8c.html#a9">KiInitializeAbiosGdtEntry</a>(
00738                 (PKGDTENTRY)(<a class="code" href="../../d2/d3/abios_8h.html#a29">KiAbiosGetGdt</a>() + <a class="code" href="../../d2/d3/abios_8h.html#a6">KGDT_CDA16</a>),
00739                 (ULONG)<a class="code" href="../../d3/d3/abiosc_8c.html#a0">KiCommonDataArea</a>,
00740                 0xffff,
00741                 TYPE_DATA
00742                 );
00743 
00744     <span class="comment">//</span>
00745     <span class="comment">// Set up 16-bit code selector for KiI386AbiosCall</span>
00746     <span class="comment">//</span>
00747 
00748     <a class="code" href="../../d3/d3/abiosc_8c.html#a9">KiInitializeAbiosGdtEntry</a>(
00749                 (PKGDTENTRY)(<a class="code" href="../../d2/d3/abios_8h.html#a29">KiAbiosGetGdt</a>() + <a class="code" href="../../d2/d3/abios_8h.html#a5">KGDT_CODE16</a>),
00750                 (ULONG)&amp;<a class="code" href="../../d2/d3/abios_8h.html#a27">KiI386CallAbios</a>,
00751                 (ULONG)&amp;<a class="code" href="../../d2/d3/abios_8h.html#a25">KiEndOfCode16</a> - (ULONG)&amp;<a class="code" href="../../d2/d3/abios_8h.html#a27">KiI386CallAbios</a> - 1,
00752                 0x18                   <span class="comment">// TYPE_CODE</span>
00753                 );
00754 
00755     <span class="comment">//</span>
00756     <span class="comment">// Link all the unused GDT entries to our GDT free list.</span>
00757     <span class="comment">//</span>
00758 
00759     <span class="keywordflow">if</span> (Processor == 0) {
00760         <a class="code" href="../../d3/d3/abiosc_8c.html#a17">Ki386InitializeGdtFreeList</a>(EndOfGdt);
00761     }
00762 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:12 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
