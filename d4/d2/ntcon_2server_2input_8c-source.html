<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: input.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>input.c</h1><a href="../../d3/d3/ntcon_2server_2input_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    input.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">        This file implements the circular buffer management for</span>
00012 <span class="comment">        input events.</span>
00013 <span class="comment"></span>
00014 <span class="comment">        The circular buffer is described by a header,</span>
00015 <span class="comment">        which resides in the beginning of the memory allocated when the</span>
00016 <span class="comment">        buffer is created.  The header contains all of the</span>
00017 <span class="comment">        per-buffer information, such as reader, writer, and</span>
00018 <span class="comment">        reference counts, and also holds the pointers into</span>
00019 <span class="comment">        the circular buffer proper.</span>
00020 <span class="comment"></span>
00021 <span class="comment">        When the in and out pointers are equal, the circular buffer</span>
00022 <span class="comment">        is empty.  When the in pointer trails the out pointer</span>
00023 <span class="comment">        by 1, the buffer is full.  Thus, a 512 byte buffer can hold</span>
00024 <span class="comment">        only 511 bytes; one byte is lost so that full and empty</span>
00025 <span class="comment">        conditions can be distinguished. So that the user can</span>
00026 <span class="comment">        put 512 bytes in a buffer that they created with a size</span>
00027 <span class="comment">        of 512, we allow for this byte lost when allocating</span>
00028 <span class="comment">        the memory.</span>
00029 <span class="comment"></span>
00030 <span class="comment">Author:</span>
00031 <span class="comment"></span>
00032 <span class="comment">    Therese Stowell (thereses) 6-Nov-1990</span>
00033 <span class="comment">    Adapted from OS/2 subsystem server\srvpipe.c</span>
00034 <span class="comment"></span>
00035 <span class="comment">Revision History:</span>
00036 <span class="comment"></span>
00037 <span class="comment">--*/</span>
00038 
00039 <span class="preprocessor">#include "<a class="code" href="../../d6/d3/w32_2ntcon_2server_2precomp_8h.html">precomp.h</a>"</span>
00040 <span class="preprocessor">#pragma hdrstop</span>
00041 <span class="preprocessor"></span>
<a name="l00042"></a><a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a0">00042</a> <span class="preprocessor">#define CTRL_BUT_NOT_ALT(n) \</span>
00043 <span class="preprocessor">        (((n) &amp; (LEFT_CTRL_PRESSED | RIGHT_CTRL_PRESSED)) &amp;&amp; \</span>
00044 <span class="preprocessor">        !((n) &amp; (LEFT_ALT_PRESSED | RIGHT_ALT_PRESSED)))</span>
00045 <span class="preprocessor"></span>
00046 <span class="comment">//</span>
00047 <span class="comment">// this boolean is TRUE while we are processing a WM_QUERYENDSESSION message.</span>
00048 <span class="comment">// since shutdown is guaranteed to be done serially (one window at a time),</span>
00049 <span class="comment">// we can use one boolean.</span>
00050 <span class="comment">//</span>
00051 
<a name="l00052"></a><a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a4">00052</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a23">ProgmanHandleMessage</a>;
00053 
<a name="l00054"></a><a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a5">00054</a> <span class="keywordtype">int</span> <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a9">DialogBoxCount</a>;
00055 
<a name="l00056"></a><a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a6">00056</a> LPTHREAD_START_ROUTINE <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a10">CtrlRoutine</a>;  <span class="comment">// address of client side ctrl-thread routine</span>
00057 
<a name="l00058"></a><a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a7">00058</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a15">InputThreadTlsIndex</a>;
00059 
<a name="l00060"></a><a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a1">00060</a> <span class="preprocessor">#define MAX_CHARS_FROM_1_KEYSTROKE 6</span>
00061 <span class="preprocessor"></span>
00062 
00063 <span class="comment">//</span>
00064 <span class="comment">// the following data structures are a hack to work around the fact that</span>
00065 <span class="comment">// MapVirtualKey does not return the correct virtual key code in many cases.</span>
00066 <span class="comment">// we store the correct info (from the keydown message) in the CONSOLE_KEY_INFO</span>
00067 <span class="comment">// structure when a keydown message is translated.  then when we receive a</span>
00068 <span class="comment">// wm_[sys][dead]char message, we retrieve it and clear out the record.</span>
00069 <span class="comment">//</span>
00070 
<a name="l00071"></a><a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a2">00071</a> <span class="preprocessor">#define CONSOLE_FREE_KEY_INFO 0</span>
<a name="l00072"></a><a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a3">00072</a> <span class="preprocessor"></span><span class="preprocessor">#define CONSOLE_MAX_KEY_INFO 32</span>
00073 <span class="preprocessor"></span>
<a name="l00074"></a><a class="code" href="../../d3/d3/struct__CONSOLE__KEY__INFO.html">00074</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d3/d3/struct__CONSOLE__KEY__INFO.html">_CONSOLE_KEY_INFO</a> {
<a name="l00075"></a><a class="code" href="../../d3/d3/struct__CONSOLE__KEY__INFO.html#o0">00075</a>     HWND <a class="code" href="../../d3/d3/struct__CONSOLE__KEY__INFO.html#o0">hWnd</a>;
<a name="l00076"></a><a class="code" href="../../d3/d3/struct__CONSOLE__KEY__INFO.html#o1">00076</a>     WORD <a class="code" href="../../d3/d3/struct__CONSOLE__KEY__INFO.html#o1">wVirtualKeyCode</a>;
<a name="l00077"></a><a class="code" href="../../d3/d3/struct__CONSOLE__KEY__INFO.html#o2">00077</a>     WORD <a class="code" href="../../d3/d3/struct__CONSOLE__KEY__INFO.html#o2">wVirtualScanCode</a>;
00078 } <a class="code" href="../../d3/d3/struct__CONSOLE__KEY__INFO.html">CONSOLE_KEY_INFO</a>, *<a class="code" href="../../d3/d3/struct__CONSOLE__KEY__INFO.html">PCONSOLE_KEY_INFO</a>;
00079 
<a name="l00080"></a><a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a10">00080</a> <a class="code" href="../../d3/d3/struct__CONSOLE__KEY__INFO.html">CONSOLE_KEY_INFO</a> <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a10">ConsoleKeyInfo</a>[<a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a3">CONSOLE_MAX_KEY_INFO</a>];
00081 
00082 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00083 <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a12">UserExitWorkerThread</a>(VOID);
00084 
00085 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
00086 <a class="code" href="../../d0/d5/srvinit_8c.html#a29">InitWindowClass</a>( VOID );
00087 
00088 <span class="preprocessor">#if !defined(FE_SB)</span>
00089 <span class="preprocessor"></span><a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00090 <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a15">ReadBuffer</a>(
00091     IN <a class="code" href="../../d7/d2/struct__INPUT__INFORMATION.html">PINPUT_INFORMATION</a> InputInformation,
00092     OUT PVOID Buffer,
00093     IN ULONG Length,
00094     OUT PULONG EventsRead,
00095     IN BOOL Peek,
00096     IN BOOL StreamRead,
00097     OUT PBOOL ResetWaitEvent
00098     );
00099 <span class="preprocessor">#endif</span>
00100 <span class="preprocessor"></span>
00101 
00102 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00103"></a><a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a16">00103</a> <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a16">CreateInputBuffer</a>(
00104     IN ULONG NumberOfEvents OPTIONAL,
00105     IN <a class="code" href="../../d7/d2/struct__INPUT__INFORMATION.html">PINPUT_INFORMATION</a> InputBufferInformation
00106 #<span class="keywordflow">if</span> defined(FE_SB)
00107     ,
00108     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console
00109 #endif
00110     )
00111 
00112 <span class="comment">/*++</span>
00113 <span class="comment"></span>
00114 <span class="comment">Routine Description:</span>
00115 <span class="comment"></span>
00116 <span class="comment">    This routine creates an input buffer.  It allocates the circular</span>
00117 <span class="comment">    buffer and initializes the information fields.</span>
00118 <span class="comment"></span>
00119 <span class="comment">Arguments:</span>
00120 <span class="comment"></span>
00121 <span class="comment">    NumberOfEvents - Size of input buffer in events.</span>
00122 <span class="comment"></span>
00123 <span class="comment">    InputBufferInformation - Pointer to input buffer information structure.</span>
00124 <span class="comment"></span>
00125 <span class="comment">Return Value:</span>
00126 <span class="comment"></span>
00127 <span class="comment"></span>
00128 <span class="comment">--*/</span>
00129 
00130 {
00131     ULONG <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>;
00132     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00133 
00134     <span class="keywordflow">if</span> (NumberOfEvents == 0) {
00135         NumberOfEvents = <a class="code" href="../../d9/d3/input_8h.html#a0">DEFAULT_NUMBER_OF_EVENTS</a>;
00136     }
00137 
00138     <span class="comment">// allocate memory for circular buffer</span>
00139 
00140     <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> =  <span class="keyword">sizeof</span>(INPUT_RECORD) * (NumberOfEvents+1);
00141     InputBufferInformation-&gt;InputBuffer = (PINPUT_RECORD)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a17">BUFFER_TAG</a> ),<a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>);
00142     <span class="keywordflow">if</span> (InputBufferInformation-&gt;InputBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00143         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00144     }
00145     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d8/ex_2event_8c.html#a5">NtCreateEvent</a>(&amp;InputBufferInformation-&gt;InputWaitEvent,
00146                            EVENT_ALL_ACCESS, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, NotificationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00147     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00148         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(InputBufferInformation-&gt;InputBuffer);
00149         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00150     }
00151     InitializeListHead(&amp;InputBufferInformation-&gt;ReadWaitQueue);
00152 
00153     <span class="comment">// initialize buffer header</span>
00154 
00155     InputBufferInformation-&gt;InputBufferSize = NumberOfEvents;
00156     InputBufferInformation-&gt;ShareAccess.OpenCount = 0;
00157     InputBufferInformation-&gt;ShareAccess.Readers = 0;
00158     InputBufferInformation-&gt;ShareAccess.Writers = 0;
00159     InputBufferInformation-&gt;ShareAccess.SharedRead = 0;
00160     InputBufferInformation-&gt;ShareAccess.SharedWrite = 0;
00161     InputBufferInformation-&gt;InputMode = ENABLE_LINE_INPUT | ENABLE_PROCESSED_INPUT | ENABLE_ECHO_INPUT | ENABLE_MOUSE_INPUT;
00162     InputBufferInformation-&gt;AllocatedBufferSize = <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>;
00163     InputBufferInformation-&gt;RefCount = 0;
00164     InputBufferInformation-&gt;First = (ULONG_PTR) InputBufferInformation-&gt;InputBuffer;
00165     InputBufferInformation-&gt;In = (ULONG_PTR) InputBufferInformation-&gt;InputBuffer;
00166     InputBufferInformation-&gt;Out = (ULONG_PTR) InputBufferInformation-&gt;InputBuffer;
00167     InputBufferInformation-&gt;Last = (ULONG_PTR) InputBufferInformation-&gt;InputBuffer + <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>;
00168 <span class="preprocessor">#if defined(FE_SB)</span>
00169 <span class="preprocessor"></span><span class="preprocessor">#if defined(FE_IME)</span>
00170 <span class="preprocessor"></span>    InputBufferInformation-&gt;ImeMode.Disable     = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00171     InputBufferInformation-&gt;ImeMode.Unavailable = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00172     InputBufferInformation-&gt;ImeMode.Open        = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00173     InputBufferInformation-&gt;ImeMode.ReadyConversion = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00174 <span class="preprocessor">#endif // FE_IME</span>
00175 <span class="preprocessor"></span>    InputBufferInformation-&gt;Console = Console;
00176     RtlZeroMemory(&amp;InputBufferInformation-&gt;ReadConInpDbcsLeadByte,<span class="keyword">sizeof</span>(INPUT_RECORD));
00177     RtlZeroMemory(&amp;InputBufferInformation-&gt;WriteConInpDbcsLeadByte,<span class="keyword">sizeof</span>(INPUT_RECORD));
00178 <span class="preprocessor">#endif</span>
00179 <span class="preprocessor"></span>
00180     <span class="keywordflow">return</span> STATUS_SUCCESS;
00181 }
00182 
00183 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00184"></a><a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a17">00184</a> <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a17">ReinitializeInputBuffer</a>(
00185     OUT <a class="code" href="../../d7/d2/struct__INPUT__INFORMATION.html">PINPUT_INFORMATION</a> InputBufferInformation
00186     )
00187 
00188 <span class="comment">/*++</span>
00189 <span class="comment"></span>
00190 <span class="comment">Routine Description:</span>
00191 <span class="comment"></span>
00192 <span class="comment">    This routine resets the input buffer information fields to their</span>
00193 <span class="comment">    initial values.</span>
00194 <span class="comment"></span>
00195 <span class="comment">Arguments:</span>
00196 <span class="comment"></span>
00197 <span class="comment">    InputBufferInformation - Pointer to input buffer information structure.</span>
00198 <span class="comment"></span>
00199 <span class="comment">Return Value:</span>
00200 <span class="comment"></span>
00201 <span class="comment">Note:</span>
00202 <span class="comment"></span>
00203 <span class="comment">    The console lock must be held when calling this routine.</span>
00204 <span class="comment"></span>
00205 <span class="comment">--*/</span>
00206 
00207 {
00208     <a class="code" href="../../d0/d8/ex_2event_8c.html#a4">NtClearEvent</a>(InputBufferInformation-&gt;InputWaitEvent);
00209     InputBufferInformation-&gt;ShareAccess.OpenCount = 0;
00210     InputBufferInformation-&gt;ShareAccess.Readers = 0;
00211     InputBufferInformation-&gt;ShareAccess.Writers = 0;
00212     InputBufferInformation-&gt;ShareAccess.SharedRead = 0;
00213     InputBufferInformation-&gt;ShareAccess.SharedWrite = 0;
00214     InputBufferInformation-&gt;InputMode = ENABLE_LINE_INPUT | ENABLE_PROCESSED_INPUT  | ENABLE_ECHO_INPUT | ENABLE_MOUSE_INPUT;
00215     InputBufferInformation-&gt;In = (ULONG_PTR) InputBufferInformation-&gt;InputBuffer;
00216     InputBufferInformation-&gt;Out = (ULONG_PTR) InputBufferInformation-&gt;InputBuffer;
00217     <span class="keywordflow">return</span> STATUS_SUCCESS;
00218 }
00219 
00220 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00221"></a><a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a18">00221</a> <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a18">FreeInputBuffer</a>(
00222     IN <a class="code" href="../../d7/d2/struct__INPUT__INFORMATION.html">PINPUT_INFORMATION</a> InputBufferInformation
00223     )
00224 
00225 <span class="comment">/*++</span>
00226 <span class="comment"></span>
00227 <span class="comment">Routine Description:</span>
00228 <span class="comment"></span>
00229 <span class="comment">    This routine frees the resources associated with an input buffer.</span>
00230 <span class="comment"></span>
00231 <span class="comment">Arguments:</span>
00232 <span class="comment"></span>
00233 <span class="comment">    InputBufferInformation - Pointer to input buffer information structure.</span>
00234 <span class="comment"></span>
00235 <span class="comment">Return Value:</span>
00236 <span class="comment"></span>
00237 <span class="comment"></span>
00238 <span class="comment">--*/</span>
00239 
00240 {
00241     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(InputBufferInformation-&gt;RefCount == 0);
00242     CloseHandle(InputBufferInformation-&gt;InputWaitEvent);
00243     <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(InputBufferInformation-&gt;InputBuffer);
00244 }
00245 
00246 
00247 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00248"></a><a class="code" href="../../d0/d7/server_2stream_8c.html#a14">00248</a> <a class="code" href="../../d0/d7/server_2stream_8c.html#a14">WaitForMoreToRead</a>(
00249     IN <a class="code" href="../../d7/d2/struct__INPUT__INFORMATION.html">PINPUT_INFORMATION</a> InputInformation,
00250     IN PCSR_API_MSG Message OPTIONAL,
00251     IN CSR_WAIT_ROUTINE WaitRoutine OPTIONAL,
00252     IN PVOID WaitParameter OPTIONAL,
00253     IN ULONG WaitParameterLength  OPTIONAL,
00254     IN BOOLEAN WaitBlockExists OPTIONAL
00255     )
00256 
00257 <span class="comment">/*++</span>
00258 <span class="comment"></span>
00259 <span class="comment">Routine Description:</span>
00260 <span class="comment"></span>
00261 <span class="comment">    This routine waits for a writer to add data to the buffer.</span>
00262 <span class="comment"></span>
00263 <span class="comment">Arguments:</span>
00264 <span class="comment"></span>
00265 <span class="comment">    InputInformation - buffer to wait for</span>
00266 <span class="comment"></span>
00267 <span class="comment">    Console - Pointer to console buffer information.</span>
00268 <span class="comment"></span>
00269 <span class="comment">    Message - if called from dll (not InputThread), points to api</span>
00270 <span class="comment">    message.  this parameter is used for wait block processing.</span>
00271 <span class="comment"></span>
00272 <span class="comment">    WaitRoutine - Routine to call when wait is woken up.</span>
00273 <span class="comment"></span>
00274 <span class="comment">    WaitParameter - Parameter to pass to wait routine.</span>
00275 <span class="comment"></span>
00276 <span class="comment">    WaitParameterLength - Length of wait parameter.</span>
00277 <span class="comment"></span>
00278 <span class="comment">    WaitBlockExists - TRUE if wait block has already been created.</span>
00279 <span class="comment"></span>
00280 <span class="comment">Return Value:</span>
00281 <span class="comment"></span>
00282 <span class="comment">    STATUS_WAIT - call was from client and wait block has been created.</span>
00283 <span class="comment"></span>
00284 <span class="comment">    STATUS_SUCCESS - call was from server and wait has been satisfied.</span>
00285 <span class="comment"></span>
00286 <span class="comment">--*/</span>
00287 
00288 {
00289     PVOID WaitParameterBuffer;
00290 
00291     <span class="keywordflow">if</span> (!WaitBlockExists) {
00292         WaitParameterBuffer = (PVOID)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a18">WAIT_TAG</a> ),WaitParameterLength);
00293         <span class="keywordflow">if</span> (WaitParameterBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00294             <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00295         }
00296         RtlCopyMemory(WaitParameterBuffer,WaitParameter,WaitParameterLength);
00297 <span class="preprocessor">#if defined(FE_SB)</span>
00298 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (WaitParameterLength == <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html">COOKED_READ_DATA</a>) &amp;&amp;
00299             InputInformation-&gt;Console-&gt;lpCookedReadData == WaitParameter) {
00300             InputInformation-&gt;Console-&gt;lpCookedReadData = WaitParameterBuffer;
00301         }
00302 <span class="preprocessor">#endif</span>
00303 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (!CsrCreateWait(&amp;InputInformation-&gt;ReadWaitQueue,
00304                           WaitRoutine,
00305                           CSR_SERVER_QUERYCLIENTTHREAD(),
00306                           Message,
00307                           WaitParameterBuffer,
00308                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00309                          )) {
00310             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(WaitParameterBuffer);
00311 <span class="preprocessor">#if defined(FE_SB)</span>
00312 <span class="preprocessor"></span>            InputInformation-&gt;Console-&gt;lpCookedReadData = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00313 <span class="preprocessor">#endif</span>
00314 <span class="preprocessor"></span>            <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00315         }
00316     }
00317     <span class="keywordflow">return</span> <a class="code" href="../../d1/d7/server_8h.html#a64">CONSOLE_STATUS_WAIT</a>;
00318 }
00319 
00320 
00321 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00322"></a><a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a20">00322</a> <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a20">WakeUpReadersWaitingForData</a>(
00323     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
00324     <a class="code" href="../../d7/d2/struct__INPUT__INFORMATION.html">PINPUT_INFORMATION</a> InputInformation
00325     )
00326 
00327 <span class="comment">/*++</span>
00328 <span class="comment"></span>
00329 <span class="comment">Routine Description:</span>
00330 <span class="comment"></span>
00331 <span class="comment">    This routine wakes up readers waiting for data to read.</span>
00332 <span class="comment"></span>
00333 <span class="comment">Arguments:</span>
00334 <span class="comment"></span>
00335 <span class="comment">    InputInformation - buffer to alert readers for</span>
00336 <span class="comment"></span>
00337 <span class="comment">Return Value:</span>
00338 <span class="comment"></span>
00339 <span class="comment">    TRUE - The operation was successful</span>
00340 <span class="comment"></span>
00341 <span class="comment">    FALSE/NULL - The operation failed.</span>
00342 <span class="comment"></span>
00343 <span class="comment">--*/</span>
00344 
00345 {
00346     BOOLEAN WaitSatisfied;
00347     WaitSatisfied = CsrNotifyWait(&amp;InputInformation-&gt;<a class="code" href="../../d7/d2/struct__INPUT__INFORMATION.html#o10">ReadWaitQueue</a>,
00348                   <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00349                   <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00350                   <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00351                  );
00352     <span class="keywordflow">if</span> (WaitSatisfied) {
00353         <span class="comment">// #334370 under stress, WaitQueue may already hold the satisfied waits</span>
00354         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((Console-&gt;WaitQueue == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
00355                 (Console-&gt;WaitQueue == &amp;InputInformation-&gt;<a class="code" href="../../d7/d2/struct__INPUT__INFORMATION.html#o10">ReadWaitQueue</a>));
00356         Console-&gt;WaitQueue = &amp;InputInformation-&gt;<a class="code" href="../../d7/d2/struct__INPUT__INFORMATION.html#o10">ReadWaitQueue</a>;
00357     }
00358 }
00359 
00360 
00361 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00362"></a><a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a21">00362</a> <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a21">GetNumberOfReadyEvents</a>(
00363     IN <a class="code" href="../../d7/d2/struct__INPUT__INFORMATION.html">PINPUT_INFORMATION</a> InputInformation,
00364     OUT PULONG NumberOfEvents
00365     )
00366 
00367 <span class="comment">/*++</span>
00368 <span class="comment"></span>
00369 <span class="comment">Routine Description:</span>
00370 <span class="comment"></span>
00371 <span class="comment">    This routine returns the number of events in the input buffer.</span>
00372 <span class="comment"></span>
00373 <span class="comment">Arguments:</span>
00374 <span class="comment"></span>
00375 <span class="comment">    InputInformation - Pointer to input buffer information structure.</span>
00376 <span class="comment"></span>
00377 <span class="comment">    NumberOfEvents - On output contains the number of events.</span>
00378 <span class="comment"></span>
00379 <span class="comment">Return Value:</span>
00380 <span class="comment"></span>
00381 <span class="comment">Note:</span>
00382 <span class="comment"></span>
00383 <span class="comment">    The console lock must be held when calling this routine.</span>
00384 <span class="comment"></span>
00385 <span class="comment">--*/</span>
00386 
00387 {
00388     <span class="keywordflow">if</span> (InputInformation-&gt;In &lt; InputInformation-&gt;Out) {
00389         *NumberOfEvents = (ULONG)(InputInformation-&gt;Last - InputInformation-&gt;Out);
00390         *NumberOfEvents += (ULONG)(InputInformation-&gt;In - InputInformation-&gt;First);
00391     }
00392     <span class="keywordflow">else</span> {
00393         *NumberOfEvents = (ULONG)(InputInformation-&gt;In - InputInformation-&gt;Out);
00394     }
00395     *NumberOfEvents /= <span class="keyword">sizeof</span>(INPUT_RECORD);
00396 
00397     <span class="keywordflow">return</span> STATUS_SUCCESS;
00398 }
00399 
00400 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00401"></a><a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a22">00401</a> <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a22">FlushAllButKeys</a>(
00402     <a class="code" href="../../d7/d2/struct__INPUT__INFORMATION.html">PINPUT_INFORMATION</a> InputInformation
00403     )
00404 
00405 <span class="comment">/*++</span>
00406 <span class="comment"></span>
00407 <span class="comment">Routine Description:</span>
00408 <span class="comment"></span>
00409 <span class="comment">    This routine removes all but the key events from the buffer.</span>
00410 <span class="comment"></span>
00411 <span class="comment">Arguments:</span>
00412 <span class="comment"></span>
00413 <span class="comment">    InputInformation - Pointer to input buffer information structure.</span>
00414 <span class="comment"></span>
00415 <span class="comment">Return Value:</span>
00416 <span class="comment"></span>
00417 <span class="comment">Note:</span>
00418 <span class="comment"></span>
00419 <span class="comment">    The console lock must be held when calling this routine.</span>
00420 <span class="comment"></span>
00421 <span class="comment">--*/</span>
00422 
00423 {
00424     ULONG NumberOfEventsRead,i;
00425     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00426     PINPUT_RECORD TmpInputBuffer,InPtr,TmpInputBufferPtr;
00427     ULONG <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>;
00428     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> Dummy;
00429 
00430     <span class="keywordflow">if</span> (InputInformation-&gt;<a class="code" href="../../d7/d2/struct__INPUT__INFORMATION.html#o7">In</a> != InputInformation-&gt;<a class="code" href="../../d7/d2/struct__INPUT__INFORMATION.html#o8">Out</a>)  {
00431 
00432         <span class="comment">//</span>
00433         <span class="comment">// allocate memory for temp buffer</span>
00434         <span class="comment">//</span>
00435 
00436         <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> =  <span class="keyword">sizeof</span>(INPUT_RECORD) * (InputInformation-&gt;<a class="code" href="../../d7/d2/struct__INPUT__INFORMATION.html#o1">InputBufferSize</a>+1);
00437         TmpInputBuffer = (PINPUT_RECORD)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a9">TMP_TAG</a> ),<a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>);
00438         <span class="keywordflow">if</span> (TmpInputBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00439             <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00440         }
00441         TmpInputBufferPtr = TmpInputBuffer;
00442 
00443         <span class="comment">//</span>
00444         <span class="comment">// copy input buffer.</span>
00445         <span class="comment">// let ReadBuffer do any compaction work.</span>
00446         <span class="comment">//</span>
00447 
00448         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a15">ReadBuffer</a>(InputInformation,
00449                             TmpInputBuffer,
00450                             InputInformation-&gt;<a class="code" href="../../d7/d2/struct__INPUT__INFORMATION.html#o1">InputBufferSize</a>,
00451                             &amp;NumberOfEventsRead,
00452                             <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00453                             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00454                             &amp;Dummy
00455 #<span class="keywordflow">if</span> defined(FE_SB)
00456                             ,
00457                             <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
00458 #endif
00459                            );
00460 
00461         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00462             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(TmpInputBuffer);
00463             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00464         }
00465 
00466         InputInformation-&gt;<a class="code" href="../../d7/d2/struct__INPUT__INFORMATION.html#o8">Out</a> = (ULONG_PTR) InputInformation-&gt;<a class="code" href="../../d7/d2/struct__INPUT__INFORMATION.html#o0">InputBuffer</a>;
00467         InPtr = InputInformation-&gt;<a class="code" href="../../d7/d2/struct__INPUT__INFORMATION.html#o0">InputBuffer</a>;
00468         <span class="keywordflow">for</span> (i=0;i&lt;NumberOfEventsRead;i++) {
00469             <span class="keywordflow">if</span> (TmpInputBuffer-&gt;EventType == KEY_EVENT) {
00470                 *InPtr = *TmpInputBuffer;
00471                 InPtr++;
00472             }
00473             TmpInputBuffer++;
00474         }
00475         InputInformation-&gt;<a class="code" href="../../d7/d2/struct__INPUT__INFORMATION.html#o7">In</a> = (ULONG_PTR) InPtr;
00476         <span class="keywordflow">if</span> (InputInformation-&gt;<a class="code" href="../../d7/d2/struct__INPUT__INFORMATION.html#o7">In</a> == InputInformation-&gt;<a class="code" href="../../d7/d2/struct__INPUT__INFORMATION.html#o8">Out</a>) {
00477             <a class="code" href="../../d0/d8/ex_2event_8c.html#a4">NtClearEvent</a>(InputInformation-&gt;<a class="code" href="../../d7/d2/struct__INPUT__INFORMATION.html#o11">InputWaitEvent</a>);
00478         }
00479         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(TmpInputBufferPtr);
00480     }
00481     <span class="keywordflow">return</span> STATUS_SUCCESS;
00482 }
00483 
00484 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00485"></a><a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a23">00485</a> <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a23">FlushInputBuffer</a>(
00486     <a class="code" href="../../d7/d2/struct__INPUT__INFORMATION.html">PINPUT_INFORMATION</a> InputInformation
00487     )
00488 
00489 <span class="comment">/*++</span>
00490 <span class="comment"></span>
00491 <span class="comment">Routine Description:</span>
00492 <span class="comment"></span>
00493 <span class="comment">    This routine empties the input buffer</span>
00494 <span class="comment"></span>
00495 <span class="comment">Arguments:</span>
00496 <span class="comment"></span>
00497 <span class="comment">    InputInformation - Pointer to input buffer information structure.</span>
00498 <span class="comment"></span>
00499 <span class="comment">Return Value:</span>
00500 <span class="comment"></span>
00501 <span class="comment">Note:</span>
00502 <span class="comment"></span>
00503 <span class="comment">    The console lock must be held when calling this routine.</span>
00504 <span class="comment"></span>
00505 <span class="comment">--*/</span>
00506 
00507 {
00508     InputInformation-&gt;<a class="code" href="../../d7/d2/struct__INPUT__INFORMATION.html#o7">In</a> = (ULONG_PTR) InputInformation-&gt;<a class="code" href="../../d7/d2/struct__INPUT__INFORMATION.html#o0">InputBuffer</a>;
00509     InputInformation-&gt;<a class="code" href="../../d7/d2/struct__INPUT__INFORMATION.html#o8">Out</a> = (ULONG_PTR) InputInformation-&gt;<a class="code" href="../../d7/d2/struct__INPUT__INFORMATION.html#o0">InputBuffer</a>;
00510     <a class="code" href="../../d0/d8/ex_2event_8c.html#a4">NtClearEvent</a>(InputInformation-&gt;<a class="code" href="../../d7/d2/struct__INPUT__INFORMATION.html#o11">InputWaitEvent</a>);
00511     <span class="keywordflow">return</span> STATUS_SUCCESS;
00512 }
00513 
00514 
00515 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00516"></a><a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a24">00516</a> <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a24">SetInputBufferSize</a>(
00517     IN <a class="code" href="../../d7/d2/struct__INPUT__INFORMATION.html">PINPUT_INFORMATION</a> InputInformation,
00518     IN ULONG Size
00519     )
00520 
00521 <span class="comment">/*++</span>
00522 <span class="comment"></span>
00523 <span class="comment">Routine Description:</span>
00524 <span class="comment"></span>
00525 <span class="comment">    This routine resizes the input buffer.</span>
00526 <span class="comment"></span>
00527 <span class="comment">Arguments:</span>
00528 <span class="comment"></span>
00529 <span class="comment">    InputInformation - Pointer to input buffer information structure.</span>
00530 <span class="comment"></span>
00531 <span class="comment">    Size - New size in number of events.</span>
00532 <span class="comment"></span>
00533 <span class="comment">Return Value:</span>
00534 <span class="comment"></span>
00535 <span class="comment">Note:</span>
00536 <span class="comment"></span>
00537 <span class="comment">    The console lock must be held when calling this routine.</span>
00538 <span class="comment"></span>
00539 <span class="comment">--*/</span>
00540 
00541 {
00542     ULONG NumberOfEventsRead;
00543     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00544     PINPUT_RECORD InputBuffer;
00545     ULONG <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>;
00546     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> Dummy;
00547 
00548 <span class="preprocessor">#if DBG</span>
00549 <span class="preprocessor"></span>    ULONG_PTR NumberOfEvents;
00550     <span class="keywordflow">if</span> (InputInformation-&gt;In &lt; InputInformation-&gt;Out) {
00551         NumberOfEvents = InputInformation-&gt;Last - InputInformation-&gt;Out;
00552         NumberOfEvents += InputInformation-&gt;In - InputInformation-&gt;First;
00553     }
00554     <span class="keywordflow">else</span> {
00555         NumberOfEvents = InputInformation-&gt;In - InputInformation-&gt;Out;
00556     }
00557     NumberOfEvents /= <span class="keyword">sizeof</span>(INPUT_RECORD);
00558 <span class="preprocessor">#endif</span>
00559 <span class="preprocessor"></span>    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> &gt; InputInformation-&gt;InputBufferSize );
00560 
00561     <span class="comment">//</span>
00562     <span class="comment">// allocate memory for new input buffer</span>
00563     <span class="comment">//</span>
00564 
00565     <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> =  <span class="keyword">sizeof</span>(INPUT_RECORD) * (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>+1);
00566     InputBuffer = (PINPUT_RECORD)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a17">BUFFER_TAG</a> ),<a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>);
00567     <span class="keywordflow">if</span> (InputBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00568         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00569     }
00570 
00571     <span class="comment">//</span>
00572     <span class="comment">// copy old input buffer.</span>
00573     <span class="comment">// let the ReadBuffer do any compaction work.</span>
00574     <span class="comment">//</span>
00575 
00576     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a15">ReadBuffer</a>(InputInformation,
00577                         InputBuffer,
00578                         <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>,
00579                         &amp;NumberOfEventsRead,
00580                         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00581                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00582                         &amp;Dummy
00583 #<span class="keywordflow">if</span> defined(FE_SB)
00584                         ,
00585                         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
00586 #endif
00587                        );
00588 
00589     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00590         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(InputBuffer);
00591         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00592     }
00593     InputInformation-&gt;Out = (ULONG_PTR)InputBuffer;
00594     InputInformation-&gt;In = (ULONG_PTR)InputBuffer + <span class="keyword">sizeof</span>(INPUT_RECORD) * NumberOfEventsRead;
00595 
00596     <span class="comment">//</span>
00597     <span class="comment">// adjust pointers</span>
00598     <span class="comment">//</span>
00599 
00600     InputInformation-&gt;First = (ULONG_PTR) InputBuffer;
00601     InputInformation-&gt;Last = (ULONG_PTR) InputBuffer + <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>;
00602 
00603     <span class="comment">//</span>
00604     <span class="comment">// free old input buffer</span>
00605     <span class="comment">//</span>
00606 
00607     <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(InputInformation-&gt;InputBuffer);
00608     InputInformation-&gt;InputBufferSize = <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00609     InputInformation-&gt;AllocatedBufferSize = <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>;
00610     InputInformation-&gt;InputBuffer = InputBuffer;
00611     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00612 }
00613 
00614 
00615 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00616"></a><a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a15">00616</a> <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a15">ReadBuffer</a>(
00617     IN <a class="code" href="../../d7/d2/struct__INPUT__INFORMATION.html">PINPUT_INFORMATION</a> InputInformation,
00618     OUT PVOID Buffer,
00619     IN ULONG Length,
00620     OUT PULONG EventsRead,
00621     IN BOOL Peek,
00622     IN BOOL StreamRead,
00623     OUT PBOOL ResetWaitEvent
00624 #ifdef FE_SB
00625     , IN BOOLEAN Unicode
00626 #endif
00627     )
00628 <span class="comment">/*++</span>
00629 <span class="comment"></span>
00630 <span class="comment">Routine Description:</span>
00631 <span class="comment"></span>
00632 <span class="comment">    This routine reads from a buffer.  It does the actual circular buffer</span>
00633 <span class="comment">    manipulation.</span>
00634 <span class="comment"></span>
00635 <span class="comment">Arguments:</span>
00636 <span class="comment"></span>
00637 <span class="comment">    InputInformation - buffer to read from</span>
00638 <span class="comment"></span>
00639 <span class="comment">    Buffer - buffer to read into</span>
00640 <span class="comment"></span>
00641 <span class="comment">    Length - length of buffer in events</span>
00642 <span class="comment"></span>
00643 <span class="comment">    EventsRead - where to store number of events read</span>
00644 <span class="comment"></span>
00645 <span class="comment">    Peek - if TRUE, don't remove data from buffer, just copy it.</span>
00646 <span class="comment"></span>
00647 <span class="comment">    StreamRead - if TRUE, events with repeat counts &gt; 1 are returned</span>
00648 <span class="comment">    as multiple events.  also, EventsRead == 1.</span>
00649 <span class="comment"></span>
00650 <span class="comment">    ResetWaitEvent - on exit, TRUE if buffer became empty.</span>
00651 <span class="comment"></span>
00652 <span class="comment">Return Value:</span>
00653 <span class="comment"></span>
00654 <span class="comment">    ??</span>
00655 <span class="comment"></span>
00656 <span class="comment">Note:</span>
00657 <span class="comment"></span>
00658 <span class="comment">    The console lock must be held when calling this routine.</span>
00659 <span class="comment"></span>
00660 <span class="comment">--*/</span>
00661 
00662 {
00663     ULONG TransferLength,OldTransferLength;
00664     ULONG BufferLengthInBytes;
00665 <span class="preprocessor">#ifdef FE_SB</span>
00666 <span class="preprocessor"></span>    <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
00667     ULONG Length2;
00668     PINPUT_RECORD BufferRecords;
00669     PINPUT_RECORD QueueRecords;
00670     WCHAR UniChar;
00671     WORD EventType;
00672 <span class="preprocessor">#endif</span>
00673 <span class="preprocessor"></span>
00674 <span class="preprocessor">#ifdef FE_SB</span>
00675 <span class="preprocessor"></span>    Console = InputInformation-&gt;Console;
00676 <span class="preprocessor">#endif</span>
00677 <span class="preprocessor"></span>    *ResetWaitEvent = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00678 
00679     <span class="comment">//</span>
00680     <span class="comment">// if StreamRead, just return one record.  if repeat count is greater</span>
00681     <span class="comment">// than one, just decrement it.  the repeat count is &gt; 1 if more than</span>
00682     <span class="comment">// one event of the same type was merged.  we need to expand them back</span>
00683     <span class="comment">// to individual events here.</span>
00684     <span class="comment">//</span>
00685 
00686     <span class="keywordflow">if</span> (StreamRead &amp;&amp;
00687         ((PINPUT_RECORD)(InputInformation-&gt;Out))-&gt;EventType == KEY_EVENT) {
00688 
00689         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Length == 1);
00690         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(InputInformation-&gt;In != InputInformation-&gt;Out);
00691         RtlMoveMemory((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00692                       (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)InputInformation-&gt;Out,
00693                       <span class="keyword">sizeof</span>(INPUT_RECORD)
00694                      );
00695         InputInformation-&gt;Out += <span class="keyword">sizeof</span>(INPUT_RECORD);
00696         <span class="keywordflow">if</span> (InputInformation-&gt;Last == InputInformation-&gt;Out) {
00697             InputInformation-&gt;Out = InputInformation-&gt;First;
00698         }
00699         <span class="keywordflow">if</span> (InputInformation-&gt;Out == InputInformation-&gt;In) {
00700             *ResetWaitEvent = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00701         }
00702         *EventsRead = 1;
00703         <span class="keywordflow">return</span> STATUS_SUCCESS;
00704     }
00705 
00706     BufferLengthInBytes = Length * <span class="keyword">sizeof</span>(INPUT_RECORD);
00707 
00708     <span class="comment">//</span>
00709     <span class="comment">// if in &gt; out, buffer looks like this:</span>
00710     <span class="comment">//</span>
00711     <span class="comment">//         out     in</span>
00712     <span class="comment">//    ______ _____________</span>
00713     <span class="comment">//   |      |      |      |</span>
00714     <span class="comment">//   | free | data | free |</span>
00715     <span class="comment">//   |______|______|______|</span>
00716     <span class="comment">//</span>
00717     <span class="comment">// we transfer the requested number of events or the amount in the buffer</span>
00718     <span class="comment">//</span>
00719 
00720     <span class="keywordflow">if</span> (InputInformation-&gt;In &gt; InputInformation-&gt;Out) {
00721         <span class="keywordflow">if</span>  ((InputInformation-&gt;In - InputInformation-&gt;Out) &gt; BufferLengthInBytes) {
00722             TransferLength = BufferLengthInBytes;
00723         }
00724         <span class="keywordflow">else</span> {
00725             TransferLength = (ULONG)(InputInformation-&gt;In - InputInformation-&gt;Out);
00726         }
00727 <span class="preprocessor">#ifdef FE_SB</span>
00728 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a>) {
00729             BufferLengthInBytes = 0;
00730             OldTransferLength = TransferLength / <span class="keyword">sizeof</span>(INPUT_RECORD);
00731             BufferRecords = (PINPUT_RECORD)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00732             QueueRecords = (PINPUT_RECORD)InputInformation-&gt;Out;
00733 
00734             <span class="keywordflow">while</span> (BufferLengthInBytes &lt; Length &amp;&amp;
00735                    OldTransferLength) {
00736                 UniChar = QueueRecords-&gt;Event.KeyEvent.uChar.UnicodeChar;
00737                 EventType = QueueRecords-&gt;EventType;
00738                 *BufferRecords++ = *QueueRecords++;
00739                 <span class="keywordflow">if</span> (EventType == KEY_EVENT) {
00740                     <span class="keywordflow">if</span> (IsConsoleFullWidth(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o10">hDC</a>,
00741                                            Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o61">CP</a>,
00742                                            UniChar)) {
00743                         BufferLengthInBytes += 2;
00744                     }
00745                     <span class="keywordflow">else</span> {
00746                         BufferLengthInBytes++;
00747                     }
00748                 }
00749                 <span class="keywordflow">else</span> {
00750                     BufferLengthInBytes++;
00751                 }
00752                 OldTransferLength--;
00753             }
00754             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(TransferLength &gt;= OldTransferLength * <span class="keyword">sizeof</span>(INPUT_RECORD));
00755             TransferLength -= OldTransferLength * <span class="keyword">sizeof</span>(INPUT_RECORD);
00756         }
00757         <span class="keywordflow">else</span>
00758 <span class="preprocessor">#endif</span>
00759 <span class="preprocessor"></span>        {
00760             RtlMoveMemory((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00761                           (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)InputInformation-&gt;Out,
00762                           TransferLength
00763                          );
00764         }
00765         *EventsRead = TransferLength / <span class="keyword">sizeof</span>(INPUT_RECORD);
00766 <span class="preprocessor">#ifdef FE_SB</span>
00767 <span class="preprocessor"></span>        <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(*EventsRead &lt;= Length);
00768 <span class="preprocessor">#endif</span>
00769 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (!Peek) {
00770             InputInformation-&gt;Out += TransferLength;
00771 <span class="preprocessor">#ifdef FE_SB</span>
00772 <span class="preprocessor"></span>            <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(InputInformation-&gt;Out &lt;= InputInformation-&gt;Last);
00773 <span class="preprocessor">#endif</span>
00774 <span class="preprocessor"></span>        }
00775         <span class="keywordflow">if</span> (InputInformation-&gt;Out == InputInformation-&gt;In) {
00776             *ResetWaitEvent = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00777         }
00778         <span class="keywordflow">return</span> STATUS_SUCCESS;
00779     }
00780 
00781     <span class="comment">//</span>
00782     <span class="comment">// if out &gt; in, buffer looks like this:</span>
00783     <span class="comment">//</span>
00784     <span class="comment">//         in     out</span>
00785     <span class="comment">//    ______ _____________</span>
00786     <span class="comment">//   |      |      |      |</span>
00787     <span class="comment">//   | data | free | data |</span>
00788     <span class="comment">//   |______|______|______|</span>
00789     <span class="comment">//</span>
00790     <span class="comment">// we read from the out pointer to the end of the buffer then from the</span>
00791     <span class="comment">// beginning of the buffer, until we hit the in pointer or enough bytes</span>
00792     <span class="comment">// are read.</span>
00793     <span class="comment">//</span>
00794 
00795     <span class="keywordflow">else</span> {
00796 
00797         <span class="keywordflow">if</span>  ((InputInformation-&gt;Last - InputInformation-&gt;Out) &gt; BufferLengthInBytes) {
00798             TransferLength = BufferLengthInBytes;
00799         }
00800         <span class="keywordflow">else</span> {
00801             TransferLength = (ULONG)(InputInformation-&gt;Last - InputInformation-&gt;Out);
00802         }
00803 <span class="preprocessor">#ifdef FE_SB</span>
00804 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a>) {
00805             BufferLengthInBytes = 0;
00806             OldTransferLength = TransferLength / <span class="keyword">sizeof</span>(INPUT_RECORD);
00807             BufferRecords = (PINPUT_RECORD)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00808             QueueRecords = (PINPUT_RECORD)InputInformation-&gt;Out;
00809 
00810             <span class="keywordflow">while</span> (BufferLengthInBytes &lt; Length &amp;&amp;
00811                    OldTransferLength) {
00812                 UniChar = QueueRecords-&gt;Event.KeyEvent.uChar.UnicodeChar;
00813                 EventType = QueueRecords-&gt;EventType;
00814                 *BufferRecords++ = *QueueRecords++;
00815                 <span class="keywordflow">if</span> (EventType == KEY_EVENT) {
00816                     <span class="keywordflow">if</span> (IsConsoleFullWidth(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o10">hDC</a>,
00817                                            Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o61">CP</a>,
00818                                     UniChar)) {
00819                         BufferLengthInBytes += 2;
00820                     }
00821                     <span class="keywordflow">else</span> {
00822                         BufferLengthInBytes++;
00823                     }
00824                 }
00825                 <span class="keywordflow">else</span> {
00826                     BufferLengthInBytes++;
00827                 }
00828                 OldTransferLength--;
00829             }
00830             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(TransferLength &gt;= OldTransferLength * <span class="keyword">sizeof</span>(INPUT_RECORD));
00831             TransferLength -= OldTransferLength * <span class="keyword">sizeof</span>(INPUT_RECORD);
00832         }
00833         <span class="keywordflow">else</span>
00834 <span class="preprocessor">#endif</span>
00835 <span class="preprocessor"></span>        {
00836             RtlMoveMemory((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00837                           (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)InputInformation-&gt;Out,
00838                           TransferLength
00839                          );
00840         }
00841         *EventsRead = TransferLength / <span class="keyword">sizeof</span>(INPUT_RECORD);
00842 <span class="preprocessor">#ifdef FE_SB</span>
00843 <span class="preprocessor"></span>        <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(*EventsRead &lt;= Length);
00844 <span class="preprocessor">#endif</span>
00845 <span class="preprocessor"></span>
00846         <span class="keywordflow">if</span> (!Peek) {
00847             InputInformation-&gt;Out += TransferLength;
00848 <span class="preprocessor">#ifdef FE_SB</span>
00849 <span class="preprocessor"></span>            <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(InputInformation-&gt;Out &lt;= InputInformation-&gt;Last);
00850 <span class="preprocessor">#endif</span>
00851 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (InputInformation-&gt;Out == InputInformation-&gt;Last) {
00852                 InputInformation-&gt;Out = InputInformation-&gt;First;
00853             }
00854         }
00855 <span class="preprocessor">#ifdef FE_SB</span>
00856 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a>) {
00857             <span class="keywordflow">if</span> (BufferLengthInBytes &gt;= Length) {
00858                 <span class="keywordflow">if</span> (InputInformation-&gt;Out == InputInformation-&gt;In) {
00859                     *ResetWaitEvent = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00860                 }
00861                 <span class="keywordflow">return</span> STATUS_SUCCESS;
00862             }
00863         }
00864         <span class="keywordflow">else</span>
00865 <span class="preprocessor">#endif</span>
00866 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (*EventsRead == Length) {
00867             <span class="keywordflow">if</span> (InputInformation-&gt;Out == InputInformation-&gt;In) {
00868                 *ResetWaitEvent = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00869             }
00870             <span class="keywordflow">return</span> STATUS_SUCCESS;
00871         }
00872 
00873         <span class="comment">//</span>
00874         <span class="comment">// hit end of buffer, read from beginning</span>
00875         <span class="comment">//</span>
00876 
00877         OldTransferLength = TransferLength;
00878 <span class="preprocessor">#ifdef FE_SB</span>
00879 <span class="preprocessor"></span>        Length2 = Length;
00880         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a>) {
00881             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Length &gt; BufferLengthInBytes);
00882             Length -= BufferLengthInBytes;
00883             <span class="keywordflow">if</span> (Length == 0) {
00884                 <span class="keywordflow">if</span> (InputInformation-&gt;Out == InputInformation-&gt;In) {
00885                     *ResetWaitEvent = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00886                 }
00887             <span class="keywordflow">return</span> STATUS_SUCCESS;
00888             }
00889             BufferLengthInBytes = Length * <span class="keyword">sizeof</span>(INPUT_RECORD);
00890 
00891             <span class="keywordflow">if</span> ((InputInformation-&gt;In - InputInformation-&gt;First) &gt; BufferLengthInBytes) {
00892                 TransferLength = BufferLengthInBytes;
00893             }
00894             <span class="keywordflow">else</span> {
00895                 TransferLength = (ULONG)(InputInformation-&gt;In - InputInformation-&gt;First);
00896             }
00897         }
00898         <span class="keywordflow">else</span>
00899 <span class="preprocessor">#endif</span>
00900 <span class="preprocessor"></span>        <span class="keywordflow">if</span>  ((InputInformation-&gt;In - InputInformation-&gt;First) &gt; (BufferLengthInBytes - OldTransferLength)) {
00901             TransferLength = BufferLengthInBytes - OldTransferLength;
00902         }
00903         <span class="keywordflow">else</span> {
00904             TransferLength = (ULONG)(InputInformation-&gt;In - InputInformation-&gt;First);
00905         }
00906 <span class="preprocessor">#ifdef FE_SB</span>
00907 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a>) {
00908             BufferLengthInBytes = 0;
00909             OldTransferLength = TransferLength / <span class="keyword">sizeof</span>(INPUT_RECORD);
00910             QueueRecords = (PINPUT_RECORD)InputInformation-&gt;First;
00911 
00912             <span class="keywordflow">while</span> (BufferLengthInBytes &lt; Length &amp;&amp;
00913                    OldTransferLength) {
00914                 UniChar = QueueRecords-&gt;Event.KeyEvent.uChar.UnicodeChar;
00915                 EventType = QueueRecords-&gt;EventType;
00916                 *BufferRecords++ = *QueueRecords++;
00917                 <span class="keywordflow">if</span> (EventType == KEY_EVENT) {
00918                     <span class="keywordflow">if</span> (IsConsoleFullWidth(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o10">hDC</a>,
00919                                            Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o61">CP</a>,
00920                                     UniChar)) {
00921                         BufferLengthInBytes += 2;
00922                     }
00923                     <span class="keywordflow">else</span> {
00924                         BufferLengthInBytes++;
00925                     }
00926                 }
00927                 <span class="keywordflow">else</span> {
00928                     BufferLengthInBytes++;
00929                 }
00930                 OldTransferLength--;
00931             }
00932             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(TransferLength &gt;= OldTransferLength * <span class="keyword">sizeof</span>(INPUT_RECORD));
00933             TransferLength -= OldTransferLength * <span class="keyword">sizeof</span>(INPUT_RECORD);
00934         }
00935         <span class="keywordflow">else</span>
00936 <span class="preprocessor">#endif</span>
00937 <span class="preprocessor"></span>        {
00938             RtlMoveMemory((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>+OldTransferLength,
00939                           (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)InputInformation-&gt;First,
00940                           TransferLength
00941                          );
00942         }
00943         *EventsRead += TransferLength / <span class="keyword">sizeof</span>(INPUT_RECORD);
00944 <span class="preprocessor">#ifdef FE_SB</span>
00945 <span class="preprocessor"></span>        <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(*EventsRead &lt;= Length2);
00946 <span class="preprocessor">#endif</span>
00947 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (!Peek) {
00948             InputInformation-&gt;Out = InputInformation-&gt;First + TransferLength;
00949         }
00950         <span class="keywordflow">if</span> (InputInformation-&gt;Out == InputInformation-&gt;In) {
00951             *ResetWaitEvent = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00952         }
00953         <span class="keywordflow">return</span> STATUS_SUCCESS;
00954     }
00955 }
00956 
00957 
00958 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00959"></a><a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a25">00959</a> <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a25">ReadInputBuffer</a>(
00960     IN <a class="code" href="../../d7/d2/struct__INPUT__INFORMATION.html">PINPUT_INFORMATION</a> InputInformation,
00961     OUT PINPUT_RECORD lpBuffer,
00962     IN OUT PDWORD nLength,
00963     IN BOOL Peek,
00964     IN BOOL WaitForData,
00965     IN BOOL StreamRead,
00966     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
00967     IN <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> HandleData OPTIONAL,
00968     IN PCSR_API_MSG Message OPTIONAL,
00969     IN CSR_WAIT_ROUTINE WaitRoutine OPTIONAL,
00970     IN PVOID WaitParameter OPTIONAL,
00971     IN ULONG WaitParameterLength  OPTIONAL,
00972     IN BOOLEAN WaitBlockExists OPTIONAL
00973 #<span class="keywordflow">if</span> defined(FE_SB)
00974     ,
00975     IN BOOLEAN Unicode
00976 #endif
00977     )
00978 
00979 <span class="comment">/*++</span>
00980 <span class="comment"></span>
00981 <span class="comment">Routine Description:</span>
00982 <span class="comment"></span>
00983 <span class="comment">    This routine reads from the input buffer.</span>
00984 <span class="comment"></span>
00985 <span class="comment">Arguments:</span>
00986 <span class="comment"></span>
00987 <span class="comment">    InputInformation - Pointer to input buffer information structure.</span>
00988 <span class="comment"></span>
00989 <span class="comment">    lpBuffer - Buffer to read into.</span>
00990 <span class="comment"></span>
00991 <span class="comment">    nLength - On input, number of events to read.  On output, number of</span>
00992 <span class="comment">    events read.</span>
00993 <span class="comment"></span>
00994 <span class="comment">    Peek - If TRUE, copy events to lpBuffer but don't remove them from</span>
00995 <span class="comment">    the input buffer.</span>
00996 <span class="comment"></span>
00997 <span class="comment">    WaitForData - if TRUE, wait until an event is input.  if FALSE, return</span>
00998 <span class="comment">        immediately</span>
00999 <span class="comment"></span>
01000 <span class="comment">    StreamRead - if TRUE, events with repeat counts &gt; 1 are returned</span>
01001 <span class="comment">    as multiple events.  also, EventsRead == 1.</span>
01002 <span class="comment"></span>
01003 <span class="comment">    Console - Pointer to console buffer information.</span>
01004 <span class="comment"></span>
01005 <span class="comment">    HandleData - Pointer to handle data structure.  This parameter is</span>
01006 <span class="comment">    optional if WaitForData is false.</span>
01007 <span class="comment"></span>
01008 <span class="comment">    Message - if called from dll (not InputThread), points to api</span>
01009 <span class="comment">    message.  this parameter is used for wait block processing.</span>
01010 <span class="comment"></span>
01011 <span class="comment">    WaitRoutine - Routine to call when wait is woken up.</span>
01012 <span class="comment"></span>
01013 <span class="comment">    WaitParameter - Parameter to pass to wait routine.</span>
01014 <span class="comment"></span>
01015 <span class="comment">    WaitParameterLength - Length of wait parameter.</span>
01016 <span class="comment"></span>
01017 <span class="comment">    WaitBlockExists - TRUE if wait block has already been created.</span>
01018 <span class="comment"></span>
01019 <span class="comment">Return Value:</span>
01020 <span class="comment"></span>
01021 <span class="comment">Note:</span>
01022 <span class="comment"></span>
01023 <span class="comment">    The console lock must be held when calling this routine.</span>
01024 <span class="comment"></span>
01025 <span class="comment">--*/</span>
01026 
01027 {
01028     ULONG EventsRead;
01029     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01030     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> ResetWaitEvent;
01031 
01032     <span class="keywordflow">if</span> (InputInformation-&gt;In == InputInformation-&gt;Out)  {
01033         <span class="keywordflow">if</span> (!WaitForData) {
01034             *nLength = 0;
01035             <span class="keywordflow">return</span> STATUS_SUCCESS;
01036         }
01037         <a class="code" href="../../d9/d3/input_8h.html#a25">LockReadCount</a>(HandleData);
01038         HandleData-&gt;InputReadData-&gt;ReadCount += 1;
01039         <a class="code" href="../../d9/d3/input_8h.html#a26">UnlockReadCount</a>(HandleData);
01040         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d7/server_2stream_8c.html#a14">WaitForMoreToRead</a>(InputInformation,
01041                                    Message,
01042                                    WaitRoutine,
01043                                    WaitParameter,
01044                                    WaitParameterLength,
01045                                    WaitBlockExists
01046                                   );
01047 
01048         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01049             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != <a class="code" href="../../d1/d7/server_8h.html#a64">CONSOLE_STATUS_WAIT</a>) {
01050                 <span class="comment">/*</span>
01051 <span class="comment">                 * WaitForMoreToRead failed, restore ReadCount and bale out</span>
01052 <span class="comment">                 */</span>
01053                 <a class="code" href="../../d9/d3/input_8h.html#a25">LockReadCount</a>(HandleData);
01054                 HandleData-&gt;InputReadData-&gt;ReadCount -= 1;
01055                 <a class="code" href="../../d9/d3/input_8h.html#a26">UnlockReadCount</a>(HandleData);
01056             }
01057             *nLength = 0;
01058             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01059         }
01060 
01061         <span class="comment">//</span>
01062         <span class="comment">// we will only get to this point if we were called by GetInput.</span>
01063         <span class="comment">//</span>
01064         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>); <span class="comment">// I say we never get here !  IANJA</span>
01065 
01066         <a class="code" href="../../d8/d5/consrv_8h.html#a42">LockConsole</a>(Console);
01067     }
01068 
01069     <span class="comment">//</span>
01070     <span class="comment">// read from buffer</span>
01071     <span class="comment">//</span>
01072 
01073     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a15">ReadBuffer</a>(InputInformation,
01074                         lpBuffer,
01075                         *nLength,
01076                         &amp;EventsRead,
01077                         Peek,
01078                         StreamRead,
01079                         &amp;ResetWaitEvent
01080 #<span class="keywordflow">if</span> defined(FE_SB)
01081                         ,
01082                         <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a>
01083 #endif
01084                        );
01085     <span class="keywordflow">if</span> (ResetWaitEvent) {
01086         <a class="code" href="../../d0/d8/ex_2event_8c.html#a4">NtClearEvent</a>(InputInformation-&gt;InputWaitEvent);
01087     }
01088 
01089     *nLength = EventsRead;
01090     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01091 }
01092 
01093 
01094 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01095"></a><a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a26">01095</a> <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a26">WriteBuffer</a>(
01096     OUT <a class="code" href="../../d7/d2/struct__INPUT__INFORMATION.html">PINPUT_INFORMATION</a> InputInformation,
01097     IN PVOID Buffer,
01098     IN ULONG Length,
01099     OUT PULONG EventsWritten,
01100     OUT PBOOL SetWaitEvent
01101     )
01102 
01103 <span class="comment">/*++</span>
01104 <span class="comment"></span>
01105 <span class="comment">Routine Description:</span>
01106 <span class="comment"></span>
01107 <span class="comment">    This routine writes to a buffer.  It does the actual circular buffer</span>
01108 <span class="comment">    manipulation.</span>
01109 <span class="comment"></span>
01110 <span class="comment">Arguments:</span>
01111 <span class="comment"></span>
01112 <span class="comment">    InputInformation - buffer to write to</span>
01113 <span class="comment"></span>
01114 <span class="comment">    Buffer - buffer to write from</span>
01115 <span class="comment"></span>
01116 <span class="comment">    Length - length of buffer in events</span>
01117 <span class="comment"></span>
01118 <span class="comment">    BytesRead - where to store number of bytes written.</span>
01119 <span class="comment"></span>
01120 <span class="comment">    SetWaitEvent - on exit, TRUE if buffer became non-empty.</span>
01121 <span class="comment"></span>
01122 <span class="comment">Return Value:</span>
01123 <span class="comment"></span>
01124 <span class="comment">    ERROR_BROKEN_PIPE - no more readers.</span>
01125 <span class="comment"></span>
01126 <span class="comment">Note:</span>
01127 <span class="comment"></span>
01128 <span class="comment">    The console lock must be held when calling this routine.</span>
01129 <span class="comment"></span>
01130 <span class="comment">--*/</span>
01131 
01132 {
01133     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01134     ULONG TransferLength;
01135     ULONG BufferLengthInBytes;
01136 <span class="preprocessor">#if defined(FE_SB)</span>
01137 <span class="preprocessor"></span>    <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console = InputInformation-&gt;Console;
01138 <span class="preprocessor">#endif</span>
01139 <span class="preprocessor"></span>
01140     *SetWaitEvent = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01141 
01142     <span class="comment">//</span>
01143     <span class="comment">// windows sends a mouse_move message each time a window is updated.</span>
01144     <span class="comment">// coalesce these.</span>
01145     <span class="comment">//</span>
01146 
01147     <span class="keywordflow">if</span> (Length == 1 &amp;&amp; InputInformation-&gt;Out != InputInformation-&gt;In) {
01148         PINPUT_RECORD InputEvent=<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
01149 
01150         <span class="keywordflow">if</span> (InputEvent-&gt;EventType == MOUSE_EVENT &amp;&amp;
01151             InputEvent-&gt;Event.MouseEvent.dwEventFlags == MOUSE_MOVED) {
01152             PINPUT_RECORD LastInputEvent;
01153 
01154             <span class="keywordflow">if</span> (InputInformation-&gt;In == InputInformation-&gt;First) {
01155                 LastInputEvent = (PINPUT_RECORD) (InputInformation-&gt;Last - <span class="keyword">sizeof</span>(INPUT_RECORD));
01156             }
01157             <span class="keywordflow">else</span> {
01158                 LastInputEvent = (PINPUT_RECORD) (InputInformation-&gt;In - <span class="keyword">sizeof</span>(INPUT_RECORD));
01159             }
01160             <span class="keywordflow">if</span> (LastInputEvent-&gt;EventType == MOUSE_EVENT &amp;&amp;
01161                 LastInputEvent-&gt;Event.MouseEvent.dwEventFlags == MOUSE_MOVED) {
01162                 LastInputEvent-&gt;Event.MouseEvent.dwMousePosition.X =
01163                     InputEvent-&gt;Event.MouseEvent.dwMousePosition.X;
01164                 LastInputEvent-&gt;Event.MouseEvent.dwMousePosition.Y =
01165                     InputEvent-&gt;Event.MouseEvent.dwMousePosition.Y;
01166                 *EventsWritten = 1;
01167                 <span class="keywordflow">return</span> STATUS_SUCCESS;
01168             }
01169         }
01170         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (InputEvent-&gt;EventType == KEY_EVENT &amp;&amp;
01171                  InputEvent-&gt;Event.KeyEvent.bKeyDown) {
01172             PINPUT_RECORD LastInputEvent;
01173             <span class="keywordflow">if</span> (InputInformation-&gt;In == InputInformation-&gt;First) {
01174                 LastInputEvent = (PINPUT_RECORD) (InputInformation-&gt;Last - <span class="keyword">sizeof</span>(INPUT_RECORD));
01175             }
01176             <span class="keywordflow">else</span> {
01177                 LastInputEvent = (PINPUT_RECORD) (InputInformation-&gt;In - <span class="keyword">sizeof</span>(INPUT_RECORD));
01178             }
01179 <span class="preprocessor">#if defined(FE_SB)</span>
01180 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (IsConsoleFullWidth(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o10">hDC</a>,
01181                                    Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o61">CP</a>,InputEvent-&gt;Event.KeyEvent.uChar.UnicodeChar)) {
01182                 ;
01183             }
01184             <span class="keywordflow">else</span>
01185             <span class="keywordflow">if</span> (InputEvent-&gt;Event.KeyEvent.dwControlKeyState &amp; NLS_IME_CONVERSION) {
01186                 <span class="keywordflow">if</span> (LastInputEvent-&gt;EventType == KEY_EVENT &amp;&amp;
01187                     LastInputEvent-&gt;Event.KeyEvent.bKeyDown &amp;&amp;
01188                     (LastInputEvent-&gt;Event.KeyEvent.uChar.UnicodeChar ==
01189                         InputEvent-&gt;Event.KeyEvent.uChar.UnicodeChar) &amp;&amp;
01190                     (LastInputEvent-&gt;Event.KeyEvent.dwControlKeyState ==
01191                         InputEvent-&gt;Event.KeyEvent.dwControlKeyState) ) {
01192                     LastInputEvent-&gt;Event.KeyEvent.wRepeatCount +=
01193                         InputEvent-&gt;Event.KeyEvent.wRepeatCount;
01194                     *EventsWritten = 1;
01195                     <span class="keywordflow">return</span> STATUS_SUCCESS;
01196                 }
01197             }
01198             <span class="keywordflow">else</span>
01199 <span class="preprocessor">#endif</span>
01200 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (LastInputEvent-&gt;EventType == KEY_EVENT &amp;&amp;
01201                 LastInputEvent-&gt;Event.KeyEvent.bKeyDown &amp;&amp;
01202                 (LastInputEvent-&gt;Event.KeyEvent.wVirtualScanCode == <span class="comment">// scancode same</span>
01203                     InputEvent-&gt;Event.KeyEvent.wVirtualScanCode) &amp;&amp;
01204                 (LastInputEvent-&gt;Event.KeyEvent.uChar.UnicodeChar == <span class="comment">// character same</span>
01205                     InputEvent-&gt;Event.KeyEvent.uChar.UnicodeChar) &amp;&amp;
01206                 (LastInputEvent-&gt;Event.KeyEvent.dwControlKeyState == <span class="comment">// ctrl/alt/shift state same</span>
01207                     InputEvent-&gt;Event.KeyEvent.dwControlKeyState) ) {
01208                 LastInputEvent-&gt;Event.KeyEvent.wRepeatCount +=
01209                     InputEvent-&gt;Event.KeyEvent.wRepeatCount;
01210                 *EventsWritten = 1;
01211                 <span class="keywordflow">return</span> STATUS_SUCCESS;
01212             }
01213         }
01214     }
01215 
01216     BufferLengthInBytes = Length*<span class="keyword">sizeof</span>(INPUT_RECORD);
01217     *EventsWritten = 0;
01218     <span class="keywordflow">while</span> (*EventsWritten &lt; Length) {
01219 
01220         <span class="comment">//</span>
01221         <span class="comment">//</span>
01222         <span class="comment">// if out &gt; in, buffer looks like this:</span>
01223         <span class="comment">//</span>
01224         <span class="comment">//             in     out</span>
01225         <span class="comment">//        ______ _____________</span>
01226         <span class="comment">//       |      |      |      |</span>
01227         <span class="comment">//       | data | free | data |</span>
01228         <span class="comment">//       |______|______|______|</span>
01229         <span class="comment">//</span>
01230         <span class="comment">// we can write from in to out-1</span>
01231         <span class="comment">//</span>
01232 
01233         <span class="keywordflow">if</span> (InputInformation-&gt;Out &gt; InputInformation-&gt;In)       {
01234             TransferLength = BufferLengthInBytes;
01235             <span class="keywordflow">if</span>  ((InputInformation-&gt;Out - InputInformation-&gt;In - <span class="keyword">sizeof</span>(INPUT_RECORD))
01236                    &lt; BufferLengthInBytes) {
01237                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a24">SetInputBufferSize</a>(InputInformation,
01238                                             InputInformation-&gt;InputBufferSize+Length+<a class="code" href="../../d9/d3/input_8h.html#a1">INPUT_BUFFER_SIZE_INCREMENT</a>);
01239                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01240                     KdPrint((<span class="stringliteral">"CONSRV: Couldn't grow input buffer, Status == %lX\n"</span>,<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01241                     TransferLength = (ULONG)(InputInformation-&gt;Out - InputInformation-&gt;In - <span class="keyword">sizeof</span>(INPUT_RECORD));
01242                     <span class="keywordflow">if</span> (TransferLength == 0) {
01243                         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01244                     }
01245                 } <span class="keywordflow">else</span> {
01246                     <span class="keywordflow">goto</span> OutPath;   <span class="comment">// after resizing, in &gt; out</span>
01247                 }
01248             }
01249             RtlMoveMemory((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)InputInformation-&gt;In,
01250                           (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
01251                           TransferLength
01252                          );
01253             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = (PVOID) (((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>) <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)+TransferLength);
01254             *EventsWritten += TransferLength/<span class="keyword">sizeof</span>(INPUT_RECORD);
01255             BufferLengthInBytes -= TransferLength;
01256             InputInformation-&gt;In += TransferLength;
01257         }
01258 
01259         <span class="comment">//</span>
01260         <span class="comment">// if in &gt;= out, buffer looks like this:</span>
01261         <span class="comment">//</span>
01262         <span class="comment">//             out     in</span>
01263         <span class="comment">//        ______ _____________</span>
01264         <span class="comment">//       |      |      |      |</span>
01265         <span class="comment">//       | free | data | free |</span>
01266         <span class="comment">//       |______|______|______|</span>
01267         <span class="comment">//</span>
01268         <span class="comment">// we write from the in pointer to the end of the buffer then from the</span>
01269         <span class="comment">// beginning of the buffer, until we hit the out pointer or enough bytes</span>
01270         <span class="comment">// are written.</span>
01271         <span class="comment">//</span>
01272 
01273         <span class="keywordflow">else</span> {
01274             <span class="keywordflow">if</span> (InputInformation-&gt;Out == InputInformation-&gt;In) {
01275                 *SetWaitEvent = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01276             }
01277 OutPath:
01278             <span class="keywordflow">if</span>  ((InputInformation-&gt;Last - InputInformation-&gt;In) &gt; BufferLengthInBytes) {
01279                 TransferLength = BufferLengthInBytes;
01280             }
01281             <span class="keywordflow">else</span> {
01282                 <span class="keywordflow">if</span> (InputInformation-&gt;First == InputInformation-&gt;Out &amp;&amp;
01283                     InputInformation-&gt;In == (InputInformation-&gt;Last-<span class="keyword">sizeof</span>(INPUT_RECORD))) {
01284                     TransferLength = BufferLengthInBytes;
01285                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a24">SetInputBufferSize</a>(InputInformation,
01286                                                 InputInformation-&gt;InputBufferSize+Length+<a class="code" href="../../d9/d3/input_8h.html#a1">INPUT_BUFFER_SIZE_INCREMENT</a>);
01287                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01288                         KdPrint((<span class="stringliteral">"CONSRV: Couldn't grow input buffer, Status == %lX\n"</span>,<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01289                         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01290                     }
01291                 }
01292                 <span class="keywordflow">else</span> {
01293                     TransferLength = (ULONG)(InputInformation-&gt;Last - InputInformation-&gt;In);
01294                     <span class="keywordflow">if</span> (InputInformation-&gt;First == InputInformation-&gt;Out) {
01295                         TransferLength -= <span class="keyword">sizeof</span>(INPUT_RECORD);
01296                     }
01297                 }
01298             }
01299             RtlMoveMemory((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)InputInformation-&gt;In,
01300                           (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
01301                           TransferLength
01302                          );
01303             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = (PVOID) (((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>) <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)+TransferLength);
01304             *EventsWritten += TransferLength/<span class="keyword">sizeof</span>(INPUT_RECORD);
01305             BufferLengthInBytes -= TransferLength;
01306             InputInformation-&gt;In += TransferLength;
01307             <span class="keywordflow">if</span> (InputInformation-&gt;In == InputInformation-&gt;Last) {
01308                 InputInformation-&gt;In = InputInformation-&gt;First;
01309             }
01310         }
01311         <span class="keywordflow">if</span> (TransferLength == 0) {
01312             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01313         }
01314     }
01315     <span class="keywordflow">return</span> STATUS_SUCCESS;
01316 }
01317 
01318 
01319 __inline <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l01320"></a><a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a27">01320</a> <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a27">IsSystemKey</a>(
01321     WORD wVirtualKeyCode
01322     )
01323 {
01324     <span class="keywordflow">switch</span> (wVirtualKeyCode) {
01325     <span class="keywordflow">case</span> VK_SHIFT:
01326     <span class="keywordflow">case</span> VK_CONTROL:
01327     <span class="keywordflow">case</span> VK_MENU:
01328     <span class="keywordflow">case</span> VK_PAUSE:
01329     <span class="keywordflow">case</span> VK_CAPITAL:
01330     <span class="keywordflow">case</span> VK_LWIN:
01331     <span class="keywordflow">case</span> VK_RWIN:
01332     <span class="keywordflow">case</span> VK_NUMLOCK:
01333     <span class="keywordflow">case</span> VK_SCROLL:
01334         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01335     }
01336     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01337 }
01338 
01339 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>
<a name="l01340"></a><a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a28">01340</a> <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a28">PreprocessInput</a>(
01341     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
01342     IN PINPUT_RECORD InputEvent,
01343     IN DWORD nLength
01344     )
01345 
01346 <span class="comment">/*++</span>
01347 <span class="comment"></span>
01348 <span class="comment">Routine Description:</span>
01349 <span class="comment"></span>
01350 <span class="comment">    This routine processes special characters in the input stream.</span>
01351 <span class="comment"></span>
01352 <span class="comment">Arguments:</span>
01353 <span class="comment"></span>
01354 <span class="comment">    Console - Pointer to console structure.</span>
01355 <span class="comment"></span>
01356 <span class="comment">    InputEvent - Buffer to write from.</span>
01357 <span class="comment"></span>
01358 <span class="comment">    nLength - Number of events to write.</span>
01359 <span class="comment"></span>
01360 <span class="comment">Return Value:</span>
01361 <span class="comment"></span>
01362 <span class="comment">    Number of events to write after special characters have been stripped.</span>
01363 <span class="comment"></span>
01364 <span class="comment">Note:</span>
01365 <span class="comment"></span>
01366 <span class="comment">    The console lock must be held when calling this routine.</span>
01367 <span class="comment"></span>
01368 <span class="comment">--*/</span>
01369 
01370 {
01371     ULONG NumEvents;
01372 
01373 
01374     <span class="keywordflow">for</span> (NumEvents = nLength; NumEvents != 0; NumEvents--) {
01375         <span class="keywordflow">if</span> (InputEvent-&gt;EventType == KEY_EVENT &amp;&amp; InputEvent-&gt;Event.KeyEvent.bKeyDown) {
01376             <span class="comment">//</span>
01377             <span class="comment">// if output is suspended, any keyboard input releases it.</span>
01378             <span class="comment">//</span>
01379 
01380             <span class="keywordflow">if</span> ((Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a25">CONSOLE_SUSPENDED</a>) &amp;&amp;
01381                 !<a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a27">IsSystemKey</a>(InputEvent-&gt;Event.KeyEvent.wVirtualKeyCode)) {
01382 
01383                 <a class="code" href="../../d0/d7/server_2stream_8c.html#a30">UnblockWriteConsole</a>(Console, <a class="code" href="../../d1/d7/server_8h.html#a1">CONSOLE_OUTPUT_SUSPENDED</a>);
01384                 RtlMoveMemory(InputEvent, InputEvent + 1, (NumEvents - 1) * <span class="keyword">sizeof</span>(INPUT_RECORD));
01385                 nLength--;
01386                 <span class="keywordflow">continue</span>;
01387             }
01388 
01389             <span class="comment">//</span>
01390             <span class="comment">// intercept control-s</span>
01391             <span class="comment">//</span>
01392 
01393             <span class="keywordflow">if</span> ((Console-&gt;InputBuffer.InputMode &amp; ENABLE_LINE_INPUT) &amp;&amp;
01394                     (InputEvent-&gt;Event.KeyEvent.wVirtualKeyCode == VK_PAUSE ||
01395                      <a class="code" href="../../d4/d1/cmdline_8h.html#a64">IsPauseKey</a>(&amp;InputEvent-&gt;Event.KeyEvent))) {
01396 
01397                 Console-&gt;Flags |= <a class="code" href="../../d1/d7/server_8h.html#a1">CONSOLE_OUTPUT_SUSPENDED</a>;
01398                 RtlMoveMemory(InputEvent, InputEvent + 1, (NumEvents - 1) * <span class="keyword">sizeof</span>(INPUT_RECORD));
01399                 nLength--;
01400                 <span class="keywordflow">continue</span>;
01401             }
01402         }
01403         InputEvent++;
01404     }
01405     <span class="keywordflow">return</span> nLength;
01406 }
01407 
01408 
01409 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>
<a name="l01410"></a><a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a29">01410</a> <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a29">PrependInputBuffer</a>(
01411     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
01412     IN <a class="code" href="../../d7/d2/struct__INPUT__INFORMATION.html">PINPUT_INFORMATION</a> InputInformation,
01413     IN PINPUT_RECORD lpBuffer,
01414     IN DWORD nLength
01415     )
01416 
01417 <span class="comment">/*++</span>
01418 <span class="comment"></span>
01419 <span class="comment">Routine Description:</span>
01420 <span class="comment"></span>
01421 <span class="comment">    This routine writes to the beginning of the input buffer.</span>
01422 <span class="comment"></span>
01423 <span class="comment">Arguments:</span>
01424 <span class="comment"></span>
01425 <span class="comment">    InputInformation - Pointer to input buffer information structure.</span>
01426 <span class="comment"></span>
01427 <span class="comment">    lpBuffer - Buffer to write from.</span>
01428 <span class="comment"></span>
01429 <span class="comment">    nLength - On input, number of events to write.  On output, number of</span>
01430 <span class="comment">    events written.</span>
01431 <span class="comment"></span>
01432 <span class="comment">Return Value:</span>
01433 <span class="comment"></span>
01434 <span class="comment">Note:</span>
01435 <span class="comment"></span>
01436 <span class="comment">    The console lock must be held when calling this routine.</span>
01437 <span class="comment"></span>
01438 <span class="comment">--*/</span>
01439 
01440 {
01441     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01442     ULONG EventsWritten,EventsRead;
01443     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> SetWaitEvent;
01444     ULONG NumExistingEvents;
01445     PINPUT_RECORD pExistingEvents;
01446     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> Dummy;
01447 
01448     nLength = <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a28">PreprocessInput</a>(Console, lpBuffer, nLength);
01449     <span class="keywordflow">if</span> (nLength == 0) {
01450         <span class="keywordflow">return</span> 0;
01451     }
01452 
01453     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a21">GetNumberOfReadyEvents</a>(InputInformation,
01454                                     &amp;NumExistingEvents
01455                                    );
01456 
01457     <span class="keywordflow">if</span> (NumExistingEvents) {
01458 
01459         pExistingEvents = <a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a17">BUFFER_TAG</a> ),NumExistingEvents * <span class="keyword">sizeof</span>(INPUT_RECORD));
01460         <span class="keywordflow">if</span> (pExistingEvents == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01461             <span class="keywordflow">return</span> (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)STATUS_NO_MEMORY;
01462         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a15">ReadBuffer</a>(InputInformation,
01463                             pExistingEvents,
01464                             NumExistingEvents,
01465                             &amp;EventsRead,
01466                             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01467                             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01468                             &amp;Dummy
01469 #<span class="keywordflow">if</span> defined(FE_SB)
01470                             ,
01471                             <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
01472 #endif
01473                            );
01474 
01475         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01476             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(pExistingEvents);
01477             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01478         }
01479     } <span class="keywordflow">else</span> {
01480         pExistingEvents = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01481     }
01482 
01483     <span class="comment">//</span>
01484     <span class="comment">// write new info to buffer</span>
01485     <span class="comment">//</span>
01486 
01487     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a26">WriteBuffer</a>(InputInformation,
01488                          lpBuffer,
01489                          nLength,
01490                          &amp;EventsWritten,
01491                          &amp;SetWaitEvent
01492                         );
01493 
01494     <span class="comment">//</span>
01495     <span class="comment">// write existing info to buffer</span>
01496     <span class="comment">//</span>
01497 
01498     <span class="keywordflow">if</span> (pExistingEvents) {
01499         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a26">WriteBuffer</a>(InputInformation,
01500                              pExistingEvents,
01501                              EventsRead,
01502                              &amp;EventsWritten,
01503                              &amp;Dummy
01504                             );
01505         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(pExistingEvents);
01506     }
01507 
01508     <span class="keywordflow">if</span> (SetWaitEvent) {
01509         <a class="code" href="../../d0/d8/ex_2event_8c.html#a10">NtSetEvent</a>(InputInformation-&gt;InputWaitEvent,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01510     }
01511 
01512     <span class="comment">//</span>
01513     <span class="comment">// alert any writers waiting for space</span>
01514     <span class="comment">//</span>
01515 
01516     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a20">WakeUpReadersWaitingForData</a>(Console,InputInformation);
01517 
01518     <span class="keywordflow">return</span> nLength;
01519 }
01520 
01521 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>
<a name="l01522"></a><a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a30">01522</a> <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a30">WriteInputBuffer</a>(
01523     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
01524     IN <a class="code" href="../../d7/d2/struct__INPUT__INFORMATION.html">PINPUT_INFORMATION</a> InputInformation,
01525     IN PINPUT_RECORD lpBuffer,
01526     IN DWORD nLength
01527     )
01528 
01529 <span class="comment">/*++</span>
01530 <span class="comment"></span>
01531 <span class="comment">Routine Description:</span>
01532 <span class="comment"></span>
01533 <span class="comment">    This routine writes to the input buffer.</span>
01534 <span class="comment"></span>
01535 <span class="comment">Arguments:</span>
01536 <span class="comment"></span>
01537 <span class="comment">    InputInformation - Pointer to input buffer information structure.</span>
01538 <span class="comment"></span>
01539 <span class="comment">    lpBuffer - Buffer to write from.</span>
01540 <span class="comment"></span>
01541 <span class="comment">    nLength - On input, number of events to write.  On output, number of</span>
01542 <span class="comment">    events written.</span>
01543 <span class="comment"></span>
01544 <span class="comment">Return Value:</span>
01545 <span class="comment"></span>
01546 <span class="comment">Note:</span>
01547 <span class="comment"></span>
01548 <span class="comment">    The console lock must be held when calling this routine.</span>
01549 <span class="comment"></span>
01550 <span class="comment">--*/</span>
01551 
01552 {
01553     ULONG EventsWritten;
01554     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> SetWaitEvent;
01555 
01556     nLength = <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a28">PreprocessInput</a>(Console, lpBuffer, nLength);
01557     <span class="keywordflow">if</span> (nLength == 0) {
01558         <span class="keywordflow">return</span> 0;
01559     }
01560 
01561     <span class="comment">//</span>
01562     <span class="comment">// write to buffer</span>
01563     <span class="comment">//</span>
01564 
01565     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a26">WriteBuffer</a>(InputInformation,
01566                 lpBuffer,
01567                 nLength,
01568                 &amp;EventsWritten,
01569                 &amp;SetWaitEvent
01570                 );
01571 
01572     <span class="keywordflow">if</span> (SetWaitEvent) {
01573         <a class="code" href="../../d0/d8/ex_2event_8c.html#a10">NtSetEvent</a>(InputInformation-&gt;InputWaitEvent,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01574     }
01575 
01576     <span class="comment">//</span>
01577     <span class="comment">// alert any writers waiting for space</span>
01578     <span class="comment">//</span>
01579 
01580     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a20">WakeUpReadersWaitingForData</a>(Console,InputInformation);
01581 
01582 
01583     <span class="keywordflow">return</span> EventsWritten;
01584 }
01585 
01586 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01587"></a><a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a31">01587</a> <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a31">StoreKeyInfo</a>(
01588     IN PMSG msg
01589     )
01590 {
01591     <span class="keywordtype">int</span> i;
01592 
01593     <span class="keywordflow">for</span> (i=0;i&lt;<a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a3">CONSOLE_MAX_KEY_INFO</a>;i++) {
01594         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a10">ConsoleKeyInfo</a>[i].<a class="code" href="../../d3/d3/struct__CONSOLE__KEY__INFO.html#o0">hWnd</a> == <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a2">CONSOLE_FREE_KEY_INFO</a> ||
01595             <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a10">ConsoleKeyInfo</a>[i].<a class="code" href="../../d3/d3/struct__CONSOLE__KEY__INFO.html#o0">hWnd</a> == <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>-&gt;hwnd) {
01596             <span class="keywordflow">break</span>;
01597         }
01598     }
01599     <span class="keywordflow">if</span> (i!=<a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a3">CONSOLE_MAX_KEY_INFO</a>) {
01600         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a10">ConsoleKeyInfo</a>[i].<a class="code" href="../../d3/d3/struct__CONSOLE__KEY__INFO.html#o0">hWnd</a> = <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>-&gt;hwnd;
01601         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a10">ConsoleKeyInfo</a>[i].<a class="code" href="../../d3/d3/struct__CONSOLE__KEY__INFO.html#o1">wVirtualKeyCode</a> = LOWORD(<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>-&gt;wParam);
01602         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a10">ConsoleKeyInfo</a>[i].<a class="code" href="../../d3/d3/struct__CONSOLE__KEY__INFO.html#o2">wVirtualScanCode</a> = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)(HIWORD(<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>-&gt;lParam));
01603     } <span class="keywordflow">else</span> {
01604         KdPrint((<span class="stringliteral">"CONSRV: ConsoleKeyInfo buffer is full\n"</span>));
01605     }
01606 }
01607 
01608 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01609"></a><a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a32">01609</a> <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a32">RetrieveKeyInfo</a>(
01610     IN HWND hWnd,
01611     OUT PWORD pwVirtualKeyCode,
01612     OUT PWORD pwVirtualScanCode,
01613     IN BOOL FreeKeyInfo
01614     )
01615 {
01616     <span class="keywordtype">int</span> i;
01617 
01618     <span class="keywordflow">for</span> (i=0;i&lt;<a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a3">CONSOLE_MAX_KEY_INFO</a>;i++) {
01619         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a10">ConsoleKeyInfo</a>[i].<a class="code" href="../../d3/d3/struct__CONSOLE__KEY__INFO.html#o0">hWnd</a> == <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>) {
01620             <span class="keywordflow">break</span>;
01621         }
01622     }
01623     <span class="keywordflow">if</span> (i!=<a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a3">CONSOLE_MAX_KEY_INFO</a>) {
01624         *pwVirtualKeyCode = <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a10">ConsoleKeyInfo</a>[i].<a class="code" href="../../d3/d3/struct__CONSOLE__KEY__INFO.html#o1">wVirtualKeyCode</a>;
01625         *pwVirtualScanCode = <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a10">ConsoleKeyInfo</a>[i].<a class="code" href="../../d3/d3/struct__CONSOLE__KEY__INFO.html#o2">wVirtualScanCode</a>;
01626         <span class="keywordflow">if</span> (FreeKeyInfo)
01627             <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a10">ConsoleKeyInfo</a>[i].<a class="code" href="../../d3/d3/struct__CONSOLE__KEY__INFO.html#o0">hWnd</a> = <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a2">CONSOLE_FREE_KEY_INFO</a>;
01628     } <span class="keywordflow">else</span> {
01629         *pwVirtualKeyCode = (WORD)<a class="code" href="../../d0/d8/ntcftxt_8h.html#a18">MapVirtualKey</a>(*pwVirtualScanCode, 3);
01630     }
01631 }
01632 
01633 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01634"></a><a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a33">01634</a> <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a33">ClearKeyInfo</a>(
01635     IN HWND hWnd
01636     )
01637 {
01638     <span class="keywordtype">int</span> i;
01639 
01640     <span class="keywordflow">for</span> (i=0;i&lt;<a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a3">CONSOLE_MAX_KEY_INFO</a>;i++) {
01641         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a10">ConsoleKeyInfo</a>[i].<a class="code" href="../../d3/d3/struct__CONSOLE__KEY__INFO.html#o0">hWnd</a> == <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>) {
01642             <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a10">ConsoleKeyInfo</a>[i].<a class="code" href="../../d3/d3/struct__CONSOLE__KEY__INFO.html#o0">hWnd</a> = <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a2">CONSOLE_FREE_KEY_INFO</a>;
01643         }
01644     }
01645 }
01646 
01647 
01648 <span class="comment">/***************************************************************************\</span>
01649 <span class="comment">* ProcessCreateConsoleWindow</span>
01650 <span class="comment">*</span>
01651 <span class="comment">* This routine processes a CM_CREATE_CONSOLE_WINDOW message. It is called</span>
01652 <span class="comment">* from the InputThread message loop under normal circumstances and from</span>
01653 <span class="comment">* the DialogHookProc if we have a dialog box up. The USER critical section</span>
01654 <span class="comment">* should not be held when calling this routine.</span>
01655 <span class="comment">\***************************************************************************/</span>
01656 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01657"></a><a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a34">01657</a> <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a34">ProcessCreateConsoleWindow</a>(
01658     IN LPMSG lpMsg
01659     )
01660 {
01661     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01662     <span class="comment">// make sure this is a valid message</span>
01663     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> pConsole;
01664 
01665     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a34">RevalidateConsole</a>((HANDLE)lpMsg-&gt;wParam, &amp;pConsole))) {
01666 
01667         <span class="comment">//</span>
01668         <span class="comment">// Make sure the console doesn't already have a window.</span>
01669         <span class="comment">//</span>
01670 
01671         <span class="keywordflow">if</span> (pConsole-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o8">hWnd</a>) {
01672             RIPMSG1(RIP_WARNING, <span class="stringliteral">"Console %#p already has a window"</span>, pConsole);
01673             <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(pConsole);
01674             <span class="keywordflow">return</span>;
01675         }
01676 
01677         pConsole-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o75">InputThreadInfo</a> = TlsGetValue(<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a15">InputThreadTlsIndex</a>);
01678         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"Before CreateWindowsWindow cWindows = %d\n"</span>,
01679                   pConsole-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o75">InputThreadInfo</a>-&gt;<a class="code" href="../../d9/d2/struct__INPUT__THREAD__INFO.html#o3">WindowCount</a>));
01680 
01681         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d2/output_8c.html#a45">CreateWindowsWindow</a>(pConsole);
01682         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"After  CreateWindowsWindow cWindows = %d\n"</span>,
01683                   pConsole-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o75">InputThreadInfo</a>-&gt;<a class="code" href="../../d9/d2/struct__INPUT__THREAD__INFO.html#o3">WindowCount</a>));
01684         <span class="keywordflow">switch</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) {
01685         <span class="keywordflow">case</span> STATUS_SUCCESS:
01686 
01687             <span class="comment">//</span>
01688             <span class="comment">// If we changed the screen buffer size, let the user know about it</span>
01689             <span class="comment">// with a message box. Make sure we don't recurse too deeply in</span>
01690             <span class="comment">// this code by limiting the number of message boxes on the screen</span>
01691             <span class="comment">// at once. If there are already a bunch up there, the user should</span>
01692             <span class="comment">// have the idea by now anyway.</span>
01693             <span class="comment">//</span>
01694 
01695             <span class="keywordflow">if</span> ((pConsole-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a24">CONSOLE_DEFAULT_BUFFER_SIZE</a>) &amp;&amp; (<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a9">DialogBoxCount</a> &lt; 8)) {
01696                 WCHAR ItemString[120];
01697                 WCHAR Title[120];
01698                 HWND <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a> = pConsole-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o8">hWnd</a>;
01699                 ULONG TitleLength = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(<span class="keyword">sizeof</span>(Title)-<span class="keyword">sizeof</span>(WCHAR), pConsole-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o26">TitleLength</a>);
01700                 RtlCopyMemory(Title, pConsole-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o28">Title</a>, TitleLength);
01701                 Title[TitleLength/<span class="keyword">sizeof</span>(WCHAR)] = 0;
01702                 <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(pConsole);
01703                 LoadString(<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a4">ghInstance</a>,<a class="code" href="../../d6/d7/menu_8h.html#a0">msgBufferTooBig</a>,ItemString,<a class="code" href="../../d2/d3/tnlsxlat_8c.html#a0">NELEM</a>(ItemString));
01704                 <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a9">DialogBoxCount</a>++;
01705                 MessageBox(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, ItemString, Title, MB_OK);
01706                 <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a9">DialogBoxCount</a>--;
01707                 <span class="keywordflow">break</span>;
01708             }
01709             <span class="comment">// FALL THRU</span>
01710         <span class="keywordflow">case</span> STATUS_NO_MEMORY:
01711             <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(pConsole);
01712             <span class="keywordflow">break</span>;
01713         <span class="keywordflow">case</span> STATUS_INVALID_HANDLE:
01714             <span class="comment">// Console is gone, don't do anything.</span>
01715             <span class="keywordflow">break</span>;
01716         <span class="keywordflow">default</span>:
01717             KdPrint((<span class="stringliteral">"CONSRV: CreateWindowsWindow returned %x\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01718             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01719             <span class="keywordflow">break</span>;
01720         }
01721     }
01722 }
01723 
01724 
01725 LRESULT
<a name="l01726"></a><a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a35">01726</a> <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a35">DialogHookProc</a>(
01727     <span class="keywordtype">int</span> nCode,
01728     WPARAM wParam,
01729     LPARAM lParam
01730     )
01731 
01732 <span class="comment">// this routine gets called to filter input to console dialogs so</span>
01733 <span class="comment">// that we can do the special processing that StoreKeyInfo does.</span>
01734 
01735 {
01736     MSG *pmsg = (PMSG)lParam;
01737 
01738     UNREFERENCED_PARAMETER(wParam);
01739 
01740     <span class="keywordflow">if</span> (pmsg-&gt;message == <a class="code" href="../../d1/d7/server_8h.html#a67">CM_CREATE_CONSOLE_WINDOW</a>) {
01741         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a34">ProcessCreateConsoleWindow</a>(pmsg);
01742         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01743     }
01744 
01745     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/consrv_8h.html#a33">CONSOLE_IS_IME_ENABLED</a>()) {
01746         <span class="keywordflow">if</span> (pmsg-&gt;message == <a class="code" href="../../d1/d7/server_8h.html#a77">CM_CONSOLE_INPUT_THREAD_MSG</a>) {
01747             <a class="code" href="../../d9/d2/struct__INPUT__THREAD__INFO.html">PINPUT_THREAD_INFO</a> pThreadInfo = TlsGetValue(<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a15">InputThreadTlsIndex</a>);
01748             MSG <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>;
01749 
01750             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pThreadInfo);
01751 
01752             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a40">UnqueueThreadMessage</a>(pThreadInfo-&gt;<a class="code" href="../../d9/d2/struct__INPUT__THREAD__INFO.html#o1">ThreadId</a>, &amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message, &amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.wParam, &amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.lParam)) {
01753                 RIPMSG3(RIP_WARNING, <span class="stringliteral">"DialogHookProc: %04x (%08x, %08x)"</span>, <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message, <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.wParam, <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.lParam);
01754                 <span class="keywordflow">switch</span> (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message) {
01755                 <span class="keywordflow">case</span> CM_CONIME_CREATE:
01756                     ProcessCreateConsoleIME(&amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, pThreadInfo-&gt;<a class="code" href="../../d9/d2/struct__INPUT__THREAD__INFO.html#o1">ThreadId</a>);
01757                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01758                 <span class="keywordflow">case</span> CM_WAIT_CONIME_PROCESS:
01759                     WaitConsoleIMEStuff((HDESK)<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.wParam, (HANDLE)<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.lParam);
01760                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01761                 <span class="keywordflow">case</span> CM_SET_CONSOLEIME_WINDOW:
01762                     pThreadInfo-&gt;hWndConsoleIME = (HWND)<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.wParam;
01763                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01764                 <span class="keywordflow">default</span>:
01765                     RIPMSG1(RIP_WARNING, <span class="stringliteral">"DialogHookProc: invalid thread message(%04x) !!"</span>, <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message);
01766                     <span class="keywordflow">break</span>;
01767                 }
01768             }
01769             <span class="keywordflow">else</span> {
01770                 RIPMSG0(RIP_WARNING, <span class="stringliteral">"DialogHookProc: bogus thread message is posted. ignored"</span>);
01771             }
01772         }
01773     }
01774 
01775     <span class="keywordflow">if</span> (nCode == MSGF_DIALOGBOX) {
01776         <span class="keywordflow">if</span> (pmsg-&gt;message &gt;= WM_KEYFIRST &amp;&amp;
01777             pmsg-&gt;message &lt;= WM_KEYLAST) {
01778             <span class="keywordflow">if</span> (pmsg-&gt;message != WM_CHAR &amp;&amp;
01779                 pmsg-&gt;message != WM_DEADCHAR &amp;&amp;
01780                 pmsg-&gt;message != WM_SYSCHAR &amp;&amp;
01781                 pmsg-&gt;message != WM_SYSDEADCHAR) {
01782 
01783                 <span class="comment">// don't store key info if dialog box input</span>
01784                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d9/cltxt_8h.html#a11">GetWindowLongPtr</a>(pmsg-&gt;hwnd, GWLP_HWNDPARENT) == 0) {
01785                     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a31">StoreKeyInfo</a>(pmsg);
01786                 }
01787             }
01788         }
01789     }
01790     <span class="keywordflow">return</span> 0;
01791 }
01792 
01793 <span class="preprocessor">#undef DbgPrint  // Need this to build on free systems</span>
01794 <span class="preprocessor"></span>
<a name="l01795"></a><a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a36">01795</a> ULONG <a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a2">InputExceptionFilter</a>(
01796     PEXCEPTION_POINTERS pexi)
01797 {
01798     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01799     SYSTEM_KERNEL_DEBUGGER_INFORMATION KernelDebuggerInfo;
01800 
01801     <span class="keywordflow">if</span> (pexi-&gt;ExceptionRecord-&gt;ExceptionCode != STATUS_PORT_DISCONNECTED) {
01802         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d8/sysinfo_8c.html#a49">NtQuerySystemInformation</a>( SystemKernelDebuggerInformation,
01803                                            &amp;KernelDebuggerInfo,
01804                                            <span class="keyword">sizeof</span>(KernelDebuggerInfo),
01805                                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01806                                          );
01807 
01808         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) &amp;&amp; KernelDebuggerInfo.KernelDebuggerEnabled) {
01809             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Unhandled Exception hit in csrss.exe InputExceptionFilter\n"</span>);
01810             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"first, enter !exr %p for the exception record\n"</span>, pexi-&gt;ExceptionRecord);
01811             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"next, enter !cxr %p for the context\n"</span>, pexi-&gt;ContextRecord);
01812             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"then !kb to get the faulting stack\n"</span>);
01813             DbgBreakPoint();
01814         }
01815     }
01816 
01817     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>;
01818 }
01819 
01821 <span class="comment">// Input Thread internal Message Queue:</span>
01822 <span class="comment">// Mainly used for Console IME stuff</span>
01824 <span class="comment"></span>
<a name="l01825"></a><a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a11">01825</a> LIST_ENTRY <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a11">gInputThreadMsg</a>;
<a name="l01826"></a><a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a12">01826</a> CRITICAL_SECTION <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a28">gInputThreadMsgLock</a>;
01827 
01828 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01829"></a><a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a37">01829</a> <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a37">InitializeThreadMessages</a>()
01830 {
01831     RtlEnterCriticalSection(&amp;<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a28">gInputThreadMsgLock</a>);
01832     InitializeListHead(&amp;<a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a11">gInputThreadMsg</a>);
01833     RtlLeaveCriticalSection(&amp;<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a28">gInputThreadMsgLock</a>);
01834 }
01835 
01836 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01837"></a><a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a38">01837</a> <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a38">CleanupInputThreadMessages</a>(
01838     DWORD dwThreadId)
01839 {
01840     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> message;
01841     WPARAM wParam;
01842     LPARAM lParam;
01843 
01844     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(dwThreadId);
01845 
01846     <span class="keywordflow">while</span> (<a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a40">UnqueueThreadMessage</a>(dwThreadId, &amp;message, &amp;wParam, &amp;lParam)) {
01847         RIPMSG3(RIP_WARNING, <span class="stringliteral">"CleanupInputThreadMessages: %04x (%08x, %08x)"</span>, message, wParam, lParam);
01848     }
01849 }
01850 
01851 <span class="comment">//</span>
01852 <span class="comment">// QueueThreadMessage</span>
01853 <span class="comment">//</span>
01854 <span class="comment">// Posts a message to Input Thread, specified by dwThreadId.</span>
01855 <span class="comment">// CM_CONSOLE_INPUT_THEAD_MSG is used as a stub message. Actual parameters are</span>
01856 <span class="comment">// stored in gInputThreadMsg. Input thread should call UnqueueThreadMessage</span>
01857 <span class="comment">// when it gets CM_CONSOLE_INPUT_THREAD_MSG.</span>
01858 <span class="comment">//</span>
01859 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01860"></a><a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a39">01860</a> <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a39">QueueThreadMessage</a>(
01861     DWORD dwThreadId,
01862     UINT message,
01863     WPARAM wParam,
01864     LPARAM lParam)
01865 {
01866     <a class="code" href="../../d1/d7/struct__CONSOLE__THREAD__MSG.html">PCONSOLE_THREAD_MSG</a> pConMsg;
01867 
01868     <span class="comment">// NOTE HIROYAMA: change this to RIP_VERBOSE</span>
01869     RIPMSG4(RIP_VERBOSE, <span class="stringliteral">"QueueThreadMessage: TID=%08x msg:%04x (%08x, %08x)"</span>,
01870             dwThreadId, message, wParam, lParam);
01871 
01872     pConMsg = <a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>(<a class="code" href="../../d8/d5/consrv_8h.html#a9">TMP_TAG</a>), <span class="keyword">sizeof</span> *pConMsg);
01873     <span class="keywordflow">if</span> (pConMsg == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01874         RIPMSG0(RIP_WARNING, <span class="stringliteral">"QueueThreadMessage: failed to allocate pConMsg"</span>);
01875         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01876     }
01877 
01878     pConMsg-&gt;dwThreadId = dwThreadId;
01879     pConMsg-&gt;Message = message;
01880     pConMsg-&gt;wParam = wParam;
01881     pConMsg-&gt;lParam = lParam;
01882 
01883     RtlEnterCriticalSection(&amp;<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a28">gInputThreadMsgLock</a>);
01884     InsertHeadList(&amp;<a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a11">gInputThreadMsg</a>, &amp;pConMsg-&gt;ListLink);
01885     RtlLeaveCriticalSection(&amp;<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a28">gInputThreadMsgLock</a>);
01886 
01887     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d8/ntcftxt_8h.html#a21">PostThreadMessage</a>(dwThreadId, <a class="code" href="../../d1/d7/server_8h.html#a77">CM_CONSOLE_INPUT_THREAD_MSG</a>, 0, 0)) {
01888         RIPMSG1(RIP_WARNING, <span class="stringliteral">"QueueThreadMessage: failed to post thread msg(%04x)"</span>, message);
01889         RtlEnterCriticalSection(&amp;<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a28">gInputThreadMsgLock</a>);
01890         RemoveEntryList(&amp;pConMsg-&gt;ListLink);
01891         RtlLeaveCriticalSection(&amp;<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a28">gInputThreadMsgLock</a>);
01892         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(pConMsg);
01893         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
01894     }
01895 
01896     <span class="keywordflow">return</span> STATUS_SUCCESS;
01897 }
01898 
01899 <span class="comment">//</span>
01900 <span class="comment">// UnqueueThreadMessage</span>
01901 <span class="comment">//</span>
01902 <span class="comment">// return value:</span>
01903 <span class="comment">//  TRUE  -- a message found.</span>
01904 <span class="comment">//  FALSE -- no message for dwThreadId found.</span>
01905 <span class="comment">//</span>
<a name="l01906"></a><a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a40">01906</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a40">UnqueueThreadMessage</a>(
01907     DWORD dwThreadId,
01908     UINT* pMessage,
01909     WPARAM* pwParam,
01910     LPARAM* plParam)
01911 {
01912     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fResult = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;       <span class="comment">// if message is found, set this to TRUE</span>
01913     PLIST_ENTRY pEntry;
01914 
01915     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(dwThreadId);
01916 
01917     RtlEnterCriticalSection(&amp;<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a28">gInputThreadMsgLock</a>);
01918 
01919     <span class="comment">//</span>
01920     <span class="comment">// Search for dwThreadId message from the tail of the queue.</span>
01921     <span class="comment">//</span>
01922     pEntry = <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a11">gInputThreadMsg</a>.Blink;
01923 
01924     <span class="keywordflow">while</span> (pEntry != &amp;<a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a11">gInputThreadMsg</a>) {
01925         <a class="code" href="../../d1/d7/struct__CONSOLE__THREAD__MSG.html">PCONSOLE_THREAD_MSG</a> pConMsg = CONTAINING_RECORD(pEntry, <a class="code" href="../../d1/d7/struct__CONSOLE__THREAD__MSG.html">CONSOLE_THREAD_MSG</a>, ListLink);
01926 
01927         <span class="keywordflow">if</span> (pConMsg-&gt;<a class="code" href="../../d1/d7/struct__CONSOLE__THREAD__MSG.html#o1">dwThreadId</a> == dwThreadId) {
01928             *pMessage = pConMsg-&gt;Message;
01929             *pwParam = pConMsg-&gt;wParam;
01930             *plParam = pConMsg-&gt;lParam;
01931 
01932             RemoveEntryList(pEntry);
01933             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(pConMsg);
01934             fResult = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01935             <span class="keywordflow">break</span>;
01936         }
01937         pEntry = pEntry-&gt;Blink;
01938     }
01939 
01940     RtlLeaveCriticalSection(&amp;<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a28">gInputThreadMsgLock</a>);
01941 
01942     <span class="keywordflow">return</span> fResult;
01943 }
01944 
01945 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01946"></a><a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a41">01946</a> <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a41">ConsoleInputThread</a>(
01947     <a class="code" href="../../d0/d3/struct__INPUT__THREAD__INIT__INFO.html">PINPUT_THREAD_INIT_INFO</a> pInputThreadInitInfo)
01948 {
01949     MSG <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>;
01950     PTEB Teb;
01951     PCSR_THREAD pcsrt = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01952     <a class="code" href="../../d9/d2/struct__INPUT__THREAD__INFO.html">INPUT_THREAD_INFO</a> ThreadInfo;
01953     <span class="keywordtype">int</span> i;
01954     HANDLE hThread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01955     HHOOK hhook = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01956     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fQuit = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01957     CONSOLEDESKTOPCONSOLETHREAD ConsoleDesktopInfo;
01958     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01959 
01960     <span class="comment">//</span>
01961     <span class="comment">// Initialize GDI accelerators.</span>
01962     <span class="comment">//</span>
01963 
01964     Teb = NtCurrentTeb();
01965 
01966     <span class="keywordflow">try</span> {
01967 
01968         <span class="comment">/*</span>
01969 <span class="comment">         * Set this thread's desktop to the one we just created/opened.</span>
01970 <span class="comment">         * When the very first app is loaded, the desktop hasn't been</span>
01971 <span class="comment">         * created yet so the above call might fail.  Make sure we don't</span>
01972 <span class="comment">         * accidentally call SetThreadDesktop with a NULL pdesk.  The</span>
01973 <span class="comment">         * first app will create the desktop and open it for itself.</span>
01974 <span class="comment">         */</span>
01975         ThreadInfo.<a class="code" href="../../d9/d2/struct__INPUT__THREAD__INFO.html#o2">Desktop</a> = pInputThreadInitInfo-&gt;<a class="code" href="../../d0/d3/struct__INPUT__THREAD__INIT__INFO.html#o2">DesktopHandle</a>;
01976         ThreadInfo.<a class="code" href="../../d9/d2/struct__INPUT__THREAD__INFO.html#o3">WindowCount</a> = 0;
01977         ThreadInfo.<a class="code" href="../../d9/d2/struct__INPUT__THREAD__INFO.html#o0">ThreadHandle</a> = pInputThreadInitInfo-&gt;<a class="code" href="../../d0/d3/struct__INPUT__THREAD__INIT__INFO.html#o0">ThreadHandle</a>;
01978         ThreadInfo.<a class="code" href="../../d9/d2/struct__INPUT__THREAD__INFO.html#o1">ThreadId</a> = HandleToUlong(Teb-&gt;ClientId.UniqueThread);
01979 <span class="preprocessor">#if defined(FE_IME)</span>
01980 <span class="preprocessor"></span>        ThreadInfo.hWndConsoleIME = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01981 <span class="preprocessor">#endif</span>
01982 <span class="preprocessor"></span>        TlsSetValue(<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a15">InputThreadTlsIndex</a>, &amp;ThreadInfo);
01983         ConsoleDesktopInfo.hdesk = pInputThreadInitInfo-&gt;<a class="code" href="../../d0/d3/struct__INPUT__THREAD__INIT__INFO.html#o2">DesktopHandle</a>;
01984         ConsoleDesktopInfo.dwThreadId = HandleToUlong(Teb-&gt;ClientId.UniqueThread);
01985         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a86">NtUserConsoleControl</a>(ConsoleDesktopConsoleThread, &amp;ConsoleDesktopInfo,
01986                 <span class="keyword">sizeof</span>(ConsoleDesktopInfo));
01987         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01988 
01989             <span class="comment">//</span>
01990             <span class="comment">// This call forces the client-side desktop information</span>
01991             <span class="comment">// to be updated.</span>
01992             <span class="comment">//</span>
01993 
01994             pcsrt = CsrConnectToUser();
01995             <span class="keywordflow">if</span> (pcsrt == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
01996                     !SetThreadDesktop(pInputThreadInitInfo-&gt;<a class="code" href="../../d0/d3/struct__INPUT__THREAD__INIT__INFO.html#o2">DesktopHandle</a>)) {
01997                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
01998             } <span class="keywordflow">else</span> {
01999 
02000                 <span class="comment">//</span>
02001                 <span class="comment">// Save our thread handle for cleanup purposes</span>
02002                 <span class="comment">//</span>
02003 
02004                 hThread = pcsrt-&gt;ThreadHandle;
02005 
02006                 <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a21">fOneTimeInitialized</a>) {
02007 
02008                     <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a44">InitializeCustomCP</a>();
02009 
02010                     <span class="comment">//</span>
02011                     <span class="comment">// Initialize default screen dimensions.  we have to initialize</span>
02012                     <span class="comment">// the font info here (in the input thread) so that GDI doesn't</span>
02013                     <span class="comment">// get completely confused on process termination (since a</span>
02014                     <span class="comment">// process that looks like it's terminating created all the</span>
02015                     <span class="comment">// server HFONTS).</span>
02016                     <span class="comment">//</span>
02017 
02018                     <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a24">EnumerateFonts</a>(<a class="code" href="../../d8/d5/consrv_8h.html#a55">EF_DEFFACE</a>);
02019 
02020                     <a class="code" href="../../d6/d2/output_8c.html#a40">InitializeScreenInfo</a>();
02021 
02022                     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d5/srvinit_8c.html#a29">InitWindowClass</a>())
02023                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
02024 
02025                     <span class="keywordflow">for</span> (i=0;i&lt;<a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a3">CONSOLE_MAX_KEY_INFO</a>;i++) {
02026                         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a10">ConsoleKeyInfo</a>[i].<a class="code" href="../../d3/d3/struct__CONSOLE__KEY__INFO.html#o0">hWnd</a> = <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a2">CONSOLE_FREE_KEY_INFO</a>;
02027                     }
02028 
02029                     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a23">ProgmanHandleMessage</a> = <a class="code" href="../../d0/d8/ntcftxt_8h.html#a25">RegisterWindowMessage</a>(TEXT(CONSOLE_PROGMAN_HANDLE_MESSAGE));
02030                 }
02031             }
02032         }
02033 
02034         <span class="comment">//</span>
02035         <span class="comment">// If we successfully initialized, the input thread is ready to run.</span>
02036         <span class="comment">// Otherwise, kill the thread.</span>
02037         <span class="comment">//</span>
02038 
02039         pInputThreadInitInfo-&gt;<a class="code" href="../../d0/d3/struct__INPUT__THREAD__INIT__INFO.html#o3">InitStatus</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02040         <a class="code" href="../../d0/d8/ex_2event_8c.html#a10">NtSetEvent</a>(pInputThreadInitInfo-&gt;<a class="code" href="../../d0/d3/struct__INPUT__THREAD__INIT__INFO.html#o1">InitCompleteEventHandle</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02041 
02042         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
02043             <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(STATUS_PORT_DISCONNECTED);
02044 
02045         hhook = SetWindowsHookEx(WH_MSGFILTER, <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a35">DialogHookProc</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02046                                 HandleToUlong(Teb-&gt;ClientId.UniqueThread));
02047 
02048         <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02049 
02050             <span class="comment">//</span>
02051             <span class="comment">// If a WM_QUIT has been received and all windows</span>
02052             <span class="comment">// are gone, get out.</span>
02053             <span class="comment">//</span>
02054 
02055             <span class="keywordflow">if</span> (fQuit &amp;&amp; ThreadInfo.<a class="code" href="../../d9/d2/struct__INPUT__THREAD__INFO.html#o3">WindowCount</a> == 0)
02056                 <span class="keywordflow">break</span>;
02057 
02058             <span class="comment">//</span>
02059             <span class="comment">// Make sure we don't hold any locks while we're idle.</span>
02060             <span class="comment">//</span>
02061 
02062             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(NtCurrentTeb()-&gt;CountOfOwnedCriticalSections == 0);
02063 
02064             <a class="code" href="../../d0/d8/ntcftxt_8h.html#a16">GetMessage</a>(&amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, 0);
02065 
02066             <span class="comment">//</span>
02067             <span class="comment">// Trap messages posted to the thread.</span>
02068             <span class="comment">//</span>
02069 
02070             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message == <a class="code" href="../../d1/d7/server_8h.html#a67">CM_CREATE_CONSOLE_WINDOW</a>) {
02071                 <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a34">ProcessCreateConsoleWindow</a>(&amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>);
02072                 <span class="keywordflow">continue</span>;
02073             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message == WM_QUIT) {
02074 
02075                 <span class="comment">//</span>
02076                 <span class="comment">// The message was posted from ExitWindows.  This</span>
02077                 <span class="comment">// means that it's OK to terminate the thread.</span>
02078                 <span class="comment">//</span>
02079 
02080                 fQuit = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02081 
02082                 <span class="comment">//</span>
02083                 <span class="comment">// Only exit the loop if there are no windows,</span>
02084                 <span class="comment">//</span>
02085 
02086                 <span class="keywordflow">if</span> (ThreadInfo.<a class="code" href="../../d9/d2/struct__INPUT__THREAD__INFO.html#o3">WindowCount</a> == 0) {
02087                     <span class="keywordflow">break</span>;
02088                 }
02089                 KdPrint((<span class="stringliteral">"WM_QUIT received by console with windows\n"</span>));
02090                 <span class="keywordflow">continue</span>;
02091             }
02092             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/consrv_8h.html#a33">CONSOLE_IS_IME_ENABLED</a>()) {
02093                 <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message == <a class="code" href="../../d1/d7/server_8h.html#a77">CM_CONSOLE_INPUT_THREAD_MSG</a>) {
02094                     MSG <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>;
02095 
02096                     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a40">UnqueueThreadMessage</a>(ThreadInfo.<a class="code" href="../../d9/d2/struct__INPUT__THREAD__INFO.html#o1">ThreadId</a>, &amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message, &amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.wParam, &amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.lParam)) {
02097                         <span class="comment">// NOTE HIROYAMA: change this to RIP_VERBOSE</span>
02098                         RIPMSG3(RIP_VERBOSE, <span class="stringliteral">"InputThread: Unqueue: msg=%04x (%08x, %08x)"</span>,
02099                                 <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message, <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.wParam, <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.lParam);
02100                         <span class="keywordflow">switch</span> (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message) {
02101                         <span class="keywordflow">case</span> CM_CONIME_CREATE:
02102                             ProcessCreateConsoleIME(&amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, ThreadInfo.<a class="code" href="../../d9/d2/struct__INPUT__THREAD__INFO.html#o1">ThreadId</a>);
02103                             <span class="keywordflow">continue</span>;
02104                         <span class="keywordflow">case</span> CM_WAIT_CONIME_PROCESS:
02105                             WaitConsoleIMEStuff((HDESK)<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.wParam, (HANDLE)<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.lParam);
02106                             <span class="keywordflow">continue</span>;
02107                         <span class="keywordflow">case</span> CM_SET_CONSOLEIME_WINDOW:
02108                             ThreadInfo.hWndConsoleIME = (HWND)<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.wParam;
02109                             <span class="keywordflow">continue</span>;
02110                         <span class="keywordflow">default</span>:
02111                             RIPMSG1(RIP_WARNING, <span class="stringliteral">"ConsoleInputThread: invalid thread message(%04x) !!"</span>, <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message);
02112                             <span class="keywordflow">break</span>;
02113                         }
02114                     }
02115                     <span class="keywordflow">else</span> {
02116                         RIPMSG0(RIP_WARNING, <span class="stringliteral">"ConsoleInputThread: bogus thread message is post. ignored"</span>);
02117                         <span class="keywordflow">continue</span>;
02118                     }
02119                 }
02120             }
02121 
02122             <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a20">TranslateMessageEx</a>(&amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, TM_POSTCHARBREAKS)) {
02123                 <a class="code" href="../../d5/d9/cltxt_8h.html#a24">DispatchMessage</a>(&amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>);
02124             } <span class="keywordflow">else</span> {
02125                 <span class="comment">// do this so that alt-tab works while journalling</span>
02126                 <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message == WM_SYSKEYDOWN &amp;&amp;
02127                     <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.wParam == VK_TAB &amp;&amp;
02128                     (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.lParam &amp; 0x20000000) ) {   <span class="comment">// alt is really down</span>
02129                     <a class="code" href="../../d5/d9/cltxt_8h.html#a24">DispatchMessage</a>(&amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>);
02130                 } <span class="keywordflow">else</span> {
02131                     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a31">StoreKeyInfo</a>(&amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>);
02132                 }
02133             }
02134         }
02135 
02136         <span class="comment">//</span>
02137         <span class="comment">// Cleanup the input thread messages</span>
02138         <span class="comment">//</span>
02139         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a38">CleanupInputThreadMessages</a>(ThreadInfo.<a class="code" href="../../d9/d2/struct__INPUT__THREAD__INFO.html#o1">ThreadId</a>);
02140 
02141         <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(STATUS_PORT_DISCONNECTED);
02142 
02143     } except (<a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a2">InputExceptionFilter</a>(GetExceptionInformation())) {
02144         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fSuccess;
02145 
02146         <span class="comment">//</span>
02147         <span class="comment">// Free all resources used by this thread</span>
02148         <span class="comment">//</span>
02149 
02150         <span class="keywordflow">if</span> (hhook != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02151             <a class="code" href="../../d3/d0/user32_8def.html#a75">UnhookWindowsHookEx</a>(hhook);
02152         ConsoleDesktopInfo.dwThreadId = 0;
02153         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a86">NtUserConsoleControl</a>(ConsoleDesktopConsoleThread,
02154                 &amp;ConsoleDesktopInfo, <span class="keyword">sizeof</span>(ConsoleDesktopInfo));
02155 
02156         <span class="comment">//</span>
02157         <span class="comment">// Close the desktop handle.  CSR is special cased to close</span>
02158         <span class="comment">// the handle even if the thread has windows.  The desktop</span>
02159         <span class="comment">// remains assigned to the thread.</span>
02160         <span class="comment">//</span>
02161 
02162         fSuccess = CloseDesktop(ThreadInfo.<a class="code" href="../../d9/d2/struct__INPUT__THREAD__INFO.html#o2">Desktop</a>);
02163         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(fSuccess);
02164 
02165         <span class="comment">//</span>
02166         <span class="comment">// Restore thread handle so that CSR won't get confused.</span>
02167         <span class="comment">//</span>
02168 
02169         <span class="keywordflow">if</span> (hThread != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02170             pcsrt-&gt;ThreadHandle = hThread;
02171     }
02172 
02173     <span class="keywordflow">if</span> (pcsrt != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02174         CsrDereferenceThread(pcsrt);
02175     <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a12">UserExitWorkerThread</a>();
02176 }
02177 
02178 ULONG
<a name="l02179"></a><a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a42">02179</a> <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a42">GetControlKeyState</a>(
02180     LPARAM lParam
02181     )
02182 {
02183     ULONG ControlKeyState=0;
02184 
02185     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a16">GetKeyState</a>(VK_LMENU) &amp; <a class="code" href="../../d9/d3/input_8h.html#a17">KEY_PRESSED</a>) {
02186         ControlKeyState |= LEFT_ALT_PRESSED;
02187     }
02188     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a16">GetKeyState</a>(VK_RMENU) &amp; <a class="code" href="../../d9/d3/input_8h.html#a17">KEY_PRESSED</a>) {
02189         ControlKeyState |= RIGHT_ALT_PRESSED;
02190     }
02191     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a16">GetKeyState</a>(VK_LCONTROL) &amp; <a class="code" href="../../d9/d3/input_8h.html#a17">KEY_PRESSED</a>) {
02192         ControlKeyState |= LEFT_CTRL_PRESSED;
02193     }
02194     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a16">GetKeyState</a>(VK_RCONTROL) &amp; <a class="code" href="../../d9/d3/input_8h.html#a17">KEY_PRESSED</a>) {
02195         ControlKeyState |= RIGHT_CTRL_PRESSED;
02196     }
02197     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a16">GetKeyState</a>(VK_SHIFT) &amp; <a class="code" href="../../d9/d3/input_8h.html#a17">KEY_PRESSED</a>) {
02198         ControlKeyState |= SHIFT_PRESSED;
02199     }
02200     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a16">GetKeyState</a>(VK_NUMLOCK) &amp; <a class="code" href="../../d4/d5/conimep_8h.html#a37">KEY_TOGGLED</a>) {
02201         ControlKeyState |= NUMLOCK_ON;
02202     }
02203     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a16">GetKeyState</a>(<a class="code" href="../../d9/d3/input_8h.html#a16">VK_OEM_SCROLL</a>) &amp; <a class="code" href="../../d4/d5/conimep_8h.html#a37">KEY_TOGGLED</a>) {
02204         ControlKeyState |= SCROLLLOCK_ON;
02205     }
02206     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a16">GetKeyState</a>(VK_CAPITAL) &amp; <a class="code" href="../../d4/d5/conimep_8h.html#a37">KEY_TOGGLED</a>) {
02207         ControlKeyState |= CAPSLOCK_ON;
02208     }
02209     <span class="keywordflow">if</span> (lParam &amp; <a class="code" href="../../d9/d3/input_8h.html#a19">KEY_ENHANCED</a>) {
02210         ControlKeyState |= ENHANCED_KEY;
02211     }
02212     ControlKeyState |= (lParam &amp; ALTNUMPAD_BIT);
02213     <span class="keywordflow">return</span> ControlKeyState;
02214 }
02215 
02216 ULONG
<a name="l02217"></a><a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a43">02217</a> <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a43">ConvertMouseButtonState</a>(
02218     IN ULONG Flag,
02219     IN ULONG State
02220     )
02221 {
02222     <span class="keywordflow">if</span> (State &amp; MK_LBUTTON) {
02223         Flag |= FROM_LEFT_1ST_BUTTON_PRESSED;
02224     }
02225     <span class="keywordflow">if</span> (State &amp; MK_MBUTTON) {
02226         Flag |= FROM_LEFT_2ND_BUTTON_PRESSED;
02227     }
02228     <span class="keywordflow">if</span> (State &amp; MK_RBUTTON) {
02229         Flag |= RIGHTMOST_BUTTON_PRESSED;
02230     }
02231     <span class="keywordflow">return</span> Flag;
02232 }
02233 
02234 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02235"></a><a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a44">02235</a> <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a44">TerminateRead</a>(
02236     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
02237     IN <a class="code" href="../../d7/d2/struct__INPUT__INFORMATION.html">PINPUT_INFORMATION</a> InputInfo,
02238     IN DWORD Flag
02239     )
02240 
02241 <span class="comment">/*++</span>
02242 <span class="comment"></span>
02243 <span class="comment">Routine Description:</span>
02244 <span class="comment"></span>
02245 <span class="comment">    This routine wakes up any readers waiting for data when a ctrl-c</span>
02246 <span class="comment">    or ctrl-break is input.</span>
02247 <span class="comment"></span>
02248 <span class="comment">Arguments:</span>
02249 <span class="comment"></span>
02250 <span class="comment">    InputInfo - pointer to input buffer</span>
02251 <span class="comment"></span>
02252 <span class="comment">    Flag - flag indicating whether ctrl-break or ctrl-c was input</span>
02253 <span class="comment"></span>
02254 <span class="comment">--*/</span>
02255 
02256 {
02257     BOOLEAN WaitSatisfied;
02258     WaitSatisfied = CsrNotifyWait(&amp;InputInfo-&gt;ReadWaitQueue,
02259                   <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
02260                   <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02261                   (PVOID)Flag
02262                  );
02263     <span class="keywordflow">if</span> (WaitSatisfied) {
02264         <span class="comment">// #334370 under stress, WaitQueue may already hold the satisfied waits</span>
02265         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((Console-&gt;WaitQueue == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
02266                 (Console-&gt;WaitQueue == &amp;InputInfo-&gt;ReadWaitQueue));
02267         Console-&gt;WaitQueue = &amp;InputInfo-&gt;ReadWaitQueue;
02268     }
02269 }
02270 
02271 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l02272"></a><a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a45">02272</a> <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a45">HandleSysKeyEvent</a>(
02273     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
02274     IN HWND hWnd,
02275     IN UINT Message,
02276     IN WPARAM wParam,
02277     IN LPARAM lParam
02278     )
02279 
02280 <span class="comment">/*</span>
02281 <span class="comment"></span>
02282 <span class="comment">    returns TRUE if DefWindowProc should be called.</span>
02283 <span class="comment"></span>
02284 <span class="comment">*/</span>
02285 
02286 {
02287     WORD VirtualKeyCode;
02288     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bCtrlDown;
02289 
02290 <span class="preprocessor">#if defined (FE_IME)</span>
02291 <span class="preprocessor"></span><span class="comment">// Sep.16.1995 Support Console IME by v-HirShi(Hirotoshi Shimizu)</span>
02292     <span class="keywordflow">if</span> (Message == WM_SYSCHAR || Message == WM_SYSDEADCHAR ||
02293         Message == WM_SYSCHAR+<a class="code" href="../../d3/d5/conime_8h.html#a23">CONIME_KEYDATA</a> || Message == WM_SYSDEADCHAR+<a class="code" href="../../d3/d5/conime_8h.html#a23">CONIME_KEYDATA</a>)
02294 <span class="preprocessor">#else</span>
02295 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (Message == WM_SYSCHAR || Message == WM_SYSDEADCHAR)
02296 <span class="preprocessor">#endif</span>
02297 <span class="preprocessor"></span>    {
02298         VirtualKeyCode = (WORD)<a class="code" href="../../d0/d8/ntcftxt_8h.html#a18">MapVirtualKey</a>(<a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(HIWORD(lParam)), 1);
02299     } <span class="keywordflow">else</span> {
02300         VirtualKeyCode = LOWORD(wParam);
02301     }
02302 
02303     <span class="comment">//</span>
02304     <span class="comment">// check for ctrl-esc</span>
02305     <span class="comment">//</span>
02306     bCtrlDown = <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a16">GetKeyState</a>(VK_CONTROL) &amp; <a class="code" href="../../d9/d3/input_8h.html#a17">KEY_PRESSED</a>;
02307 
02308     <span class="keywordflow">if</span> (VirtualKeyCode == VK_ESCAPE &amp;&amp;
02309         bCtrlDown &amp;&amp;
02310         !(<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a16">GetKeyState</a>(VK_MENU) &amp; <a class="code" href="../../d9/d3/input_8h.html#a17">KEY_PRESSED</a>) &amp;&amp;
02311         !(<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a16">GetKeyState</a>(VK_SHIFT) &amp; <a class="code" href="../../d9/d3/input_8h.html#a17">KEY_PRESSED</a>) &amp;&amp;
02312         !(Console-&gt;ReserveKeys &amp; CONSOLE_CTRLESC) ) {
02313         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;    <span class="comment">// call DefWindowProc</span>
02314     }
02315 
02316     <span class="keywordflow">if</span> ((lParam &amp; 0x20000000) == 0) {   <span class="comment">// we're iconic</span>
02317 
02318 
02319         <span class="comment">//</span>
02320         <span class="comment">// Check for ENTER while ICONic (Restore accelerator)</span>
02321         <span class="comment">//</span>
02322 
02323         <span class="keywordflow">if</span> (VirtualKeyCode == VK_RETURN &amp;&amp; !(Console-&gt;FullScreenFlags &amp; CONSOLE_FULLSCREEN_HARDWARE)) {
02324 
02325             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;    <span class="comment">// call DefWindowProc</span>
02326         } <span class="keywordflow">else</span> {
02327             <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a46">HandleKeyEvent</a>(Console,
02328                            <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>,
02329                            Message,
02330                            wParam,
02331                            lParam
02332                           );
02333             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02334         }
02335     }
02336 
02337     <span class="keywordflow">if</span> (VirtualKeyCode == VK_RETURN &amp;&amp; !bCtrlDown &amp;&amp;
02338             !(Console-&gt;ReserveKeys &amp; CONSOLE_ALTENTER)) {
02339 <span class="preprocessor">#ifdef i386</span>
02340 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (!(Message &amp; <a class="code" href="../../d9/d3/input_8h.html#a20">KEY_UP_TRANSITION</a>)) {
02341             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a12">FullScreenInitialized</a>) {
02342                 <span class="keywordflow">if</span> (Console-&gt;FullScreenFlags == 0) {
02343                     <a class="code" href="../../d7/d4/server_2private_8c.html#a48">ConvertToFullScreen</a>(Console);
02344                     Console-&gt;FullScreenFlags = CONSOLE_FULLSCREEN;
02345 
02346                     <a class="code" href="../../d8/d5/consrv_8h.html#a293">ChangeDispSettings</a>(Console, Console-&gt;hWnd,CDS_FULLSCREEN);
02347                 } <span class="keywordflow">else</span> {
02348                     <a class="code" href="../../d7/d4/server_2private_8c.html#a49">ConvertToWindowed</a>(Console);
02349                     Console-&gt;FullScreenFlags &amp;= ~CONSOLE_FULLSCREEN;
02350 
02351                     <a class="code" href="../../d8/d5/consrv_8h.html#a293">ChangeDispSettings</a>(Console, Console-&gt;hWnd,0);
02352 
02353                     <a class="code" href="../../d3/d0/user32_8def.html#a32">ShowWindow</a>(Console-&gt;hWnd, SW_RESTORE);
02354                 }
02355             } <span class="keywordflow">else</span> {
02356                 WCHAR ItemString[70];
02357                 LoadString(<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a4">ghInstance</a>,<a class="code" href="../../d6/d7/menu_8h.html#a1">msgNoFullScreen</a>,ItemString,70);
02358                 MessageBoxEx(Console-&gt;hWnd,
02359                             ItemString,
02360                             Console-&gt;Title,
02361                             MB_SYSTEMMODAL | MB_OK,
02362                             0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>
02363                            );
02364             }
02365         }
02366 <span class="preprocessor">#endif</span>
02367 <span class="preprocessor"></span>        <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02368     }
02369 
02370     <span class="comment">//</span>
02371     <span class="comment">// make sure alt-space gets translated so that the system</span>
02372     <span class="comment">// menu is displayed.</span>
02373     <span class="comment">//</span>
02374 
02375     <span class="keywordflow">if</span> (!(<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a16">GetKeyState</a>(VK_CONTROL) &amp; <a class="code" href="../../d9/d3/input_8h.html#a17">KEY_PRESSED</a>)) {
02376         <span class="keywordflow">if</span> (VirtualKeyCode == VK_SPACE &amp;&amp; !(Console-&gt;ReserveKeys &amp; CONSOLE_ALTSPACE)) {
02377             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>; <span class="comment">// call DefWindowProc</span>
02378         }
02379 
02380         <span class="keywordflow">if</span> (VirtualKeyCode == VK_ESCAPE &amp;&amp; !(Console-&gt;ReserveKeys &amp; CONSOLE_ALTESC)) {
02381             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;  <span class="comment">// call DefWindowProc</span>
02382         }
02383         <span class="keywordflow">if</span> (VirtualKeyCode == VK_TAB &amp;&amp; !(Console-&gt;ReserveKeys &amp; CONSOLE_ALTTAB)) {
02384             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;  <span class="comment">// call DefWindowProc</span>
02385         }
02386     }
02387     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a46">HandleKeyEvent</a>(Console,
02388                    <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>,
02389                    Message,
02390                    wParam,
02391                    lParam
02392                   );
02393     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02394 }
02395 
02396 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02397"></a><a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a46">02397</a> <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a46">HandleKeyEvent</a>(
02398     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
02399     IN HWND hWnd,
02400     IN UINT Message,
02401     IN WPARAM wParam,
02402     IN LPARAM lParam
02403     )
02404 {
02405     INPUT_RECORD InputEvent;
02406     BOOLEAN ContinueProcessing;
02407     ULONG EventsWritten;
02408     WORD VirtualKeyCode;
02409     ULONG ControlKeyState;
02410     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bKeyDown;
02411     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bGenerateBreak=<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02412 <span class="preprocessor">#ifdef FE_SB</span>
02413 <span class="preprocessor"></span>    <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> KeyMessageFromConsoleIME;
02414 <span class="preprocessor">#endif</span>
02415 <span class="preprocessor"></span>
02416 <span class="preprocessor">#ifdef FE_SB</span>
02417 <span class="preprocessor"></span>    <span class="comment">// v-HirShi Sep.21.1995 For Console IME</span>
02418     <span class="keywordflow">if</span> ((WM_KEYFIRST+<a class="code" href="../../d3/d5/conime_8h.html#a23">CONIME_KEYDATA</a>) &lt;= Message &amp;&amp; Message &lt;= (WM_KEYLAST+<a class="code" href="../../d3/d5/conime_8h.html#a23">CONIME_KEYDATA</a>)) {
02419         Message -= <a class="code" href="../../d3/d5/conime_8h.html#a23">CONIME_KEYDATA</a> ;
02420         KeyMessageFromConsoleIME = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
02421     }
02422     <span class="keywordflow">else</span> {
02423         KeyMessageFromConsoleIME = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
02424     }
02425 <span class="preprocessor">#endif</span>
02426 <span class="preprocessor"></span>    <span class="comment">/*</span>
02427 <span class="comment">     * BOGUS for WM_CHAR/WM_DEADCHAR, in which LOWORD(lParam) is a character</span>
02428 <span class="comment">     */</span>
02429     VirtualKeyCode = LOWORD(wParam);
02430     ControlKeyState = <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a42">GetControlKeyState</a>(lParam);
02431     bKeyDown = !(lParam &amp; <a class="code" href="../../d9/d3/input_8h.html#a22">KEY_TRANSITION_UP</a>);
02432 
02433     <span class="comment">//</span>
02434     <span class="comment">// Make sure we retrieve the key info first, or we could chew up</span>
02435     <span class="comment">// unneeded space in the key info table if we bail out early.</span>
02436     <span class="comment">//</span>
02437 
02438     InputEvent.Event.KeyEvent.wVirtualKeyCode = VirtualKeyCode;
02439     InputEvent.Event.KeyEvent.wVirtualScanCode = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)(HIWORD(lParam));
02440     <span class="keywordflow">if</span> (Message == WM_CHAR || Message == WM_SYSCHAR ||
02441         Message == WM_DEADCHAR || Message == WM_SYSDEADCHAR) {
02442         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a32">RetrieveKeyInfo</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>,
02443                         &amp;InputEvent.Event.KeyEvent.wVirtualKeyCode,
02444                         &amp;InputEvent.Event.KeyEvent.wVirtualScanCode,
02445                         !(Console-&gt;InputBuffer.ImeMode.Open ^ KeyMessageFromConsoleIME));
02446         VirtualKeyCode = InputEvent.Event.KeyEvent.wVirtualKeyCode;
02447     }
02448 
02449     <span class="comment">//</span>
02450     <span class="comment">// If this is a key up message, should we ignore it? We do this</span>
02451     <span class="comment">// so that if a process reads a line from the input buffer, the</span>
02452     <span class="comment">// key up event won't get put in the buffer after the read</span>
02453     <span class="comment">// completes.</span>
02454     <span class="comment">//</span>
02455 
02456     <span class="keywordflow">if</span> (Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a17">CONSOLE_IGNORE_NEXT_KEYUP</a>) {
02457         Console-&gt;Flags &amp;= ~<a class="code" href="../../d1/d7/server_8h.html#a17">CONSOLE_IGNORE_NEXT_KEYUP</a>;
02458         <span class="keywordflow">if</span> (!bKeyDown)
02459             <span class="keywordflow">return</span>;
02460     }
02461 
02462 <span class="preprocessor">#ifdef FE_SB</span>
02463 <span class="preprocessor"></span>    <span class="comment">// v-HirShi Sep.21.1995 For Console IME</span>
02464     <span class="keywordflow">if</span> (KeyMessageFromConsoleIME) {
02465         <span class="keywordflow">goto</span> FromConsoleIME ;
02466     }
02467 <span class="preprocessor">#endif</span>
02468 <span class="preprocessor"></span>
02469     <span class="keywordflow">if</span> (Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a4">CONSOLE_SELECTING</a>) {
02470 
02471         <span class="keywordflow">if</span> (!bKeyDown) {
02472             <span class="keywordflow">return</span>;
02473         }
02474 
02475         <span class="comment">//</span>
02476         <span class="comment">// if escape or ctrl-c, cancel selection</span>
02477         <span class="comment">//</span>
02478 
02479         <span class="keywordflow">if</span> (!(Console-&gt;SelectionFlags &amp; <a class="code" href="../../d1/d7/server_8h.html#a29">CONSOLE_MOUSE_DOWN</a>) ) {
02480             <span class="keywordflow">if</span> (VirtualKeyCode == VK_ESCAPE ||
02481                 (VirtualKeyCode == <span class="charliteral">'C'</span> &amp;&amp;
02482                  (<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a16">GetKeyState</a>(VK_CONTROL) &amp; <a class="code" href="../../d9/d3/input_8h.html#a17">KEY_PRESSED</a>) )) {
02483                 <a class="code" href="../../d8/d5/consrv_8h.html#a306">ClearSelection</a>(Console);
02484                 <span class="keywordflow">return</span>;
02485             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (VirtualKeyCode == VK_RETURN) {
02486 
02487                 <span class="comment">// if return, copy selection</span>
02488 
02489                 <a class="code" href="../../d8/d5/consrv_8h.html#a300">DoCopy</a>(Console);
02490                 <span class="keywordflow">return</span>;
02491             }
02492         }
02493         <span class="keywordflow">if</span> (!(Console-&gt;SelectionFlags &amp; <a class="code" href="../../d1/d7/server_8h.html#a28">CONSOLE_MOUSE_SELECTION</a>)) {
02494             <span class="keywordflow">if</span> ((Console-&gt;CurrentScreenBuffer-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>) &amp;&amp;
02495                 (VirtualKeyCode == VK_RIGHT ||
02496                  VirtualKeyCode == VK_LEFT ||
02497                  VirtualKeyCode == VK_UP ||
02498                  VirtualKeyCode == VK_DOWN ||
02499                  VirtualKeyCode == VK_NEXT ||
02500                  VirtualKeyCode == VK_PRIOR ||
02501                  VirtualKeyCode == VK_END ||
02502                  VirtualKeyCode == VK_HOME
02503                 ) ) {
02504                 <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo;
02505 <span class="preprocessor">#ifdef FE_SB</span>
02506 <span class="preprocessor"></span>                <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> RowIndex;
02507                 <a class="code" href="../../d9/d4/struct__ROW.html">PROW</a> Row;
02508                 <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> KAttrs;
02509                 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> NextRightX;
02510                 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> NextLeftX;
02511 <span class="preprocessor">#endif</span>
02512 <span class="preprocessor"></span>
02513                 ScreenInfo = Console-&gt;CurrentScreenBuffer;
02514 
02515                 <span class="comment">//</span>
02516                 <span class="comment">// see if shift is down.  if so, we're extending</span>
02517                 <span class="comment">// the selection.  otherwise, we're resetting the</span>
02518                 <span class="comment">// anchor</span>
02519                 <span class="comment">//</span>
02520 
02521                 <a class="code" href="../../d6/d1/ntcon_2server_2cursor_8c.html#a3">ConsoleHideCursor</a>(ScreenInfo);
02522 <span class="preprocessor">#ifdef FE_SB</span>
02523 <span class="preprocessor"></span>                RowIndex = (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.FirstRow+ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.Y) % ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.Y;
02524                 Row = &amp;ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.Rows[RowIndex];
02525 
02526                <span class="keywordflow">if</span> (CONSOLE_IS_DBCS_OUTPUTCP(Console))
02527                {
02528                     KAttrs = Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.KAttrs[ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.X];
02529                     <span class="keywordflow">if</span> (KAttrs &amp; ATTR_LEADING_BYTE)
02530                         NextRightX = 2;
02531                     <span class="keywordflow">else</span>
02532                         NextRightX = 1;
02533                 }
02534                 <span class="keywordflow">else</span>
02535                 {
02536                     NextRightX = 1;
02537                 }
02538                 <span class="keywordflow">if</span> (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.X &gt; 0) {
02539                     <span class="keywordflow">if</span> (CONSOLE_IS_DBCS_OUTPUTCP(Console)) {
02540                         KAttrs = Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.KAttrs[ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.X-1];
02541                         <span class="keywordflow">if</span> (KAttrs &amp; ATTR_TRAILING_BYTE)
02542                             NextLeftX = 2;
02543                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (KAttrs &amp; ATTR_LEADING_BYTE) {
02544                             <span class="keywordflow">if</span> (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.X-1 &gt; 0) {
02545                                 KAttrs = Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.KAttrs[ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.X-2];
02546                                 <span class="keywordflow">if</span> (KAttrs &amp; ATTR_TRAILING_BYTE)
02547                                     NextLeftX = 3;
02548                                 <span class="keywordflow">else</span>
02549                                     NextLeftX = 2;
02550                             }
02551                             <span class="keywordflow">else</span>
02552                                 NextLeftX = 1;
02553                         }
02554                         <span class="keywordflow">else</span>
02555                             NextLeftX = 1;
02556                     }
02557                     <span class="keywordflow">else</span>
02558                         NextLeftX = 1;
02559                 }
02560 
02561                 <span class="keywordflow">switch</span> (VirtualKeyCode) {
02562                     <span class="keywordflow">case</span> VK_RIGHT:
02563                         <span class="keywordflow">if</span> (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.X+NextRightX &lt; ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.X) {
02564                             ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.X+=NextRightX;
02565                         }
02566                         <span class="keywordflow">break</span>;
02567                     <span class="keywordflow">case</span> VK_LEFT:
02568                         <span class="keywordflow">if</span> (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.X &gt; 0) {
02569                             ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.X-=NextLeftX;
02570                         }
02571                         <span class="keywordflow">break</span>;
02572                     <span class="keywordflow">case</span> VK_UP:
02573                         <span class="keywordflow">if</span> (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.Y &gt; 0) {
02574                             ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.Y-=1;
02575                         }
02576                         <span class="keywordflow">break</span>;
02577                     <span class="keywordflow">case</span> VK_DOWN:
02578                         <span class="keywordflow">if</span> (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.Y+1 &lt; ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.Y) {
02579                             ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.Y+=1;
02580                         }
02581                         <span class="keywordflow">break</span>;
02582                     <span class="keywordflow">case</span> VK_NEXT:
02583                         ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.Y += <a class="code" href="../../d7/d2/output_8h.html#a18">CONSOLE_WINDOW_SIZE_Y</a>(ScreenInfo)-1;
02584                         <span class="keywordflow">if</span> (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.Y &gt;= ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.Y) {
02585                             ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.Y = ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.Y-1;
02586                         }
02587                         <span class="keywordflow">break</span>;
02588                     <span class="keywordflow">case</span> VK_PRIOR:
02589                         ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.Y -= <a class="code" href="../../d7/d2/output_8h.html#a18">CONSOLE_WINDOW_SIZE_Y</a>(ScreenInfo)-1;
02590                         <span class="keywordflow">if</span> (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.Y &lt; 0) {
02591                             ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.Y = 0;
02592                         }
02593                         <span class="keywordflow">break</span>;
02594                     <span class="keywordflow">case</span> VK_END:
02595                         ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.Y = ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.Y-<a class="code" href="../../d7/d2/output_8h.html#a18">CONSOLE_WINDOW_SIZE_Y</a>(ScreenInfo);
02596                         <span class="keywordflow">break</span>;
02597                     <span class="keywordflow">case</span> VK_HOME:
02598                         ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.X = 0;
02599                         ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.Y = 0;
02600                         <span class="keywordflow">break</span>;
02601                     <span class="keywordflow">default</span>:
02602                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02603                 }
02604 <span class="preprocessor">#else   // FE_SB</span>
02605 <span class="preprocessor"></span>                <span class="keywordflow">switch</span> (VirtualKeyCode) {
02606                     <span class="keywordflow">case</span> VK_RIGHT:
02607                         <span class="keywordflow">if</span> (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.X+1 &lt; ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.X) {
02608                             ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.X+=1;
02609                         }
02610                         <span class="keywordflow">break</span>;
02611                     <span class="keywordflow">case</span> VK_LEFT:
02612                         <span class="keywordflow">if</span> (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.X &gt; 0) {
02613                             ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.X-=1;
02614                         }
02615                         <span class="keywordflow">break</span>;
02616                     <span class="keywordflow">case</span> VK_UP:
02617                         <span class="keywordflow">if</span> (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.Y &gt; 0) {
02618                             ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.Y-=1;
02619                         }
02620                         <span class="keywordflow">break</span>;
02621                     <span class="keywordflow">case</span> VK_DOWN:
02622                         <span class="keywordflow">if</span> (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.Y+1 &lt; ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.Y) {
02623                             ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.Y+=1;
02624                         }
02625                         <span class="keywordflow">break</span>;
02626                     <span class="keywordflow">case</span> VK_NEXT:
02627                         ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.Y += <a class="code" href="../../d7/d2/output_8h.html#a18">CONSOLE_WINDOW_SIZE_Y</a>(ScreenInfo)-1;
02628                         <span class="keywordflow">if</span> (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.Y &gt;= ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.Y) {
02629                             ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.Y = ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.Y-1;
02630                         }
02631                         <span class="keywordflow">break</span>;
02632                     <span class="keywordflow">case</span> VK_PRIOR:
02633                         ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.Y -= <a class="code" href="../../d7/d2/output_8h.html#a18">CONSOLE_WINDOW_SIZE_Y</a>(ScreenInfo)-1;
02634                         <span class="keywordflow">if</span> (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.Y &lt; 0) {
02635                             ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.Y = 0;
02636                         }
02637                         <span class="keywordflow">break</span>;
02638                     <span class="keywordflow">case</span> VK_END:
02639                         ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.Y = ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.Y-<a class="code" href="../../d7/d2/output_8h.html#a18">CONSOLE_WINDOW_SIZE_Y</a>(ScreenInfo);
02640                         <span class="keywordflow">break</span>;
02641                     <span class="keywordflow">case</span> VK_HOME:
02642                         ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.X = 0;
02643                         ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.Y = 0;
02644                         <span class="keywordflow">break</span>;
02645                     <span class="keywordflow">default</span>:
02646                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02647                 }
02648 <span class="preprocessor">#endif  // FE_SB</span>
02649 <span class="preprocessor"></span>                <a class="code" href="../../d6/d1/ntcon_2server_2cursor_8c.html#a2">ConsoleShowCursor</a>(ScreenInfo);
02650                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a16">GetKeyState</a>(VK_SHIFT) &amp; <a class="code" href="../../d9/d3/input_8h.html#a17">KEY_PRESSED</a>) {
02651                     {
02652                         <a class="code" href="../../d8/d5/consrv_8h.html#a305">ExtendSelection</a>(Console,ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition);
02653                     }
02654                 } <span class="keywordflow">else</span> {
02655                     <span class="keywordflow">if</span> (Console-&gt;SelectionFlags &amp; <a class="code" href="../../d1/d7/server_8h.html#a27">CONSOLE_SELECTION_NOT_EMPTY</a>) {
02656                         <a class="code" href="../../d8/d5/consrv_8h.html#a309">MyInvert</a>(Console,&amp;Console-&gt;SelectionRect);
02657                         Console-&gt;SelectionFlags &amp;= ~<a class="code" href="../../d1/d7/server_8h.html#a27">CONSOLE_SELECTION_NOT_EMPTY</a>;
02658                         <a class="code" href="../../d6/d1/ntcon_2server_2cursor_8c.html#a2">ConsoleShowCursor</a>(ScreenInfo);
02659                     }
02660                     Console-&gt;SelectionAnchor = ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition;
02661                     <a class="code" href="../../d0/d7/server_2stream_8c.html#a28">MakeCursorVisible</a>(ScreenInfo,Console-&gt;SelectionAnchor);
02662                     Console-&gt;SelectionRect.Left = Console-&gt;SelectionRect.Right = Console-&gt;SelectionAnchor.X;
02663                     Console-&gt;SelectionRect.Top = Console-&gt;SelectionRect.Bottom = Console-&gt;SelectionAnchor.Y;
02664                 }
02665                 <span class="keywordflow">return</span>;
02666             }
02667         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(Console-&gt;SelectionFlags &amp; <a class="code" href="../../d1/d7/server_8h.html#a29">CONSOLE_MOUSE_DOWN</a>)) {
02668 
02669             <span class="comment">//</span>
02670             <span class="comment">// if in mouse selection mode and user hits a key, cancel selection</span>
02671             <span class="comment">//</span>
02672 
02673             <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a27">IsSystemKey</a>(VirtualKeyCode)) {
02674                 <a class="code" href="../../d8/d5/consrv_8h.html#a306">ClearSelection</a>(Console);
02675             }
02676         }
02677     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a5">CONSOLE_SCROLLING</a>) {
02678 
02679         <span class="keywordflow">if</span> (!bKeyDown) {
02680             <span class="keywordflow">return</span>;
02681         }
02682 
02683         <span class="comment">//</span>
02684         <span class="comment">// if escape, enter or ctrl-c, cancel scroll</span>
02685         <span class="comment">//</span>
02686 
02687         <span class="keywordflow">if</span> (VirtualKeyCode == VK_ESCAPE ||
02688             VirtualKeyCode == VK_RETURN ||
02689             (VirtualKeyCode == <span class="charliteral">'C'</span> &amp;&amp;
02690              (<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a16">GetKeyState</a>(VK_CONTROL) &amp; <a class="code" href="../../d9/d3/input_8h.html#a17">KEY_PRESSED</a>) )) {
02691             <a class="code" href="../../d8/d5/consrv_8h.html#a312">ClearScroll</a>(Console);
02692         } <span class="keywordflow">else</span> {
02693             WORD ScrollCommand;
02694             <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> Horizontal=<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02695             <span class="keywordflow">switch</span> (VirtualKeyCode) {
02696                 <span class="keywordflow">case</span> VK_UP:
02697                     ScrollCommand = SB_LINEUP;
02698                     <span class="keywordflow">break</span>;
02699                 <span class="keywordflow">case</span> VK_DOWN:
02700                     ScrollCommand = SB_LINEDOWN;
02701                     <span class="keywordflow">break</span>;
02702                 <span class="keywordflow">case</span> VK_LEFT:
02703                     ScrollCommand = SB_LINEUP;
02704                     Horizontal=<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02705                     <span class="keywordflow">break</span>;
02706                 <span class="keywordflow">case</span> VK_RIGHT:
02707                     ScrollCommand = SB_LINEDOWN;
02708                     Horizontal=<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02709                     <span class="keywordflow">break</span>;
02710                 <span class="keywordflow">case</span> VK_NEXT:
02711                     ScrollCommand = SB_PAGEDOWN;
02712                     <span class="keywordflow">break</span>;
02713                 <span class="keywordflow">case</span> VK_PRIOR:
02714                     ScrollCommand = SB_PAGEUP;
02715                     <span class="keywordflow">break</span>;
02716                 <span class="keywordflow">case</span> VK_END:
02717                     ScrollCommand = SB_PAGEDOWN;
02718                     Horizontal=<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02719                     <span class="keywordflow">break</span>;
02720                 <span class="keywordflow">case</span> VK_HOME:
02721                     ScrollCommand = SB_PAGEUP;
02722                     Horizontal=<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02723                     <span class="keywordflow">break</span>;
02724                 <span class="keywordflow">case</span> VK_SHIFT:
02725                 <span class="keywordflow">case</span> VK_CONTROL:
02726                 <span class="keywordflow">case</span> VK_MENU:
02727                     <span class="keywordflow">return</span>;
02728                 <span class="keywordflow">default</span>:
02729                     Beep(800, 200);
02730                     <span class="keywordflow">return</span>;
02731             }
02732             <span class="keywordflow">if</span> (Horizontal)
02733                 <a class="code" href="../../d6/d2/output_8c.html#a82">HorizontalScroll</a>(Console-&gt;CurrentScreenBuffer, ScrollCommand, 0);
02734             <span class="keywordflow">else</span>
02735                 <a class="code" href="../../d6/d2/output_8c.html#a81">VerticalScroll</a>(Console, Console-&gt;CurrentScreenBuffer,ScrollCommand,0);
02736         }
02737         <span class="keywordflow">return</span>;
02738     }
02739 
02740     <span class="comment">//</span>
02741     <span class="comment">// if the user is inputting chars at an inappropriate time, beep.</span>
02742     <span class="comment">//</span>
02743 
02744     <span class="keywordflow">if</span> ((Console-&gt;Flags &amp; (<a class="code" href="../../d1/d7/server_8h.html#a4">CONSOLE_SELECTING</a> | <a class="code" href="../../d1/d7/server_8h.html#a5">CONSOLE_SCROLLING</a> | <a class="code" href="../../d1/d7/server_8h.html#a21">CONSOLE_SCROLLBAR_TRACKING</a>)) &amp;&amp;
02745         bKeyDown &amp;&amp;
02746         !<a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a27">IsSystemKey</a>(VirtualKeyCode)) {
02747         Beep(800, 200);
02748         <span class="keywordflow">return</span>;
02749     }
02750 
02751     <span class="comment">//</span>
02752     <span class="comment">// if in fullscreen mode, process PrintScreen</span>
02753     <span class="comment">//</span>
02754 
02755 <span class="preprocessor">#ifdef LATER</span>
02756 <span class="preprocessor"></span><span class="comment">//</span>
02757 <span class="comment">// Changed this code to get commas to work (build 485).</span>
02758 <span class="comment">//</span>
02759 <span class="comment">// Therese, the problem is that WM_CHAR/WM_SYSCHAR messages come through</span>
02760 <span class="comment">// here - in this case, LOWORD(wParam) is a character value and not a virtual</span>
02761 <span class="comment">// key. It happens that VK_SNAPSHOT == 0x2c, and the character value for a</span>
02762 <span class="comment">// comma is also == 0x2c, so execution enters this conditional when a comma</span>
02763 <span class="comment">// is hit. Commas aren't coming out because of the newly entered return</span>
02764 <span class="comment">// statement.</span>
02765 <span class="comment">//</span>
02766 <span class="comment">// HandleKeyEvent() is making many virtual key comparisons - need to make</span>
02767 <span class="comment">// sure that for each one, there is either no corresponding character value,</span>
02768 <span class="comment">// or that you check before you compare so that you are comparing two values</span>
02769 <span class="comment">// that have the same data type.</span>
02770 <span class="comment">//</span>
02771 <span class="comment">// I added the message comparison so that we know we're checking virtual</span>
02772 <span class="comment">// keys against virtual keys and not characters.</span>
02773 <span class="comment">//</span>
02774 <span class="comment">// - scottlu</span>
02775 <span class="comment">//</span>
02776 
02777 <span class="preprocessor">#endif</span>
02778 <span class="preprocessor"></span>
02779     <span class="keywordflow">if</span> (Message != WM_CHAR &amp;&amp; Message != WM_SYSCHAR &amp;&amp;
02780         VirtualKeyCode == VK_SNAPSHOT &amp;&amp;
02781         !(Console-&gt;ReserveKeys &amp; (CONSOLE_ALTPRTSC | CONSOLE_PRTSC )) ) {
02782         <span class="keywordflow">if</span> (Console-&gt;FullScreenFlags &amp; CONSOLE_FULLSCREEN_HARDWARE) {
02783             Console-&gt;SelectionFlags |= <a class="code" href="../../d1/d7/server_8h.html#a27">CONSOLE_SELECTION_NOT_EMPTY</a>;
02784             Console-&gt;SelectionRect = Console-&gt;CurrentScreenBuffer-&gt;Window;
02785             <a class="code" href="../../d8/d5/consrv_8h.html#a307">StoreSelection</a>(Console);
02786             Console-&gt;SelectionFlags &amp;= ~<a class="code" href="../../d1/d7/server_8h.html#a27">CONSOLE_SELECTION_NOT_EMPTY</a>;
02787         }
02788         <span class="keywordflow">return</span>;
02789     }
02790 
02791     <span class="comment">//</span>
02792     <span class="comment">// IME stuff</span>
02793     <span class="comment">//</span>
02794     <span class="keywordflow">if</span> (!(Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a9">CONSOLE_VDM_REGISTERED</a>)) {
02795         LPARAM lParamForHotKey ;
02796         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> HotkeyID ;
02797         lParamForHotKey = lParam ;
02798 
02799         HotkeyID = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a397">NtUserCheckImeHotKey</a>( (VirtualKeyCode &amp; 0x00ff),lParamForHotKey) ;
02800         <span class="comment">//</span>
02801         <span class="comment">// If it's direct KL switching hokey, handle it here</span>
02802         <span class="comment">// regardless the system is IME enabled or not.</span>
02803         <span class="comment">//</span>
02804         <span class="keywordflow">if</span> (HotkeyID &gt;= IME_HOTKEY_DSWITCH_FIRST &amp;&amp; HotkeyID &lt;= IME_HOTKEY_DSWITCH_LAST) {
02805             <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uModifier, uVkey;
02806             HKL hkl;
02807 
02808             RIPMSG1(RIP_VERBOSE, <span class="stringliteral">"HandleKeyEvent: handling IME HOTKEY id=%x"</span>, HotkeyID);
02809             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a393">NtUserGetImeHotKey</a>(HotkeyID, &amp;uModifier, &amp;uVkey, &amp;hkl) &amp;&amp; hkl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02810                 <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> bCharSetSys = <a class="code" href="../../d0/d3/dbcs_8h.html#a45">CodePageToCharSet</a>(GetACP());
02811                 WPARAM wpSysChar = 0;
02812                 CHARSETINFO cs;
02813 
02814                 <span class="keywordflow">if</span> (TranslateCharsetInfo((LPDWORD)LOWORD(hkl), &amp;cs, TCI_SRCLOCALE)) {
02815                     <span class="keywordflow">if</span> (bCharSetSys == cs.ciCharset) {
02816                         wpSysChar = INPUTLANGCHANGE_SYSCHARSET;
02817                     }
02818                 }
02819                 <a class="code" href="../../d0/d8/ntcftxt_8h.html#a20">PostMessage</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, WM_INPUTLANGCHANGEREQUEST, wpSysChar, (LPARAM)hkl);
02820             }
02821             <span class="keywordflow">return</span>;
02822         }
02823 
02824         <span class="keywordflow">if</span> (!(Console-&gt;InputBuffer.ImeMode.Disable) &amp;&amp; <a class="code" href="../../d8/d5/consrv_8h.html#a33">CONSOLE_IS_IME_ENABLED</a>()) {
02825 
02826             <span class="keywordflow">if</span> (HotkeyID != IME_INVALID_HOTKEY) {
02827                 <span class="keywordflow">switch</span>(HotkeyID) {
02828                 <span class="keywordflow">case</span> IME_JHOTKEY_CLOSE_OPEN:
02829                     {
02830                         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fOpen = Console-&gt;InputBuffer.ImeMode.Open;
02831                         <span class="keywordflow">if</span> (!bKeyDown)
02832                             <span class="keywordflow">break</span> ;
02833 
02834                         Console-&gt;InputBuffer.ImeMode.Open = !fOpen ;
02835                         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ConsoleImeMessagePump(Console,
02836                                               <a class="code" href="../../d3/d5/conime_8h.html#a13">CONIME_HOTKEY</a>,
02837                                               (WPARAM)Console-&gt;ConsoleHandle,
02838                                               HotkeyID))) {
02839                             <span class="keywordflow">break</span>;
02840                         }
02841 
02842                         <span class="comment">// Update in the system conversion mode buffer.</span>
02843                         GetImeKeyState(Console, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02844 
02845                         <span class="keywordflow">break</span> ;
02846                     }
02847                 <span class="keywordflow">case</span> IME_CHOTKEY_IME_NONIME_TOGGLE:
02848                 <span class="keywordflow">case</span> IME_THOTKEY_IME_NONIME_TOGGLE:
02849                 <span class="keywordflow">case</span> IME_CHOTKEY_SHAPE_TOGGLE:
02850                 <span class="keywordflow">case</span> IME_THOTKEY_SHAPE_TOGGLE:
02851                 <span class="keywordflow">case</span> IME_CHOTKEY_SYMBOL_TOGGLE:
02852                 <span class="keywordflow">case</span> IME_THOTKEY_SYMBOL_TOGGLE:
02853                 <span class="keywordflow">case</span> IME_KHOTKEY_SHAPE_TOGGLE:
02854                 <span class="keywordflow">case</span> IME_KHOTKEY_HANJACONVERT:
02855                 <span class="keywordflow">case</span> IME_KHOTKEY_ENGLISH:
02856                 <span class="keywordflow">case</span> IME_ITHOTKEY_RESEND_RESULTSTR:
02857                 <span class="keywordflow">case</span> IME_ITHOTKEY_PREVIOUS_COMPOSITION:
02858                 <span class="keywordflow">case</span> IME_ITHOTKEY_UISTYLE_TOGGLE:
02859                 <span class="keywordflow">default</span>:
02860                     {
02861                         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ConsoleImeMessagePump(Console,
02862                                               <a class="code" href="../../d3/d5/conime_8h.html#a13">CONIME_HOTKEY</a>,
02863                                               (WPARAM)Console-&gt;ConsoleHandle,
02864                                               HotkeyID))) {
02865                             <span class="keywordflow">break</span>;
02866                         }
02867 
02868                         <span class="comment">// Update in the system conversion mode buffer.</span>
02869                         GetImeKeyState(Console, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02870 
02871                         <span class="keywordflow">break</span> ;
02872                     }
02873                 }
02874                 <span class="keywordflow">return</span> ;
02875             }
02876 
02877             <span class="keywordflow">if</span> ( <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a8">CTRL_BUT_NOT_ALT</a>(ControlKeyState) &amp;&amp;
02878                     (bKeyDown) ) {
02879                 <span class="keywordflow">if</span> (VirtualKeyCode == <span class="charliteral">'C'</span> &amp;&amp;
02880                         Console-&gt;InputBuffer.InputMode &amp; ENABLE_PROCESSED_INPUT) {
02881                     <span class="keywordflow">goto</span> FromConsoleIME ;
02882                 }
02883                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (VirtualKeyCode == VK_CANCEL) {
02884                     <span class="keywordflow">goto</span> FromConsoleIME ;
02885                 }
02886                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (VirtualKeyCode == <span class="charliteral">'S'</span>){
02887                     <span class="keywordflow">goto</span> FromConsoleIME ;
02888                 }
02889             }
02890             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (VirtualKeyCode == VK_PAUSE ){
02891                 <span class="keywordflow">goto</span> FromConsoleIME ;
02892             }
02893             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( ((VirtualKeyCode == VK_SHIFT)   ||
02894                        (VirtualKeyCode == VK_CONTROL) ||
02895                        (VirtualKeyCode == VK_CAPITAL) ||
02896                        (VirtualKeyCode == VK_KANA)    ||    <span class="comment">// VK_KANA == VK_HANGUL</span>
02897                        (VirtualKeyCode == VK_JUNJA)   ||
02898                        (VirtualKeyCode == VK_HANJA)   ||
02899                        (VirtualKeyCode == VK_NUMLOCK) ||
02900                        (VirtualKeyCode == VK_SCROLL)     )
02901                       &amp;&amp;
02902                       !(Console-&gt;InputBuffer.ImeMode.Unavailable) &amp;&amp;
02903                       !(Console-&gt;InputBuffer.ImeMode.Open)
02904                     )
02905             {
02906                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ConsoleImeMessagePump(Console,
02907                                       Message+<a class="code" href="../../d3/d5/conime_8h.html#a23">CONIME_KEYDATA</a>,
02908                                       (WPARAM)LOWORD(wParam)&lt;&lt;16|LOWORD(VirtualKeyCode),
02909                                       lParam
02910                                      ))) {
02911                     <span class="keywordflow">return</span>;
02912                 }
02913                 <span class="keywordflow">goto</span> FromConsoleIME ;
02914             }
02915 
02916             <span class="keywordflow">if</span> (!Console-&gt;InputBuffer.ImeMode.Unavailable &amp;&amp; Console-&gt;InputBuffer.ImeMode.Open) {
02917                 <span class="keywordflow">if</span> (! (HIWORD(lParam) &amp; KF_REPEAT))
02918                 {
02919                     <span class="keywordflow">if</span> (PRIMARYLANGID(LOWORD(Console-&gt;hklActive)) == LANG_JAPANESE &amp;&amp;
02920                             (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)wParam == VK_KANA) {
02921                         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ConsoleImeMessagePump(Console,
02922                                               <a class="code" href="../../d3/d5/conime_8h.html#a17">CONIME_NOTIFY_VK_KANA</a>,
02923                                               0,
02924                                               0
02925                                              ))) {
02926                             <span class="keywordflow">return</span>;
02927                         }
02928                     }
02929                 }
02930 
02931                 ConsoleImeMessagePump(Console,
02932                                       Message+<a class="code" href="../../d3/d5/conime_8h.html#a23">CONIME_KEYDATA</a>,
02933                                       LOWORD(wParam)&lt;&lt;16|LOWORD(VirtualKeyCode),
02934                                       lParam
02935                                      );
02936                 <span class="keywordflow">return</span> ;
02937             }
02938         }
02939     }
02940 FromConsoleIME:
02941 
02942     <span class="comment">//</span>
02943     <span class="comment">// ignore key strokes that will generate CHAR messages.  this is only</span>
02944     <span class="comment">// necessary while a dialog box is up.</span>
02945     <span class="comment">//</span>
02946 
02947     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a9">DialogBoxCount</a> &gt; 0) {
02948         <span class="keywordflow">if</span> (Message != WM_CHAR &amp;&amp; Message != WM_SYSCHAR &amp;&amp; Message != WM_DEADCHAR &amp;&amp; Message != WM_SYSDEADCHAR) {
02949             WCHAR awch[<a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a1">MAX_CHARS_FROM_1_KEYSTROKE</a>];
02950             <span class="keywordtype">int</span> cwch;
02951             <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> KeyState[256];
02952 
02953             <a class="code" href="../../d3/d0/user32_8def.html#a46">GetKeyboardState</a>(KeyState);
02954             cwch = <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a25">ToUnicodeEx</a>((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)wParam,HIWORD(lParam),KeyState,awch,
02955                                <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a1">MAX_CHARS_FROM_1_KEYSTROKE</a>,
02956                                <span class="comment">//TM_POSTCHARBREAKS | (KeyState(VK_MENU) &amp; 1));</span>
02957                                TM_POSTCHARBREAKS,
02958                                (HKL)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02959             <span class="keywordflow">if</span> (cwch != 0) {
02960                 <span class="keywordflow">return</span>;
02961             }
02962         } <span class="keywordflow">else</span> {
02963             <span class="comment">// remember to generate break</span>
02964             <span class="keywordflow">if</span> (Message == WM_CHAR) {
02965                 bGenerateBreak=<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02966             }
02967         }
02968     }
02969 
02970 <span class="preprocessor">#ifdef FE_IME</span>
02971 <span class="preprocessor"></span>    <span class="comment">// ignore key stroke while IME property is up.</span>
02972     <span class="keywordflow">if</span> (Console-&gt;InputBuffer.hWndConsoleIME)
02973         <span class="keywordflow">return</span>;
02974 <span class="preprocessor">#endif</span>
02975 <span class="preprocessor"></span>
02976     InputEvent.EventType = KEY_EVENT;
02977     InputEvent.Event.KeyEvent.bKeyDown = bKeyDown;
02978     InputEvent.Event.KeyEvent.wRepeatCount = LOWORD(lParam);
02979 
02980     <span class="keywordflow">if</span> (Message == WM_CHAR || Message == WM_SYSCHAR || Message == WM_DEADCHAR || Message == WM_SYSDEADCHAR) {
02981         <span class="comment">// If this is a fake character, zero the scancode.</span>
02982         <span class="keywordflow">if</span> (lParam &amp; 0x02000000) {
02983             InputEvent.Event.KeyEvent.wVirtualScanCode = 0;
02984         }
02985         InputEvent.Event.KeyEvent.dwControlKeyState = <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a42">GetControlKeyState</a>(lParam);
02986         <span class="keywordflow">if</span> (Message == WM_CHAR || Message == WM_SYSCHAR) {
02987             InputEvent.Event.KeyEvent.uChar.UnicodeChar = (WCHAR)wParam;
02988         } <span class="keywordflow">else</span> {
02989             InputEvent.Event.KeyEvent.uChar.UnicodeChar = (WCHAR)0;
02990         }
02991     } <span class="keywordflow">else</span> {
02992         <span class="comment">// if alt-gr, ignore</span>
02993         <span class="keywordflow">if</span> (lParam &amp; 0x02000000) {
02994             <span class="keywordflow">return</span>;
02995         }
02996         InputEvent.Event.KeyEvent.dwControlKeyState = ControlKeyState;
02997         InputEvent.Event.KeyEvent.uChar.UnicodeChar = 0;
02998     }
02999 
03000 <span class="preprocessor">#ifdef FE_IME</span>
03001 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/consrv_8h.html#a33">CONSOLE_IS_IME_ENABLED</a>()) {
03002         <span class="comment">// MSKK August.22.1993 KazuM</span>
03003         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwConversion;
03004 
03005         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(GetImeKeyState(Console, &amp;dwConversion))) {
03006             <span class="keywordflow">return</span>;
03007         }
03008 
03009         InputEvent.Event.KeyEvent.dwControlKeyState |= <a class="code" href="../../d0/d3/dbcs_8h.html#a54">ImmConversionToConsole</a>(dwConversion);
03010     }
03011 <span class="preprocessor">#endif</span>
03012 <span class="preprocessor"></span>
03013     ContinueProcessing=<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03014 
03015     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/server_2cmdline_8c.html#a8">CTRL_BUT_NOT_ALT</a>(InputEvent.Event.KeyEvent.dwControlKeyState) &amp;&amp;
03016         InputEvent.Event.KeyEvent.bKeyDown) {
03017 
03018         <span class="comment">//</span>
03019         <span class="comment">// check for ctrl-c, if in line input mode.</span>
03020         <span class="comment">//</span>
03021 
03022         <span class="keywordflow">if</span> (InputEvent.Event.KeyEvent.wVirtualKeyCode == <span class="charliteral">'C'</span> &amp;&amp;
03023             Console-&gt;InputBuffer.InputMode &amp; ENABLE_PROCESSED_INPUT) {
03024             <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a50">HandleCtrlEvent</a>(Console,CTRL_C_EVENT);
03025             <span class="keywordflow">if</span> (!Console-&gt;PopupCount)
03026                 <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a44">TerminateRead</a>(Console,&amp;Console-&gt;InputBuffer,<a class="code" href="../../d9/d3/input_8h.html#a23">CONSOLE_CTRL_C_SEEN</a>);
03027             <span class="keywordflow">if</span> (!(Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a25">CONSOLE_SUSPENDED</a>)) {
03028                 ContinueProcessing=<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03029             }
03030         }
03031 
03032         <span class="comment">//</span>
03033         <span class="comment">// check for ctrl-break.</span>
03034         <span class="comment">//</span>
03035 
03036         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (InputEvent.Event.KeyEvent.wVirtualKeyCode == VK_CANCEL) {
03037             <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a23">FlushInputBuffer</a>(&amp;Console-&gt;InputBuffer);
03038             <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a50">HandleCtrlEvent</a>(Console,CTRL_BREAK_EVENT);
03039             <span class="keywordflow">if</span> (!Console-&gt;PopupCount)
03040                 <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a44">TerminateRead</a>(Console,&amp;Console-&gt;InputBuffer,<a class="code" href="../../d9/d3/input_8h.html#a24">CONSOLE_CTRL_BREAK_SEEN</a>);
03041             <span class="keywordflow">if</span> (!(Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a25">CONSOLE_SUSPENDED</a>)) {
03042                 ContinueProcessing=<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03043             }
03044         }
03045 
03046         <span class="comment">//</span>
03047         <span class="comment">// don't write ctrl-esc to the input buffer</span>
03048         <span class="comment">//</span>
03049 
03050         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (InputEvent.Event.KeyEvent.wVirtualKeyCode == VK_ESCAPE &amp;&amp;
03051                  !(Console-&gt;ReserveKeys &amp; CONSOLE_CTRLESC)) {
03052             ContinueProcessing=<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03053         }
03054     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (InputEvent.Event.KeyEvent.dwControlKeyState &amp; (RIGHT_ALT_PRESSED | LEFT_ALT_PRESSED) &amp;&amp;
03055                InputEvent.Event.KeyEvent.bKeyDown &amp;&amp;
03056                InputEvent.Event.KeyEvent.wVirtualKeyCode == VK_ESCAPE &amp;&amp;
03057                !(Console-&gt;ReserveKeys &amp; CONSOLE_ALTESC)) {
03058         ContinueProcessing=<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03059     }
03060 
03061     <span class="keywordflow">if</span> (ContinueProcessing) {
03062         EventsWritten = <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a30">WriteInputBuffer</a>( Console,
03063                                           &amp;Console-&gt;InputBuffer,
03064                                           &amp;InputEvent,
03065                                           1
03066                                          );
03067         <span class="keywordflow">if</span> (EventsWritten &amp;&amp; bGenerateBreak) {
03068             InputEvent.Event.KeyEvent.bKeyDown = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03069             <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a30">WriteInputBuffer</a>( Console,
03070                               &amp;Console-&gt;InputBuffer,
03071                               &amp;InputEvent,
03072                               1
03073                              );
03074         }
03075     }
03076     <span class="keywordflow">return</span>;
03077 }
03078 
03079 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l03080"></a><a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a47">03080</a> <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a47">HandleMouseEvent</a>(
03081     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
03082     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
03083     IN UINT Message,
03084     IN WPARAM wParam,
03085     IN LPARAM lParam
03086     )
03087 <span class="comment">/*</span>
03088 <span class="comment"></span>
03089 <span class="comment">    returns TRUE if DefWindowProc should be called.</span>
03090 <span class="comment"></span>
03091 <span class="comment">*/</span>
03092 
03093 {
03094     ULONG ButtonFlags,EventFlags;
03095     INPUT_RECORD InputEvent;
03096     ULONG EventsWritten;
03097     COORD MousePosition;
03098     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> RowIndex;
03099     <a class="code" href="../../d9/d4/struct__ROW.html">PROW</a> Row;
03100 
03101     <span class="keywordflow">if</span> (!(Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a2">CONSOLE_HAS_FOCUS</a>) &amp;&amp;
03102         !(Console-&gt;FullScreenFlags &amp; CONSOLE_FULLSCREEN_HARDWARE) &amp;&amp;
03103         !(Console-&gt;SelectionFlags &amp; <a class="code" href="../../d1/d7/server_8h.html#a29">CONSOLE_MOUSE_DOWN</a>)) {
03104         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03105     }
03106 
03107     <span class="keywordflow">if</span> (Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a3">CONSOLE_IGNORE_NEXT_MOUSE_INPUT</a>) {
03108         <span class="comment">// only reset on up transition</span>
03109         <span class="keywordflow">if</span> (Message != WM_LBUTTONDOWN &amp;&amp;
03110             Message != WM_MBUTTONDOWN &amp;&amp;
03111             Message != WM_RBUTTONDOWN) {
03112             Console-&gt;Flags &amp;= ~<a class="code" href="../../d1/d7/server_8h.html#a3">CONSOLE_IGNORE_NEXT_MOUSE_INPUT</a>;
03113             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03114         }
03115         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03116     }
03117 
03118     <span class="comment">//</span>
03119     <span class="comment">// translate mouse position into characters, if necessary.</span>
03120     <span class="comment">//</span>
03121 
03122     MousePosition.X = LOWORD(lParam);
03123     MousePosition.Y = HIWORD(lParam);
03124     <span class="keywordflow">if</span> (ScreenInfo-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>) {
03125         MousePosition.X /= <a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(ScreenInfo).X;
03126         MousePosition.Y /= <a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(ScreenInfo).Y;
03127     }
03128     MousePosition.X += ScreenInfo-&gt;Window.Left;
03129     MousePosition.Y += ScreenInfo-&gt;Window.Top;
03130 
03131     <span class="comment">//</span>
03132     <span class="comment">// make sure mouse position is clipped to screen buffer</span>
03133     <span class="comment">//</span>
03134 
03135     <span class="keywordflow">if</span> (MousePosition.X &lt; 0) {
03136         MousePosition.X = 0;
03137     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (MousePosition.X &gt;= ScreenInfo-&gt;ScreenBufferSize.X) {
03138         MousePosition.X = ScreenInfo-&gt;ScreenBufferSize.X-1;
03139     }
03140     <span class="keywordflow">if</span> (MousePosition.Y &lt; 0) {
03141         MousePosition.Y = 0;
03142     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (MousePosition.Y &gt;= ScreenInfo-&gt;ScreenBufferSize.Y) {
03143         MousePosition.Y = ScreenInfo-&gt;ScreenBufferSize.Y-1;
03144     }
03145 
03146     <span class="keywordflow">if</span> (Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a4">CONSOLE_SELECTING</a> ||
03147         ((Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a11">CONSOLE_QUICK_EDIT_MODE</a>) &amp;&amp;
03148          (Console-&gt;FullScreenFlags == 0)) ) {
03149         <span class="keywordflow">if</span> (Message == WM_LBUTTONDOWN) {
03150 
03151             <span class="comment">//</span>
03152             <span class="comment">// make sure message matches button state</span>
03153             <span class="comment">//</span>
03154 
03155             <span class="keywordflow">if</span> (!(<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a16">GetKeyState</a>(VK_LBUTTON) &amp; <a class="code" href="../../d9/d3/input_8h.html#a17">KEY_PRESSED</a>)) {
03156                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03157             }
03158 
03159             <span class="keywordflow">if</span> (Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a11">CONSOLE_QUICK_EDIT_MODE</a> &amp;&amp;
03160                 !(Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a4">CONSOLE_SELECTING</a>)) {
03161                 Console-&gt;Flags |= <a class="code" href="../../d1/d7/server_8h.html#a4">CONSOLE_SELECTING</a>;
03162                 Console-&gt;SelectionFlags = <a class="code" href="../../d1/d7/server_8h.html#a28">CONSOLE_MOUSE_SELECTION</a> | <a class="code" href="../../d1/d7/server_8h.html#a29">CONSOLE_MOUSE_DOWN</a> | <a class="code" href="../../d1/d7/server_8h.html#a27">CONSOLE_SELECTION_NOT_EMPTY</a>;
03163 
03164                 <span class="comment">//</span>
03165                 <span class="comment">// invert selection</span>
03166                 <span class="comment">//</span>
03167 
03168                 Console-&gt;SelectionAnchor = MousePosition;
03169                 Console-&gt;SelectionRect.Left =Console-&gt;SelectionRect.Right = Console-&gt;SelectionAnchor.X;
03170                 Console-&gt;SelectionRect.Top = Console-&gt;SelectionRect.Bottom = Console-&gt;SelectionAnchor.Y;
03171                 <a class="code" href="../../d8/d5/consrv_8h.html#a309">MyInvert</a>(Console,&amp;Console-&gt;SelectionRect);
03172                 <a class="code" href="../../d1/d7/ntcon_2server_2menu_8c.html#a3">SetWinText</a>(Console,<a class="code" href="../../d6/d7/menu_8h.html#a5">msgSelectMode</a>,<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03173                 <a class="code" href="../../d3/d0/user32_8def.html#a44">SetCapture</a>(Console-&gt;hWnd);
03174             } <span class="keywordflow">else</span> {
03175 
03176             <span class="comment">//</span>
03177             <span class="comment">// We now capture the mouse to our Window. We do this so that the user can</span>
03178             <span class="comment">//  "scroll" the selection endpoint to an off screen position by moving the</span>
03179             <span class="comment">//  mouse off the client area.</span>
03180             <span class="comment">//</span>
03181 
03182             <span class="keywordflow">if</span> (Console-&gt;SelectionFlags &amp; <a class="code" href="../../d1/d7/server_8h.html#a28">CONSOLE_MOUSE_SELECTION</a>) {
03183 
03184                 <span class="comment">//</span>
03185                 <span class="comment">// Check for SHIFT-Mouse Down "continue previous selection" command</span>
03186                 <span class="comment">//</span>
03187 
03188                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a16">GetKeyState</a>(VK_SHIFT) &amp; <a class="code" href="../../d9/d3/input_8h.html#a17">KEY_PRESSED</a>) {
03189                     Console-&gt;SelectionFlags |= <a class="code" href="../../d1/d7/server_8h.html#a29">CONSOLE_MOUSE_DOWN</a>; <span class="comment">// BUGBUG necessary flag?</span>
03190                     <a class="code" href="../../d3/d0/user32_8def.html#a44">SetCapture</a>(Console-&gt;hWnd);
03191                     <a class="code" href="../../d8/d5/consrv_8h.html#a305">ExtendSelection</a>(Console,
03192                                     MousePosition
03193                                    );
03194                 } <span class="keywordflow">else</span> {
03195 
03196                     <span class="comment">//</span>
03197                     <span class="comment">// invert old selection, reset anchor, and invert</span>
03198                     <span class="comment">// new selection.</span>
03199                     <span class="comment">//</span>
03200 
03201                     <a class="code" href="../../d8/d5/consrv_8h.html#a309">MyInvert</a>(Console,&amp;Console-&gt;SelectionRect);
03202                     Console-&gt;SelectionFlags |= <a class="code" href="../../d1/d7/server_8h.html#a29">CONSOLE_MOUSE_DOWN</a>; <span class="comment">// BUGBUG necessary flag?</span>
03203                     <a class="code" href="../../d3/d0/user32_8def.html#a44">SetCapture</a>(Console-&gt;hWnd);
03204                     Console-&gt;SelectionAnchor = MousePosition;
03205                     Console-&gt;SelectionRect.Left =Console-&gt;SelectionRect.Right = Console-&gt;SelectionAnchor.X;
03206                     Console-&gt;SelectionRect.Top = Console-&gt;SelectionRect.Bottom = Console-&gt;SelectionAnchor.Y;
03207                     <a class="code" href="../../d8/d5/consrv_8h.html#a309">MyInvert</a>(Console,&amp;Console-&gt;SelectionRect);
03208                 }
03209             } <span class="keywordflow">else</span> {
03210                 <a class="code" href="../../d8/d5/consrv_8h.html#a310">ConvertToMouseSelect</a>(Console,
03211                                      MousePosition
03212                                     );
03213             }
03214             }
03215         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Message == WM_LBUTTONUP) {
03216             <span class="keywordflow">if</span> (Console-&gt;SelectionFlags &amp; <a class="code" href="../../d1/d7/server_8h.html#a28">CONSOLE_MOUSE_SELECTION</a>) {
03217                 Console-&gt;SelectionFlags &amp;= ~<a class="code" href="../../d1/d7/server_8h.html#a29">CONSOLE_MOUSE_DOWN</a>;
03218                 <a class="code" href="../../d3/d8/client_8c.html#a124">ReleaseCapture</a>();
03219             }
03220         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Message == WM_LBUTTONDBLCLK) {
03221             <span class="keywordflow">if</span> ((MousePosition.X == Console-&gt;SelectionAnchor.X) &amp;&amp;
03222                 (MousePosition.Y == Console-&gt;SelectionAnchor.Y)) {
03223                 RowIndex = (ScreenInfo-&gt;BufferInfo.TextInfo.FirstRow+MousePosition.Y) % ScreenInfo-&gt;ScreenBufferSize.Y;
03224                 Row = &amp;ScreenInfo-&gt;BufferInfo.TextInfo.Rows[RowIndex];
03225                 <span class="keywordflow">while</span> (Console-&gt;SelectionAnchor.X &gt; 0) {
03226                     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/cmdline_8h.html#a23">IS_WORD_DELIM</a>(Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o4">Chars</a>[Console-&gt;SelectionAnchor.X - 1]))
03227                         <span class="keywordflow">break</span>;
03228                     Console-&gt;SelectionAnchor.X--;
03229                 }
03230                 <span class="keywordflow">while</span> (MousePosition.X &lt; ScreenInfo-&gt;ScreenBufferSize.X) {
03231                     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/cmdline_8h.html#a23">IS_WORD_DELIM</a>(Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o4">Chars</a>[MousePosition.X]))
03232                         <span class="keywordflow">break</span>;
03233                     MousePosition.X++;
03234                 }
03235                 <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a25">gfTrimLeadingZeros</a>) {
03236                     <span class="comment">//</span>
03237                     <span class="comment">// Trim the leading zeros: 000fe12 -&gt; fe12</span>
03238                     <span class="comment">// Usefull for debugging</span>
03239                     <span class="comment">//</span>
03240                     <span class="keywordflow">if</span> (MousePosition.X &gt; Console-&gt;SelectionAnchor.X + 2 &amp;&amp;
03241                             Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o4">Chars</a>[Console-&gt;SelectionAnchor.X + 1] != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'x'</span> &amp;&amp;
03242                             Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o4">Chars</a>[Console-&gt;SelectionAnchor.X + 1] != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'X'</span>) {
03243                         <span class="comment">// Don't touch the selection begins with 0x</span>
03244                         <span class="keywordflow">while</span> (Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o4">Chars</a>[Console-&gt;SelectionAnchor.X] == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'0'</span> &amp;&amp; Console-&gt;SelectionAnchor.X &lt; MousePosition.X - 1) {
03245                             Console-&gt;SelectionAnchor.X++;
03246                         }
03247                     }
03248                 }
03249                 <a class="code" href="../../d8/d5/consrv_8h.html#a305">ExtendSelection</a>(Console, MousePosition);
03250             }
03251         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((Message == WM_RBUTTONDOWN) || (Message == WM_RBUTTONDBLCLK)) {
03252             <span class="keywordflow">if</span> (!(Console-&gt;SelectionFlags &amp; <a class="code" href="../../d1/d7/server_8h.html#a29">CONSOLE_MOUSE_DOWN</a>)) {
03253                 <span class="keywordflow">if</span> (Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a4">CONSOLE_SELECTING</a>) {
03254                     <a class="code" href="../../d8/d5/consrv_8h.html#a300">DoCopy</a>(Console);
03255                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a11">CONSOLE_QUICK_EDIT_MODE</a>) {
03256                     <a class="code" href="../../d8/d5/consrv_8h.html#a304">DoPaste</a>(Console);
03257                 }
03258                 Console-&gt;Flags |= <a class="code" href="../../d1/d7/server_8h.html#a3">CONSOLE_IGNORE_NEXT_MOUSE_INPUT</a>;
03259             }
03260         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Message == WM_MOUSEMOVE) {
03261             <span class="keywordflow">if</span> (Console-&gt;SelectionFlags &amp; <a class="code" href="../../d1/d7/server_8h.html#a29">CONSOLE_MOUSE_DOWN</a>) {
03262                 <a class="code" href="../../d8/d5/consrv_8h.html#a305">ExtendSelection</a>(Console,
03263                                 MousePosition
03264                                );
03265             }
03266         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Message == WM_MOUSEWHEEL) {
03267             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03268         }
03269         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03270     }
03271 
03272     <span class="keywordflow">if</span> (!(Console-&gt;InputBuffer.InputMode &amp; ENABLE_MOUSE_INPUT)) {
03273         <a class="code" href="../../d3/d8/client_8c.html#a124">ReleaseCapture</a>();
03274         <span class="keywordflow">if</span> (Console-&gt;FullScreenFlags == 0) {
03275             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03276         }
03277         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03278     }
03279 
03280     <span class="comment">// BUGBUG alt is not set correctly</span>
03281     InputEvent.Event.MouseEvent.dwControlKeyState = <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a42">GetControlKeyState</a>(0);
03282 
03283     <span class="keywordflow">if</span> (Console-&gt;FullScreenFlags &amp; CONSOLE_FULLSCREEN_HARDWARE) {
03284         <span class="keywordflow">if</span> (MousePosition.X &gt; ScreenInfo-&gt;Window.Right) {
03285             MousePosition.X = ScreenInfo-&gt;Window.Right;
03286         }
03287         <span class="keywordflow">if</span> (MousePosition.Y &gt; ScreenInfo-&gt;Window.Bottom) {
03288             MousePosition.Y = ScreenInfo-&gt;Window.Bottom;
03289         }
03290     }
03291     <span class="keywordflow">switch</span> (Message) {
03292         <span class="keywordflow">case</span> WM_LBUTTONDOWN:
03293             <a class="code" href="../../d3/d0/user32_8def.html#a44">SetCapture</a>(Console-&gt;hWnd);
03294             ButtonFlags = FROM_LEFT_1ST_BUTTON_PRESSED;
03295             EventFlags = 0;
03296             <span class="keywordflow">break</span>;
03297         <span class="keywordflow">case</span> WM_LBUTTONUP:
03298             <a class="code" href="../../d3/d8/client_8c.html#a124">ReleaseCapture</a>();
03299             ButtonFlags = 0;
03300             EventFlags = 0;
03301             <span class="keywordflow">break</span>;
03302         <span class="keywordflow">case</span> WM_RBUTTONDOWN:
03303             <a class="code" href="../../d3/d0/user32_8def.html#a44">SetCapture</a>(Console-&gt;hWnd);
03304             ButtonFlags = RIGHTMOST_BUTTON_PRESSED;
03305             EventFlags = 0;
03306             <span class="keywordflow">break</span>;
03307         <span class="keywordflow">case</span> WM_RBUTTONUP:
03308             <a class="code" href="../../d3/d8/client_8c.html#a124">ReleaseCapture</a>();
03309             ButtonFlags = 0;
03310             EventFlags = 0;
03311             <span class="keywordflow">break</span>;
03312         <span class="keywordflow">case</span> WM_MBUTTONDOWN:
03313             <a class="code" href="../../d3/d0/user32_8def.html#a44">SetCapture</a>(Console-&gt;hWnd);
03314             ButtonFlags = FROM_LEFT_2ND_BUTTON_PRESSED;
03315             EventFlags = 0;
03316             <span class="keywordflow">break</span>;
03317         <span class="keywordflow">case</span> WM_MBUTTONUP:
03318             <a class="code" href="../../d3/d8/client_8c.html#a124">ReleaseCapture</a>();
03319             ButtonFlags = 0;
03320             EventFlags = 0;
03321             <span class="keywordflow">break</span>;
03322         <span class="keywordflow">case</span> WM_MOUSEMOVE:
03323             ButtonFlags = 0;
03324             EventFlags = MOUSE_MOVED;
03325             <span class="keywordflow">break</span>;
03326         <span class="keywordflow">case</span> WM_LBUTTONDBLCLK:
03327             ButtonFlags = FROM_LEFT_1ST_BUTTON_PRESSED;
03328             EventFlags = DOUBLE_CLICK;
03329             <span class="keywordflow">break</span>;
03330         <span class="keywordflow">case</span> WM_RBUTTONDBLCLK:
03331             ButtonFlags = RIGHTMOST_BUTTON_PRESSED;
03332             EventFlags = DOUBLE_CLICK;
03333             <span class="keywordflow">break</span>;
03334         <span class="keywordflow">case</span> WM_MBUTTONDBLCLK:
03335             ButtonFlags = FROM_LEFT_2ND_BUTTON_PRESSED;
03336             EventFlags = DOUBLE_CLICK;
03337             <span class="keywordflow">break</span>;
03338         <span class="keywordflow">case</span> WM_MOUSEWHEEL:
03339             ButtonFlags = ((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)wParam &amp; 0xFFFF0000);
03340             EventFlags = MOUSE_WHEELED;
03341             <span class="keywordflow">break</span>;
03342         <span class="keywordflow">default</span>:
03343             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03344     }
03345     InputEvent.EventType = MOUSE_EVENT;
03346     InputEvent.Event.MouseEvent.dwMousePosition = MousePosition;
03347     InputEvent.Event.MouseEvent.dwEventFlags = EventFlags;
03348     InputEvent.Event.MouseEvent.dwButtonState =
03349         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a43">ConvertMouseButtonState</a>(ButtonFlags,(<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)wParam);
03350     EventsWritten = <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a30">WriteInputBuffer</a>( Console,
03351                                       &amp;Console-&gt;InputBuffer,
03352                                       &amp;InputEvent,
03353                                       1
03354                                      );
03355 <span class="preprocessor">#if DBG</span>
03356 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (EventsWritten != 1) {
03357         OutputDebugStringA(<span class="stringliteral">"PutInputInBuffer: EventsWritten != 1, 1 expected\n"</span>);
03358     }
03359 <span class="preprocessor">#endif</span>
03360 <span class="preprocessor"></span><span class="preprocessor">#ifdef i386</span>
03361 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (Console-&gt;FullScreenFlags &amp; CONSOLE_FULLSCREEN_HARDWARE) {
03362         <a class="code" href="../../d8/d5/consrv_8h.html#a277">UpdateMousePosition</a>(ScreenInfo,InputEvent.Event.MouseEvent.dwMousePosition);
03363     }
03364 <span class="preprocessor">#endif</span>
03365 <span class="preprocessor"></span>    <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03366 }
03367 
03368 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03369"></a><a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a48">03369</a> <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a48">HandleFocusEvent</a>(
03370     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
03371     IN BOOL bSetFocus
03372     )
03373 {
03374     INPUT_RECORD InputEvent;
03375     ULONG EventsWritten;
03376     USERTHREAD_FLAGS Flags;
03377 
03378     InputEvent.EventType = FOCUS_EVENT;
03379     InputEvent.Event.FocusEvent.bSetFocus = bSetFocus;
03380 
03381     Flags.dwFlags = 0;
03382     <span class="keywordflow">if</span> (bSetFocus) {
03383         <span class="keywordflow">if</span> (Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a9">CONSOLE_VDM_REGISTERED</a>) {
03384             Flags.dwFlags |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a810">TIF_VDMAPP</a>;
03385         }
03386         <span class="keywordflow">if</span> (Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a13">CONSOLE_CONNECTED_TO_EMULATOR</a>) {
03387             Flags.dwFlags |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a811">TIF_DOSEMULATOR</a>;
03388         }
03389     }
03390 
03391     Flags.dwMask = (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a810">TIF_VDMAPP</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a811">TIF_DOSEMULATOR</a>);
03392     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a277">NtUserSetInformationThread</a>(Console-&gt;InputThreadInfo-&gt;ThreadHandle,
03393             UserThreadFlags, &amp;Flags, <span class="keyword">sizeof</span>(Flags));
03394     EventsWritten = <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a30">WriteInputBuffer</a>( Console,
03395                                       &amp;Console-&gt;InputBuffer,
03396                                       &amp;InputEvent,
03397                                       1
03398                                      );
03399 <span class="preprocessor">#if DBG</span>
03400 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (EventsWritten != 1) {
03401         OutputDebugStringA(<span class="stringliteral">"PutInputInBuffer: EventsWritten != 1, 1 expected\n"</span>);
03402     }
03403 <span class="preprocessor">#endif</span>
03404 <span class="preprocessor"></span>}
03405 
03406 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03407"></a><a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a49">03407</a> <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a49">HandleMenuEvent</a>(
03408     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
03409     IN DWORD wParam
03410     )
03411 {
03412     INPUT_RECORD InputEvent;
03413     ULONG EventsWritten;
03414 
03415     InputEvent.EventType = MENU_EVENT;
03416     InputEvent.Event.MenuEvent.dwCommandId = wParam;
03417     EventsWritten = <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a30">WriteInputBuffer</a>( Console,
03418                                       &amp;Console-&gt;InputBuffer,
03419                                       &amp;InputEvent,
03420                                       1
03421                                      );
03422 <span class="preprocessor">#if DBG</span>
03423 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (EventsWritten != 1) {
03424         OutputDebugStringA(<span class="stringliteral">"PutInputInBuffer: EventsWritten != 1, 1 expected\n"</span>);
03425     }
03426 <span class="preprocessor">#endif</span>
03427 <span class="preprocessor"></span>}
03428 
03429 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03430"></a><a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a50">03430</a> <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a50">HandleCtrlEvent</a>(
03431     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
03432     IN DWORD EventType
03433     )
03434 {
03435     <span class="keywordflow">switch</span> (EventType) {
03436         <span class="keywordflow">case</span> CTRL_C_EVENT:
03437             Console-&gt;CtrlFlags |= <a class="code" href="../../d1/d7/server_8h.html#a31">CONSOLE_CTRL_C_FLAG</a>;
03438             <span class="keywordflow">break</span>;
03439         <span class="keywordflow">case</span> CTRL_BREAK_EVENT:
03440             Console-&gt;CtrlFlags |= <a class="code" href="../../d1/d7/server_8h.html#a32">CONSOLE_CTRL_BREAK_FLAG</a>;
03441             <span class="keywordflow">break</span>;
03442         <span class="keywordflow">case</span> CTRL_CLOSE_EVENT:
03443             Console-&gt;CtrlFlags |= <a class="code" href="../../d1/d7/server_8h.html#a33">CONSOLE_CTRL_CLOSE_FLAG</a>;
03444             <span class="keywordflow">break</span>;
03445         <span class="keywordflow">default</span>:
03446             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03447     }
03448 }
03449 
03450 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03451"></a><a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a51">03451</a> <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a51">KillProcess</a>(
03452     <a class="code" href="../../d2/d4/struct__CONSOLE__PROCESS__TERMINATION__RECORD.html">PCONSOLE_PROCESS_TERMINATION_RECORD</a> ProcessHandleRecord,
03453     ULONG_PTR ProcessId
03454     )
03455 {
03456     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03457 
03458     <span class="comment">//</span>
03459     <span class="comment">// Just terminate the process outright.</span>
03460     <span class="comment">//</span>
03461 
03462     status = <a class="code" href="../../d8/d0/psdelete_8c.html#a4">NtTerminateProcess</a>(ProcessHandleRecord-&gt;<a class="code" href="../../d2/d4/struct__CONSOLE__PROCESS__TERMINATION__RECORD.html#o0">ProcessHandle</a>,
03463                 ProcessHandleRecord-&gt;<a class="code" href="../../d2/d4/struct__CONSOLE__PROCESS__TERMINATION__RECORD.html#o2">bDebugee</a> ? DBG_TERMINATE_PROCESS : CONTROL_C_EXIT);
03464 
03465 <span class="preprocessor">#if DBG</span>
03466 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (status != STATUS_SUCCESS &amp;&amp;
03467             status != STATUS_PROCESS_IS_TERMINATING &amp;&amp;
03468             status != STATUS_THREAD_WAS_SUSPENDED &amp;&amp;
03469             !(status == STATUS_ACCESS_DENIED &amp;&amp; ProcessHandleRecord-&gt;<a class="code" href="../../d2/d4/struct__CONSOLE__PROCESS__TERMINATION__RECORD.html#o2">bDebugee</a>)) {
03470         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"NtTerminateProcess failed - status = %x\n"</span>, status);
03471         DbgBreakPoint();
03472     }
03473 <span class="preprocessor">#endif</span>
03474 <span class="preprocessor"></span>
03475     <span class="comment">//</span>
03476     <span class="comment">// Clear any remaining hard errors for the process.</span>
03477     <span class="comment">//</span>
03478 
03479     <span class="keywordflow">if</span> (ProcessId)
03480         <a class="code" href="../../d7/d1/usersrv_8h.html#a53">BoostHardError</a>(ProcessId, <a class="code" href="../../d7/d1/usersrv_8h.html#a30">BHE_FORCE</a>);
03481 
03482     <span class="comment">//</span>
03483     <span class="comment">// Give the process 5 seconds to exit.</span>
03484     <span class="comment">//</span>
03485 
03486     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03487         LARGE_INTEGER li;
03488 
03489         li.QuadPart = (LONGLONG)-10000 * <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a912">CMSHUNGAPPTIMEOUT</a>;
03490         status = <a class="code" href="../../d1/d2/obwait_8c.html#a4">NtWaitForSingleObject</a>(ProcessHandleRecord-&gt;<a class="code" href="../../d2/d4/struct__CONSOLE__PROCESS__TERMINATION__RECORD.html#o0">ProcessHandle</a>,
03491                                        <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
03492                                        &amp;li);
03493         <span class="keywordflow">if</span> (status != STATUS_WAIT_0) {
03494             RIPMSG2(RIP_WARNING,
03495                     <span class="stringliteral">"KillProcess: wait for process %x failed with status %x"</span>,
03496                     ProcessId, status);
03497         }
03498     }
03499 }
03500 
03501 <span class="keywordtype">int</span>
<a name="l03502"></a><a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a52">03502</a> <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a52">CreateCtrlThread</a>(
03503     IN <a class="code" href="../../d2/d4/struct__CONSOLE__PROCESS__TERMINATION__RECORD.html">PCONSOLE_PROCESS_TERMINATION_RECORD</a> ProcessHandleList,
03504     IN ULONG ProcessHandleListLength,
03505     IN PWCHAR Title,
03506     IN DWORD EventType,
03507     IN BOOL fForce
03508     )
03509 
03510 <span class="comment">// this routine must be called not holding the console lock.</span>
03511 <span class="comment">// returns true if process is exiting</span>
03512 
03513 {
03514     HANDLE Thread;
03515     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03516     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03517     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> ShutdownFlags;
03518     <span class="keywordtype">int</span> Success=<a class="code" href="../../d8/d5/consrv_8h.html#a45">CONSOLE_SHUTDOWN_SUCCEEDED</a>;
03519     ULONG i;
03520     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> EventFlags;
03521     PROCESS_BASIC_INFORMATION BasicInfo;
03522     PCSR_PROCESS Process;
03523     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fForceProcess;
03524     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fExitProcess;
03525     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fFirstPass=<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03526     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fSecondPassNeeded=<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03527     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fHasError;
03528     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fFirstWait;
03529     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fEventProcessed;
03530     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fBreakEvent;
03531 
03532 BigLoop:
03533     <span class="keywordflow">for</span> (i=0;i&lt;ProcessHandleListLength;i++) {
03534 
03535         <span class="comment">//</span>
03536         <span class="comment">// If the user has already cancelled shutdown, don't try to kill</span>
03537         <span class="comment">// any more processes.</span>
03538         <span class="comment">//</span>
03539 
03540         <span class="keywordflow">if</span> (Success == <a class="code" href="../../d8/d5/consrv_8h.html#a44">CONSOLE_SHUTDOWN_FAILED</a>) {
03541             <span class="keywordflow">break</span>;
03542         }
03543 
03544         <span class="comment">//</span>
03545         <span class="comment">// Get the process shutdown parameters here. First get the process</span>
03546         <span class="comment">// id so we can get the csr process structure pointer.</span>
03547         <span class="comment">//</span>
03548 
03549         status = <a class="code" href="../../d9/d1/psquery_8c.html#a18">NtQueryInformationProcess</a>(
03550                 ProcessHandleList[i].ProcessHandle,
03551                 ProcessBasicInformation,
03552                 &amp;BasicInfo,
03553                 <span class="keyword">sizeof</span>(BasicInfo),
03554                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03555 
03556         <span class="comment">//</span>
03557         <span class="comment">// Grab the shutdown flags from the csr process structure.  If</span>
03558         <span class="comment">// the structure cannot be found, terminate the process.</span>
03559         <span class="comment">//</span>
03560 
03561         ProcessHandleList[i].bDebugee = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03562         ShutdownFlags = 0;
03563         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03564             CsrLockProcessByClientId(
03565                     (HANDLE)BasicInfo.UniqueProcessId, &amp;Process);
03566             <span class="keywordflow">if</span> (Process == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03567                 <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a51">KillProcess</a>(&amp;ProcessHandleList[i],
03568                         BasicInfo.UniqueProcessId);
03569                 <span class="keywordflow">continue</span>;
03570             }
03571         } <span class="keywordflow">else</span> {
03572             <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a51">KillProcess</a>(&amp;ProcessHandleList[i], 0);
03573             <span class="keywordflow">continue</span>;
03574         }
03575         ShutdownFlags = Process-&gt;ShutdownFlags;
03576         ProcessHandleList[i].bDebugee = Process-&gt;DebugUserInterface.UniqueProcess!=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03577         CsrUnlockProcess(Process);
03578 
03579         <span class="keywordflow">if</span> (!ProcessHandleList[i].bDebugee) {
03580             HANDLE <a class="code" href="../../d8/d7/udbgk_8c.html#a0">DebugPort</a>;
03581 
03582             <span class="comment">// see if we're a OS/2 app that's being debugged</span>
03583             <a class="code" href="../../d8/d7/udbgk_8c.html#a0">DebugPort</a> = (HANDLE)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03584             status = <a class="code" href="../../d9/d1/psquery_8c.html#a18">NtQueryInformationProcess</a>(
03585                         ProcessHandleList[i].ProcessHandle,
03586                         ProcessDebugPort,
03587                         (PVOID)&amp;<a class="code" href="../../d8/d7/udbgk_8c.html#a0">DebugPort</a>,
03588                         <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d7/udbgk_8c.html#a0">DebugPort</a>),
03589                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
03590                         );
03591             <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; <a class="code" href="../../d8/d7/udbgk_8c.html#a0">DebugPort</a> ) {
03592                 ProcessHandleList[i].bDebugee = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03593             }
03594         }
03595         <span class="keywordflow">if</span> (EventType != CTRL_C_EVENT &amp;&amp; EventType != CTRL_BREAK_EVENT) {
03596             fBreakEvent = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03597             <span class="keywordflow">if</span> (fFirstPass) {
03598                 <span class="keywordflow">if</span> (ProcessHandleList[i].bDebugee) {
03599                     fSecondPassNeeded = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03600                     <span class="keywordflow">continue</span>;
03601                 }
03602             } <span class="keywordflow">else</span> {
03603                 <span class="keywordflow">if</span> (!ProcessHandleList[i].bDebugee) {
03604                     <span class="keywordflow">continue</span>;
03605                 }
03606             }
03607         } <span class="keywordflow">else</span> {
03608             fBreakEvent = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03609             fFirstPass=<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03610         }
03611 
03612         <span class="comment">//</span>
03613         <span class="comment">// fForce is whether ExitWindowsEx was called with EWX_FORCE.</span>
03614         <span class="comment">// ShutdownFlags are the shutdown flags for this process. If</span>
03615         <span class="comment">// either are force (noretry is the same as force), then force:</span>
03616         <span class="comment">// which means if the app doesn't exit, don't bring up the retry</span>
03617         <span class="comment">// dialog - just force it to exit right away.</span>
03618         <span class="comment">//</span>
03619 
03620         fForceProcess = fForce || (ShutdownFlags &amp; SHUTDOWN_NORETRY);
03621 
03622         <span class="comment">//</span>
03623         <span class="comment">// Only notify system security and service context processes.</span>
03624         <span class="comment">// Don't bring up retry dialogs for them.</span>
03625         <span class="comment">//</span>
03626 
03627         fExitProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03628         EventFlags = 0;
03629         <span class="keywordflow">if</span> (ShutdownFlags &amp; (SHUTDOWN_SYSTEMCONTEXT | SHUTDOWN_OTHERCONTEXT)) {
03630 
03631             <span class="comment">//</span>
03632             <span class="comment">// System context - make sure we don't cause it to exit, make</span>
03633             <span class="comment">// sure we don't bring up retry dialogs.</span>
03634             <span class="comment">//</span>
03635 
03636             fExitProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03637             fForceProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03638 
03639             <span class="comment">//</span>
03640             <span class="comment">// This EventFlag will be passed on down to the CtrlRoutine()</span>
03641             <span class="comment">// on the client side. That way that side knows not to exit</span>
03642             <span class="comment">// this process.</span>
03643             <span class="comment">//</span>
03644 
03645             EventFlags = 0x80000000;
03646         }
03647 
03648         <span class="comment">//</span>
03649         <span class="comment">// Is this the first time we're waiting for this process to die?</span>
03650         <span class="comment">//</span>
03651 
03652         fFirstWait = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03653         fEventProcessed = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03654 
03655         <span class="keywordflow">while</span> (!fEventProcessed) {
03656             <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> ThreadExitCode;
03657             <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> ProcessExitCode;
03658             <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> cMsTimeout;
03659 
03660             Thread = <a class="code" href="../../d2/d0/server_2exitwin_8c.html#a19">InternalCreateCallbackThread</a>(
03661                     ProcessHandleList[i].ProcessHandle,
03662                     (ULONG_PTR)ProcessHandleList[i].<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a10">CtrlRoutine</a>,
03663                     EventType | EventFlags);
03664 
03665             <span class="comment">//</span>
03666             <span class="comment">// If the thread cannot be created, terminate the process.</span>
03667             <span class="comment">//</span>
03668 
03669             <span class="keywordflow">if</span> (Thread == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03670                 KdPrint((<span class="stringliteral">"CONSRV: CreateRemoteThread failed %x\n"</span>,GetLastError()));
03671                 <span class="keywordflow">break</span>;
03672             }
03673 
03674             <span class="comment">//</span>
03675             <span class="comment">// Mark the event as processed.</span>
03676             <span class="comment">//</span>
03677 
03678             fEventProcessed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03679 
03680             <span class="comment">/*</span>
03681 <span class="comment">             * if it's a ctrl-c or ctrl-break event, just close our</span>
03682 <span class="comment">             * handle to the thread.  otherwise it's a close.  wait</span>
03683 <span class="comment">             * for client-side thread to terminate.</span>
03684 <span class="comment">             */</span>
03685 
03686             <span class="keywordflow">if</span> (EventType == CTRL_CLOSE_EVENT) {
03687                 cMsTimeout = <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a2">gCmsHungAppTimeout</a>;
03688             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (EventType == CTRL_LOGOFF_EVENT) {
03689                 cMsTimeout = <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a3">gCmsWaitToKillTimeout</a>;
03690             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (EventType == CTRL_SHUTDOWN_EVENT) {
03691 
03692                 <span class="comment">//</span>
03693                 <span class="comment">// If we are shutting down services.exe, we need to look in the</span>
03694                 <span class="comment">// registry to see how long to wait.</span>
03695                 <span class="comment">//</span>
03696 
03697                 <span class="keywordflow">if</span> (fFirstWait &amp;&amp; BasicInfo.UniqueProcessId == <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a7">gdwServicesProcessId</a>) {
03698                     cMsTimeout = <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a8">gdwServicesWaitToKillTimeout</a>;
03699                 } <span class="keywordflow">else</span> {
03700                     cMsTimeout = <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a3">gCmsWaitToKillTimeout</a>;
03701                 }
03702             } <span class="keywordflow">else</span> {
03703                 CloseHandle(Thread);
03704                 fExitProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03705                 <span class="keywordflow">break</span>;
03706             }
03707 
03708             <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
03709                 fHasError = <a class="code" href="../../d7/d1/usersrv_8h.html#a53">BoostHardError</a>(BasicInfo.UniqueProcessId,
03710                         (fForceProcess ? <a class="code" href="../../d7/d1/usersrv_8h.html#a30">BHE_FORCE</a> : <a class="code" href="../../d7/d1/usersrv_8h.html#a29">BHE_ACTIVATE</a>));
03711 
03712                 <span class="comment">//</span>
03713                 <span class="comment">// Use a 1 second wait if there was a hard error, otherwise</span>
03714                 <span class="comment">// wait cMsTimeout ms.</span>
03715                 <span class="comment">//</span>
03716 
03717                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d0/server_2exitwin_8c.html#a18">InternalWaitCancel</a>(Thread,
03718                         (fHasError &amp;&amp; fForceProcess) ? 1000 : cMsTimeout);
03719                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == WAIT_TIMEOUT) {
03720                     <span class="keywordtype">int</span> <a class="code" href="../../d7/d0/cmdat2_8c.html#a18">Action</a>;
03721 
03722                     <span class="comment">//</span>
03723                     <span class="comment">// If there was a hard error, see if there is another one.</span>
03724                     <span class="comment">//</span>
03725 
03726                     <span class="keywordflow">if</span> (fHasError &amp;&amp; fForceProcess) {
03727                         <span class="keywordflow">continue</span>;
03728                     }
03729 
03730                     <span class="keywordflow">if</span> (!fForceProcess) {
03731 
03732                         <span class="comment">//</span>
03733                         <span class="comment">// we timed out in the handler.  ask the user what</span>
03734                         <span class="comment">// to do.</span>
03735                         <span class="comment">//</span>
03736 
03737                         <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a9">DialogBoxCount</a>++;
03738                         <a class="code" href="../../d7/d0/cmdat2_8c.html#a18">Action</a> = <a class="code" href="../../d7/d1/usersrv_8h.html#a54">ThreadShutdownNotify</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a134">WMCS_CONSOLE</a>, (ULONG_PTR)Thread, (LPARAM)Title);
03739                         <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a9">DialogBoxCount</a>--;
03740 
03741                         <span class="comment">//</span>
03742                         <span class="comment">// If the response is Cancel or EndTask, exit the loop.</span>
03743                         <span class="comment">// Otherwise retry the wait.</span>
03744                         <span class="comment">//</span>
03745 
03746                         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/cmdat2_8c.html#a18">Action</a> == <a class="code" href="../../d7/d1/usersrv_8h.html#a19">TSN_USERSAYSCANCEL</a>) {
03747                             Success = <a class="code" href="../../d8/d5/consrv_8h.html#a44">CONSOLE_SHUTDOWN_FAILED</a>;
03748                         }
03749                     }
03750                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == 0) {
03751                     ThreadExitCode = 0;
03752                     GetExitCodeThread(Thread,&amp;ThreadExitCode);
03753                     GetExitCodeProcess(ProcessHandleList[i].ProcessHandle,
03754                             &amp;ProcessExitCode);
03755 
03756                     <span class="comment">//</span>
03757                     <span class="comment">// if the app returned TRUE (event handled)</span>
03758                     <span class="comment">// notify the user and see if the app should</span>
03759                     <span class="comment">// be terminated anyway.</span>
03760                     <span class="comment">//</span>
03761 
03762                     <span class="keywordflow">if</span> (fHasError || (ThreadExitCode == EventType &amp;&amp;
03763                             ProcessExitCode == STILL_ACTIVE)) {
03764                         <span class="keywordtype">int</span> <a class="code" href="../../d7/d0/cmdat2_8c.html#a18">Action</a>;
03765 
03766                         <span class="keywordflow">if</span> (!fForceProcess) {
03767 
03768                             <span class="comment">//</span>
03769                             <span class="comment">// Wait for the process to exit.  If it does exit,</span>
03770                             <span class="comment">// don't bring up the end task dialog.</span>
03771                             <span class="comment">//</span>
03772 
03773                             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d0/server_2exitwin_8c.html#a18">InternalWaitCancel</a>(ProcessHandleList[i].ProcessHandle,
03774                                     (fHasError || fFirstWait) ? 1000 : cMsTimeout);
03775                             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == 0) {
03776 
03777                                 <span class="comment">//</span>
03778                                 <span class="comment">// The process exited.</span>
03779                                 <span class="comment">//</span>
03780 
03781                                 fExitProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03782                             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == WAIT_TIMEOUT) {
03783                                 <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a9">DialogBoxCount</a>++;
03784                                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a18">Action</a> = <a class="code" href="../../d7/d1/usersrv_8h.html#a54">ThreadShutdownNotify</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a134">WMCS_CONSOLE</a>,
03785                                                               (ULONG_PTR)ProcessHandleList[i].ProcessHandle,
03786                                                                (LPARAM)Title);
03787                                 <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a9">DialogBoxCount</a>--;
03788 
03789                                 <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/cmdat2_8c.html#a18">Action</a> == <a class="code" href="../../d7/d1/usersrv_8h.html#a19">TSN_USERSAYSCANCEL</a>) {
03790                                     Success = <a class="code" href="../../d8/d5/consrv_8h.html#a44">CONSOLE_SHUTDOWN_FAILED</a>;
03791                                 }
03792                             }
03793                         }
03794                     } <span class="keywordflow">else</span> {
03795 
03796                         <span class="comment">//</span>
03797                         <span class="comment">// The process exited.</span>
03798                         <span class="comment">//</span>
03799 
03800                         fExitProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03801                     }
03802                 }
03803 
03804                 <span class="comment">//</span>
03805                 <span class="comment">// If we get here, we know that all wait conditions have</span>
03806                 <span class="comment">// been satisfied.  Time to finish with the process.</span>
03807                 <span class="comment">//</span>
03808 
03809                 <span class="keywordflow">break</span>;
03810             }
03811 
03812             CloseHandle(Thread);
03813         }
03814 
03815         <span class="comment">//</span>
03816         <span class="comment">// If the process is shutting down, mark it as terminated.</span>
03817         <span class="comment">// This prevents the process from raising any hard error popups</span>
03818         <span class="comment">// after we're done shutting it down.</span>
03819         <span class="comment">//</span>
03820 
03821         <span class="keywordflow">if</span> (!fBreakEvent &amp;&amp;
03822                 !(ShutdownFlags &amp; (SHUTDOWN_SYSTEMCONTEXT | SHUTDOWN_OTHERCONTEXT)) &amp;&amp;
03823                 Success == <a class="code" href="../../d8/d5/consrv_8h.html#a45">CONSOLE_SHUTDOWN_SUCCEEDED</a>) {
03824             CsrLockProcessByClientId(
03825                     (HANDLE)BasicInfo.UniqueProcessId, &amp;Process);
03826             <span class="keywordflow">if</span> (Process) {
03827                 Process-&gt;Flags |= CSR_PROCESS_TERMINATED;
03828                 CsrUnlockProcess(Process);
03829             }
03830 
03831             <span class="comment">//</span>
03832             <span class="comment">// Force the termination of the process if needed.  Otherwise,</span>
03833             <span class="comment">// acknowledge any remaining hard errors.</span>
03834             <span class="comment">//</span>
03835             <span class="keywordflow">if</span> (fExitProcess) {
03836                 <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a51">KillProcess</a>(&amp;ProcessHandleList[i],
03837                         BasicInfo.UniqueProcessId);
03838             } <span class="keywordflow">else</span> {
03839                 <a class="code" href="../../d7/d1/usersrv_8h.html#a53">BoostHardError</a>(BasicInfo.UniqueProcessId, <a class="code" href="../../d7/d1/usersrv_8h.html#a30">BHE_FORCE</a>);
03840             }
03841         }
03842     }
03843 
03844     <span class="comment">//</span>
03845     <span class="comment">// If this was our first time through and we skipped one of the</span>
03846     <span class="comment">// processes because it was being debugged, we'll go back for a</span>
03847     <span class="comment">// second pass.</span>
03848     <span class="comment">//</span>
03849 
03850     <span class="keywordflow">if</span> (fFirstPass &amp;&amp; fSecondPassNeeded) {
03851         fFirstPass = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03852         <span class="keywordflow">goto</span> BigLoop;
03853     }
03854 
03855     <span class="comment">// if we're shutting down a system or service security context</span>
03856     <span class="comment">// thread, don't wait for the process to terminate</span>
03857 
03858     <span class="keywordflow">if</span> (ShutdownFlags &amp; (SHUTDOWN_SYSTEMCONTEXT | SHUTDOWN_OTHERCONTEXT)) {
03859         <span class="keywordflow">return</span> <a class="code" href="../../d8/d5/consrv_8h.html#a46">CONSOLE_SHUTDOWN_SYSTEM</a>;
03860     }
03861     <span class="keywordflow">return</span> Success;
03862 }
03863 
03864 <span class="keywordtype">int</span>
<a name="l03865"></a><a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a53">03865</a> <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a53">ProcessCtrlEvents</a>(
03866     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console
03867     )
03868 <span class="comment">/* returns TRUE if a ctrl thread was created */</span>
03869 {
03870     PWCHAR Title;
03871     <a class="code" href="../../d2/d4/struct__CONSOLE__PROCESS__TERMINATION__RECORD.html">CONSOLE_PROCESS_TERMINATION_RECORD</a> ProcessHandles[2];
03872     <a class="code" href="../../d2/d4/struct__CONSOLE__PROCESS__TERMINATION__RECORD.html">PCONSOLE_PROCESS_TERMINATION_RECORD</a> ProcessHandleList;
03873     ULONG ProcessHandleListLength,i;
03874     ULONG CtrlFlags;
03875     PLIST_ENTRY ListHead, ListNext;
03876     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> FreeTitle;
03877     <span class="keywordtype">int</span> Success;
03878     <a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html">PCONSOLE_PROCESS_HANDLE</a> ProcessHandleRecord;
03879     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> EventType;
03880     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> LimitingProcessId;
03881     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03882 
03883     <span class="comment">//</span>
03884     <span class="comment">// If the console was marked for destruction, do it now.</span>
03885     <span class="comment">//</span>
03886 
03887     <span class="keywordflow">if</span> (Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a22">CONSOLE_IN_DESTRUCTION</a>) {
03888         <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a20">DestroyConsole</a>(Console);
03889         <span class="keywordflow">return</span> <a class="code" href="../../d8/d5/consrv_8h.html#a44">CONSOLE_SHUTDOWN_FAILED</a>;
03890     }
03891 
03892     <span class="comment">//</span>
03893     <span class="comment">// make sure we don't try to process control events if this</span>
03894     <span class="comment">// console is already going away</span>
03895     <span class="comment">//</span>
03896 
03897     <span class="keywordflow">if</span> (Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a12">CONSOLE_TERMINATING</a>) {
03898         Console-&gt;CtrlFlags = 0;
03899     }
03900 
03901     <span class="keywordflow">if</span> (Console-&gt;CtrlFlags == 0) {
03902         RtlLeaveCriticalSection(&amp;Console-&gt;ConsoleLock);
03903         <span class="keywordflow">return</span> <a class="code" href="../../d8/d5/consrv_8h.html#a44">CONSOLE_SHUTDOWN_FAILED</a>;
03904     }
03905 
03906     <span class="comment">//</span>
03907     <span class="comment">// make our own copy of the console process handle list</span>
03908     <span class="comment">//</span>
03909 
03910     LimitingProcessId = Console-&gt;LimitingProcessId;
03911     Console-&gt;LimitingProcessId = 0;
03912 
03913     ListHead = &amp;Console-&gt;ProcessHandleList;
03914     ListNext = ListHead-&gt;Flink;
03915     ProcessHandleListLength = 0;
03916     <span class="keywordflow">while</span> (ListNext != ListHead) {
03917         ProcessHandleRecord = CONTAINING_RECORD( ListNext, <a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html">CONSOLE_PROCESS_HANDLE</a>, ListLink );
03918         ListNext = ListNext-&gt;Flink;
03919         <span class="keywordflow">if</span> ( LimitingProcessId ) {
03920             <span class="keywordflow">if</span> ( ProcessHandleRecord-&gt;<a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html#o2">Process</a>-&gt;ProcessGroupId == LimitingProcessId ) {
03921                 ProcessHandleListLength += 1;
03922             }
03923         } <span class="keywordflow">else</span> {
03924             ProcessHandleListLength += 1;
03925         }
03926     }
03927 
03928     <span class="comment">//</span>
03929     <span class="comment">// Use the stack buffer to hold the process handles if there are only a</span>
03930     <span class="comment">// few, otherwise allocate a buffer from the heap.</span>
03931     <span class="comment">//</span>
03932 
03933     <span class="keywordflow">if</span> (ProcessHandleListLength &lt;= <a class="code" href="../../d2/d3/tnlsxlat_8c.html#a0">NELEM</a>(ProcessHandles)) {
03934         ProcessHandleList = ProcessHandles;
03935     } <span class="keywordflow">else</span> {
03936         ProcessHandleList = (<a class="code" href="../../d2/d4/struct__CONSOLE__PROCESS__TERMINATION__RECORD.html">PCONSOLE_PROCESS_TERMINATION_RECORD</a>)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a9">TMP_TAG</a> ),ProcessHandleListLength * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__CONSOLE__PROCESS__TERMINATION__RECORD.html">CONSOLE_PROCESS_TERMINATION_RECORD</a>));
03937         <span class="keywordflow">if</span> (ProcessHandleList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03938             RtlLeaveCriticalSection(&amp;Console-&gt;ConsoleLock);
03939             <span class="keywordflow">return</span> <a class="code" href="../../d8/d5/consrv_8h.html#a44">CONSOLE_SHUTDOWN_FAILED</a>;
03940         }
03941     }
03942 
03943     ListNext = ListHead-&gt;Flink;
03944     i=0;
03945     <span class="keywordflow">while</span> (ListNext != ListHead) {
03946         BOOLEAN ProcessIsIn;
03947 
03948         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(i&lt;=ProcessHandleListLength);
03949         ProcessHandleRecord = CONTAINING_RECORD( ListNext, <a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html">CONSOLE_PROCESS_HANDLE</a>, ListLink );
03950         ListNext = ListNext-&gt;Flink;
03951 
03952         <span class="keywordflow">if</span> ( LimitingProcessId ) {
03953             <span class="keywordflow">if</span> ( ProcessHandleRecord-&gt;<a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html#o2">Process</a>-&gt;ProcessGroupId == LimitingProcessId ) {
03954                 ProcessIsIn = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03955             } <span class="keywordflow">else</span> {
03956                 ProcessIsIn = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03957             }
03958         } <span class="keywordflow">else</span> {
03959             ProcessIsIn = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03960         }
03961 
03962         <span class="keywordflow">if</span> ( ProcessIsIn ) {
03963             Success = (<span class="keywordtype">int</span>)DuplicateHandle(NtCurrentProcess(),
03964                            ProcessHandleRecord-&gt;<a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html#o1">ProcessHandle</a>,
03965                            NtCurrentProcess(),
03966                            &amp;ProcessHandleList[i].ProcessHandle,
03967                            0,
03968                            <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
03969                            DUPLICATE_SAME_ACCESS);
03970 
03971             <span class="comment">//</span>
03972             <span class="comment">// If the duplicate failed, the best we can do is to skip</span>
03973             <span class="comment">// including the process in the list and hope it goes</span>
03974             <span class="comment">// away.</span>
03975             <span class="comment">//</span>
03976             <span class="keywordflow">if</span> (!Success) {
03977                 KdPrint((<span class="stringliteral">"CONSRV: dup handle failed for %d of %d in %lx\n"</span>,
03978                          i, ProcessHandleListLength, Console));
03979                 <span class="keywordflow">continue</span>;
03980             }
03981 
03982             <span class="keywordflow">if</span> (Console-&gt;CtrlFlags &amp; <a class="code" href="../../d1/d7/server_8h.html#a33">CONSOLE_CTRL_CLOSE_FLAG</a>) {
03983                 ProcessHandleRecord-&gt;<a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html#o3">TerminateCount</a>++;
03984             } <span class="keywordflow">else</span> {
03985                 ProcessHandleRecord-&gt;<a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html#o3">TerminateCount</a> = 0;
03986             }
03987             ProcessHandleList[i].<a class="code" href="../../d2/d4/struct__CONSOLE__PROCESS__TERMINATION__RECORD.html#o1">TerminateCount</a> = ProcessHandleRecord-&gt;<a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html#o3">TerminateCount</a>;
03988 
03989             <span class="keywordflow">if</span> (ProcessHandleRecord-&gt;<a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html#o4">CtrlRoutine</a>) {
03990                 ProcessHandleList[i].<a class="code" href="../../d2/d4/struct__CONSOLE__PROCESS__TERMINATION__RECORD.html#o3">CtrlRoutine</a> = ProcessHandleRecord-&gt;<a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html#o4">CtrlRoutine</a>;
03991             } <span class="keywordflow">else</span> {
03992                 ProcessHandleList[i].<a class="code" href="../../d2/d4/struct__CONSOLE__PROCESS__TERMINATION__RECORD.html#o3">CtrlRoutine</a> = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a10">CtrlRoutine</a>;
03993             }
03994 
03995             <span class="comment">//</span>
03996             <span class="comment">// If this is the VDM process and we're closing the</span>
03997             <span class="comment">// console window, move it to the front of the list</span>
03998             <span class="comment">//</span>
03999 
04000             <span class="keywordflow">if</span> (i &gt; 0 &amp;&amp; Console-&gt;VDMProcessId &amp;&amp; Console-&gt;VDMProcessId ==
04001                     ProcessHandleRecord-&gt;<a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html#o2">Process</a>-&gt;ClientId.UniqueProcess &amp;&amp;
04002                     ProcessHandleRecord-&gt;<a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html#o3">TerminateCount</a> &gt; 0) {
04003                 <a class="code" href="../../d2/d4/struct__CONSOLE__PROCESS__TERMINATION__RECORD.html">CONSOLE_PROCESS_TERMINATION_RECORD</a> ProcessHandle;
04004                 ProcessHandle = ProcessHandleList[0];
04005                 ProcessHandleList[0] = ProcessHandleList[i];
04006                 ProcessHandleList[i] = ProcessHandle;
04007             }
04008 
04009             i++;
04010         }
04011     }
04012     ProcessHandleListLength = i;
04013     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ProcessHandleListLength &gt; 0);
04014 
04015     <span class="comment">// copy title.  titlelength does not include terminating null.</span>
04016 
04017     Title = (PWCHAR)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a13">TITLE_TAG</a> ),Console-&gt;TitleLength+<span class="keyword">sizeof</span>(WCHAR));
04018     <span class="keywordflow">if</span> (Title) {
04019         FreeTitle = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04020         RtlCopyMemory(Title,Console-&gt;Title,Console-&gt;TitleLength+<span class="keyword">sizeof</span>(WCHAR));
04021     } <span class="keywordflow">else</span> {
04022         FreeTitle = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04023         Title = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Command Window"</span>;
04024     }
04025 
04026     <span class="comment">// copy ctrl flags</span>
04027 
04028     CtrlFlags = Console-&gt;CtrlFlags;
04029     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( !((CtrlFlags &amp; (<a class="code" href="../../d1/d7/server_8h.html#a33">CONSOLE_CTRL_CLOSE_FLAG</a> | <a class="code" href="../../d1/d7/server_8h.html#a32">CONSOLE_CTRL_BREAK_FLAG</a> | <a class="code" href="../../d1/d7/server_8h.html#a31">CONSOLE_CTRL_C_FLAG</a>)) &amp;&amp;
04030               (CtrlFlags &amp; (<a class="code" href="../../d1/d7/server_8h.html#a35">CONSOLE_CTRL_LOGOFF_FLAG</a> | <a class="code" href="../../d1/d7/server_8h.html#a36">CONSOLE_CTRL_SHUTDOWN_FLAG</a>)) ));
04031 
04032     Console-&gt;CtrlFlags = 0;
04033 
04034     RtlLeaveCriticalSection(&amp;Console-&gt;ConsoleLock);
04035 
04036     <span class="comment">//</span>
04037     <span class="comment">// the ctrl flags could be a combination of the following</span>
04038     <span class="comment">// values:</span>
04039     <span class="comment">//</span>
04040     <span class="comment">//        CONSOLE_CTRL_C_FLAG</span>
04041     <span class="comment">//        CONSOLE_CTRL_BREAK_FLAG</span>
04042     <span class="comment">//        CONSOLE_CTRL_CLOSE_FLAG</span>
04043     <span class="comment">//        CONSOLE_CTRL_LOGOFF_FLAG</span>
04044     <span class="comment">//        CONSOLE_CTRL_SHUTDOWN_FLAG</span>
04045     <span class="comment">//</span>
04046 
04047     Success = <a class="code" href="../../d8/d5/consrv_8h.html#a44">CONSOLE_SHUTDOWN_FAILED</a>;
04048 
04049     EventType = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)-1;
04050     <span class="keywordflow">switch</span> (CtrlFlags &amp; (<a class="code" href="../../d1/d7/server_8h.html#a33">CONSOLE_CTRL_CLOSE_FLAG</a> | <a class="code" href="../../d1/d7/server_8h.html#a32">CONSOLE_CTRL_BREAK_FLAG</a> |
04051             <a class="code" href="../../d1/d7/server_8h.html#a31">CONSOLE_CTRL_C_FLAG</a> | <a class="code" href="../../d1/d7/server_8h.html#a35">CONSOLE_CTRL_LOGOFF_FLAG</a> |
04052             <a class="code" href="../../d1/d7/server_8h.html#a36">CONSOLE_CTRL_SHUTDOWN_FLAG</a>)) {
04053 
04054     <span class="keywordflow">case</span> <a class="code" href="../../d1/d7/server_8h.html#a33">CONSOLE_CTRL_CLOSE_FLAG</a>:
04055         EventType = CTRL_CLOSE_EVENT;
04056         <span class="keywordflow">break</span>;
04057 
04058     <span class="keywordflow">case</span> <a class="code" href="../../d1/d7/server_8h.html#a32">CONSOLE_CTRL_BREAK_FLAG</a>:
04059         EventType = CTRL_BREAK_EVENT;
04060         <span class="keywordflow">break</span>;
04061 
04062     <span class="keywordflow">case</span> <a class="code" href="../../d1/d7/server_8h.html#a31">CONSOLE_CTRL_C_FLAG</a>:
04063         EventType = CTRL_C_EVENT;
04064         <span class="keywordflow">break</span>;
04065 
04066     <span class="keywordflow">case</span> <a class="code" href="../../d1/d7/server_8h.html#a35">CONSOLE_CTRL_LOGOFF_FLAG</a>:
04067         EventType = CTRL_LOGOFF_EVENT;
04068         <span class="keywordflow">break</span>;
04069 
04070     <span class="keywordflow">case</span> <a class="code" href="../../d1/d7/server_8h.html#a36">CONSOLE_CTRL_SHUTDOWN_FLAG</a>:
04071         EventType = CTRL_SHUTDOWN_EVENT;
04072         <span class="keywordflow">break</span>;
04073     }
04074 
04075     <span class="keywordflow">if</span> (EventType != (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)-1) {
04076 
04077         Success = <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a52">CreateCtrlThread</a>(ProcessHandleList,
04078                 ProcessHandleListLength,
04079                 Title,
04080                 EventType,
04081                 (CtrlFlags &amp; <a class="code" href="../../d1/d7/server_8h.html#a34">CONSOLE_FORCE_SHUTDOWN_FLAG</a>) != 0
04082                 );
04083     }
04084 
04085     <span class="keywordflow">if</span> (FreeTitle) {
04086         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(Title);
04087     }
04088 
04089     <span class="keywordflow">for</span> (i=0;i&lt;ProcessHandleListLength;i++) {
04090         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(ProcessHandleList[i].ProcessHandle);
04091         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
04092     }
04093 
04094     <span class="keywordflow">if</span> (ProcessHandleList != ProcessHandles) {
04095         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(ProcessHandleList);
04096     }
04097 
04098     <span class="keywordflow">return</span> Success;
04099 }
04100 
04101 
04102 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04103"></a><a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">04103</a> <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(
04104     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console
04105     )
04106 {
04107     LIST_ENTRY WaitQueue;
04108 
04109     <span class="comment">//</span>
04110     <span class="comment">// Make sure the console pointer is still valid</span>
04111     <span class="comment">//</span>
04112     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a15">ValidateConsole</a>(Console)));
04113 
04114 <span class="preprocessor">#ifdef i386</span>
04115 <span class="preprocessor"></span>    <span class="comment">//</span>
04116     <span class="comment">// do nothing if we are in screen switching(handshaking with ntvdm)</span>
04117     <span class="comment">// we don't check anything else because we are in a safe state here.</span>
04118     <span class="comment">//</span>
04119     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a14">ConsoleVDMOnSwitching</a> == Console &amp;&amp;
04120         <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a14">ConsoleVDMOnSwitching</a>-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o52">VDMProcessId</a> == <a class="code" href="../../d1/d7/server_8h.html#a80">CONSOLE_CLIENTPROCESSID</a>()) {
04121         KdPrint((<span class="stringliteral">"    UnlockConsole - Thread %lx is leaving VDM CritSec\n"</span>, GetCurrentThreadId()));
04122         RtlLeaveCriticalSection(&amp;<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a13">ConsoleVDMCriticalSection</a>);
04123         <span class="keywordflow">return</span>;
04124     }
04125 <span class="preprocessor">#endif</span>
04126 <span class="preprocessor"></span>
04127     <span class="comment">//</span>
04128     <span class="comment">// if we're about to release the console lock, see if there</span>
04129     <span class="comment">// are any satisfied wait blocks that need to be dereferenced.</span>
04130     <span class="comment">// this code avoids a deadlock between grabbing the console</span>
04131     <span class="comment">// lock and then grabbing the process structure lock.</span>
04132     <span class="comment">//</span>
04133 <span class="preprocessor">#if defined(_X86_)</span>
04134 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (Console-&gt;ConsoleLock.RecursionCount == 1) {
04135 <span class="preprocessor">#endif</span>
04136 <span class="preprocessor"></span><span class="preprocessor">#if defined(_MIPS_) || defined(_ALPHA_) || defined(_PPC_) || defined(_IA64_)</span>
04137 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (Console-&gt;ConsoleLock.RecursionCount == 0) {
04138 <span class="preprocessor">#endif</span>
04139 <span class="preprocessor"></span>        InitializeListHead(&amp;WaitQueue);
04140         <span class="keywordflow">if</span> (Console-&gt;WaitQueue) {
04141             CsrMoveSatisfiedWait(&amp;WaitQueue, Console-&gt;WaitQueue);
04142             Console-&gt;WaitQueue = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04143         }
04144         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a53">ProcessCtrlEvents</a>(Console);
04145 
04146         <span class="comment">/*</span>
04147 <span class="comment">         * Can't call CsrDereferenceWait with the console locked or we could deadlock.</span>
04148 <span class="comment">         */</span>
04149         <span class="keywordflow">if</span> (!IsListEmpty(&amp;WaitQueue)) {
04150             CsrDereferenceWait(&amp;WaitQueue);
04151         }
04152     } <span class="keywordflow">else</span> {
04153         RtlLeaveCriticalSection(&amp;Console-&gt;ConsoleLock);
04154     }
04155 }
04156 
04157 ULONG
04158 <a class="code" href="../../d8/d5/consrv_8h.html#a154">ShutdownConsole</a>(
04159     IN HANDLE ConsoleHandle,
04160     IN <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>
04161     )
04162 <span class="comment">/*</span>
04163 <span class="comment">    returns TRUE if console shutdown.  we recurse here so we don't</span>
04164 <span class="comment">    return from the WM_QUERYENDSESSION until the console is gone.</span>
04165 <span class="comment"></span>
04166 <span class="comment">*/</span>
04167 
04168 {
04169     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> EventFlag;
04170     <span class="keywordtype">int</span> WaitForShutdown;
04171     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
04172 
04173     EventFlag = 0;
04174 
04175     <span class="comment">//</span>
04176     <span class="comment">// Transmit the force bit (meaning don't bring up the retry dialog</span>
04177     <span class="comment">// if the app times out.</span>
04178     <span class="comment">//</span>
04179 
04180     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; EWX_FORCE)
04181         EventFlag |= <a class="code" href="../../d1/d7/server_8h.html#a34">CONSOLE_FORCE_SHUTDOWN_FLAG</a>;
04182 
04183     <span class="comment">//</span>
04184     <span class="comment">// Remember if this is shutdown or logoff - inquiring apps want to know.</span>
04185     <span class="comment">//</span>
04186 
04187     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; EWX_SHUTDOWN) {
04188         EventFlag |= <a class="code" href="../../d1/d7/server_8h.html#a36">CONSOLE_CTRL_SHUTDOWN_FLAG</a>;
04189     } <span class="keywordflow">else</span> {
04190         EventFlag |= <a class="code" href="../../d1/d7/server_8h.html#a35">CONSOLE_CTRL_LOGOFF_FLAG</a>;
04191     }
04192 
04193     <span class="comment">//</span>
04194     <span class="comment">// see if console already going away</span>
04195     <span class="comment">//</span>
04196 
04197     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a34">RevalidateConsole</a>(ConsoleHandle, &amp;Console))) {
04198         KdPrint((<span class="stringliteral">"CONSRV: Shutting down terminating console\n"</span>));
04199         <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a13">SHUTDOWN_KNOWN_PROCESS</a>;
04200     }
04201 
04202     Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> |= <a class="code" href="../../d1/d7/server_8h.html#a15">CONSOLE_SHUTTING_DOWN</a>;
04203     Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o66">CtrlFlags</a> = EventFlag;
04204     Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o67">LimitingProcessId</a> = 0;
04205 
04206     WaitForShutdown = <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a53">ProcessCtrlEvents</a>(Console);
04207     <span class="keywordflow">if</span> (WaitForShutdown == <a class="code" href="../../d8/d5/consrv_8h.html#a45">CONSOLE_SHUTDOWN_SUCCEEDED</a>) {
04208         <span class="keywordflow">return</span> (ULONG)STATUS_PROCESS_IS_TERMINATING;
04209     } <span class="keywordflow">else</span> {
04210         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a34">RevalidateConsole</a>(ConsoleHandle, &amp;Console))) {
04211             <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a13">SHUTDOWN_KNOWN_PROCESS</a>;
04212         }
04213         Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp;= ~<a class="code" href="../../d1/d7/server_8h.html#a15">CONSOLE_SHUTTING_DOWN</a>;
04214         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
04215         <span class="keywordflow">if</span> (WaitForShutdown == <a class="code" href="../../d8/d5/consrv_8h.html#a46">CONSOLE_SHUTDOWN_SYSTEM</a>) {
04216             <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a13">SHUTDOWN_KNOWN_PROCESS</a>;
04217         } <span class="keywordflow">else</span> {
04218             <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a15">SHUTDOWN_CANCEL</a>;
04219         }
04220     }
04221 }
04222 
04223 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a12">UserExitWorkerThread</a>(<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)
04224 
04225 <span class="comment">/*++</span>
04226 <span class="comment"></span>
04227 <span class="comment">Routine Description:</span>
04228 <span class="comment"></span>
04229 <span class="comment">    The current thread can exit using ExitThread.</span>
04230 <span class="comment"></span>
04231 <span class="comment">    ExitThread is the prefered method of exiting a thread.  When this</span>
04232 <span class="comment">    API is called (either explicitly or by returning from a thread</span>
04233 <span class="comment">    procedure), The current thread's stack is deallocated and the thread</span>
04234 <span class="comment">    terminates.  If the thread is the last thread in the process when</span>
04235 <span class="comment">    this API is called, the behavior of this API does not change.  DLLs</span>
04236 <span class="comment">    are not notified as a result of a call to ExitThread.</span>
04237 <span class="comment"></span>
04238 <span class="comment">Arguments:</span>
04239 <span class="comment"></span>
04240 <span class="comment">    dwExitCode - Supplies the termination status for the thread.</span>
04241 <span class="comment"></span>
04242 <span class="comment">Return Value:</span>
04243 <span class="comment"></span>
04244 <span class="comment">    None.</span>
04245 <span class="comment"></span>
04246 <span class="comment">--*/</span>
04247 
04248 {
04249     MEMORY_BASIC_INFORMATION MemInfo;
04250     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
04251     <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> SwitchStackThenTerminate(PVOID CurrentStack, PVOID NewStack, <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> ExitCode);
04252 
04253     st = <a class="code" href="../../d5/d3/queryvm_8c.html#a4">NtQueryVirtualMemory</a>(
04254             NtCurrentProcess(),
04255             NtCurrentTeb()-&gt;NtTib.StackLimit,
04256             MemoryBasicInformation,
04257             (PVOID)&amp;MemInfo,
04258             <span class="keyword">sizeof</span>(MemInfo),
04259             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
04260             );
04261     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
04262         <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(st);
04263         }
04264 
04265     SwitchStackThenTerminate(
04266         MemInfo.AllocationBase,
04267         &amp;NtCurrentTeb()-&gt;UserReserved[0],
04268         0
04269         );
04270 }
04271 
04272 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> FreeStackAndTerminate(
04273     IN PVOID OldStack,
04274     IN <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> ExitCode)
04275 
04276 <span class="comment">/*++</span>
04277 <span class="comment"></span>
04278 <span class="comment">Routine Description:</span>
04279 <span class="comment"></span>
04280 <span class="comment">    This API is called during thread termination to delete a thread's</span>
04281 <span class="comment">    stack and then terminate.</span>
04282 <span class="comment"></span>
04283 <span class="comment">Arguments:</span>
04284 <span class="comment"></span>
04285 <span class="comment">    OldStack - Supplies the address of the stack to free.</span>
04286 <span class="comment"></span>
04287 <span class="comment">    ExitCode - Supplies the termination status that the thread</span>
04288 <span class="comment">        is to exit with.</span>
04289 <span class="comment"></span>
04290 <span class="comment">Return Value:</span>
04291 <span class="comment"></span>
04292 <span class="comment">    None.</span>
04293 <span class="comment"></span>
04294 <span class="comment">--*/</span>
04295 
04296 {
04297     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04298     SIZE_T <a class="code" href="../../d6/d6/ttime_8c.html#a0">Zero</a>;
04299     PVOID BaseAddress;
04300 
04301     <a class="code" href="../../d6/d6/ttime_8c.html#a0">Zero</a> = 0;
04302     BaseAddress = OldStack;
04303 
04304     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d7/freevm_8c.html#a6">NtFreeVirtualMemory</a>(
04305                 NtCurrentProcess(),
04306                 &amp;BaseAddress,
04307                 &amp;<a class="code" href="../../d6/d6/ttime_8c.html#a0">Zero</a>,
04308                 MEM_RELEASE
04309                 );
04310     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
04311 
04312     <span class="comment">//</span>
04313     <span class="comment">// Don't worry, no commenting precedent has been set by SteveWo.  this</span>
04314     <span class="comment">// comment was added by an innocent bystander.</span>
04315     <span class="comment">//</span>
04316     <span class="comment">// NtTerminateThread will return if this thread is the last one in</span>
04317     <span class="comment">// the process.  So ExitProcess will only be called if that is the</span>
04318     <span class="comment">// case.</span>
04319     <span class="comment">//</span>
04320 
04321     <a class="code" href="../../d8/d0/psdelete_8c.html#a6">NtTerminateThread</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,(<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)ExitCode);
04322 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:23 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
