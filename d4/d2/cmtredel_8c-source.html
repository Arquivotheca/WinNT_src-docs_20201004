<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: cmtredel.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>cmtredel.c</h1><a href="../../d3/d3/cmtredel_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1992  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    cmtredel.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This file contains code for CmpDeleteTree, and support.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Bryan M. Willman (bryanwi) 24-Jan-92</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:</span>
00018 <span class="comment"></span>
00019 <span class="comment">--*/</span>
00020 
00021 <span class="preprocessor">#include    "<a class="code" href="../../d1/d2/cmp_8h.html">cmp.h</a>"</span>
00022 
00023 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00024 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpDeleteTree)</span>
00025 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpFreeKeyByCell)</span>
00026 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpMarkKeyDirty)</span>
00027 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00028 <span class="preprocessor"></span>
00029 <span class="comment">//</span>
00030 <span class="comment">// Routine to actually call to do a tree delete</span>
00031 <span class="comment">//</span>
00032 
00033 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00034"></a><a class="code" href="../../d3/d3/cmtredel_8c.html#a0">00034</a> <a class="code" href="../../d3/d3/cmtredel_8c.html#a0">CmpDeleteTree</a>(
00035     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>      Hive,
00036     HCELL_INDEX Cell
00037     )
00038 <span class="comment">/*++</span>
00039 <span class="comment"></span>
00040 <span class="comment">Routine Description:</span>
00041 <span class="comment"></span>
00042 <span class="comment">    Delete all child subkeys, recursively, of Hive.Cell.  Delete all</span>
00043 <span class="comment">    value entries of Hive.Cell.  Do NOT delete Hive.Cell itself.</span>
00044 <span class="comment"></span>
00045 <span class="comment">    NOTE:   If this call fails part way through, it will NOT undo</span>
00046 <span class="comment">            any successfully completed deletes.</span>
00047 <span class="comment"></span>
00048 <span class="comment">    NOTE:   This algorithm can deal with a hive of any depth, at the</span>
00049 <span class="comment">            cost of some "redundent" scaning and mapping.</span>
00050 <span class="comment"></span>
00051 <span class="comment">Arguments:</span>
00052 <span class="comment"></span>
00053 <span class="comment">    Hive - pointer to hive control structure for hive to delete from</span>
00054 <span class="comment"></span>
00055 <span class="comment">    Cell - index of cell at root of tree to delete</span>
00056 <span class="comment"></span>
00057 <span class="comment">Return Value:</span>
00058 <span class="comment"></span>
00059 <span class="comment">    BOOLEAN - Result code from call, among the following:</span>
00060 <span class="comment">        TRUE - it worked</span>
00061 <span class="comment">        FALSE - the tree delete was not completed (though more than 0</span>
00062 <span class="comment">                keys may have been deleted)</span>
00063 <span class="comment"></span>
00064 <span class="comment">--*/</span>
00065 {
00066     ULONG  count;
00067     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ptr1;
00068     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ptr2;
00069     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> parent;
00070     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Node;
00071 
00072     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a32">CMS_SAVRES</a>) {
00073         KdPrint((<span class="stringliteral">"CmpDeleteTree:\n"</span>));
00074         KdPrint((<span class="stringliteral">"\tHive=%08lx Cell=%08lx\n"</span>,<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,<a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>));
00075     }
00076 
00077     ptr1 = <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>;
00078 
00079     <span class="keywordflow">while</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00080 
00081         Node = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, ptr1);
00082         count = Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>] +
00083                 Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>];
00084         parent = Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o4">Parent</a>;
00085 
00086         <span class="keywordflow">if</span> (count &gt; 0) {                <span class="comment">// ptr1-&gt;count &gt; 0?</span>
00087 
00088             <span class="comment">//</span>
00089             <span class="comment">// subkeys exist, find and delete them</span>
00090             <span class="comment">//</span>
00091             ptr2 = <a class="code" href="../../d1/d2/cmp_8h.html#a304">CmpFindSubKeyByNumber</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, Node, 0);
00092 
00093             Node = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, ptr2);
00094             count = Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>] +
00095                     Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>];
00096 
00097             <span class="keywordflow">if</span> (count &gt; 0) {            <span class="comment">// ptr2-&gt;count &gt; 0?</span>
00098 
00099                 <span class="comment">//</span>
00100                 <span class="comment">// subkey has subkeys, descend to next level</span>
00101                 <span class="comment">//</span>
00102                 ptr1 = ptr2;
00103                 <span class="keywordflow">continue</span>;
00104 
00105             } <span class="keywordflow">else</span> {
00106 
00107                 <span class="comment">//</span>
00108                 <span class="comment">// have found leaf, delete it</span>
00109                 <span class="comment">//</span>
00110                 <a class="code" href="../../d3/d3/cmtredel_8c.html#a1">CmpFreeKeyByCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, ptr2, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00111                 <span class="keywordflow">continue</span>;
00112             }
00113 
00114         } <span class="keywordflow">else</span> {
00115 
00116             <span class="comment">//</span>
00117             <span class="comment">// no more subkeys at this level, we are now a leaf.</span>
00118             <span class="comment">//</span>
00119             <span class="keywordflow">if</span> (ptr1 != <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>) {
00120 
00121                 <span class="comment">//</span>
00122                 <span class="comment">// we are not at the root cell, so ascend to parent</span>
00123                 <span class="comment">//</span>
00124                 ptr1 = parent;          <span class="comment">// ptr1 = ptr1-&gt;parent</span>
00125                 <span class="keywordflow">continue</span>;
00126 
00127             } <span class="keywordflow">else</span> {
00128 
00129                 <span class="comment">//</span>
00130                 <span class="comment">// we are at the root cell, we are done</span>
00131                 <span class="comment">//</span>
00132                 <span class="keywordflow">return</span>;
00133             }
00134         } <span class="comment">// outer if</span>
00135     } <span class="comment">// while</span>
00136 }
00137 
00138 
00139 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00140"></a><a class="code" href="../../d3/d3/cmtredel_8c.html#a1">00140</a> <a class="code" href="../../d3/d3/cmtredel_8c.html#a1">CmpFreeKeyByCell</a>(
00141     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> Hive,
00142     HCELL_INDEX Cell,
00143     BOOLEAN Unlink
00144     )
00145 <span class="comment">/*++</span>
00146 <span class="comment"></span>
00147 <span class="comment">Routine Description:</span>
00148 <span class="comment"></span>
00149 <span class="comment">    Actually free the storage for the specified cell.  We will first</span>
00150 <span class="comment">    remove it from its parent's child key list, then free all of its</span>
00151 <span class="comment">    values, then the key body itself.</span>
00152 <span class="comment"></span>
00153 <span class="comment">Arguments:</span>
00154 <span class="comment"></span>
00155 <span class="comment">    Hive - pointer to hive control structure for hive of interest</span>
00156 <span class="comment"></span>
00157 <span class="comment">    Cell - index for cell to free storage for (the target)</span>
00158 <span class="comment"></span>
00159 <span class="comment">    Unlink - if TRUE, target cell will be removed from parent cell's</span>
00160 <span class="comment">             subkeylist, if FALSE, it will NOT be.</span>
00161 <span class="comment"></span>
00162 <span class="comment">Return Value:</span>
00163 <span class="comment"></span>
00164 <span class="comment">    NONE.</span>
00165 <span class="comment"></span>
00166 <span class="comment">--*/</span>
00167 {
00168     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a>  ptarget;
00169     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a>  pparent;
00170     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a>  plist;
00171     ULONG       i;
00172 
00173     <span class="comment">//</span>
00174     <span class="comment">// Mark dirty everything that we might touch</span>
00175     <span class="comment">//</span>
00176     <span class="keywordflow">if</span> (! <a class="code" href="../../d3/d3/cmtredel_8c.html#a2">CmpMarkKeyDirty</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>)) {
00177         <span class="keywordflow">return</span> STATUS_NO_LOG_SPACE;
00178     }
00179 
00180     <span class="comment">//</span>
00181     <span class="comment">// Map in the target</span>
00182     <span class="comment">//</span>
00183     ptarget = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>);
00184     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((ptarget-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>] +
00185             ptarget-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>]) == 0);
00186 
00187 
00188     <span class="keywordflow">if</span> (Unlink == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00189         BOOLEAN Success;
00190 
00191         Success = <a class="code" href="../../d1/d2/cmp_8h.html#a307">CmpRemoveSubKey</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, ptarget-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o4">Parent</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>);
00192         <span class="keywordflow">if</span> (!Success) {
00193             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00194         }
00195         pparent = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, ptarget-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o4">Parent</a>);
00196         <span class="keywordflow">if</span> ( (pparent-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>] +
00197               pparent-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>]) == 0)
00198         {
00199             pparent-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o11">MaxNameLen</a> = 0;
00200             pparent-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o12">MaxClassLen</a> = 0;
00201         }
00202     }
00203 
00204     <span class="comment">//</span>
00205     <span class="comment">// Target is now an unreferenced key, free it's actual storage</span>
00206     <span class="comment">//</span>
00207 
00208     <span class="comment">//</span>
00209     <span class="comment">// Free misc stuff</span>
00210     <span class="comment">//</span>
00211     <span class="keywordflow">if</span> (!(ptarget-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a28">KEY_HIVE_EXIT</a>) &amp;&amp;
00212         !(ptarget-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a33">KEY_PREDEF_HANDLE</a>) ) {
00213 
00214         <span class="comment">//</span>
00215         <span class="comment">// First, free the value entries</span>
00216         <span class="comment">//</span>
00217         <span class="keywordflow">if</span> (ptarget-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a> &gt; 0) {
00218 
00219             <span class="comment">// target list</span>
00220             plist = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, ptarget-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o1">List</a>);
00221 
00222             <span class="keywordflow">for</span> (i = 0; i &lt; ptarget-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a>; i++) {
00223                 <a class="code" href="../../d9/d2/cmsubs2_8c.html#a3">CmpFreeValue</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, plist-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o4">KeyList</a>[i]);
00224             }
00225 
00226             <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, ptarget-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o1">List</a>);
00227         }
00228 
00229         <span class="comment">//</span>
00230         <span class="comment">// Free the security descriptor</span>
00231         <span class="comment">//</span>
00232         <a class="code" href="../../d6/d3/cmwraper_8c.html#a12">CmpFreeSecurityDescriptor</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>);
00233     }
00234 
00235     <span class="comment">//</span>
00236     <span class="comment">// Free the key body itself, and Class data.</span>
00237     <span class="comment">//</span>
00238     <a class="code" href="../../d8/d2/cmsubs_8c.html#a25">CmpFreeKeyBody</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>);
00239 
00240     <span class="keywordflow">return</span> STATUS_SUCCESS;
00241 }
00242 
00243 
00244 BOOLEAN
<a name="l00245"></a><a class="code" href="../../d3/d3/cmtredel_8c.html#a2">00245</a> <a class="code" href="../../d3/d3/cmtredel_8c.html#a2">CmpMarkKeyDirty</a>(
00246     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> Hive,
00247     HCELL_INDEX Cell
00248     )
00249 <span class="comment">/*++</span>
00250 <span class="comment"></span>
00251 <span class="comment">Routine Description:</span>
00252 <span class="comment"></span>
00253 <span class="comment">    Mark all of the cells related to a key being deleted dirty.</span>
00254 <span class="comment">    Includes the parent, the parent's child list, the key body,</span>
00255 <span class="comment">    class, security, all value entry bodies, and all of their data cells.</span>
00256 <span class="comment"></span>
00257 <span class="comment">Arguments:</span>
00258 <span class="comment"></span>
00259 <span class="comment">    Hive - pointer to hive control structure for hive of interest</span>
00260 <span class="comment"></span>
00261 <span class="comment">    Cell - index for cell holding keybody to make dirty</span>
00262 <span class="comment"></span>
00263 <span class="comment">Return Value:</span>
00264 <span class="comment"></span>
00265 <span class="comment">    TRUE - it worked</span>
00266 <span class="comment"></span>
00267 <span class="comment">    FALSE - some error, most likely cannot get log space</span>
00268 <span class="comment"></span>
00269 <span class="comment">--*/</span>
00270 {
00271     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a>  ptarget;
00272     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a>  plist;
00273     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a>  security;
00274     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a>  pvalue;
00275     ULONG       i;
00276     ULONG realsize;
00277 
00278 
00279     <span class="comment">//</span>
00280     <span class="comment">// Map in the target</span>
00281     <span class="comment">//</span>
00282     ptarget = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>);
00283     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ptarget-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>] == 0);
00284     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ptarget-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>] == 0);
00285 
00286     <span class="keywordflow">if</span> (ptarget-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a28">KEY_HIVE_EXIT</a>) {
00287 
00288         <span class="comment">//</span>
00289         <span class="comment">// If this is a link node, we are done.  Link nodes never have</span>
00290         <span class="comment">// classes, values, subkeys, or security descriptors.  Since</span>
00291         <span class="comment">// they always reside in the master hive, they're always volatile.</span>
00292         <span class="comment">//</span>
00293         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00294     }
00295 
00296     <span class="comment">//</span>
00297     <span class="comment">// mark cell itself</span>
00298     <span class="comment">//</span>
00299     <span class="keywordflow">if</span> (! <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>)) {
00300         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00301     }
00302 
00303     <span class="comment">//</span>
00304     <span class="comment">// Mark the class</span>
00305     <span class="comment">//</span>
00306     <span class="keywordflow">if</span> (ptarget-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o10">Class</a> != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00307         <span class="keywordflow">if</span> (! <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, ptarget-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o10">Class</a>)) {
00308             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00309         }
00310     }
00311 
00312     <span class="comment">//</span>
00313     <span class="comment">// Mark security</span>
00314     <span class="comment">//</span>
00315     <span class="keywordflow">if</span> (ptarget-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o9">Security</a> != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00316         <span class="keywordflow">if</span> (! <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, ptarget-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o9">Security</a>)) {
00317             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00318         }
00319 
00320         security = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, ptarget-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o9">Security</a>);
00321         <span class="keywordflow">if</span> (! (<a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, security-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o2">KeySecurity</a>.<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o2">Flink</a>) &amp;&amp;
00322                <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, security-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o2">KeySecurity</a>.<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o3">Blink</a>)))
00323         {
00324             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00325         }
00326     }
00327 
00328     <span class="comment">//</span>
00329     <span class="comment">// Mark the value entries and their data</span>
00330     <span class="comment">//</span>
00331     <span class="keywordflow">if</span> ( !(ptarget-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a33">KEY_PREDEF_HANDLE</a>) &amp;&amp; 
00332                   (ptarget-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a> &gt; 0) 
00333            ) {
00334 
00335         <span class="comment">// target list</span>
00336         <span class="keywordflow">if</span> (! <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, ptarget-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o1">List</a>)) {
00337             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00338         }
00339         plist = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, ptarget-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o1">List</a>);
00340 
00341         <span class="keywordflow">for</span> (i = 0; i &lt; ptarget-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a>; i++) {
00342             <span class="keywordflow">if</span> (! <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, plist-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o4">KeyList</a>[i])) {
00343                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00344             }
00345 
00346             pvalue = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, plist-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o4">KeyList</a>[i]);
00347 
00348             <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d0/cmdata_8h.html#a38">CmpIsHKeyValueSmall</a>(realsize, pvalue-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o2">DataLength</a>)) {
00349                 <span class="keywordflow">if</span> (! <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, pvalue-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o3">Data</a>)) {
00350                     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00351                 }
00352             }
00353         }
00354     }
00355 
00356     <span class="keywordflow">if</span> (ptarget-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a29">KEY_HIVE_ENTRY</a>) {
00357 
00358         <span class="comment">//</span>
00359         <span class="comment">// if this is an entry node, we are done.  our parent will</span>
00360         <span class="comment">// be in the master hive (and thus volatile)</span>
00361         <span class="comment">//</span>
00362         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00363     }
00364 
00365     <span class="comment">//</span>
00366     <span class="comment">// Mark the parent's Subkey list</span>
00367     <span class="comment">//</span>
00368     <span class="keywordflow">if</span> (! <a class="code" href="../../d1/d2/cmp_8h.html#a306">CmpMarkIndexDirty</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, ptarget-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o4">Parent</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>)) {
00369         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00370     }
00371 
00372     <span class="comment">//</span>
00373     <span class="comment">// Mark the parent</span>
00374     <span class="comment">//</span>
00375     <span class="keywordflow">if</span> (! <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, ptarget-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o4">Parent</a>)) {
00376         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00377     }
00378 
00379 
00380     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00381 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:29 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
