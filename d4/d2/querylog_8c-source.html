<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: querylog.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>querylog.c</h1><a href="../../d3/d3/querylog_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1990  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    QueryLog.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements the user routines which query for log records</span>
00012 <span class="comment">    in a log file.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Brian Andrew    [BrianAn]   20-June-1991</span>
00017 <span class="comment"></span>
00018 <span class="comment">Revision History:</span>
00019 <span class="comment"></span>
00020 <span class="comment">--*/</span>
00021 
00022 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/lfsprocs_8h.html">lfsprocs.h</a>"</span>
00023 
00024 <span class="comment">//</span>
00025 <span class="comment">//  The debug trace level</span>
00026 <span class="comment">//</span>
00027 
<a name="l00028"></a><a class="code" href="../../d3/d3/querylog_8c.html#a0">00028</a> <span class="preprocessor">#define Dbg                              (DEBUG_TRACE_QUERY)</span>
00029 <span class="preprocessor"></span>
00030 <span class="preprocessor">#undef MODULE_POOL_TAG</span>
<a name="l00031"></a><a class="code" href="../../d3/d3/querylog_8c.html#a1">00031</a> <span class="preprocessor"></span><span class="preprocessor">#define MODULE_POOL_TAG                  ('QsfL')</span>
00032 <span class="preprocessor"></span>
00033 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00034 <a class="code" href="../../d3/d3/querylog_8c.html#a2">LfsFindLogRecord</a> (
00035     IN <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb,
00036     IN OUT <a class="code" href="../../d5/d9/struct__LCB.html">PLCB</a> Lcb,
00037     IN LSN Lsn,
00038     OUT PLFS_RECORD_TYPE RecordType,
00039     OUT TRANSACTION_ID *TransactionId,
00040     OUT PLSN UndoNextLsn,
00041     OUT PLSN PreviousLsn,
00042     OUT PULONG BufferLength,
00043     OUT PVOID *Buffer
00044     );
00045 
00046 BOOLEAN
00047 <a class="code" href="../../d3/d3/querylog_8c.html#a3">LfsFindClientNextLsn</a> (
00048     IN <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb,
00049     IN <a class="code" href="../../d5/d9/struct__LCB.html">PLCB</a> Lcb,
00050     OUT PLSN Lsn
00051     );
00052 
00053 BOOLEAN
00054 <a class="code" href="../../d3/d3/querylog_8c.html#a4">LfsSearchForwardByClient</a> (
00055     IN <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb,
00056     IN OUT <a class="code" href="../../d5/d9/struct__LCB.html">PLCB</a> Lcb,
00057     OUT PLSN Lsn
00058     );
00059 
00060 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00061 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, LfsFindClientNextLsn)</span>
00062 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, LfsFindLogRecord)</span>
00063 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, LfsQueryLastLsn)</span>
00064 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, LfsReadLogRecord)</span>
00065 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, LfsReadNextLogRecord)</span>
00066 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, LfsSearchForwardByClient)</span>
00067 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, LfsTerminateLogQuery)</span>
00068 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00069 <span class="preprocessor"></span>
00070 
00071 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00072"></a><a class="code" href="../../d3/d3/querylog_8c.html#a5">00072</a> <a class="code" href="../../d3/d3/querylog_8c.html#a5">LfsReadLogRecord</a> (
00073     IN LFS_LOG_HANDLE LogHandle,
00074     IN LSN FirstLsn,
00075     IN LFS_CONTEXT_MODE ContextMode,
00076     OUT PLFS_LOG_CONTEXT Context,
00077     OUT PLFS_RECORD_TYPE RecordType,
00078     OUT TRANSACTION_ID *TransactionId,
00079     OUT PLSN UndoNextLsn,
00080     OUT PLSN PreviousLsn,
00081     OUT PULONG BufferLength,
00082     OUT PVOID *Buffer
00083     )
00084 
00085 <span class="comment">/*++</span>
00086 <span class="comment"></span>
00087 <span class="comment">Routine Description:</span>
00088 <span class="comment"></span>
00089 <span class="comment">    This routine initiates the query operation.  It returns the log record</span>
00090 <span class="comment">    in question and a context structure used by the Lfs to return related</span>
00091 <span class="comment">    log records.  The caller specifies what mode of query to use.  He may</span>
00092 <span class="comment">    walk backwards through the file by Undo records or all records for</span>
00093 <span class="comment">    this client linked through the previous Lsn fields.  He may also look</span>
00094 <span class="comment">    forwards through the file for all records for the issuing client.</span>
00095 <span class="comment"></span>
00096 <span class="comment">Arguments:</span>
00097 <span class="comment"></span>
00098 <span class="comment">    LogHandle - Pointer to private Lfs structure used to identify this</span>
00099 <span class="comment">                client.</span>
00100 <span class="comment"></span>
00101 <span class="comment">    FirstLsn - Starting record for this query operation.</span>
00102 <span class="comment"></span>
00103 <span class="comment">    ContextMode - Method of query.</span>
00104 <span class="comment"></span>
00105 <span class="comment">    Context - Supplies the address to store a pointer to the Lfs created</span>
00106 <span class="comment">              context structure.</span>
00107 <span class="comment"></span>
00108 <span class="comment">    RecordType - Supplies the address to store the record type of this</span>
00109 <span class="comment">                 log record.</span>
00110 <span class="comment"></span>
00111 <span class="comment">    TransactionId - Supplies the address to store the transaction Id of</span>
00112 <span class="comment">                    this log record.</span>
00113 <span class="comment"></span>
00114 <span class="comment">    UndoNextLsn - Supplies the address to store the Undo Next Lsn for this</span>
00115 <span class="comment">                  log record.</span>
00116 <span class="comment"></span>
00117 <span class="comment">    PreviousLsn - Supplies the address to store the Previous Lsn for this</span>
00118 <span class="comment">                  log record.</span>
00119 <span class="comment"></span>
00120 <span class="comment">    BufferLength - This is the length of the log data.</span>
00121 <span class="comment"></span>
00122 <span class="comment">    Buffer - This is a pointer to the start of the log data.</span>
00123 <span class="comment"></span>
00124 <span class="comment">Return Value:</span>
00125 <span class="comment"></span>
00126 <span class="comment">    None</span>
00127 <span class="comment"></span>
00128 <span class="comment">--*/</span>
00129 
00130 {
00131     <span class="keyword">volatile</span> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00132 
00133     <a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> ClientRecord;
00134 
00135     <a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a> Lch;
00136 
00137     <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb;
00138 
00139     <a class="code" href="../../d5/d9/struct__LCB.html">PLCB</a> Lcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00140 
00141     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00142 
00143     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"LfsReadLogRecord:  Entered\n"</span>, 0 );
00144     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Log Handle        -&gt; %08lx\n"</span>, LogHandle );
00145     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"First Lsn (Low)   -&gt; %08lx\n"</span>, FirstLsn.LowPart );
00146     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"First Lsn (High)  -&gt; %08lx\n"</span>, FirstLsn.HighPart );
00147     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Context Mode      -&gt; %08lx\n"</span>, ContextMode );
00148 
00149     Lch = (<a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a>) LogHandle;
00150 
00151     <span class="comment">//</span>
00152     <span class="comment">//  Check that the context mode is valid.</span>
00153     <span class="comment">//</span>
00154 
00155     <span class="keywordflow">switch</span> (ContextMode) {
00156 
00157     <span class="keywordflow">case</span> <a class="code" href="../../d6/d3/lfs_8h.html#a63a33">LfsContextUndoNext</a> :
00158     <span class="keywordflow">case</span> <a class="code" href="../../d6/d3/lfs_8h.html#a63a34">LfsContextPrevious</a> :
00159     <span class="keywordflow">case</span> <a class="code" href="../../d6/d3/lfs_8h.html#a63a35">LfsContextForward</a> :
00160 
00161         <span class="keywordflow">break</span>;
00162 
00163     <span class="keywordflow">default</span>:
00164 
00165         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Invalid context mode -&gt; %08x\n"</span>, ContextMode );
00166         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_INVALID_PARAMETER );
00167     }
00168 
00169     <span class="comment">//</span>
00170     <span class="comment">//  Check that the structure is a valid log handle structure.</span>
00171     <span class="comment">//</span>
00172 
00173     <a class="code" href="../../d0/d4/lfsprocs_8h.html#a32">LfsValidateLch</a>( Lch );
00174 
00175     <span class="comment">//</span>
00176     <span class="comment">//  Use a try-except to catch errors.</span>
00177     <span class="comment">//</span>
00178 
00179     <span class="keywordflow">try</span> {
00180 
00181         <span class="comment">//</span>
00182         <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00183         <span class="comment">//</span>
00184 
00185         <span class="keywordflow">try</span> {
00186 
00187             <span class="comment">//</span>
00188             <span class="comment">//  Acquire the log file control block for this log file.</span>
00189             <span class="comment">//</span>
00190 
00191             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a30">LfsAcquireLch</a>( Lch );
00192             Lfcb = Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o3">Lfcb</a>;
00193 
00194             <span class="comment">//</span>
00195             <span class="comment">//  If the Log file has been closed then refuse access.</span>
00196             <span class="comment">//</span>
00197 
00198             <span class="keywordflow">if</span> (Lfcb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00199 
00200                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_ACCESS_DENIED );
00201             }
00202 
00203             <span class="comment">//</span>
00204             <span class="comment">//  Check that the client Id is valid.</span>
00205             <span class="comment">//</span>
00206 
00207             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a33">LfsValidateClientId</a>( Lfcb, Lch );
00208 
00209             <span class="comment">//</span>
00210             <span class="comment">//  Check that the given Lsn is in the legal range for this client.</span>
00211             <span class="comment">//</span>
00212 
00213             ClientRecord = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o31">ClientArray</a>,
00214                                     Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o6">ClientArrayByteOffset</a>,
00215                                     <a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> );
00216 
00217             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d4/lfsprocs_8h.html#a34">LfsVerifyClientLsnInRange</a>( Lfcb, ClientRecord, FirstLsn )) {
00218 
00219                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_DISK_CORRUPT_ERROR );
00220             }
00221 
00222             <span class="comment">//</span>
00223             <span class="comment">//  We can give up the Lfcb as we know the Lsn is within the file.</span>
00224             <span class="comment">//</span>
00225 
00226             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a31">LfsReleaseLch</a>( Lch );
00227 
00228             <span class="comment">//</span>
00229             <span class="comment">//  Allocate and initialize a context structure.</span>
00230             <span class="comment">//</span>
00231 
00232             <a class="code" href="../../d8/d7/lfs_2strucsup_8c.html#a5">LfsAllocateLcb</a>( Lfcb, &amp;Lcb );
00233 
00234             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a15">LfsInitializeLcb</a>( Lcb,
00235                               Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o4">ClientId</a>,
00236                               ContextMode );
00237 
00238             <span class="comment">//</span>
00239             <span class="comment">//  Find the log record indicated by the given Lsn.</span>
00240             <span class="comment">//</span>
00241 
00242             <a class="code" href="../../d3/d3/querylog_8c.html#a2">LfsFindLogRecord</a>( Lfcb,
00243                               Lcb,
00244                               FirstLsn,
00245                               RecordType,
00246                               TransactionId,
00247                               UndoNextLsn,
00248                               PreviousLsn,
00249                               BufferLength,
00250                               <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> );
00251 
00252             <span class="comment">//</span>
00253             <span class="comment">//  Update the client's arguments.</span>
00254             <span class="comment">//</span>
00255 
00256             *Context = Lcb;
00257             Lcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00258 
00259         } finally {
00260 
00261             <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( <a class="code" href="../../d6/d3/lfs_8h.html#a58">LfsReadLogRecord</a> );
00262 
00263             <span class="comment">//</span>
00264             <span class="comment">//  Release the log file control block if held.</span>
00265             <span class="comment">//</span>
00266 
00267             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a31">LfsReleaseLch</a>( Lch );
00268 
00269             <span class="comment">//</span>
00270             <span class="comment">//  Deallocate the context block if an error occurred.</span>
00271             <span class="comment">//</span>
00272 
00273             <span class="keywordflow">if</span> (Lcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00274 
00275                 <a class="code" href="../../d8/d7/lfs_2strucsup_8c.html#a6">LfsDeallocateLcb</a>( Lfcb, Lcb );
00276             }
00277 
00278             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Context       -&gt; %08lx\n"</span>, *Context );
00279             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Buffer Length -&gt; %08lx\n"</span>, *BufferLength );
00280             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Buffer        -&gt; %08lx\n"</span>, *<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> );
00281             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"LfsReadLogRecord:  Exit\n"</span>, 0 );
00282         }
00283 
00284     } except (<a class="code" href="../../d0/d4/lfsprocs_8h.html#a56">LfsExceptionFilter</a>( GetExceptionInformation() )) {
00285 
00286         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00287     }
00288 
00289     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) {
00290 
00291         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00292     }
00293 
00294     <span class="keywordflow">return</span>;
00295 }
00296 
00297 
00298 BOOLEAN
<a name="l00299"></a><a class="code" href="../../d3/d3/querylog_8c.html#a6">00299</a> <a class="code" href="../../d3/d3/querylog_8c.html#a6">LfsReadNextLogRecord</a> (
00300     IN LFS_LOG_HANDLE LogHandle,
00301     IN OUT LFS_LOG_CONTEXT Context,
00302     OUT PLFS_RECORD_TYPE RecordType,
00303     OUT TRANSACTION_ID *TransactionId,
00304     OUT PLSN UndoNextLsn,
00305     OUT PLSN PreviousLsn,
00306     OUT PLSN Lsn,
00307     OUT PULONG BufferLength,
00308     OUT PVOID *Buffer
00309     )
00310 
00311 <span class="comment">/*++</span>
00312 <span class="comment"></span>
00313 <span class="comment">Routine Description:</span>
00314 <span class="comment"></span>
00315 <span class="comment">    This routine is called to continue a query operation.  The Lfs uses</span>
00316 <span class="comment">    private information stored in the context structure to determine the</span>
00317 <span class="comment">    next log record to return to the caller.</span>
00318 <span class="comment"></span>
00319 <span class="comment">Arguments:</span>
00320 <span class="comment"></span>
00321 <span class="comment">    LogHandle - Pointer to private Lfs structure used to identify this</span>
00322 <span class="comment">                client.</span>
00323 <span class="comment"></span>
00324 <span class="comment">    Context - Supplies the address to store a pointer to the Lfs created</span>
00325 <span class="comment">              context structure.</span>
00326 <span class="comment"></span>
00327 <span class="comment">    Lsn - Lsn for this log record.</span>
00328 <span class="comment"></span>
00329 <span class="comment">    RecordType - Supplies the address to store the record type of this</span>
00330 <span class="comment">                 log record.</span>
00331 <span class="comment"></span>
00332 <span class="comment">    TransactionId - Supplies the address to store the transaction Id of</span>
00333 <span class="comment">                    this log record.</span>
00334 <span class="comment"></span>
00335 <span class="comment">    UndoNextLsn - Supplies the address to store the Undo Next Lsn for this</span>
00336 <span class="comment">                  log record.</span>
00337 <span class="comment"></span>
00338 <span class="comment">    PreviousLsn - Supplies the address to store the Previous Lsn for this</span>
00339 <span class="comment">                  log record.</span>
00340 <span class="comment"></span>
00341 <span class="comment">    BufferLength - This is the length of the log data.</span>
00342 <span class="comment"></span>
00343 <span class="comment">    Buffer - This is a pointer to the start of the log data.</span>
00344 <span class="comment"></span>
00345 <span class="comment">Return Value:</span>
00346 <span class="comment"></span>
00347 <span class="comment">    None</span>
00348 <span class="comment"></span>
00349 <span class="comment">--*/</span>
00350 
00351 {
00352     <span class="keyword">volatile</span> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00353 
00354     <a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a> Lch;
00355 
00356     <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb;
00357 
00358     <a class="code" href="../../d5/d9/struct__LCB.html">PLCB</a> Lcb;
00359 
00360     BOOLEAN FoundNextLsn;
00361 
00362     BOOLEAN UnwindRememberLcbFields;
00363     <a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a> UnwindRecordHeaderBcb;
00364     <a class="code" href="../../d8/d0/struct__LFS__RECORD__HEADER.html">PLFS_RECORD_HEADER</a> UnwindRecordHeader;
00365     PVOID UnwindCurrentLogRecord;
00366     BOOLEAN UnwindAuxilaryBuffer;
00367 
00368     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00369 
00370     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"LfsReadNextLogRecord:  Entered\n"</span>, 0 );
00371     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Log Handle    -&gt; %08lx\n"</span>, LogHandle );
00372     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Context       -&gt; %08lx\n"</span>, Context );
00373 
00374     FoundNextLsn = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00375 
00376     UnwindRememberLcbFields = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00377 
00378     Lch = (<a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a>) LogHandle;
00379     Lcb = (<a class="code" href="../../d5/d9/struct__LCB.html">PLCB</a>) Context;
00380 
00381     <span class="comment">//</span>
00382     <span class="comment">//  Check that the structure is a valid log handle structure.</span>
00383     <span class="comment">//</span>
00384 
00385     <a class="code" href="../../d0/d4/lfsprocs_8h.html#a32">LfsValidateLch</a>( Lch );
00386 
00387     <span class="comment">//</span>
00388     <span class="comment">//  Use a try-except to catch errors.</span>
00389     <span class="comment">//</span>
00390 
00391     <span class="keywordflow">try</span> {
00392 
00393         <span class="comment">//</span>
00394         <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00395         <span class="comment">//</span>
00396 
00397         <span class="keywordflow">try</span> {
00398 
00399             <span class="comment">//</span>
00400             <span class="comment">//  Acquire the log file control block for this log file.</span>
00401             <span class="comment">//</span>
00402 
00403             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a30">LfsAcquireLch</a>( Lch );
00404             Lfcb = Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o3">Lfcb</a>;
00405 
00406             <span class="comment">//</span>
00407             <span class="comment">//  If the Log file has been closed then refuse access.</span>
00408             <span class="comment">//</span>
00409 
00410             <span class="keywordflow">if</span> (Lfcb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00411 
00412                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_ACCESS_DENIED );
00413             }
00414 
00415             <span class="comment">//</span>
00416             <span class="comment">//  Check that the client Id is valid.</span>
00417             <span class="comment">//</span>
00418 
00419             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a33">LfsValidateClientId</a>( Lfcb, Lch );
00420 
00421             <span class="comment">//</span>
00422             <span class="comment">//  Check that the context structure is valid.</span>
00423             <span class="comment">//</span>
00424 
00425             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a36">LfsValidateLcb</a>( Lcb, Lch );
00426 
00427             <span class="comment">//</span>
00428             <span class="comment">//  Remember any context fields to be overwritten.</span>
00429             <span class="comment">//</span>
00430 
00431             UnwindRememberLcbFields = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00432 
00433             UnwindRecordHeaderBcb = Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o3">RecordHeaderBcb</a>;
00434             Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o3">RecordHeaderBcb</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00435 
00436             UnwindRecordHeader = Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o2">RecordHeader</a>;
00437             UnwindCurrentLogRecord = Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o6">CurrentLogRecord</a>;
00438 
00439             UnwindAuxilaryBuffer = Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o7">AuxilaryBuffer</a>;
00440             Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o7">AuxilaryBuffer</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00441 
00442             <span class="comment">//</span>
00443             <span class="comment">//  Find the next Lsn number based on the current Lsn number in</span>
00444             <span class="comment">//  the context block.</span>
00445             <span class="comment">//</span>
00446 
00447             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d3/querylog_8c.html#a3">LfsFindClientNextLsn</a>( Lfcb, Lcb, Lsn )) {
00448 
00449                 <span class="comment">//</span>
00450                 <span class="comment">//  We can give up the Lfcb as we know the Lsn is within the file.</span>
00451                 <span class="comment">//</span>
00452 
00453                 <a class="code" href="../../d0/d4/lfsprocs_8h.html#a29">LfsReleaseLfcb</a>( Lfcb );
00454 
00455                 <span class="comment">//</span>
00456                 <span class="comment">//  Cleanup the context block so we can do the next search.</span>
00457                 <span class="comment">//</span>
00458 
00459                 Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o6">CurrentLogRecord</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00460                 Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o7">AuxilaryBuffer</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00461 
00462                 <span class="comment">//</span>
00463                 <span class="comment">//  Perform the work of getting the log record.</span>
00464                 <span class="comment">//</span>
00465 
00466                 <a class="code" href="../../d3/d3/querylog_8c.html#a2">LfsFindLogRecord</a>( Lfcb,
00467                                   Lcb,
00468                                   *Lsn,
00469                                   RecordType,
00470                                   TransactionId,
00471                                   UndoNextLsn,
00472                                   PreviousLsn,
00473                                   BufferLength,
00474                                   <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> );
00475 
00476                 FoundNextLsn = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00477             }
00478 
00479         } finally {
00480 
00481             <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( <a class="code" href="../../d6/d3/lfs_8h.html#a59">LfsReadNextLogRecord</a> );
00482 
00483             <span class="comment">//</span>
00484             <span class="comment">//  If we exited due to an error, we have to restore the context</span>
00485             <span class="comment">//  block.</span>
00486             <span class="comment">//</span>
00487 
00488             <span class="keywordflow">if</span> (UnwindRememberLcbFields) {
00489 
00490                 <span class="keywordflow">if</span> (AbnormalTermination()) {
00491 
00492                     <span class="comment">//</span>
00493                     <span class="comment">//  If the record header in the context block is not</span>
00494                     <span class="comment">//  the same as we started with.  Then we unpin that</span>
00495                     <span class="comment">//  data.</span>
00496                     <span class="comment">//</span>
00497 
00498                     <span class="keywordflow">if</span> (Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o3">RecordHeaderBcb</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00499 
00500                         <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o3">RecordHeaderBcb</a> );
00501 
00502                     }
00503 
00504                     <span class="keywordflow">if</span> (Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o6">CurrentLogRecord</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00505                         &amp;&amp; Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o7">AuxilaryBuffer</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00506 
00507                         <a class="code" href="../../d6/d5/logpgsup_8c.html#a4">LfsFreeSpanningBuffer</a>( Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o6">CurrentLogRecord</a> );
00508                     }
00509 
00510                     Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o3">RecordHeaderBcb</a> = UnwindRecordHeaderBcb;
00511                     Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o2">RecordHeader</a> = UnwindRecordHeader;
00512                     Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o6">CurrentLogRecord</a> = UnwindCurrentLogRecord;
00513                     Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o7">AuxilaryBuffer</a> = UnwindAuxilaryBuffer;
00514 
00515                 <span class="comment">//</span>
00516                 <span class="comment">//  Otherwise, if we have successfully found the next Lsn,</span>
00517                 <span class="comment">//  we free up any resources being held from the previous search.</span>
00518                 <span class="comment">//</span>
00519 
00520                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (FoundNextLsn ) {
00521 
00522                     <span class="keywordflow">if</span> (UnwindRecordHeaderBcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00523 
00524                         <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( UnwindRecordHeaderBcb );
00525                     }
00526 
00527                     <span class="keywordflow">if</span> (UnwindCurrentLogRecord != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00528                         &amp;&amp; UnwindAuxilaryBuffer == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00529 
00530                         <a class="code" href="../../d6/d5/logpgsup_8c.html#a4">LfsFreeSpanningBuffer</a>( UnwindCurrentLogRecord );
00531                     }
00532 
00533                 <span class="comment">//</span>
00534                 <span class="comment">//  Restore the Bcb and auxilary buffer field for the final</span>
00535                 <span class="comment">//  cleanup.</span>
00536                 <span class="comment">//</span>
00537 
00538                 } <span class="keywordflow">else</span> {
00539 
00540                     <span class="keywordflow">if</span> (UnwindRecordHeaderBcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00541 
00542                         <span class="keywordflow">if</span> (Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o3">RecordHeaderBcb</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00543 
00544                             <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( UnwindRecordHeaderBcb );
00545 
00546                         } <span class="keywordflow">else</span> {
00547 
00548                             Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o3">RecordHeaderBcb</a> = UnwindRecordHeaderBcb;
00549                         }
00550                     }
00551 
00552                     <span class="keywordflow">if</span> (UnwindAuxilaryBuffer) {
00553 
00554                         <span class="keywordflow">if</span> (Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o6">CurrentLogRecord</a> == UnwindCurrentLogRecord) {
00555 
00556                             Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o7">AuxilaryBuffer</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00557 
00558                         } <span class="keywordflow">else</span> {
00559 
00560                             <a class="code" href="../../d6/d5/logpgsup_8c.html#a4">LfsFreeSpanningBuffer</a>( UnwindCurrentLogRecord );
00561                         }
00562                     }
00563                 }
00564             }
00565 
00566             <span class="comment">//</span>
00567             <span class="comment">//  Release the log file control block if held.</span>
00568             <span class="comment">//</span>
00569 
00570             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a31">LfsReleaseLch</a>( Lch );
00571 
00572             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Lsn (Low)     -&gt; %08lx\n"</span>, Lsn-&gt;LowPart );
00573             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Lsn (High)    -&gt; %08lx\n"</span>, Lsn-&gt;HighPart );
00574             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Buffer Length -&gt; %08lx\n"</span>, *BufferLength );
00575             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Buffer        -&gt; %08lx\n"</span>, *<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> );
00576             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"LfsReadNextLogRecord:  Exit\n"</span>, 0 );
00577         }
00578 
00579     } except (<a class="code" href="../../d0/d4/lfsprocs_8h.html#a56">LfsExceptionFilter</a>( GetExceptionInformation() )) {
00580 
00581         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00582     }
00583 
00584     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) {
00585 
00586         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00587     }
00588 
00589     <span class="keywordflow">return</span> FoundNextLsn;
00590 }
00591 
00592 
00593 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00594"></a><a class="code" href="../../d3/d3/querylog_8c.html#a7">00594</a> <a class="code" href="../../d3/d3/querylog_8c.html#a7">LfsTerminateLogQuery</a> (
00595     IN LFS_LOG_HANDLE LogHandle,
00596     IN LFS_LOG_CONTEXT Context
00597     )
00598 
00599 <span class="comment">/*++</span>
00600 <span class="comment"></span>
00601 <span class="comment">Routine Description:</span>
00602 <span class="comment"></span>
00603 <span class="comment">    This routine is called when a client has completed his query operation</span>
00604 <span class="comment">    and wishes to deallocate any resources acquired by the Lfs to</span>
00605 <span class="comment">    perform the log file query.</span>
00606 <span class="comment"></span>
00607 <span class="comment">Arguments:</span>
00608 <span class="comment"></span>
00609 <span class="comment">    LogHandle - Pointer to private Lfs structure used to identify this</span>
00610 <span class="comment">                client.</span>
00611 <span class="comment"></span>
00612 <span class="comment">    Context - Supplies the address to store a pointer to the Lfs created</span>
00613 <span class="comment">              context structure.</span>
00614 <span class="comment"></span>
00615 <span class="comment">Return Value:</span>
00616 <span class="comment"></span>
00617 <span class="comment">    None</span>
00618 <span class="comment"></span>
00619 <span class="comment">--*/</span>
00620 
00621 {
00622     <a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a> Lch;
00623     <a class="code" href="../../d5/d9/struct__LCB.html">PLCB</a> Lcb;
00624 
00625     <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb;
00626 
00627     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00628 
00629     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"LfsTerminateLogQuery:  Entered\n"</span>, 0 );
00630     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Log Handle    -&gt; %08lx\n"</span>, LogHandle );
00631     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Context       -&gt; %08lx\n"</span>, Context );
00632 
00633     Lch = (<a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a>) LogHandle;
00634     Lcb = (<a class="code" href="../../d5/d9/struct__LCB.html">PLCB</a>) Context;
00635 
00636     <span class="comment">//</span>
00637     <span class="comment">//  Check that the structure is a valid log handle structure.</span>
00638     <span class="comment">//</span>
00639 
00640     <a class="code" href="../../d0/d4/lfsprocs_8h.html#a32">LfsValidateLch</a>( Lch );
00641 
00642     <span class="comment">//</span>
00643     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00644     <span class="comment">//</span>
00645 
00646     <span class="keywordflow">try</span> {
00647 
00648         <span class="comment">//</span>
00649         <span class="comment">//  Acquire the log file control block for this log file.</span>
00650         <span class="comment">//</span>
00651 
00652         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a30">LfsAcquireLch</a>( Lch );
00653         Lfcb = Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o3">Lfcb</a>;
00654 
00655         <span class="comment">//</span>
00656         <span class="comment">//  If the Log file has been closed then refuse access.</span>
00657         <span class="comment">//</span>
00658 
00659         <span class="keywordflow">if</span> (Lfcb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00660 
00661             <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( NOTHING );
00662         }
00663 
00664         <span class="comment">//</span>
00665         <span class="comment">//  Check that the client Id is valid.</span>
00666         <span class="comment">//</span>
00667 
00668         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a33">LfsValidateClientId</a>( Lfcb, Lch );
00669 
00670         <span class="comment">//</span>
00671         <span class="comment">//  Check that the context structure is valid.</span>
00672         <span class="comment">//</span>
00673 
00674         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a36">LfsValidateLcb</a>( Lcb, Lch );
00675 
00676         <span class="comment">//</span>
00677         <span class="comment">//  Deallocate the context block.</span>
00678         <span class="comment">//</span>
00679 
00680         <a class="code" href="../../d8/d7/lfs_2strucsup_8c.html#a6">LfsDeallocateLcb</a>( Lfcb, Lcb );
00681 
00682     try_exit:  NOTHING;
00683     } finally {
00684 
00685         <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( <a class="code" href="../../d6/d3/lfs_8h.html#a60">LfsTerminateLogQuery</a> );
00686 
00687         <span class="comment">//</span>
00688         <span class="comment">//  Release the Lfcb if acquired.</span>
00689         <span class="comment">//</span>
00690 
00691         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a31">LfsReleaseLch</a>( Lch );
00692 
00693         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"LfsTerminateLogQuery:  Exit\n"</span>, 0 );
00694     }
00695 
00696     <span class="keywordflow">return</span>;
00697 }
00698 
00699 
00700 <a class="code" href="../../d6/d3/lfs_8h.html#a10">LSN</a>
<a name="l00701"></a><a class="code" href="../../d3/d3/querylog_8c.html#a8">00701</a> <a class="code" href="../../d3/d3/querylog_8c.html#a8">LfsQueryLastLsn</a> (
00702     IN LFS_LOG_HANDLE LogHandle
00703     )
00704 
00705 <span class="comment">/*++</span>
00706 <span class="comment"></span>
00707 <span class="comment">Routine Description:</span>
00708 <span class="comment"></span>
00709 <span class="comment">    This routine will return the most recent Lsn for this log record.</span>
00710 <span class="comment"></span>
00711 <span class="comment">Arguments:</span>
00712 <span class="comment"></span>
00713 <span class="comment">    LogHandle - Pointer to private Lfs structure used to identify this</span>
00714 <span class="comment">                client.</span>
00715 <span class="comment"></span>
00716 <span class="comment">Return Value:</span>
00717 <span class="comment"></span>
00718 <span class="comment">    LSN - This is the last Lsn assigned in this log file.</span>
00719 <span class="comment"></span>
00720 <span class="comment">--*/</span>
00721 
00722 {
00723     <a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a> Lch;
00724 
00725     <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb;
00726 
00727     <a class="code" href="../../d6/d3/lfs_8h.html#a10">LSN</a> LastLsn;
00728 
00729     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00730 
00731     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"LfsQueryLastLsn:  Entered\n"</span>, 0 );
00732     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Log Handle    -&gt; %08lx\n"</span>, LogHandle );
00733 
00734     Lch = (<a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a>) LogHandle;
00735 
00736     <span class="comment">//</span>
00737     <span class="comment">//  Check that the structure is a valid log handle structure.</span>
00738     <span class="comment">//</span>
00739 
00740     <a class="code" href="../../d0/d4/lfsprocs_8h.html#a32">LfsValidateLch</a>( Lch );
00741 
00742     <span class="comment">//</span>
00743     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00744     <span class="comment">//</span>
00745 
00746     <span class="keywordflow">try</span> {
00747 
00748         <span class="comment">//</span>
00749         <span class="comment">//  Acquire the log file control block for this log file.</span>
00750         <span class="comment">//</span>
00751 
00752         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a30">LfsAcquireLch</a>( Lch );
00753         Lfcb = Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o3">Lfcb</a>;
00754 
00755         <span class="comment">//</span>
00756         <span class="comment">//  If the Log file has been closed then refuse access.</span>
00757         <span class="comment">//</span>
00758 
00759         <span class="keywordflow">if</span> (Lfcb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00760 
00761             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_ACCESS_DENIED );
00762         }
00763 
00764         <span class="comment">//</span>
00765         <span class="comment">//  Check that the client Id is valid.</span>
00766         <span class="comment">//</span>
00767 
00768         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a33">LfsValidateClientId</a>( Lfcb, Lch );
00769 
00770         <span class="comment">//</span>
00771         <span class="comment">//  Copy the last Lsn out of the Lfcb.  If the last Lsn is</span>
00772         <span class="comment">//  does not correspond to a log record, we will return the</span>
00773         <span class="comment">//  zero Lsn.</span>
00774         <span class="comment">//</span>
00775 
00776         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o54">Flags</a>, <a class="code" href="../../d1/d4/lfsstruc_8h.html#a7">LFCB_NO_LAST_LSN</a> )) {
00777 
00778             LastLsn = <a class="code" href="../../d6/d3/lfs_8h.html#a12">LfsZeroLsn</a>;
00779 
00780         } <span class="keywordflow">else</span> {
00781 
00782             LastLsn = Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o30">RestartArea</a>-&gt;<a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html#o0">CurrentLsn</a>;
00783         }
00784 
00785     } finally {
00786 
00787         <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( <a class="code" href="../../d6/d3/lfs_8h.html#a61">LfsQueryLastLsn</a> );
00788 
00789         <span class="comment">//</span>
00790         <span class="comment">//  Release the Lfcb if acquired.</span>
00791         <span class="comment">//</span>
00792 
00793         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a31">LfsReleaseLch</a>( Lch );
00794 
00795         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Last Lsn (Low)    -&gt; %08lx\n"</span>, LastLsn.LowPart );
00796         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Last Lsn (High)   -&gt; %08lx\n"</span>, LastLsn.HighPart );
00797         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"LfsQueryLastLsn:  Exit\n"</span>, 0 );
00798     }
00799 
00800     <span class="keywordflow">return</span> LastLsn;
00801 }
00802 
00803 
00804 <span class="comment">//</span>
00805 <span class="comment">//  Local support routine.</span>
00806 <span class="comment">//</span>
00807 
00808 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00809"></a><a class="code" href="../../d3/d3/querylog_8c.html#a2">00809</a> <a class="code" href="../../d3/d3/querylog_8c.html#a2">LfsFindLogRecord</a> (
00810     IN <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb,
00811     IN OUT <a class="code" href="../../d5/d9/struct__LCB.html">PLCB</a> Lcb,
00812     IN LSN Lsn,
00813     OUT PLFS_RECORD_TYPE RecordType,
00814     OUT TRANSACTION_ID *TransactionId,
00815     OUT PLSN UndoNextLsn,
00816     OUT PLSN PreviousLsn,
00817     OUT PULONG BufferLength,
00818     OUT PVOID *Buffer
00819     )
00820 
00821 <span class="comment">/*++</span>
00822 <span class="comment"></span>
00823 <span class="comment">Routine Description:</span>
00824 <span class="comment"></span>
00825 <span class="comment">    This routine is called recover a log record for a client.</span>
00826 <span class="comment"></span>
00827 <span class="comment">Arguments:</span>
00828 <span class="comment"></span>
00829 <span class="comment">    Lfcb - Log file control block for this file.</span>
00830 <span class="comment"></span>
00831 <span class="comment">    Lcb - Pointer to the context block to update.</span>
00832 <span class="comment"></span>
00833 <span class="comment">    Lsn - This is the Lsn for the log record.</span>
00834 <span class="comment"></span>
00835 <span class="comment">    RecordType - Supplies the address to store the record type of this</span>
00836 <span class="comment">                 log record.</span>
00837 <span class="comment"></span>
00838 <span class="comment">    TransactionId - Supplies the address to store the transaction Id of</span>
00839 <span class="comment">                    this log record.</span>
00840 <span class="comment"></span>
00841 <span class="comment">    UndoNextLsn - Supplies the address to store the Undo Next Lsn for this</span>
00842 <span class="comment">                  log record.</span>
00843 <span class="comment"></span>
00844 <span class="comment">    PreviousLsn - Supplies the address to store the Previous Lsn for this</span>
00845 <span class="comment">                  log record.</span>
00846 <span class="comment"></span>
00847 <span class="comment">    BufferLength - Pointer to address to store the length in bytes of the</span>
00848 <span class="comment">                   log record.</span>
00849 <span class="comment"></span>
00850 <span class="comment">    Buffer - Pointer to store the address where the log record data begins.</span>
00851 <span class="comment"></span>
00852 <span class="comment">Return Value:</span>
00853 <span class="comment"></span>
00854 <span class="comment">    None</span>
00855 <span class="comment"></span>
00856 <span class="comment">--*/</span>
00857 
00858 {
00859     PCHAR NewBuffer;
00860     BOOLEAN UsaError;
00861     LONGLONG LogRecordLength;
00862     ULONG PageOffset;
00863 
00864     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00865 
00866     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"LfsFindLogRecord:  Entered\n"</span>, 0 );
00867     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Lfcb          -&gt; %08lx\n"</span>, Lfcb );
00868     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Context Block -&gt; %08lx\n"</span>, Lcb );
00869     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Lsn (Low)     -&gt; %08lx\n"</span>, Lsn.LowPart );
00870 
00871     NewBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00872 
00873     <span class="comment">//</span>
00874     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00875     <span class="comment">//</span>
00876 
00877     <span class="keywordflow">try</span> {
00878 
00879         <span class="comment">//</span>
00880         <span class="comment">//  Map the record header for this Lsn if we haven't already.</span>
00881         <span class="comment">//</span>
00882 
00883         <span class="keywordflow">if</span> (Lcb-&gt;RecordHeader == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00884 
00885             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a49">LfsPinOrMapLogRecordHeader</a>( Lfcb,
00886                                         Lsn,
00887                                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00888                                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00889                                         &amp;UsaError,
00890                                         &amp;Lcb-&gt;RecordHeader,
00891                                         &amp;Lcb-&gt;RecordHeaderBcb );
00892         }
00893 
00894         <span class="comment">//</span>
00895         <span class="comment">//  We now have the log record desired.  If the Lsn in the</span>
00896         <span class="comment">//  log record doesn't match the desired Lsn then the disk is</span>
00897         <span class="comment">//  corrupt.</span>
00898         <span class="comment">//</span>
00899 
00900         <span class="keywordflow">if</span> ( Lsn.QuadPart != Lcb-&gt;RecordHeader-&gt;ThisLsn.QuadPart ) {                                                   <span class="comment">//**** xxNeq( Lsn, Lcb-&gt;RecordHeader-&gt;ThisLsn )</span>
00901 
00902             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_DISK_CORRUPT_ERROR );
00903         }
00904 
00905         <span class="comment">//</span>
00906         <span class="comment">//  Check that the length field isn't greater than the total available space</span>
00907         <span class="comment">//  in the log file.</span>
00908         <span class="comment">//</span>
00909 
00910         LogRecordLength = Lcb-&gt;RecordHeader-&gt;ClientDataLength + Lfcb-&gt;RecordHeaderLength;                              <span class="comment">//**** xxFromUlong( Lcb-&gt;RecordHeader-&gt;ClientDataLength + Lfcb-&gt;RecordHeaderLength );</span>
00911 
00912         <span class="keywordflow">if</span> ( LogRecordLength &gt;= Lfcb-&gt;TotalAvailable ) {                                                               <span class="comment">//**** xxGeq( LogRecordLength, Lfcb-&gt;TotalAvailable )</span>
00913 
00914             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_DISK_CORRUPT_ERROR );
00915         }
00916 
00917         <span class="comment">//</span>
00918         <span class="comment">//  If the entire log record is on this log page, put a pointer to</span>
00919         <span class="comment">//  the log record in the context block.</span>
00920         <span class="comment">//</span>
00921 
00922         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lcb-&gt;RecordHeader-&gt;Flags, <a class="code" href="../../d9/d3/lfsdisk_8h.html#a5">LOG_RECORD_MULTI_PAGE</a> )) {
00923 
00924             <span class="comment">//</span>
00925             <span class="comment">//  If client size indicates that we have to go beyond the end of the current</span>
00926             <span class="comment">//  page, we raise an error.</span>
00927             <span class="comment">//</span>
00928 
00929             PageOffset = <a class="code" href="../../d0/d4/lfsprocs_8h.html#a14">LfsLsnToPageOffset</a>( Lfcb, Lsn );
00930 
00931             <span class="keywordflow">if</span> ((PageOffset + Lcb-&gt;RecordHeader-&gt;ClientDataLength + Lfcb-&gt;RecordHeaderLength)
00932                 &gt; (ULONG)Lfcb-&gt;LogPageSize) {
00933 
00934                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_DISK_CORRUPT_ERROR );
00935             }
00936 
00937             Lcb-&gt;CurrentLogRecord = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( Lcb-&gt;RecordHeader, <a class="code" href="../../d9/d3/lfsdisk_8h.html#a6">LFS_RECORD_HEADER_SIZE</a>, PVOID );
00938             Lcb-&gt;AuxilaryBuffer = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00939 
00940         <span class="comment">//</span>
00941         <span class="comment">//  Else we copy the data and remember that we allocated a buffer.</span>
00942         <span class="comment">//</span>
00943 
00944         } <span class="keywordflow">else</span> {
00945 
00946             NewBuffer = <a class="code" href="../../d6/d5/logpgsup_8c.html#a3">LfsAllocateSpanningBuffer</a>( Lfcb, Lcb-&gt;RecordHeader-&gt;ClientDataLength );
00947 
00948             <span class="comment">//</span>
00949             <span class="comment">//  Copy the data into the buffer returned.</span>
00950             <span class="comment">//</span>
00951 
00952             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a50">LfsCopyReadLogRecord</a>( Lfcb,
00953                                   Lcb-&gt;RecordHeader,
00954                                   NewBuffer );
00955 
00956             Lcb-&gt;CurrentLogRecord = NewBuffer;
00957 
00958             Lcb-&gt;AuxilaryBuffer = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00959 
00960             NewBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00961         }
00962 
00963         <span class="comment">//</span>
00964         <span class="comment">//  We need to update the caller's parameters and the context block.</span>
00965         <span class="comment">//</span>
00966 
00967         *RecordType = Lcb-&gt;RecordHeader-&gt;RecordType;
00968         *TransactionId = Lcb-&gt;RecordHeader-&gt;TransactionId;
00969 
00970         *UndoNextLsn = Lcb-&gt;RecordHeader-&gt;ClientUndoNextLsn;
00971         *PreviousLsn = Lcb-&gt;RecordHeader-&gt;ClientPreviousLsn;
00972 
00973         *<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = Lcb-&gt;CurrentLogRecord;
00974         *BufferLength = Lcb-&gt;RecordHeader-&gt;ClientDataLength;
00975 
00976     } finally {
00977 
00978         <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( <a class="code" href="../../d3/d3/querylog_8c.html#a2">LfsFindLogRecord</a> );
00979 
00980         <span class="comment">//</span>
00981         <span class="comment">//  If an error occurred we unpin the record header and the log</span>
00982         <span class="comment">//  We also free the buffer if allocated by us.</span>
00983         <span class="comment">//</span>
00984 
00985         <span class="keywordflow">if</span> (NewBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00986 
00987             <a class="code" href="../../d6/d5/logpgsup_8c.html#a4">LfsFreeSpanningBuffer</a>( NewBuffer );
00988         }
00989 
00990         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Buffer Length -&gt; %08lx\n"</span>, *BufferLength );
00991         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Buffer        -&gt; %08lx\n"</span>, *<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> );
00992         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"LfsFindLogRecord:  Exit\n"</span>, 0 );
00993     }
00994 
00995     <span class="keywordflow">return</span>;
00996 }
00997 
00998 
00999 <span class="comment">//</span>
01000 <span class="comment">//  Local support routine.</span>
01001 <span class="comment">//</span>
01002 
01003 BOOLEAN
<a name="l01004"></a><a class="code" href="../../d3/d3/querylog_8c.html#a3">01004</a> <a class="code" href="../../d3/d3/querylog_8c.html#a3">LfsFindClientNextLsn</a> (
01005     IN <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb,
01006     IN <a class="code" href="../../d5/d9/struct__LCB.html">PLCB</a> Lcb,
01007     OUT PLSN Lsn
01008     )
01009 
01010 <span class="comment">/*++</span>
01011 <span class="comment"></span>
01012 <span class="comment">Routine Description:</span>
01013 <span class="comment"></span>
01014 <span class="comment">    This routine will attempt to find the next Lsn to return to a client</span>
01015 <span class="comment">    based on the context mode.</span>
01016 <span class="comment"></span>
01017 <span class="comment">Arguments:</span>
01018 <span class="comment"></span>
01019 <span class="comment">    Lfcb - File control block for this log file.</span>
01020 <span class="comment"></span>
01021 <span class="comment">    Lcb - Pointer to the context block for this query operation.</span>
01022 <span class="comment"></span>
01023 <span class="comment">    Lsn - Pointer to store the Lsn found (if any)</span>
01024 <span class="comment"></span>
01025 <span class="comment">Return Value:</span>
01026 <span class="comment"></span>
01027 <span class="comment">    BOOLEAN - TRUE if an Lsn is found, FALSE otherwise.</span>
01028 <span class="comment"></span>
01029 <span class="comment">--*/</span>
01030 
01031 {
01032     <a class="code" href="../../d6/d3/lfs_8h.html#a10">LSN</a> NextLsn;
01033     BOOLEAN NextLsnFound;
01034 
01035     <a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> ClientRecord;
01036 
01037     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01038 
01039     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"LfsFindClientNextLsn:  Entered\n"</span>, 0 );
01040     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Lcb  -&gt; %08lx\n"</span>, Lcb );
01041 
01042     ClientRecord = Lfcb-&gt;ClientArray + Lcb-&gt;ClientId.ClientIndex;
01043 
01044     <span class="comment">//</span>
01045     <span class="comment">//  The context block has the last Lsn returned.  If the user wanted</span>
01046     <span class="comment">//  one of the Lsn's in that log header then our job is simple.</span>
01047     <span class="comment">//</span>
01048 
01049     <span class="keywordflow">switch</span> (Lcb-&gt;ContextMode) {
01050 
01051     <span class="keywordflow">case</span> <a class="code" href="../../d6/d3/lfs_8h.html#a63a33">LfsContextUndoNext</a>:
01052     <span class="keywordflow">case</span> <a class="code" href="../../d6/d3/lfs_8h.html#a63a34">LfsContextPrevious</a>:
01053 
01054         NextLsn = (Lcb-&gt;ContextMode == <a class="code" href="../../d6/d3/lfs_8h.html#a63a33">LfsContextUndoNext</a>
01055                    ? Lcb-&gt;RecordHeader-&gt;ClientUndoNextLsn
01056                    : Lcb-&gt;RecordHeader-&gt;ClientPreviousLsn);
01057 
01058         <span class="keywordflow">if</span> ( NextLsn.QuadPart == 0 ) {                                                                                 <span class="comment">//**** xxEqlZero( NextLsn )</span>
01059 
01060             NextLsnFound = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01061 
01062         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d0/d4/lfsprocs_8h.html#a34">LfsVerifyClientLsnInRange</a>( Lfcb, ClientRecord, NextLsn )) {
01063 
01064             BOOLEAN UsaError;
01065 
01066             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a49">LfsPinOrMapLogRecordHeader</a>( Lfcb,
01067                                         NextLsn,
01068                                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01069                                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01070                                         &amp;UsaError,
01071                                         &amp;Lcb-&gt;RecordHeader,
01072                                         &amp;Lcb-&gt;RecordHeaderBcb );
01073 
01074             NextLsnFound = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01075 
01076         } <span class="keywordflow">else</span> {
01077 
01078             NextLsnFound = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01079         }
01080 
01081         <span class="keywordflow">break</span>;
01082 
01083     <span class="keywordflow">case</span> <a class="code" href="../../d6/d3/lfs_8h.html#a63a35">LfsContextForward</a>:
01084 
01085         <span class="comment">//</span>
01086         <span class="comment">//  We search forward for the next log record for this client.</span>
01087         <span class="comment">//</span>
01088 
01089         NextLsnFound = <a class="code" href="../../d3/d3/querylog_8c.html#a4">LfsSearchForwardByClient</a>( Lfcb, Lcb, &amp;NextLsn );
01090         <span class="keywordflow">break</span>;
01091 
01092     <span class="keywordflow">default</span>:
01093 
01094         NextLsnFound = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01095         <span class="keywordflow">break</span>;
01096     }
01097 
01098     <span class="keywordflow">if</span> (NextLsnFound) {
01099 
01100         *Lsn = NextLsn;
01101     }
01102 
01103     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"NextLsn (Low)     -&gt; %08lx\n"</span>, NextLsn.LowPart );
01104     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"NextLsn (High)    -&gt; %08lx\n"</span>, NextLsn.HighPart );
01105     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"LfsFindClientNextLsn:  Exit -&gt; %08x\n"</span>, NextLsnFound );
01106 
01107     <span class="keywordflow">return</span> NextLsnFound;
01108 }
01109 
01110 
01111 <span class="comment">//</span>
01112 <span class="comment">//  Local support routine.</span>
01113 <span class="comment">//</span>
01114 
01115 BOOLEAN
<a name="l01116"></a><a class="code" href="../../d3/d3/querylog_8c.html#a4">01116</a> <a class="code" href="../../d3/d3/querylog_8c.html#a4">LfsSearchForwardByClient</a> (
01117     IN <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb,
01118     IN OUT <a class="code" href="../../d5/d9/struct__LCB.html">PLCB</a> Lcb,
01119     OUT PLSN Lsn
01120     )
01121 
01122 <span class="comment">/*++</span>
01123 <span class="comment"></span>
01124 <span class="comment">Routine Description:</span>
01125 <span class="comment"></span>
01126 <span class="comment">    This routine will attempt to find the next Lsn for this client by searching</span>
01127 <span class="comment">    forward in the file, looking for a match.</span>
01128 <span class="comment"></span>
01129 <span class="comment">Arguments:</span>
01130 <span class="comment"></span>
01131 <span class="comment">    Lfcb - Pointer to the file control block for this log file.</span>
01132 <span class="comment"></span>
01133 <span class="comment">    Lcb - Pointer to the context block for this query operation.</span>
01134 <span class="comment"></span>
01135 <span class="comment">    Lsn - Points to the location to store the next Lsn if found.</span>
01136 <span class="comment"></span>
01137 <span class="comment">Return Value:</span>
01138 <span class="comment"></span>
01139 <span class="comment">    BOOLEAN - TRUE if another Lsn for this client is found.  FALSE otherwise.</span>
01140 <span class="comment"></span>
01141 <span class="comment">--*/</span>
01142 
01143 {
01144     <a class="code" href="../../d8/d0/struct__LFS__RECORD__HEADER.html">PLFS_RECORD_HEADER</a> CurrentRecordHeader;
01145     <a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a> CurrentBcb;
01146 
01147     BOOLEAN FoundNextLsn;
01148 
01149     <a class="code" href="../../d6/d3/lfs_8h.html#a10">LSN</a> CurrentLsn;
01150 
01151     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01152 
01153     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"LfsSearchForwardByClient:  Entered\n"</span>, 0 );
01154     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Lcb  -&gt; %08lx\n"</span>, Lcb );
01155 
01156     <span class="comment">//</span>
01157     <span class="comment">//  The log record header is in the log context</span>
01158     <span class="comment">//  block.  We set the current Bcb to NULL so that we don't</span>
01159     <span class="comment">//  unpin the log record in the context block until we're sure</span>
01160     <span class="comment">//  of success.</span>
01161     <span class="comment">//</span>
01162 
01163     CurrentRecordHeader = Lcb-&gt;RecordHeader;
01164 
01165     CurrentBcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01166 
01167     <span class="comment">//</span>
01168     <span class="comment">//  We use a try-finally to facilitate cleanup.</span>
01169     <span class="comment">//</span>
01170 
01171     <span class="keywordflow">try</span> {
01172 
01173         <span class="comment">//</span>
01174         <span class="comment">//  We assume we won't find another Lsn.</span>
01175         <span class="comment">//</span>
01176 
01177         FoundNextLsn = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01178 
01179         <span class="comment">//</span>
01180         <span class="comment">//  Loop as long as another Lsn can be found.</span>
01181         <span class="comment">//</span>
01182 
01183         <span class="keywordflow">while</span> (<a class="code" href="../../d9/d7/lsnsup_8c.html#a2">LfsFindNextLsn</a>( Lfcb, CurrentRecordHeader, &amp;CurrentLsn )) {
01184 
01185             BOOLEAN UsaError;
01186 
01187             <span class="comment">//</span>
01188             <span class="comment">//  Unpin the previous log record header.</span>
01189             <span class="comment">//</span>
01190 
01191             <span class="keywordflow">if</span> (CurrentBcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01192 
01193                 <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( CurrentBcb );
01194                 CurrentBcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01195             }
01196 
01197             <span class="comment">//</span>
01198             <span class="comment">//  Pin the log record header for this Lsn.</span>
01199             <span class="comment">//</span>
01200 
01201             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a49">LfsPinOrMapLogRecordHeader</a>( Lfcb,
01202                                         CurrentLsn,
01203                                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01204                                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01205                                         &amp;UsaError,
01206                                         &amp;CurrentRecordHeader,
01207                                         &amp;CurrentBcb );
01208 
01209             <span class="comment">//</span>
01210             <span class="comment">//  If the client values match, then we update the</span>
01211             <span class="comment">//  context block and exit.</span>
01212             <span class="comment">//</span>
01213 
01214             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d4/lfsprocs_8h.html#a35">LfsClientIdMatch</a>( &amp;CurrentRecordHeader-&gt;<a class="code" href="../../d8/d0/struct__LFS__RECORD__HEADER.html#o4">ClientId</a>,
01215                                   &amp;Lcb-&gt;ClientId )
01216                 &amp;&amp; CurrentRecordHeader-&gt;<a class="code" href="../../d8/d0/struct__LFS__RECORD__HEADER.html#o5">RecordType</a> == <a class="code" href="../../d6/d3/lfs_8h.html#a62a31">LfsClientRecord</a>) {
01217 
01218                 <span class="comment">//</span>
01219                 <span class="comment">//  We remember this one.</span>
01220                 <span class="comment">//</span>
01221 
01222                 Lcb-&gt;RecordHeader = CurrentRecordHeader;
01223                 Lcb-&gt;RecordHeaderBcb = CurrentBcb;
01224 
01225                 CurrentBcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01226                 FoundNextLsn = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01227 
01228                 *Lsn = CurrentLsn;
01229                 <span class="keywordflow">break</span>;
01230             }
01231         }
01232 
01233     } finally {
01234 
01235         <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( <a class="code" href="../../d3/d3/querylog_8c.html#a4">LfsSearchForwardByClient</a> );
01236 
01237         <span class="comment">//</span>
01238         <span class="comment">//  Unpin any log record headers still pinned for no reason.</span>
01239         <span class="comment">//</span>
01240 
01241         <span class="keywordflow">if</span> (CurrentBcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01242 
01243             <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( CurrentBcb );
01244         }
01245 
01246         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"NextLsn (Low)     -&gt; %08lx\n"</span>, Lsn-&gt;LowPart );
01247         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"NextLsn (High)    -&gt; %08lx\n"</span>, Lsn-&gt;HighPart );
01248         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"LfsSearchForwardByClient:  Exit -&gt; %08x\n"</span>, FoundNextLsn );
01249     }
01250 
01251     <span class="keywordflow">return</span> FoundNextLsn;
01252 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:34 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
