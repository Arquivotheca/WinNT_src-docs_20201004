<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: dumpuser.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>dumpuser.c</h1><a href="../../d3/d3/dumpuser_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 
00002 <span class="comment">/*  Defines for Jim   */</span>
00003 <span class="comment">// #define LONGNAMES</span>
<a name="l00004"></a><a class="code" href="../../d3/d3/dumpuser_8c.html#a0">00004</a> <span class="preprocessor">#define SECPKG       "[Tmpv1_0]"</span>
00005 <span class="preprocessor"></span>
00006 <span class="preprocessor">#ifdef LONGNAMES</span>
00007 <span class="preprocessor"></span><span class="preprocessor">#define SERVOP "DOMAIN_SERVER_OPERATORS "</span>
00008 <span class="preprocessor"></span><span class="preprocessor">#define ACCTOP "DOMAIN_ACCOUNT_OPERATORS "</span>
00009 <span class="preprocessor"></span><span class="preprocessor">#define COMMOP "DOMAIN_COMM_OPERATORS "</span>
00010 <span class="preprocessor"></span><span class="preprocessor">#define PRINTOP "DOMAIN_PRINT_OPERATORS "</span>
00011 <span class="preprocessor"></span><span class="preprocessor">#define DISKOP "DOMAIN_DISK_OPERATORS "</span>
00012 <span class="preprocessor"></span><span class="preprocessor">#define AUDITOP "DOMAIN_AUDIT_OPERATORS "</span>
00013 <span class="preprocessor"></span><span class="preprocessor">#define GADMINS  "DOMAIN_ADMIN "</span>
00014 <span class="preprocessor"></span><span class="preprocessor">#define GUSERS   "DOMAIN_USERS "</span>
00015 <span class="preprocessor"></span><span class="preprocessor">#define GGUESTS  "DOMAIN_GUESTS "</span>
00016 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00017"></a><a class="code" href="../../d3/d3/dumpuser_8c.html#a1">00017</a> <span class="preprocessor"></span><span class="preprocessor">#define SERVOP    "D_SERVER "</span>
<a name="l00018"></a><a class="code" href="../../d3/d3/dumpuser_8c.html#a2">00018</a> <span class="preprocessor"></span><span class="preprocessor">#define ACCTOP    "D_ACCOUN "</span>
<a name="l00019"></a><a class="code" href="../../d3/d3/dumpuser_8c.html#a3">00019</a> <span class="preprocessor"></span><span class="preprocessor">#define COMMOP    "D_COMM_O "</span>
<a name="l00020"></a><a class="code" href="../../d3/d3/dumpuser_8c.html#a4">00020</a> <span class="preprocessor"></span><span class="preprocessor">#define PRINTOP   "D_PRINT_ "</span>
<a name="l00021"></a><a class="code" href="../../d3/d3/dumpuser_8c.html#a5">00021</a> <span class="preprocessor"></span><span class="preprocessor">#define DISKOP    "D_DISK_O "</span>
<a name="l00022"></a><a class="code" href="../../d3/d3/dumpuser_8c.html#a6">00022</a> <span class="preprocessor"></span><span class="preprocessor">#define AUDITOP   "D_AUDIT_ "</span>
<a name="l00023"></a><a class="code" href="../../d3/d3/dumpuser_8c.html#a7">00023</a> <span class="preprocessor"></span><span class="preprocessor">#define GADMINS   "D_ADMIN "</span>
<a name="l00024"></a><a class="code" href="../../d3/d3/dumpuser_8c.html#a8">00024</a> <span class="preprocessor"></span><span class="preprocessor">#define GUSERS    "D_USERS "</span>
<a name="l00025"></a><a class="code" href="../../d3/d3/dumpuser_8c.html#a9">00025</a> <span class="preprocessor"></span><span class="preprocessor">#define GGUESTS   "D_GUESTS "</span>
00026 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00027 <span class="preprocessor"></span>
00028 
<a name="l00029"></a><a class="code" href="../../d3/d3/dumpuser_8c.html#a10">00029</a> <span class="preprocessor">#define INCL_DOSMEMMGR</span>
00030 <span class="preprocessor"></span><span class="preprocessor">#include &lt;os2.h&gt;</span>
00031 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00032 <span class="preprocessor">#include &lt;string.h&gt;</span>
00033 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00034 <span class="preprocessor">#include &lt;netcons.h&gt;</span>
00035 <span class="preprocessor">#include &lt;neterr.h&gt;</span>
00036 <span class="preprocessor">#include &lt;netlib.h&gt;</span>
00037 <span class="preprocessor">#include &lt;uascache.h&gt;</span>
00038 <span class="preprocessor">#include &lt;<a class="code" href="../../d9/d3/access_8h.html">access.h</a>&gt;</span>
00039 <span class="preprocessor">#include &lt;permit.h&gt;</span>
00040 <span class="preprocessor">#include "ssitools.h"</span>
00041 
<a name="l00042"></a><a class="code" href="../../d3/d3/dumpuser_8c.html#a11">00042</a> <span class="keywordtype">char</span> <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> *  <a class="code" href="../../d3/d3/dumpuser_8c.html#a11">buf1</a>;
<a name="l00043"></a><a class="code" href="../../d3/d3/dumpuser_8c.html#a12">00043</a> <span class="keywordtype">char</span> <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> *  <a class="code" href="../../d3/d3/dumpuser_8c.html#a12">buf2</a>;
<a name="l00044"></a><a class="code" href="../../d3/d3/dumpuser_8c.html#a13">00044</a> <span class="keywordtype">char</span> <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> *  <a class="code" href="../../d3/d3/dumpuser_8c.html#a13">GroupCache</a>;
<a name="l00045"></a><a class="code" href="../../d3/d3/dumpuser_8c.html#a14">00045</a> <span class="keywordtype">char</span>        <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>[256];
<a name="l00046"></a><a class="code" href="../../d3/d3/dumpuser_8c.html#a15">00046</a> <span class="keywordtype">char</span>        <a class="code" href="../../d3/d3/dumpuser_8c.html#a15">userbuf</a>[MAX_USER_SIZE];
<a name="l00047"></a><a class="code" href="../../d3/d3/dumpuser_8c.html#a16">00047</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>    <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
<a name="l00048"></a><a class="code" href="../../d3/d3/dumpuser_8c.html#a17">00048</a> <span class="keyword">struct </span>_ahdr <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> * <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>;
00049 
00050 <span class="keywordtype">void</span> <a class="code" href="../../d3/d3/dumpuser_8c.html#a18">InitMemStuff</a>(<span class="keywordtype">void</span>);
00051 <span class="keywordtype">void</span> <a class="code" href="../../d3/d3/dumpuser_8c.html#a19">loadit</a>(<span class="keywordtype">void</span>);
00052 <span class="keywordtype">void</span> <a class="code" href="../../d3/d3/dumpuser_8c.html#a20">showentries</a>(<span class="keywordtype">void</span>);
00053 <span class="keywordtype">void</span> <a class="code" href="../../d3/d3/dumpuser_8c.html#a21">doargs</a>(<span class="keywordtype">int</span>, <span class="keywordtype">char</span>**);
00054 
<a name="l00055"></a><a class="code" href="../../d4/d1/structmy__group.html">00055</a> <span class="keyword">struct </span><a class="code" href="../../d4/d1/structmy__group.html">my_group</a> {
<a name="l00056"></a><a class="code" href="../../d4/d1/structmy__group.html#o0">00056</a>    <span class="keywordtype">char</span>  <a class="code" href="../../d4/d1/structmy__group.html#o0">name</a>[GNLEN + 1];
<a name="l00057"></a><a class="code" href="../../d4/d1/structmy__group.html#o1">00057</a>    <span class="keywordtype">char</span>  <a class="code" href="../../d4/d1/structmy__group.html#o1">pad</a>;
<a name="l00058"></a><a class="code" href="../../d4/d1/structmy__group.html#o2">00058</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <a class="code" href="../../d4/d1/structmy__group.html#o2">gid</a>;
<a name="l00059"></a><a class="code" href="../../d4/d1/structmy__group.html#o3">00059</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>  <a class="code" href="../../d4/d1/structmy__group.html#o3">serial</a>;
00060 };
00061 
00062 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00063"></a><a class="code" href="../../d3/d3/dumpuser_8c.html#a22">00063</a> <a class="code" href="../../d3/d3/dumpuser_8c.html#a22">UserHashVal</a>(uname, domain)
00064 const <span class="keywordtype">char</span> far *uname;
00065 <span class="keywordtype">int</span> domain;
00066 {
00067         <span class="keyword">register</span> <span class="keywordtype">unsigned</span> val=0;
00068         <span class="keyword">register</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>;
00069 
00070         <span class="keywordflow">while</span> ((<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>= (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>) *uname++))
00071                 val += toupper(<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>);
00072 
00073         <span class="keywordflow">return</span> (<span class="keywordtype">int</span>) (val % domain);
00074 }
00075 
00076 <span class="keywordtype">unsigned</span>
<a name="l00077"></a><a class="code" href="../../d3/d3/dumpuser_8c.html#a23">00077</a> <a class="code" href="../../d3/d3/dumpuser_8c.html#a23">dread</a>(<span class="keywordtype">unsigned</span> handle, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> pos, <span class="keywordtype">char</span> far * buffer, <span class="keywordtype">unsigned</span> length)
00078 {
00079    <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> err, bread;
00080    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> newpos;
00081 
00082    err = DosChgFilePtr(handle, pos, FILE_BEGIN, &amp;newpos);
00083    <span class="keywordflow">if</span> (err)
00084       <span class="keywordflow">return</span> err;
00085    <span class="keywordflow">if</span> (newpos != pos)
00086       <span class="keywordflow">return</span> NERR_ACFFileIOFail;
00087    err = DosRead( handle, buffer, length, &amp;bread);
00088    <span class="keywordflow">if</span> (err)
00089       <span class="keywordflow">return</span> err;
00090    <span class="keywordflow">if</span> (bread != length)
00091       <span class="keywordflow">return</span> NERR_ACFFileIOFail;
00092    <span class="keywordflow">return</span> 0;
00093 }
00094 
<a name="l00095"></a><a class="code" href="../../d3/d3/dumpuser_8c.html#a24">00095</a> <span class="keywordtype">unsigned</span> <a class="code" href="../../d3/d3/dumpuser_8c.html#a24">read_object</a>(<span class="keywordtype">unsigned</span> handle, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> pos, <span class="keywordtype">char</span> FAR * buf)
00096 {
00097    <span class="keywordtype">unsigned</span> err;
00098    <span class="keyword">struct </span>disk_obj_hdr <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> * dobj;
00099 
00100    err = <a class="code" href="../../d3/d3/dumpuser_8c.html#a23">dread</a>(handle, pos, buf, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> disk_obj_hdr));
00101    <span class="keywordflow">if</span> (err)
00102       <span class="keywordflow">return</span> err;
00103    dobj = (<span class="keyword">struct </span>disk_obj_hdr <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> *) buf;
00104    <span class="keywordflow">return</span> <a class="code" href="../../d3/d3/dumpuser_8c.html#a23">dread</a>(handle, pos, buf, dobj-&gt;do_numblocks * 64);
00105 }
00106 
<a name="l00107"></a><a class="code" href="../../d3/d3/dumpuser_8c.html#a18">00107</a> <span class="keywordtype">void</span> <a class="code" href="../../d3/d3/dumpuser_8c.html#a18">InitMemStuff</a>()
00108 {
00109    <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>    err;
00110    <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>    sel, action;
00111 
00112    err = DosAllocSeg(0x8000, &amp;sel, 0);
00113    <span class="keywordflow">if</span> (err) {
00114       printf(<span class="stringliteral">"Could not alloc memory, error %d\n"</span>, err);
00115       <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>(1);
00116    }
00117    <a class="code" href="../../d3/d3/dumpuser_8c.html#a11">buf1</a> = MAKEP(sel, 0);
00118    err = DosAllocSeg(0x8000, &amp;sel, 0);
00119    <span class="keywordflow">if</span> (err) {
00120       printf(<span class="stringliteral">"Could not alloc memory, error %d\n"</span>, err);
00121       <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>(1);
00122    }
00123    <a class="code" href="../../d3/d3/dumpuser_8c.html#a12">buf2</a> = MAKEP(sel, 0);
00124    err = DosAllocSeg(1024, &amp;sel, 0);
00125    <span class="keywordflow">if</span> (err) {
00126       printf(<span class="stringliteral">"Could not alloc memory, error %d\n"</span>, err);
00127       <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>(1);
00128    }
00129    <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a> = MAKEP(sel, 0);
00130    <span class="keywordflow">if</span> (err = DosAllocSeg(0x8000, &amp;sel, 0)) {
00131       printf(<span class="stringliteral">"Could not alloc memory, error %d\n"</span>, err);
00132       <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>(1);
00133    }
00134    <a class="code" href="../../d3/d3/dumpuser_8c.html#a13">GroupCache</a> = MAKEP(sel, 0);
00135    err = DosOpen(<a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>, &amp;<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>, &amp;action, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>, 0, FILE_OPEN,
00136                   OPEN_ACCESS_READONLY | OPEN_SHARE_DENYNONE, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
00137    <span class="keywordflow">if</span> (err) {
00138       printf(<span class="stringliteral">"Error opening %s, code %d\n"</span>, <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>, err);
00139       <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>(1);
00140    }
00141    err = DosRead(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>, <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>, 512, &amp;action);
00142    <span class="keywordflow">if</span> (err || action != 512) {
00143       printf(<span class="stringliteral">"Error reading from file, code %d\n"</span>, err);
00144       <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>(1);
00145    }
00146    printf(<span class="stringliteral">"Total users, %d\n"</span>, <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;num_users);
00147 }
00148 
<a name="l00149"></a><a class="code" href="../../d3/d3/dumpuser_8c.html#a19">00149</a> <span class="keywordtype">void</span> <a class="code" href="../../d3/d3/dumpuser_8c.html#a19">loadit</a>()
00150 {
00151    <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>    err;
00152    <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>    action;
00153    <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>    i;
00154    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>     pos;
00155    <span class="keyword">struct </span>diskuserhash <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> *diskhashentry;
00156    <span class="keyword">struct </span>userhash <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> *userhashentry;
00157    <span class="keyword">struct </span>_grouprec <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> * grec;
00158    <span class="keyword">struct </span><a class="code" href="../../d4/d1/structmy__group.html">my_group</a> <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> * mygroup;
00159 
00160    err = DosChgFilePtr(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>, 512<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>, FILE_BEGIN, &amp;pos);
00161    err = DosRead(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>, <a class="code" href="../../d3/d3/dumpuser_8c.html#a11">buf1</a>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> _grouprec) * MAXGROUP, &amp;action);
00162    <span class="keywordflow">if</span> (err || action != <span class="keyword">sizeof</span>(<span class="keyword">struct </span>_grouprec) * MAXGROUP) {
00163       printf(<span class="stringliteral">"Error reading from file, %d\n"</span>, err);
00164       <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>(1);
00165    }
00166    mygroup = (<span class="keyword">struct </span><a class="code" href="../../d4/d1/structmy__group.html">my_group</a> <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> *) <a class="code" href="../../d3/d3/dumpuser_8c.html#a13">GroupCache</a>;
00167    grec = (<span class="keyword">struct </span>_grouprec <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> *) <a class="code" href="../../d3/d3/dumpuser_8c.html#a11">buf1</a>;
00168    <span class="keywordflow">for</span> (i = 0; i &lt; MAXGROUP ; i++, grec++, mygroup++ ) {
00169       <span class="keywordflow">if</span> (grec-&gt;name[0] != REC_EMPTY &amp;&amp; grec-&gt;name[0] != REC_DELETE) {
00170 <span class="comment">/*         if (strcmpf(grec-&gt;name, "ADMINS") == 0) {</span>
00171 <span class="comment">            strcpyf(mygroup-&gt;name, GADMIN);</span>
00172 <span class="comment">          else if (strcmpf(grec-&gt;name, "USERS") == 0)</span>
00173 <span class="comment">            strcpyf(mygroup-&gt;name, GUSERS);</span>
00174 <span class="comment">          else if (strcmpf(grec-&gt;name, "GUESTS") == 0)</span>
00175 <span class="comment">            strcpyf(mygroup-&gt;name, GGUESTS);</span>
00176 <span class="comment">          else */</span>
00177          strncpyf(mygroup-&gt;name, grec-&gt;name, GNLEN);
00178          mygroup-&gt;gid = <a class="code" href="../../d3/d3/dumpuser_8c.html#a22">UserHashVal</a>(mygroup-&gt;name, MAXGROUP);
00179          mygroup-&gt;serial = grec-&gt;serial;
00180       } <span class="keywordflow">else</span>
00181          mygroup-&gt;name[0] = <span class="charliteral">'\0'</span>;
00182    }
00183 
00184    err = DosChgFilePtr(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>) HASH_TBL_OFFSET, FILE_BEGIN, &amp;pos);
00185    diskhashentry = (<span class="keyword">struct </span>diskuserhash <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> *)  <a class="code" href="../../d3/d3/dumpuser_8c.html#a11">buf1</a>;
00186    <span class="keywordflow">if</span> (err = DosRead (<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>, diskhashentry, HASH_TBL_SIZE, &amp;action)) {
00187       printf(<span class="stringliteral">"Could not read hash table, error %d\n"</span>, err);
00188       <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>(1);
00189    }
00190 
00191    <span class="keywordflow">if</span> (action != HASH_TBL_SIZE) {
00192       printf(<span class="stringliteral">"Could not read hash table\n"</span>);
00193       <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>(1);
00194    }
00195    <span class="comment">/*</span>
00196 <span class="comment">    *  Copy disk user hash table into memory</span>
00197 <span class="comment">    */</span>
00198     userhashentry = (<span class="keyword">struct </span>userhash <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> *) <a class="code" href="../../d3/d3/dumpuser_8c.html#a12">buf2</a>;
00199     <span class="keywordflow">for</span> (i = 0; i &lt; USER_HASH_ENTRIES; i++) {
00200                 userhashentry-&gt;uh_disk = diskhashentry-&gt;dh_disk;
00201                 userhashentry-&gt;uh_serial = diskhashentry-&gt;dh_serial;
00202                 userhashentry-&gt;uh_cache = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00203                 userhashentry++;
00204                 diskhashentry++;
00205         }
00206 }
00207 
<a name="l00208"></a><a class="code" href="../../d3/d3/dumpuser_8c.html#a25">00208</a> <span class="keywordtype">void</span> <a class="code" href="../../d3/d3/dumpuser_8c.html#a25">printgroups</a>()
00209 {
00210    <span class="keyword">struct </span><a class="code" href="../../d4/d1/structmy__group.html">my_group</a> <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> * mygroup = (<span class="keyword">struct </span><a class="code" href="../../d4/d1/structmy__group.html">my_group</a> <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> *) <a class="code" href="../../d3/d3/dumpuser_8c.html#a13">GroupCache</a>;
00211    <span class="keywordtype">unsigned</span> i;
00212    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>  relid;
00213 
00214    printf(<span class="stringliteral">"\t// Groups\n"</span>);
00215    <span class="keywordflow">for</span> (i = 0; i&lt; MAXGROUP ; i++, mygroup++ ) {
00216       <span class="keywordflow">if</span> (mygroup-&gt;name[0]) {
00217          relid = ((mygroup-&gt;gid | GROUPIDMASK) + (mygroup-&gt;serial &lt;&lt; 16)) ^ 0x80000000<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00218          printf(<span class="stringliteral">"\tGroup = %ld %Fs\n"</span>, relid, mygroup-&gt;name);
00219       }
00220    }
00221 }
<a name="l00222"></a><a class="code" href="../../d3/d3/dumpuser_8c.html#a20">00222</a> <span class="keywordtype">void</span> <a class="code" href="../../d3/d3/dumpuser_8c.html#a20">showentries</a>()
00223 {
00224    <span class="keywordtype">unsigned</span> i, j, k;
00225    <span class="keywordtype">unsigned</span> err;
00226    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> pos, oprights;
00227    <span class="keywordtype">signed</span> <span class="keywordtype">long</span> relativeid;
00228    <span class="keywordtype">unsigned</span> usercount = 0;
00229    <span class="keyword">struct </span>userhash <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> * entry = (<span class="keyword">struct </span>userhash <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> *) <a class="code" href="../../d3/d3/dumpuser_8c.html#a12">buf2</a>;
00230    <span class="keyword">struct </span>user_object <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> * uo = (<span class="keyword">struct </span>user_object <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> *) <a class="code" href="../../d3/d3/dumpuser_8c.html#a15">userbuf</a>;
00231    <span class="keyword">struct </span><a class="code" href="../../d4/d1/structmy__group.html">my_group</a> <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> * mygroup = (<span class="keyword">struct </span><a class="code" href="../../d4/d1/structmy__group.html">my_group</a> <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> *) <a class="code" href="../../d3/d3/dumpuser_8c.html#a13">GroupCache</a>;
00232    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> * gmask;
00233    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> test;
00234    <span class="keywordtype">char</span> groupnames[256];
00235 
00236    printf(<span class="stringliteral">"\n\n\t// Users\n"</span>);
00237    <span class="keywordflow">for</span> (i = 0; i &lt; USER_HASH_ENTRIES ; i++ ) {
00238       pos = entry-&gt;uh_disk;
00239       <span class="keywordflow">while</span> (pos) {
00240          <span class="keywordflow">if</span> (err = <a class="code" href="../../d3/d3/dumpuser_8c.html#a24">read_object</a>(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>, pos, <a class="code" href="../../d3/d3/dumpuser_8c.html#a15">userbuf</a>)) {
00241             printf(<span class="stringliteral">"Failed reading object, code %d\n"</span>, err);
00242             <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>(1);
00243          }
00244          relativeid = ( ((uo-&gt;uo_record.user.uc0_guid.guid_serial) &lt;&lt; 16) +
00245                       (uo-&gt;uo_record.user.uc0_guid.guid_uid) ) ^ 0x80000000;
00246          gmask = uo-&gt;uo_record.user.uc0_groups;
00247          groupnames[0] = <span class="charliteral">'\0'</span>;
00248          <span class="keywordflow">for</span> (j = 0; j &lt; 32 ; j++ ) {
00249             test = gmask[j];
00250             k = 0;
00251             <span class="keywordflow">while</span> (test) {
00252                <span class="keywordflow">if</span> (test &amp; 1) {
00253                   strcatf(groupnames, mygroup[j * 8 + k].name);
00254                   strcatf(groupnames, <span class="stringliteral">" "</span>);
00255                }
00256                test &gt;&gt;= 1;
00257                k++;
00258             }
00259          }
00260 
00261          oprights = uo-&gt;uo_record.user.uc0_auth_flags;
00262          <span class="keywordflow">if</span> (oprights &amp; AF_OP_PRINT)
00263             strcat(groupnames, <a class="code" href="../../d3/d3/dumpuser_8c.html#a4">PRINTOP</a>);
00264          <span class="keywordflow">if</span> (oprights &amp; AF_OP_COMM)
00265             strcat(groupnames, <a class="code" href="../../d3/d3/dumpuser_8c.html#a3">COMMOP</a>);
00266          <span class="keywordflow">if</span> (oprights &amp; AF_OP_SERVER)
00267             strcat(groupnames, <a class="code" href="../../d3/d3/dumpuser_8c.html#a1">SERVOP</a>);
00268          <span class="keywordflow">if</span> (oprights &amp; AF_OP_ACCOUNTS)
00269             strcat(groupnames, <a class="code" href="../../d3/d3/dumpuser_8c.html#a2">ACCTOP</a>);
00270 
00271          printf(<span class="stringliteral">"\tUser = %ld %Fs %Fs\n"</span>, relativeid,
00272                      (<span class="keywordtype">char</span> <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> *) uo-&gt;uo_record.name,
00273                      (<span class="keywordtype">char</span> <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> *) groupnames);
00274          usercount++;
00275          pos = uo-&gt;uo_header.do_next;
00276       }
00277       entry++;
00278    }
00279    <span class="keywordflow">if</span> (usercount != <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;num_users) {
00280       printf(<span class="stringliteral">"Huh?  Didn't find all the users (found %d)\n"</span>, usercount);
00281    }
00282 }
00283 
<a name="l00284"></a><a class="code" href="../../d3/d3/dumpuser_8c.html#a26">00284</a> <span class="keywordtype">void</span> <a class="code" href="../../d3/d3/dumpuser_8c.html#a26">banner</a>(<span class="keywordtype">unsigned</span> longnames)
00285 {
00286 
00287    printf(<a class="code" href="../../d3/d3/dumpuser_8c.html#a0">SECPKG</a>);
00288    printf(<span class="stringliteral">"\n\n\t//\n\t// Account Setup information\n"</span>);
00289    printf(<span class="stringliteral">"\t//  This file produced from the LAN Manager 2.0 UAS\n"</span>);
00290    printf(<span class="stringliteral">"\t//      %s\n"</span>, <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>);
00291 
00292    printf(<span class="stringliteral">"\tGroup = 501 %s\n"</span>, <a class="code" href="../../d3/d3/dumpuser_8c.html#a7">GADMINS</a>);
00293    printf(<span class="stringliteral">"\tGroup = 502 %s\n"</span>, <a class="code" href="../../d3/d3/dumpuser_8c.html#a8">GUSERS</a>);
00294    printf(<span class="stringliteral">"\tGroup = 503 %s\n"</span>, <a class="code" href="../../d3/d3/dumpuser_8c.html#a9">GGUESTS</a>);
00295    printf(<span class="stringliteral">"\tGroup = 504 %s\n"</span>, <a class="code" href="../../d3/d3/dumpuser_8c.html#a2">ACCTOP</a>);
00296    printf(<span class="stringliteral">"\tGroup = 505 %s\n"</span>, <a class="code" href="../../d3/d3/dumpuser_8c.html#a1">SERVOP</a>);
00297    printf(<span class="stringliteral">"\tGroup = 506 %s\n"</span>, <a class="code" href="../../d3/d3/dumpuser_8c.html#a4">PRINTOP</a>);
00298    printf(<span class="stringliteral">"\tGroup = 507 %s\n"</span>, <a class="code" href="../../d3/d3/dumpuser_8c.html#a3">COMMOP</a>);
00299    printf(<span class="stringliteral">"\tGroup = 508 %s\n"</span>, <a class="code" href="../../d3/d3/dumpuser_8c.html#a5">DISKOP</a>);
00300    printf(<span class="stringliteral">"\tGroup = 509 %s\n"</span>, <a class="code" href="../../d3/d3/dumpuser_8c.html#a6">AUDITOP</a>);
00301 }
00302 
<a name="l00303"></a><a class="code" href="../../d3/d3/dumpuser_8c.html#a21">00303</a> <span class="keywordtype">void</span> <a class="code" href="../../d3/d3/dumpuser_8c.html#a21">doargs</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
00304 {
00305    <span class="keywordflow">if</span> (argc != 2 || *argv[1] == <span class="charliteral">'?'</span>) {
00306       printf(<span class="stringliteral">"usage:  %s path\\net.acc\n"</span>, argv[0]);
00307       printf(<span class="stringliteral">"\tlists all the users/groups and their hash/serial numbers for a UAS\n"</span>);
00308       <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>(0);
00309    }
00310    strcpy(<a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>, argv[1]);
00311 }
00312 
<a name="l00313"></a><a class="code" href="../../d3/d3/dumpuser_8c.html#a27">00313</a> <a class="code" href="../../d2/d5/editreg_8c.html#a87">main</a> (<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
00314 {
00315    printf(SIGNON);
00316    <a class="code" href="../../d3/d3/dumpuser_8c.html#a21">doargs</a>(argc, argv);
00317    <a class="code" href="../../d3/d3/dumpuser_8c.html#a18">InitMemStuff</a>();
00318    <a class="code" href="../../d3/d3/dumpuser_8c.html#a19">loadit</a>();
00319 
00320    <a class="code" href="../../d3/d3/dumpuser_8c.html#a26">banner</a>(0);
00321 
00322    <a class="code" href="../../d3/d3/dumpuser_8c.html#a25">printgroups</a>();
00323    <a class="code" href="../../d3/d3/dumpuser_8c.html#a20">showentries</a>();
00324 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:47 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
