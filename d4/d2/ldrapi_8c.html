<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: ldrapi.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>ldrapi.c File Reference</h1><code>#include "<a class="el" href="../../d0/d2/ldrp_8h-source.html">ldrp.h</a>"</code><br>

<p>
<a href="../../d5/d1/ldrapi_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d2/ldrapi_8c.html#a0">DLLEXTENSION</a>&nbsp;&nbsp;&nbsp;((PWSTR)".\0d\0l\0l\0\0")</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d2/ldrapi_8c.html#a1">LdrpClearLoadInProgress</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d2/ldrapi_8c.html#a2">LdrLoadDll</a> (IN PWSTR DllPath OPTIONAL, IN PULONG DllCharacteristics OPTIONAL, IN PUNICODE_STRING DllName, OUT PVOID *DllHandle)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS NTAPI&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d2/ldrapi_8c.html#a3">LdrpLoadDll</a> (IN PWSTR DllPath OPTIONAL, IN PULONG DllCharacteristics OPTIONAL, IN PUNICODE_STRING DllName, OUT PVOID *DllHandle, IN BOOLEAN RunInitRoutines)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d2/ldrapi_8c.html#a4">LdrGetDllHandle</a> (IN PWSTR DllPath OPTIONAL, IN PULONG DllCharacteristics OPTIONAL, IN PUNICODE_STRING DllName, OUT PVOID *DllHandle)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d2/ldrapi_8c.html#a5">LdrDisableThreadCalloutsForDll</a> (IN PVOID DllHandle)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d2/ldrapi_8c.html#a6">LdrUnloadDll</a> (IN PVOID DllHandle)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d2/ldrapi_8c.html#a7">LdrGetProcedureAddress</a> (IN PVOID DllHandle, IN PANSI_STRING ProcedureName OPTIONAL, IN ULONG ProcedureNumber OPTIONAL, OUT PVOID *ProcedureAddress)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d2/ldrapi_8c.html#a8">LdrpGetProcedureAddress</a> (IN PVOID DllHandle, IN PANSI_STRING ProcedureName OPTIONAL, IN ULONG ProcedureNumber OPTIONAL, OUT PVOID *ProcedureAddress, IN BOOLEAN RunInitRoutines)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS NTAPI&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d2/ldrapi_8c.html#a9">LdrVerifyImageMatchesChecksum</a> (IN HANDLE ImageFileHandle, IN PLDR_IMPORT_MODULE_CALLBACK ImportCallbackRoutine OPTIONAL, IN PVOID ImportCallbackParameter, OUT <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a22">PUSHORT</a> ImageCharacteristics OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d2/ldrapi_8c.html#a10">LdrQueryProcessModuleInformation</a> (OUT PRTL_PROCESS_MODULES ModuleInformation, IN ULONG ModuleInformationLength, OUT PULONG ReturnLength OPTIONAL)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="ldrapi.c::DLLEXTENSION" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DLLEXTENSION&nbsp;&nbsp;&nbsp;((PWSTR)".\0d\0l\0l\0\0")          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00026">26</a> of file <a class="el" href="../../d5/d1/ldrapi_8c-source.html">ldrapi.c</a>.
<p>
Referenced by <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00295">LdrGetDllHandle()</a>, and <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00070">LdrpLoadDll()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a5" doxytag="ldrapi.c::LdrDisableThreadCalloutsForDll" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS LdrDisableThreadCalloutsForDll           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DllHandle</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00474">474</a> of file <a class="el" href="../../d5/d1/ldrapi_8c-source.html">ldrapi.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l01196">LdrpCheckForLoadedDllHandle()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00035">LdrpInLdrInit</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00031">LdrpShutdownInProgress</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00142">LoaderLock</a>, and <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>.
<p>
Referenced by <a class="el" href="../../d2/d9/csrinit_8c-source.html#l00106">CsrClientConnectToServer()</a>.
<p>
<pre class="fragment"><div>00480                    :
00481 
00482     This function disables thread attach and detach notification
00483     <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified DLL.
00484 
00485 Arguments:
00486 
00487     DllHandle - Supplies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DLL to disable.
00488 
00489 Return Value:
00490 
00491     TBD
00492 
00493 --*/
00494 
00495 {
00496     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
00497     PLDR_DATA_TABLE_ENTRY LdrDataTableEntry;
00498 
00499     st = STATUS_SUCCESS;
00500 
00501     <span class="keywordflow">try</span> {
00502 
00503         <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d2/ldrinit_8c.html#a4">LdrpInLdrInit</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ) {
00504             RtlEnterCriticalSection((PRTL_CRITICAL_SECTION)NtCurrentPeb()-&gt;LoaderLock);
00505             }
00506         <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d2/ldrinit_8c.html#a0">LdrpShutdownInProgress</a> ) {
00507             <span class="keywordflow">return</span> STATUS_SUCCESS;
00508             }
00509 
00510         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d3/ldrsnap_8c.html#a45">LdrpCheckForLoadedDllHandle</a>(DllHandle, &amp;LdrDataTableEntry)) {
00511             <span class="keywordflow">if</span> ( LdrDataTableEntry-&gt;TlsIndex ) {
00512                 st = STATUS_DLL_NOT_FOUND;
00513                 }
00514             <span class="keywordflow">else</span> {
00515                 LdrDataTableEntry-&gt;Flags |= LDRP_DONT_CALL_FOR_THREADS;
00516                 }
00517             }
00518         }
00519     finally {
00520         <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d2/ldrinit_8c.html#a4">LdrpInLdrInit</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ) {
00521             RtlLeaveCriticalSection((PRTL_CRITICAL_SECTION)NtCurrentPeb()-&gt;LoaderLock);
00522             }
00523         }
00524     <span class="keywordflow">return</span> st;
00525 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="ldrapi.c::LdrGetDllHandle" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS LdrGetDllHandle           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PWSTR DllPath&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PULONG DllCharacteristics&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>DllName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>DllHandle</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00295">295</a> of file <a class="el" href="../../d5/d1/ldrapi_8c-source.html">ldrapi.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00026">DLLEXTENSION</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l00832">LdrpCheckForLoadedDll()</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00384">LdrpGetModuleHandleCache</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00035">LdrpInLdrInit</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00142">LoaderLock</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01608">RtlEqualUnicodeString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00367">ShowSnaps</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d2/d9/csrinit_8c-source.html#l00106">CsrClientConnectToServer()</a>.
<p>
<pre class="fragment"><div>00304                    :
00305 
00306     This function locates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified DLL and returns its handle.
00307 
00308 Arguments:
00309 
00310     DllPath - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> search <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> to be used to locate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DLL.
00311 
00312     DllCharacteristics - Supplies an optional DLL characteristics flag,
00313         that <span class="keywordflow">if</span> specified <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to match against <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dll being loaded.
00314 
00315     DllName - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DLL to load.
00316 
00317     DllHandle - Returns a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> loaded DLL.
00318 
00319 Return Value:
00320 
00321     TBD
00322 
00323 --*/
00324 
00325 {
00326     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
00327     PPEB Peb;
00328     PTEB Teb;
00329     PLDR_DATA_TABLE_ENTRY LdrDataTableEntry;
00330     PWSTR ActualDllName;
00331     PWCH p, pp;
00332     UNICODE_STRING ActualDllNameStr;
00333     BOOLEAN Wx86KnownDll = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00334     WCHAR FreeBuffer[266];
00335 
00336 
00337     DllCharacteristics;
00338 
00339     Peb = NtCurrentPeb();
00340     Teb = NtCurrentTeb();
00341 
00342     st = STATUS_DLL_NOT_FOUND;
00343 
00344     <span class="keywordflow">try</span> {
00345 
00346           <span class="comment">//</span>
00347           <span class="comment">// Grab Peb lock</span>
00348           <span class="comment">//</span>
00349 
00350           <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d2/ldrinit_8c.html#a4">LdrpInLdrInit</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ) {
00351             RtlEnterCriticalSection((PRTL_CRITICAL_SECTION)NtCurrentPeb()-&gt;LoaderLock);
00352             }
00353 
00354 <span class="preprocessor">#if defined (WX86)</span>
00355 <span class="preprocessor"></span>
00356 
00357           <span class="keywordflow">if</span> (Teb-&gt;Wx86Thread.UseKnownWx86Dll) {
00358               Wx86KnownDll = Teb-&gt;Wx86Thread.UseKnownWx86Dll;
00359               Teb-&gt;Wx86Thread.UseKnownWx86Dll = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00360               }
00361 
00362            <span class="comment">//</span>
00363            <span class="comment">//  No module handle cache lookup for Wx86,</span>
00364            <span class="comment">//  (relies on unique basename)</span>
00365            <span class="comment">//</span>
00366            <span class="keywordflow">if</span> (Wx86ProcessInit) {
00367                <a class="code" href="../../d9/d2/ldrp_8h.html#a43">LdrpGetModuleHandleCache</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00368                }
00369 
00370 <span class="preprocessor">#endif</span>
00371 <span class="preprocessor"></span>
00372 
00373           <span class="keywordflow">if</span> ( <a class="code" href="../../d9/d2/ldrp_8h.html#a43">LdrpGetModuleHandleCache</a> ) {
00374               <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>(DllName,
00375                           &amp;<a class="code" href="../../d9/d2/ldrp_8h.html#a43">LdrpGetModuleHandleCache</a>-&gt;BaseDllName,
00376                           TRUE
00377                           )) {
00378                   *DllHandle = (PVOID)<a class="code" href="../../d9/d2/ldrp_8h.html#a43">LdrpGetModuleHandleCache</a>-&gt;DllBase;
00379                   st = STATUS_SUCCESS;
00380                   leave;
00381                   }
00382               }
00383 
00384 
00385 
00386           p = DllName-&gt;Buffer;
00387           pp = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00388           <span class="keywordflow">while</span> (*p) {
00389              <span class="keywordflow">if</span> (*p++ == (WCHAR)<span class="charliteral">'.'</span>) {
00390                  <span class="comment">//</span>
00391                  <span class="comment">// pp will point to first character after last '.'</span>
00392                  <span class="comment">//</span>
00393                  pp = p;
00394              }
00395           }
00396 
00397           ActualDllName = FreeBuffer;
00398           <span class="keywordflow">if</span> ( DllName-&gt;Length &gt;= <span class="keyword">sizeof</span>(FreeBuffer)) {
00399               <span class="keywordflow">return</span> STATUS_NAME_TOO_LONG;
00400               }
00401           RtlMoveMemory(ActualDllName, DllName-&gt;Buffer, DllName-&gt;Length);
00402 
00403           <span class="keywordflow">if</span> (!pp || *pp == (WCHAR)<span class="charliteral">'\\'</span>) {
00404               <span class="comment">//</span>
00405               <span class="comment">// No extension found (just ..\)</span>
00406               <span class="comment">//</span>
00407               <span class="keywordflow">if</span> ( DllName-&gt;Length+10 &gt;= <span class="keyword">sizeof</span>(FreeBuffer) ) {
00408                   <span class="keywordflow">return</span> STATUS_NAME_TOO_LONG;
00409                   }
00410 
00411               RtlMoveMemory((PCHAR)ActualDllName+DllName-&gt;Length, DLLEXTENSION, 10);
00412               }
00413 
00414           <span class="keywordflow">else</span> {
00415 
00416               <span class="comment">//</span>
00417               <span class="comment">// see if the name ends in . If it does, trim out the trailing</span>
00418               <span class="comment">// .</span>
00419               <span class="comment">//</span>
00420 
00421               <span class="keywordflow">if</span> ( ActualDllName[ (DllName-&gt;Length-2) &gt;&gt; 1] == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'.'</span> ) {
00422                  DllName-&gt;Length -= 2;
00423                  }
00424 
00425               ActualDllName[DllName-&gt;Length &gt;&gt; 1] = UNICODE_NULL;
00426               }
00427 
00428 
00429 
00430           <span class="comment">//</span>
00431           <span class="comment">// Check the LdrTable to see if Dll has already been loaded</span>
00432           <span class="comment">// into this image.</span>
00433           <span class="comment">//</span>
00434 
00435           <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;ActualDllNameStr,ActualDllName);
00436           ActualDllNameStr.MaximumLength = <span class="keyword">sizeof</span>(FreeBuffer);
00437 
00438           <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
00439               <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: LdrGetDllHandle, searching for %ws from %ws\n"</span>,
00440                        ActualDllName,
00441                        ARGUMENT_PRESENT(DllPath) ? (DllPath == (PWSTR)1 ? L<span class="stringliteral">""</span> : DllPath) : L<span class="stringliteral">""</span>
00442                        );
00443           }
00444 
00445 
00446           <span class="comment">//</span>
00447           <span class="comment">// sort of a hack, but done to speed up GetModuleHandle. kernel32</span>
00448           <span class="comment">// now does a two pass call here to avoid computing</span>
00449           <span class="comment">// process dll path</span>
00450           <span class="comment">//</span>
00451 
00452 
00453           <span class="keywordflow">if</span> (<a class="code" href="../../d2/d3/ldrsnap_8c.html#a44">LdrpCheckForLoadedDll</a>( DllPath,
00454                                      &amp;ActualDllNameStr,
00455                                      (BOOLEAN)(DllPath == (PWSTR)1 ? TRUE : FALSE),
00456                                      Wx86KnownDll,
00457                                      &amp;LdrDataTableEntry
00458                                    )
00459              ) {
00460               *DllHandle = (PVOID)LdrDataTableEntry-&gt;DllBase;
00461               <a class="code" href="../../d9/d2/ldrp_8h.html#a43">LdrpGetModuleHandleCache</a> = LdrDataTableEntry;
00462               st = STATUS_SUCCESS;
00463 
00464           }
00465         } finally {
00466                     <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d2/ldrinit_8c.html#a4">LdrpInLdrInit</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ) {
00467                         RtlLeaveCriticalSection((PRTL_CRITICAL_SECTION)NtCurrentPeb()-&gt;LoaderLock);
00468                         }
00469                   }
00470     <span class="keywordflow">return</span> st;
00471 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="ldrapi.c::LdrGetProcedureAddress" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS LdrGetProcedureAddress           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>DllHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PANSI_STRING ProcedureName&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG ProcedureNumber&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcedureAddress</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00838">838</a> of file <a class="el" href="../../d5/d1/ldrapi_8c-source.html">ldrapi.c</a>.
<p>
References <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00851">LdrpGetProcedureAddress()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d2/d9/csrinit_8c-source.html#l00106">CsrClientConnectToServer()</a>, and <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00616">LdrpInitializeProcess()</a>.
<p>
<pre class="fragment"><div>00844 {
00845 
00846     <span class="keywordflow">return</span> <a class="code" href="../../d9/d2/ldrp_8h.html#a83">LdrpGetProcedureAddress</a>(DllHandle,ProcedureName,ProcedureNumber,ProcedureAddress,TRUE);
00847 
00848 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="ldrapi.c::LdrLoadDll" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS LdrLoadDll           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PWSTR DllPath&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PULONG DllCharacteristics&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>DllName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>DllHandle</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00035">35</a> of file <a class="el" href="../../d5/d1/ldrapi_8c-source.html">ldrapi.c</a>.
<p>
References <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00070">LdrpLoadDll()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00616">LdrpInitializeProcess()</a>, and <a class="el" href="../../d7/d3/client_2private_8c-source.html#l00737">SetConsolePalette()</a>.
<p>
<pre class="fragment"><div>00044                    :
00045 
00046     This function loads a DLL into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> calling process address space.
00047 
00048 Arguments:
00049 
00050     DllPath - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> search <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> to be used to locate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DLL.
00051 
00052     DllCharacteristics - Supplies an optional DLL characteristics flag,
00053         that <span class="keywordflow">if</span> specified <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to match against <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dll being loaded.
00054 
00055     DllName - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DLL to load.
00056 
00057     DllHandle - Returns a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> loaded DLL.
00058 
00059 Return Value:
00060 
00061     TBD
00062 
00063 --*/
00064 {
00065     <span class="keywordflow">return</span> <a class="code" href="../../d9/d2/ldrp_8h.html#a82">LdrpLoadDll</a>(DllPath,DllCharacteristics,DllName,DllHandle,TRUE);
00066 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="ldrapi.c::LdrpClearLoadInProgress" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG LdrpClearLoadInProgress           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l00622">622</a> of file <a class="el" href="../../d3/d2/ldrsnap_8c-source.html">ldrsnap.c</a>.
<p>
Referenced by <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00070">LdrpLoadDll()</a>, and <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l00652">LdrpRunInitializeRoutines()</a>.
<p>
<pre class="fragment"><div>00625 {
00626     PLIST_ENTRY Head, Next;
00627     PLDR_DATA_TABLE_ENTRY LdrDataTableEntry;
00628     ULONG i;
00629 
00630     Head = &amp;NtCurrentPeb()-&gt;Ldr-&gt;InInitializationOrderModuleList;
00631     Next = Head-&gt;Flink;
00632     i = 0;
00633     <span class="keywordflow">while</span> ( Next != Head ) {
00634         LdrDataTableEntry = CONTAINING_RECORD(Next, LDR_DATA_TABLE_ENTRY, InInitializationOrderLinks);
00635         LdrDataTableEntry-&gt;Flags &amp;= ~LDRP_LOAD_IN_PROGRESS;
00636 
00637         <span class="comment">//</span>
00638         <span class="comment">// return the number of entries that have not been processed, but</span>
00639         <span class="comment">// have init routines</span>
00640         <span class="comment">//</span>
00641 
00642         <span class="keywordflow">if</span> ( !(LdrDataTableEntry-&gt;Flags &amp; LDRP_ENTRY_PROCESSED) &amp;&amp; LdrDataTableEntry-&gt;EntryPoint) {
00643             i++;
00644             }
00645 
00646         Next = Next-&gt;Flink;
00647         }
00648     <span class="keywordflow">return</span> i;
00649 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="ldrapi.c::LdrpGetProcedureAddress" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS LdrpGetProcedureAddress           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>DllHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PANSI_STRING ProcedureName&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG ProcedureNumber&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcedureAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>RunInitRoutines</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00851">851</a> of file <a class="el" href="../../d5/d1/ldrapi_8c-source.html">ldrapi.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l01196">LdrpCheckForLoadedDllHandle()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00035">LdrpInLdrInit</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l00652">LdrpRunInitializeRoutines()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l02476">LdrpSnapThunk()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00142">LoaderLock</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00457">MAKE_TAG</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00022">RtlAllocateHeap</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00023">RtlFreeHeap</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00250">RtlImageDirectoryEntryToData()</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00029">RtlImageNtHeader()</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00367">ShowSnaps</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00465">TEMP_TAG</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00838">LdrGetProcedureAddress()</a>, and <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l02476">LdrpSnapThunk()</a>.
<p>
<pre class="fragment"><div>00861                    :
00862 
00863     This function locates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00864     specified DLL and returns its address.
00865 
00866 Arguments:
00867 
00868     DllHandle - Supplies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DLL that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being
00869         looked up in.
00870 
00871     ProcedureName - Supplies that address of a string that contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00872         name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> to lookup in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DLL.  If <span class="keyword">this</span> argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00873         not specified, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ProcedureNumber <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used.
00874 
00875     ProcedureNumber - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> number to lookup.  If
00876         ProcedureName <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified, then <span class="keyword">this</span> argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> ignored.
00877         Otherwise, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> ordinal number to locate
00878         in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DLL.
00879 
00880     ProcedureAddress - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> found in
00881         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DLL.
00882 
00883 Return Value:
00884 
00885     TBD
00886 
00887 --*/
00888 
00889 {
00890     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
00891     UCHAR FunctionNameBuffer[64];
00892     PUCHAR src, dst;
00893     ULONG cb, ExportSize;
00894     PLDR_DATA_TABLE_ENTRY LdrDataTableEntry;
00895     IMAGE_THUNK_DATA Thunk;
00896     PVOID ImageBase;
00897     PIMAGE_IMPORT_BY_NAME FunctionName;
00898     PIMAGE_EXPORT_DIRECTORY ExportDirectory;
00899     PLIST_ENTRY Next;
00900 <span class="preprocessor">#if defined (WX86)</span>
00901 <span class="preprocessor"></span>    PTEB Teb;
00902     BOOLEAN Wx86KnownDll = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00903 <span class="preprocessor">#endif</span>
00904 <span class="preprocessor"></span>
00905     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
00906         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: LdrGetProcedureAddress by "</span>);
00907     }
00908 
00909 <span class="preprocessor">#if defined (WX86)</span>
00910 <span class="preprocessor"></span>    Teb = NtCurrentTeb();
00911     <span class="keywordflow">if</span> (Teb-&gt;Wx86Thread.UseKnownWx86Dll) {
00912         Wx86KnownDll = Teb-&gt;Wx86Thread.UseKnownWx86Dll;
00913         Teb-&gt;Wx86Thread.UseKnownWx86Dll = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00914         }
00915 <span class="preprocessor">#endif</span>
00916 <span class="preprocessor"></span>    
00917     FunctionName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00918     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(ProcedureName) ) {
00919 
00920         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
00921             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"NAME - %s\n"</span>, ProcedureName-&gt;Buffer);
00922         }
00923 
00924         <span class="comment">//</span>
00925         <span class="comment">// BUGBUG need STRING to PSZ</span>
00926         <span class="comment">//</span>
00927 
00928 
00929         <span class="keywordflow">if</span> (ProcedureName-&gt;Length &gt;= <span class="keyword">sizeof</span>( FunctionNameBuffer )-1 ) {
00930             FunctionName = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(RtlProcessHeap(), <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( TEMP_TAG ),ProcedureName-&gt;Length+1+<span class="keyword">sizeof</span>(USHORT));
00931             <span class="keywordflow">if</span> ( !FunctionName ) {
00932                 <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00933                 }
00934         } <span class="keywordflow">else</span> {
00935             FunctionName = (PIMAGE_IMPORT_BY_NAME) FunctionNameBuffer;
00936         }
00937 
00938         FunctionName-&gt;Hint = 0;
00939 
00940         cb = ProcedureName-&gt;Length;
00941         src = ProcedureName-&gt;Buffer;
00942         dst = FunctionName-&gt;Name;
00943 
00944         <span class="keywordflow">while</span> (cb--) {
00945             *dst++ = *src++;
00946         }
00947         *dst = <span class="charliteral">'\0'</span>;
00948 
00949         <span class="comment">//</span>
00950         <span class="comment">// Make sure we don't pass in address with high bit set so we</span>
00951         <span class="comment">// can still use it as ordinal flag</span>
00952         <span class="comment">//</span>
00953 
00954         ImageBase = FunctionName;
00955         Thunk.u1.AddressOfData = 0;
00956 
00957     } <span class="keywordflow">else</span> {
00958             ImageBase = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00959              <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
00960                  <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"ORDINAL - %lx\n"</span>, ProcedureNumber);
00961              }
00962 
00963              <span class="keywordflow">if</span> (ProcedureNumber) {
00964                  Thunk.u1.Ordinal = ProcedureNumber | IMAGE_ORDINAL_FLAG;
00965              } <span class="keywordflow">else</span> {
00966                       <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00967                     }
00968           }
00969 
00970     <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d2/ldrinit_8c.html#a4">LdrpInLdrInit</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ) {
00971         RtlEnterCriticalSection((PRTL_CRITICAL_SECTION)NtCurrentPeb()-&gt;LoaderLock);
00972         }
00973     <span class="keywordflow">try</span> {
00974 
00975         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d3/ldrsnap_8c.html#a45">LdrpCheckForLoadedDllHandle</a>(DllHandle, &amp;LdrDataTableEntry)) {
00976             st = STATUS_DLL_NOT_FOUND;
00977             <span class="keywordflow">return</span> st;
00978         }
00979 
00980         ExportDirectory = (PIMAGE_EXPORT_DIRECTORY)<a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a>(
00981                            LdrDataTableEntry-&gt;DllBase,
00982                            TRUE,
00983                            IMAGE_DIRECTORY_ENTRY_EXPORT,
00984                            &amp;ExportSize
00985                            );
00986 
00987         <span class="keywordflow">if</span> (!ExportDirectory) {
00988             <span class="keywordflow">return</span> STATUS_PROCEDURE_NOT_FOUND;
00989         }
00990 
00991         st = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a49">LdrpSnapThunk</a>(LdrDataTableEntry-&gt;DllBase,
00992                            ImageBase,
00993                            &amp;Thunk,
00994                            &amp;Thunk,
00995                            ExportDirectory,
00996                            ExportSize,
00997                            FALSE,
00998                            NULL
00999                           );
01000 
01001         <span class="keywordflow">if</span> ( RunInitRoutines ) {
01002             PLDR_DATA_TABLE_ENTRY LdrInitEntry;
01003 
01004             <span class="comment">//</span>
01005             <span class="comment">// Look at last entry in init order list. If entry processed</span>
01006             <span class="comment">// flag is not set, then a forwarded dll was loaded during the</span>
01007             <span class="comment">// getprocaddr call and we need to run init routines</span>
01008             <span class="comment">//</span>
01009 
01010             Next = NtCurrentPeb()-&gt;Ldr-&gt;InInitializationOrderModuleList.Blink;
01011             LdrInitEntry = CONTAINING_RECORD(Next, LDR_DATA_TABLE_ENTRY, InInitializationOrderLinks);
01012             <span class="keywordflow">if</span> ( !(LdrInitEntry-&gt;Flags &amp; LDRP_ENTRY_PROCESSED) ) {
01013                 <span class="keywordflow">try</span> {
01014                     st = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a43">LdrpRunInitializeRoutines</a>(NULL);
01015                     }
01016                 except( EXCEPTION_EXECUTE_HANDLER ) {
01017                     st = GetExceptionCode();
01018                     }
01019 
01020                 }
01021             }
01022 
01023         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
01024             *ProcedureAddress = (PVOID)Thunk.u1.Function;
01025 <span class="preprocessor">#if defined (WX86)</span>
01026 <span class="preprocessor"></span>            <span class="comment">// For dlls loaded as a Wx86 plugin ...</span>
01027 
01028             <span class="keywordflow">if</span> (Wx86ProcessInit &amp;&amp; (LdrDataTableEntry-&gt;Flags &amp; LDRP_WX86_PLUGIN)) {
01029                 PVOID ExportThunk = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01030                 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> MachineType = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(LdrDataTableEntry-&gt;DllBase)-&gt;FileHeader.Machine;
01031 
01032                 <span class="comment">// and the GetProcAddress call is cross-architecture ...</span>
01033 
01034                 <span class="keywordflow">if</span> ((!Wx86KnownDll &amp;&amp; (MachineType == IMAGE_FILE_MACHINE_I386))
01035                   || (Wx86KnownDll &amp;&amp; (MachineType != IMAGE_FILE_MACHINE_I386))) {
01036     
01037                     <span class="comment">// Thunk the export</span>
01038 
01039                     st = Wx86ThunkPluginExport(LdrDataTableEntry-&gt;DllBase,
01040                                                FunctionName? FunctionName-&gt;Name : NULL,
01041                                                ProcedureNumber,
01042                                                (PVOID)(Thunk.u1.Function),
01043                                                &amp;ExportThunk
01044                                                );
01045                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) &amp;&amp; ExportThunk) {
01046                         *ProcedureAddress = ExportThunk;
01047                     } <span class="keywordflow">else</span> {
01048                         <span class="comment">// Don't let unthunked cross-architecture addresses get out</span>
01049                         *ProcedureAddress = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01050                         st = STATUS_INVALID_IMAGE_FORMAT;
01051                         }
01052                     }
01053                 }
01054 <span class="preprocessor">#endif</span>
01055 <span class="preprocessor"></span>            }
01056     } finally {
01057         <span class="keywordflow">if</span> ( FunctionName &amp;&amp; (FunctionName != (PIMAGE_IMPORT_BY_NAME) FunctionNameBuffer) ) {
01058             <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(RtlProcessHeap(),0,FunctionName);
01059             }
01060         <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d2/ldrinit_8c.html#a4">LdrpInLdrInit</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ) {
01061             RtlLeaveCriticalSection((PRTL_CRITICAL_SECTION)NtCurrentPeb()-&gt;LoaderLock);
01062             }
01063     }
01064     <span class="keywordflow">return</span> st;
01065 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="ldrapi.c::LdrpLoadDll" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NTAPI LdrpLoadDll           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PWSTR DllPath&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PULONG DllCharacteristics&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>DllName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>DllHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>RunInitRoutines</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00070">70</a> of file <a class="el" href="../../d5/d1/ldrapi_8c-source.html">ldrapi.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00026">DLLEXTENSION</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l00832">LdrpCheckForLoadedDll()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l00622">LdrpClearLoadInProgress()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00035">LdrpInLdrInit</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00034">LdrpLdrDatabaseIsSetup</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l01261">LdrpMapDll()</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00253">LdrpReferenceLoadedDll</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l00652">LdrpRunInitializeRoutines()</a>, <a class="el" href="../../d2/d3/ldrsnap_8c.html#a39">LdrpWalkImportDescriptor()</a>, <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00528">LdrUnloadDll()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00142">LoaderLock</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, and <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00367">ShowSnaps</a>.
<p>
Referenced by <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00035">LdrLoadDll()</a>, and <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l02476">LdrpSnapThunk()</a>.
<p>
<pre class="fragment"><div>00078 {
00079     PPEB Peb;
00080     PTEB Teb;
00081     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
00082     PLDR_DATA_TABLE_ENTRY LdrDataTableEntry;
00083     PWSTR ActualDllName;
00084     PWCH p, pp;
00085     UNICODE_STRING ActualDllNameStr;
00086     BOOLEAN Wx86KnownDll = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00087     WCHAR FreeBuffer[266];
00088 
00089     Peb = NtCurrentPeb();
00090     Teb = NtCurrentTeb();
00091 
00092     st = STATUS_SUCCESS;
00093 
00094     <span class="keywordflow">try</span> {
00095 
00096         <span class="comment">//</span>
00097         <span class="comment">// Grab Peb lock and Snap All Links to specified DLL</span>
00098         <span class="comment">//</span>
00099 
00100         <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d2/ldrinit_8c.html#a4">LdrpInLdrInit</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ) {
00101             RtlEnterCriticalSection((PRTL_CRITICAL_SECTION)NtCurrentPeb()-&gt;LoaderLock);
00102             }
00103 
00104 
00105 
00106 <span class="preprocessor">#if defined (WX86)</span>
00107 <span class="preprocessor"></span>
00108         <span class="keywordflow">if</span> (Teb-&gt;Wx86Thread.UseKnownWx86Dll) {
00109             Wx86KnownDll = Teb-&gt;Wx86Thread.UseKnownWx86Dll;
00110             Teb-&gt;Wx86Thread.UseKnownWx86Dll = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00111             }
00112 <span class="preprocessor">#endif</span>
00113 <span class="preprocessor"></span>
00114 
00115 
00116         p = DllName-&gt;Buffer;
00117         pp = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00118         <span class="keywordflow">while</span> (*p) {
00119             <span class="keywordflow">if</span> (*p++ == (WCHAR)<span class="charliteral">'.'</span>) {
00120                 <span class="comment">//</span>
00121                 <span class="comment">// pp will point to first character after last '.'</span>
00122                 <span class="comment">//</span>
00123                 pp = p;
00124                 }
00125             }
00126 
00127 
00128         ActualDllName = FreeBuffer;
00129         <span class="keywordflow">if</span> ( DllName-&gt;Length &gt;= <span class="keyword">sizeof</span>(FreeBuffer)) {
00130             <span class="keywordflow">return</span> STATUS_NAME_TOO_LONG;
00131             }
00132         RtlMoveMemory(ActualDllName, DllName-&gt;Buffer, DllName-&gt;Length);
00133 
00134 
00135         <span class="keywordflow">if</span> (!pp || *pp == (WCHAR)<span class="charliteral">'\\'</span>) {
00136             <span class="comment">//</span>
00137             <span class="comment">// No extension found (just ..\)</span>
00138             <span class="comment">//</span>
00139             <span class="keywordflow">if</span> ( DllName-&gt;Length+10 &gt;= <span class="keyword">sizeof</span>(FreeBuffer) ) {
00140                 <span class="keywordflow">return</span> STATUS_NAME_TOO_LONG;
00141                 }
00142 
00143             RtlMoveMemory((PCHAR)ActualDllName+DllName-&gt;Length, DLLEXTENSION, 10);
00144             }
00145         <span class="keywordflow">else</span> {
00146             ActualDllName[DllName-&gt;Length &gt;&gt; 1] = UNICODE_NULL;
00147             }
00148 
00149         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
00150             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: LdrLoadDll, loading %ws from %ws\n"</span>,
00151                      ActualDllName,
00152                      ARGUMENT_PRESENT(DllPath) ? DllPath : L<span class="stringliteral">""</span>
00153                      );
00154             }
00155 
00156 
00157         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;ActualDllNameStr,ActualDllName);
00158         ActualDllNameStr.MaximumLength = <span class="keyword">sizeof</span>(FreeBuffer);
00159 
00160         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d3/ldrsnap_8c.html#a44">LdrpCheckForLoadedDll</a>( DllPath,
00161                                     &amp;ActualDllNameStr,
00162                                     FALSE,
00163                                     Wx86KnownDll,
00164                                     &amp;LdrDataTableEntry
00165                                   )
00166            ) {
00167             st = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a46">LdrpMapDll</a>(DllPath,
00168                             ActualDllName,
00169                             DllCharacteristics,
00170                             FALSE,
00171                             Wx86KnownDll,
00172                             &amp;LdrDataTableEntry
00173                             );
00174 
00175             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
00176                 <span class="keywordflow">return</span> st;
00177                 }
00178 
00179             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( DllCharacteristics ) &amp;&amp;
00180                 *DllCharacteristics &amp; IMAGE_FILE_EXECUTABLE_IMAGE
00181                ) {
00182                 LdrDataTableEntry-&gt;EntryPoint = 0;
00183                 LdrDataTableEntry-&gt;Flags &amp;= ~LDRP_IMAGE_DLL;
00184                 }
00185 
00186             <span class="comment">//</span>
00187             <span class="comment">// and walk the import descriptor.</span>
00188             <span class="comment">//</span>
00189 
00190             <span class="keywordflow">if</span> (LdrDataTableEntry-&gt;Flags &amp; LDRP_IMAGE_DLL) {
00191 
00192                 <span class="keywordflow">try</span> {
00193                     st = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a39">LdrpWalkImportDescriptor</a>(
00194                               DllPath,
00195                               LdrDataTableEntry
00196                               );
00197                     }
00198                 except(EXCEPTION_EXECUTE_HANDLER) {
00199                     st = GetExceptionCode();
00200                     }
00201                 <span class="keywordflow">if</span> ( LdrDataTableEntry-&gt;LoadCount != 0xffff ) {
00202                     LdrDataTableEntry-&gt;LoadCount++;
00203                     }
00204                 <a class="code" href="../../d9/d2/ldrp_8h.html#a9">LdrpReferenceLoadedDll</a>(LdrDataTableEntry);
00205                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
00206                     LdrDataTableEntry-&gt;EntryPoint = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00207                     InsertTailList(&amp;NtCurrentPeb()-&gt;Ldr-&gt;InInitializationOrderModuleList,
00208                            &amp;LdrDataTableEntry-&gt;InInitializationOrderLinks);
00209                     <a class="code" href="../../d2/d3/ldrsnap_8c.html#a42">LdrpClearLoadInProgress</a>();
00210                     <a class="code" href="../../d4/d2/ldrapi_8c.html#a6">LdrUnloadDll</a>((PVOID)LdrDataTableEntry-&gt;DllBase);
00211                     <span class="keywordflow">return</span> st;
00212                     }
00213                 }
00214             <span class="keywordflow">else</span> {
00215                 <span class="keywordflow">if</span> ( LdrDataTableEntry-&gt;LoadCount != 0xffff ) {
00216                     LdrDataTableEntry-&gt;LoadCount++;
00217                     }
00218                 }
00219 
00220             <span class="comment">//</span>
00221             <span class="comment">// Add init routine to list</span>
00222             <span class="comment">//</span>
00223 
00224             InsertTailList(&amp;NtCurrentPeb()-&gt;Ldr-&gt;InInitializationOrderModuleList,
00225                            &amp;LdrDataTableEntry-&gt;InInitializationOrderLinks);
00226 
00227 
00228             <span class="comment">//</span>
00229             <span class="comment">// If the loader data base is not fully setup, this load was because</span>
00230             <span class="comment">// of a forwarder in the static load set. Can't run init routines</span>
00231             <span class="comment">// yet because the load counts are NOT set</span>
00232             <span class="comment">//</span>
00233 
00234             <span class="keywordflow">if</span> ( RunInitRoutines &amp;&amp; <a class="code" href="../../d8/d2/ldrinit_8c.html#a3">LdrpLdrDatabaseIsSetup</a> ) {
00235 
00236                 <span class="keywordflow">try</span> {
00237                     st = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a43">LdrpRunInitializeRoutines</a>(NULL);
00238                     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
00239                         <a class="code" href="../../d4/d2/ldrapi_8c.html#a6">LdrUnloadDll</a>((PVOID)LdrDataTableEntry-&gt;DllBase);
00240                         }
00241                     }
00242                 except( EXCEPTION_EXECUTE_HANDLER ) {
00243                     <a class="code" href="../../d4/d2/ldrapi_8c.html#a6">LdrUnloadDll</a>((PVOID)LdrDataTableEntry-&gt;DllBase);
00244                     <span class="keywordflow">return</span> GetExceptionCode();
00245                     }
00246                 }
00247             <span class="keywordflow">else</span> {
00248                 st = STATUS_SUCCESS;
00249                 }
00250 
00251             }
00252         <span class="keywordflow">else</span> {
00253 
00254             <span class="comment">//</span>
00255             <span class="comment">// Count it. And everything that it imports.</span>
00256             <span class="comment">//</span>
00257 
00258             <span class="keywordflow">if</span> ( LdrDataTableEntry-&gt;Flags &amp; LDRP_IMAGE_DLL &amp;&amp;
00259                  LdrDataTableEntry-&gt;LoadCount != 0xffff  ) {
00260 
00261                 LdrDataTableEntry-&gt;LoadCount++;
00262 
00263                 <a class="code" href="../../d9/d2/ldrp_8h.html#a9">LdrpReferenceLoadedDll</a>(LdrDataTableEntry);
00264 
00265                 <span class="comment">//</span>
00266                 <span class="comment">// Now clear the Load in progress bits</span>
00267                 <span class="comment">//</span>
00268 
00269                 <a class="code" href="../../d2/d3/ldrsnap_8c.html#a42">LdrpClearLoadInProgress</a>();
00270 
00271                 }
00272             <span class="keywordflow">else</span> {
00273                 <span class="keywordflow">if</span> ( LdrDataTableEntry-&gt;LoadCount != 0xffff ) {
00274                     LdrDataTableEntry-&gt;LoadCount++;
00275                     }
00276                 }
00277             }
00278         }
00279     finally {
00280         <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d2/ldrinit_8c.html#a4">LdrpInLdrInit</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ) {
00281             RtlLeaveCriticalSection((PRTL_CRITICAL_SECTION)NtCurrentPeb()-&gt;LoaderLock);
00282             }
00283 
00284         }
00285     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
00286         *DllHandle = (PVOID)LdrDataTableEntry-&gt;DllBase;
00287         }
00288     <span class="keywordflow">else</span> {
00289         *DllHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00290         }
00291     <span class="keywordflow">return</span> st;
00292 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="ldrapi.c::LdrQueryProcessModuleInformation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS LdrQueryProcessModuleInformation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PRTL_PROCESS_MODULES&nbsp;</td>
          <td class="mdname" nowrap> <em>ModuleInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ModuleInformationLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG ReturnLength&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l01210">1210</a> of file <a class="el" href="../../d5/d1/ldrapi_8c-source.html">ldrapi.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00035">LdrpInLdrInit</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00142">LoaderLock</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00246">RtlUnicodeStringToAnsiString()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/dll_2query_8c-source.html#l00630">RtlQueryProcessModuleInformation()</a>.
<p>
<pre class="fragment"><div>01215 {
01216     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01217     PPEB Peb;
01218     PLIST_ENTRY LoadOrderListHead;
01219     PLIST_ENTRY InitOrderListHead;
01220     ULONG RequiredLength;
01221     PLIST_ENTRY Next;
01222     PLIST_ENTRY Next1;
01223     PRTL_PROCESS_MODULE_INFORMATION ModuleInfo;
01224     PLDR_DATA_TABLE_ENTRY LdrDataTableEntry;
01225     PLDR_DATA_TABLE_ENTRY LdrDataTableEntry1;
01226     ANSI_STRING AnsiString;
01227     PUCHAR s;
01228 
01229     Peb = NtCurrentPeb();
01230 
01231     <span class="comment">//</span>
01232     <span class="comment">// Grab Peb lock and capture information about of DLLs loaded in current process.</span>
01233     <span class="comment">//</span>
01234 
01235     <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d2/ldrinit_8c.html#a4">LdrpInLdrInit</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ) {
01236         RtlEnterCriticalSection((PRTL_CRITICAL_SECTION)NtCurrentPeb()-&gt;LoaderLock);
01237         }
01238 
01239     <span class="keywordflow">try</span> {
01240         RequiredLength = FIELD_OFFSET( RTL_PROCESS_MODULES, Modules );
01241         <span class="keywordflow">if</span> (ModuleInformationLength &lt; RequiredLength) {
01242             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INFO_LENGTH_MISMATCH;
01243             ModuleInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01244             }
01245         <span class="keywordflow">else</span> {
01246             ModuleInformation-&gt;NumberOfModules = 0;
01247             ModuleInfo = &amp;ModuleInformation-&gt;Modules[ 0 ];
01248             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01249             }
01250 
01251         LoadOrderListHead = &amp;Peb-&gt;Ldr-&gt;InLoadOrderModuleList;
01252         InitOrderListHead = &amp;Peb-&gt;Ldr-&gt;InInitializationOrderModuleList;
01253         Next = LoadOrderListHead-&gt;Flink;
01254         <span class="keywordflow">while</span> ( Next != LoadOrderListHead ) {
01255             LdrDataTableEntry = CONTAINING_RECORD( Next,
01256                                                    LDR_DATA_TABLE_ENTRY,
01257                                                    InLoadOrderLinks
01258                                                  );
01259 
01260             RequiredLength += <span class="keyword">sizeof</span>( RTL_PROCESS_MODULE_INFORMATION );
01261             <span class="keywordflow">if</span> (ModuleInformationLength &lt; RequiredLength) {
01262                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INFO_LENGTH_MISMATCH;
01263                 }
01264             <span class="keywordflow">else</span> {
01265                 ModuleInfo-&gt;MappedBase = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01266                 ModuleInfo-&gt;ImageBase = LdrDataTableEntry-&gt;DllBase;
01267                 ModuleInfo-&gt;ImageSize = LdrDataTableEntry-&gt;SizeOfImage;
01268                 ModuleInfo-&gt;Flags = LdrDataTableEntry-&gt;Flags;
01269                 ModuleInfo-&gt;LoadCount = LdrDataTableEntry-&gt;LoadCount;
01270 
01271                 ModuleInfo-&gt;LoadOrderIndex = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(ModuleInformation-&gt;NumberOfModules);
01272 
01273                 ModuleInfo-&gt;InitOrderIndex = 0;
01274                 Next1 = InitOrderListHead-&gt;Flink;
01275                 <span class="keywordflow">while</span> ( Next1 != InitOrderListHead ) {
01276                     LdrDataTableEntry1 = CONTAINING_RECORD( Next1,
01277                                                             LDR_DATA_TABLE_ENTRY,
01278                                                             InInitializationOrderLinks
01279                                                           );
01280 
01281                     ModuleInfo-&gt;InitOrderIndex++;
01282                     <span class="keywordflow">if</span> (LdrDataTableEntry1 == LdrDataTableEntry) {
01283                         <span class="keywordflow">break</span>;
01284                         }
01285 
01286                     Next1 = Next1-&gt;Flink;
01287                     }
01288 
01289                 AnsiString.Buffer = ModuleInfo-&gt;FullPathName;
01290                 AnsiString.Length = 0;
01291                 AnsiString.MaximumLength = <span class="keyword">sizeof</span>( ModuleInfo-&gt;FullPathName );
01292                 <a class="code" href="../../d6/d6/nls_8c.html#a23">RtlUnicodeStringToAnsiString</a>( &amp;AnsiString,
01293                                               &amp;LdrDataTableEntry-&gt;FullDllName,
01294                                               FALSE
01295                                             );
01296                 s = AnsiString.Buffer + AnsiString.Length;
01297                 <span class="keywordflow">while</span> (s &gt; AnsiString.Buffer &amp;&amp; *--s) {
01298                     <span class="keywordflow">if</span> (*s == (UCHAR)OBJ_NAME_PATH_SEPARATOR) {
01299                         s++;
01300                         <span class="keywordflow">break</span>;
01301                         }
01302                     }
01303                 ModuleInfo-&gt;OffsetToFileName = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(s - AnsiString.Buffer);
01304 
01305                 ModuleInfo++;
01306                 }
01307 
01308             <span class="keywordflow">if</span> (ModuleInformation != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01309                 ModuleInformation-&gt;NumberOfModules++;
01310                 }
01311 
01312             Next = Next-&gt;Flink;
01313             }
01314 
01315         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ReturnLength )) {
01316             *ReturnLength = RequiredLength;
01317             }
01318         }
01319     finally {
01320         <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d2/ldrinit_8c.html#a4">LdrpInLdrInit</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ) {
01321             RtlLeaveCriticalSection((PRTL_CRITICAL_SECTION)NtCurrentPeb()-&gt;LoaderLock);
01322             }
01323         }
01324 
01325     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01326 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="ldrapi.c::LdrUnloadDll" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS LdrUnloadDll           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DllHandle</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00528">528</a> of file <a class="el" href="../../d5/d1/ldrapi_8c-source.html">ldrapi.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00383">LdrpActiveUnloadCount</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00484">LdrpCallInitRoutine</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l01196">LdrpCheckForLoadedDllHandle()</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00254">LdrpDereferenceLoadedDll</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00384">LdrpGetModuleHandleCache</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00035">LdrpInLdrInit</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00385">LdrpLoadedDllHandleCache</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00031">LdrpShutdownInProgress</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00382">LdrpUnloadHead</a>, <a class="el" href="../../d2/d2/ldrrsrc_8c-source.html#l01882">LdrUnloadAlternateResourceModule()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00142">LoaderLock</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d8/umapview_8c-source.html#l00033">NtUnmapViewOfSection()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00023">RtlFreeHeap</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01215">RtlFreeUnicodeString()</a>, and <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00367">ShowSnaps</a>.
<p>
Referenced by <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00070">LdrpLoadDll()</a>.
<p>
<pre class="fragment"><div>00534                    :
00535 
00536     This function unloads <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DLL from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified process
00537 
00538 Arguments:
00539 
00540     DllHandle - Supplies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DLL to unload.
00541 
00542 Return Value:
00543 
00544     TBD
00545 
00546 --*/
00547 
00548 {
00549     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
00550     PPEB Peb;
00551     PLDR_DATA_TABLE_ENTRY LdrDataTableEntry;
00552     PLDR_DATA_TABLE_ENTRY Entry;
00553     PDLL_INIT_ROUTINE InitRoutine;
00554     LIST_ENTRY LocalUnloadHead;
00555     PLIST_ENTRY Next;
00556 <span class="preprocessor">#if defined (WX86)</span>
00557 <span class="preprocessor"></span>    PVOID Wx86Plugin = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00558 <span class="preprocessor">#endif</span>
00559 <span class="preprocessor"></span>
00560     Peb = NtCurrentPeb();
00561     st = STATUS_SUCCESS;
00562 
00563     <span class="keywordflow">try</span> {
00564 
00565         <span class="comment">//</span>
00566         <span class="comment">// Grab Peb lock and decrement reference count of all affected DLLs</span>
00567         <span class="comment">//</span>
00568 
00569 
00570         <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d2/ldrinit_8c.html#a4">LdrpInLdrInit</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ) {
00571             RtlEnterCriticalSection((PRTL_CRITICAL_SECTION)NtCurrentPeb()-&gt;LoaderLock);
00572             }
00573 
00574         <a class="code" href="../../d9/d2/ldrp_8h.html#a42">LdrpActiveUnloadCount</a>++;
00575 
00576         <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d2/ldrinit_8c.html#a0">LdrpShutdownInProgress</a> ) {
00577             <span class="keywordflow">goto</span> leave_finally;
00578             }
00579 
00580         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d3/ldrsnap_8c.html#a45">LdrpCheckForLoadedDllHandle</a>(DllHandle, &amp;LdrDataTableEntry)) {
00581             st = STATUS_DLL_NOT_FOUND;
00582             <span class="keywordflow">goto</span> leave_finally;
00583         }
00584 
00585         <span class="comment">//</span>
00586         <span class="comment">// Now that we have the data table entry, unload it</span>
00587         <span class="comment">//</span>
00588 
00589         <span class="keywordflow">if</span> ( LdrDataTableEntry-&gt;LoadCount != 0xffff ) {
00590             LdrDataTableEntry-&gt;LoadCount--;
00591             <span class="keywordflow">if</span> ( LdrDataTableEntry-&gt;Flags &amp; LDRP_IMAGE_DLL ) {
00592                 <a class="code" href="../../d9/d2/ldrp_8h.html#a10">LdrpDereferenceLoadedDll</a>(LdrDataTableEntry);
00593                 }
00594         } <span class="keywordflow">else</span> {
00595 
00596             <span class="comment">//</span>
00597             <span class="comment">// if the load count is 0xffff, then we do not need to recurse</span>
00598             <span class="comment">// through this DLL's import table.</span>
00599             <span class="comment">//</span>
00600             <span class="comment">// Additionally, we don't have to scan more LoadCount == 0</span>
00601             <span class="comment">// modules since nothing could have happened as a result of a free on this</span>
00602             <span class="comment">// DLL.</span>
00603 
00604             <span class="keywordflow">goto</span> leave_finally;
00605         }
00606 
00607         <span class="comment">//</span>
00608         <span class="comment">// Now process init routines and then in a second pass, unload</span>
00609         <span class="comment">// DLLs</span>
00610         <span class="comment">//</span>
00611 
00612         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
00613             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: UNINIT LIST\n"</span>);
00614         }
00615 
00616         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a42">LdrpActiveUnloadCount</a> == 1 ) {
00617             InitializeListHead(&amp;LdrpUnloadHead);
00618             }
00619 
00620         <span class="comment">//</span>
00621         <span class="comment">// Go in reverse order initialization order and build</span>
00622         <span class="comment">// the unload list</span>
00623         <span class="comment">//</span>
00624 
00625         Next = Peb-&gt;Ldr-&gt;InInitializationOrderModuleList.Blink;
00626         <span class="keywordflow">while</span> ( Next != &amp;Peb-&gt;Ldr-&gt;InInitializationOrderModuleList) {
00627             LdrDataTableEntry
00628                 = (PLDR_DATA_TABLE_ENTRY)
00629                   (CONTAINING_RECORD(Next,LDR_DATA_TABLE_ENTRY,InInitializationOrderLinks));
00630 
00631             Next = Next-&gt;Blink;
00632             LdrDataTableEntry-&gt;Flags &amp;= ~LDRP_UNLOAD_IN_PROGRESS;
00633 
00634             <span class="keywordflow">if</span> (LdrDataTableEntry-&gt;LoadCount == 0) {
00635 
00636                 <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
00637                       <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"          (%d) [%ws] %ws (%lx) deinit %lx\n"</span>,
00638                               LdrpActiveUnloadCount,
00639                               LdrDataTableEntry-&gt;BaseDllName.Buffer,
00640                               LdrDataTableEntry-&gt;FullDllName.Buffer,
00641                               (ULONG)LdrDataTableEntry-&gt;LoadCount,
00642                               LdrDataTableEntry-&gt;EntryPoint
00643                               );
00644                 }
00645 
00646                 Entry = LdrDataTableEntry;
00647 
00648                 RemoveEntryList(&amp;Entry-&gt;InInitializationOrderLinks);
00649                 RemoveEntryList(&amp;Entry-&gt;InMemoryOrderLinks);
00650                 RemoveEntryList(&amp;Entry-&gt;HashLinks);
00651 
00652                 <span class="keywordflow">if</span> ( <a class="code" href="../../d9/d2/ldrp_8h.html#a42">LdrpActiveUnloadCount</a> &gt; 1 ) {
00653                     <a class="code" href="../../d9/d2/ldrp_8h.html#a44">LdrpLoadedDllHandleCache</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00654                     Entry-&gt;InMemoryOrderLinks.Flink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00655                     }
00656                 InsertTailList(&amp;LdrpUnloadHead,&amp;Entry-&gt;HashLinks);
00657             }
00658         }
00659         <span class="comment">//</span>
00660         <span class="comment">// End of new code</span>
00661         <span class="comment">//</span>
00662 
00663         <span class="comment">//</span>
00664         <span class="comment">// We only do init routine call's and module free's at the top level,</span>
00665         <span class="comment">// so if the active count is &gt; 1, just return</span>
00666         <span class="comment">//</span>
00667 
00668         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a42">LdrpActiveUnloadCount</a> &gt; 1 ) {
00669             <span class="keywordflow">goto</span> leave_finally;
00670             }
00671 
00672         <span class="comment">//</span>
00673         <span class="comment">// Now that the unload list is built, walk through the unload</span>
00674         <span class="comment">// list in order and call the init routine. The dll must remain</span>
00675         <span class="comment">// on the InLoadOrderLinks so that the pctoheader stuff will</span>
00676         <span class="comment">// still work</span>
00677         <span class="comment">//</span>
00678 
00679         InitializeListHead(&amp;LocalUnloadHead);
00680         Entry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00681         Next = <a class="code" href="../../d9/d2/ldrp_8h.html#a41">LdrpUnloadHead</a>.Flink;
00682         <span class="keywordflow">while</span> ( Next != &amp;<a class="code" href="../../d9/d2/ldrp_8h.html#a41">LdrpUnloadHead</a> ) {
00683 top:
00684             <span class="keywordflow">if</span> ( Entry ) {
00685                 RemoveEntryList(&amp;(Entry-&gt;InLoadOrderLinks));
00686                 Entry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00687                 Next = <a class="code" href="../../d9/d2/ldrp_8h.html#a41">LdrpUnloadHead</a>.Flink;
00688                 <span class="keywordflow">if</span> (Next == &amp;<a class="code" href="../../d9/d2/ldrp_8h.html#a41">LdrpUnloadHead</a> ) {
00689                     <span class="keywordflow">goto</span> bottom;
00690                     }
00691             }
00692             LdrDataTableEntry
00693                 = (PLDR_DATA_TABLE_ENTRY)
00694                   (CONTAINING_RECORD(Next,LDR_DATA_TABLE_ENTRY,HashLinks));
00695 
00696             <span class="comment">//</span>
00697             <span class="comment">// Remove dll from the global unload list and place</span>
00698             <span class="comment">// on the local unload list. This is because the global list</span>
00699             <span class="comment">// can change during the callout to the init routine</span>
00700             <span class="comment">//</span>
00701 
00702             Entry = LdrDataTableEntry;
00703             <a class="code" href="../../d9/d2/ldrp_8h.html#a44">LdrpLoadedDllHandleCache</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00704             Entry-&gt;InMemoryOrderLinks.Flink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00705 
00706             RemoveEntryList(&amp;Entry-&gt;HashLinks);
00707             InsertTailList(&amp;LocalUnloadHead,&amp;Entry-&gt;HashLinks);
00708 
00709             <span class="comment">//</span>
00710             <span class="comment">// If the function has an init routine, call it.</span>
00711             <span class="comment">//</span>
00712 
00713             InitRoutine = (PDLL_INIT_ROUTINE)LdrDataTableEntry-&gt;EntryPoint;
00714 
00715 <span class="preprocessor">#if defined (WX86)</span>
00716 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (Wx86ProcessInit) {
00717                 <span class="keywordflow">try</span> {
00718                    LdrpWx86DllProcessDetach(LdrDataTableEntry);
00719                    RemoveEntryList(&amp;Entry-&gt;InLoadOrderLinks);
00720                    Entry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00721                    Next = <a class="code" href="../../d9/d2/ldrp_8h.html#a41">LdrpUnloadHead</a>.Flink;
00722                    }
00723                 except(EXCEPTION_EXECUTE_HANDLER){
00724                     <span class="keywordflow">goto</span> top;
00725                     }
00726                 }
00727             <span class="keywordflow">else</span>
00728 <span class="preprocessor">#endif</span>
00729 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (InitRoutine &amp;&amp; (LdrDataTableEntry-&gt;Flags &amp; LDRP_PROCESS_ATTACH_CALLED) ) {
00730                 <span class="keywordflow">try</span> {
00731                     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
00732                         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: Calling deinit %lx\n"</span>,InitRoutine);
00733                         }
00734 
00735                     <a class="code" href="../../d9/d2/ldrp_8h.html#a20">LdrpCallInitRoutine</a>(InitRoutine,
00736                                         LdrDataTableEntry-&gt;DllBase,
00737                                         DLL_PROCESS_DETACH,
00738                                         NULL);
00739 
00740                     RemoveEntryList(&amp;Entry-&gt;InLoadOrderLinks);
00741                     Entry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00742                     Next = <a class="code" href="../../d9/d2/ldrp_8h.html#a41">LdrpUnloadHead</a>.Flink;
00743                     }
00744                 except(EXCEPTION_EXECUTE_HANDLER){
00745                     <span class="keywordflow">goto</span> top;
00746                     }
00747             } <span class="keywordflow">else</span> {
00748                 RemoveEntryList(&amp;(Entry-&gt;InLoadOrderLinks));
00749                 Entry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00750                 Next = <a class="code" href="../../d9/d2/ldrp_8h.html#a41">LdrpUnloadHead</a>.Flink;
00751             }
00752         }
00753 bottom:
00754 
00755 <span class="preprocessor">#if defined (WX86)</span>
00756 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (Wx86ProcessInit) {
00757 
00758             <span class="comment">//</span>
00759             <span class="comment">// Notify Wx86 that the modules are about to be unmapped.  This</span>
00760             <span class="comment">// must be done in a separate pass from the unmap loop, as wx86.dll</span>
00761             <span class="comment">// might be in the list of modules to unmap.</span>
00762             <span class="comment">//</span>
00763             Next = LocalUnloadHead.Flink;
00764             <span class="keywordflow">while</span> ( Next != &amp;LocalUnloadHead ) {
00765                 LdrDataTableEntry
00766                     = (PLDR_DATA_TABLE_ENTRY)
00767                       (CONTAINING_RECORD(Next,LDR_DATA_TABLE_ENTRY,HashLinks));
00768 
00769                 Next = Next-&gt;Flink;
00770 
00771                 LdrpWx86DllMapNotify(LdrDataTableEntry-&gt;DllBase, FALSE);
00772 
00773                 <span class="comment">// Remember if we are unloading a plugin dll</span>
00774 
00775                 <span class="keywordflow">if</span> ((LdrDataTableEntry-&gt;DllBase == DllHandle) &amp;&amp;
00776                     (LdrDataTableEntry-&gt;Flags &amp; LDRP_WX86_PLUGIN)) {
00777                         Wx86Plugin = DllHandle;
00778                 }
00779             }
00780         }
00781 <span class="preprocessor">#endif</span>
00782 <span class="preprocessor"></span>
00783         <span class="comment">//</span>
00784         <span class="comment">// Now, go through the modules and unmap them</span>
00785         <span class="comment">//</span>
00786 
00787         Next = LocalUnloadHead.Flink;
00788         <span class="keywordflow">while</span> ( Next != &amp;LocalUnloadHead ) {
00789             LdrDataTableEntry
00790                 = (PLDR_DATA_TABLE_ENTRY)
00791                   (CONTAINING_RECORD(Next,LDR_DATA_TABLE_ENTRY,HashLinks));
00792 
00793             Next = Next-&gt;Flink;
00794             Entry = LdrDataTableEntry;
00795 
00796             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
00797                   <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: Unmapping [%ws]\n"</span>,
00798                           LdrDataTableEntry-&gt;BaseDllName.Buffer
00799                           );
00800                 }
00801             st = <a class="code" href="../../d4/d9/umapview_8c.html#a0">NtUnmapViewOfSection</a>(NtCurrentProcess(),Entry-&gt;DllBase);
00802             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st));
00803 
00804             <a class="code" href="../../d1/d3/ldrrsrc_8c.html#a22">LdrUnloadAlternateResourceModule</a>(Entry-&gt;DllBase);
00805 
00806             <span class="keywordflow">if</span> (Entry-&gt;FullDllName.Buffer) {
00807                 <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;Entry-&gt;FullDllName);
00808                 }
00809             <span class="keywordflow">if</span> (Entry-&gt;BaseDllName.Buffer) {
00810                 <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;Entry-&gt;BaseDllName);
00811                 }
00812 
00813             <span class="keywordflow">if</span> ( Entry == <a class="code" href="../../d9/d2/ldrp_8h.html#a43">LdrpGetModuleHandleCache</a> ) {
00814                 <a class="code" href="../../d9/d2/ldrp_8h.html#a43">LdrpGetModuleHandleCache</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00815                 }
00816 
00817             <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(Peb-&gt;ProcessHeap, 0,Entry);
00818             }
00819 
00820 leave_finally:;
00821         }
00822     finally {
00823         <a class="code" href="../../d9/d2/ldrp_8h.html#a42">LdrpActiveUnloadCount</a>--;
00824         <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d2/ldrinit_8c.html#a4">LdrpInLdrInit</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ) {
00825 
00826 <span class="preprocessor">#if defined (WX86)</span>
00827 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (Wx86ProcessInit &amp;&amp; Wx86Plugin) {
00828                 Wx86UnloadProviders( Wx86Plugin );
00829             }
00830 <span class="preprocessor">#endif</span>
00831 <span class="preprocessor"></span>            RtlLeaveCriticalSection((PRTL_CRITICAL_SECTION)NtCurrentPeb()-&gt;LoaderLock);
00832             }
00833         }
00834     <span class="keywordflow">return</span> st;
00835 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="ldrapi.c::LdrVerifyImageMatchesChecksum" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NTAPI LdrVerifyImageMatchesChecksum           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ImageFileHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLDR_IMPORT_MODULE_CALLBACK ImportCallbackRoutine&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>ImportCallbackParameter</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a22">PUSHORT</a> ImageCharacteristics&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l01069">1069</a> of file <a class="el" href="../../d5/d1/ldrapi_8c-source.html">ldrapi.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d1/d6/checksum_8c-source.html#l00099">LdrVerifyMappedImageMatchesChecksum()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d1/d7/creasect_8c-source.html#l00134">NtCreateSection()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l00199">NtMapViewOfSection()</a>, <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00101">NtQueryInformationFile()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d8/umapview_8c-source.html#l00033">NtUnmapViewOfSection()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00250">RtlImageDirectoryEntryToData()</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00029">RtlImageNtHeader()</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00370">RtlImageRvaToVa()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>01075 {
01076 
01077     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01078     HANDLE Section;
01079     PVOID ViewBase;
01080     SIZE_T ViewSize;
01081     IO_STATUS_BLOCK IoStatusBlock;
01082     FILE_STANDARD_INFORMATION StandardInfo;
01083     PIMAGE_SECTION_HEADER LastRvaSection;
01084     BOOLEAN b;
01085     BOOLEAN JustDoSideEffects;
01086 
01087     <span class="comment">//</span>
01088     <span class="comment">// stevewo added all sorts of side effects to this API. We want to stop</span>
01089     <span class="comment">// doing checksums for known dll's, but really want the sideeffects</span>
01090     <span class="comment">// (ImageCharacteristics write, and Import descriptor walk).</span>
01091     <span class="comment">//</span>
01092 
01093     <span class="keywordflow">if</span> ( (UINT_PTR) ImageFileHandle &amp; 1 ) {
01094         JustDoSideEffects = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01095         }
01096     <span class="keywordflow">else</span> {
01097         JustDoSideEffects = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01098         }
01099 
01100     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d8/creasect_8c.html#a19">NtCreateSection</a>(
01101                 &amp;Section,
01102                 SECTION_MAP_EXECUTE,
01103                 NULL,
01104                 NULL,
01105                 PAGE_EXECUTE,
01106                 SEC_COMMIT,
01107                 ImageFileHandle
01108                 );
01109     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
01110         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01111         }
01112 
01113     ViewBase = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01114     ViewSize = 0;
01115 
01116     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d5/mapview_8c.html#a20">NtMapViewOfSection</a>(
01117                 Section,
01118                 NtCurrentProcess(),
01119                 (PVOID *)&amp;ViewBase,
01120                 0L,
01121                 0L,
01122                 NULL,
01123                 &amp;ViewSize,
01124                 ViewShare,
01125                 0L,
01126                 PAGE_EXECUTE
01127                 );
01128 
01129     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
01130         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(Section);
01131         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01132         }
01133 
01134     <span class="comment">//</span>
01135     <span class="comment">// now the image is mapped as a data file... Calculate it's size and then</span>
01136     <span class="comment">// check it's checksum</span>
01137     <span class="comment">//</span>
01138 
01139     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d2/qsinfo_8c.html#a3">NtQueryInformationFile</a>(
01140                 ImageFileHandle,
01141                 &amp;IoStatusBlock,
01142                 &amp;StandardInfo,
01143                 <span class="keyword">sizeof</span>(StandardInfo),
01144                 FileStandardInformation
01145                 );
01146 
01147     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
01148         <a class="code" href="../../d4/d9/umapview_8c.html#a0">NtUnmapViewOfSection</a>(NtCurrentProcess(),ViewBase);
01149         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(Section);
01150         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01151         }
01152 
01153     <span class="keywordflow">try</span> {
01154         <span class="keywordflow">if</span> ( JustDoSideEffects ) {
01155             b = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01156             }
01157         <span class="keywordflow">else</span> {
01158             b = <a class="code" href="../../d0/d7/checksum_8c.html#a1">LdrVerifyMappedImageMatchesChecksum</a>(ViewBase,StandardInfo.EndOfFile.LowPart);
01159             }
01160         <span class="keywordflow">if</span> (b &amp;&amp; ARGUMENT_PRESENT( ImportCallbackRoutine )) {
01161             PIMAGE_NT_HEADERS NtHeaders;
01162             PIMAGE_IMPORT_DESCRIPTOR ImportDescriptor;
01163             ULONG ImportSize;
01164             PCHAR ImportName;
01165 
01166             <span class="comment">//</span>
01167             <span class="comment">// Caller wants to enumerate the import descriptors while we have</span>
01168             <span class="comment">// the image mapped.  Call back to their routine for each module</span>
01169             <span class="comment">// name in the import descriptor table.</span>
01170             <span class="comment">//</span>
01171             LastRvaSection = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01172             NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>( ViewBase );
01173             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ImageCharacteristics )) {
01174                 *ImageCharacteristics = NtHeaders-&gt;FileHeader.Characteristics;
01175                 }
01176 
01177             ImportDescriptor = (PIMAGE_IMPORT_DESCRIPTOR)
01178                 <a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a>( ViewBase,
01179                                               FALSE,
01180                                               IMAGE_DIRECTORY_ENTRY_IMPORT,
01181                                               &amp;ImportSize
01182                                             );
01183             <span class="keywordflow">if</span> (ImportDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01184                 <span class="keywordflow">while</span> (ImportDescriptor-&gt;Name) {
01185                     ImportName = (PSZ)<a class="code" href="../../d8/d9/imagedir_8c.html#a7">RtlImageRvaToVa</a>( NtHeaders,
01186                                                        ViewBase,
01187                                                        ImportDescriptor-&gt;Name,
01188                                                        &amp;LastRvaSection
01189                                                      );
01190                     (*ImportCallbackRoutine)( ImportCallbackParameter, ImportName );
01191                     ImportDescriptor += 1;
01192                     }
01193                 }
01194             }
01195         }
01196     except (EXCEPTION_EXECUTE_HANDLER) {
01197         <a class="code" href="../../d4/d9/umapview_8c.html#a0">NtUnmapViewOfSection</a>(NtCurrentProcess(),ViewBase);
01198         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(Section);
01199         <span class="keywordflow">return</span> STATUS_IMAGE_CHECKSUM_MISMATCH;
01200         }
01201     <a class="code" href="../../d4/d9/umapview_8c.html#a0">NtUnmapViewOfSection</a>(NtCurrentProcess(),ViewBase);
01202     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(Section);
01203     <span class="keywordflow">if</span> ( !b ) {
01204         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_IMAGE_CHECKSUM_MISMATCH;
01205         }
01206     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01207 }
</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:30 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
