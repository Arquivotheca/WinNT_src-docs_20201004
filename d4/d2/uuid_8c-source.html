<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: uuid.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>uuid.c</h1><a href="../../d3/d3/uuid_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1994-1997  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    uuid.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements the core time and sequence number allocation</span>
00012 <span class="comment">    for UUIDs (exposed to user mode), as well as complete UUID</span>
00013 <span class="comment">    creation (exposed to kernel mode only).</span>
00014 <span class="comment"></span>
00015 <span class="comment">              (e.g. RPC Runtime)                (e.g. NTFS)</span>
00016 <span class="comment">                      |                              |</span>
00017 <span class="comment">                      V                              V</span>
00018 <span class="comment">                NtAllocateUuids                 ExUuidCreate</span>
00019 <span class="comment">                      |                              |</span>
00020 <span class="comment">                      V                              V</span>
00021 <span class="comment">                      |                         ExpUuidGetValues</span>
00022 <span class="comment">                      |                              |</span>
00023 <span class="comment">                      |                              |</span>
00024 <span class="comment">                      +------&gt; ExpAllocateUuids &lt;----+</span>
00025 <span class="comment"></span>
00026 <span class="comment"></span>
00027 <span class="comment"></span>
00028 <span class="comment">Author:</span>
00029 <span class="comment"></span>
00030 <span class="comment">    Mario Goertzel (MarioGo)  22-Nov-1994</span>
00031 <span class="comment"></span>
00032 <span class="comment">Revision History:</span>
00033 <span class="comment"></span>
00034 <span class="comment">    MikeHill    17-Jan-96   Ported ExUuidCreate &amp; ExpUuidGetValues from RPCRT4.</span>
00035 <span class="comment">    MazharM     17-Feb-98   Add PNP support</span>
00036 <span class="comment"></span>
00037 <span class="comment">--*/</span>
00038 
00039 <span class="preprocessor">#include "<a class="code" href="../../d4/d0/exp_8h.html">exp.h</a>"</span>
00040 
00041 
00042 
00043 <span class="comment">//</span>
00044 <span class="comment">// Well known values</span>
00045 <span class="comment">//</span>
00046 
00047 <span class="comment">// Registry info for the sequen number</span>
<a name="l00048"></a><a class="code" href="../../d3/d3/uuid_8c.html#a0">00048</a> <span class="preprocessor">#define RPC_SEQUENCE_NUMBER_PATH L"\\Registry\\Machine\\Software\\Microsoft\\Rpc"</span>
<a name="l00049"></a><a class="code" href="../../d3/d3/uuid_8c.html#a1">00049</a> <span class="preprocessor"></span><span class="preprocessor">#define RPC_SEQUENCE_NUMBER_NAME L"UuidSequenceNumber"</span>
00050 <span class="preprocessor"></span>
00051 <span class="comment">// Masks and constants to interpret the UUID</span>
<a name="l00052"></a><a class="code" href="../../d3/d3/uuid_8c.html#a2">00052</a> <span class="preprocessor">#define UUID_TIME_HIGH_MASK    0x0FFF</span>
<a name="l00053"></a><a class="code" href="../../d3/d3/uuid_8c.html#a3">00053</a> <span class="preprocessor"></span><span class="preprocessor">#define UUID_VERSION           0x1000</span>
<a name="l00054"></a><a class="code" href="../../d3/d3/uuid_8c.html#a4">00054</a> <span class="preprocessor"></span><span class="preprocessor">#define UUID_RESERVED          0x80</span>
<a name="l00055"></a><a class="code" href="../../d3/d3/uuid_8c.html#a5">00055</a> <span class="preprocessor"></span><span class="preprocessor">#define UUID_CLOCK_SEQ_HI_MASK 0x3F</span>
00056 <span class="preprocessor"></span>
00057 <span class="comment">// Values for ExpUuidCacheValid</span>
<a name="l00058"></a><a class="code" href="../../d3/d3/uuid_8c.html#a6">00058</a> <span class="preprocessor">#define CACHE_LOCAL_ONLY 0</span>
<a name="l00059"></a><a class="code" href="../../d3/d3/uuid_8c.html#a7">00059</a> <span class="preprocessor"></span><span class="preprocessor">#define CACHE_VALID      1</span>
00060 <span class="preprocessor"></span>
00061 <span class="comment">//</span>
00062 <span class="comment">// Custom types</span>
00063 <span class="comment">//</span>
00064 
00065 <span class="comment">// An alternative data-template for a UUID, useful during generation.</span>
<a name="l00066"></a><a class="code" href="../../d9/d4/struct__UUID__GENERATE.html">00066</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d9/d4/struct__UUID__GENERATE.html">_UUID_GENERATE</a> {
<a name="l00067"></a><a class="code" href="../../d9/d4/struct__UUID__GENERATE.html#o0">00067</a>     ULONG   <a class="code" href="../../d9/d4/struct__UUID__GENERATE.html#o0">TimeLow</a>;
<a name="l00068"></a><a class="code" href="../../d9/d4/struct__UUID__GENERATE.html#o1">00068</a>     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>  <a class="code" href="../../d9/d4/struct__UUID__GENERATE.html#o1">TimeMid</a>;
<a name="l00069"></a><a class="code" href="../../d9/d4/struct__UUID__GENERATE.html#o2">00069</a>     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>  <a class="code" href="../../d9/d4/struct__UUID__GENERATE.html#o2">TimeHiAndVersion</a>;
<a name="l00070"></a><a class="code" href="../../d9/d4/struct__UUID__GENERATE.html#o3">00070</a>     UCHAR   <a class="code" href="../../d9/d4/struct__UUID__GENERATE.html#o3">ClockSeqHiAndReserved</a>;
<a name="l00071"></a><a class="code" href="../../d9/d4/struct__UUID__GENERATE.html#o4">00071</a>     UCHAR   <a class="code" href="../../d9/d4/struct__UUID__GENERATE.html#o4">ClockSeqLow</a>;
<a name="l00072"></a><a class="code" href="../../d9/d4/struct__UUID__GENERATE.html#o5">00072</a>     UCHAR   <a class="code" href="../../d9/d4/struct__UUID__GENERATE.html#o5">NodeId</a>[6];
00073 } <a class="code" href="../../d9/d4/struct__UUID__GENERATE.html">UUID_GENERATE</a>;
00074 
00075 <span class="comment">// A cache of allocated UUIDs</span>
<a name="l00076"></a><a class="code" href="../../d8/d4/struct__UUID__CACHED__VALUES__STRUCT.html">00076</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d8/d4/struct__UUID__CACHED__VALUES__STRUCT.html">_UUID_CACHED_VALUES_STRUCT</a> {
<a name="l00077"></a><a class="code" href="../../d8/d4/struct__UUID__CACHED__VALUES__STRUCT.html#o0">00077</a>     ULONGLONG           <a class="code" href="../../d8/d4/struct__UUID__CACHED__VALUES__STRUCT.html#o0">Time</a>;           <span class="comment">// End time of allocation</span>
<a name="l00078"></a><a class="code" href="../../d8/d4/struct__UUID__CACHED__VALUES__STRUCT.html#o1">00078</a>     LONG                <a class="code" href="../../d8/d4/struct__UUID__CACHED__VALUES__STRUCT.html#o1">AllocatedCount</a>; <span class="comment">// Number of UUIDs allocated</span>
<a name="l00079"></a><a class="code" href="../../d8/d4/struct__UUID__CACHED__VALUES__STRUCT.html#o2">00079</a>     UCHAR               <a class="code" href="../../d8/d4/struct__UUID__CACHED__VALUES__STRUCT.html#o2">ClockSeqHiAndReserved</a>;
<a name="l00080"></a><a class="code" href="../../d8/d4/struct__UUID__CACHED__VALUES__STRUCT.html#o3">00080</a>     UCHAR               <a class="code" href="../../d8/d4/struct__UUID__CACHED__VALUES__STRUCT.html#o3">ClockSeqLow</a>;
<a name="l00081"></a><a class="code" href="../../d8/d4/struct__UUID__CACHED__VALUES__STRUCT.html#o4">00081</a>     UCHAR               <a class="code" href="../../d8/d4/struct__UUID__CACHED__VALUES__STRUCT.html#o4">NodeId</a>[6];
00082 } <a class="code" href="../../d8/d4/struct__UUID__CACHED__VALUES__STRUCT.html">UUID_CACHED_VALUES_STRUCT</a>;
00083 
00084 
00085 <span class="comment">//</span>
00086 <span class="comment">//  Global variables</span>
00087 <span class="comment">//</span>
00088 
00089 <span class="comment">// UUID cache information</span>
<a name="l00090"></a><a class="code" href="../../d3/d3/uuid_8c.html#a11">00090</a> LARGE_INTEGER               <a class="code" href="../../d3/d3/uuid_8c.html#a11">ExpUuidLastTimeAllocated</a>;
<a name="l00091"></a><a class="code" href="../../d3/d3/uuid_8c.html#a12">00091</a> BOOLEAN                     <a class="code" href="../../d3/d3/uuid_8c.html#a12">ExpUuidCacheValid</a> = <a class="code" href="../../d3/d3/uuid_8c.html#a6">CACHE_LOCAL_ONLY</a>;
00092 
00093 <span class="comment">// Make cache allocate UUIDs on first call.</span>
00094 <span class="comment">// Time = 0. Allocated = -1, ..., multicast bit in node id</span>
<a name="l00095"></a><a class="code" href="../../d3/d3/uuid_8c.html#a13">00095</a> <a class="code" href="../../d8/d4/struct__UUID__CACHED__VALUES__STRUCT.html">UUID_CACHED_VALUES_STRUCT</a>   <a class="code" href="../../d3/d3/uuid_8c.html#a13">ExpUuidCachedValues</a> = { 0, -1, 0, 0, { 0x80, <span class="charliteral">'m'</span>, <span class="charliteral">'a'</span>, <span class="charliteral">'r'</span>, <span class="charliteral">'i'</span>, <span class="charliteral">'o'</span> }};
00096 
00097 <span class="comment">// UUID Sequence number information</span>
<a name="l00098"></a><a class="code" href="../../d3/d3/uuid_8c.html#a14">00098</a> ULONG                       <a class="code" href="../../d3/d3/uuid_8c.html#a14">ExpUuidSequenceNumber</a>;
<a name="l00099"></a><a class="code" href="../../d3/d3/uuid_8c.html#a15">00099</a> BOOLEAN                     <a class="code" href="../../d3/d3/uuid_8c.html#a15">ExpUuidSequenceNumberValid</a>;
<a name="l00100"></a><a class="code" href="../../d3/d3/uuid_8c.html#a16">00100</a> BOOLEAN                     <a class="code" href="../../d3/d3/uuid_8c.html#a16">ExpUuidSequenceNumberNotSaved</a>;
00101 
00102 <span class="comment">// A lock to protect all of the above global data.</span>
<a name="l00103"></a><a class="code" href="../../d3/d3/uuid_8c.html#a17">00103</a> <a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a>                  <a class="code" href="../../d3/d3/uuid_8c.html#a17">ExpUuidLock</a>;
00104 
00105 <span class="comment">//</span>
00106 <span class="comment">// Code section allocations</span>
00107 <span class="comment">//</span>
00108 
00109 <span class="keyword">extern</span> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d3/d3/uuid_8c.html#a18">ExpUuidLoadSequenceNumber</a>(
00110     OUT PULONG
00111     );
00112 
00113 <span class="keyword">extern</span> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d3/d3/uuid_8c.html#a19">ExpUuidSaveSequenceNumber</a>(
00114     IN ULONG
00115     );
00116 
00117 <span class="keyword">extern</span> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d3/d3/uuid_8c.html#a20">ExpUuidSaveSequenceNumberIf</a> ();
00118 
00119 <span class="keyword">extern</span> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d3/d3/uuid_8c.html#a21">ExpUuidGetValues</a>(
00120     OUT <a class="code" href="../../d8/d4/struct__UUID__CACHED__VALUES__STRUCT.html">UUID_CACHED_VALUES_STRUCT</a> *Values
00121     );
00122 
00123 
00124 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00125 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, ExpUuidLoadSequenceNumber)</span>
00126 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, ExpUuidSaveSequenceNumber)</span>
00127 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, ExpUuidSaveSequenceNumberIf)</span>
00128 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT, ExpUuidInitialization)</span>
00129 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, NtAllocateUuids)</span>
00130 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, NtSetUuidSeed)</span>
00131 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, ExpUuidGetValues)</span>
00132 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, ExUuidCreate)</span>
00133 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00134 <span class="preprocessor"></span>
00135 
00136 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00137"></a><a class="code" href="../../d3/d3/uuid_8c.html#a18">00137</a> <a class="code" href="../../d3/d3/uuid_8c.html#a18">ExpUuidLoadSequenceNumber</a>(
00138     OUT PULONG Sequence
00139     )
00140 <span class="comment">/*++</span>
00141 <span class="comment"></span>
00142 <span class="comment">Routine Description:</span>
00143 <span class="comment"></span>
00144 <span class="comment">    This function loads the saved sequence number from the registry.</span>
00145 <span class="comment">    This function is called only during system startup.</span>
00146 <span class="comment"></span>
00147 <span class="comment">Arguments:</span>
00148 <span class="comment"></span>
00149 <span class="comment">    Sequence - Pointer to storage for the sequence number.</span>
00150 <span class="comment"></span>
00151 <span class="comment">Return Value:</span>
00152 <span class="comment"></span>
00153 <span class="comment">    STATUS_SUCCESS when the sequence number is successfully read from the</span>
00154 <span class="comment">        registry.</span>
00155 <span class="comment"></span>
00156 <span class="comment">    STATUS_UNSUCCESSFUL when the sequence number is not correctly stored</span>
00157 <span class="comment">        in the registry.</span>
00158 <span class="comment"></span>
00159 <span class="comment">    Failure codes from ZwOpenKey() and ZwQueryValueKey() maybe returned.</span>
00160 <span class="comment"></span>
00161 <span class="comment">--*/</span>
00162 {
00163     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00164     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
00165     UNICODE_STRING <a class="code" href="../../d8/d0/rtbatcr_8c.html#a2">KeyPath</a>, <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>;
00166     HANDLE <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>;
00167     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> KeyValueBuffer[<span class="keyword">sizeof</span>(KEY_VALUE_PARTIAL_INFORMATION) + <span class="keyword">sizeof</span>(ULONG)];
00168     PKEY_VALUE_PARTIAL_INFORMATION KeyValueInformation;
00169     ULONG ResultLength;
00170 
00171     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00172 
00173     KeyValueInformation = (PKEY_VALUE_PARTIAL_INFORMATION)KeyValueBuffer;
00174 
00175     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a2">KeyPath</a>, <a class="code" href="../../d3/d3/uuid_8c.html#a0">RPC_SEQUENCE_NUMBER_PATH</a>);
00176     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>, <a class="code" href="../../d3/d3/uuid_8c.html#a1">RPC_SEQUENCE_NUMBER_NAME</a>);
00177 
00178     InitializeObjectAttributes( &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00179                                 &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a2">KeyPath</a>,
00180                                 OBJ_CASE_INSENSITIVE | OBJ_KERNEL_HANDLE,
00181                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00182                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00183                               );
00184 
00185     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> =
00186     ZwOpenKey( &amp;<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>,
00187                GENERIC_READ,
00188                &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>
00189              );
00190 
00191     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00192         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> =
00193         ZwQueryValueKey( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>,
00194                          &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>,
00195                          KeyValuePartialInformation,
00196                          KeyValueInformation,
00197                          <span class="keyword">sizeof</span>(KeyValueBuffer),
00198                          &amp;ResultLength
00199                        );
00200 
00201         ZwClose( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> );
00202         }
00203 
00204     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00205         <span class="keywordflow">if</span> ( KeyValueInformation-&gt;Type == REG_DWORD &amp;&amp;
00206              KeyValueInformation-&gt;DataLength == <span class="keyword">sizeof</span>(ULONG)
00207            ) {
00208             *Sequence = *(PULONG)KeyValueInformation-&gt;Data;
00209             }
00210         <span class="keywordflow">else</span> {
00211             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
00212             }
00213         }
00214 
00215     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00216 }
00217 
00218 
00219 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00220"></a><a class="code" href="../../d3/d3/uuid_8c.html#a19">00220</a> <a class="code" href="../../d3/d3/uuid_8c.html#a19">ExpUuidSaveSequenceNumber</a>(
00221     IN ULONG Sequence
00222     )
00223 <span class="comment">/*++</span>
00224 <span class="comment"></span>
00225 <span class="comment">Routine Description:</span>
00226 <span class="comment"></span>
00227 <span class="comment">    This function saves the uuid sequence number in the registry.  This</span>
00228 <span class="comment">    value will be read by ExpUuidLoadSequenceNumber during the next boot.</span>
00229 <span class="comment"></span>
00230 <span class="comment">    This routine assumes that the current thread has exclusive access</span>
00231 <span class="comment">    to the the ExpUuid* values.</span>
00232 <span class="comment"></span>
00233 <span class="comment">Arguments:</span>
00234 <span class="comment"></span>
00235 <span class="comment">    Sequence - The sequence number to save.</span>
00236 <span class="comment"></span>
00237 <span class="comment">Return Value:</span>
00238 <span class="comment"></span>
00239 <span class="comment">    STATUS_SUCCESS</span>
00240 <span class="comment"></span>
00241 <span class="comment">    Failure codes from ZwOpenKey() and ZwSetValueKey() maybe returned.</span>
00242 <span class="comment"></span>
00243 <span class="comment">--*/</span>
00244 {
00245     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00246     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
00247     UNICODE_STRING <a class="code" href="../../d8/d0/rtbatcr_8c.html#a2">KeyPath</a>, <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>;
00248     HANDLE <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>;
00249 
00250     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00251 
00252     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a2">KeyPath</a>, <a class="code" href="../../d3/d3/uuid_8c.html#a0">RPC_SEQUENCE_NUMBER_PATH</a>);
00253     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>, <a class="code" href="../../d3/d3/uuid_8c.html#a1">RPC_SEQUENCE_NUMBER_NAME</a>);
00254 
00255     InitializeObjectAttributes( &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00256                                 &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a2">KeyPath</a>,
00257                                 OBJ_CASE_INSENSITIVE | OBJ_KERNEL_HANDLE,
00258                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00259                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00260                               );
00261 
00262     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> =
00263     ZwOpenKey( &amp;<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>,
00264                GENERIC_READ | GENERIC_WRITE,
00265                &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>
00266              );
00267 
00268     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00269         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> =
00270         ZwSetValueKey( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>,
00271                        &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>,
00272                        0,
00273                        REG_DWORD,
00274                        &amp;Sequence,
00275                        <span class="keyword">sizeof</span>(ULONG)
00276                      );
00277 
00278         ZwClose( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> );
00279         }
00280 
00281     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00282 }
00283 
00284 
00285 
00286 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00287"></a><a class="code" href="../../d3/d3/uuid_8c.html#a20">00287</a> <a class="code" href="../../d3/d3/uuid_8c.html#a20">ExpUuidSaveSequenceNumberIf</a> ()
00288 
00289 <span class="comment">/*++</span>
00290 <span class="comment"></span>
00291 <span class="comment">Routine Description:</span>
00292 <span class="comment"></span>
00293 <span class="comment">    This function saves the ExpUuidSequenceNumber, but only</span>
00294 <span class="comment">    if necessary (as determined by the ExpUuidSequenceNumberNotSaved</span>
00295 <span class="comment">    flag).</span>
00296 <span class="comment"></span>
00297 <span class="comment">    This routine assumes that the current thread has exclusive access</span>
00298 <span class="comment">    to the ExpUuid* values.</span>
00299 <span class="comment"></span>
00300 <span class="comment">Arguments:</span>
00301 <span class="comment"></span>
00302 <span class="comment">    None.</span>
00303 <span class="comment"></span>
00304 <span class="comment">Return Value:</span>
00305 <span class="comment"></span>
00306 <span class="comment">    STATUS_SUCCESS if the operation was successful.</span>
00307 <span class="comment"></span>
00308 <span class="comment">--*/</span>
00309 
00310 {
00311     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00312 
00313     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00314 
00315     <span class="comment">// Does the sequence number need to be saved?</span>
00316     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d3/uuid_8c.html#a16">ExpUuidSequenceNumberNotSaved</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00317 
00318         <span class="comment">// Print this message just to make sure we aren't hitting the</span>
00319         <span class="comment">// registry too much under normal usage.</span>
00320 
00321         KdPrint((<span class="stringliteral">"Uuid: Saving new sequence number.\n"</span>));
00322 
00323         <span class="comment">// Save the sequence number</span>
00324 
00325         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d3/uuid_8c.html#a19">ExpUuidSaveSequenceNumber</a>(<a class="code" href="../../d3/d3/uuid_8c.html#a14">ExpUuidSequenceNumber</a>);
00326 
00327         <span class="comment">// Indicate that it's now been saved.</span>
00328         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00329             <a class="code" href="../../d3/d3/uuid_8c.html#a16">ExpUuidSequenceNumberNotSaved</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00330             }
00331         }
00332 
00333     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00334 }
00335 
00336 
00337 
00338 
00339 BOOLEAN
<a name="l00340"></a><a class="code" href="../../d3/d3/uuid_8c.html#a22">00340</a> <a class="code" href="../../d4/d0/exp_8h.html#a30">ExpUuidInitialization</a> (
00341     VOID
00342     )
00343 <span class="comment">/*++</span>
00344 <span class="comment"></span>
00345 <span class="comment">Routine Description:</span>
00346 <span class="comment"></span>
00347 <span class="comment">    This function initializes the UUID allocation.</span>
00348 <span class="comment"></span>
00349 <span class="comment">Arguments:</span>
00350 <span class="comment"></span>
00351 <span class="comment">    None.</span>
00352 <span class="comment"></span>
00353 <span class="comment">Return Value:</span>
00354 <span class="comment"></span>
00355 <span class="comment">    A value of TRUE is returned if the initialization is successfully</span>
00356 <span class="comment">    completed.  Otherwise, a value of FALSE is returned.</span>
00357 <span class="comment"></span>
00358 <span class="comment">--*/</span>
00359 
00360 {
00361     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00362 
00363     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00364 
00365     <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>(&amp;<a class="code" href="../../d3/d3/uuid_8c.html#a17">ExpUuidLock</a>);
00366 
00367     <a class="code" href="../../d3/d3/uuid_8c.html#a15">ExpUuidSequenceNumberValid</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00368 
00369     <span class="comment">// We can use the current time since we'll be changing the sequence number.</span>
00370 
00371     <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a>(&amp;<a class="code" href="../../d3/d3/uuid_8c.html#a11">ExpUuidLastTimeAllocated</a>);
00372 
00373     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00374 }
00375 
00376 
00377 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00378"></a><a class="code" href="../../d3/d3/uuid_8c.html#a23">00378</a> <a class="code" href="../../d3/d3/uuid_8c.html#a23">ExpAllocateUuids</a> (
00379     OUT PLARGE_INTEGER Time,
00380     OUT PULONG Range,
00381     OUT PULONG Sequence
00382     )
00383 
00384 <span class="comment">/*++</span>
00385 <span class="comment"></span>
00386 <span class="comment">Routine Description:</span>
00387 <span class="comment"></span>
00388 <span class="comment">    Allocates a sequence number and a range of times for a set of UUIDs.</span>
00389 <span class="comment">    The caller can use this together with the network address to</span>
00390 <span class="comment">    generate complete UUIDs.</span>
00391 <span class="comment"></span>
00392 <span class="comment">    This routine assumes that the current thread has exclusive access</span>
00393 <span class="comment">    to the ExpUuid* values.</span>
00394 <span class="comment"></span>
00395 <span class="comment">Arguments:</span>
00396 <span class="comment"></span>
00397 <span class="comment">    Time - Supplies the address of a variable that will receive the</span>
00398 <span class="comment">        start time (SYSTEMTIME format) of the range of time reserved.</span>
00399 <span class="comment"></span>
00400 <span class="comment">    Range - Supplies the address of a variable that will receive the</span>
00401 <span class="comment">        number of ticks (100ns) reserved after the value in Time.</span>
00402 <span class="comment">        The range reserved is *Time to (*Time+*Range-1).</span>
00403 <span class="comment"></span>
00404 <span class="comment">    Sequence - Supplies the address of a variable that will receive</span>
00405 <span class="comment">        the time sequence number.  This value is used with the associated</span>
00406 <span class="comment">        range of time to prevent problems with clocks going backwards.</span>
00407 <span class="comment"></span>
00408 <span class="comment">Return Value:</span>
00409 <span class="comment"></span>
00410 <span class="comment">    STATUS_SUCCESS is returned if the service is successfully executed.</span>
00411 <span class="comment"></span>
00412 <span class="comment">    STATUS_RETRY is returned if we're unable to reserve a range of</span>
00413 <span class="comment">        UUIDs.  This will occur if system clock hasn't advanced</span>
00414 <span class="comment">        and the allocator is out of cached values.</span>
00415 <span class="comment"></span>
00416 <span class="comment">    STATUS_UNSUCCESSFUL is returned if some other service reports</span>
00417 <span class="comment">        an error, most likly the registery.</span>
00418 <span class="comment"></span>
00419 <span class="comment">--*/</span>
00420 
00421 {
00422     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00423     LARGE_INTEGER CurrentTime;
00424     LARGE_INTEGER AvailableTime;
00425 
00426     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00427 
00428     <span class="comment">//</span>
00429     <span class="comment">// Make sure we have a valid sequence number.  If not, make one up.</span>
00430     <span class="comment">//</span>
00431 
00432     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d3/uuid_8c.html#a15">ExpUuidSequenceNumberValid</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00433 
00434         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d3/uuid_8c.html#a18">ExpUuidLoadSequenceNumber</a>(&amp;<a class="code" href="../../d3/d3/uuid_8c.html#a14">ExpUuidSequenceNumber</a>);
00435 
00436         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00437             <span class="comment">// Unable read the sequence number, this means we should make one up.</span>
00438 
00439             LARGE_INTEGER PerfCounter;
00440             LARGE_INTEGER PerfFrequency;
00441 
00442             <span class="comment">// This should only happen when we're called</span>
00443             <span class="comment">// for the first time on a given machine. (machine, not boot)</span>
00444 
00445             KdPrint((<span class="stringliteral">"Uuid: Generating first sequence number.\n"</span>));
00446 
00447             PerfCounter = <a class="code" href="../../d2/d7/hal_8h.html#a205">KeQueryPerformanceCounter</a>(&amp;PerfFrequency);
00448 
00449             <a class="code" href="../../d3/d3/uuid_8c.html#a14">ExpUuidSequenceNumber</a> ^= (ULONG)((ULONG_PTR)&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ^ PerfCounter.LowPart ^
00450                 PerfCounter.HighPart ^ (ULONG)((ULONG_PTR)Sequence);
00451             }
00452         <span class="keywordflow">else</span> {
00453             <span class="comment">// We increment the sequence number on every boot.</span>
00454             <a class="code" href="../../d3/d3/uuid_8c.html#a14">ExpUuidSequenceNumber</a>++;
00455             }
00456 
00457         <a class="code" href="../../d3/d3/uuid_8c.html#a15">ExpUuidSequenceNumberValid</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00458         <a class="code" href="../../d3/d3/uuid_8c.html#a16">ExpUuidSequenceNumberNotSaved</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00459 
00460         }
00461 
00462     <span class="comment">//</span>
00463     <span class="comment">// Get the current time, usually we will have plenty of avaliable</span>
00464     <span class="comment">// to give the caller.  But we may need to deal with time going</span>
00465     <span class="comment">// backwards and really fast machines.</span>
00466     <span class="comment">//</span>
00467 
00468     <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a>(&amp;CurrentTime);
00469 
00470     AvailableTime.QuadPart = CurrentTime.QuadPart - <a class="code" href="../../d3/d3/uuid_8c.html#a11">ExpUuidLastTimeAllocated</a>.QuadPart;
00471 
00472     <span class="keywordflow">if</span> (AvailableTime.QuadPart &lt; 0) {
00473 
00474         <span class="comment">// Time has been set time backwards. This means that we must make sure</span>
00475         <span class="comment">// that somebody increments the sequence number and saves the new</span>
00476         <span class="comment">// sequence number in the registry.</span>
00477 
00478         <a class="code" href="../../d3/d3/uuid_8c.html#a16">ExpUuidSequenceNumberNotSaved</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00479         <a class="code" href="../../d3/d3/uuid_8c.html#a14">ExpUuidSequenceNumber</a>++;
00480 
00481         <span class="comment">// The sequence number has been changed, so it's now okay to set time</span>
00482         <span class="comment">// backwards.  Since time is going backwards anyway, it's okay to set</span>
00483         <span class="comment">// it back an extra millisecond or two.</span>
00484 
00485         <a class="code" href="../../d3/d3/uuid_8c.html#a11">ExpUuidLastTimeAllocated</a>.QuadPart = CurrentTime.QuadPart - 20000;
00486         AvailableTime.QuadPart = 20000;
00487         }
00488 
00489     <span class="keywordflow">if</span> (AvailableTime.QuadPart == 0) {
00490         <span class="comment">// System time hasn't moved.  The caller should yield the CPU and retry.</span>
00491         <span class="keywordflow">return</span>(STATUS_RETRY);
00492         }
00493 
00494     <span class="comment">//</span>
00495     <span class="comment">// Common case, time has moved forward.</span>
00496     <span class="comment">//</span>
00497 
00498     <span class="keywordflow">if</span> (AvailableTime.QuadPart &gt; 10*1000*1000) {
00499         <span class="comment">// We never want to give out really old (&gt; 1 second) Uuids.</span>
00500         AvailableTime.QuadPart = 10*1000*1000;
00501         }
00502 
00503     <span class="keywordflow">if</span> (AvailableTime.QuadPart &gt; 10*1000) {
00504         <span class="comment">// We've got over a millisecond to give out.  We'll save some time for</span>
00505         <span class="comment">// another caller so that we can avoid returning STATUS_RETRY very often.</span>
00506         *Range = 10*1000;
00507         AvailableTime.QuadPart -= 10*1000;
00508         }
00509     <span class="keywordflow">else</span> {
00510         <span class="comment">// Not much time avaiable, give it all away.</span>
00511         *Range = (ULONG)AvailableTime.QuadPart;
00512         AvailableTime.QuadPart = 0;
00513         }
00514 
00515     <a class="code" href="../../d6/d6/ttime_8c.html#a14">Time</a>-&gt;QuadPart = CurrentTime.QuadPart - (*Range + AvailableTime.QuadPart);
00516 
00517     <a class="code" href="../../d3/d3/uuid_8c.html#a11">ExpUuidLastTimeAllocated</a>.QuadPart = <a class="code" href="../../d6/d6/ttime_8c.html#a14">Time</a>-&gt;QuadPart + *Range;
00518 
00519     <span class="comment">// Last time allocated is just after the range we hand back to the caller</span>
00520     <span class="comment">// this may be almost a second behind the true system time.</span>
00521 
00522     *Sequence = <a class="code" href="../../d3/d3/uuid_8c.html#a14">ExpUuidSequenceNumber</a>;
00523 
00524 
00525     <span class="keywordflow">return</span>(STATUS_SUCCESS);
00526 }
00527 
<a name="l00528"></a><a class="code" href="../../d3/d3/uuid_8c.html#a8">00528</a> <span class="preprocessor">#define SEED_SIZE 6 * sizeof(CHAR)</span>
00529 <span class="preprocessor"></span>
00530 
00531 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00532"></a><a class="code" href="../../d3/d3/uuid_8c.html#a24">00532</a> <a class="code" href="../../d3/d3/uuid_8c.html#a24">NtSetUuidSeed</a> (
00533     IN PCHAR Seed
00534     )
00535 <span class="comment">/*++</span>
00536 <span class="comment"></span>
00537 <span class="comment">Routine Description:</span>
00538 <span class="comment"></span>
00539 <span class="comment">    This routine is used to set the seed used for UUID generation. The seed</span>
00540 <span class="comment">    will be set by RPCSS at startup and each time a card is replaced.</span>
00541 <span class="comment">    </span>
00542 <span class="comment">Arguments:</span>
00543 <span class="comment"></span>
00544 <span class="comment">    Seed - Pointer to a six byte buffer</span>
00545 <span class="comment">    </span>
00546 <span class="comment">Return Value:</span>
00547 <span class="comment"></span>
00548 <span class="comment">    STATUS_SUCCESS is returned if the service is successfully executed.</span>
00549 <span class="comment"></span>
00550 <span class="comment">    STATUS_ACCESS_DENIED If caller doesn't have the permissions to make this call. </span>
00551 <span class="comment">    You need to be logged on as Local System in order to call this API.</span>
00552 <span class="comment"></span>
00553 <span class="comment">    STATUS_ACCESS_VIOLATION is returned if the Seed could not be read.</span>
00554 <span class="comment">    </span>
00555 <span class="comment">--*/</span>
00556 {
00557     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00558     LUID AuthenticationId;
00559     <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">SECURITY_SUBJECT_CONTEXT</a> SubjectContext;
00560     LUID SystemLuid = SYSTEM_LUID;
00561     BOOLEAN CapturedSubjectContext = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00562     
00563     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00564 
00565     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetPreviousMode() != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>);
00566 
00567     <span class="keywordflow">try</span> {
00568         <span class="comment">//</span>
00569         <span class="comment">// Check if the caller has the appropriate permission</span>
00570         <span class="comment">//</span>
00571         <a class="code" href="../../d0/d8/subject_8c.html#a0">SeCaptureSubjectContext</a>(&amp;SubjectContext); 
00572         CapturedSubjectContext = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00573 
00574         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a1">SeQueryAuthenticationIdToken</a>(
00575                              <a class="code" href="../../d0/d5/se_8h.html#a16">SeQuerySubjectContextToken</a>(&amp;SubjectContext),
00576                              &amp;AuthenticationId);
00577         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00578             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00579             }
00580         
00581         <span class="keywordflow">if</span> (RtlCompareMemory(&amp;AuthenticationId, &amp;SystemLuid, <span class="keyword">sizeof</span>(LUID)) != <span class="keyword">sizeof</span>(LUID)) {
00582             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>(STATUS_ACCESS_DENIED);
00583             }
00584 
00585         <span class="comment">//</span>
00586         <span class="comment">// Store the UUID seed</span>
00587         <span class="comment">//</span>
00588         <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(<a class="code" href="../../d4/d4/tprefix_8c.html#a2">Seed</a>, <a class="code" href="../../d3/d3/uuid_8c.html#a8">SEED_SIZE</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>));
00589         RtlCopyMemory(&amp;<a class="code" href="../../d3/d3/uuid_8c.html#a13">ExpUuidCachedValues</a>.<a class="code" href="../../d8/d4/struct__UUID__CACHED__VALUES__STRUCT.html#o4">NodeId</a>[0], <a class="code" href="../../d4/d4/tprefix_8c.html#a2">Seed</a>, <a class="code" href="../../d3/d3/uuid_8c.html#a8">SEED_SIZE</a>);
00590 
00591         <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d4/tprefix_8c.html#a2">Seed</a>[0] &amp; 0x80) == 0)
00592             {
00593             <span class="comment">// If the high bit is not set the NodeId is a valid IEEE 802</span>
00594             <span class="comment">// address and should be globally unique.</span>
00595             <a class="code" href="../../d3/d3/uuid_8c.html#a12">ExpUuidCacheValid</a> = <a class="code" href="../../d3/d3/uuid_8c.html#a7">CACHE_VALID</a>;
00596             }
00597         <span class="keywordflow">else</span>
00598             {
00599             <a class="code" href="../../d3/d3/uuid_8c.html#a12">ExpUuidCacheValid</a> = <a class="code" href="../../d3/d3/uuid_8c.html#a6">CACHE_LOCAL_ONLY</a>;
00600             }
00601         
00602         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00603     }
00604     except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00605         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00606     }
00607 
00608     <span class="keywordflow">if</span> (CapturedSubjectContext) {
00609         <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a>( &amp;SubjectContext );
00610         }
00611 
00612     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00613 }
00614 
00615 
00616 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00617"></a><a class="code" href="../../d3/d3/uuid_8c.html#a25">00617</a> <a class="code" href="../../d3/d3/uuid_8c.html#a25">NtAllocateUuids</a> (
00618     OUT PULARGE_INTEGER Time,
00619     OUT PULONG Range,
00620     OUT PULONG Sequence,
00621     OUT PCHAR Seed
00622     )
00623 
00624 <span class="comment">/*++</span>
00625 <span class="comment"></span>
00626 <span class="comment">Routine Description:</span>
00627 <span class="comment"></span>
00628 <span class="comment">    This function reserves a range of time for the caller(s) to use for</span>
00629 <span class="comment">    handing out Uuids.  As far a possible the same range of time and</span>
00630 <span class="comment">    sequence number will never be given out.</span>
00631 <span class="comment"></span>
00632 <span class="comment">    (It's possible to reboot 2^14-1 times and set the clock backwards and then</span>
00633 <span class="comment">    call this allocator and get a duplicate.  Since only the low 14bits of the</span>
00634 <span class="comment">    sequence number are used in a real uuid.)</span>
00635 <span class="comment"></span>
00636 <span class="comment">Arguments:</span>
00637 <span class="comment"></span>
00638 <span class="comment">    Time - Supplies the address of a variable that will receive the</span>
00639 <span class="comment">        start time (SYSTEMTIME format) of the range of time reserved.</span>
00640 <span class="comment"></span>
00641 <span class="comment">    Range - Supplies the address of a variable that will receive the</span>
00642 <span class="comment">        number of ticks (100ns) reserved after the value in Time.</span>
00643 <span class="comment">        The range reserved is *Time to (*Time + *Range - 1).</span>
00644 <span class="comment"></span>
00645 <span class="comment">    Sequence - Supplies the address of a variable that will receive</span>
00646 <span class="comment">        the time sequence number.  This value is used with the associated</span>
00647 <span class="comment">        range of time to prevent problems with clocks going backwards.</span>
00648 <span class="comment"></span>
00649 <span class="comment">    Seed - Pointer to a 6 byte buffer. The current seed is written into this buffer.</span>
00650 <span class="comment">    </span>
00651 <span class="comment">Return Value:</span>
00652 <span class="comment"></span>
00653 <span class="comment">    STATUS_SUCCESS is returned if the service is successfully executed.</span>
00654 <span class="comment"></span>
00655 <span class="comment">    STATUS_RETRY is returned if we're unable to reserve a range of</span>
00656 <span class="comment">        UUIDs.  This may (?) occur if system clock hasn't advanced</span>
00657 <span class="comment">        and the allocator is out of cached values.</span>
00658 <span class="comment"></span>
00659 <span class="comment">    STATUS_ACCESS_VIOLATION is returned if the output parameter for the</span>
00660 <span class="comment">        UUID cannot be written.</span>
00661 <span class="comment"></span>
00662 <span class="comment">    STATUS_UNSUCCESSFUL is returned if some other service reports</span>
00663 <span class="comment">        an error, most likly the registery.</span>
00664 <span class="comment"></span>
00665 <span class="comment">--*/</span>
00666 
00667 {
00668 
00669     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00670     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00671 
00672     LARGE_INTEGER OutputTime;
00673     ULONG OutputRange;
00674     ULONG OutputSequence;
00675 
00676     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00677 
00678     <span class="comment">//</span>
00679     <span class="comment">// Establish an exception handler and attempt to write the output</span>
00680     <span class="comment">// arguments. If the write attempt fails, then return</span>
00681     <span class="comment">// the exception code as the service status. Otherwise return success</span>
00682     <span class="comment">// as the service status.</span>
00683     <span class="comment">//</span>
00684 
00685     <span class="keywordflow">try</span> {
00686 
00687         <span class="comment">//</span>
00688         <span class="comment">// Get previous processor mode and probe arguments if necessary.</span>
00689         <span class="comment">//</span>
00690 
00691         PreviousMode = KeGetPreviousMode();
00692         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00693             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>((PVOID)<a class="code" href="../../d6/d6/ttime_8c.html#a14">Time</a>, <span class="keyword">sizeof</span>(LARGE_INTEGER), <span class="keyword">sizeof</span>(ULONG));
00694             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>((PVOID)Range, <span class="keyword">sizeof</span>(ULONG), <span class="keyword">sizeof</span>(ULONG));
00695             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>((PVOID)Sequence, <span class="keyword">sizeof</span>(ULONG), <span class="keyword">sizeof</span>(ULONG));
00696             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>((PVOID)<a class="code" href="../../d4/d4/tprefix_8c.html#a2">Seed</a>, <a class="code" href="../../d3/d3/uuid_8c.html#a8">SEED_SIZE</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>));
00697             }
00698         }
00699     except (<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00700         <span class="keywordflow">return</span> GetExceptionCode();
00701         }
00702 
00703     <span class="comment">// Take the lock, because we're about to update the UUID cache.</span>
00704 
00705     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00706     <a class="code" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe</a>(&amp;<a class="code" href="../../d3/d3/uuid_8c.html#a17">ExpUuidLock</a>);
00707 
00708     <span class="comment">// Get the sequence number and a range of times that can</span>
00709     <span class="comment">// be used in UUID-generation.</span>
00710 
00711     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d3/uuid_8c.html#a23">ExpAllocateUuids</a>( &amp;OutputTime, &amp;OutputRange, &amp;OutputSequence );
00712 
00713     <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
00714         <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a>(&amp;<a class="code" href="../../d3/d3/uuid_8c.html#a17">ExpUuidLock</a>);
00715         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00716         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00717         }
00718 
00719     <span class="comment">// If necessary, save the sequence number.  If there's an error,</span>
00720     <span class="comment">// we'll just leave it marked as dirty, and retry on some future call.</span>
00721 
00722     <a class="code" href="../../d3/d3/uuid_8c.html#a20">ExpUuidSaveSequenceNumberIf</a>();
00723 
00724     <span class="comment">// Release the lock</span>
00725     <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a>(&amp;<a class="code" href="../../d3/d3/uuid_8c.html#a17">ExpUuidLock</a>);
00726     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00727 
00728     <span class="comment">//</span>
00729     <span class="comment">// Attempt to store the result of this call into the output parameters.</span>
00730     <span class="comment">// This is done within an exception handler in case output parameters</span>
00731     <span class="comment">// are now invalid.</span>
00732     <span class="comment">//</span>
00733 
00734     <span class="keywordflow">try</span> {
00735         <a class="code" href="../../d6/d6/ttime_8c.html#a14">Time</a>-&gt;QuadPart = OutputTime.QuadPart;
00736         *Range = OutputRange;
00737         *Sequence = OutputSequence;
00738         RtlCopyMemory((PVOID) <a class="code" href="../../d4/d4/tprefix_8c.html#a2">Seed</a>, &amp;<a class="code" href="../../d3/d3/uuid_8c.html#a13">ExpUuidCachedValues</a>.<a class="code" href="../../d8/d4/struct__UUID__CACHED__VALUES__STRUCT.html#o4">NodeId</a>[0], <a class="code" href="../../d3/d3/uuid_8c.html#a8">SEED_SIZE</a>);
00739     }
00740     except (<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00741         <span class="keywordflow">return</span> GetExceptionCode();
00742         }
00743 
00744     <span class="keywordflow">return</span>(STATUS_SUCCESS);
00745 }
00746 
00747 
00748 
00749 
00750 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00751"></a><a class="code" href="../../d3/d3/uuid_8c.html#a21">00751</a> <a class="code" href="../../d3/d3/uuid_8c.html#a21">ExpUuidGetValues</a>(
00752     OUT <a class="code" href="../../d8/d4/struct__UUID__CACHED__VALUES__STRUCT.html">UUID_CACHED_VALUES_STRUCT</a> *Values
00753     )
00754 <span class="comment">/*++</span>
00755 <span class="comment"></span>
00756 <span class="comment">Routine Description:</span>
00757 <span class="comment"></span>
00758 <span class="comment">    This routine allocates a block of UUIDs and stores them in</span>
00759 <span class="comment">    the caller-provided cached-values structure.</span>
00760 <span class="comment"></span>
00761 <span class="comment">    This routine assumes that the current thread has exclusive</span>
00762 <span class="comment">    access to the ExpUuid* values.</span>
00763 <span class="comment"></span>
00764 <span class="comment">    Note that the Time value in this cache is different than the</span>
00765 <span class="comment">    Time value returned by NtAllocateUuids (and ExpAllocateUuids).</span>
00766 <span class="comment">    As a result, the cache must be interpreted differently in</span>
00767 <span class="comment">    order to determine the valid range.  The valid range from</span>
00768 <span class="comment">    these two routines is:</span>
00769 <span class="comment"></span>
00770 <span class="comment">        NtAllocateUuids:  [ Time, Time+Range )</span>
00771 <span class="comment">        ExpUuidGetValues: ( Values.Time-Values.Range, Values.Time ]</span>
00772 <span class="comment"></span>
00773 <span class="comment">Arguments:</span>
00774 <span class="comment"></span>
00775 <span class="comment">    Values - Set to contain everything needed to allocate a block of uuids.</span>
00776 <span class="comment"></span>
00777 <span class="comment">Return Value:</span>
00778 <span class="comment"></span>
00779 <span class="comment">    STATUS_SUCCESS is returned if the service is successfully executed.</span>
00780 <span class="comment"></span>
00781 <span class="comment">    STATUS_RETRY is returned if we're unable to reserve a range of</span>
00782 <span class="comment">        UUIDs.  This will occur if system clock hasn't advanced</span>
00783 <span class="comment">        and the allocator is out of cached values.</span>
00784 <span class="comment"></span>
00785 <span class="comment">    STATUS_NO_MEMORY is returned if we're unable to reserve a range</span>
00786 <span class="comment">        of UUIDs, for some reason other than the clock not advancing.</span>
00787 <span class="comment"></span>
00788 <span class="comment">--*/</span>
00789 {
00790     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00791     LARGE_INTEGER <a class="code" href="../../d6/d6/ttime_8c.html#a14">Time</a>;
00792     ULONG Range;
00793     ULONG Sequence;
00794 
00795     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00796 
00797     <span class="comment">// Allocate a range of times for use in UUIDs.</span>
00798 
00799     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d3/uuid_8c.html#a23">ExpAllocateUuids</a>(&amp;<a class="code" href="../../d6/d6/ttime_8c.html#a14">Time</a>, &amp;Range, &amp;Sequence);
00800 
00801     <span class="keywordflow">if</span> (STATUS_RETRY == <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) {
00802         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00803         }
00804 
00805     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00806         <span class="keywordflow">return</span>(STATUS_NO_MEMORY);
00807         }
00808 
00809     <span class="comment">// ExpAllocateUuids keeps time in SYSTEM_TIME format which is 100ns ticks since</span>
00810     <span class="comment">// Jan 1, 1601.  UUIDs use time in 100ns ticks since Oct 15, 1582.</span>
00811 
00812     <span class="comment">// 17 Days in Oct + 30 (Nov) + 31 (Dec) + 18 years and 5 leap days.</span>
00813 
00814     <a class="code" href="../../d6/d6/ttime_8c.html#a14">Time</a>.QuadPart +=   (ULONGLONG) (1000*1000*10)       <span class="comment">// seconds</span>
00815                      * (ULONGLONG) (60 * 60 * 24)       <span class="comment">// days</span>
00816                      * (ULONGLONG) (17+30+31+365*18+5); <span class="comment">// # of days</span>
00817 
00818     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Range);
00819 
00820     Values-&gt;ClockSeqHiAndReserved =
00821         <a class="code" href="../../d3/d3/uuid_8c.html#a4">UUID_RESERVED</a> | (((UCHAR) (Sequence &gt;&gt; 8))
00822         &amp; (UCHAR) <a class="code" href="../../d3/d3/uuid_8c.html#a5">UUID_CLOCK_SEQ_HI_MASK</a>);
00823 
00824     Values-&gt;ClockSeqLow = (UCHAR) (Sequence &amp; 0x00FF);
00825 
00826 
00827     <span class="comment">// We'll modify the Time value so that it indicates the</span>
00828     <span class="comment">// end of the range rather than the beginning of it.</span>
00829 
00830     <span class="comment">// The order of these assignments is important</span>
00831 
00832     Values-&gt;Time = <a class="code" href="../../d6/d6/ttime_8c.html#a14">Time</a>.QuadPart + (Range - 1);
00833     Values-&gt;AllocatedCount = Range;
00834 
00835     <span class="keywordflow">return</span>(STATUS_SUCCESS);
00836 }
00837 
00838 
00839 
00840 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00841"></a><a class="code" href="../../d5/d8/ex_8h.html#a324">00841</a> <a class="code" href="../../d5/d8/ex_8h.html#a324">ExUuidCreate</a>(
00842     OUT <a class="code" href="../../d5/d8/ex_8h.html#a172">UUID</a> *Uuid
00843     )
00844 
00845 <span class="comment">/*++</span>
00846 <span class="comment"></span>
00847 <span class="comment">Routine Description:</span>
00848 <span class="comment"></span>
00849 <span class="comment">    This routine creates a DCE UUID and returns it in the caller's</span>
00850 <span class="comment">    buffer.</span>
00851 <span class="comment"></span>
00852 <span class="comment">Arguments:</span>
00853 <span class="comment"></span>
00854 <span class="comment">    Uuid - will receive the UUID.</span>
00855 <span class="comment"></span>
00856 <span class="comment">Return Value:</span>
00857 <span class="comment"></span>
00858 <span class="comment">    STATUS_SUCCESS is returned if the service is successfully executed.</span>
00859 <span class="comment"></span>
00860 <span class="comment">    STATUS_RETRY is returned if we're unable to reserve a range of</span>
00861 <span class="comment">        UUIDs.  This will occur if system clock hasn't advanced</span>
00862 <span class="comment">        and the allocator is out of cached values.</span>
00863 <span class="comment"></span>
00864 <span class="comment">--*/</span>
00865 
00866 {
00867     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00868 
00869     <a class="code" href="../../d9/d4/struct__UUID__GENERATE.html">UUID_GENERATE</a>  *UuidGen = (<a class="code" href="../../d9/d4/struct__UUID__GENERATE.html">UUID_GENERATE</a> *) Uuid;
00870     ULONGLONG       <a class="code" href="../../d6/d6/ttime_8c.html#a14">Time</a>;
00871     LONG            Delta;
00872 
00873     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00874 
00875     <span class="comment">//</span>
00876     <span class="comment">// Get a value from the cache.  If the cache is empty, we'll fill</span>
00877     <span class="comment">// it and retry.  The first time cache will be empty.</span>
00878     <span class="comment">//</span>
00879 
00880     <span class="keywordflow">for</span>(;;) {
00881 
00882         <span class="comment">// Get the highest value in the cache (though it may not</span>
00883         <span class="comment">// be available).</span>
00884         <a class="code" href="../../d6/d6/ttime_8c.html#a14">Time</a> = <a class="code" href="../../d3/d3/uuid_8c.html#a13">ExpUuidCachedValues</a>.<a class="code" href="../../d8/d4/struct__UUID__CACHED__VALUES__STRUCT.html#o0">Time</a>;
00885 
00886         <span class="comment">// Copy the static info into the UUID.  We can't do this later</span>
00887         <span class="comment">// because the clock sequence could be updated by another thread.</span>
00888 
00889         *(PULONG)&amp;UuidGen-&gt;<a class="code" href="../../d9/d4/struct__UUID__GENERATE.html#o3">ClockSeqHiAndReserved</a> =
00890             *(PULONG)&amp;<a class="code" href="../../d3/d3/uuid_8c.html#a13">ExpUuidCachedValues</a>.<a class="code" href="../../d8/d4/struct__UUID__CACHED__VALUES__STRUCT.html#o2">ClockSeqHiAndReserved</a>;
00891         *(PULONG)&amp;UuidGen-&gt;<a class="code" href="../../d9/d4/struct__UUID__GENERATE.html#o5">NodeId</a>[2] =
00892             *(PULONG)&amp;<a class="code" href="../../d3/d3/uuid_8c.html#a13">ExpUuidCachedValues</a>.<a class="code" href="../../d8/d4/struct__UUID__CACHED__VALUES__STRUCT.html#o4">NodeId</a>[2];
00893 
00894         <span class="comment">// See what we need to subtract from Time to get a valid GUID.</span>
00895         Delta = InterlockedDecrement(&amp;<a class="code" href="../../d3/d3/uuid_8c.html#a13">ExpUuidCachedValues</a>.<a class="code" href="../../d8/d4/struct__UUID__CACHED__VALUES__STRUCT.html#o1">AllocatedCount</a>);
00896 
00897         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/ttime_8c.html#a14">Time</a> != <a class="code" href="../../d3/d3/uuid_8c.html#a13">ExpUuidCachedValues</a>.<a class="code" href="../../d8/d4/struct__UUID__CACHED__VALUES__STRUCT.html#o0">Time</a>) {
00898 
00899             <span class="comment">// If our captured time doesn't match the cache then another</span>
00900             <span class="comment">// thread already took the lock and updated the cache. We'll</span>
00901             <span class="comment">// just loop and try again.</span>
00902             <span class="keywordflow">continue</span>;
00903             }
00904 
00905         <span class="comment">// If the cache hadn't already run dry, we can break out of this retry</span>
00906         <span class="comment">// loop.</span>
00907         <span class="keywordflow">if</span> (Delta &gt;= 0) {
00908             <span class="keywordflow">break</span>;
00909             }
00910 
00911         <span class="comment">//</span>
00912         <span class="comment">// Allocate a new block of Uuids.</span>
00913         <span class="comment">//</span>
00914 
00915         <span class="comment">// Take the cache lock</span>
00916         <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00917         <a class="code" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe</a>(&amp;<a class="code" href="../../d3/d3/uuid_8c.html#a17">ExpUuidLock</a>);
00918 
00919         <span class="comment">// If the cache has already been updated, try again.</span>
00920         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/ttime_8c.html#a14">Time</a> != <a class="code" href="../../d3/d3/uuid_8c.html#a13">ExpUuidCachedValues</a>.<a class="code" href="../../d8/d4/struct__UUID__CACHED__VALUES__STRUCT.html#o0">Time</a>) {
00921             <span class="comment">// Release the lock</span>
00922             <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a>(&amp;<a class="code" href="../../d3/d3/uuid_8c.html#a17">ExpUuidLock</a>);
00923             <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00924             <span class="keywordflow">continue</span>;
00925             }
00926 
00927         <span class="comment">// Update the cache.</span>
00928         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d3/uuid_8c.html#a21">ExpUuidGetValues</a>( &amp;<a class="code" href="../../d3/d3/uuid_8c.html#a13">ExpUuidCachedValues</a> );
00929 
00930         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) {
00931             <span class="comment">// Release the lock</span>
00932             <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a>(&amp;<a class="code" href="../../d3/d3/uuid_8c.html#a17">ExpUuidLock</a>);
00933             <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00934             <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00935             }
00936 
00937         <span class="comment">// The sequence number may have been dirtied, see if it needs</span>
00938         <span class="comment">// to be saved.  If there's an error, we'll ignore it and</span>
00939         <span class="comment">// retry on a future call.</span>
00940 
00941         <a class="code" href="../../d3/d3/uuid_8c.html#a20">ExpUuidSaveSequenceNumberIf</a>();
00942 
00943         <span class="comment">// Release the lock</span>
00944         <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a>(&amp;<a class="code" href="../../d3/d3/uuid_8c.html#a17">ExpUuidLock</a>);
00945         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00946 
00947         <span class="comment">// Loop</span>
00948         }
00949 
00950     <span class="comment">// Adjust the time to that of the next available UUID.</span>
00951     <a class="code" href="../../d6/d6/ttime_8c.html#a14">Time</a> -= Delta;
00952 
00953     <span class="comment">// Finish filling in the UUID.</span>
00954 
00955     UuidGen-&gt;<a class="code" href="../../d9/d4/struct__UUID__GENERATE.html#o0">TimeLow</a> = (ULONG) <a class="code" href="../../d6/d6/ttime_8c.html#a14">Time</a>;
00956     UuidGen-&gt;<a class="code" href="../../d9/d4/struct__UUID__GENERATE.html#o1">TimeMid</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) (<a class="code" href="../../d6/d6/ttime_8c.html#a14">Time</a> &gt;&gt; 32);
00957     UuidGen-&gt;<a class="code" href="../../d9/d4/struct__UUID__GENERATE.html#o2">TimeHiAndVersion</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)
00958         (( (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(<a class="code" href="../../d6/d6/ttime_8c.html#a14">Time</a> &gt;&gt; (32+16))
00959         &amp; <a class="code" href="../../d3/d3/uuid_8c.html#a2">UUID_TIME_HIGH_MASK</a>) | <a class="code" href="../../d3/d3/uuid_8c.html#a3">UUID_VERSION</a>);
00960 
00961     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS);
00962 
00963     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d3/uuid_8c.html#a12">ExpUuidCacheValid</a> == <a class="code" href="../../d3/d3/uuid_8c.html#a6">CACHE_LOCAL_ONLY</a>) {
00964         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = RPC_NT_UUID_LOCAL_ONLY;
00965         }
00966 
00967     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00968 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:42:17 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
