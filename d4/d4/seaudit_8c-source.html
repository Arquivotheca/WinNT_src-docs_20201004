<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: seaudit.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>seaudit.c</h1><a href="../../d3/d5/seaudit_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    seaudit.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This Module implements the audit and alarm procedures.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Robert Reichel      (robertre)     26-Nov-90</span>
00016 <span class="comment">    Scott Birrell       (ScottBi)      17-Jan-92</span>
00017 <span class="comment"></span>
00018 <span class="comment">Environment:</span>
00019 <span class="comment"></span>
00020 <span class="comment">    Kernel Mode</span>
00021 <span class="comment"></span>
00022 <span class="comment">Revision History:</span>
00023 <span class="comment"></span>
00024 <span class="comment">    Richard Ward        (richardw)     14-Apr-92</span>
00025 <span class="comment"></span>
00026 <span class="comment">--*/</span>
00027 
00028 <span class="preprocessor">#include "<a class="code" href="../../d8/d3/tokenp_8h.html">tokenp.h</a>"</span>
00029 <span class="preprocessor">#include "<a class="code" href="../../d7/d4/adt_8h.html">adt.h</a>"</span>
00030 <span class="preprocessor">#include "<a class="code" href="../../d1/d5/adtp_8h.html">adtp.h</a>"</span>
00031 <span class="preprocessor">#include &lt;sertlp.h&gt;</span>
00032 
00033 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00034 <a class="code" href="../../d3/d5/seaudit_8c.html#a5">SepProbeAndCaptureString_U</a> (
00035     IN PUNICODE_STRING SourceString,
00036     OUT PUNICODE_STRING *DestString
00037     );
00038 
00039 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00040 <a class="code" href="../../d3/d5/seaudit_8c.html#a6">SepFreeCapturedString</a>(
00041     IN PUNICODE_STRING CapturedString
00042     );
00043 
00044 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00045 <a class="code" href="../../d3/d5/seaudit_8c.html#a7">SepAuditTypeList</a> (
00046     IN <a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">PIOBJECT_TYPE_LIST</a> ObjectTypeList,
00047     IN ULONG ObjectTypeListLength,
00048     IN PNTSTATUS AccessStatus,
00049     IN ULONG StartIndex,
00050     OUT PBOOLEAN GenerateSuccessAudit,
00051     OUT PBOOLEAN GenerateFailureAudit
00052     );
00053 
00054 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00055 <a class="code" href="../../d3/d5/seaudit_8c.html#a8">SepExamineSaclEx</a>(
00056     IN PACL Sacl,
00057     IN PACCESS_TOKEN Token,
00058     IN ACCESS_MASK DesiredAccess,
00059     IN <a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">PIOBJECT_TYPE_LIST</a> ObjectTypeList OPTIONAL,
00060     IN ULONG ObjectTypeListLength,
00061     IN BOOLEAN ReturnResultList,
00062     IN PNTSTATUS AccessStatus,
00063     IN PACCESS_MASK GrantedAccess,
00064     OUT PBOOLEAN GenerateSuccessAudit,
00065     OUT PBOOLEAN GenerateFailureAudit
00066     );
00067 
00068 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00069 <a class="code" href="../../d3/d5/seaudit_8c.html#a9">SepAccessCheckAndAuditAlarm</a> (
00070     IN PUNICODE_STRING SubsystemName,
00071     IN PVOID HandleId,
00072     IN PHANDLE ClientToken OPTIONAL,
00073     IN PUNICODE_STRING ObjectTypeName,
00074     IN PUNICODE_STRING ObjectName,
00075     IN PSECURITY_DESCRIPTOR SecurityDescriptor,
00076     IN PSID PrincipalSelfSid,
00077     IN ACCESS_MASK DesiredAccess,
00078     IN AUDIT_EVENT_TYPE AuditType,
00079     IN ULONG Flags,
00080     IN POBJECT_TYPE_LIST ObjectTypeList OPTIONAL,
00081     IN ULONG ObjectTypeListLength,
00082     IN PGENERIC_MAPPING GenericMapping,
00083     IN BOOLEAN ObjectCreation,
00084     OUT PACCESS_MASK GrantedAccess,
00085     OUT PNTSTATUS AccessStatus,
00086     OUT PBOOLEAN GenerateOnClose,
00087     IN BOOLEAN ReturnResultList
00088     );
00089 
00090 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00091 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtAccessCheckAndAuditAlarm)</span>
00092 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtAccessCheckByTypeAndAuditAlarm)</span>
00093 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtAccessCheckByTypeResultListAndAuditAlarm)</span>
00094 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtAccessCheckByTypeResultListAndAuditAlarmByHandle)</span>
00095 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtCloseObjectAuditAlarm)</span>
00096 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtDeleteObjectAuditAlarm)</span>
00097 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtOpenObjectAuditAlarm)</span>
00098 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtPrivilegeObjectAuditAlarm)</span>
00099 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtPrivilegedServiceAuditAlarm)</span>
00100 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SeAuditHandleCreation)</span>
00101 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SeAuditingFileEvents)</span>
00102 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SeCheckAuditPrivilege)</span>
00103 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SeCloseObjectAuditAlarm)</span>
00104 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SeDeleteObjectAuditAlarm)</span>
00105 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SeCreateObjectAuditAlarm)</span>
00106 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SeObjectReferenceAuditAlarm)</span>
00107 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SeOpenObjectAuditAlarm)</span>
00108 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SePrivilegeObjectAuditAlarm)</span>
00109 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SePrivilegedServiceAuditAlarm)</span>
00110 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SeTraverseAuditAlarm)</span>
00111 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SepAccessCheckAndAuditAlarm)</span>
00112 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SepExamineSacl)</span>
00113 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SepExamineSaclEx)</span>
00114 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SepAuditTypeList)</span>
00115 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SepFilterPrivilegeAudits)</span>
00116 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SepFreeCapturedString)</span>
00117 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SepProbeAndCaptureString_U)</span>
00118 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SepSinglePrivilegeCheck)</span>
00119 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00120 <span class="preprocessor"></span>
00121 <span class="comment">//</span>
00122 <span class="comment">// Flag to tell us if we are auditing shutdown events.</span>
00123 <span class="comment">//</span>
00124 <span class="comment">// Move this to seglobal.c</span>
00125 <span class="comment">//</span>
00126 
<a name="l00127"></a><a class="code" href="../../d3/d5/seaudit_8c.html#a1">00127</a> BOOLEAN <a class="code" href="../../d3/d5/seaudit_8c.html#a1">SepAuditShutdownEvents</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00128 
00129 
00130 <span class="comment">//</span>
00131 <span class="comment">//  Private useful routines</span>
00132 <span class="comment">//</span>
00133 
00134 <span class="comment">//</span>
00135 <span class="comment">// This routine is to be called to do simple checks of single privileges</span>
00136 <span class="comment">// against the passed token.</span>
00137 <span class="comment">//</span>
00138 <span class="comment">// DO NOT CALL THIS TO CHECK FOR SeTcbPrivilege SINCE THAT MUST</span>
00139 <span class="comment">// BE CHECKED AGAINST THE PRIMARY TOKEN ONLY!</span>
00140 <span class="comment">//</span>
00141 
00142 BOOLEAN
<a name="l00143"></a><a class="code" href="../../d6/d6/sep_8h.html#a49">00143</a> <a class="code" href="../../d6/d6/sep_8h.html#a49">SepSinglePrivilegeCheck</a> (
00144    LUID DesiredPrivilege,
00145    IN PACCESS_TOKEN Token,
00146    IN KPROCESSOR_MODE PreviousMode
00147    )
00148 
00149 <span class="comment">/*++</span>
00150 <span class="comment"></span>
00151 <span class="comment">Routine Description:</span>
00152 <span class="comment"></span>
00153 <span class="comment">    Determines if the passed token has the passed privilege.</span>
00154 <span class="comment"></span>
00155 <span class="comment">Arguments:</span>
00156 <span class="comment"></span>
00157 <span class="comment">    DesiredPrivilege - The privilege to be tested for.</span>
00158 <span class="comment"></span>
00159 <span class="comment">    Token - The token being examined.</span>
00160 <span class="comment"></span>
00161 <span class="comment">    PreviousMode - The previous processor mode.</span>
00162 <span class="comment"></span>
00163 <span class="comment">Return Value:</span>
00164 <span class="comment"></span>
00165 <span class="comment">    Returns TRUE of the subject has the passed privilege, FALSE otherwise.</span>
00166 <span class="comment"></span>
00167 <span class="comment">--*/</span>
00168 
00169 {
00170 
00171    LUID_AND_ATTRIBUTES Privilege;
00172    BOOLEAN Result;
00173 
00174    <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00175 
00176    <span class="comment">//</span>
00177    <span class="comment">// Don't let anyone call this to test for SeTcbPrivilege</span>
00178    <span class="comment">//</span>
00179 
00180    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!((DesiredPrivilege.LowPart == <a class="code" href="../../d0/d5/se_8h.html#a84">SeTcbPrivilege</a>.LowPart) &amp;&amp;
00181             (DesiredPrivilege.HighPart == <a class="code" href="../../d0/d5/se_8h.html#a84">SeTcbPrivilege</a>.HighPart)));
00182 
00183    Privilege.Luid = DesiredPrivilege;
00184    Privilege.Attributes = 0;
00185 
00186    Result = <a class="code" href="../../d8/d3/tokenp_8h.html#a37">SepPrivilegeCheck</a>(
00187                <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,
00188                &amp;Privilege,
00189                1,
00190                PRIVILEGE_SET_ALL_NECESSARY,
00191                PreviousMode
00192                );
00193 
00194    <span class="keywordflow">return</span>(Result);
00195 }
00196 
00197 
00198 BOOLEAN
<a name="l00199"></a><a class="code" href="../../d3/d5/seaudit_8c.html#a11">00199</a> <a class="code" href="../../d3/d5/seaudit_8c.html#a11">SeCheckAuditPrivilege</a> (
00200    IN <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">PSECURITY_SUBJECT_CONTEXT</a> SubjectSecurityContext,
00201    IN KPROCESSOR_MODE PreviousMode
00202    )
00203 <span class="comment">/*++</span>
00204 <span class="comment"></span>
00205 <span class="comment">Routine Description:</span>
00206 <span class="comment"></span>
00207 <span class="comment">    This routine specifically searches the primary token (rather than</span>
00208 <span class="comment">    the effective token) of the calling process for SeAuditPrivilege.</span>
00209 <span class="comment">    In order to do this it must call the underlying worker</span>
00210 <span class="comment">    SepPrivilegeCheck directly, to ensure that the correct token is</span>
00211 <span class="comment">    searched</span>
00212 <span class="comment"></span>
00213 <span class="comment">Arguments:</span>
00214 <span class="comment"></span>
00215 <span class="comment">    SubjectSecurityContext - The subject being examined.</span>
00216 <span class="comment"></span>
00217 <span class="comment">    PreviousMode - The previous processor mode.</span>
00218 <span class="comment"></span>
00219 <span class="comment">Return Value:</span>
00220 <span class="comment"></span>
00221 <span class="comment">    Returns TRUE if the subject has SeAuditPrivilege, FALSE otherwise.</span>
00222 <span class="comment"></span>
00223 <span class="comment">--*/</span>
00224 {
00225 
00226     PRIVILEGE_SET RequiredPrivileges;
00227     BOOLEAN AccessGranted;
00228 
00229     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00230 
00231     RequiredPrivileges.PrivilegeCount = 1;
00232     RequiredPrivileges.Control = PRIVILEGE_SET_ALL_NECESSARY;
00233     RequiredPrivileges.Privilege[0].Luid = <a class="code" href="../../d0/d5/se_8h.html#a98">SeAuditPrivilege</a>;
00234     RequiredPrivileges.Privilege[0].Attributes = 0;
00235 
00236     AccessGranted = <a class="code" href="../../d8/d3/tokenp_8h.html#a37">SepPrivilegeCheck</a>(
00237                         SubjectSecurityContext-&gt;PrimaryToken,     <span class="comment">// token</span>
00238                         RequiredPrivileges.Privilege,             <span class="comment">// privilege set</span>
00239                         RequiredPrivileges.PrivilegeCount,        <span class="comment">// privilege count</span>
00240                         PRIVILEGE_SET_ALL_NECESSARY,              <span class="comment">// privilege control</span>
00241                         PreviousMode                              <span class="comment">// previous mode</span>
00242                         );
00243 
00244     <span class="keywordflow">if</span> ( PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a> ) {
00245 
00246         <a class="code" href="../../d3/d5/seaudit_8c.html#a15">SePrivilegedServiceAuditAlarm</a> (
00247             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                              <span class="comment">// BUGWARNING need service name</span>
00248             SubjectSecurityContext,
00249             &amp;RequiredPrivileges,
00250             AccessGranted
00251             );
00252     }
00253 
00254     <span class="keywordflow">return</span>( AccessGranted );
00255 }
00256 
00257 
00258 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00259"></a><a class="code" href="../../d3/d5/seaudit_8c.html#a5">00259</a> <a class="code" href="../../d3/d5/seaudit_8c.html#a5">SepProbeAndCaptureString_U</a> (
00260     IN PUNICODE_STRING SourceString,
00261     OUT PUNICODE_STRING *DestString
00262     )
00263 <span class="comment">/*++</span>
00264 <span class="comment"></span>
00265 <span class="comment">Routine Description:</span>
00266 <span class="comment"></span>
00267 <span class="comment">    Helper routine to probe and capture a Unicode string argument.</span>
00268 <span class="comment"></span>
00269 <span class="comment">    This routine may fail due to lack of memory, in which case,</span>
00270 <span class="comment">    it will return a NULL pointer in the output parameter.</span>
00271 <span class="comment"></span>
00272 <span class="comment">Arguments:</span>
00273 <span class="comment"></span>
00274 <span class="comment">    SourceString - Pointer to a Unicode string to be captured.</span>
00275 <span class="comment"></span>
00276 <span class="comment">    DestString - Returns a pointer to a captured Unicode string.  This</span>
00277 <span class="comment">        will be one contiguous structure, and thus may be freed by</span>
00278 <span class="comment">        a single call to ExFreePool().</span>
00279 <span class="comment"></span>
00280 <span class="comment">Return Value:</span>
00281 <span class="comment"></span>
00282 <span class="comment">    None.</span>
00283 <span class="comment"></span>
00284 <span class="comment">--*/</span>
00285 {
00286 
00287     UNICODE_STRING InputString;
00288     ULONG Length;
00289     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00290 
00291     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00292 
00293     <span class="comment">//</span>
00294     <span class="comment">// Initialize the object name descriptor and capture the specified name</span>
00295     <span class="comment">// string.</span>
00296     <span class="comment">//</span>
00297 
00298     *<a class="code" href="../../d0/d2/usrbench_8h.html#a35">DestString</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00299 
00300     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00301     <span class="keywordflow">try</span> {
00302 
00303         <span class="comment">//</span>
00304         <span class="comment">// Probe and capture the name string descriptor and probe the</span>
00305         <span class="comment">// name string, if necessary.</span>
00306         <span class="comment">//</span>
00307 
00308         InputString = <a class="code" href="../../d5/d8/ex_8h.html#a26">ProbeAndReadUnicodeString</a>(<a class="code" href="../../d0/d2/usrbench_8h.html#a33">SourceString</a>);
00309         <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(InputString.Buffer,
00310                      InputString.Length,
00311                      <span class="keyword">sizeof</span>(WCHAR));
00312 
00313 
00314 
00315         <span class="comment">//</span>
00316         <span class="comment">// If the length of the string is not an even multiple of the</span>
00317         <span class="comment">// size of a UNICODE character or cannot be zero terminated,</span>
00318         <span class="comment">// then return an error.</span>
00319         <span class="comment">//</span>
00320 
00321         Length = InputString.Length;
00322         <span class="keywordflow">if</span> (((Length &amp; (<span class="keyword">sizeof</span>(WCHAR) - 1)) != 0) ||
00323             (Length == (MAXUSHORT - <span class="keyword">sizeof</span>(WCHAR) + 1))) {
00324             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00325 
00326         } <span class="keywordflow">else</span> {
00327 
00328             <span class="comment">//</span>
00329             <span class="comment">// Allocate a buffer for the specified name string.</span>
00330             <span class="comment">//</span>
00331 
00332             *<a class="code" href="../../d0/d2/usrbench_8h.html#a35">DestString</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
00333                             <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00334                             InputString.Length + <span class="keyword">sizeof</span>(UNICODE_STRING),
00335                             'sUeS');
00336 
00337             <span class="keywordflow">if</span> (*<a class="code" href="../../d0/d2/usrbench_8h.html#a35">DestString</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00338                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00339 
00340             } <span class="keywordflow">else</span> {
00341                 (*DestString)-&gt;Length = InputString.Length;
00342                 (*DestString)-&gt;MaximumLength = InputString.Length;
00343                 (*DestString)-&gt;Buffer = (PWSTR) ((*DestString) + 1);
00344 
00345                 <span class="keywordflow">if</span> (InputString.Length != 0) {
00346 
00347                     RtlCopyMemory(
00348                         (*DestString)-&gt;Buffer,
00349                         InputString.Buffer,
00350                         InputString.Length);
00351                 }
00352 
00353             }
00354         }
00355 
00356     } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00357         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00358         <span class="keywordflow">if</span> (*<a class="code" href="../../d0/d2/usrbench_8h.html#a35">DestString</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00359             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(*<a class="code" href="../../d0/d2/usrbench_8h.html#a35">DestString</a>);
00360             *<a class="code" href="../../d0/d2/usrbench_8h.html#a35">DestString</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00361         }
00362     }
00363 
00364     <span class="keywordflow">return</span>;
00365 
00366 }
00367 
00368 
00369 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00370"></a><a class="code" href="../../d3/d5/seaudit_8c.html#a6">00370</a> <a class="code" href="../../d3/d5/seaudit_8c.html#a6">SepFreeCapturedString</a>(
00371     IN PUNICODE_STRING CapturedString
00372     )
00373 
00374 <span class="comment">/*++</span>
00375 <span class="comment"></span>
00376 <span class="comment">Routine Description:</span>
00377 <span class="comment"></span>
00378 <span class="comment">    Frees a string captured by SepProbeAndCaptureString.</span>
00379 <span class="comment"></span>
00380 <span class="comment">Arguments:</span>
00381 <span class="comment"></span>
00382 <span class="comment">    CapturedString - Supplies a pointer to a string previously captured</span>
00383 <span class="comment">        by SepProbeAndCaptureString.</span>
00384 <span class="comment"></span>
00385 <span class="comment">Return Value:</span>
00386 <span class="comment"></span>
00387 <span class="comment">    None.</span>
00388 <span class="comment"></span>
00389 <span class="comment">--*/</span>
00390 
00391 {
00392     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00393 
00394     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( CapturedString );
00395     <span class="keywordflow">return</span>;
00396 }
00397 
00399 <span class="comment">//                                                                    //</span>
00400 <span class="comment">//                  Privileged Object Audit Alarms                    //</span>
00401 <span class="comment">//                                                                    //</span>
00403 <span class="comment"></span>
00404 
00405 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00406"></a><a class="code" href="../../d3/d5/seaudit_8c.html#a12">00406</a> <a class="code" href="../../d3/d5/seaudit_8c.html#a12">NtPrivilegeObjectAuditAlarm</a> (
00407     IN PUNICODE_STRING SubsystemName,
00408     IN PVOID HandleId,
00409     IN HANDLE ClientToken,
00410     IN ACCESS_MASK DesiredAccess,
00411     IN PPRIVILEGE_SET Privileges,
00412     IN BOOLEAN AccessGranted
00413     )
00414 <span class="comment">/*++</span>
00415 <span class="comment"></span>
00416 <span class="comment">Routine Description:</span>
00417 <span class="comment"></span>
00418 <span class="comment">    This routine is used to generate audit and alarm messages when an</span>
00419 <span class="comment">    attempt is made to perform privileged operations on a protected</span>
00420 <span class="comment">    subsystem object after the object is already opened.  This routine may</span>
00421 <span class="comment">    result in several messages being generated and sent to Port objects.</span>
00422 <span class="comment">    This may result in a significant latency before returning.  Design of</span>
00423 <span class="comment">    routines that must call this routine must take this potential latency</span>
00424 <span class="comment">    into account.  This may have an impact on the approach taken for data</span>
00425 <span class="comment">    structure mutex locking, for example.</span>
00426 <span class="comment"></span>
00427 <span class="comment">    This API requires the caller have SeAuditPrivilege privilege.  The test</span>
00428 <span class="comment">    for this privilege is always against the primary token of the calling</span>
00429 <span class="comment">    process, allowing the caller to be impersonating a client during the</span>
00430 <span class="comment">    call with no ill effects.</span>
00431 <span class="comment"></span>
00432 <span class="comment">Arguments:</span>
00433 <span class="comment"></span>
00434 <span class="comment">    SubsystemName - Supplies a name string identifying the subsystem</span>
00435 <span class="comment">        calling the routine.</span>
00436 <span class="comment"></span>
00437 <span class="comment">    HandleId - A unique value representing the client's handle to the</span>
00438 <span class="comment">        object.</span>
00439 <span class="comment"></span>
00440 <span class="comment">    ClientToken - A handle to a token object representing the client that</span>
00441 <span class="comment">        requested the operation.  This handle must be obtained from a</span>
00442 <span class="comment">        communication session layer, such as from an LPC Port or Local</span>
00443 <span class="comment">        Named Pipe, to prevent possible security policy violations.</span>
00444 <span class="comment"></span>
00445 <span class="comment">    DesiredAccess - The desired access mask.  This mask must have been</span>
00446 <span class="comment">        previously mapped to contain no generic accesses.</span>
00447 <span class="comment"></span>
00448 <span class="comment">    Privileges - The set of privileges required for the requested</span>
00449 <span class="comment">        operation.  Those privileges that were held by the subject are</span>
00450 <span class="comment">        marked using the UsedForAccess flag of the attributes</span>
00451 <span class="comment">        associated with each privilege.</span>
00452 <span class="comment"></span>
00453 <span class="comment">    AccessGranted - Indicates whether the requested access was granted or</span>
00454 <span class="comment">        not.  A value of TRUE indicates the access was granted.  A value of</span>
00455 <span class="comment">        FALSE indicates the access was not granted.</span>
00456 <span class="comment"></span>
00457 <span class="comment">Return value:</span>
00458 <span class="comment"></span>
00459 <span class="comment">--*/</span>
00460 {
00461 
00462     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00463     PUNICODE_STRING CapturedSubsystemName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00464     PPRIVILEGE_SET CapturedPrivileges = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00465     ULONG PrivilegeParameterLength;
00466     ULONG PrivilegeCount;
00467     <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">SECURITY_SUBJECT_CONTEXT</a> SubjectSecurityContext;
00468     BOOLEAN Result;
00469     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
00470     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00471     BOOLEAN AuditPerformed;
00472 
00473     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00474 
00475     PreviousMode = KeGetPreviousMode();
00476 
00477     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>);
00478 
00479     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00480          <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a16">ClientToken</a>,             <span class="comment">// Handle</span>
00481          TOKEN_QUERY,             <span class="comment">// DesiredAccess</span>
00482          <a class="code" href="../../d0/d5/se_8h.html#a36">SepTokenObjectType</a>,      <span class="comment">// ObjectType</span>
00483          PreviousMode,            <span class="comment">// AccessMode</span>
00484          (PVOID *)&amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,         <span class="comment">// Object</span>
00485          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>                     <span class="comment">// GrantedAccess</span>
00486          );
00487 
00488     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00489         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00490     }
00491 
00492     <span class="comment">//</span>
00493     <span class="comment">// If the passed token is an impersonation token, make sure</span>
00494     <span class="comment">// it is at SecurityIdentification or above.</span>
00495     <span class="comment">//</span>
00496 
00497     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;TokenType == TokenImpersonation) {
00498 
00499         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;ImpersonationLevel &lt; SecurityIdentification) {
00500 
00501             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( (PVOID)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00502 
00503             <span class="keywordflow">return</span>( STATUS_BAD_IMPERSONATION_LEVEL );
00504 
00505         }
00506     }
00507 
00508 <span class="comment">//    //</span>
00509 <span class="comment">//    // Make sure the passed token is an impersonation token...</span>
00510 <span class="comment">//    //</span>
00511 <span class="comment">//</span>
00512 <span class="comment">//    if (Token-&gt;TokenType != TokenImpersonation) {</span>
00513 <span class="comment">//</span>
00514 <span class="comment">//        ObDereferenceObject( (PVOID)Token );</span>
00515 <span class="comment">//</span>
00516 <span class="comment">//        return( STATUS_NO_IMPERSONATION_TOKEN );</span>
00517 <span class="comment">//</span>
00518 <span class="comment">//    }</span>
00519 <span class="comment">//</span>
00520 <span class="comment">//    //</span>
00521 <span class="comment">//    //  ...and at a high enough impersonation level</span>
00522 <span class="comment">//    //</span>
00523 <span class="comment">//</span>
00524 <span class="comment">//    if (Token-&gt;ImpersonationLevel &lt; SecurityIdentification) {</span>
00525 <span class="comment">//</span>
00526 <span class="comment">//        ObDereferenceObject( (PVOID)Token );</span>
00527 <span class="comment">//</span>
00528 <span class="comment">//        return( STATUS_BAD_IMPERSONATION_LEVEL );</span>
00529 <span class="comment">//</span>
00530 <span class="comment">//    }</span>
00531 
00532     <span class="comment">//</span>
00533     <span class="comment">// Check for SeAuditPrivilege</span>
00534     <span class="comment">//</span>
00535 
00536     <a class="code" href="../../d0/d8/subject_8c.html#a0">SeCaptureSubjectContext</a> ( &amp;SubjectSecurityContext );
00537 
00538     Result = <a class="code" href="../../d3/d5/seaudit_8c.html#a11">SeCheckAuditPrivilege</a> (
00539                  &amp;SubjectSecurityContext,
00540                  PreviousMode
00541                  );
00542 
00543     <span class="keywordflow">if</span> (!Result) {
00544 
00545         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( (PVOID)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00546         <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a> ( &amp;SubjectSecurityContext );
00547         <span class="keywordflow">return</span>(STATUS_PRIVILEGE_NOT_HELD);
00548 
00549     }
00550 
00551     <span class="keywordflow">try</span> {
00552 
00553         <a class="code" href="../../d3/d5/seaudit_8c.html#a5">SepProbeAndCaptureString_U</a> ( SubsystemName,
00554                                      &amp;CapturedSubsystemName );
00555 
00556         <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(
00557             Privileges,
00558             <span class="keyword">sizeof</span>(PRIVILEGE_SET),
00559             <span class="keyword">sizeof</span>(ULONG)
00560             );
00561         PrivilegeCount = Privileges-&gt;PrivilegeCount;
00562 
00563         <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d6/sep_8h.html#a11">IsValidElementCount</a>(PrivilegeCount, LUID_AND_ATTRIBUTES)) {
00564             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>= STATUS_INVALID_PARAMETER;
00565             leave ;
00566         }
00567         PrivilegeParameterLength = (ULONG)<span class="keyword">sizeof</span>(PRIVILEGE_SET) +
00568                           ((PrivilegeCount - <a class="code" href="../../d5/d4/acpitabl_8h.html#a44">ANYSIZE_ARRAY</a>) *
00569                             (ULONG)<span class="keyword">sizeof</span>(LUID_AND_ATTRIBUTES)  );
00570 
00571         <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(
00572             Privileges,
00573             PrivilegeParameterLength,
00574             <span class="keyword">sizeof</span>(ULONG)
00575             );
00576 
00577         CapturedPrivileges = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00578                                                     PrivilegeParameterLength,
00579                                                     'rPeS'
00580                                                   );
00581 
00582         <span class="keywordflow">if</span> (CapturedPrivileges != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00583 
00584             RtlCopyMemory ( CapturedPrivileges,
00585                             Privileges,
00586                             PrivilegeParameterLength );
00587             CapturedPrivileges-&gt;PrivilegeCount = PrivilegeCount;
00588         }
00589 
00590     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00591 
00592         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00593     }
00594     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00595 
00596         <span class="keywordflow">if</span> (CapturedPrivileges != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00597             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( CapturedPrivileges );
00598         }
00599 
00600         <span class="keywordflow">if</span> (CapturedSubsystemName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00601             <a class="code" href="../../d3/d5/seaudit_8c.html#a6">SepFreeCapturedString</a> ( CapturedSubsystemName );
00602         }
00603 
00604         <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a> ( &amp;SubjectSecurityContext );
00605 
00606         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( (PVOID)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00607 
00608         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00609 
00610     }
00611 
00612     <span class="comment">//</span>
00613     <span class="comment">// No need to lock the token, because the only thing we're going</span>
00614     <span class="comment">// to reference in it is the User's Sid, which cannot be changed.</span>
00615     <span class="comment">//</span>
00616 
00617     <span class="comment">//</span>
00618     <span class="comment">// SepPrivilegeObjectAuditAlarm will check the global flags</span>
00619     <span class="comment">// to determine if we're supposed to be auditing here.</span>
00620     <span class="comment">//</span>
00621 
00622     AuditPerformed = <a class="code" href="../../d7/d6/sepaudit_8c.html#a9">SepAdtPrivilegeObjectAuditAlarm</a> (
00623                          CapturedSubsystemName,
00624                          HandleId,
00625                          <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,                                <span class="comment">// ClientToken</span>
00626                          SubjectSecurityContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o2">PrimaryToken</a>,  <span class="comment">// PrimaryToken</span>
00627                          SubjectSecurityContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o3">ProcessAuditId</a>,
00628                          DesiredAccess,
00629                          CapturedPrivileges,
00630                          AccessGranted
00631                          );
00632 
00633     <span class="keywordflow">if</span> (CapturedPrivileges != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00634         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( CapturedPrivileges );
00635     }
00636 
00637     <span class="keywordflow">if</span> (CapturedSubsystemName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00638         <a class="code" href="../../d3/d5/seaudit_8c.html#a6">SepFreeCapturedString</a> ( CapturedSubsystemName );
00639     }
00640 
00641     <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a> ( &amp;SubjectSecurityContext );
00642 
00643     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( (PVOID)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00644 
00645     <span class="keywordflow">return</span>(STATUS_SUCCESS);
00646 }
00647 
00648 
00649 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00650"></a><a class="code" href="../../d3/d5/seaudit_8c.html#a13">00650</a> <a class="code" href="../../d3/d5/seaudit_8c.html#a13">SePrivilegeObjectAuditAlarm</a>(
00651     IN HANDLE Handle,
00652     IN <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">PSECURITY_SUBJECT_CONTEXT</a> SubjectSecurityContext,
00653     IN ACCESS_MASK DesiredAccess,
00654     IN PPRIVILEGE_SET Privileges,
00655     IN BOOLEAN AccessGranted,
00656     IN KPROCESSOR_MODE AccessMode
00657     )
00658 
00659 <span class="comment">/*++</span>
00660 <span class="comment"></span>
00661 <span class="comment">Routine Description:</span>
00662 <span class="comment"></span>
00663 <span class="comment">    This routine is used by object methods that perform privileged</span>
00664 <span class="comment">    operations to generate audit and alarm messages related to the use</span>
00665 <span class="comment">    of privileges, or attempts to use privileges.</span>
00666 <span class="comment"></span>
00667 <span class="comment">Arguments:</span>
00668 <span class="comment"></span>
00669 <span class="comment">    Object - Address of the object accessed.  This value will not be</span>
00670 <span class="comment">    used as a pointer (referenced).  It is necessary only to enter</span>
00671 <span class="comment">    into log messages.</span>
00672 <span class="comment"></span>
00673 <span class="comment">    Handle - Provides the handle value assigned for the open.</span>
00674 <span class="comment"></span>
00675 <span class="comment">    SecurityDescriptor - A pointer to the security descriptor of the</span>
00676 <span class="comment">    object being accessed.</span>
00677 <span class="comment"></span>
00678 <span class="comment">    SubjectSecurityContext - A pointer to the captured security</span>
00679 <span class="comment">    context of the subject attempting to open the object.</span>
00680 <span class="comment"></span>
00681 <span class="comment">    DesiredAccess - The desired access mask.  This mask must have been</span>
00682 <span class="comment">    previously mapped to contain no generic accesses.</span>
00683 <span class="comment"></span>
00684 <span class="comment">    Privileges - Points to a set of privileges required for the access</span>
00685 <span class="comment">    attempt.  Those privileges that were held by the subject are</span>
00686 <span class="comment">    marked using the UsedForAccess flag of the PRIVILEGE_ATTRIBUTES</span>
00687 <span class="comment">    associated with each privilege.</span>
00688 <span class="comment"></span>
00689 <span class="comment">    AccessGranted - Indicates whether the access was granted or</span>
00690 <span class="comment">    denied.  A value of TRUE indicates the access was allowed.  A</span>
00691 <span class="comment">    value of FALSE indicates the access was denied.</span>
00692 <span class="comment"></span>
00693 <span class="comment">    AccessMode - Indicates the access mode used for the access check.</span>
00694 <span class="comment">    Messages will not be generated by kernel mode accesses.</span>
00695 <span class="comment"></span>
00696 <span class="comment">Return Value:</span>
00697 <span class="comment"></span>
00698 <span class="comment">    None.</span>
00699 <span class="comment"></span>
00700 <span class="comment">--*/</span>
00701 
00702 {
00703     BOOLEAN AuditPerformed;
00704 
00705     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00706 
00707     <span class="keywordflow">if</span> (AccessMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00708 
00709         AuditPerformed = <a class="code" href="../../d7/d6/sepaudit_8c.html#a9">SepAdtPrivilegeObjectAuditAlarm</a> (
00710                              &amp;<a class="code" href="../../d0/d5/se_8h.html#a107">SeSubsystemName</a>,
00711                              <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
00712                              SubjectSecurityContext-&gt;ClientToken,
00713                              SubjectSecurityContext-&gt;PrimaryToken,
00714                              SubjectSecurityContext-&gt;ProcessAuditId,
00715                              DesiredAccess,
00716                              Privileges,
00717                              AccessGranted
00718                              );
00719     }
00720 }
00721 
00722 
00724 <span class="comment">//                                                                    //</span>
00725 <span class="comment">//                  Privileged Service Audit Alarms                   //</span>
00726 <span class="comment">//                                                                    //</span>
00728 <span class="comment"></span>
00729 
00730 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00731"></a><a class="code" href="../../d3/d5/seaudit_8c.html#a14">00731</a> <a class="code" href="../../d3/d5/seaudit_8c.html#a14">NtPrivilegedServiceAuditAlarm</a> (
00732     IN PUNICODE_STRING SubsystemName,
00733     IN PUNICODE_STRING ServiceName,
00734     IN HANDLE ClientToken,
00735     IN PPRIVILEGE_SET Privileges,
00736     IN BOOLEAN AccessGranted
00737     )
00738 
00739 <span class="comment">/*++</span>
00740 <span class="comment"></span>
00741 <span class="comment">Routine Description:</span>
00742 <span class="comment"></span>
00743 <span class="comment">    This routine is used to generate audit and alarm messages when an</span>
00744 <span class="comment">    attempt is made to perform privileged system service operations.  This</span>
00745 <span class="comment">    routine may result in several messages being generated and sent to Port</span>
00746 <span class="comment">    objects.  This may result in a significant latency before returning.</span>
00747 <span class="comment">    Design of routines that must call this routine must take this potential</span>
00748 <span class="comment">    latency into account.  This may have an impact on the approach taken</span>
00749 <span class="comment">    for data structure mutex locking, for example.</span>
00750 <span class="comment"></span>
00751 <span class="comment">    This API requires the caller have SeAuditPrivilege privilege.  The test</span>
00752 <span class="comment">    for this privilege is always against the primary token of the calling</span>
00753 <span class="comment">    process, allowing the caller to be impersonating a client during the</span>
00754 <span class="comment">    call with no ill effects</span>
00755 <span class="comment"></span>
00756 <span class="comment">Arguments:</span>
00757 <span class="comment"></span>
00758 <span class="comment">    SubsystemName - Supplies a name string identifying the subsystem</span>
00759 <span class="comment">        calling the routine.</span>
00760 <span class="comment"></span>
00761 <span class="comment">    ServiceName - Supplies a name of the privileged subsystem service.  For</span>
00762 <span class="comment">        example, "RESET RUNTIME LOCAL SECURITY POLICY" might be specified</span>
00763 <span class="comment">        by a Local Security Authority service used to update the local</span>
00764 <span class="comment">        security policy database.</span>
00765 <span class="comment"></span>
00766 <span class="comment">    ClientToken - A handle to a token object representing the client that</span>
00767 <span class="comment">        requested the operation.  This handle must be obtained from a</span>
00768 <span class="comment">        communication session layer, such as from an LPC Port or Local</span>
00769 <span class="comment">        Named Pipe, to prevent possible security policy violations.</span>
00770 <span class="comment"></span>
00771 <span class="comment">    Privileges - Points to a set of privileges required to perform the</span>
00772 <span class="comment">        privileged operation.  Those privileges that were held by the</span>
00773 <span class="comment">        subject are marked using the UsedForAccess flag of the</span>
00774 <span class="comment">        attributes associated with each privilege.</span>
00775 <span class="comment"></span>
00776 <span class="comment">    AccessGranted - Indicates whether the requested access was granted or</span>
00777 <span class="comment">        not.  A value of TRUE indicates the access was granted.  A value of</span>
00778 <span class="comment">        FALSE indicates the access was not granted.</span>
00779 <span class="comment"></span>
00780 <span class="comment">Return value:</span>
00781 <span class="comment"></span>
00782 <span class="comment">--*/</span>
00783 
00784 {
00785 
00786     PPRIVILEGE_SET CapturedPrivileges = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00787     ULONG PrivilegeParameterLength = 0;
00788     BOOLEAN Result;
00789     <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">SECURITY_SUBJECT_CONTEXT</a> SubjectSecurityContext;
00790     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00791     PUNICODE_STRING CapturedSubsystemName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00792     PUNICODE_STRING CapturedServiceName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00793     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00794     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
00795     ULONG PrivilegeCount;
00796 
00797     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00798 
00799     PreviousMode = KeGetPreviousMode();
00800 
00801     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>);
00802 
00803     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00804                  <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a16">ClientToken</a>,             <span class="comment">// Handle</span>
00805                  TOKEN_QUERY,             <span class="comment">// DesiredAccess</span>
00806                  <a class="code" href="../../d0/d5/se_8h.html#a36">SepTokenObjectType</a>,      <span class="comment">// ObjectType</span>
00807                  PreviousMode,            <span class="comment">// AccessMode</span>
00808                  (PVOID *)&amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,         <span class="comment">// Object</span>
00809                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>                     <span class="comment">// GrantedAccess</span>
00810                  );
00811 
00812     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00813         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00814     }
00815 
00816     <span class="comment">//</span>
00817     <span class="comment">// If the passed token is an impersonation token, make sure</span>
00818     <span class="comment">// it is at SecurityIdentification or above.</span>
00819     <span class="comment">//</span>
00820 
00821     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;TokenType == TokenImpersonation) {
00822 
00823         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;ImpersonationLevel &lt; SecurityIdentification) {
00824 
00825             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( (PVOID)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00826 
00827             <span class="keywordflow">return</span>( STATUS_BAD_IMPERSONATION_LEVEL );
00828 
00829         }
00830     }
00831 
00832 <span class="comment">//    //</span>
00833 <span class="comment">//    // Make sure the passed token is an impersonation token...</span>
00834 <span class="comment">//    //</span>
00835 <span class="comment">//</span>
00836 <span class="comment">//    if (Token-&gt;TokenType != TokenImpersonation) {</span>
00837 <span class="comment">//</span>
00838 <span class="comment">//        ObDereferenceObject( (PVOID)Token );</span>
00839 <span class="comment">//</span>
00840 <span class="comment">//        return( STATUS_NO_IMPERSONATION_TOKEN );</span>
00841 <span class="comment">//</span>
00842 <span class="comment">//    }</span>
00843 <span class="comment">//</span>
00844 <span class="comment">//    //</span>
00845 <span class="comment">//    //  ...and at a high enough impersonation level</span>
00846 <span class="comment">//    //</span>
00847 <span class="comment">//</span>
00848 <span class="comment">//    if (Token-&gt;ImpersonationLevel &lt; SecurityIdentification) {</span>
00849 <span class="comment">//</span>
00850 <span class="comment">//        ObDereferenceObject( (PVOID)Token );</span>
00851 <span class="comment">//</span>
00852 <span class="comment">//        return( STATUS_BAD_IMPERSONATION_LEVEL );</span>
00853 <span class="comment">//</span>
00854 <span class="comment">//    }</span>
00855 
00856     <span class="comment">//</span>
00857     <span class="comment">// Check for SeAuditPrivilege</span>
00858     <span class="comment">//</span>
00859 
00860     <a class="code" href="../../d0/d8/subject_8c.html#a0">SeCaptureSubjectContext</a> ( &amp;SubjectSecurityContext );
00861 
00862     Result = <a class="code" href="../../d3/d5/seaudit_8c.html#a11">SeCheckAuditPrivilege</a> (
00863                  &amp;SubjectSecurityContext,
00864                  PreviousMode
00865                  );
00866 
00867     <span class="keywordflow">if</span> (!Result) {
00868 
00869         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( (PVOID)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00870 
00871         <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a> ( &amp;SubjectSecurityContext );
00872 
00873         <span class="keywordflow">return</span>(STATUS_PRIVILEGE_NOT_HELD);
00874     }
00875 
00876     <span class="keywordflow">try</span> {
00877 
00878         <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( SubsystemName )) {
00879             <a class="code" href="../../d3/d5/seaudit_8c.html#a5">SepProbeAndCaptureString_U</a> ( SubsystemName,
00880                                          &amp;CapturedSubsystemName );
00881         }
00882 
00883         <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( ServiceName )) {
00884             <a class="code" href="../../d3/d5/seaudit_8c.html#a5">SepProbeAndCaptureString_U</a> ( ServiceName,
00885                                          &amp;CapturedServiceName );
00886 
00887         }
00888 
00889         <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(
00890             Privileges,
00891             <span class="keyword">sizeof</span>(PRIVILEGE_SET),
00892             <span class="keyword">sizeof</span>(ULONG)
00893             );
00894 
00895         PrivilegeCount = Privileges-&gt;PrivilegeCount;
00896 
00897         <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d6/sep_8h.html#a11">IsValidElementCount</a>( PrivilegeCount, LUID_AND_ATTRIBUTES ) ) {
00898             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00899             leave ;
00900         }
00901         PrivilegeParameterLength = (ULONG)<span class="keyword">sizeof</span>(PRIVILEGE_SET) +
00902                           ((PrivilegeCount - <a class="code" href="../../d5/d4/acpitabl_8h.html#a44">ANYSIZE_ARRAY</a>) *
00903                             (ULONG)<span class="keyword">sizeof</span>(LUID_AND_ATTRIBUTES)  );
00904 
00905         <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(
00906             Privileges,
00907             PrivilegeParameterLength,
00908             <span class="keyword">sizeof</span>(ULONG)
00909             );
00910 
00911         CapturedPrivileges = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00912                                                     PrivilegeParameterLength,
00913                                                     'rPeS'
00914                                                   );
00915 
00916         <span class="comment">//</span>
00917         <span class="comment">// If ExAllocatePool has failed, too bad.  Carry on and do as much of the</span>
00918         <span class="comment">// audit as we can.</span>
00919         <span class="comment">//</span>
00920 
00921         <span class="keywordflow">if</span> (CapturedPrivileges != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00922 
00923             RtlCopyMemory ( CapturedPrivileges,
00924                             Privileges,
00925                             PrivilegeParameterLength );
00926             CapturedPrivileges-&gt;PrivilegeCount = PrivilegeCount;
00927 
00928         }
00929 
00930     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00931         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00932     }
00933 
00934     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00935 
00936         <span class="keywordflow">if</span> (CapturedSubsystemName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00937             <a class="code" href="../../d3/d5/seaudit_8c.html#a6">SepFreeCapturedString</a> ( CapturedSubsystemName );
00938         }
00939 
00940         <span class="keywordflow">if</span> (CapturedServiceName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00941             <a class="code" href="../../d3/d5/seaudit_8c.html#a6">SepFreeCapturedString</a> ( CapturedServiceName );
00942         }
00943 
00944         <span class="keywordflow">if</span> (CapturedPrivileges != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00945             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> ( CapturedPrivileges );
00946         }
00947 
00948         <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a> ( &amp;SubjectSecurityContext );
00949 
00950         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( (PVOID)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00951 
00952         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00953 
00954     }
00955 
00956     <span class="comment">//</span>
00957     <span class="comment">// The AuthenticationId is in the read-only part of the token,</span>
00958     <span class="comment">// so we may reference it without having the token read-locked.</span>
00959     <span class="comment">//</span>
00960 
00961     <a class="code" href="../../d7/d6/sepaudit_8c.html#a10">SepAdtPrivilegedServiceAuditAlarm</a> ( CapturedSubsystemName,
00962                                         CapturedServiceName,
00963                                         <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,
00964                                         SubjectSecurityContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o2">PrimaryToken</a>,
00965                                         CapturedPrivileges,
00966                                         AccessGranted );
00967 
00968     <span class="keywordflow">if</span> (CapturedSubsystemName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00969         <a class="code" href="../../d3/d5/seaudit_8c.html#a6">SepFreeCapturedString</a> ( CapturedSubsystemName );
00970     }
00971 
00972     <span class="keywordflow">if</span> (CapturedServiceName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00973         <a class="code" href="../../d3/d5/seaudit_8c.html#a6">SepFreeCapturedString</a> ( CapturedServiceName );
00974     }
00975 
00976     <span class="keywordflow">if</span> (CapturedPrivileges != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00977         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> ( CapturedPrivileges );
00978     }
00979 
00980     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( (PVOID)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00981 
00982     <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a> ( &amp;SubjectSecurityContext );
00983 
00984     <span class="keywordflow">return</span>(STATUS_SUCCESS);
00985 }
00986 
00987 
00988 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00989"></a><a class="code" href="../../d3/d5/seaudit_8c.html#a15">00989</a> <a class="code" href="../../d3/d5/seaudit_8c.html#a15">SePrivilegedServiceAuditAlarm</a> (
00990     IN PUNICODE_STRING ServiceName,
00991     IN <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">PSECURITY_SUBJECT_CONTEXT</a> SubjectSecurityContext,
00992     IN PPRIVILEGE_SET Privileges,
00993     IN BOOLEAN AccessGranted
00994     )
00995 <span class="comment">/*++</span>
00996 <span class="comment"></span>
00997 <span class="comment">Routine Description:</span>
00998 <span class="comment"></span>
00999 <span class="comment">    This routine is to be called whenever a privileged system service</span>
01000 <span class="comment">    is attempted.  It should be called immediately after the privilege</span>
01001 <span class="comment">    check regardless of whether or not the test succeeds.</span>
01002 <span class="comment"></span>
01003 <span class="comment">Arguments:</span>
01004 <span class="comment"></span>
01005 <span class="comment">    ServiceName - Supplies the name of the privileged system service.</span>
01006 <span class="comment"></span>
01007 <span class="comment">    SubjectSecurityContext - The subject security context representing</span>
01008 <span class="comment">        the caller of the system service.</span>
01009 <span class="comment"></span>
01010 <span class="comment">    Privileges - Supplies a privilge set containing the privilege(s)</span>
01011 <span class="comment">        required for the access.</span>
01012 <span class="comment"></span>
01013 <span class="comment">    AccessGranted - Supplies the results of the privilege test.</span>
01014 <span class="comment"></span>
01015 <span class="comment">Return Value:</span>
01016 <span class="comment"></span>
01017 <span class="comment">    None.</span>
01018 <span class="comment"></span>
01019 <span class="comment">--*/</span>
01020 
01021 {
01022     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
01023 
01024     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01025 
01026     <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d5/adtp_8h.html#a1">SepAdtAuditThisEvent</a>( AuditCategoryPrivilegeUse, &amp;AccessGranted ) &amp;&amp;
01027          <a class="code" href="../../d6/d6/sep_8h.html#a67">SepFilterPrivilegeAudits</a>( Privileges )) {
01028 
01029         <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> = (<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)<a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a>( SubjectSecurityContext );
01030 
01031         <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>( <a class="code" href="../../d0/d5/se_8h.html#a54">SeLocalSystemSid</a>, <a class="code" href="../../d6/d6/sep_8h.html#a8">SepTokenUserSid</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> ))) {
01032             <span class="keywordflow">return</span>;
01033         }
01034 
01035         <a class="code" href="../../d7/d6/sepaudit_8c.html#a10">SepAdtPrivilegedServiceAuditAlarm</a> (
01036             &amp;<a class="code" href="../../d0/d5/se_8h.html#a107">SeSubsystemName</a>,
01037             ServiceName,
01038             SubjectSecurityContext-&gt;ClientToken,
01039             SubjectSecurityContext-&gt;PrimaryToken,
01040             Privileges,
01041             AccessGranted
01042             );
01043     }
01044 
01045     <span class="keywordflow">return</span>;
01046 }
01047 
01048 
01049 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01050"></a><a class="code" href="../../d3/d5/seaudit_8c.html#a9">01050</a> <a class="code" href="../../d3/d5/seaudit_8c.html#a9">SepAccessCheckAndAuditAlarm</a> (
01051     IN PUNICODE_STRING SubsystemName,
01052     IN PVOID HandleId,
01053     IN PHANDLE ClientToken OPTIONAL,
01054     IN PUNICODE_STRING ObjectTypeName,
01055     IN PUNICODE_STRING ObjectName,
01056     IN PSECURITY_DESCRIPTOR SecurityDescriptor,
01057     IN PSID PrincipalSelfSid,
01058     IN ACCESS_MASK DesiredAccess,
01059     IN AUDIT_EVENT_TYPE AuditType,
01060     IN ULONG Flags,
01061     IN POBJECT_TYPE_LIST ObjectTypeList OPTIONAL,
01062     IN ULONG ObjectTypeListLength,
01063     IN PGENERIC_MAPPING GenericMapping,
01064     IN BOOLEAN ObjectCreation,
01065     OUT PACCESS_MASK GrantedAccess,
01066     OUT PNTSTATUS AccessStatus,
01067     OUT PBOOLEAN GenerateOnClose,
01068     IN BOOLEAN ReturnResultList
01069     )
01070 <span class="comment">/*++</span>
01071 <span class="comment"></span>
01072 <span class="comment">Routine Description:</span>
01073 <span class="comment"></span>
01074 <span class="comment">    This system service is used to perform both an access validation and</span>
01075 <span class="comment">    generate the corresponding audit and alarm messages.  This service may</span>
01076 <span class="comment">    only be used by a protected server that chooses to impersonate its</span>
01077 <span class="comment">    client and thereby specifies the client security context implicitly.</span>
01078 <span class="comment"></span>
01079 <span class="comment">Arguments:</span>
01080 <span class="comment"></span>
01081 <span class="comment">    SubsystemName - Supplies a name string identifying the subsystem</span>
01082 <span class="comment">        calling the routine.</span>
01083 <span class="comment"></span>
01084 <span class="comment">    HandleId - A unique value that will be used to represent the client's</span>
01085 <span class="comment">        handle to the object.  This value is ignored (and may be re-used)</span>
01086 <span class="comment">        if the access is denied.</span>
01087 <span class="comment"></span>
01088 <span class="comment">    ClientToken - Supplies the client token so that the caller does not have</span>
01089 <span class="comment">        to impersonate before making the kernel call.</span>
01090 <span class="comment"></span>
01091 <span class="comment">    ObjectTypeName - Supplies the name of the type of the object being</span>
01092 <span class="comment">        created or accessed.</span>
01093 <span class="comment"></span>
01094 <span class="comment">    ObjectName - Supplies the name of the object being created or accessed.</span>
01095 <span class="comment"></span>
01096 <span class="comment">    SecurityDescriptor - A pointer to the Security Descriptor against which</span>
01097 <span class="comment">        acccess is to be checked.</span>
01098 <span class="comment"></span>
01099 <span class="comment">    DesiredAccess - The desired acccess mask.  This mask must have been</span>
01100 <span class="comment">        previously mapped to contain no generic accesses.</span>
01101 <span class="comment"></span>
01102 <span class="comment">    AuditType - Specifies the type of audit to be generated.  Valid values</span>
01103 <span class="comment">        are: AuditEventObjectAccess and AuditEventDirectoryServiceAccess.</span>
01104 <span class="comment"></span>
01105 <span class="comment">    Flags - Flags modifying the execution of the API:</span>
01106 <span class="comment"></span>
01107 <span class="comment">        AUDIT_ALLOW_NO_PRIVILEGE - If the called does not have AuditPrivilege,</span>
01108 <span class="comment">            the call will silently continue to check access and will</span>
01109 <span class="comment">            generate no audit.</span>
01110 <span class="comment"></span>
01111 <span class="comment">    ObjectTypeList - Supplies a list of GUIDs representing the object (and</span>
01112 <span class="comment">        sub-objects) being accessed.  If no list is present, AccessCheckByType</span>
01113 <span class="comment">        behaves identically to AccessCheck.</span>
01114 <span class="comment"></span>
01115 <span class="comment">    ObjectTypeListLength - Specifies the number of elements in the ObjectTypeList.</span>
01116 <span class="comment"></span>
01117 <span class="comment">    GenericMapping - Supplies a pointer to the generic mapping associated</span>
01118 <span class="comment">        with this object type.</span>
01119 <span class="comment"></span>
01120 <span class="comment">    ObjectCreation - A boolean flag indicated whether the access will</span>
01121 <span class="comment">        result in a new object being created if granted.  A value of TRUE</span>
01122 <span class="comment">        indicates an object will be created, FALSE indicates an existing</span>
01123 <span class="comment">        object will be opened.</span>
01124 <span class="comment"></span>
01125 <span class="comment">    GrantedAccess - Receives a masking indicating which accesses have been</span>
01126 <span class="comment">        granted.</span>
01127 <span class="comment"></span>
01128 <span class="comment">    AccessStatus - Receives an indication of the success or failure of the</span>
01129 <span class="comment">        access check.  If access is granted, STATUS_SUCCESS is returned.</span>
01130 <span class="comment">        If access is denied, a value appropriate for return to the client</span>
01131 <span class="comment">        is returned.  This will be STATUS_ACCESS_DENIED or, when mandatory</span>
01132 <span class="comment">        access controls are implemented, STATUS_OBJECT_NOT_FOUND.</span>
01133 <span class="comment"></span>
01134 <span class="comment">    GenerateOnClose - Points to a boolean that is set by the audity</span>
01135 <span class="comment">        generation routine and must be passed to NtCloseObjectAuditAlarm</span>
01136 <span class="comment">        when the object handle is closed.</span>
01137 <span class="comment"></span>
01138 <span class="comment">    ReturnResultList - If true, GrantedAccess and AccessStatus are actually</span>
01139 <span class="comment">        arrays of entries ObjectTypeListLength elements long.</span>
01140 <span class="comment"></span>
01141 <span class="comment">Return Value:</span>
01142 <span class="comment"></span>
01143 <span class="comment">    STATUS_SUCCESS - Indicates the call completed successfully.  In this</span>
01144 <span class="comment">        case, ClientStatus receives the result of the access check.</span>
01145 <span class="comment"></span>
01146 <span class="comment">    STATUS_PRIVILEGE_NOT_HELD - Indicates the caller does not have</span>
01147 <span class="comment">        sufficient privilege to use this privileged system service.</span>
01148 <span class="comment"></span>
01149 <span class="comment">--*/</span>
01150 
01151 {
01152 
01153     <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">SECURITY_SUBJECT_CONTEXT</a> SubjectSecurityContext;
01154 
01155     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01156 
01157     ACCESS_MASK LocalGrantedAccess = (ACCESS_MASK)0;
01158     PACCESS_MASK LocalGrantedAccessPointer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01159     BOOLEAN LocalGrantedAccessAllocated = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01160     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> LocalAccessStatus;
01161     PNTSTATUS LocalAccessStatusPointer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01162     BOOLEAN LocalGenerateOnClose = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01163     POLICY_AUDIT_EVENT_TYPE NtAuditType;
01164 
01165     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
01166 
01167     PUNICODE_STRING CapturedSubsystemName = (PUNICODE_STRING) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01168     PUNICODE_STRING CapturedObjectTypeName = (PUNICODE_STRING) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01169     PUNICODE_STRING CapturedObjectName = (PUNICODE_STRING) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01170     PSECURITY_DESCRIPTOR CapturedSecurityDescriptor = (PSECURITY_DESCRIPTOR) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01171     PSID CapturedPrincipalSelfSid = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01172     <a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">PIOBJECT_TYPE_LIST</a> LocalObjectTypeList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01173 
01174     ACCESS_MASK PreviouslyGrantedAccess = (ACCESS_MASK)0;
01175     GENERIC_MAPPING LocalGenericMapping;
01176 
01177     PPRIVILEGE_SET PrivilegeSet = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01178 
01179     BOOLEAN Result;
01180 
01181     BOOLEAN AccessGranted;
01182     BOOLEAN AccessDenied;
01183     BOOLEAN GenerateSuccessAudit = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01184     BOOLEAN GenerateFailureAudit = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01185     LUID OperationId;
01186     BOOLEAN AuditPerformed;
01187     BOOLEAN AvoidAudit = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01188 
01189     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> NewToken = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01190     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> OldToken = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01191     BOOLEAN TokenSwapped = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01192 
01193     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01194 
01195     PreviousMode = KeGetPreviousMode();
01196 
01197     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a> );
01198 
01199     <span class="comment">//</span>
01200     <span class="comment">// Capture the subject Context</span>
01201     <span class="comment">//</span>
01202 
01203     <a class="code" href="../../d0/d8/subject_8c.html#a0">SeCaptureSubjectContext</a> ( &amp;SubjectSecurityContext );
01204 
01205     <span class="comment">//</span>
01206     <span class="comment">// Convert AuditType</span>
01207     <span class="comment">//</span>
01208 
01209     <span class="keywordflow">if</span> ( AuditType == AuditEventObjectAccess ) {
01210         NtAuditType = AuditCategoryObjectAccess;
01211     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( AuditType == AuditEventDirectoryServiceAccess ) {
01212         NtAuditType = AuditCategoryDirectoryServiceAccess;
01213     } <span class="keywordflow">else</span> {
01214         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
01215         <span class="keywordflow">goto</span> Cleanup;
01216     }
01217 
01218     <span class="comment">//</span>
01219     <span class="comment">// Impersonation checks should be done only if the ClientToken is NULL.</span>
01220     <span class="comment">//</span>
01221 
01222     <span class="keywordflow">if</span> ( !ARGUMENT_PRESENT( <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a16">ClientToken</a> ) ) {
01223 
01224         <span class="comment">//</span>
01225         <span class="comment">// Make sure we're impersonating a client...</span>
01226         <span class="comment">//</span>
01227 
01228         <span class="keywordflow">if</span> ( (SubjectSecurityContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o0">ClientToken</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ) {
01229             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_IMPERSONATION_TOKEN;
01230             <span class="keywordflow">goto</span> Cleanup;
01231         }
01232 
01233 
01234         <span class="comment">//</span>
01235         <span class="comment">// ...and at a high enough impersonation level</span>
01236         <span class="comment">//</span>
01237 
01238         <span class="keywordflow">if</span> (SubjectSecurityContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o1">ImpersonationLevel</a> &lt; SecurityIdentification) {
01239             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_BAD_IMPERSONATION_LEVEL;
01240             <span class="keywordflow">goto</span> Cleanup;
01241         }
01242     }
01243 
01244     <span class="keywordflow">try</span> {
01245 
01246         <span class="keywordflow">if</span> ( ReturnResultList ) {
01247 
01248             <span class="keywordflow">if</span> ( ObjectTypeListLength == 0 ) {
01249                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
01250                 leave;
01251             }
01252 
01253             <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d6/sep_8h.html#a11">IsValidElementCount</a>(ObjectTypeListLength, ULONG)) {
01254                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
01255                 leave;
01256             }
01257             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(
01258                 AccessStatus,
01259                 <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>) * ObjectTypeListLength,
01260                 <span class="keyword">sizeof</span>(ULONG)
01261                 );
01262 
01263             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(
01264                 GrantedAccess,
01265                 <span class="keyword">sizeof</span>(ACCESS_MASK) * ObjectTypeListLength,
01266                 <span class="keyword">sizeof</span>(ULONG)
01267                 );
01268 
01269         } <span class="keywordflow">else</span> {
01270             <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>((PULONG)AccessStatus);
01271             <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>((PULONG)GrantedAccess);
01272         }
01273 
01274         <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(
01275             GenericMapping,
01276             <span class="keyword">sizeof</span>(GENERIC_MAPPING),
01277             <span class="keyword">sizeof</span>(ULONG)
01278             );
01279 
01280         LocalGenericMapping = *GenericMapping;
01281 
01282     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
01283 
01284         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
01285     }
01286 
01287     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01288         <span class="keywordflow">goto</span> Cleanup;
01289     }
01290 
01291     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a16">ClientToken</a> ) ) {
01292 
01293         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
01294                      *<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a16">ClientToken</a>,                 <span class="comment">// Handle</span>
01295                      (ACCESS_MASK)TOKEN_QUERY,     <span class="comment">// DesiredAccess</span>
01296                      <a class="code" href="../../d0/d5/se_8h.html#a36">SepTokenObjectType</a>,           <span class="comment">// ObjectType</span>
01297                      PreviousMode,                 <span class="comment">// AccessMode</span>
01298                      (PVOID *)&amp;NewToken,           <span class="comment">// Object</span>
01299                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>                          <span class="comment">// GrantedAccess</span>
01300                      );
01301 
01302         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01303             NewToken = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01304             <span class="keywordflow">goto</span> Cleanup;
01305         }
01306 
01307         <span class="comment">//</span>
01308         <span class="comment">// Save the old token so that it can be recovered before</span>
01309         <span class="comment">// SeReleaseSubjectContext.</span>
01310         <span class="comment">//</span>
01311 
01312         OldToken = SubjectSecurityContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o0">ClientToken</a>;
01313 
01314         <span class="comment">//</span>
01315         <span class="comment">// Set the impersonation token to the one that has been obtained thru</span>
01316         <span class="comment">// ClientToken handle. This must be freed later in Cleanup.</span>
01317         <span class="comment">//</span>
01318 
01319         SubjectSecurityContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o0">ClientToken</a> = NewToken;
01320 
01321         TokenSwapped = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01322     }
01323 
01324     <span class="comment">//</span>
01325     <span class="comment">// Check for SeAuditPrivilege</span>
01326     <span class="comment">//</span>
01327 
01328     Result = <a class="code" href="../../d3/d5/seaudit_8c.html#a11">SeCheckAuditPrivilege</a> (
01329                  &amp;SubjectSecurityContext,
01330                  PreviousMode
01331                  );
01332 
01333     <span class="keywordflow">if</span> (!Result) {
01334         <span class="keywordflow">if</span> ( Flags &amp; AUDIT_ALLOW_NO_PRIVILEGE ) {
01335             AvoidAudit = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01336         } <span class="keywordflow">else</span> {
01337             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_PRIVILEGE_NOT_HELD;
01338             <span class="keywordflow">goto</span> Cleanup;
01339         }
01340     }
01341 
01342     <span class="keywordflow">if</span> (DesiredAccess &amp;
01343         ( GENERIC_READ | GENERIC_WRITE | GENERIC_EXECUTE | GENERIC_ALL )) {
01344 
01345         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_GENERIC_NOT_MAPPED;
01346         <span class="keywordflow">goto</span> Cleanup;
01347     }
01348 
01349     <span class="comment">//</span>
01350     <span class="comment">// Capture the passed security descriptor.</span>
01351     <span class="comment">//</span>
01352     <span class="comment">// SeCaptureSecurityDescriptor probes the input security descriptor,</span>
01353     <span class="comment">// so we don't have to</span>
01354     <span class="comment">//</span>
01355 
01356     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/se_2capture_8c.html#a1">SeCaptureSecurityDescriptor</a> (
01357                 SecurityDescriptor,
01358                 PreviousMode,
01359                 <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
01360                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01361                 &amp;CapturedSecurityDescriptor
01362                 );
01363 
01364     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
01365         CapturedSecurityDescriptor = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01366         <span class="keywordflow">goto</span> Cleanup;
01367     }
01368 
01369     <span class="keywordflow">if</span> ( CapturedSecurityDescriptor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01370         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_SECURITY_DESCR;
01371         <span class="keywordflow">goto</span> Cleanup;
01372     }
01373 
01374     <span class="comment">//</span>
01375     <span class="comment">// A valid security descriptor must have an owner and a group</span>
01376     <span class="comment">//</span>
01377 
01378     <span class="keywordflow">if</span> ( RtlpOwnerAddrSecurityDescriptor(
01379                 (PISECURITY_DESCRIPTOR)CapturedSecurityDescriptor
01380                 ) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
01381          RtlpGroupAddrSecurityDescriptor(
01382                 (PISECURITY_DESCRIPTOR)CapturedSecurityDescriptor
01383                 ) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01384 
01385         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_SECURITY_DESCR;
01386         <span class="keywordflow">goto</span> Cleanup;
01387     }
01388 
01389     <span class="comment">//</span>
01390     <span class="comment">//  Probe and capture the STRING arguments</span>
01391     <span class="comment">//</span>
01392 
01393     <span class="keywordflow">try</span> {
01394 
01395         <a class="code" href="../../d5/d8/ex_8h.html#a28">ProbeForWriteBoolean</a>(GenerateOnClose);
01396 
01397         <a class="code" href="../../d3/d5/seaudit_8c.html#a5">SepProbeAndCaptureString_U</a> ( SubsystemName, &amp;CapturedSubsystemName );
01398 
01399         <a class="code" href="../../d3/d5/seaudit_8c.html#a5">SepProbeAndCaptureString_U</a> ( ObjectTypeName, &amp;CapturedObjectTypeName );
01400 
01401         <a class="code" href="../../d3/d5/seaudit_8c.html#a5">SepProbeAndCaptureString_U</a> ( ObjectName, &amp;CapturedObjectName );
01402 
01403     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
01404 
01405         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
01406         <span class="keywordflow">goto</span> Cleanup;
01407 
01408     }
01409 
01410     <span class="comment">//</span>
01411     <span class="comment">// Capture the PrincipalSelfSid.</span>
01412     <span class="comment">//</span>
01413 
01414     <span class="keywordflow">if</span> ( PrincipalSelfSid != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01415         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/se_2capture_8c.html#a8">SeCaptureSid</a>(
01416                      PrincipalSelfSid,
01417                      PreviousMode,
01418                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0,
01419                      <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
01420                      <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01421                      &amp;CapturedPrincipalSelfSid );
01422 
01423         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01424             CapturedPrincipalSelfSid = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01425             <span class="keywordflow">goto</span> Cleanup;
01426         }
01427     }
01428 
01429     <span class="comment">//</span>
01430     <span class="comment">// Capture any Object type list</span>
01431     <span class="comment">//</span>
01432 
01433     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d3/tokenp_8h.html#a21">SeCaptureObjectTypeList</a>( ObjectTypeList,
01434                                       ObjectTypeListLength,
01435                                       PreviousMode,
01436                                       &amp;LocalObjectTypeList );
01437 
01438     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01439         <span class="keywordflow">goto</span> Cleanup;
01440     }
01441 
01442     <span class="comment">//</span>
01443     <span class="comment">// See if anything (or everything) in the desired access can be</span>
01444     <span class="comment">// satisfied by privileges.</span>
01445     <span class="comment">//</span>
01446 
01447     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d4/accessck_8c.html#a20">SePrivilegePolicyCheck</a>(
01448                  &amp;DesiredAccess,
01449                  &amp;PreviouslyGrantedAccess,
01450                  &amp;SubjectSecurityContext,
01451                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01452                  &amp;PrivilegeSet,
01453                  PreviousMode
01454                  );
01455 
01456     <a class="code" href="../../d0/d8/subject_8c.html#a1">SeLockSubjectContext</a>( &amp;SubjectSecurityContext );
01457 
01458     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01459         AccessGranted = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01460         AccessDenied = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01461         LocalAccessStatus = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01462 
01463         <span class="keywordflow">if</span> ( ReturnResultList ) {
01464             ULONG ResultListIndex;
01465             LocalGrantedAccessPointer =
01466                 <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, (<span class="keyword">sizeof</span>(ACCESS_MASK)+<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)) * ObjectTypeListLength, 'aGeS' );
01467 
01468             <span class="keywordflow">if</span> (LocalGrantedAccessPointer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01469                 <a class="code" href="../../d0/d8/subject_8c.html#a2">SeUnlockSubjectContext</a>( &amp;SubjectSecurityContext );
01470                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
01471                 <span class="keywordflow">goto</span> Cleanup;
01472             }
01473             LocalGrantedAccessAllocated = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01474             LocalAccessStatusPointer = (PNTSTATUS)(LocalGrantedAccessPointer + ObjectTypeListLength);
01475 
01476             <span class="keywordflow">for</span> ( ResultListIndex=0; ResultListIndex&lt;ObjectTypeListLength; ResultListIndex++ ) {
01477                 LocalGrantedAccessPointer[ResultListIndex] = LocalGrantedAccess;
01478                 LocalAccessStatusPointer[ResultListIndex] = LocalAccessStatus;
01479             }
01480 
01481         } <span class="keywordflow">else</span> {
01482         LocalGrantedAccessPointer = &amp;LocalGrantedAccess;
01483         LocalAccessStatusPointer =  &amp;LocalAccessStatus;
01484         }
01485 
01486     } <span class="keywordflow">else</span> {
01487 
01488         <span class="comment">//</span>
01489         <span class="comment">// If the user in the token is the owner of the object, we</span>
01490         <span class="comment">// must automatically grant ReadControl and WriteDac access</span>
01491         <span class="comment">// if desired.  If the DesiredAccess mask is empty after</span>
01492         <span class="comment">// these bits are turned off, we don't have to do any more</span>
01493         <span class="comment">// access checking (ref section 4, DSA ACL Arch)</span>
01494         <span class="comment">//</span>
01495 
01496         <span class="keywordflow">if</span> ( DesiredAccess &amp; (WRITE_DAC | READ_CONTROL | MAXIMUM_ALLOWED) ) {
01497 
01498             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/sep_8h.html#a54">SepTokenIsOwner</a>( SubjectSecurityContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o0">ClientToken</a>, CapturedSecurityDescriptor, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> )) {
01499 
01500                 <span class="keywordflow">if</span> ( DesiredAccess &amp; MAXIMUM_ALLOWED ) {
01501 
01502                     PreviouslyGrantedAccess |= ( WRITE_DAC | READ_CONTROL );
01503 
01504                 } <span class="keywordflow">else</span> {
01505 
01506                     PreviouslyGrantedAccess |= (DesiredAccess &amp; (WRITE_DAC | READ_CONTROL));
01507                 }
01508 
01509                 DesiredAccess &amp;= ~(WRITE_DAC | READ_CONTROL);
01510             }
01511 
01512         }
01513 
01514         <span class="keywordflow">if</span> (DesiredAccess == 0) {
01515 
01516             LocalGrantedAccess = PreviouslyGrantedAccess;
01517             AccessGranted = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01518             AccessDenied = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01519             LocalAccessStatus = STATUS_SUCCESS;
01520 
01521             <span class="keywordflow">if</span> ( ReturnResultList ) {
01522                 ULONG ResultListIndex;
01523                 LocalGrantedAccessPointer =
01524                     <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, (<span class="keyword">sizeof</span>(ACCESS_MASK)+<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)) * ObjectTypeListLength, 'aGeS' );
01525 
01526                 <span class="keywordflow">if</span> (LocalGrantedAccessPointer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01527                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
01528                     <a class="code" href="../../d0/d8/subject_8c.html#a2">SeUnlockSubjectContext</a>( &amp;SubjectSecurityContext );
01529                     <span class="keywordflow">goto</span> Cleanup;
01530                 }
01531                 LocalGrantedAccessAllocated = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01532                 LocalAccessStatusPointer = (PNTSTATUS)(LocalGrantedAccessPointer + ObjectTypeListLength);
01533 
01534                 <span class="keywordflow">for</span> ( ResultListIndex=0; ResultListIndex&lt;ObjectTypeListLength; ResultListIndex++ ) {
01535                     LocalGrantedAccessPointer[ResultListIndex] = LocalGrantedAccess;
01536                     LocalAccessStatusPointer[ResultListIndex] = LocalAccessStatus;
01537                 }
01538 
01539             } <span class="keywordflow">else</span> {
01540             LocalGrantedAccessPointer = &amp;LocalGrantedAccess;
01541             LocalAccessStatusPointer =  &amp;LocalAccessStatus;
01542             }
01543 
01544         } <span class="keywordflow">else</span> {
01545 
01546             <span class="comment">//</span>
01547             <span class="comment">// Finally, do the access check</span>
01548             <span class="comment">//</span>
01549 
01550             <span class="keywordflow">if</span> ( ReturnResultList ) {
01551                 LocalGrantedAccessPointer =
01552                     <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, (<span class="keyword">sizeof</span>(ACCESS_MASK)+<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)) * ObjectTypeListLength, 'aGeS' );
01553 
01554                 <span class="keywordflow">if</span> (LocalGrantedAccessPointer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01555                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
01556                     <a class="code" href="../../d0/d8/subject_8c.html#a2">SeUnlockSubjectContext</a>( &amp;SubjectSecurityContext );
01557                     <span class="keywordflow">goto</span> Cleanup;
01558                 }
01559                 LocalGrantedAccessAllocated = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01560                 LocalAccessStatusPointer = (PNTSTATUS)(LocalGrantedAccessPointer + ObjectTypeListLength);
01561 
01562             } <span class="keywordflow">else</span> {
01563                 LocalGrantedAccessPointer = &amp;LocalGrantedAccess;
01564                 LocalAccessStatusPointer =  &amp;LocalAccessStatus;
01565             }
01566 
01567             <a class="code" href="../../d8/d3/tokenp_8h.html#a38">SepAccessCheck</a> (
01568                         CapturedSecurityDescriptor,
01569                         CapturedPrincipalSelfSid,
01570                         SubjectSecurityContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o2">PrimaryToken</a>,
01571                         SubjectSecurityContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o0">ClientToken</a>,
01572                         DesiredAccess,
01573                         LocalObjectTypeList,
01574                         ObjectTypeListLength,
01575                         &amp;LocalGenericMapping,
01576                         PreviouslyGrantedAccess,
01577                         PreviousMode,
01578                         LocalGrantedAccessPointer,
01579                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,       <span class="comment">// Privileges already checked</span>
01580                         LocalAccessStatusPointer,
01581                         ReturnResultList,
01582                         &amp;AccessGranted,
01583                         &amp;AccessDenied
01584                         );
01585 
01586         }
01587     }
01588 
01589     <span class="comment">//</span>
01590     <span class="comment">// sound the alarms...</span>
01591     <span class="comment">//</span>
01592 
01593     <span class="keywordflow">if</span> ( !AvoidAudit ) {
01594         <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d5/adtp_8h.html#a2">SepAdtAuditThisEventEx</a>( NtAuditType, AccessGranted, AccessDenied )) {
01595 
01596             <a class="code" href="../../d3/d5/seaudit_8c.html#a8">SepExamineSaclEx</a>(
01597                 RtlpSaclAddrSecurityDescriptor( (PISECURITY_DESCRIPTOR)CapturedSecurityDescriptor ),
01598                 <a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a>( &amp;SubjectSecurityContext ),
01599                 DesiredAccess | PreviouslyGrantedAccess,
01600                 LocalObjectTypeList,
01601                 ObjectTypeListLength,
01602                 ReturnResultList,
01603                 LocalAccessStatusPointer,
01604                 LocalGrantedAccessPointer,
01605                 &amp;GenerateSuccessAudit,
01606                 &amp;GenerateFailureAudit
01607                 );
01608 
01609         }
01610 
01611         <span class="keywordflow">if</span> ( GenerateSuccessAudit ||
01612              GenerateFailureAudit ) {
01613 
01614             <span class="comment">//</span>
01615             <span class="comment">// Save this to a local here, so we don't</span>
01616             <span class="comment">// have to risk accessing user memory and</span>
01617             <span class="comment">// potentially having to exit before the audit</span>
01618             <span class="comment">//</span>
01619 
01620             <span class="keywordflow">if</span> ( AccessGranted ) {
01621 
01622                 <span class="comment">//</span>
01623                 <span class="comment">// SAM calls NtCloseObjectAuditAlarm despite the fact that it may not</span>
01624                 <span class="comment">// have successfully opened the object, causing a spurious close audit.</span>
01625                 <span class="comment">// Since no one should rely on this anyway if their access attempt</span>
01626                 <span class="comment">// failed, make sure it's false and SAM will work properly.</span>
01627                 <span class="comment">//</span>
01628 
01629                 LocalGenerateOnClose = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01630             }
01631 
01632             <span class="comment">//</span>
01633             <span class="comment">// Generate the success audit if needed.</span>
01634             <span class="comment">//</span>
01635             <span class="keywordflow">if</span> ( GenerateSuccessAudit ) {
01636                 <a class="code" href="../../d5/d8/ex_8h.html#a79">ExAllocateLocallyUniqueId</a>( &amp;OperationId );
01637 
01638                 <span class="comment">// ??</span>
01639                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( AccessGranted );
01640                 AuditPerformed = <a class="code" href="../../d7/d6/sepaudit_8c.html#a11">SepAdtOpenObjectAuditAlarm</a> (
01641                                      CapturedSubsystemName,
01642                                      AccessGranted ? &amp;HandleId : <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <span class="comment">// Don't audit handle if failure</span>
01643                                      CapturedObjectTypeName,
01644                                      0,                            <span class="comment">// IN PVOID Object OPTIONAL,</span>
01645                                      CapturedObjectName,
01646                                      SubjectSecurityContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o0">ClientToken</a>,
01647                                      SubjectSecurityContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o2">PrimaryToken</a>,
01648                                      *LocalGrantedAccessPointer,
01649                                      *LocalGrantedAccessPointer,
01650                                      &amp;OperationId,
01651                                      PrivilegeSet,
01652                                      ObjectCreation,
01653                                      <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,  <span class="comment">// Generate success case</span>
01654                                      <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,  <span class="comment">// Generate audit</span>
01655                                      <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <span class="comment">// Don't generate alarm</span>
01656                                      <a class="code" href="../../d1/d9/ps_8h.html#a25">PsProcessAuditId</a>( <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() ),
01657                                      NtAuditType,
01658                                      LocalObjectTypeList,
01659                                      ObjectTypeListLength,
01660                                      ReturnResultList ? LocalGrantedAccessPointer : <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01661                                      );
01662             }
01663 
01664             <span class="comment">//</span>
01665             <span class="comment">// Generate failure audit if it is needed.</span>
01666             <span class="comment">//</span>
01667             <span class="keywordflow">if</span> ( GenerateFailureAudit ) {
01668                 <a class="code" href="../../d5/d8/ex_8h.html#a79">ExAllocateLocallyUniqueId</a>( &amp;OperationId );
01669 
01670                 <span class="comment">// ??</span>
01671                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( AccessDenied );
01672                 AuditPerformed = <a class="code" href="../../d7/d6/sepaudit_8c.html#a11">SepAdtOpenObjectAuditAlarm</a> (
01673                                      CapturedSubsystemName,
01674                                      AccessGranted ? &amp;HandleId : <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <span class="comment">// Don't audit handle if failure</span>
01675                                      CapturedObjectTypeName,
01676                                      0,                            <span class="comment">// IN PVOID Object OPTIONAL,</span>
01677                                      CapturedObjectName,
01678                                      SubjectSecurityContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o0">ClientToken</a>,
01679                                      SubjectSecurityContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o2">PrimaryToken</a>,
01680                                      DesiredAccess,
01681                                      DesiredAccess,
01682                                      &amp;OperationId,
01683                                      PrivilegeSet,
01684                                      ObjectCreation,
01685                                      <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <span class="comment">// Generate failure case</span>
01686                                      <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,  <span class="comment">// Generate audit</span>
01687                                      <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <span class="comment">// Don't generate alarm</span>
01688                                      <a class="code" href="../../d1/d9/ps_8h.html#a25">PsProcessAuditId</a>( <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() ),
01689                                      NtAuditType,
01690                                      LocalObjectTypeList,
01691                                      ObjectTypeListLength,
01692                                      ReturnResultList ? LocalGrantedAccessPointer : <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01693                                      );
01694             }
01695         } <span class="keywordflow">else</span> {
01696 
01697             <span class="comment">//</span>
01698             <span class="comment">// We didn't generate an audit due to the SACL.  If privileges were used, we need</span>
01699             <span class="comment">// to audit that.</span>
01700             <span class="comment">//</span>
01701 
01702             <span class="keywordflow">if</span> ( PrivilegeSet != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01703 
01704                 <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d5/adtp_8h.html#a1">SepAdtAuditThisEvent</a>( AuditCategoryPrivilegeUse, &amp;AccessGranted) ) {
01705 
01706                     AuditPerformed = <a class="code" href="../../d7/d6/sepaudit_8c.html#a9">SepAdtPrivilegeObjectAuditAlarm</a> ( CapturedSubsystemName,
01707                                                                        &amp;HandleId,
01708                                                                        SubjectSecurityContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o0">ClientToken</a>,
01709                                                                        SubjectSecurityContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o2">PrimaryToken</a>,
01710                                                                        <a class="code" href="../../d1/d9/ps_8h.html#a25">PsProcessAuditId</a>( <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() ),
01711                                                                        DesiredAccess,
01712                                                                        PrivilegeSet,
01713                                                                        AccessGranted
01714                                                                        );
01715 
01716                     <span class="comment">//</span>
01717                     <span class="comment">// We don't want close audits to be generated.  May need to revisit this.</span>
01718                     <span class="comment">//</span>
01719 
01720                     LocalGenerateOnClose = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01721                 }
01722             }
01723         }
01724     }
01725 
01726     <a class="code" href="../../d0/d8/subject_8c.html#a2">SeUnlockSubjectContext</a>( &amp;SubjectSecurityContext );
01727 
01728     <span class="keywordflow">try</span> {
01729             <span class="keywordflow">if</span> ( ReturnResultList ) {
01730                 ULONG ResultListIndex;
01731                 <span class="keywordflow">if</span> ( LocalAccessStatusPointer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01732                     <span class="keywordflow">for</span> ( ResultListIndex=0; ResultListIndex&lt;ObjectTypeListLength; ResultListIndex++ ) {
01733                         AccessStatus[ResultListIndex] = LocalAccessStatus;
01734                         GrantedAccess[ResultListIndex] = LocalGrantedAccess;
01735                     }
01736                 } <span class="keywordflow">else</span> {
01737                     <span class="keywordflow">for</span> ( ResultListIndex=0; ResultListIndex&lt;ObjectTypeListLength; ResultListIndex++ ) {
01738                         AccessStatus[ResultListIndex] = LocalAccessStatusPointer[ResultListIndex];
01739                         GrantedAccess[ResultListIndex] = LocalGrantedAccessPointer[ResultListIndex];
01740                     }
01741                 }
01742 
01743             } <span class="keywordflow">else</span> {
01744                 *AccessStatus = LocalAccessStatus;
01745                 *GrantedAccess = LocalGrantedAccess;
01746             }
01747             *GenerateOnClose    = LocalGenerateOnClose;
01748             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01749 
01750     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
01751 
01752         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
01753     }
01754 
01755     <span class="comment">//</span>
01756     <span class="comment">// Free locally used resources.</span>
01757     <span class="comment">//</span>
01758 Cleanup:
01759 
01760     <span class="keywordflow">if</span> ( TokenSwapped ) {
01761 
01762         <span class="comment">//</span>
01763         <span class="comment">// Decrement the reference count for the ClientToken that was passed in.</span>
01764         <span class="comment">//</span>
01765 
01766         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( (PVOID)NewToken );
01767 
01768         <span class="comment">//</span>
01769         <span class="comment">// Reset the value of the token from saved value.</span>
01770         <span class="comment">//</span>
01771 
01772         SubjectSecurityContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o0">ClientToken</a> = OldToken;
01773     }
01774 
01775     <span class="comment">//</span>
01776     <span class="comment">// Free any privileges allocated as part of the access check</span>
01777     <span class="comment">//</span>
01778 
01779     <span class="keywordflow">if</span> (PrivilegeSet != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01780         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( PrivilegeSet );
01781     }
01782 
01783     <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a> ( &amp;SubjectSecurityContext );
01784 
01785     <a class="code" href="../../d2/d5/se_2capture_8c.html#a2">SeReleaseSecurityDescriptor</a> ( CapturedSecurityDescriptor,
01786                                   PreviousMode,
01787                                   <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01788 
01789     <span class="keywordflow">if</span> (CapturedSubsystemName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01790       <a class="code" href="../../d3/d5/seaudit_8c.html#a6">SepFreeCapturedString</a>( CapturedSubsystemName );
01791     }
01792 
01793     <span class="keywordflow">if</span> (CapturedObjectTypeName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01794       <a class="code" href="../../d3/d5/seaudit_8c.html#a6">SepFreeCapturedString</a>( CapturedObjectTypeName );
01795     }
01796 
01797     <span class="keywordflow">if</span> (CapturedObjectName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01798       <a class="code" href="../../d3/d5/seaudit_8c.html#a6">SepFreeCapturedString</a>( CapturedObjectName );
01799     }
01800 
01801     <span class="keywordflow">if</span> (CapturedPrincipalSelfSid != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01802         <a class="code" href="../../d2/d5/se_2capture_8c.html#a9">SeReleaseSid</a>( CapturedPrincipalSelfSid, PreviousMode, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01803     }
01804 
01805     <span class="keywordflow">if</span> ( LocalObjectTypeList != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01806         <a class="code" href="../../d8/d3/tokenp_8h.html#a22">SeFreeCapturedObjectTypeList</a>( LocalObjectTypeList );
01807     }
01808 
01809     <span class="keywordflow">if</span> ( LocalGrantedAccessAllocated ) {
01810         <span class="keywordflow">if</span> ( LocalGrantedAccessPointer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01811             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( LocalGrantedAccessPointer );
01812         }
01813     }
01814 
01815     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01816 }
01817 
01818 
01819 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01820"></a><a class="code" href="../../d3/d5/seaudit_8c.html#a16">01820</a> <a class="code" href="../../d3/d5/seaudit_8c.html#a16">NtAccessCheckAndAuditAlarm</a> (
01821     IN PUNICODE_STRING SubsystemName,
01822     IN PVOID HandleId,
01823     IN PUNICODE_STRING ObjectTypeName,
01824     IN PUNICODE_STRING ObjectName,
01825     IN PSECURITY_DESCRIPTOR SecurityDescriptor,
01826     IN ACCESS_MASK DesiredAccess,
01827     IN PGENERIC_MAPPING GenericMapping,
01828     IN BOOLEAN ObjectCreation,
01829     OUT PACCESS_MASK GrantedAccess,
01830     OUT PNTSTATUS AccessStatus,
01831     OUT PBOOLEAN GenerateOnClose
01832     )
01833 <span class="comment">/*++</span>
01834 <span class="comment"></span>
01835 <span class="comment">Routine Description:</span>
01836 <span class="comment"></span>
01837 <span class="comment">    See SepAccessCheckAndAuditAlarm.</span>
01838 <span class="comment"></span>
01839 <span class="comment">Arguments:</span>
01840 <span class="comment"></span>
01841 <span class="comment">    See SepAccessCheckAndAuditAlarm.</span>
01842 <span class="comment"></span>
01843 <span class="comment">Return Value:</span>
01844 <span class="comment"></span>
01845 <span class="comment">    STATUS_SUCCESS - Indicates the call completed successfully.  In this</span>
01846 <span class="comment">        case, ClientStatus receives the result of the access check.</span>
01847 <span class="comment"></span>
01848 <span class="comment">    STATUS_PRIVILEGE_NOT_HELD - Indicates the caller does not have</span>
01849 <span class="comment">        sufficient privilege to use this privileged system service.</span>
01850 <span class="comment"></span>
01851 <span class="comment">--*/</span>
01852 
01853 {
01854     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01855     <span class="keywordflow">return</span> <a class="code" href="../../d3/d5/seaudit_8c.html#a9">SepAccessCheckAndAuditAlarm</a>(
01856             SubsystemName,
01857             HandleId,
01858             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01859             ObjectTypeName,
01860             ObjectName,
01861             SecurityDescriptor,
01862             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,       <span class="comment">// No Principal Self sid</span>
01863             DesiredAccess,
01864             AuditEventObjectAccess,  <span class="comment">// Default to ObjectAccess</span>
01865             0,          <span class="comment">// No Flags</span>
01866             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,       <span class="comment">// No ObjectType List</span>
01867             0,          <span class="comment">// No ObjectType List</span>
01868             GenericMapping,
01869             ObjectCreation,
01870             GrantedAccess,
01871             AccessStatus,
01872             GenerateOnClose,
01873             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );    <span class="comment">// Return a single GrantedAccess and AccessStatus</span>
01874 
01875 }
01876 
01877 
01878 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01879"></a><a class="code" href="../../d3/d5/seaudit_8c.html#a17">01879</a> <a class="code" href="../../d3/d5/seaudit_8c.html#a17">NtAccessCheckByTypeAndAuditAlarm</a> (
01880     IN PUNICODE_STRING SubsystemName,
01881     IN PVOID HandleId,
01882     IN PUNICODE_STRING ObjectTypeName,
01883     IN PUNICODE_STRING ObjectName,
01884     IN PSECURITY_DESCRIPTOR SecurityDescriptor,
01885     IN PSID PrincipalSelfSid,
01886     IN ACCESS_MASK DesiredAccess,
01887     IN AUDIT_EVENT_TYPE AuditType,
01888     IN ULONG Flags,
01889     IN POBJECT_TYPE_LIST ObjectTypeList OPTIONAL,
01890     IN ULONG ObjectTypeListLength,
01891     IN PGENERIC_MAPPING GenericMapping,
01892     IN BOOLEAN ObjectCreation,
01893     OUT PACCESS_MASK GrantedAccess,
01894     OUT PNTSTATUS AccessStatus,
01895     OUT PBOOLEAN GenerateOnClose
01896     )
01897 <span class="comment">/*++</span>
01898 <span class="comment"></span>
01899 <span class="comment">Routine Description:</span>
01900 <span class="comment"></span>
01901 <span class="comment">    See SepAccessCheckAndAuditAlarm.</span>
01902 <span class="comment"></span>
01903 <span class="comment">Arguments:</span>
01904 <span class="comment"></span>
01905 <span class="comment">    See SepAccessCheckAndAuditAlarm.</span>
01906 <span class="comment"></span>
01907 <span class="comment">Return Value:</span>
01908 <span class="comment"></span>
01909 <span class="comment">    STATUS_SUCCESS - Indicates the call completed successfully.  In this</span>
01910 <span class="comment">        case, ClientStatus receives the result of the access check.</span>
01911 <span class="comment"></span>
01912 <span class="comment">    STATUS_PRIVILEGE_NOT_HELD - Indicates the caller does not have</span>
01913 <span class="comment">        sufficient privilege to use this privileged system service.</span>
01914 <span class="comment"></span>
01915 <span class="comment">--*/</span>
01916 
01917 {
01918     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01919     <span class="keywordflow">return</span> <a class="code" href="../../d3/d5/seaudit_8c.html#a9">SepAccessCheckAndAuditAlarm</a>(
01920             SubsystemName,
01921             HandleId,
01922             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01923             ObjectTypeName,
01924             ObjectName,
01925             SecurityDescriptor,
01926             PrincipalSelfSid,
01927             DesiredAccess,
01928             AuditType,
01929             Flags,
01930             ObjectTypeList,
01931             ObjectTypeListLength,
01932             GenericMapping,
01933             ObjectCreation,
01934             GrantedAccess,
01935             AccessStatus,
01936             GenerateOnClose,
01937             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );  <span class="comment">// Return a single GrantedAccess and AccessStatus</span>
01938 
01939 }
01940 
01941 
01942 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01943"></a><a class="code" href="../../d3/d5/seaudit_8c.html#a18">01943</a> <a class="code" href="../../d3/d5/seaudit_8c.html#a18">NtAccessCheckByTypeResultListAndAuditAlarm</a> (
01944     IN PUNICODE_STRING SubsystemName,
01945     IN PVOID HandleId,
01946     IN PUNICODE_STRING ObjectTypeName,
01947     IN PUNICODE_STRING ObjectName,
01948     IN PSECURITY_DESCRIPTOR SecurityDescriptor,
01949     IN PSID PrincipalSelfSid,
01950     IN ACCESS_MASK DesiredAccess,
01951     IN AUDIT_EVENT_TYPE AuditType,
01952     IN ULONG Flags,
01953     IN POBJECT_TYPE_LIST ObjectTypeList OPTIONAL,
01954     IN ULONG ObjectTypeListLength,
01955     IN PGENERIC_MAPPING GenericMapping,
01956     IN BOOLEAN ObjectCreation,
01957     OUT PACCESS_MASK GrantedAccess,
01958     OUT PNTSTATUS AccessStatus,
01959     OUT PBOOLEAN GenerateOnClose
01960     )
01961 <span class="comment">/*++</span>
01962 <span class="comment"></span>
01963 <span class="comment">Routine Description:</span>
01964 <span class="comment"></span>
01965 <span class="comment">    See SepAccessCheckAndAuditAlarm.</span>
01966 <span class="comment"></span>
01967 <span class="comment">Arguments:</span>
01968 <span class="comment"></span>
01969 <span class="comment">    See SepAccessCheckAndAuditAlarm.</span>
01970 <span class="comment"></span>
01971 <span class="comment">Return Value:</span>
01972 <span class="comment"></span>
01973 <span class="comment">    STATUS_SUCCESS - Indicates the call completed successfully.  In this</span>
01974 <span class="comment">        case, ClientStatus receives the result of the access check.</span>
01975 <span class="comment"></span>
01976 <span class="comment">    STATUS_PRIVILEGE_NOT_HELD - Indicates the caller does not have</span>
01977 <span class="comment">        sufficient privilege to use this privileged system service.</span>
01978 <span class="comment"></span>
01979 <span class="comment">--*/</span>
01980 
01981 {
01982     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01983     <span class="keywordflow">return</span> <a class="code" href="../../d3/d5/seaudit_8c.html#a9">SepAccessCheckAndAuditAlarm</a>(
01984             SubsystemName,
01985             HandleId,
01986             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01987             ObjectTypeName,
01988             ObjectName,
01989             SecurityDescriptor,
01990             PrincipalSelfSid,
01991             DesiredAccess,
01992             AuditType,
01993             Flags,
01994             ObjectTypeList,
01995             ObjectTypeListLength,
01996             GenericMapping,
01997             ObjectCreation,
01998             GrantedAccess,
01999             AccessStatus,
02000             GenerateOnClose,
02001             <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );  <span class="comment">// Return an array of GrantedAccess and AccessStatus</span>
02002 
02003 }
02004 
02005 
02006 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02007"></a><a class="code" href="../../d3/d5/seaudit_8c.html#a19">02007</a> <a class="code" href="../../d3/d5/seaudit_8c.html#a19">NtAccessCheckByTypeResultListAndAuditAlarmByHandle</a> (
02008     IN PUNICODE_STRING SubsystemName,
02009     IN PVOID HandleId,
02010     IN HANDLE ClientToken,
02011     IN PUNICODE_STRING ObjectTypeName,
02012     IN PUNICODE_STRING ObjectName,
02013     IN PSECURITY_DESCRIPTOR SecurityDescriptor,
02014     IN PSID PrincipalSelfSid,
02015     IN ACCESS_MASK DesiredAccess,
02016     IN AUDIT_EVENT_TYPE AuditType,
02017     IN ULONG Flags,
02018     IN POBJECT_TYPE_LIST ObjectTypeList OPTIONAL,
02019     IN ULONG ObjectTypeListLength,
02020     IN PGENERIC_MAPPING GenericMapping,
02021     IN BOOLEAN ObjectCreation,
02022     OUT PACCESS_MASK GrantedAccess,
02023     OUT PNTSTATUS AccessStatus,
02024     OUT PBOOLEAN GenerateOnClose
02025     )
02026 <span class="comment">/*++</span>
02027 <span class="comment"></span>
02028 <span class="comment">Routine Description:</span>
02029 <span class="comment"></span>
02030 <span class="comment">    See SepAccessCheckAndAuditAlarm.</span>
02031 <span class="comment"></span>
02032 <span class="comment">Arguments:</span>
02033 <span class="comment"></span>
02034 <span class="comment">    See SepAccessCheckAndAuditAlarm.</span>
02035 <span class="comment"></span>
02036 <span class="comment">Return Value:</span>
02037 <span class="comment"></span>
02038 <span class="comment">    STATUS_SUCCESS - Indicates the call completed successfully.  In this</span>
02039 <span class="comment">        case, ClientStatus receives the result of the access check.</span>
02040 <span class="comment"></span>
02041 <span class="comment">    STATUS_PRIVILEGE_NOT_HELD - Indicates the caller does not have</span>
02042 <span class="comment">        sufficient privilege to use this privileged system service.</span>
02043 <span class="comment"></span>
02044 <span class="comment">--*/</span>
02045 
02046 {
02047     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02048     <span class="keywordflow">return</span> <a class="code" href="../../d3/d5/seaudit_8c.html#a9">SepAccessCheckAndAuditAlarm</a>(
02049             SubsystemName,
02050             HandleId,
02051             &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a16">ClientToken</a>,
02052             ObjectTypeName,
02053             ObjectName,
02054             SecurityDescriptor,
02055             PrincipalSelfSid,
02056             DesiredAccess,
02057             AuditType,
02058             Flags,
02059             ObjectTypeList,
02060             ObjectTypeListLength,
02061             GenericMapping,
02062             ObjectCreation,
02063             GrantedAccess,
02064             AccessStatus,
02065             GenerateOnClose,
02066             <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );  <span class="comment">// Return an array of GrantedAccess and AccessStatus</span>
02067 
02068 }
02069 
02070 
02071 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02072"></a><a class="code" href="../../d3/d5/seaudit_8c.html#a20">02072</a> <a class="code" href="../../d3/d5/seaudit_8c.html#a20">NtOpenObjectAuditAlarm</a> (
02073     IN PUNICODE_STRING SubsystemName,
02074     IN PVOID HandleId OPTIONAL,
02075     IN PUNICODE_STRING ObjectTypeName,
02076     IN PUNICODE_STRING ObjectName,
02077     IN PSECURITY_DESCRIPTOR SecurityDescriptor OPTIONAL,
02078     IN HANDLE ClientToken,
02079     IN ACCESS_MASK DesiredAccess,
02080     IN ACCESS_MASK GrantedAccess,
02081     IN PPRIVILEGE_SET Privileges OPTIONAL,
02082     IN BOOLEAN ObjectCreation,
02083     IN BOOLEAN AccessGranted,
02084     OUT PBOOLEAN GenerateOnClose
02085     )
02086 <span class="comment">/*++</span>
02087 <span class="comment"></span>
02088 <span class="comment">    Routine Description:</span>
02089 <span class="comment"></span>
02090 <span class="comment">    This routine is used to generate audit and alarm messages when an</span>
02091 <span class="comment">    attempt is made to access an existing protected subsystem object or</span>
02092 <span class="comment">    create a new one.  This routine may result in several messages being</span>
02093 <span class="comment">    generated and sent to Port objects.  This may result in a significant</span>
02094 <span class="comment">    latency before returning.  Design of routines that must call this</span>
02095 <span class="comment">    routine must take this potential latency into account.  This may have</span>
02096 <span class="comment">    an impact on the approach taken for data structure mutex locking, for</span>
02097 <span class="comment">    example.</span>
02098 <span class="comment"></span>
02099 <span class="comment">    This routine may not be able to generate a complete audit record</span>
02100 <span class="comment">    due to memory restrictions.</span>
02101 <span class="comment"></span>
02102 <span class="comment">    This API requires the caller have SeAuditPrivilege privilege.  The test</span>
02103 <span class="comment">    for this privilege is always against the primary token of the calling</span>
02104 <span class="comment">    process, not the impersonation token of the thread.</span>
02105 <span class="comment"></span>
02106 <span class="comment">Arguments:</span>
02107 <span class="comment"></span>
02108 <span class="comment">    SubsystemName - Supplies a name string identifying the</span>
02109 <span class="comment">        subsystem calling the routine.</span>
02110 <span class="comment"></span>
02111 <span class="comment">    HandleId - A unique value representing the client's handle to the</span>
02112 <span class="comment">        object.  If the access attempt was not successful (AccessGranted is</span>
02113 <span class="comment">        FALSE), then this parameter is ignored.</span>
02114 <span class="comment"></span>
02115 <span class="comment">    ObjectTypeName - Supplies the name of the type of object being</span>
02116 <span class="comment">        accessed.</span>
02117 <span class="comment"></span>
02118 <span class="comment">    ObjectName - Supplies the name of the object the client</span>
02119 <span class="comment">        accessed or attempted to access.</span>
02120 <span class="comment"></span>
02121 <span class="comment">    SecurityDescriptor - An optional pointer to the security descriptor of</span>
02122 <span class="comment">        the object being accessed.</span>
02123 <span class="comment"></span>
02124 <span class="comment">    ClientToken - A handle to a token object representing the client that</span>
02125 <span class="comment">        requested the operation.  This handle must be obtained from a</span>
02126 <span class="comment">        communication session layer, such as from an LPC Port or Local</span>
02127 <span class="comment">        Named Pipe, to prevent possible security policy violations.</span>
02128 <span class="comment"></span>
02129 <span class="comment">    DesiredAccess - The desired access mask.  This mask must have been</span>
02130 <span class="comment">        previously mapped to contain no generic accesses.</span>
02131 <span class="comment"></span>
02132 <span class="comment">    GrantedAccess - The mask of accesses that were actually granted.</span>
02133 <span class="comment"></span>
02134 <span class="comment">    Privileges - Optionally points to a set of privileges that were</span>
02135 <span class="comment">        required for the access attempt.  Those privileges that were held</span>
02136 <span class="comment">        by the subject are marked using the UsedForAccess flag of the</span>
02137 <span class="comment">        attributes associated with each privilege.</span>
02138 <span class="comment"></span>
02139 <span class="comment">    ObjectCreation - A boolean flag indicating whether the access will</span>
02140 <span class="comment">        result in a new object being created if granted.  A value of TRUE</span>
02141 <span class="comment">        indicates an object will be created, FALSE indicates an existing</span>
02142 <span class="comment">        object will be opened.</span>
02143 <span class="comment"></span>
02144 <span class="comment">    AccessGranted - Indicates whether the requested access was granted or</span>
02145 <span class="comment">        not.  A value of TRUE indicates the access was granted.  A value of</span>
02146 <span class="comment">        FALSE indicates the access was not granted.</span>
02147 <span class="comment"></span>
02148 <span class="comment">    GenerateOnClose - Points to a boolean that is set by the audit</span>
02149 <span class="comment">        generation routine and must be passed to NtCloseObjectAuditAlarm()</span>
02150 <span class="comment">        when the object handle is closed.</span>
02151 <span class="comment"></span>
02152 <span class="comment">Return Value:</span>
02153 <span class="comment"></span>
02154 <span class="comment">--*/</span>
02155 {
02156 
02157     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
02158     ULONG PrivilegeParameterLength;
02159     PUNICODE_STRING CapturedSubsystemName = (PUNICODE_STRING) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02160     PUNICODE_STRING CapturedObjectTypeName = (PUNICODE_STRING) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02161     PUNICODE_STRING CapturedObjectName = (PUNICODE_STRING) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02162     PSECURITY_DESCRIPTOR CapturedSecurityDescriptor = (PSECURITY_DESCRIPTOR) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02163     PPRIVILEGE_SET CapturedPrivileges = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02164     BOOLEAN LocalGenerateOnClose = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02165     <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">SECURITY_SUBJECT_CONTEXT</a> SubjectSecurityContext;
02166     BOOLEAN Result;
02167     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02168     BOOLEAN GenerateAudit = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02169     BOOLEAN GenerateAlarm = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02170     PLUID ClientAuthenticationId = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02171     HANDLE CapturedHandleId = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02172     BOOLEAN AuditPerformed;
02173     ULONG PrivilegeCount;
02174 
02175     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
02176 
02177     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02178 
02179     PreviousMode = KeGetPreviousMode();
02180 
02181     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a> );
02182 
02183     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a16">ClientToken</a>,             <span class="comment">// Handle</span>
02184                                         TOKEN_QUERY,             <span class="comment">// DesiredAccess</span>
02185                                         <a class="code" href="../../d0/d5/se_8h.html#a36">SepTokenObjectType</a>,      <span class="comment">// ObjectType</span>
02186                                         PreviousMode,            <span class="comment">// AccessMode</span>
02187                                         (PVOID *)&amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,         <span class="comment">// Object</span>
02188                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>                     <span class="comment">// GrantedAccess</span>
02189                                         );
02190 
02191     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02192         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
02193     }
02194 
02195     <span class="comment">//</span>
02196     <span class="comment">// If the passed token is an impersonation token, make sure</span>
02197     <span class="comment">// it is at SecurityIdentification or above.</span>
02198     <span class="comment">//</span>
02199 
02200     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;TokenType == TokenImpersonation) {
02201 
02202         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;ImpersonationLevel &lt; SecurityIdentification) {
02203 
02204             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( (PVOID)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
02205 
02206             <span class="keywordflow">return</span>( STATUS_BAD_IMPERSONATION_LEVEL );
02207 
02208         }
02209     }
02210 
02211     <span class="comment">//</span>
02212     <span class="comment">// Check for SeAuditPrivilege.  This must be tested against</span>
02213     <span class="comment">// the caller's primary token.</span>
02214     <span class="comment">//</span>
02215 
02216     <a class="code" href="../../d0/d8/subject_8c.html#a0">SeCaptureSubjectContext</a> ( &amp;SubjectSecurityContext );
02217 
02218     Result = <a class="code" href="../../d3/d5/seaudit_8c.html#a11">SeCheckAuditPrivilege</a> (
02219                  &amp;SubjectSecurityContext,
02220                  PreviousMode
02221                  );
02222 
02223     <span class="keywordflow">if</span> (!Result) {
02224 
02225         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( (PVOID)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
02226 
02227         <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a> ( &amp;SubjectSecurityContext );
02228 
02229         <span class="keywordflow">return</span>(STATUS_PRIVILEGE_NOT_HELD);
02230     }
02231 
02232     <span class="comment">//</span>
02233     <span class="comment">// This will just return NULL if the input descriptor is NULL</span>
02234     <span class="comment">//</span>
02235 
02236     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/se_2capture_8c.html#a1">SeCaptureSecurityDescriptor</a> ( SecurityDescriptor,
02237                                            PreviousMode,
02238                                            <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
02239                                            <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
02240                                            &amp;CapturedSecurityDescriptor
02241                                            );
02242 
02243     <span class="comment">//</span>
02244     <span class="comment">// At this point in time, if there's no security descriptor, there's</span>
02245     <span class="comment">// nothing to do.  Return success.</span>
02246     <span class="comment">//</span>
02247 
02248     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) || CapturedSecurityDescriptor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02249 
02250         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( (PVOID)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
02251 
02252         <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a> ( &amp;SubjectSecurityContext );
02253 
02254         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
02255     }
02256 
02257     <span class="keywordflow">try</span> {
02258 
02259         <span class="comment">//</span>
02260         <span class="comment">// Only capture the privileges if we've completed a successful</span>
02261         <span class="comment">// access check.  Otherwise they don't mean anything.</span>
02262         <span class="comment">//</span>
02263 
02264         <span class="keywordflow">if</span> (AccessGranted &amp;&amp; ARGUMENT_PRESENT(Privileges)) {
02265 
02266             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(
02267                 Privileges,
02268                 <span class="keyword">sizeof</span>(PRIVILEGE_SET),
02269                 <span class="keyword">sizeof</span>(ULONG)
02270                 );
02271 
02272             PrivilegeCount = Privileges-&gt;PrivilegeCount;
02273             <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d6/sep_8h.html#a11">IsValidElementCount</a>( PrivilegeCount, LUID_AND_ATTRIBUTES) ) {
02274                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
02275                 leave;
02276             }
02277 
02278             PrivilegeParameterLength = (ULONG)<span class="keyword">sizeof</span>(PRIVILEGE_SET) +
02279                               ((PrivilegeCount - <a class="code" href="../../d5/d4/acpitabl_8h.html#a44">ANYSIZE_ARRAY</a>) *
02280                                 (ULONG)<span class="keyword">sizeof</span>(LUID_AND_ATTRIBUTES)  );
02281 
02282             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(
02283                 Privileges,
02284                 PrivilegeParameterLength,
02285                 <span class="keyword">sizeof</span>(ULONG)
02286                 );
02287 
02288             CapturedPrivileges = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
02289                                                         PrivilegeParameterLength,
02290                                                         'rPeS'
02291                                                       );
02292 
02293             <span class="keywordflow">if</span> (CapturedPrivileges != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02294 
02295                 RtlCopyMemory ( CapturedPrivileges,
02296                                 Privileges,
02297                                 PrivilegeParameterLength );
02298                 CapturedPrivileges-&gt;PrivilegeCount = PrivilegeCount;
02299             } <span class="keywordflow">else</span> {
02300 
02301                 <a class="code" href="../../d2/d5/se_2capture_8c.html#a2">SeReleaseSecurityDescriptor</a> ( CapturedSecurityDescriptor,
02302                                               PreviousMode,
02303                                               <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
02304 
02305                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( (PVOID)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
02306                 <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a> ( &amp;SubjectSecurityContext );
02307                 <span class="keywordflow">return</span>( STATUS_INSUFFICIENT_RESOURCES );
02308             }
02309 
02310 
02311         }
02312 
02313         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( HandleId )) {
02314 
02315             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( (PHANDLE)HandleId, <span class="keyword">sizeof</span>(PVOID), <span class="keyword">sizeof</span>(PVOID) );
02316             CapturedHandleId = *(PHANDLE)HandleId;
02317         }
02318 
02319         <a class="code" href="../../d5/d8/ex_8h.html#a28">ProbeForWriteBoolean</a>(GenerateOnClose);
02320 
02321         <span class="comment">//</span>
02322         <span class="comment">// Probe and Capture the parameter strings.</span>
02323         <span class="comment">// If we run out of memory attempting to capture</span>
02324         <span class="comment">// the strings, the returned pointer will be</span>
02325         <span class="comment">// NULL and we will continue with the audit.</span>
02326         <span class="comment">//</span>
02327 
02328         <a class="code" href="../../d3/d5/seaudit_8c.html#a5">SepProbeAndCaptureString_U</a> ( SubsystemName,
02329                                      &amp;CapturedSubsystemName );
02330 
02331         <a class="code" href="../../d3/d5/seaudit_8c.html#a5">SepProbeAndCaptureString_U</a> ( ObjectTypeName,
02332                                      &amp;CapturedObjectTypeName );
02333 
02334         <a class="code" href="../../d3/d5/seaudit_8c.html#a5">SepProbeAndCaptureString_U</a> ( ObjectName,
02335                                      &amp;CapturedObjectName );
02336 
02337     } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
02338         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
02339     }
02340 
02341     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02342 
02343         <span class="keywordflow">if</span> (CapturedSubsystemName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02344           <a class="code" href="../../d3/d5/seaudit_8c.html#a6">SepFreeCapturedString</a>( CapturedSubsystemName );
02345         }
02346 
02347         <span class="keywordflow">if</span> (CapturedObjectTypeName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02348           <a class="code" href="../../d3/d5/seaudit_8c.html#a6">SepFreeCapturedString</a>( CapturedObjectTypeName );
02349         }
02350 
02351         <span class="keywordflow">if</span> (CapturedObjectName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02352           <a class="code" href="../../d3/d5/seaudit_8c.html#a6">SepFreeCapturedString</a>( CapturedObjectName );
02353         }
02354 
02355         <span class="keywordflow">if</span> (CapturedPrivileges != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02356           <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( CapturedPrivileges );
02357         }
02358 
02359         <span class="keywordflow">if</span> (CapturedSecurityDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02360 
02361             <a class="code" href="../../d2/d5/se_2capture_8c.html#a2">SeReleaseSecurityDescriptor</a> ( CapturedSecurityDescriptor,
02362                                           PreviousMode,
02363                                           <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
02364         }
02365 
02366         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( (PVOID)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
02367 
02368         <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a> ( &amp;SubjectSecurityContext );
02369 
02370         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02371 
02372     }
02373 
02374     <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d5/adtp_8h.html#a1">SepAdtAuditThisEvent</a>( AuditCategoryObjectAccess, &amp;AccessGranted) ) {
02375 
02376         <a class="code" href="../../d6/d6/sep_8h.html#a62">SepExamineSacl</a>(
02377             RtlpSaclAddrSecurityDescriptor( (PISECURITY_DESCRIPTOR)CapturedSecurityDescriptor ),
02378             <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,
02379             DesiredAccess | GrantedAccess,
02380             AccessGranted,
02381             &amp;GenerateAudit,
02382             &amp;GenerateAlarm
02383             );
02384 
02385         <span class="keywordflow">if</span> (GenerateAudit || GenerateAlarm) {
02386 
02387             <span class="comment">//</span>
02388             <span class="comment">// Take a read lock on the token, because we're going to extract</span>
02389             <span class="comment">// the user's Sid from it.</span>
02390             <span class="comment">//</span>
02391 
02392             LocalGenerateOnClose = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02393 
02394             AuditPerformed = <a class="code" href="../../d7/d6/sepaudit_8c.html#a11">SepAdtOpenObjectAuditAlarm</a> ( CapturedSubsystemName,
02395                                                           ARGUMENT_PRESENT(HandleId) ? (PVOID)&amp;CapturedHandleId : <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02396                                                           CapturedObjectTypeName,
02397                                                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02398                                                           CapturedObjectName,
02399                                                           <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,
02400                                                           SubjectSecurityContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o2">PrimaryToken</a>,
02401                                                           DesiredAccess,
02402                                                           GrantedAccess,
02403                                                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02404                                                           CapturedPrivileges,
02405                                                           ObjectCreation,
02406                                                           AccessGranted,
02407                                                           GenerateAudit,
02408                                                           GenerateAlarm,
02409                                                           <a class="code" href="../../d1/d9/ps_8h.html#a25">PsProcessAuditId</a>( <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() ),
02410                                                           AuditCategoryObjectAccess,
02411                                                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02412                                                           0,
02413                                                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02414                                                           );
02415 
02416             LocalGenerateOnClose = AuditPerformed;
02417         }
02418     }
02419 
02420     <span class="keywordflow">if</span> ( !(GenerateAudit || GenerateAlarm) ) {
02421 
02422         <span class="comment">//</span>
02423         <span class="comment">// We didn't attempt to generate an audit above, so if privileges were used,</span>
02424         <span class="comment">// see if we should generate an audit here.</span>
02425         <span class="comment">//</span>
02426 
02427         <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(Privileges) ) {
02428 
02429             <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d5/adtp_8h.html#a1">SepAdtAuditThisEvent</a>( AuditCategoryPrivilegeUse, &amp;AccessGranted) ) {
02430 
02431                 AuditPerformed = <a class="code" href="../../d7/d6/sepaudit_8c.html#a9">SepAdtPrivilegeObjectAuditAlarm</a> ( CapturedSubsystemName,
02432                                                                    CapturedHandleId,
02433                                                                    <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,
02434                                                                    SubjectSecurityContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o2">PrimaryToken</a>,
02435                                                                    <a class="code" href="../../d1/d9/ps_8h.html#a25">PsProcessAuditId</a>( <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() ),
02436                                                                    DesiredAccess,
02437                                                                    CapturedPrivileges,
02438                                                                    AccessGranted
02439                                                                    );
02440                 <span class="comment">//</span>
02441                 <span class="comment">// If we generate an audit due to use of privilege, don't set generate on close,</span>
02442                 <span class="comment">// because then we'll have a close audit without a corresponding open audit.</span>
02443                 <span class="comment">//</span>
02444 
02445                 LocalGenerateOnClose = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02446             }
02447         }
02448     }
02449 
02450     <span class="keywordflow">if</span> (CapturedSecurityDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02451 
02452         <a class="code" href="../../d2/d5/se_2capture_8c.html#a2">SeReleaseSecurityDescriptor</a> ( CapturedSecurityDescriptor,
02453                                       PreviousMode,
02454                                       <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
02455     }
02456 
02457     <span class="keywordflow">if</span> (CapturedSubsystemName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02458       <a class="code" href="../../d3/d5/seaudit_8c.html#a6">SepFreeCapturedString</a>( CapturedSubsystemName );
02459     }
02460 
02461     <span class="keywordflow">if</span> (CapturedObjectTypeName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02462       <a class="code" href="../../d3/d5/seaudit_8c.html#a6">SepFreeCapturedString</a>( CapturedObjectTypeName );
02463     }
02464 
02465     <span class="keywordflow">if</span> (CapturedObjectName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02466       <a class="code" href="../../d3/d5/seaudit_8c.html#a6">SepFreeCapturedString</a>( CapturedObjectName );
02467     }
02468 
02469     <span class="keywordflow">if</span> (CapturedPrivileges != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02470       <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( CapturedPrivileges );
02471     }
02472 
02473     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( (PVOID)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
02474 
02475     <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a> ( &amp;SubjectSecurityContext );
02476 
02477     <span class="keywordflow">try</span> {
02478 
02479         *GenerateOnClose = LocalGenerateOnClose;
02480 
02481     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
02482 
02483             <span class="keywordflow">return</span> GetExceptionCode();
02484     }
02485 
02486     <span class="keywordflow">return</span>(STATUS_SUCCESS);
02487 }
02488 
02489 
02490 
02491 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02492"></a><a class="code" href="../../d3/d5/seaudit_8c.html#a21">02492</a> <a class="code" href="../../d3/d5/seaudit_8c.html#a21">NtCloseObjectAuditAlarm</a> (
02493     IN PUNICODE_STRING SubsystemName,
02494     IN PVOID HandleId,
02495     IN BOOLEAN GenerateOnClose
02496     )
02497 
02498 <span class="comment">/*++</span>
02499 <span class="comment"></span>
02500 <span class="comment">Routine Description:</span>
02501 <span class="comment"></span>
02502 <span class="comment">    This routine is used to generate audit and alarm messages when a handle</span>
02503 <span class="comment">    to a protected subsystem object is deleted.  This routine may result in</span>
02504 <span class="comment">    several messages being generated and sent to Port objects.  This may</span>
02505 <span class="comment">    result in a significant latency before returning.  Design of routines</span>
02506 <span class="comment">    that must call this routine must take this potential latency into</span>
02507 <span class="comment">    account.  This may have an impact on the approach taken for data</span>
02508 <span class="comment">    structure mutex locking, for example.</span>
02509 <span class="comment"></span>
02510 <span class="comment">    This API requires the caller have SeAuditPrivilege privilege.  The test</span>
02511 <span class="comment">    for this privilege is always against the primary token of the calling</span>
02512 <span class="comment">    process, allowing the caller to be impersonating a client during the</span>
02513 <span class="comment">    call with no ill effects.</span>
02514 <span class="comment"></span>
02515 <span class="comment">Arguments:</span>
02516 <span class="comment"></span>
02517 <span class="comment">    SubsystemName - Supplies a name string identifying the subsystem</span>
02518 <span class="comment">        calling the routine.</span>
02519 <span class="comment"></span>
02520 <span class="comment">    HandleId - A unique value representing the client's handle to the</span>
02521 <span class="comment">        object.</span>
02522 <span class="comment"></span>
02523 <span class="comment">    GenerateOnClose - Is a boolean value returned from a corresponding</span>
02524 <span class="comment">        NtAccessCheckAndAuditAlarm() call or NtOpenObjectAuditAlarm() call</span>
02525 <span class="comment">        when the object handle was created.</span>
02526 <span class="comment"></span>
02527 <span class="comment">Return value:</span>
02528 <span class="comment"></span>
02529 <span class="comment">--*/</span>
02530 
02531 {
02532     BOOLEAN Result;
02533     <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">SECURITY_SUBJECT_CONTEXT</a> SubjectSecurityContext;
02534     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
02535     PUNICODE_STRING CapturedSubsystemName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02536     PSID UserSid;
02537     PSID CapturedUserSid = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02538     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02539 
02540     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02541 
02542     PreviousMode = KeGetPreviousMode();
02543 
02544     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>);
02545 
02546     <span class="keywordflow">if</span> (!GenerateOnClose) {
02547         <span class="keywordflow">return</span>( STATUS_SUCCESS );
02548     }
02549 
02550     <span class="comment">//</span>
02551     <span class="comment">// Check for SeAuditPrivilege</span>
02552     <span class="comment">//</span>
02553 
02554     <a class="code" href="../../d0/d8/subject_8c.html#a0">SeCaptureSubjectContext</a> ( &amp;SubjectSecurityContext );
02555 
02556     Result = <a class="code" href="../../d3/d5/seaudit_8c.html#a11">SeCheckAuditPrivilege</a> (
02557                  &amp;SubjectSecurityContext,
02558                  PreviousMode
02559                  );
02560 
02561     <span class="keywordflow">if</span> (!Result) {
02562         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_PRIVILEGE_NOT_HELD;
02563         <span class="keywordflow">goto</span> Cleanup;
02564     }
02565 
02566     UserSid = <a class="code" href="../../d6/d6/sep_8h.html#a8">SepTokenUserSid</a>( <a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a> (&amp;SubjectSecurityContext));
02567 
02568     CapturedUserSid = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
02569                           <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
02570                           <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( UserSid ),
02571                           'iSeS'
02572                           );
02573 
02574     <span class="keywordflow">if</span> ( CapturedUserSid == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
02575         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
02576         <span class="keywordflow">goto</span> Cleanup;
02577     }
02578 
02579     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> =  <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a> (
02580                   <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( UserSid ),
02581                   CapturedUserSid,
02582                   UserSid
02583                   );
02584 
02585     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ));
02586 
02587 
02588     <span class="keywordflow">try</span> {
02589 
02590         <a class="code" href="../../d3/d5/seaudit_8c.html#a5">SepProbeAndCaptureString_U</a> ( SubsystemName,
02591                                    &amp;CapturedSubsystemName );
02592 
02593     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
02594         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
02595         <span class="keywordflow">goto</span> Cleanup;
02596     }
02597 
02598     <span class="comment">//</span>
02599     <span class="comment">// This routine will check to see if auditing is enabled</span>
02600     <span class="comment">//</span>
02601 
02602     <a class="code" href="../../d7/d6/sepaudit_8c.html#a13">SepAdtCloseObjectAuditAlarm</a> ( CapturedSubsystemName,
02603                                HandleId,
02604                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02605                                CapturedUserSid,
02606                                <a class="code" href="../../d6/d6/sep_8h.html#a9">SepTokenAuthenticationId</a>( <a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a>( &amp;SubjectSecurityContext ))
02607                                );
02608 
02609     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
02610 
02611 Cleanup:
02612     <span class="keywordflow">if</span> ( CapturedSubsystemName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
02613         <a class="code" href="../../d3/d5/seaudit_8c.html#a6">SepFreeCapturedString</a>( CapturedSubsystemName );
02614     }
02615 
02616     <span class="keywordflow">if</span> ( CapturedUserSid != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
02617         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( CapturedUserSid );
02618     }
02619 
02620     <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a> ( &amp;SubjectSecurityContext );
02621 
02622     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02623 }
02624 
02625 
02626 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02627"></a><a class="code" href="../../d3/d5/seaudit_8c.html#a22">02627</a> <a class="code" href="../../d3/d5/seaudit_8c.html#a22">NtDeleteObjectAuditAlarm</a> (
02628     IN PUNICODE_STRING SubsystemName,
02629     IN PVOID HandleId,
02630     IN BOOLEAN GenerateOnClose
02631     )
02632 
02633 <span class="comment">/*++</span>
02634 <span class="comment"></span>
02635 <span class="comment">Routine Description:</span>
02636 <span class="comment"></span>
02637 <span class="comment">    This routine is used to generate audit and alarm messages when an object</span>
02638 <span class="comment">    in a protected subsystem object is deleted.  This routine may result in</span>
02639 <span class="comment">    several messages being generated and sent to Port objects.  This may</span>
02640 <span class="comment">    result in a significant latency before returning.  Design of routines</span>
02641 <span class="comment">    that must call this routine must take this potential latency into</span>
02642 <span class="comment">    account.  This may have an impact on the approach taken for data</span>
02643 <span class="comment">    structure mutex locking, for example.</span>
02644 <span class="comment"></span>
02645 <span class="comment">    This API requires the caller have SeAuditPrivilege privilege.  The test</span>
02646 <span class="comment">    for this privilege is always against the primary token of the calling</span>
02647 <span class="comment">    process, allowing the caller to be impersonating a client during the</span>
02648 <span class="comment">    call with no ill effects.</span>
02649 <span class="comment"></span>
02650 <span class="comment">Arguments:</span>
02651 <span class="comment"></span>
02652 <span class="comment">    SubsystemName - Supplies a name string identifying the subsystem</span>
02653 <span class="comment">        calling the routine.</span>
02654 <span class="comment"></span>
02655 <span class="comment">    HandleId - A unique value representing the client's handle to the</span>
02656 <span class="comment">        object.</span>
02657 <span class="comment"></span>
02658 <span class="comment">    GenerateOnClose - Is a boolean value returned from a corresponding</span>
02659 <span class="comment">        NtAccessCheckAndAuditAlarm() call or NtOpenObjectAuditAlarm() call</span>
02660 <span class="comment">        when the object handle was created.</span>
02661 <span class="comment"></span>
02662 <span class="comment">Return value:</span>
02663 <span class="comment"></span>
02664 <span class="comment">--*/</span>
02665 
02666 {
02667     BOOLEAN Result;
02668     <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">SECURITY_SUBJECT_CONTEXT</a> SubjectSecurityContext;
02669     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
02670     PUNICODE_STRING CapturedSubsystemName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02671     PSID UserSid;
02672     PSID CapturedUserSid;
02673     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02674 
02675     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02676 
02677     PreviousMode = KeGetPreviousMode();
02678 
02679     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>);
02680 
02681     <span class="keywordflow">if</span> (!GenerateOnClose) {
02682         <span class="keywordflow">return</span>( STATUS_SUCCESS );
02683     }
02684 
02685     <span class="comment">//</span>
02686     <span class="comment">// Check for SeAuditPrivilege</span>
02687     <span class="comment">//</span>
02688 
02689     <a class="code" href="../../d0/d8/subject_8c.html#a0">SeCaptureSubjectContext</a> ( &amp;SubjectSecurityContext );
02690 
02691     Result = <a class="code" href="../../d3/d5/seaudit_8c.html#a11">SeCheckAuditPrivilege</a> (
02692                  &amp;SubjectSecurityContext,
02693                  PreviousMode
02694                  );
02695 
02696     <span class="keywordflow">if</span> (!Result) {
02697 
02698         <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a> ( &amp;SubjectSecurityContext );
02699         <span class="keywordflow">return</span>(STATUS_PRIVILEGE_NOT_HELD);
02700     }
02701 
02702     UserSid = <a class="code" href="../../d6/d6/sep_8h.html#a8">SepTokenUserSid</a>( <a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a> (&amp;SubjectSecurityContext));
02703 
02704     CapturedUserSid = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
02705                           <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
02706                           <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( UserSid ),
02707                           'iSeS'
02708                           );
02709 
02710     <span class="keywordflow">if</span> ( CapturedUserSid == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
02711         <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a> ( &amp;SubjectSecurityContext );
02712         <span class="keywordflow">return</span>( STATUS_INSUFFICIENT_RESOURCES );
02713     }
02714 
02715     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> =  <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a> (
02716                   <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( UserSid ),
02717                   CapturedUserSid,
02718                   UserSid
02719                   );
02720 
02721     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ));
02722 
02723 
02724     <span class="keywordflow">try</span> {
02725 
02726         <a class="code" href="../../d3/d5/seaudit_8c.html#a5">SepProbeAndCaptureString_U</a> ( SubsystemName,
02727                                    &amp;CapturedSubsystemName );
02728 
02729     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
02730 
02731         <span class="keywordflow">if</span> ( CapturedSubsystemName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
02732             <a class="code" href="../../d3/d5/seaudit_8c.html#a6">SepFreeCapturedString</a>( CapturedSubsystemName );
02733         }
02734 
02735         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( CapturedUserSid );
02736         <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a> ( &amp;SubjectSecurityContext );
02737         <span class="keywordflow">return</span> GetExceptionCode();
02738 
02739     }
02740 
02741     <span class="comment">//</span>
02742     <span class="comment">// This routine will check to see if auditing is enabled</span>
02743     <span class="comment">//</span>
02744 
02745     <a class="code" href="../../d7/d6/sepaudit_8c.html#a14">SepAdtDeleteObjectAuditAlarm</a> ( CapturedSubsystemName,
02746                                HandleId,
02747                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02748                                CapturedUserSid,
02749                                <a class="code" href="../../d6/d6/sep_8h.html#a9">SepTokenAuthenticationId</a>( <a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a>( &amp;SubjectSecurityContext ))
02750                                );
02751 
02752     <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a> ( &amp;SubjectSecurityContext );
02753 
02754     <span class="keywordflow">if</span> ( CapturedSubsystemName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
02755         <a class="code" href="../../d3/d5/seaudit_8c.html#a6">SepFreeCapturedString</a>( CapturedSubsystemName );
02756     }
02757 
02758     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( CapturedUserSid );
02759 
02760     <span class="keywordflow">return</span>(STATUS_SUCCESS);
02761 }
02762 
02763 
02764 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02765"></a><a class="code" href="../../d3/d5/seaudit_8c.html#a23">02765</a> <a class="code" href="../../d3/d5/seaudit_8c.html#a23">SeOpenObjectAuditAlarm</a> (
02766     IN PUNICODE_STRING ObjectTypeName,
02767     IN PVOID Object OPTIONAL,
02768     IN PUNICODE_STRING AbsoluteObjectName OPTIONAL,
02769     IN PSECURITY_DESCRIPTOR SecurityDescriptor,
02770     IN <a class="code" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState,
02771     IN BOOLEAN ObjectCreated,
02772     IN BOOLEAN AccessGranted,
02773     IN KPROCESSOR_MODE AccessMode,
02774     OUT PBOOLEAN GenerateOnClose
02775     )
02776 <span class="comment">/*++</span>
02777 <span class="comment"></span>
02778 <span class="comment">Routine Description:</span>
02779 <span class="comment"></span>
02780 <span class="comment">    SeOpenObjectAuditAlarm is used by the object manager that open objects</span>
02781 <span class="comment">    to generate any necessary audit or alarm messages.  The open may be to</span>
02782 <span class="comment">    existing objects or for newly created objects.  No messages will be</span>
02783 <span class="comment">    generated for Kernel mode accesses.</span>
02784 <span class="comment"></span>
02785 <span class="comment">    This routine is used to generate audit and alarm messages when an</span>
02786 <span class="comment">    attempt is made to open an object.</span>
02787 <span class="comment"></span>
02788 <span class="comment">    This routine may result in several messages being generated and sent to</span>
02789 <span class="comment">    Port objects.  This may result in a significant latency before</span>
02790 <span class="comment">    returning.  Design of routines that must call this routine must take</span>
02791 <span class="comment">    this potential latency into account.  This may have an impact on the</span>
02792 <span class="comment">    approach taken for data structure mutex locking, for example.</span>
02793 <span class="comment"></span>
02794 <span class="comment">Arguments:</span>
02795 <span class="comment"></span>
02796 <span class="comment">    ObjectTypeName - Supplies the name of the type of object being</span>
02797 <span class="comment">        accessed.  This must be the same name provided to the</span>
02798 <span class="comment">        ObCreateObjectType service when the object type was created.</span>
02799 <span class="comment"></span>
02800 <span class="comment">    Object - Address of the object accessed.  This value will not be used</span>
02801 <span class="comment">        as a pointer (referenced).  It is necessary only to enter into log</span>
02802 <span class="comment">        messages.  If the open was not successful, then this argument is</span>
02803 <span class="comment">        ignored.  Otherwise, it must be provided.</span>
02804 <span class="comment"></span>
02805 <span class="comment">    AbsoluteObjectName - Supplies the name of the object being accessed.</span>
02806 <span class="comment">        If the object doesn't have a name, then this field is left null.</span>
02807 <span class="comment">        Otherwise, it must be provided.</span>
02808 <span class="comment"></span>
02809 <span class="comment">    SecurityDescriptor - A pointer to the security descriptor of the</span>
02810 <span class="comment">        object being accessed.</span>
02811 <span class="comment"></span>
02812 <span class="comment">    AccessState - A pointer to an access state structure containing the</span>
02813 <span class="comment">        subject context, the remaining desired access types, the granted</span>
02814 <span class="comment">        access types, and optionally a privilege set to indicate which</span>
02815 <span class="comment">        privileges were used to permit the access.</span>
02816 <span class="comment"></span>
02817 <span class="comment">    ObjectCreated - A boolean flag indicating whether the access resulted</span>
02818 <span class="comment">        in a new object being created.  A value of TRUE indicates an object</span>
02819 <span class="comment">        was created, FALSE indicates an existing object was opened.</span>
02820 <span class="comment"></span>
02821 <span class="comment">    AccessGranted - Indicates if the access was granted or denied based on</span>
02822 <span class="comment">        the access check or privilege check.</span>
02823 <span class="comment"></span>
02824 <span class="comment">    AccessMode - Indicates the access mode used for the access check.  One</span>
02825 <span class="comment">        of UserMode or KernelMode.  Messages will not be generated by</span>
02826 <span class="comment">        kernel mode accesses.</span>
02827 <span class="comment"></span>
02828 <span class="comment">    GenerateOnClose - Points to a boolean that is set by the audit</span>
02829 <span class="comment">        generation routine and must be passed to SeCloseObjectAuditAlarm()</span>
02830 <span class="comment">        when the object handle is closed.</span>
02831 <span class="comment"></span>
02832 <span class="comment">Return value:</span>
02833 <span class="comment"></span>
02834 <span class="comment">    None.</span>
02835 <span class="comment"></span>
02836 <span class="comment">--*/</span>
02837 {
02838     BOOLEAN GenerateAudit = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02839     BOOLEAN GenerateAlarm = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02840     ACCESS_MASK RequestedAccess;
02841     POBJECT_NAME_INFORMATION ObjectNameInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02842     PUNICODE_STRING ObjectTypeNameInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02843     PUNICODE_STRING ObjectName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02844     PUNICODE_STRING LocalObjectTypeName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02845     PLUID PrimaryAuthenticationId = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02846     PLUID ClientAuthenticationId = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02847     BOOLEAN AuditPrivileges = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02848     BOOLEAN AuditPerformed;
02849     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
02850     ACCESS_MASK MappedGrantMask = (ACCESS_MASK)0;
02851     ACCESS_MASK MappedDenyMask = (ACCESS_MASK)0;
02852     <a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html">PAUX_ACCESS_DATA</a> AuxData;
02853 
02854     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02855 
02856     <span class="keywordflow">if</span> ( AccessMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a> ) {
02857         <span class="keywordflow">return</span>;
02858     }
02859 
02860     AuxData = (<a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html">PAUX_ACCESS_DATA</a>)AccessState-&gt;AuxData;
02861 
02862     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> = <a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a>( &amp;AccessState-&gt;SubjectSecurityContext );
02863 
02864     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;AuditData)) {
02865 
02866         MappedGrantMask = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;AuditData-&gt;GrantMask;
02867 
02868         <a class="code" href="../../d8/d6/sertl_8c.html#a70">RtlMapGenericMask</a>(
02869             &amp;MappedGrantMask,
02870             &amp;AuxData-&gt;<a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html#o1">GenericMapping</a>
02871             );
02872 
02873         MappedDenyMask = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;AuditData-&gt;DenyMask;
02874 
02875         <a class="code" href="../../d8/d6/sertl_8c.html#a70">RtlMapGenericMask</a>(
02876             &amp;MappedDenyMask,
02877             &amp;AuxData-&gt;<a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html#o1">GenericMapping</a>
02878             );
02879     }
02880 
02881     <span class="keywordflow">if</span> (SecurityDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02882 
02883         RequestedAccess = AccessState-&gt;RemainingDesiredAccess |
02884                           AccessState-&gt;PreviouslyGrantedAccess;
02885 
02886         <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d5/adtp_8h.html#a1">SepAdtAuditThisEvent</a>( AuditCategoryObjectAccess, &amp;AccessGranted )) {
02887 
02888             <span class="keywordflow">if</span> ( RequestedAccess &amp; (AccessGranted ? MappedGrantMask : MappedDenyMask)) {
02889 
02890                 GenerateAudit = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02891 
02892             } <span class="keywordflow">else</span> {
02893 
02894                 <a class="code" href="../../d6/d6/sep_8h.html#a62">SepExamineSacl</a>(
02895                     RtlpSaclAddrSecurityDescriptor( (PISECURITY_DESCRIPTOR)SecurityDescriptor ),
02896                     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,
02897                     RequestedAccess,
02898                     AccessGranted,
02899                     &amp;GenerateAudit,
02900                     &amp;GenerateAlarm
02901                     );
02902             }
02903 
02904             <span class="comment">//</span>
02905             <span class="comment">// Only generate an audit on close of we're auditing from SACL</span>
02906             <span class="comment">// settings.</span>
02907             <span class="comment">//</span>
02908 
02909             <span class="keywordflow">if</span> (GenerateAudit) {
02910                 *GenerateOnClose = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02911             }
02912         }
02913     }
02914 
02915     <span class="comment">//</span>
02916     <span class="comment">// If we don't generate an audit via the SACL, see if we need to generate</span>
02917     <span class="comment">// one for privilege use.</span>
02918     <span class="comment">//</span>
02919     <span class="comment">// Note that we only audit privileges successfully used to open objects,</span>
02920     <span class="comment">// so we don't care about a failed privilege use here.  Therefore, only</span>
02921     <span class="comment">// do this test of access has been granted.</span>
02922     <span class="comment">//</span>
02923 
02924     <span class="keywordflow">if</span> (!GenerateAudit &amp;&amp; (AccessGranted == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
02925 
02926         <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d5/adtp_8h.html#a1">SepAdtAuditThisEvent</a>( AuditCategoryPrivilegeUse, &amp;AccessGranted )) {
02927 
02928             <span class="keywordflow">if</span> ((AuxData-&gt;<a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html#o0">PrivilegesUsed</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
02929                 (AuxData-&gt;<a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html#o0">PrivilegesUsed</a>-&gt;PrivilegeCount &gt; 0) ) {
02930 
02931                 <span class="comment">//</span>
02932                 <span class="comment">// Make sure these are actually privileges that we want to audit</span>
02933                 <span class="comment">//</span>
02934 
02935                 <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/sep_8h.html#a67">SepFilterPrivilegeAudits</a>( AuxData-&gt;<a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html#o0">PrivilegesUsed</a> )) {
02936 
02937                     GenerateAudit = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02938 
02939                     <span class="comment">//</span>
02940                     <span class="comment">// When we finally try to generate this audit, this flag</span>
02941                     <span class="comment">// will tell us that we need to audit the fact that we</span>
02942                     <span class="comment">// used a privilege, as opposed to audit due to the SACL.</span>
02943                     <span class="comment">//</span>
02944 
02945                     AccessState-&gt;AuditPrivileges = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02946                 }
02947             }
02948         }
02949     }
02950 
02951     <span class="comment">//</span>
02952     <span class="comment">// Set up either to generate an audit (if the access check has failed), or save</span>
02953     <span class="comment">// the stuff that we're going to audit later into the AccessState structure.</span>
02954     <span class="comment">//</span>
02955 
02956     <span class="keywordflow">if</span> (GenerateAudit || GenerateAlarm) {
02957 
02958         AccessState-&gt;GenerateAudit = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02959 
02960         <span class="comment">//</span>
02961         <span class="comment">// Figure out what we've been passed, and obtain as much</span>
02962         <span class="comment">// missing information as possible.</span>
02963         <span class="comment">//</span>
02964 
02965         <span class="keywordflow">if</span> ( !ARGUMENT_PRESENT( AbsoluteObjectName )) {
02966 
02967             <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( Object )) {
02968 
02969                 ObjectNameInfo = <a class="code" href="../../d7/d6/sepaudit_8c.html#a17">SepQueryNameString</a>( Object  );
02970 
02971                 <span class="keywordflow">if</span> ( ObjectNameInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
02972 
02973                     ObjectName = &amp;ObjectNameInfo-&gt;Name;
02974                 }
02975             }
02976 
02977         } <span class="keywordflow">else</span> {
02978 
02979             ObjectName = AbsoluteObjectName;
02980         }
02981 
02982         <span class="keywordflow">if</span> ( !ARGUMENT_PRESENT( ObjectTypeName )) {
02983 
02984             <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( Object )) {
02985 
02986                 ObjectTypeNameInfo = <a class="code" href="../../d7/d6/sepaudit_8c.html#a18">SepQueryTypeString</a>( Object );
02987 
02988                 <span class="keywordflow">if</span> ( ObjectTypeNameInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
02989 
02990                     LocalObjectTypeName = ObjectTypeNameInfo;
02991                 }
02992             }
02993 
02994         } <span class="keywordflow">else</span> {
02995 
02996             LocalObjectTypeName = ObjectTypeName;
02997         }
02998 
02999         <span class="comment">//</span>
03000         <span class="comment">// If the access attempt failed, do the audit here.  If it succeeded,</span>
03001         <span class="comment">// we'll do the audit later, when the handle is allocated.</span>
03002         <span class="comment">//</span>
03003         <span class="comment">//</span>
03004 
03005         <span class="keywordflow">if</span> (!AccessGranted) {
03006 
03007             AuditPerformed = <a class="code" href="../../d7/d6/sepaudit_8c.html#a11">SepAdtOpenObjectAuditAlarm</a> ( &amp;<a class="code" href="../../d0/d5/se_8h.html#a107">SeSubsystemName</a>,
03008                                                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03009                                                           LocalObjectTypeName,
03010                                                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03011                                                           ObjectName,
03012                                                           AccessState-&gt;SubjectSecurityContext.ClientToken,
03013                                                           AccessState-&gt;SubjectSecurityContext.PrimaryToken,
03014                                                           AccessState-&gt;OriginalDesiredAccess,
03015                                                           AccessState-&gt;PreviouslyGrantedAccess,
03016                                                           &amp;AccessState-&gt;OperationID,
03017                                                           AuxData-&gt;<a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html#o0">PrivilegesUsed</a>,
03018                                                           <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
03019                                                           <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
03020                                                           <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
03021                                                           <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
03022                                                           AccessState-&gt;SubjectSecurityContext.ProcessAuditId,
03023                                                           AuditCategoryObjectAccess,
03024                                                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03025                                                           0,
03026                                                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
03027         } <span class="keywordflow">else</span> {
03028 
03029             <span class="comment">//</span>
03030             <span class="comment">// Copy all the stuff we're going to need into the</span>
03031             <span class="comment">// AccessState and return.</span>
03032             <span class="comment">//</span>
03033 
03034             <span class="keywordflow">if</span> ( ObjectName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
03035 
03036                  <span class="keywordflow">if</span> ( AccessState-&gt;ObjectName.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
03037 
03038                      <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( AccessState-&gt;ObjectName.Buffer );
03039                      AccessState-&gt;ObjectName.Length = 0;
03040                      AccessState-&gt;ObjectName.MaximumLength = 0;
03041                  }
03042 
03043                 AccessState-&gt;ObjectName.Buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,ObjectName-&gt;MaximumLength );
03044                 <span class="keywordflow">if</span> (AccessState-&gt;ObjectName.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03045 
03046                     AccessState-&gt;ObjectName.MaximumLength = ObjectName-&gt;MaximumLength;
03047                     <a class="code" href="../../d6/d6/nls_8c.html#a44">RtlCopyUnicodeString</a>( &amp;AccessState-&gt;ObjectName, ObjectName );
03048                 }
03049             }
03050 
03051             <span class="keywordflow">if</span> ( LocalObjectTypeName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
03052 
03053                  <span class="keywordflow">if</span> ( AccessState-&gt;ObjectTypeName.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
03054 
03055                      <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( AccessState-&gt;ObjectTypeName.Buffer );
03056                      AccessState-&gt;ObjectTypeName.Length = 0;
03057                      AccessState-&gt;ObjectTypeName.MaximumLength = 0;
03058                  }
03059 
03060                 AccessState-&gt;ObjectTypeName.Buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, LocalObjectTypeName-&gt;MaximumLength );
03061                 <span class="keywordflow">if</span> (AccessState-&gt;ObjectTypeName.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03062 
03063                     AccessState-&gt;ObjectTypeName.MaximumLength = LocalObjectTypeName-&gt;MaximumLength;
03064                     <a class="code" href="../../d6/d6/nls_8c.html#a44">RtlCopyUnicodeString</a>( &amp;AccessState-&gt;ObjectTypeName, LocalObjectTypeName );
03065                 }
03066             }
03067         }
03068 
03069         <span class="keywordflow">if</span> ( ObjectNameInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
03070 
03071             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( ObjectNameInfo );
03072         }
03073 
03074         <span class="keywordflow">if</span> ( ObjectTypeNameInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
03075 
03076             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( ObjectTypeNameInfo );
03077         }
03078     }
03079 
03080     <span class="keywordflow">return</span>;
03081 }
03082 
03083 
03084 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03085"></a><a class="code" href="../../d3/d5/seaudit_8c.html#a24">03085</a> <a class="code" href="../../d3/d5/seaudit_8c.html#a24">SeOpenObjectForDeleteAuditAlarm</a> (
03086     IN PUNICODE_STRING ObjectTypeName,
03087     IN PVOID Object OPTIONAL,
03088     IN PUNICODE_STRING AbsoluteObjectName OPTIONAL,
03089     IN PSECURITY_DESCRIPTOR SecurityDescriptor,
03090     IN <a class="code" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState,
03091     IN BOOLEAN ObjectCreated,
03092     IN BOOLEAN AccessGranted,
03093     IN KPROCESSOR_MODE AccessMode,
03094     OUT PBOOLEAN GenerateOnClose
03095     )
03096 <span class="comment">/*++</span>
03097 <span class="comment"></span>
03098 <span class="comment">Routine Description:</span>
03099 <span class="comment"></span>
03100 <span class="comment">    SeOpenObjectForDeleteAuditAlarm is used by the object manager that open</span>
03101 <span class="comment">    objects to generate any necessary audit or alarm messages.  The open may</span>
03102 <span class="comment">    be to existing objects or for newly created objects.  No messages will be</span>
03103 <span class="comment">    generated for Kernel mode accesses.</span>
03104 <span class="comment"></span>
03105 <span class="comment">    This routine is used to generate audit and alarm messages when an</span>
03106 <span class="comment">    attempt is made to open an object with the intent to delete it.</span>
03107 <span class="comment">    Specifically, this is used by file systems when the flag</span>
03108 <span class="comment">    FILE_DELETE_ON_CLOSE is specified.</span>
03109 <span class="comment"></span>
03110 <span class="comment">    This routine may result in several messages being generated and sent to</span>
03111 <span class="comment">    Port objects.  This may result in a significant latency before</span>
03112 <span class="comment">    returning.  Design of routines that must call this routine must take</span>
03113 <span class="comment">    this potential latency into account.  This may have an impact on the</span>
03114 <span class="comment">    approach taken for data structure mutex locking, for example.</span>
03115 <span class="comment"></span>
03116 <span class="comment">Arguments:</span>
03117 <span class="comment"></span>
03118 <span class="comment">    ObjectTypeName - Supplies the name of the type of object being</span>
03119 <span class="comment">        accessed.  This must be the same name provided to the</span>
03120 <span class="comment">        ObCreateObjectType service when the object type was created.</span>
03121 <span class="comment"></span>
03122 <span class="comment">    Object - Address of the object accessed.  This value will not be used</span>
03123 <span class="comment">        as a pointer (referenced).  It is necessary only to enter into log</span>
03124 <span class="comment">        messages.  If the open was not successful, then this argument is</span>
03125 <span class="comment">        ignored.  Otherwise, it must be provided.</span>
03126 <span class="comment"></span>
03127 <span class="comment">    AbsoluteObjectName - Supplies the name of the object being accessed.</span>
03128 <span class="comment">        If the object doesn't have a name, then this field is left null.</span>
03129 <span class="comment">        Otherwise, it must be provided.</span>
03130 <span class="comment"></span>
03131 <span class="comment">    SecurityDescriptor - A pointer to the security descriptor of the</span>
03132 <span class="comment">        object being accessed.</span>
03133 <span class="comment"></span>
03134 <span class="comment">    AccessState - A pointer to an access state structure containing the</span>
03135 <span class="comment">        subject context, the remaining desired access types, the granted</span>
03136 <span class="comment">        access types, and optionally a privilege set to indicate which</span>
03137 <span class="comment">        privileges were used to permit the access.</span>
03138 <span class="comment"></span>
03139 <span class="comment">    ObjectCreated - A boolean flag indicating whether the access resulted</span>
03140 <span class="comment">        in a new object being created.  A value of TRUE indicates an object</span>
03141 <span class="comment">        was created, FALSE indicates an existing object was opened.</span>
03142 <span class="comment"></span>
03143 <span class="comment">    AccessGranted - Indicates if the access was granted or denied based on</span>
03144 <span class="comment">        the access check or privilege check.</span>
03145 <span class="comment"></span>
03146 <span class="comment">    AccessMode - Indicates the access mode used for the access check.  One</span>
03147 <span class="comment">        of UserMode or KernelMode.  Messages will not be generated by</span>
03148 <span class="comment">        kernel mode accesses.</span>
03149 <span class="comment"></span>
03150 <span class="comment">    GenerateOnClose - Points to a boolean that is set by the audit</span>
03151 <span class="comment">        generation routine and must be passed to SeCloseObjectAuditAlarm()</span>
03152 <span class="comment">        when the object handle is closed.</span>
03153 <span class="comment"></span>
03154 <span class="comment">Return value:</span>
03155 <span class="comment"></span>
03156 <span class="comment">    None.</span>
03157 <span class="comment"></span>
03158 <span class="comment">--*/</span>
03159 {
03160     BOOLEAN GenerateAudit = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03161     BOOLEAN GenerateAlarm = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03162     ACCESS_MASK RequestedAccess;
03163     POBJECT_NAME_INFORMATION ObjectNameInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03164     PUNICODE_STRING ObjectTypeNameInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03165     PUNICODE_STRING ObjectName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03166     PUNICODE_STRING LocalObjectTypeName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03167     PLUID PrimaryAuthenticationId = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03168     PLUID ClientAuthenticationId = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03169     BOOLEAN AuditPrivileges = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03170     BOOLEAN AuditPerformed;
03171     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
03172     ACCESS_MASK MappedGrantMask = (ACCESS_MASK)0;
03173     ACCESS_MASK MappedDenyMask = (ACCESS_MASK)0;
03174     <a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html">PAUX_ACCESS_DATA</a> AuxData;
03175 
03176     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03177 
03178     <span class="keywordflow">if</span> ( AccessMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a> ) {
03179         <span class="keywordflow">return</span>;
03180     }
03181 
03182     AuxData = (<a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html">PAUX_ACCESS_DATA</a>)AccessState-&gt;AuxData;
03183 
03184     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> = <a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a>( &amp;AccessState-&gt;SubjectSecurityContext );
03185 
03186     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;AuditData)) {
03187 
03188         MappedGrantMask = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;AuditData-&gt;GrantMask;
03189 
03190         <a class="code" href="../../d8/d6/sertl_8c.html#a70">RtlMapGenericMask</a>(
03191             &amp;MappedGrantMask,
03192             &amp;AuxData-&gt;<a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html#o1">GenericMapping</a>
03193             );
03194 
03195         MappedDenyMask = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;AuditData-&gt;DenyMask;
03196 
03197         <a class="code" href="../../d8/d6/sertl_8c.html#a70">RtlMapGenericMask</a>(
03198             &amp;MappedDenyMask,
03199             &amp;AuxData-&gt;<a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html#o1">GenericMapping</a>
03200             );
03201     }
03202 
03203     <span class="keywordflow">if</span> (SecurityDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03204 
03205         RequestedAccess = AccessState-&gt;RemainingDesiredAccess |
03206                           AccessState-&gt;PreviouslyGrantedAccess;
03207 
03208         <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d5/adtp_8h.html#a1">SepAdtAuditThisEvent</a>( AuditCategoryObjectAccess, &amp;AccessGranted )) {
03209 
03210             <span class="keywordflow">if</span> ( RequestedAccess &amp; (AccessGranted ? MappedGrantMask : MappedDenyMask)) {
03211 
03212                 GenerateAudit = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03213 
03214             } <span class="keywordflow">else</span> {
03215 
03216                 <a class="code" href="../../d6/d6/sep_8h.html#a62">SepExamineSacl</a>(
03217                     RtlpSaclAddrSecurityDescriptor( (PISECURITY_DESCRIPTOR)SecurityDescriptor ),
03218                     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,
03219                     RequestedAccess,
03220                     AccessGranted,
03221                     &amp;GenerateAudit,
03222                     &amp;GenerateAlarm
03223                     );
03224             }
03225 
03226             <span class="comment">//</span>
03227             <span class="comment">// Only generate an audit on close of we're auditing from SACL</span>
03228             <span class="comment">// settings.</span>
03229             <span class="comment">//</span>
03230 
03231             <span class="keywordflow">if</span> (GenerateAudit) {
03232                 *GenerateOnClose = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03233             }
03234         }
03235     }
03236 
03237     <span class="comment">//</span>
03238     <span class="comment">// If we don't generate an audit via the SACL, see if we need to generate</span>
03239     <span class="comment">// one for privilege use.</span>
03240     <span class="comment">//</span>
03241     <span class="comment">// Note that we only audit privileges successfully used to open objects,</span>
03242     <span class="comment">// so we don't care about a failed privilege use here.  Therefore, only</span>
03243     <span class="comment">// do this test of access has been granted.</span>
03244     <span class="comment">//</span>
03245 
03246     <span class="keywordflow">if</span> (!GenerateAudit &amp;&amp; (AccessGranted == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
03247 
03248         <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d5/adtp_8h.html#a1">SepAdtAuditThisEvent</a>( AuditCategoryPrivilegeUse, &amp;AccessGranted )) {
03249 
03250             <span class="keywordflow">if</span> ((AuxData-&gt;<a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html#o0">PrivilegesUsed</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
03251                 (AuxData-&gt;<a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html#o0">PrivilegesUsed</a>-&gt;PrivilegeCount &gt; 0) ) {
03252 
03253                 <span class="comment">//</span>
03254                 <span class="comment">// Make sure these are actually privileges that we want to audit</span>
03255                 <span class="comment">//</span>
03256 
03257                 <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/sep_8h.html#a67">SepFilterPrivilegeAudits</a>( AuxData-&gt;<a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html#o0">PrivilegesUsed</a> )) {
03258 
03259                     GenerateAudit = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03260 
03261                     <span class="comment">//</span>
03262                     <span class="comment">// When we finally try to generate this audit, this flag</span>
03263                     <span class="comment">// will tell us that we need to audit the fact that we</span>
03264                     <span class="comment">// used a privilege, as opposed to audit due to the SACL.</span>
03265                     <span class="comment">//</span>
03266 
03267                     AccessState-&gt;AuditPrivileges = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03268                 }
03269             }
03270         }
03271     }
03272 
03273     <span class="comment">//</span>
03274     <span class="comment">// Set up either to generate an audit (if the access check has failed), or save</span>
03275     <span class="comment">// the stuff that we're going to audit later into the AccessState structure.</span>
03276     <span class="comment">//</span>
03277 
03278     <span class="keywordflow">if</span> (GenerateAudit || GenerateAlarm) {
03279 
03280         AccessState-&gt;GenerateAudit = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03281 
03282         <span class="comment">//</span>
03283         <span class="comment">// Figure out what we've been passed, and obtain as much</span>
03284         <span class="comment">// missing information as possible.</span>
03285         <span class="comment">//</span>
03286 
03287         <span class="keywordflow">if</span> ( !ARGUMENT_PRESENT( AbsoluteObjectName )) {
03288 
03289             <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( Object )) {
03290 
03291                 ObjectNameInfo = <a class="code" href="../../d7/d6/sepaudit_8c.html#a17">SepQueryNameString</a>( Object  );
03292 
03293                 <span class="keywordflow">if</span> ( ObjectNameInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
03294 
03295                     ObjectName = &amp;ObjectNameInfo-&gt;Name;
03296                 }
03297             }
03298 
03299         } <span class="keywordflow">else</span> {
03300 
03301             ObjectName = AbsoluteObjectName;
03302         }
03303 
03304         <span class="keywordflow">if</span> ( !ARGUMENT_PRESENT( ObjectTypeName )) {
03305 
03306             <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( Object )) {
03307 
03308                 ObjectTypeNameInfo = <a class="code" href="../../d7/d6/sepaudit_8c.html#a18">SepQueryTypeString</a>( Object );
03309 
03310                 <span class="keywordflow">if</span> ( ObjectTypeNameInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
03311 
03312                     LocalObjectTypeName = ObjectTypeNameInfo;
03313                 }
03314             }
03315 
03316         } <span class="keywordflow">else</span> {
03317 
03318             LocalObjectTypeName = ObjectTypeName;
03319         }
03320 
03321         <span class="comment">//</span>
03322         <span class="comment">// If the access attempt failed, do the audit here.  If it succeeded,</span>
03323         <span class="comment">// we'll do the audit later, when the handle is allocated.</span>
03324         <span class="comment">//</span>
03325         <span class="comment">//</span>
03326 
03327         <span class="keywordflow">if</span> (!AccessGranted) {
03328 
03329             AuditPerformed = <a class="code" href="../../d7/d6/sepaudit_8c.html#a11">SepAdtOpenObjectAuditAlarm</a> ( &amp;<a class="code" href="../../d0/d5/se_8h.html#a107">SeSubsystemName</a>,
03330                                                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03331                                                           LocalObjectTypeName,
03332                                                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03333                                                           ObjectName,
03334                                                           AccessState-&gt;SubjectSecurityContext.ClientToken,
03335                                                           AccessState-&gt;SubjectSecurityContext.PrimaryToken,
03336                                                           AccessState-&gt;OriginalDesiredAccess,
03337                                                           AccessState-&gt;PreviouslyGrantedAccess,
03338                                                           &amp;AccessState-&gt;OperationID,
03339                                                           AuxData-&gt;<a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html#o0">PrivilegesUsed</a>,
03340                                                           <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
03341                                                           <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
03342                                                           <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
03343                                                           <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
03344                                                           AccessState-&gt;SubjectSecurityContext.ProcessAuditId,
03345                                                           AuditCategoryObjectAccess,
03346                                                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03347                                                           0,
03348                                                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
03349         } <span class="keywordflow">else</span> {
03350 
03351             <span class="comment">//</span>
03352             <span class="comment">// Generate the delete audit first</span>
03353             <span class="comment">//</span>
03354 
03355             <a class="code" href="../../d7/d6/sepaudit_8c.html#a12">SepAdtOpenObjectForDeleteAuditAlarm</a> ( &amp;<a class="code" href="../../d0/d5/se_8h.html#a107">SeSubsystemName</a>,
03356                                                   <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03357                                                   LocalObjectTypeName,
03358                                                   <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03359                                                   ObjectName,
03360                                                   AccessState-&gt;SubjectSecurityContext.ClientToken,
03361                                                   AccessState-&gt;SubjectSecurityContext.PrimaryToken,
03362                                                   AccessState-&gt;OriginalDesiredAccess,
03363                                                   AccessState-&gt;PreviouslyGrantedAccess,
03364                                                   &amp;AccessState-&gt;OperationID,
03365                                                   AuxData-&gt;<a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html#o0">PrivilegesUsed</a>,
03366                                                   <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
03367                                                   <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
03368                                                   <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
03369                                                   <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
03370                                                   AccessState-&gt;SubjectSecurityContext.ProcessAuditId );
03371 
03372             <span class="comment">//</span>
03373             <span class="comment">// Copy all the stuff we're going to need into the</span>
03374             <span class="comment">// AccessState and return.</span>
03375             <span class="comment">//</span>
03376 
03377             <span class="keywordflow">if</span> ( ObjectName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
03378 
03379                  <span class="keywordflow">if</span> ( AccessState-&gt;ObjectName.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
03380 
03381                      <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( AccessState-&gt;ObjectName.Buffer );
03382                      AccessState-&gt;ObjectName.Length = 0;
03383                      AccessState-&gt;ObjectName.MaximumLength = 0;
03384                  }
03385 
03386                 AccessState-&gt;ObjectName.Buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,ObjectName-&gt;MaximumLength );
03387                 <span class="keywordflow">if</span> (AccessState-&gt;ObjectName.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03388 
03389                     AccessState-&gt;ObjectName.MaximumLength = ObjectName-&gt;MaximumLength;
03390                     <a class="code" href="../../d6/d6/nls_8c.html#a44">RtlCopyUnicodeString</a>( &amp;AccessState-&gt;ObjectName, ObjectName );
03391                 }
03392             }
03393 
03394             <span class="keywordflow">if</span> ( LocalObjectTypeName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
03395 
03396                  <span class="keywordflow">if</span> ( AccessState-&gt;ObjectTypeName.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
03397 
03398                      <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( AccessState-&gt;ObjectTypeName.Buffer );
03399                      AccessState-&gt;ObjectTypeName.Length = 0;
03400                      AccessState-&gt;ObjectTypeName.MaximumLength = 0;
03401                  }
03402 
03403                 AccessState-&gt;ObjectTypeName.Buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, LocalObjectTypeName-&gt;MaximumLength );
03404                 <span class="keywordflow">if</span> (AccessState-&gt;ObjectTypeName.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03405 
03406                     AccessState-&gt;ObjectTypeName.MaximumLength = LocalObjectTypeName-&gt;MaximumLength;
03407                     <a class="code" href="../../d6/d6/nls_8c.html#a44">RtlCopyUnicodeString</a>( &amp;AccessState-&gt;ObjectTypeName, LocalObjectTypeName );
03408                 }
03409             }
03410         }
03411 
03412         <span class="keywordflow">if</span> ( ObjectNameInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
03413 
03414             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( ObjectNameInfo );
03415         }
03416 
03417         <span class="keywordflow">if</span> ( ObjectTypeNameInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
03418 
03419             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( ObjectTypeNameInfo );
03420         }
03421     }
03422 
03423     <span class="keywordflow">return</span>;
03424 }
03425 
03426 
03427 
03428 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03429"></a><a class="code" href="../../d3/d5/seaudit_8c.html#a25">03429</a> <a class="code" href="../../d3/d5/seaudit_8c.html#a25">SeTraverseAuditAlarm</a>(
03430     IN PLUID OperationID,
03431     IN PVOID DirectoryObject,
03432     IN PSECURITY_DESCRIPTOR SecurityDescriptor,
03433     IN <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">PSECURITY_SUBJECT_CONTEXT</a> SubjectSecurityContext,
03434     IN BOOLEAN SubjectContextLocked,
03435     IN ACCESS_MASK TraverseAccess,
03436     IN PPRIVILEGE_SET Privileges OPTIONAL,
03437     IN BOOLEAN AccessGranted,
03438     IN KPROCESSOR_MODE AccessMode
03439     )
03440 <span class="comment">/*++</span>
03441 <span class="comment"></span>
03442 <span class="comment">Routine Description:</span>
03443 <span class="comment"></span>
03444 <span class="comment">    This routine is called to audit directory traverse operations</span>
03445 <span class="comment">    specifically.  It should be called by parse procedures as they traverse</span>
03446 <span class="comment">    directories as part of their operation.</span>
03447 <span class="comment"></span>
03448 <span class="comment">Arguments:</span>
03449 <span class="comment"></span>
03450 <span class="comment">    OperationID - LUID identifying the operation in progress</span>
03451 <span class="comment"></span>
03452 <span class="comment">    DirectoryObject - Pointer to the directory being traversed.</span>
03453 <span class="comment"></span>
03454 <span class="comment">    SecurityDescriptor - The security descriptor (if any) attached to the</span>
03455 <span class="comment">        directory being traversed.</span>
03456 <span class="comment"></span>
03457 <span class="comment">    SubjectSecurityContext - Security context of the client.</span>
03458 <span class="comment"></span>
03459 <span class="comment">    SubjectContextLocked - Supplies whether the SubjectContext is locked</span>
03460 <span class="comment">        for shared access.</span>
03461 <span class="comment"></span>
03462 <span class="comment">    TraverseAccess - Mask to indicate the traverse access for this object</span>
03463 <span class="comment">        type.</span>
03464 <span class="comment"></span>
03465 <span class="comment">    Privileges - Optional parameter to indicate any privilges that the</span>
03466 <span class="comment">        subject may have used to gain access to the object.</span>
03467 <span class="comment"></span>
03468 <span class="comment">    AccessGranted - Indicates if the access was granted or denied based on</span>
03469 <span class="comment">        the access check or privilege check.</span>
03470 <span class="comment"></span>
03471 <span class="comment">    AccessMode - Indicates the access mode used for the access check.  One</span>
03472 <span class="comment">        of UserMode or KernelMode.  Messages will not be generated by</span>
03473 <span class="comment">        kernel mode accesses.</span>
03474 <span class="comment"></span>
03475 <span class="comment">Return value:</span>
03476 <span class="comment"></span>
03477 <span class="comment">    None.</span>
03478 <span class="comment"></span>
03479 <span class="comment">--*/</span>
03480 
03481 {
03482     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03483 
03484 <span class="preprocessor">#if 0</span>
03485 <span class="preprocessor"></span>    BOOLEAN GenerateAudit = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03486     BOOLEAN GenerateAlarm = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03487 
03488     <span class="keywordflow">if</span> (AccessMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
03489         <span class="keywordflow">return</span>;
03490     }
03491 
03492     <span class="keywordflow">if</span> ((<a class="code" href="../../d0/d5/se_8h.html#a105">SeAuditingState</a>[AuditEventTraverse].<a class="code" href="../../d1/d0/struct__SE__AUDITING__STATE.html#o0">AuditOnSuccess</a> &amp;&amp; AccessGranted) ||
03493          <a class="code" href="../../d0/d5/se_8h.html#a105">SeAuditingState</a>[AuditEventTraverse].<a class="code" href="../../d1/d0/struct__SE__AUDITING__STATE.html#o1">AuditOnFailure</a> &amp;&amp; !AccessGranted) {
03494 
03495         <span class="keywordflow">if</span> ( SecurityDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
03496 
03497             <span class="keywordflow">if</span> ( !SubjectContextLocked ) {
03498                 <a class="code" href="../../d0/d8/subject_8c.html#a1">SeLockSubjectContext</a>( SubjectSecurityContext );
03499             }
03500 
03501             <a class="code" href="../../d6/d6/sep_8h.html#a62">SepExamineSacl</a>(
03502                 RtlpSaclAddrSecurityDescriptor( (PISECURITY_DESCRIPTOR)SecurityDescriptor ),
03503                 <a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a>( SubjectSecurityContext ),
03504                 TraverseAccess,
03505                 AccessGranted,
03506                 &amp;GenerateAudit,
03507                 &amp;GenerateAlarm
03508                 );
03509 
03510             <span class="keywordflow">if</span> (GenerateAudit || GenerateAlarm) {
03511 
03512                 <a class="code" href="../../d1/d5/adtp_8h.html#a20">SepAdtTraverseAuditAlarm</a>(
03513                     OperationID,
03514                     DirectoryObject,
03515                     <a class="code" href="../../d6/d6/sep_8h.html#a8">SepTokenUserSid</a>(<a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a>( SubjectSecurityContext )),
03516                     <a class="code" href="../../d6/d6/sep_8h.html#a9">SepTokenAuthenticationId</a>(<a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a>( SubjectSecurityContext )),
03517                     TraverseAccess,
03518                     Privileges,
03519                     AccessGranted,
03520                     GenerateAudit,
03521                     GenerateAlarm
03522                     );
03523             }
03524 
03525             <span class="keywordflow">if</span> ( !SubjectContextLocked ) {
03526                 <a class="code" href="../../d0/d8/subject_8c.html#a2">SeUnlockSubjectContext</a>( SubjectSecurityContext );
03527             }
03528         }
03529     }
03530 
03531 <span class="preprocessor">#endif</span>
03532 <span class="preprocessor"></span>
03533     <span class="keywordflow">return</span>;
03534 }
03535 
03536 
03537 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03538"></a><a class="code" href="../../d3/d5/seaudit_8c.html#a26">03538</a> <a class="code" href="../../d3/d5/seaudit_8c.html#a26">SeCreateObjectAuditAlarm</a>(
03539     IN PLUID OperationID OPTIONAL,
03540     IN PVOID DirectoryObject,
03541     IN PUNICODE_STRING ComponentName,
03542     IN PSECURITY_DESCRIPTOR SecurityDescriptor,
03543     IN <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">PSECURITY_SUBJECT_CONTEXT</a> SubjectSecurityContext,
03544     IN ACCESS_MASK DesiredAccess,
03545     IN PPRIVILEGE_SET Privileges OPTIONAL,
03546     IN BOOLEAN AccessGranted,
03547     OUT PBOOLEAN AuditPerformed,
03548     IN KPROCESSOR_MODE AccessMode
03549     )
03550 
03551 <span class="comment">/*++</span>
03552 <span class="comment"></span>
03553 <span class="comment">Routine Description:</span>
03554 <span class="comment"></span>
03555 <span class="comment">    Audits the creation of an object in a directory.</span>
03556 <span class="comment"></span>
03557 <span class="comment">Arguments:</span>
03558 <span class="comment"></span>
03559 <span class="comment">    OperationID - Optionally supplies the LUID representing the operation</span>
03560 <span class="comment">        id for this operation.</span>
03561 <span class="comment"></span>
03562 <span class="comment">    DirectoryObject - Provides a pointer to the directory object being</span>
03563 <span class="comment">        examined.</span>
03564 <span class="comment"></span>
03565 <span class="comment">    ComponentName - Provides a pointer to a Unicode string containing the</span>
03566 <span class="comment">        relative name of the object being created.</span>
03567 <span class="comment"></span>
03568 <span class="comment">    SecurityDescriptor - The security descriptor for the passed direcctory.</span>
03569 <span class="comment"></span>
03570 <span class="comment">    SubjectSecurityContext - The current subject context.</span>
03571 <span class="comment"></span>
03572 <span class="comment">    DesiredAccess - The desired access to the directory.</span>
03573 <span class="comment"></span>
03574 <span class="comment">    Privileges - Returns any privileges that were used for the access attempt.</span>
03575 <span class="comment"></span>
03576 <span class="comment">    AccessGranted - Returns whether or not the access was successful.</span>
03577 <span class="comment"></span>
03578 <span class="comment">    AuditPerformed - Returns whether or not auditing was performed.</span>
03579 <span class="comment"></span>
03580 <span class="comment">    AccessMode - The previous mode.</span>
03581 <span class="comment"></span>
03582 <span class="comment">Return Value:</span>
03583 <span class="comment"></span>
03584 <span class="comment">    return-value - Description of conditions needed to return value. - or -</span>
03585 <span class="comment">    None.</span>
03586 <span class="comment"></span>
03587 <span class="comment">--*/</span>
03588 
03589 {
03590     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03591 <span class="preprocessor">#if 0</span>
03592 <span class="preprocessor"></span>
03593     BOOLEAN GenerateAudit = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03594     BOOLEAN GenerateAlarm = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03595     PUNICODE_STRING <a class="code" href="../../d3/d3/tob_8c.html#a8">DirectoryName</a>;
03596     POBJECT_NAME_INFORMATION ObjectNameInformation = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03597 
03598     UNREFERENCED_PARAMETER( DirectoryObject );
03599     UNREFERENCED_PARAMETER( Privileges );
03600 
03601     <span class="keywordflow">if</span> (AccessMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
03602         <span class="keywordflow">return</span>;
03603     }
03604 
03605     <span class="keywordflow">if</span> ( SecurityDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
03606 
03607         <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d5/adtp_8h.html#a1">SepAdtAuditThisEvent</a>( AuditCategoryObjectAccess, &amp;AccessGranted )) {
03608 
03609             <a class="code" href="../../d6/d6/sep_8h.html#a62">SepExamineSacl</a>(
03610                 RtlpSaclAddrSecurityDescriptor( (PISECURITY_DESCRIPTOR)SecurityDescriptor ),
03611                 <a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a>( SubjectSecurityContext ),
03612                 DesiredAccess,
03613                 AccessGranted,
03614                 &amp;GenerateAudit,
03615                 &amp;GenerateAlarm
03616                 );
03617 
03618             <span class="keywordflow">if</span> ( GenerateAudit || GenerateAlarm ) {
03619 
03620                 <span class="comment">//</span>
03621                 <span class="comment">// Call ob for the name of the directory.</span>
03622                 <span class="comment">//</span>
03623 
03624                 ObjectNameInformation = <a class="code" href="../../d7/d6/sepaudit_8c.html#a17">SepQueryNameString</a>( DirectoryObject );
03625 
03626                 <span class="keywordflow">if</span> ( ObjectNameInformation != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
03627 
03628                     <a class="code" href="../../d3/d3/tob_8c.html#a8">DirectoryName</a> = &amp;ObjectNameInformation-&gt;Name;
03629                 }
03630 
03631                 <a class="code" href="../../d1/d5/adtp_8h.html#a22">SepAdtCreateObjectAuditAlarm</a>(
03632                     OperationID,
03633                     <a class="code" href="../../d3/d3/tob_8c.html#a8">DirectoryName</a>,
03634                     ComponentName,
03635                     <a class="code" href="../../d6/d6/sep_8h.html#a8">SepTokenUserSid</a>(<a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a>( SubjectSecurityContext )),
03636                     <a class="code" href="../../d6/d6/sep_8h.html#a9">SepTokenAuthenticationId</a>( <a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a>( SubjectSecurityContext )),
03637                     DesiredAccess,
03638                     AccessGranted,
03639                     GenerateAudit,
03640                     GenerateAlarm
03641                     );
03642 
03643                 *AuditPerformed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03644 
03645                 <span class="keywordflow">if</span> ( <a class="code" href="../../d3/d3/tob_8c.html#a8">DirectoryName</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
03646 
03647                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( <a class="code" href="../../d3/d3/tob_8c.html#a8">DirectoryName</a> );
03648                 }
03649             }
03650         }
03651     }
03652 
03653 <span class="preprocessor">#endif</span>
03654 <span class="preprocessor"></span>
03655     <span class="keywordflow">return</span>;
03656 }
03657 
03658 
03659 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03660"></a><a class="code" href="../../d3/d5/seaudit_8c.html#a27">03660</a> <a class="code" href="../../d3/d5/seaudit_8c.html#a27">SeObjectReferenceAuditAlarm</a>(
03661     IN PLUID OperationID OPTIONAL,
03662     IN PVOID Object,
03663     IN PSECURITY_DESCRIPTOR SecurityDescriptor,
03664     IN <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">PSECURITY_SUBJECT_CONTEXT</a> SubjectSecurityContext,
03665     IN ACCESS_MASK DesiredAccess,
03666     IN PPRIVILEGE_SET Privileges OPTIONAL,
03667     IN BOOLEAN AccessGranted,
03668     IN KPROCESSOR_MODE AccessMode
03669     )
03670 
03671 <span class="comment">/*++</span>
03672 <span class="comment"></span>
03673 <span class="comment">Routine Description:</span>
03674 <span class="comment"></span>
03675 <span class="comment">    description-of-function.</span>
03676 <span class="comment"></span>
03677 <span class="comment">Arguments:</span>
03678 <span class="comment"></span>
03679 <span class="comment">    argument-name - Supplies | Returns description of argument.</span>
03680 <span class="comment">    .</span>
03681 <span class="comment">    .</span>
03682 <span class="comment"></span>
03683 <span class="comment">Return Value:</span>
03684 <span class="comment"></span>
03685 <span class="comment">    return-value - Description of conditions needed to return value. - or -</span>
03686 <span class="comment">    None.</span>
03687 <span class="comment"></span>
03688 <span class="comment">--*/</span>
03689 
03690 {
03691     BOOLEAN GenerateAudit = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03692     BOOLEAN GenerateAlarm = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03693 
03694     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03695 
03696     <span class="keywordflow">if</span> (AccessMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
03697         <span class="keywordflow">return</span>;
03698     }
03699 
03700     <span class="keywordflow">if</span> ( SecurityDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
03701 
03702         <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d5/adtp_8h.html#a1">SepAdtAuditThisEvent</a>( AuditCategoryDetailedTracking, &amp;AccessGranted )) {
03703 
03704             <a class="code" href="../../d6/d6/sep_8h.html#a62">SepExamineSacl</a>(
03705                 RtlpSaclAddrSecurityDescriptor( (PISECURITY_DESCRIPTOR)SecurityDescriptor ),
03706                 <a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a>( SubjectSecurityContext ),
03707                 DesiredAccess,
03708                 AccessGranted,
03709                 &amp;GenerateAudit,
03710                 &amp;GenerateAlarm
03711                 );
03712 
03713             <span class="keywordflow">if</span> ( GenerateAudit || GenerateAlarm ) {
03714 
03715                 <a class="code" href="../../d7/d6/sepaudit_8c.html#a16">SepAdtObjectReferenceAuditAlarm</a>(
03716                     OperationID,
03717                     Object,
03718                     SubjectSecurityContext,
03719                     DesiredAccess,
03720                     Privileges,
03721                     AccessGranted,
03722                     GenerateAudit,
03723                     GenerateAlarm
03724                     );
03725             }
03726         }
03727     }
03728 
03729     <span class="keywordflow">return</span>;
03730 
03731 }
03732 
03733 
03734 
03735 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03736"></a><a class="code" href="../../d3/d5/seaudit_8c.html#a28">03736</a> <a class="code" href="../../d3/d5/seaudit_8c.html#a28">SeAuditHandleCreation</a>(
03737     IN <a class="code" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState,
03738     IN HANDLE Handle
03739     )
03740 
03741 <span class="comment">/*++</span>
03742 <span class="comment"></span>
03743 <span class="comment">Routine Description:</span>
03744 <span class="comment"></span>
03745 <span class="comment">    This function audits the creation of a handle.</span>
03746 <span class="comment"></span>
03747 <span class="comment">    It will examine the AuditHandleCreation field in the passed AccessState,</span>
03748 <span class="comment">    which will indicate whether auditing was performed when the object</span>
03749 <span class="comment">    was found or created.</span>
03750 <span class="comment"></span>
03751 <span class="comment">    This routine is necessary because object name decoding and handle</span>
03752 <span class="comment">    allocation occur in widely separate places, preventing us from</span>
03753 <span class="comment">    auditing everything at once.</span>
03754 <span class="comment"></span>
03755 <span class="comment">Arguments:</span>
03756 <span class="comment"></span>
03757 <span class="comment">    AccessState - Supplies a pointer to the AccessState structure</span>
03758 <span class="comment">        representing this access attempt.</span>
03759 <span class="comment"></span>
03760 <span class="comment">    Handle - The newly allocated handle value.</span>
03761 <span class="comment"></span>
03762 <span class="comment">Return Value:</span>
03763 <span class="comment"></span>
03764 <span class="comment">    None.</span>
03765 <span class="comment"></span>
03766 <span class="comment">--*/</span>
03767 
03768 {
03769     BOOLEAN AuditPerformed = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03770     <a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html">PAUX_ACCESS_DATA</a> AuxData;
03771 
03772     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03773 
03774     AuxData = (<a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html">PAUX_ACCESS_DATA</a>)AccessState-&gt;AuxData;
03775 
03776     <span class="keywordflow">if</span> ( AccessState-&gt;GenerateAudit ) {
03777 
03778         <span class="keywordflow">if</span> ( AccessState-&gt;AuditPrivileges ) {
03779 
03780             AuditPerformed = <a class="code" href="../../d7/d6/sepaudit_8c.html#a9">SepAdtPrivilegeObjectAuditAlarm</a> (
03781                                  &amp;<a class="code" href="../../d0/d5/se_8h.html#a107">SeSubsystemName</a>,
03782                                  <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
03783                                  (<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)AccessState-&gt;SubjectSecurityContext.ClientToken,
03784                                  (<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)AccessState-&gt;SubjectSecurityContext.PrimaryToken,
03785                                  &amp;AccessState-&gt;SubjectSecurityContext.ProcessAuditId,
03786                                  AccessState-&gt;PreviouslyGrantedAccess,
03787                                  AuxData-&gt;<a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html#o0">PrivilegesUsed</a>,
03788                                  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
03789                                  );
03790         } <span class="keywordflow">else</span> {
03791 
03792             AuditPerformed = <a class="code" href="../../d7/d6/sepaudit_8c.html#a11">SepAdtOpenObjectAuditAlarm</a> ( &amp;<a class="code" href="../../d0/d5/se_8h.html#a107">SeSubsystemName</a>,
03793                                                           &amp;<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
03794                                                           &amp;AccessState-&gt;ObjectTypeName,
03795                                                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03796                                                           &amp;AccessState-&gt;ObjectName,
03797                                                           AccessState-&gt;SubjectSecurityContext.ClientToken,
03798                                                           AccessState-&gt;SubjectSecurityContext.PrimaryToken,
03799                                                           AccessState-&gt;OriginalDesiredAccess,
03800                                                           AccessState-&gt;PreviouslyGrantedAccess,
03801                                                           &amp;AccessState-&gt;OperationID,
03802                                                           AuxData-&gt;<a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html#o0">PrivilegesUsed</a>,
03803                                                           <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
03804                                                           <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
03805                                                           <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
03806                                                           <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
03807                                                           <a class="code" href="../../d1/d9/ps_8h.html#a152">PsGetCurrentProcessId</a>(),
03808                                                           AuditCategoryObjectAccess,
03809                                                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03810                                                           0,
03811                                                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
03812         }
03813     }
03814 
03815     <span class="comment">//</span>
03816     <span class="comment">// If we generated an 'open' audit, make sure we generate a close</span>
03817     <span class="comment">//</span>
03818 
03819     AccessState-&gt;GenerateOnClose = AuditPerformed;
03820 
03821     <span class="keywordflow">return</span>;
03822 }
03823 
03824 
03825 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03826"></a><a class="code" href="../../d3/d5/seaudit_8c.html#a29">03826</a> <a class="code" href="../../d3/d5/seaudit_8c.html#a29">SeCloseObjectAuditAlarm</a>(
03827     IN PVOID Object,
03828     IN HANDLE Handle,
03829     IN BOOLEAN GenerateOnClose
03830     )
03831 
03832 <span class="comment">/*++</span>
03833 <span class="comment"></span>
03834 <span class="comment">Routine Description:</span>
03835 <span class="comment"></span>
03836 <span class="comment">    This routine is used to generate audit and alarm messages when a handle</span>
03837 <span class="comment">    to an object is deleted.</span>
03838 <span class="comment"></span>
03839 <span class="comment">    This routine may result in several messages being generated and sent to</span>
03840 <span class="comment">    Port objects.  This may result in a significant latency before</span>
03841 <span class="comment">    returning.  Design of routines that must call this routine must take</span>
03842 <span class="comment">    this potential latency into account.  This may have an impact on the</span>
03843 <span class="comment">    approach taken for data structure mutex locking, for example.</span>
03844 <span class="comment"></span>
03845 <span class="comment">Arguments:</span>
03846 <span class="comment"></span>
03847 <span class="comment">    Object - Address of the object being accessed.  This value will not be</span>
03848 <span class="comment">        used as a pointer (referenced).  It is necessary only to enter into</span>
03849 <span class="comment">        log messages.</span>
03850 <span class="comment"></span>
03851 <span class="comment">    Handle - Supplies the handle value assigned to the open.</span>
03852 <span class="comment"></span>
03853 <span class="comment">    GenerateOnClose - Is a boolean value returned from a corresponding</span>
03854 <span class="comment">        SeOpenObjectAuditAlarm() call when the object handle was created.</span>
03855 <span class="comment"></span>
03856 <span class="comment">Return Value:</span>
03857 <span class="comment"></span>
03858 <span class="comment">    None.</span>
03859 <span class="comment"></span>
03860 <span class="comment">--*/</span>
03861 
03862 {
03863     <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">SECURITY_SUBJECT_CONTEXT</a> SubjectSecurityContext;
03864     PSID UserSid;
03865     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03866 
03867     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03868 
03869     <span class="keywordflow">if</span> (GenerateOnClose) {
03870 
03871         <a class="code" href="../../d0/d8/subject_8c.html#a0">SeCaptureSubjectContext</a> ( &amp;SubjectSecurityContext );
03872 
03873         UserSid = <a class="code" href="../../d6/d6/sep_8h.html#a8">SepTokenUserSid</a>( <a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a> (&amp;SubjectSecurityContext));
03874 
03875 
03876         <a class="code" href="../../d7/d6/sepaudit_8c.html#a13">SepAdtCloseObjectAuditAlarm</a> (
03877             &amp;<a class="code" href="../../d0/d5/se_8h.html#a107">SeSubsystemName</a>,
03878             (PVOID)<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
03879             Object,
03880             UserSid,
03881             <a class="code" href="../../d6/d6/sep_8h.html#a9">SepTokenAuthenticationId</a>( <a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a> (&amp;SubjectSecurityContext))
03882             );
03883 
03884         <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a> ( &amp;SubjectSecurityContext );
03885     }
03886 
03887     <span class="keywordflow">return</span>;
03888 }
03889 
03890 
03891 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03892"></a><a class="code" href="../../d3/d5/seaudit_8c.html#a30">03892</a> <a class="code" href="../../d3/d5/seaudit_8c.html#a30">SeDeleteObjectAuditAlarm</a>(
03893     IN PVOID Object,
03894     IN HANDLE Handle
03895     )
03896 
03897 <span class="comment">/*++</span>
03898 <span class="comment"></span>
03899 <span class="comment">Routine Description:</span>
03900 <span class="comment"></span>
03901 <span class="comment">    This routine is used to generate audit and alarm messages when an object</span>
03902 <span class="comment">    is marked for deletion.</span>
03903 <span class="comment"></span>
03904 <span class="comment">    This routine may result in several messages being generated and sent to</span>
03905 <span class="comment">    Port objects.  This may result in a significant latency before</span>
03906 <span class="comment">    returning.  Design of routines that must call this routine must take</span>
03907 <span class="comment">    this potential latency into account.  This may have an impact on the</span>
03908 <span class="comment">    approach taken for data structure mutex locking, for example.</span>
03909 <span class="comment"></span>
03910 <span class="comment">Arguments:</span>
03911 <span class="comment"></span>
03912 <span class="comment">    Object - Address of the object being accessed.  This value will not be</span>
03913 <span class="comment">        used as a pointer (referenced).  It is necessary only to enter into</span>
03914 <span class="comment">        log messages.</span>
03915 <span class="comment"></span>
03916 <span class="comment">    Handle - Supplies the handle value assigned to the open.</span>
03917 <span class="comment"></span>
03918 <span class="comment">Return Value:</span>
03919 <span class="comment"></span>
03920 <span class="comment">    None.</span>
03921 <span class="comment"></span>
03922 <span class="comment">--*/</span>
03923 
03924 {
03925     <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">SECURITY_SUBJECT_CONTEXT</a> SubjectSecurityContext;
03926     PSID UserSid;
03927     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03928 
03929     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03930 
03931     <a class="code" href="../../d0/d8/subject_8c.html#a0">SeCaptureSubjectContext</a> ( &amp;SubjectSecurityContext );
03932 
03933     UserSid = <a class="code" href="../../d6/d6/sep_8h.html#a8">SepTokenUserSid</a>( <a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a> (&amp;SubjectSecurityContext));
03934 
03935 
03936 
03937     <a class="code" href="../../d7/d6/sepaudit_8c.html#a14">SepAdtDeleteObjectAuditAlarm</a> (
03938         &amp;<a class="code" href="../../d0/d5/se_8h.html#a107">SeSubsystemName</a>,
03939         (PVOID)<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
03940         Object,
03941         UserSid,
03942         <a class="code" href="../../d6/d6/sep_8h.html#a9">SepTokenAuthenticationId</a>( <a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a> (&amp;SubjectSecurityContext))
03943         );
03944 
03945     <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a> ( &amp;SubjectSecurityContext );
03946 
03947     <span class="keywordflow">return</span>;
03948 }
03949 
03950 
03951 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03952"></a><a class="code" href="../../d6/d6/sep_8h.html#a62">03952</a> <a class="code" href="../../d6/d6/sep_8h.html#a62">SepExamineSacl</a>(
03953     IN PACL Sacl,
03954     IN PACCESS_TOKEN Token,
03955     IN ACCESS_MASK DesiredAccess,
03956     IN BOOLEAN AccessGranted,
03957     OUT PBOOLEAN GenerateAudit,
03958     OUT PBOOLEAN GenerateAlarm
03959     )
03960 
03961 <span class="comment">/*++</span>
03962 <span class="comment"></span>
03963 <span class="comment">Routine Description:</span>
03964 <span class="comment"></span>
03965 <span class="comment">    This routine will examine the passed Sacl and determine what</span>
03966 <span class="comment">    if any action is required based its contents.</span>
03967 <span class="comment"></span>
03968 <span class="comment">    Note that this routine is not aware of any system state, ie,</span>
03969 <span class="comment">    whether or not auditing is currently enabled for either the</span>
03970 <span class="comment">    system or this particular object type.</span>
03971 <span class="comment"></span>
03972 <span class="comment">Arguments:</span>
03973 <span class="comment"></span>
03974 <span class="comment">    Sacl - Supplies a pointer to the Sacl to be examined.</span>
03975 <span class="comment"></span>
03976 <span class="comment">    Token - Supplies the effective token of the caller</span>
03977 <span class="comment"></span>
03978 <span class="comment">    AccessGranted - Supplies whether or not the access attempt</span>
03979 <span class="comment">        was successful.</span>
03980 <span class="comment"></span>
03981 <span class="comment">    GenerateAudit - Returns a boolean indicating whether or not</span>
03982 <span class="comment">        we should generate an audit.</span>
03983 <span class="comment"></span>
03984 <span class="comment">    GenerateAlarm - Returns a boolean indiciating whether or not</span>
03985 <span class="comment">        we should generate an alarm.</span>
03986 <span class="comment"></span>
03987 <span class="comment">Return Value:</span>
03988 <span class="comment"></span>
03989 <span class="comment">    STATUS_SUCCESS - The operation completed successfully.</span>
03990 <span class="comment"></span>
03991 <span class="comment">--*/</span>
03992 
03993 {
03994 
03995     ULONG i;
03996     PVOID Ace;
03997     ULONG AceCount;
03998     ACCESS_MASK AccessMask;
03999     UCHAR AceFlags;
04000     BOOLEAN FailedMaximumAllowed;
04001 
04002     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04003 
04004     *GenerateAudit = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04005     *GenerateAlarm = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04006 
04007     <span class="comment">//</span>
04008     <span class="comment">// If we failed an attempt to open an object for ONLY maximumum allowed,</span>
04009     <span class="comment">// then we generate an audit if ANY ACCESS_DENIED audit matching this</span>
04010     <span class="comment">// user's list of sids is found</span>
04011     <span class="comment">//</span>
04012 
04013     FailedMaximumAllowed = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04014     <span class="keywordflow">if</span> (!AccessGranted &amp;&amp; (DesiredAccess &amp; MAXIMUM_ALLOWED)) {
04015         FailedMaximumAllowed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04016     }
04017 
04018     <span class="comment">//</span>
04019     <span class="comment">// If the Sacl is null, do nothing and return</span>
04020     <span class="comment">//</span>
04021 
04022     <span class="keywordflow">if</span> (Sacl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04023 
04024         <span class="keywordflow">return</span>;
04025     }
04026 
04027     AceCount = Sacl-&gt;AceCount;
04028 
04029     <span class="keywordflow">if</span> (AceCount == 0) {
04030         <span class="keywordflow">return</span>;
04031     }
04032 
04033     <span class="comment">//</span>
04034     <span class="comment">// Iterate through the ACEs on the Sacl until either we reach</span>
04035     <span class="comment">// the end or discover that we have to take all possible actions,</span>
04036     <span class="comment">// in which case it doesn't pay to look any further</span>
04037     <span class="comment">//</span>
04038 
04039     <span class="keywordflow">for</span> ( i = 0, Ace = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a1">FirstAce</a>( Sacl ) ;
04040           (i &lt; AceCount) &amp;&amp; !(*GenerateAudit &amp;&amp; *GenerateAlarm);
04041           i++, Ace = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a2">NextAce</a>( Ace ) ) {
04042 
04043         <span class="keywordflow">if</span> ( !(((PACE_HEADER)Ace)-&gt;AceFlags &amp; INHERIT_ONLY_ACE)) {
04044 
04045              <span class="keywordflow">if</span> ( (((PACE_HEADER)Ace)-&gt;AceType == SYSTEM_AUDIT_ACE_TYPE) ) {
04046 
04047                 <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d6/sep_8h.html#a61">SepSidInToken</a>( (PACCESS_TOKEN)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;((PSYSTEM_AUDIT_ACE)Ace)-&gt;SidStart, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ) ) {
04048 
04049                     AccessMask = ((PSYSTEM_AUDIT_ACE)Ace)-&gt;Mask;
04050                     AceFlags   = ((PACE_HEADER)Ace)-&gt;AceFlags;
04051 
04052                     <span class="keywordflow">if</span> ( AccessMask &amp; DesiredAccess ) {
04053 
04054                         <span class="keywordflow">if</span> (((AceFlags &amp; SUCCESSFUL_ACCESS_ACE_FLAG) &amp;&amp; AccessGranted) ||
04055                               ((AceFlags &amp; FAILED_ACCESS_ACE_FLAG) &amp;&amp; !AccessGranted)) {
04056 
04057                             *GenerateAudit = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04058                         }
04059                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( FailedMaximumAllowed &amp;&amp; (AceFlags &amp; FAILED_ACCESS_ACE_FLAG) ) {
04060                             *GenerateAudit = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04061                     }
04062                 }
04063 
04064                  <span class="keywordflow">continue</span>;
04065              }
04066 
04067              <span class="keywordflow">if</span> ( (((PACE_HEADER)Ace)-&gt;AceType == SYSTEM_ALARM_ACE_TYPE) ) {
04068 
04069                 <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d6/sep_8h.html#a61">SepSidInToken</a>( (PACCESS_TOKEN)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;((PSYSTEM_ALARM_ACE)Ace)-&gt;SidStart, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ) ) {
04070 
04071                     AccessMask = ((PSYSTEM_ALARM_ACE)Ace)-&gt;Mask;
04072 
04073                     <span class="keywordflow">if</span> ( AccessMask &amp; DesiredAccess ) {
04074 
04075                         AceFlags   = ((PACE_HEADER)Ace)-&gt;AceFlags;
04076 
04077                         <span class="keywordflow">if</span> (((AceFlags &amp; SUCCESSFUL_ACCESS_ACE_FLAG) &amp;&amp; AccessGranted) ||
04078                               ((AceFlags &amp; FAILED_ACCESS_ACE_FLAG) &amp;&amp; !AccessGranted)) {
04079 
04080                             *GenerateAlarm = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04081                         }
04082                     }
04083                 }
04084             }
04085         }
04086     }
04087 
04088     <span class="keywordflow">return</span>;
04089 }
04090 
04091 
04092 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04093"></a><a class="code" href="../../d3/d5/seaudit_8c.html#a7">04093</a> <a class="code" href="../../d3/d5/seaudit_8c.html#a7">SepAuditTypeList</a> (
04094     IN <a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">PIOBJECT_TYPE_LIST</a> ObjectTypeList,
04095     IN ULONG ObjectTypeListLength,
04096     IN PNTSTATUS AccessStatus,
04097     IN ULONG StartIndex,
04098     OUT PBOOLEAN GenerateSuccessAudit,
04099     OUT PBOOLEAN GenerateFailureAudit
04100     )
04101 <span class="comment">/*++</span>
04102 <span class="comment"></span>
04103 <span class="comment">Routine Description:</span>
04104 <span class="comment"></span>
04105 <span class="comment">    This routine determines if any children of the object represented by</span>
04106 <span class="comment">    StartIndex have a different degree of success than the StartIndex element.</span>
04107 <span class="comment"></span>
04108 <span class="comment">Arguments:</span>
04109 <span class="comment"></span>
04110 <span class="comment">    ObjectTypeList - The object type list to update.</span>
04111 <span class="comment"></span>
04112 <span class="comment">    ObjectTypeListLength - Number of elements in ObjectTypeList</span>
04113 <span class="comment"></span>
04114 <span class="comment">    AccessStatus - Specifies STATUS_SUCCESS or other error code to be</span>
04115 <span class="comment">        propogated back to the caller</span>
04116 <span class="comment"></span>
04117 <span class="comment">    StartIndex - Index to the target element to update.</span>
04118 <span class="comment"></span>
04119 <span class="comment">    GenerateSuccessAudit - Returns a boolean indicating whether or not</span>
04120 <span class="comment">        we should generate a success audit.</span>
04121 <span class="comment"></span>
04122 <span class="comment">    GenerateFailureAudit - Returns a boolean indicating whether or not</span>
04123 <span class="comment">        we should generate a failure audit.</span>
04124 <span class="comment"></span>
04125 <span class="comment">Return Value:</span>
04126 <span class="comment"></span>
04127 <span class="comment">    None.</span>
04128 <span class="comment"></span>
04129 <span class="comment">--*/</span>
04130 
04131 {
04132     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
04133     BOOLEAN WasSuccess;
04134 
04135     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04136 
04137     <span class="comment">//</span>
04138     <span class="comment">// Determine if the target was successful.</span>
04139     <span class="comment">//</span>
04140 
04141     WasSuccess = <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( AccessStatus[StartIndex] );
04142 
04143     <span class="comment">//</span>
04144     <span class="comment">// Loop handling all children of the target.</span>
04145     <span class="comment">//</span>
04146 
04147     <span class="keywordflow">for</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>=StartIndex+1; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>&lt;ObjectTypeListLength; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>++ ) {
04148 
04149         <span class="comment">//</span>
04150         <span class="comment">// By definition, the children of an object are all those entries</span>
04151         <span class="comment">// immediately following the target.  The list of children (or</span>
04152         <span class="comment">// grandchildren) stops as soon as we reach an entry the has the</span>
04153         <span class="comment">// same level as the target (a sibling) or lower than the target</span>
04154         <span class="comment">// (an uncle).</span>
04155         <span class="comment">//</span>
04156 
04157         <span class="keywordflow">if</span> ( ObjectTypeList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Level &lt;= ObjectTypeList[StartIndex].Level ) {
04158             <span class="keywordflow">break</span>;
04159         }
04160 
04161         <span class="comment">//</span>
04162         <span class="comment">// If the child has different access than the target,</span>
04163         <span class="comment">//  mark the child.</span>
04164         <span class="comment">//</span>
04165 
04166         <span class="keywordflow">if</span> ( WasSuccess &amp;&amp; !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( AccessStatus[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>]) ) {
04167             *GenerateFailureAudit = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04168             ObjectTypeList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Flags |= <a class="code" href="../../d8/d3/tokenp_8h.html#a5">OBJECT_FAILURE_AUDIT</a>;
04169         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !WasSuccess &amp;&amp; <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( AccessStatus[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>]) ) {
04170             *GenerateSuccessAudit = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04171             ObjectTypeList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Flags |= <a class="code" href="../../d8/d3/tokenp_8h.html#a4">OBJECT_SUCCESS_AUDIT</a>;
04172         }
04173 
04174     }
04175 }
04176 
04177 
04178 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04179"></a><a class="code" href="../../d3/d5/seaudit_8c.html#a32">04179</a> <a class="code" href="../../d3/d5/seaudit_8c.html#a32">SepSetAuditInfoForObjectType</a>(
04180     IN  UCHAR AceFlags,
04181     IN  ACCESS_MASK AccessMask,
04182     IN  ACCESS_MASK DesiredAccess,
04183     IN  <a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">PIOBJECT_TYPE_LIST</a> ObjectTypeList,
04184     IN  ULONG ObjectTypeListLength,
04185     IN  BOOLEAN ReturnResultList,
04186     IN  ULONG ObjectTypeIndex,
04187     IN  PNTSTATUS AccessStatus,
04188     IN  PACCESS_MASK GrantedAccess,
04189     IN  BOOLEAN FailedMaximumAllowed,
04190     OUT PBOOLEAN GenerateSuccessAudit,
04191     OUT PBOOLEAN GenerateFailureAudit
04192     )
04193 <span class="comment">/*++</span>
04194 <span class="comment"></span>
04195 <span class="comment">Routine Description:</span>
04196 <span class="comment"></span>
04197 <span class="comment">    Determine if success/failure audit needs to be generated for</span>
04198 <span class="comment">    object at ObjectTypeIndex in ObjectTypeList.</span>
04199 <span class="comment"></span>
04200 <span class="comment">    This helper function is called only by SepExamineSaclEx.</span>
04201 <span class="comment"></span>
04202 <span class="comment">Arguments:</span>
04203 <span class="comment"></span>
04204 <span class="comment">    please refer to arg help for function SepExamineSaclEx</span>
04205 <span class="comment"></span>
04206 <span class="comment">Return Value:</span>
04207 <span class="comment"></span>
04208 <span class="comment">    None.</span>
04209 <span class="comment"></span>
04210 <span class="comment">--*/</span>
04211 {
04212     <span class="keywordflow">if</span> ( AccessMask &amp; (DesiredAccess|GrantedAccess[ObjectTypeIndex]) ) {
04213 
04214         <span class="keywordflow">if</span> ( (AceFlags &amp; SUCCESSFUL_ACCESS_ACE_FLAG) &amp;&amp;
04215              <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(AccessStatus[ObjectTypeIndex]) ) {
04216 
04217             *GenerateSuccessAudit = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04218             <span class="keywordflow">if</span> ( ObjectTypeListLength != 0 ) {
04219 
04220                 ObjectTypeList[ObjectTypeIndex].Flags |= <a class="code" href="../../d8/d3/tokenp_8h.html#a4">OBJECT_SUCCESS_AUDIT</a>;
04221                 <span class="keywordflow">if</span> ( ReturnResultList ) {
04222                     <a class="code" href="../../d3/d5/seaudit_8c.html#a7">SepAuditTypeList</a>( ObjectTypeList,
04223                                       ObjectTypeListLength,
04224                                       AccessStatus,
04225                                       ObjectTypeIndex,
04226                                       GenerateSuccessAudit,
04227                                       GenerateFailureAudit );
04228                 }
04229             }
04230 
04231         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((AceFlags &amp; FAILED_ACCESS_ACE_FLAG) &amp;&amp;
04232                    !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(AccessStatus[ObjectTypeIndex]) ) {
04233 
04234             *GenerateFailureAudit = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04235             <span class="keywordflow">if</span> ( ObjectTypeListLength != 0 ) {
04236                 ObjectTypeList[ObjectTypeIndex].Flags |= <a class="code" href="../../d8/d3/tokenp_8h.html#a5">OBJECT_FAILURE_AUDIT</a>;
04237                 <span class="keywordflow">if</span> ( ReturnResultList ) {
04238                     <a class="code" href="../../d3/d5/seaudit_8c.html#a7">SepAuditTypeList</a>( ObjectTypeList,
04239                                       ObjectTypeListLength,
04240                                       AccessStatus,
04241                                       ObjectTypeIndex,
04242                                       GenerateSuccessAudit,
04243                                       GenerateFailureAudit );
04244                 }
04245             }
04246         }
04247     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( FailedMaximumAllowed &amp;&amp; (AceFlags &amp; FAILED_ACCESS_ACE_FLAG) ) {
04248         *GenerateFailureAudit = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04249         <span class="keywordflow">if</span> ( ObjectTypeListLength != 0 ) {
04250             ObjectTypeList[ObjectTypeIndex].Flags |= <a class="code" href="../../d8/d3/tokenp_8h.html#a5">OBJECT_FAILURE_AUDIT</a>;
04251         }
04252     }
04253 }
04254 
04255 
04256 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04257"></a><a class="code" href="../../d3/d5/seaudit_8c.html#a8">04257</a> <a class="code" href="../../d3/d5/seaudit_8c.html#a8">SepExamineSaclEx</a>(
04258     IN PACL Sacl,
04259     IN PACCESS_TOKEN Token,
04260     IN ACCESS_MASK DesiredAccess,
04261     IN <a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">PIOBJECT_TYPE_LIST</a> ObjectTypeList OPTIONAL,
04262     IN ULONG ObjectTypeListLength,
04263     IN BOOLEAN ReturnResultList,
04264     IN PNTSTATUS AccessStatus,
04265     IN PACCESS_MASK GrantedAccess,
04266     OUT PBOOLEAN GenerateSuccessAudit,
04267     OUT PBOOLEAN GenerateFailureAudit
04268     )
04269 
04270 <span class="comment">/*++</span>
04271 <span class="comment"></span>
04272 <span class="comment">Routine Description:</span>
04273 <span class="comment"></span>
04274 <span class="comment">    This routine will examine the passed Sacl and determine what</span>
04275 <span class="comment">    if any action is required based its contents.</span>
04276 <span class="comment"></span>
04277 <span class="comment">    Note that this routine is not aware of any system state, ie,</span>
04278 <span class="comment">    whether or not auditing is currently enabled for either the</span>
04279 <span class="comment">    system or this particular object type.</span>
04280 <span class="comment"></span>
04281 <span class="comment">Arguments:</span>
04282 <span class="comment"></span>
04283 <span class="comment">    Sacl - Supplies a pointer to the Sacl to be examined.</span>
04284 <span class="comment"></span>
04285 <span class="comment">    Token - Supplies the effective token of the caller</span>
04286 <span class="comment"></span>
04287 <span class="comment">    DesiredAccess - Access that the caller wanted to the object</span>
04288 <span class="comment"></span>
04289 <span class="comment">    ObjectTypeList - Supplies a list of GUIDs representing the object (and</span>
04290 <span class="comment">        sub-objects) being accessed.</span>
04291 <span class="comment"></span>
04292 <span class="comment">    ObjectTypeListLength - Specifies the number of elements in the ObjectTypeList.</span>
04293 <span class="comment"></span>
04294 <span class="comment">    ReturnResultList - If true, AccessStatus and GrantedAccess is actually</span>
04295 <span class="comment">        an array of entries ObjectTypeListLength elements long.</span>
04296 <span class="comment"></span>
04297 <span class="comment">    AccessStatus - Specifies STATUS_SUCCESS or other error code to be</span>
04298 <span class="comment">        propogated back to the caller</span>
04299 <span class="comment"></span>
04300 <span class="comment">    GrantedAccess - Specifies the access granted to the caller.</span>
04301 <span class="comment"></span>
04302 <span class="comment">    GenerateSuccessAudit - Returns a boolean indicating whether or not</span>
04303 <span class="comment">        we should generate a success audit.</span>
04304 <span class="comment"></span>
04305 <span class="comment">    GenerateFailureAudit - Returns a boolean indicating whether or not</span>
04306 <span class="comment">        we should generate a failure audit.</span>
04307 <span class="comment"></span>
04308 <span class="comment">Return Value:</span>
04309 <span class="comment"></span>
04310 <span class="comment">    STATUS_SUCCESS - The operation completed successfully.</span>
04311 <span class="comment"></span>
04312 <span class="comment">--*/</span>
04313 
04314 {
04315 
04316     ULONG i, j;
04317     PVOID Ace;
04318     ULONG AceCount;
04319     ACCESS_MASK AccessMask;
04320     UCHAR AceFlags;
04321     BOOLEAN FailedMaximumAllowed;
04322     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
04323     ULONG SuccessIndex;
04324 <span class="preprocessor">#define INVALID_OBJECT_TYPE_LIST_INDEX 0xFFFFFFFF</span>
04325 <span class="preprocessor"></span>
04326     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04327 
04328     *GenerateSuccessAudit = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04329     *GenerateFailureAudit = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04330 
04331     <span class="comment">//</span>
04332     <span class="comment">// If we failed an attempt to open an object for maximumum allowed,</span>
04333     <span class="comment">// then we generate an audit if ANY ACCESS_DENIED audit matching this</span>
04334     <span class="comment">// user's list of sids is found</span>
04335     <span class="comment">//</span>
04336 
04337     FailedMaximumAllowed = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04338     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(*AccessStatus) &amp;&amp; (DesiredAccess &amp; MAXIMUM_ALLOWED)) {
04339         FailedMaximumAllowed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04340     }
04341 
04342     <span class="comment">//</span>
04343     <span class="comment">// If the Sacl is null, do nothing and return</span>
04344     <span class="comment">//</span>
04345 
04346     <span class="keywordflow">if</span> (Sacl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04347         <span class="keywordflow">return</span>;
04348     }
04349 
04350     AceCount = Sacl-&gt;AceCount;
04351 
04352     <span class="keywordflow">if</span> (AceCount == 0) {
04353         <span class="keywordflow">return</span>;
04354     }
04355 
04356 
04357     <span class="comment">//</span>
04358     <span class="comment">// Iterate through the ACEs on the Sacl until either we reach</span>
04359     <span class="comment">// the end or discover that we have to take all possible actions,</span>
04360     <span class="comment">// in which case it doesn't pay to look any further</span>
04361     <span class="comment">//</span>
04362 
04363     <span class="keywordflow">for</span> ( i = 0, Ace = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a1">FirstAce</a>( Sacl ) ;
04364           (i &lt; AceCount) &amp;&amp; !((*GenerateSuccessAudit || *GenerateFailureAudit) &amp;&amp; ObjectTypeListLength &lt;= 1 );
04365           i++, Ace = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a2">NextAce</a>( Ace ) ) {
04366 
04367         AceFlags = ((PACE_HEADER)Ace)-&gt;AceFlags;
04368 
04369         <span class="keywordflow">if</span> ( !(AceFlags &amp; INHERIT_ONLY_ACE)) {
04370 
04371             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = <a class="code" href="../../d3/d5/seaudit_8c.html#a0">INVALID_OBJECT_TYPE_LIST_INDEX</a>;
04372 
04373              <span class="keywordflow">if</span> ( (((PACE_HEADER)Ace)-&gt;AceType == SYSTEM_AUDIT_ACE_TYPE) ) {
04374 
04375                  <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d6/sep_8h.html#a61">SepSidInToken</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;((PSYSTEM_AUDIT_ACE)Ace)-&gt;SidStart, (BOOLEAN) ((AceFlags &amp; FAILED_ACCESS_ACE_FLAG) != 0) ) ) {
04376 
04377                     AccessMask = ((PSYSTEM_AUDIT_ACE)Ace)-&gt;Mask;
04378 
04379                     <span class="keywordflow">for</span> (j=0; j &lt; ObjectTypeListLength; j++)
04380                     {
04381                         <a class="code" href="../../d3/d5/seaudit_8c.html#a32">SepSetAuditInfoForObjectType</a>(AceFlags,
04382                                                      AccessMask,
04383                                                      DesiredAccess,
04384                                                      ObjectTypeList,
04385                                                      ObjectTypeListLength,
04386                                                      ReturnResultList,
04387                                                      j,
04388                                                      AccessStatus,
04389                                                      GrantedAccess,
04390                                                      FailedMaximumAllowed,
04391                                                      GenerateSuccessAudit,
04392                                                      GenerateFailureAudit
04393                                                      );
04394                     }
04395                     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = <a class="code" href="../../d3/d5/seaudit_8c.html#a0">INVALID_OBJECT_TYPE_LIST_INDEX</a>;
04396                 }
04397 
04398             <span class="comment">//</span>
04399             <span class="comment">// Handle an object specific audit ACE</span>
04400             <span class="comment">//</span>
04401             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (((PACE_HEADER)Ace)-&gt;AceType == SYSTEM_AUDIT_OBJECT_ACE_TYPE) ) {
04402                 GUID *ObjectTypeInAce;
04403 
04404                 <span class="comment">//</span>
04405                 <span class="comment">// If no object type is in the ACE,</span>
04406                 <span class="comment">//  treat this as a normal audit ACE.</span>
04407                 <span class="comment">//</span>
04408 
04409                 AccessMask = ((PSYSTEM_AUDIT_OBJECT_ACE)Ace)-&gt;Mask;
04410                 ObjectTypeInAce = RtlObjectAceObjectType(Ace);
04411 
04412                 <span class="keywordflow">if</span> ( ObjectTypeInAce == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
04413 
04414                     <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d6/sep_8h.html#a61">SepSidInToken</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, RtlObjectAceSid(Ace), (BOOLEAN)((AceFlags &amp; FAILED_ACCESS_ACE_FLAG) != 0) ) ) {
04415 
04416                         <span class="keywordflow">for</span> (j=0; j &lt; ObjectTypeListLength; j++)
04417                         {
04418                             <a class="code" href="../../d3/d5/seaudit_8c.html#a32">SepSetAuditInfoForObjectType</a>(AceFlags,
04419                                                          AccessMask,
04420                                                          DesiredAccess,
04421                                                          ObjectTypeList,
04422                                                          ObjectTypeListLength,
04423                                                          ReturnResultList,
04424                                                          j,
04425                                                          AccessStatus,
04426                                                          GrantedAccess,
04427                                                          FailedMaximumAllowed,
04428                                                          GenerateSuccessAudit,
04429                                                          GenerateFailureAudit
04430                                                          );
04431                         }
04432                         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = <a class="code" href="../../d3/d5/seaudit_8c.html#a0">INVALID_OBJECT_TYPE_LIST_INDEX</a>;
04433                     }
04434 
04435                 <span class="comment">//</span>
04436                 <span class="comment">// If no object type list was passed,</span>
04437                 <span class="comment">//  don't generate an audit.</span>
04438                 <span class="comment">//</span>
04439 
04440                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( ObjectTypeListLength == 0 ) {
04441 
04442                     <span class="comment">// Drop through</span>
04443 
04444                 <span class="comment">//</span>
04445                 <span class="comment">// If an object type is in the ACE,</span>
04446                 <span class="comment">//   Find it in the LocalTypeList before using the ACE.</span>
04447                 <span class="comment">//</span>
04448                 } <span class="keywordflow">else</span> {
04449 
04450                     <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d6/sep_8h.html#a61">SepSidInToken</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, RtlObjectAceSid(Ace), (BOOLEAN)((AceFlags &amp; FAILED_ACCESS_ACE_FLAG) != 0) ) ) {
04451 
04452                         <span class="keywordflow">if</span> ( !<a class="code" href="../../d8/d3/tokenp_8h.html#a39">SepObjectInTypeList</a>( ObjectTypeInAce,
04453                                                    ObjectTypeList,
04454                                                    ObjectTypeListLength,
04455                                                    &amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> ) ) {
04456 
04457                             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = <a class="code" href="../../d3/d5/seaudit_8c.html#a0">INVALID_OBJECT_TYPE_LIST_INDEX</a>;
04458                         }
04459                     }
04460                 }
04461 
04462             }
04463 
04464             <span class="comment">//</span>
04465             <span class="comment">// If the ACE has a matched SID and a matched GUID,</span>
04466             <span class="comment">//  handle it.</span>
04467             <span class="comment">//</span>
04468 
04469             <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> != <a class="code" href="../../d3/d5/seaudit_8c.html#a0">INVALID_OBJECT_TYPE_LIST_INDEX</a> ) {
04470 
04471                 <span class="comment">//</span>
04472                 <span class="comment">// ASSERT: we have an ACE to be audited.</span>
04473                 <span class="comment">//</span>
04474                 <span class="comment">// Index is an index into ObjectTypeList of the entry to mark</span>
04475                 <span class="comment">//  as the GUID needs auditing.</span>
04476                 <span class="comment">//</span>
04477                 <span class="comment">// SuccessIndex is an index into AccessStatus to determine if</span>
04478                 <span class="comment">//  a success or failure audit is to be generated</span>
04479                 <span class="comment">//</span>
04480 
04481                 <a class="code" href="../../d3/d5/seaudit_8c.html#a32">SepSetAuditInfoForObjectType</a>(AceFlags,
04482                                              AccessMask,
04483                                              DesiredAccess,
04484                                              ObjectTypeList,
04485                                              ObjectTypeListLength,
04486                                              ReturnResultList,
04487                                              <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>,
04488                                              AccessStatus,
04489                                              GrantedAccess,
04490                                              FailedMaximumAllowed,
04491                                              GenerateSuccessAudit,
04492                                              GenerateFailureAudit
04493                                              );
04494             }
04495 
04496         }
04497     }
04498 
04499     <span class="keywordflow">return</span>;
04500 }
04501 
04502 
04503 
04504 <span class="comment">/******************************************************************************</span>
04505 <span class="comment">*                                                                             *</span>
04506 <span class="comment">*    The following list of privileges is checked at high frequency            *</span>
04507 <span class="comment">*    during normal operation, and tend to clog up the audit log when          *</span>
04508 <span class="comment">*    privilege auditing is enabled.  The use of these privileges will         *</span>
04509 <span class="comment">*    not be audited when they are checked singly or in combination with       *</span>
04510 <span class="comment">*    each other.                                                              *</span>
04511 <span class="comment">*                                                                             *</span>
04512 <span class="comment">*    When adding new privileges, be careful to preserve the NULL              *</span>
04513 <span class="comment">*    privilege pointer marking the end of the array.                          *</span>
04514 <span class="comment">*                                                                             *</span>
04515 <span class="comment">*    Be sure to update the corresponding array in LSA when adding new         *</span>
04516 <span class="comment">*    privileges to this list (LsaFilterPrivileges).                           *</span>
04517 <span class="comment">*                                                                             *</span>
04518 <span class="comment">******************************************************************************/</span>
04519 
<a name="l04520"></a><a class="code" href="../../d3/d5/seaudit_8c.html#a2">04520</a> PLUID *<a class="code" href="../../d3/d5/seaudit_8c.html#a2">SepFilterPrivileges</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04521 
<a name="l04522"></a><a class="code" href="../../d3/d5/seaudit_8c.html#a3">04522</a> PLUID <a class="code" href="../../d3/d5/seaudit_8c.html#a3">SepFilterPrivilegesLong</a>[] =
04523     {
04524         &amp;<a class="code" href="../../d0/d5/se_8h.html#a100">SeChangeNotifyPrivilege</a>,
04525         &amp;<a class="code" href="../../d0/d5/se_8h.html#a98">SeAuditPrivilege</a>,
04526         &amp;<a class="code" href="../../d0/d5/se_8h.html#a79">SeCreateTokenPrivilege</a>,
04527         &amp;<a class="code" href="../../d0/d5/se_8h.html#a80">SeAssignPrimaryTokenPrivilege</a>,
04528         &amp;<a class="code" href="../../d0/d5/se_8h.html#a94">SeBackupPrivilege</a>,
04529         &amp;<a class="code" href="../../d0/d5/se_8h.html#a95">SeRestorePrivilege</a>,
04530         &amp;<a class="code" href="../../d0/d5/se_8h.html#a97">SeDebugPrivilege</a>,
04531         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
04532     };
04533 
04534 <span class="comment">/******************************************************************************</span>
04535 <span class="comment">*                                                                             *</span>
04536 <span class="comment">*  The following list of privileges is the same as the above list, except     *</span>
04537 <span class="comment">*  is missing backup and restore privileges.  This allows for auditing        *</span>
04538 <span class="comment">*  the use of those privileges at the time they are used.                     *</span>
04539 <span class="comment">*                                                                             *</span>
04540 <span class="comment">*  The use of this list or the one above is determined by settings in         *</span>
04541 <span class="comment">*  the registry.                                                              *</span>
04542 <span class="comment">*                                                                             *</span>
04543 <span class="comment">******************************************************************************/</span>
04544 
<a name="l04545"></a><a class="code" href="../../d3/d5/seaudit_8c.html#a4">04545</a> PLUID <a class="code" href="../../d3/d5/seaudit_8c.html#a4">SepFilterPrivilegesShort</a>[] =
04546     {
04547         &amp;<a class="code" href="../../d0/d5/se_8h.html#a100">SeChangeNotifyPrivilege</a>,
04548         &amp;<a class="code" href="../../d0/d5/se_8h.html#a98">SeAuditPrivilege</a>,
04549         &amp;<a class="code" href="../../d0/d5/se_8h.html#a79">SeCreateTokenPrivilege</a>,
04550         &amp;<a class="code" href="../../d0/d5/se_8h.html#a80">SeAssignPrimaryTokenPrivilege</a>,
04551         &amp;<a class="code" href="../../d0/d5/se_8h.html#a97">SeDebugPrivilege</a>,
04552         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
04553     };
04554 
04555 BOOLEAN
<a name="l04556"></a><a class="code" href="../../d3/d5/seaudit_8c.html#a33">04556</a> <a class="code" href="../../d3/d5/seaudit_8c.html#a33">SepInitializePrivilegeFilter</a>(
04557     BOOLEAN Verbose
04558     )
04559 <span class="comment">/*++</span>
04560 <span class="comment"></span>
04561 <span class="comment">Routine Description:</span>
04562 <span class="comment"></span>
04563 <span class="comment">    Initializes SepFilterPrivileges for either normal or verbose auditing.</span>
04564 <span class="comment"></span>
04565 <span class="comment">Arguments:</span>
04566 <span class="comment"></span>
04567 <span class="comment">    Verbose - Whether we want to filter by the short or long privileges</span>
04568 <span class="comment">    list.  Verbose == TRUE means use the short list.</span>
04569 <span class="comment"></span>
04570 <span class="comment">Return Value:</span>
04571 <span class="comment"></span>
04572 <span class="comment">    TRUE for success, FALSE for failure</span>
04573 <span class="comment"></span>
04574 <span class="comment">--*/</span>
04575 {
04576     <span class="keywordflow">if</span> (Verbose) {
04577         <a class="code" href="../../d3/d5/seaudit_8c.html#a2">SepFilterPrivileges</a> = <a class="code" href="../../d3/d5/seaudit_8c.html#a4">SepFilterPrivilegesShort</a>;
04578     } <span class="keywordflow">else</span> {
04579         <a class="code" href="../../d3/d5/seaudit_8c.html#a2">SepFilterPrivileges</a> = <a class="code" href="../../d3/d5/seaudit_8c.html#a3">SepFilterPrivilegesLong</a>;
04580     }
04581 
04582     <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
04583 }
04584 
04585 
04586 BOOLEAN
<a name="l04587"></a><a class="code" href="../../d6/d6/sep_8h.html#a67">04587</a> <a class="code" href="../../d6/d6/sep_8h.html#a67">SepFilterPrivilegeAudits</a>(
04588     IN PPRIVILEGE_SET PrivilegeSet
04589     )
04590 
04591 <span class="comment">/*++</span>
04592 <span class="comment"></span>
04593 <span class="comment">Routine Description:</span>
04594 <span class="comment"></span>
04595 <span class="comment">    This routine will filter out a list of privileges as listed in the</span>
04596 <span class="comment">    SepFilterPrivileges array.</span>
04597 <span class="comment"></span>
04598 <span class="comment">Arguments:</span>
04599 <span class="comment"></span>
04600 <span class="comment">    Privileges - The privilege set to be audited</span>
04601 <span class="comment"></span>
04602 <span class="comment">Return Value:</span>
04603 <span class="comment"></span>
04604 <span class="comment">    FALSE means that this use of privilege is not to be audited.</span>
04605 <span class="comment">    TRUE means that the audit should continue normally.</span>
04606 <span class="comment"></span>
04607 <span class="comment">--*/</span>
04608 
04609 {
04610     PLUID *Privilege;
04611     ULONG Match = 0;
04612     ULONG i;
04613 
04614     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04615 
04616     <span class="keywordflow">if</span> ( !ARGUMENT_PRESENT(PrivilegeSet) ||
04617         (PrivilegeSet-&gt;PrivilegeCount == 0) ) {
04618         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
04619     }
04620 
04621     <span class="keywordflow">for</span> (i=0; i&lt;PrivilegeSet-&gt;PrivilegeCount; i++) {
04622 
04623         Privilege = <a class="code" href="../../d3/d5/seaudit_8c.html#a2">SepFilterPrivileges</a>;
04624 
04625         <span class="keywordflow">do</span> {
04626 
04627             <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>( &amp;PrivilegeSet-&gt;Privilege[i].Luid, *Privilege )) {
04628 
04629                 Match++;
04630                 <span class="keywordflow">break</span>;
04631             }
04632 
04633         } <span class="keywordflow">while</span> ( *++Privilege != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>  );
04634     }
04635 
04636     <span class="keywordflow">if</span> ( Match == PrivilegeSet-&gt;PrivilegeCount ) {
04637 
04638         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
04639 
04640     } <span class="keywordflow">else</span> {
04641 
04642         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
04643     }
04644 }
04645 
04646 
04647 BOOLEAN
<a name="l04648"></a><a class="code" href="../../d3/d5/seaudit_8c.html#a35">04648</a> <a class="code" href="../../d3/d5/seaudit_8c.html#a35">SeAuditingFileOrGlobalEvents</a>(
04649     IN BOOLEAN AccessGranted,
04650     IN PSECURITY_DESCRIPTOR SecurityDescriptor,
04651     IN <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">PSECURITY_SUBJECT_CONTEXT</a> SubjectSecurityContext
04652     )
04653 
04654 <span class="comment">/*++</span>
04655 <span class="comment"></span>
04656 <span class="comment">Routine Description:</span>
04657 <span class="comment"></span>
04658 <span class="comment">    This routine is to be called by a file system to quickly determine</span>
04659 <span class="comment">    if we are auditing file open events.  This allows the file system</span>
04660 <span class="comment">    to avoid the often considerable setup involved in generating an audit.</span>
04661 <span class="comment"></span>
04662 <span class="comment">Arguments:</span>
04663 <span class="comment"></span>
04664 <span class="comment">    AccessGranted - Supplies whether the access attempt was successful</span>
04665 <span class="comment">        or a failure.</span>
04666 <span class="comment"></span>
04667 <span class="comment">Return Value:</span>
04668 <span class="comment"></span>
04669 <span class="comment">    Boolean - TRUE if events of type AccessGranted are being audited, FALSE</span>
04670 <span class="comment">        otherwise.</span>
04671 <span class="comment"></span>
04672 <span class="comment">--*/</span>
04673 
04674 {
04675     PISECURITY_DESCRIPTOR ISecurityDescriptor = (PISECURITY_DESCRIPTOR) SecurityDescriptor;
04676 
04677     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04678 
04679     <span class="keywordflow">if</span> ( ((<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)<a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a>( SubjectSecurityContext ))-&gt;AuditData != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04680         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
04681     }
04682 
04683     <span class="keywordflow">if</span> ( RtlpSaclAddrSecurityDescriptor( ISecurityDescriptor ) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
04684 
04685         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
04686     }
04687 
04688     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d5/adtp_8h.html#a1">SepAdtAuditThisEvent</a>( AuditCategoryObjectAccess, &amp;AccessGranted ) );
04689 }
04690 
04691 
04692 BOOLEAN
<a name="l04693"></a><a class="code" href="../../d3/d5/seaudit_8c.html#a36">04693</a> <a class="code" href="../../d3/d5/seaudit_8c.html#a36">SeAuditingFileEvents</a>(
04694     IN BOOLEAN AccessGranted,
04695     IN PSECURITY_DESCRIPTOR SecurityDescriptor
04696     )
04697 
04698 <span class="comment">/*++</span>
04699 <span class="comment"></span>
04700 <span class="comment">Routine Description:</span>
04701 <span class="comment"></span>
04702 <span class="comment">    This routine is to be called by a file system to quickly determine</span>
04703 <span class="comment">    if we are auditing file open events.  This allows the file system</span>
04704 <span class="comment">    to avoid the often considerable setup involved in generating an audit.</span>
04705 <span class="comment"></span>
04706 <span class="comment">Arguments:</span>
04707 <span class="comment"></span>
04708 <span class="comment">    AccessGranted - Supplies whether the access attempt was successful</span>
04709 <span class="comment">        or a failure.</span>
04710 <span class="comment"></span>
04711 <span class="comment">Return Value:</span>
04712 <span class="comment"></span>
04713 <span class="comment">    Boolean - TRUE if events of type AccessGranted are being audited, FALSE</span>
04714 <span class="comment">        otherwise.</span>
04715 <span class="comment"></span>
04716 <span class="comment">--*/</span>
04717 
04718 {
04719     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04720 
04721     UNREFERENCED_PARAMETER( SecurityDescriptor );
04722 
04723     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d5/adtp_8h.html#a1">SepAdtAuditThisEvent</a>( AuditCategoryObjectAccess, &amp;AccessGranted ) );
04724 }
04725 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:44 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
