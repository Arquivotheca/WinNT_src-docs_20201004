<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: trapc.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>trapc.c</h1><a href="../../d3/d5/i386_2trapc_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    trapc.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains some trap handling code written in C.</span>
00012 <span class="comment">    Only by the kernel.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Ken Reneris     6-9-93</span>
00017 <span class="comment"></span>
00018 <span class="comment">Revision History:</span>
00019 <span class="comment"></span>
00020 <span class="comment">--*/</span>
00021 
00022 <span class="preprocessor">#include    "<a class="code" href="../../d0/d0/ki_8h.html">ki.h</a>"</span>
00023 
00024 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00025 <a class="code" href="../../d4/d4/iafptrap_8c.html#a11">Ki386CheckDivideByZeroTrap</a> (
00026     IN  PKTRAP_FRAME    UserFrame
00027     );
00028 
00029 
00030 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00031 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, Ki386CheckDivideByZeroTrap)</span>
00032 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00033 <span class="preprocessor"></span>
00034 
<a name="l00035"></a><a class="code" href="../../d3/d5/i386_2trapc_8c.html#a0">00035</a> <span class="preprocessor">#define REG(field)          ((ULONG)(&amp;((KTRAP_FRAME *)0)-&gt;field))</span>
<a name="l00036"></a><a class="code" href="../../d3/d5/i386_2trapc_8c.html#a1">00036</a> <span class="preprocessor"></span><span class="preprocessor">#define GETREG(frame,reg)   ((PULONG) (((ULONG) frame)+reg))[0]</span>
00037 <span class="preprocessor"></span>
<a name="l00038"></a><a class="code" href="../../d1/d8/structKMOD.html">00038</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
00039     UCHAR   RmDisplaceOnly;     <span class="comment">// RM of displacment only, no base reg</span>
00040     UCHAR   RmSib;              <span class="comment">// RM of SIB</span>
00041     UCHAR   RmDisplace;         <span class="comment">// bit mask of RMs which have a displacement</span>
00042     UCHAR   Disp;               <span class="comment">// sizeof displacement (in bytes)</span>
00043 } <a class="code" href="../../d1/d8/structKMOD.html">KMOD</a>, *<a class="code" href="../../d3/d5/i386_2trapc_8c.html#a2">PKMOD</a>;
00044 
<a name="l00045"></a><a class="code" href="../../d3/d5/i386_2trapc_8c.html#a3">00045</a> <span class="keyword">static</span> UCHAR <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a3">RM32</a>[] = {
00046     <span class="comment">/* 000 */</span>   <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a0">REG</a>(Eax),
00047     <span class="comment">/* 001 */</span>   <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a0">REG</a>(Ecx),
00048     <span class="comment">/* 010 */</span>   <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a0">REG</a>(Edx),
00049     <span class="comment">/* 011 */</span>   <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a0">REG</a>(Ebx),
00050     <span class="comment">/* 100 */</span>   <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a0">REG</a>(HardwareEsp),
00051     <span class="comment">/* 101 */</span>   <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a0">REG</a>(Ebp),       <span class="comment">// SIB</span>
00052     <span class="comment">/* 110 */</span>   <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a0">REG</a>(Esi),
00053     <span class="comment">/* 111 */</span>   <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a0">REG</a>(Edi)
00054 };
00055 
<a name="l00056"></a><a class="code" href="../../d3/d5/i386_2trapc_8c.html#a4">00056</a> <span class="keyword">static</span> UCHAR <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a4">RM8</a>[] = {
00057     <span class="comment">/* 000 */</span>   <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a0">REG</a>(Eax),       <span class="comment">// al</span>
00058     <span class="comment">/* 001 */</span>   <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a0">REG</a>(Ecx),       <span class="comment">// cl</span>
00059     <span class="comment">/* 010 */</span>   <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a0">REG</a>(Edx),       <span class="comment">// dl</span>
00060     <span class="comment">/* 011 */</span>   <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a0">REG</a>(Ebx),       <span class="comment">// bl</span>
00061     <span class="comment">/* 100 */</span>   <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a0">REG</a>(Eax) + 1,   <span class="comment">// ah</span>
00062     <span class="comment">/* 101 */</span>   <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a0">REG</a>(Ecx) + 1,   <span class="comment">// ch</span>
00063     <span class="comment">/* 110 */</span>   <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a0">REG</a>(Edx) + 1,   <span class="comment">// dh</span>
00064     <span class="comment">/* 111 */</span>   <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a0">REG</a>(Ebx) + 1    <span class="comment">// bh</span>
00065 };
00066 
<a name="l00067"></a><a class="code" href="../../d3/d5/i386_2trapc_8c.html#a5">00067</a> <span class="keyword">static</span> <a class="code" href="../../d1/d8/structKMOD.html">KMOD</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a5">MOD32</a>[] = {
00068     <span class="comment">/* 00 */</span>     5,     4,   0x20,   4,
00069     <span class="comment">/* 01 */</span>  0xff,     4,   0xff,   1,
00070     <span class="comment">/* 10 */</span>  0xff,     4,   0xff,   4,
00071     <span class="comment">/* 11 */</span>  0xff,  0xff,   0x00,   0
00072 } ;
00073 
00074 <span class="keyword">static</span> <span class="keyword">struct </span>{
<a name="l00075"></a><a class="code" href="../../d3/d5/i386_2trapc_8c.html#a7">00075</a>     UCHAR   <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a6">Opcode1</a>, <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a7">Opcode2</a>;   <span class="comment">// instruction opcode</span>
<a name="l00076"></a><a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">00076</a>     UCHAR   <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a8">ModRm</a>, <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>;        <span class="comment">// if 2nd part of opcode is encoded in ModRm</span>
00077 } <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a10">NoWaitNpxInstructions</a>[] = {
00078     <span class="comment">/* FNINIT   */</span>  0xDB, 0xE3, 0,  1,
00079     <span class="comment">/* FNCLEX   */</span>  0xDB, 0xE2, 0,  1,
00080     <span class="comment">/* FNSTENV  */</span>  0xD9, 0x06, 1,  1,
00081     <span class="comment">/* FNSAVE   */</span>  0xDD, 0x06, 1,  1,
00082     <span class="comment">/* FNSTCW   */</span>  0xD9, 0x07, 1,  2,
00083     <span class="comment">/* FNSTSW   */</span>  0xDD, 0x07, 1,  3,
00084     <span class="comment">/* FNSTSW AX*/</span>  0xDF, 0xE0, 0,  4,
00085                     0x00, 0x00, 0,  1
00086 };
00087 
00088 
00089 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00090"></a><a class="code" href="../../d3/d5/i386_2trapc_8c.html#a11">00090</a> <a class="code" href="../../d4/d4/iafptrap_8c.html#a11">Ki386CheckDivideByZeroTrap</a> (
00091     IN  PKTRAP_FRAME    UserFrame
00092     )
00093 <span class="comment">/*++</span>
00094 <span class="comment"></span>
00095 <span class="comment">Routine Description:</span>
00096 <span class="comment"></span>
00097 <span class="comment">    This function gains control when the x86 processor generates a</span>
00098 <span class="comment">    divide by zero trap.  The x86 design generates such a trap on</span>
00099 <span class="comment">    divide by zero and on division overflows.  In order to determine</span>
00100 <span class="comment">    which expection code to dispatch, the divisor of the "div" or "idiv"</span>
00101 <span class="comment">    instruction needs to be inspected.</span>
00102 <span class="comment"></span>
00103 <span class="comment">Arguments:</span>
00104 <span class="comment"></span>
00105 <span class="comment">    UserFrame - Trap frame of the divide by zero trap</span>
00106 <span class="comment"></span>
00107 <span class="comment">Return Value:</span>
00108 <span class="comment"></span>
00109 <span class="comment">    exception code dispatch</span>
00110 <span class="comment"></span>
00111 <span class="comment">--*/</span>
00112 {
00113     ULONG       operandsize, operandmask, i, accum;
00114     PUCHAR      istream, pRM;
00115     UCHAR       ibyte, rm;
00116     <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a2">PKMOD</a>       Mod;
00117     BOOLEAN     fPrefix;
00118     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
00119 
00120     status = STATUS_INTEGER_DIVIDE_BY_ZERO;
00121 
00122     <span class="keywordflow">if</span> (UserFrame-&gt;SegCs == KGDT_R0_CODE) {
00123         <span class="comment">//</span>
00124         <span class="comment">// Divide by zero exception from Kernel Mode?</span>
00125         <span class="comment">// Likely bad hardware interrupt and the device or vector table is corrupt.</span>
00126         <span class="comment">// Bugcheck NOW so we can figure out what went wrong. If we try and</span>
00127         <span class="comment">// proceed, then we'll likely fault in reading the top of user space, and then</span>
00128         <span class="comment">// double fault (page fault in the div zero handler.) -- This is a debugging</span>
00129         <span class="comment">// consideration. You can't put breakpoints on the trap labels  so this is hard to debug.</span>
00130         <span class="comment">// We cannot recover</span>
00131         <span class="comment">//</span>
00132         <span class="comment">//</span>
00133         <a class="code" href="../../d9/d1/bugcheck_8c.html#a13">KeBugCheck</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a23">UNEXPECTED_KERNEL_MODE_TRAP</a>);
00134 
00135     }
00136 
00137 
00138     <span class="keywordflow">try</span> {
00139 
00140         <span class="comment">//</span>
00141         <span class="comment">// read instruction prefixes</span>
00142         <span class="comment">//</span>
00143 
00144         fPrefix = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00145         pRM = <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a3">RM32</a>;
00146         operandsize = 4;
00147         operandmask = 0xffffffff;
00148         istream = (PUCHAR) UserFrame-&gt;Eip;
00149         <span class="keywordflow">while</span> (fPrefix) {
00150             ibyte = <a class="code" href="../../d5/d8/ex_8h.html#a14">ProbeAndReadUchar</a>(istream);
00151             istream++;
00152             <span class="keywordflow">switch</span> (ibyte) {
00153                 <span class="keywordflow">case</span> 0x2e:  <span class="comment">// cs override</span>
00154                 <span class="keywordflow">case</span> 0x36:  <span class="comment">// ss override</span>
00155                 <span class="keywordflow">case</span> 0x3e:  <span class="comment">// ds override</span>
00156                 <span class="keywordflow">case</span> 0x26:  <span class="comment">// es override</span>
00157                 <span class="keywordflow">case</span> 0x64:  <span class="comment">// fs override</span>
00158                 <span class="keywordflow">case</span> 0x65:  <span class="comment">// gs override</span>
00159                 <span class="keywordflow">case</span> 0xF3:  <span class="comment">// rep</span>
00160                 <span class="keywordflow">case</span> 0xF2:  <span class="comment">// rep</span>
00161                 <span class="keywordflow">case</span> 0xF0:  <span class="comment">// lock</span>
00162                     <span class="keywordflow">break</span>;
00163 
00164                 <span class="keywordflow">case</span> 0x66:
00165                     <span class="comment">// 16 bit operand override</span>
00166                     operandsize = 2;
00167                     operandmask = 0xffff;
00168                     <span class="keywordflow">break</span>;
00169 
00170                 <span class="keywordflow">case</span> 0x67:
00171                     <span class="comment">// 16 bit address size override</span>
00172                     <span class="comment">// this is some non-flat code</span>
00173                     <span class="keywordflow">goto</span> try_exit;
00174 
00175                 <span class="keywordflow">default</span>:
00176                     fPrefix = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00177                     <span class="keywordflow">break</span>;
00178             }
00179         }
00180 
00181         <span class="comment">//</span>
00182         <span class="comment">// Check instruction opcode</span>
00183         <span class="comment">//</span>
00184 
00185         <span class="keywordflow">if</span> (ibyte != 0xf7  &amp;&amp;  ibyte != 0xf6) {
00186             <span class="comment">// this is not a DIV or IDIV opcode</span>
00187             <span class="keywordflow">goto</span> try_exit;
00188         }
00189 
00190         <span class="keywordflow">if</span> (ibyte == 0xf6) {
00191             <span class="comment">// this is a byte div or idiv</span>
00192             operandsize = 1;
00193             operandmask = 0xff;
00194         }
00195 
00196         <span class="comment">//</span>
00197         <span class="comment">// Get Mod R/M</span>
00198         <span class="comment">//</span>
00199 
00200         ibyte = <a class="code" href="../../d5/d8/ex_8h.html#a14">ProbeAndReadUchar</a> (istream);
00201         istream++;
00202         Mod = <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a5">MOD32</a> + (ibyte &gt;&gt; 6);
00203         rm  = ibyte &amp; 7;
00204 
00205         <span class="comment">//</span>
00206         <span class="comment">// put register values into accum</span>
00207         <span class="comment">//</span>
00208 
00209         <span class="keywordflow">if</span> (operandsize == 1  &amp;&amp;  (ibyte &amp; 0xc0) == 0xc0) {
00210             pRM = <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a4">RM8</a>;
00211         }
00212 
00213         accum = 0;
00214         <span class="keywordflow">if</span> (rm != Mod-&gt;RmDisplaceOnly) {
00215             <span class="keywordflow">if</span> (rm == Mod-&gt;RmSib) {
00216                 <span class="comment">// get SIB</span>
00217                 ibyte = <a class="code" href="../../d5/d8/ex_8h.html#a14">ProbeAndReadUchar</a>(istream);
00218                 istream++;
00219                 i = (ibyte &gt;&gt; 3) &amp; 7;
00220                 <span class="keywordflow">if</span> (i != 4) {
00221                     accum = <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a1">GETREG</a>(UserFrame, <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a3">RM32</a>[i]);
00222                     accum = accum &lt;&lt; (ibyte &gt;&gt; 6);    <span class="comment">// apply scaler</span>
00223                 }
00224                 i = ibyte &amp; 7;
00225                 accum = accum + <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a1">GETREG</a>(UserFrame, <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a3">RM32</a>[i]);
00226             } <span class="keywordflow">else</span> {
00227                 <span class="comment">// get register's value</span>
00228                 accum = <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a1">GETREG</a>(UserFrame, pRM[rm]);
00229             }
00230         }
00231 
00232         <span class="comment">//</span>
00233         <span class="comment">// apply displacement to accum</span>
00234         <span class="comment">//</span>
00235 
00236         <span class="keywordflow">if</span> (Mod-&gt;RmDisplace &amp; (1 &lt;&lt; rm)) {
00237             <span class="keywordflow">if</span> (Mod-&gt;Disp == 4) {
00238                 i = <a class="code" href="../../d5/d8/ex_8h.html#a20">ProbeAndReadUlong</a> ((PULONG) istream);
00239             } <span class="keywordflow">else</span> {
00240                 ibyte = <a class="code" href="../../d5/d8/ex_8h.html#a13">ProbeAndReadChar</a> (istream);
00241                 i = (<span class="keywordtype">signed</span> <span class="keywordtype">long</span>) ((<span class="keywordtype">signed</span> <span class="keywordtype">char</span>) ibyte);    <span class="comment">// sign extend</span>
00242             }
00243             accum += i;
00244         }
00245 
00246         <span class="comment">//</span>
00247         <span class="comment">// if this is an effective address, go get the data value</span>
00248         <span class="comment">//</span>
00249 
00250         <span class="keywordflow">if</span> (Mod-&gt;Disp) {
00251             <span class="keywordflow">switch</span> (operandsize) {
00252                 <span class="keywordflow">case</span> 1:  accum = <a class="code" href="../../d5/d8/ex_8h.html#a14">ProbeAndReadUchar</a>((PUCHAR) accum);    <span class="keywordflow">break</span>;
00253                 <span class="keywordflow">case</span> 2:  accum = <a class="code" href="../../d5/d8/ex_8h.html#a16">ProbeAndReadUshort</a>((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>) accum);  <span class="keywordflow">break</span>;
00254                 <span class="keywordflow">case</span> 4:  accum = <a class="code" href="../../d5/d8/ex_8h.html#a20">ProbeAndReadUlong</a>((PULONG) accum);    <span class="keywordflow">break</span>;
00255             }
00256         }
00257 
00258         <span class="comment">//</span>
00259         <span class="comment">// accum now contains the instruction operand, see if the</span>
00260         <span class="comment">// operand was really a zero</span>
00261         <span class="comment">//</span>
00262 
00263         <span class="keywordflow">if</span> (accum &amp; operandmask) {
00264             <span class="comment">// operand was non-zero, must be an overflow</span>
00265             status = STATUS_INTEGER_OVERFLOW;
00266         }
00267 
00268 try_exit: ;
00269     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00270         <span class="comment">// do nothing...</span>
00271     }
00272 
00273     <span class="keywordflow">return</span> status;
00274 }
00275 
00276 UCHAR
<a name="l00277"></a><a class="code" href="../../d3/d5/i386_2trapc_8c.html#a12">00277</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a12">KiNextIStreamByte</a> (
00278     IN  PKTRAP_FRAME UserFrame,
00279     IN  PUCHAR  *istream
00280     )
00281 <span class="comment">/*++</span>
00282 <span class="comment"></span>
00283 <span class="comment">Routine Description:</span>
00284 <span class="comment"></span>
00285 <span class="comment">    Reads the next byte from the istream pointed to by the UserFrame, and</span>
00286 <span class="comment">    advances the EIP.</span>
00287 <span class="comment"></span>
00288 <span class="comment"></span>
00289 <span class="comment">    Note: this function works for 32 bit code only</span>
00290 <span class="comment"></span>
00291 <span class="comment">--*/</span>
00292 {
00293     UCHAR   ibyte;
00294 
00295     <span class="keywordflow">if</span> (UserFrame-&gt;SegCs == KGDT_R0_CODE) {
00296         ibyte = **istream;
00297     } <span class="keywordflow">else</span> {
00298         ibyte = <a class="code" href="../../d5/d8/ex_8h.html#a14">ProbeAndReadUchar</a> (*istream);
00299     }
00300 
00301     *istream += 1;
00302     <span class="keywordflow">return</span> ibyte;
00303 }
00304 
00305 
00306 
00307 
00308 BOOLEAN
<a name="l00309"></a><a class="code" href="../../d3/d5/i386_2trapc_8c.html#a13">00309</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a13">Ki386CheckDelayedNpxTrap</a> (
00310     IN  PKTRAP_FRAME UserFrame,
00311     IN  PFX_SAVE_AREA NpxFrame
00312     )
00313 
00314 <span class="comment">/*++</span>
00315 <span class="comment"></span>
00316 <span class="comment">Routine Description:</span>
00317 <span class="comment"></span>
00318 <span class="comment">    This function gains control from the Trap07 handler.  It examines</span>
00319 <span class="comment">    the user mode instruction to see if it's a NoWait NPX instruction.</span>
00320 <span class="comment">    Such instructions do not generate floating point exceptions - this</span>
00321 <span class="comment">    check needs to be done due to the way 80386/80387 systems are</span>
00322 <span class="comment">    implemented.  Such machines will generate a floating point exception</span>
00323 <span class="comment">    interrupt when the kernel performs an FRSTOR to reload the thread's</span>
00324 <span class="comment">    NPX context.  If the thread's next instruction is a NoWait style</span>
00325 <span class="comment">    instruction, then we clear the exception or emulate the instruction.</span>
00326 <span class="comment"></span>
00327 <span class="comment">    AND... due to a different 80386/80387 "feature" the kernel needs</span>
00328 <span class="comment">    to use FWAIT at times which can causes 80487's to generate delayed</span>
00329 <span class="comment">    exceptions that can lead to the same problem described above.</span>
00330 <span class="comment"></span>
00331 <span class="comment">Arguments:</span>
00332 <span class="comment"></span>
00333 <span class="comment">    UserFrame - Trap frame of the exception</span>
00334 <span class="comment">    NpxFrame - Thread's NpxFrame  (WARNING: does not have NpxState)</span>
00335 <span class="comment"></span>
00336 <span class="comment">    Interrupts are disabled</span>
00337 <span class="comment"></span>
00338 <span class="comment">Return Value:</span>
00339 <span class="comment"></span>
00340 <span class="comment">    FALSE - Dispatch NPX exception to user mode</span>
00341 <span class="comment">    TRUE - Exception handled, continue</span>
00342 <span class="comment"></span>
00343 <span class="comment">--*/</span>
00344 
00345 {
00346     EXCEPTION_RECORD ExceptionRecord;
00347     UCHAR       ibyte1, ibyte2, inmodrm, status;
00348     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>      StatusWord, ControlWord, UsersWord;
00349     PUCHAR      istream;
00350     BOOLEAN     fPrefix;
00351     UCHAR       rm;
00352     <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a2">PKMOD</a>       Mod;
00353     ULONG       accum, i;
00354 
00355     status = 0;
00356     <span class="keywordflow">try</span> {
00357 
00358         <span class="comment">//</span>
00359         <span class="comment">// read instruction prefixes</span>
00360         <span class="comment">//</span>
00361 
00362         fPrefix = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00363         istream = (PUCHAR) UserFrame-&gt;Eip;
00364         <span class="keywordflow">while</span> (fPrefix) {
00365             ibyte1 = <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a12">KiNextIStreamByte</a> (UserFrame, &amp;istream);
00366             <span class="keywordflow">switch</span> (ibyte1) {
00367                 <span class="keywordflow">case</span> 0x2e:  <span class="comment">// cs override</span>
00368                 <span class="keywordflow">case</span> 0x36:  <span class="comment">// ss override</span>
00369                 <span class="keywordflow">case</span> 0x3e:  <span class="comment">// ds override</span>
00370                 <span class="keywordflow">case</span> 0x26:  <span class="comment">// es override</span>
00371                 <span class="keywordflow">case</span> 0x64:  <span class="comment">// fs override</span>
00372                 <span class="keywordflow">case</span> 0x65:  <span class="comment">// gs override</span>
00373                     <span class="keywordflow">break</span>;
00374 
00375                 <span class="keywordflow">default</span>:
00376                     fPrefix = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00377                     <span class="keywordflow">break</span>;
00378             }
00379         }
00380 
00381         <span class="comment">//</span>
00382         <span class="comment">// Check for coprocessor NoWait NPX instruction</span>
00383         <span class="comment">//</span>
00384 
00385         ibyte2 = <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a12">KiNextIStreamByte</a> (UserFrame, &amp;istream);
00386         inmodrm = (ibyte2 &gt;&gt; 3) &amp; 0x7;
00387 
00388         <span class="keywordflow">for</span> (i=0; <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a10">NoWaitNpxInstructions</a>[i].Opcode1; i++) {
00389             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d5/i386_2trapc_8c.html#a10">NoWaitNpxInstructions</a>[i].Opcode1 == ibyte1) {
00390 
00391                 <span class="comment">//</span>
00392                 <span class="comment">// first opcode byte matched - check second part of opcode</span>
00393                 <span class="comment">//</span>
00394 
00395                 <span class="keywordflow">if</span> (<a class="code" href="../../d3/d5/i386_2trapc_8c.html#a10">NoWaitNpxInstructions</a>[i].ModRm) {
00396 
00397                     <span class="comment">//</span>
00398                     <span class="comment">// modrm only applies for opcode in range 0-0xbf</span>
00399                     <span class="comment">//</span>
00400 
00401                     <span class="keywordflow">if</span> (((ibyte2 &amp; 0xc0) != 0xc0) &amp;&amp;
00402                         (<a class="code" href="../../d3/d5/i386_2trapc_8c.html#a10">NoWaitNpxInstructions</a>[i].Opcode2 == inmodrm)) {
00403 
00404                         <span class="comment">//</span>
00405                         <span class="comment">// This is a no-wait NPX instruction</span>
00406                         <span class="comment">//</span>
00407 
00408                         status = <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a10">NoWaitNpxInstructions</a>[i].type;
00409                         <span class="keywordflow">break</span>;
00410                     }
00411 
00412                 } <span class="keywordflow">else</span> {
00413                     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d5/i386_2trapc_8c.html#a10">NoWaitNpxInstructions</a>[i].Opcode2 == ibyte2) {
00414 
00415                         <span class="comment">//</span>
00416                         <span class="comment">// This is a no-wait NPX instruction</span>
00417                         <span class="comment">//</span>
00418 
00419                         status = <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a10">NoWaitNpxInstructions</a>[i].type;
00420                         <span class="keywordflow">break</span>;
00421                     }
00422                 }
00423             }
00424         }
00425 
00426     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00427         <span class="comment">// do nothing...</span>
00428     }
00429 
00430     <span class="keywordflow">if</span> (status == 0) {
00431         <span class="comment">//</span>
00432         <span class="comment">// Dispatch coprocessor exception to user mode</span>
00433         <span class="comment">//</span>
00434 
00435         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00436     }
00437 
00438     <span class="keywordflow">if</span> (status == 1) {
00439         <span class="comment">//</span>
00440         <span class="comment">// Ignore pending exception, user mode instruction does not trap</span>
00441         <span class="comment">// on pending execptions and it will clear/mask the pending exceptions</span>
00442         <span class="comment">//</span>
00443 
00444         _asm {
00445             mov     eax, cr0
00446             and     eax, NOT (CR0_MP+CR0_EM+CR0_TS)
00447             mov     cr0, eax
00448         }
00449 
00450         NpxFrame-&gt;Cr0NpxState &amp;= ~CR0_TS;
00451         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00452     }
00453 
00454     <span class="comment">//</span>
00455     <span class="comment">// This is either FNSTSW or FNSTCW.  Both of these instructions get</span>
00456     <span class="comment">// a value from the coprocessor without effecting the pending exception</span>
00457     <span class="comment">// state.  To do this we emulate the instructions.</span>
00458     <span class="comment">//</span>
00459 
00460     <span class="comment">//</span>
00461     <span class="comment">// Read the coprocessors Status &amp; Control word state, then re-enable</span>
00462     <span class="comment">// interrupts.  (it's safe to context switch after that point)</span>
00463     <span class="comment">//</span>
00464 
00465     _asm {
00466         mov     eax, cr0
00467         mov     ecx, eax
00468         and     eax, NOT (CR0_MP+CR0_EM+CR0_TS)
00469         mov     cr0, eax
00470 
00471         fnstsw  StatusWord
00472         fnstcw  ControlWord
00473 
00474         mov     cr0, ecx
00475         sti
00476     }
00477 
00478     <span class="keywordflow">if</span> (status == 4) {
00479         <span class="comment">//</span>
00480         <span class="comment">// Emulate FNSTSW AX</span>
00481         <span class="comment">//</span>
00482 
00483         UserFrame-&gt;Eip = (ULONG)istream;
00484         UserFrame-&gt;Eax = (UserFrame-&gt;Eax &amp; 0xFFFF0000) | StatusWord;
00485         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00486     }
00487 
00488     <span class="keywordflow">if</span> (status == 2) {
00489         UsersWord = ControlWord;
00490     } <span class="keywordflow">else</span> {
00491         UsersWord = StatusWord;
00492     }
00493 
00494     <span class="keywordflow">try</span> {
00495 
00496         <span class="comment">//</span>
00497         <span class="comment">// (PERFNOTE: the operand decode code should really share code with</span>
00498         <span class="comment">// KiCheckDivideByZeroTrap, but this is a late change therefore the</span>
00499         <span class="comment">// code was copied to keep the impact of the change localized)</span>
00500         <span class="comment">//</span>
00501 
00502         <span class="comment">//</span>
00503         <span class="comment">// decode Mod/RM byte</span>
00504         <span class="comment">//</span>
00505 
00506         Mod = <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a5">MOD32</a> + (ibyte2 &gt;&gt; 6);
00507         rm  = ibyte2 &amp; 7;
00508 
00509         <span class="comment">//</span>
00510         <span class="comment">// Decode the instruction's word pointer into accum</span>
00511         <span class="comment">//</span>
00512 
00513         accum = 0;
00514         <span class="keywordflow">if</span> (rm != Mod-&gt;RmDisplaceOnly) {
00515             <span class="keywordflow">if</span> (rm == Mod-&gt;RmSib) {
00516                 <span class="comment">// get SIB</span>
00517                 ibyte1 = <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a12">KiNextIStreamByte</a> (UserFrame, &amp;istream);
00518                 i = (ibyte1 &gt;&gt; 3) &amp; 7;
00519                 <span class="keywordflow">if</span> (i != 4) {
00520                     accum = <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a1">GETREG</a>(UserFrame, <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a3">RM32</a>[i]);
00521                     accum = accum &lt;&lt; (ibyte1 &gt;&gt; 6);    <span class="comment">// apply scaler</span>
00522                 }
00523                 i = ibyte1 &amp; 7;
00524                 accum = accum + <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a1">GETREG</a>(UserFrame, <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a3">RM32</a>[i]);
00525             } <span class="keywordflow">else</span> {
00526                 <span class="comment">// get register's value</span>
00527                 accum = <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a1">GETREG</a>(UserFrame, <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a3">RM32</a>[rm]);
00528             }
00529         }
00530 
00531         <span class="comment">//</span>
00532         <span class="comment">// apply displacement to accum</span>
00533         <span class="comment">//</span>
00534 
00535         <span class="keywordflow">if</span> (Mod-&gt;RmDisplace &amp; (1 &lt;&lt; rm)) {
00536             <span class="keywordflow">if</span> (Mod-&gt;Disp == 4) {
00537                 i = (<a class="code" href="../../d3/d5/i386_2trapc_8c.html#a12">KiNextIStreamByte</a> (UserFrame, &amp;istream) &lt;&lt; 0) |
00538                     (<a class="code" href="../../d3/d5/i386_2trapc_8c.html#a12">KiNextIStreamByte</a> (UserFrame, &amp;istream) &lt;&lt; 8) |
00539                     (<a class="code" href="../../d3/d5/i386_2trapc_8c.html#a12">KiNextIStreamByte</a> (UserFrame, &amp;istream) &lt;&lt; 16) |
00540                     (<a class="code" href="../../d3/d5/i386_2trapc_8c.html#a12">KiNextIStreamByte</a> (UserFrame, &amp;istream) &lt;&lt; 24);
00541             } <span class="keywordflow">else</span> {
00542                 ibyte1 = <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a12">KiNextIStreamByte</a> (UserFrame, &amp;istream);
00543                 i = (<span class="keywordtype">signed</span> <span class="keywordtype">long</span>) ((<span class="keywordtype">signed</span> <span class="keywordtype">char</span>) ibyte1);    <span class="comment">// sign extend</span>
00544             }
00545             accum += i;
00546         }
00547 
00548         <span class="comment">//</span>
00549         <span class="comment">// Set the word pointer</span>
00550         <span class="comment">//</span>
00551 
00552         <span class="keywordflow">if</span> (UserFrame-&gt;SegCs == KGDT_R0_CODE) {
00553             *((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>) accum) = UsersWord;
00554         } <span class="keywordflow">else</span> {
00555             <a class="code" href="../../d5/d8/ex_8h.html#a48">ProbeAndWriteUshort</a> ((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>) accum, UsersWord);
00556         }
00557         UserFrame-&gt;Eip = (ULONG)istream;
00558 
00559     } except (<a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a12">KiCopyInformation</a>(&amp;ExceptionRecord,
00560                 (GetExceptionInformation())-&gt;ExceptionRecord)) {
00561         <span class="comment">//</span>
00562         <span class="comment">// Faulted addressing user's memory.</span>
00563         <span class="comment">// Set the address of the exception to the current program address</span>
00564         <span class="comment">// and raise the exception by calling the exception dispatcher.</span>
00565         <span class="comment">//</span>
00566 
00567         ExceptionRecord.ExceptionAddress = (PVOID)(UserFrame-&gt;Eip);
00568         <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a11">KiDispatchException</a>(
00569             &amp;ExceptionRecord,
00570             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                <span class="comment">// ExceptionFrame</span>
00571             UserFrame,
00572             <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>,
00573             <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
00574         );
00575     }
00576 
00577     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00578 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:42:03 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
