<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: lockvm.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>lockvm.c</h1><a href="../../d3/d5/lockvm_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">   lockvm.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains the routines which implement the</span>
00012 <span class="comment">    NtLockVirtualMemory service.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Lou Perazzoli (loup) 20-August-1989</span>
00017 <span class="comment"></span>
00018 <span class="comment">Revision History:</span>
00019 <span class="comment"></span>
00020 <span class="comment">    Landy Wang (landyw) 08-April-1998 : Modifications for 3-level 64-bit NT.</span>
00021 <span class="comment"></span>
00022 <span class="comment">--*/</span>
00023 
00024 <span class="preprocessor">#include "<a class="code" href="../../d4/d8/mi_8h.html">mi.h</a>"</span>
00025 
00026 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00027 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtLockVirtualMemory)</span>
00028 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtUnlockVirtualMemory)</span>
00029 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00030 <span class="preprocessor"></span>
00031 
00032 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00033"></a><a class="code" href="../../d3/d5/lockvm_8c.html#a0">00033</a> <a class="code" href="../../d3/d5/lockvm_8c.html#a0">NtLockVirtualMemory</a> (
00034     IN HANDLE ProcessHandle,
00035     IN OUT PVOID *BaseAddress,
00036     IN OUT PSIZE_T RegionSize,
00037     IN ULONG MapType
00038      )
00039 
00040 <span class="comment">/*++</span>
00041 <span class="comment"></span>
00042 <span class="comment">Routine Description:</span>
00043 <span class="comment"></span>
00044 <span class="comment">    This function locks a region of pages within the working set list</span>
00045 <span class="comment">    of a subject process.</span>
00046 <span class="comment"></span>
00047 <span class="comment">    The caller of this function must have PROCESS_VM_OPERATION access</span>
00048 <span class="comment">    to the target process.  The caller must also have SeLockMemoryPrivilege.</span>
00049 <span class="comment"></span>
00050 <span class="comment">Arguments:</span>
00051 <span class="comment"></span>
00052 <span class="comment">   ProcessHandle - Supplies an open handle to a process object.</span>
00053 <span class="comment"></span>
00054 <span class="comment">   BaseAddress - The base address of the region of pages</span>
00055 <span class="comment">        to be locked. This value is rounded down to the</span>
00056 <span class="comment">        next host page address boundary.</span>
00057 <span class="comment"></span>
00058 <span class="comment">   RegionSize - A pointer to a variable that will receive</span>
00059 <span class="comment">        the actual size in bytes of the locked region of</span>
00060 <span class="comment">        pages. The initial value of this argument is</span>
00061 <span class="comment">        rounded up to the next host page size boundary.</span>
00062 <span class="comment"></span>
00063 <span class="comment">   MapType - A set of flags that describe the type of locking to</span>
00064 <span class="comment">            perform.  One of MAP_PROCESS or MAP_SYSTEM.</span>
00065 <span class="comment"></span>
00066 <span class="comment">Return Value:</span>
00067 <span class="comment"></span>
00068 <span class="comment">    Returns the status</span>
00069 <span class="comment"></span>
00070 <span class="comment">    STATUS_PRIVILEGE_NOT_HELD - The caller did not have sufficient</span>
00071 <span class="comment">        privilege to perform the requested operation.</span>
00072 <span class="comment"></span>
00073 <span class="comment">    TBS</span>
00074 <span class="comment"></span>
00075 <span class="comment"></span>
00076 <span class="comment">--*/</span>
00077 
00078 {
00079     PVOID Va;
00080     PVOID EndingAddress;
00081     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00082     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte1;
00083     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
00084     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
00085     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe;
00086     ULONG_PTR CapturedRegionSize;
00087     PVOID CapturedBase;
00088     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> TargetProcess;
00089     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00090     BOOLEAN WasLocked;
00091     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00092     ULONG Entry;
00093     ULONG SwapEntry;
00094     SIZE_T NumberOfAlreadyLocked;
00095     SIZE_T NumberToLock;
00096     ULONG WorkingSetIndex;
00097     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Vad;
00098     PVOID LastVa;
00099     <a class="code" href="../../d7/d2/struct__MMLOCK__CONFLICT.html">MMLOCK_CONFLICT</a> Conflict;
00100     ULONG Waited;
00101     LOGICAL Attached;
00102 <span class="preprocessor">#if defined(_MIALT4K_)</span>
00103 <span class="preprocessor"></span>    BOOLEAN IsWow64Process = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00104 <span class="preprocessor">#endif</span>
00105 <span class="preprocessor"></span>
00106     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00107 
00108     WasLocked = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00109     LastVa = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00110 
00111     <span class="comment">//</span>
00112     <span class="comment">// Validate the flags in MapType.</span>
00113     <span class="comment">//</span>
00114 
00115     <span class="keywordflow">if</span> ((MapType &amp; ~(MAP_PROCESS | MAP_SYSTEM)) != 0) {
00116         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00117     }
00118 
00119     <span class="keywordflow">if</span> ((MapType &amp; (MAP_PROCESS | MAP_SYSTEM)) == 0) {
00120         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00121     }
00122 
00123     PreviousMode = KeGetPreviousMode();
00124 
00125     <span class="keywordflow">try</span> {
00126 
00127         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00128 
00129             <a class="code" href="../../d5/d8/ex_8h.html#a37">ProbeForWritePointer</a> ((PULONG)BaseAddress);
00130             <a class="code" href="../../d5/d8/ex_8h.html#a41">ProbeForWriteUlong_ptr</a> (RegionSize);
00131         }
00132 
00133         <span class="comment">//</span>
00134         <span class="comment">// Capture the base address.</span>
00135         <span class="comment">//</span>
00136 
00137         CapturedBase = *BaseAddress;
00138 
00139         <span class="comment">//</span>
00140         <span class="comment">// Capture the region size.</span>
00141         <span class="comment">//</span>
00142 
00143         CapturedRegionSize = *RegionSize;
00144 
00145     } except (<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00146 
00147         <span class="comment">//</span>
00148         <span class="comment">// If an exception occurs during the probe or capture</span>
00149         <span class="comment">// of the initial values, then handle the exception and</span>
00150         <span class="comment">// return the exception code as the status value.</span>
00151         <span class="comment">//</span>
00152 
00153         <span class="keywordflow">return</span> GetExceptionCode();
00154     }
00155 
00156     <span class="comment">//</span>
00157     <span class="comment">// Make sure the specified starting and ending addresses are</span>
00158     <span class="comment">// within the user part of the virtual address space.</span>
00159     <span class="comment">//</span>
00160 
00161     <span class="keywordflow">if</span> (CapturedBase &gt; MM_HIGHEST_USER_ADDRESS) {
00162 
00163         <span class="comment">//</span>
00164         <span class="comment">// Invalid base address.</span>
00165         <span class="comment">//</span>
00166 
00167         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00168     }
00169 
00170     <span class="keywordflow">if</span> ((ULONG_PTR)MM_HIGHEST_USER_ADDRESS - (ULONG_PTR)CapturedBase &lt;
00171                                                         CapturedRegionSize) {
00172 
00173         <span class="comment">//</span>
00174         <span class="comment">// Invalid region size;</span>
00175         <span class="comment">//</span>
00176 
00177         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00178 
00179     }
00180 
00181     <span class="keywordflow">if</span> (CapturedRegionSize == 0) {
00182         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00183     }
00184 
00185     <span class="comment">//</span>
00186     <span class="comment">// Reference the specified process.</span>
00187     <span class="comment">//</span>
00188 
00189     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a> ( ProcessHandle,
00190                                          PROCESS_VM_OPERATION,
00191                                          <a class="code" href="../../d9/d8/ntos_8h.html#a2">PsProcessType</a>,
00192                                          PreviousMode,
00193                                          (PVOID *)&amp;TargetProcess,
00194                                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00195 
00196     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00197         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00198     }
00199 
00200     <span class="keywordflow">if</span> ((MapType &amp; MAP_SYSTEM) != 0) {
00201 
00202         <span class="comment">//</span>
00203         <span class="comment">// In addition to PROCESS_VM_OPERATION access to the target</span>
00204         <span class="comment">// process, the caller must have SE_LOCK_MEMORY_PRIVILEGE.</span>
00205         <span class="comment">//</span>
00206 
00207         <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d4/privileg_8c.html#a3">SeSinglePrivilegeCheck</a>(
00208                            <a class="code" href="../../d0/d5/se_8h.html#a81">SeLockMemoryPrivilege</a>,
00209                            PreviousMode
00210                            )) {
00211 
00212             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( TargetProcess );
00213             <span class="keywordflow">return</span>( STATUS_PRIVILEGE_NOT_HELD );
00214         }
00215     }
00216 
00217     <span class="comment">//</span>
00218     <span class="comment">// Attach to the specified process.</span>
00219     <span class="comment">//</span>
00220 
00221     <span class="keywordflow">if</span> (ProcessHandle != NtCurrentProcess()) {
00222         <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a> (&amp;TargetProcess-&gt;Pcb);
00223         Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00224     }
00225     <span class="keywordflow">else</span> {
00226         Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00227     }
00228 
00229     <span class="comment">//</span>
00230     <span class="comment">// Get address creation mutex, this prevents the</span>
00231     <span class="comment">// address range from being modified while it is examined.  Raise</span>
00232     <span class="comment">// to APC level to prevent an APC routine from acquiring the</span>
00233     <span class="comment">// address creation mutex.  Get the working set mutex so the</span>
00234     <span class="comment">// number of already locked pages in the request can be determined.</span>
00235     <span class="comment">//</span>
00236 
00237 <span class="preprocessor">#if defined(_MIALT4K_)</span>
00238 <span class="preprocessor"></span>
00239     <span class="comment">//</span>
00240     <span class="comment">// changing to 4k aligned should not change the correctness.</span>
00241     <span class="comment">//</span>
00242 
00243     EndingAddress = <a class="code" href="../../d2/d9/miia64_8h.html#a230">PAGE_4K_ALIGN</a>((PCHAR)CapturedBase + CapturedRegionSize - 1);
00244 <span class="preprocessor">#else</span>
00245 <span class="preprocessor"></span>    EndingAddress = <a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>((PCHAR)CapturedBase + CapturedRegionSize - 1);
00246 <span class="preprocessor">#endif</span>
00247 <span class="preprocessor"></span>
00248     Va = <a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> (CapturedBase);
00249     NumberOfAlreadyLocked = 0;
00250     NumberToLock = ((ULONG_PTR)EndingAddress - (ULONG_PTR)Va) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
00251 
00252     <a class="code" href="../../d4/d8/mi_8h.html#a161">LOCK_WS_AND_ADDRESS_SPACE</a> (TargetProcess);
00253 
00254     <span class="comment">//</span>
00255     <span class="comment">// Make sure the address space was not deleted, if so, return an error.</span>
00256     <span class="comment">//</span>
00257 
00258     <span class="keywordflow">if</span> (TargetProcess-&gt;AddressSpaceDeleted != 0) {
00259         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_PROCESS_IS_TERMINATING;
00260         <span class="keywordflow">goto</span> ErrorReturn;
00261     }
00262 
00263     <span class="keywordflow">if</span> (NumberToLock + <a class="code" href="../../d4/d8/mi_8h.html#a15">MM_FLUID_WORKING_SET</a> &gt;
00264                                     TargetProcess-&gt;Vm.MinimumWorkingSetSize) {
00265         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_WORKING_SET_QUOTA;
00266         <span class="keywordflow">goto</span> ErrorReturn;
00267     }
00268 
00269     <span class="keywordflow">while</span> (Va &lt;= EndingAddress) {
00270 
00271         <span class="keywordflow">if</span> (Va &gt; LastVa) {
00272 
00273             <span class="comment">//</span>
00274             <span class="comment">// Don't lock physically mapped views.</span>
00275             <span class="comment">//</span>
00276 
00277             Vad = <a class="code" href="../../d6/d3/vadtree_8c.html#a2">MiLocateAddress</a> (Va);
00278             <span class="keywordflow">if</span> (Vad == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00279                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_VIOLATION;
00280                 <span class="keywordflow">goto</span> ErrorReturn;
00281             }
00282 
00283             <span class="keywordflow">if</span> ((Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.PhysicalMapping == 1) ||
00284                 (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.UserPhysicalPages == 1)) {
00285                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INCOMPATIBLE_FILE_MAP;
00286                 <span class="keywordflow">goto</span> ErrorReturn;
00287             }
00288             LastVa = <a class="code" href="../../d4/d8/mi_8h.html#a108">MI_VPN_TO_VA</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a>);
00289         }
00290 
00291         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a> (Va)) {
00292 
00293             <span class="comment">//</span>
00294             <span class="comment">// The page is valid, therefore it is in the working set.</span>
00295             <span class="comment">// Locate the WSLE for the page and see if it is locked.</span>
00296             <span class="comment">//</span>
00297 
00298             PointerPte1 = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (Va);
00299             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPte1-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
00300 
00301             WorkingSetIndex = <a class="code" href="../../d7/d0/wstree_8c.html#a7">MiLocateWsle</a> (Va,
00302                                             <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>,
00303                                             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex);
00304 
00305             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WorkingSetIndex != <a class="code" href="../../d4/d8/mi_8h.html#a10">WSLE_NULL_INDEX</a>);
00306 
00307             <span class="keywordflow">if</span> (WorkingSetIndex &lt; <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>) {
00308 
00309                 <span class="comment">//</span>
00310                 <span class="comment">// This page is locked in the working set.</span>
00311                 <span class="comment">//</span>
00312 
00313                 NumberOfAlreadyLocked += 1;
00314 
00315                 <span class="comment">//</span>
00316                 <span class="comment">// Check to see if the WAS_LOCKED status should be returned.</span>
00317                 <span class="comment">//</span>
00318 
00319                 <span class="keywordflow">if</span> ((MapType &amp; MAP_PROCESS) &amp;&amp;
00320                         (<a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>[WorkingSetIndex].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.LockedInWs == 1)) {
00321                     WasLocked = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00322                 }
00323 
00324                 <span class="keywordflow">if</span> ((MapType &amp; MAP_SYSTEM) &amp;&amp;
00325                         (<a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>[WorkingSetIndex].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.LockedInMemory == 1)) {
00326                     WasLocked = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00327                 }
00328             }
00329         }
00330         Va = (PVOID)((PCHAR)Va + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
00331     }
00332 
00333     <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (TargetProcess);
00334 
00335     <span class="comment">//</span>
00336     <span class="comment">// Check to ensure the working set list is still fluid after</span>
00337     <span class="comment">// the requested number of pages are locked.</span>
00338     <span class="comment">//</span>
00339 
00340     <span class="keywordflow">if</span> (TargetProcess-&gt;Vm.MinimumWorkingSetSize &lt;
00341           ((<a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a> + NumberToLock +
00342                       <a class="code" href="../../d4/d8/mi_8h.html#a15">MM_FLUID_WORKING_SET</a>) - NumberOfAlreadyLocked)) {
00343 
00344         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_WORKING_SET_QUOTA;
00345         <a class="code" href="../../d4/d8/mi_8h.html#a163">UNLOCK_ADDRESS_SPACE</a> (TargetProcess);
00346         <span class="keywordflow">goto</span> ErrorReturn1;
00347     }
00348 
00349     Va = <a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> (CapturedBase);
00350 
00351 <span class="preprocessor">#if defined(_MIALT4K_)</span>
00352 <span class="preprocessor"></span>
00353     <span class="keywordflow">if</span> (TargetProcess-&gt;Wow64Process != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00354 
00355         IsWow64Process = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00356         Va = <a class="code" href="../../d2/d9/miia64_8h.html#a230">PAGE_4K_ALIGN</a> (CapturedBase);
00357 
00358     }
00359 
00360 <span class="preprocessor">#endif</span>
00361 <span class="preprocessor"></span>
00362     <span class="comment">//</span>
00363     <span class="comment">// Set up an exception handler and touch each page in the specified</span>
00364     <span class="comment">// range.</span>
00365     <span class="comment">//</span>
00366 
00367     <a class="code" href="../../d4/d8/mi_8h.html#a775">MiInsertConflictInList</a> (&amp;Conflict);
00368 
00369     <span class="keywordflow">try</span> {
00370 
00371         <span class="keywordflow">while</span> (Va &lt;= EndingAddress) {
00372             *(<span class="keyword">volatile</span> ULONG *)Va;
00373             Va = (PVOID)((PCHAR)Va + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
00374         }
00375 
00376     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00377         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00378         <a class="code" href="../../d4/d8/mi_8h.html#a774">MiRemoveConflictFromList</a> (&amp;Conflict);
00379         <a class="code" href="../../d4/d8/mi_8h.html#a163">UNLOCK_ADDRESS_SPACE</a> (TargetProcess);
00380         <span class="keywordflow">goto</span> ErrorReturn1;
00381     }
00382 
00383     <a class="code" href="../../d4/d8/mi_8h.html#a774">MiRemoveConflictFromList</a> (&amp;Conflict);
00384 
00385     <span class="comment">//</span>
00386     <span class="comment">// The complete address range is accessible, lock the pages into</span>
00387     <span class="comment">// the working set.</span>
00388     <span class="comment">//</span>
00389 
00390     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (CapturedBase);
00391     Va = <a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> (CapturedBase);
00392 
00393 <span class="preprocessor">#if defined(_MIALT4K_)</span>
00394 <span class="preprocessor"></span>
00395     <span class="keywordflow">if</span> (IsWow64Process) {
00396 
00397         Va = <a class="code" href="../../d2/d9/miia64_8h.html#a230">PAGE_4K_ALIGN</a> (CapturedBase);
00398 
00399     }
00400 
00401 <span class="preprocessor">#endif</span>
00402 <span class="preprocessor"></span>
00403     <span class="comment">//</span>
00404     <span class="comment">// Acquire the working set mutex, no page faults are allowed.</span>
00405     <span class="comment">//</span>
00406 
00407     <a class="code" href="../../d4/d8/mi_8h.html#a155">LOCK_WS_UNSAFE</a> (TargetProcess);
00408 
00409     <span class="keywordflow">while</span> (Va &lt;= EndingAddress) {
00410 
00411         <span class="comment">//</span>
00412         <span class="comment">// Make sure the PDE is valid.</span>
00413         <span class="comment">//</span>
00414 
00415         PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (Va);
00416         PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
00417 
00418         <span class="keywordflow">do</span> {
00419 
00420             (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a168">MiDoesPpeExistAndMakeValid</a> (PointerPpe,
00421                                               TargetProcess,
00422                                               <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00423                                               &amp;Waited);
00424 
00425             Waited = 0;
00426 
00427             (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d0/d2/mmsup_8c.html#a6">MiDoesPdeExistAndMakeValid</a> (PointerPde,
00428                                               TargetProcess,
00429                                               <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00430                                               &amp;Waited);
00431 
00432         } <span class="keywordflow">while</span> (Waited != 0);
00433 
00434         <span class="comment">//</span>
00435         <span class="comment">// Make sure the page is in the working set.</span>
00436         <span class="comment">//</span>
00437 
00438         <span class="keywordflow">while</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
00439 
00440             <span class="comment">//</span>
00441             <span class="comment">// Release the working set mutex and fault in the page.</span>
00442             <span class="comment">//</span>
00443 
00444             <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (TargetProcess);
00445 
00446             <span class="comment">//</span>
00447             <span class="comment">// Page in the PDE and make the PTE valid.</span>
00448             <span class="comment">//</span>
00449 
00450             *(<span class="keyword">volatile</span> ULONG *)Va;
00451 
00452             <span class="comment">//</span>
00453             <span class="comment">// Reacquire the working set mutex.</span>
00454             <span class="comment">//</span>
00455 
00456             <a class="code" href="../../d4/d8/mi_8h.html#a155">LOCK_WS_UNSAFE</a> (TargetProcess);
00457 
00458             <span class="comment">//</span>
00459             <span class="comment">// Make sure the page directory &amp; table pages are still valid.</span>
00460             <span class="comment">// Trimming could occur if either of the pages that were just</span>
00461             <span class="comment">// made valid were removed from the working set before the</span>
00462             <span class="comment">// working set lock was acquired.</span>
00463             <span class="comment">//</span>
00464 
00465             <span class="keywordflow">do</span> {
00466 
00467                 (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a168">MiDoesPpeExistAndMakeValid</a> (PointerPpe,
00468                                                   TargetProcess,
00469                                                   <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00470                                                   &amp;Waited);
00471 
00472                 Waited = 0;
00473 
00474                 (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d0/d2/mmsup_8c.html#a6">MiDoesPdeExistAndMakeValid</a> (PointerPde,
00475                                                   TargetProcess,
00476                                                   <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00477                                                   &amp;Waited);
00478             } <span class="keywordflow">while</span> (Waited != 0);
00479         }
00480 
00481         <span class="comment">//</span>
00482         <span class="comment">// The page is now in the working set, lock the page into</span>
00483         <span class="comment">// the working set.</span>
00484         <span class="comment">//</span>
00485 
00486         PointerPte1 = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (Va);
00487         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPte1-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
00488 
00489         Entry = <a class="code" href="../../d7/d0/wstree_8c.html#a7">MiLocateWsle</a> (Va, <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>, Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex);
00490 
00491         <span class="keywordflow">if</span> (Entry &gt;= <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>) {
00492 
00493             SwapEntry = <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>;
00494 
00495             <span class="keywordflow">if</span> (Entry != <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>) {
00496 
00497                 <span class="comment">//</span>
00498                 <span class="comment">// Swap this entry with the one at first dynamic.</span>
00499                 <span class="comment">//</span>
00500 
00501                 <a class="code" href="../../d7/d0/wstree_8c.html#a9">MiSwapWslEntries</a> (Entry, SwapEntry, &amp;TargetProcess-&gt;Vm);
00502             }
00503 
00504             <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a> += 1;
00505         } <span class="keywordflow">else</span> {
00506             SwapEntry = Entry;
00507         }
00508 
00509         <span class="comment">//</span>
00510         <span class="comment">// Indicate that the page is locked.</span>
00511         <span class="comment">//</span>
00512 
00513         <span class="keywordflow">if</span> (MapType &amp; MAP_PROCESS) {
00514             <a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>[SwapEntry].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.LockedInWs = 1;
00515         }
00516 
00517         <span class="keywordflow">if</span> (MapType &amp; MAP_SYSTEM) {
00518             <a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>[SwapEntry].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.LockedInMemory = 1;
00519         }
00520 
00521         <span class="comment">//</span>
00522         <span class="comment">// Increment to the next va and PTE.</span>
00523         <span class="comment">//</span>
00524 
00525         PointerPte += 1;
00526         Va = (PVOID)((PCHAR)Va + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
00527     }
00528 
00529 <span class="preprocessor">#if !(defined(_MIALT4K_))</span>
00530 <span class="preprocessor"></span>
00531     <a class="code" href="../../d4/d8/mi_8h.html#a162">UNLOCK_WS_AND_ADDRESS_SPACE</a> (TargetProcess);
00532 
00533 <span class="preprocessor">#else</span>
00534 <span class="preprocessor"></span>
00535     <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (TargetProcess);
00536 
00537     <span class="keywordflow">if</span> (IsWow64Process) {
00538 
00539         <a class="code" href="../../d2/d9/miia64_8h.html#a313">MiLockFor4kPage</a>(CapturedBase, CapturedRegionSize, TargetProcess);
00540 
00541     }
00542 
00543     <a class="code" href="../../d4/d8/mi_8h.html#a163">UNLOCK_ADDRESS_SPACE</a> (TargetProcess);
00544 
00545 <span class="preprocessor">#endif</span>
00546 <span class="preprocessor"></span>
00547     <span class="keywordflow">if</span> (Attached == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00548         <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00549     }
00550     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (TargetProcess);
00551 
00552     <span class="comment">//</span>
00553     <span class="comment">// Update return arguments.</span>
00554     <span class="comment">//</span>
00555 
00556     <span class="comment">//</span>
00557     <span class="comment">// Establish an exception handler and write the size and base</span>
00558     <span class="comment">// address.</span>
00559     <span class="comment">//</span>
00560 
00561     <span class="keywordflow">try</span> {
00562 
00563 <span class="preprocessor">#if defined(_MIALT4K_)</span>
00564 <span class="preprocessor"></span>
00565         <span class="keywordflow">if</span> (IsWow64Process) { 
00566 
00567             *RegionSize = ((PCHAR)EndingAddress -
00568                         (PCHAR)<a class="code" href="../../d2/d9/miia64_8h.html#a230">PAGE_4K_ALIGN</a>(CapturedBase)) + <a class="code" href="../../d2/d9/miia64_8h.html#a227">PAGE_4K</a>;
00569 
00570             *BaseAddress = <a class="code" href="../../d2/d9/miia64_8h.html#a230">PAGE_4K_ALIGN</a>(CapturedBase);
00571 
00572 
00573         } <span class="keywordflow">else</span> {    
00574 
00575 <span class="preprocessor">#endif</span>
00576 <span class="preprocessor"></span>        *RegionSize = ((PCHAR)EndingAddress - (PCHAR)<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(CapturedBase)) +
00577                                                                     <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
00578         *BaseAddress = <a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(CapturedBase);
00579 
00580 <span class="preprocessor">#if defined(_MIALT4K_)</span>
00581 <span class="preprocessor"></span>        }
00582 <span class="preprocessor">#endif</span>
00583 <span class="preprocessor"></span>
00584     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00585         <span class="keywordflow">return</span> GetExceptionCode();
00586     }
00587 
00588     <span class="keywordflow">if</span> (WasLocked) {
00589         <span class="keywordflow">return</span> STATUS_WAS_LOCKED;
00590     }
00591 
00592     <span class="keywordflow">return</span> STATUS_SUCCESS;
00593 
00594 ErrorReturn:
00595         <a class="code" href="../../d4/d8/mi_8h.html#a162">UNLOCK_WS_AND_ADDRESS_SPACE</a> (TargetProcess);
00596 ErrorReturn1:
00597         <span class="keywordflow">if</span> (Attached == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00598             <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00599         }
00600         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (TargetProcess);
00601         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00602 }
00603 
00604 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00605"></a><a class="code" href="../../d3/d5/lockvm_8c.html#a1">00605</a> <a class="code" href="../../d3/d5/lockvm_8c.html#a1">NtUnlockVirtualMemory</a> (
00606     IN HANDLE ProcessHandle,
00607     IN OUT PVOID *BaseAddress,
00608     IN OUT PSIZE_T RegionSize,
00609     IN ULONG MapType
00610     )
00611 
00612 <span class="comment">/*++</span>
00613 <span class="comment"></span>
00614 <span class="comment">Routine Description:</span>
00615 <span class="comment"></span>
00616 <span class="comment">    This function unlocks a region of pages within the working set list</span>
00617 <span class="comment">    of a subject process.</span>
00618 <span class="comment"></span>
00619 <span class="comment">    As a side effect, any pages which are not locked and are in the</span>
00620 <span class="comment">    process's working set are removed from the process's working set.</span>
00621 <span class="comment">    This allows NtUnlockVirtualMemory to remove a range of pages</span>
00622 <span class="comment">    from the working set.</span>
00623 <span class="comment"></span>
00624 <span class="comment">    The caller of this function must have PROCESS_VM_OPERATION access</span>
00625 <span class="comment">    to the target process.</span>
00626 <span class="comment"></span>
00627 <span class="comment">    The caller must also have SeLockMemoryPrivilege for MAP_SYSTEM.</span>
00628 <span class="comment"></span>
00629 <span class="comment">Arguments:</span>
00630 <span class="comment"></span>
00631 <span class="comment">   ProcessHandle - Supplies an open handle to a process object.</span>
00632 <span class="comment"></span>
00633 <span class="comment">   BaseAddress - The base address of the region of pages</span>
00634 <span class="comment">        to be unlocked. This value is rounded down to the</span>
00635 <span class="comment">        next host page address boundary.</span>
00636 <span class="comment"></span>
00637 <span class="comment">   RegionSize - A pointer to a variable that will receive</span>
00638 <span class="comment">        the actual size in bytes of the unlocked region of</span>
00639 <span class="comment">        pages. The initial value of this argument is</span>
00640 <span class="comment">        rounded up to the next host page size boundary.</span>
00641 <span class="comment"></span>
00642 <span class="comment">   MapType - A set of flags that describe the type of unlocking to</span>
00643 <span class="comment">            perform.  One of MAP_PROCESS or MAP_SYSTEM.</span>
00644 <span class="comment"></span>
00645 <span class="comment">Return Value:</span>
00646 <span class="comment"></span>
00647 <span class="comment">    Returns the status</span>
00648 <span class="comment"></span>
00649 <span class="comment">    TBS</span>
00650 <span class="comment"></span>
00651 <span class="comment"></span>
00652 <span class="comment">--*/</span>
00653 
00654 {
00655     PVOID Va;
00656     PVOID EndingAddress;
00657     SIZE_T CapturedRegionSize;
00658     PVOID CapturedBase;
00659     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> TargetProcess;
00660     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00661     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00662     ULONG Entry;
00663     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00664     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
00665     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Vad;
00666     PVOID LastVa;
00667     LOGICAL Attached;
00668 <span class="preprocessor">#if defined(_MIALT4K_)</span>
00669 <span class="preprocessor"></span>    BOOLEAN IsWow64Process = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00670 <span class="preprocessor">#endif</span>
00671 <span class="preprocessor"></span>
00672     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00673 
00674     LastVa = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00675 
00676     <span class="comment">//</span>
00677     <span class="comment">// Validate the flags in MapType.</span>
00678     <span class="comment">//</span>
00679 
00680     <span class="keywordflow">if</span> ((MapType &amp; ~(MAP_PROCESS | MAP_SYSTEM)) != 0) {
00681         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00682     }
00683 
00684     <span class="keywordflow">if</span> ((MapType &amp; (MAP_PROCESS | MAP_SYSTEM)) == 0) {
00685         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00686     }
00687 
00688     PreviousMode = KeGetPreviousMode();
00689 
00690     <span class="keywordflow">try</span> {
00691 
00692         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00693 
00694             <a class="code" href="../../d5/d8/ex_8h.html#a37">ProbeForWritePointer</a> (BaseAddress);
00695             <a class="code" href="../../d5/d8/ex_8h.html#a41">ProbeForWriteUlong_ptr</a> (RegionSize);
00696         }
00697 
00698         <span class="comment">//</span>
00699         <span class="comment">// Capture the base address.</span>
00700         <span class="comment">//</span>
00701 
00702         CapturedBase = *BaseAddress;
00703 
00704         <span class="comment">//</span>
00705         <span class="comment">// Capture the region size.</span>
00706         <span class="comment">//</span>
00707 
00708         CapturedRegionSize = *RegionSize;
00709 
00710     } except (<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00711 
00712         <span class="comment">//</span>
00713         <span class="comment">// If an exception occurs during the probe or capture</span>
00714         <span class="comment">// of the initial values, then handle the exception and</span>
00715         <span class="comment">// return the exception code as the status value.</span>
00716         <span class="comment">//</span>
00717 
00718         <span class="keywordflow">return</span> GetExceptionCode();
00719     }
00720 
00721     <span class="comment">//</span>
00722     <span class="comment">// Make sure the specified starting and ending addresses are</span>
00723     <span class="comment">// within the user part of the virtual address space.</span>
00724     <span class="comment">//</span>
00725 
00726     <span class="keywordflow">if</span> (CapturedBase &gt; MM_HIGHEST_USER_ADDRESS) {
00727 
00728         <span class="comment">//</span>
00729         <span class="comment">// Invalid base address.</span>
00730         <span class="comment">//</span>
00731 
00732         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00733     }
00734 
00735     <span class="keywordflow">if</span> ((ULONG_PTR)MM_HIGHEST_USER_ADDRESS - (ULONG_PTR)CapturedBase &lt;
00736                                                         CapturedRegionSize) {
00737 
00738         <span class="comment">//</span>
00739         <span class="comment">// Invalid region size;</span>
00740         <span class="comment">//</span>
00741 
00742         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00743 
00744     }
00745 
00746     <span class="keywordflow">if</span> (CapturedRegionSize == 0) {
00747         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00748     }
00749 
00750     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a> ( ProcessHandle,
00751                                          PROCESS_VM_OPERATION,
00752                                          <a class="code" href="../../d9/d8/ntos_8h.html#a2">PsProcessType</a>,
00753                                          PreviousMode,
00754                                          (PVOID *)&amp;TargetProcess,
00755                                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00756 
00757     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00758         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00759     }
00760 
00761     <span class="keywordflow">if</span> ((MapType &amp; MAP_SYSTEM) != 0) {
00762 
00763         <span class="comment">//</span>
00764         <span class="comment">// In addition to PROCESS_VM_OPERATION access to the target</span>
00765         <span class="comment">// process, the caller must have SE_LOCK_MEMORY_PRIVILEGE.</span>
00766         <span class="comment">//</span>
00767 
00768         <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d4/privileg_8c.html#a3">SeSinglePrivilegeCheck</a>(
00769                            <a class="code" href="../../d0/d5/se_8h.html#a81">SeLockMemoryPrivilege</a>,
00770                            PreviousMode
00771                            )) {
00772 
00773             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( TargetProcess );
00774             <span class="keywordflow">return</span> STATUS_PRIVILEGE_NOT_HELD;
00775         }
00776     }
00777 
00778     <span class="comment">//</span>
00779     <span class="comment">// Attach to the specified process.</span>
00780     <span class="comment">//</span>
00781 
00782     <span class="keywordflow">if</span> (ProcessHandle != NtCurrentProcess()) {
00783         <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a> (&amp;TargetProcess-&gt;Pcb);
00784         Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00785     }
00786     <span class="keywordflow">else</span> {
00787         Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00788     }
00789 
00790     <span class="comment">//</span>
00791     <span class="comment">// Get address creation mutex, this prevents the</span>
00792     <span class="comment">// address range from being modified while it is examined.</span>
00793     <span class="comment">// Block APCs so an APC routine can't get a page fault and</span>
00794     <span class="comment">// corrupt the working set list, etc.</span>
00795     <span class="comment">//</span>
00796 
00797     <a class="code" href="../../d4/d8/mi_8h.html#a161">LOCK_WS_AND_ADDRESS_SPACE</a> (TargetProcess);
00798 
00799     <span class="comment">//</span>
00800     <span class="comment">// Make sure the address space was not deleted, if so, return an error.</span>
00801     <span class="comment">//</span>
00802 
00803     <span class="keywordflow">if</span> (TargetProcess-&gt;AddressSpaceDeleted != 0) {
00804         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_PROCESS_IS_TERMINATING;
00805         <span class="keywordflow">goto</span> ErrorReturn;
00806     }
00807 
00808     EndingAddress = <a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>((PCHAR)CapturedBase + CapturedRegionSize - 1);
00809 
00810     Va = <a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> (CapturedBase);
00811 
00812     <span class="keywordflow">while</span> (Va &lt;= EndingAddress) {
00813 
00814         <span class="comment">//</span>
00815         <span class="comment">// Check to ensure all the specified pages are locked.</span>
00816         <span class="comment">//</span>
00817 
00818         <span class="comment">//</span>
00819         <span class="comment">// Don't unlock physically mapped views.</span>
00820         <span class="comment">//</span>
00821 
00822         <span class="keywordflow">if</span> (Va &gt; LastVa) {
00823             Vad = <a class="code" href="../../d6/d3/vadtree_8c.html#a2">MiLocateAddress</a> (Va);
00824             <span class="keywordflow">if</span> (Vad == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00825                 Va = (PVOID)((PCHAR)Va + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
00826                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NOT_LOCKED;
00827                 <span class="keywordflow">break</span>;
00828             }
00829 
00830             <span class="keywordflow">if</span> ((Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.PhysicalMapping == 1) ||
00831                 (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.UserPhysicalPages == 1)) {
00832                 Va = <a class="code" href="../../d4/d8/mi_8h.html#a108">MI_VPN_TO_VA</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a>);
00833                 <span class="keywordflow">break</span>;
00834             }
00835             LastVa = <a class="code" href="../../d4/d8/mi_8h.html#a108">MI_VPN_TO_VA</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a>);
00836         }
00837 
00838         <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a> (Va)) {
00839 
00840             <span class="comment">//</span>
00841             <span class="comment">// This page is not valid, therefore not in working set.</span>
00842             <span class="comment">//</span>
00843 
00844             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NOT_LOCKED;
00845         } <span class="keywordflow">else</span> {
00846 
00847             PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (Va);
00848             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid != 0);
00849             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
00850             Entry = <a class="code" href="../../d7/d0/wstree_8c.html#a7">MiLocateWsle</a> (Va, <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>, Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex);
00851             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Entry != <a class="code" href="../../d4/d8/mi_8h.html#a10">WSLE_NULL_INDEX</a>);
00852 
00853             <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>[Entry].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.LockedInWs == 0) &amp;&amp;
00854                 (<a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>[Entry].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.LockedInMemory == 0)) {
00855 
00856                 <span class="comment">//</span>
00857                 <span class="comment">// Not locked in memory or system, remove from working</span>
00858                 <span class="comment">// set.</span>
00859                 <span class="comment">//</span>
00860 
00861                 <a class="code" href="../../d2/d1/mm_8h.html#a80">PERFINFO_PAGE_INFO_DECL</a>();
00862 
00863                 <a class="code" href="../../d2/d1/mm_8h.html#a53">PERFINFO_GET_PAGE_INFO</a>(PointerPte);
00864 
00865                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/wslist_8c.html#a26">MiFreeWsle</a> (Entry, &amp;TargetProcess-&gt;Vm, PointerPte)) {
00866                     <a class="code" href="../../d2/d1/mm_8h.html#a74">PERFINFO_LOG_WS_REMOVAL</a>(PERFINFO_LOG_TYPE_OUTWS_EMPTYQ, &amp;TargetProcess-&gt;Vm);
00867                 }
00868 
00869                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NOT_LOCKED;
00870 
00871             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (MapType &amp; MAP_PROCESS) {
00872                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>[Entry].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.LockedInWs == 0)  {
00873 
00874                     <span class="comment">//</span>
00875                     <span class="comment">// This page is not locked.</span>
00876                     <span class="comment">//</span>
00877 
00878                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NOT_LOCKED;
00879                 }
00880             } <span class="keywordflow">else</span> {
00881                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>[Entry].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.LockedInMemory == 0)  {
00882 
00883                     <span class="comment">//</span>
00884                     <span class="comment">// This page is not locked.</span>
00885                     <span class="comment">//</span>
00886 
00887                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NOT_LOCKED;
00888                 }
00889             }
00890         }
00891         Va = (PVOID)((PCHAR)Va + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
00892     } <span class="comment">// end while</span>
00893 
00894 <span class="preprocessor">#if defined(_MIALT4K_)</span>
00895 <span class="preprocessor"></span>
00896     <span class="keywordflow">if</span> (TargetProcess-&gt;Wow64Process != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00897         
00898         IsWow64Process = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00899         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d9/miia64_8h.html#a314">MiUnlockFor4kPage</a>(CapturedBase, CapturedRegionSize, TargetProcess);
00900 
00901     }
00902 
00903 <span class="preprocessor">#endif</span>
00904 <span class="preprocessor"></span>
00905     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_NOT_LOCKED) {
00906         <span class="keywordflow">goto</span> ErrorReturn;
00907     }
00908 
00909     <span class="comment">//</span>
00910     <span class="comment">// The complete address range is locked, unlock them.</span>
00911     <span class="comment">//</span>
00912 
00913     Va = <a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> (CapturedBase);
00914     LastVa = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00915 
00916 
00917     <span class="keywordflow">while</span> (Va &lt;= EndingAddress) {
00918 
00919 <span class="preprocessor">#if defined(_MIALT4K_)</span>
00920 <span class="preprocessor"></span>
00921     <span class="keywordflow">if</span> (IsWow64Process) {
00922 
00923         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d9/miia64_8h.html#a315">MiShouldBeUnlockedFor4kPage</a>(Va, TargetProcess)) {
00924 
00925             <span class="comment">//</span>
00926             <span class="comment">// The other 4k pages in the native page still hold the page lock.</span>
00927             <span class="comment">// Should skip unlocking.</span>
00928 
00929             Va = (PVOID)((PCHAR)Va + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
00930             <span class="keywordflow">continue</span>;
00931         }
00932     }
00933 
00934 <span class="preprocessor">#endif</span>
00935 <span class="preprocessor"></span>        <span class="comment">//</span>
00936         <span class="comment">// Don't unlock physically mapped views.</span>
00937         <span class="comment">//</span>
00938 
00939         <span class="keywordflow">if</span> (Va &gt; LastVa) {
00940             Vad = <a class="code" href="../../d6/d3/vadtree_8c.html#a2">MiLocateAddress</a> (Va);
00941             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Vad != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00942 
00943             <span class="keywordflow">if</span> ((Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.PhysicalMapping == 1) ||
00944                 (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.UserPhysicalPages == 1)) {
00945                 Va = <a class="code" href="../../d4/d8/mi_8h.html#a108">MI_VPN_TO_VA</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a>);
00946                 <span class="keywordflow">break</span>;
00947             }
00948             LastVa = <a class="code" href="../../d4/d8/mi_8h.html#a108">MI_VPN_TO_VA</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a>);
00949         }
00950 
00951         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (Va);
00952         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
00953         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
00954         Entry = <a class="code" href="../../d7/d0/wstree_8c.html#a7">MiLocateWsle</a> (Va, <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>, Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex);
00955 
00956         <span class="keywordflow">if</span> (MapType &amp; MAP_PROCESS) {
00957             <a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>[Entry].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.LockedInWs = 0;
00958         }
00959 
00960         <span class="keywordflow">if</span> (MapType &amp; MAP_SYSTEM) {
00961             <a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>[Entry].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.LockedInMemory = 0;
00962         }
00963 
00964         <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>[Entry].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.LockedInMemory == 0) &amp;&amp;
00965              <a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>[Entry].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.LockedInWs == 0) {
00966 
00967             <span class="comment">//</span>
00968             <span class="comment">// The page is no longer should be locked, move</span>
00969             <span class="comment">// it to the dynamic part of the working set.</span>
00970             <span class="comment">//</span>
00971 
00972             <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a> -= 1;
00973 
00974             <span class="keywordflow">if</span> (Entry != <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>) {
00975 
00976                 <span class="comment">//</span>
00977                 <span class="comment">// Swap this element with the last locked page, making</span>
00978                 <span class="comment">// this element the new first dynamic entry.</span>
00979                 <span class="comment">//</span>
00980 
00981                 <a class="code" href="../../d7/d0/wstree_8c.html#a9">MiSwapWslEntries</a> (Entry,
00982                                   <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>,
00983                                   &amp;TargetProcess-&gt;Vm);
00984             }
00985         }
00986 
00987         Va = (PVOID)((PCHAR)Va + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
00988     }
00989 
00990     <a class="code" href="../../d4/d8/mi_8h.html#a162">UNLOCK_WS_AND_ADDRESS_SPACE</a> (TargetProcess);
00991     <span class="keywordflow">if</span> (Attached == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00992         <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00993     }
00994     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (TargetProcess);
00995 
00996     <span class="comment">//</span>
00997     <span class="comment">// Update return arguments.</span>
00998     <span class="comment">//</span>
00999 
01000     <span class="comment">//</span>
01001     <span class="comment">// Establish an exception handler and write the size and base</span>
01002     <span class="comment">// address.</span>
01003     <span class="comment">//</span>
01004 
01005     <span class="keywordflow">try</span> {
01006 
01007 <span class="preprocessor">#if defined(_MIALT4K_)</span>
01008 <span class="preprocessor"></span>
01009         <span class="keywordflow">if</span> (IsWow64Process) { 
01010 
01011             *RegionSize = ((PCHAR)EndingAddress -
01012                         (PCHAR)<a class="code" href="../../d2/d9/miia64_8h.html#a230">PAGE_4K_ALIGN</a>(CapturedBase)) + <a class="code" href="../../d2/d9/miia64_8h.html#a227">PAGE_4K</a>;
01013 
01014             *BaseAddress = <a class="code" href="../../d2/d9/miia64_8h.html#a230">PAGE_4K_ALIGN</a>(CapturedBase);
01015 
01016 
01017         } <span class="keywordflow">else</span> {    
01018 
01019 <span class="preprocessor">#endif</span>
01020 <span class="preprocessor"></span>        *RegionSize = ((PCHAR)EndingAddress -
01021                         (PCHAR)<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(CapturedBase)) + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
01022 
01023         *BaseAddress = <a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(CapturedBase);
01024 
01025 <span class="preprocessor">#if defined(_MIALT4K_)</span>
01026 <span class="preprocessor"></span>        }
01027 <span class="preprocessor">#endif</span>
01028 <span class="preprocessor"></span>
01029     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
01030         <span class="keywordflow">return</span> GetExceptionCode();
01031     }
01032 
01033     <span class="keywordflow">return</span> STATUS_SUCCESS;
01034 
01035 ErrorReturn:
01036 
01037         <a class="code" href="../../d4/d8/mi_8h.html#a162">UNLOCK_WS_AND_ADDRESS_SPACE</a> (TargetProcess);
01038         <span class="keywordflow">if</span> (Attached == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01039             <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
01040         }
01041         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (TargetProcess);
01042         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01043 }
01044 
01045 
01046 <span class="comment">//</span>
01047 <span class="comment">// Nonpagable routines.</span>
01048 <span class="comment">//</span>
01049 
01050 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01051"></a><a class="code" href="../../d3/d5/lockvm_8c.html#a2">01051</a> <a class="code" href="../../d4/d8/mi_8h.html#a775">MiInsertConflictInList</a> (
01052     <a class="code" href="../../d7/d2/struct__MMLOCK__CONFLICT.html">PMMLOCK_CONFLICT</a> Conflict
01053     )
01054 
01055 {
01056     KIRQL OldIrql;
01057     Conflict-&gt;<a class="code" href="../../d7/d2/struct__MMLOCK__CONFLICT.html#o1">Thread</a> = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
01058     ExAcquireSpinLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a690">MmChargeCommitmentLock</a>, &amp;OldIrql);
01059     InsertHeadList ( &amp;<a class="code" href="../../d4/d8/mi_8h.html#a433">MmLockConflictList</a>,
01060                      &amp;Conflict-&gt;<a class="code" href="../../d7/d2/struct__MMLOCK__CONFLICT.html#o0">List</a>);
01061     ExReleaseSpinLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a690">MmChargeCommitmentLock</a>, OldIrql);
01062     <span class="keywordflow">return</span>;
01063 }
01064 
01065 
01066 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01067"></a><a class="code" href="../../d3/d5/lockvm_8c.html#a3">01067</a> <a class="code" href="../../d4/d8/mi_8h.html#a774">MiRemoveConflictFromList</a> (
01068     <a class="code" href="../../d7/d2/struct__MMLOCK__CONFLICT.html">PMMLOCK_CONFLICT</a> Conflict
01069     )
01070 {
01071     KIRQL OldIrql;
01072 
01073     ExAcquireSpinLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a690">MmChargeCommitmentLock</a>, &amp;OldIrql);
01074     RemoveEntryList (&amp;Conflict-&gt;<a class="code" href="../../d7/d2/struct__MMLOCK__CONFLICT.html#o0">List</a>);
01075     ExReleaseSpinLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a690">MmChargeCommitmentLock</a>, OldIrql);
01076     <span class="keywordflow">return</span>;
01077 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:39 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
