<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: procobj.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>procobj.c</h1><a href="../../d3/d5/procobj_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    procobj.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements the machine independent functions to manipulate</span>
00012 <span class="comment">    the kernel process object. Functions are provided to initialize, attach,</span>
00013 <span class="comment">    detach, exclude, include, and set the base priority of process objects.</span>
00014 <span class="comment"></span>
00015 <span class="comment">Author:</span>
00016 <span class="comment"></span>
00017 <span class="comment">    David N. Cutler (davec) 7-Mar-1989</span>
00018 <span class="comment"></span>
00019 <span class="comment">Environment:</span>
00020 <span class="comment"></span>
00021 <span class="comment">    Kernel mode only.</span>
00022 <span class="comment"></span>
00023 <span class="comment">Revision History:</span>
00024 <span class="comment"></span>
00025 <span class="comment">--*/</span>
00026 
00027 <span class="preprocessor">#include "<a class="code" href="../../d0/d0/ki_8h.html">ki.h</a>"</span>
00028 
00029 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00030 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, KeInitializeProcess)</span>
00031 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00032 <span class="preprocessor"></span>
00033 
00034 <span class="comment">//</span>
00035 <span class="comment">// Define forward referenced function prototypes.</span>
00036 <span class="comment">//</span>
00037 
00038 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00039 <a class="code" href="../../d3/d5/procobj_8c.html#a13">KiAttachProcess</a> (
00040     IN <a class="code" href="../../d1/d8/struct__KTHREAD.html">PRKTHREAD</a> Thread,
00041     IN <a class="code" href="../../d5/d7/struct__KPROCESS.html">PRKPROCESS</a> Process,
00042     IN KIRQL OldIrql,
00043     OUT <a class="code" href="../../d3/d5/struct__KAPC__STATE.html">PRKAPC_STATE</a> SavedApcState
00044     );
00045 
00046 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00047 <a class="code" href="../../d3/d5/procobj_8c.html#a2">KiMoveApcState</a> (
00048     IN <a class="code" href="../../d3/d5/struct__KAPC__STATE.html">PKAPC_STATE</a> Source,
00049     OUT <a class="code" href="../../d3/d5/struct__KAPC__STATE.html">PKAPC_STATE</a> Destination
00050     );
00051 
00052 <span class="comment">//</span>
00053 <span class="comment">// The following assert macro is used to check that an input process is</span>
00054 <span class="comment">// really a kprocess and not something else, like deallocated pool.</span>
00055 <span class="comment">//</span>
00056 
<a name="l00057"></a><a class="code" href="../../d3/d5/procobj_8c.html#a0">00057</a> <span class="preprocessor">#define ASSERT_PROCESS(E) {             \</span>
00058 <span class="preprocessor">    ASSERT((E)-&gt;Header.Type == ProcessObject); \</span>
00059 <span class="preprocessor">}</span>
00060 <span class="preprocessor"></span>
00061 
00062 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00063"></a><a class="code" href="../../d3/d5/procobj_8c.html#a3">00063</a> <a class="code" href="../../d3/d5/procobj_8c.html#a3">KeInitializeProcess</a> (
00064     IN <a class="code" href="../../d5/d7/struct__KPROCESS.html">PRKPROCESS</a> Process,
00065     IN KPRIORITY BasePriority,
00066     IN KAFFINITY Affinity,
00067     IN ULONG_PTR DirectoryTableBase[2],
00068     IN BOOLEAN Enable
00069     )
00070 
00071 <span class="comment">/*++</span>
00072 <span class="comment"></span>
00073 <span class="comment">Routine Description:</span>
00074 <span class="comment"></span>
00075 <span class="comment">    This function initializes a kernel process object. The base priority,</span>
00076 <span class="comment">    affinity, and page frame numbers for the process page table directory</span>
00077 <span class="comment">    and hyper space are stored in the process object.</span>
00078 <span class="comment"></span>
00079 <span class="comment">    N.B. It is assumed that the process object is zeroed.</span>
00080 <span class="comment"></span>
00081 <span class="comment">Arguments:</span>
00082 <span class="comment"></span>
00083 <span class="comment">    Process - Supplies a pointer to a dispatcher object of type process.</span>
00084 <span class="comment"></span>
00085 <span class="comment">    BasePriority - Supplies the base priority of the process.</span>
00086 <span class="comment"></span>
00087 <span class="comment">    Affinity - Supplies the set of processors on which children threads</span>
00088 <span class="comment">        of the process can execute.</span>
00089 <span class="comment"></span>
00090 <span class="comment">    DirectoryTableBase - Supplies a pointer to an array whose fist element</span>
00091 <span class="comment">        is the value that is to be loaded into the Directory Table Base</span>
00092 <span class="comment">        register when a child thread is dispatched for execution and whose</span>
00093 <span class="comment">        second element contains the page table entry that maps hyper space.</span>
00094 <span class="comment"></span>
00095 <span class="comment">    Enable - Supplies a boolean value that determines the default</span>
00096 <span class="comment">        handling of data alignment exceptions for child threads. A value</span>
00097 <span class="comment">        of TRUE causes all data alignment exceptions to be automatically</span>
00098 <span class="comment">        handled by the kernel. A value of FALSE causes all data alignment</span>
00099 <span class="comment">        exceptions to be actually raised as exceptions.</span>
00100 <span class="comment"></span>
00101 <span class="comment">Return Value:</span>
00102 <span class="comment"></span>
00103 <span class="comment">    None.</span>
00104 <span class="comment"></span>
00105 <span class="comment">--*/</span>
00106 
00107 {
00108 
00109     <span class="comment">//</span>
00110     <span class="comment">// Initialize the standard dispatcher object header and set the initial</span>
00111     <span class="comment">// signal state of the process object.</span>
00112     <span class="comment">//</span>
00113 
00114     Process-&gt;Header.Type = <a class="code" href="../../d4/d9/ke_8h.html#a402a160">ProcessObject</a>;
00115     Process-&gt;Header.Size = <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d7/struct__KPROCESS.html">KPROCESS</a>) / <span class="keyword">sizeof</span>(LONG);
00116     InitializeListHead(&amp;Process-&gt;Header.WaitListHead);
00117 
00118     <span class="comment">//</span>
00119     <span class="comment">// Initialize the base priority, affinity, directory table base values,</span>
00120     <span class="comment">// autoalignment, and stack count.</span>
00121     <span class="comment">//</span>
00122     <span class="comment">// N.B. The distinguished value MAXSHORT is used to signify that no</span>
00123     <span class="comment">//      threads have been created for the process.</span>
00124     <span class="comment">//</span>
00125 
00126     Process-&gt;BasePriority = (SCHAR)BasePriority;
00127     Process-&gt;Affinity = Affinity;
00128     Process-&gt;AutoAlignment = Enable;
00129     Process-&gt;DirectoryTableBase[0] = DirectoryTableBase[0];
00130     Process-&gt;DirectoryTableBase[1] = DirectoryTableBase[1];
00131     Process-&gt;StackCount = MAXSHORT;
00132 
00133     <span class="comment">//</span>
00134     <span class="comment">// Initialize the stack count, profile listhead, ready queue list head,</span>
00135     <span class="comment">// accumulated runtime, process quantum, thread quantum, and thread list</span>
00136     <span class="comment">// head.</span>
00137     <span class="comment">//</span>
00138 
00139     InitializeListHead(&amp;Process-&gt;ProfileListHead);
00140     InitializeListHead(&amp;Process-&gt;ReadyListHead);
00141     InitializeListHead(&amp;Process-&gt;ThreadListHead);
00142     Process-&gt;ThreadQuantum = <a class="code" href="../../d4/d9/ke_8h.html#a3">THREAD_QUANTUM</a>;
00143 
00144     <span class="comment">//</span>
00145     <span class="comment">// Initialize the process state and set the thread processor selection</span>
00146     <span class="comment">// seed.</span>
00147     <span class="comment">//</span>
00148 
00149     Process-&gt;State = <a class="code" href="../../d4/d9/ke_8h.html#a405a186">ProcessInMemory</a>;
00150     Process-&gt;ThreadSeed = (UCHAR)KiQueryLowTickCount();
00151 
00152     <span class="comment">//</span>
00153     <span class="comment">// Initialize IopmBase and Iopl flag for this process (i386 only)</span>
00154     <span class="comment">//</span>
00155 
00156 <span class="preprocessor">#ifdef i386</span>
00157 <span class="preprocessor"></span>
00158     Process-&gt;IopmOffset = KiComputeIopmOffset(IO_ACCESS_MAP_NONE);
00159 
00160 <span class="preprocessor">#endif</span>
00161 <span class="preprocessor"></span>
00162     <span class="keywordflow">return</span>;
00163 }
00164 
00165 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00166"></a><a class="code" href="../../d3/d5/procobj_8c.html#a4">00166</a> <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a> (
00167     IN <a class="code" href="../../d5/d7/struct__KPROCESS.html">PRKPROCESS</a> Process
00168     )
00169 
00170 <span class="comment">/*++</span>
00171 <span class="comment"></span>
00172 <span class="comment">Routine Description:</span>
00173 <span class="comment"></span>
00174 <span class="comment">    This function attaches a thread to a target process' address space</span>
00175 <span class="comment">    if, and only if, there is not already a process attached.</span>
00176 <span class="comment"></span>
00177 <span class="comment">Arguments:</span>
00178 <span class="comment"></span>
00179 <span class="comment">    Process - Supplies a pointer to a dispatcher object of type process.</span>
00180 <span class="comment"></span>
00181 <span class="comment">Return Value:</span>
00182 <span class="comment"></span>
00183 <span class="comment">    None.</span>
00184 <span class="comment"></span>
00185 <span class="comment">--*/</span>
00186 
00187 {
00188 
00189     KIRQL OldIrql;
00190     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PRKTHREAD</a> Thread;
00191 
00192     <a class="code" href="../../d4/d1/alpha_2thredini_8c.html#a0">ASSERT_PROCESS</a>(Process);
00193     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
00194 
00195     <span class="comment">//</span>
00196     <span class="comment">// Raise IRQL to dispatcher level and lock dispatcher database.</span>
00197     <span class="comment">//</span>
00198 
00199     Thread = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
00200     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00201 
00202     <span class="comment">//</span>
00203     <span class="comment">// If the target process is the current process, then return immediately.</span>
00204     <span class="comment">// Otherwise, check whether there is a process address space attached or</span>
00205     <span class="comment">// the thread is executing a DPC. If either condition is true, then call</span>
00206     <span class="comment">// bug check. Otherwise, attach the target process.</span>
00207     <span class="comment">//</span>
00208 
00209     <span class="keywordflow">if</span> (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o1">Process</a> == Process) {
00210         <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00211 
00212     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o58">ApcStateIndex</a> != 0) ||
00213                (KeIsExecutingDpc() != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
00214         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(INVALID_PROCESS_ATTACH_ATTEMPT,
00215                      (ULONG_PTR)Process,
00216                      (ULONG_PTR)Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o1">Process</a>,
00217                      (ULONG)Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o58">ApcStateIndex</a>,
00218                      (ULONG)KeIsExecutingDpc());
00219 
00220     } <span class="keywordflow">else</span> {
00221         <a class="code" href="../../d3/d5/procobj_8c.html#a13">KiAttachProcess</a>(Thread, Process, OldIrql, &amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o56">SavedApcState</a>);
00222     }
00223 
00224     <span class="keywordflow">return</span>;
00225 }
00226 
00227 LOGICAL
<a name="l00228"></a><a class="code" href="../../d3/d5/procobj_8c.html#a5">00228</a> <a class="code" href="../../d3/d5/procobj_8c.html#a5">KeForceAttachProcess</a> (
00229     IN <a class="code" href="../../d5/d7/struct__KPROCESS.html">PRKPROCESS</a> Process
00230     )
00231 
00232 <span class="comment">/*++</span>
00233 <span class="comment"></span>
00234 <span class="comment">Routine Description:</span>
00235 <span class="comment"></span>
00236 <span class="comment">    This function forces an attach of a thread to a target process' address</span>
00237 <span class="comment">    space if the process is not current being swapped into or out of memory.</span>
00238 <span class="comment"></span>
00239 <span class="comment">    N.B. This function is for use by memory management ONLY.</span>
00240 <span class="comment"></span>
00241 <span class="comment">Arguments:</span>
00242 <span class="comment"></span>
00243 <span class="comment">    Process - Supplies a pointer to a dispatcher object of type process.</span>
00244 <span class="comment"></span>
00245 <span class="comment">Return Value:</span>
00246 <span class="comment"></span>
00247 <span class="comment">    None.</span>
00248 <span class="comment"></span>
00249 <span class="comment">--*/</span>
00250 
00251 {
00252 
00253     KIRQL OldIrql;
00254     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PRKTHREAD</a> Thread;
00255 
00256     <a class="code" href="../../d4/d1/alpha_2thredini_8c.html#a0">ASSERT_PROCESS</a>(Process);
00257     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
00258 
00259     <span class="comment">//</span>
00260     <span class="comment">// Raise IRQL to dispatcher level and lock dispatcher database.</span>
00261     <span class="comment">//</span>
00262 
00263     Thread = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
00264     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00265 
00266     <span class="comment">//</span>
00267     <span class="comment">// Check whether there is already a process address space attached or</span>
00268     <span class="comment">// the thread is executing a DPC. If either condition is true, then call</span>
00269     <span class="comment">// bug check.</span>
00270     <span class="comment">//</span>
00271 
00272     <span class="keywordflow">if</span> ((Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o58">ApcStateIndex</a> != 0) ||
00273         (KeIsExecutingDpc() != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
00274         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(INVALID_PROCESS_ATTACH_ATTEMPT,
00275                      (ULONG_PTR)Process,
00276                      (ULONG_PTR)Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o1">Process</a>,
00277                      (ULONG)Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o58">ApcStateIndex</a>,
00278                      (ULONG)KeIsExecutingDpc());
00279     }
00280 
00281     <span class="comment">//</span>
00282     <span class="comment">// If the target process is not the current process, then attach the target</span>
00283     <span class="comment">// process if the process is not currently being swapped in or out of memory.</span>
00284     <span class="comment">//</span>
00285 
00286     <span class="keywordflow">if</span> (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o1">Process</a> == Process) {
00287         <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00288 
00289     } <span class="keywordflow">else</span> {
00290 
00291         <span class="comment">//</span>
00292         <span class="comment">// If the target process is currently being swapped into or out of memory,</span>
00293         <span class="comment">// then return a value of FALSE. Otherwise, force the process to be inswapped.</span>
00294         <span class="comment">//</span>
00295 
00296         <span class="keywordflow">if</span> ((Process-&gt;State == <a class="code" href="../../d4/d9/ke_8h.html#a405a189">ProcessInSwap</a>) || Process-&gt;State == <a class="code" href="../../d4/d9/ke_8h.html#a405a190">ProcessOutSwap</a>) {
00297             <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00298             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00299 
00300         } <span class="keywordflow">else</span> {
00301 
00302             <span class="comment">//</span>
00303             <span class="comment">// If the target process is in transition, then remove it from its</span>
00304             <span class="comment">// transition list.</span>
00305             <span class="comment">//</span>
00306 
00307             <span class="keywordflow">if</span> (Process-&gt;State == <a class="code" href="../../d4/d9/ke_8h.html#a405a188">ProcessInTransition</a>) {
00308                 RemoveEntryList(&amp;Process-&gt;SwapListEntry);
00309             }
00310 
00311             <span class="comment">//</span>
00312             <span class="comment">// Force the process state to in memory and attach the target process.</span>
00313             <span class="comment">//</span>
00314 
00315             Process-&gt;State = <a class="code" href="../../d4/d9/ke_8h.html#a405a186">ProcessInMemory</a>;
00316             <a class="code" href="../../d3/d5/procobj_8c.html#a13">KiAttachProcess</a>(Thread, Process, OldIrql, &amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o56">SavedApcState</a>);
00317         }
00318     }
00319 
00320     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00321 }
00322 
00323 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00324"></a><a class="code" href="../../d3/d5/procobj_8c.html#a6">00324</a> <a class="code" href="../../d3/d5/procobj_8c.html#a6">KeStackAttachProcess</a> (
00325     IN <a class="code" href="../../d5/d7/struct__KPROCESS.html">PRKPROCESS</a> Process,
00326     OUT <a class="code" href="../../d3/d5/struct__KAPC__STATE.html">PRKAPC_STATE</a> ApcState
00327     )
00328 
00329 <span class="comment">/*++</span>
00330 <span class="comment"></span>
00331 <span class="comment">Routine Description:</span>
00332 <span class="comment"></span>
00333 <span class="comment">    This function attaches a thread to a target process' address space</span>
00334 <span class="comment">    and returns information about a previous attached process.</span>
00335 <span class="comment"></span>
00336 <span class="comment">Arguments:</span>
00337 <span class="comment"></span>
00338 <span class="comment">    Process - Supplies a pointer to a dispatcher object of type process.</span>
00339 <span class="comment"></span>
00340 <span class="comment">Return Value:</span>
00341 <span class="comment"></span>
00342 <span class="comment">    None.</span>
00343 <span class="comment"></span>
00344 <span class="comment">--*/</span>
00345 
00346 {
00347 
00348     KIRQL OldIrql;
00349     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PRKTHREAD</a> Thread;
00350 
00351     <a class="code" href="../../d4/d1/alpha_2thredini_8c.html#a0">ASSERT_PROCESS</a>(Process);
00352     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
00353 
00354     <span class="comment">//</span>
00355     <span class="comment">// Raise IRQL to dispatcher level and lock dispatcher database.</span>
00356     <span class="comment">//</span>
00357 
00358     Thread = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
00359     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00360 
00361     <span class="comment">//</span>
00362     <span class="comment">// If the current thread is executing a DPC, then bug check.</span>
00363     <span class="comment">//</span>
00364 
00365     <span class="keywordflow">if</span> (KeIsExecutingDpc() != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00366         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(INVALID_PROCESS_ATTACH_ATTEMPT,
00367                      (ULONG_PTR)Process,
00368                      (ULONG_PTR)Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o1">Process</a>,
00369                      (ULONG)Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o58">ApcStateIndex</a>,
00370                      (ULONG)KeIsExecutingDpc());
00371     }
00372 
00373     <span class="comment">//</span>
00374     <span class="comment">// If the target process is not the current process, then attach the target</span>
00375     <span class="comment">// process. Otherwise, return a distinguished process value to indicate that</span>
00376     <span class="comment">// an attach was not performed.</span>
00377     <span class="comment">//</span>
00378 
00379     <span class="keywordflow">if</span> (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o1">Process</a> == Process) {
00380         <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00381         ApcState-&gt;Process = (<a class="code" href="../../d5/d7/struct__KPROCESS.html">PRKPROCESS</a>)1;
00382 
00383     } <span class="keywordflow">else</span> {
00384 
00385         <span class="comment">//</span>
00386         <span class="comment">// If the current thread is attached to a process, then save the current</span>
00387         <span class="comment">// APC state in the callers APC state structure. Otherwise, save the</span>
00388         <span class="comment">// current APC state in the saved APC state structure, and return a NULL</span>
00389         <span class="comment">// process pointer.</span>
00390         <span class="comment">//</span>
00391 
00392         <span class="keywordflow">if</span> (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o58">ApcStateIndex</a> != 0) {
00393             <a class="code" href="../../d3/d5/procobj_8c.html#a13">KiAttachProcess</a>(Thread, Process, OldIrql, ApcState);
00394 
00395         } <span class="keywordflow">else</span> {
00396             <a class="code" href="../../d3/d5/procobj_8c.html#a13">KiAttachProcess</a>(Thread, Process, OldIrql, &amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o56">SavedApcState</a>);
00397             ApcState-&gt;Process = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00398         }
00399     }
00400 
00401     <span class="keywordflow">return</span>;
00402 }
00403 
00404 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00405"></a><a class="code" href="../../d3/d5/procobj_8c.html#a7">00405</a> <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a> (
00406     VOID
00407     )
00408 
00409 <span class="comment">/*++</span>
00410 <span class="comment"></span>
00411 <span class="comment">Routine Description:</span>
00412 <span class="comment"></span>
00413 <span class="comment">    This function detaches a thread from another process' address space.</span>
00414 <span class="comment"></span>
00415 <span class="comment">Arguments:</span>
00416 <span class="comment"></span>
00417 <span class="comment">    None.</span>
00418 <span class="comment"></span>
00419 <span class="comment">Return Value:</span>
00420 <span class="comment"></span>
00421 <span class="comment">    None.</span>
00422 <span class="comment"></span>
00423 <span class="comment">--*/</span>
00424 
00425 {
00426 
00427     KIRQL OldIrql;
00428     <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process;
00429     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread;
00430 
00431     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
00432 
00433     <span class="comment">//</span>
00434     <span class="comment">// Raise IRQL to dispatcher level and lock dispatcher database.</span>
00435     <span class="comment">//</span>
00436 
00437     Thread = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
00438     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00439 
00440     <span class="comment">//</span>
00441     <span class="comment">// If the current thread is attached to another process, then detach</span>
00442     <span class="comment">// it.</span>
00443     <span class="comment">//</span>
00444 
00445     <span class="keywordflow">if</span> (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o58">ApcStateIndex</a> != 0) {
00446 
00447         <span class="comment">//</span>
00448         <span class="comment">// Check if a kernel APC is in progress, the kernel APC queue is</span>
00449         <span class="comment">// not empty, or the user APC queue is not empty. If any of these</span>
00450         <span class="comment">// conditions are true, then call bug check.</span>
00451         <span class="comment">//</span>
00452 
00453 <span class="preprocessor">#if DBG</span>
00454 <span class="preprocessor"></span>
00455         <span class="keywordflow">if</span> ((Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o2">KernelApcInProgress</a>) ||
00456             (IsListEmpty(&amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o0">ApcListHead</a>[<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>]) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) ||
00457             (IsListEmpty(&amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o0">ApcListHead</a>[<a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>]) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
00458             <a class="code" href="../../d9/d1/bugcheck_8c.html#a13">KeBugCheck</a>(INVALID_PROCESS_DETACH_ATTEMPT);
00459         }
00460 
00461 <span class="preprocessor">#endif</span>
00462 <span class="preprocessor"></span>
00463         <span class="comment">//</span>
00464         <span class="comment">// Unbias current process stack count and check if the process should</span>
00465         <span class="comment">// be swapped out of memory.</span>
00466         <span class="comment">//</span>
00467 
00468         Process = Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o1">Process</a>;
00469         Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o11">StackCount</a> -= 1;
00470         <span class="keywordflow">if</span> ((Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o11">StackCount</a> == 0) &amp;&amp;
00471             (IsListEmpty(&amp;Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o8">ThreadListHead</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
00472             Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o15">State</a> = <a class="code" href="../../d4/d9/ke_8h.html#a405a188">ProcessInTransition</a>;
00473             InsertTailList(&amp;<a class="code" href="../../d5/d9/kernldat_8c.html#a49">KiProcessOutSwapListHead</a>, &amp;Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o7">SwapListEntry</a>);
00474             <a class="code" href="../../d5/d9/kernldat_8c.html#a47">KiSwapEvent</a>.<a class="code" href="../../d2/d6/struct__KEVENT.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o4">SignalState</a> = 1;
00475             <span class="keywordflow">if</span> (IsListEmpty(&amp;<a class="code" href="../../d5/d9/kernldat_8c.html#a47">KiSwapEvent</a>.<a class="code" href="../../d2/d6/struct__KEVENT.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o5">WaitListHead</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00476                 <a class="code" href="../../d2/d7/waitsup_8c.html#a3">KiWaitTest</a>(&amp;<a class="code" href="../../d5/d9/kernldat_8c.html#a47">KiSwapEvent</a>, <a class="code" href="../../d0/d0/ki_8h.html#a1">BALANCE_INCREMENT</a>);
00477             }
00478         }
00479 
00480         <span class="comment">//</span>
00481         <span class="comment">// Restore APC state and check whether the kernel APC queue contains</span>
00482         <span class="comment">// an entry. If the kernel APC queue contains an entry then set kernel</span>
00483         <span class="comment">// APC pending and request a software interrupt at APC_LEVEL.</span>
00484         <span class="comment">//</span>
00485 
00486         <a class="code" href="../../d3/d5/procobj_8c.html#a2">KiMoveApcState</a>(&amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o56">SavedApcState</a>, &amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>);
00487         Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o56">SavedApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o1">Process</a> = (<a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00488         Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o49">ApcStatePointer</a>[0] = &amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>;
00489         Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o49">ApcStatePointer</a>[1] = &amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o56">SavedApcState</a>;
00490         Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o58">ApcStateIndex</a> = 0;
00491         <span class="keywordflow">if</span> (IsListEmpty(&amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o0">ApcListHead</a>[<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>]) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00492             Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o3">KernelApcPending</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00493             <a class="code" href="../../d9/d4/intsupc_8c.html#a3">KiRequestSoftwareInterrupt</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>);
00494         }
00495 
00496         <span class="comment">//</span>
00497         <span class="comment">// Swap the address space back to the parent process.</span>
00498         <span class="comment">//</span>
00499 
00500         <a class="code" href="../../d0/d0/ki_8h.html#a137">KiSwapProcess</a>(Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o1">Process</a>, Process);
00501     }
00502 
00503     <span class="comment">//</span>
00504     <span class="comment">// Lower IRQL to its previous value and return.</span>
00505     <span class="comment">//</span>
00506 
00507     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00508     <span class="keywordflow">return</span>;
00509 }
00510 
00511 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00512"></a><a class="code" href="../../d3/d5/procobj_8c.html#a8">00512</a> <a class="code" href="../../d3/d5/procobj_8c.html#a8">KeUnstackDetachProcess</a> (
00513     IN <a class="code" href="../../d3/d5/struct__KAPC__STATE.html">PRKAPC_STATE</a> ApcState
00514     )
00515 
00516 <span class="comment">/*++</span>
00517 <span class="comment"></span>
00518 <span class="comment">Routine Description:</span>
00519 <span class="comment"></span>
00520 <span class="comment">    This function detaches a thread from another process' address space</span>
00521 <span class="comment">    and restores previous attach state.</span>
00522 <span class="comment"></span>
00523 <span class="comment">Arguments:</span>
00524 <span class="comment"></span>
00525 <span class="comment">    ApcState - Supplies a pointer to an APC state structure that was returned</span>
00526 <span class="comment">        from a previous call to stack attach process.</span>
00527 <span class="comment"></span>
00528 <span class="comment">Return Value:</span>
00529 <span class="comment"></span>
00530 <span class="comment">    None.</span>
00531 <span class="comment"></span>
00532 <span class="comment">--*/</span>
00533 
00534 {
00535 
00536     KIRQL OldIrql;
00537     <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process;
00538     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread;
00539 
00540     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
00541 
00542     <span class="comment">//</span>
00543     <span class="comment">// Raise IRQL to dispatcher level and lock dispatcher database.</span>
00544     <span class="comment">//</span>
00545 
00546     Thread = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
00547     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00548 
00549     <span class="comment">//</span>
00550     <span class="comment">// If the APC state has a distinguished process pointer value, then no</span>
00551     <span class="comment">// attach was performed on the paired call to stack attach process.</span>
00552     <span class="comment">//</span>
00553 
00554     <span class="keywordflow">if</span> (ApcState-&gt;Process != (<a class="code" href="../../d5/d7/struct__KPROCESS.html">PRKPROCESS</a>)1) {
00555 
00556         <span class="comment">//</span>
00557         <span class="comment">// If the current thread is not attached to another process, a kernel</span>
00558         <span class="comment">// APC is in progress, or either the kernel or user mode APC queues</span>
00559         <span class="comment">// are not empty, then call bug check.</span>
00560         <span class="comment">//</span>
00561 
00562         <span class="keywordflow">if</span> ((Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o58">ApcStateIndex</a> == 0) ||
00563              (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o2">KernelApcInProgress</a>) ||
00564              (IsListEmpty(&amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o0">ApcListHead</a>[<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>]) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) ||
00565              (IsListEmpty(&amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o0">ApcListHead</a>[<a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>]) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
00566             <a class="code" href="../../d9/d1/bugcheck_8c.html#a13">KeBugCheck</a>(INVALID_PROCESS_DETACH_ATTEMPT);
00567         }
00568 
00569         <span class="comment">//</span>
00570         <span class="comment">// Unbias current process stack count and check if the process should</span>
00571         <span class="comment">// be swapped out of memory.</span>
00572         <span class="comment">//</span>
00573 
00574         Process = Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o1">Process</a>;
00575         Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o11">StackCount</a> -= 1;
00576         <span class="keywordflow">if</span> ((Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o11">StackCount</a> == 0) &amp;&amp;
00577             (IsListEmpty(&amp;Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o8">ThreadListHead</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
00578             Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o15">State</a> = <a class="code" href="../../d4/d9/ke_8h.html#a405a188">ProcessInTransition</a>;
00579             InsertTailList(&amp;<a class="code" href="../../d5/d9/kernldat_8c.html#a49">KiProcessOutSwapListHead</a>, &amp;Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o7">SwapListEntry</a>);
00580             <a class="code" href="../../d5/d9/kernldat_8c.html#a47">KiSwapEvent</a>.<a class="code" href="../../d2/d6/struct__KEVENT.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o4">SignalState</a> = 1;
00581             <span class="keywordflow">if</span> (IsListEmpty(&amp;<a class="code" href="../../d5/d9/kernldat_8c.html#a47">KiSwapEvent</a>.<a class="code" href="../../d2/d6/struct__KEVENT.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o5">WaitListHead</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00582                 <a class="code" href="../../d2/d7/waitsup_8c.html#a3">KiWaitTest</a>(&amp;<a class="code" href="../../d5/d9/kernldat_8c.html#a47">KiSwapEvent</a>, <a class="code" href="../../d0/d0/ki_8h.html#a1">BALANCE_INCREMENT</a>);
00583             }
00584         }
00585 
00586         <span class="comment">//</span>
00587         <span class="comment">// Restore APC state and check whether the kernel APC queue contains</span>
00588         <span class="comment">// an entry. If the kernel APC queue contains an entry then set kernel</span>
00589         <span class="comment">// APC pending and request a software interrupt at APC_LEVEL.</span>
00590         <span class="comment">//</span>
00591 
00592         <span class="keywordflow">if</span> (ApcState-&gt;Process != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00593             <a class="code" href="../../d3/d5/procobj_8c.html#a2">KiMoveApcState</a>(ApcState, &amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>);
00594 
00595         } <span class="keywordflow">else</span> {
00596             <a class="code" href="../../d3/d5/procobj_8c.html#a2">KiMoveApcState</a>(&amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o56">SavedApcState</a>, &amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>);
00597             Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o56">SavedApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o1">Process</a> = (<a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00598             Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o49">ApcStatePointer</a>[0] = &amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>;
00599             Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o49">ApcStatePointer</a>[1] = &amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o56">SavedApcState</a>;
00600             Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o58">ApcStateIndex</a> = 0;
00601         }
00602 
00603         <span class="keywordflow">if</span> (IsListEmpty(&amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o0">ApcListHead</a>[<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>]) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00604             Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o3">KernelApcPending</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00605             <a class="code" href="../../d9/d4/intsupc_8c.html#a3">KiRequestSoftwareInterrupt</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>);
00606         }
00607 
00608         <span class="comment">//</span>
00609         <span class="comment">// Swap the address space back to the parent process.</span>
00610         <span class="comment">//</span>
00611 
00612         <a class="code" href="../../d0/d0/ki_8h.html#a137">KiSwapProcess</a>(Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o1">Process</a>, Process);
00613     }
00614 
00615     <span class="comment">//</span>
00616     <span class="comment">// Lower IRQL to its previous value and return.</span>
00617     <span class="comment">//</span>
00618 
00619     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00620     <span class="keywordflow">return</span>;
00621 }
00622 
00623 LONG
<a name="l00624"></a><a class="code" href="../../d3/d5/procobj_8c.html#a9">00624</a> <a class="code" href="../../d3/d5/procobj_8c.html#a9">KeReadStateProcess</a> (
00625     IN <a class="code" href="../../d5/d7/struct__KPROCESS.html">PRKPROCESS</a> Process
00626     )
00627 
00628 <span class="comment">/*++</span>
00629 <span class="comment"></span>
00630 <span class="comment">Routine Description:</span>
00631 <span class="comment"></span>
00632 <span class="comment">    This function reads the current signal state of a process object.</span>
00633 <span class="comment"></span>
00634 <span class="comment">Arguments:</span>
00635 <span class="comment"></span>
00636 <span class="comment">    Process - Supplies a pointer to a dispatcher object of type process.</span>
00637 <span class="comment"></span>
00638 <span class="comment">Return Value:</span>
00639 <span class="comment"></span>
00640 <span class="comment">    The current signal state of the process object.</span>
00641 <span class="comment"></span>
00642 <span class="comment">--*/</span>
00643 
00644 {
00645 
00646     <a class="code" href="../../d4/d1/alpha_2thredini_8c.html#a0">ASSERT_PROCESS</a>(Process);
00647 
00648     <span class="comment">//</span>
00649     <span class="comment">// Return current signal state of process object.</span>
00650     <span class="comment">//</span>
00651 
00652     <span class="keywordflow">return</span> Process-&gt;Header.SignalState;
00653 }
00654 
00655 LONG
<a name="l00656"></a><a class="code" href="../../d3/d5/procobj_8c.html#a10">00656</a> <a class="code" href="../../d3/d5/procobj_8c.html#a10">KeSetProcess</a> (
00657     IN <a class="code" href="../../d5/d7/struct__KPROCESS.html">PRKPROCESS</a> Process,
00658     IN KPRIORITY Increment,
00659     IN BOOLEAN Wait
00660     )
00661 
00662 <span class="comment">/*++</span>
00663 <span class="comment"></span>
00664 <span class="comment">Routine Description:</span>
00665 <span class="comment"></span>
00666 <span class="comment">    This function sets the signal state of a proces object to Signaled</span>
00667 <span class="comment">    and attempts to satisfy as many Waits as possible. The previous</span>
00668 <span class="comment">    signal state of the process object is returned as the function value.</span>
00669 <span class="comment"></span>
00670 <span class="comment">Arguments:</span>
00671 <span class="comment"></span>
00672 <span class="comment">    Process - Supplies a pointer to a dispatcher object of type process.</span>
00673 <span class="comment"></span>
00674 <span class="comment">    Increment - Supplies the priority increment that is to be applied</span>
00675 <span class="comment">       if setting the process causes a Wait to be satisfied.</span>
00676 <span class="comment"></span>
00677 <span class="comment">    Wait - Supplies a boolean value that signifies whether the call to</span>
00678 <span class="comment">       KeSetProcess will be immediately followed by a call to one of the</span>
00679 <span class="comment">       kernel Wait functions.</span>
00680 <span class="comment"></span>
00681 <span class="comment">Return Value:</span>
00682 <span class="comment"></span>
00683 <span class="comment">    The previous signal state of the process object.</span>
00684 <span class="comment"></span>
00685 <span class="comment">--*/</span>
00686 
00687 {
00688 
00689     KIRQL OldIrql;
00690     LONG OldState;
00691     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PRKTHREAD</a> Thread;
00692 
00693     <a class="code" href="../../d4/d1/alpha_2thredini_8c.html#a0">ASSERT_PROCESS</a>(Process);
00694     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
00695 
00696     <span class="comment">//</span>
00697     <span class="comment">// Raise IRQL to dispatcher level and lock dispatcher database.</span>
00698     <span class="comment">//</span>
00699 
00700     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00701 
00702     <span class="comment">//</span>
00703     <span class="comment">// If the previous state of the process object is Not-Signaled and</span>
00704     <span class="comment">// the wait queue is not empty, then satisfy as many Waits as</span>
00705     <span class="comment">// possible.</span>
00706     <span class="comment">//</span>
00707 
00708     OldState = Process-&gt;Header.SignalState;
00709     Process-&gt;Header.SignalState = 1;
00710     <span class="keywordflow">if</span> ((OldState == 0) &amp;&amp; (!IsListEmpty(&amp;Process-&gt;Header.WaitListHead))) {
00711         <a class="code" href="../../d2/d7/waitsup_8c.html#a3">KiWaitTest</a>(Process, <a class="code" href="../../d6/d4/rtl_2random_8c.html#a1">Increment</a>);
00712     }
00713 
00714     <span class="comment">//</span>
00715     <span class="comment">// If the value of the Wait argument is TRUE, then return to the</span>
00716     <span class="comment">// caller with IRQL raised and the dispatcher database locked. Else</span>
00717     <span class="comment">// release the dispatcher database lock and lower IRQL to its</span>
00718     <span class="comment">// previous value.</span>
00719     <span class="comment">//</span>
00720 
00721     <span class="keywordflow">if</span> (Wait) {
00722         Thread = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
00723         Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o19">WaitNext</a> = Wait;
00724         Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o17">WaitIrql</a> = OldIrql;
00725 
00726     } <span class="keywordflow">else</span> {
00727         <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00728     }
00729 
00730     <span class="comment">//</span>
00731     <span class="comment">// Return previous signal state of process object.</span>
00732     <span class="comment">//</span>
00733 
00734     <span class="keywordflow">return</span> OldState;
00735 }
00736 
00737 KPRIORITY
<a name="l00738"></a><a class="code" href="../../d3/d5/procobj_8c.html#a11">00738</a> <a class="code" href="../../d3/d5/procobj_8c.html#a11">KeSetPriorityProcess</a> (
00739     IN <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process,
00740     IN KPRIORITY NewBase
00741     )
00742 
00743 <span class="comment">/*++</span>
00744 <span class="comment"></span>
00745 <span class="comment">Routine Description:</span>
00746 <span class="comment"></span>
00747 <span class="comment">    This function set the base priority of a process to a new value</span>
00748 <span class="comment">    and adjusts the priority and base priority of all child threads</span>
00749 <span class="comment">    as appropriate.</span>
00750 <span class="comment"></span>
00751 <span class="comment">Arguments:</span>
00752 <span class="comment"></span>
00753 <span class="comment">    Process - Supplies a pointer to a dispatcher object of type process.</span>
00754 <span class="comment"></span>
00755 <span class="comment">    NewBase - Supplies the new base priority of the process.</span>
00756 <span class="comment"></span>
00757 <span class="comment">Return Value:</span>
00758 <span class="comment"></span>
00759 <span class="comment">    The previous base priority of the process.</span>
00760 <span class="comment"></span>
00761 <span class="comment">--*/</span>
00762 
00763 {
00764 
00765     KPRIORITY Adjustment;
00766     PLIST_ENTRY NextEntry;
00767     KPRIORITY NewPriority;
00768     KIRQL OldIrql;
00769     KPRIORITY OldBase;
00770     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread;
00771 
00772     <a class="code" href="../../d4/d1/alpha_2thredini_8c.html#a0">ASSERT_PROCESS</a>(Process);
00773     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
00774 
00775     <span class="comment">//</span>
00776     <span class="comment">// Raise IRQL to dispatcher level and lock dispatcher database.</span>
00777     <span class="comment">//</span>
00778 
00779     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00780 
00781     <span class="comment">//</span>
00782     <span class="comment">// Save the current process base priority, set the new process base</span>
00783     <span class="comment">// priority, compute the adjustment value, and adjust the priority</span>
00784     <span class="comment">// and base priority of all child threads as appropriate.</span>
00785     <span class="comment">//</span>
00786 
00787     OldBase = Process-&gt;BasePriority;
00788     Process-&gt;BasePriority = (SCHAR)NewBase;
00789     Adjustment = NewBase - OldBase;
00790     NextEntry = Process-&gt;ThreadListHead.Flink;
00791     <span class="keywordflow">if</span> (NewBase &gt;= LOW_REALTIME_PRIORITY) {
00792         <span class="keywordflow">while</span> (NextEntry != &amp;Process-&gt;ThreadListHead) {
00793             Thread = CONTAINING_RECORD(NextEntry, <a class="code" href="../../d1/d8/struct__KTHREAD.html">KTHREAD</a>, ThreadListEntry);
00794 
00795             <span class="comment">//</span>
00796             <span class="comment">// Compute the new base priority of the thread.</span>
00797             <span class="comment">//</span>
00798 
00799             NewPriority = Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o24">BasePriority</a> + Adjustment;
00800 
00801             <span class="comment">//</span>
00802             <span class="comment">// If the new base priority is outside the realtime class,</span>
00803             <span class="comment">// then limit the change to the realtime class.</span>
00804             <span class="comment">//</span>
00805 
00806             <span class="keywordflow">if</span> (NewPriority &lt; LOW_REALTIME_PRIORITY) {
00807                 NewPriority = LOW_REALTIME_PRIORITY;
00808 
00809             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NewPriority &gt; HIGH_PRIORITY) {
00810                 NewPriority = HIGH_PRIORITY;
00811             }
00812 
00813             <span class="comment">//</span>
00814             <span class="comment">// Set the base priority and the current priority of the</span>
00815             <span class="comment">// thread to the appropriate value.</span>
00816             <span class="comment">//</span>
00817             <span class="comment">// N.B. If priority saturation occured the last time the thread</span>
00818             <span class="comment">//      base priority was set and the new process base priority</span>
00819             <span class="comment">//      is not crossing from variable to realtime, then it is not</span>
00820             <span class="comment">//      necessary to change the thread priority.</span>
00821             <span class="comment">//</span>
00822 
00823             <span class="keywordflow">if</span> ((Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o12">Saturation</a> == 0) || (OldBase &lt; LOW_REALTIME_PRIORITY)) {
00824                 <span class="keywordflow">if</span> (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o12">Saturation</a> &gt; 0) {
00825                     NewPriority = HIGH_PRIORITY;
00826 
00827                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o12">Saturation</a> &lt; 0) {
00828                     NewPriority = LOW_REALTIME_PRIORITY;
00829                 }
00830 
00831                 Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o24">BasePriority</a> = (SCHAR)NewPriority;
00832                 Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o27">Quantum</a> = Process-&gt;ThreadQuantum;
00833                 Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o25">DecrementCount</a> = 0;
00834                 Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o26">PriorityDecrement</a> = 0;
00835                 <a class="code" href="../../d0/d2/thredsup_8c.html#a5">KiSetPriorityThread</a>(Thread, NewPriority);
00836             }
00837 
00838             NextEntry = NextEntry-&gt;Flink;
00839         }
00840 
00841     } <span class="keywordflow">else</span> {
00842         <span class="keywordflow">while</span> (NextEntry != &amp;Process-&gt;ThreadListHead) {
00843             Thread = CONTAINING_RECORD(NextEntry, <a class="code" href="../../d1/d8/struct__KTHREAD.html">KTHREAD</a>, ThreadListEntry);
00844 
00845             <span class="comment">//</span>
00846             <span class="comment">// Compute the new base priority of the thread.</span>
00847             <span class="comment">//</span>
00848 
00849             NewPriority = Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o24">BasePriority</a> + Adjustment;
00850 
00851             <span class="comment">//</span>
00852             <span class="comment">// If the new base priority is outside the variable class,</span>
00853             <span class="comment">// then limit the change to the variable class.</span>
00854             <span class="comment">//</span>
00855 
00856             <span class="keywordflow">if</span> (NewPriority &gt;= LOW_REALTIME_PRIORITY) {
00857                 NewPriority = LOW_REALTIME_PRIORITY - 1;
00858 
00859             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NewPriority &lt;= LOW_PRIORITY) {
00860                 NewPriority = 1;
00861             }
00862 
00863             <span class="comment">//</span>
00864             <span class="comment">// Set the base priority and the current priority of the</span>
00865             <span class="comment">// thread to the computed value and reset the thread quantum.</span>
00866             <span class="comment">//</span>
00867             <span class="comment">// N.B. If priority saturation occured the last time the thread</span>
00868             <span class="comment">//      base priority was set and the new process base priority</span>
00869             <span class="comment">//      is not crossing from realtime to variable, then it is not</span>
00870             <span class="comment">//      necessary to change the thread priority.</span>
00871             <span class="comment">//</span>
00872 
00873             <span class="keywordflow">if</span> ((Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o12">Saturation</a> == 0) || (OldBase &gt;= LOW_REALTIME_PRIORITY)) {
00874                 <span class="keywordflow">if</span> (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o12">Saturation</a> &gt; 0) {
00875                     NewPriority = LOW_REALTIME_PRIORITY - 1;
00876 
00877                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o12">Saturation</a> &lt; 0) {
00878                     NewPriority = 1;
00879                 }
00880 
00881                 Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o24">BasePriority</a> = (SCHAR)NewPriority;
00882                 Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o27">Quantum</a> = Process-&gt;ThreadQuantum;
00883                 Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o25">DecrementCount</a> = 0;
00884                 Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o26">PriorityDecrement</a> = 0;
00885                 <a class="code" href="../../d0/d2/thredsup_8c.html#a5">KiSetPriorityThread</a>(Thread, NewPriority);
00886             }
00887 
00888             NextEntry = NextEntry-&gt;Flink;
00889         }
00890     }
00891 
00892     <span class="comment">//</span>
00893     <span class="comment">// Unlock dispatcher database and lower IRQL to its previous</span>
00894     <span class="comment">// value.</span>
00895     <span class="comment">//</span>
00896 
00897     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00898 
00899     <span class="comment">//</span>
00900     <span class="comment">// Return previous process base priority</span>
00901     <span class="comment">//</span>
00902 
00903     <span class="keywordflow">return</span> OldBase;
00904 }
00905 
00906 LOGICAL
<a name="l00907"></a><a class="code" href="../../d3/d5/procobj_8c.html#a12">00907</a> <a class="code" href="../../d3/d5/procobj_8c.html#a12">KeSetDisableQuantumProcess</a> (
00908     IN <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process,
00909     IN LOGICAL Disable
00910     )
00911 
00912 <span class="comment">/*++</span>
00913 <span class="comment"></span>
00914 <span class="comment">Routine Description:</span>
00915 <span class="comment"></span>
00916 <span class="comment">    This function disables quantum runout for realtime threads in the</span>
00917 <span class="comment">    specified process.</span>
00918 <span class="comment"></span>
00919 <span class="comment">Arguments:</span>
00920 <span class="comment"></span>
00921 <span class="comment">    Process  - Supplies a pointer to a dispatcher object of type process.</span>
00922 <span class="comment"></span>
00923 <span class="comment">    Disable - Supplies a logical value that determines whether quantum</span>
00924 <span class="comment">        runout for realtime threads in the specified process are disabled</span>
00925 <span class="comment">        or enabled.</span>
00926 <span class="comment"></span>
00927 <span class="comment">Return Value:</span>
00928 <span class="comment"></span>
00929 <span class="comment">    The previous value of the disable quantum state variable.</span>
00930 <span class="comment"></span>
00931 <span class="comment">--*/</span>
00932 
00933 {
00934 
00935     LOGICAL DisableQuantum;
00936 
00937     <a class="code" href="../../d4/d1/alpha_2thredini_8c.html#a0">ASSERT_PROCESS</a>(Process);
00938 
00939     <span class="comment">//</span>
00940     <span class="comment">// Capture the current state of the disable boost variable and set its</span>
00941     <span class="comment">// state to TRUE.</span>
00942     <span class="comment">//</span>
00943 
00944     DisableQuantum = Process-&gt;DisableQuantum;
00945     Process-&gt;DisableQuantum = (BOOLEAN)Disable;
00946 
00947     <span class="comment">//</span>
00948     <span class="comment">// Return the previous disable quantum state.</span>
00949     <span class="comment">//</span>
00950 
00951     <span class="keywordflow">return</span> DisableQuantum;
00952 }
00953 
00954 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00955"></a><a class="code" href="../../d3/d5/procobj_8c.html#a13">00955</a> <a class="code" href="../../d3/d5/procobj_8c.html#a13">KiAttachProcess</a> (
00956     IN <a class="code" href="../../d1/d8/struct__KTHREAD.html">PRKTHREAD</a> Thread,
00957     IN <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process,
00958     IN KIRQL OldIrql,
00959     OUT <a class="code" href="../../d3/d5/struct__KAPC__STATE.html">PRKAPC_STATE</a> SavedApcState
00960     )
00961 
00962 <span class="comment">/*++</span>
00963 <span class="comment"></span>
00964 <span class="comment">Routine Description:</span>
00965 <span class="comment"></span>
00966 <span class="comment">    This function attaches a thread to a target process' address space.</span>
00967 <span class="comment"></span>
00968 <span class="comment">    N.B. The dispatcher database lock must be held when this routine is</span>
00969 <span class="comment">        called.</span>
00970 <span class="comment"></span>
00971 <span class="comment">Arguments:</span>
00972 <span class="comment"></span>
00973 <span class="comment">    Thread - Supplies a pointer to a dispatcher object of type thread.</span>
00974 <span class="comment"></span>
00975 <span class="comment">    Process - Supplies a pointer to a dispatcher object of type process.</span>
00976 <span class="comment"></span>
00977 <span class="comment">    OldIrql - Supplies the previous IRQL.</span>
00978 <span class="comment"></span>
00979 <span class="comment">    SavedApcState - Supplies a pointer to the APC state structure that receives</span>
00980 <span class="comment">        the saved APC state.</span>
00981 <span class="comment"></span>
00982 <span class="comment">Return Value:</span>
00983 <span class="comment"></span>
00984 <span class="comment">    None.</span>
00985 <span class="comment"></span>
00986 <span class="comment">--*/</span>
00987 
00988 {
00989 
00990     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PRKTHREAD</a> OutThread;
00991     KAFFINITY Processor;
00992     PLIST_ENTRY NextEntry;
00993     KIRQL HighIrql;
00994 
00995     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Process != Thread-&gt;ApcState.Process);
00996 
00997     <span class="comment">//</span>
00998     <span class="comment">// Bias the stack count of the target process to signify that a</span>
00999     <span class="comment">// thread exists in that process with a stack that is resident.</span>
01000     <span class="comment">//</span>
01001 
01002     Process-&gt;StackCount += 1;
01003 
01004     <span class="comment">//</span>
01005     <span class="comment">// Save current APC state and initialize a new APC state.</span>
01006     <span class="comment">//</span>
01007 
01008     <a class="code" href="../../d3/d5/procobj_8c.html#a2">KiMoveApcState</a>(&amp;Thread-&gt;ApcState, SavedApcState);
01009     InitializeListHead(&amp;Thread-&gt;ApcState.ApcListHead[<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>]);
01010     InitializeListHead(&amp;Thread-&gt;ApcState.ApcListHead[<a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>]);
01011     Thread-&gt;ApcState.Process = Process;
01012     Thread-&gt;ApcState.KernelApcInProgress = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01013     Thread-&gt;ApcState.KernelApcPending = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01014     Thread-&gt;ApcState.UserApcPending = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01015     <span class="keywordflow">if</span> (SavedApcState == &amp;Thread-&gt;SavedApcState) {
01016         Thread-&gt;ApcStatePointer[0] = &amp;Thread-&gt;SavedApcState;
01017         Thread-&gt;ApcStatePointer[1] = &amp;Thread-&gt;ApcState;
01018         Thread-&gt;ApcStateIndex = 1;
01019     }
01020 
01021     <span class="comment">//</span>
01022     <span class="comment">// If the target process is in memory, then immediately enter the</span>
01023     <span class="comment">// new address space by loading a new Directory Table Base. Otherwise,</span>
01024     <span class="comment">// insert the current thread in the target process ready list, inswap</span>
01025     <span class="comment">// the target process if necessary, select a new thread to run on the</span>
01026     <span class="comment">// the current processor and context switch to the new thread.</span>
01027     <span class="comment">//</span>
01028 
01029     <span class="keywordflow">if</span> (Process-&gt;State == <a class="code" href="../../d4/d9/ke_8h.html#a405a186">ProcessInMemory</a>) {
01030 
01031         <span class="comment">//</span>
01032         <span class="comment">// It is possible that the process is in memory, but there exist</span>
01033         <span class="comment">// threads in the process ready list. This can happen when memory</span>
01034         <span class="comment">// management forces a process attach.</span>
01035         <span class="comment">//</span>
01036 
01037         NextEntry = Process-&gt;ReadyListHead.Flink;
01038         <span class="keywordflow">while</span> (NextEntry != &amp;Process-&gt;ReadyListHead) {
01039             OutThread = CONTAINING_RECORD(NextEntry, <a class="code" href="../../d1/d8/struct__KTHREAD.html">KTHREAD</a>, WaitListEntry);
01040             RemoveEntryList(NextEntry);
01041             OutThread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o43">ProcessReadyQueue</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01042             <a class="code" href="../../d0/d2/thredsup_8c.html#a3">KiReadyThread</a>(OutThread);
01043             NextEntry = Process-&gt;ReadyListHead.Flink;
01044         }
01045 
01046         <a class="code" href="../../d0/d0/ki_8h.html#a137">KiSwapProcess</a>(Process, SavedApcState-&gt;Process);
01047         <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
01048 
01049     } <span class="keywordflow">else</span> {
01050         Thread-&gt;State = <a class="code" href="../../d4/d9/ke_8h.html#a406a192">Ready</a>;
01051         Thread-&gt;ProcessReadyQueue = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01052         InsertTailList(&amp;Process-&gt;ReadyListHead, &amp;Thread-&gt;WaitListEntry);
01053         <span class="keywordflow">if</span> (Process-&gt;State == <a class="code" href="../../d4/d9/ke_8h.html#a405a187">ProcessOutOfMemory</a>) {
01054             Process-&gt;State = <a class="code" href="../../d4/d9/ke_8h.html#a405a188">ProcessInTransition</a>;
01055             InsertTailList(&amp;<a class="code" href="../../d5/d9/kernldat_8c.html#a48">KiProcessInSwapListHead</a>, &amp;Process-&gt;SwapListEntry);
01056             <a class="code" href="../../d5/d9/kernldat_8c.html#a47">KiSwapEvent</a>.<a class="code" href="../../d2/d6/struct__KEVENT.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o4">SignalState</a> = 1;
01057             <span class="keywordflow">if</span> (IsListEmpty(&amp;<a class="code" href="../../d5/d9/kernldat_8c.html#a47">KiSwapEvent</a>.<a class="code" href="../../d2/d6/struct__KEVENT.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o5">WaitListHead</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01058                 <a class="code" href="../../d2/d7/waitsup_8c.html#a3">KiWaitTest</a>(&amp;<a class="code" href="../../d5/d9/kernldat_8c.html#a47">KiSwapEvent</a>, <a class="code" href="../../d0/d0/ki_8h.html#a1">BALANCE_INCREMENT</a>);
01059             }
01060         }
01061 
01062         <span class="comment">//</span>
01063         <span class="comment">// Clear the active processor bit in the previous process and</span>
01064         <span class="comment">// set active processor bit in the process being attached to.</span>
01065         <span class="comment">//</span>
01066 
01067 <span class="preprocessor">#if !defined(NT_UP)</span>
01068 <span class="preprocessor"></span>
01069         <a class="code" href="../../d0/d0/ki_8h.html#a11">KiLockContextSwap</a>(&amp;HighIrql);
01070         Processor = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>()-&gt;SetMember;
01071         SavedApcState-&gt;Process-&gt;ActiveProcessors &amp;= ~Processor;
01072         Process-&gt;ActiveProcessors |= Processor;
01073 
01074 <span class="preprocessor">#if defined(_ALPHA_)</span>
01075 <span class="preprocessor"></span>
01076         Process-&gt;RunOnProcessors |= Processor;
01077 
01078 <span class="preprocessor">#endif</span>
01079 <span class="preprocessor"></span>
01080         <a class="code" href="../../d0/d0/ki_8h.html#a12">KiUnlockContextSwap</a>(HighIrql);
01081 
01082 <span class="preprocessor">#endif</span>
01083 <span class="preprocessor"></span>
01084         Thread-&gt;WaitIrql = OldIrql;
01085         <a class="code" href="../../d0/d0/ki_8h.html#a138">KiSwapThread</a>();
01086     }
01087 
01088     <span class="keywordflow">return</span>;
01089 }
01090 
01091 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01092"></a><a class="code" href="../../d3/d5/procobj_8c.html#a2">01092</a> <a class="code" href="../../d3/d5/procobj_8c.html#a2">KiMoveApcState</a> (
01093     IN <a class="code" href="../../d3/d5/struct__KAPC__STATE.html">PKAPC_STATE</a> Source,
01094     OUT <a class="code" href="../../d3/d5/struct__KAPC__STATE.html">PKAPC_STATE</a> Destination
01095     )
01096 
01097 <span class="comment">/*++</span>
01098 <span class="comment"></span>
01099 <span class="comment">Routine Description:</span>
01100 <span class="comment"></span>
01101 <span class="comment">    This function moves the APC state from the source structure to the</span>
01102 <span class="comment">    destination structure and reinitializes list headers as appropriate.</span>
01103 <span class="comment"></span>
01104 <span class="comment">Arguments:</span>
01105 <span class="comment"></span>
01106 <span class="comment">    Source - Supplies a pointer to the source APC state structure.</span>
01107 <span class="comment"></span>
01108 <span class="comment">    Destination - Supplies a pointer to the destination APC state structure.</span>
01109 <span class="comment"></span>
01110 <span class="comment"></span>
01111 <span class="comment">Return Value:</span>
01112 <span class="comment"></span>
01113 <span class="comment">    None.</span>
01114 <span class="comment"></span>
01115 <span class="comment">--*/</span>
01116 
01117 {
01118 
01119     PLIST_ENTRY First;
01120     PLIST_ENTRY Last;
01121 
01122     <span class="comment">//</span>
01123     <span class="comment">// Copy the APC state from the source to the destination.</span>
01124     <span class="comment">//</span>
01125 
01126     *Destination = *Source;
01127     <span class="keywordflow">if</span> (IsListEmpty(&amp;Source-&gt;ApcListHead[<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>]) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01128         InitializeListHead(&amp;Destination-&gt;ApcListHead[<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>]);
01129 
01130     } <span class="keywordflow">else</span> {
01131         First = Source-&gt;ApcListHead[<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>].Flink;
01132         Last = Source-&gt;ApcListHead[<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>].Blink;
01133         Destination-&gt;ApcListHead[<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>].Flink = First;
01134         Destination-&gt;ApcListHead[<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>].Blink = Last;
01135         First-&gt;Blink = &amp;Destination-&gt;ApcListHead[<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>];
01136         Last-&gt;Flink = &amp;Destination-&gt;ApcListHead[<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>];
01137     }
01138 
01139     <span class="keywordflow">if</span> (IsListEmpty(&amp;Source-&gt;ApcListHead[<a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>]) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01140         InitializeListHead(&amp;Destination-&gt;ApcListHead[<a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>]);
01141 
01142     } <span class="keywordflow">else</span> {
01143         First = Source-&gt;ApcListHead[<a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>].Flink;
01144         Last = Source-&gt;ApcListHead[<a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>].Blink;
01145         Destination-&gt;ApcListHead[<a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>].Flink = First;
01146         Destination-&gt;ApcListHead[<a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>].Blink = Last;
01147         First-&gt;Blink = &amp;Destination-&gt;ApcListHead[<a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>];
01148         Last-&gt;Flink = &amp;Destination-&gt;ApcListHead[<a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>];
01149     }
01150 
01151     <span class="keywordflow">return</span>;
01152 }
01153 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:26 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
