<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: ssend.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>ssend.c</h1><a href="../../d3/d5/ssend_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: ssend.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* Server side sending stubs</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* 07-06-91 ScottLu      Created.</span>
00009 <span class="comment">\***************************************************************************/</span>
00010 
00011 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00012 <span class="preprocessor">#pragma hdrstop</span>
00013 <span class="preprocessor"></span>
<a name="l00014"></a><a class="code" href="../../d3/d5/ssend_8c.html#a0">00014</a> <span class="preprocessor">#define CALLBACKPROC 1</span>
<a name="l00015"></a><a class="code" href="../../d3/d5/ssend_8c.html#a1">00015</a> <span class="preprocessor"></span><span class="preprocessor">#define SERVERSIDE 1</span>
00016 <span class="preprocessor"></span>
00017 <span class="preprocessor">#include "callback.h"</span>
00018 
<a name="l00019"></a><a class="code" href="../../d3/d5/ssend_8c.html#a2">00019</a> <span class="preprocessor">#define SENDSIDE 1</span>
00020 <span class="preprocessor"></span>
<a name="l00021"></a><a class="code" href="../../d3/d5/ssend_8c.html#a3">00021</a> <span class="preprocessor">#define CBBUFSIZE   512</span>
00022 <span class="preprocessor"></span>
<a name="l00023"></a><a class="code" href="../../d3/d5/ssend_8c.html#a4">00023</a> <span class="preprocessor">#define PADSIZE     (sizeof(ULONG_PTR) - 1)</span>
00024 <span class="preprocessor"></span>
00025 <span class="comment">/*</span>
00026 <span class="comment"> * Callback setup and control macros</span>
00027 <span class="comment"> */</span>
<a name="l00028"></a><a class="code" href="../../d3/d5/ssend_8c.html#a5">00028</a> <span class="preprocessor">#define SMESSAGECALL(api) \</span>
00029 <span class="preprocessor">LRESULT Sfn ## api(      \</span>
00030 <span class="preprocessor">    PWND pwnd,           \</span>
00031 <span class="preprocessor">    UINT msg,            \</span>
00032 <span class="preprocessor">    WPARAM wParam,       \</span>
00033 <span class="preprocessor">    LPARAM lParam,       \</span>
00034 <span class="preprocessor">    ULONG_PTR xParam,     \</span>
00035 <span class="preprocessor">    PROC xpfnProc,       \</span>
00036 <span class="preprocessor">    DWORD dwSCMSFlags,   \</span>
00037 <span class="preprocessor">    PSMS psms)</span>
00038 <span class="preprocessor"></span>
<a name="l00039"></a><a class="code" href="../../d3/d5/ssend_8c.html#a6">00039</a> <span class="preprocessor">#define SETUP(api)  \</span>
00040 <span class="preprocessor">    api ## MSG m;                                           \</span>
00041 <span class="preprocessor">    api ## MSG *mp = &amp;m;                                    \</span>
00042 <span class="preprocessor">    BYTE Buffer[CBBUFSIZE];                                 \</span>
00043 <span class="preprocessor">    PCALLBACKSTATUS pcbs;                                   \</span>
00044 <span class="preprocessor">    ULONG cbCBStatus;                                       \</span>
00045 <span class="preprocessor">    ULONG_PTR retval;                                        \</span>
00046 <span class="preprocessor">    NTSTATUS Status;</span>
00047 <span class="preprocessor"></span>
<a name="l00048"></a><a class="code" href="../../d3/d5/ssend_8c.html#a7">00048</a> <span class="preprocessor">#define SETUPDC(api)  \</span>
00049 <span class="preprocessor">    SETUP(api)                         \</span>
00050 <span class="preprocessor">    int iDC = 0;                       \</span>
00051 <span class="preprocessor">    HDC     hdcUse;                    \</span>
00052 <span class="preprocessor">    HBITMAP hbmDCGray = NULL;</span>
00053 <span class="preprocessor"></span>
00054 
<a name="l00055"></a><a class="code" href="../../d3/d5/ssend_8c.html#a8">00055</a> <span class="preprocessor">#define SETUPPWND(api) \</span>
00056 <span class="preprocessor">    api ## MSG m;                                               \</span>
00057 <span class="preprocessor">    api ## MSG *mp = &amp;m;                                        \</span>
00058 <span class="preprocessor">    BYTE Buffer[CBBUFSIZE];                                     \</span>
00059 <span class="preprocessor">    PCALLBACKSTATUS pcbs;                                       \</span>
00060 <span class="preprocessor">    ULONG cbCBStatus;                                           \</span>
00061 <span class="preprocessor">    ULONG_PTR retval;                                           \</span>
00062 <span class="preprocessor">    NTSTATUS Status;                                            \</span>
00063 <span class="preprocessor">    TL tlpwnd;                                                  \</span>
00064 <span class="preprocessor">    CALLBACKWND cbwin;                                          \</span>
00065 <span class="preprocessor">    PCLIENTINFO pci = PtiCurrent()-&gt;pClientInfo;                \</span>
00066 <span class="preprocessor">    PWND pwndClient = pwnd ? (PWND)((PBYTE)pwnd - pci-&gt;ulClientDelta) : NULL; \</span>
00067 <span class="preprocessor">    UserAssert(pci-&gt;ulClientDelta != 0);</span>
00068 <span class="preprocessor"></span>
<a name="l00069"></a><a class="code" href="../../d3/d5/ssend_8c.html#a9">00069</a> <span class="preprocessor">#define CALC_SIZE_IN(cb, pstr) \</span>
00070 <span class="preprocessor">    cb = (pstr)-&gt;Length + sizeof(WCHAR);  \</span>
00071 <span class="preprocessor">    if ((pstr)-&gt;bAnsi &amp;&amp; !fAnsiReceiver)  \</span>
00072 <span class="preprocessor">        cb *= sizeof(WCHAR);</span>
00073 <span class="preprocessor"></span>
<a name="l00074"></a><a class="code" href="../../d3/d5/ssend_8c.html#a10">00074</a> <span class="preprocessor">#define CALC_SIZE_OUT(cb, pstr) \</span>
00075 <span class="preprocessor">    cb = (pstr)-&gt;MaximumLength + sizeof(WCHAR); \</span>
00076 <span class="preprocessor">    if ((pstr)-&gt;bAnsi &amp;&amp; !fAnsiReceiver)        \</span>
00077 <span class="preprocessor">        cb *= sizeof(WCHAR);</span>
00078 <span class="preprocessor"></span>
00079 <span class="preprocessor">#ifdef FE_SB // CALC_SIZE_OUT_STRING()</span>
00080 <span class="preprocessor"></span><span class="preprocessor">#define CALC_SIZE_OUT_STRING(cb, pstr) \</span>
00081 <span class="preprocessor">    cb = (pstr)-&gt;MaximumLength + sizeof(WCHAR); \</span>
00082 <span class="preprocessor">    if (!(PtiCurrent()-&gt;TIF_flags &amp; TIF_ANSILENGTH)) { \</span>
00083 <span class="preprocessor">        if ((pstr)-&gt;bAnsi &amp;&amp; !fAnsiReceiver)           \</span>
00084 <span class="preprocessor">            cb *= sizeof(WCHAR);                       \</span>
00085 <span class="preprocessor">    }</span>
00086 <span class="preprocessor"></span><span class="preprocessor">#endif // FE_SB</span>
00087 <span class="preprocessor"></span>
00088 <span class="preprocessor">#ifdef FE_SB // CALC_SIZE_STRING_OUT()</span>
00089 <span class="preprocessor"></span><span class="preprocessor">#define CALC_SIZE_STRING_OUT(cchText)                                                 \</span>
00090 <span class="preprocessor">    try {                                                                             \</span>
00091 <span class="preprocessor">        (cchText) = CalcOutputStringSize(pcbs,(cchText),fAnsiSender,fAnsiReceiver);   \</span>
00092 <span class="preprocessor">    } except (W32ExceptionHandler(FALSE, RIP_ERROR)) { \</span>
00093 <span class="preprocessor">        (cchText) = 0; \</span>
00094 <span class="preprocessor">        MSGERROR(); \</span>
00095 <span class="preprocessor">    }</span>
00096 <span class="preprocessor"></span><span class="preprocessor">#endif // FE_SB</span>
00097 <span class="preprocessor"></span>
<a name="l00098"></a><a class="code" href="../../d3/d5/ssend_8c.html#a11">00098</a> <span class="preprocessor">#define BEGINSEND(api) \</span>
00099 <span class="preprocessor">    mp = &amp;m; \</span>
00100 <span class="preprocessor">    Buffer;  \</span>
00101 <span class="preprocessor">    {</span>
00102 <span class="preprocessor"></span>
<a name="l00103"></a><a class="code" href="../../d3/d5/ssend_8c.html#a12">00103</a> <span class="preprocessor">#define BEGINSENDCAPTURE(api, cCapturePointers, cCaptureBytes, fInput) \</span>
00104 <span class="preprocessor">    if (cCapturePointers) {                             \</span>
00105 <span class="preprocessor">        mp = AllocCallbackMessage(sizeof(m),            \</span>
00106 <span class="preprocessor">                (cCapturePointers),                     \</span>
00107 <span class="preprocessor">                (cCaptureBytes),                        \</span>
00108 <span class="preprocessor">                Buffer,                                 \</span>
00109 <span class="preprocessor">                fInput);                                \</span>
00110 <span class="preprocessor">        if (mp == NULL)                                 \</span>
00111 <span class="preprocessor">            goto errorexitnofreemp;                     \</span>
00112 <span class="preprocessor">    } else {                                            \</span>
00113 <span class="preprocessor">        m.CaptureBuf.cbCallback = sizeof(m);            \</span>
00114 <span class="preprocessor">        m.CaptureBuf.cbCapture = 0;                     \</span>
00115 <span class="preprocessor">        m.CaptureBuf.cCapturedPointers = 0;             \</span>
00116 <span class="preprocessor">        mp = &amp;m;                                        \</span>
00117 <span class="preprocessor">    }                                                   \</span>
00118 <span class="preprocessor">    {                                                   \</span>
00119 <span class="preprocessor">        PTHREADINFO ptiCurrent = PtiCurrent();          \</span>
00120 <span class="preprocessor">        TL tlPool;                                      \</span>
00121 <span class="preprocessor">                                                        \</span>
00122 <span class="preprocessor">        if (mp != &amp;m &amp;&amp; (PVOID)mp != (PVOID)Buffer)     \</span>
00123 <span class="preprocessor">            ThreadLockPool(ptiCurrent, mp, &amp;tlPool);</span>
00124 <span class="preprocessor"></span>
<a name="l00125"></a><a class="code" href="../../d3/d5/ssend_8c.html#a13">00125</a> <span class="preprocessor">#define BEGINSENDCAPTUREVOIDDC(api, cCapturePointers, cCaptureBytes, fInput)  \</span>
00126 <span class="preprocessor">    hdcUse = CreateCompatiblePublicDC(hdc,&amp;hbmDCGray);                        \</span>
00127 <span class="preprocessor">    if (hdcUse == (HDC)NULL) {                                                \</span>
00128 <span class="preprocessor">        return;                                                               \</span>
00129 <span class="preprocessor">    }                                                                         \</span>
00130 <span class="preprocessor">    BEGINSENDCAPTURE(api, cCapturePointers, cCaptureBytes, fInput);           \</span>
00131 <span class="preprocessor"></span>
<a name="l00132"></a><a class="code" href="../../d3/d5/ssend_8c.html#a14">00132</a> <span class="preprocessor"></span><span class="preprocessor">#define BEGINSENDCAPTUREDC(api, cCapturePointers, cCaptureBytes, fInput)  \</span>
00133 <span class="preprocessor">    hdcUse = CreateCompatiblePublicDC(hdc,&amp;hbmDCGray);                    \</span>
00134 <span class="preprocessor">    if (hdcUse == (HDC)NULL) {                                            \</span>
00135 <span class="preprocessor">        return FALSE;                                                     \</span>
00136 <span class="preprocessor">    }                                                                     \</span>
00137 <span class="preprocessor">    BEGINSENDCAPTURE(api, cCapturePointers, cCaptureBytes, fInput);       \</span>
00138 <span class="preprocessor"></span>
<a name="l00139"></a><a class="code" href="../../d3/d5/ssend_8c.html#a15">00139</a> <span class="preprocessor"></span><span class="preprocessor">#define LOCKPWND() \</span>
00140 <span class="preprocessor">    ThreadLock(pwnd, &amp;tlpwnd);          \</span>
00141 <span class="preprocessor">    cbwin = pci-&gt;CallbackWnd;           \</span>
00142 <span class="preprocessor">    pci-&gt;CallbackWnd.pwnd = pwndClient; \</span>
00143 <span class="preprocessor">    pci-&gt;CallbackWnd.hwnd = HW(pwnd);</span>
00144 <span class="preprocessor"></span>
<a name="l00145"></a><a class="code" href="../../d3/d5/ssend_8c.html#a16">00145</a> <span class="preprocessor">#define UNLOCKPWND() \</span>
00146 <span class="preprocessor">    pci-&gt;CallbackWnd = cbwin;       \</span>
00147 <span class="preprocessor">    ThreadUnlock(&amp;tlpwnd);</span>
00148 <span class="preprocessor"></span>
<a name="l00149"></a><a class="code" href="../../d3/d5/ssend_8c.html#a17">00149</a> <span class="preprocessor">#define MAKECALL(api) \</span>
00150 <span class="preprocessor">    UserAssert(!(PtiCurrent()-&gt;TIF_flags &amp; TIF_INCLEANUP)); \</span>
00151 <span class="preprocessor">    LeaveCrit();                                            \</span>
00152 <span class="preprocessor">    Status = KeUserModeCallback(                            \</span>
00153 <span class="preprocessor">        FI_ ## api,                                         \</span>
00154 <span class="preprocessor">        mp,                                                 \</span>
00155 <span class="preprocessor">        sizeof(*mp),                                        \</span>
00156 <span class="preprocessor">        &amp;pcbs,                                              \</span>
00157 <span class="preprocessor">        &amp;cbCBStatus);                                       \</span>
00158 <span class="preprocessor">    EnterCrit();</span>
00159 <span class="preprocessor"></span>
<a name="l00160"></a><a class="code" href="../../d3/d5/ssend_8c.html#a18">00160</a> <span class="preprocessor">#define MAKECALLCAPTURE(api) \</span>
00161 <span class="preprocessor">    UserAssert(!(PtiCurrent()-&gt;TIF_flags &amp; TIF_INCLEANUP)); \</span>
00162 <span class="preprocessor">    LeaveCrit();                                            \</span>
00163 <span class="preprocessor">    Status = (DWORD)KeUserModeCallback(                     \</span>
00164 <span class="preprocessor">        FI_ ## api,                                         \</span>
00165 <span class="preprocessor">        mp,                                                 \</span>
00166 <span class="preprocessor">        mp-&gt;CaptureBuf.cbCallback,                          \</span>
00167 <span class="preprocessor">        &amp;pcbs,                                              \</span>
00168 <span class="preprocessor">        &amp;cbCBStatus);                                       \</span>
00169 <span class="preprocessor">    EnterCrit();</span>
00170 <span class="preprocessor"></span>
<a name="l00171"></a><a class="code" href="../../d3/d5/ssend_8c.html#a19">00171</a> <span class="preprocessor">#define MAKECALLCAPTUREDC(api)                              \</span>
00172 <span class="preprocessor">        iDC = GreSaveDC(hdc);                               \</span>
00173 <span class="preprocessor">        MAKECALLCAPTURE(api)                                \</span>
00174 <span class="preprocessor">        GreRestoreDC(hdc, iDC);                             \</span>
00175 <span class="preprocessor">        iDC = 0;                                            \</span>
00176 <span class="preprocessor">        if ((hdcUse != hdc) &amp;&amp; NT_SUCCESS(Status)) {        \</span>
00177 <span class="preprocessor">            GreBitBlt(hdc,                                  \</span>
00178 <span class="preprocessor">                      0,                                    \</span>
00179 <span class="preprocessor">                      0,                                    \</span>
00180 <span class="preprocessor">                      gpDispInfo-&gt;cxGray,                   \</span>
00181 <span class="preprocessor">                      gpDispInfo-&gt;cyGray,                   \</span>
00182 <span class="preprocessor">                      hdcUse,                               \</span>
00183 <span class="preprocessor">                      0,                                    \</span>
00184 <span class="preprocessor">                      0,                                    \</span>
00185 <span class="preprocessor">                      SRCCOPY,                              \</span>
00186 <span class="preprocessor">                      0);                                   \</span>
00187 <span class="preprocessor">        }</span>
00188 <span class="preprocessor"></span>
<a name="l00189"></a><a class="code" href="../../d3/d5/ssend_8c.html#a20">00189</a> <span class="preprocessor">#define CHECKRETURN() \</span>
00190 <span class="preprocessor">    if (!NT_SUCCESS(Status) ||                              \</span>
00191 <span class="preprocessor">            cbCBStatus != sizeof(*pcbs)) {                  \</span>
00192 <span class="preprocessor">        goto errorexit;                                     \</span>
00193 <span class="preprocessor">    }                                                       \</span>
00194 <span class="preprocessor">    try {                                                   \</span>
00195 <span class="preprocessor">        retval = ProbeAndReadStructure(&amp;pcbs-&gt;retval, ULONG_PTR); \</span>
00196 <span class="preprocessor">    } except (W32ExceptionHandler(FALSE, RIP_ERROR)) { \</span>
00197 <span class="preprocessor">        MSGERROR(); \</span>
00198 <span class="preprocessor">    }</span>
00199 <span class="preprocessor"></span>
<a name="l00200"></a><a class="code" href="../../d3/d5/ssend_8c.html#a21">00200</a> <span class="preprocessor">#define ENDSEND(type, error) \</span>
00201 <span class="preprocessor">        return (type)retval;               \</span>
00202 <span class="preprocessor">        goto errorexit;                    \</span>
00203 <span class="preprocessor">    }                                      \</span>
00204 <span class="preprocessor">errorexit:                                 \</span>
00205 <span class="preprocessor">   return (type)error</span>
00206 <span class="preprocessor"></span>
<a name="l00207"></a><a class="code" href="../../d3/d5/ssend_8c.html#a22">00207</a> <span class="preprocessor">#define CLEANUPSENDCAPTURECOMMONDC() \</span>
00208 <span class="preprocessor">   if(iDC) {                                                    \</span>
00209 <span class="preprocessor">       GreRestoreDC(hdc, iDC);                                  \</span>
00210 <span class="preprocessor">   }                                                            \</span>
00211 <span class="preprocessor">   if (hdcUse != hdc) {                                         \</span>
00212 <span class="preprocessor">       GreDeleteDC(hdcUse);                                     \</span>
00213 <span class="preprocessor">       GreDeleteObject(hbmDCGray);                              \</span>
00214 <span class="preprocessor">   }                                                            \</span>
00215 <span class="preprocessor"></span>
<a name="l00216"></a><a class="code" href="../../d3/d5/ssend_8c.html#a23">00216</a> <span class="preprocessor"></span><span class="preprocessor">#define BEGIN_ENDSENDCAPTURE(type, error) \</span>
00217 <span class="preprocessor">exit:</span>
<a name="l00218"></a><a class="code" href="../../d3/d5/ssend_8c.html#a24">00218</a> <span class="preprocessor"></span><span class="preprocessor">#define _ENDSENDCAPTURE(type, error) \</span>
00219 <span class="preprocessor">        if (mp != &amp;m &amp;&amp; (PVOID)mp != (PVOID)Buffer) {           \</span>
00220 <span class="preprocessor">            if (mp-&gt;CaptureBuf.pvVirtualAddress) {              \</span>
00221 <span class="preprocessor">                NTSTATUS Status;                                \</span>
00222 <span class="preprocessor">                SIZE_T ulRegionSize = 0;                        \</span>
00223 <span class="preprocessor">                                                                \</span>
00224 <span class="preprocessor">                Status = ZwFreeVirtualMemory(NtCurrentProcess(),\</span>
00225 <span class="preprocessor">                        &amp;mp-&gt;CaptureBuf.pvVirtualAddress,       \</span>
00226 <span class="preprocessor">                        &amp;ulRegionSize,                          \</span>
00227 <span class="preprocessor">                        MEM_RELEASE);                           \</span>
00228 <span class="preprocessor">                UserAssert(NT_SUCCESS(Status));                 \</span>
00229 <span class="preprocessor">            }                                                   \</span>
00230 <span class="preprocessor">            ThreadUnlockAndFreePool(ptiCurrent, &amp;tlPool);       \</span>
00231 <span class="preprocessor">        }                                                       \</span>
00232 <span class="preprocessor">        return (type)retval;                                    \</span>
00233 <span class="preprocessor">        goto errorexit;                                         \</span>
00234 <span class="preprocessor">    }                                                           \</span>
00235 <span class="preprocessor">errorexit:                                                      \</span>
00236 <span class="preprocessor">   retval = error;                                              \</span>
00237 <span class="preprocessor">   goto exit;                                                   \</span>
00238 <span class="preprocessor">errorexitnofreemp:</span>
<a name="l00239"></a><a class="code" href="../../d3/d5/ssend_8c.html#a25">00239</a> <span class="preprocessor"></span><span class="preprocessor">#define END_ENDSENDCAPTURE(type, error) \</span>
00240 <span class="preprocessor">       return (type)error</span>
00241 <span class="preprocessor"></span>
00242 
<a name="l00243"></a><a class="code" href="../../d3/d5/ssend_8c.html#a26">00243</a> <span class="preprocessor">#define ENDSENDCAPTUREDC(type, error) \</span>
00244 <span class="preprocessor">        BEGIN_ENDSENDCAPTURE(type, error); \</span>
00245 <span class="preprocessor">        CLEANUPSENDCAPTURECOMMONDC(); \</span>
00246 <span class="preprocessor">        _ENDSENDCAPTURE(type, error); \</span>
00247 <span class="preprocessor">        CLEANUPSENDCAPTURECOMMONDC(); \</span>
00248 <span class="preprocessor">        END_ENDSENDCAPTURE(type, error)</span>
00249 <span class="preprocessor"></span>
<a name="l00250"></a><a class="code" href="../../d3/d5/ssend_8c.html#a27">00250</a> <span class="preprocessor">#define ENDSENDCAPTURE(type, error) \</span>
00251 <span class="preprocessor">        BEGIN_ENDSENDCAPTURE(type, error); \</span>
00252 <span class="preprocessor">        _ENDSENDCAPTURE(type, error); \</span>
00253 <span class="preprocessor">        END_ENDSENDCAPTURE(type, error)</span>
00254 <span class="preprocessor"></span>
00255 
00256 <span class="preprocessor">#ifdef FE_SB // ENDSENDCAPTUREOUTSTRING()</span>
00257 <span class="preprocessor"></span><span class="preprocessor">#define ENDSENDCAPTUREOUTSTRING(type, error) \</span>
00258 <span class="preprocessor">exit:                                                           \</span>
00259 <span class="preprocessor">        if (mp != &amp;m &amp;&amp; (PVOID)mp != (PVOID)Buffer) {           \</span>
00260 <span class="preprocessor">            if (mp-&gt;CaptureBuf.pvVirtualAddress) {              \</span>
00261 <span class="preprocessor">                NTSTATUS Status;                                \</span>
00262 <span class="preprocessor">                SIZE_T ulRegionSize = 0;                        \</span>
00263 <span class="preprocessor">                                                                \</span>
00264 <span class="preprocessor">                Status = ZwFreeVirtualMemory(NtCurrentProcess(),\</span>
00265 <span class="preprocessor">                        &amp;mp-&gt;CaptureBuf.pvVirtualAddress,       \</span>
00266 <span class="preprocessor">                        &amp;ulRegionSize,                          \</span>
00267 <span class="preprocessor">                        MEM_RELEASE);                           \</span>
00268 <span class="preprocessor">                UserAssert(NT_SUCCESS(Status));                 \</span>
00269 <span class="preprocessor">            }                                                   \</span>
00270 <span class="preprocessor">            ThreadUnlockAndFreePool(ptiCurrent, &amp;tlPool);       \</span>
00271 <span class="preprocessor">        }                                                       \</span>
00272 <span class="preprocessor">        if (bInflateWParam)                                     \</span>
00273 <span class="preprocessor">            PtiCurrent()-&gt;TIF_flags &amp;= ~TIF_ANSILENGTH;         \</span>
00274 <span class="preprocessor">        return (type)retval;                                    \</span>
00275 <span class="preprocessor">        goto errorexit;                                         \</span>
00276 <span class="preprocessor">    }                                                           \</span>
00277 <span class="preprocessor">errorexit:                                                      \</span>
00278 <span class="preprocessor">   retval = error;                                              \</span>
00279 <span class="preprocessor">   goto exit;                                                   \</span>
00280 <span class="preprocessor">errorexitnofreemp:                                              \</span>
00281 <span class="preprocessor">   if (bInflateWParam)                                          \</span>
00282 <span class="preprocessor">       PtiCurrent()-&gt;TIF_flags &amp;= ~TIF_ANSILENGTH;              \</span>
00283 <span class="preprocessor">   return (type)error</span>
00284 <span class="preprocessor"></span><span class="preprocessor">#endif // FE_SB</span>
00285 <span class="preprocessor"></span>
<a name="l00286"></a><a class="code" href="../../d3/d5/ssend_8c.html#a28">00286</a> <span class="preprocessor">#define BEGIN_ENDSENDCAPTUREVOID() \</span>
00287 <span class="preprocessor">errorexit:</span>
<a name="l00288"></a><a class="code" href="../../d3/d5/ssend_8c.html#a29">00288</a> <span class="preprocessor"></span><span class="preprocessor">#define _ENDSENDCAPTUREVOID() \</span>
00289 <span class="preprocessor">        if (mp != &amp;m &amp;&amp; (PVOID)mp != (PVOID)Buffer) {           \</span>
00290 <span class="preprocessor">            if (mp-&gt;CaptureBuf.pvVirtualAddress) {              \</span>
00291 <span class="preprocessor">                NTSTATUS Status;                                \</span>
00292 <span class="preprocessor">                SIZE_T ulRegionSize = 0;                        \</span>
00293 <span class="preprocessor">                                                                \</span>
00294 <span class="preprocessor">                Status = ZwFreeVirtualMemory(NtCurrentProcess(),\</span>
00295 <span class="preprocessor">                        &amp;mp-&gt;CaptureBuf.pvVirtualAddress,       \</span>
00296 <span class="preprocessor">                        &amp;ulRegionSize,                          \</span>
00297 <span class="preprocessor">                        MEM_RELEASE);                           \</span>
00298 <span class="preprocessor">                UserAssert(NT_SUCCESS(Status));                 \</span>
00299 <span class="preprocessor">            }                                                   \</span>
00300 <span class="preprocessor">            ThreadUnlockAndFreePool(ptiCurrent, &amp;tlPool);       \</span>
00301 <span class="preprocessor">        }                                                       \</span>
00302 <span class="preprocessor">        return;                                                 \</span>
00303 <span class="preprocessor">    }                                                           \</span>
00304 <span class="preprocessor">errorexitnofreemp:</span>
<a name="l00305"></a><a class="code" href="../../d3/d5/ssend_8c.html#a30">00305</a> <span class="preprocessor"></span><span class="preprocessor">#define END_ENDSENDCAPTUREVOID() \</span>
00306 <span class="preprocessor">   return</span>
00307 <span class="preprocessor"></span>
<a name="l00308"></a><a class="code" href="../../d3/d5/ssend_8c.html#a31">00308</a> <span class="preprocessor">#define ENDSENDCAPTUREVOIDDC() \</span>
00309 <span class="preprocessor">        BEGIN_ENDSENDCAPTUREVOID(); \</span>
00310 <span class="preprocessor">        CLEANUPSENDCAPTURECOMMONDC(); \</span>
00311 <span class="preprocessor">        _ENDSENDCAPTUREVOID(); \</span>
00312 <span class="preprocessor">        CLEANUPSENDCAPTURECOMMONDC(); \</span>
00313 <span class="preprocessor">        END_ENDSENDCAPTUREVOID()</span>
00314 <span class="preprocessor"></span>
<a name="l00315"></a><a class="code" href="../../d3/d5/ssend_8c.html#a32">00315</a> <span class="preprocessor">#define ENDSENDCAPTUREVOID() \</span>
00316 <span class="preprocessor">        BEGIN_ENDSENDCAPTUREVOID(); \</span>
00317 <span class="preprocessor">        CLEANUPSENDCAPTURECOMMON(); \</span>
00318 <span class="preprocessor">        _ENDSENDCAPTUREVOID(); \</span>
00319 <span class="preprocessor">        CLEANUPSENDCAPTURECOMMON(); \</span>
00320 <span class="preprocessor">        END_ENDSENDCAPTUREVOID()</span>
00321 <span class="preprocessor"></span>
00322 
<a name="l00323"></a><a class="code" href="../../d3/d5/ssend_8c.html#a33">00323</a> <span class="preprocessor">#define ENDSENDVOID() \</span>
00324 <span class="preprocessor">    }                 \</span>
00325 <span class="preprocessor">    return</span>
00326 <span class="preprocessor"></span>
<a name="l00327"></a><a class="code" href="../../d3/d5/ssend_8c.html#a34">00327</a> <span class="preprocessor">#define MSGERROR() goto errorexit</span>
00328 <span class="preprocessor"></span>
00329 <span class="preprocessor">#ifdef FE_SB // CHECKRETURN1() &amp; ENDSEND1()</span>
00330 <span class="preprocessor"></span><span class="preprocessor">#define CHECKRETURN1() \</span>
00331 <span class="preprocessor">    if (!NT_SUCCESS(Status) ||                              \</span>
00332 <span class="preprocessor">            cbCBStatus != sizeof(*pcbs)) {                  \</span>
00333 <span class="preprocessor">        goto errorexit1;                                    \</span>
00334 <span class="preprocessor">    }                                                       \</span>
00335 <span class="preprocessor">    try {                                                   \</span>
00336 <span class="preprocessor">        retval = ProbeAndReadStructure(&amp;pcbs-&gt;retval, ULONG_PTR); \</span>
00337 <span class="preprocessor">    } except (W32ExceptionHandler(FALSE, RIP_ERROR)) { \</span>
00338 <span class="preprocessor">        MSGERROR(); \</span>
00339 <span class="preprocessor">    }</span>
00340 <span class="preprocessor"></span>
00341 <span class="preprocessor">#define ENDSEND1(type, error) \</span>
00342 <span class="preprocessor">        return (type)retval;               \</span>
00343 <span class="preprocessor">        goto errorexit1;                   \</span>
00344 <span class="preprocessor">    }                                      \</span>
00345 <span class="preprocessor">errorexit1:                                \</span>
00346 <span class="preprocessor">   return (type)error</span>
00347 <span class="preprocessor"></span>
00348 <span class="preprocessor">#define MSGERROR1() goto errorexit1</span>
00349 <span class="preprocessor"></span><span class="preprocessor">#endif // FE_SB</span>
00350 <span class="preprocessor"></span>
00351 <span class="comment">/*</span>
00352 <span class="comment"> * Callback IN parameter macros</span>
00353 <span class="comment"> */</span>
<a name="l00354"></a><a class="code" href="../../d3/d5/ssend_8c.html#a35">00354</a> <span class="preprocessor">#define MSGDATA() (mp)</span>
00355 <span class="preprocessor"></span>
<a name="l00356"></a><a class="code" href="../../d3/d5/ssend_8c.html#a36">00356</a> <span class="preprocessor">#define COPYSTRUCTOPT(x) \</span>
00357 <span class="preprocessor">        MSGDATA()-&gt;p ## x = (p ## x); \</span>
00358 <span class="preprocessor">        if (p ## x) MSGDATA()-&gt;x = *(p ## x);</span>
00359 <span class="preprocessor"></span>
<a name="l00360"></a><a class="code" href="../../d3/d5/ssend_8c.html#a37">00360</a> <span class="preprocessor">#define COPYCONSTRECTSTRUCTOPT(x) \</span>
00361 <span class="preprocessor">        MSGDATA()-&gt;p ## x = (LPRECT)(p ## x); \</span>
00362 <span class="preprocessor">        if (p ## x) MSGDATA()-&gt;x = *(p ## x);</span>
00363 <span class="preprocessor"></span>
<a name="l00364"></a><a class="code" href="../../d3/d5/ssend_8c.html#a38">00364</a> <span class="preprocessor">#define COPYBYTES(p, cb) \</span>
00365 <span class="preprocessor">    if (!NT_SUCCESS(CaptureCallbackData(&amp;mp-&gt;CaptureBuf, p, cb, &amp;mp-&gt;p))) \</span>
00366 <span class="preprocessor">        goto errorexit;</span>
00367 <span class="preprocessor"></span>
<a name="l00368"></a><a class="code" href="../../d3/d5/ssend_8c.html#a39">00368</a> <span class="preprocessor">#define COPYBYTESOPT(p, cb) \</span>
00369 <span class="preprocessor">    if (p) {                                                                    \</span>
00370 <span class="preprocessor">        if (!NT_SUCCESS(CaptureCallbackData(&amp;mp-&gt;CaptureBuf, p, cb, &amp;mp-&gt;p)))   \</span>
00371 <span class="preprocessor">            goto errorexit;                                                     \</span>
00372 <span class="preprocessor">    } else {                                                                    \</span>
00373 <span class="preprocessor">        mp-&gt;p = NULL;                                                           \</span>
00374 <span class="preprocessor">    }</span>
00375 <span class="preprocessor"></span>
<a name="l00376"></a><a class="code" href="../../d3/d5/ssend_8c.html#a40">00376</a> <span class="preprocessor">#define LARGECOPYBYTES(p, cb) \</span>
00377 <span class="preprocessor">    if (!NT_SUCCESS(CaptureCallbackData(&amp;mp-&gt;CaptureBuf, p, cb, &amp;mp-&gt;p))) \</span>
00378 <span class="preprocessor">        goto errorexit;</span>
00379 <span class="preprocessor"></span>
<a name="l00380"></a><a class="code" href="../../d3/d5/ssend_8c.html#a41">00380</a> <span class="preprocessor">#define LARGECOPYBYTES2(src, cb, dest) \</span>
00381 <span class="preprocessor">    if (!NT_SUCCESS(CaptureCallbackData(&amp;mp-&gt;CaptureBuf, src, cb, &amp;mp-&gt;dest))) \</span>
00382 <span class="preprocessor">        goto errorexit;</span>
00383 <span class="preprocessor"></span>
<a name="l00384"></a><a class="code" href="../../d3/d5/ssend_8c.html#a42">00384</a> <span class="preprocessor">#define COPYSTRING(s) \</span>
00385 <span class="preprocessor">    mp-&gt;s.Length = (p ## s)-&gt;Length;                                                \</span>
00386 <span class="preprocessor">    mp-&gt;s.MaximumLength = (p ## s)-&gt;MaximumLength;                                  \</span>
00387 <span class="preprocessor">    if (!NT_SUCCESS(CaptureCallbackData(&amp;mp-&gt;CaptureBuf,                            \</span>
00388 <span class="preprocessor">                                        (p ## s)-&gt;Buffer,                           \</span>
00389 <span class="preprocessor">                                        (p ## s)-&gt;Length + sizeof(WCHAR),           \</span>
00390 <span class="preprocessor">                                        &amp;mp-&gt;s.Buffer)))                            \</span>
00391 <span class="preprocessor">        goto errorexit;</span>
00392 <span class="preprocessor"></span>
<a name="l00393"></a><a class="code" href="../../d3/d5/ssend_8c.html#a43">00393</a> <span class="preprocessor">#define COPYSTRINGOPT(s) \</span>
00394 <span class="preprocessor">    if (p ## s) {                                                                   \</span>
00395 <span class="preprocessor">        mp-&gt;s.Length = (p ## s)-&gt;Length;                                            \</span>
00396 <span class="preprocessor">        mp-&gt;s.MaximumLength = (p ## s)-&gt;MaximumLength;                              \</span>
00397 <span class="preprocessor">        if (!NT_SUCCESS(CaptureCallbackData(&amp;mp-&gt;CaptureBuf,                        \</span>
00398 <span class="preprocessor">                                            (p ## s)-&gt;Buffer,                       \</span>
00399 <span class="preprocessor">                                            (p ## s)-&gt;Length + sizeof(WCHAR),       \</span>
00400 <span class="preprocessor">                                            &amp;mp-&gt;s.Buffer)))                        \</span>
00401 <span class="preprocessor">            goto errorexit;                                                         \</span>
00402 <span class="preprocessor">    } else {                                                                        \</span>
00403 <span class="preprocessor">        mp-&gt;s.Length = 0;                                                           \</span>
00404 <span class="preprocessor">        mp-&gt;s.Buffer = NULL;                                                        \</span>
00405 <span class="preprocessor">    }</span>
00406 <span class="preprocessor"></span>
<a name="l00407"></a><a class="code" href="../../d3/d5/ssend_8c.html#a44">00407</a> <span class="preprocessor">#define COPYSTRINGID(s) \</span>
00408 <span class="preprocessor">    mp-&gt;s.Length = (p ## s)-&gt;Length;                                                \</span>
00409 <span class="preprocessor">    mp-&gt;s.MaximumLength = (p ## s)-&gt;MaximumLength;                                  \</span>
00410 <span class="preprocessor">    if (mp-&gt;s.MaximumLength) {                                                      \</span>
00411 <span class="preprocessor">        if (!NT_SUCCESS(CaptureCallbackData(&amp;mp-&gt;CaptureBuf,                        \</span>
00412 <span class="preprocessor">                                            (p ## s)-&gt;Buffer,                       \</span>
00413 <span class="preprocessor">                                            (p ## s)-&gt;Length + sizeof(WCHAR),       \</span>
00414 <span class="preprocessor">                                            &amp;mp-&gt;s.Buffer)))                        \</span>
00415 <span class="preprocessor">            goto errorexit;                                                         \</span>
00416 <span class="preprocessor">    } else {                                                                        \</span>
00417 <span class="preprocessor">        mp-&gt;s.Buffer = (p ## s)-&gt;Buffer;                                            \</span>
00418 <span class="preprocessor">    }</span>
00419 <span class="preprocessor"></span>
<a name="l00420"></a><a class="code" href="../../d3/d5/ssend_8c.html#a45">00420</a> <span class="preprocessor">#define LARGECOPYSTRINGLPWSTR(ps, psz) \</span>
00421 <span class="preprocessor">    if (!NT_SUCCESS(CaptureCallbackData(&amp;mp-&gt;CaptureBuf,                            \</span>
00422 <span class="preprocessor">                                        (ps)-&gt;Buffer,                               \</span>
00423 <span class="preprocessor">                                        (ps)-&gt;Length + sizeof(WCHAR),               \</span>
00424 <span class="preprocessor">                                        (PVOID *)&amp;mp-&gt;psz)))                        \</span>
00425 <span class="preprocessor">        goto errorexit;</span>
00426 <span class="preprocessor"></span>
<a name="l00427"></a><a class="code" href="../../d3/d5/ssend_8c.html#a46">00427</a> <span class="preprocessor">#define LARGECOPYSTRINGLPSTR(ps, psz) \</span>
00428 <span class="preprocessor">    if (!NT_SUCCESS(CaptureCallbackData(&amp;mp-&gt;CaptureBuf,                            \</span>
00429 <span class="preprocessor">                                        (ps)-&gt;Buffer,                               \</span>
00430 <span class="preprocessor">                                        (ps)-&gt;Length + 1,                           \</span>
00431 <span class="preprocessor">                                        (PVOID *)&amp;mp-&gt;psz)))                        \</span>
00432 <span class="preprocessor">        goto errorexit;</span>
00433 <span class="preprocessor"></span>
<a name="l00434"></a><a class="code" href="../../d3/d5/ssend_8c.html#a47">00434</a> <span class="preprocessor">#define LARGECOPYSTRINGLPWSTRA(ps, psz) \</span>
00435 <span class="preprocessor">    if (!NT_SUCCESS(CaptureAnsiCallbackData(&amp;mp-&gt;CaptureBuf,                        \</span>
00436 <span class="preprocessor">                                        (ps)-&gt;Buffer,                               \</span>
00437 <span class="preprocessor">                                        ((ps)-&gt;Length / sizeof(WCHAR)) + 1,         \</span>
00438 <span class="preprocessor">                                        (PVOID *)&amp;mp-&gt;psz)))                        \</span>
00439 <span class="preprocessor">        goto errorexit;</span>
00440 <span class="preprocessor"></span>
<a name="l00441"></a><a class="code" href="../../d3/d5/ssend_8c.html#a48">00441</a> <span class="preprocessor">#define LARGECOPYSTRINGLPSTRW(ps, psz) \</span>
00442 <span class="preprocessor">    if (!NT_SUCCESS(CaptureUnicodeCallbackData(&amp;mp-&gt;CaptureBuf,                     \</span>
00443 <span class="preprocessor">                                        (ps)-&gt;Buffer,                               \</span>
00444 <span class="preprocessor">                                        ((ps)-&gt;Length + 1) * sizeof(WCHAR),         \</span>
00445 <span class="preprocessor">                                        (PVOID *)&amp;mp-&gt;psz)))                        \</span>
00446 <span class="preprocessor">        goto errorexit;                                                             \</span>
00447 <span class="preprocessor"></span>
<a name="l00448"></a><a class="code" href="../../d3/d5/ssend_8c.html#a49">00448</a> <span class="preprocessor"></span><span class="preprocessor">#define LARGECOPYSTRINGLPWSTROPT(ps, psz) \</span>
00449 <span class="preprocessor">    if (ps) {                                                                       \</span>
00450 <span class="preprocessor">        if (!NT_SUCCESS(CaptureCallbackData(&amp;mp-&gt;CaptureBuf,                        \</span>
00451 <span class="preprocessor">                                            (ps)-&gt;Buffer,                           \</span>
00452 <span class="preprocessor">                                            (ps)-&gt;Length + sizeof(WCHAR),           \</span>
00453 <span class="preprocessor">                                            (PVOID *)&amp;mp-&gt;psz)))                    \</span>
00454 <span class="preprocessor">            goto errorexit;                                                         \</span>
00455 <span class="preprocessor">    } else {                                                                        \</span>
00456 <span class="preprocessor">        mp-&gt;psz = NULL;                                                             \</span>
00457 <span class="preprocessor">    }</span>
00458 <span class="preprocessor"></span>
<a name="l00459"></a><a class="code" href="../../d3/d5/ssend_8c.html#a50">00459</a> <span class="preprocessor">#define LARGECOPYSTRINGLPSTROPT(ps, psz) \</span>
00460 <span class="preprocessor">    if (ps) {                                                                       \</span>
00461 <span class="preprocessor">        if (!NT_SUCCESS(CaptureCallbackData(&amp;mp-&gt;CaptureBuf,                        \</span>
00462 <span class="preprocessor">                                            (ps)-&gt;Buffer,                           \</span>
00463 <span class="preprocessor">                                            (ps)-&gt;Length + sizeof(UCHAR),           \</span>
00464 <span class="preprocessor">                                            (PVOID *)&amp;mp-&gt;psz)))                    \</span>
00465 <span class="preprocessor">            goto errorexit;                                                         \</span>
00466 <span class="preprocessor">    } else {                                                                        \</span>
00467 <span class="preprocessor">        mp-&gt;psz = NULL;                                                             \</span>
00468 <span class="preprocessor">    }</span>
00469 <span class="preprocessor"></span>
<a name="l00470"></a><a class="code" href="../../d3/d5/ssend_8c.html#a51">00470</a> <span class="preprocessor">#define LARGECOPYSTRINGLPWSTROPTA(ps, psz) \</span>
00471 <span class="preprocessor">    if (ps) {                                                                       \</span>
00472 <span class="preprocessor">        if (!NT_SUCCESS(CaptureAnsiCallbackData(&amp;mp-&gt;CaptureBuf,                    \</span>
00473 <span class="preprocessor">                                            (ps)-&gt;Buffer,                           \</span>
00474 <span class="preprocessor">                                            ((ps)-&gt;Length / sizeof(WCHAR)) + 1,     \</span>
00475 <span class="preprocessor">                                            (PVOID *)&amp;mp-&gt;psz)))                    \</span>
00476 <span class="preprocessor">            goto errorexit;                                                         \</span>
00477 <span class="preprocessor">    } else {                                                                        \</span>
00478 <span class="preprocessor">        mp-&gt;psz = NULL;                                                             \</span>
00479 <span class="preprocessor">    }</span>
00480 <span class="preprocessor"></span>
00481 <span class="comment">/*</span>
00482 <span class="comment"> * Wrappers to determine whether copy out should be done.</span>
00483 <span class="comment"> */</span>
<a name="l00484"></a><a class="code" href="../../d3/d5/ssend_8c.html#a52">00484</a> <span class="preprocessor">#define BEGINCOPYOUT() \</span>
00485 <span class="preprocessor">    if ((psms == NULL || ((psms-&gt;flags &amp; (SMF_SENDERDIED | SMF_REPLY)) == 0)) \</span>
00486 <span class="preprocessor">            &amp;&amp; !(dwSCMSFlags &amp; SCMS_FLAGS_INONLY)) {</span>
00487 <span class="preprocessor"></span>
<a name="l00488"></a><a class="code" href="../../d3/d5/ssend_8c.html#a53">00488</a> <span class="preprocessor">#define ENDCOPYOUT() \</span>
00489 <span class="preprocessor">    }</span>
00490 <span class="preprocessor"></span>
00491 <span class="comment">/*</span>
00492 <span class="comment"> * Callback OUT paramter macros</span>
00493 <span class="comment"> */</span>
<a name="l00494"></a><a class="code" href="../../d3/d5/ssend_8c.html#a54">00494</a> <span class="preprocessor">#define OUTSTRUCT(pstruct, type) \</span>
00495 <span class="preprocessor">    try {                                                                   \</span>
00496 <span class="preprocessor">        *(pstruct) = ProbeAndReadStructure(((type *)pcbs-&gt;pOutput), type);  \</span>
00497 <span class="preprocessor">    } except (W32ExceptionHandler(FALSE, RIP_ERROR)) { \</span>
00498 <span class="preprocessor">        MSGERROR(); \</span>
00499 <span class="preprocessor">    }</span>
00500 <span class="preprocessor"></span>
00501 <span class="comment">/*</span>
00502 <span class="comment"> * flags field with mask (propagate back bits in mask only)</span>
00503 <span class="comment"> */</span>
<a name="l00504"></a><a class="code" href="../../d3/d5/ssend_8c.html#a55">00504</a> <span class="preprocessor">#define OUTBITMASK(pstruct, type, mask) \</span>
00505 <span class="preprocessor">    try {                                                                   \</span>
00506 <span class="preprocessor">        type flags = ProbeAndReadStructure(((type *)pcbs-&gt;pOutput), type);  \</span>
00507 <span class="preprocessor">        COPY_FLAG(*(pstruct), flags, mask);                                 \</span>
00508 <span class="preprocessor">    } except (W32ExceptionHandler(FALSE, RIP_ERROR)) { \</span>
00509 <span class="preprocessor">        MSGERROR(); \</span>
00510 <span class="preprocessor">    }</span>
00511 <span class="preprocessor"></span>
00512 <span class="preprocessor">#ifdef FE_SB // COPYOUTLPWSTRLIMIT()</span>
00513 <span class="preprocessor"></span><span class="comment">// should we insert IS_DBCS_ENABLED() in COPYOUTLPWSTRLIMIT ?</span>
00514 <span class="preprocessor">#define COPYOUTLPWSTRLIMIT(pstr, cch) \</span>
00515 <span class="preprocessor">    try {                                                                   \</span>
00516 <span class="preprocessor">        retval = CalcOutputStringSize(pcbs,(DWORD)retval,pstr-&gt;bAnsi,fAnsiReceiver); \</span>
00517 <span class="preprocessor">        CopyOutputString(pcbs, pstr, cch, fAnsiReceiver);                   \</span>
00518 <span class="preprocessor">    } except (W32ExceptionHandler(FALSE, RIP_ERROR)) { \</span>
00519 <span class="preprocessor">        MSGERROR(); \</span>
00520 <span class="preprocessor">    }</span>
00521 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00522"></a><a class="code" href="../../d3/d5/ssend_8c.html#a56">00522</a> <span class="preprocessor"></span><span class="preprocessor">#define COPYOUTLPWSTRLIMIT(pstr, cch) \</span>
00523 <span class="preprocessor">    try {                                                                   \</span>
00524 <span class="preprocessor">        CopyOutputString(pcbs, pstr, cch, fAnsiReceiver);                   \</span>
00525 <span class="preprocessor">    } except (W32ExceptionHandler(FALSE, RIP_ERROR)) { \</span>
00526 <span class="preprocessor">        MSGERROR(); \</span>
00527 <span class="preprocessor">    }</span>
00528 <span class="preprocessor"></span><span class="preprocessor">#endif // FE_SB</span>
00529 <span class="preprocessor"></span>
<a name="l00530"></a><a class="code" href="../../d3/d5/ssend_8c.html#a57">00530</a> <span class="preprocessor">#define RESERVEBYTES(cb, dest, cbdest) \</span>
00531 <span class="preprocessor">    if (!NT_SUCCESS(AllocateCallbackData(&amp;mp-&gt;CaptureBuf,   \</span>
00532 <span class="preprocessor">            cb, (PVOID *)&amp;mp-&gt;dest)))                       \</span>
00533 <span class="preprocessor">        goto errorexit;                                     \</span>
00534 <span class="preprocessor">    mp-&gt;cbdest = cb;</span>
00535 <span class="preprocessor"></span>
00536 <span class="comment">/***************************************************************************\</span>
00537 <span class="comment">* AllocCallbackMessage</span>
00538 <span class="comment">*</span>
00539 <span class="comment">* Allocates a callback message from pool memory and reserves space</span>
00540 <span class="comment">* for arguments to captured later.</span>
00541 <span class="comment">*</span>
00542 <span class="comment">* 03-13-95 JimA             Created.</span>
00543 <span class="comment">\***************************************************************************/</span>
00544 
<a name="l00545"></a><a class="code" href="../../d3/d5/ssend_8c.html#a58">00545</a> PVOID <a class="code" href="../../d3/d5/ssend_8c.html#a58">AllocCallbackMessage</a>(
00546     DWORD cbBaseMsg,
00547     DWORD cPointers,
00548     SIZE_T cbCapture,
00549     PBYTE pStackBuffer,
00550     BOOL fInput)
00551 {
00552     <a class="code" href="../../d4/d7/struct__CAPTUREBUF.html">PCAPTUREBUF</a> pcb;
00553 
00554     <span class="keywordflow">if</span> (cPointers == 0)
00555         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00556 
00557     <span class="comment">/*</span>
00558 <span class="comment">     * Compute allocation sizes</span>
00559 <span class="comment">     */</span>
00560     cbBaseMsg = (cbBaseMsg + <a class="code" href="../../d3/d5/ssend_8c.html#a4">PADSIZE</a>) &amp; ~<a class="code" href="../../d3/d5/ssend_8c.html#a4">PADSIZE</a>;
00561     cbBaseMsg += (cPointers * <span class="keyword">sizeof</span>(PVOID));
00562     cbCapture = (cbCapture + (<a class="code" href="../../d3/d5/ssend_8c.html#a4">PADSIZE</a> * cPointers)) &amp; ~<a class="code" href="../../d3/d5/ssend_8c.html#a4">PADSIZE</a>;
00563 
00564     <span class="comment">/*</span>
00565 <span class="comment">     * If the captured data is greater than a page, place it</span>
00566 <span class="comment">     * in a section.  Otherwise, put the message and the</span>
00567 <span class="comment">     * data in a single block of pool</span>
00568 <span class="comment">     */</span>
00569     <span class="keywordflow">if</span> (cbCapture &gt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a97">CALLBACKSTACKLIMIT</a>) {
00570         <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00571 
00572         <span class="comment">/*</span>
00573 <span class="comment">         * Allocate the message buffer</span>
00574 <span class="comment">         */</span>
00575         pcb = UserAllocPoolWithQuota(cbBaseMsg, TAG_CALLBACK);
00576         <span class="keywordflow">if</span> (pcb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00577             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00578 
00579         <span class="comment">/*</span>
00580 <span class="comment">         * Allocate the virtual memory</span>
00581 <span class="comment">         */</span>
00582         pcb-&gt;<a class="code" href="../../d4/d7/struct__CAPTUREBUF.html#o5">pvVirtualAddress</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00583         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwAllocateVirtualMemory(NtCurrentProcess(),
00584                 &amp;pcb-&gt;<a class="code" href="../../d4/d7/struct__CAPTUREBUF.html#o5">pvVirtualAddress</a>, 0, &amp;cbCapture,
00585                 MEM_COMMIT, PAGE_READWRITE);
00586         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00587             RIPMSG2(RIP_WARNING, <span class="stringliteral">"AllocCallbackMessage: ZwAllocateVirtualMemory failed. Status:%#lx. Size:%#lx"</span>,
00588                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>, cbCapture);
00589             UserFreePool(pcb);
00590             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00591         }
00592         pcb-&gt;<a class="code" href="../../d4/d7/struct__CAPTUREBUF.html#o3">pbFree</a> = pcb-&gt;<a class="code" href="../../d4/d7/struct__CAPTUREBUF.html#o5">pvVirtualAddress</a>;
00593         pcb-&gt;<a class="code" href="../../d4/d7/struct__CAPTUREBUF.html#o0">cbCallback</a> = cbBaseMsg;
00594     } <span class="keywordflow">else</span> {
00595 
00596         <span class="comment">/*</span>
00597 <span class="comment">         * If the message is too big to save on the stack, allocate</span>
00598 <span class="comment">         * the buffer from pool.</span>
00599 <span class="comment">         */</span>
00600         <span class="keywordflow">if</span> (cbBaseMsg + cbCapture &gt; <a class="code" href="../../d3/d5/ssend_8c.html#a3">CBBUFSIZE</a>) {
00601             pcb = UserAllocPoolWithQuota((ULONG)(cbBaseMsg + cbCapture), TAG_CALLBACK);
00602             <span class="keywordflow">if</span> (pcb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00603                 <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00604         } <span class="keywordflow">else</span> {
00605             pcb = (<a class="code" href="../../d4/d7/struct__CAPTUREBUF.html">PCAPTUREBUF</a>)pStackBuffer;
00606         }
00607         pcb-&gt;<a class="code" href="../../d4/d7/struct__CAPTUREBUF.html#o3">pbFree</a> = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pcb + cbBaseMsg;
00608         pcb-&gt;<a class="code" href="../../d4/d7/struct__CAPTUREBUF.html#o5">pvVirtualAddress</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00609 
00610         <span class="comment">/*</span>
00611 <span class="comment">         * If this callback is passing data to the client, include the</span>
00612 <span class="comment">         * captured data in the message.  Otherwise, only pass the message.</span>
00613 <span class="comment">         */</span>
00614         <span class="keywordflow">if</span> (fInput)
00615             pcb-&gt;<a class="code" href="../../d4/d7/struct__CAPTUREBUF.html#o0">cbCallback</a> = cbBaseMsg + (ULONG)cbCapture;
00616         <span class="keywordflow">else</span>
00617             pcb-&gt;<a class="code" href="../../d4/d7/struct__CAPTUREBUF.html#o0">cbCallback</a> = cbBaseMsg;
00618     }
00619 
00620     <span class="comment">/*</span>
00621 <span class="comment">     * Initialize the capture buffer</span>
00622 <span class="comment">     */</span>
00623     pcb-&gt;<a class="code" href="../../d4/d7/struct__CAPTUREBUF.html#o1">cbCapture</a> = (ULONG)cbCapture;
00624     pcb-&gt;<a class="code" href="../../d4/d7/struct__CAPTUREBUF.html#o2">cCapturedPointers</a> = 0;
00625     pcb-&gt;<a class="code" href="../../d4/d7/struct__CAPTUREBUF.html#o4">offPointers</a> = cbBaseMsg - (cPointers * <span class="keyword">sizeof</span>(PVOID));
00626 
00627     <span class="keywordflow">return</span> (PVOID)pcb;
00628 }
00629 
00630 
00631 <span class="comment">/***************************************************************************\</span>
00632 <span class="comment">* CaptureCallbackData</span>
00633 <span class="comment">*</span>
00634 <span class="comment">* Captures data into a callback structure.</span>
00635 <span class="comment">*</span>
00636 <span class="comment">* 03-13-95 JimA             Created.</span>
00637 <span class="comment">\***************************************************************************/</span>
00638 
<a name="l00639"></a><a class="code" href="../../d3/d5/ssend_8c.html#a59">00639</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d3/d5/ssend_8c.html#a59">CaptureCallbackData</a>(
00640     <a class="code" href="../../d4/d7/struct__CAPTUREBUF.html">PCAPTUREBUF</a> pcb,
00641     PVOID pData,
00642     DWORD cbData,
00643     PVOID *ppDest)
00644 {
00645     <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a> pbBuffer;
00646 
00647     <span class="comment">/*</span>
00648 <span class="comment">     * If the data pointer is NULL, the out pointer will be</span>
00649 <span class="comment">     * NULL</span>
00650 <span class="comment">     */</span>
00651     <span class="keywordflow">if</span> (pData == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00652         *ppDest = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00653         <span class="keywordflow">return</span> STATUS_SUCCESS;
00654     }
00655 
00656     <span class="comment">/*</span>
00657 <span class="comment">     * Allocate space from the message buffer</span>
00658 <span class="comment">     */</span>
00659     <span class="keywordflow">if</span> (cbData &gt; pcb-&gt;<a class="code" href="../../d4/d7/struct__CAPTUREBUF.html#o1">cbCapture</a>) {
00660         <span class="keywordflow">return</span> STATUS_BUFFER_OVERFLOW;
00661     }
00662 
00663     pbBuffer = pcb-&gt;<a class="code" href="../../d4/d7/struct__CAPTUREBUF.html#o3">pbFree</a>;
00664     pcb-&gt;<a class="code" href="../../d4/d7/struct__CAPTUREBUF.html#o3">pbFree</a> = pbBuffer + ((cbData + <a class="code" href="../../d3/d5/ssend_8c.html#a4">PADSIZE</a>) &amp; ~<a class="code" href="../../d3/d5/ssend_8c.html#a4">PADSIZE</a>);
00665 
00666     <span class="keywordflow">try</span> {
00667         RtlCopyMemory(pbBuffer, pData, cbData);
00668     } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, RIP_WARNING)) {
00669         <span class="keywordflow">return</span> STATUS_ACCESS_VIOLATION;
00670     }
00671 
00672     <span class="comment">/*</span>
00673 <span class="comment">     * Fix up offsets to data.  If the data is going into a section</span>
00674 <span class="comment">     * use the real pointer and don't compute offsets.</span>
00675 <span class="comment">     */</span>
00676     <span class="keywordflow">if</span> (pcb-&gt;<a class="code" href="../../d4/d7/struct__CAPTUREBUF.html#o5">pvVirtualAddress</a>)
00677         *ppDest = pbBuffer;
00678     <span class="keywordflow">else</span> {
00679         *ppDest = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)(pbBuffer - (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pcb);
00680         ((LPDWORD)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pcb + pcb-&gt;<a class="code" href="../../d4/d7/struct__CAPTUREBUF.html#o4">offPointers</a>))[pcb-&gt;<a class="code" href="../../d4/d7/struct__CAPTUREBUF.html#o2">cCapturedPointers</a>++] =
00681                 (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)ppDest - (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pcb);
00682     }
00683 
00684     <span class="keywordflow">return</span> STATUS_SUCCESS;
00685 }
00686 
00687 <span class="comment">/***************************************************************************\</span>
00688 <span class="comment">* AllocateCallbackData</span>
00689 <span class="comment">*</span>
00690 <span class="comment">* Allocates space from a callback structure.</span>
00691 <span class="comment">*</span>
00692 <span class="comment">* 05-08-95 JimA             Created.</span>
00693 <span class="comment">\***************************************************************************/</span>
00694 
<a name="l00695"></a><a class="code" href="../../d3/d5/ssend_8c.html#a60">00695</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d3/d5/ssend_8c.html#a60">AllocateCallbackData</a>(
00696     <a class="code" href="../../d4/d7/struct__CAPTUREBUF.html">PCAPTUREBUF</a> pcb,
00697     DWORD cbData,
00698     PVOID *ppDest)
00699 {
00700     <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a> pbBuffer;
00701 
00702     <span class="comment">/*</span>
00703 <span class="comment">     * Allocate space from the message buffer</span>
00704 <span class="comment">     */</span>
00705     <span class="keywordflow">if</span> (cbData &gt; pcb-&gt;<a class="code" href="../../d4/d7/struct__CAPTUREBUF.html#o1">cbCapture</a>) {
00706         <span class="keywordflow">return</span> STATUS_BUFFER_OVERFLOW;
00707     }
00708 
00709     pbBuffer = pcb-&gt;<a class="code" href="../../d4/d7/struct__CAPTUREBUF.html#o3">pbFree</a>;
00710     pcb-&gt;<a class="code" href="../../d4/d7/struct__CAPTUREBUF.html#o3">pbFree</a> = pbBuffer + ((cbData + <a class="code" href="../../d3/d5/ssend_8c.html#a4">PADSIZE</a>) &amp; ~<a class="code" href="../../d3/d5/ssend_8c.html#a4">PADSIZE</a>);
00711 
00712     <span class="comment">/*</span>
00713 <span class="comment">     * Fix up offsets to data.  If the data is going into a section</span>
00714 <span class="comment">     * use the real pointer and don't compute offsets.</span>
00715 <span class="comment">     */</span>
00716     <span class="keywordflow">if</span> (pcb-&gt;<a class="code" href="../../d4/d7/struct__CAPTUREBUF.html#o5">pvVirtualAddress</a>)
00717         *ppDest = pbBuffer;
00718     <span class="keywordflow">else</span> {
00719         *ppDest = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)(pbBuffer - (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pcb);
00720         ((LPDWORD)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pcb + pcb-&gt;<a class="code" href="../../d4/d7/struct__CAPTUREBUF.html#o4">offPointers</a>))[pcb-&gt;<a class="code" href="../../d4/d7/struct__CAPTUREBUF.html#o2">cCapturedPointers</a>++] =
00721                 (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)ppDest - (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pcb);
00722     }
00723 
00724     <span class="keywordflow">return</span> STATUS_SUCCESS;
00725 }
00726 
00727 <span class="comment">/***************************************************************************\</span>
00728 <span class="comment">* CaptureAnsiCallbackData</span>
00729 <span class="comment">*</span>
00730 <span class="comment">* Converts Unicode to ANSI data and captures the result</span>
00731 <span class="comment">* into a callback structure.</span>
00732 <span class="comment">*</span>
00733 <span class="comment">* 03-13-95 JimA             Created.</span>
00734 <span class="comment">\***************************************************************************/</span>
00735 
<a name="l00736"></a><a class="code" href="../../d3/d5/ssend_8c.html#a61">00736</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d3/d5/ssend_8c.html#a61">CaptureAnsiCallbackData</a>(
00737     <a class="code" href="../../d4/d7/struct__CAPTUREBUF.html">PCAPTUREBUF</a> pcb,
00738     PVOID pData,
00739     DWORD cbData,
00740     PVOID *ppDest)
00741 {
00742     <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a> pbBuffer;
00743     ULONG nCharsInAnsiString;
00744 
00745     <span class="comment">/*</span>
00746 <span class="comment">     * If the data pointer is NULL, the out pointer will be</span>
00747 <span class="comment">     * NULL</span>
00748 <span class="comment">     */</span>
00749     <span class="keywordflow">if</span> (pData == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00750         *ppDest = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00751         <span class="keywordflow">return</span> STATUS_SUCCESS;
00752     }
00753 
00754     <span class="comment">/*</span>
00755 <span class="comment">     * Allocate space from the message buffer</span>
00756 <span class="comment">     */</span>
00757 <span class="preprocessor">#ifdef FE_SB // CaptureAnsiCallbackData()</span>
00758 <span class="preprocessor"></span>    <span class="comment">/*</span>
00759 <span class="comment">     * Reserve enough space for DBCS.</span>
00760 <span class="comment">     */</span>
00761     <span class="keywordflow">if</span> ((cbData * <span class="keyword">sizeof</span>(WORD)) &gt; pcb-&gt;<a class="code" href="../../d4/d7/struct__CAPTUREBUF.html#o1">cbCapture</a>) {
00762 <span class="preprocessor">#else</span>
00763 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (cbData &gt; pcb-&gt;<a class="code" href="../../d4/d7/struct__CAPTUREBUF.html#o1">cbCapture</a>) {
00764 <span class="preprocessor">#endif // FE_SB</span>
00765 <span class="preprocessor"></span>        <span class="keywordflow">return</span> STATUS_BUFFER_OVERFLOW;
00766     }
00767 
00768     pbBuffer = pcb-&gt;<a class="code" href="../../d4/d7/struct__CAPTUREBUF.html#o3">pbFree</a>;
00769 
00770     <span class="comment">/*</span>
00771 <span class="comment">     * Convert the unicode string to ANSI</span>
00772 <span class="comment">     */</span>
00773     <span class="keywordflow">try</span> {
00774 <span class="preprocessor">#ifdef FE_SB // CaptureAnsiCallbackData()</span>
00775 <span class="preprocessor"></span>        <span class="comment">/*</span>
00776 <span class="comment">         * Enough space for keep DBCS string.</span>
00777 <span class="comment">         */</span>
00778         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d9/d6/nlsxlat_8c.html#a37">RtlUnicodeToMultiByteN</a>(
00779                         (PCH)pbBuffer,
00780                         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a125">IS_DBCS_ENABLED</a>() ? cbData * <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a123">DBCS_CHARSIZE</a> : cbData,
00781                         &amp;nCharsInAnsiString,
00782                         (PWCH)pData,
00783                         cbData * <span class="keyword">sizeof</span>(WCHAR)
00784                         ))) {
00785 <span class="preprocessor">#else</span>
00786 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d9/d6/nlsxlat_8c.html#a37">RtlUnicodeToMultiByteN</a>(
00787                         (PCH)pbBuffer,
00788                         cbData,
00789                         &amp;nCharsInAnsiString,
00790                         (PWCH)pData,
00791                         cbData * <span class="keyword">sizeof</span>(WCHAR)
00792                         ))) {
00793 <span class="preprocessor">#endif // FE_SB</span>
00794 <span class="preprocessor"></span>            <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
00795         }
00796     } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, RIP_WARNING)) {
00797         <span class="keywordflow">return</span> STATUS_ACCESS_VIOLATION;
00798     }
00799 
00800     <span class="comment">/*</span>
00801 <span class="comment">     * Translation succeeded.</span>
00802 <span class="comment">     */</span>
00803 <span class="preprocessor">#ifdef FE_SB // CaptureAnsiCallbackData()</span>
00804 <span class="preprocessor"></span>    <span class="comment">/*</span>
00805 <span class="comment">     * nCharsInAnsiString is actual bytes wriiten in message area.</span>
00806 <span class="comment">     */</span>
00807     pcb-&gt;<a class="code" href="../../d4/d7/struct__CAPTUREBUF.html#o3">pbFree</a> = pbBuffer + ((nCharsInAnsiString + <a class="code" href="../../d3/d5/ssend_8c.html#a4">PADSIZE</a>) &amp; ~<a class="code" href="../../d3/d5/ssend_8c.html#a4">PADSIZE</a>);
00808     pcb-&gt;<a class="code" href="../../d4/d7/struct__CAPTUREBUF.html#o1">cbCapture</a> -= nCharsInAnsiString;
00809 <span class="preprocessor">#else</span>
00810 <span class="preprocessor"></span>    pcb-&gt;<a class="code" href="../../d4/d7/struct__CAPTUREBUF.html#o3">pbFree</a> = pbBuffer + ((cbData + <a class="code" href="../../d3/d5/ssend_8c.html#a4">PADSIZE</a>) &amp; ~<a class="code" href="../../d3/d5/ssend_8c.html#a4">PADSIZE</a>);
00811     pcb-&gt;<a class="code" href="../../d4/d7/struct__CAPTUREBUF.html#o1">cbCapture</a> -= cbData;
00812 <span class="preprocessor">#endif // FE_SB</span>
00813 <span class="preprocessor"></span>
00814     <span class="comment">/*</span>
00815 <span class="comment">     * Fix up offsets to data.  If the data is going into a section</span>
00816 <span class="comment">     * use the real pointer and don't compute offsets.</span>
00817 <span class="comment">     */</span>
00818     <span class="keywordflow">if</span> (pcb-&gt;<a class="code" href="../../d4/d7/struct__CAPTUREBUF.html#o5">pvVirtualAddress</a>)
00819         *ppDest = pbBuffer;
00820     <span class="keywordflow">else</span> {
00821         *ppDest = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)(pbBuffer - (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pcb);
00822         ((LPDWORD)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pcb + pcb-&gt;<a class="code" href="../../d4/d7/struct__CAPTUREBUF.html#o4">offPointers</a>))[pcb-&gt;<a class="code" href="../../d4/d7/struct__CAPTUREBUF.html#o2">cCapturedPointers</a>++] =
00823                 (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)ppDest - (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pcb);
00824     }
00825 
00826     <span class="keywordflow">return</span> STATUS_SUCCESS;
00827 }
00828 
00829 
00830 <span class="comment">/***************************************************************************\</span>
00831 <span class="comment">* CaptureUnicodeCallbackData</span>
00832 <span class="comment">*</span>
00833 <span class="comment">* Converts ANSI to Unicode data and captures the result</span>
00834 <span class="comment">* into a callback structure.</span>
00835 <span class="comment">*</span>
00836 <span class="comment">* 03-31-95 JimA             Created.</span>
00837 <span class="comment">\***************************************************************************/</span>
00838 
<a name="l00839"></a><a class="code" href="../../d3/d5/ssend_8c.html#a62">00839</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d3/d5/ssend_8c.html#a62">CaptureUnicodeCallbackData</a>(
00840     <a class="code" href="../../d4/d7/struct__CAPTUREBUF.html">PCAPTUREBUF</a> pcb,
00841     PVOID pData,
00842     DWORD cbData,
00843     PVOID *ppDest)
00844 {
00845     <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a> pbBuffer;
00846     ULONG nCharsInUnicodeString;
00847 
00848     <span class="comment">/*</span>
00849 <span class="comment">     * If the data pointer is NULL, the out pointer will be</span>
00850 <span class="comment">     * NULL</span>
00851 <span class="comment">     */</span>
00852     <span class="keywordflow">if</span> (pData == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00853         *ppDest = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00854         <span class="keywordflow">return</span> STATUS_SUCCESS;
00855     }
00856 
00857     <span class="comment">/*</span>
00858 <span class="comment">     * Allocate space from the message buffer</span>
00859 <span class="comment">     */</span>
00860     <span class="keywordflow">if</span> (cbData &gt; pcb-&gt;<a class="code" href="../../d4/d7/struct__CAPTUREBUF.html#o1">cbCapture</a>) {
00861         <span class="keywordflow">return</span> STATUS_BUFFER_OVERFLOW;
00862     }
00863 
00864     pbBuffer = pcb-&gt;<a class="code" href="../../d4/d7/struct__CAPTUREBUF.html#o3">pbFree</a>;
00865 
00866     <span class="comment">/*</span>
00867 <span class="comment">     * Convert the ANSI string to unicode</span>
00868 <span class="comment">     */</span>
00869     <span class="keywordflow">try</span> {
00870         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d9/d6/nlsxlat_8c.html#a33">RtlMultiByteToUnicodeN</a>(
00871                             (PWCH)pbBuffer,
00872                             cbData,
00873                             &amp;nCharsInUnicodeString,
00874                             (PCH)pData,
00875                             cbData / <span class="keyword">sizeof</span>(WCHAR)
00876                             ))) {
00877             <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
00878         }
00879     } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, RIP_WARNING)) {
00880         <span class="keywordflow">return</span> STATUS_ACCESS_VIOLATION;
00881     }
00882 
00883     <span class="comment">/*</span>
00884 <span class="comment">     * Translation succeeded.</span>
00885 <span class="comment">     */</span>
00886     pcb-&gt;<a class="code" href="../../d4/d7/struct__CAPTUREBUF.html#o3">pbFree</a> = pbBuffer + ((cbData + <a class="code" href="../../d3/d5/ssend_8c.html#a4">PADSIZE</a>) &amp; ~<a class="code" href="../../d3/d5/ssend_8c.html#a4">PADSIZE</a>);
00887     pcb-&gt;<a class="code" href="../../d4/d7/struct__CAPTUREBUF.html#o1">cbCapture</a> -= cbData;
00888 
00889     <span class="comment">/*</span>
00890 <span class="comment">     * Fix up offsets to data.  If the data is going into a section</span>
00891 <span class="comment">     * use the real pointer and don't compute offsets.</span>
00892 <span class="comment">     */</span>
00893     <span class="keywordflow">if</span> (pcb-&gt;<a class="code" href="../../d4/d7/struct__CAPTUREBUF.html#o5">pvVirtualAddress</a>)
00894         *ppDest = pbBuffer;
00895     <span class="keywordflow">else</span> {
00896         *ppDest = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)(pbBuffer - (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pcb);
00897         ((LPDWORD)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pcb + pcb-&gt;<a class="code" href="../../d4/d7/struct__CAPTUREBUF.html#o4">offPointers</a>))[pcb-&gt;<a class="code" href="../../d4/d7/struct__CAPTUREBUF.html#o2">cCapturedPointers</a>++] =
00898                 (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)ppDest - (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pcb);
00899     }
00900 
00901     <span class="keywordflow">return</span> STATUS_SUCCESS;
00902 }
00903 
00904 
00905 <span class="comment">/***************************************************************************\</span>
00906 <span class="comment">* CopyOutputString</span>
00907 <span class="comment">*</span>
00908 <span class="comment">* Copies a callback output string to the output buffer and performs</span>
00909 <span class="comment">* any necessary ANSI/Unicode translation.</span>
00910 <span class="comment">*</span>
00911 <span class="comment">* Copies up to cchLimit characters, possibly including a null terminator.</span>
00912 <span class="comment">*</span>
00913 <span class="comment">* A null terminator is placed in pstr-&gt;Buffer only if the number of (non-null)</span>
00914 <span class="comment">* characters obtained is less than cchLimit.</span>
00915 <span class="comment">* pstr-&gt;Length may be set larger than necessary: ie: it may sometimes indicate</span>
00916 <span class="comment">* a string longer than that which is null terminated. This is a deficiency in</span>
00917 <span class="comment">* the current implementation.</span>
00918 <span class="comment">*</span>
00919 <span class="comment">* 05-08-95 JimA             Created.</span>
00920 <span class="comment">\***************************************************************************/</span>
00921 
<a name="l00922"></a><a class="code" href="../../d3/d5/ssend_8c.html#a63">00922</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d3/d5/ssend_8c.html#a63">CopyOutputString</a>(
00923     <a class="code" href="../../d1/d7/struct__CALLBACKSTATUS.html">PCALLBACKSTATUS</a> pcbs,
00924     <a class="code" href="../../d1/d9/struct__LARGE__STRING.html">PLARGE_STRING</a> pstr,
00925     UINT cchLimit,
00926     BOOL fAnsi)
00927 {
00928     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> cch;
00929 
00930     <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(<a class="code" href="../../d8/d4/w32_2ntuser_2client_2callback_8c.html#a0">pcbs</a>-&gt;pOutput, <a class="code" href="../../d8/d4/w32_2ntuser_2client_2callback_8c.html#a0">pcbs</a>-&gt;cbOutput,
00931             fAnsi ? <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>) : <span class="keyword">sizeof</span>(WORD));
00932     <span class="keywordflow">if</span> (!pstr-&gt;<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o2">bAnsi</a>) {
00933         <span class="keywordflow">if</span> (fAnsi) {
00934             cch = MBToWCS((LPSTR)<a class="code" href="../../d8/d4/w32_2ntuser_2client_2callback_8c.html#a0">pcbs</a>-&gt;pOutput, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)<a class="code" href="../../d8/d4/w32_2ntuser_2client_2callback_8c.html#a0">pcbs</a>-&gt;retval,
00935                     (LPWSTR *)&amp;pstr-&gt;<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o3">Buffer</a>, cchLimit, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00936             <span class="keywordflow">if</span> (cch &lt; cchLimit) {
00937                 <span class="comment">/*</span>
00938 <span class="comment">                 * Add a null terminator and ensure an accurate pstr-&gt;Length</span>
00939 <span class="comment">                 */</span>
00940                 ((LPWSTR)pstr-&gt;<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o3">Buffer</a>)[cch] = 0;
00941                 cchLimit = cch;
00942             }
00943         } <span class="keywordflow">else</span> {
00944             cchLimit = <a class="code" href="../../d1/d5/w32_2ntuser_2rtl_2random_8c.html#a3">wcsncpycch</a>(pstr-&gt;<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o3">Buffer</a>, (LPWSTR)<a class="code" href="../../d8/d4/w32_2ntuser_2client_2callback_8c.html#a0">pcbs</a>-&gt;pOutput, cchLimit);
00945             <span class="comment">// wcsncpy(pstr-&gt;Buffer, (LPWSTR)pcbs-&gt;pOutput, cchLimit);</span>
00946         }
00947         pstr-&gt;<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o0">Length</a> = cchLimit * <span class="keyword">sizeof</span>(WCHAR);
00948     } <span class="keywordflow">else</span> {
00949         <span class="keywordflow">if</span> (fAnsi) {
00950             cchLimit = <a class="code" href="../../d1/d5/w32_2ntuser_2rtl_2random_8c.html#a4">strncpycch</a>((LPSTR)pstr-&gt;<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o3">Buffer</a>,
00951             <span class="comment">// strncpy((LPSTR)pstr-&gt;Buffer,</span>
00952                     (LPSTR)<a class="code" href="../../d8/d4/w32_2ntuser_2client_2callback_8c.html#a0">pcbs</a>-&gt;pOutput, cchLimit);
00953         } <span class="keywordflow">else</span> {
00954             cch = WCSToMB((LPWSTR)<a class="code" href="../../d8/d4/w32_2ntuser_2client_2callback_8c.html#a0">pcbs</a>-&gt;pOutput, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)<a class="code" href="../../d8/d4/w32_2ntuser_2client_2callback_8c.html#a0">pcbs</a>-&gt;retval,
00955                     (LPSTR *)&amp;pstr-&gt;<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o3">Buffer</a>, cchLimit, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00956             <span class="keywordflow">if</span> (cch &lt; cchLimit) {
00957                 <span class="comment">/*</span>
00958 <span class="comment">                 * Add a null terminator and ensure an accurate pstr-&gt;Length</span>
00959 <span class="comment">                 */</span>
00960                 ((LPSTR)pstr-&gt;<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o3">Buffer</a>)[cch] = 0;
00961                 cchLimit = cch;
00962             }
00963         }
00964         pstr-&gt;<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o0">Length</a> = cchLimit;
00965     }
00966 }
00967 
00968 <span class="preprocessor">#ifdef FE_SB // CalcOutputStringSize()</span>
00969 <span class="preprocessor"></span><span class="comment">/***************************************************************************\</span>
00970 <span class="comment">* CalcOutputStringSize()</span>
00971 <span class="comment">*</span>
00972 <span class="comment">* Copies a callback output string to the output buffer and performs</span>
00973 <span class="comment">* any necessary ANSI/Unicode translation.</span>
00974 <span class="comment">*</span>
00975 <span class="comment">* 03-14-96 HideyukN             Created.</span>
00976 <span class="comment">\***************************************************************************/</span>
00977 
00978 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> CalcOutputStringSize(
00979     <a class="code" href="../../d1/d7/struct__CALLBACKSTATUS.html">PCALLBACKSTATUS</a> pcbs,
00980     DWORD cchText,
00981     BOOL fAnsiSender,
00982     BOOL fAnsiReceiver)
00983 {
00984     ULONG cch;
00985 
00986     <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(<a class="code" href="../../d8/d4/w32_2ntuser_2client_2callback_8c.html#a0">pcbs</a>-&gt;pOutput, <a class="code" href="../../d8/d4/w32_2ntuser_2client_2callback_8c.html#a0">pcbs</a>-&gt;cbOutput,
00987             fAnsiReceiver ? <span class="keyword">sizeof</span>(BYTE) : <span class="keyword">sizeof</span>(WORD));
00988     <span class="keywordflow">if</span> (!fAnsiSender) {
00989         <span class="keywordflow">if</span> (fAnsiReceiver) {
00990             <a class="code" href="../../d9/d6/nlsxlat_8c.html#a35">RtlMultiByteToUnicodeSize</a>(&amp;cch,(LPSTR)<a class="code" href="../../d8/d4/w32_2ntuser_2client_2callback_8c.html#a0">pcbs</a>-&gt;pOutput,cchText);
00991             cch /= <span class="keyword">sizeof</span>(WCHAR);
00992         } <span class="keywordflow">else</span> {
00993             cch = cchText;
00994         }
00995     } <span class="keywordflow">else</span> {
00996         <span class="keywordflow">if</span> (fAnsiReceiver) {
00997             cch = cchText;
00998         } <span class="keywordflow">else</span> {
00999             <a class="code" href="../../d9/d6/nlsxlat_8c.html#a36">RtlUnicodeToMultiByteSize</a>(&amp;cch,(LPWSTR)<a class="code" href="../../d8/d4/w32_2ntuser_2client_2callback_8c.html#a0">pcbs</a>-&gt;pOutput,cchText * <span class="keyword">sizeof</span>(WCHAR));
01000         }
01001     }
01002 
01003     <span class="keywordflow">return</span> ((<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)cch);
01004 }
01005 <span class="preprocessor">#endif // FE_SB</span>
01006 <span class="preprocessor"></span>
01007 <span class="comment">/**************************************************************************\</span>
01008 <span class="comment">*</span>
01009 <span class="comment">* include the stub definition file</span>
01010 <span class="comment">*</span>
01011 <span class="comment">\**************************************************************************/</span>
01012 
01013 <span class="preprocessor">#include "<a class="code" href="../../d9/d7/ntcb_8h.html">ntcb.h</a>"</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:51 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
