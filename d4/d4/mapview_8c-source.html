<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: mapview.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>mapview.c</h1><a href="../../d3/d5/mapview_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">   mapview.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains the routines which implement the</span>
00012 <span class="comment">    NtMapViewOfSection service.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Lou Perazzoli (loup) 22-May-1989</span>
00017 <span class="comment">    Landy Wang (landyw) 02-June-1997</span>
00018 <span class="comment"></span>
00019 <span class="comment">Revision History:</span>
00020 <span class="comment"></span>
00021 <span class="comment">--*/</span>
00022 
00023 <span class="preprocessor">#include "<a class="code" href="../../d4/d8/mi_8h.html">mi.h</a>"</span>
00024 
<a name="l00025"></a><a class="code" href="../../d3/d5/mapview_8c.html#a2">00025</a> ULONG <a class="code" href="../../d3/d5/mapview_8c.html#a2">MMPPTE_NAME</a> = 'tPmM'; <span class="comment">//MmPt</span>
<a name="l00026"></a><a class="code" href="../../d3/d5/mapview_8c.html#a3">00026</a> ULONG <a class="code" href="../../d3/d5/mapview_8c.html#a3">MMDB</a> = 'bDmM';
<a name="l00027"></a><a class="code" href="../../d3/d5/mapview_8c.html#a4">00027</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d3/d6/allocvm_8c.html#a0">MMVADKEY</a>;
00028 
00029 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00030 <a class="code" href="../../d3/d5/mapview_8c.html#a9">MiSetPageModified</a> (
00031     IN PVOID Address
00032     );
00033 
<a name="l00034"></a><a class="code" href="../../d3/d5/mapview_8c.html#a5">00034</a> <span class="keyword">extern</span> LIST_ENTRY <a class="code" href="../../d6/d8/sysinfo_8c.html#a20">MmLoadedUserImageList</a>;
00035 
<a name="l00036"></a><a class="code" href="../../d3/d5/mapview_8c.html#a0">00036</a> <span class="preprocessor">#define X256MEG (256*1024*1024)</span>
00037 <span class="preprocessor"></span>
00038 <span class="preprocessor">#if DBG</span>
00039 <span class="preprocessor"></span><span class="keyword">extern</span> <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> MmWatchProcess;
00040 <span class="preprocessor">#endif // DBG</span>
00041 <span class="preprocessor"></span>
<a name="l00042"></a><a class="code" href="../../d3/d5/mapview_8c.html#a1">00042</a> <span class="preprocessor">#define ROUND_TO_PAGES64(Size)  (((UINT64)(Size) + PAGE_SIZE - 1) &amp; ~(PAGE_SIZE - 1))</span>
00043 <span class="preprocessor"></span>
<a name="l00044"></a><a class="code" href="../../d3/d5/mapview_8c.html#a6">00044</a> <a class="code" href="../../d0/d6/struct__MMSESSION.html">MMSESSION</a>   <a class="code" href="../../d3/d5/mapview_8c.html#a6">MmSession</a>;
00045 
00046 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00047 <a class="code" href="../../d3/d5/mapview_8c.html#a23">MiMapViewOfImageSection</a> (
00048     IN <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea,
00049     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
00050     IN PVOID *CapturedBase,
00051     IN PLARGE_INTEGER SectionOffset,
00052     IN PSIZE_T CapturedViewSize,
00053     IN PSECTION Section,
00054     IN SECTION_INHERIT InheritDisposition,
00055     IN ULONG_PTR ZeroBits,
00056     IN SIZE_T ImageCommitment,
00057     OUT PBOOLEAN ReleasedWsMutex
00058     );
00059 
00060 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00061 <a class="code" href="../../d3/d5/mapview_8c.html#a24">MiMapViewOfDataSection</a> (
00062     IN <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea,
00063     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
00064     IN PVOID *CapturedBase,
00065     IN PLARGE_INTEGER SectionOffset,
00066     IN PSIZE_T CapturedViewSize,
00067     IN PSECTION Section,
00068     IN SECTION_INHERIT InheritDisposition,
00069     IN ULONG ProtectionMask,
00070     IN SIZE_T CommitSize,
00071     IN ULONG_PTR ZeroBits,
00072     IN ULONG AllocationType,
00073     OUT PBOOLEAN ReleasedWsMutex
00074     );
00075 
00076 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00077 <a class="code" href="../../d3/d5/mapview_8c.html#a12">MiRemoveMappedPtes</a> (
00078     IN PVOID BaseAddress,
00079     IN ULONG NumberOfPtes,
00080     IN <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea,
00081     IN <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> WorkingSetInfo
00082     );
00083 
00084 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00085 <a class="code" href="../../d3/d5/mapview_8c.html#a13">MiMapViewInSystemSpace</a> (
00086     IN PVOID Section,
00087     IN <a class="code" href="../../d0/d6/struct__MMSESSION.html">PMMSESSION</a> Session,
00088     OUT PVOID *MappedBase,
00089     IN OUT PSIZE_T ViewSize
00090     );
00091 
00092 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00093 <a class="code" href="../../d3/d5/mapview_8c.html#a14">MiUnmapViewInSystemSpace</a> (
00094     IN <a class="code" href="../../d0/d6/struct__MMSESSION.html">PMMSESSION</a> Session,
00095     IN PVOID MappedBase
00096     );
00097 
00098 BOOLEAN
00099 <a class="code" href="../../d3/d5/mapview_8c.html#a15">MiFillSystemPageDirectory</a> (
00100     PVOID Base,
00101     SIZE_T NumberOfBytes
00102     );
00103 
00104 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00105 <a class="code" href="../../d5/d5/sectsup_8c.html#a12">VadTreeWalk</a> (
00106     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Start
00107     );
00108 
00109 <span class="preprocessor">#if DBG</span>
00110 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00111 MiDumpConflictingVad(
00112     IN PVOID StartingAddress,
00113     IN PVOID EndingAddress,
00114     IN <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Vad
00115     );
00116 
00117 
00118 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00119 MiDumpConflictingVad(
00120     IN PVOID StartingAddress,
00121     IN PVOID EndingAddress,
00122     IN <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Vad
00123     )
00124 {
00125     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_SHOW_LDR_SNAPS) {
00126         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"MM: [%p ... %p) conflicted with Vad %p\n"</span>,
00127                   StartingAddress, EndingAddress, Vad);
00128         <span class="keywordflow">if</span> ((Vad-&gt;u.VadFlags.PrivateMemory == 1) ||
00129             (Vad-&gt;ControlArea == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00130             <span class="keywordflow">return</span>;
00131         }
00132         <span class="keywordflow">if</span> (Vad-&gt;ControlArea-&gt;u.Flags.Image)
00133             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"    conflict with %Z image at [%p .. %p)\n"</span>,
00134                       &amp;Vad-&gt;ControlArea-&gt;FilePointer-&gt;FileName,
00135                       <a class="code" href="../../d4/d8/mi_8h.html#a108">MI_VPN_TO_VA</a> (Vad-&gt;StartingVpn),
00136                       <a class="code" href="../../d4/d8/mi_8h.html#a109">MI_VPN_TO_VA_ENDING</a> (Vad-&gt;EndingVpn)
00137                     );
00138         <span class="keywordflow">else</span>
00139         <span class="keywordflow">if</span> (Vad-&gt;ControlArea-&gt;u.Flags.File)
00140             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"    conflict with %Z file at [%p .. %p)\n"</span>,
00141                       &amp;Vad-&gt;ControlArea-&gt;FilePointer-&gt;FileName,
00142                       <a class="code" href="../../d4/d8/mi_8h.html#a108">MI_VPN_TO_VA</a> (Vad-&gt;StartingVpn),
00143                       <a class="code" href="../../d4/d8/mi_8h.html#a109">MI_VPN_TO_VA_ENDING</a> (Vad-&gt;EndingVpn)
00144                     );
00145         <span class="keywordflow">else</span>
00146             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"    conflict with section at [%p .. %p)\n"</span>,
00147                       MI_VPN_TO_VA (Vad-&gt;StartingVpn),
00148                       <a class="code" href="../../d4/d8/mi_8h.html#a109">MI_VPN_TO_VA_ENDING</a> (Vad-&gt;EndingVpn)
00149                     );
00150     }
00151 }
00152 <span class="preprocessor">#endif //DBG</span>
00153 <span class="preprocessor"></span>
00154 
00155 ULONG
00156 <a class="code" href="../../d8/d8/sysload_8c.html#a30">CacheImageSymbols</a>(
00157     IN PVOID ImageBase
00158     );
00159 
00160 PVOID
00161 <a class="code" href="../../d3/d5/mapview_8c.html#a18">MiInsertInSystemSpace</a> (
00162     IN <a class="code" href="../../d0/d6/struct__MMSESSION.html">PMMSESSION</a> Session,
00163     IN ULONG SizeIn64k,
00164     IN <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea
00165     );
00166 
00167 ULONG
00168 <a class="code" href="../../d3/d5/mapview_8c.html#a19">MiRemoveFromSystemSpace</a> (
00169     IN <a class="code" href="../../d0/d6/struct__MMSESSION.html">PMMSESSION</a> Session,
00170     IN PVOID Base,
00171     OUT <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> *ControlArea
00172     );
00173 
00174 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00175 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtMapViewOfSection)</span>
00176 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,MmMapViewOfSection)</span>
00177 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,MmSecureVirtualMemory)</span>
00178 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,MmUnsecureVirtualMemory)</span>
00179 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CacheImageSymbols)</span>
00180 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtAreMappedFilesTheSame)</span>
00181 <span class="preprocessor"></span>
00182 <span class="preprocessor">#pragma alloc_text(PAGELK,MiMapViewOfPhysicalSection)</span>
00183 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGELK,MiMapViewInSystemSpace)</span>
00184 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGELK,MmMapViewInSystemSpace)</span>
00185 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGELK,MmMapViewInSessionSpace)</span>
00186 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGELK,MiUnmapViewInSystemSpace)</span>
00187 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGELK,MmUnmapViewInSystemSpace)</span>
00188 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGELK,MmUnmapViewInSessionSpace)</span>
00189 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGELK,MiFillSystemPageDirectory)</span>
00190 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGELK,MiInsertInSystemSpace)</span>
00191 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGELK,MiRemoveFromSystemSpace)</span>
00192 <span class="preprocessor"></span>
00193 <span class="preprocessor">#pragma alloc_text(PAGEHYDRA,MiInitializeSystemSpaceMap)</span>
00194 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEHYDRA, MiFreeSessionSpaceMap)</span>
00195 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00196 <span class="preprocessor"></span>
00197 
00198 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00199"></a><a class="code" href="../../d3/d5/mapview_8c.html#a20">00199</a> <a class="code" href="../../d3/d5/mapview_8c.html#a20">NtMapViewOfSection</a>(
00200     IN HANDLE SectionHandle,
00201     IN HANDLE ProcessHandle,
00202     IN OUT PVOID *BaseAddress,
00203     IN ULONG_PTR ZeroBits,
00204     IN SIZE_T CommitSize,
00205     IN OUT PLARGE_INTEGER SectionOffset OPTIONAL,
00206     IN OUT PSIZE_T ViewSize,
00207     IN SECTION_INHERIT InheritDisposition,
00208     IN ULONG AllocationType,
00209     IN ULONG Protect
00210     )
00211 
00212 <span class="comment">/*++</span>
00213 <span class="comment"></span>
00214 <span class="comment">Routine Description:</span>
00215 <span class="comment"></span>
00216 <span class="comment">    This function maps a view in the specified subject process to</span>
00217 <span class="comment">    the section object.</span>
00218 <span class="comment"></span>
00219 <span class="comment">Arguments:</span>
00220 <span class="comment"></span>
00221 <span class="comment">    SectionHandle - Supplies an open handle to a section object.</span>
00222 <span class="comment"></span>
00223 <span class="comment">    ProcessHandle - Supplies an open handle to a process object.</span>
00224 <span class="comment"></span>
00225 <span class="comment">    BaseAddress - Supplies a pointer to a variable that will receive</span>
00226 <span class="comment">                  the base address of the view. If the initial value</span>
00227 <span class="comment">                  of this argument is not null, then the view will</span>
00228 <span class="comment">                  be allocated starting at the specified virtual</span>
00229 <span class="comment">                  address rounded down to the next 64kb address</span>
00230 <span class="comment">                  boundary. If the initial value of this argument is</span>
00231 <span class="comment">                  null, then the operating system will determine</span>
00232 <span class="comment">                  where to allocate the view using the information</span>
00233 <span class="comment">                  specified by the ZeroBits argument value and the</span>
00234 <span class="comment">                  section allocation attributes (i.e. based and</span>
00235 <span class="comment">                  tiled).</span>
00236 <span class="comment">        </span>
00237 <span class="comment">    ZeroBits - Supplies the number of high order address bits that</span>
00238 <span class="comment">               must be zero in the base address of the section</span>
00239 <span class="comment">               view. The value of this argument must be less than</span>
00240 <span class="comment">               or equal to the maximum number of zero bits and is only</span>
00241 <span class="comment">               used when memory management determines where to allocate</span>
00242 <span class="comment">               the view (i.e. when BaseAddress is null).</span>
00243 <span class="comment">        </span>
00244 <span class="comment">               If ZeroBits is zero, then no zero bit constraints are applied.</span>
00245 <span class="comment"></span>
00246 <span class="comment">               If ZeroBits is greater than 0 and less than 32, then it is</span>
00247 <span class="comment">               the number of leading zero bits from bit 31.  Bits 63:32 are</span>
00248 <span class="comment">               also required to be zero.  This retains compatibility</span>
00249 <span class="comment">               with 32-bit systems.</span>
00250 <span class="comment">                </span>
00251 <span class="comment">               If ZeroBits is greater than 32, then it is considered as</span>
00252 <span class="comment">               a mask and then number of leading zero are counted out</span>
00253 <span class="comment">               in the mask.  This then becomes the zero bits argument.</span>
00254 <span class="comment"></span>
00255 <span class="comment">    CommitSize - Supplies the size of the initially committed region</span>
00256 <span class="comment">                 of the view in bytes. This value is rounded up to</span>
00257 <span class="comment">                 the next host page size boundary.</span>
00258 <span class="comment"></span>
00259 <span class="comment">    SectionOffset - Supplies the offset from the beginning of the</span>
00260 <span class="comment">                    section to the view in bytes. This value is</span>
00261 <span class="comment">                    rounded down to the next host page size boundary.</span>
00262 <span class="comment"></span>
00263 <span class="comment">    ViewSize - Supplies a pointer to a variable that will receive</span>
00264 <span class="comment">               the actual size in bytes of the view. If the value</span>
00265 <span class="comment">               of this argument is zero, then a view of the</span>
00266 <span class="comment">               section will be mapped starting at the specified</span>
00267 <span class="comment">               section offset and continuing to the end of the</span>
00268 <span class="comment">               section. Otherwise the initial value of this</span>
00269 <span class="comment">               argument specifies the size of the view in bytes</span>
00270 <span class="comment">               and is rounded up to the next host page size</span>
00271 <span class="comment">               boundary.</span>
00272 <span class="comment">        </span>
00273 <span class="comment">    InheritDisposition - Supplies a value that specifies how the</span>
00274 <span class="comment">                         view is to be shared by a child process created</span>
00275 <span class="comment">                         with a create process operation.</span>
00276 <span class="comment"></span>
00277 <span class="comment">        InheritDisposition Values</span>
00278 <span class="comment"></span>
00279 <span class="comment">         ViewShare - Inherit view and share a single copy</span>
00280 <span class="comment">              of the committed pages with a child process</span>
00281 <span class="comment">              using the current protection value.</span>
00282 <span class="comment"></span>
00283 <span class="comment">         ViewUnmap - Do not map the view into a child process.</span>
00284 <span class="comment"></span>
00285 <span class="comment">    AllocationType - Supplies the type of allocation.</span>
00286 <span class="comment"></span>
00287 <span class="comment">         MEM_TOP_DOWN</span>
00288 <span class="comment">         MEM_DOS_LIM</span>
00289 <span class="comment">         MEM_LARGE_PAGES</span>
00290 <span class="comment">         MEM_RESERVE - for file mapped sections only.</span>
00291 <span class="comment"></span>
00292 <span class="comment">    Protect - Supplies the protection desired for the region of</span>
00293 <span class="comment">              initially committed pages.</span>
00294 <span class="comment"></span>
00295 <span class="comment">        Protect Values</span>
00296 <span class="comment"></span>
00297 <span class="comment"></span>
00298 <span class="comment">         PAGE_NOACCESS - No access to the committed region</span>
00299 <span class="comment">              of pages is allowed. An attempt to read,</span>
00300 <span class="comment">              write, or execute the committed region</span>
00301 <span class="comment">              results in an access violation (i.e. a GP</span>
00302 <span class="comment">              fault).</span>
00303 <span class="comment"></span>
00304 <span class="comment">         PAGE_EXECUTE - Execute access to the committed</span>
00305 <span class="comment">              region of pages is allowed. An attempt to</span>
00306 <span class="comment">              read or write the committed region results in</span>
00307 <span class="comment">              an access violation.</span>
00308 <span class="comment"></span>
00309 <span class="comment">         PAGE_READONLY - Read only and execute access to the</span>
00310 <span class="comment">              committed region of pages is allowed. An</span>
00311 <span class="comment">              attempt to write the committed region results</span>
00312 <span class="comment">              in an access violation.</span>
00313 <span class="comment"></span>
00314 <span class="comment">         PAGE_READWRITE - Read, write, and execute access to</span>
00315 <span class="comment">              the region of committed pages is allowed. If</span>
00316 <span class="comment">              write access to the underlying section is</span>
00317 <span class="comment">              allowed, then a single copy of the pages are</span>
00318 <span class="comment">              shared. Otherwise the pages are shared read</span>
00319 <span class="comment">              only/copy on write.</span>
00320 <span class="comment"></span>
00321 <span class="comment">Return Value:</span>
00322 <span class="comment"></span>
00323 <span class="comment">    Various NTSTATUS codes.</span>
00324 <span class="comment"></span>
00325 <span class="comment">--*/</span>
00326 
00327 {
00328     <a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a> Section;
00329     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
00330     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00331     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00332     PVOID CapturedBase;
00333     SIZE_T CapturedViewSize;
00334     LARGE_INTEGER TempViewSize;
00335     LARGE_INTEGER CapturedOffset;
00336     ULONGLONG HighestPhysicalAddressInPfnDatabase;
00337     ACCESS_MASK DesiredSectionAccess;
00338     ULONG ProtectMaskForAccess;
00339     BOOLEAN WriteCombined;
00340 
00341     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00342 
00343     <span class="comment">//</span>
00344     <span class="comment">// Check the zero bits argument for correctness.</span>
00345     <span class="comment">//</span>
00346 
00347 <span class="preprocessor">#if defined (_WIN64)</span>
00348 <span class="preprocessor"></span>
00349     <span class="keywordflow">if</span> (ZeroBits &gt;= 32) {
00350 
00351         <span class="comment">//</span>
00352         <span class="comment">// ZeroBits is a mask instead of a count.  Translate it to a count now.</span>
00353         <span class="comment">//</span>
00354 
00355         ZeroBits = 64 - <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a44">RtlFindMostSignificantBit</a> (ZeroBits);        
00356     }
00357     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ZeroBits) {
00358         ZeroBits += 32;
00359     }
00360 
00361 <span class="preprocessor">#endif</span>
00362 <span class="preprocessor"></span>
00363     <span class="keywordflow">if</span> (ZeroBits &gt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a10">MM_MAXIMUM_ZERO_BITS</a>) {
00364         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_4;
00365     }
00366 
00367     <span class="comment">//</span>
00368     <span class="comment">// Check the inherit disposition flags.</span>
00369     <span class="comment">//</span>
00370 
00371     <span class="keywordflow">if</span> ((InheritDisposition &gt; ViewUnmap) ||
00372         (InheritDisposition &lt; ViewShare)) {
00373         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_8;
00374     }
00375 
00376     <span class="comment">//</span>
00377     <span class="comment">// Check the allocation type field.</span>
00378     <span class="comment">//</span>
00379 
00380 <span class="preprocessor">#ifdef i386</span>
00381 <span class="preprocessor"></span>
00382     <span class="comment">//</span>
00383     <span class="comment">// Only allow DOS_LIM support for i386.  The MEM_DOS_LIM flag allows</span>
00384     <span class="comment">// map views of data sections to be done on 4k boundaries rather</span>
00385     <span class="comment">// than 64k boundaries.</span>
00386     <span class="comment">//</span>
00387 
00388     <span class="keywordflow">if</span> ((AllocationType &amp; ~(MEM_TOP_DOWN | MEM_LARGE_PAGES | MEM_DOS_LIM |
00389            SEC_NO_CHANGE | MEM_RESERVE)) != 0) {
00390         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_9;
00391     }
00392 <span class="preprocessor">#else</span>
00393 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ((AllocationType &amp; ~(MEM_TOP_DOWN | MEM_LARGE_PAGES |
00394            SEC_NO_CHANGE | MEM_RESERVE)) != 0) {
00395         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_9;
00396     }
00397 
00398 <span class="preprocessor">#endif //i386</span>
00399 <span class="preprocessor"></span>
00400     <span class="comment">//</span>
00401     <span class="comment">// Check the protection field.  This could raise an exception.</span>
00402     <span class="comment">//</span>
00403 
00404     <span class="keywordflow">if</span> (Protect &amp; PAGE_WRITECOMBINE) {
00405         Protect &amp;= ~PAGE_WRITECOMBINE;
00406         WriteCombined = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00407     }
00408     <span class="keywordflow">else</span> {
00409         WriteCombined = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00410     }
00411 
00412     <span class="keywordflow">try</span> {
00413         ProtectMaskForAccess = <a class="code" href="../../d0/d2/mmsup_8c.html#a5">MiMakeProtectionMask</a> (Protect) &amp; 0x7;
00414     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00415         <span class="keywordflow">return</span> GetExceptionCode();
00416     }
00417 
00418     DesiredSectionAccess = <a class="code" href="../../d4/d8/mi_8h.html#a414">MmMakeSectionAccess</a>[ProtectMaskForAccess];
00419 
00420     PreviousMode = KeGetPreviousMode();
00421 
00422     <span class="comment">//</span>
00423     <span class="comment">// Establish an exception handler, probe the specified addresses</span>
00424     <span class="comment">// for write access and capture the initial values.</span>
00425     <span class="comment">//</span>
00426 
00427     <span class="keywordflow">try</span> {
00428         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00429             <a class="code" href="../../d5/d8/ex_8h.html#a37">ProbeForWritePointer</a> ((PULONG)BaseAddress);
00430             <a class="code" href="../../d5/d8/ex_8h.html#a41">ProbeForWriteUlong_ptr</a> (ViewSize);
00431 
00432         }
00433 
00434         <span class="keywordflow">if</span> (ARGUMENT_PRESENT (SectionOffset)) {
00435             <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00436                 <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a> (SectionOffset,
00437                                <span class="keyword">sizeof</span>(LARGE_INTEGER),
00438                                <span class="keyword">sizeof</span>(ULONG_PTR));
00439             }
00440             CapturedOffset = *SectionOffset;
00441         } <span class="keywordflow">else</span> {
00442             <a class="code" href="../../d4/d8/mi_8h.html#a166">ZERO_LARGE</a> (CapturedOffset);
00443         }
00444 
00445         <span class="comment">//</span>
00446         <span class="comment">// Capture the base address.</span>
00447         <span class="comment">//</span>
00448 
00449         CapturedBase = *BaseAddress;
00450 
00451         <span class="comment">//</span>
00452         <span class="comment">// Capture the region size.</span>
00453         <span class="comment">//</span>
00454 
00455         CapturedViewSize = *ViewSize;
00456 
00457     } except (<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00458 
00459         <span class="comment">//</span>
00460         <span class="comment">// If an exception occurs during the probe or capture</span>
00461         <span class="comment">// of the initial values, then handle the exception and</span>
00462         <span class="comment">// return the exception code as the status value.</span>
00463         <span class="comment">//</span>
00464 
00465         <span class="keywordflow">return</span> GetExceptionCode();
00466     }
00467 
00468 <span class="preprocessor">#if DBG</span>
00469 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a81">MM_DBG_SHOW_NT_CALLS</a>) {
00470         <span class="keywordflow">if</span> ( !MmWatchProcess ) {
00471             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"mapview process handle %lx section %lx base address %p zero bits %lx\n"</span>,
00472                 ProcessHandle, SectionHandle, CapturedBase, ZeroBits);
00473             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    view size %p offset %p commitsize %p  protect %lx\n"</span>,
00474                 CapturedViewSize, CapturedOffset, CommitSize, Protect);
00475             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    Inheritdisp %lx  Allocation type %lx\n"</span>,
00476                 InheritDisposition, AllocationType);
00477         }
00478     }
00479 <span class="preprocessor">#endif</span>
00480 <span class="preprocessor"></span>
00481     <span class="comment">//</span>
00482     <span class="comment">// Make sure the specified starting and ending addresses are</span>
00483     <span class="comment">// within the user part of the virtual address space.</span>
00484     <span class="comment">//</span>
00485 
00486     <span class="keywordflow">if</span> (CapturedBase &gt; <a class="code" href="../../d4/d8/mi_8h.html#a19">MM_HIGHEST_VAD_ADDRESS</a>) {
00487 
00488         <span class="comment">//</span>
00489         <span class="comment">// Invalid base address.</span>
00490         <span class="comment">//</span>
00491 
00492         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_3;
00493     }
00494 
00495     <span class="keywordflow">if</span> (((ULONG_PTR)<a class="code" href="../../d4/d8/mi_8h.html#a19">MM_HIGHEST_VAD_ADDRESS</a> - (ULONG_PTR)CapturedBase) &lt;
00496                                                         CapturedViewSize) {
00497 
00498         <span class="comment">//</span>
00499         <span class="comment">// Invalid region size;</span>
00500         <span class="comment">//</span>
00501 
00502         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_3;
00503 
00504     }
00505 
00506     <span class="keywordflow">if</span> (((ULONG_PTR)CapturedBase + CapturedViewSize) &gt; ((ULONG_PTR)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a9">MM_USER_ADDRESS_RANGE_LIMIT</a> &gt;&gt; ZeroBits)) {
00507 
00508         <span class="comment">//</span>
00509         <span class="comment">// Desired Base and zero_bits conflict.</span>
00510         <span class="comment">//</span>
00511 
00512         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_4;
00513     }
00514 
00515     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a> ( ProcessHandle,
00516                                          PROCESS_VM_OPERATION,
00517                                          <a class="code" href="../../d9/d8/ntos_8h.html#a2">PsProcessType</a>,
00518                                          PreviousMode,
00519                                          (PVOID *)&amp;Process,
00520                                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00521     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00522         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00523     }
00524 
00525     <span class="comment">//</span>
00526     <span class="comment">// Reference the section object, if a view is mapped to the section</span>
00527     <span class="comment">// object, the object is not dereferenced as the virtual address</span>
00528     <span class="comment">// descriptor contains a pointer to the section object.</span>
00529     <span class="comment">//</span>
00530 
00531     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a> ( SectionHandle,
00532                                          DesiredSectionAccess,
00533                                          <a class="code" href="../../d2/d1/mm_8h.html#a133">MmSectionObjectType</a>,
00534                                          PreviousMode,
00535                                          (PVOID *)&amp;Section,
00536                                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00537 
00538     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00539         <span class="keywordflow">goto</span> ErrorReturn1;
00540     }
00541 
00542     <span class="keywordflow">if</span> (Section-&gt;u.Flags.Image == 0) {
00543 
00544         <span class="comment">//</span>
00545         <span class="comment">// This is not an image section, make sure the section page</span>
00546         <span class="comment">// protection is compatible with the specified page protection.</span>
00547         <span class="comment">//</span>
00548 
00549         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d2/mmsup_8c.html#a4">MiIsProtectionCompatible</a> (Section-&gt;InitialPageProtection,
00550                                        Protect)) {
00551             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SECTION_PROTECTION;
00552             <span class="keywordflow">goto</span> ErrorReturn;
00553         }
00554     }
00555 
00556     <span class="comment">//</span>
00557     <span class="comment">// Check to see if this the section backs physical memory, if</span>
00558     <span class="comment">// so DON'T align the offset on a 64K boundary, just a 4k boundary.</span>
00559     <span class="comment">//</span>
00560 
00561     <span class="keywordflow">if</span> (Section-&gt;Segment-&gt;ControlArea-&gt;u.Flags.PhysicalMemory) {
00562         HighestPhysicalAddressInPfnDatabase = (ULONGLONG)<a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a> &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
00563         CapturedOffset.LowPart = CapturedOffset.LowPart &amp; ~(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1);
00564 
00565         <span class="comment">//</span>
00566         <span class="comment">// No usermode mappings past the end of the PFN database are allowed.</span>
00567         <span class="comment">// Address wrap is checked in the common path.</span>
00568         <span class="comment">//</span>
00569 
00570         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00571 
00572             <span class="keywordflow">if</span> ((ULONGLONG)(CapturedOffset.QuadPart + CapturedViewSize) &gt; HighestPhysicalAddressInPfnDatabase) {
00573                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER_6;
00574                 <span class="keywordflow">goto</span> ErrorReturn;
00575             }
00576         }
00577 
00578     } <span class="keywordflow">else</span> {
00579 
00580         <span class="comment">//</span>
00581         <span class="comment">// Make sure alignments are correct for specified address</span>
00582         <span class="comment">// and offset into the file.</span>
00583         <span class="comment">//</span>
00584 
00585         <span class="keywordflow">if</span> ((AllocationType &amp; MEM_DOS_LIM) == 0) {
00586             <span class="keywordflow">if</span> (((ULONG_PTR)CapturedBase &amp; (<a class="code" href="../../d4/d8/mi_8h.html#a18">X64K</a> - 1)) != 0) {
00587                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_MAPPED_ALIGNMENT;
00588                 <span class="keywordflow">goto</span> ErrorReturn;
00589             }
00590 
00591             <span class="keywordflow">if</span> ((ARGUMENT_PRESENT (SectionOffset)) &amp;&amp;
00592                 ((CapturedOffset.LowPart &amp; (<a class="code" href="../../d4/d8/mi_8h.html#a18">X64K</a> - 1)) != 0)) {
00593                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_MAPPED_ALIGNMENT;
00594                 <span class="keywordflow">goto</span> ErrorReturn;
00595             }
00596         }
00597     }
00598 
00599     <span class="comment">//</span>
00600     <span class="comment">// Check to make sure the view size plus the offset is less</span>
00601     <span class="comment">// than the size of the section.</span>
00602     <span class="comment">//</span>
00603 
00604     <span class="keywordflow">if</span> ((ULONGLONG) (CapturedOffset.QuadPart + CapturedViewSize) &lt;
00605         (ULONGLONG)CapturedOffset.QuadPart) {
00606 
00607         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_VIEW_SIZE;
00608         <span class="keywordflow">goto</span> ErrorReturn;
00609     }
00610 
00611     <span class="keywordflow">if</span> (((ULONGLONG) (CapturedOffset.QuadPart + CapturedViewSize) &gt;
00612                  (ULONGLONG)Section-&gt;SizeOfSection.QuadPart) &amp;&amp;
00613         ((AllocationType &amp; MEM_RESERVE) == 0)) {
00614 
00615         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_VIEW_SIZE;
00616         <span class="keywordflow">goto</span> ErrorReturn;
00617     }
00618 
00619     <span class="keywordflow">if</span> (CapturedViewSize == 0) {
00620 
00621         <span class="comment">//</span>
00622         <span class="comment">// Set the view size to be size of the section less the offset.</span>
00623         <span class="comment">//</span>
00624 
00625         TempViewSize.QuadPart = Section-&gt;SizeOfSection.QuadPart -
00626                                                 CapturedOffset.QuadPart;
00627 
00628         CapturedViewSize = (SIZE_T)TempViewSize.QuadPart;
00629 
00630         <span class="keywordflow">if</span> (
00631 
00632 <span class="preprocessor">#if !defined(_WIN64)</span>
00633 <span class="preprocessor"></span>
00634             (TempViewSize.HighPart != 0) ||
00635 
00636 <span class="preprocessor">#endif</span>
00637 <span class="preprocessor"></span>
00638             (((ULONG_PTR)<a class="code" href="../../d4/d8/mi_8h.html#a19">MM_HIGHEST_VAD_ADDRESS</a> - (ULONG_PTR)CapturedBase) &lt;
00639                                                         CapturedViewSize)) {
00640 
00641             <span class="comment">//</span>
00642             <span class="comment">// Invalid region size;</span>
00643             <span class="comment">//</span>
00644 
00645             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_VIEW_SIZE;
00646             <span class="keywordflow">goto</span> ErrorReturn;
00647         }
00648     }
00649 
00650     <span class="comment">//</span>
00651     <span class="comment">// Check commit size.</span>
00652     <span class="comment">//</span>
00653 
00654     <span class="keywordflow">if</span> ((CommitSize &gt; CapturedViewSize) &amp;&amp;
00655         ((AllocationType &amp; MEM_RESERVE) == 0)) {
00656         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER_5;
00657         <span class="keywordflow">goto</span> ErrorReturn;
00658     }
00659 
00660     <span class="keywordflow">if</span> (WriteCombined == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00661         Protect |= PAGE_WRITECOMBINE;
00662     }
00663 
00664     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d5/mapview_8c.html#a21">MmMapViewOfSection</a> ( (PVOID)Section,
00665                                   Process,
00666                                   &amp;CapturedBase,
00667                                   ZeroBits,
00668                                   CommitSize,
00669                                   &amp;CapturedOffset,
00670                                   &amp;CapturedViewSize,
00671                                   InheritDisposition,
00672                                   AllocationType,
00673                                   Protect);
00674 
00675     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
00676         <span class="keywordflow">if</span> ( (Section-&gt;Segment-&gt;ControlArea-&gt;u.Flags.Image) &amp;&amp;
00677              Process == <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() ) {
00678             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_CONFLICTING_ADDRESSES ) {
00679                 <a class="code" href="../../d4/d3/dbgk_8h.html#a3">DbgkMapViewOfSection</a>(
00680                     SectionHandle,
00681                     CapturedBase,
00682                     CapturedOffset.LowPart,
00683                     CapturedViewSize
00684                     );
00685             }
00686         }
00687         <span class="keywordflow">goto</span> ErrorReturn;
00688     }
00689 
00690     <span class="comment">//</span>
00691     <span class="comment">// Anytime the current process maps an image file,</span>
00692     <span class="comment">// a potential debug event occurs. DbgkMapViewOfSection</span>
00693     <span class="comment">// handles these events.</span>
00694     <span class="comment">//</span>
00695 
00696     <span class="keywordflow">if</span> ( (Section-&gt;Segment-&gt;ControlArea-&gt;u.Flags.Image) &amp;&amp;
00697          Process == <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() ) {
00698         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_IMAGE_NOT_AT_BASE ) {
00699             <a class="code" href="../../d4/d3/dbgk_8h.html#a3">DbgkMapViewOfSection</a>(
00700                 SectionHandle,
00701                 CapturedBase,
00702                 CapturedOffset.LowPart,
00703                 CapturedViewSize
00704                 );
00705         }
00706     }
00707 
00708     <span class="comment">//</span>
00709     <span class="comment">// Establish an exception handler and write the size and base</span>
00710     <span class="comment">// address.</span>
00711     <span class="comment">//</span>
00712 
00713     <span class="keywordflow">try</span> {
00714 
00715         *ViewSize = CapturedViewSize;
00716         *BaseAddress = CapturedBase;
00717 
00718         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(SectionOffset)) {
00719             *SectionOffset = CapturedOffset;
00720         }
00721 
00722     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00723         <span class="keywordflow">goto</span> ErrorReturn;
00724     }
00725 
00726 <span class="preprocessor">#if 0 // test code...</span>
00727 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS) &amp;&amp;
00728         (Section-&gt;u.Flags.Image == 0)) {
00729 
00730         PVOID Base;
00731         ULONG <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = 0;
00732         <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00733 
00734         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d5/mapview_8c.html#a27">MmMapViewInSystemSpace</a> ((PVOID)Section,
00735                                         &amp;Base,
00736                                         &amp;<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>);
00737         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS) {
00738             <a class="code" href="../../d3/d5/mapview_8c.html#a29">MmUnmapViewInSystemSpace</a> (Base);
00739         }
00740     }
00741 <span class="preprocessor">#endif //0</span>
00742 <span class="preprocessor"></span>
00743     {
00744 ErrorReturn:
00745         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (Section);
00746 ErrorReturn1:
00747         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (Process);
00748         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00749     }
00750 }
00751 
00752 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00753"></a><a class="code" href="../../d3/d5/mapview_8c.html#a21">00753</a> <a class="code" href="../../d3/d5/mapview_8c.html#a21">MmMapViewOfSection</a>(
00754     IN PVOID SectionToMap,
00755     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
00756     IN OUT PVOID *CapturedBase,
00757     IN ULONG_PTR ZeroBits,
00758     IN SIZE_T CommitSize,
00759     IN OUT PLARGE_INTEGER SectionOffset,
00760     IN OUT PSIZE_T CapturedViewSize,
00761     IN SECTION_INHERIT InheritDisposition,
00762     IN ULONG AllocationType,
00763     IN ULONG Protect
00764     )
00765 
00766 <span class="comment">/*++</span>
00767 <span class="comment"></span>
00768 <span class="comment">Routine Description:</span>
00769 <span class="comment"></span>
00770 <span class="comment">    This function maps a view in the specified subject process to</span>
00771 <span class="comment">    the section object.</span>
00772 <span class="comment"></span>
00773 <span class="comment">    This function is a kernel mode interface to allow LPC to map</span>
00774 <span class="comment">    a section given the section pointer to map.</span>
00775 <span class="comment"></span>
00776 <span class="comment">    This routine assumes all arguments have been probed and captured.</span>
00777 <span class="comment"></span>
00778 <span class="comment">    ********************************************************************</span>
00779 <span class="comment">    ********************************************************************</span>
00780 <span class="comment">    ********************************************************************</span>
00781 <span class="comment"></span>
00782 <span class="comment">    NOTE:</span>
00783 <span class="comment"></span>
00784 <span class="comment">    CapturedViewSize, SectionOffset, and CapturedBase must be</span>
00785 <span class="comment">    captured in non-paged system space (i.e., kernel stack).</span>
00786 <span class="comment"></span>
00787 <span class="comment">    ********************************************************************</span>
00788 <span class="comment">    ********************************************************************</span>
00789 <span class="comment">    ********************************************************************</span>
00790 <span class="comment"></span>
00791 <span class="comment">Arguments:</span>
00792 <span class="comment"></span>
00793 <span class="comment">    SectionToMap - Supplies a pointer to the section object.</span>
00794 <span class="comment"></span>
00795 <span class="comment">    Process - Supplies a pointer to the process object.</span>
00796 <span class="comment"></span>
00797 <span class="comment">    BaseAddress - Supplies a pointer to a variable that will receive</span>
00798 <span class="comment">         the base address of the view. If the initial value</span>
00799 <span class="comment">         of this argument is not null, then the view will</span>
00800 <span class="comment">         be allocated starting at the specified virtual</span>
00801 <span class="comment">         address rounded down to the next 64kb address</span>
00802 <span class="comment">         boundary. If the initial value of this argument is</span>
00803 <span class="comment">         null, then the operating system will determine</span>
00804 <span class="comment">         where to allocate the view using the information</span>
00805 <span class="comment">         specified by the ZeroBits argument value and the</span>
00806 <span class="comment">         section allocation attributes (i.e. based and</span>
00807 <span class="comment">         tiled).</span>
00808 <span class="comment"></span>
00809 <span class="comment">    ZeroBits - Supplies the number of high order address bits that</span>
00810 <span class="comment">         must be zero in the base address of the section</span>
00811 <span class="comment">         view. The value of this argument must be less than</span>
00812 <span class="comment">         21 and is only used when the operating system</span>
00813 <span class="comment">         determines where to allocate the view (i.e. when</span>
00814 <span class="comment">         BaseAddress is null).</span>
00815 <span class="comment"></span>
00816 <span class="comment">    CommitSize - Supplies the size of the initially committed region</span>
00817 <span class="comment">         of the view in bytes. This value is rounded up to</span>
00818 <span class="comment">         the next host page size boundary.</span>
00819 <span class="comment"></span>
00820 <span class="comment">    SectionOffset - Supplies the offset from the beginning of the</span>
00821 <span class="comment">         section to the view in bytes. This value is</span>
00822 <span class="comment">         rounded down to the next host page size boundary.</span>
00823 <span class="comment"></span>
00824 <span class="comment">    ViewSize - Supplies a pointer to a variable that will receive</span>
00825 <span class="comment">         the actual size in bytes of the view. If the value</span>
00826 <span class="comment">         of this argument is zero, then a view of the</span>
00827 <span class="comment">         section will be mapped starting at the specified</span>
00828 <span class="comment">         section offset and continuing to the end of the</span>
00829 <span class="comment">         section. Otherwise the initial value of this</span>
00830 <span class="comment">         argument specifies the size of the view in bytes</span>
00831 <span class="comment">         and is rounded up to the next host page size</span>
00832 <span class="comment">         boundary.</span>
00833 <span class="comment"></span>
00834 <span class="comment">    InheritDisposition - Supplies a value that specifies how the</span>
00835 <span class="comment">         view is to be shared by a child process created</span>
00836 <span class="comment">         with a create process operation.</span>
00837 <span class="comment"></span>
00838 <span class="comment">    AllocationType - Supplies the type of allocation.</span>
00839 <span class="comment"></span>
00840 <span class="comment">    Protect - Supplies the protection desired for the region of</span>
00841 <span class="comment">         initially committed pages.</span>
00842 <span class="comment"></span>
00843 <span class="comment">Return Value:</span>
00844 <span class="comment"></span>
00845 <span class="comment">    Returns the status</span>
00846 <span class="comment"></span>
00847 <span class="comment">    TBS</span>
00848 <span class="comment"></span>
00849 <span class="comment"></span>
00850 <span class="comment">--*/</span>
00851 {
00852     BOOLEAN Attached;
00853     <a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a> Section;
00854     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
00855     ULONG ProtectionMask;
00856     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00857     BOOLEAN ReleasedWsMutex;
00858     BOOLEAN WriteCombined;
00859     SIZE_T ImageCommitment;
00860 
00861     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00862 
00863     Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00864     ReleasedWsMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00865 
00866     Section = (<a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>)SectionToMap;
00867 
00868     <span class="comment">//</span>
00869     <span class="comment">// Check to make sure the section is not smaller than the view size.</span>
00870     <span class="comment">//</span>
00871 
00872     <span class="keywordflow">if</span> ((LONGLONG)*CapturedViewSize &gt; Section-&gt;SizeOfSection.QuadPart) {
00873         <span class="keywordflow">if</span> ((AllocationType &amp; MEM_RESERVE) == 0) {
00874             <span class="keywordflow">return</span> STATUS_INVALID_VIEW_SIZE;
00875         }
00876     }
00877 
00878     <span class="keywordflow">if</span> (AllocationType &amp; MEM_RESERVE) {
00879         <span class="keywordflow">if</span> (((Section-&gt;InitialPageProtection &amp; PAGE_READWRITE) |
00880             (Section-&gt;InitialPageProtection &amp; PAGE_EXECUTE_READWRITE)) == 0) {
00881 
00882             <span class="keywordflow">return</span> STATUS_SECTION_PROTECTION;
00883         }
00884     }
00885 
00886     <span class="keywordflow">if</span> (Section-&gt;u.Flags.NoCache) {
00887         Protect |= PAGE_NOCACHE;
00888     }
00889 
00890     <span class="comment">//</span>
00891     <span class="comment">// Note that write combining is only relevant to physical memory sections</span>
00892     <span class="comment">// because they are never trimmed - the write combining bits in a PTE entry</span>
00893     <span class="comment">// are not preserved across trims.</span>
00894     <span class="comment">//</span>
00895 
00896     <span class="keywordflow">if</span> (Protect &amp; PAGE_WRITECOMBINE) {
00897         Protect &amp;= ~PAGE_WRITECOMBINE;
00898         WriteCombined = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00899     }
00900     <span class="keywordflow">else</span> {
00901         WriteCombined = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00902     }
00903 
00904     <span class="comment">//</span>
00905     <span class="comment">// Check the protection field.  This could raise an exception.</span>
00906     <span class="comment">//</span>
00907 
00908     <span class="keywordflow">try</span> {
00909         ProtectionMask = <a class="code" href="../../d0/d2/mmsup_8c.html#a5">MiMakeProtectionMask</a> (Protect);
00910     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00911         <span class="keywordflow">return</span> GetExceptionCode();
00912     }
00913 
00914     ControlArea = Section-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o0">Segment</a>-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o0">ControlArea</a>;
00915     ImageCommitment = Section-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o0">Segment</a>-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o5">ImageCommitment</a>;
00916 
00917     <span class="comment">//</span>
00918     <span class="comment">// If the specified process is not the current process, attach</span>
00919     <span class="comment">// to the specified process.</span>
00920     <span class="comment">//</span>
00921 
00922     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() != Process) {
00923         <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a> (&amp;Process-&gt;Pcb);
00924         Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00925     }
00926 
00927     <span class="comment">//</span>
00928     <span class="comment">// Get the address creation mutex to block multiple threads</span>
00929     <span class="comment">// creating or deleting address space at the same time.</span>
00930     <span class="comment">//</span>
00931 
00932     <a class="code" href="../../d4/d8/mi_8h.html#a160">LOCK_ADDRESS_SPACE</a> (Process);
00933 
00934     <span class="comment">//</span>
00935     <span class="comment">// Make sure the address space was not deleted, if so, return an error.</span>
00936     <span class="comment">//</span>
00937 
00938     <span class="keywordflow">if</span> (Process-&gt;AddressSpaceDeleted != 0) {
00939         status = STATUS_PROCESS_IS_TERMINATING;
00940         <span class="keywordflow">goto</span> ErrorReturn;
00941     }
00942 
00943     <span class="comment">//</span>
00944     <span class="comment">// Map the view base on the type.</span>
00945     <span class="comment">//</span>
00946 
00947     ReleasedWsMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00948 
00949     <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.PhysicalMemory) {
00950 
00951         <a class="code" href="../../d5/d6/iosup_8c.html#a76">MmLockPagableSectionByHandle</a>(<a class="code" href="../../d5/d8/ex_8h.html#a166">ExPageLockHandle</a>);
00952         status = <a class="code" href="../../d4/d8/mi_8h.html#a913">MiMapViewOfPhysicalSection</a> (ControlArea,
00953                                              Process,
00954                                              CapturedBase,
00955                                              SectionOffset,
00956                                              CapturedViewSize,
00957                                              ProtectionMask,
00958                                              ZeroBits,
00959                                              AllocationType,
00960                                              WriteCombined,
00961                                              &amp;ReleasedWsMutex);
00962         <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(<a class="code" href="../../d5/d8/ex_8h.html#a166">ExPageLockHandle</a>);
00963 
00964     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.Image) {
00965         <span class="keywordflow">if</span> (AllocationType &amp; MEM_RESERVE) {
00966             status = STATUS_INVALID_PARAMETER_9;
00967         }
00968         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (WriteCombined == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00969             status = STATUS_INVALID_PARAMETER_10;
00970         } <span class="keywordflow">else</span> {
00971 
00972             status = <a class="code" href="../../d3/d5/mapview_8c.html#a23">MiMapViewOfImageSection</a> (ControlArea,
00973                                               Process,
00974                                               CapturedBase,
00975                                               SectionOffset,
00976                                               CapturedViewSize,
00977                                               Section,
00978                                               InheritDisposition,
00979                                               ZeroBits,
00980                                               ImageCommitment,
00981                                               &amp;ReleasedWsMutex);
00982         }
00983 
00984     } <span class="keywordflow">else</span> {
00985 
00986         <span class="comment">//</span>
00987         <span class="comment">// Not an image section, therefore it is a data section.</span>
00988         <span class="comment">//</span>
00989 
00990         <span class="keywordflow">if</span> (WriteCombined == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00991             status = STATUS_INVALID_PARAMETER_10;
00992         }
00993         <span class="keywordflow">else</span> {
00994             status = <a class="code" href="../../d3/d5/mapview_8c.html#a24">MiMapViewOfDataSection</a> (ControlArea,
00995                                          Process,
00996                                          CapturedBase,
00997                                          SectionOffset,
00998                                          CapturedViewSize,
00999                                          Section,
01000                                          InheritDisposition,
01001                                          ProtectionMask,
01002                                          CommitSize,
01003                                          ZeroBits,
01004                                          AllocationType,
01005                                          &amp;ReleasedWsMutex
01006                                         );
01007         }
01008     }
01009 
01010 ErrorReturn:
01011     <span class="keywordflow">if</span> (!ReleasedWsMutex) {
01012         <a class="code" href="../../d4/d8/mi_8h.html#a162">UNLOCK_WS_AND_ADDRESS_SPACE</a> (Process);
01013     }
01014     <span class="keywordflow">else</span> {
01015         <a class="code" href="../../d4/d8/mi_8h.html#a163">UNLOCK_ADDRESS_SPACE</a> (Process);
01016     }
01017 
01018     <span class="keywordflow">if</span> (Attached) {
01019         <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
01020     }
01021 
01022     <span class="keywordflow">return</span> status;
01023 }
01024 
01025 <span class="preprocessor">#ifndef _ALPHA_</span>
01026 <span class="preprocessor"></span>
01027 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01028"></a><a class="code" href="../../d3/d5/mapview_8c.html#a22">01028</a> <a class="code" href="../../d4/d8/mi_8h.html#a913">MiMapViewOfPhysicalSection</a> (
01029     IN <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea,
01030     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
01031     IN PVOID *CapturedBase,
01032     IN PLARGE_INTEGER SectionOffset,
01033     IN PSIZE_T CapturedViewSize,
01034     IN ULONG ProtectionMask,
01035     IN ULONG_PTR ZeroBits,
01036     IN ULONG AllocationType,
01037     IN BOOLEAN WriteCombined,
01038     OUT PBOOLEAN ReleasedWsMutex
01039     )
01040 
01041 <span class="comment">/*++</span>
01042 <span class="comment"></span>
01043 <span class="comment">Routine Description:</span>
01044 <span class="comment"></span>
01045 <span class="comment">    This routine maps the specified physical section into the</span>
01046 <span class="comment">    specified process's address space.</span>
01047 <span class="comment"></span>
01048 <span class="comment">Arguments:</span>
01049 <span class="comment"></span>
01050 <span class="comment">    see MmMapViewOfSection above...</span>
01051 <span class="comment"></span>
01052 <span class="comment">    ControlArea - Supplies the control area for the section.</span>
01053 <span class="comment"></span>
01054 <span class="comment">    Process - Supplies the process pointer which is receiving the section.</span>
01055 <span class="comment"></span>
01056 <span class="comment">    ProtectionMask - Supplies the initial page protection-mask.</span>
01057 <span class="comment"></span>
01058 <span class="comment">    ReleasedWsMutex - Supplies FALSE. If the working set mutex is</span>
01059 <span class="comment">                      not held when returning this must be set to TRUE</span>
01060 <span class="comment">                      so the caller will not release the unheld mutex.</span>
01061 <span class="comment"></span>
01062 <span class="comment">                      Note if this routine acquires the working set mutex</span>
01063 <span class="comment">                      it is always done unsafely as the address space mutex</span>
01064 <span class="comment">                      must be held on entry regardless.</span>
01065 <span class="comment"></span>
01066 <span class="comment">Return Value:</span>
01067 <span class="comment"></span>
01068 <span class="comment">    Status of the map view operation.</span>
01069 <span class="comment"></span>
01070 <span class="comment">Environment:</span>
01071 <span class="comment"></span>
01072 <span class="comment">    Kernel Mode, address creation mutex held.</span>
01073 <span class="comment"></span>
01074 <span class="comment">--*/</span>
01075 
01076 {
01077     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Vad;
01078     PVOID StartingAddress;
01079     PVOID EndingAddress;
01080     KIRQL OldIrql;
01081     KIRQL OldIrql2;
01082     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe;
01083     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
01084     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
01085     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
01086     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
01087     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn2;
01088     SIZE_T PhysicalViewSize;
01089     ULONG_PTR Alignment;
01090     PVOID UsedPageTableHandle;
01091     PVOID UsedPageDirectoryHandle;
01092     <a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html">PMI_PHYSICAL_VIEW</a> PhysicalView;
01093 <span class="preprocessor">#ifdef LARGE_PAGES</span>
01094 <span class="preprocessor"></span>    ULONG size;
01095     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> protoPte;
01096     ULONG pageSize;
01097     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> Subsection;
01098     ULONG EmPageSize;
01099 <span class="preprocessor">#endif //LARGE_PAGES</span>
01100 <span class="preprocessor"></span>
01101     <span class="comment">//</span>
01102     <span class="comment">// Physical memory section.</span>
01103     <span class="comment">//</span>
01104 
01105     <span class="comment">//</span>
01106     <span class="comment">// If running on an R4000 and MEM_LARGE_PAGES is specified,</span>
01107     <span class="comment">// set up the PTEs as a series of  pointers to the same</span>
01108     <span class="comment">// prototype PTE.  This prototype PTE will reference a subsection</span>
01109     <span class="comment">// that indicates large pages should be used.</span>
01110     <span class="comment">//</span>
01111     <span class="comment">// The R4000 supports pages of 4k, 16k, 64k, etc (powers of 4).</span>
01112     <span class="comment">// Since the TB supports 2 entries, sizes of 8k, 32k etc can</span>
01113     <span class="comment">// be mapped by 2 LargePages in a single TB entry.  These 2 entries</span>
01114     <span class="comment">// are maintained in the subsection structure pointed to by the</span>
01115     <span class="comment">// prototype PTE.</span>
01116     <span class="comment">//</span>
01117 
01118     <span class="keywordflow">if</span> (AllocationType &amp; MEM_RESERVE) {
01119         *ReleasedWsMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01120         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_9;
01121     }
01122     Alignment = <a class="code" href="../../d4/d8/mi_8h.html#a18">X64K</a>;
01123     <a class="code" href="../../d4/d8/mi_8h.html#a155">LOCK_WS_UNSAFE</a> (Process);
01124 
01125 <span class="preprocessor">#ifdef LARGE_PAGES</span>
01126 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (AllocationType &amp; MEM_LARGE_PAGES) {
01127 
01128         <span class="comment">//</span>
01129         <span class="comment">// Determine the page size and the required alignment.</span>
01130         <span class="comment">//</span>
01131 
01132         <span class="keywordflow">if</span> ((SectionOffset-&gt;LowPart &amp; (<a class="code" href="../../d4/d8/mi_8h.html#a18">X64K</a> - 1)) != 0) {
01133             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_9;
01134         }
01135 
01136         size = (*CapturedViewSize - 1) &gt;&gt; (<a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a> + 1);
01137         pageSize = <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
01138 
01139         <span class="keywordflow">while</span> (size != 0) {
01140             size = size &gt;&gt; 2;
01141             pageSize = pageSize &lt;&lt; 2;
01142         }
01143 
01144         Alignment = pageSize &lt;&lt; 1;
01145         <span class="keywordflow">if</span> (Alignment &lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a50">MM_VA_MAPPED_BY_PDE</a>) {
01146             Alignment = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a50">MM_VA_MAPPED_BY_PDE</a>;
01147         }
01148 
01149 <span class="preprocessor">#if defined(_IA64_)</span>
01150 <span class="preprocessor"></span>
01151         <span class="comment">//</span>
01152         <span class="comment">// Convert pageSize to the EM page-size field format.</span>
01153         <span class="comment">//</span>
01154 
01155         EmPageSize = 0;
01156         size = pageSize - 1 ;
01157 
01158         <span class="keywordflow">while</span> (size) {
01159             size = size &gt;&gt; 1;
01160             EmPageSize += 1;
01161         }
01162 
01163         <span class="keywordflow">if</span> (*CapturedViewSize &gt; pageSize) {
01164 
01165             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d2/dataia64_8c.html#a27">MmPageSizeInfo</a> &amp; (pageSize &lt;&lt; 1)) {
01166 
01167                 <span class="comment">//</span>
01168                 <span class="comment">// if larger page size is supported in the implementation</span>
01169                 <span class="comment">//</span>
01170 
01171                 pageSize = pageSize &lt;&lt; 1;
01172                 EmPageSize += 1;
01173 
01174             }
01175             <span class="keywordflow">else</span> {
01176 
01177                 EmPageSize = EmPageSize | pageSize;
01178 
01179             }
01180         }
01181 
01182         pageSize = EmPageSize;
01183 <span class="preprocessor">#endif</span>
01184 <span class="preprocessor"></span>
01185     }
01186 <span class="preprocessor">#endif //LARGE_PAGES</span>
01187 <span class="preprocessor"></span>
01188     <span class="keywordflow">if</span> (*CapturedBase == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01189 
01190         <span class="comment">//</span>
01191         <span class="comment">// Attempt to locate address space.  This could raise an</span>
01192         <span class="comment">// exception.</span>
01193         <span class="comment">//</span>
01194 
01195         <span class="keywordflow">try</span> {
01196 
01197             <span class="comment">//</span>
01198             <span class="comment">// Find a starting address on a 64k boundary.</span>
01199             <span class="comment">//</span>
01200 <span class="preprocessor">#ifdef i386</span>
01201 <span class="preprocessor"></span>            <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (SectionOffset-&gt;HighPart == 0);
01202 <span class="preprocessor">#endif</span>
01203 <span class="preprocessor"></span>
01204 <span class="preprocessor">#ifdef LARGE_PAGES</span>
01205 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (AllocationType &amp; MEM_LARGE_PAGES) {
01206                 PhysicalViewSize = Alignment;
01207             } <span class="keywordflow">else</span> {
01208 <span class="preprocessor">#endif //LARGE_PAGES</span>
01209 <span class="preprocessor"></span>
01210                 PhysicalViewSize = *CapturedViewSize +
01211                                        (SectionOffset-&gt;LowPart &amp; (<a class="code" href="../../d4/d8/mi_8h.html#a18">X64K</a> - 1));
01212 <span class="preprocessor">#ifdef LARGE_PAGES</span>
01213 <span class="preprocessor"></span>            }
01214 <span class="preprocessor">#endif //LARGE_PAGES</span>
01215 <span class="preprocessor"></span>
01216             StartingAddress = <a class="code" href="../../d6/d3/vadtree_8c.html#a3">MiFindEmptyAddressRange</a> (PhysicalViewSize,
01217                                                        Alignment,
01218                                                        (ULONG)ZeroBits);
01219 
01220         } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
01221 
01222             <span class="keywordflow">return</span> GetExceptionCode();
01223         }
01224 
01225         EndingAddress = (PVOID)(((ULONG_PTR)StartingAddress +
01226                                 PhysicalViewSize - 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>) | (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>));
01227         StartingAddress = (PVOID)((ULONG_PTR)StartingAddress +
01228                                      (SectionOffset-&gt;LowPart &amp; (<a class="code" href="../../d4/d8/mi_8h.html#a18">X64K</a> - 1)));
01229 
01230         <span class="keywordflow">if</span> (ZeroBits &gt; 0) {
01231             <span class="keywordflow">if</span> (EndingAddress &gt; (PVOID)((ULONG_PTR)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a9">MM_USER_ADDRESS_RANGE_LIMIT</a> &gt;&gt; ZeroBits)) {
01232                 <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01233             }
01234         }
01235 
01236     } <span class="keywordflow">else</span> {
01237 
01238         <span class="comment">//</span>
01239         <span class="comment">// Check to make sure the specified base address to ending address</span>
01240         <span class="comment">// is currently unused.</span>
01241         <span class="comment">//</span>
01242 
01243         StartingAddress = (PVOID)((ULONG_PTR)<a class="code" href="../../d4/d8/mi_8h.html#a91">MI_64K_ALIGN</a>(*CapturedBase) +
01244                                     (SectionOffset-&gt;LowPart &amp; (<a class="code" href="../../d4/d8/mi_8h.html#a18">X64K</a> - 1)));
01245         EndingAddress = (PVOID)(((ULONG_PTR)StartingAddress +
01246                                 *CapturedViewSize - 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>) | (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>));
01247 
01248 <span class="preprocessor">#ifdef LARGE_PAGES</span>
01249 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (AllocationType &amp; MEM_LARGE_PAGES) {
01250             <span class="keywordflow">if</span> (((ULONG_PTR)StartingAddress &amp; (Alignment - 1)) != 0) {
01251                 <span class="keywordflow">return</span> STATUS_CONFLICTING_ADDRESSES;
01252             }
01253             EndingAddress = (PVOID)((PCHAR)StartingAddress + Alignment);
01254         }
01255 <span class="preprocessor">#endif //LARGE_PAGES</span>
01256 <span class="preprocessor"></span>
01257         Vad = <a class="code" href="../../d4/d8/mi_8h.html#a98">MiCheckForConflictingVad</a> (StartingAddress, EndingAddress);
01258 
01259         <span class="keywordflow">if</span> (Vad != (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01260 <span class="preprocessor">#if DBG</span>
01261 <span class="preprocessor"></span>            MiDumpConflictingVad (StartingAddress, EndingAddress, Vad);
01262 <span class="preprocessor">#endif</span>
01263 <span class="preprocessor"></span>
01264             <span class="keywordflow">return</span> STATUS_CONFLICTING_ADDRESSES;
01265         }
01266     }
01267 
01268     <span class="comment">//</span>
01269     <span class="comment">// An unoccupied address range has been found, build the virtual</span>
01270     <span class="comment">// address descriptor to describe this range.</span>
01271     <span class="comment">//</span>
01272 
01273 <span class="preprocessor">#ifdef LARGE_PAGES</span>
01274 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (AllocationType &amp; MEM_LARGE_PAGES) {
01275         <span class="comment">//</span>
01276         <span class="comment">// Allocate a subsection and 4 prototype PTEs to hold</span>
01277         <span class="comment">// the information for the large pages.</span>
01278         <span class="comment">//</span>
01279 
01280         Subsection = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
01281                                      <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d7/struct__SUBSECTION.html">SUBSECTION</a>) + (4 * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>)),
01282                                      <a class="code" href="../../d3/d5/mapview_8c.html#a2">MMPPTE_NAME</a>);
01283         <span class="keywordflow">if</span> (Subsection == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01284             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01285         }
01286     }
01287 <span class="preprocessor">#endif //LARGE_PAGES</span>
01288 <span class="preprocessor"></span>
01289     <span class="comment">//</span>
01290     <span class="comment">// Establish an exception handler and attempt to allocate</span>
01291     <span class="comment">// the pool and charge quota.  Note that the InsertVad routine</span>
01292     <span class="comment">// will also charge quota which could raise an exception.</span>
01293     <span class="comment">//</span>
01294 
01295     <span class="keywordflow">try</span>  {
01296 
01297         PhysicalView = (<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html">PMI_PHYSICAL_VIEW</a>)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
01298                                                                  <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html">MI_PHYSICAL_VIEW</a>),
01299                                                                  <a class="code" href="../../d4/d8/mi_8h.html#a231">MI_PHYSICAL_VIEW_KEY</a>);
01300         <span class="keywordflow">if</span> (PhysicalView == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01301             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_INSUFFICIENT_RESOURCES);
01302         }
01303 
01304         Vad = (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
01305                                              <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d6/struct__MMVAD.html">MMVAD</a>),
01306                                              <a class="code" href="../../d3/d6/allocvm_8c.html#a0">MMVADKEY</a>);
01307         <span class="keywordflow">if</span> (Vad == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01308             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_INSUFFICIENT_RESOURCES);
01309         }
01310 
01311         PhysicalView-&gt;<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o1">Vad</a> = Vad;
01312         PhysicalView-&gt;<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o2">StartVa</a> = StartingAddress;
01313         PhysicalView-&gt;<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o3">EndVa</a> = EndingAddress;
01314 
01315         RtlZeroMemory (Vad, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/mi_8h.html#a489">MMVAD</a>));
01316         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a> = <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (StartingAddress);
01317         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a> = <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (EndingAddress);
01318         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o8">ControlArea</a> = ControlArea;
01319         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.Inherit = <a class="code" href="../../d4/d8/mi_8h.html#a228">MM_VIEW_UNMAP</a>;
01320         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.PhysicalMapping = 1;
01321         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.Protection = ProtectionMask;
01322 
01323         <span class="comment">//</span>
01324         <span class="comment">// Set the last contiguous PTE field in the Vad to the page frame</span>
01325         <span class="comment">// number of the starting physical page.</span>
01326         <span class="comment">//</span>
01327 
01328         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o10">LastContiguousPte</a> = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)(ULONG)(
01329                             SectionOffset-&gt;QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
01330 <span class="preprocessor">#ifdef LARGE_PAGES</span>
01331 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (AllocationType &amp; MEM_LARGE_PAGES) {
01332         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.LargePages = 1;
01333         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o9">FirstPrototypePte</a> = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)Subsection;
01334     } <span class="keywordflow">else</span> {
01335 <span class="preprocessor">#endif //LARGE_PAGES</span>
01336 <span class="preprocessor"></span>        <span class="comment">// Vad-&gt;u.VadFlags.LargePages = 0;</span>
01337         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o9">FirstPrototypePte</a> = Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o10">LastContiguousPte</a>;
01338 <span class="preprocessor">#ifdef LARGE_PAGES</span>
01339 <span class="preprocessor"></span>    }
01340 <span class="preprocessor">#endif //LARGE_PAGES</span>
01341 <span class="preprocessor"></span>
01342         <span class="comment">//</span>
01343         <span class="comment">// Insert the VAD.  This could get an exception.</span>
01344         <span class="comment">//</span>
01345 
01346         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o9">FirstPrototypePte</a> &lt;= Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o10">LastContiguousPte</a>);
01347         <a class="code" href="../../d6/d3/vadtree_8c.html#a0">MiInsertVad</a> (Vad);
01348 
01349     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
01350 
01351         <span class="keywordflow">if</span> (PhysicalView != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01352             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (PhysicalView);
01353         }
01354 
01355         <span class="keywordflow">if</span> (Vad != (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01356 
01357             <span class="comment">//</span>
01358             <span class="comment">// The pool allocation succeeded, but the quota charge</span>
01359             <span class="comment">// in InsertVad failed, deallocate the pool and return</span>
01360             <span class="comment">// an error.</span>
01361             <span class="comment">//</span>
01362 
01363             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Vad);
01364 <span class="preprocessor">#ifdef LARGE_PAGES</span>
01365 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (AllocationType &amp; MEM_LARGE_PAGES) {
01366             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Subsection);
01367     }
01368 <span class="preprocessor">#endif //LARGE_PAGES</span>
01369 <span class="preprocessor"></span>            <span class="keywordflow">return</span> GetExceptionCode();
01370         }
01371         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01372     }
01373 
01374     <span class="comment">//</span>
01375     <span class="comment">// Increment the count of the number of views for the</span>
01376     <span class="comment">// section object.  This requires the PFN lock to be held.</span>
01377     <span class="comment">//</span>
01378 
01379     <a class="code" href="../../d4/d8/mi_8h.html#a133">LOCK_AWE</a> (Process, OldIrql);
01380     <a class="code" href="../../d4/d8/mi_8h.html#a130">LOCK_PFN2</a> (OldIrql2);
01381 
01382     InsertHeadList (&amp;Process-&gt;PhysicalVadList, &amp;PhysicalView-&gt;<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o0">ListEntry</a>);
01383 
01384     ControlArea-&gt;NumberOfMappedViews += 1;
01385     ControlArea-&gt;NumberOfUserReferences += 1;
01386 
01387     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea-&gt;NumberOfSectionReferences != 0);
01388 
01389     <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql2);
01390     <a class="code" href="../../d4/d8/mi_8h.html#a134">UNLOCK_AWE</a> (Process, OldIrql);
01391 
01392     <span class="comment">//</span>
01393     <span class="comment">// Build the PTEs in the address space.</span>
01394     <span class="comment">//</span>
01395 
01396     PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a> (StartingAddress);
01397     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (StartingAddress);
01398     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (StartingAddress);
01399     LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (EndingAddress);
01400 
01401     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a105">MI_MAKE_VALID_PTE</a> (TempPte,
01402                        (ULONG_PTR)Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o10">LastContiguousPte</a>,
01403                        ProtectionMask,
01404                        PointerPte);
01405 
01406     <span class="keywordflow">if</span> (WriteCombined == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01407         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a111">MI_SET_PTE_WRITE_COMBINE</a> (TempPte);
01408     }
01409 
01410     <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Write) {
01411         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a112">MI_SET_PTE_DIRTY</a> (TempPte);
01412     }
01413 
01414 <span class="preprocessor">#if defined(_IA64_)</span>
01415 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a119">MI_IS_CACHING_DISABLED</a>(&amp;TempPte) || (WriteCombined == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
01416         <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a0">KeFlushEntireTb</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01417     }
01418 <span class="preprocessor">#endif</span>
01419 <span class="preprocessor"></span>
01420 <span class="preprocessor">#ifdef LARGE_PAGES</span>
01421 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (AllocationType &amp; MEM_LARGE_PAGES) {
01422         Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o4">StartingSector</a> = pageSize;
01423         Subsection-&gt;EndingSector = (ULONG_PTR)StartingAddress;
01424         Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o3">u</a>.LongFlags = 0;
01425         Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o3">u</a>.SubsectionFlags.LargePages = 1;
01426         protoPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)(Subsection + 1);
01427 
01428         <span class="comment">//</span>
01429         <span class="comment">// Build the first 2 PTEs as entries for the TLB to</span>
01430         <span class="comment">// map the specified physical address.</span>
01431         <span class="comment">//</span>
01432 
01433         *protoPte = TempPte;
01434         protoPte += 1;
01435 
01436         <span class="keywordflow">if</span> (*CapturedViewSize &gt; pageSize) {
01437             *protoPte = TempPte;
01438             protoPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber += (pageSize &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
01439         } <span class="keywordflow">else</span> {
01440             *protoPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a0">ZeroPte</a>;
01441         }
01442         protoPte += 1;
01443 
01444         <span class="comment">//</span>
01445         <span class="comment">// Build the first prototype PTE as a paging file format PTE</span>
01446         <span class="comment">// referring to the subsection.</span>
01447         <span class="comment">//</span>
01448 
01449         protoPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a149">MiGetSubsectionAddressForPte</a> (Subsection);
01450         protoPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype = 1;
01451         protoPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection = ProtectionMask;
01452 
01453         <span class="comment">//</span>
01454         <span class="comment">// Set the PTE up for all the user's PTE entries, proto pte</span>
01455         <span class="comment">// format pointing to the 3rd prototype PTE.</span>
01456         <span class="comment">//</span>
01457 
01458         TempPte.u.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a145">MiProtoAddressForPte</a> (protoPte);
01459     }
01460 
01461     <span class="keywordflow">if</span> (!(AllocationType &amp; MEM_LARGE_PAGES)) {
01462 <span class="preprocessor">#endif //LARGE_PAGES</span>
01463 <span class="preprocessor"></span>
01464 <span class="preprocessor">#if defined (_WIN64)</span>
01465 <span class="preprocessor"></span>        <a class="code" href="../../d4/d8/mi_8h.html#a245">MiMakePpeExistAndMakeValid</a> (PointerPpe, Process, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01466         <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0) {
01467             UsedPageDirectoryHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (PointerPte);
01468             <a class="code" href="../../d4/d8/mi_8h.html#a182">MI_INCREMENT_USED_PTES_BY_HANDLE</a> (UsedPageDirectoryHandle);
01469         }
01470 <span class="preprocessor">#endif</span>
01471 <span class="preprocessor"></span>
01472         <a class="code" href="../../d0/d2/mmsup_8c.html#a7">MiMakePdeExistAndMakeValid</a> (PointerPde, Process, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01473 
01474         Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
01475 
01476         UsedPageTableHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (StartingAddress);
01477 
01478         <span class="keywordflow">while</span> (PointerPte &lt;= LastPte) {
01479 
01480             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a> (PointerPte)) {
01481 
01482                 PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPte);
01483 
01484                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a166">MiIsPteOnPpeBoundary</a> (PointerPte)) {
01485                     PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
01486                     <a class="code" href="../../d4/d8/mi_8h.html#a245">MiMakePpeExistAndMakeValid</a> (PointerPpe, Process, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01487                 }
01488 
01489 <span class="preprocessor">#if defined (_WIN64)</span>
01490 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0) {
01491                     UsedPageDirectoryHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (PointerPte);
01492                     <a class="code" href="../../d4/d8/mi_8h.html#a182">MI_INCREMENT_USED_PTES_BY_HANDLE</a> (UsedPageDirectoryHandle);
01493                 }
01494 <span class="preprocessor">#endif</span>
01495 <span class="preprocessor"></span>
01496                 <a class="code" href="../../d0/d2/mmsup_8c.html#a7">MiMakePdeExistAndMakeValid</a> (PointerPde, Process, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01497                 Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
01498                 UsedPageTableHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte));
01499             }
01500 
01501             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0);
01502 
01503             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPte, TempPte);
01504 
01505             <a class="code" href="../../d4/d8/mi_8h.html#a121">CONSISTENCY_LOCK_PFN</a> (OldIrql);
01506 
01507             Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
01508 
01509             <a class="code" href="../../d4/d8/mi_8h.html#a122">CONSISTENCY_UNLOCK_PFN</a> (OldIrql);
01510 
01511             <span class="comment">//</span>
01512             <span class="comment">// Increment the count of non-zero page table entries for this</span>
01513             <span class="comment">// page table and the number of private pages for the process.</span>
01514             <span class="comment">//</span>
01515 
01516             <a class="code" href="../../d4/d8/mi_8h.html#a182">MI_INCREMENT_USED_PTES_BY_HANDLE</a> (UsedPageTableHandle);
01517 
01518             PointerPte += 1;
01519             TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber += 1;
01520         }
01521 <span class="preprocessor">#ifdef LARGE_PAGES</span>
01522 <span class="preprocessor"></span>    }
01523 <span class="preprocessor">#endif //LARGE_PAGES</span>
01524 <span class="preprocessor"></span>
01525 <span class="preprocessor">#if defined(i386)</span>
01526 <span class="preprocessor"></span>    <span class="comment">//</span>
01527     <span class="comment">// If write combined was specified then flush all caches and TBs.</span>
01528     <span class="comment">//</span>
01529 
01530     <span class="keywordflow">if</span> (WriteCombined == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> &amp;&amp; <a class="code" href="../../d6/d8/mi386_8h.html#a204">MiWriteCombiningPtes</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01531         <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a0">KeFlushEntireTb</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01532         <a class="code" href="../../d0/d5/i386_2flush_8c.html#a2">KeInvalidateAllCaches</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01533     }
01534 <span class="preprocessor">#endif</span>
01535 <span class="preprocessor"></span>
01536 <span class="preprocessor">#if defined(_IA64_)</span>
01537 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a119">MI_IS_CACHING_DISABLED</a>(&amp;TempPte) || (WriteCombined == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
01538         <a class="code" href="../../d2/d9/miia64_8h.html#a318">MiSweepCacheMachineDependent</a>(StartingAddress, 
01539                                      (PCHAR)EndingAddress - (PCHAR)StartingAddress + 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
01540                                      <a class="code" href="../../d4/d9/ke_8h.html#a413a250">MmWriteCombined</a>);
01541     }
01542 <span class="preprocessor">#endif</span>
01543 <span class="preprocessor"></span>
01544     <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (Process);
01545     *ReleasedWsMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01546 
01547     <span class="comment">//</span>
01548     <span class="comment">// Update the current virtual size in the process header.</span>
01549     <span class="comment">//</span>
01550 
01551     *CapturedViewSize = (PCHAR)EndingAddress - (PCHAR)StartingAddress + 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
01552     Process-&gt;VirtualSize += *CapturedViewSize;
01553 
01554     <span class="keywordflow">if</span> (Process-&gt;VirtualSize &gt; Process-&gt;PeakVirtualSize) {
01555         Process-&gt;PeakVirtualSize = Process-&gt;VirtualSize;
01556     }
01557 
01558     *CapturedBase = StartingAddress;
01559 
01560     <span class="keywordflow">return</span> STATUS_SUCCESS;
01561 }
01562 
01563 <span class="preprocessor">#endif </span>
01564 <span class="preprocessor"></span>
01565 <span class="preprocessor"></span>
01566 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01567"></a><a class="code" href="../../d3/d5/mapview_8c.html#a23">01567</a> <a class="code" href="../../d3/d5/mapview_8c.html#a23">MiMapViewOfImageSection</a> (
01568     IN <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea,
01569     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
01570     IN PVOID *CapturedBase,
01571     IN PLARGE_INTEGER SectionOffset,
01572     IN PSIZE_T CapturedViewSize,
01573     IN PSECTION Section,
01574     IN SECTION_INHERIT InheritDisposition,
01575     IN ULONG_PTR ZeroBits,
01576     IN SIZE_T ImageCommitment,
01577     IN OUT PBOOLEAN ReleasedWsMutex
01578     )
01579 
01580 <span class="comment">/*++</span>
01581 <span class="comment"></span>
01582 <span class="comment">Routine Description:</span>
01583 <span class="comment"></span>
01584 <span class="comment">    This routine maps the specified Image section into the</span>
01585 <span class="comment">    specified process's address space.</span>
01586 <span class="comment"></span>
01587 <span class="comment">Arguments:</span>
01588 <span class="comment"></span>
01589 <span class="comment">    see MmMapViewOfSection above...</span>
01590 <span class="comment"></span>
01591 <span class="comment">    ControlArea - Supplies the control area for the section.</span>
01592 <span class="comment"></span>
01593 <span class="comment">    Process - Supplies the process pointer which is receiving the section.</span>
01594 <span class="comment"></span>
01595 <span class="comment">    ReleasedWsMutex - Supplies FALSE. If the working set mutex is</span>
01596 <span class="comment">                      not held when returning this must be set to TRUE</span>
01597 <span class="comment">                      so the caller will not release the unheld mutex.</span>
01598 <span class="comment"></span>
01599 <span class="comment">                      Note if this routine acquires the working set mutex</span>
01600 <span class="comment">                      it is always done unsafely as the address space mutex</span>
01601 <span class="comment">                      must be held on entry regardless.</span>
01602 <span class="comment"></span>
01603 <span class="comment">Return Value:</span>
01604 <span class="comment"></span>
01605 <span class="comment">    Status of the map view operation.</span>
01606 <span class="comment"></span>
01607 <span class="comment">Environment:</span>
01608 <span class="comment"></span>
01609 <span class="comment">    Kernel Mode, address creation mutex held.</span>
01610 <span class="comment"></span>
01611 <span class="comment">--*/</span>
01612 
01613 {
01614     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Vad;
01615     PVOID StartingAddress;
01616     PVOID EndingAddress;
01617     BOOLEAN Attached;
01618     KIRQL OldIrql;
01619     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> Subsection;
01620     ULONG PteOffset;
01621     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> ReturnedStatus;
01622     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> ProtoPte;
01623     PVOID BasedAddress;
01624     SIZE_T NeededViewSize;
01625 <span class="preprocessor">#if defined(_ALPHA_)</span>
01626 <span class="preprocessor"></span>    ULONG_PTR Starting2gb;
01627     ULONG_PTR Ending2gb;
01628     ULONG_PTR BoundaryMask;
01629     LOGICAL AlignmentOk;
01630 <span class="preprocessor">#endif</span>
01631 <span class="preprocessor"></span><span class="preprocessor">#if defined(_MIALT4K_)</span>
01632 <span class="preprocessor"></span>    <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerAltPte;
01633     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> ProtoAltPte;
01634     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempAltPte;
01635     PIMAGE_NT_HEADERS NtHeaders;
01636     ULONG ImageAlignment;
01637 <span class="preprocessor">#endif</span>
01638 <span class="preprocessor"></span>
01639     Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01640 
01641     <span class="comment">//</span>
01642     <span class="comment">// Image file.</span>
01643     <span class="comment">//</span>
01644     <span class="comment">// Locate the first subsection (text) and create a virtual</span>
01645     <span class="comment">// address descriptor to map the entire image here.</span>
01646     <span class="comment">//</span>
01647 
01648     <span class="keywordflow">if</span> (ControlArea-&gt;u.Flags.GlobalOnlyPerSession == 0) {
01649         Subsection = (<a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a>)(ControlArea + 1);
01650     }
01651     <span class="keywordflow">else</span> {
01652         Subsection = (<a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a>)((<a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html">PLARGE_CONTROL_AREA</a>)ControlArea + 1);
01653     }
01654 
01655     <span class="keywordflow">if</span> (ControlArea-&gt;u.Flags.ImageMappedInSystemSpace) {
01656 
01657         <span class="keywordflow">if</span> (KeGetPreviousMode() != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
01658 
01659             <span class="comment">//</span>
01660             <span class="comment">// Mapping in system space as a driver, hence copy on write does</span>
01661             <span class="comment">// not work.  Don't allow user processes to map the image.</span>
01662             <span class="comment">//</span>
01663 
01664             *ReleasedWsMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01665             <span class="keywordflow">return</span> STATUS_CONFLICTING_ADDRESSES;
01666         }
01667     }
01668 
01669     <span class="comment">//</span>
01670     <span class="comment">// Check to see if a purge operation is in progress and if so, wait</span>
01671     <span class="comment">// for the purge to complete.  In addition, up the count of mapped</span>
01672     <span class="comment">// views for this control area.</span>
01673     <span class="comment">//</span>
01674 
01675     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a928">MiCheckPurgeAndUpMapCount</a> (ControlArea) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01676         *ReleasedWsMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01677         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01678     }
01679 
01680     <span class="comment">//</span>
01681     <span class="comment">// Capture the based address to the stack, to prevent page faults.</span>
01682     <span class="comment">//</span>
01683 
01684     BasedAddress = ControlArea-&gt;Segment-&gt;BasedAddress;
01685 
01686     <span class="keywordflow">if</span> (*CapturedViewSize == 0) {
01687         *CapturedViewSize =
01688             (ULONG_PTR)(Section-&gt;SizeOfSection.QuadPart - SectionOffset-&gt;QuadPart);
01689     }
01690 
01691     <a class="code" href="../../d4/d8/mi_8h.html#a155">LOCK_WS_UNSAFE</a> (Process);
01692 
01693     ReturnedStatus = STATUS_SUCCESS;
01694 
01695     <span class="comment">//</span>
01696     <span class="comment">// Determine if a specific base was specified.</span>
01697     <span class="comment">//</span>
01698 
01699     <span class="keywordflow">if</span> (*CapturedBase != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01700 
01701         <span class="comment">//</span>
01702         <span class="comment">// Captured base is not NULL.</span>
01703         <span class="comment">//</span>
01704         <span class="comment">// Check to make sure the specified address range is currently unused</span>
01705         <span class="comment">// and within the user address space.</span>
01706         <span class="comment">//</span>
01707 
01708         Vad = (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)1;
01709         StartingAddress = <a class="code" href="../../d4/d8/mi_8h.html#a91">MI_64K_ALIGN</a>(*CapturedBase);
01710         EndingAddress = (PVOID)(((ULONG_PTR)StartingAddress +
01711                                        *CapturedViewSize - 1) | (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1));
01712 
01713         <span class="keywordflow">if</span> ((StartingAddress &lt;=  <a class="code" href="../../d4/d8/mi_8h.html#a19">MM_HIGHEST_VAD_ADDRESS</a>) &amp;&amp;
01714             (((ULONG_PTR)<a class="code" href="../../d4/d8/mi_8h.html#a19">MM_HIGHEST_VAD_ADDRESS</a> + 1) -
01715                                 (ULONG_PTR)StartingAddress &gt;= *CapturedViewSize) &amp;&amp;
01716 
01717             (EndingAddress &lt;= <a class="code" href="../../d4/d8/mi_8h.html#a19">MM_HIGHEST_VAD_ADDRESS</a>)) {
01718 
01719             Vad = <a class="code" href="../../d4/d8/mi_8h.html#a98">MiCheckForConflictingVad</a> (StartingAddress, EndingAddress);
01720         }
01721 
01722         <span class="keywordflow">if</span> (Vad != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01723 <span class="preprocessor">#if DBG</span>
01724 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (Vad != (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)1) {
01725                 MiDumpConflictingVad (StartingAddress, EndingAddress, Vad);
01726             }
01727 <span class="preprocessor">#endif</span>
01728 <span class="preprocessor"></span>
01729             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01730             ControlArea-&gt;NumberOfMappedViews -= 1;
01731             ControlArea-&gt;NumberOfUserReferences -= 1;
01732 
01733             <span class="comment">//</span>
01734             <span class="comment">// Check to see if the control area (segment) should be deleted.</span>
01735             <span class="comment">// This routine releases the PFN lock.</span>
01736             <span class="comment">//</span>
01737         
01738             <a class="code" href="../../d5/d5/sectsup_8c.html#a24">MiCheckControlArea</a> (ControlArea, Process, OldIrql);
01739             <span class="keywordflow">return</span> STATUS_CONFLICTING_ADDRESSES;
01740         }
01741 
01742         <span class="comment">//</span>
01743         <span class="comment">// A conflicting VAD was not found and the specified address range is</span>
01744         <span class="comment">// within the user address space. If the image will not reside at its</span>
01745         <span class="comment">// base address, then set a special return status.</span>
01746         <span class="comment">//</span>
01747 
01748         <span class="keywordflow">if</span> (((ULONG_PTR)StartingAddress +
01749             (ULONG_PTR)<a class="code" href="../../d4/d8/mi_8h.html#a91">MI_64K_ALIGN</a>(SectionOffset-&gt;LowPart)) != (ULONG_PTR)BasedAddress) {
01750             ReturnedStatus = STATUS_IMAGE_NOT_AT_BASE;
01751         }
01752 
01753     } <span class="keywordflow">else</span> {
01754 
01755         <span class="comment">//</span>
01756         <span class="comment">// Captured base is NULL.</span>
01757         <span class="comment">//</span>
01758         <span class="comment">// If the captured view size is greater than the largest size that</span>
01759         <span class="comment">// can fit in the user address space, then it is not possible to map</span>
01760         <span class="comment">// the image.</span>
01761         <span class="comment">//</span>
01762 
01763         <span class="keywordflow">if</span> ((PVOID)*CapturedViewSize &gt; <a class="code" href="../../d4/d8/mi_8h.html#a19">MM_HIGHEST_VAD_ADDRESS</a>) {
01764             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01765             ControlArea-&gt;NumberOfMappedViews -= 1;
01766             ControlArea-&gt;NumberOfUserReferences -= 1;
01767 
01768             <span class="comment">//</span>
01769             <span class="comment">// Check to see if the control area (segment) should be deleted.</span>
01770             <span class="comment">// This routine releases the PFN lock.</span>
01771             <span class="comment">//</span>
01772         
01773             <a class="code" href="../../d5/d5/sectsup_8c.html#a24">MiCheckControlArea</a> (ControlArea, Process, OldIrql);
01774             <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01775         }
01776 
01777         <span class="comment">//</span>
01778         <span class="comment">// Check to make sure the specified address range is currently unused</span>
01779         <span class="comment">// and within the user address space.</span>
01780         <span class="comment">//</span>
01781 
01782         StartingAddress = (PVOID)((ULONG_PTR)BasedAddress +
01783                                     (ULONG_PTR)<a class="code" href="../../d4/d8/mi_8h.html#a91">MI_64K_ALIGN</a>(SectionOffset-&gt;LowPart));
01784 
01785         EndingAddress = (PVOID)(((ULONG_PTR)StartingAddress +
01786                                     *CapturedViewSize - 1) | (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1));
01787 
01788         Vad = (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)1;
01789         NeededViewSize = *CapturedViewSize;
01790 
01791 <span class="preprocessor">#if defined(_ALPHA_)</span>
01792 <span class="preprocessor"></span>
01793 <span class="preprocessor">#if defined(_AXP64_)</span>
01794 <span class="preprocessor"></span><span class="preprocessor">#define BOUNDARY ((LONG_PTR)_2gb)</span>
01795 <span class="preprocessor"></span><span class="preprocessor">#else</span>
01796 <span class="preprocessor"></span><span class="preprocessor">#define BOUNDARY ((ULONG_PTR)_2gb)</span>
01797 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
01798 <span class="preprocessor"></span>
01799         <span class="comment">//</span>
01800         <span class="comment">// Alpha images cannot span 2GB boundaries with the current compiler</span>
01801         <span class="comment">// generated branch instructions.  If a spanning image is detected, it</span>
01802         <span class="comment">// must be relocated.</span>
01803         <span class="comment">//</span>
01804 
01805         BoundaryMask = (ULONG_PTR)~(BOUNDARY-1);
01806 
01807         Starting2gb = (ULONG_PTR)StartingAddress &amp; BoundaryMask;
01808         Ending2gb = (ULONG_PTR)EndingAddress &amp; BoundaryMask;
01809 
01810         AlignmentOk = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01811 
01812         <span class="keywordflow">if</span> (Starting2gb != Ending2gb) {
01813             AlignmentOk = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01814             <span class="keywordflow">if</span> (Starting2gb + 1 == Ending2gb) {
01815                 <span class="keywordflow">if</span> (((ULONG_PTR)EndingAddress &amp; (BOUNDARY-1)) == 0) {
01816                     AlignmentOk = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01817                 }
01818             }
01819         }
01820 
01821         <span class="keywordflow">if</span> (AlignmentOk == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01822 
01823             <span class="comment">//</span>
01824             <span class="comment">// Find twice the required size so that it can be placed correctly.</span>
01825             <span class="comment">//</span>
01826 
01827             NeededViewSize = *CapturedViewSize * 2 + <a class="code" href="../../d4/d8/mi_8h.html#a18">X64K</a>;
01828         }
01829         <span class="keywordflow">else</span>
01830 <span class="preprocessor">#endif</span>
01831 <span class="preprocessor"></span>
01832         <span class="keywordflow">if</span> ((StartingAddress &gt;= MM_LOWEST_USER_ADDRESS) &amp;&amp;
01833             (StartingAddress &lt;= <a class="code" href="../../d4/d8/mi_8h.html#a19">MM_HIGHEST_VAD_ADDRESS</a>) &amp;&amp;
01834             (((ULONG_PTR)<a class="code" href="../../d4/d8/mi_8h.html#a19">MM_HIGHEST_VAD_ADDRESS</a> + 1) -
01835                                 (ULONG_PTR)StartingAddress &gt;= *CapturedViewSize) &amp;&amp;
01836 
01837             (EndingAddress &lt;= <a class="code" href="../../d4/d8/mi_8h.html#a19">MM_HIGHEST_VAD_ADDRESS</a>)) {
01838 
01839             Vad = <a class="code" href="../../d4/d8/mi_8h.html#a98">MiCheckForConflictingVad</a> (StartingAddress, EndingAddress);
01840         }
01841 
01842         <span class="comment">//</span>
01843         <span class="comment">// If the VAD address is not NULL, then a conflict was discovered.</span>
01844         <span class="comment">// Attempt to select another address range in which to map the image.</span>
01845         <span class="comment">//</span>
01846 
01847         <span class="keywordflow">if</span> (Vad != (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01848 
01849             <span class="comment">//</span>
01850             <span class="comment">// The image could not be mapped at its natural base address</span>
01851             <span class="comment">// try to find another place to map it.</span>
01852             <span class="comment">//</span>
01853 <span class="preprocessor">#if DBG</span>
01854 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (Vad != (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)1) {
01855                 MiDumpConflictingVad (StartingAddress, EndingAddress, Vad);
01856             }
01857 <span class="preprocessor">#endif</span>
01858 <span class="preprocessor"></span>
01859             <span class="comment">//</span>
01860             <span class="comment">// If the system has been biased to an alternate base address to</span>
01861             <span class="comment">// allow 3gb of user address space, then make sure the high order</span>
01862             <span class="comment">// address bit is zero.</span>
01863             <span class="comment">//</span>
01864 
01865 <span class="preprocessor">#if defined(_X86_)</span>
01866 <span class="preprocessor"></span>
01867             <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d1/mm_8h.html#a126">MmVirtualBias</a> != 0) &amp;&amp;
01868                 (ZeroBits == 0)) {
01869                 ZeroBits = 1;
01870             }
01871 <span class="preprocessor">#endif</span>
01872 <span class="preprocessor"></span>
01873             ReturnedStatus = STATUS_IMAGE_NOT_AT_BASE;
01874             <span class="keywordflow">try</span> {
01875 
01876                 <span class="comment">//</span>
01877                 <span class="comment">// Find a starting address on a 64k boundary.</span>
01878                 <span class="comment">//</span>
01879 
01880                 StartingAddress = <a class="code" href="../../d6/d3/vadtree_8c.html#a3">MiFindEmptyAddressRange</a> (NeededViewSize,
01881                                                            <a class="code" href="../../d4/d8/mi_8h.html#a18">X64K</a>,
01882                                                            (ULONG)ZeroBits);
01883 
01884 
01885             } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
01886                 <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01887                 ControlArea-&gt;NumberOfMappedViews -= 1;
01888                 ControlArea-&gt;NumberOfUserReferences -= 1;
01889 
01890                 <span class="comment">//</span>
01891                 <span class="comment">// Check to see if the control area (segment) should be deleted.</span>
01892                 <span class="comment">// This routine releases the PFN lock.</span>
01893                 <span class="comment">//</span>
01894             
01895                 <a class="code" href="../../d5/d5/sectsup_8c.html#a24">MiCheckControlArea</a> (ControlArea, Process, OldIrql);
01896 
01897                 <span class="keywordflow">return</span> GetExceptionCode();
01898             }
01899 
01900             EndingAddress = (PVOID)(((ULONG_PTR)StartingAddress +
01901                                         *CapturedViewSize - 1) | (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1));
01902 
01903 <span class="preprocessor">#if defined(_ALPHA_)</span>
01904 <span class="preprocessor"></span>
01905             <span class="keywordflow">if</span> (AlignmentOk == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01906                 Starting2gb = (ULONG_PTR)StartingAddress &amp; ~(BOUNDARY-1);
01907                 Ending2gb = (ULONG_PTR)EndingAddress &amp; ~(BOUNDARY-1);
01908         
01909                 <span class="keywordflow">if</span> (Starting2gb != Ending2gb) {
01910     
01911                     <span class="comment">//</span>
01912                     <span class="comment">// Not in the same 2gb.  Up the start to a 2gb boundary.</span>
01913                     <span class="comment">//</span>
01914     
01915                     StartingAddress = (PVOID)Ending2gb;
01916                     EndingAddress = (PVOID)(((ULONG_PTR)StartingAddress +
01917                                         *CapturedViewSize - 1) | (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1));
01918                 }
01919             }
01920 <span class="preprocessor">#endif</span>
01921 <span class="preprocessor"></span>
01922         }
01923     }
01924 
01925     <span class="comment">//</span>
01926     <span class="comment">// Allocate and initialize a VAD for the specified address range.</span>
01927     <span class="comment">//</span>
01928 
01929     Vad = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d6/struct__MMVAD.html">MMVAD</a>), <a class="code" href="../../d3/d6/allocvm_8c.html#a0">MMVADKEY</a>);
01930     <span class="keywordflow">try</span>  {
01931         <span class="keywordflow">if</span> (Vad == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01932             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_INSUFFICIENT_RESOURCES);
01933         }
01934 
01935         RtlZeroMemory (Vad, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/mi_8h.html#a489">MMVAD</a>));
01936         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a> = <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (StartingAddress);
01937         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a> = <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (EndingAddress);
01938         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.Inherit = (InheritDisposition == ViewShare);
01939         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.ImageMap = 1;
01940 
01941         <span class="comment">//</span>
01942         <span class="comment">// Set the protection in the VAD as EXECUTE_WRITE_COPY.</span>
01943         <span class="comment">//</span>
01944 
01945         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.Protection = <a class="code" href="../../d4/d8/mi_8h.html#a42">MM_EXECUTE_WRITECOPY</a>;
01946         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o8">ControlArea</a> = ControlArea;
01947 
01948         <span class="comment">//</span>
01949         <span class="comment">// Set the first prototype PTE field in the Vad.</span>
01950         <span class="comment">//</span>
01951 
01952         SectionOffset-&gt;LowPart = SectionOffset-&gt;LowPart &amp; ~(<a class="code" href="../../d4/d8/mi_8h.html#a18">X64K</a> - 1);
01953         PteOffset = (ULONG)(SectionOffset-&gt;QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
01954 
01955         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o9">FirstPrototypePte</a> = &amp;Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>[PteOffset];
01956         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o10">LastContiguousPte</a> = <a class="code" href="../../d4/d8/mi_8h.html#a13">MM_ALLOCATION_FILLS_VAD</a>;
01957 
01958         <span class="comment">//</span>
01959         <span class="comment">// NOTE: the full commitment is charged even if a partial map of an</span>
01960         <span class="comment">// image is being done.  This saves from having to run through the</span>
01961         <span class="comment">// entire image (via prototype PTEs) and calculate the charge on</span>
01962         <span class="comment">// a per page basis for the partial map.</span>
01963         <span class="comment">//</span>
01964 
01965         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.CommitCharge = (SIZE_T)ImageCommitment; <span class="comment">// ****** temp</span>
01966 
01967         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o9">FirstPrototypePte</a> &lt;= Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o10">LastContiguousPte</a>);
01968 
01969         <a class="code" href="../../d6/d3/vadtree_8c.html#a0">MiInsertVad</a> (Vad);
01970 
01971     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
01972         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01973         ControlArea-&gt;NumberOfMappedViews -= 1;
01974         ControlArea-&gt;NumberOfUserReferences -= 1;
01975 
01976         <span class="comment">//</span>
01977         <span class="comment">// Check to see if the control area (segment) should be deleted.</span>
01978         <span class="comment">// This routine releases the PFN lock.</span>
01979         <span class="comment">//</span>
01980     
01981         <a class="code" href="../../d5/d5/sectsup_8c.html#a24">MiCheckControlArea</a> (ControlArea, Process, OldIrql);
01982 
01983         <span class="keywordflow">if</span> (Vad != (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01984 
01985             <span class="comment">//</span>
01986             <span class="comment">// The pool allocation succeeded, but the quota charge</span>
01987             <span class="comment">// in InsertVad failed, deallocate the pool and return</span>
01988             <span class="comment">// an error.</span>
01989             <span class="comment">//</span>
01990 
01991             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Vad);
01992             <span class="keywordflow">return</span> GetExceptionCode();
01993         }
01994 
01995         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01996     }
01997 
01998     *CapturedViewSize = (PCHAR)EndingAddress - (PCHAR)StartingAddress + 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
01999     *CapturedBase = StartingAddress;
02000 
02001 <span class="preprocessor">#if DBG</span>
02002 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a76">MM_DBG_WALK_VAD_TREE</a>) {
02003         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"mapped image section vads\n"</span>);
02004         <a class="code" href="../../d5/d5/sectsup_8c.html#a12">VadTreeWalk</a>(Process-&gt;VadRoot);
02005     }
02006 <span class="preprocessor">#endif</span>
02007 <span class="preprocessor"></span>
02008     <span class="comment">//</span>
02009     <span class="comment">// Update the current virtual size in the process header.</span>
02010     <span class="comment">//</span>
02011 
02012     Process-&gt;VirtualSize += *CapturedViewSize;
02013 
02014     <span class="keywordflow">if</span> (Process-&gt;VirtualSize &gt; Process-&gt;PeakVirtualSize) {
02015         Process-&gt;PeakVirtualSize = Process-&gt;VirtualSize;
02016     }
02017 
02018     <span class="keywordflow">if</span> (ControlArea-&gt;u.Flags.FloppyMedia) {
02019 
02020         *ReleasedWsMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02021         <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (Process);
02022 
02023         <span class="comment">//</span>
02024         <span class="comment">// The image resides on a floppy disk, in-page all</span>
02025         <span class="comment">// pages from the floppy and mark them as modified so</span>
02026         <span class="comment">// they migrate to the paging file rather than reread</span>
02027         <span class="comment">// them from the floppy disk which may have been removed.</span>
02028         <span class="comment">//</span>
02029 
02030         ProtoPte = Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o9">FirstPrototypePte</a>;
02031 
02032         <span class="comment">//</span>
02033         <span class="comment">// This could get an in-page error from the floppy.</span>
02034         <span class="comment">//</span>
02035 
02036         <span class="keywordflow">while</span> (StartingAddress &lt; EndingAddress) {
02037 
02038             <span class="comment">//</span>
02039             <span class="comment">// If the prototype PTE is valid, transition or</span>
02040             <span class="comment">// in prototype PTE format, bring the page into</span>
02041             <span class="comment">// memory and set the modified bit.</span>
02042             <span class="comment">//</span>
02043 
02044             <span class="keywordflow">if</span> ((ProtoPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) ||
02045                 (ProtoPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 1) ||
02046                 (ProtoPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 1)) {
02047 
02048                 <span class="keywordflow">try</span> {
02049 
02050                     <a class="code" href="../../d3/d5/mapview_8c.html#a9">MiSetPageModified</a> (StartingAddress);
02051 
02052                 } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
02053 
02054                     <span class="comment">//</span>
02055                     <span class="comment">// An in page error must have occurred touching the image,</span>
02056                     <span class="comment">// ignore the error and continue to the next page.</span>
02057                     <span class="comment">//</span>
02058 
02059                     NOTHING;
02060                 }
02061             }
02062             ProtoPte += 1;
02063             StartingAddress = (PVOID)((PCHAR)StartingAddress + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
02064         }
02065     }
02066 
02067     <span class="keywordflow">if</span> (!*ReleasedWsMutex) {
02068         *ReleasedWsMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02069         <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (Process);
02070     }
02071 
02072     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ReturnedStatus)) {
02073 
02074 
02075         <span class="comment">//</span>
02076         <span class="comment">// Check to see if this image is for the architecture of the current</span>
02077         <span class="comment">// machine.</span>
02078         <span class="comment">//</span>
02079 
02080         <span class="keywordflow">if</span> (ControlArea-&gt;Segment-&gt;ImageInformation-&gt;ImageContainsCode &amp;&amp;
02081             ((ControlArea-&gt;Segment-&gt;ImageInformation-&gt;Machine &lt;
02082                                           USER_SHARED_DATA-&gt;ImageNumberLow) ||
02083              (ControlArea-&gt;Segment-&gt;ImageInformation-&gt;Machine &gt;
02084                                           USER_SHARED_DATA-&gt;ImageNumberHigh)
02085             )
02086            ) {
02087 <span class="preprocessor">#if defined (_WIN64)</span>
02088 <span class="preprocessor"></span>
02089             <span class="comment">//</span>
02090             <span class="comment">// If this is a wow64 process, allow i386 images</span>
02091             <span class="comment">//</span>
02092 
02093             <span class="keywordflow">if</span> (!Process-&gt;Wow64Process ||
02094                 ControlArea-&gt;Segment-&gt;ImageInformation-&gt;Machine != IMAGE_FILE_MACHINE_I386) {
02095                 <span class="keywordflow">return</span> STATUS_IMAGE_MACHINE_TYPE_MISMATCH;
02096             }
02097 <span class="preprocessor">#else   </span>
02098 <span class="preprocessor">            return STATUS_IMAGE_MACHINE_TYPE_MISMATCH;</span>
02099 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
02100 <span class="preprocessor"></span>        }
02101 
02102         StartingAddress = <a class="code" href="../../d4/d8/mi_8h.html#a108">MI_VPN_TO_VA</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a>);
02103 
02104         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a72">PsImageNotifyEnabled</a>) {
02105 
02106             <a class="code" href="../../d2/d1/struct__IMAGE__INFO.html">IMAGE_INFO</a> ImageInfo;
02107 
02108             <span class="keywordflow">if</span> ( (StartingAddress &lt; <a class="code" href="../../d0/d9/miglobal_8c.html#a0">MmHighestUserAddress</a>) &amp;&amp;
02109                  Process-&gt;UniqueProcessId &amp;&amp;
02110                  Process != <a class="code" href="../../d1/d9/ps_8h.html#a53">PsInitialSystemProcess</a> ) {
02111 
02112                 ImageInfo.<a class="code" href="../../d2/d1/struct__IMAGE__INFO.html#o0">Properties</a> = 0;
02113                 ImageInfo.<a class="code" href="../../d2/d1/struct__IMAGE__INFO.html#o1">ImageAddressingMode</a> = <a class="code" href="../../d1/d9/ps_8h.html#a23">IMAGE_ADDRESSING_MODE_32BIT</a>;
02114                 ImageInfo.<a class="code" href="../../d2/d1/struct__IMAGE__INFO.html#o5">ImageBase</a> = StartingAddress;
02115                 ImageInfo.<a class="code" href="../../d2/d1/struct__IMAGE__INFO.html#o7">ImageSize</a> = *CapturedViewSize;
02116                 ImageInfo.<a class="code" href="../../d2/d1/struct__IMAGE__INFO.html#o6">ImageSelector</a> = 0;
02117                 ImageInfo.<a class="code" href="../../d2/d1/struct__IMAGE__INFO.html#o8">ImageSectionNumber</a> = 0;
02118                 <a class="code" href="../../d2/d8/ps_2create_8c.html#a28">PsCallImageNotifyRoutines</a>(
02119                             (PUNICODE_STRING) &amp;ControlArea-&gt;FilePointer-&gt;FileName,
02120                             Process-&gt;UniqueProcessId,
02121                             &amp;ImageInfo
02122                             );
02123             }
02124         }
02125 
02126         <span class="keywordflow">if</span> ((<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_ENABLE_KDEBUG_SYMBOL_LOAD) &amp;&amp;
02127             (ControlArea-&gt;u.Flags.Image) &amp;&amp;
02128             (ReturnedStatus != STATUS_IMAGE_NOT_AT_BASE)) {
02129             <span class="keywordflow">if</span> (ControlArea-&gt;u.Flags.DebugSymbolsLoaded == 0) {
02130                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/sysload_8c.html#a30">CacheImageSymbols</a> (StartingAddress)) {
02131 
02132                     <span class="comment">//</span>
02133                     <span class="comment">//  TEMP TEMP TEMP rip out when debugger converted</span>
02134                     <span class="comment">//</span>
02135 
02136                     PUNICODE_STRING <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>;
02137                     ANSI_STRING AnsiName;
02138                     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02139 
02140                     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02141                     ControlArea-&gt;u.Flags.DebugSymbolsLoaded = 1;
02142                     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02143 
02144                     <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a> = (PUNICODE_STRING)&amp;ControlArea-&gt;FilePointer-&gt;FileName;
02145                     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length != 0 &amp;&amp; (<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_ENABLE_KDEBUG_SYMBOL_LOAD)) {
02146                         PLIST_ENTRY Head, Next;
02147                         PLDR_DATA_TABLE_ENTRY Entry;
02148 
02149                         <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
02150                         <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a> (&amp;<a class="code" href="../../d1/d9/ps_8h.html#a57">PsLoadedModuleResource</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02151                         Head = &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a20">MmLoadedUserImageList</a>;
02152                         Next = Head-&gt;Flink;
02153                         <span class="keywordflow">while</span> (Next != Head) {
02154                             Entry = CONTAINING_RECORD( Next,
02155                                                        LDR_DATA_TABLE_ENTRY,
02156                                                        InLoadOrderLinks
02157                                                      );
02158                             <span class="keywordflow">if</span> (Entry-&gt;DllBase == StartingAddress) {
02159                                 Entry-&gt;LoadCount += 1;
02160                                 <span class="keywordflow">break</span>;
02161                             }
02162                             Next = Next-&gt;Flink;
02163                         }
02164 
02165                         <span class="keywordflow">if</span> (Next == Head) {
02166                             Entry = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
02167                                                     <span class="keyword">sizeof</span>( *Entry ) +
02168                                                         <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length +
02169                                                         <span class="keyword">sizeof</span>( UNICODE_NULL ),
02170                                                         <a class="code" href="../../d3/d5/mapview_8c.html#a3">MMDB</a>
02171                                                   );
02172                             <span class="keywordflow">if</span> (Entry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02173                                 PIMAGE_NT_HEADERS NtHeaders;
02174 
02175                                 RtlZeroMemory (Entry, <span class="keyword">sizeof</span>(*Entry));
02176 
02177                                 <span class="keywordflow">try</span> {
02178                                     NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a> (StartingAddress);
02179                                     <span class="keywordflow">if</span> (NtHeaders != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02180 <span class="preprocessor">#if defined(_WIN64)</span>
02181 <span class="preprocessor"></span>                                        <span class="keywordflow">if</span> (NtHeaders-&gt;OptionalHeader.Magic == IMAGE_NT_OPTIONAL_HDR64_MAGIC) {
02182                                             Entry-&gt;SizeOfImage = NtHeaders-&gt;OptionalHeader.SizeOfImage;
02183                                             Entry-&gt;CheckSum = NtHeaders-&gt;OptionalHeader.CheckSum;
02184                                         }
02185                                         <span class="keywordflow">else</span> {
02186                                             PIMAGE_NT_HEADERS32 NtHeaders32 = (PIMAGE_NT_HEADERS32)NtHeaders;
02187 
02188                                             Entry-&gt;SizeOfImage = NtHeaders32-&gt;OptionalHeader.SizeOfImage;
02189                                             Entry-&gt;CheckSum = NtHeaders32-&gt;OptionalHeader.CheckSum;
02190                                         }
02191 <span class="preprocessor">#else</span>
02192 <span class="preprocessor"></span>                                        Entry-&gt;SizeOfImage = NtHeaders-&gt;OptionalHeader.SizeOfImage;
02193                                         Entry-&gt;CheckSum = NtHeaders-&gt;OptionalHeader.CheckSum;
02194 <span class="preprocessor">#endif</span>
02195 <span class="preprocessor"></span>                                    }
02196                                 } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
02197                                     NOTHING;
02198                                 }
02199 
02200                                 Entry-&gt;DllBase = StartingAddress;
02201                                 Entry-&gt;FullDllName.Buffer = (PWSTR)(Entry+1);
02202                                 Entry-&gt;FullDllName.Length = <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length;
02203                                 Entry-&gt;FullDllName.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)
02204                                     (Entry-&gt;FullDllName.Length + <span class="keyword">sizeof</span>( UNICODE_NULL ));
02205                                 RtlMoveMemory( Entry-&gt;FullDllName.Buffer,
02206                                                <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Buffer,
02207                                                <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length
02208                                              );
02209                                 Entry-&gt;FullDllName.Buffer[ Entry-&gt;FullDllName.Length / <span class="keyword">sizeof</span>( WCHAR )] = UNICODE_NULL;
02210                                 Entry-&gt;LoadCount = 1;
02211                                 InsertTailList( &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a20">MmLoadedUserImageList</a>,
02212                                                 &amp;Entry-&gt;InLoadOrderLinks
02213                                               );
02214                                 InitializeListHead( &amp;Entry-&gt;InInitializationOrderLinks );
02215                                 InitializeListHead( &amp;Entry-&gt;InMemoryOrderLinks );
02216                             }
02217                         }
02218 
02219                         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a> (&amp;<a class="code" href="../../d1/d9/ps_8h.html#a57">PsLoadedModuleResource</a>);
02220                         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
02221                     }
02222 
02223                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a23">RtlUnicodeStringToAnsiString</a>( &amp;AnsiName,
02224                                                            <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>,
02225                                                            <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
02226 
02227                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02228                         DbgLoadImageSymbols( &amp;AnsiName,
02229                                              StartingAddress,
02230                                              (ULONG_PTR)Process
02231                                            );
02232                         <a class="code" href="../../d6/d6/nls_8c.html#a35">RtlFreeAnsiString</a>( &amp;AnsiName );
02233                     }
02234                 }
02235             }
02236         }
02237     }
02238 
02239 <span class="preprocessor">#if defined(_MIALT4K_)</span>
02240 <span class="preprocessor"></span>
02241     <span class="keywordflow">if</span> (Process-&gt;Wow64Process != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02242 
02243         <a class="code" href="../../d2/d9/miia64_8h.html#a305">MiProtectImageFileFor4kPage</a>(StartingAddress,
02244                                     *CapturedViewSize,
02245                                     Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o9">FirstPrototypePte</a>,
02246                                     Process);
02247     }
02248 
02249 <span class="preprocessor">#endif</span>
02250 <span class="preprocessor"></span>
02251     <span class="keywordflow">return</span> ReturnedStatus;
02252 
02253 }
02254 
02255 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02256"></a><a class="code" href="../../d3/d5/mapview_8c.html#a24">02256</a> <a class="code" href="../../d3/d5/mapview_8c.html#a24">MiMapViewOfDataSection</a> (
02257     IN <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea,
02258     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
02259     IN PVOID *CapturedBase,
02260     IN PLARGE_INTEGER SectionOffset,
02261     IN PSIZE_T CapturedViewSize,
02262     IN PSECTION Section,
02263     IN SECTION_INHERIT InheritDisposition,
02264     IN ULONG ProtectionMask,
02265     IN SIZE_T CommitSize,
02266     IN ULONG_PTR ZeroBits,
02267     IN ULONG AllocationType,
02268     IN PBOOLEAN ReleasedWsMutex
02269     )
02270 
02271 <span class="comment">/*++</span>
02272 <span class="comment"></span>
02273 <span class="comment">Routine Description:</span>
02274 <span class="comment"></span>
02275 <span class="comment">    This routine maps the specified physical section into the</span>
02276 <span class="comment">    specified process's address space.</span>
02277 <span class="comment"></span>
02278 <span class="comment">Arguments:</span>
02279 <span class="comment"></span>
02280 <span class="comment">    see MmMapViewOfSection above...</span>
02281 <span class="comment"></span>
02282 <span class="comment">    ControlArea - Supplies the control area for the section.</span>
02283 <span class="comment"></span>
02284 <span class="comment">    Process - Supplies the process pointer which is receiving the section.</span>
02285 <span class="comment"></span>
02286 <span class="comment">    ProtectionMask - Supplies the initial page protection-mask.</span>
02287 <span class="comment"></span>
02288 <span class="comment">    ReleasedWsMutex - Supplies FALSE. If the working set mutex is</span>
02289 <span class="comment">                      not held when returning this must be set to TRUE</span>
02290 <span class="comment">                      so the caller will not release the unheld mutex.</span>
02291 <span class="comment"></span>
02292 <span class="comment">                      Note if this routine acquires the working set mutex</span>
02293 <span class="comment">                      it is always done unsafely as the address space mutex</span>
02294 <span class="comment">                      must be held on entry regardless.</span>
02295 <span class="comment"></span>
02296 <span class="comment">Return Value:</span>
02297 <span class="comment"></span>
02298 <span class="comment">    Status of the map view operation.</span>
02299 <span class="comment"></span>
02300 <span class="comment">Environment:</span>
02301 <span class="comment"></span>
02302 <span class="comment">    Kernel Mode, address creation mutex held.</span>
02303 <span class="comment"></span>
02304 <span class="comment">--*/</span>
02305 
02306 {
02307     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Vad;
02308     PVOID StartingAddress;
02309     PVOID EndingAddress;
02310     BOOLEAN Attached;
02311     KIRQL OldIrql;
02312     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> Subsection;
02313     ULONG PteOffset;
02314     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
02315     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
02316     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
02317     ULONG_PTR Alignment;
02318     SIZE_T QuotaCharge;
02319     BOOLEAN ChargedQuota;
02320     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> TheFirstPrototypePte;
02321     PVOID CapturedStartingVa;
02322     ULONG CapturedCopyOnWrite;
02323 <span class="preprocessor">#if defined(_MIALT4K_)</span>
02324 <span class="preprocessor"></span>    SIZE_T ViewSizeFor4k;
02325 <span class="preprocessor">#endif</span>
02326 <span class="preprocessor"></span>
02327     Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02328     QuotaCharge = 0;
02329     ChargedQuota = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02330 
02331     <span class="keywordflow">if</span> ((AllocationType &amp; MEM_RESERVE) &amp;&amp;
02332         (ControlArea-&gt;FilePointer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
02333         *ReleasedWsMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02334         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_9;
02335     }
02336 
02337     <span class="comment">//</span>
02338     <span class="comment">// Check to see if there is a purge operation ongoing for</span>
02339     <span class="comment">// this segment.</span>
02340     <span class="comment">//</span>
02341 
02342     <span class="keywordflow">if</span> ((AllocationType &amp; MEM_DOS_LIM) != 0) {
02343         <span class="keywordflow">if</span> ((*CapturedBase == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
02344             (AllocationType &amp; MEM_RESERVE)) {
02345 
02346             <span class="comment">//</span>
02347             <span class="comment">// If MEM_DOS_LIM is specified, the address to map the</span>
02348             <span class="comment">// view MUST be specified as well.</span>
02349             <span class="comment">//</span>
02350 
02351             *ReleasedWsMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02352             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_3;
02353         }
02354         Alignment = <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
02355     } <span class="keywordflow">else</span> {
02356        Alignment = <a class="code" href="../../d4/d8/mi_8h.html#a18">X64K</a>;
02357     }
02358 
02359     <span class="comment">//</span>
02360     <span class="comment">// Check to see if a purge operation is in progress and if so, wait</span>
02361     <span class="comment">// for the purge to complete.  In addition, up the count of mapped</span>
02362     <span class="comment">// views for this control area.</span>
02363     <span class="comment">//</span>
02364 
02365     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a928">MiCheckPurgeAndUpMapCount</a> (ControlArea) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
02366         *ReleasedWsMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02367         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
02368     }
02369 
02370     <span class="keywordflow">if</span> (*CapturedViewSize == 0) {
02371 
02372         SectionOffset-&gt;LowPart = SectionOffset-&gt;LowPart &amp; ~((ULONG)Alignment - 1);
02373         *CapturedViewSize = (ULONG_PTR)(Section-&gt;SizeOfSection.QuadPart -
02374                                     SectionOffset-&gt;QuadPart);
02375     } <span class="keywordflow">else</span> {
02376         *CapturedViewSize += SectionOffset-&gt;LowPart &amp; (Alignment - 1);
02377         SectionOffset-&gt;LowPart = SectionOffset-&gt;LowPart &amp; ~((ULONG)Alignment - 1);
02378     }
02379 
02380     <span class="keywordflow">if</span> ((LONG_PTR)*CapturedViewSize &lt;= 0) {
02381 
02382         <span class="comment">//</span>
02383         <span class="comment">// Section offset or view size past size of section.</span>
02384         <span class="comment">//</span>
02385 
02386         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02387         ControlArea-&gt;NumberOfMappedViews -= 1;
02388         ControlArea-&gt;NumberOfUserReferences -= 1;
02389 
02390         <span class="comment">//</span>
02391         <span class="comment">// Check to see if the control area (segment) should be deleted.</span>
02392         <span class="comment">// This routine releases the PFN lock.</span>
02393         <span class="comment">//</span>
02394     
02395         <a class="code" href="../../d5/d5/sectsup_8c.html#a24">MiCheckControlArea</a> (ControlArea, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, OldIrql);
02396 
02397         *ReleasedWsMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02398         <span class="keywordflow">return</span> STATUS_INVALID_VIEW_SIZE;
02399     }
02400 
02401     <span class="comment">//</span>
02402     <span class="comment">// Calculate the first prototype PTE field in the Vad.</span>
02403     <span class="comment">//</span>
02404 
02405     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea-&gt;u.Flags.GlobalOnlyPerSession == 0);
02406 
02407     Subsection = (<a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a>)(ControlArea + 1);
02408 
02409     SectionOffset-&gt;LowPart = SectionOffset-&gt;LowPart &amp; ~((ULONG)Alignment - 1);
02410     PteOffset = (ULONG)(SectionOffset-&gt;QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
02411 
02412     <span class="comment">//</span>
02413     <span class="comment">// Make sure the PTEs are not in the extended part of the</span>
02414     <span class="comment">// segment.</span>
02415     <span class="comment">//</span>
02416 
02417     <span class="keywordflow">if</span> (PteOffset &gt;= ControlArea-&gt;Segment-&gt;TotalNumberOfPtes) {
02418         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02419         ControlArea-&gt;NumberOfMappedViews -= 1;
02420         ControlArea-&gt;NumberOfUserReferences -= 1;
02421 
02422         <span class="comment">//</span>
02423         <span class="comment">// Check to see if the control area (segment) should be deleted.</span>
02424         <span class="comment">// This routine releases the PFN lock.</span>
02425         <span class="comment">//</span>
02426     
02427         <a class="code" href="../../d5/d5/sectsup_8c.html#a24">MiCheckControlArea</a> (ControlArea, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, OldIrql);
02428 
02429         *ReleasedWsMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02430         <span class="keywordflow">return</span> STATUS_INVALID_VIEW_SIZE;
02431     }
02432 
02433     <span class="keywordflow">while</span> (PteOffset &gt;= Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a>) {
02434         PteOffset -= Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a>;
02435         Subsection = Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a>;
02436         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Subsection != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02437     }
02438 
02439     TheFirstPrototypePte = &amp;Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>[PteOffset];
02440 
02441     <span class="comment">//</span>
02442     <span class="comment">// Calculate the quota for the specified pages.</span>
02443     <span class="comment">//</span>
02444 
02445     <span class="keywordflow">if</span> ((ControlArea-&gt;FilePointer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
02446         (CommitSize != 0) &amp;&amp;
02447         (ControlArea-&gt;Segment-&gt;NumberOfCommittedPages &lt;
02448                 ControlArea-&gt;Segment-&gt;TotalNumberOfPtes)) {
02449 
02450 
02451         <a class="code" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a677">MmSectionCommitMutex</a>);
02452 
02453         PointerPte = TheFirstPrototypePte;
02454         LastPte = PointerPte + <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a>(CommitSize);
02455 
02456         <span class="keywordflow">while</span> (PointerPte &lt; LastPte) {
02457             <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0) {
02458                 QuotaCharge += 1;
02459             }
02460             PointerPte += 1;
02461         }
02462         <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a677">MmSectionCommitMutex</a>);
02463     }
02464 
02465     CapturedStartingVa = (PVOID)Section-&gt;Address.StartingVpn;
02466     CapturedCopyOnWrite = Section-&gt;u.Flags.CopyOnWrite;
02467     <a class="code" href="../../d4/d8/mi_8h.html#a155">LOCK_WS_UNSAFE</a> (Process);
02468 
02469     <span class="keywordflow">if</span> ((*CapturedBase == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (CapturedStartingVa == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
02470 
02471         <span class="comment">//</span>
02472         <span class="comment">// The section is not based, find an empty range.</span>
02473         <span class="comment">// This could raise an exception.</span>
02474 
02475         <span class="keywordflow">try</span> {
02476 
02477             <span class="comment">//</span>
02478             <span class="comment">// Find a starting address on a 64k boundary.</span>
02479             <span class="comment">//</span>
02480 
02481             <span class="keywordflow">if</span> ( AllocationType &amp; MEM_TOP_DOWN ) {
02482                 StartingAddress = <a class="code" href="../../d4/d8/mi_8h.html#a94">MiFindEmptyAddressRangeDown</a> (
02483                                     *CapturedViewSize,
02484                                     (PVOID)((PCHAR)<a class="code" href="../../d4/d8/mi_8h.html#a19">MM_HIGHEST_VAD_ADDRESS</a> + 1),
02485                                     Alignment
02486                                     );
02487             } <span class="keywordflow">else</span> {
02488                 StartingAddress = <a class="code" href="../../d6/d3/vadtree_8c.html#a3">MiFindEmptyAddressRange</a> (*CapturedViewSize,
02489                                                            Alignment,
02490                                                            (ULONG)ZeroBits);
02491             }
02492 
02493         } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
02494 
02495             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02496             ControlArea-&gt;NumberOfMappedViews -= 1;
02497             ControlArea-&gt;NumberOfUserReferences -= 1;
02498 
02499             <span class="comment">//</span>
02500             <span class="comment">// Check to see if the control area (segment) should be deleted.</span>
02501             <span class="comment">// This routine releases the PFN lock.</span>
02502             <span class="comment">//</span>
02503         
02504             <a class="code" href="../../d5/d5/sectsup_8c.html#a24">MiCheckControlArea</a> (ControlArea, Process, OldIrql);
02505 
02506             <span class="keywordflow">return</span> GetExceptionCode();
02507         }
02508 
02509         EndingAddress = (PVOID)(((ULONG_PTR)StartingAddress +
02510                                     *CapturedViewSize - 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>) | (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>));
02511 
02512         <span class="keywordflow">if</span> (ZeroBits &gt; 0) {
02513             <span class="keywordflow">if</span> (EndingAddress &gt; (PVOID)((ULONG_PTR)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a9">MM_USER_ADDRESS_RANGE_LIMIT</a> &gt;&gt; ZeroBits)) {
02514                 <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02515                 ControlArea-&gt;NumberOfMappedViews -= 1;
02516                 ControlArea-&gt;NumberOfUserReferences -= 1;
02517 
02518                 <span class="comment">//</span>
02519                 <span class="comment">// Check to see if the control area (segment) should be deleted.</span>
02520                 <span class="comment">// This routine releases the PFN lock.</span>
02521                 <span class="comment">//</span>
02522             
02523                 <a class="code" href="../../d5/d5/sectsup_8c.html#a24">MiCheckControlArea</a> (ControlArea, Process, OldIrql);
02524 
02525                 <span class="keywordflow">return</span> STATUS_NO_MEMORY;
02526             }
02527         }
02528 
02529     } <span class="keywordflow">else</span> {
02530 
02531         <span class="keywordflow">if</span> (*CapturedBase == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02532 
02533             <span class="comment">//</span>
02534             <span class="comment">// The section is based.</span>
02535             <span class="comment">//</span>
02536 
02537             StartingAddress = (PVOID)((PCHAR)CapturedStartingVa +
02538                                                      SectionOffset-&gt;LowPart);
02539         } <span class="keywordflow">else</span> {
02540 
02541             StartingAddress = <a class="code" href="../../d4/d8/mi_8h.html#a92">MI_ALIGN_TO_SIZE</a> (*CapturedBase, Alignment);
02542 
02543         }
02544 
02545         <span class="comment">//</span>
02546         <span class="comment">// Check to make sure the specified base address to ending address</span>
02547         <span class="comment">// is currently unused.</span>
02548         <span class="comment">//</span>
02549 
02550         EndingAddress = (PVOID)(((ULONG_PTR)StartingAddress +
02551                                    *CapturedViewSize - 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>) | (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>));
02552 
02553         Vad = <a class="code" href="../../d4/d8/mi_8h.html#a98">MiCheckForConflictingVad</a> (StartingAddress, EndingAddress);
02554         <span class="keywordflow">if</span> (Vad != (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02555 <span class="preprocessor">#if DBG</span>
02556 <span class="preprocessor"></span>                MiDumpConflictingVad (StartingAddress, EndingAddress, Vad);
02557 <span class="preprocessor">#endif</span>
02558 <span class="preprocessor"></span>
02559             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02560             ControlArea-&gt;NumberOfMappedViews -= 1;
02561             ControlArea-&gt;NumberOfUserReferences -= 1;
02562 
02563             <span class="comment">//</span>
02564             <span class="comment">// Check to see if the control area (segment) should be deleted.</span>
02565             <span class="comment">// This routine releases the PFN lock.</span>
02566             <span class="comment">//</span>
02567         
02568             <a class="code" href="../../d5/d5/sectsup_8c.html#a24">MiCheckControlArea</a> (ControlArea, Process, OldIrql);
02569 
02570             <span class="keywordflow">return</span> STATUS_CONFLICTING_ADDRESSES;
02571         }
02572     }
02573 
02574     <span class="comment">//</span>
02575     <span class="comment">// An unoccupied address range has been found, build the virtual</span>
02576     <span class="comment">// address descriptor to describe this range.</span>
02577     <span class="comment">//</span>
02578 
02579     <span class="keywordflow">try</span>  {
02580 
02581         Vad = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
02582                                      <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d6/struct__MMVAD.html">MMVAD</a>),
02583                                      <a class="code" href="../../d3/d6/allocvm_8c.html#a0">MMVADKEY</a>);
02584         <span class="keywordflow">if</span> (Vad == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02585             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_INSUFFICIENT_RESOURCES);
02586         }
02587         RtlZeroMemory (Vad, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/mi_8h.html#a489">MMVAD</a>));
02588 
02589         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a> = <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (StartingAddress);
02590         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a> = <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (EndingAddress);
02591         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o9">FirstPrototypePte</a> = TheFirstPrototypePte;
02592 
02593         <span class="comment">//</span>
02594         <span class="comment">// Set the protection in the PTE template field of the VAD.</span>
02595         <span class="comment">//</span>
02596 
02597         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o8">ControlArea</a> = ControlArea;
02598 
02599         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.Inherit = (InheritDisposition == ViewShare);
02600         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.Protection = ProtectionMask;
02601         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.CopyOnWrite = CapturedCopyOnWrite;
02602 
02603         <span class="comment">//</span>
02604         <span class="comment">// Note that for MEM_DOS_LIM significance is lost here, but those</span>
02605         <span class="comment">// files are not mapped MEM_RESERVE.</span>
02606         <span class="comment">//</span>
02607 
02608         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.FileOffset = (ULONG)(SectionOffset-&gt;QuadPart &gt;&gt; 16);
02609 
02610         <span class="keywordflow">if</span> ((AllocationType &amp; SEC_NO_CHANGE) || (Section-&gt;u.Flags.NoChange)) {
02611             Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.NoChange = 1;
02612             Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.SecNoChange = 1;
02613         }
02614         <span class="keywordflow">if</span> (AllocationType &amp; MEM_RESERVE) {
02615             <a class="code" href="../../d0/d2/struct__MMEXTEND__INFO.html">PMMEXTEND_INFO</a> ExtendInfo;
02616 
02617             <a class="code" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a678">MmSectionBasedMutex</a>);
02618             ExtendInfo = ControlArea-&gt;Segment-&gt;ExtendInfo;
02619             <span class="keywordflow">if</span> (ExtendInfo) {
02620                 ExtendInfo-&gt;<a class="code" href="../../d0/d2/struct__MMEXTEND__INFO.html#o1">ReferenceCount</a> += 1;
02621                 <span class="keywordflow">if</span> (ExtendInfo-&gt;<a class="code" href="../../d0/d2/struct__MMEXTEND__INFO.html#o0">CommittedSize</a> &lt; (UINT64)Section-&gt;SizeOfSection.QuadPart) {
02622                     ExtendInfo-&gt;<a class="code" href="../../d0/d2/struct__MMEXTEND__INFO.html#o0">CommittedSize</a> = (UINT64)Section-&gt;SizeOfSection.QuadPart;
02623                 }
02624             } <span class="keywordflow">else</span> {
02625 
02626                 ExtendInfo = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
02627                                                     <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d2/struct__MMEXTEND__INFO.html">MMEXTEND_INFO</a>),
02628                                                     'xCmM');
02629                 <span class="keywordflow">if</span> (ExtendInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02630                     <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a678">MmSectionBasedMutex</a>);
02631                     <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_INSUFFICIENT_RESOURCES);
02632                 }
02633                 ExtendInfo-&gt;<a class="code" href="../../d0/d2/struct__MMEXTEND__INFO.html#o1">ReferenceCount</a> = 1;
02634                 ExtendInfo-&gt;<a class="code" href="../../d0/d2/struct__MMEXTEND__INFO.html#o0">CommittedSize</a> = ControlArea-&gt;Segment-&gt;SizeOfSegment;
02635                 <span class="keywordflow">if</span> (ExtendInfo-&gt;<a class="code" href="../../d0/d2/struct__MMEXTEND__INFO.html#o0">CommittedSize</a> &lt; (UINT64)Section-&gt;SizeOfSection.QuadPart) {
02636                     ExtendInfo-&gt;<a class="code" href="../../d0/d2/struct__MMEXTEND__INFO.html#o0">CommittedSize</a> = (UINT64)Section-&gt;SizeOfSection.QuadPart;
02637                 }
02638                 ControlArea-&gt;Segment-&gt;ExtendInfo = ExtendInfo;
02639             }
02640             <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a678">MmSectionBasedMutex</a>);
02641             Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.ExtendableFile = 1;
02642             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o19">u4</a>.ExtendedInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02643             Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o19">u4</a>.ExtendedInfo = ExtendInfo;
02644         }
02645 
02646         <span class="comment">//</span>
02647         <span class="comment">// If the page protection is write-copy or execute-write-copy</span>
02648         <span class="comment">// charge for each page in the view as it may become private.</span>
02649         <span class="comment">//</span>
02650 
02651         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a88">MI_IS_PTE_PROTECTION_COPY_WRITE</a>(ProtectionMask)) {
02652             Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.CommitCharge = (<a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a> ((PCHAR) EndingAddress -
02653                                (PCHAR) StartingAddress));
02654         }
02655 
02656         <span class="comment">//</span>
02657         <span class="comment">// If this is a page file backed section, charge the process's page</span>
02658         <span class="comment">// file quota as if all the pages have been committed.  This solves</span>
02659         <span class="comment">// the problem when other processes commit all the pages and leave</span>
02660         <span class="comment">// only one process around who may not have been charged the proper</span>
02661         <span class="comment">// quota.  This is solved by charging everyone the maximum quota.</span>
02662         <span class="comment">//</span>
02663 <span class="comment">//</span>
02664 <span class="comment">// commented out for commitment charging.</span>
02665 <span class="comment">//</span>
02666 
02667 <span class="preprocessor">#if 0</span>
02668 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (ControlArea-&gt;FilePointer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02669 
02670             <span class="comment">//</span>
02671             <span class="comment">// This is a page file backed section.  Charge for all the pages.</span>
02672             <span class="comment">//</span>
02673 
02674             Vad-&gt;CommitCharge += (<a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a> ((PCHAR)EndingAddress -
02675                                (PCHAR)StartingAddress));
02676         }
02677 <span class="preprocessor">#endif</span>
02678 <span class="preprocessor"></span>
02679 
02680         PteOffset += (ULONG)(Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a> - Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a>);
02681 
02682         <span class="keywordflow">if</span> (PteOffset &lt; Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a> ) {
02683             Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o10">LastContiguousPte</a> = &amp;Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>[PteOffset];
02684 
02685         } <span class="keywordflow">else</span> {
02686             Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o10">LastContiguousPte</a> = &amp;Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>[
02687                                         (Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a> - 1) +
02688                                         Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o7">UnusedPtes</a>];
02689         }
02690 
02691         <span class="keywordflow">if</span> (QuotaCharge != 0) {
02692             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d1/mmquota_8c.html#a17">MiChargeCommitment</a> (QuotaCharge, Process) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
02693                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_COMMITMENT_LIMIT);
02694             }
02695             ChargedQuota = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02696             <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a269">MM_DBG_COMMIT_MAPVIEW_DATA</a>, QuotaCharge);
02697         }
02698 
02699         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o9">FirstPrototypePte</a> &lt;= Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o10">LastContiguousPte</a>);
02700         <a class="code" href="../../d6/d3/vadtree_8c.html#a0">MiInsertVad</a> (Vad);
02701 
02702     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
02703 
02704         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02705         ControlArea-&gt;NumberOfMappedViews -= 1;
02706         ControlArea-&gt;NumberOfUserReferences -= 1;
02707 
02708         <span class="comment">//</span>
02709         <span class="comment">// Check to see if the control area (segment) should be deleted.</span>
02710         <span class="comment">// This routine releases the PFN lock.</span>
02711         <span class="comment">//</span>
02712     
02713         <a class="code" href="../../d5/d5/sectsup_8c.html#a24">MiCheckControlArea</a> (ControlArea, Process, OldIrql);
02714 
02715         <span class="keywordflow">if</span> (Vad != (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02716 
02717             <span class="comment">//</span>
02718             <span class="comment">// The pool allocation succeeded, but the quota charge</span>
02719             <span class="comment">// in InsertVad failed, deallocate the pool and return</span>
02720             <span class="comment">// an error.</span>
02721             <span class="comment">//</span>
02722 
02723             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Vad);
02724             <span class="keywordflow">if</span> (ChargedQuota) {
02725                 <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (QuotaCharge);
02726                 <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a300">MM_DBG_COMMIT_RETURN_MAPVIEW_DATA</a>, QuotaCharge);
02727             }
02728             <span class="keywordflow">return</span> GetExceptionCode();
02729         }
02730         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
02731     }
02732 
02733     *ReleasedWsMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02734 
02735 <span class="preprocessor">#if DBG</span>
02736 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (!(AllocationType &amp; MEM_RESERVE)) {
02737         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(((ULONG_PTR)EndingAddress - (ULONG_PTR)StartingAddress) &lt;=
02738                 <a class="code" href="../../d3/d5/mapview_8c.html#a1">ROUND_TO_PAGES64</a>(Section-&gt;Segment-&gt;SizeOfSegment));
02739     }
02740 <span class="preprocessor">#endif //DBG</span>
02741 <span class="preprocessor"></span>
02742     <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (Process);
02743 
02744     <span class="comment">//</span>
02745     <span class="comment">// If a commit size was specified, make sure those pages are committed.</span>
02746     <span class="comment">//</span>
02747 
02748     <span class="keywordflow">if</span> (QuotaCharge != 0) {
02749 
02750         <a class="code" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a677">MmSectionCommitMutex</a>);
02751 
02752         PointerPte = Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o9">FirstPrototypePte</a>;
02753         LastPte = PointerPte + <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a>(CommitSize);
02754         TempPte = ControlArea-&gt;Segment-&gt;SegmentPteTemplate;
02755 
02756         <span class="keywordflow">while</span> (PointerPte &lt; LastPte) {
02757 
02758             <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0) {
02759 
02760                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, TempPte);
02761             }
02762             PointerPte += 1;
02763         }
02764 
02765         ControlArea-&gt;Segment-&gt;NumberOfCommittedPages += QuotaCharge;
02766 
02767         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea-&gt;Segment-&gt;NumberOfCommittedPages &lt;=
02768                 ControlArea-&gt;Segment-&gt;TotalNumberOfPtes);
02769         <a class="code" href="../../d8/d5/kddata_8c.html#a31">MmSharedCommit</a> += QuotaCharge;
02770 
02771         <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a677">MmSectionCommitMutex</a>);
02772     }
02773 
02774 <span class="preprocessor">#if defined(_MIALT4K_)</span>
02775 <span class="preprocessor"></span>
02776     <span class="keywordflow">if</span> (Process-&gt;Wow64Process != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02777 
02778 
02779         EndingAddress = (PVOID)(((ULONG_PTR)StartingAddress +
02780                                  *CapturedViewSize - 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>) | (<a class="code" href="../../d2/d9/miia64_8h.html#a227">PAGE_4K</a> - 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>));
02781 
02782         ViewSizeFor4k = (PCHAR)EndingAddress - (PCHAR)StartingAddress + 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
02783 
02784         <a class="code" href="../../d2/d9/miia64_8h.html#a304">MiProtectMapFileFor4kPage</a> (StartingAddress,
02785                                    ViewSizeFor4k,
02786                                    ProtectionMask, 
02787                                    Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o9">FirstPrototypePte</a>,
02788                                    Process);
02789     }
02790 <span class="preprocessor">#endif</span>
02791 <span class="preprocessor"></span>
02792     <span class="comment">//</span>
02793     <span class="comment">// Update the current virtual size in the process header.</span>
02794     <span class="comment">//</span>
02795 
02796     *CapturedViewSize = (PCHAR)EndingAddress - (PCHAR)StartingAddress + 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
02797     Process-&gt;VirtualSize += *CapturedViewSize;
02798 
02799     <span class="keywordflow">if</span> (Process-&gt;VirtualSize &gt; Process-&gt;PeakVirtualSize) {
02800         Process-&gt;PeakVirtualSize = Process-&gt;VirtualSize;
02801     }
02802 
02803     *CapturedBase = StartingAddress;
02804 
02805     <span class="keywordflow">return</span> STATUS_SUCCESS;
02806 }
02807 
02808 LOGICAL
<a name="l02809"></a><a class="code" href="../../d4/d8/mi_8h.html#a928">02809</a> <a class="code" href="../../d4/d8/mi_8h.html#a928">MiCheckPurgeAndUpMapCount</a> (
02810     IN <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea
02811     )
02812 
02813 <span class="comment">/*++</span>
02814 <span class="comment"></span>
02815 <span class="comment">Routine Description:</span>
02816 <span class="comment"></span>
02817 <span class="comment">    This routine synchronizes with any on going purge operations</span>
02818 <span class="comment">    on the same segment (identified via the control area).  If</span>
02819 <span class="comment">    another purge operation is occurring, the function blocks until</span>
02820 <span class="comment">    it is completed.</span>
02821 <span class="comment"></span>
02822 <span class="comment">    When this function returns the MappedView and the NumberOfUserReferences</span>
02823 <span class="comment">    count for the control area will be incremented thereby referencing</span>
02824 <span class="comment">    the control area.</span>
02825 <span class="comment"></span>
02826 <span class="comment">Arguments:</span>
02827 <span class="comment"></span>
02828 <span class="comment">    ControlArea - Supplies the control area for the segment to be purged.</span>
02829 <span class="comment"></span>
02830 <span class="comment">Return Value:</span>
02831 <span class="comment"></span>
02832 <span class="comment">    TRUE if the synchronization was successful.</span>
02833 <span class="comment">    FALSE if the synchronization did not occur due to low resources, etc.</span>
02834 <span class="comment"></span>
02835 <span class="comment">Environment:</span>
02836 <span class="comment"></span>
02837 <span class="comment">    Kernel Mode.</span>
02838 <span class="comment"></span>
02839 <span class="comment">--*/</span>
02840 
02841 {
02842     KIRQL OldIrql;
02843     <a class="code" href="../../d3/d7/struct__EVENT__COUNTER.html">PEVENT_COUNTER</a> PurgedEvent;
02844     <a class="code" href="../../d3/d7/struct__EVENT__COUNTER.html">PEVENT_COUNTER</a> WaitEvent;
02845     ULONG OldRef;
02846 
02847     PurgedEvent = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02848     OldRef = 1;
02849 
02850     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02851 
02852     <span class="keywordflow">while</span> (ControlArea-&gt;u.Flags.BeingPurged != 0) {
02853 
02854         <span class="comment">//</span>
02855         <span class="comment">// A purge operation is in progress.</span>
02856         <span class="comment">//</span>
02857 
02858         <span class="keywordflow">if</span> (PurgedEvent == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02859 
02860             <span class="comment">//</span>
02861             <span class="comment">// Release the locks and allocate pool for the event.</span>
02862             <span class="comment">//</span>
02863 
02864             PurgedEvent = <a class="code" href="../../d4/d8/mi_8h.html#a931">MiGetEventCounter</a> ();
02865             <span class="keywordflow">if</span> (PurgedEvent == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02866                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02867                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02868             }
02869 
02870             <span class="keywordflow">continue</span>;
02871         }
02872 
02873         <span class="keywordflow">if</span> (ControlArea-&gt;WaitingForDeletion == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02874             ControlArea-&gt;WaitingForDeletion = PurgedEvent;
02875             WaitEvent = PurgedEvent;
02876             PurgedEvent = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02877         } <span class="keywordflow">else</span> {
02878             WaitEvent = ControlArea-&gt;WaitingForDeletion;
02879             WaitEvent-&gt;<a class="code" href="../../d3/d7/struct__EVENT__COUNTER.html#o0">RefCount</a> += 1;
02880         }
02881 
02882         <span class="comment">//</span>
02883         <span class="comment">// Release the pfn lock and wait for the event.</span>
02884         <span class="comment">//</span>
02885 
02886         <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
02887         <a class="code" href="../../d4/d8/mi_8h.html#a132">UNLOCK_PFN_AND_THEN_WAIT</a>(OldIrql);
02888 
02889         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(&amp;WaitEvent-&gt;<a class="code" href="../../d3/d7/struct__EVENT__COUNTER.html#o1">Event</a>,
02890                               <a class="code" href="../../d4/d9/ke_8h.html#a407a216">WrVirtualMemory</a>,
02891                               <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
02892                               <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
02893                               (PLARGE_INTEGER)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02894         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02895         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
02896         <a class="code" href="../../d5/d5/sectsup_8c.html#a28">MiFreeEventCounter</a> (WaitEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02897     }
02898 
02899     <span class="comment">//</span>
02900     <span class="comment">// Indicate another file is mapped for the segment.</span>
02901     <span class="comment">//</span>
02902 
02903     ControlArea-&gt;NumberOfMappedViews += 1;
02904     ControlArea-&gt;NumberOfUserReferences += 1;
02905     ControlArea-&gt;u.Flags.HadUserReference = 1;
02906     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea-&gt;NumberOfSectionReferences != 0);
02907 
02908     <span class="keywordflow">if</span> (PurgedEvent != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02909         <a class="code" href="../../d5/d5/sectsup_8c.html#a28">MiFreeEventCounter</a> (PurgedEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02910     }
02911     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02912 
02913     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02914 }
02915 
<a name="l02916"></a><a class="code" href="../../d4/d4/struct__NTSYM.html">02916</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d4/d4/struct__NTSYM.html">_NTSYM</a> {
<a name="l02917"></a><a class="code" href="../../d4/d4/struct__NTSYM.html#o0">02917</a>     <span class="keyword">struct </span><a class="code" href="../../d4/d4/struct__NTSYM.html">_NTSYM</a> *<a class="code" href="../../d4/d4/struct__NTSYM.html#o0">Next</a>;
<a name="l02918"></a><a class="code" href="../../d4/d4/struct__NTSYM.html#o1">02918</a>     PVOID <a class="code" href="../../d4/d4/struct__NTSYM.html#o1">SymbolTable</a>;
<a name="l02919"></a><a class="code" href="../../d4/d4/struct__NTSYM.html#o2">02919</a>     ULONG <a class="code" href="../../d4/d4/struct__NTSYM.html#o2">NumberOfSymbols</a>;
<a name="l02920"></a><a class="code" href="../../d4/d4/struct__NTSYM.html#o3">02920</a>     PVOID <a class="code" href="../../d4/d4/struct__NTSYM.html#o3">StringTable</a>;
<a name="l02921"></a><a class="code" href="../../d4/d4/struct__NTSYM.html#o4">02921</a>     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> <a class="code" href="../../d4/d4/struct__NTSYM.html#o4">Flags</a>;
<a name="l02922"></a><a class="code" href="../../d4/d4/struct__NTSYM.html#o5">02922</a>     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> <a class="code" href="../../d4/d4/struct__NTSYM.html#o5">EntrySize</a>;
<a name="l02923"></a><a class="code" href="../../d4/d4/struct__NTSYM.html#o6">02923</a>     ULONG <a class="code" href="../../d4/d4/struct__NTSYM.html#o6">MinimumVa</a>;
<a name="l02924"></a><a class="code" href="../../d4/d4/struct__NTSYM.html#o7">02924</a>     ULONG <a class="code" href="../../d4/d4/struct__NTSYM.html#o7">MaximumVa</a>;
<a name="l02925"></a><a class="code" href="../../d4/d4/struct__NTSYM.html#o8">02925</a>     PCHAR <a class="code" href="../../d4/d4/struct__NTSYM.html#o8">MapName</a>;
<a name="l02926"></a><a class="code" href="../../d4/d4/struct__NTSYM.html#o9">02926</a>     ULONG <a class="code" href="../../d4/d4/struct__NTSYM.html#o9">MapNameLen</a>;
02927 } <a class="code" href="../../d4/d4/struct__NTSYM.html">NTSYM</a>, *<a class="code" href="../../d4/d4/struct__NTSYM.html">PNTSYM</a>;
02928 
02929 ULONG
<a name="l02930"></a><a class="code" href="../../d3/d5/mapview_8c.html#a17">02930</a> <a class="code" href="../../d8/d8/sysload_8c.html#a30">CacheImageSymbols</a>(
02931     IN PVOID ImageBase
02932     )
02933 {
02934     PIMAGE_DEBUG_DIRECTORY DebugDirectory;
02935     ULONG DebugSize;
02936 
02937     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02938 
02939     <span class="keywordflow">try</span> {
02940         DebugDirectory = (PIMAGE_DEBUG_DIRECTORY)
02941         <a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a>( ImageBase,
02942                                       <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
02943                                       IMAGE_DIRECTORY_ENTRY_DEBUG,
02944                                       &amp;DebugSize
02945                                     );
02946         <span class="keywordflow">if</span> (!DebugDirectory) {
02947             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02948         }
02949 
02950         <span class="comment">//</span>
02951         <span class="comment">// If using remote KD, ImageBase is what it wants to see.</span>
02952         <span class="comment">//</span>
02953 
02954     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
02955         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02956     }
02957 
02958     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02959 }
02960 
02961 
02962 NTSYSAPI
02963 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
02964 NTAPI
<a name="l02965"></a><a class="code" href="../../d3/d5/mapview_8c.html#a26">02965</a> <a class="code" href="../../d3/d5/mapview_8c.html#a26">NtAreMappedFilesTheSame</a> (
02966     IN PVOID File1MappedAsAnImage,
02967     IN PVOID File2MappedAsFile
02968     )
02969 
02970 <span class="comment">/*++</span>
02971 <span class="comment"></span>
02972 <span class="comment">Routine Description:</span>
02973 <span class="comment"></span>
02974 <span class="comment">    This routine compares the two files mapped at the specified</span>
02975 <span class="comment">    addresses to see if they are both the same file.</span>
02976 <span class="comment"></span>
02977 <span class="comment">Arguments:</span>
02978 <span class="comment"></span>
02979 <span class="comment">    File1MappedAsAnImage - Supplies an address within the first file which</span>
02980 <span class="comment">        is mapped as an image file.</span>
02981 <span class="comment"></span>
02982 <span class="comment">    File2MappedAsFile - Supplies an address within the second file which</span>
02983 <span class="comment">        is mapped as either an image file or a data file.</span>
02984 <span class="comment"></span>
02985 <span class="comment">Return Value:</span>
02986 <span class="comment"></span>
02987 <span class="comment"></span>
02988 <span class="comment">    STATUS_SUCCESS is returned if the two files are the same.</span>
02989 <span class="comment"></span>
02990 <span class="comment">    STATUS_NOT_SAME_DEVICE is returned if the files are different.</span>
02991 <span class="comment"></span>
02992 <span class="comment">    Other status values can be returned if the addresses are not mapped as</span>
02993 <span class="comment">    files, etc.</span>
02994 <span class="comment"></span>
02995 <span class="comment">Environment:</span>
02996 <span class="comment"></span>
02997 <span class="comment">    User mode callable system service.</span>
02998 <span class="comment"></span>
02999 <span class="comment">--*/</span>
03000 
03001 {
03002     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> FoundVad1;
03003     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> FoundVad2;
03004     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03005 
03006     <a class="code" href="../../d4/d8/mi_8h.html#a160">LOCK_ADDRESS_SPACE</a> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>());
03007     FoundVad1 = <a class="code" href="../../d6/d3/vadtree_8c.html#a2">MiLocateAddress</a> (File1MappedAsAnImage);
03008     FoundVad2 = <a class="code" href="../../d6/d3/vadtree_8c.html#a2">MiLocateAddress</a> (File2MappedAsFile);
03009 
03010     <span class="keywordflow">if</span> ((FoundVad1 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
03011         (FoundVad2 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
03012 
03013         <span class="comment">//</span>
03014         <span class="comment">// No virtual address is allocated at the specified base address,</span>
03015         <span class="comment">// return an error.</span>
03016         <span class="comment">//</span>
03017 
03018         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_ADDRESS;
03019         <span class="keywordflow">goto</span> ErrorReturn;
03020     }
03021 
03022     <span class="comment">//</span>
03023     <span class="comment">// Check file names.</span>
03024     <span class="comment">//</span>
03025 
03026     <span class="keywordflow">if</span> ((FoundVad1-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.PrivateMemory == 1) ||
03027         (FoundVad2-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.PrivateMemory == 1)) {
03028         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_CONFLICTING_ADDRESSES;
03029         <span class="keywordflow">goto</span> ErrorReturn;
03030     }
03031 
03032     <span class="keywordflow">if</span> ((FoundVad1-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o8">ControlArea</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
03033         (FoundVad2-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o8">ControlArea</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
03034         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_CONFLICTING_ADDRESSES;
03035         <span class="keywordflow">goto</span> ErrorReturn;
03036     }
03037 
03038     <span class="keywordflow">if</span> ((FoundVad1-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o8">ControlArea</a>-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
03039         (FoundVad2-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o8">ControlArea</a>-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
03040         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_CONFLICTING_ADDRESSES;
03041         <span class="keywordflow">goto</span> ErrorReturn;
03042     }
03043 
03044     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NOT_SAME_DEVICE;
03045 
03046     <span class="keywordflow">if</span> ((PVOID)FoundVad1-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o8">ControlArea</a> ==
03047             FoundVad2-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o8">ControlArea</a>-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o6">SectionObjectPointer</a>-&gt;<a class="code" href="../../d7/d0/struct__SECTION__OBJECT__POINTERS.html#o2">ImageSectionObject</a>) {
03048         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
03049     }
03050 
03051 ErrorReturn:
03052 
03053     <a class="code" href="../../d4/d8/mi_8h.html#a163">UNLOCK_ADDRESS_SPACE</a> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>());
03054     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03055 }
03056 
03057 
03058 
03059 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03060"></a><a class="code" href="../../d3/d5/mapview_8c.html#a9">03060</a> <a class="code" href="../../d3/d5/mapview_8c.html#a9">MiSetPageModified</a> (
03061     IN PVOID Address
03062     )
03063 
03064 <span class="comment">/*++</span>
03065 <span class="comment"></span>
03066 <span class="comment">Routine Description:</span>
03067 <span class="comment"></span>
03068 <span class="comment">    This routine sets the modified bit in the PFN database for the</span>
03069 <span class="comment">    pages that correspond to the specified address range.</span>
03070 <span class="comment"></span>
03071 <span class="comment">    Note that the dirty bit in the PTE is cleared by this operation.</span>
03072 <span class="comment"></span>
03073 <span class="comment">Arguments:</span>
03074 <span class="comment"></span>
03075 <span class="comment">    Address - Supplies the address of the start of the range.  This</span>
03076 <span class="comment">              range must reside within the system cache.</span>
03077 <span class="comment"></span>
03078 <span class="comment">Return Value:</span>
03079 <span class="comment"></span>
03080 <span class="comment">    None.</span>
03081 <span class="comment"></span>
03082 <span class="comment">Environment:</span>
03083 <span class="comment"></span>
03084 <span class="comment">    Kernel mode.  APC_LEVEL and below for pagable addresses,</span>
03085 <span class="comment">                  DISPATCH_LEVEL and below for non-pagable addresses.</span>
03086 <span class="comment"></span>
03087 <span class="comment">--*/</span>
03088 
03089 {
03090     <span class="keyword">volatile</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe;
03091     <span class="keyword">volatile</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
03092     <span class="keyword">volatile</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
03093     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
03094     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
03095     KIRQL OldIrql;
03096 
03097     <span class="comment">//</span>
03098     <span class="comment">// Loop on the copy on write case until the page is only</span>
03099     <span class="comment">// writable.</span>
03100     <span class="comment">//</span>
03101 
03102     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (Address);
03103     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (Address);
03104     PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a> (Address);
03105 
03106     *(<span class="keyword">volatile</span> CCHAR *)Address;
03107 
03108     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
03109 
03110 <span class="preprocessor">#if defined (_WIN64)</span>
03111 <span class="preprocessor"></span>    <span class="keywordflow">while</span> ((PointerPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) ||
03112            (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) ||
03113            (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0))
03114 <span class="preprocessor">#else</span>
03115 <span class="preprocessor"></span>    <span class="keywordflow">while</span> ((PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) ||
03116            (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0))
03117 <span class="preprocessor">#endif</span>
03118 <span class="preprocessor"></span>    {
03119 
03120         <span class="comment">//</span>
03121         <span class="comment">// Page is no longer valid.</span>
03122         <span class="comment">//</span>
03123 
03124         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03125         *(<span class="keyword">volatile</span> CCHAR *)Address;
03126         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
03127     }
03128 
03129     PteContents = *PointerPte;
03130 
03131     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
03132     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified = 1;
03133 
03134     <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0) &amp;&amp;
03135                  (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.WriteInProgress == 0)) {
03136         <a class="code" href="../../d4/d8/mi_8h.html#a889">MiReleasePageFileSpace</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>);
03137         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.PageFileHigh = 0;
03138     }
03139 
03140 <span class="preprocessor">#ifdef NT_UP</span>
03141 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a114">MI_IS_PTE_DIRTY</a> (PteContents)) {
03142 <span class="preprocessor">#endif //NT_UP</span>
03143 <span class="preprocessor"></span>        <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a113">MI_SET_PTE_CLEAN</a> (PteContents);
03144 
03145         <span class="comment">//</span>
03146         <span class="comment">// Clear the dirty bit in the PTE so new writes can be tracked.</span>
03147         <span class="comment">//</span>
03148 
03149         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a2">KeFlushSingleTb</a> (Address,
03150                                <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
03151                                <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
03152                                (PHARDWARE_PTE)PointerPte,
03153                                PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush);
03154 <span class="preprocessor">#ifdef NT_UP</span>
03155 <span class="preprocessor"></span>    }
03156 <span class="preprocessor">#endif //NT_UP</span>
03157 <span class="preprocessor"></span>
03158     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03159     <span class="keywordflow">return</span>;
03160 }
03161 
03162 
03163 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03164"></a><a class="code" href="../../d3/d5/mapview_8c.html#a27">03164</a> <a class="code" href="../../d3/d5/mapview_8c.html#a27">MmMapViewInSystemSpace</a> (
03165     IN PVOID Section,
03166     OUT PVOID *MappedBase,
03167     IN OUT PSIZE_T ViewSize
03168     )
03169 
03170 <span class="comment">/*++</span>
03171 <span class="comment"></span>
03172 <span class="comment">Routine Description:</span>
03173 <span class="comment"></span>
03174 <span class="comment">    This routine maps the specified section into the system's address space.</span>
03175 <span class="comment"></span>
03176 <span class="comment">Arguments:</span>
03177 <span class="comment"></span>
03178 <span class="comment">    Section - Supplies a pointer to the section to map.</span>
03179 <span class="comment"></span>
03180 <span class="comment">    *MappedBase - Returns the address where the section was mapped.</span>
03181 <span class="comment"></span>
03182 <span class="comment">    ViewSize - Supplies the size of the view to map.  If this</span>
03183 <span class="comment">               is specified as zero, the whole section is mapped.</span>
03184 <span class="comment">               Returns the actual size mapped.</span>
03185 <span class="comment"></span>
03186 <span class="comment">Return Value:</span>
03187 <span class="comment"></span>
03188 <span class="comment">    Status of the map view operation.</span>
03189 <span class="comment"></span>
03190 <span class="comment">Environment:</span>
03191 <span class="comment"></span>
03192 <span class="comment">    Kernel Mode, IRQL of dispatch level.</span>
03193 <span class="comment"></span>
03194 <span class="comment">--*/</span>
03195 
03196 {
03197     <a class="code" href="../../d0/d6/struct__MMSESSION.html">PMMSESSION</a>  Session;
03198 
03199     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03200 
03201     Session = &amp;<a class="code" href="../../d3/d5/mapview_8c.html#a6">MmSession</a>;
03202 
03203     <span class="keywordflow">return</span> <a class="code" href="../../d3/d5/mapview_8c.html#a13">MiMapViewInSystemSpace</a> (Section,
03204                                    Session,
03205                                    MappedBase,
03206                                    ViewSize);
03207 }
03208 
03209 
03210 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03211"></a><a class="code" href="../../d3/d5/mapview_8c.html#a28">03211</a> <a class="code" href="../../d3/d5/mapview_8c.html#a28">MmMapViewInSessionSpace</a> (
03212     IN PVOID Section,
03213     OUT PVOID *MappedBase,
03214     IN OUT PSIZE_T ViewSize
03215     )
03216 
03217 <span class="comment">/*++</span>
03218 <span class="comment"></span>
03219 <span class="comment">Routine Description:</span>
03220 <span class="comment"></span>
03221 <span class="comment">    This routine maps the specified section into the current process's</span>
03222 <span class="comment">    session address space.</span>
03223 <span class="comment"></span>
03224 <span class="comment">Arguments:</span>
03225 <span class="comment"></span>
03226 <span class="comment">    Section - Supplies a pointer to the section to map.</span>
03227 <span class="comment"></span>
03228 <span class="comment">    *MappedBase - Returns the address where the section was mapped.</span>
03229 <span class="comment"></span>
03230 <span class="comment">    ViewSize - Supplies the size of the view to map.  If this</span>
03231 <span class="comment">               is specified as zero, the whole section is mapped.</span>
03232 <span class="comment">               Returns the actual size mapped.</span>
03233 <span class="comment"></span>
03234 <span class="comment">Return Value:</span>
03235 <span class="comment"></span>
03236 <span class="comment">    Status of the map view operation.</span>
03237 <span class="comment"></span>
03238 <span class="comment">Environment:</span>
03239 <span class="comment"></span>
03240 <span class="comment">    Kernel Mode, IRQL of dispatch level.</span>
03241 <span class="comment"></span>
03242 <span class="comment">--*/</span>
03243 
03244 {
03245     <a class="code" href="../../d0/d6/struct__MMSESSION.html">PMMSESSION</a>  Session;
03246 
03247     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03248 
03249     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
03250         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Vm.u.Flags.ProcessInSession == 0) {
03251             <span class="keywordflow">return</span> STATUS_NOT_MAPPED_VIEW;
03252         }
03253         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a>(<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03254         Session = &amp;<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o34">Session</a>;
03255     }
03256     <span class="keywordflow">else</span> {
03257         Session = &amp;<a class="code" href="../../d3/d5/mapview_8c.html#a6">MmSession</a>;
03258     }
03259 
03260     <span class="keywordflow">return</span> <a class="code" href="../../d3/d5/mapview_8c.html#a13">MiMapViewInSystemSpace</a> (Section,
03261                                    Session,
03262                                    MappedBase,
03263                                    ViewSize);
03264 }
03265 
03266 
03267 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03268"></a><a class="code" href="../../d3/d5/mapview_8c.html#a13">03268</a> <a class="code" href="../../d3/d5/mapview_8c.html#a13">MiMapViewInSystemSpace</a> (
03269     IN PVOID Section,
03270     IN <a class="code" href="../../d0/d6/struct__MMSESSION.html">PMMSESSION</a> Session,
03271     OUT PVOID *MappedBase,
03272     IN OUT PSIZE_T ViewSize
03273     )
03274 
03275 <span class="comment">/*++</span>
03276 <span class="comment"></span>
03277 <span class="comment">Routine Description:</span>
03278 <span class="comment"></span>
03279 <span class="comment">    This routine maps the specified section into the system's address space.</span>
03280 <span class="comment"></span>
03281 <span class="comment">Arguments:</span>
03282 <span class="comment"></span>
03283 <span class="comment">    Section - Supplies a pointer to the section to map.</span>
03284 <span class="comment"></span>
03285 <span class="comment">    Session - Supplies the session data structure for this view.</span>
03286 <span class="comment"></span>
03287 <span class="comment">    *MappedBase - Returns the address where the section was mapped.</span>
03288 <span class="comment"></span>
03289 <span class="comment">    ViewSize - Supplies the size of the view to map.  If this</span>
03290 <span class="comment">               is specified as zero, the whole section is mapped.</span>
03291 <span class="comment">               Returns the actual size mapped.</span>
03292 <span class="comment"></span>
03293 <span class="comment">    Protect - Supplies the protection for the view.  Must be</span>
03294 <span class="comment">              either PAGE_READWRITE or PAGE_READONLY.</span>
03295 <span class="comment"></span>
03296 <span class="comment">Return Value:</span>
03297 <span class="comment"></span>
03298 <span class="comment">    Status of the map view operation.</span>
03299 <span class="comment"></span>
03300 <span class="comment">Environment:</span>
03301 <span class="comment"></span>
03302 <span class="comment">    Kernel Mode, IRQL of APC_LEVEL or below.</span>
03303 <span class="comment"></span>
03304 <span class="comment">--*/</span>
03305 
03306 {
03307     PVOID Base;
03308     KIRQL OldIrql;
03309     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> Subsection;
03310     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
03311     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> NewControlArea;
03312     ULONG StartBit;
03313     ULONG SizeIn64k;
03314     ULONG NewSizeIn64k;
03315     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> BasePte;
03316     ULONG NumberOfPtes;
03317     ULONG NumberOfBytes;
03318     BOOLEAN status;
03319     KIRQL WsIrql;
03320 
03321     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03322 
03323     <span class="comment">//</span>
03324     <span class="comment">// Check to see if a purge operation is in progress and if so, wait</span>
03325     <span class="comment">// for the purge to complete.  In addition, up the count of mapped</span>
03326     <span class="comment">// views for this control area.</span>
03327     <span class="comment">//</span>
03328 
03329     ControlArea = ((<a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>)Section)-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o0">Segment</a>-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o0">ControlArea</a>;
03330 
03331     <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.GlobalOnlyPerSession == 0) {
03332         Subsection = (<a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a>)(ControlArea + 1);
03333     }
03334     <span class="keywordflow">else</span> {
03335         Subsection = (<a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a>)((<a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html">PLARGE_CONTROL_AREA</a>)ControlArea + 1);
03336     }
03337 
03338     <a class="code" href="../../d5/d6/iosup_8c.html#a76">MmLockPagableSectionByHandle</a>(<a class="code" href="../../d5/d8/ex_8h.html#a166">ExPageLockHandle</a>);
03339 
03340     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a928">MiCheckPurgeAndUpMapCount</a> (ControlArea) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
03341         <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(<a class="code" href="../../d5/d8/ex_8h.html#a166">ExPageLockHandle</a>);
03342         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
03343     }
03344 
03345     <span class="keywordflow">if</span> (*ViewSize == 0) {
03346 
03347         *ViewSize = ((<a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>)Section)-&gt;SizeOfSection.LowPart;
03348 
03349     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*ViewSize &gt; ((<a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>)Section)-&gt;SizeOfSection.LowPart) {
03350 
03351         <span class="comment">//</span>
03352         <span class="comment">// Section offset or view size past size of section.</span>
03353         <span class="comment">//</span>
03354 
03355         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
03356         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o4">NumberOfMappedViews</a> -= 1;
03357         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o7">NumberOfUserReferences</a> -= 1;
03358 
03359         <span class="comment">//</span>
03360         <span class="comment">// Check to see if the control area (segment) should be deleted.</span>
03361         <span class="comment">// This routine releases the PFN lock.</span>
03362         <span class="comment">//</span>
03363     
03364         <a class="code" href="../../d5/d5/sectsup_8c.html#a24">MiCheckControlArea</a> (ControlArea, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, OldIrql);
03365 
03366         <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(<a class="code" href="../../d5/d8/ex_8h.html#a166">ExPageLockHandle</a>);
03367         <span class="keywordflow">return</span> STATUS_INVALID_VIEW_SIZE;
03368     }
03369 
03370     <span class="comment">//</span>
03371     <span class="comment">// Calculate the first prototype PTE field in the Vad.</span>
03372     <span class="comment">//</span>
03373 
03374     SizeIn64k = (ULONG)((*ViewSize / <a class="code" href="../../d4/d8/mi_8h.html#a18">X64K</a>) + ((*ViewSize &amp; (<a class="code" href="../../d4/d8/mi_8h.html#a18">X64K</a> - 1)) != 0));
03375 
03376     Base = <a class="code" href="../../d3/d5/mapview_8c.html#a18">MiInsertInSystemSpace</a> (Session, SizeIn64k, ControlArea);
03377 
03378     <span class="keywordflow">if</span> (Base == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03379         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
03380         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o4">NumberOfMappedViews</a> -= 1;
03381         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o7">NumberOfUserReferences</a> -= 1;
03382 
03383         <span class="comment">//</span>
03384         <span class="comment">// Check to see if the control area (segment) should be deleted.</span>
03385         <span class="comment">// This routine releases the PFN lock.</span>
03386         <span class="comment">//</span>
03387     
03388         <a class="code" href="../../d5/d5/sectsup_8c.html#a24">MiCheckControlArea</a> (ControlArea, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, OldIrql);
03389 
03390         <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(<a class="code" href="../../d5/d8/ex_8h.html#a166">ExPageLockHandle</a>);
03391         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
03392     }
03393 
03394     NumberOfBytes = SizeIn64k * <a class="code" href="../../d4/d8/mi_8h.html#a18">X64K</a>;
03395 
03396     <span class="keywordflow">if</span> (Session == &amp;<a class="code" href="../../d3/d5/mapview_8c.html#a6">MmSession</a>) {
03397         status = <a class="code" href="../../d3/d5/mapview_8c.html#a15">MiFillSystemPageDirectory</a> (Base, NumberOfBytes);
03398     }
03399     <span class="keywordflow">else</span> {
03400         <a class="code" href="../../d4/d8/mi_8h.html#a407">LOCK_SESSION_SPACE_WS</a> (WsIrql);
03401         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d4/d8/mi_8h.html#a972">MiSessionCommitPageTables</a> (Base,
03402                 (PVOID)((ULONG_PTR)Base + NumberOfBytes - 1)))) {
03403                     status = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03404         }
03405         <span class="keywordflow">else</span> {
03406                     status = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03407         }
03408     }
03409 
03410     <span class="keywordflow">if</span> (status == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
03411         <span class="keywordflow">if</span> (Session != &amp;<a class="code" href="../../d3/d5/mapview_8c.html#a6">MmSession</a>) {
03412             <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a> (WsIrql);
03413         }
03414 
03415         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
03416         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o4">NumberOfMappedViews</a> -= 1;
03417         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o7">NumberOfUserReferences</a> -= 1;
03418 
03419         <span class="comment">//</span>
03420         <span class="comment">// Check to see if the control area (segment) should be deleted.</span>
03421         <span class="comment">// This routine releases the PFN lock.</span>
03422         <span class="comment">//</span>
03423     
03424         <a class="code" href="../../d5/d5/sectsup_8c.html#a24">MiCheckControlArea</a> (ControlArea, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, OldIrql);
03425 
03426         StartBit = (ULONG) (((ULONG_PTR)Base - (ULONG_PTR)Session-&gt;SystemSpaceViewStart) &gt;&gt; 16);
03427 
03428         <a class="code" href="../../d4/d8/mi_8h.html#a238">LOCK_SYSTEM_VIEW_SPACE</a> (Session);
03429 
03430         NewSizeIn64k = <a class="code" href="../../d3/d5/mapview_8c.html#a19">MiRemoveFromSystemSpace</a> (Session, Base, &amp;NewControlArea);
03431 
03432         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea == NewControlArea);
03433         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (SizeIn64k == NewSizeIn64k);
03434 
03435         <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a33">RtlClearBits</a> (Session-&gt;SystemSpaceBitMap, StartBit, SizeIn64k);
03436 
03437         <a class="code" href="../../d4/d8/mi_8h.html#a239">UNLOCK_SYSTEM_VIEW_SPACE</a> (Session);
03438 
03439         <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(<a class="code" href="../../d5/d8/ex_8h.html#a166">ExPageLockHandle</a>);
03440         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
03441     }
03442 
03443     <span class="comment">//</span>
03444     <span class="comment">// Setup PTEs to point to prototype PTEs.</span>
03445     <span class="comment">//</span>
03446 
03447     <span class="keywordflow">if</span> (((<a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>)Section)-&gt;u.Flags.Image) {
03448 
03449 <span class="preprocessor">#if DBG</span>
03450 <span class="preprocessor"></span>        <span class="comment">//</span>
03451         <span class="comment">// The only reason this ASSERT isn't done for Hydra is because</span>
03452         <span class="comment">// the session space working set lock is currently held so faults</span>
03453         <span class="comment">// are not allowed.</span>
03454         <span class="comment">//</span>
03455 
03456         <span class="keywordflow">if</span> (Session == &amp;<a class="code" href="../../d3/d5/mapview_8c.html#a6">MmSession</a>) {
03457             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (((<a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>)Section)-&gt;Segment-&gt;ControlArea == ControlArea);
03458         }
03459 <span class="preprocessor">#endif</span>
03460 <span class="preprocessor"></span>
03461         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
03462         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.ImageMappedInSystemSpace = 1;
03463         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03464     }
03465 
03466     BasePte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (Base);
03467     NumberOfPtes = <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a> (*ViewSize);
03468 
03469     <a class="code" href="../../d4/d8/mi_8h.html#a816">MiAddMappedPtes</a> (BasePte,
03470                      NumberOfPtes,
03471                      ControlArea);
03472 
03473     <span class="keywordflow">if</span> (Session != &amp;<a class="code" href="../../d3/d5/mapview_8c.html#a6">MmSession</a>) {
03474         <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a> (WsIrql);
03475     }
03476 
03477     *MappedBase = Base;
03478 
03479     <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(<a class="code" href="../../d5/d8/ex_8h.html#a166">ExPageLockHandle</a>);
03480     <span class="keywordflow">return</span> STATUS_SUCCESS;
03481 }
03482 
03483 BOOLEAN
<a name="l03484"></a><a class="code" href="../../d3/d5/mapview_8c.html#a15">03484</a> <a class="code" href="../../d3/d5/mapview_8c.html#a15">MiFillSystemPageDirectory</a> (
03485     PVOID Base,
03486     SIZE_T NumberOfBytes
03487     )
03488 
03489 <span class="comment">/*++</span>
03490 <span class="comment"></span>
03491 <span class="comment">Routine Description:</span>
03492 <span class="comment"></span>
03493 <span class="comment">    This routine allocates page tables and fills the system page directory</span>
03494 <span class="comment">    entries for the specified virtual address range.</span>
03495 <span class="comment"></span>
03496 <span class="comment">Arguments:</span>
03497 <span class="comment"></span>
03498 <span class="comment">    Base - Supplies the virtual address of the view.</span>
03499 <span class="comment"></span>
03500 <span class="comment">    NumberOfBytes - Supplies the number of bytes the view spans.</span>
03501 <span class="comment"></span>
03502 <span class="comment">Return Value:</span>
03503 <span class="comment"></span>
03504 <span class="comment">    TRUE on success, FALSE on failure.</span>
03505 <span class="comment"></span>
03506 <span class="comment">Environment:</span>
03507 <span class="comment"></span>
03508 <span class="comment">    Kernel Mode, IRQL of dispatch level.</span>
03509 <span class="comment"></span>
03510 <span class="comment">--*/</span>
03511 
03512 {
03513     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> FirstPde;
03514     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPde;
03515     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> FirstSystemPde;
03516     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
03517     PFN_NUMBER PageFrameIndex;
03518     KIRQL OldIrql;
03519     ULONG i;
03520 
03521     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03522 
03523     <span class="comment">//</span>
03524     <span class="comment">// CODE IS ALREADY LOCKED BY CALLER.</span>
03525     <span class="comment">//</span>
03526 
03527     FirstPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (Base);
03528     LastPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> ((PVOID)(((PCHAR)Base) + NumberOfBytes - 1));
03529 
03530 <span class="preprocessor">#if defined (_WIN64)</span>
03531 <span class="preprocessor"></span>    FirstSystemPde = FirstPde;
03532 <span class="preprocessor">#else</span>
03533 <span class="preprocessor"></span><span class="preprocessor">#if !defined (_X86PAE_)</span>
03534 <span class="preprocessor"></span>    FirstSystemPde = &amp;<a class="code" href="../../d4/d8/mi_8h.html#a636">MmSystemPagePtes</a>[((ULONG_PTR)FirstPde &amp;
03535                      ((<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a102">PDE_PER_PAGE</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>)) - 1)) / <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>) ];
03536 <span class="preprocessor">#else</span>
03537 <span class="preprocessor"></span>    FirstSystemPde = &amp;<a class="code" href="../../d4/d8/mi_8h.html#a636">MmSystemPagePtes</a>[((ULONG_PTR)FirstPde &amp;
03538                      (PD_PER_SYSTEM * (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a102">PDE_PER_PAGE</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>)) - 1)) / <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>) ];
03539 <span class="preprocessor">#endif</span>
03540 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
03541 <span class="preprocessor"></span>
03542     <span class="keywordflow">do</span> {
03543         <span class="keywordflow">if</span> (FirstSystemPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
03544 
03545             <span class="comment">//</span>
03546             <span class="comment">// No page table page exists, get a page and map it in.</span>
03547             <span class="comment">//</span>
03548 
03549             TempPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a7">ValidKernelPde</a>;
03550 
03551             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
03552 
03553             <span class="keywordflow">if</span> (((<span class="keyword">volatile</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> *)FirstSystemPde)-&gt;u.Hard.Valid == 0) {
03554 
03555                 <span class="keywordflow">if</span> (<a class="code" href="../../d7/d5/pfnlist_8c.html#a13">MiEnsureAvailablePageOrWait</a> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, FirstPde)) {
03556 
03557                     <span class="comment">//</span>
03558                     <span class="comment">// PFN_LOCK was dropped, redo this loop as another process</span>
03559                     <span class="comment">// could have made this PDE valid.</span>
03560                     <span class="comment">//</span>
03561 
03562                     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03563                     <span class="keywordflow">continue</span>;
03564                 }
03565 
03566                 <a class="code" href="../../d6/d1/mmquota_8c.html#a18">MiChargeCommitmentCantExpand</a> (1, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03567                 <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a270">MM_DBG_COMMIT_FILL_SYSTEM_DIRECTORY</a>, 1);
03568                 PageFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (
03569                                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a124">MI_GET_PAGE_COLOR_FROM_PTE</a> (FirstSystemPde));
03570                 TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = PageFrameIndex;
03571                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (FirstSystemPde, TempPte);
03572                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (FirstPde, TempPte);
03573 
03574 <span class="preprocessor">#if defined (_WIN64)</span>
03575 <span class="preprocessor"></span>                <a class="code" href="../../d8/d2/pagfault_8c.html#a22">MiInitializePfn</a> (PageFrameIndex,
03576                                  FirstPde,
03577                                  1);
03578 <span class="preprocessor">#else</span>
03579 <span class="preprocessor"></span>
03580 <span class="preprocessor">#if !defined (_X86PAE_)</span>
03581 <span class="preprocessor"></span>                <a class="code" href="../../d8/d2/pagfault_8c.html#a27">MiInitializePfnForOtherProcess</a> (PageFrameIndex,
03582                                                 FirstPde,
03583                                                 <a class="code" href="../../d4/d8/mi_8h.html#a637">MmSystemPageDirectory</a>);
03584 <span class="preprocessor">#else</span>
03585 <span class="preprocessor"></span>                i = (FirstPde - <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(0)) / <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a102">PDE_PER_PAGE</a>;
03586                 <a class="code" href="../../d8/d2/pagfault_8c.html#a27">MiInitializePfnForOtherProcess</a> (PageFrameIndex,
03587                                                 FirstPde,
03588                                                 <a class="code" href="../../d4/d8/mi_8h.html#a637">MmSystemPageDirectory</a>[i]);
03589 <span class="preprocessor">#endif</span>
03590 <span class="preprocessor"></span>
03591 <span class="preprocessor">#endif</span>
03592 <span class="preprocessor"></span>
03593                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a189">MiFillMemoryPte</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (FirstPde),
03594                                  <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>,
03595                                  <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a94">MM_ZERO_KERNEL_PTE</a>);
03596             }
03597             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03598         }
03599 
03600         FirstSystemPde += 1;
03601         FirstPde += 1;
03602     } <span class="keywordflow">while</span> (FirstPde &lt;= LastPde  );
03603 
03604     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03605 }
03606 
03607 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03608"></a><a class="code" href="../../d3/d5/mapview_8c.html#a29">03608</a> <a class="code" href="../../d3/d5/mapview_8c.html#a29">MmUnmapViewInSystemSpace</a> (
03609     IN PVOID MappedBase
03610     )
03611 
03612 <span class="comment">/*++</span>
03613 <span class="comment"></span>
03614 <span class="comment">Routine Description:</span>
03615 <span class="comment"></span>
03616 <span class="comment">    This routine unmaps the specified section from the system's address space.</span>
03617 <span class="comment"></span>
03618 <span class="comment">Arguments:</span>
03619 <span class="comment"></span>
03620 <span class="comment">    MappedBase - Supplies the address of the view to unmap.</span>
03621 <span class="comment"></span>
03622 <span class="comment">Return Value:</span>
03623 <span class="comment"></span>
03624 <span class="comment">    Status of the map view operation.</span>
03625 <span class="comment"></span>
03626 <span class="comment">Environment:</span>
03627 <span class="comment"></span>
03628 <span class="comment">    Kernel Mode, IRQL of dispatch level.</span>
03629 <span class="comment"></span>
03630 <span class="comment">--*/</span>
03631 
03632 {
03633     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03634 
03635     <span class="keywordflow">return</span> <a class="code" href="../../d3/d5/mapview_8c.html#a14">MiUnmapViewInSystemSpace</a> (&amp;<a class="code" href="../../d3/d5/mapview_8c.html#a6">MmSession</a>, MappedBase);
03636 }
03637 
03638 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03639"></a><a class="code" href="../../d3/d5/mapview_8c.html#a30">03639</a> <a class="code" href="../../d3/d5/mapview_8c.html#a30">MmUnmapViewInSessionSpace</a> (
03640     IN PVOID MappedBase
03641     )
03642 
03643 <span class="comment">/*++</span>
03644 <span class="comment"></span>
03645 <span class="comment">Routine Description:</span>
03646 <span class="comment"></span>
03647 <span class="comment">    This routine unmaps the specified section from the system's address space.</span>
03648 <span class="comment"></span>
03649 <span class="comment">Arguments:</span>
03650 <span class="comment"></span>
03651 <span class="comment">    MappedBase - Supplies the address of the view to unmap.</span>
03652 <span class="comment"></span>
03653 <span class="comment">Return Value:</span>
03654 <span class="comment"></span>
03655 <span class="comment">    Status of the map view operation.</span>
03656 <span class="comment"></span>
03657 <span class="comment">Environment:</span>
03658 <span class="comment"></span>
03659 <span class="comment">    Kernel Mode, IRQL of dispatch level.</span>
03660 <span class="comment"></span>
03661 <span class="comment">--*/</span>
03662 
03663 {
03664     <a class="code" href="../../d0/d6/struct__MMSESSION.html">PMMSESSION</a> Session;
03665 
03666     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03667 
03668     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
03669         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Vm.u.Flags.ProcessInSession == 0) {
03670             <span class="keywordflow">return</span> STATUS_NOT_MAPPED_VIEW;
03671         }
03672         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a>(<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03673         Session = &amp;<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o34">Session</a>;
03674     }
03675     <span class="keywordflow">else</span> {
03676         Session = &amp;<a class="code" href="../../d3/d5/mapview_8c.html#a6">MmSession</a>;
03677     }
03678 
03679     <span class="keywordflow">return</span> <a class="code" href="../../d3/d5/mapview_8c.html#a14">MiUnmapViewInSystemSpace</a> (Session, MappedBase);
03680 }
03681 
03682 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03683"></a><a class="code" href="../../d3/d5/mapview_8c.html#a14">03683</a> <a class="code" href="../../d3/d5/mapview_8c.html#a14">MiUnmapViewInSystemSpace</a> (
03684     IN <a class="code" href="../../d0/d6/struct__MMSESSION.html">PMMSESSION</a> Session,
03685     IN PVOID MappedBase
03686     )
03687 
03688 <span class="comment">/*++</span>
03689 <span class="comment"></span>
03690 <span class="comment">Routine Description:</span>
03691 <span class="comment"></span>
03692 <span class="comment">    This routine unmaps the specified section from the system's address space.</span>
03693 <span class="comment"></span>
03694 <span class="comment">Arguments:</span>
03695 <span class="comment"></span>
03696 <span class="comment">    Session - Supplies the session data structure for this view.</span>
03697 <span class="comment"></span>
03698 <span class="comment">    MappedBase - Supplies the address of the view to unmap.</span>
03699 <span class="comment"></span>
03700 <span class="comment">Return Value:</span>
03701 <span class="comment"></span>
03702 <span class="comment">    Status of the map view operation.</span>
03703 <span class="comment"></span>
03704 <span class="comment">Environment:</span>
03705 <span class="comment"></span>
03706 <span class="comment">    Kernel Mode, IRQL of dispatch level.</span>
03707 <span class="comment"></span>
03708 <span class="comment">--*/</span>
03709 
03710 {
03711     ULONG StartBit;
03712     ULONG <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
03713     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
03714     <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> Ws;
03715     KIRQL WsIrql;
03716 
03717     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03718 
03719     <a class="code" href="../../d5/d6/iosup_8c.html#a76">MmLockPagableSectionByHandle</a>(<a class="code" href="../../d5/d8/ex_8h.html#a166">ExPageLockHandle</a>);
03720     StartBit =  (ULONG) (((ULONG_PTR)MappedBase - (ULONG_PTR)Session-&gt;SystemSpaceViewStart) &gt;&gt; 16);
03721 
03722     <a class="code" href="../../d4/d8/mi_8h.html#a238">LOCK_SYSTEM_VIEW_SPACE</a> (Session);
03723 
03724     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = <a class="code" href="../../d3/d5/mapview_8c.html#a19">MiRemoveFromSystemSpace</a> (Session, MappedBase, &amp;ControlArea);
03725 
03726     <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a33">RtlClearBits</a> (Session-&gt;SystemSpaceBitMap, StartBit, <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>);
03727 
03728     <span class="comment">//</span>
03729     <span class="comment">// Zero PTEs.</span>
03730     <span class="comment">//</span>
03731 
03732     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> * (<a class="code" href="../../d4/d8/mi_8h.html#a18">X64K</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
03733 
03734     <span class="keywordflow">if</span> (Session == &amp;<a class="code" href="../../d3/d5/mapview_8c.html#a6">MmSession</a>) {
03735         Ws = &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>;
03736     }
03737     <span class="keywordflow">else</span> {
03738         Ws = &amp;<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>;
03739         <a class="code" href="../../d4/d8/mi_8h.html#a407">LOCK_SESSION_SPACE_WS</a>(WsIrql);
03740     }
03741 
03742     <a class="code" href="../../d3/d5/mapview_8c.html#a12">MiRemoveMappedPtes</a> (MappedBase, <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>, ControlArea, Ws);
03743 
03744     <span class="keywordflow">if</span> (Session != &amp;<a class="code" href="../../d3/d5/mapview_8c.html#a6">MmSession</a>) {
03745         <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a>(WsIrql);
03746     }
03747 
03748     <a class="code" href="../../d4/d8/mi_8h.html#a239">UNLOCK_SYSTEM_VIEW_SPACE</a> (Session);
03749 
03750     <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(<a class="code" href="../../d5/d8/ex_8h.html#a166">ExPageLockHandle</a>);
03751 
03752     <span class="keywordflow">return</span> STATUS_SUCCESS;
03753 }
03754 
03755 
03756 PVOID
<a name="l03757"></a><a class="code" href="../../d3/d5/mapview_8c.html#a18">03757</a> <a class="code" href="../../d3/d5/mapview_8c.html#a18">MiInsertInSystemSpace</a> (
03758     IN <a class="code" href="../../d0/d6/struct__MMSESSION.html">PMMSESSION</a> Session,
03759     IN ULONG SizeIn64k,
03760     IN <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea
03761     )
03762 
03763 <span class="comment">/*++</span>
03764 <span class="comment"></span>
03765 <span class="comment">Routine Description:</span>
03766 <span class="comment"></span>
03767 <span class="comment">    This routine creates a view in system space for the specified control</span>
03768 <span class="comment">    area (file mapping).</span>
03769 <span class="comment"></span>
03770 <span class="comment">Arguments:</span>
03771 <span class="comment"></span>
03772 <span class="comment">    SizeIn64k - Supplies the size of the view to be created.</span>
03773 <span class="comment"></span>
03774 <span class="comment">    ControlArea - Supplies a pointer to the control area for this view.</span>
03775 <span class="comment"></span>
03776 <span class="comment">Return Value:</span>
03777 <span class="comment"></span>
03778 <span class="comment">    Base address where the view was mapped, NULL if the view could not be</span>
03779 <span class="comment">    mapped.</span>
03780 <span class="comment"></span>
03781 <span class="comment">Environment:</span>
03782 <span class="comment"></span>
03783 <span class="comment">    Kernel Mode.</span>
03784 <span class="comment"></span>
03785 <span class="comment">--*/</span>
03786 
03787 {
03788 
03789     PVOID Base;
03790     ULONG_PTR Entry;
03791     ULONG Hash;
03792     ULONG i;
03793     ULONG AllocSize;
03794     <a class="code" href="../../d5/d7/struct__MMVIEW.html">PMMVIEW</a> OldTable;
03795     ULONG StartBit;
03796     ULONG NewHashSize;
03797 
03798     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03799 
03800     <span class="comment">//</span>
03801     <span class="comment">// CODE IS ALREADY LOCKED BY CALLER.</span>
03802     <span class="comment">//</span>
03803 
03804     <a class="code" href="../../d4/d8/mi_8h.html#a238">LOCK_SYSTEM_VIEW_SPACE</a> (Session);
03805 
03806     <span class="keywordflow">if</span> (Session-&gt;SystemSpaceHashEntries + 8 &gt; Session-&gt;SystemSpaceHashSize) {
03807 
03808         <span class="comment">//</span>
03809         <span class="comment">// Less than 8 free slots, reallocate and rehash.</span>
03810         <span class="comment">//</span>
03811 
03812         NewHashSize = Session-&gt;SystemSpaceHashSize &lt;&lt; 1;
03813 
03814         AllocSize = <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d7/struct__MMVIEW.html">MMVIEW</a>) * NewHashSize;
03815         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (AllocSize &lt; <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
03816 
03817         OldTable = Session-&gt;SystemSpaceViewTable;
03818 
03819         Session-&gt;SystemSpaceViewTable = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
03820                                                                AllocSize,
03821                                                                '  mM');
03822 
03823         <span class="keywordflow">if</span> (Session-&gt;SystemSpaceViewTable == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03824             Session-&gt;SystemSpaceViewTable = OldTable;
03825         }
03826         <span class="keywordflow">else</span> {
03827             RtlZeroMemory (Session-&gt;SystemSpaceViewTable, AllocSize);
03828 
03829             Session-&gt;SystemSpaceHashSize = NewHashSize;
03830             Session-&gt;SystemSpaceHashKey = Session-&gt;SystemSpaceHashSize - 1;
03831 
03832             <span class="keywordflow">for</span> (i = 0; i &lt; (Session-&gt;SystemSpaceHashSize / 2); i += 1) {
03833                 <span class="keywordflow">if</span> (OldTable[i].<a class="code" href="../../d5/d7/struct__MMVIEW.html#o0">Entry</a> != 0) {
03834                     Hash = (ULONG) ((OldTable[i].<a class="code" href="../../d5/d7/struct__MMVIEW.html#o0">Entry</a> &gt;&gt; 16) % Session-&gt;SystemSpaceHashKey);
03835 
03836                     <span class="keywordflow">while</span> (Session-&gt;SystemSpaceViewTable[Hash].Entry != 0) {
03837                         Hash += 1;
03838                         <span class="keywordflow">if</span> (Hash &gt;= Session-&gt;SystemSpaceHashSize) {
03839                             Hash = 0;
03840                         }
03841                     }
03842                     Session-&gt;SystemSpaceViewTable[Hash] = OldTable[i];
03843                 }
03844             }
03845             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (OldTable);
03846         }
03847     }
03848 
03849     <span class="keywordflow">if</span> (Session-&gt;SystemSpaceHashEntries == Session-&gt;SystemSpaceHashSize) {
03850 
03851         <span class="comment">//</span>
03852         <span class="comment">// There are no free hash slots to place a new entry into even</span>
03853         <span class="comment">// though there may still be unused virtual address space.</span>
03854         <span class="comment">//</span>
03855 
03856         <a class="code" href="../../d4/d8/mi_8h.html#a239">UNLOCK_SYSTEM_VIEW_SPACE</a> (Session);
03857         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03858     }
03859 
03860     StartBit = <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a31">RtlFindClearBitsAndSet</a> (Session-&gt;SystemSpaceBitMap,
03861                                        SizeIn64k,
03862                                        0);
03863 
03864     <span class="keywordflow">if</span> (StartBit == 0xFFFFFFFF) {
03865         <a class="code" href="../../d4/d8/mi_8h.html#a239">UNLOCK_SYSTEM_VIEW_SPACE</a> (Session);
03866         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03867     }
03868 
03869     Base = (PVOID)((PCHAR)Session-&gt;SystemSpaceViewStart + (StartBit * <a class="code" href="../../d4/d8/mi_8h.html#a18">X64K</a>));
03870 
03871     Entry = (ULONG_PTR) <a class="code" href="../../d4/d8/mi_8h.html#a91">MI_64K_ALIGN</a>(Base) + SizeIn64k;
03872 
03873     Hash = (ULONG) ((Entry &gt;&gt; 16) % Session-&gt;SystemSpaceHashKey);
03874 
03875     <span class="keywordflow">while</span> (Session-&gt;SystemSpaceViewTable[Hash].Entry != 0) {
03876         Hash += 1;
03877         <span class="keywordflow">if</span> (Hash &gt;= Session-&gt;SystemSpaceHashSize) {
03878             Hash = 0;
03879         }
03880     }
03881 
03882     Session-&gt;SystemSpaceHashEntries += 1;
03883 
03884     Session-&gt;SystemSpaceViewTable[Hash].Entry = Entry;
03885     Session-&gt;SystemSpaceViewTable[Hash].ControlArea = ControlArea;
03886 
03887     <a class="code" href="../../d4/d8/mi_8h.html#a239">UNLOCK_SYSTEM_VIEW_SPACE</a> (Session);
03888     <span class="keywordflow">return</span> Base;
03889 }
03890 
03891 
03892 ULONG
<a name="l03893"></a><a class="code" href="../../d3/d5/mapview_8c.html#a19">03893</a> <a class="code" href="../../d3/d5/mapview_8c.html#a19">MiRemoveFromSystemSpace</a> (
03894     IN <a class="code" href="../../d0/d6/struct__MMSESSION.html">PMMSESSION</a> Session,
03895     IN PVOID Base,
03896     OUT <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> *ControlArea
03897     )
03898 
03899 <span class="comment">/*++</span>
03900 <span class="comment"></span>
03901 <span class="comment">Routine Description:</span>
03902 <span class="comment"></span>
03903 <span class="comment">    This routine looks up the specified view in the system space hash</span>
03904 <span class="comment">    table and unmaps the view from system space and the table.</span>
03905 <span class="comment"></span>
03906 <span class="comment">Arguments:</span>
03907 <span class="comment"></span>
03908 <span class="comment">    Session - Supplies the session data structure for this view.</span>
03909 <span class="comment"></span>
03910 <span class="comment">    Base - Supplies the base address for the view.  If this address is</span>
03911 <span class="comment">           NOT found in the hash table, the system bugchecks.</span>
03912 <span class="comment"></span>
03913 <span class="comment">    ControlArea - Returns the control area corresponding to the base</span>
03914 <span class="comment">                  address.</span>
03915 <span class="comment"></span>
03916 <span class="comment">Return Value:</span>
03917 <span class="comment"></span>
03918 <span class="comment">    Size of the view divided by 64k.</span>
03919 <span class="comment"></span>
03920 <span class="comment">Environment:</span>
03921 <span class="comment"></span>
03922 <span class="comment">    Kernel Mode, system view hash table locked.</span>
03923 <span class="comment"></span>
03924 <span class="comment">--*/</span>
03925 
03926 {
03927     ULONG_PTR Base16;
03928     ULONG Hash;
03929     ULONG <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
03930     ULONG count;
03931 
03932     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03933 
03934     count = 0;
03935 
03936     <span class="comment">//</span>
03937     <span class="comment">// CODE IS ALREADY LOCKED BY CALLER.</span>
03938     <span class="comment">//</span>
03939 
03940     Base16 = (ULONG_PTR)Base &gt;&gt; 16;
03941     Hash = (ULONG)(Base16 % Session-&gt;SystemSpaceHashKey);
03942 
03943     <span class="keywordflow">while</span> ((Session-&gt;SystemSpaceViewTable[Hash].Entry &gt;&gt; 16) != Base16) {
03944         Hash += 1;
03945         <span class="keywordflow">if</span> (Hash &gt;= Session-&gt;SystemSpaceHashSize) {
03946             Hash = 0;
03947             count += 1;
03948             <span class="keywordflow">if</span> (count == 2) {
03949                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_UNMAPPING_INVALID_VIEW,
03950                               (ULONG_PTR)Base,
03951                               <a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a>,
03952                               0,
03953                               0);
03954             }
03955         }
03956     }
03957 
03958     Session-&gt;SystemSpaceHashEntries -= 1;
03959     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = (ULONG) (Session-&gt;SystemSpaceViewTable[Hash].Entry &amp; 0xFFFF);
03960     Session-&gt;SystemSpaceViewTable[Hash].Entry = 0;
03961     *ControlArea = Session-&gt;SystemSpaceViewTable[Hash].ControlArea;
03962     <span class="keywordflow">return</span> <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
03963 }
03964 
03965 
03966 BOOLEAN
<a name="l03967"></a><a class="code" href="../../d3/d5/mapview_8c.html#a31">03967</a> <a class="code" href="../../d4/d8/mi_8h.html#a779">MiInitializeSystemSpaceMap</a> (
03968     PVOID   InputSession OPTIONAL
03969     )
03970 
03971 <span class="comment">/*++</span>
03972 <span class="comment"></span>
03973 <span class="comment">Routine Description:</span>
03974 <span class="comment"></span>
03975 <span class="comment">    This routine initializes the tables for mapping views into system space.</span>
03976 <span class="comment">    Views are kept in a multiple of 64k bytes in a growable hashed table.</span>
03977 <span class="comment"></span>
03978 <span class="comment">Arguments:</span>
03979 <span class="comment"></span>
03980 <span class="comment">    NULL if this is the initial system session (non-Hydra), a valid session</span>
03981 <span class="comment">    pointer (the pointer must be in global space, not session space) for</span>
03982 <span class="comment">    Hydra session initialization.</span>
03983 <span class="comment"></span>
03984 <span class="comment">Return Value:</span>
03985 <span class="comment"></span>
03986 <span class="comment">    TRUE on success, FALSE on failure.</span>
03987 <span class="comment"></span>
03988 <span class="comment">Environment:</span>
03989 <span class="comment"></span>
03990 <span class="comment">    Kernel Mode, initialization.</span>
03991 <span class="comment"></span>
03992 <span class="comment">--*/</span>
03993 
03994 {
03995     ULONG AllocSize;
03996     ULONG <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
03997     PCHAR ViewStart;
03998     <a class="code" href="../../d0/d6/struct__MMSESSION.html">PMMSESSION</a> Session;
03999 
04000     <span class="keywordflow">if</span> (ARGUMENT_PRESENT (InputSession)) {
04001         Session = (<a class="code" href="../../d0/d6/struct__MMSESSION.html">PMMSESSION</a>)InputSession;
04002         ViewStart = (PCHAR)<a class="code" href="../../d4/d8/mi_8h.html#a349">MI_SESSION_VIEW_START</a>;
04003         <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = <a class="code" href="../../d4/d8/mi_8h.html#a336">MI_SESSION_VIEW_SIZE</a>;
04004     }
04005     <span class="keywordflow">else</span> {
04006         Session = &amp;<a class="code" href="../../d3/d5/mapview_8c.html#a6">MmSession</a>;
04007         ViewStart = (PCHAR)<a class="code" href="../../d4/d8/mi_8h.html#a656">MiSystemViewStart</a>;
04008         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
04009             <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a20">MM_SYSTEM_VIEW_SIZE_IF_HYDRA</a>;
04010         }
04011         <span class="keywordflow">else</span> {
04012             <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a18">MM_SYSTEM_VIEW_SIZE</a>;
04013         }
04014     }
04015 
04016     <span class="comment">//</span>
04017     <span class="comment">// We are passed a system global address for the address of the session.</span>
04018     <span class="comment">// Save a global pointer to the mutex below because multiple sessions will</span>
04019     <span class="comment">// generally give us a session-space (not a global space) pointer to the</span>
04020     <span class="comment">// MMSESSION in subsequent calls.  We need the global pointer for the mutex</span>
04021     <span class="comment">// field for the kernel primitives to work properly.</span>
04022     <span class="comment">//</span>
04023 
04024     Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o1">SystemSpaceViewLockPointer</a> = &amp;Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o0">SystemSpaceViewLock</a>;
04025     <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>(Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o1">SystemSpaceViewLockPointer</a>);
04026 
04027     <span class="comment">//</span>
04028     <span class="comment">// If the kernel image has not been biased to allow for 3gb of user space,</span>
04029     <span class="comment">// then the system space view starts at the defined place. Otherwise, it</span>
04030     <span class="comment">// starts 16mb above the kernel image.</span>
04031     <span class="comment">//</span>
04032 
04033     Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o2">SystemSpaceViewStart</a> = ViewStart;
04034 
04035     <a class="code" href="../../d4/d8/mi_8h.html#a233">MiCreateBitMap</a> (&amp;Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o7">SystemSpaceBitMap</a>, <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> / <a class="code" href="../../d4/d8/mi_8h.html#a18">X64K</a>, <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>);
04036     <span class="keywordflow">if</span> (Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o7">SystemSpaceBitMap</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04037         <a class="code" href="../../d4/d8/mi_8h.html#a396">MM_BUMP_SESSION_FAILURES</a> (<a class="code" href="../../d4/d8/mi_8h.html#a392">MM_SESSION_FAILURE_NO_NONPAGED_POOL</a>);
04038         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04039     }
04040 
04041     <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a27">RtlClearAllBits</a> (Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o7">SystemSpaceBitMap</a>);
04042 
04043     <span class="comment">//</span>
04044     <span class="comment">// Build the view table.</span>
04045     <span class="comment">//</span>
04046 
04047     Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o4">SystemSpaceHashSize</a> = 31;
04048     Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o6">SystemSpaceHashKey</a> = Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o4">SystemSpaceHashSize</a> - 1;
04049     Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o5">SystemSpaceHashEntries</a> = 0;
04050 
04051     AllocSize = <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d7/struct__MMVIEW.html">MMVIEW</a>) * Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o4">SystemSpaceHashSize</a>;
04052     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (AllocSize &lt; <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
04053 
04054     Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o3">SystemSpaceViewTable</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
04055                                                            AllocSize,
04056                                                            '  mM');
04057 
04058     <span class="keywordflow">if</span> (Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o3">SystemSpaceViewTable</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04059         <a class="code" href="../../d4/d8/mi_8h.html#a396">MM_BUMP_SESSION_FAILURES</a> (<a class="code" href="../../d4/d8/mi_8h.html#a394">MM_SESSION_FAILURE_NO_SESSION_PAGED_POOL</a>);
04060         <a class="code" href="../../d4/d8/mi_8h.html#a234">MiRemoveBitMap</a> (&amp;Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o7">SystemSpaceBitMap</a>);
04061         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04062     }
04063 
04064     RtlZeroMemory (Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o3">SystemSpaceViewTable</a>, AllocSize);
04065 
04066     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04067 }
04068 
04069 
04070 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04071"></a><a class="code" href="../../d4/d8/mi_8h.html#a995">04071</a> <a class="code" href="../../d4/d8/mi_8h.html#a995">MiFreeSessionSpaceMap</a> (
04072     VOID
04073     )
04074 
04075 <span class="comment">/*++</span>
04076 <span class="comment"></span>
04077 <span class="comment">Routine Description:</span>
04078 <span class="comment"></span>
04079 <span class="comment">    This routine frees the tables used for mapping session views.</span>
04080 <span class="comment"></span>
04081 <span class="comment">Arguments:</span>
04082 <span class="comment"></span>
04083 <span class="comment">    None.</span>
04084 <span class="comment"></span>
04085 <span class="comment">Return Value:</span>
04086 <span class="comment"></span>
04087 <span class="comment">    None.</span>
04088 <span class="comment"></span>
04089 <span class="comment">Environment:</span>
04090 <span class="comment"></span>
04091 <span class="comment">    Kernel Mode.  The caller must be in the correct session context.</span>
04092 <span class="comment"></span>
04093 <span class="comment">--*/</span>
04094 
04095 {
04096     <a class="code" href="../../d0/d6/struct__MMSESSION.html">PMMSESSION</a> Session;
04097 
04098     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04099 
04100     Session = &amp;<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o34">Session</a>;
04101 
04102     <span class="comment">//</span>
04103     <span class="comment">// Check for leaks of objects in the view table.</span>
04104     <span class="comment">//</span>
04105 
04106     <a class="code" href="../../d4/d8/mi_8h.html#a238">LOCK_SYSTEM_VIEW_SPACE</a> (Session);
04107 
04108     <span class="keywordflow">if</span> (Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o3">SystemSpaceViewTable</a> &amp;&amp; Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o5">SystemSpaceHashEntries</a>) {
04109 
04110         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (SESSION_HAS_VALID_VIEWS_ON_EXIT,
04111                       (ULONG_PTR)<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o4">SessionId</a>,
04112                       Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o5">SystemSpaceHashEntries</a>,
04113                       (ULONG_PTR)&amp;Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o3">SystemSpaceViewTable</a>[0],
04114                       Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o4">SystemSpaceHashSize</a>);
04115 
04116 <span class="preprocessor">#if 0</span>
04117 <span class="preprocessor"></span>        ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
04118 
04119         <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o4">SystemSpaceHashSize</a>; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
04120 
04121             <a class="code" href="../../d5/d7/struct__MMVIEW.html">PMMVIEW</a> Table;
04122             PVOID Base;
04123 
04124             Table = &amp;Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o3">SystemSpaceViewTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
04125 
04126             <span class="keywordflow">if</span> (Table-&gt;<a class="code" href="../../d5/d7/struct__MMVIEW.html#o0">Entry</a>) {
04127 
04128 <span class="preprocessor">#if DBG</span>
04129 <span class="preprocessor"></span>                <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MM: MiFreeSessionSpaceMap: view entry %d leak: ControlArea %p, Addr %p, Size %d\n"</span>,
04130                     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>,
04131                     Table-&gt;<a class="code" href="../../d5/d7/struct__MMVIEW.html#o1">ControlArea</a>,
04132                     Table-&gt;<a class="code" href="../../d5/d7/struct__MMVIEW.html#o0">Entry</a> &amp; ~0xFFFF,
04133                     Table-&gt;<a class="code" href="../../d5/d7/struct__MMVIEW.html#o0">Entry</a> &amp; 0x0000FFFF
04134                 );
04135 <span class="preprocessor">#endif</span>
04136 <span class="preprocessor"></span>
04137                 Base = (PVOID)(Table-&gt;<a class="code" href="../../d5/d7/struct__MMVIEW.html#o0">Entry</a> &amp; ~0xFFFF);
04138 
04139                 <span class="comment">//</span>
04140                 <span class="comment">// MiUnmapViewInSystemSpace locks the ViewLock.</span>
04141                 <span class="comment">//</span>
04142 
04143                 <a class="code" href="../../d4/d8/mi_8h.html#a239">UNLOCK_SYSTEM_VIEW_SPACE</a>(Session);
04144 
04145                 <a class="code" href="../../d3/d5/mapview_8c.html#a14">MiUnmapViewInSystemSpace</a> (Session, Base);
04146 
04147                 <a class="code" href="../../d4/d8/mi_8h.html#a238">LOCK_SYSTEM_VIEW_SPACE</a> (Session);
04148 
04149                 <span class="comment">//</span>
04150                 <span class="comment">// The view table may have been deleted while we let go of</span>
04151                 <span class="comment">// the lock.</span>
04152                 <span class="comment">//</span>
04153 
04154                 <span class="keywordflow">if</span> (Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o3">SystemSpaceViewTable</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04155                     <span class="keywordflow">break</span>;
04156                 }
04157             }
04158         }
04159 <span class="preprocessor">#endif</span>
04160 <span class="preprocessor"></span>
04161     }
04162 
04163     <a class="code" href="../../d4/d8/mi_8h.html#a239">UNLOCK_SYSTEM_VIEW_SPACE</a> (Session);
04164 
04165     <span class="keywordflow">if</span> (Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o3">SystemSpaceViewTable</a>) {
04166         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o3">SystemSpaceViewTable</a>);
04167         Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o3">SystemSpaceViewTable</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04168     }
04169 
04170     <span class="keywordflow">if</span> (Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o7">SystemSpaceBitMap</a>) {
04171         <a class="code" href="../../d4/d8/mi_8h.html#a234">MiRemoveBitMap</a> (&amp;Session-&gt;<a class="code" href="../../d0/d6/struct__MMSESSION.html#o7">SystemSpaceBitMap</a>);
04172     }
04173 }
04174 
04175 
04176 HANDLE
<a name="l04177"></a><a class="code" href="../../d3/d5/mapview_8c.html#a33">04177</a> <a class="code" href="../../d3/d5/mapview_8c.html#a33">MmSecureVirtualMemory</a> (
04178     IN PVOID Address,
04179     IN SIZE_T Size,
04180     IN ULONG ProbeMode
04181     )
04182 
04183 <span class="comment">/*++</span>
04184 <span class="comment"></span>
04185 <span class="comment">Routine Description:</span>
04186 <span class="comment"></span>
04187 <span class="comment">    This routine probes the requested address range and protects</span>
04188 <span class="comment">    the specified address range from having its protection made</span>
04189 <span class="comment">    more restricted and being deleted.</span>
04190 <span class="comment"></span>
04191 <span class="comment">    MmUnsecureVirtualMemory is used to allow the range to return</span>
04192 <span class="comment">    to a normal state.</span>
04193 <span class="comment"></span>
04194 <span class="comment">Arguments:</span>
04195 <span class="comment"></span>
04196 <span class="comment">    Address - Supplies the base address to probe and secure.</span>
04197 <span class="comment"></span>
04198 <span class="comment">    Size - Supplies the size of the range to secure.</span>
04199 <span class="comment"></span>
04200 <span class="comment">    ProbeMode - Supplies one of PAGE_READONLY or PAGE_READWRITE.</span>
04201 <span class="comment"></span>
04202 <span class="comment">Return Value:</span>
04203 <span class="comment"></span>
04204 <span class="comment">    Returns a handle to be used to unsecure the range.</span>
04205 <span class="comment">    If the range could not be locked because of protection</span>
04206 <span class="comment">    problems or noncommitted memory, the value (HANDLE)0</span>
04207 <span class="comment">    is returned.</span>
04208 <span class="comment"></span>
04209 <span class="comment">Environment:</span>
04210 <span class="comment"></span>
04211 <span class="comment">    Kernel Mode.</span>
04212 <span class="comment"></span>
04213 <span class="comment">--*/</span>
04214 
04215 {
04216     ULONG_PTR EndAddress;
04217     PVOID StartAddress;
04218     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> Temp;
04219     ULONG Probe;
04220     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
04221     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Vad;
04222     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> NewVad;
04223     <a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html">PMMSECURE_ENTRY</a> Secure;
04224     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
04225     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe;
04226     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
04227     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
04228     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
04229     <a class="code" href="../../d7/d2/struct__MMLOCK__CONFLICT.html">MMLOCK_CONFLICT</a> Conflict;
04230     ULONG Waited;
04231 
04232     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04233 
04234     <span class="keywordflow">if</span> ((ULONG_PTR)Address + <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> &gt; (ULONG_PTR)MM_HIGHEST_USER_ADDRESS || (ULONG_PTR)Address + <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> &lt;= (ULONG_PTR)Address) {
04235         <span class="keywordflow">return</span> (HANDLE)0;
04236     }
04237 
04238     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = (HANDLE)0;
04239 
04240     Probe = (ProbeMode == PAGE_READONLY);
04241 
04242     Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
04243     StartAddress = Address;
04244 
04245     <a class="code" href="../../d4/d8/mi_8h.html#a160">LOCK_ADDRESS_SPACE</a> (Process);
04246 
04247     <span class="comment">//</span>
04248     <span class="comment">// Check for a private committed VAD first instead of probing to avoid all</span>
04249     <span class="comment">// the page faults and zeroing.  If we find one, then we run the PTEs</span>
04250     <span class="comment">// instead.</span>
04251     <span class="comment">//</span>
04252 
04253     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> &gt;= 64 * 1024) {
04254         EndAddress = (ULONG_PTR)StartAddress + <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> - 1;
04255         Vad = <a class="code" href="../../d6/d3/vadtree_8c.html#a2">MiLocateAddress</a> (StartAddress);
04256 
04257         <span class="keywordflow">if</span> (Vad == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04258             <span class="keywordflow">goto</span> Return1;
04259         }
04260 
04261         <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.UserPhysicalPages == 1) {
04262             <span class="keywordflow">goto</span> Return1;
04263         }
04264 
04265         <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.MemCommit == 0) {
04266             <span class="keywordflow">goto</span> LongWay;
04267         }
04268 
04269         <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.PrivateMemory == 0) {
04270             <span class="keywordflow">goto</span> LongWay;
04271         }
04272 
04273         <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.PhysicalMapping == 1) {
04274             <span class="keywordflow">goto</span> LongWay;
04275         }
04276 
04277         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.Protection);
04278 
04279         <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (StartAddress) &lt; Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a>) ||
04280             (<a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (EndAddress) &gt; Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a>)) {
04281             <span class="keywordflow">goto</span> Return1;
04282         }
04283 
04284         <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.Protection == <a class="code" href="../../d4/d8/mi_8h.html#a46">MM_NOACCESS</a>) {
04285             <span class="keywordflow">goto</span> LongWay;
04286         }
04287 
04288         <span class="keywordflow">if</span> (ProbeMode == PAGE_READONLY) {
04289             <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.Protection &gt; <a class="code" href="../../d4/d8/mi_8h.html#a42">MM_EXECUTE_WRITECOPY</a>) {
04290                 <span class="keywordflow">goto</span> LongWay;
04291             }
04292         }
04293         <span class="keywordflow">else</span> {
04294             <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.Protection != <a class="code" href="../../d4/d8/mi_8h.html#a39">MM_READWRITE</a> &amp;&amp;
04295                 Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.Protection != <a class="code" href="../../d4/d8/mi_8h.html#a41">MM_EXECUTE_READWRITE</a>) {
04296                     <span class="keywordflow">goto</span> LongWay;
04297             }
04298         }
04299 
04300         <span class="comment">//</span>
04301         <span class="comment">// Check individual page permissions.</span>
04302         <span class="comment">//</span>
04303 
04304         PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (StartAddress);
04305         PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
04306         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (StartAddress);
04307         LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (EndAddress);
04308 
04309         <a class="code" href="../../d4/d8/mi_8h.html#a155">LOCK_WS_UNSAFE</a> (Process);
04310 
04311         <span class="keywordflow">do</span> {
04312 
04313             <span class="keywordflow">while</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a168">MiDoesPpeExistAndMakeValid</a> (PointerPpe,
04314                                                Process,
04315                                                <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
04316                                                &amp;Waited) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
04317                 <span class="comment">//</span>
04318                 <span class="comment">// Page directory parent entry is empty, go to the next one.</span>
04319                 <span class="comment">//</span>
04320 
04321                 PointerPpe += 1;
04322                 PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPpe);
04323                 PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
04324                 <span class="keywordflow">if</span> (PointerPte &gt; LastPte) {
04325                     <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (Process);
04326                     <span class="keywordflow">goto</span> EditVad;
04327                 }
04328             }
04329 
04330             Waited = 0;
04331 
04332             <span class="keywordflow">while</span> (<a class="code" href="../../d0/d2/mmsup_8c.html#a6">MiDoesPdeExistAndMakeValid</a> (PointerPde,
04333                                                Process,
04334                                                <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
04335                                                &amp;Waited) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
04336                 <span class="comment">//</span>
04337                 <span class="comment">// This page directory entry is empty, go to the next one.</span>
04338                 <span class="comment">//</span>
04339 
04340                 PointerPde += 1;
04341                 PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
04342                 PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
04343                 <span class="keywordflow">if</span> (PointerPte &gt; LastPte) {
04344                     <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (Process);
04345                     <span class="keywordflow">goto</span> EditVad;
04346                 }
04347 <span class="preprocessor">#if defined (_WIN64)</span>
04348 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a> (PointerPde)) {
04349                     Waited = 1;
04350                     <span class="keywordflow">break</span>;
04351                 }
04352 <span class="preprocessor">#endif</span>
04353 <span class="preprocessor"></span>            }
04354 
04355         } <span class="keywordflow">while</span> (Waited != 0);
04356 
04357         <span class="keywordflow">while</span> (PointerPte &lt;= LastPte) {
04358 
04359             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a> (PointerPte)) {
04360 
04361                 PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPte);
04362                 PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
04363 
04364                 <span class="keywordflow">do</span> {
04365 
04366                     <span class="keywordflow">while</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a168">MiDoesPpeExistAndMakeValid</a> (PointerPpe,
04367                                                        Process,
04368                                                        <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
04369                                                        &amp;Waited) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
04370                         <span class="comment">//</span>
04371                         <span class="comment">// Page directory parent entry is empty, go to the next one.</span>
04372                         <span class="comment">//</span>
04373 
04374                         PointerPpe += 1;
04375                         PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPpe);
04376                         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
04377 
04378                         <span class="keywordflow">if</span> (PointerPte &gt; LastPte) {
04379                             <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (Process);
04380                             <span class="keywordflow">goto</span> EditVad;
04381                         }
04382                     }
04383 
04384                     Waited = 0;
04385 
04386                     <span class="keywordflow">while</span> (<a class="code" href="../../d0/d2/mmsup_8c.html#a6">MiDoesPdeExistAndMakeValid</a> (PointerPde,
04387                                                        Process,
04388                                                        <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
04389                                                        &amp;Waited) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
04390                         <span class="comment">//</span>
04391                         <span class="comment">// This page directory entry is empty, go to the next one.</span>
04392                         <span class="comment">//</span>
04393 
04394                         PointerPde += 1;
04395                         PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
04396                         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
04397                         <span class="keywordflow">if</span> (PointerPte &gt; LastPte) {
04398                             <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (Process);
04399                             <span class="keywordflow">goto</span> EditVad;
04400                         }
04401 <span class="preprocessor">#if defined (_WIN64)</span>
04402 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a> (PointerPde)) {
04403                             Waited = 1;
04404                             <span class="keywordflow">break</span>;
04405                         }
04406 <span class="preprocessor">#endif</span>
04407 <span class="preprocessor"></span>                    }
04408 
04409                 } <span class="keywordflow">while</span> (Waited != 0);
04410             }
04411             <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long) {
04412                 <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (Process);
04413                 <span class="keywordflow">goto</span> LongWay;
04414             }
04415             PointerPte += 1;
04416         }
04417         <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (Process);
04418     }
04419     <span class="keywordflow">else</span> {
04420 LongWay:
04421 
04422         <a class="code" href="../../d4/d8/mi_8h.html#a775">MiInsertConflictInList</a> (&amp;Conflict);
04423 
04424         <span class="keywordflow">try</span> {
04425 
04426             <span class="keywordflow">if</span> (ProbeMode == PAGE_READONLY) {
04427 
04428                 EndAddress = (ULONG_PTR)Address + <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> - 1;
04429                 EndAddress = (EndAddress &amp; ~(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1)) + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
04430 
04431                 <span class="keywordflow">do</span> {
04432                     Temp = *(<span class="keyword">volatile</span> <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> *)Address;
04433                     Address = (PVOID)(((ULONG_PTR)Address &amp; ~(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1)) + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
04434                 } <span class="keywordflow">while</span> ((ULONG_PTR)Address != EndAddress);
04435             } <span class="keywordflow">else</span> {
04436                 <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a> (Address, (ULONG)<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>, 1); <span class="comment">// ****** temp ******</span>
04437             }
04438 
04439         } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
04440             <a class="code" href="../../d4/d8/mi_8h.html#a774">MiRemoveConflictFromList</a> (&amp;Conflict);
04441             <span class="keywordflow">goto</span> Return1;
04442         }
04443 
04444         <a class="code" href="../../d4/d8/mi_8h.html#a774">MiRemoveConflictFromList</a> (&amp;Conflict);
04445 
04446         <span class="comment">//</span>
04447         <span class="comment">// Locate VAD and add in secure descriptor.</span>
04448         <span class="comment">//</span>
04449 
04450         EndAddress = (ULONG_PTR)StartAddress + <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> - 1;
04451         Vad = <a class="code" href="../../d6/d3/vadtree_8c.html#a2">MiLocateAddress</a> (StartAddress);
04452 
04453         <span class="keywordflow">if</span> (Vad == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04454             <span class="keywordflow">goto</span> Return1;
04455         }
04456 
04457         <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.UserPhysicalPages == 1) {
04458             <span class="keywordflow">goto</span> Return1;
04459         }
04460 
04461         <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (StartAddress) &lt; Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a>) ||
04462             (<a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (EndAddress) &gt; Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a>)) {
04463 
04464             <span class="comment">//</span>
04465             <span class="comment">// Not within the section virtual address descriptor,</span>
04466             <span class="comment">// return an error.</span>
04467             <span class="comment">//</span>
04468 
04469             <span class="keywordflow">goto</span> Return1;
04470         }
04471     }
04472 
04473 EditVad:
04474 
04475     <span class="comment">//</span>
04476     <span class="comment">// If this is a short VAD, it needs to be reallocated as a large</span>
04477     <span class="comment">// VAD.</span>
04478     <span class="comment">//</span>
04479 
04480     <span class="keywordflow">if</span> ((Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.PrivateMemory) &amp;&amp; (!Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.NoChange)) {
04481 
04482         NewVad = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
04483                                         <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d6/struct__MMVAD.html">MMVAD</a>),
04484                                         <a class="code" href="../../d3/d6/allocvm_8c.html#a0">MMVADKEY</a>);
04485         <span class="keywordflow">if</span> (NewVad == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04486             <span class="keywordflow">goto</span> Return1;
04487         }
04488 
04489         RtlZeroMemory (NewVad, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/mi_8h.html#a489">MMVAD</a>));
04490         RtlCopyMemory (NewVad, Vad, <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d7/struct__MMVAD__SHORT.html">MMVAD_SHORT</a>));
04491         NewVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.NoChange = 1;
04492         NewVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.OneSecured = 1;
04493         NewVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.StoredInVad = 1;
04494         NewVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.ReadOnly = Probe;
04495         NewVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o16">u3</a>.Secured.StartVpn = (ULONG_PTR)StartAddress;
04496         NewVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o16">u3</a>.Secured.EndVpn = EndAddress;
04497 
04498         <span class="comment">//</span>
04499         <span class="comment">// Replace the current VAD with this expanded VAD.</span>
04500         <span class="comment">//</span>
04501 
04502         <a class="code" href="../../d4/d8/mi_8h.html#a155">LOCK_WS_UNSAFE</a> (Process);
04503         <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o2">Parent</a>) {
04504             <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o2">Parent</a>-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o4">RightChild</a> == Vad) {
04505                 Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o2">Parent</a>-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o4">RightChild</a> = NewVad;
04506             } <span class="keywordflow">else</span> {
04507                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o2">Parent</a>-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o3">LeftChild</a> == Vad);
04508                 Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o2">Parent</a>-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o3">LeftChild</a> = NewVad;
04509             }
04510         } <span class="keywordflow">else</span> {
04511             Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o38">VadRoot</a> = NewVad;
04512         }
04513         <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o3">LeftChild</a>) {
04514             Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o3">LeftChild</a>-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o2">Parent</a> = NewVad;
04515         }
04516         <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o4">RightChild</a>) {
04517             Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o4">RightChild</a>-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o2">Parent</a> = NewVad;
04518         }
04519         <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o39">VadHint</a> == Vad) {
04520             Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o39">VadHint</a> = NewVad;
04521         }
04522         <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o57">VadFreeHint</a> == Vad) {
04523             Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o57">VadFreeHint</a> = NewVad;
04524         }
04525 
04526         <span class="keywordflow">if</span> ((Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.PhysicalMapping == 1) ||
04527             (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.WriteWatch == 1)) {
04528 
04529             <a class="code" href="../../d4/d8/mi_8h.html#a894">MiPhysicalViewAdjuster</a> (Process, Vad, NewVad);
04530         }
04531 
04532         <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (Process);
04533         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Vad);
04534         <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = (HANDLE)&amp;NewVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.LongFlags2;
04535         <span class="keywordflow">goto</span> Return1;
04536     }
04537 
04538     <span class="comment">//</span>
04539     <span class="comment">// This is already a large VAD, add the secure entry.</span>
04540     <span class="comment">//</span>
04541 
04542     <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.OneSecured) {
04543 
04544         <span class="comment">//</span>
04545         <span class="comment">// This VAD already is secured.  Move the info out of the</span>
04546         <span class="comment">// block into pool.</span>
04547         <span class="comment">//</span>
04548 
04549         Secure = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
04550                                         <span class="keyword">sizeof</span> (<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html">MMSECURE_ENTRY</a>),
04551                                         'eSmM');
04552         <span class="keywordflow">if</span> (Secure == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04553             <span class="keywordflow">goto</span> Return1;
04554         }
04555 
04556         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.NoChange == 1);
04557         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.OneSecured = 0;
04558         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.MultipleSecured = 1;
04559         Secure-&gt;<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o2">u2</a>.LongFlags2 = (ULONG) Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.LongFlags;
04560         Secure-&gt;<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o2">u2</a>.VadFlags2.StoredInVad = 0;
04561         Secure-&gt;<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o3">StartVpn</a> = Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o16">u3</a>.Secured.StartVpn;
04562         Secure-&gt;<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o4">EndVpn</a> = Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o16">u3</a>.Secured.EndVpn;
04563 
04564         InitializeListHead (&amp;Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o16">u3</a>.List);
04565         InsertTailList (&amp;Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o16">u3</a>.List,
04566                         &amp;Secure-&gt;<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o5">List</a>);
04567     }
04568 
04569     <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.MultipleSecured) {
04570 
04571         <span class="comment">//</span>
04572         <span class="comment">// This VAD already has a secured element in its list, allocate and</span>
04573         <span class="comment">// add in the new secured element.</span>
04574         <span class="comment">//</span>
04575 
04576         Secure = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
04577                                         <span class="keyword">sizeof</span> (<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html">MMSECURE_ENTRY</a>),
04578                                         'eSmM');
04579         <span class="keywordflow">if</span> (Secure == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04580             <span class="keywordflow">goto</span> Return1;
04581         }
04582 
04583         Secure-&gt;<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o2">u2</a>.LongFlags2 = 0;
04584         Secure-&gt;<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o2">u2</a>.VadFlags2.ReadOnly = Probe;
04585         Secure-&gt;<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o3">StartVpn</a> = (ULONG_PTR)StartAddress;
04586         Secure-&gt;<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o4">EndVpn</a> = EndAddress;
04587 
04588         InsertTailList (&amp;Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o16">u3</a>.List,
04589                         &amp;Secure-&gt;<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o5">List</a>);
04590         <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = (HANDLE)Secure;
04591 
04592     } <span class="keywordflow">else</span> {
04593 
04594         <span class="comment">//</span>
04595         <span class="comment">// This list does not have a secure element.  Put it in the VAD.</span>
04596         <span class="comment">//</span>
04597 
04598         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.NoChange = 1;
04599         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.OneSecured = 1;
04600         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.StoredInVad = 1;
04601         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.ReadOnly = Probe;
04602         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o16">u3</a>.Secured.StartVpn = (ULONG_PTR)StartAddress;
04603         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o16">u3</a>.Secured.EndVpn = EndAddress;
04604         <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = (HANDLE)&amp;Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.LongFlags2;
04605     }
04606 
04607 Return1:
04608     <a class="code" href="../../d4/d8/mi_8h.html#a163">UNLOCK_ADDRESS_SPACE</a> (Process);
04609     <span class="keywordflow">return</span> <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
04610 }
04611 
04612 
04613 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04614"></a><a class="code" href="../../d3/d5/mapview_8c.html#a34">04614</a> <a class="code" href="../../d3/d5/mapview_8c.html#a34">MmUnsecureVirtualMemory</a> (
04615     IN HANDLE SecureHandle
04616     )
04617 
04618 <span class="comment">/*++</span>
04619 <span class="comment"></span>
04620 <span class="comment">Routine Description:</span>
04621 <span class="comment"></span>
04622 <span class="comment">    This routine unsecures memory previous secured via a call to</span>
04623 <span class="comment">    MmSecureVirtualMemory.</span>
04624 <span class="comment"></span>
04625 <span class="comment">Arguments:</span>
04626 <span class="comment"></span>
04627 <span class="comment">    SecureHandle - Supplies the handle returned in MmSecureVirtualMemory.</span>
04628 <span class="comment"></span>
04629 <span class="comment">Return Value:</span>
04630 <span class="comment"></span>
04631 <span class="comment">    None.</span>
04632 <span class="comment"></span>
04633 <span class="comment">Environment:</span>
04634 <span class="comment"></span>
04635 <span class="comment">    Kernel Mode.</span>
04636 <span class="comment"></span>
04637 <span class="comment">--*/</span>
04638 
04639 {
04640     <a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html">PMMSECURE_ENTRY</a> Secure;
04641     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
04642     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Vad;
04643 
04644     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04645 
04646     Secure = (<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html">PMMSECURE_ENTRY</a>)SecureHandle;
04647     Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a> ();
04648     <a class="code" href="../../d4/d8/mi_8h.html#a160">LOCK_ADDRESS_SPACE</a> (Process);
04649 
04650     <span class="keywordflow">if</span> (Secure-&gt;<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o2">u2</a>.VadFlags2.StoredInVad) {
04651         Vad = CONTAINING_RECORD( Secure,
04652                                  <a class="code" href="../../d6/d6/struct__MMVAD.html">MMVAD</a>,
04653                                  u2.<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o0">LongFlags2</a>);
04654     } <span class="keywordflow">else</span> {
04655         Vad = <a class="code" href="../../d6/d3/vadtree_8c.html#a2">MiLocateAddress</a> ((PVOID)Secure-&gt;<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o3">StartVpn</a>);
04656     }
04657 
04658     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Vad);
04659     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.NoChange == 1);
04660 
04661     <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.OneSecured) {
04662         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Secure == (<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html">PMMSECURE_ENTRY</a>)&amp;Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.LongFlags2);
04663         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.OneSecured = 0;
04664         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.MultipleSecured == 0);
04665         <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.SecNoChange == 0) {
04666 
04667             <span class="comment">//</span>
04668             <span class="comment">// No more secure entries in this list, remove the state.</span>
04669             <span class="comment">//</span>
04670 
04671             Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.NoChange = 0;
04672         }
04673     } <span class="keywordflow">else</span> {
04674         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.MultipleSecured == 1);
04675 
04676         <span class="keywordflow">if</span> (Secure == (<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html">PMMSECURE_ENTRY</a>)&amp;Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.LongFlags2) {
04677 
04678             <span class="comment">//</span>
04679             <span class="comment">// This was a single block that got converted into a list.</span>
04680             <span class="comment">// Reset the entry.</span>
04681             <span class="comment">//</span>
04682 
04683             Secure = CONTAINING_RECORD (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o16">u3</a>.List.Flink,
04684                                         <a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html">MMSECURE_ENTRY</a>,
04685                                         <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>);
04686         }
04687         RemoveEntryList (&amp;Secure-&gt;<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o5">List</a>);
04688         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Secure);
04689         <span class="keywordflow">if</span> (IsListEmpty (&amp;Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o16">u3</a>.List)) {
04690 
04691             <span class="comment">//</span>
04692             <span class="comment">// No more secure entries, reset the state.</span>
04693             <span class="comment">//</span>
04694 
04695             Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.MultipleSecured = 0;
04696 
04697             <span class="keywordflow">if</span> ((Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.SecNoChange == 0) &amp;&amp;
04698                (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.PrivateMemory == 0)) {
04699 
04700                 <span class="comment">//</span>
04701                 <span class="comment">// No more secure entries in this list, remove the state</span>
04702                 <span class="comment">// if and only if this VAD is not private.  If this VAD</span>
04703                 <span class="comment">// is private, removing the state NoChange flag indicates</span>
04704                 <span class="comment">// that this is a short VAD which it no longer is.</span>
04705                 <span class="comment">//</span>
04706 
04707                 Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.NoChange = 0;
04708             }
04709         }
04710     }
04711 
04712     <a class="code" href="../../d4/d8/mi_8h.html#a163">UNLOCK_ADDRESS_SPACE</a> (Process);
04713     <span class="keywordflow">return</span>;
04714 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:42 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
