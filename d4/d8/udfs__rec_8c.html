<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: udfs_rec.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>udfs_rec.c File Reference</h1><code>#include "<a class="el" href="../../d8/d6/fs__rec_8h-source.html">fs_rec.h</a>"</code><br>
<code>#include "<a class="el" href="../../d6/d7/udfs__rec_8h-source.html">udfs_rec.h</a>"</code><br>

<p>
<a href="../../d5/d7/udfs__rec_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d8/udfs__rec_8c.html#a0">Dbg</a>&nbsp;&nbsp;&nbsp;(FSREC_DEBUG_LEVEL_UDFS)</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d8/udfs__rec_8c.html#a2">UdfsRecFsControl</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d8/udfs__rec_8c.html#a3">IsUdfsVolume</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN ULONG SectorSize)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d8/udfs__rec_8c.html#a4">UdfsFindInParseTable</a> (IN <a class="el" href="../../d2/d8/struct__PARSE__KEYVALUE.html">PPARSE_KEYVALUE</a> ParseTable, IN PCHAR Id, IN ULONG MaxIdLen)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d2/d8/struct__PARSE__KEYVALUE.html">PARSE_KEYVALUE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d8/udfs__rec_8c.html#a1">VsdIdentParseTable</a> []</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="udfs_rec.c::Dbg" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define Dbg&nbsp;&nbsp;&nbsp;(FSREC_DEBUG_LEVEL_UDFS)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/udfs__rec_8c-source.html#l00033">33</a> of file <a class="el" href="../../d5/d7/udfs__rec_8c-source.html">udfs_rec.c</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a3" doxytag="udfs_rec.c::IsUdfsVolume" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IsUdfsVolume           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SectorSize</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/udfs__rec_8c-source.html#l00157">157</a> of file <a class="el" href="../../d5/d7/udfs__rec_8c-source.html">udfs_rec.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00907">FsRecReadBlock()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00033">Offset</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/udfs__rec_8h.html#a13">PVSD_GENERIC</a>, <a class="el" href="../../d6/d7/udfs__rec_8h-source.html#l00110">SectorAlignN</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00230">SectorSize</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d7/udfs__rec_8c-source.html#l00392">UdfsFindInParseTable()</a>, <a class="el" href="../../d6/d7/udfs__rec_8h-source.html#l00036">VRA_BOUNDARY_LOCATION</a>, <a class="el" href="../../d5/d8/udfs__rec_8h.html#a12">VSD_GENERIC</a>, <a class="el" href="../../d6/d7/udfs__rec_8h-source.html#l00057">VSD_LENGTH_IDENT</a>, <a class="el" href="../../d5/d8/udfs__rec_8h.html#a30a19">VsdIdentBEA01</a>, <a class="el" href="../../d5/d8/udfs__rec_8h.html#a30a27">VsdIdentBOOT2</a>, <a class="el" href="../../d5/d8/udfs__rec_8h.html#a30a22">VsdIdentCD001</a>, <a class="el" href="../../d5/d8/udfs__rec_8h.html#a30a21">VsdIdentCDROM</a>, <a class="el" href="../../d5/d8/udfs__rec_8h.html#a30a23">VsdIdentCDW01</a>, <a class="el" href="../../d5/d8/udfs__rec_8h.html#a30a24">VsdIdentCDW02</a>, <a class="el" href="../../d5/d8/udfs__rec_8h.html#a30a25">VsdIdentNSR01</a>, <a class="el" href="../../d5/d8/udfs__rec_8h.html#a30a26">VsdIdentNSR02</a>, <a class="el" href="../../d5/d7/udfs__rec_8c-source.html#l00039">VsdIdentParseTable</a>, and <a class="el" href="../../d5/d8/udfs__rec_8h.html#a30a20">VsdIdentTEA01</a>.
<p>
Referenced by <a class="el" href="../../d5/d7/udfs__rec_8c-source.html#l00060">UdfsRecFsControl()</a>.
<p>
<pre class="fragment"><div>00164                    :
00165 
00166     This routine walks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Volume Recognition Sequence to determine
00167     whether <span class="keyword">this</span> volume contains an NSR02 (ISO 13346 Section 4) image.
00168     
00169     Note: <span class="keyword">this</span> routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> pretty much diked <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> of UdfsRecognizeVolume
00170     in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> real filesystem, modulo fitting <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> fs recognizer.
00171 
00172 Arguments:
00173 
00174     DeviceObject - device we are checking
00175 
00176     <a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a> - size of a physical sector on <span class="keyword">this</span> device
00177 
00178 Return Value:
00179 
00180     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a21">Boolean</a> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> we found NSR02, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
00181 
00182 --*/
00183 
00184 {
00185     BOOLEAN FoundNSR = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00186 
00187     BOOLEAN FoundBEA = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00188     BOOLEAN Resolved = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00189 
00190     <a class="code" href="../../d4/d2/structVSD__GENERIC.html">PVSD_GENERIC</a> VolumeStructureDescriptor = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00191     ULONGLONG <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = <a class="code" href="../../d5/d8/udfs__rec_8h.html#a11">SectorAlignN</a>( SectorSize, VRA_BOUNDARY_LOCATION );
00192 
00193     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00194 
00195     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( +1, Dbg,
00196                  <span class="stringliteral">"IsUdfsVolume, DevObj %08x SectorSize %08x\n"</span>,
00197                  DeviceObject,
00198                  SectorSize ));
00199 
00200     <span class="keywordflow">while</span> (!Resolved) {
00201     
00202         <span class="keywordflow">if</span> (!<a class="code" href="../../d7/d7/fs__rec_8h.html#a32">FsRecReadBlock</a>( DeviceObject,
00203                              (PLARGE_INTEGER)&amp;Offset,
00204                              <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d2/structVSD__GENERIC.html">VSD_GENERIC</a>),
00205                              SectorSize,
00206                              (PVOID) &amp;VolumeStructureDescriptor,
00207                              NULL )) {
00208 
00209             <span class="keywordflow">break</span>;
00210         }
00211     
00212         <span class="comment">//</span>
00213         <span class="comment">//  Now check the type of the descriptor. All ISO 13346 VSDs are</span>
00214         <span class="comment">//  of Type 0, 9660 PVDs are Type 1, 9660 SVDs are Type 2, and 9660</span>
00215         <span class="comment">//  terminating descriptors are Type 255.</span>
00216         <span class="comment">//</span>
00217     
00218         <span class="keywordflow">if</span> (VolumeStructureDescriptor-&gt;<a class="code" href="../../d4/d2/structVSD__GENERIC.html#o0">Type</a> == 0) {
00219 
00220             <span class="comment">//</span>
00221             <span class="comment">//  In order to properly recognize the volume, we must know all of the</span>
00222             <span class="comment">//  Structure identifiers in ISO 13346 so that we can terminate if a</span>
00223             <span class="comment">//  badly formatted (or, shockingly, non 13346) volume is presented to us.</span>
00224             <span class="comment">//</span>
00225 
00226             <span class="keywordflow">switch</span> (<a class="code" href="../../d5/d8/udfs__rec_8h.html#a29">UdfsFindInParseTable</a>( VsdIdentParseTable,
00227                                          VolumeStructureDescriptor-&gt;<a class="code" href="../../d4/d2/structVSD__GENERIC.html#o1">Ident</a>,
00228                                          VSD_LENGTH_IDENT )) {
00229                 <span class="keywordflow">case</span> <a class="code" href="../../d5/d8/udfs__rec_8h.html#a30a19">VsdIdentBEA01</a>:
00230 
00231                     <span class="comment">//</span>
00232                     <span class="comment">//  Only one BEA may exist and its version must be 1 (2/9.2.3)</span>
00233                     <span class="comment">//</span>
00234 
00235                     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg, <span class="stringliteral">"IsUdfsVolume, got a BEA01\n"</span> ));
00236 
00237 
00238                     <span class="keywordflow">if</span> ((FoundBEA &amp;&amp;
00239                          <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg,
00240                                       <span class="stringliteral">"IsUdfsVolume, ... but it is a duplicate!\n"</span> ))) ||
00241 
00242                         (VolumeStructureDescriptor-&gt;<a class="code" href="../../d4/d2/structVSD__GENERIC.html#o2">Version</a> != 1 &amp;&amp;
00243                          <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg,
00244                                       <span class="stringliteral">"IsUdfsVolume, ... but it has a wacky version number %02x != 1!\n"</span>,
00245                                       VolumeStructureDescriptor-&gt;<a class="code" href="../../d4/d2/structVSD__GENERIC.html#o2">Version</a> )))) {
00246 
00247                         Resolved = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00248                         <span class="keywordflow">break</span>;
00249                     }
00250 
00251                     FoundBEA = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00252                     <span class="keywordflow">break</span>;
00253 
00254                 <span class="keywordflow">case</span> <a class="code" href="../../d5/d8/udfs__rec_8h.html#a30a20">VsdIdentTEA01</a>:
00255 
00256                     <span class="comment">//</span>
00257                     <span class="comment">//  If we reach the TEA it must be the case that we don't recognize</span>
00258                     <span class="comment">//</span>
00259 
00260                     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg, <span class="stringliteral">"IsUdfsVolume, got a TEA01\n"</span> ));
00261 
00262                     Resolved = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00263                     <span class="keywordflow">break</span>;
00264 
00265                 <span class="keywordflow">case</span> <a class="code" href="../../d5/d8/udfs__rec_8h.html#a30a26">VsdIdentNSR02</a>:
00266 
00267                     <span class="comment">//</span>
00268                     <span class="comment">//  We recognize NSR02 version 1 embedded after a BEA (3/9.1.3).  For</span>
00269                     <span class="comment">//  simplicity we will not bother being a complete nitpick and check</span>
00270                     <span class="comment">//  for a bounding TEA, although we will be optimistic in the case where</span>
00271                     <span class="comment">//  we fail to match the version.</span>
00272                     <span class="comment">//</span>
00273 
00274                     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg, <span class="stringliteral">"IsUdfsVolume, got an NSR02\n"</span> ));
00275 
00276                     <span class="keywordflow">if</span> ((FoundBEA ||
00277                          !<a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg, <span class="stringliteral">"IsUdfsVolume, ... but we haven't seen a BEA01 yet!\n"</span> ))) &amp;&amp;
00278 
00279                         (VolumeStructureDescriptor-&gt;<a class="code" href="../../d4/d2/structVSD__GENERIC.html#o2">Version</a> == 1 ||
00280                          !<a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg, <span class="stringliteral">"IsUdfsVolume, ... but it has a wacky version number %02x != 1\n"</span>,
00281                                        VolumeStructureDescriptor-&gt;<a class="code" href="../../d4/d2/structVSD__GENERIC.html#o2">Version</a> )))) {
00282 
00283                         FoundNSR = Resolved = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00284                         <span class="keywordflow">break</span>;
00285                     }
00286 
00287                     <span class="keywordflow">break</span>;
00288 
00289                 <span class="keywordflow">case</span> <a class="code" href="../../d5/d8/udfs__rec_8h.html#a30a22">VsdIdentCD001</a>:
00290                 <span class="keywordflow">case</span> <a class="code" href="../../d5/d8/udfs__rec_8h.html#a30a23">VsdIdentCDW01</a>:
00291                 <span class="keywordflow">case</span> <a class="code" href="../../d5/d8/udfs__rec_8h.html#a30a25">VsdIdentNSR01</a>:
00292                 <span class="keywordflow">case</span> <a class="code" href="../../d5/d8/udfs__rec_8h.html#a30a24">VsdIdentCDW02</a>:
00293                 <span class="keywordflow">case</span> <a class="code" href="../../d5/d8/udfs__rec_8h.html#a30a27">VsdIdentBOOT2</a>:
00294 
00295                     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg, <span class="stringliteral">"IsUdfsVolume, got a valid but uninteresting 13346 descriptor\n"</span> ));
00296 
00297                     <span class="comment">//</span>
00298                     <span class="comment">//  Valid but uninteresting (to us) descriptors</span>
00299                     <span class="comment">//</span>
00300 
00301                     <span class="keywordflow">break</span>;
00302 
00303                 <span class="keywordflow">default</span>:
00304 
00305                     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg, <span class="stringliteral">"IsUdfsVolume, got an invalid 13346 descriptor\n"</span> ));
00306 
00307                     <span class="comment">//</span>
00308                     <span class="comment">//  Stumbling across something we don't know, it must be that this</span>
00309                     <span class="comment">//  is not a valid 13346 image</span>
00310                     <span class="comment">//</span>
00311 
00312                     Resolved = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00313                     <span class="keywordflow">break</span>;
00314 
00315             }
00316 
00317         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!FoundBEA &amp;&amp; (VolumeStructureDescriptor-&gt;<a class="code" href="../../d4/d2/structVSD__GENERIC.html#o0">Type</a> &lt; 3 ||
00318                                  VolumeStructureDescriptor-&gt;<a class="code" href="../../d4/d2/structVSD__GENERIC.html#o0">Type</a> == 255)) {
00319 
00320             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg, <span class="stringliteral">"IsUdfsVolume, got a 9660 descriptor\n"</span> ));
00321 
00322             <span class="comment">//</span>
00323             <span class="comment">//  Only HSG (CDROM) and 9660 (CD001) are possible, and they are only legal</span>
00324             <span class="comment">//  before the ISO 13346 BEA/TEA extent.  By design, an ISO 13346 VSD precisely</span>
00325             <span class="comment">//  overlaps a 9660 PVD/SVD in the appropriate fields.</span>
00326             <span class="comment">//</span>
00327             <span class="comment">//  Note that we aren't being strict about the structure of the 9660 descriptors</span>
00328             <span class="comment">//  since that really isn't very interesting.  We care more about the 13346.</span>
00329             <span class="comment">//  </span>
00330             <span class="comment">//</span>
00331 
00332             <span class="keywordflow">switch</span> (<a class="code" href="../../d5/d8/udfs__rec_8h.html#a29">UdfsFindInParseTable</a>( VsdIdentParseTable,
00333                                           VolumeStructureDescriptor-&gt;<a class="code" href="../../d4/d2/structVSD__GENERIC.html#o1">Ident</a>,
00334                                           VSD_LENGTH_IDENT )) {
00335                 <span class="keywordflow">case</span> <a class="code" href="../../d5/d8/udfs__rec_8h.html#a30a21">VsdIdentCDROM</a>:
00336                 <span class="keywordflow">case</span> <a class="code" href="../../d5/d8/udfs__rec_8h.html#a30a22">VsdIdentCD001</a>:
00337 
00338                     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg, <span class="stringliteral">"IsUdfsVolume, ... seems we have 9660 here\n"</span> ));
00339 
00340                     <span class="comment">//</span>
00341                     <span class="comment">//  Note to our caller that we seem to have ISO 9660 here</span>
00342                     <span class="comment">//</span>
00343 
00344                     <span class="keywordflow">break</span>;
00345 
00346                 <span class="keywordflow">default</span>:
00347 
00348                     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg, <span class="stringliteral">"IsUdfsVolume, ... but it looks wacky\n"</span> ));
00349 
00350                     <span class="comment">//</span>
00351                     <span class="comment">//  This probably was a false alert, but in any case there is nothing</span>
00352                     <span class="comment">//  on this volume for us.</span>
00353                     <span class="comment">//</span>
00354 
00355                     Resolved = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00356                     <span class="keywordflow">break</span>;
00357             }
00358 
00359         } <span class="keywordflow">else</span> {
00360 
00361             <span class="comment">//</span>
00362             <span class="comment">//  Something else must be recorded on this volume.</span>
00363             <span class="comment">//</span>
00364 
00365             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg, <span class="stringliteral">"IsUdfsVolume, got an unrecognizeable descriptor, probably not 13346/9660\n"</span> ));
00366             <span class="keywordflow">break</span>;
00367         }
00368 
00369         <span class="comment">//</span>
00370         <span class="comment">//  Align our next read with the sector following the current descriptor</span>
00371         <span class="comment">//</span>
00372 
00373         <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> += <a class="code" href="../../d5/d8/udfs__rec_8h.html#a11">SectorAlignN</a>( SectorSize, <span class="keyword">sizeof</span>(VSD_GENERIC) );
00374     }
00375 
00376     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( -1, Dbg, <span class="stringliteral">"IsUdfsVolume -&gt; %c\n"</span>, ( FoundNSR ? <span class="charliteral">'T'</span> : <span class="charliteral">'F'</span> )));
00377 
00378     <span class="comment">//</span>
00379     <span class="comment">//  Free up our temporary buffer</span>
00380     <span class="comment">//</span>
00381 
00382     <span class="keywordflow">if</span> (VolumeStructureDescriptor) {
00383     
00384         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( VolumeStructureDescriptor );
00385     }
00386 
00387     <span class="keywordflow">return</span> FoundNSR;
00388 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="udfs_rec.c::UdfsFindInParseTable" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG UdfsFindInParseTable           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d8/struct__PARSE__KEYVALUE.html">PPARSE_KEYVALUE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ParseTable</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>Id</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>MaxIdLen</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/udfs__rec_8c-source.html#l00392">392</a> of file <a class="el" href="../../d5/d7/udfs__rec_8c-source.html">udfs_rec.c</a>.
<p>
References <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d5/d7/udfs__rec_8c-source.html#l00157">IsUdfsVolume()</a>.
<p>
<pre class="fragment"><div>00400                    :
00401 
00402     This routine walks a table of string key/value information <span class="keywordflow">for</span> a match of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00403     input Id.  MaxIdLen can be set to get a prefix match.
00404 
00405 Arguments:
00406 
00407     Table - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> table being searched.
00408 
00409     Id - <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> value.
00410 
00411     MaxIdLen - Maximum possible length of Id.
00412 
00413 Return Value:
00414 
00415     Value of <a class="code" href="../../d7/d1/genuedef_8c.html#a7">matching</a> entry, or <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> terminating (NULL) entry's value.
00416 
00417 --*/
00418 
00419 {
00420     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00421 
00422     <span class="keywordflow">while</span> (ParseTable-&gt;Key != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00423 
00424         <span class="keywordflow">if</span> (RtlEqualMemory(ParseTable-&gt;Key, Id, MaxIdLen)) {
00425 
00426             <span class="keywordflow">break</span>;
00427         }
00428 
00429         ParseTable++;
00430     }
00431 
00432     <span class="keywordflow">return</span> ParseTable-&gt;Value;
00433 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="udfs_rec.c::UdfsRecFsControl" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS UdfsRecFsControl           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/udfs__rec_8c-source.html#l00060">60</a> of file <a class="el" href="../../d5/d7/udfs__rec_8c-source.html">udfs_rec.c</a>.
<p>
References <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00800">FsRecGetDeviceSectorSize()</a>, <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00579">FsRecLoadFileSystem()</a>, <a class="el" href="../../d8/d7/exboosts_8h-source.html#l00056">IO_NO_INCREMENT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02960">IoCompleteRequest</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00115">IRP_MN_LOAD_FILE_SYSTEM</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00113">IRP_MN_MOUNT_VOLUME</a>, <a class="el" href="../../d5/d7/udfs__rec_8c-source.html#l00157">IsUdfsVolume()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>.
<p>
Referenced by <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00446">FsRecFsControl()</a>.
<p>
<pre class="fragment"><div>00067                    :
00068 
00069     This function performs <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mount and driver reload <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a16">functions</a> <span class="keywordflow">for</span> <span class="keyword">this</span> mini-
00070     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system recognizer driver.
00071 
00072 Arguments:
00073 
00074     DeviceObject - Pointer to <span class="keyword">this</span> driver's device object.
00075 
00076     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a24">Request</a> Packet (<a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>) representing the function to
00077         be performed.
00078 
00079 Return Value:
00080 
00081     The function value is the final status of the operation.
00082 
00083 
00084  -*/
00085 
00086 {
00087     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00088     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
00089     <a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html">PDEVICE_EXTENSION</a> deviceExtension;
00090     UNICODE_STRING driverName;
00091     ULONG bytesPerSector;
00092     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> targetDevice;
00093 
00094     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00095 
00096     <span class="comment">//</span>
00097     <span class="comment">// Begin by determining what function that is to be performed.</span>
00098     <span class="comment">//</span>
00099 
00100     deviceExtension = (<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html">PDEVICE_EXTENSION</a>) DeviceObject-&gt;DeviceExtension;
00101     irpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp );
00102 
00103     <span class="keywordflow">switch</span> ( irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> ) {
00104 
00105     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a47">IRP_MN_MOUNT_VOLUME</a>:
00106 
00107         <span class="comment">//</span>
00108         <span class="comment">// Attempt to mount a volume:  There are two different cases here:</span>
00109         <span class="comment">//</span>
00110         <span class="comment">//     1)  The device is being opened for DASD access, that is, no</span>
00111         <span class="comment">//         file system is required, thus it is OK to allow RAW to</span>
00112         <span class="comment">//         to open it.</span>
00113         <span class="comment">//</span>
00114         <span class="comment">//     2)  We need to rummage the media to see if this is a UDF volume.</span>
00115         <span class="comment">//</span>
00116 
00117         status = STATUS_UNRECOGNIZED_VOLUME;
00118 
00119         targetDevice = irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.MountVolume.DeviceObject;
00120 
00121         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d7/fs__rec_8h.html#a30">FsRecGetDeviceSectorSize</a>( targetDevice,
00122                                       &amp;bytesPerSector )) {
00123         
00124             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d8/udfs__rec_8h.html#a28">IsUdfsVolume</a>( targetDevice,
00125                               bytesPerSector )) {
00126 
00127                 status = STATUS_FS_DRIVER_REQUIRED;
00128             }
00129         }
00130 
00131         <span class="keywordflow">break</span>;
00132 
00133     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a49">IRP_MN_LOAD_FILE_SYSTEM</a>:
00134 
00135         status = <a class="code" href="../../d7/d7/fs__rec_8h.html#a29">FsRecLoadFileSystem</a>( DeviceObject,
00136                                       L<span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Services\\Udfs"</span> );
00137         <span class="keywordflow">break</span>;
00138 
00139     <span class="keywordflow">default</span>:
00140         status = STATUS_INVALID_DEVICE_REQUEST;
00141 
00142     }
00143 
00144     <span class="comment">//</span>
00145     <span class="comment">// Finally, complete the request and return the same status code to the</span>
00146     <span class="comment">// caller.</span>
00147     <span class="comment">//</span>
00148 
00149     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = status;
00150     <a class="code" href="../../d0/d5/io_8h.html#a224">IoCompleteRequest</a>( Irp, IO_NO_INCREMENT );
00151 
00152     <span class="keywordflow">return</span> status;
00153 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a1" doxytag="udfs_rec.c::VsdIdentParseTable" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d2/d8/struct__PARSE__KEYVALUE.html">PARSE_KEYVALUE</a> <a class="el" href="../../d1/d8/udfdata_8h.html#a63">VsdIdentParseTable</a>[]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Initial value:</b><pre class="fragment"><div> {
    { <a class="code" href="../../d5/d8/udfs__rec_8h.html#a2">VSD_IDENT_BEA01</a>, <a class="code" href="../../d5/d8/udfs__rec_8h.html#a30a19">VsdIdentBEA01</a> },
    { <a class="code" href="../../d5/d8/udfs__rec_8h.html#a3">VSD_IDENT_TEA01</a>, <a class="code" href="../../d5/d8/udfs__rec_8h.html#a30a20">VsdIdentTEA01</a> },
    { <a class="code" href="../../d5/d8/udfs__rec_8h.html#a4">VSD_IDENT_CDROM</a>, <a class="code" href="../../d5/d8/udfs__rec_8h.html#a30a21">VsdIdentCDROM</a> },
    { <a class="code" href="../../d5/d8/udfs__rec_8h.html#a5">VSD_IDENT_CD001</a>, <a class="code" href="../../d5/d8/udfs__rec_8h.html#a30a22">VsdIdentCD001</a> },
    { <a class="code" href="../../d5/d8/udfs__rec_8h.html#a6">VSD_IDENT_CDW01</a>, <a class="code" href="../../d5/d8/udfs__rec_8h.html#a30a23">VsdIdentCDW01</a> },
    { <a class="code" href="../../d5/d8/udfs__rec_8h.html#a7">VSD_IDENT_CDW02</a>, <a class="code" href="../../d5/d8/udfs__rec_8h.html#a30a24">VsdIdentCDW02</a> },
    { <a class="code" href="../../d5/d8/udfs__rec_8h.html#a8">VSD_IDENT_NSR01</a>, <a class="code" href="../../d5/d8/udfs__rec_8h.html#a30a25">VsdIdentNSR01</a> },
    { <a class="code" href="../../d5/d8/udfs__rec_8h.html#a9">VSD_IDENT_NSR02</a>, <a class="code" href="../../d5/d8/udfs__rec_8h.html#a30a26">VsdIdentNSR02</a> },
    { <a class="code" href="../../d5/d8/udfs__rec_8h.html#a10">VSD_IDENT_BOOT2</a>, <a class="code" href="../../d5/d8/udfs__rec_8h.html#a30a27">VsdIdentBOOT2</a> },
    { <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,            <a class="code" href="../../d5/d8/udfs__rec_8h.html#a30a18">VsdIdentBad</a> }
    }
</div></pre>
<p>
Definition at line <a class="el" href="../../d5/d7/udfs__rec_8c-source.html#l00039">39</a> of file <a class="el" href="../../d5/d7/udfs__rec_8c-source.html">udfs_rec.c</a>.
<p>
Referenced by <a class="el" href="../../d5/d7/udfs__rec_8c-source.html#l00157">IsUdfsVolume()</a>, and <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l03457">UdfRecognizeVolume()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:51 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
