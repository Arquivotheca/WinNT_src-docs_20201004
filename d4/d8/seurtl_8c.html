<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: seurtl.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>seurtl.c File Reference</h1><code>#include &lt;<a class="el" href="../../d0/d8/ntos_8h-source.html">ntos.h</a>&gt;</code><br>
<code>#include &lt;nturtl.h&gt;</code><br>
<code>#include &lt;ntlsa.h&gt;</code><br>
<code>#include "seopaque.h"</code><br>
<code>#include "sertlp.h"</code><br>
<code>#include "<a class="el" href="../../d0/d2/ldrp_8h-source.html">ldrp.h</a>"</code><br>

<p>
<a href="../../d5/d7/seurtl_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d8/seurtl_8c.html#a0">RtlNewSecurityObjectEx</a> (IN PSECURITY_DESCRIPTOR ParentDescriptor OPTIONAL, IN PSECURITY_DESCRIPTOR CreatorDescriptor OPTIONAL, OUT PSECURITY_DESCRIPTOR *NewDescriptor, IN GUID *ObjectType OPTIONAL, IN BOOLEAN IsDirectoryObject, IN ULONG AutoInheritFlags, IN HANDLE <a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a> OPTIONAL, IN PGENERIC_MAPPING GenericMapping)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d8/seurtl_8c.html#a1">RtlNewSecurityObject</a> (IN PSECURITY_DESCRIPTOR ParentDescriptor OPTIONAL, IN PSECURITY_DESCRIPTOR CreatorDescriptor OPTIONAL, OUT PSECURITY_DESCRIPTOR *NewDescriptor, IN BOOLEAN IsDirectoryObject, IN HANDLE <a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a>, IN PGENERIC_MAPPING GenericMapping)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d8/seurtl_8c.html#a2">RtlSetSecurityObject</a> (IN SECURITY_INFORMATION SecurityInformation, IN PSECURITY_DESCRIPTOR ModificationDescriptor, IN OUT PSECURITY_DESCRIPTOR *ObjectsSecurityDescriptor, IN PGENERIC_MAPPING GenericMapping, IN HANDLE <a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a> OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d8/seurtl_8c.html#a3">RtlSetSecurityObjectEx</a> (IN SECURITY_INFORMATION SecurityInformation, IN PSECURITY_DESCRIPTOR ModificationDescriptor, IN OUT PSECURITY_DESCRIPTOR *ObjectsSecurityDescriptor, IN ULONG AutoInheritFlags, IN PGENERIC_MAPPING GenericMapping, IN HANDLE <a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a> OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d8/seurtl_8c.html#a4">RtlQuerySecurityObject</a> (IN PSECURITY_DESCRIPTOR ObjectDescriptor, IN SECURITY_INFORMATION SecurityInformation, OUT PSECURITY_DESCRIPTOR ResultantDescriptor, IN ULONG DescriptorLength, OUT PULONG ReturnLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d8/seurtl_8c.html#a5">RtlDeleteSecurityObject</a> (IN OUT PSECURITY_DESCRIPTOR *ObjectDescriptor)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d8/seurtl_8c.html#a6">RtlNewInstanceSecurityObject</a> (IN BOOLEAN ParentDescriptorChanged, IN BOOLEAN CreatorDescriptorChanged, IN PLUID OldClientTokenModifiedId, OUT PLUID NewClientTokenModifiedId, IN PSECURITY_DESCRIPTOR ParentDescriptor OPTIONAL, IN PSECURITY_DESCRIPTOR CreatorDescriptor OPTIONAL, OUT PSECURITY_DESCRIPTOR *NewDescriptor, IN BOOLEAN IsDirectoryObject, IN HANDLE <a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a>, IN PGENERIC_MAPPING GenericMapping)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d8/seurtl_8c.html#a7">RtlNewSecurityGrantedAccess</a> (IN ACCESS_MASK DesiredAccess, OUT PPRIVILEGE_SET Privileges, IN OUT PULONG Length, IN HANDLE <a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a> OPTIONAL, IN PGENERIC_MAPPING GenericMapping, OUT PACCESS_MASK RemainingDesiredAccess)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d8/seurtl_8c.html#a8">RtlCopySecurityDescriptor</a> (IN PSECURITY_DESCRIPTOR InputSecurityDescriptor, OUT PSECURITY_DESCRIPTOR *OutputSecurityDescriptor)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d8/seurtl_8c.html#a9">RtlpInitializeAllowedAce</a> (IN PACCESS_ALLOWED_ACE AllowedAce, IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> AceSize, IN UCHAR InheritFlags, IN UCHAR AceFlags, IN ACCESS_MASK Mask, IN PSID AllowedSid)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d8/seurtl_8c.html#a10">RtlpInitializeDeniedAce</a> (IN PACCESS_DENIED_ACE DeniedAce, IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> AceSize, IN UCHAR InheritFlags, IN UCHAR AceFlags, IN ACCESS_MASK Mask, IN PSID DeniedSid)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d8/seurtl_8c.html#a11">RtlpInitializeAuditAce</a> (IN PACCESS_ALLOWED_ACE AuditAce, IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> AceSize, IN UCHAR InheritFlags, IN UCHAR AceFlags, IN ACCESS_MASK Mask, IN PSID AuditSid)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d8/seurtl_8c.html#a12">RtlCreateAndSetSD</a> (IN PRTL_ACE_DATA AceData, IN ULONG AceCount, IN PSID OwnerSid OPTIONAL, IN PSID GroupSid OPTIONAL, OUT PSECURITY_DESCRIPTOR *NewDescriptor)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d8/seurtl_8c.html#a13">RtlCreateUserSecurityObject</a> (IN PRTL_ACE_DATA AceData, IN ULONG AceCount, IN PSID OwnerSid, IN PSID GroupSid, IN BOOLEAN IsDirectoryObject, IN PGENERIC_MAPPING GenericMapping, OUT PSECURITY_DESCRIPTOR *NewDescriptor)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d8/seurtl_8c.html#a14">RtlConvertToAutoInheritSecurityObject</a> (IN PSECURITY_DESCRIPTOR ParentDescriptor OPTIONAL, IN PSECURITY_DESCRIPTOR CurrentSecurityDescriptor, OUT PSECURITY_DESCRIPTOR *NewSecurityDescriptor, IN GUID *ObjectType OPTIONAL, IN BOOLEAN IsDirectoryObject, IN PGENERIC_MAPPING GenericMapping)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d8/seurtl_8c.html#a15">RtlDefaultNpAcl</a> (OUT PACL *pAcl)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a14" doxytag="seurtl.c::RtlConvertToAutoInheritSecurityObject" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlConvertToAutoInheritSecurityObject           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSECURITY_DESCRIPTOR ParentDescriptor&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>CurrentSecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PSECURITY_DESCRIPTOR *&nbsp;</td>
          <td class="mdname" nowrap> <em>NewSecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN GUID *ObjectType&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>IsDirectoryObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PGENERIC_MAPPING&nbsp;</td>
          <td class="mdname" nowrap> <em>GenericMapping</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/seurtl_8c-source.html#l01786">1786</a> of file <a class="el" href="../../d5/d7/seurtl_8c-source.html">seurtl.c</a>.
<p>
References <a class="el" href="../../d9/d5/sertl_8c-source.html#l06520">RtlpConvertToAutoInheritSecurityObject()</a>.
<p>
<pre class="fragment"><div>01796                    :
01797 
01798     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a converts a security descriptor whose ACLs are not marked
01799     as AutoInherit to a security descriptor whose ACLs are marked as
01800     AutoInherit.
01801 
01802     See further detailed description on ConvertToAutoInheritPrivateObjectSecurity.
01803 
01804 Arguments:
01805 
01806     ParentDescriptor - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Security Descriptor <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parent
01807         directory under which a object exists.  If there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
01808         no parent directory, then <span class="keyword">this</span> argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified as <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>.
01809 
01810     CurrentSecurityDescriptor - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> objects security descriptor
01811         that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> going to be altered by <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a>.
01812 
01813     NewSecurityDescriptor Points to a pointer that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> to point to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01814         newly allocated <span class="keyword">self</span>-relative security descriptor. When no
01815         longer needed, <span class="keyword">this</span> descriptor must be freed <span class="keyword">using</span>
01816         DestroyPrivateObjectSecurity().
01817 
01818     ObjectType - GUID of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> being created.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object being
01819         created has no GUID associated with <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>, then <span class="keyword">this</span> argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
01820         specified as <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>.
01821 
01822     IsDirectoryObject - Specifies <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a
01823         directory object.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a
01824         container of other objects.
01825 
01826     GenericMapping - Supplies a pointer to a generic mapping array denoting
01827         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mapping between each generic right to specific rights.
01828 
01829 Return Value:
01830 
01831     STATUS_SUCCESS - The operation was successful.
01832 
01833     STATUS_UNKNOWN_REVISION - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source ACL <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a revision that
01834         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> unknown to <span class="keyword">this</span> routine.  (Only revision 2 ACLs are support by <span class="keyword">this</span> routine.)
01835 
01836     STATUS_INVALID_ACL - The structure of one of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACLs in invalid.
01837 
01838 
01839 
01840 --*/
01841 {
01842 
01843     <span class="comment">//</span>
01844     <span class="comment">// Simply call the corresponding Rtlp routine telling it which allocator</span>
01845     <span class="comment">//  to use.</span>
01846     <span class="comment">//</span>
01847 
01848     <span class="keywordflow">return</span> <a class="code" href="../../d8/d6/sertl_8c.html#a75">RtlpConvertToAutoInheritSecurityObject</a>(
01849                             ParentDescriptor,
01850                             CurrentSecurityDescriptor,
01851                             NewSecurityDescriptor,
01852                             ObjectType,
01853                             IsDirectoryObject,
01854                             GenericMapping );
01855 
01856 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="seurtl.c::RtlCopySecurityDescriptor" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlCopySecurityDescriptor           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>InputSecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PSECURITY_DESCRIPTOR *&nbsp;</td>
          <td class="mdname" nowrap> <em>OutputSecurityDescriptor</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/seurtl_8c-source.html#l01021">1021</a> of file <a class="el" href="../../d5/d7/seurtl_8c-source.html">seurtl.c</a>.
<p>
References <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00161">Dacl</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00457">MAKE_TAG</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00159">Owner</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00022">RtlAllocateHeap</a>, <a class="el" href="../../d8/d0/rtlassig_8c-source.html#l00425">RtlpQuerySecurityDescriptor()</a>, and <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00464">SE_TAG</a>.
<p>
<pre class="fragment"><div>01028                    :
01029 
01030     This routine will copy a <span class="keyword">self</span>-relative security descriptor from
01031     any memory into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> correct <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of memory required by security
01032     descriptor Rtl <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a>.
01033 
01034     This allows security descriptors to be kept in whatever kind of
01035     storage <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> most convenient <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current application.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> security
01036     descriptor should be copied via <span class="keyword">this</span> routine and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> copy passed
01037     into any Rtl routine that in any way modify <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor
01038     (eg <a class="code" href="../../d4/d8/seurtl_8c.html#a2">RtlSetSecurityObject</a>).
01039 
01040     The storage allocated by <span class="keyword">this</span> routine must be freed by
01041     <a class="code" href="../../d4/d8/seurtl_8c.html#a5">RtlDeleteSecurityObject</a>.
01042 
01043 Arguments:
01044 
01045     InputSecurityDescriptor - contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source security descriptor
01046 
01047     OutputSecurityDescriptor - returns a copy of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor
01048         in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> correct kind of memory.
01049 
01050 
01051 Return Value:
01052 
01053     STATUS_NO_MEMORY - There was not enough memory available to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current
01054         process to complete <span class="keyword">this</span> operation.
01055 
01056 --*/
01057 
01058 {
01059 
01060     PACL <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>;
01061     PACL Sacl;
01062 
01063     PSID <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>;
01064     PSID PrimaryGroup;
01065 
01066     ULONG DaclSize;
01067     ULONG OwnerSize;
01068     ULONG PrimaryGroupSize;
01069     ULONG SaclSize;
01070     ULONG TotalSize;
01071 
01072     PISECURITY_DESCRIPTOR ISecurityDescriptor =
01073                             (PISECURITY_DESCRIPTOR)InputSecurityDescriptor;
01074 
01075 
01076     <a class="code" href="../../d7/d1/rtlassig_8c.html#a5">RtlpQuerySecurityDescriptor</a>(
01077         ISecurityDescriptor,
01078         &amp;Owner,
01079         &amp;OwnerSize,
01080         &amp;PrimaryGroup,
01081         &amp;PrimaryGroupSize,
01082         &amp;Dacl,
01083         &amp;DaclSize,
01084         &amp;Sacl,
01085         &amp;SaclSize
01086         );
01087 
01088     TotalSize = <span class="keyword">sizeof</span>(SECURITY_DESCRIPTOR) +
01089                 OwnerSize +
01090                 PrimaryGroupSize +
01091                 DaclSize +
01092                 SaclSize;
01093 
01094     *OutputSecurityDescriptor = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>( RtlProcessHeap(), <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( SE_TAG ), TotalSize );
01095 
01096     <span class="keywordflow">if</span> ( *OutputSecurityDescriptor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01097         <span class="keywordflow">return</span>( STATUS_NO_MEMORY );
01098     }
01099 
01100     RtlMoveMemory( *OutputSecurityDescriptor,
01101                    ISecurityDescriptor,
01102                    TotalSize
01103                    );
01104 
01105     <span class="keywordflow">return</span>( STATUS_SUCCESS );
01106 
01107 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="seurtl.c::RtlCreateAndSetSD" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlCreateAndSetSD           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PRTL_ACE_DATA&nbsp;</td>
          <td class="mdname" nowrap> <em>AceData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AceCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID OwnerSid&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID GroupSid&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PSECURITY_DESCRIPTOR *&nbsp;</td>
          <td class="mdname" nowrap> <em>NewDescriptor</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/seurtl_8c-source.html#l01260">1260</a> of file <a class="el" href="../../d5/d7/seurtl_8c-source.html">seurtl.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00161">Dacl</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/memory_8c-source.html#l00115">HeapHandle</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00457">MAKE_TAG</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l00718">RtlAddAce()</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00022">RtlAllocateHeap</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l00099">RtlCreateAcl()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01945">RtlCreateSecurityDescriptor()</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00023">RtlFreeHeap</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01350">RtlLengthSid()</a>, <a class="el" href="../../d5/d7/seurtl_8c-source.html#l01111">RtlpInitializeAllowedAce()</a>, <a class="el" href="../../d5/d7/seurtl_8c-source.html#l01211">RtlpInitializeAuditAce()</a>, <a class="el" href="../../d5/d7/seurtl_8c-source.html#l01161">RtlpInitializeDeniedAce()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l02543">RtlSetDaclSecurityDescriptor()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l03135">RtlSetGroupSecurityDescriptor()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l02963">RtlSetOwnerSecurityDescriptor()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l02756">RtlSetSaclSecurityDescriptor()</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00464">SE_TAG</a>, <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d5/d7/seurtl_8c-source.html#l01624">RtlCreateUserSecurityObject()</a>.
<p>
<pre class="fragment"><div>01269                    :
01270 
01271     This function creates an absolute security descriptor containing
01272     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> supplied ACE information.
01273 
01274     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> sample usage of <span class="keyword">this</span> function:
01275 
01276         <span class="comment">//</span>
01277         <span class="comment">// Order matters!  These ACEs are inserted into the DACL in the</span>
01278         <span class="comment">// following order.  Security access is granted or denied based on</span>
01279         <span class="comment">// the order of the ACEs in the DACL.</span>
01280         <span class="comment">//</span>
01281 
01282         RTL_ACE_DATA AceData[4] = {
01283             {ACCESS_ALLOWED_ACE_TYPE, 0, 0,
01284                    GENERIC_ALL,                  &amp;LocalAdminSid},
01285 
01286             {ACCESS_DENIED_ACE_TYPE,  0, 0,
01287                    GENERIC_ALL,                  &amp;<a class="code" href="../../d4/d1/rtdmpsec_8c.html#a13">NetworkSid</a>},
01288 
01289             {ACCESS_ALLOWED_ACE_TYPE, 0, 0,
01290                    WKSTA_CONFIG_GUEST_INFO_GET |
01291                    WKSTA_CONFIG_USER_INFO_GET,   &amp;DomainUsersSid},
01292 
01293             {ACCESS_ALLOWED_ACE_TYPE, 0, 0,
01294                    WKSTA_CONFIG_GUEST_INFO_GET,  &amp;DomainGuestsSid}
01295             };
01296 
01297         PSECURITY_DESCRIPTOR WkstaSecurityDescriptor;
01298 
01299 
01300         <span class="keywordflow">return</span> <a class="code" href="../../d4/d8/seurtl_8c.html#a12">RtlCreateAndSetSD</a>(
01301                    AceData,
01302                    4,
01303                    LocalSystemSid,
01304                    LocalSystemSid,
01305                    &amp;WkstaSecurityDescriptor
01306                    );
01307 
01308 Arguments:
01309 
01310     AceData - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> structure of information that describes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DACL.
01311 
01312     AceCount - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of entries in AceData structure.
01313 
01314     OwnerSid - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor
01315         owner.  If not specified, a security descriptor with no owner
01316         will be created.
01317 
01318     GroupSid - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor
01319         primary group.  If not specified, a security descriptor with no primary
01320         group will be created.
01321 
01322     NewDescriptor - Returns a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> absolute security descriptor
01323         allocated <span class="keyword">using</span> <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>.
01324 
01325 Return Value:
01326 
01327     STATUS_SUCCESS - <span class="keywordflow">if</span> successful
01328     STATUS_NO_MEMORY - <span class="keywordflow">if</span> cannot allocate memory <span class="keywordflow">for</span> DACL, ACEs, and
01329         security descriptor.
01330 
01331     Any other status codes returned from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security Rtl <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a>.
01332 
01333     NOTE : <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user security object created by calling <span class="keyword">this</span> function may be
01334                 freed up by calling <a class="code" href="../../d4/d8/seurtl_8c.html#a5">RtlDeleteSecurityObject</a>().
01335 
01336 --*/
01337 {
01338 
01339     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> ntstatus = STATUS_SUCCESS;
01340     ULONG i;
01341 
01342     <span class="comment">//</span>
01343     <span class="comment">// Pointer to memory dynamically allocated by this routine to hold</span>
01344     <span class="comment">// the absolute security descriptor, the DACL, the SACL, and all the ACEs.</span>
01345     <span class="comment">//</span>
01346     <span class="comment">// +---------------------------------------------------------------+</span>
01347     <span class="comment">// |                     Security Descriptor                       |</span>
01348     <span class="comment">// +-------------------------------+-------+---------------+-------+</span>
01349     <span class="comment">// |          DACL                 | ACE 1 |   .  .  .     | ACE n |</span>
01350     <span class="comment">// +-------------------------------+-------+---------------+-------+</span>
01351     <span class="comment">// |          SACL                 | ACE 1 |   .  .  .     | ACE n |</span>
01352     <span class="comment">// +-------------------------------+-------+---------------+-------+</span>
01353     <span class="comment">//</span>
01354 
01355     PSECURITY_DESCRIPTOR AbsoluteSd = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01356     PACL <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;   <span class="comment">// Pointer to the DACL portion of above buffer</span>
01357     PACL Sacl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;   <span class="comment">// Pointer to the SACL portion of above buffer</span>
01358 
01359     ULONG DaclSize = <span class="keyword">sizeof</span>(ACL);
01360     ULONG SaclSize = <span class="keyword">sizeof</span>(ACL);
01361     ULONG MaxAceSize = 0;
01362     PVOID MaxAce = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01363 
01364     PCHAR CurrentAvailable;
01365     ULONG <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
01366 
01367     PVOID <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a> = RtlProcessHeap();
01368 
01369 
01370     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( AceCount &gt; 0 );
01371 
01372     <span class="comment">//</span>
01373     <span class="comment">// Compute the total size of the DACL and SACL ACEs and the maximum</span>
01374     <span class="comment">// size of any ACE.</span>
01375     <span class="comment">//</span>
01376 
01377     <span class="keywordflow">for</span> (i = 0; i &lt; AceCount; i++) {
01378         ULONG AceSize;
01379 
01380         AceSize = <a class="code" href="../../d8/d6/sertl_8c.html#a45">RtlLengthSid</a>(*(AceData[i].Sid));
01381 
01382         <span class="keywordflow">switch</span> (AceData[i].AceType) {
01383         <span class="keywordflow">case</span> ACCESS_ALLOWED_ACE_TYPE:
01384             AceSize += <span class="keyword">sizeof</span>(ACCESS_ALLOWED_ACE);
01385             DaclSize += AceSize;
01386             <span class="keywordflow">break</span>;
01387 
01388         <span class="keywordflow">case</span> ACCESS_DENIED_ACE_TYPE:
01389             AceSize += <span class="keyword">sizeof</span>(ACCESS_DENIED_ACE);
01390             DaclSize += AceSize;
01391             <span class="keywordflow">break</span>;
01392 
01393         <span class="keywordflow">case</span> SYSTEM_AUDIT_ACE_TYPE:
01394             AceSize += <span class="keyword">sizeof</span>(SYSTEM_AUDIT_ACE);
01395             SaclSize += AceSize;
01396             <span class="keywordflow">break</span>;
01397 
01398         <span class="keywordflow">default</span>:
01399             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01400         }
01401 
01402         MaxAceSize = MaxAceSize &gt; AceSize ? MaxAceSize : AceSize;
01403     }
01404 
01405     <span class="comment">//</span>
01406     <span class="comment">// Allocate a chunk of memory large enough for the security descriptor,</span>
01407     <span class="comment">// the DACL, the SACL and all ACEs.</span>
01408     <span class="comment">//</span>
01409     <span class="comment">// A security descriptor is of opaque data type but</span>
01410     <span class="comment">// SECURITY_DESCRIPTOR_MIN_LENGTH is the right size.</span>
01411     <span class="comment">//</span>
01412 
01413     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = SECURITY_DESCRIPTOR_MIN_LENGTH;
01414     <span class="keywordflow">if</span> ( DaclSize != <span class="keyword">sizeof</span>(ACL) ) {
01415         <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> += DaclSize;
01416     }
01417     <span class="keywordflow">if</span> ( SaclSize != <span class="keyword">sizeof</span>(ACL) ) {
01418         <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> += SaclSize;
01419     }
01420 
01421     <span class="keywordflow">if</span> ((AbsoluteSd = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(
01422                           HeapHandle, <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( SE_TAG ),
01423                           Size
01424                           )) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01425         ntstatus = STATUS_NO_MEMORY;
01426         <span class="keywordflow">goto</span> Cleanup;
01427     }
01428 
01429     <span class="comment">//</span>
01430     <span class="comment">// Initialize the Dacl and Sacl</span>
01431     <span class="comment">//</span>
01432 
01433     CurrentAvailable = (PCHAR)AbsoluteSd + SECURITY_DESCRIPTOR_MIN_LENGTH;
01434 
01435     <span class="keywordflow">if</span> ( DaclSize != <span class="keyword">sizeof</span>(ACL) ) {
01436         <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a> = (PACL)CurrentAvailable;
01437         CurrentAvailable += DaclSize;
01438 
01439         ntstatus = <a class="code" href="../../d2/d4/acledit_8c.html#a6">RtlCreateAcl</a>( Dacl, DaclSize, ACL_REVISION );
01440 
01441         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ntstatus) ) {
01442             <span class="keywordflow">goto</span> Cleanup;
01443         }
01444     }
01445 
01446     <span class="keywordflow">if</span> ( SaclSize != <span class="keyword">sizeof</span>(ACL) ) {
01447         Sacl = (PACL)CurrentAvailable;
01448         CurrentAvailable += SaclSize;
01449 
01450         ntstatus = <a class="code" href="../../d2/d4/acledit_8c.html#a6">RtlCreateAcl</a>( Sacl, SaclSize, ACL_REVISION );
01451 
01452         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ntstatus) ) {
01453             <span class="keywordflow">goto</span> Cleanup;
01454         }
01455     }
01456 
01457     <span class="comment">//</span>
01458     <span class="comment">// Allocate a temporary buffer big enough for the biggest ACE.</span>
01459     <span class="comment">//</span>
01460 
01461     <span class="keywordflow">if</span> ((MaxAce = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(
01462                       HeapHandle, <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( SE_TAG ),
01463                       MaxAceSize
01464                       )) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01465         ntstatus = STATUS_NO_MEMORY;
01466         <span class="keywordflow">goto</span> Cleanup;
01467     }
01468 
01469     <span class="comment">//</span>
01470     <span class="comment">// Initialize each ACE, and append it into the end of the DACL or SACL.</span>
01471     <span class="comment">//</span>
01472 
01473     <span class="keywordflow">for</span> (i = 0; i &lt; AceCount; i++) {
01474         ULONG AceSize;
01475         PACL CurrentAcl;
01476 
01477         AceSize = <a class="code" href="../../d8/d6/sertl_8c.html#a45">RtlLengthSid</a>(*(AceData[i].Sid));
01478 
01479         <span class="keywordflow">switch</span> (AceData[i].AceType) {
01480         <span class="keywordflow">case</span> ACCESS_ALLOWED_ACE_TYPE:
01481 
01482             AceSize += <span class="keyword">sizeof</span>(ACCESS_ALLOWED_ACE);
01483             CurrentAcl = <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>;
01484             ntstatus = <a class="code" href="../../d4/d8/seurtl_8c.html#a9">RtlpInitializeAllowedAce</a>(
01485                            MaxAce,
01486                            (USHORT) AceSize,
01487                            AceData[i].InheritFlags,
01488                            AceData[i].AceFlags,
01489                            AceData[i].Mask,
01490                            *(AceData[i].Sid)
01491                            );
01492             <span class="keywordflow">break</span>;
01493 
01494         <span class="keywordflow">case</span> ACCESS_DENIED_ACE_TYPE:
01495             AceSize += <span class="keyword">sizeof</span>(ACCESS_DENIED_ACE);
01496             CurrentAcl = <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>;
01497             ntstatus = <a class="code" href="../../d4/d8/seurtl_8c.html#a10">RtlpInitializeDeniedAce</a>(
01498                            MaxAce,
01499                            (USHORT) AceSize,
01500                            AceData[i].InheritFlags,
01501                            AceData[i].AceFlags,
01502                            AceData[i].Mask,
01503                            *(AceData[i].Sid)
01504                            );
01505             <span class="keywordflow">break</span>;
01506 
01507         <span class="keywordflow">case</span> SYSTEM_AUDIT_ACE_TYPE:
01508             AceSize += <span class="keyword">sizeof</span>(SYSTEM_AUDIT_ACE);
01509             CurrentAcl = Sacl;
01510             ntstatus = <a class="code" href="../../d4/d8/seurtl_8c.html#a11">RtlpInitializeAuditAce</a>(
01511                            MaxAce,
01512                            (USHORT) AceSize,
01513                            AceData[i].InheritFlags,
01514                            AceData[i].AceFlags,
01515                            AceData[i].Mask,
01516                            *(AceData[i].Sid)
01517                            );
01518             <span class="keywordflow">break</span>;
01519         }
01520 
01521         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( ntstatus ) ) {
01522             <span class="keywordflow">goto</span> Cleanup;
01523         }
01524 
01525         <span class="comment">//</span>
01526         <span class="comment">// Append the initialized ACE to the end of DACL or SACL</span>
01527         <span class="comment">//</span>
01528 
01529         <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (ntstatus = <a class="code" href="../../d2/d4/acledit_8c.html#a10">RtlAddAce</a>(
01530                                          CurrentAcl,
01531                                          ACL_REVISION,
01532                                          MAXULONG,
01533                                          MaxAce,
01534                                          AceSize
01535                                          ))) {
01536             <span class="keywordflow">goto</span> Cleanup;
01537         }
01538     }
01539 
01540     <span class="comment">//</span>
01541     <span class="comment">// Create the security descriptor with absolute pointers to SIDs</span>
01542     <span class="comment">// and ACLs.</span>
01543     <span class="comment">//</span>
01544     <span class="comment">// Owner = OwnerSid</span>
01545     <span class="comment">// Group = GroupSid</span>
01546     <span class="comment">// Dacl  = Dacl</span>
01547     <span class="comment">// Sacl  = Sacl</span>
01548     <span class="comment">//</span>
01549 
01550     <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ntstatus = <a class="code" href="../../d8/d6/sertl_8c.html#a53">RtlCreateSecurityDescriptor</a>(
01551                                     AbsoluteSd,
01552                                     SECURITY_DESCRIPTOR_REVISION
01553                                     ))) {
01554         <span class="keywordflow">goto</span> Cleanup;
01555     }
01556 
01557     <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ntstatus = <a class="code" href="../../d8/d6/sertl_8c.html#a64">RtlSetOwnerSecurityDescriptor</a>(
01558                                     AbsoluteSd,
01559                                     OwnerSid,
01560                                     FALSE
01561                                     ))) {
01562         <span class="keywordflow">goto</span> Cleanup;
01563     }
01564 
01565     <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ntstatus = <a class="code" href="../../d8/d6/sertl_8c.html#a66">RtlSetGroupSecurityDescriptor</a>(
01566                                     AbsoluteSd,
01567                                     GroupSid,
01568                                     FALSE
01569                                     ))) {
01570         <span class="keywordflow">goto</span> Cleanup;
01571     }
01572 
01573     <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ntstatus = <a class="code" href="../../d8/d6/sertl_8c.html#a60">RtlSetDaclSecurityDescriptor</a>(
01574                                     AbsoluteSd,
01575                                     TRUE,
01576                                     Dacl,
01577                                     FALSE
01578                                     ))) {
01579         <span class="keywordflow">goto</span> Cleanup;
01580     }
01581 
01582     <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ntstatus = <a class="code" href="../../d8/d6/sertl_8c.html#a62">RtlSetSaclSecurityDescriptor</a>(
01583                                     AbsoluteSd,
01584                                     FALSE,
01585                                     Sacl,
01586                                     FALSE
01587                                     ))) {
01588         <span class="keywordflow">goto</span> Cleanup;
01589     }
01590 
01591     <span class="comment">//</span>
01592     <span class="comment">// Done</span>
01593     <span class="comment">//</span>
01594 
01595     ntstatus = STATUS_SUCCESS;
01596 
01597     <span class="comment">//</span>
01598     <span class="comment">// Clean up</span>
01599     <span class="comment">//</span>
01600 
01601 Cleanup:
01602     <span class="comment">//</span>
01603     <span class="comment">// Either return the security descriptor to the caller or delete it</span>
01604     <span class="comment">//</span>
01605 
01606     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( ntstatus ) ) {
01607         *NewDescriptor = AbsoluteSd;
01608     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( AbsoluteSd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01609         (<span class="keywordtype">void</span>) <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(HeapHandle, 0, AbsoluteSd);
01610     }
01611 
01612     <span class="comment">//</span>
01613     <span class="comment">// Delete the temporary ACE</span>
01614     <span class="comment">//</span>
01615 
01616     <span class="keywordflow">if</span> ( MaxAce != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01617         (<span class="keywordtype">void</span>) <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(HeapHandle, 0, MaxAce);
01618     }
01619     <span class="keywordflow">return</span> ntstatus;
01620 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="seurtl.c::RtlCreateUserSecurityObject" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlCreateUserSecurityObject           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PRTL_ACE_DATA&nbsp;</td>
          <td class="mdname" nowrap> <em>AceData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AceCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>OwnerSid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>GroupSid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>IsDirectoryObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PGENERIC_MAPPING&nbsp;</td>
          <td class="mdname" nowrap> <em>GenericMapping</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PSECURITY_DESCRIPTOR *&nbsp;</td>
          <td class="mdname" nowrap> <em>NewDescriptor</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/seurtl_8c-source.html#l01624">1624</a> of file <a class="el" href="../../d5/d7/seurtl_8c-source.html">seurtl.c</a>.
<p>
References <a class="el" href="../../d5/d5/memory_8c-source.html#l00115">HeapHandle</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d8/d2/tokenopn_8c-source.html#l00178">NtOpenProcessToken()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/seurtl_8c-source.html#l01260">RtlCreateAndSetSD()</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00023">RtlFreeHeap</a>, and <a class="el" href="../../d5/d7/seurtl_8c-source.html#l00280">RtlNewSecurityObject()</a>.
<p>
<pre class="fragment"><div>01635                    :
01636 
01637     This function creates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DACL <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor based on
01638     on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACE information specified, and creates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor
01639     which becomes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user-mode security object.
01640 
01641     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> sample usage of <span class="keyword">this</span> function:
01642 
01643         <span class="comment">//</span>
01644         <span class="comment">// Structure that describes the mapping of Generic access rights to</span>
01645         <span class="comment">// object specific access rights for the ConfigurationInfo object.</span>
01646         <span class="comment">//</span>
01647 
01648         GENERIC_MAPPING WsConfigInfoMapping = {
01649             STANDARD_RIGHTS_READ            |      <span class="comment">// Generic read</span>
01650                 WKSTA_CONFIG_GUEST_INFO_GET |
01651                 WKSTA_CONFIG_USER_INFO_GET  |
01652                 WKSTA_CONFIG_ADMIN_INFO_GET,
01653             STANDARD_RIGHTS_WRITE |                <span class="comment">// Generic write</span>
01654                 WKSTA_CONFIG_INFO_SET,
01655             STANDARD_RIGHTS_EXECUTE,               <span class="comment">// Generic execute</span>
01656             WKSTA_CONFIG_ALL_ACCESS                <span class="comment">// Generic all</span>
01657             };
01658 
01659         <span class="comment">//</span>
01660         <span class="comment">// Order matters!  These ACEs are inserted into the DACL in the</span>
01661         <span class="comment">// following order.  Security access is granted or denied based on</span>
01662         <span class="comment">// the order of the ACEs in the DACL.</span>
01663         <span class="comment">//</span>
01664 
01665         RTL_ACE_DATA AceData[4] = {
01666             {ACCESS_ALLOWED_ACE_TYPE, 0, 0,
01667                    GENERIC_ALL,                  &amp;LocalAdminSid},
01668 
01669             {ACCESS_DENIED_ACE_TYPE,  0, 0,
01670                    GENERIC_ALL,                  &amp;<a class="code" href="../../d4/d1/rtdmpsec_8c.html#a13">NetworkSid</a>},
01671 
01672             {ACCESS_ALLOWED_ACE_TYPE, 0, 0,
01673                    WKSTA_CONFIG_GUEST_INFO_GET |
01674                    WKSTA_CONFIG_USER_INFO_GET,   &amp;DomainUsersSid},
01675 
01676             {ACCESS_ALLOWED_ACE_TYPE, 0, 0,
01677                    WKSTA_CONFIG_GUEST_INFO_GET,  &amp;DomainGuestsSid}
01678             };
01679 
01680         PSECURITY_DESCRIPTOR WkstaSecurityObject;
01681 
01682 
01683         <span class="keywordflow">return</span> <a class="code" href="../../d4/d8/seurtl_8c.html#a13">RtlCreateUserSecurityObject</a>(
01684                    AceData,
01685                    4,
01686                    LocalSystemSid,
01687                    LocalSystemSid,
01688                    FALSE,
01689                    &amp;WsConfigInfoMapping,
01690                    &amp;WkstaSecurityObject
01691                    );
01692 
01693 Arguments:
01694 
01695     AceData - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> structure of information that describes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DACL.
01696 
01697     AceCount - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of entries in AceData structure.
01698 
01699     OwnerSid - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor
01700         owner.
01701 
01702     GroupSid - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor
01703         primary group.
01704 
01705     IsDirectoryObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> flag which indicates whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01706         user-mode object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a directory object.
01707 
01708     GenericMapping - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pointer to a generic mapping array denoting
01709         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mapping between each generic right to specific rights.
01710 
01711     NewDescriptor - Returns a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">self</span>-relative security descriptor
01712         which represents <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user-mode object.
01713 
01714 Return Value:
01715 
01716     STATUS_SUCCESS - <span class="keywordflow">if</span> successful
01717     STATUS_NO_MEMORY - <span class="keywordflow">if</span> cannot allocate memory <span class="keywordflow">for</span> DACL, ACEs, and
01718         security descriptor.
01719 
01720     Any other status codes returned from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security Rtl <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a>.
01721 
01722     NOTE : <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user security object created by calling <span class="keyword">this</span> function may be
01723                 freed up by calling <a class="code" href="../../d4/d8/seurtl_8c.html#a5">RtlDeleteSecurityObject</a>().
01724 
01725 --*/
01726 {
01727 
01728     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> ntstatus;
01729     PSECURITY_DESCRIPTOR AbsoluteSd;
01730     HANDLE TokenHandle;
01731     PVOID <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a> = RtlProcessHeap();
01732 
01733     ntstatus = <a class="code" href="../../d4/d8/seurtl_8c.html#a12">RtlCreateAndSetSD</a>(
01734                    AceData,
01735                    AceCount,
01736                    OwnerSid,
01737                    GroupSid,
01738                    &amp;AbsoluteSd
01739                    );
01740 
01741     <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ntstatus)) {
01742         <span class="keywordflow">return</span> ntstatus;
01743     }
01744 
01745     ntstatus = <a class="code" href="../../d7/d3/tokenopn_8c.html#a1">NtOpenProcessToken</a>(
01746                    NtCurrentProcess(),
01747                    TOKEN_QUERY,
01748                    &amp;TokenHandle
01749                    );
01750 
01751     <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ntstatus)) {
01752         (<span class="keywordtype">void</span>) <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(HeapHandle, 0, AbsoluteSd);
01753         <span class="keywordflow">return</span> ntstatus;
01754     }
01755 
01756     <span class="comment">//</span>
01757     <span class="comment">// Create the security object (a user-mode object is really a pseudo-</span>
01758     <span class="comment">// object represented by a security descriptor that have relative</span>
01759     <span class="comment">// pointers to SIDs and ACLs).  This routine allocates the memory to</span>
01760     <span class="comment">// hold the relative security descriptor so the memory allocated for the</span>
01761     <span class="comment">// DACL, ACEs, and the absolute descriptor can be freed.</span>
01762     <span class="comment">//</span>
01763     ntstatus = <a class="code" href="../../d4/d8/seurtl_8c.html#a1">RtlNewSecurityObject</a>(
01764                    NULL,                   <span class="comment">// Parent descriptor</span>
01765                    AbsoluteSd,             <span class="comment">// Creator descriptor</span>
01766                    NewDescriptor,          <span class="comment">// Pointer to new descriptor</span>
01767                    IsDirectoryObject,      <span class="comment">// Is directory object</span>
01768                    TokenHandle,            <span class="comment">// Token</span>
01769                    GenericMapping          <span class="comment">// Generic mapping</span>
01770                    );
01771 
01772     (<span class="keywordtype">void</span>) <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(TokenHandle);
01773 
01774     <span class="comment">//</span>
01775     <span class="comment">// Free dynamic memory before returning</span>
01776     <span class="comment">//</span>
01777     (<span class="keywordtype">void</span>) <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(HeapHandle, 0, AbsoluteSd);
01778     <span class="keywordflow">return</span> ntstatus;
01779 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="seurtl.c::RtlDefaultNpAcl" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlDefaultNpAcl           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PACL *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pAcl</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/seurtl_8c-source.html#l01860">1860</a> of file <a class="el" href="../../d5/d7/seurtl_8c-source.html">seurtl.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d8/d2/tokenopn_8c-source.html#l00178">NtOpenProcessToken()</a>, <a class="el" href="../../d8/d2/tokenopn_8c-source.html#l00458">NtOpenThreadToken()</a>, <a class="el" href="../../d0/d3/tokenqry_8c-source.html#l00034">NtQueryInformationToken()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l01607">RtlAddAccessAllowedAce()</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00022">RtlAllocateHeap</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l00099">RtlCreateAcl()</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00023">RtlFreeHeap</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01166">RtlInitializeSid()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01030">RtlLengthRequiredSid()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01350">RtlLengthSid()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01286">RtlSubAuthoritySid()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>01865                    :
01866 
01867     This routine constructs a <span class="keywordflow">default</span> ACL to be applied to
01868     named pipe objects when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller has not specified one.
01869     See NT bug 131090.
01870 
01871     The ACL constructed <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> as follows:
01872 
01873     Need to build an ACL that looks like <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following:
01874 
01875      Local System : F
01876      Administrators: F
01877      <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>: F
01878      Everyone: R
01879 
01880      The owner <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> determined by querying <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> currently effective
01881      toke and extracting <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">default</span> owner.
01882 
01883 Arguments:
01884 
01885     pAcl - Receives a pointer to an ACL to apply to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> named pipe
01886         being created.  Guaranteed to be <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> on <span class="keywordflow">return</span> <span class="keywordflow">if</span> an error
01887         occurs.
01888 
01889         This must be freed by calling <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>.
01890 
01891 Return Value:
01892 
01893     NT <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>.
01894 
01895 --*/
01896 {
01897     SID_IDENTIFIER_AUTHORITY    NtAuthority         = SECURITY_NT_AUTHORITY;
01898     SID_IDENTIFIER_AUTHORITY    CreatorSidAuthority = SECURITY_CREATOR_SID_AUTHORITY;
01899     SID_IDENTIFIER_AUTHORITY    WorldSidAuthority   = SECURITY_WORLD_SID_AUTHORITY;
01900 
01901     ULONG AclSize         = 0;
01902     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>       = STATUS_SUCCESS;
01903     ULONG ReturnLength    = 0;
01904     PTOKEN_OWNER OwnerSid = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01905 
01906     HANDLE hToken;
01907 
01908     <span class="comment">//</span>
01909     <span class="comment">// Initialize OUT parameters</span>
01910     <span class="comment">//</span>
01911 
01912     *pAcl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01913 
01914     <span class="comment">//</span>
01915     <span class="comment">// Open thread token</span>
01916     <span class="comment">//</span>
01917 
01918     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d3/tokenopn_8c.html#a3">NtOpenThreadToken</a>(
01919                  NtCurrentThread(),
01920                  TOKEN_QUERY,
01921                  TRUE,
01922                  &amp;hToken
01923                  );
01924 
01925     <span class="keywordflow">if</span> (STATUS_NO_TOKEN == <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) {
01926 
01927         <span class="comment">//</span>
01928         <span class="comment">// Not impersonating, get process token</span>
01929         <span class="comment">//</span>
01930 
01931         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d3/tokenopn_8c.html#a1">NtOpenProcessToken</a>(
01932                      NtCurrentProcess(),
01933                      TOKEN_QUERY,
01934                      &amp;hToken
01935                      );
01936     }
01937 
01938     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
01939 
01940         <span class="comment">//</span>
01941         <span class="comment">// Get the default owner</span>
01942         <span class="comment">//</span>
01943 
01944         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a> (
01945                      hToken,
01946                      TokenOwner,
01947                      NULL,
01948                      0,
01949                      &amp;ReturnLength
01950                      );
01951 
01952         <span class="keywordflow">if</span> (STATUS_BUFFER_TOO_SMALL == <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) {
01953 
01954             OwnerSid = (PTOKEN_OWNER)<a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>( RtlProcessHeap(), 0, ReturnLength );
01955 
01956             <span class="keywordflow">if</span> (OwnerSid) {
01957 
01958                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a> (
01959                              hToken,
01960                              TokenOwner,
01961                              OwnerSid,
01962                              ReturnLength,
01963                              &amp;ReturnLength
01964                              );
01965 
01966                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
01967 
01968                     <span class="comment">//</span>
01969                     <span class="comment">// Compute the size needed</span>
01970                     <span class="comment">//</span>
01971 
01972                     UCHAR SidBuffer[16];
01973                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( 16 == <a class="code" href="../../d8/d6/sertl_8c.html#a38">RtlLengthRequiredSid</a>( 2 ));
01974 
01975                     AclSize += <a class="code" href="../../d8/d6/sertl_8c.html#a38">RtlLengthRequiredSid</a>( 1 );   <span class="comment">// LocalSystem Sid</span>
01976                     AclSize += <a class="code" href="../../d8/d6/sertl_8c.html#a38">RtlLengthRequiredSid</a>( 2 );   <span class="comment">// Administrators</span>
01977                     AclSize += <a class="code" href="../../d8/d6/sertl_8c.html#a38">RtlLengthRequiredSid</a>( 1 );   <span class="comment">// Everyone (World)</span>
01978 
01979                     AclSize += <a class="code" href="../../d8/d6/sertl_8c.html#a45">RtlLengthSid</a>( OwnerSid-&gt;Owner );   <span class="comment">// Owner</span>
01980 
01981                     AclSize += <span class="keyword">sizeof</span>( ACL );               <span class="comment">// Header</span>
01982                     AclSize += 4 * (<span class="keyword">sizeof</span>( ACCESS_ALLOWED_ACE ) - <span class="keyword">sizeof</span>( ULONG ));
01983 
01984                     <span class="comment">//</span>
01985                     <span class="comment">// Allocate the Acl out of the local process heap</span>
01986                     <span class="comment">//</span>
01987 
01988                     *pAcl = (PACL)<a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>( RtlProcessHeap(), 0, AclSize );
01989 
01990                     <span class="keywordflow">if</span> (*pAcl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01991 
01992                         <a class="code" href="../../d2/d4/acledit_8c.html#a6">RtlCreateAcl</a>( *pAcl, AclSize, ACL_REVISION );
01993 
01994                         <span class="comment">//</span>
01995                         <span class="comment">// Create each SID in turn and copy the resultant ACE into</span>
01996                         <span class="comment">// the new ACL</span>
01997                         <span class="comment">//</span>
01998 
01999                         <span class="comment">//</span>
02000                         <span class="comment">// Local System - Generic All</span>
02001                         <span class="comment">//</span>
02002 
02003                         <a class="code" href="../../d8/d6/sertl_8c.html#a40">RtlInitializeSid</a>( SidBuffer, &amp;NtAuthority, 1);
02004                         *(<a class="code" href="../../d8/d6/sertl_8c.html#a43">RtlSubAuthoritySid</a>( SidBuffer, 0 )) = SECURITY_LOCAL_SYSTEM_RID;
02005                         <a class="code" href="../../d2/d4/acledit_8c.html#a16">RtlAddAccessAllowedAce</a>( *pAcl, ACL_REVISION, GENERIC_ALL, (PSID)SidBuffer );
02006 
02007                         <span class="comment">//</span>
02008                         <span class="comment">// Admins - Generic All</span>
02009                         <span class="comment">//</span>
02010 
02011                         <a class="code" href="../../d8/d6/sertl_8c.html#a40">RtlInitializeSid</a>( SidBuffer, &amp;NtAuthority, 2);
02012                         *(<a class="code" href="../../d8/d6/sertl_8c.html#a43">RtlSubAuthoritySid</a>( SidBuffer, 0 )) = SECURITY_BUILTIN_DOMAIN_RID;
02013                         *(<a class="code" href="../../d8/d6/sertl_8c.html#a43">RtlSubAuthoritySid</a>( SidBuffer, 1 )) = DOMAIN_ALIAS_RID_ADMINS;
02014                         <a class="code" href="../../d2/d4/acledit_8c.html#a16">RtlAddAccessAllowedAce</a>( *pAcl, ACL_REVISION, GENERIC_ALL, (PSID)SidBuffer );
02015 
02016                         <span class="comment">//</span>
02017                         <span class="comment">// Owner - Generic All</span>
02018                         <span class="comment">//</span>
02019 
02020                         <a class="code" href="../../d2/d4/acledit_8c.html#a16">RtlAddAccessAllowedAce</a>( *pAcl, ACL_REVISION, GENERIC_ALL, OwnerSid-&gt;Owner );
02021 
02022                         <span class="comment">//</span>
02023                         <span class="comment">// World - Generic Read</span>
02024                         <span class="comment">//</span>
02025 
02026                         <a class="code" href="../../d8/d6/sertl_8c.html#a40">RtlInitializeSid</a>( SidBuffer, &amp;WorldSidAuthority, 1 );
02027                         *(<a class="code" href="../../d8/d6/sertl_8c.html#a43">RtlSubAuthoritySid</a>( SidBuffer, 0 )) = SECURITY_WORLD_RID;
02028                         <a class="code" href="../../d2/d4/acledit_8c.html#a16">RtlAddAccessAllowedAce</a>( *pAcl, ACL_REVISION, GENERIC_READ, (PSID)SidBuffer );
02029 
02030                     } <span class="keywordflow">else</span> {
02031 
02032                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
02033                     }
02034                 }
02035 
02036                 <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( RtlProcessHeap(), 0, OwnerSid );
02037 
02038             } <span class="keywordflow">else</span> {
02039 
02040                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
02041             }
02042         }
02043 
02044         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( hToken );
02045     }
02046 
02047     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
02048 
02049         <span class="comment">//</span>
02050         <span class="comment">// Something failed, clean up OUT</span>
02051         <span class="comment">// parameters.</span>
02052         <span class="comment">//</span>
02053 
02054         <span class="keywordflow">if</span> (*pAcl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02055             <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( RtlProcessHeap(), 0, *pAcl );
02056             *pAcl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02057         }
02058     }
02059 
02060     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
02061 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="seurtl.c::RtlDeleteSecurityObject" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlDeleteSecurityObject           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PSECURITY_DESCRIPTOR *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ObjectDescriptor</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/seurtl_8c-source.html#l00633">633</a> of file <a class="el" href="../../d5/d7/seurtl_8c-source.html">seurtl.c</a>.
<p>
References <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00023">RtlFreeHeap</a>.
<p>
<pre class="fragment"><div>00640                    :
00641 
00642     <a class="code" href="../../d9/d0/rtdelkey_8c.html#a5">Delete</a> a <span class="keyword">protected</span> server object's security descriptor.
00643 
00644     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a>, called <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> from user mode, <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to <span class="keyword">delete</span> a
00645     security descriptor associated with a <span class="keyword">protected</span> server's object.  This
00646     routine will normally be called by a <span class="keyword">protected</span> server during object
00647     deletion.
00648 
00649                                   - - <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a> - -
00650 
00651     This service <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keywordflow">for</span> use by <span class="keyword">protected</span> subsystems that project their own
00652     <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of object.  This service <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> explicitly not <span class="keywordflow">for</span> use by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00653     executive <span class="keywordflow">for</span> executive objects and must not be called from kernel
00654     mode.
00655 
00656 
00657 Arguments:
00658 
00659     ObjectDescriptor - Points to a pointer to a security descriptor to be
00660         deleted.
00661 
00662 
00663 Return Value:
00664 
00665     STATUS_SUCCESS - The operation was successful.
00666 
00667 --*/
00668 
00669 {
00670     <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( RtlProcessHeap(), 0, (PVOID)*ObjectDescriptor );
00671 
00672     <span class="keywordflow">return</span>( STATUS_SUCCESS );
00673 
00674 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="seurtl.c::RtlNewInstanceSecurityObject" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlNewInstanceSecurityObject           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ParentDescriptorChanged</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>CreatorDescriptorChanged</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLUID&nbsp;</td>
          <td class="mdname" nowrap> <em>OldClientTokenModifiedId</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PLUID&nbsp;</td>
          <td class="mdname" nowrap> <em>NewClientTokenModifiedId</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_DESCRIPTOR ParentDescriptor&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_DESCRIPTOR CreatorDescriptor&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PSECURITY_DESCRIPTOR *&nbsp;</td>
          <td class="mdname" nowrap> <em>NewDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>IsDirectoryObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Token</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PGENERIC_MAPPING&nbsp;</td>
          <td class="mdname" nowrap> <em>GenericMapping</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/seurtl_8c-source.html#l00680">680</a> of file <a class="el" href="../../d5/d7/seurtl_8c-source.html">seurtl.c</a>.
<p>
References <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00040">ClientTokenStatistics</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d3/tokenqry_8c-source.html#l00034">NtQueryInformationToken()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01824">RtlEqualLuid()</a>, <a class="el" href="../../d5/d7/seurtl_8c-source.html#l00280">RtlNewSecurityObject()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>.
<p>
<pre class="fragment"><div>00695                    :
00696 
00697     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">return</span> status <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> STATUS_SUCCESS and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NewSecurity <span class="keywordflow">return</span>
00698     value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security desscriptor of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> original
00699     instance of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> valid <span class="keywordflow">for</span> <span class="keyword">this</span> instance as well.
00700 
00701 Arguments:
00702 
00703     ParentDescriptorChanged - Supplies a flag indicating whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00704         parent security descriptor has changed since <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last time
00705         <span class="keyword">this</span> set of parameters was used.
00706 
00707     CreatorDescriptorChanged - Supplies a flag indicating whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00708         creator security descriptor has changed since <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last time
00709         <span class="keyword">this</span> set of parameters was used.
00710 
00711     OldClientTokenModifiedId - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ModifiedId from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> passed
00712         token that was in effect when <span class="keyword">this</span> call was last <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> with
00713         these parameters.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current ModifiedId <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> different from
00714         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> one passed in here, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor must be
00715         rebuilt.
00716 
00717     NewClientTokenModifiedId - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current ModifiedId from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00718         passed token.
00719 
00720     ParentDescriptor - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Security Descriptor <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parent
00721         directory under which a <span class="keyword">new</span> object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being created.  If there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00722         no parent directory, then <span class="keyword">this</span> argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified as <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>.
00723 
00724     CreatorDescriptor - (Optionally) Points to a security descriptor
00725         presented by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> creator of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> creator of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00726         object did not explicitly pass security information <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span>
00727         object, then a null pointer should be passed.
00728 
00729     NewDescriptor - Points to a pointer that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> to point to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00730         newly allocated <span class="keyword">self</span>-relative security descriptor.
00731 
00732     IsDirectoryObject - Specifies <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> going to be a
00733         directory object.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a
00734         container of other objects.
00735 
00736     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client on whose behalf <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00737         object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being created.  If <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an impersonation token,
00738         then <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> must be at SecurityIdentification level or higher.  If
00739         <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not an impersonation token, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation proceeds
00740         normally.
00741 
00742         <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> client token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to retrieve <span class="keywordflow">default</span> security
00743         information <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> object, such as <span class="keywordflow">default</span> owner, primary
00744         group, and discretionary access <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a>.  The token must be
00745         open <span class="keywordflow">for</span> TOKEN_QUERY access.
00746 
00747     GenericMapping - Supplies a pointer to a generic mapping array denoting
00748         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mapping between each generic right to specific rights.
00749 
00750 Return Value:
00751 
00752     <span class="keywordflow">return</span>-value - <a class="code" href="../../d4/d9/heapdbg_8c.html#a4">Description</a> of conditions needed to <span class="keywordflow">return</span> value. - or -
00753     None.
00754 
00755 --*/
00756 
00757 {
00758 
00759     TOKEN_STATISTICS <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a17">ClientTokenStatistics</a>;
00760     ULONG ReturnLength;
00761     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00762 
00763 
00764 
00765     <span class="comment">//</span>
00766     <span class="comment">// Get the current token modified LUID</span>
00767     <span class="comment">//</span>
00768 
00769 
00770     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
00771                  Token,                        <span class="comment">// Handle</span>
00772                  TokenStatistics,              <span class="comment">// TokenInformationClass</span>
00773                  &amp;ClientTokenStatistics,       <span class="comment">// TokenInformation</span>
00774                  <span class="keyword">sizeof</span>(TOKEN_STATISTICS),     <span class="comment">// TokenInformationLength</span>
00775                  &amp;ReturnLength                 <span class="comment">// ReturnLength</span>
00776                  );
00777 
00778     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00779         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00780     }
00781 
00782     *NewClientTokenModifiedId = <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a17">ClientTokenStatistics</a>.ModifiedId;
00783 
00784     <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>(NewClientTokenModifiedId, OldClientTokenModifiedId) ) {
00785 
00786         <span class="keywordflow">if</span> ( !(ParentDescriptorChanged || CreatorDescriptorChanged) ) {
00787 
00788             <span class="comment">//</span>
00789             <span class="comment">// The old security descriptor is valid for this new instance</span>
00790             <span class="comment">// of the object type as well.  Pass back success and NULL for</span>
00791             <span class="comment">// the NewDescriptor.</span>
00792             <span class="comment">//</span>
00793 
00794             *NewDescriptor = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00795             <span class="keywordflow">return</span>( STATUS_SUCCESS );
00796 
00797         }
00798     }
00799 
00800     <span class="comment">//</span>
00801     <span class="comment">// Something has changed, take the long route and build a new</span>
00802     <span class="comment">// descriptor</span>
00803     <span class="comment">//</span>
00804 
00805     <span class="keywordflow">return</span>( <a class="code" href="../../d4/d8/seurtl_8c.html#a1">RtlNewSecurityObject</a>( ParentDescriptor,
00806                                   CreatorDescriptor,
00807                                   NewDescriptor,
00808                                   IsDirectoryObject,
00809                                   Token,
00810                                   GenericMapping
00811                                   ));
00812 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="seurtl.c::RtlNewSecurityGrantedAccess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlNewSecurityGrantedAccess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PPRIVILEGE_SET&nbsp;</td>
          <td class="mdname" nowrap> <em>Privileges</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE <a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PGENERIC_MAPPING&nbsp;</td>
          <td class="mdname" nowrap> <em>GenericMapping</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>RemainingDesiredAccess</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/seurtl_8c-source.html#l00818">818</a> of file <a class="el" href="../../d5/d7/seurtl_8c-source.html">seurtl.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d8/d2/tokenopn_8c-source.html#l00458">NtOpenThreadToken()</a>, <a class="el" href="../../d9/d3/privileg_8c-source.html#l00231">NtPrivilegeCheck()</a>, <a class="el" href="../../d0/d3/tokenqry_8c-source.html#l00034">NtQueryInformationToken()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l03381">RtlMapGenericMask()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>00829                    :
00830 
00831     This routine implements privilege policy by examining <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bits in
00832     a DesiredAccess mask and adjusting them based on privilege checks.
00833 
00834     Currently, a request <span class="keywordflow">for</span> ACCESS_SYSTEM_SECURITY may <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> be satisfied
00835     by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller having <a class="code" href="../../d0/d5/se_8h.html#a85">SeSecurityPrivilege</a>.
00836 
00837     Note that <span class="keyword">this</span> routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> to be called when an object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being
00838     created.  When an object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being opened, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> expected that
00839     <a class="code" href="../../d0/d4/accessck_8c.html#a14">NtAccessCheck</a> will be called, and that routine will implement
00840     another policy <span class="keywordflow">for</span> substituting privileges <span class="keywordflow">for</span> DACL access.
00841 
00842 Arguments:
00843 
00844     DesiredAccess - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user's desired access mask
00845 
00846     Privileges - Supplies a pointer to an empty buffer in which will
00847         be returned a privilege set describing any privileges that were
00848         used to gain access.
00849 
00850         Note that <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not an optional parameter, that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>, enough
00851         room <span class="keywordflow">for</span> a single privilege must always be passed.
00852 
00853     Length - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Privileges parameter in bytes.
00854         If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> supplies length <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not adequate to store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entire
00855         privilege set, <span class="keyword">this</span> field will <span class="keywordflow">return</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d4/mrcf_8c.html#a3">minimum</a> length required.
00856 
00857     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> - (optionally) Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client on whose
00858         behalf <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being accessed.  If <span class="keyword">this</span> value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00859         specified as null, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> opened and
00860         examined to see <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an impersonation token.  If <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>,
00861         then <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> must be at SecurityIdentification level or higher.  If
00862         <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not an impersonation token, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation proceeds
00863         normally.
00864 
00865     GenericMapping - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> generic mapping associated with <span class="keyword">this</span>
00866         object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>.
00867 
00868     RemainingDesiredAccess - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DesiredAccess mask after any bits
00869         have been masked off.  If no access types could be granted, <span class="keyword">this</span>
00870         mask will be identical to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> one passed in.
00871 
00872 Return Value:
00873 
00874     STATUS_SUCCESS - The operation completed successfully.
00875 
00876     STATUS_BUFFER_TOO_SMALL - The passed buffer was not large enough
00877         to contain <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> information being returned.
00878 
00879     STATUS_BAD_IMPERSONATION_LEVEL - The caller or passed token was
00880         impersonating, but not at a <a class="code" href="../../d2/d3/fetypes_8h.html#a457a417">high</a> enough level.
00881 
00882 
00883 --*/
00884 
00885 {
00886     PRIVILEGE_SET RequiredPrivilege;
00887     BOOLEAN Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00888     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00889     ULONG PrivilegeCount = 0;
00890     HANDLE ThreadToken;
00891     BOOLEAN TokenPassed;
00892     TOKEN_STATISTICS ThreadTokenStatistics;
00893     ULONG ReturnLength;
00894     ULONG SizeRequired;
00895     ULONG PrivilegeNumber = 0;
00896 
00897 
00898     <span class="comment">//</span>
00899     <span class="comment">//  If the caller hasn't passed a token, call the kernel and get</span>
00900     <span class="comment">//  his impersonation token.  This call will fail if the caller is</span>
00901     <span class="comment">//  not impersonating a client, so if the caller is not</span>
00902     <span class="comment">//  impersonating someone, he'd better have passed in an explicit</span>
00903     <span class="comment">//  token.</span>
00904     <span class="comment">//</span>
00905 
00906     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( Token )) {
00907 
00908         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d3/tokenopn_8c.html#a3">NtOpenThreadToken</a>(
00909                      NtCurrentThread(),
00910                      TOKEN_QUERY,
00911                      TRUE,
00912                      &amp;ThreadToken
00913                      );
00914 
00915         TokenPassed = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00916 
00917         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00918             <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00919         }
00920 
00921     } <span class="keywordflow">else</span> {
00922 
00923         ThreadToken = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
00924         TokenPassed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00925     }
00926 
00927     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
00928                  ThreadToken,                  <span class="comment">// Handle</span>
00929                  TokenStatistics,              <span class="comment">// TokenInformationClass</span>
00930                  &amp;ThreadTokenStatistics,       <span class="comment">// TokenInformation</span>
00931                  <span class="keyword">sizeof</span>(TOKEN_STATISTICS),     <span class="comment">// TokenInformationLength</span>
00932                  &amp;ReturnLength                 <span class="comment">// ReturnLength</span>
00933                  );
00934 
00935     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) );
00936 
00937     <a class="code" href="../../d8/d6/sertl_8c.html#a70">RtlMapGenericMask</a>(
00938         &amp;DesiredAccess,
00939         GenericMapping
00940         );
00941 
00942     *RemainingDesiredAccess = DesiredAccess;
00943 
00944     <span class="keywordflow">if</span> ( DesiredAccess &amp; ACCESS_SYSTEM_SECURITY ) {
00945 
00946         RequiredPrivilege.PrivilegeCount = 1;
00947         RequiredPrivilege.Control = PRIVILEGE_SET_ALL_NECESSARY;
00948         RequiredPrivilege.Privilege[0].Luid = RtlConvertLongToLuid(SE_SECURITY_PRIVILEGE);
00949         RequiredPrivilege.Privilege[0].Attributes = 0;
00950 
00951         <span class="comment">//</span>
00952         <span class="comment">// NtPrivilegeCheck will make sure we are impersonating</span>
00953         <span class="comment">// properly.</span>
00954         <span class="comment">//</span>
00955 
00956         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d4/privileg_8c.html#a2">NtPrivilegeCheck</a>(
00957                      ThreadToken,
00958                      &amp;RequiredPrivilege,
00959                      &amp;Result
00960                      );
00961 
00962         <span class="keywordflow">if</span> ( (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> ( Status )) || (!Result) ) {
00963 
00964             <span class="keywordflow">if</span> (!TokenPassed) {
00965                 <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( ThreadToken );
00966             }
00967 
00968             <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00969                 <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00970             }
00971 
00972             <span class="keywordflow">if</span> ( !Result ) {
00973                 <span class="keywordflow">return</span>( STATUS_PRIVILEGE_NOT_HELD );
00974             }
00975 
00976         }
00977 
00978         <span class="comment">//</span>
00979         <span class="comment">// We have the required privilege, turn off the bit in</span>
00980         <span class="comment">// copy of the input mask and remember that we need to return</span>
00981         <span class="comment">// this privilege.</span>
00982         <span class="comment">//</span>
00983 
00984         *RemainingDesiredAccess &amp;= ~ACCESS_SYSTEM_SECURITY;
00985     }
00986 
00987     <span class="keywordflow">if</span> (!TokenPassed) {
00988         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( ThreadToken );
00989     }
00990 
00991     SizeRequired = <span class="keyword">sizeof</span>(PRIVILEGE_SET);
00992 
00993     <span class="keywordflow">if</span> ( SizeRequired &gt; *Length ) {
00994         *Length = SizeRequired;
00995         <span class="keywordflow">return</span>( STATUS_BUFFER_TOO_SMALL );
00996     }
00997 
00998     <span class="keywordflow">if</span> (Result) {
00999 
01000         Privileges-&gt;PrivilegeCount = 1;
01001         Privileges-&gt;Control = 0;
01002         Privileges-&gt;Privilege[PrivilegeNumber].Luid = RtlConvertLongToLuid(SE_SECURITY_PRIVILEGE);
01003         Privileges-&gt;Privilege[PrivilegeNumber].Attributes = SE_PRIVILEGE_USED_FOR_ACCESS;
01004 
01005     } <span class="keywordflow">else</span> {
01006 
01007         Privileges-&gt;PrivilegeCount = 0;
01008         Privileges-&gt;Control = 0;
01009         Privileges-&gt;Privilege[PrivilegeNumber].Luid = RtlConvertLongToLuid(0);
01010         Privileges-&gt;Privilege[PrivilegeNumber].Attributes = 0;
01011 
01012     }
01013 
01014     <span class="keywordflow">return</span>( STATUS_SUCCESS );
01015 
01016 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="seurtl.c::RtlNewSecurityObject" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlNewSecurityObject           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSECURITY_DESCRIPTOR ParentDescriptor&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_DESCRIPTOR CreatorDescriptor&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PSECURITY_DESCRIPTOR *&nbsp;</td>
          <td class="mdname" nowrap> <em>NewDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>IsDirectoryObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Token</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PGENERIC_MAPPING&nbsp;</td>
          <td class="mdname" nowrap> <em>GenericMapping</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/seurtl_8c-source.html#l00280">280</a> of file <a class="el" href="../../d5/d7/seurtl_8c-source.html">seurtl.c</a>.
<p>
References <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l09057">RtlpNewSecurityObject()</a>, and <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>.
<p>
Referenced by <a class="el" href="../../d0/d4/edithive_8c-source.html#l00988">EhpAttachSecurity()</a>, <a class="el" href="../../d5/d7/seurtl_8c-source.html#l01624">RtlCreateUserSecurityObject()</a>, and <a class="el" href="../../d5/d7/seurtl_8c-source.html#l00680">RtlNewInstanceSecurityObject()</a>.
<p>
<pre class="fragment"><div>00290                    :
00291 
00292     See <a class="code" href="../../d8/d6/sertl_8c.html#a76">RtlpNewSecurityObject</a>.
00293 
00294                               - - <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a> - -
00295 
00296     This service <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keywordflow">for</span> use by <span class="keyword">protected</span> subsystems that project their own
00297     <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of object.  This service <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> explicitly not <span class="keywordflow">for</span> use by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00298     executive <span class="keywordflow">for</span> executive objects and must not be called from kernel
00299     mode.
00300 
00301 Arguments:
00302 
00303     See <a class="code" href="../../d8/d6/sertl_8c.html#a76">RtlpNewSecurityObject</a>.
00304 
00305 Return Value:
00306 
00307     See <a class="code" href="../../d8/d6/sertl_8c.html#a76">RtlpNewSecurityObject</a>.
00308 
00309 --*/
00310 {
00311 
00312     <span class="comment">//</span>
00313     <span class="comment">// Simple call the newer RtlpNewSecurityObject</span>
00314     <span class="comment">//</span>
00315 
00316     <span class="keywordflow">return</span> <a class="code" href="../../d8/d6/sertl_8c.html#a76">RtlpNewSecurityObject</a> (
00317                 ParentDescriptor,
00318                 CreatorDescriptor,
00319                 NewDescriptor,
00320                 NULL,   <span class="comment">// No ObjectType</span>
00321                 IsDirectoryObject,
00322                 0,      <span class="comment">// No Automatic inheritance</span>
00323                 Token,
00324                 GenericMapping );
00325 
00326 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="seurtl.c::RtlNewSecurityObjectEx" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlNewSecurityObjectEx           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSECURITY_DESCRIPTOR ParentDescriptor&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_DESCRIPTOR CreatorDescriptor&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PSECURITY_DESCRIPTOR *&nbsp;</td>
          <td class="mdname" nowrap> <em>NewDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN GUID *ObjectType&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>IsDirectoryObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AutoInheritFlags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE <a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PGENERIC_MAPPING&nbsp;</td>
          <td class="mdname" nowrap> <em>GenericMapping</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/seurtl_8c-source.html#l00226">226</a> of file <a class="el" href="../../d5/d7/seurtl_8c-source.html">seurtl.c</a>.
<p>
References <a class="el" href="../../d9/d5/sertl_8c-source.html#l09057">RtlpNewSecurityObject()</a>, and <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>.
<p>
<pre class="fragment"><div>00238                    :
00239 
00240     See <a class="code" href="../../d8/d6/sertl_8c.html#a76">RtlpNewSecurityObject</a>.
00241 
00242                               - - <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a> - -
00243 
00244     This service <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keywordflow">for</span> use by <span class="keyword">protected</span> subsystems that project their own
00245     <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of object.  This service <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> explicitly not <span class="keywordflow">for</span> use by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00246     executive <span class="keywordflow">for</span> executive objects and must not be called from kernel
00247     mode.
00248 
00249 Arguments:
00250 
00251     See <a class="code" href="../../d8/d6/sertl_8c.html#a76">RtlpNewSecurityObject</a>.
00252 
00253 Return Value:
00254 
00255     See <a class="code" href="../../d8/d6/sertl_8c.html#a76">RtlpNewSecurityObject</a>.
00256 
00257 --*/
00258 {
00259 
00260     <span class="comment">//</span>
00261     <span class="comment">// Simple call the newer RtlpNewSecurityObject</span>
00262     <span class="comment">//</span>
00263 
00264     <span class="keywordflow">return</span> <a class="code" href="../../d8/d6/sertl_8c.html#a76">RtlpNewSecurityObject</a> (
00265                 ParentDescriptor,
00266                 CreatorDescriptor,
00267                 NewDescriptor,
00268                 ObjectType,
00269                 IsDirectoryObject,
00270                 AutoInheritFlags,
00271                 Token,
00272                 GenericMapping );
00273 
00274 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="seurtl.c::RtlpInitializeAllowedAce" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlpInitializeAllowedAce           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PACCESS_ALLOWED_ACE&nbsp;</td>
          <td class="mdname" nowrap> <em>AllowedAce</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AceSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN UCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>InheritFlags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN UCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>AceFlags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>Mask</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>AllowedSid</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/seurtl_8c-source.html#l01111">1111</a> of file <a class="el" href="../../d5/d7/seurtl_8c-source.html">seurtl.c</a>.
<p>
References <a class="el" href="../../d9/d5/sertl_8c-source.html#l01380">RtlCopySid()</a>, and <a class="el" href="../../d9/d5/sertl_8c-source.html#l01350">RtlLengthSid()</a>.
<p>
Referenced by <a class="el" href="../../d5/d7/seurtl_8c-source.html#l01260">RtlCreateAndSetSD()</a>.
<p>
<pre class="fragment"><div>01121                    :
01122 
01123     This function assigns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified ACE values into an allowed <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> ACE.
01124 
01125 Arguments:
01126 
01127     AllowedAce - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACE that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> initialized.
01128 
01129     AceSize - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACE in bytes.
01130 
01131     InheritFlags - Supplies ACE inherit flags.
01132 
01133     AceFlags - Supplies ACE <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> specific <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> flags.
01134 
01135     Mask - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allowed access masks.
01136 
01137     AllowedSid - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID of user/group which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allowed
01138         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified access.
01139 
01140 Return Value:
01141 
01142     Returns status from <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>.
01143 
01144 --*/
01145 {
01146     AllowedAce-&gt;Header.AceType = ACCESS_ALLOWED_ACE_TYPE;
01147     AllowedAce-&gt;Header.AceSize = AceSize;
01148     AllowedAce-&gt;Header.AceFlags = AceFlags | InheritFlags;
01149 
01150     AllowedAce-&gt;Mask = Mask;
01151 
01152     <span class="keywordflow">return</span> <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>(
01153                <a class="code" href="../../d8/d6/sertl_8c.html#a45">RtlLengthSid</a>(AllowedSid),
01154                &amp;(AllowedAce-&gt;SidStart),
01155                AllowedSid
01156                );
01157 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="seurtl.c::RtlpInitializeAuditAce" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlpInitializeAuditAce           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PACCESS_ALLOWED_ACE&nbsp;</td>
          <td class="mdname" nowrap> <em>AuditAce</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AceSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN UCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>InheritFlags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN UCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>AceFlags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>Mask</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>AuditSid</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/seurtl_8c-source.html#l01211">1211</a> of file <a class="el" href="../../d5/d7/seurtl_8c-source.html">seurtl.c</a>.
<p>
References <a class="el" href="../../d9/d5/sertl_8c-source.html#l01380">RtlCopySid()</a>, and <a class="el" href="../../d9/d5/sertl_8c-source.html#l01350">RtlLengthSid()</a>.
<p>
Referenced by <a class="el" href="../../d5/d7/seurtl_8c-source.html#l01260">RtlCreateAndSetSD()</a>.
<p>
<pre class="fragment"><div>01221                    :
01222 
01223     This function assigns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified ACE values into an audit <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> ACE.
01224 
01225 Arguments:
01226 
01227     AuditAce - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACE that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> initialized.
01228 
01229     AceSize - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACE in bytes.
01230 
01231     InheritFlags - Supplies ACE inherit flags.
01232 
01233     AceFlags - Supplies ACE <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> specific <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> flags.
01234 
01235     Mask - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allowed access masks.
01236 
01237     AuditSid - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID of user/group which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be
01238         audited.
01239 
01240 Return Value:
01241 
01242     Returns status from <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>.
01243 
01244 --*/
01245 {
01246     AuditAce-&gt;Header.AceType = SYSTEM_AUDIT_ACE_TYPE;
01247     AuditAce-&gt;Header.AceSize = AceSize;
01248     AuditAce-&gt;Header.AceFlags = AceFlags | InheritFlags;
01249 
01250     AuditAce-&gt;Mask = Mask;
01251 
01252     <span class="keywordflow">return</span> <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>(
01253                <a class="code" href="../../d8/d6/sertl_8c.html#a45">RtlLengthSid</a>(AuditSid),
01254                &amp;(AuditAce-&gt;SidStart),
01255                AuditSid
01256                );
01257 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="seurtl.c::RtlpInitializeDeniedAce" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlpInitializeDeniedAce           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PACCESS_DENIED_ACE&nbsp;</td>
          <td class="mdname" nowrap> <em>DeniedAce</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AceSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN UCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>InheritFlags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN UCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>AceFlags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>Mask</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>DeniedSid</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/seurtl_8c-source.html#l01161">1161</a> of file <a class="el" href="../../d5/d7/seurtl_8c-source.html">seurtl.c</a>.
<p>
References <a class="el" href="../../d9/d5/sertl_8c-source.html#l01380">RtlCopySid()</a>, and <a class="el" href="../../d9/d5/sertl_8c-source.html#l01350">RtlLengthSid()</a>.
<p>
Referenced by <a class="el" href="../../d5/d7/seurtl_8c-source.html#l01260">RtlCreateAndSetSD()</a>.
<p>
<pre class="fragment"><div>01171                    :
01172 
01173     This function assigns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified ACE values into a denied <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> ACE.
01174 
01175 Arguments:
01176 
01177     DeniedAce - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACE that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> initialized.
01178 
01179     AceSize - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ACE in bytes.
01180 
01181     InheritFlags - Supplies ACE inherit flags.
01182 
01183     AceFlags - Supplies ACE <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> specific <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> flags.
01184 
01185     Mask - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> denied access masks.
01186 
01187     AllowedSid - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID of user/group which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> denied
01188         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified access.
01189 
01190 Return Value:
01191 
01192     Returns status from <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>.
01193 
01194 --*/
01195 {
01196     DeniedAce-&gt;Header.AceType = ACCESS_DENIED_ACE_TYPE;
01197     DeniedAce-&gt;Header.AceSize = AceSize;
01198     DeniedAce-&gt;Header.AceFlags = AceFlags | InheritFlags;
01199 
01200     DeniedAce-&gt;Mask = Mask;
01201 
01202     <span class="keywordflow">return</span> <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>(
01203                <a class="code" href="../../d8/d6/sertl_8c.html#a45">RtlLengthSid</a>(DeniedSid),
01204                &amp;(DeniedAce-&gt;SidStart),
01205                DeniedSid
01206                );
01207 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="seurtl.c::RtlQuerySecurityObject" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlQuerySecurityObject           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SECURITY_INFORMATION&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>ResultantDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>DescriptorLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ReturnLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/seurtl_8c-source.html#l00418">418</a> of file <a class="el" href="../../d5/d7/seurtl_8c-source.html">seurtl.c</a>.
<p>
References <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00161">Dacl</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00160">Group</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00159">Owner</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01945">RtlCreateSecurityDescriptor()</a>, and <a class="el" href="../../d1/d4/se_8h-source.html#l00540">SeLengthSid</a>.
<p>
<pre class="fragment"><div>00428                    :
00429 
00430     Query information from a <span class="keyword">protected</span> server object's existing security
00431     descriptor.
00432 
00433     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a>, called <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> from user mode, <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to retrieve
00434     information from a security descriptor on an existing <span class="keyword">protected</span>
00435     server's object.  All access checking <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> expected to be done before
00436     calling <span class="keyword">this</span> routine.  This includes checking <span class="keywordflow">for</span> READ_CONTROL, and
00437     privilege to read a system ACL as appropriate.
00438 
00439                           - - <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a> - -
00440 
00441     This service <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keywordflow">for</span> use by <span class="keyword">protected</span> subsystems that project their own
00442     <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of object.  This service <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> explicitly not <span class="keywordflow">for</span> use by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00443     executive <span class="keywordflow">for</span> executive objects and must not be called from kernel
00444     mode.
00445 
00446 
00447 Arguments:
00448 
00449     ObjectDescriptor - Points to a pointer to a security descriptor to be
00450         queried.
00451 
00452     SecurityInformation - Identifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security information being
00453         requested.
00454 
00455     ResultantDescriptor - Points to buffer to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resultant
00456         security descriptor.  The resultant security descriptor will
00457         contain all information requested by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SecurityInformation
00458         parameter.
00459 
00460     DescriptorLength - Is an <span class="keywordtype">unsigned</span> integer which indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length,
00461         in bytes, of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer provided to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resultant
00462         descriptor.
00463 
00464     ReturnLength - Receives an <span class="keywordtype">unsigned</span> integer indicating <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> actual
00465         number of bytes needed in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ResultantDescriptor to store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00466         requested information.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value returned <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> greater than <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00467         value passed via <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DescriptorLength parameter, then
00468         STATUS_BUFFER_TOO_SMALL <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned and no information <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00469 
00470 
00471 Return Value:
00472 
00473     STATUS_SUCCESS - The operation was successful.
00474 
00475     STATUS_BUFFER_TOO_SMALL - The buffer provided to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested
00476         information was not large enough to hold <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> information.  No
00477         information has been returned.
00478 
00479     STATUS_BAD_DESCRIPTOR_FORMAT - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> provided object's security
00480         descriptor was not in <span class="keyword">self</span>-relative <a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a>.
00481 
00482 --*/
00483 
00484 {
00485 
00486     PSID <a class="code" href="../../d6/d0/ctaccess_8c.html#a54">Group</a>;
00487     PSID <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>;
00488     PACL <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>;
00489     PACL Sacl;
00490 
00491     ULONG GroupSize = 0;
00492     ULONG DaclSize = 0;
00493     ULONG SaclSize = 0;
00494     ULONG OwnerSize = 0;
00495 
00496     PCHAR Field;
00497     PCHAR Base;
00498 
00499 
00500     PISECURITY_DESCRIPTOR IObjectDescriptor;
00501     PISECURITY_DESCRIPTOR_RELATIVE IResultantDescriptor;
00502 
00503 
00504     IResultantDescriptor = (PISECURITY_DESCRIPTOR_RELATIVE)ResultantDescriptor;
00505     IObjectDescriptor = (PISECURITY_DESCRIPTOR)ObjectDescriptor;
00506 
00507     <span class="comment">//</span>
00508     <span class="comment">// For each item specified in the SecurityInformation, extract it</span>
00509     <span class="comment">// and get it to the point where it can be copied into a new</span>
00510     <span class="comment">// descriptor.</span>
00511     <span class="comment">//</span>
00512 
00513     <span class="keywordflow">if</span> (SecurityInformation &amp; GROUP_SECURITY_INFORMATION) {
00514 
00515         <a class="code" href="../../d6/d0/ctaccess_8c.html#a54">Group</a> = RtlpGroupAddrSecurityDescriptor(IObjectDescriptor);
00516         GroupSize = LongAlignSize(<a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(Group));
00517     }
00518 
00519     <span class="keywordflow">if</span> (SecurityInformation &amp; DACL_SECURITY_INFORMATION) {
00520 
00521         <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a> = RtlpDaclAddrSecurityDescriptor( IObjectDescriptor );
00522 
00523         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00524             DaclSize = LongAlignSize(<a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>-&gt;AclSize);
00525         }
00526     }
00527 
00528     <span class="keywordflow">if</span> (SecurityInformation &amp; SACL_SECURITY_INFORMATION) {
00529 
00530         Sacl = RtlpSaclAddrSecurityDescriptor( IObjectDescriptor );
00531 
00532         <span class="keywordflow">if</span> (Sacl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00533             SaclSize = LongAlignSize(Sacl-&gt;AclSize);
00534         }
00535 
00536     }
00537 
00538     <span class="keywordflow">if</span> (SecurityInformation &amp; OWNER_SECURITY_INFORMATION) {
00539 
00540         <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a> = RtlpOwnerAddrSecurityDescriptor ( IObjectDescriptor );
00541         OwnerSize = LongAlignSize(<a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(Owner));
00542     }
00543 
00544     *ReturnLength = <span class="keyword">sizeof</span>( SECURITY_DESCRIPTOR_RELATIVE ) +
00545                     GroupSize +
00546                     DaclSize  +
00547                     SaclSize  +
00548                     OwnerSize;
00549 
00550     <span class="keywordflow">if</span> (*ReturnLength &gt; DescriptorLength) {
00551         <span class="keywordflow">return</span>( STATUS_BUFFER_TOO_SMALL );
00552     }
00553 
00554     <a class="code" href="../../d8/d6/sertl_8c.html#a53">RtlCreateSecurityDescriptor</a>(
00555         IResultantDescriptor,
00556         SECURITY_DESCRIPTOR_REVISION
00557         );
00558 
00559     RtlpSetControlBits( IResultantDescriptor, SE_SELF_RELATIVE );
00560 
00561     Base = (PCHAR)(IResultantDescriptor);
00562     Field =  Base + (ULONG)<span class="keyword">sizeof</span>(SECURITY_DESCRIPTOR_RELATIVE);
00563 
00564     <span class="keywordflow">if</span> (SecurityInformation &amp; SACL_SECURITY_INFORMATION) {
00565 
00566         <span class="keywordflow">if</span> (SaclSize &gt; 0) {
00567             RtlMoveMemory( Field, Sacl, SaclSize );
00568             IResultantDescriptor-&gt;Sacl = RtlPointerToOffset(Base,Field);
00569             Field += SaclSize;
00570         }
00571 
00572         RtlpPropagateControlBits(
00573             IResultantDescriptor,
00574             IObjectDescriptor,
00575             SE_SACL_PRESENT | SE_SACL_DEFAULTED
00576             );
00577     }
00578 
00579     <span class="keywordflow">if</span> (SecurityInformation &amp; DACL_SECURITY_INFORMATION) {
00580 
00581         <span class="keywordflow">if</span> (DaclSize &gt; 0) {
00582             RtlMoveMemory( Field, Dacl, DaclSize );
00583             IResultantDescriptor-&gt;Dacl = RtlPointerToOffset(Base,Field);
00584             Field += DaclSize;
00585         }
00586 
00587         RtlpPropagateControlBits(
00588             IResultantDescriptor,
00589             IObjectDescriptor,
00590             SE_DACL_PRESENT | SE_DACL_DEFAULTED
00591             );
00592     }
00593 
00594     <span class="keywordflow">if</span> (SecurityInformation &amp; OWNER_SECURITY_INFORMATION) {
00595 
00596         <span class="keywordflow">if</span> (OwnerSize &gt; 0) {
00597             RtlMoveMemory( Field, Owner, OwnerSize );
00598             IResultantDescriptor-&gt;Owner = RtlPointerToOffset(Base,Field);
00599             Field += OwnerSize;
00600         }
00601 
00602         RtlpPropagateControlBits(
00603             IResultantDescriptor,
00604             IObjectDescriptor,
00605             SE_OWNER_DEFAULTED
00606             );
00607 
00608     }
00609 
00610     <span class="keywordflow">if</span> (SecurityInformation &amp; GROUP_SECURITY_INFORMATION) {
00611 
00612         <span class="keywordflow">if</span> (GroupSize &gt; 0) {
00613             RtlMoveMemory( Field, Group, GroupSize );
00614             IResultantDescriptor-&gt;Group = RtlPointerToOffset(Base,Field);
00615         }
00616 
00617         RtlpPropagateControlBits(
00618             IResultantDescriptor,
00619             IObjectDescriptor,
00620             SE_GROUP_DEFAULTED
00621             );
00622     }
00623 
00624     <span class="keywordflow">return</span>( STATUS_SUCCESS );
00625 
00626 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="seurtl.c::RtlSetSecurityObject" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlSetSecurityObject           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN SECURITY_INFORMATION&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>ModificationDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PSECURITY_DESCRIPTOR *&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectsSecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PGENERIC_MAPPING&nbsp;</td>
          <td class="mdname" nowrap> <em>GenericMapping</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE <a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/seurtl_8c-source.html#l00331">331</a> of file <a class="el" href="../../d5/d7/seurtl_8c-source.html">seurtl.c</a>.
<p>
References <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l10195">RtlpSetSecurityObject()</a>, and <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>.
<p>
<pre class="fragment"><div>00340                    :
00341 
00342     See <a class="code" href="../../d8/d6/sertl_8c.html#a77">RtlpSetSecurityObject</a>.
00343 
00344 Arguments:
00345 
00346     See <a class="code" href="../../d8/d6/sertl_8c.html#a77">RtlpSetSecurityObject</a>.
00347 
00348 Return Value:
00349 
00350     See <a class="code" href="../../d8/d6/sertl_8c.html#a77">RtlpSetSecurityObject</a>.
00351 
00352 --*/
00353 
00354 {
00355 
00356     <span class="comment">//</span>
00357     <span class="comment">// Simply call RtlpSetSecurityObject specifying no auto inheritance.</span>
00358     <span class="comment">//</span>
00359 
00360     <span class="keywordflow">return</span> <a class="code" href="../../d8/d6/sertl_8c.html#a77">RtlpSetSecurityObject</a>( NULL,
00361                                   SecurityInformation,
00362                                   ModificationDescriptor,
00363                                   ObjectsSecurityDescriptor,
00364                                   0,   <span class="comment">// No AutoInheritance</span>
00365                                   PagedPool,
00366                                   GenericMapping,
00367                                   Token );
00368 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="seurtl.c::RtlSetSecurityObjectEx" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlSetSecurityObjectEx           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN SECURITY_INFORMATION&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>ModificationDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PSECURITY_DESCRIPTOR *&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectsSecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AutoInheritFlags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PGENERIC_MAPPING&nbsp;</td>
          <td class="mdname" nowrap> <em>GenericMapping</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE <a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/seurtl_8c-source.html#l00373">373</a> of file <a class="el" href="../../d5/d7/seurtl_8c-source.html">seurtl.c</a>.
<p>
References <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l10195">RtlpSetSecurityObject()</a>, and <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>.
<p>
<pre class="fragment"><div>00383                    :
00384 
00385     See <a class="code" href="../../d8/d6/sertl_8c.html#a77">RtlpSetSecurityObject</a>.
00386 
00387 Arguments:
00388 
00389     See <a class="code" href="../../d8/d6/sertl_8c.html#a77">RtlpSetSecurityObject</a>.
00390 
00391 Return Value:
00392 
00393     See <a class="code" href="../../d8/d6/sertl_8c.html#a77">RtlpSetSecurityObject</a>.
00394 
00395 --*/
00396 
00397 {
00398 
00399     <span class="comment">//</span>
00400     <span class="comment">// Simply call RtlpSetSecurityObject specifying no auto inheritance.</span>
00401     <span class="comment">//</span>
00402 
00403     <span class="keywordflow">return</span> <a class="code" href="../../d8/d6/sertl_8c.html#a77">RtlpSetSecurityObject</a>( NULL,
00404                                   SecurityInformation,
00405                                   ModificationDescriptor,
00406                                   ObjectsSecurityDescriptor,
00407                                   AutoInheritFlags,
00408                                   PagedPool,
00409                                   GenericMapping,
00410                                   Token );
00411 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:38 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
