<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: syscmd.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>syscmd.c File Reference</h1><code>#include "<a class="el" href="../../d1/d3/w32_2ntuser_2kernel_2precomp_8h-source.html">precomp.h</a>"</code><br>

<p>
<a href="../../d5/d7/syscmd_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>void&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d8/syscmd_8c.html#a0">xxxHandleNCMouseGuys</a> (<a class="el" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, UINT message, int htArea, LPARAM lParam)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>void&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d8/syscmd_8c.html#a1">StartScreenSaver</a> (BOOL bOnlyIfSecure)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>void&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d8/syscmd_8c.html#a2">xxxSysCommand</a> (<a class="el" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> cmd, LPARAM lParam)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d8/syscmd_8c.html#a3">_RegisterTasklist</a> (<a class="el" href="../../d6/d9/structtagWND.html">PWND</a> pwndTasklist)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a3" doxytag="syscmd.c::_RegisterTasklist" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL _RegisterTasklist           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pwndTasklist</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/syscmd_8c-source.html#l00583">583</a> of file <a class="el" href="../../d5/d7/syscmd_8c-source.html">syscmd.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01547">GETPTI</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00219">ghwndSwitch</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00088">gptiTasklist</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01515">HWq</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02832">TIF_DONTATTACHQUEUE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l03234">NtUserRegisterTasklist()</a>.
<p>
<pre class="fragment"><div>00585 {
00586 <span class="preprocessor">#ifdef LATER</span>
00587 <span class="preprocessor"></span>    <span class="comment">//</span>
00588     <span class="comment">// JimA - ??? Why do this?</span>
00589     <span class="comment">//</span>
00590     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
00591 
00592     Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00593     pRitCSRThread-&gt;ThreadHandle = Thread-&gt;ThreadHandle;
00594 <span class="preprocessor">#endif</span>
00595 <span class="preprocessor"></span>
00596     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a22">gptiTasklist</a> = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndTasklist);
00597     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a91">ghwndSwitch</a> = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwndTasklist);
00598 
00599     <span class="comment">/*</span>
00600 <span class="comment">     * Don't allow an app to call AttachThreadInput() on task man -</span>
00601 <span class="comment">     * we want taskman to be unsynchronized at all times (so the user</span>
00602 <span class="comment">     * can bring it up and kill other apps).</span>
00603 <span class="comment">     */</span>
00604     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndTasklist)-&gt;TIF_flags |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a801">TIF_DONTATTACHQUEUE</a>;
00605 
00606     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00607 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="syscmd.c::StartScreenSaver" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> void StartScreenSaver           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">BOOL&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>bOnlyIfSecure</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/syscmd_8c-source.html#l00165">165</a> of file <a class="el" href="../../d5/d7/syscmd_8c-source.html">syscmd.c</a>.
<p>
References <a class="el" href="../../d6/d2/ntuser_2kernel_2input_8c-source.html#l00981">_PostMessage()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06619">tagPOWERSTATE::fInProgress</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00901">gPowerState</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00423">gppiScreenSaver</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00071">gspwndLogonNotify</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/ntuser_2kernel_2input_8c-source.html#l05120">IdleTimerProc()</a>, and <a class="el" href="../../d5/d7/syscmd_8c-source.html#l00193">xxxSysCommand()</a>.
<p>
<pre class="fragment"><div>00167 {
00168     <span class="comment">/*</span>
00169 <span class="comment">     * If a screen saver is already running or we're in the midst of powering</span>
00170 <span class="comment">     * down the machine, ignore this request.</span>
00171 <span class="comment">     */</span>
00172     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a158">gppiScreenSaver</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a313">gPowerState</a>.<a class="code" href="../../d6/d3/structtagPOWERSTATE.html#o0">fInProgress</a>)
00173         <span class="keywordflow">return</span>;
00174 
00175     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a17">gspwndLogonNotify</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00176         <span class="comment">/*</span>
00177 <span class="comment">         * Let the logon process take care of the screen saver</span>
00178 <span class="comment">         */</span>
00179         <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(gspwndLogonNotify,
00180                 WM_LOGONNOTIFY, LOGON_INPUT_TIMEOUT, bOnlyIfSecure);
00181     }
00182 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="syscmd.c::xxxHandleNCMouseGuys" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> void xxxHandleNCMouseGuys           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pwnd</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>UINT&nbsp;</td>
          <td class="mdname" nowrap> <em>message</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>htArea</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPARAM&nbsp;</td>
          <td class="mdname" nowrap> <em>lParam</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/syscmd_8c-source.html#l00023">23</a> of file <a class="el" href="../../d5/d7/syscmd_8c-source.html">syscmd.c</a>.
<p>
References <a class="el" href="../../d7/d8/rtl_2wow_8c-source.html#l00583">_GetMenuState()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02328">AW_USE2</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00361">CheckLock</a>, <a class="el" href="../../d3/d7/rtl_2winmgr_8c-source.html#l00817">GetTopLevelWindow()</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02555">TestWF</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00362">ThreadLock</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00366">ThreadUnlock</a>, <a class="el" href="../../d0/d5/ndismain_8h-source.html#l00026">UINT</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02400">WFMAXBOX</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02415">WFMAXIMIZED</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02420">WFMINIMIZED</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02405">WFSYSMENU</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l02060">xxxActivateWindow()</a>, <a class="el" href="../../d8/d6/menuc_8c-source.html#l00270">xxxGetSysMenuHandle()</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00688">xxxSendMessage()</a>, and <a class="el" href="../../d6/d2/mnsys_8c-source.html#l00232">xxxSetSysMenu()</a>.
<p>
Referenced by <a class="el" href="../../d9/d2/dwp_8c-source.html#l00601">xxxDWP_NCMouse()</a>.
<p>
<pre class="fragment"><div>00028 {
00029     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> syscmd;
00030     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndT;
00031     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndT;
00032 
00033     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00034 
00035     syscmd = 0xFFFF;
00036 
00037     <span class="keywordflow">switch</span> (htArea) {
00038 
00039     <span class="keywordflow">case</span> HTCAPTION:
00040         <span class="keywordflow">switch</span> (message) {
00041 
00042         <span class="keywordflow">case</span> WM_NCLBUTTONDBLCLK:
00043             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WFMINIMIZED) || <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WFMAXIMIZED)) {
00044                 syscmd = SC_RESTORE;
00045             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WFMAXBOX)) {
00046                 syscmd = SC_MAXIMIZE;
00047             }
00048             <span class="keywordflow">break</span>;
00049 
00050         <span class="keywordflow">case</span> WM_NCLBUTTONDOWN:
00051             pwndT = <a class="code" href="../../d2/d8/rtl_2winmgr_8c.html#a11">GetTopLevelWindow</a>(pwnd);
00052             <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pwndT, &amp;tlpwndT);
00053             <a class="code" href="../../d4/d1/userk_8h.html#a1230">xxxActivateWindow</a>(pwndT, AW_USE2);
00054             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT);
00055             syscmd = SC_MOVE;
00056             <span class="keywordflow">break</span>;
00057         }
00058         <span class="keywordflow">break</span>;
00059 
00060     <span class="keywordflow">case</span> HTSYSMENU:
00061     <span class="keywordflow">case</span> HTMENU:
00062     <span class="keywordflow">case</span> HTHSCROLL:
00063     <span class="keywordflow">case</span> HTVSCROLL:
00064         <span class="keywordflow">if</span> (message == WM_NCLBUTTONDOWN || message == WM_NCLBUTTONDBLCLK) {
00065             <span class="keywordflow">switch</span> (htArea) {
00066             <span class="keywordflow">case</span> HTSYSMENU:
00067                 <span class="keywordflow">if</span> (message == WM_NCLBUTTONDBLCLK) {
00068                     syscmd = SC_CLOSE;
00069                     <span class="keywordflow">break</span>;
00070                 }
00071 
00072             <span class="comment">/*</span>
00073 <span class="comment">             *** FALL THRU **</span>
00074 <span class="comment">             */</span>
00075 
00076             <span class="keywordflow">case</span> HTMENU:
00077                 syscmd = SC_MOUSEMENU;
00078                 <span class="keywordflow">break</span>;
00079 
00080             <span class="keywordflow">case</span> HTHSCROLL:
00081                 syscmd = SC_HSCROLL;
00082                 <span class="keywordflow">break</span>;
00083 
00084             <span class="keywordflow">case</span> HTVSCROLL:
00085                 syscmd = SC_VSCROLL;
00086                 <span class="keywordflow">break</span>;
00087             }
00088         }
00089         <span class="keywordflow">break</span>;
00090     }
00091 
00092     <span class="keywordflow">switch</span> (syscmd) {
00093 
00094     <span class="keywordflow">case</span> SC_MINIMIZE:
00095     <span class="keywordflow">case</span> SC_MAXIMIZE:
00096     <span class="keywordflow">case</span> SC_CLOSE:
00097 
00098         <span class="comment">/*</span>
00099 <span class="comment">         * Only do double click commands on an upclick.</span>
00100 <span class="comment">         * This code is very sensitive to changes from this state.</span>
00101 <span class="comment">         * Eat any mouse messages.</span>
00102 <span class="comment">         */</span>
00103 
00104         <span class="comment">/*</span>
00105 <span class="comment">         * Bug #152: WM_NCLBUTTONUP message missing from double click.</span>
00106 <span class="comment">         * This code was broken in Windows 3.x and the test for whether</span>
00107 <span class="comment">         * the mouse button was down always failed, so no mouse messages</span>
00108 <span class="comment">         * were ever eaten. We'll emulate this by not even doing the test.</span>
00109 <span class="comment">         *</span>
00110 <span class="comment">         *</span>
00111 <span class="comment">         * {</span>
00112 <span class="comment">         *     PQ pqCurrent;</span>
00113 <span class="comment">         *     MSG msg;</span>
00114 <span class="comment">         *</span>
00115 <span class="comment">         *     pqCurrent = PtiCurrent()-&gt;pq;</span>
00116 <span class="comment">         *     if (TestKeyStateDown(pqCurrent, VK_LBUTTON)) {</span>
00117 <span class="comment">         *         xxxCapture(PtiCurrent(), pwnd, WINDOW_CAPTURE);</span>
00118 <span class="comment">         *</span>
00119 <span class="comment">         *         while (TestKeyStateDown(pqCurrent, VK_LBUTTON)) {</span>
00120 <span class="comment">         *             if (!xxxPeekMessage(&amp;msg, NULL, WM_MOUSEFIRST, WM_MOUSELAST,</span>
00121 <span class="comment">         *                     PM_REMOVE)) {</span>
00122 <span class="comment">         *                 if (!xxxSleepThread(QS_MOUSE, 0, TRUE))</span>
00123 <span class="comment">         *                     break;</span>
00124 <span class="comment">         *             }</span>
00125 <span class="comment">         *         }</span>
00126 <span class="comment">         *</span>
00127 <span class="comment">         *         xxxReleaseCapture();</span>
00128 <span class="comment">         *</span>
00129 <span class="comment">         *     }</span>
00130 <span class="comment">         * }</span>
00131 <span class="comment">         *</span>
00132 <span class="comment">         */</span>
00133 
00134         <span class="comment">/*</span>
00135 <span class="comment">         ** FALL THRU **</span>
00136 <span class="comment">         */</span>
00137     <span class="keywordflow">case</span> SC_SIZE:
00138     <span class="keywordflow">case</span> SC_MOVE:
00139         <span class="comment">/*</span>
00140 <span class="comment">         * For SysCommands on system menu, don't do if menu item is</span>
00141 <span class="comment">         * disabled.</span>
00142 <span class="comment">         */</span>
00143         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WFSYSMENU)) {
00144             <a class="code" href="../../d4/d1/userk_8h.html#a1402">xxxSetSysMenu</a>(pwnd);
00145             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d9/rtl_2wow_8c.html#a11">_GetMenuState</a>(<a class="code" href="../../d4/d1/userk_8h.html#a1403">xxxGetSysMenuHandle</a>(pwnd), (syscmd &amp; 0xFFF0),
00146                     MF_BYCOMMAND) &amp; MFS_GRAYED) {
00147                 <span class="keywordflow">return</span>;
00148             }
00149         }
00150         <span class="keywordflow">break</span>;
00151     }
00152 
00153     <span class="keywordflow">if</span> (syscmd != 0xFFFF) {
00154         <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwnd, WM_SYSCOMMAND, syscmd | htArea, lParam);
00155     }
00156 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="syscmd.c::xxxSysCommand" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> void xxxSysCommand           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pwnd</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>cmd</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPARAM&nbsp;</td>
          <td class="mdname" nowrap> <em>lParam</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/syscmd_8c-source.html#l00193">193</a> of file <a class="el" href="../../d5/d7/syscmd_8c-source.html">syscmd.c</a>.
<p>
References <a class="el" href="../../d4/d8/client_2wow_8c-source.html#l00107">_GetDesktopWindow()</a>, <a class="el" href="../../d8/d8/keyboard_8c-source.html#l00027">_GetKeyState()</a>, <a class="el" href="../../d3/d7/rtl_2winmgr_8c-source.html#l00490">_GetLastActivePopup()</a>, <a class="el" href="../../d6/d2/ntuser_2kernel_2input_8c-source.html#l01205">_GetMessagePos()</a>, <a class="el" href="../../d6/d2/ntuser_2kernel_2input_8c-source.html#l00981">_PostMessage()</a>, <a class="el" href="../../d6/d2/ntuser_2kernel_2input_8c-source.html#l01123">_PostThreadMessage()</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00361">CheckLock</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03261">tagLASTINPUT::dwFlags</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l05831">FCallHookTray</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l05830">FDoTray</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06619">tagPOWERSTATE::fInProgress</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03210">tagMENUSTATE::fModelessMenu</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l05832">FPostTray</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03207">tagMENUSTATE::fUnderline</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01547">GETPTI</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00219">ghwndSwitch</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00198">glinp</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00464">gpDispInfo</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00901">gPowerState</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00099">gpqForeground</a>, <a class="el" href="../../d2/d7/clglobal_8c-source.html#l00051">gpsi</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00088">gptiTasklist</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00061">gspwndFullScreen</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00060">gspwndInternalCapture</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01827">tagWND::head</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01515">HWq</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l01266">IsHooked</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03269">LINP_LOWPOWER</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03270">LINP_POWEROFF</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03271">LINP_POWERTIMEOUTS</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06630">LOWPOWER_PHASE</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02756">MENUSYSMENU</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03201">tagMENUSTATE::pGlobalPopupMenu</a>, <a class="el" href="../../d5/d3/kernel_2msgbeep_8c-source.html#l00108">PlayEventSound()</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02095">tagDISPLAYINFO::pmdev</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06631">POWEROFF_PHASE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06629">POWERON_PHASE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03321">tagTHREADINFO::pq</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03262">tagLASTINPUT::ptiLastWoken</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03226">tagMENUSTATE::ptiMenuStateOwner</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06584">PUDF_ANIMATE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03828">PWND_TOP</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l03031">QF_CAPTURELOCKED</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00194">RevalidateHwnd</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l04826">SCROLL_DIRECT</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l04825">SCROLL_NORMAL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03109">tagQ::spwndCapture</a>, <a class="el" href="../../d5/d7/syscmd_8c-source.html#l00165">StartScreenSaver()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06608">TEST_PUDF</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02555">TestWF</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00362">ThreadLock</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00363">ThreadLockAlways</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00366">ThreadUnlock</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02827">TIF_16BIT</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03331">tagTHREADINFO::TIF_flags</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d0/d5/ndismain_8h-source.html#l00026">UINT</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01302">tagSERVERINFO::uiShellMsg</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l03569">USER_SOUND_MAXIMIZE</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l03568">USER_SOUND_MINIMIZE</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l03567">USER_SOUND_RESTOREDOWN</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l03566">USER_SOUND_RESTOREUP</a>, <a class="el" href="../../d5/d9/immcli_8h-source.html#l00120">ValidateHwnd</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02421">WFCHILD</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02418">WFDISABLED</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02415">WFMAXIMIZED</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02420">WFMINIMIZED</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02037">WHF_CBT</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l01246">xxxCallHook()</a>, <a class="el" href="../../d3/d9/kernel_2help_8c-source.html#l00073">xxxHelpLoop()</a>, <a class="el" href="../../d7/d0/dragdrop_8c-source.html#l00354">xxxIsDragging()</a>, <a class="el" href="../../d9/d7/fullscr_8c-source.html#l00166">xxxMakeWindowForegroundWithState()</a>, <a class="el" href="../../d5/d2/mnstate_8c-source.html#l00265">xxxMNEndMenuState()</a>, <a class="el" href="../../d1/d2/mnkey_8c-source.html#l00290">xxxMNKeyFilter()</a>, <a class="el" href="../../d2/d2/mnloop_8c-source.html#l00635">xxxMNLoop()</a>, <a class="el" href="../../d5/d2/mnstate_8c-source.html#l00540">xxxMNStartMenuState()</a>, <a class="el" href="../../d9/d2/movesize_8c-source.html#l01053">xxxMoveSize()</a>, <a class="el" href="../../d2/d2/tmswitch_8c-source.html#l02121">xxxOldNextWindow()</a>, <a class="el" href="../../d9/d3/sbctl_8c-source.html#l02196">xxxSBTrackInit()</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00688">xxxSendMessage()</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l01235">xxxSetForegroundWindow()</a>, <a class="el" href="../../d3/d7/swp_8c-source.html#l01468">xxxSetWindowPos()</a>, and <a class="el" href="../../d1/d8/showwin_8c-source.html#l00085">xxxShowWindow()</a>.
<p>
Referenced by <a class="el" href="../../d9/d2/dwp_8c-source.html#l01264">xxxDefWindowProc()</a>.
<p>
<pre class="fragment"><div>00197 {
00198     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>        htArea;
00199     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>        pwndSwitch;
00200     <a class="code" href="../../d4/d1/structtagMENUSTATE.html">PMENUSTATE</a>  pMenuState;
00201     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>          tlpwnd;
00202     POINT       pt;
00203     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>       dw;
00204     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>        pwndCapture;
00205     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti;
00206 
00207     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00208 
00209     htArea = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)(cmd &amp; 0x0F);
00210     cmd -= htArea;
00211 
00212     <span class="comment">/*</span>
00213 <span class="comment">     * Intense hack o' death.</span>
00214 <span class="comment">     */</span>
00215     <span class="keywordflow">if</span> (lParam == 0x00010000<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>)
00216         lParam = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00217 
00218     <span class="comment">/*</span>
00219 <span class="comment">     * If the system doesn't have capture (ie CLENT_CAPTURE_INTERNAL)</span>
00220 <span class="comment">     * do the sys command.  Also, do the sys command for the special case</span>
00221 <span class="comment">     * where the window receiving the sys command is a console window that</span>
00222 <span class="comment">     * is in full screen mode.  In this case we let the sys command through.</span>
00223 <span class="comment">     *</span>
00224 <span class="comment">     * Also if this a SC_SCREENSAVE then we handle it anyway and</span>
00225 <span class="comment">     * switching desktops will do the cancel.  SC_SCREENSAVER</span>
00226 <span class="comment">     * is special so we can start the screen saver even if we are in</span>
00227 <span class="comment">     * menu mode for security so NT bug 10975 Banker's Trust</span>
00228 <span class="comment">     */</span>
00229     pti = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd);
00230 
00231     <span class="comment">/*</span>
00232 <span class="comment">     * For 32bit apps (and apps on seperate queues), we need to check</span>
00233 <span class="comment">     * the capture in the queue.  Otherwise, on MDI child-destruction</span>
00234 <span class="comment">     * we would get the restore when they shouldn't.  This broke MSGOLF</span>
00235 <span class="comment">     * who during the restore, AV'd because they assumed this wouldn't</span>
00236 <span class="comment">     * happen. On 16bit shared apps, we want to check the internal</span>
00237 <span class="comment">     * capture.  Otherwise, when doing 16bit drag-and-drop, we would</span>
00238 <span class="comment">     * not restore the minimized window if we had a queue-capture-window.</span>
00239 <span class="comment">     */</span>
00240 
00241     <span class="comment">/*</span>
00242 <span class="comment">     * But... it is too broad a change to just check internal capture for all WoW apps. Some</span>
00243 <span class="comment">     * apps depend on bailing out when they have capture set. (Adobe Persuasion, NT bug 68794,</span>
00244 <span class="comment">     * for SC_MOVE).  So, let's restrict the hack to SC_RESTORE to keep Ole drag-and-drop working.</span>
00245 <span class="comment">     * See NT bug 6109. FritzS</span>
00246 <span class="comment">     */</span>
00247 
00248     pwndCapture = ((pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>) &amp;&amp; (cmd == SC_RESTORE)) ? <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a14">gspwndInternalCapture</a> :
00249                                                  pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o6">spwndCapture</a>;
00250 
00251     <span class="keywordflow">if</span> ((!pwndCapture &amp;&amp; !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WFDISABLED)) ||
00252         (pwnd == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a15">gspwndFullScreen</a>)                  ||
00253         (cmd == SC_SCREENSAVE)                      ||
00254         (cmd == SC_MONITORPOWER)                    ||
00255         (cmd == SC_TASKLIST)) {
00256 
00257         <span class="comment">/*</span>
00258 <span class="comment">         * Perform the sys command</span>
00259 <span class="comment">         */</span>
00260 
00261 <span class="preprocessor">#ifdef SYSMODALWINDOWS</span>
00262 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (gspwndSysModal != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00263             <span class="keywordflow">switch</span> (cmd) {
00264             <span class="keywordflow">case</span> SC_SIZE:
00265             <span class="keywordflow">case</span> SC_MOVE:
00266             <span class="keywordflow">case</span> SC_MINIMIZE:
00267             <span class="keywordflow">case</span> SC_MAXIMIZE:
00268             <span class="keywordflow">case</span> SC_NEXTWINDOW:
00269             <span class="keywordflow">case</span> SC_PREVWINDOW:
00270             <span class="keywordflow">case</span> SC_SCREENSAVE:
00271                 <span class="keywordflow">return</span>;
00272             }
00273         }
00274 <span class="preprocessor">#endif</span>
00275 <span class="preprocessor"></span>
00276         <span class="comment">/*</span>
00277 <span class="comment">         * Call the CBT hook asking if it's okay to do this command.</span>
00278 <span class="comment">         * If not, return from here.</span>
00279 <span class="comment">         */</span>
00280         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a208">IsHooked</a>(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>(), WHF_CBT) &amp;&amp; <a class="code" href="../../d4/d1/userk_8h.html#a1521">xxxCallHook</a>(HCBT_SYSCOMMAND,
00281                 (DWORD)cmd, (DWORD)lParam, WH_CBT)) {
00282             <span class="keywordflow">return</span>;
00283         }
00284 
00285         <span class="keywordflow">switch</span> (cmd) {
00286         <span class="keywordflow">case</span> SC_RESTORE:
00287             cmd = SW_RESTORE;
00288             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WFMINIMIZED) || !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WFMAXIMIZED))
00289                 <a class="code" href="../../d4/d1/userk_8h.html#a1731">PlayEventSound</a>(USER_SOUND_RESTOREUP);
00290             <span class="keywordflow">else</span>
00291                 <a class="code" href="../../d4/d1/userk_8h.html#a1731">PlayEventSound</a>(USER_SOUND_RESTOREDOWN);
00292             <span class="keywordflow">goto</span> MinMax;
00293 
00294 
00295         <span class="keywordflow">case</span> SC_MINIMIZE:
00296             cmd = SW_MINIMIZE;
00297 
00298             <span class="comment">/*</span>
00299 <span class="comment">             * Are we already minimized?</span>
00300 <span class="comment">             */</span>
00301             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WFMINIMIZED))
00302                 <span class="keywordflow">break</span>;
00303 
00304             <a class="code" href="../../d4/d1/userk_8h.html#a1731">PlayEventSound</a>(USER_SOUND_MINIMIZE);
00305 
00306             <span class="keywordflow">goto</span> MinMax;
00307         <span class="keywordflow">case</span> SC_MAXIMIZE:
00308             cmd = SW_SHOWMAXIMIZED;
00309 
00310             <span class="comment">/*</span>
00311 <span class="comment">             * Are we already maximized?</span>
00312 <span class="comment">             */</span>
00313             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WFMAXIMIZED))
00314                 <span class="keywordflow">break</span>;
00315 
00316             <a class="code" href="../../d4/d1/userk_8h.html#a1731">PlayEventSound</a>(USER_SOUND_MAXIMIZE);
00317 MinMax:
00318             <a class="code" href="../../d4/d1/userk_8h.html#a1607">xxxShowWindow</a>(pwnd, cmd | <a class="code" href="../../d4/d1/userk_8h.html#a657">TEST_PUDF</a>(PUDF_ANIMATE));
00319             <span class="keywordflow">return</span>;
00320 
00321         <span class="keywordflow">case</span> SC_SIZE:
00322             {
00323                 <a class="code" href="../../d4/d1/userk_8h.html#a1508">xxxMoveSize</a>(pwnd, htArea, <a class="code" href="../../d4/d1/userk_8h.html#a1639">_GetMessagePos</a>());
00324             }
00325             <span class="keywordflow">return</span>;
00326 
00327         <span class="keywordflow">case</span> SC_MOVE:
00328             <span class="comment">//</span>
00329             <span class="comment">// Don't enter movesize loop unless the user is actually</span>
00330             <span class="comment">// dragging from the caption.  Otherwise, put up the system</span>
00331             <span class="comment">// menu on a minimized window.</span>
00332             <span class="comment">//</span>
00333 
00334             <span class="comment">//</span>
00335             <span class="comment">// Are we dragging with the left mouse button?</span>
00336             <span class="comment">//</span>
00337             dw = <a class="code" href="../../d4/d1/userk_8h.html#a1639">_GetMessagePos</a>();
00338             POINTSTOPOINT( pt, MAKEPOINTS(dw));
00339             <span class="keywordflow">if</span> ( !htArea ||
00340                  <a class="code" href="../../d4/d1/userk_8h.html#a1313">xxxIsDragging</a>(pwnd, pt, WM_LBUTTONUP)) {
00341 
00342                 <span class="comment">/*</span>
00343 <span class="comment">                 * We are moving.  Enter move/size loop.</span>
00344 <span class="comment">                 */</span>
00345                 {
00346                     <a class="code" href="../../d4/d1/userk_8h.html#a1508">xxxMoveSize</a>(pwnd, (htArea == 0) ? WMSZ_KEYMOVE : WMSZ_MOVE, dw);
00347                 }
00348             } <span class="keywordflow">else</span> {
00349 
00350                 <span class="comment">/*</span>
00351 <span class="comment">                 * Activate our window, just like we would have in</span>
00352 <span class="comment">                 * MoveSize().</span>
00353 <span class="comment">                 */</span>
00354                 <a class="code" href="../../d4/d1/userk_8h.html#a1615">xxxSetWindowPos</a>(pwnd, PWND_TOP, 0, 0, 0, 0,
00355                                 SWP_NOMOVE | SWP_NOSIZE);
00356                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WFMINIMIZED)) {
00357 
00358                     <span class="comment">/*</span>
00359 <span class="comment">                     * Try to popup the system menu</span>
00360 <span class="comment">                     */</span>
00361                     <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwnd, WM_SYSCOMMAND, SC_KEYMENU,
00362                             (DWORD) (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WFCHILD) ? <span class="charliteral">'-'</span> : MENUSYSMENU));
00363                 }
00364             }
00365             <span class="keywordflow">return</span>;
00366 
00367         <span class="keywordflow">case</span> SC_CLOSE:
00368             <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwnd, WM_CLOSE, 0L, 0L);
00369             <span class="keywordflow">return</span>;
00370 
00371         <span class="keywordflow">case</span> SC_NEXTWINDOW:
00372         <span class="keywordflow">case</span> SC_PREVWINDOW:
00373             <a class="code" href="../../d4/d1/userk_8h.html#a1512">xxxOldNextWindow</a>((UINT)lParam);
00374             <span class="keywordflow">break</span>;
00375 
00376         <span class="keywordflow">case</span> SC_CONTEXTHELP:
00377             <a class="code" href="../../d4/d1/userk_8h.html#a1465">xxxHelpLoop</a>(pwnd);
00378             <span class="keywordflow">break</span>;
00379 
00380         <span class="keywordflow">case</span> SC_KEYMENU:
00381 
00382             <span class="comment">/*</span>
00383 <span class="comment">             * A menu was selected via keyboard</span>
00384 <span class="comment">             */</span>
00385             pMenuState = <a class="code" href="../../d4/d1/userk_8h.html#a1350">xxxMNStartMenuState</a>(pwnd, cmd, lParam);
00386             <span class="keywordflow">if</span> (pMenuState != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00387                 UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>() == pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o24">ptiMenuStateOwner</a>);
00388 
00389                 <span class="comment">/*</span>
00390 <span class="comment">                 * Make sure we are not fullscreen</span>
00391 <span class="comment">                 */</span>
00392                 <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a15">gspwndFullScreen</a> == pwnd) {
00393                     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndT;
00394                     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndT;
00395 
00396                     pwndT = <a class="code" href="../../d3/d9/client_2wow_8c.html#a3">_GetDesktopWindow</a>();
00397                     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pwndT, &amp;tlpwndT);
00398                     <a class="code" href="../../d4/d1/userk_8h.html#a1756">xxxMakeWindowForegroundWithState</a>(pwndT, GDIFULLSCREEN);
00399                     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT);
00400                 }
00401 
00402                 pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o6">fUnderline</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00403                 <a class="code" href="../../d4/d1/userk_8h.html#a1395">xxxMNKeyFilter</a>(pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o0">pGlobalPopupMenu</a>, pMenuState, (UINT)lParam);
00404                 <span class="keywordflow">if</span> (!pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o9">fModelessMenu</a>) {
00405                     <a class="code" href="../../d4/d1/userk_8h.html#a1344">xxxMNEndMenuState</a> (TRUE);
00406                 }
00407             }
00408             <span class="comment">/*</span>
00409 <span class="comment">             * Capture must have been unlocked</span>
00410 <span class="comment">             */</span>
00411             UserAssert(!(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;pq-&gt;QF_flags &amp; QF_CAPTURELOCKED));
00412             <span class="keywordflow">return</span>;
00413 
00414         <span class="keywordflow">case</span> SC_MOUSEMENU:
00415         <span class="keywordflow">case</span> SC_DEFAULT:
00416 
00417             <span class="comment">/*</span>
00418 <span class="comment">             * If the window is not foreground, eat the command to avoid</span>
00419 <span class="comment">             * wasting time flashing the system menu.</span>
00420 <span class="comment">             *</span>
00421 <span class="comment">             * We used to check if the top level window was WFFRAMEON (so a</span>
00422 <span class="comment">             * child window's system menu works like Win 3.1) but Excel's</span>
00423 <span class="comment">             * (SDM) dialogs allow you to access their menus even though</span>
00424 <span class="comment">             * the child and parent appear to be inactive.</span>
00425 <span class="comment">             */</span>
00426             <span class="keywordflow">if</span> (!(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;pq == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>))
00427                 <span class="keywordflow">return</span>;
00428 
00429             <span class="comment">/*</span>
00430 <span class="comment">             * A mouse click occurred on a toplevel menu.</span>
00431 <span class="comment">             */</span>
00432             pMenuState = <a class="code" href="../../d4/d1/userk_8h.html#a1350">xxxMNStartMenuState</a>(pwnd, cmd, lParam);
00433             <span class="keywordflow">if</span> (pMenuState != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00434                 UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>() == pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o24">ptiMenuStateOwner</a>);
00435                 <a class="code" href="../../d4/d1/userk_8h.html#a1401">xxxMNLoop</a>(pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o0">pGlobalPopupMenu</a>, pMenuState, lParam, (cmd==SC_DEFAULT));
00436                 <span class="keywordflow">if</span> (!pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o9">fModelessMenu</a>) {
00437                     <a class="code" href="../../d4/d1/userk_8h.html#a1344">xxxMNEndMenuState</a> (TRUE);
00438                 }
00439             }
00440             <span class="comment">/*</span>
00441 <span class="comment">             * Capture must have been unlocked</span>
00442 <span class="comment">             */</span>
00443             UserAssert(!(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;pq-&gt;QF_flags &amp; QF_CAPTURELOCKED));
00444             <span class="keywordflow">return</span>;
00445 
00446         <span class="keywordflow">case</span> SC_VSCROLL:
00447         <span class="keywordflow">case</span> SC_HSCROLL:
00448             <a class="code" href="../../d4/d1/userk_8h.html#a1420">xxxSBTrackInit</a>(pwnd, lParam, htArea, (<a class="code" href="../../d7/d9/keyboard_8c.html#a1">_GetKeyState</a>(VK_SHIFT) &lt; 0) ? SCROLL_DIRECT : SCROLL_NORMAL);
00449             <span class="keywordflow">return</span>;
00450 
00451         <span class="keywordflow">case</span> SC_TASKLIST:
00452 <span class="comment">//            _PostThreadMessage(gptiTasklist, WM_SYSCOMMAND, SC_TASKLIST, 0);</span>
00453 <span class="comment">//            if (!FCallTray() ||</span>
00454 <span class="comment">//                !CallHook(HSHELL_TASKMAN, (WPARAM) HW16(hwnd), (LPARAM) 0, WH_SHELL))</span>
00455 
00456             <span class="comment">/*</span>
00457 <span class="comment">             * Winlogon will set lParam to -1 to indicate that we really want a task list,</span>
00458 <span class="comment">             * not just the start menu.  We indicate this to the shell by passing a NULL</span>
00459 <span class="comment">             * window ptr</span>
00460 <span class="comment">             * This message is really intended for the SHELL, so give them the right</span>
00461 <span class="comment">             *  to set the foreground.</span>
00462 <span class="comment">             */</span>
00463             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a592">FDoTray</a>() &amp;&amp; (<a class="code" href="../../d4/d1/userk_8h.html#a593">FCallHookTray</a>() || <a class="code" href="../../d4/d1/userk_8h.html#a594">FPostTray</a>(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.rpdesk))) {
00464                 <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndTaskman = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.rpdesk-&gt;pDeskInfo-&gt;spwndTaskman;
00465                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a593">FCallHookTray</a>()) {
00466                     <a class="code" href="../../d4/d1/userk_8h.html#a1521">xxxCallHook</a>(HSHELL_TASKMAN, (WPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwnd), (LPARAM) 0, WH_SHELL);
00467                 }
00468                 <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d1/userk_8h.html#a594">FPostTray</a>(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.rpdesk)) &amp;&amp; (pwndTaskman != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00469                     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a78">glinp</a>.<a class="code" href="../../d5/d9/structtagLASTINPUT.html#o2">ptiLastWoken</a> = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndTaskman);
00470                     <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(pwndTaskman, <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o15">uiShellMsg</a>, HSHELL_TASKMAN,
00471                             lParam == (ULONG)(-1) ? (LPARAM) -1 :(LPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwnd));
00472                 }
00473             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a22">gptiTasklist</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00474                  <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a78">glinp</a>.<a class="code" href="../../d5/d9/structtagLASTINPUT.html#o2">ptiLastWoken</a> = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a22">gptiTasklist</a>;
00475                 <a class="code" href="../../d4/d1/userk_8h.html#a1645">_PostThreadMessage</a>(gptiTasklist, WM_SYSCOMMAND, SC_TASKLIST, 0);
00476 <span class="comment">// LATER -- FritzS</span>
00477 <span class="comment">//                HCURSOR hCursorLast;</span>
00478 <span class="comment">//                static char CODESEG szTask[] = " %d %d";</span>
00479 
00480 <span class="comment">//                ShowCursor(TRUE);</span>
00481 <span class="comment">//                hCursorLast = SetCursor32(hCursWait, TRUE);</span>
00482 
00483                 <span class="comment">// Try in the windows directory first.</span>
00484 <span class="comment">//                GetWindowsDirectory(szBuff, sizeof(szBuff));</span>
00485 <span class="comment">//                if (szBuff[lstrlen(szBuff) - 1] != '\\')</span>
00486 <span class="comment">//                    lstrcatn(szBuff, "\\", sizeof(szBuff));</span>
00487 <span class="comment">//                lstrcatn(szBuff, (LPSTR)pTaskManName, sizeof(szBuff));</span>
00488 <span class="comment">//                wvsprintf(szBuff+lstrlen(szBuff), (LPSTR)szTask, (LPSTR)&amp;lParam);</span>
00489 
00490 <span class="comment">//                if (WinExec((LPSTR)szBuff, SW_SHOWNORMAL) &lt;= 32)</span>
00491 <span class="comment">//                {</span>
00492 <span class="comment">//                    // If it wasn't in the windows directory then try</span>
00493 <span class="comment">//                    // searching the full path.</span>
00494 <span class="comment">//                    lstrcpyn(szBuff, pTaskManName, sizeof(szBuff));</span>
00495 <span class="comment">//                    wvsprintf(szBuff+lstrlen(szBuff), (LPSTR)szTask, (LPSTR)&amp;lParam);</span>
00496 <span class="comment">//                    WinExec((LPSTR)szBuff, SW_SHOWNORMAL);</span>
00497 <span class="comment">//                }</span>
00498 <span class="comment">//</span>
00499 <span class="comment">//                ShowCursor(FALSE);</span>
00500 <span class="comment">//                SetCursor32(hCursorLast, TRUE);</span>
00501             }
00502 
00503             <span class="keywordflow">break</span>;
00504 
00505         <span class="keywordflow">case</span> SC_MONITORPOWER:
00506             <span class="comment">/*</span>
00507 <span class="comment">             * If we're powering down the machine, ignore this request.</span>
00508 <span class="comment">             */</span>
00509             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a313">gPowerState</a>.<a class="code" href="../../d6/d3/structtagPOWERSTATE.html#o0">fInProgress</a>) {
00510                 <span class="keywordflow">break</span>;
00511             }
00512 
00513             <span class="keywordflow">switch</span> (lParam) {
00514             <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a663">POWERON_PHASE</a>:
00515                 <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a78">glinp</a>.<a class="code" href="../../d5/d9/structtagLASTINPUT.html#o1">dwFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a380">LINP_POWERTIMEOUTS</a>) {
00516                     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a78">glinp</a>.<a class="code" href="../../d5/d9/structtagLASTINPUT.html#o1">dwFlags</a> &amp;= ~<a class="code" href="../../d4/d1/userk_8h.html#a380">LINP_POWERTIMEOUTS</a>;
00517                     DrvSetMonitorPowerState(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o1">pmdev</a>,
00518                                           PowerDeviceD0);
00519                 }
00520                 <span class="keywordflow">break</span>;
00521             <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a664">LOWPOWER_PHASE</a>:
00522                 <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a78">glinp</a>.<a class="code" href="../../d5/d9/structtagLASTINPUT.html#o1">dwFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a378">LINP_LOWPOWER</a>) == 0) {
00523                     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a78">glinp</a>.<a class="code" href="../../d5/d9/structtagLASTINPUT.html#o1">dwFlags</a> |= <a class="code" href="../../d4/d1/userk_8h.html#a378">LINP_LOWPOWER</a>;
00524                     DrvSetMonitorPowerState(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o1">pmdev</a>,
00525                                           PowerDeviceD1);
00526                 }
00527                 <span class="keywordflow">break</span>;
00528             <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a665">POWEROFF_PHASE</a>:
00529                 <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a78">glinp</a>.<a class="code" href="../../d5/d9/structtagLASTINPUT.html#o1">dwFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a379">LINP_POWEROFF</a>) == 0) {
00530                     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a78">glinp</a>.<a class="code" href="../../d5/d9/structtagLASTINPUT.html#o1">dwFlags</a> |= <a class="code" href="../../d4/d1/userk_8h.html#a379">LINP_POWEROFF</a>;
00531                     DrvSetMonitorPowerState(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o1">pmdev</a>,
00532                                           PowerDeviceD3);
00533                 }
00534                 <span class="keywordflow">break</span>;
00535             <span class="keywordflow">default</span>:
00536                 <span class="keywordflow">break</span>;
00537             }
00538             <span class="keywordflow">break</span>;
00539 
00540         <span class="keywordflow">case</span> SC_SCREENSAVE:
00541             pwndSwitch = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(ghwndSwitch);
00542 
00543             <span class="comment">// Lock out screen save until we get another input message.</span>
00544 
00545             <span class="keywordflow">if</span> (pwndSwitch != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; pwnd != pwndSwitch) {
00546                 <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(pwndSwitch, WM_SYSCOMMAND, SC_SCREENSAVE, 0L);
00547             } <span class="keywordflow">else</span> {
00548                 <a class="code" href="../../d4/d1/userk_8h.html#a1121">StartScreenSaver</a>(FALSE);
00549             }
00550             <span class="keywordflow">break</span>;
00551 
00552         <span class="keywordflow">case</span> SC_HOTKEY:
00553 
00554             <span class="comment">/*</span>
00555 <span class="comment">             * Loword of the lparam is window to switch to</span>
00556 <span class="comment">             */</span>
00557             pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>((HWND)lParam);
00558             <span class="keywordflow">if</span> (pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00559                 pwndSwitch = <a class="code" href="../../d2/d8/rtl_2winmgr_8c.html#a4">_GetLastActivePopup</a>(pwnd);
00560 
00561                 <span class="keywordflow">if</span> (pwndSwitch != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00562                       pwnd = pwndSwitch;
00563 
00564                 <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pwnd, &amp;tlpwnd);
00565                 <a class="code" href="../../d4/d1/userk_8h.html#a1665">xxxSetForegroundWindow</a>(pwnd, FALSE);
00566                 <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
00567 
00568                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WFMINIMIZED))
00569                     <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(pwnd, WM_SYSCOMMAND, SC_RESTORE, 0);
00570             }
00571             <span class="keywordflow">break</span>;
00572         }
00573     }
00574 }
</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:43 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
