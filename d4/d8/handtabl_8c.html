<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: handtabl.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>handtabl.c File Reference</h1><code>#include "<a class="el" href="../../d1/d3/w32_2ntuser_2kernel_2precomp_8h-source.html">precomp.h</a>"</code><br>

<p>
<a href="../../d5/d7/handtabl_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d8/handtabl_8c.html#a0">HTIENTRY</a>(szObjectType, structName, fnDestroy, dwAllocTag, bObjectCreateFlags)&nbsp;&nbsp;&nbsp;{(<a class="el" href="../../d0/d0/client_2nt6_2user_8h.html#a1011">FnDestroyUserObject</a>)fnDestroy, (CONST <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)dwAllocTag, (CONST <a class="el" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)(bObjectCreateFlags)}</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d8/handtabl_8c.html#a1">CPAGEENTRIESINIT</a>&nbsp;&nbsp;&nbsp;4</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d8/handtabl_8c.html#a2">DBGValidateHandleQuota</a>()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d8/handtabl_8c.html#a3">DBGHMValidateFreeLists</a>()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d8/handtabl_8c.html#a4">CHANDLEENTRIESINIT</a>&nbsp;&nbsp;&nbsp;200</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d8/handtabl_8c.html#a5">CLOCKENTRIESINIT</a>&nbsp;&nbsp;&nbsp;100</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>void&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d8/handtabl_8c.html#a9">HMNullFnDestroy</a> (PVOID pobj)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>void&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d8/handtabl_8c.html#a10">HMDestroyUnlockedObject</a> (<a class="el" href="../../d2/d4/struct__HANDLEENTRY.html">PHE</a> phe)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>void&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d8/handtabl_8c.html#a11">HMRecordLock</a> (PVOID ppobj, PVOID pobj, <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> cLockObj)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d8/handtabl_8c.html#a12">HMUnrecordLock</a> (PVOID ppobj, PVOID pobj)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d8/handtabl_8c.html#a13">ShowLocks</a> (<a class="el" href="../../d2/d4/struct__HANDLEENTRY.html">PHE</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>void&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d8/handtabl_8c.html#a14">HMInitHandleEntries</a> (ULONG_PTR iheFirstFree)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d8/handtabl_8c.html#a15">HMInitHandleTable</a> (PVOID pReadOnlySharedSectionBase)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d8/handtabl_8c.html#a16">HMGrowHandleTable</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d8/handtabl_8c.html#a17">HMAllocObject</a> (<a class="el" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiOwner, <a class="el" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a> pdeskSrc, <a class="el" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> bType, <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> size)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d8/handtabl_8c.html#a18">HMFreeObject</a> (PVOID pobj)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d8/handtabl_8c.html#a19">HMMarkObjectDestroy</a> (PVOID pobj)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d8/handtabl_8c.html#a20">HMDestroyObject</a> (PVOID pobj)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d8/handtabl_8c.html#a21">HMUnlockObjectInternal</a> (PVOID pobj)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d8/handtabl_8c.html#a22">HMAssignmentLock</a> (PVOID *ppobj, PVOID pobj)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d8/handtabl_8c.html#a23">HMAssignmentUnlock</a> (PVOID *ppobj)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d8/handtabl_8c.html#a24">ThreadUnlock1</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d8/handtabl_8c.html#a25">HMChangeOwnerThread</a> (PVOID pobj, <a class="el" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d8/handtabl_8c.html#a26">HMChangeOwnerPheProcess</a> (<a class="el" href="../../d2/d4/struct__HANDLEENTRY.html">PHE</a> phe, <a class="el" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d8/handtabl_8c.html#a27">DestroyThreadsObjects</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>void&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d8/handtabl_8c.html#a28">FixupCursor</a> (<a class="el" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a> pcur, <a class="el" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppi)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d8/handtabl_8c.html#a29">DestroyProcessesObjects</a> (<a class="el" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppi)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>void&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d8/handtabl_8c.html#a30">MarkThreadsObjects</a> (<a class="el" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d8/handtabl_8c.html#a31">_QueryUserHandles</a> (LPDWORD paPids, <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwNumInstances, <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwResult[][TYPE_CTYPES])</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>void&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d8/handtabl_8c.html#a32">HMCleanupGrantedHandle</a> (HANDLE h)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>CONST <a class="el" href="../../d1/d6/structtagHANDLETYPEINFO.html">HANDLETYPEINFO</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d8/handtabl_8c.html#a6">gahti</a> [TYPE_CTYPES]</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d8/handtabl_8c.html#a7">gcHandlePages</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d4/d4/struct__HANDLEPAGE.html">PHANDLEPAGE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d8/handtabl_8c.html#a8">gpHandlePages</a></td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a4" doxytag="handtabl.c::CHANDLEENTRIESINIT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CHANDLEENTRIESINIT&nbsp;&nbsp;&nbsp;200          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/handtabl_8c-source.html#l00572">572</a> of file <a class="el" href="../../d5/d7/handtabl_8c-source.html">handtabl.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="handtabl.c::CLOCKENTRIESINIT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CLOCKENTRIESINIT&nbsp;&nbsp;&nbsp;100          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/handtabl_8c-source.html#l00573">573</a> of file <a class="el" href="../../d5/d7/handtabl_8c-source.html">handtabl.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="handtabl.c::CPAGEENTRIESINIT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CPAGEENTRIESINIT&nbsp;&nbsp;&nbsp;4          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/handtabl_8c-source.html#l00206">206</a> of file <a class="el" href="../../d5/d7/handtabl_8c-source.html">handtabl.c</a>.
<p>
Referenced by <a class="el" href="../../d5/d7/handtabl_8c-source.html#l00704">HMGrowHandleTable()</a>, and <a class="el" href="../../d5/d7/handtabl_8c-source.html#l00575">HMInitHandleTable()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="handtabl.c::DBGHMValidateFreeLists" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DBGHMValidateFreeLists          </td>
          <td class="md" valign="top">(&nbsp;</td>
&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/handtabl_8c-source.html#l00455">455</a> of file <a class="el" href="../../d5/d7/handtabl_8c-source.html">handtabl.c</a>.
<p>
Referenced by <a class="el" href="../../d5/d7/handtabl_8c-source.html#l00828">HMAllocObject()</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l01069">HMFreeObject()</a>, and <a class="el" href="../../d5/d7/handtabl_8c-source.html#l00529">HMInitHandleEntries()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="handtabl.c::DBGValidateHandleQuota" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DBGValidateHandleQuota          </td>
          <td class="md" valign="top">(&nbsp;</td>
&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/handtabl_8c-source.html#l00269">269</a> of file <a class="el" href="../../d5/d7/handtabl_8c-source.html">handtabl.c</a>.
<p>
Referenced by <a class="el" href="../../d5/d7/handtabl_8c-source.html#l02511">DestroyProcessesObjects()</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l02284">DestroyThreadsObjects()</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l00828">HMAllocObject()</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l02220">HMChangeOwnerPheProcess()</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l02112">HMChangeOwnerThread()</a>, and <a class="el" href="../../d5/d7/handtabl_8c-source.html#l01069">HMFreeObject()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="handtabl.c::HTIENTRY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define HTIENTRY          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">szObjectType,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>structName,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>fnDestroy,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>dwAllocTag,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>bObjectCreateFlags&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;{(<a class="el" href="../../d1/d0/inc_2user_8h.html#a979">FnDestroyUserObject</a>)fnDestroy, (CONST <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)dwAllocTag, (CONST <a class="el" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)(bObjectCreateFlags)}</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/handtabl_8c-source.html#l00023">23</a> of file <a class="el" href="../../d5/d7/handtabl_8c-source.html">handtabl.c</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a31" doxytag="handtabl.c::_QueryUserHandles" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID _QueryUserHandles           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">LPDWORD&nbsp;</td>
          <td class="mdname" nowrap> <em>paPids</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>dwNumInstances</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>dwResult</em>[][TYPE_CTYPES]</td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/handtabl_8c-source.html#l02776">2776</a> of file <a class="el" href="../../d5/d7/handtabl_8c-source.html">handtabl.c</a>.
<p>
References <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01278">tagSHAREDINFO::aheList</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01438">tagHANDLETYPEINFO::bObjectCreateFlags</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01514">_HANDLEENTRY::bType</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d0/d6/ntuser_2kernel_2globals_8h-source.html#l00496">gahti</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00849">giheLast</a>, <a class="el" href="../../d2/d7/clglobal_8c-source.html#l00052">gSharedInfo</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01344">OCF_PROCESSOWNED</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01343">OCF_THREADOWNED</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01447">_HANDLEENTRY::pOwner</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00035">QUC_PID_TOTAL</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00924">TYPE_CTYPES</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
<pre class="fragment"><div>02780 {
02781     <a class="code" href="../../d2/d4/struct__HANDLEENTRY.html">PHE</a>         pheCurPos;                 <span class="comment">// Current position in the table</span>
02782     <a class="code" href="../../d2/d4/struct__HANDLEENTRY.html">PHE</a>         pheMax;                    <span class="comment">// address of last table entry</span>
02783     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>       index;
02784     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>       pid;
02785     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>       dwTotalCounters[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a254">TYPE_CTYPES</a>]; <span class="comment">// system wide counters</span>
02786 
02787     RtlZeroMemory(dwTotalCounters, TYPE_CTYPES*<span class="keyword">sizeof</span>(DWORD));
02788     RtlZeroMemory(dwResult, dwNumInstances*TYPE_CTYPES*<span class="keyword">sizeof</span>(DWORD));
02789     <span class="comment">/*</span>
02790 <span class="comment">     * Walk the handle table and update the counters</span>
02791 <span class="comment">     */</span>
02792     pheMax = &amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o1">aheList</a>[<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a308">giheLast</a>];
02793     <span class="keywordflow">for</span>(pheCurPos = <a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o1">aheList</a>; pheCurPos &lt;= pheMax; pheCurPos++) {
02794 
02795         UserAssert(pheCurPos-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o2">bType</a> &lt; TYPE_CTYPES);
02796 
02797         pid = 0;
02798 
02799         <span class="keywordflow">if</span> (pheCurPos-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o1">pOwner</a>) {
02800 
02801             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d6/ntuser_2kernel_2globals_8h.html#a241">gahti</a>[pheCurPos-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o2">bType</a>].<a class="code" href="../../d1/d6/structtagHANDLETYPEINFO.html#o2">bObjectCreateFlags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a414">OCF_PROCESSOWNED</a>) {
02802                 <span class="comment">/*</span>
02803 <span class="comment">                 * Object is owned by process</span>
02804 <span class="comment">                 * some objects may not have an owner</span>
02805 <span class="comment">                 */</span>
02806                     pid = HandleToUlong(((<a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a>)pheCurPos-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o1">pOwner</a>)-&gt;Process-&gt;UniqueProcessId);
02807                 }
02808             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d9/d6/ntuser_2kernel_2globals_8h.html#a241">gahti</a>[pheCurPos-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o2">bType</a>].<a class="code" href="../../d1/d6/structtagHANDLETYPEINFO.html#o2">bObjectCreateFlags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a413">OCF_THREADOWNED</a>) {
02809                 <span class="comment">/*</span>
02810 <span class="comment">                 * Object owned by thread</span>
02811 <span class="comment">                 */</span>
02812                     pid = HandleToUlong(((<a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>)pheCurPos-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o1">pOwner</a>)-&gt;pEThread-&gt;ThreadsProcess-&gt;UniqueProcessId);
02813                 }
02814         }
02815         <span class="comment">/*</span>
02816 <span class="comment">         * search to see if we are interested in this process</span>
02817 <span class="comment">         * unowned handles are reported for the "System" process whose pid is 0</span>
02818 <span class="comment">         */</span>
02819         <span class="keywordflow">for</span> (index = 0; index &lt; dwNumInstances; index++) {
02820 
02821             <span class="keywordflow">if</span> (paPids[index] == pid) {
02822                 dwResult[index][pheCurPos-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o2">bType</a>]++;
02823             }
02824         }
02825         <span class="comment">/*</span>
02826 <span class="comment">         *  update the totals</span>
02827 <span class="comment">         */</span>
02828          dwTotalCounters[pheCurPos-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o2">bType</a>]++;
02829     }
02830 
02831     <span class="comment">/*</span>
02832 <span class="comment">     * search to see if we are interested in the totals</span>
02833 <span class="comment">     */</span>
02834     <span class="keywordflow">for</span> (index = 0; index &lt; dwNumInstances; index++) {
02835 
02836         <span class="keywordflow">if</span> (paPids[index] == <a class="code" href="../../d0/d5/perfuser_8c.html#a1">QUC_PID_TOTAL</a>) {
02837 
02838             RtlMoveMemory(dwResult[index], dwTotalCounters, <span class="keyword">sizeof</span>(dwTotalCounters));
02839         }
02840     }
02841 
02842 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a29" doxytag="handtabl.c::DestroyProcessesObjects" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID DestroyProcessesObjects           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ppi</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/handtabl_8c-source.html#l02511">2511</a> of file <a class="el" href="../../d5/d7/handtabl_8c-source.html">handtabl.c</a>.
<p>
References <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01278">tagSHAREDINFO::aheList</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01515">_HANDLEENTRY::bFlags</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01438">tagHANDLETYPEINFO::bObjectCreateFlags</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01514">_HANDLEENTRY::bType</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l00269">DBGValidateHandleQuota</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l02475">FixupCursor()</a>, <a class="el" href="../../d0/d6/ntuser_2kernel_2globals_8h-source.html#l00496">gahti</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00849">giheLast</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00794">gpepCSRSS</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00455">gptiRit</a>, <a class="el" href="../../d2/d7/clglobal_8c-source.html#l00052">gSharedInfo</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01429">HANDLEF_DESTROY</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l02220">HMChangeOwnerPheProcess()</a>, <a class="el" href="../../d4/d1/userk_8h.html#a977">HMDestroyUnlockedObject()</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l03600">ISTS</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01344">OCF_PROCESSOWNED</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01512">_HANDLEENTRY::phead</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01447">_HANDLEENTRY::pOwner</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00908">TYPE_CURSOR</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00905">TYPE_FREE</a>, <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>, and <a class="el" href="../../d8/d3/loadbits_8c-source.html#l00156">ZombieCursor()</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/queue_8c-source.html#l02552">xxxDestroyThreadInfo()</a>.
<p>
<pre class="fragment"><div>02513 {
02514     <a class="code" href="../../d2/d4/struct__HANDLEENTRY.html">PHE</a>  pheT, pheMax;
02515     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bGlobal = (<a class="code" href="../../d1/d0/inc_2user_8h.html#a882">ISTS</a>() &amp;&amp; ppi-&gt;Process == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a299">gpepCSRSS</a>);
02516 
02517     <span class="comment">/*</span>
02518 <span class="comment">     * Loop through the table destroying all objects created by the current</span>
02519 <span class="comment">     * process. All objects will get destroyed in their proper order simply</span>
02520 <span class="comment">     * because of the object locking.</span>
02521 <span class="comment">     */</span>
02522     <a class="code" href="../../d4/d8/handtabl_8c.html#a2">DBGValidateHandleQuota</a>();
02523     pheMax = &amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o1">aheList</a>[<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a308">giheLast</a>];
02524 
02525     <span class="keywordflow">for</span> (pheT = <a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o1">aheList</a>; pheT &lt;= pheMax; pheT++) {
02526 
02527         <span class="comment">/*</span>
02528 <span class="comment">         * Check against free before we look at ppi... because pq is stored</span>
02529 <span class="comment">         * in the object itself, which won't be there if TYPE_FREE.</span>
02530 <span class="comment">         */</span>
02531         <span class="keywordflow">if</span> (pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o2">bType</a> == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a236">TYPE_FREE</a>)
02532             <span class="keywordflow">continue</span>;
02533 
02534         <span class="comment">/*</span>
02535 <span class="comment">         * Destroy those objects created by this queue.</span>
02536 <span class="comment">         */</span>
02537         <span class="keywordflow">if</span> (!(<a class="code" href="../../d9/d6/ntuser_2kernel_2globals_8h.html#a241">gahti</a>[pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o2">bType</a>].<a class="code" href="../../d1/d6/structtagHANDLETYPEINFO.html#o2">bObjectCreateFlags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a414">OCF_PROCESSOWNED</a>) ||
02538                 (<a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a>)pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o1">pOwner</a> != ppi)
02539             <span class="keywordflow">continue</span>;
02540 
02541         <span class="comment">/*</span>
02542 <span class="comment">         * Make sure this object isn't already marked to be destroyed - we'll</span>
02543 <span class="comment">         * do no good if we try to destroy it now since it is locked.</span>
02544 <span class="comment">         * Change the owner since the process is going away</span>
02545 <span class="comment">         */</span>
02546         <span class="keywordflow">if</span> (pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o3">bFlags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a421">HANDLEF_DESTROY</a>) {
02547             <a class="code" href="../../d4/d1/userk_8h.html#a981">HMChangeOwnerPheProcess</a>(pheT, gptiRit);
02548             <span class="keywordflow">continue</span>;
02549         }
02550 
02551         <span class="keywordflow">if</span> (bGlobal) {
02552 
02553             <span class="comment">/*</span>
02554 <span class="comment">             * For global cursors set the ppi in the pcur</span>
02555 <span class="comment">             * to be CSRSS</span>
02556 <span class="comment">             */</span>
02557             <span class="keywordflow">if</span> (pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o2">bType</a> == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a239">TYPE_CURSOR</a>) {
02558                 <a class="code" href="../../d4/d8/handtabl_8c.html#a28">FixupCursor</a>((<a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a>)pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o0">phead</a>, ppi);
02559             }
02560         }
02561 
02562         <span class="comment">/*</span>
02563 <span class="comment">         * Destroy this object.</span>
02564 <span class="comment">         */</span>
02565         <a class="code" href="../../d4/d1/userk_8h.html#a977">HMDestroyUnlockedObject</a>(pheT);
02566 
02567         <span class="comment">/*</span>
02568 <span class="comment">         * When the object is freed, the handle type is set to TYPE_FREE.</span>
02569 <span class="comment">         * Zombie this object, since its process is going away and it couldn't</span>
02570 <span class="comment">         * be freed. This may include unlinking it and resetting the owner.</span>
02571 <span class="comment">         */</span>
02572         <span class="keywordflow">if</span> (pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o2">bType</a> != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a236">TYPE_FREE</a>) {
02573             <span class="keywordflow">if</span> (pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o2">bType</a> == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a239">TYPE_CURSOR</a>) {
02574                 RIPMSG1(RIP_WARNING, <span class="stringliteral">"About to zombie pcur %#p\n"</span>,
02575                         pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o0">phead</a>);
02576 
02577                 <a class="code" href="../../d4/d1/userk_8h.html#a1108">ZombieCursor</a>((<a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a>)pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o0">phead</a>);
02578             } <span class="keywordflow">else</span> {
02579                 <a class="code" href="../../d4/d1/userk_8h.html#a981">HMChangeOwnerPheProcess</a>(pheT, gptiRit);
02580             }
02581         }
02582     } <span class="comment">/* for loop */</span>
02583     <a class="code" href="../../d4/d8/handtabl_8c.html#a2">DBGValidateHandleQuota</a>();
02584 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a27" doxytag="handtabl.c::DestroyThreadsObjects" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID DestroyThreadsObjects           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/handtabl_8c-source.html#l02284">2284</a> of file <a class="el" href="../../d5/d7/handtabl_8c-source.html">handtabl.c</a>.
<p>
References <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01278">tagSHAREDINFO::aheList</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01838">BEGINATOMICCHECK</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01515">_HANDLEENTRY::bFlags</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01438">tagHANDLETYPEINFO::bObjectCreateFlags</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01514">_HANDLEENTRY::bType</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l00269">DBGValidateHandleQuota</a>, <a class="el" href="../../d5/d7/createw_8c-source.html#l02923">DestroyCacheDCEntries()</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01842">ENDATOMICCHECK</a>, <a class="el" href="../../d0/d6/ntuser_2kernel_2globals_8h-source.html#l00496">gahti</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01547">GETPTI</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00849">giheLast</a>, <a class="el" href="../../d2/d7/clglobal_8c-source.html#l00052">gSharedInfo</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01429">HANDLEF_DESTROY</a>, <a class="el" href="../../d4/d1/userk_8h.html#a977">HMDestroyUnlockedObject()</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00070">KeGetCurrentThread</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01344">OCF_PROCESSOWNED</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01343">OCF_THREADOWNED</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01512">_HANDLEENTRY::phead</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01447">_HANDLEENTRY::pOwner</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03317">tagTHREADINFO::ptl</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00366">ThreadUnlock</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00905">TYPE_FREE</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00907">TYPE_MENU</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00368">Unlock</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/queue_8c-source.html#l02552">xxxDestroyThreadInfo()</a>.
<p>
<pre class="fragment"><div>02285 {
02286     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent;
02287     <a class="code" href="../../d2/d4/struct__HANDLEENTRY.html">HANDLEENTRY</a> <span class="keyword">volatile</span> * (*pphe);
02288     <a class="code" href="../../d2/d4/struct__HANDLEENTRY.html">PHE</a> pheT;
02289     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> i;
02290 
02291     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
02292     <a class="code" href="../../d4/d8/handtabl_8c.html#a2">DBGValidateHandleQuota</a>();
02293 
02294     <span class="comment">/*</span>
02295 <span class="comment">     * Before any window destruction occurs, we need to destroy any dcs</span>
02296 <span class="comment">     * in use in the dc cache. When a dc is checked out, it is marked owned,</span>
02297 <span class="comment">     * which makes gdi's process cleanup code delete it when a process</span>
02298 <span class="comment">     * goes away. We need to similarly destroy the cache entry of any dcs</span>
02299 <span class="comment">     * in use by the exiting process.</span>
02300 <span class="comment">     */</span>
02301     <a class="code" href="../../d4/d1/userk_8h.html#a1553">DestroyCacheDCEntries</a>(ptiCurrent);
02302 
02303     <span class="comment">/*</span>
02304 <span class="comment">     * Remove any thread locks that may exist for this thread.</span>
02305 <span class="comment">     */</span>
02306     <span class="keywordflow">while</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o1">ptl</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02307 
02308         UserAssert((ULONG_PTR)ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o1">ptl</a> &gt; (ULONG_PTR)&amp;i);
02309         UserAssert((ULONG_PTR)ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o1">ptl</a> &lt; (ULONG_PTR)<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;StackBase);
02310         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o1">ptl</a>);
02311     }
02312 
02313     <span class="comment">/*</span>
02314 <span class="comment">     * CleanupPool stuff must happen before handle table clean up (as it always has been).</span>
02315 <span class="comment">     * This is because SMWPs can be HM objects and still be locked in ptlPool.</span>
02316 <span class="comment">     * If the handle is destroyed first (and it's not locked) we would end up with a</span>
02317 <span class="comment">     *  bogus pointer in ptlPool. If ptlPool is cleaned up first, the handle will be freed</span>
02318 <span class="comment">     *  or properly preserved if locked.</span>
02319 <span class="comment">     */</span>
02320     CleanupW32ThreadLocks((PW32THREAD)ptiCurrent);
02321 
02322     <span class="comment">/*</span>
02323 <span class="comment">     * Eventhough HMDestroyUnlockedObject might call xxxDestroyWindow, the</span>
02324 <span class="comment">     *  following loop is not supposed to leave the critical section. We must</span>
02325 <span class="comment">     *  have called PatchThreadWindows before coming here.</span>
02326 <span class="comment">     */</span>
02327     <a class="code" href="../../d4/d1/userk_8h.html#a159">BEGINATOMICCHECK</a>();
02328 
02329     <span class="comment">/*</span>
02330 <span class="comment">     * Loop through the table destroying all objects created by the current</span>
02331 <span class="comment">     * thread. All objects will get destroyed in their proper order simply</span>
02332 <span class="comment">     * because of the object locking.</span>
02333 <span class="comment">     */</span>
02334     pphe = &amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o1">aheList</a>;
02335     <span class="keywordflow">for</span> (i = 0; i &lt;= <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a308">giheLast</a>; i++) {
02336         <span class="comment">/*</span>
02337 <span class="comment">         * This pointer is done this way because it can change when we leave</span>
02338 <span class="comment">         * the critical section below.  The above volatile ensures that we</span>
02339 <span class="comment">         * always use the most current value</span>
02340 <span class="comment">         */</span>
02341         pheT = (<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html">PHE</a>)((*pphe) + i);
02342 
02343         <span class="comment">/*</span>
02344 <span class="comment">         * Check against free before we look at pti... because pq is stored</span>
02345 <span class="comment">         * in the object itself, which won't be there if TYPE_FREE.</span>
02346 <span class="comment">         */</span>
02347         <span class="keywordflow">if</span> (pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o2">bType</a> == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a236">TYPE_FREE</a>)
02348             <span class="keywordflow">continue</span>;
02349 
02350         <span class="comment">/*</span>
02351 <span class="comment">         * If a menu refererences a window owned by this thread, unlock</span>
02352 <span class="comment">         * the window.  This is done to prevent calling xxxDestroyWindow</span>
02353 <span class="comment">         * during process cleanup.</span>
02354 <span class="comment">         */</span>
02355         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d6/ntuser_2kernel_2globals_8h.html#a241">gahti</a>[pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o2">bType</a>].<a class="code" href="../../d1/d6/structtagHANDLETYPEINFO.html#o2">bObjectCreateFlags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a414">OCF_PROCESSOWNED</a>) {
02356             <span class="keywordflow">if</span> (pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o2">bType</a> == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a238">TYPE_MENU</a>) {
02357                 <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd = ((<a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a>)pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o0">phead</a>)-&gt;spwndNotify;
02358 
02359                 <span class="keywordflow">if</span> (pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd) == ptiCurrent)
02360                     <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;((<a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a>)pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o0">phead</a>)-&gt;spwndNotify);
02361             }
02362             <span class="keywordflow">continue</span>;
02363         }
02364 
02365         <span class="comment">/*</span>
02366 <span class="comment">         * Destroy those objects created by this queue.</span>
02367 <span class="comment">         */</span>
02368         <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>)pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o1">pOwner</a> != ptiCurrent)
02369             <span class="keywordflow">continue</span>;
02370 
02371         UserAssert(gahti[pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o2">bType</a>].bObjectCreateFlags &amp; OCF_THREADOWNED);
02372 
02373         <span class="comment">/*</span>
02374 <span class="comment">         * Make sure this object isn't already marked to be destroyed - we'll</span>
02375 <span class="comment">         * do no good if we try to destroy it now since it is locked.</span>
02376 <span class="comment">         */</span>
02377         <span class="keywordflow">if</span> (pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o3">bFlags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a421">HANDLEF_DESTROY</a>) {
02378             <span class="keywordflow">continue</span>;
02379         }
02380 
02381         <span class="comment">/*</span>
02382 <span class="comment">         * Destroy this object.</span>
02383 <span class="comment">         */</span>
02384         <a class="code" href="../../d4/d1/userk_8h.html#a977">HMDestroyUnlockedObject</a>(pheT);
02385     }
02386 
02387     <a class="code" href="../../d4/d1/userk_8h.html#a163">ENDATOMICCHECK</a>();
02388     <a class="code" href="../../d4/d8/handtabl_8c.html#a2">DBGValidateHandleQuota</a>();
02389 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a28" doxytag="handtabl.c::FixupCursor" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> void FixupCursor           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pcur</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ppi</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/handtabl_8c-source.html#l02475">2475</a> of file <a class="el" href="../../d5/d7/handtabl_8c-source.html">handtabl.c</a>.
<p>
References <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02176">CURSORF_ACON</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02178">CURSORF_ACONFRAME</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a>.
<p>
Referenced by <a class="el" href="../../d5/d7/handtabl_8c-source.html#l02511">DestroyProcessesObjects()</a>.
<p>
<pre class="fragment"><div>02478 {
02479     <span class="keywordtype">int</span>   i;
02480     <a class="code" href="../../d1/d8/structtagACON.html">PACON</a> <a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a> = (<a class="code" href="../../d1/d8/structtagACON.html">PACON</a>)pcur;
02481 
02482     <span class="keywordflow">if</span> (pcur-&gt;head.ppi == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02483         pcur-&gt;head.ppi = ppi;
02484     }
02485 
02486     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a>-&gt;CURSORF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a537">CURSORF_ACON</a>) {
02487         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a>-&gt;cpcur; i++) {
02488 
02489             UserAssert(<a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a>-&gt;aspcur[i]-&gt;CURSORF_flags &amp; CURSORF_ACONFRAME);
02490 
02491             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a>-&gt;aspcur[i]-&gt;head.ppi == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02492                 <a class="code" href="../../d4/d4/kernel_2acons_8c.html#a1">pacon</a>-&gt;aspcur[i]-&gt;head.ppi = ppi;
02493             }
02494         }
02495     }
02496 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="handtabl.c::HMAllocObject" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID HMAllocObject           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ptiOwner</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pdeskSrc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>bType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>size</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/handtabl_8c-source.html#l00828">828</a> of file <a class="el" href="../../d5/d7/handtabl_8c-source.html">handtabl.c</a>.
<p>
References <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01278">tagSHAREDINFO::aheList</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01515">_HANDLEENTRY::bFlags</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01438">tagHANDLETYPEINFO::bObjectCreateFlags</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01514">_HANDLEENTRY::bType</a>, <a class="el" href="../../d0/d7/halvprnt_8c-source.html#l00031">BYTE</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01189">tagSERVERINFO::cHandleEntries</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01833">CheckCritIn</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l00455">DBGHMValidateFreeLists</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l00269">DBGValidateHandleQuota</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l00047">DesktopAlloc()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02628">DTAG_HANDTABL</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l03328">ExQueryPoolBlockSize()</a>, <a class="el" href="../../d0/d6/ntuser_2kernel_2globals_8h-source.html#l00496">gahti</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l00208">gcHandlePages</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00849">giheLast</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l00209">gpHandlePages</a>, <a class="el" href="../../d2/d7/clglobal_8c-source.html#l00051">gpsi</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00921">gpvSharedAlloc</a>, <a class="el" href="../../d2/d7/clglobal_8c-source.html#l00052">gSharedInfo</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00678">gUserProcessHandleQuota</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01380">_HEAD::h</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l00704">HMGrowHandleTable()</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01469">HMHandleFromIndex</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01465">HMINDEXBITS</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01470">HMIndexFromHandle</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03173">tagTDB::hTaskWow</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01139">_HANDLEPAGE::iheFreeEven</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01140">_HANDLEPAGE::iheFreeOdd</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01131">tagPERFINFO::lCount</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01132">tagPERFINFO::lMaxCount</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01640">LockDesktop</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01134">tagPERFINFO::lSize</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01133">tagPERFINFO::lTotalCount</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01347">OCF_DESKTOPHEAP</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01345">OCF_MARKPROCESS</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01344">OCF_PROCESSOWNED</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01349">OCF_SHAREDHEAP</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01343">OCF_THREADOWNED</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01348">OCF_USEPOOLIFNODESKTOP</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01346">OCF_USEPOOLQUOTA</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01353">OCF_VARIABLESIZE</a>, <a class="el" href="../../d0/d7/halvprnt_8c-source.html#l00031">PBYTE</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01512">_HANDLEENTRY::phead</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02664">tagDESKTOP::pheapDesktop</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01447">_HANDLEENTRY::pOwner</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03319">tagTHREADINFO::ppi</a>, <a class="el" href="../../d0/d0/client_2nt6_2user_8h.html#a1021">PPROCMARKHEAD</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03352">tagTHREADINFO::ptdb</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l03655">RtlSizeHeap()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02137">SharedAlloc()</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02827">TIF_16BIT</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03331">tagTHREADINFO::TIF_flags</a>, and <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00906">TYPE_WINDOW</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/swp_8c-source.html#l00272">_BeginDeferWindowPos()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00088">_ConvertMemHandle()</a>, <a class="el" href="../../d2/d1/mnaccel_8c-source.html#l00217">_CreateAcceleratorTable()</a>, <a class="el" href="../../d8/d3/loadbits_8c-source.html#l00026">_CreateEmptyCursorObject()</a>, <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00674">_SetWinEventHook()</a>, <a class="el" href="../../d6/d7/ntimm_8c-source.html#l00040">CreateInputContext()</a>, <a class="el" href="../../d9/d7/fullscr_8c-source.html#l00449">CreateMonitor()</a>, <a class="el" href="../../d6/d3/kernel_2ddetrack_8c-source.html#l01689">Createpxs()</a>, <a class="el" href="../../d1/d4/ntuser_2kernel_2getset_8c-source.html#l00875">GetCPD()</a>, <a class="el" href="../../d6/d1/mncreate_8c-source.html#l00036">InternalCreateMenu()</a>, <a class="el" href="../../d5/d1/timers_8c-source.html#l00225">InternalSetTimer()</a>, <a class="el" href="../../d7/d1/kbdlyout_8c-source.html#l00316">LoadKeyboardLayoutFile()</a>, <a class="el" href="../../d6/d3/kernel_2ddetrack_8c-source.html#l01766">NewConversation()</a>, <a class="el" href="../../d5/d7/createw_8c-source.html#l00033">xxxCreateWindowEx()</a>, <a class="el" href="../../d2/d3/ddemlsvr_8c-source.html#l00019">xxxCsDdeInitialize()</a>, <a class="el" href="../../d7/d1/kbdlyout_8c-source.html#l00654">xxxLoadKeyboardLayoutEx()</a>, and <a class="el" href="../../d2/d1/hooks_8c-source.html#l00576">zzzSetWindowsHookEx()</a>.
<p>
<pre class="fragment"><div>00833 {
00834     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>       i;
00835     <a class="code" href="../../d4/d5/struct__HEAD.html">PHEAD</a>       phead;
00836     <a class="code" href="../../d2/d4/struct__HANDLEENTRY.html">PHE</a>         pheT;
00837     ULONG_PTR    iheFree, *piheFreeHead;
00838     <a class="code" href="../../d4/d4/struct__HANDLEPAGE.html">PHANDLEPAGE</a> php;
00839     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>        bCreateFlags;
00840     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppiQuotaCharge = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00841     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>        fUsePoolIfNoDesktop;
00842     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>        fEven;
00843 
00844     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00845     bCreateFlags = <a class="code" href="../../d9/d6/ntuser_2kernel_2globals_8h.html#a241">gahti</a>[bType].<a class="code" href="../../d1/d6/structtagHANDLETYPEINFO.html#o2">bObjectCreateFlags</a>;
00846 
00847 <span class="preprocessor">#if DBG</span>
00848 <span class="preprocessor"></span>    <span class="comment">/*</span>
00849 <span class="comment">     * Validate size</span>
00850 <span class="comment">     */</span>
00851     <span class="keywordflow">if</span> (bCreateFlags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a420">OCF_VARIABLESIZE</a>) {
00852         UserAssert(gahti[bType].uSize &lt;= size);
00853     } <span class="keywordflow">else</span> {
00854         UserAssert(gahti[bType].uSize == size);
00855     }
00856 <span class="preprocessor">#endif</span>
00857 <span class="preprocessor"></span>
00858     <span class="comment">/*</span>
00859 <span class="comment">     * Check for process handle quota</span>
00860 <span class="comment">     */</span>
00861     <span class="keywordflow">if</span> (bCreateFlags &amp; (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a414">OCF_PROCESSOWNED</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a413">OCF_THREADOWNED</a>)) {
00862         UserAssert(ptiOwner != NULL);
00863         ppiQuotaCharge = ptiOwner-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>;
00864         <span class="keywordflow">if</span> (ppiQuotaCharge-&gt;UserHandleCount &gt;= <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a253">gUserProcessHandleQuota</a>) {
00865             RIPERR0(ERROR_NO_MORE_USER_HANDLES,
00866                    RIP_WARNING,
00867                 <span class="stringliteral">"USER: HMAllocObject: out of handle quota\n"</span>);
00868             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00869         }
00870     }
00871 
00872     <span class="comment">/*</span>
00873 <span class="comment">     * Find the next free handle</span>
00874 <span class="comment">     * Window handles must be even; hence we try first to use odd handles</span>
00875 <span class="comment">     *  for all other objects.</span>
00876 <span class="comment">     * Old comment:</span>
00877 <span class="comment">     * Some wow apps, like WinProj, require even Window handles so we'll</span>
00878 <span class="comment">     * accomodate them; build a list of the odd handles so they won't get lost</span>
00879 <span class="comment">     * 10/13/97: WinProj never fixed this; even the 32 bit version has the problem.</span>
00880 <span class="comment">     */</span>
00881     fEven = (bType == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a237">TYPE_WINDOW</a>);
00882     piheFreeHead = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00883     <span class="keywordflow">do</span> {
00884         php = <a class="code" href="../../d4/d8/handtabl_8c.html#a8">gpHandlePages</a>;
00885         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d4/d8/handtabl_8c.html#a7">gcHandlePages</a>; ++i, ++php) {
00886             <span class="keywordflow">if</span> (fEven) {
00887                 <span class="keywordflow">if</span> (php-&gt;<a class="code" href="../../d4/d4/struct__HANDLEPAGE.html#o1">iheFreeEven</a> != 0) {
00888                     piheFreeHead = &amp;php-&gt;<a class="code" href="../../d4/d4/struct__HANDLEPAGE.html#o1">iheFreeEven</a>;
00889                     <span class="keywordflow">break</span>;
00890                 }
00891             } <span class="keywordflow">else</span> {
00892                 <span class="keywordflow">if</span> (php-&gt;<a class="code" href="../../d4/d4/struct__HANDLEPAGE.html#o2">iheFreeOdd</a> != 0) {
00893                     piheFreeHead = &amp;php-&gt;<a class="code" href="../../d4/d4/struct__HANDLEPAGE.html#o2">iheFreeOdd</a>;
00894                     <span class="keywordflow">break</span>;
00895                 }
00896             }
00897         } <span class="comment">/* for */</span>
00898         <span class="comment">/*</span>
00899 <span class="comment">         * If we couldn't find an odd handle, then search for an even one</span>
00900 <span class="comment">         */</span>
00901         fEven = ((piheFreeHead == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; !fEven);
00902     } <span class="keywordflow">while</span> (fEven);
00903     <span class="comment">/*</span>
00904 <span class="comment">     * If there are no free handles we can use, grow the table</span>
00905 <span class="comment">     */</span>
00906     <span class="keywordflow">if</span> (piheFreeHead == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00907         <a class="code" href="../../d4/d8/handtabl_8c.html#a16">HMGrowHandleTable</a>();
00908         <span class="comment">/*</span>
00909 <span class="comment">         * If the table didn't grow, get out.</span>
00910 <span class="comment">         */</span>
00911         <span class="keywordflow">if</span> (i == <a class="code" href="../../d4/d8/handtabl_8c.html#a7">gcHandlePages</a>) {
00912             RIPMSG0(RIP_WARNING, <span class="stringliteral">"HMAllocObject: could not grow handle space"</span>);
00913             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00914         }
00915         <span class="comment">/*</span>
00916 <span class="comment">         * Because the handle page table may have moved,</span>
00917 <span class="comment">         * recalc the page entry pointer.</span>
00918 <span class="comment">         */</span>
00919         php = &amp;<a class="code" href="../../d4/d8/handtabl_8c.html#a8">gpHandlePages</a>[i];
00920         piheFreeHead = (bType == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a237">TYPE_WINDOW</a> ? &amp;php-&gt;<a class="code" href="../../d4/d4/struct__HANDLEPAGE.html#o1">iheFreeEven</a> : &amp;php-&gt;<a class="code" href="../../d4/d4/struct__HANDLEPAGE.html#o2">iheFreeOdd</a>);
00921         <span class="keywordflow">if</span> (*piheFreeHead == 0) {
00922             UserAssert(<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o4">cHandleEntries</a> == (HMINDEXBITS + 1));
00923             RIPMSG0(RIP_WARNING, <span class="stringliteral">"HMAllocObject: handle table is full"</span>);
00924             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00925         }
00926     }
00927     <span class="comment">/*</span>
00928 <span class="comment">     * HMINDEXBITS is a reserved value that should never be in the free lists</span>
00929 <span class="comment">     *  (see HMGrowHandleTable());</span>
00930 <span class="comment">     */</span>
00931     UserAssert(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a432">HMIndexFromHandle</a>(*piheFreeHead) != HMINDEXBITS);
00932     <span class="comment">/*</span>
00933 <span class="comment">     * Try to allocate the object. If this fails, bail out.</span>
00934 <span class="comment">     */</span>
00935     <span class="keywordflow">if</span> ((bCreateFlags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a417">OCF_DESKTOPHEAP</a>) &amp;&amp; pdeskSrc) {
00936         phead = (<a class="code" href="../../d4/d5/struct__HEAD.html">PHEAD</a>)<a class="code" href="../../d4/d1/userk_8h.html#a1020">DesktopAlloc</a>(pdeskSrc, size, DTAG_HANDTABL);
00937         <span class="keywordflow">if</span> (phead) {
00938             <a class="code" href="../../d4/d1/userk_8h.html#a126">LockDesktop</a>(&amp;((<a class="code" href="../../d8/d2/struct__DESKOBJHEAD.html">PDESKOBJHEAD</a>)phead)-&gt;rpdesk, pdeskSrc, LDL_OBJ_DESK, (ULONG_PTR)phead);
00939             ((<a class="code" href="../../d8/d2/struct__DESKOBJHEAD.html">PDESKOBJHEAD</a>)phead)-&gt;pSelf = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)phead;
00940         }
00941     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bCreateFlags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a419">OCF_SHAREDHEAP</a>) {
00942         UserAssert(!pdeskSrc);
00943         phead = (<a class="code" href="../../d4/d5/struct__HEAD.html">PHEAD</a>)<a class="code" href="../../d4/d1/userk_8h.html#a1000">SharedAlloc</a>(size);
00944     } <span class="keywordflow">else</span> {
00945         fUsePoolIfNoDesktop = !pdeskSrc &amp;&amp; (bCreateFlags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a418">OCF_USEPOOLIFNODESKTOP</a>);
00946         UserAssert(!(bCreateFlags &amp; OCF_DESKTOPHEAP) || fUsePoolIfNoDesktop);
00947 
00948         <span class="keywordflow">if</span> ((bCreateFlags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a416">OCF_USEPOOLQUOTA</a>) &amp;&amp; !fUsePoolIfNoDesktop) {
00949             phead = (<a class="code" href="../../d4/d5/struct__HEAD.html">PHEAD</a>)UserAllocPoolWithQuotaZInit(size, gahti[bType].dwAllocTag);
00950         } <span class="keywordflow">else</span> {
00951             phead = (<a class="code" href="../../d4/d5/struct__HEAD.html">PHEAD</a>)UserAllocPoolZInit(size, gahti[bType].dwAllocTag);
00952         }
00953     }
00954 
00955     <span class="keywordflow">if</span> (phead == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00956         RIPERR0(ERROR_NOT_ENOUGH_MEMORY,
00957                 RIP_WARNING,
00958                 <span class="stringliteral">"USER: HMAllocObject: out of memory"</span>);
00959         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00960     }
00961     <span class="comment">/*</span>
00962 <span class="comment">     * We're going to use this handle so get it off its free list.</span>
00963 <span class="comment">     * The free handle phead points to the next free handle.</span>
00964 <span class="comment">     */</span>
00965     iheFree = *piheFreeHead;
00966     pheT = &amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o1">aheList</a>[iheFree];
00967     *piheFreeHead = (ULONG_PTR)pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o0">phead</a>;
00968     <a class="code" href="../../d4/d8/handtabl_8c.html#a3">DBGHMValidateFreeLists</a>();
00969     <span class="comment">/*</span>
00970 <span class="comment">     * Track high water mark for handle allocation.</span>
00971 <span class="comment">     */</span>
00972     <span class="keywordflow">if</span> ((<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)iheFree &gt; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a308">giheLast</a>) {
00973         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a308">giheLast</a> = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)iheFree;
00974     }
00975     <span class="comment">/*</span>
00976 <span class="comment">     * Setup the handle contents, plus initialize the object header.</span>
00977 <span class="comment">     */</span>
00978     pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o2">bType</a> = bType;
00979     pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o0">phead</a> = phead;
00980     UserAssert(pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o3">bFlags</a> == 0);
00981     <span class="keywordflow">if</span> (bCreateFlags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a414">OCF_PROCESSOWNED</a>) {
00982         <span class="keywordflow">if</span> ((ptiOwner-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>) &amp;&amp; (ptiOwner-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o22">ptdb</a>)) {
00983             ((<a class="code" href="../../d8/d0/struct__PROCOBJHEAD.html">PPROCOBJHEAD</a>)phead)-&gt;hTaskWow = ptiOwner-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o22">ptdb</a>-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o5">hTaskWow</a>;
00984         } <span class="keywordflow">else</span> {
00985             ((<a class="code" href="../../d8/d0/struct__PROCOBJHEAD.html">PPROCOBJHEAD</a>)phead)-&gt;hTaskWow = 0;
00986         }
00987         pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o1">pOwner</a> = ptiOwner-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>;
00988         <span class="keywordflow">if</span> (bCreateFlags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a415">OCF_MARKPROCESS</a>) {
00989             ((<a class="code" href="../../d7/d0/struct__PROCMARKHEAD.html">PPROCMARKHEAD</a>)phead)-&gt;ppi = ptiOwner-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>;
00990         }
00991     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bCreateFlags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a413">OCF_THREADOWNED</a>) {
00992         ((<a class="code" href="../../d1/d1/struct__THROBJHEAD.html">PTHROBJHEAD</a>)phead)-&gt;pti = pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o1">pOwner</a> = ptiOwner;
00993     } <span class="keywordflow">else</span> {
00994         <span class="comment">/*</span>
00995 <span class="comment">         * The caller is wasting time if ptiOwner != NULL</span>
00996 <span class="comment">         * The handle entry must already have pOwner == NULL.</span>
00997 <span class="comment">         */</span>
00998         UserAssert(ptiOwner == NULL);
00999         UserAssert(pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o1">pOwner</a> == NULL);
01000     }
01001 
01002     phead-&gt;<a class="code" href="../../d4/d5/struct__HEAD.html#o0">h</a> = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a431">HMHandleFromIndex</a>(iheFree);
01003 
01004     <span class="keywordflow">if</span> (ppiQuotaCharge) {
01005         ppiQuotaCharge-&gt;UserHandleCount++;
01006         <a class="code" href="../../d4/d8/handtabl_8c.html#a2">DBGValidateHandleQuota</a>();
01007     }
01008 
01009 <span class="preprocessor">#if DBG</span>
01010 <span class="preprocessor"></span>    <span class="comment">/*</span>
01011 <span class="comment">     *   performance counter dumphmgr</span>
01012 <span class="comment">     *   dwPrevCount is used for the snapshot option</span>
01013 <span class="comment">     */</span>
01014 
01015     gaPerfhti[bType].lTotalCount++;
01016     gaPerfhti[bType].lCount++;
01017     <span class="keywordflow">if</span> (gaPerfhti[bType].lCount &gt; gaPerfhti[bType].lMaxCount) {
01018         gaPerfhti[bType].lMaxCount = gaPerfhti[bType].lCount;
01019     }
01020     <span class="keywordflow">if</span> ((bCreateFlags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a417">OCF_DESKTOPHEAP</a>) &amp;&amp; (pdeskSrc != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01021         gaPerfhti[bType].lSize += <a class="code" href="../../d1/d9/rtl_2heap_8c.html#a21">RtlSizeHeap</a>(Win32HeapGetHandle(pdeskSrc-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o16">pheapDesktop</a>), 0, phead);
01022     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bCreateFlags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a419">OCF_SHAREDHEAP</a>) {
01023         gaPerfhti[bType].lSize += <a class="code" href="../../d1/d9/rtl_2heap_8c.html#a21">RtlSizeHeap</a>(Win32HeapGetHandle(gpvSharedAlloc), 0, phead);
01024     } <span class="keywordflow">else</span> {
01025         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>  notUsed;
01026         gaPerfhti[bType].lSize += <a class="code" href="../../d5/d8/ex_8h.html#a228">ExQueryPoolBlockSize</a>(phead, &amp;notUsed);
01027     }
01028 
01029 <span class="preprocessor">#endif // DBG</span>
01030 <span class="preprocessor"></span>
01031     <span class="comment">/*</span>
01032 <span class="comment">     * Return a handle entry pointer.</span>
01033 <span class="comment">     */</span>
01034     <span class="keywordflow">return</span> pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o0">phead</a>;
01035 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="handtabl.c::HMAssignmentLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID FASTCALL HMAssignmentLock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>ppobj</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>pobj</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/handtabl_8c-source.html#l01509">1509</a> of file <a class="el" href="../../d5/d7/handtabl_8c-source.html">handtabl.c</a>.
<p>
References <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00034">FASTCALL</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01477">HMIsMarkDestroy</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01197">HMLockObject</a>, <a class="el" href="../../d4/d8/handtabl_8c.html#a11">HMRecordLock()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01186">HMUnlockObject</a>, <a class="el" href="../../d4/d8/handtabl_8c.html#a12">HMUnrecordLock()</a>, <a class="el" href="../../d1/d0/inc_2user_8h.html#a1181">HMValidateCatHandleNoSecure()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d0/client_2nt6_2user_8h.html#a1015">PHEAD</a>, and <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00926">TYPE_GENERIC</a>.
<p>
<pre class="fragment"><div>01512 {
01513     PVOID pobjOld;
01514 
01515     pobjOld = *ppobj;
01516     *ppobj = pobj;
01517 
01518     <span class="comment">/*</span>
01519 <span class="comment">     * Unlocks the old, locks the new.</span>
01520 <span class="comment">     */</span>
01521     <span class="keywordflow">if</span> (pobjOld != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01522 
01523         <span class="comment">/*</span>
01524 <span class="comment">         * if we are locking in the same object that is there then</span>
01525 <span class="comment">         * it is a no-op but we don't want to do the Unlock and the Lock</span>
01526 <span class="comment">         * because the unlock could free object and the lock would lock</span>
01527 <span class="comment">         * in a freed pointer; 6410.</span>
01528 <span class="comment">         */</span>
01529         <span class="keywordflow">if</span> (pobjOld == pobj) {
01530             <span class="keywordflow">return</span> pobjOld;
01531         }
01532 
01533 <span class="preprocessor">#if DEBUGTAGS</span>
01534 <span class="preprocessor"></span>
01535         <span class="comment">/*</span>
01536 <span class="comment">         * Track assignment locks.</span>
01537 <span class="comment">         */</span>
01538         <span class="keywordflow">if</span> (IsDbgTagEnabled(DBGTAG_TrackLocks)) {
01539             <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d8/handtabl_8c.html#a12">HMUnrecordLock</a>(ppobj, pobjOld)) {
01540                 <a class="code" href="../../d4/d8/handtabl_8c.html#a11">HMRecordLock</a>(ppobj, pobjOld, ((<a class="code" href="../../d4/d5/struct__HEAD.html">PHEAD</a>)pobjOld)-&gt;cLockObj - 1);
01541             }
01542         }
01543 <span class="preprocessor">#endif</span>
01544 <span class="preprocessor"></span>
01545     }
01546 
01547 
01548     <span class="keywordflow">if</span> (pobj != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01549         UserAssert(pobj == <a class="code" href="../../d1/d0/inc_2user_8h.html#a1181">HMValidateCatHandleNoSecure</a>(((<a class="code" href="../../d4/d5/struct__HEAD.html">PHEAD</a>)pobj)-&gt;h, TYPE_GENERIC));
01550         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a438">HMIsMarkDestroy</a>(pobj)) {
01551             RIPERR2(ERROR_INVALID_PARAMETER,
01552                     RIP_WARNING,
01553                     <span class="stringliteral">"HMAssignmentLock, locking object %#p marked for destruction at %#p\n"</span>,
01554                     pobj, ppobj);
01555         }
01556 <span class="preprocessor">#if DEBUGTAGS</span>
01557 <span class="preprocessor"></span>
01558         <span class="comment">/*</span>
01559 <span class="comment">         * Track assignment locks.</span>
01560 <span class="comment">         */</span>
01561         <span class="keywordflow">if</span> (IsDbgTagEnabled(DBGTAG_TrackLocks)) {
01562             <a class="code" href="../../d4/d8/handtabl_8c.html#a11">HMRecordLock</a>(ppobj, pobj, ((<a class="code" href="../../d4/d5/struct__HEAD.html">PHEAD</a>)pobj)-&gt;cLockObj + 1);
01563             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a438">HMIsMarkDestroy</a>(pobj)) {
01564 
01565                 RIPMSG2(RIP_WARNING,
01566                         <span class="stringliteral">"Locking object %#p marked for destruction at %#p"</span>,
01567                         pobj, ppobj);
01568             }
01569         }
01570 <span class="preprocessor">#endif</span>
01571 <span class="preprocessor"></span>        <a class="code" href="../../d4/d1/userk_8h.html#a112">HMLockObject</a>(pobj);
01572     }
01573 
01574 <span class="comment">/*</span>
01575 <span class="comment"> * This unlock has been moved from up above, so that we implement a</span>
01576 <span class="comment"> * "lock before unlock" strategy.  Just in case pobjOld was the</span>
01577 <span class="comment"> * only object referencing pobj, pobj won't go away when we unlock</span>
01578 <span class="comment"> * pobjNew -- it will have been locked above.</span>
01579 <span class="comment"> */</span>
01580 
01581     <span class="keywordflow">if</span> (pobjOld) {
01582         pobjOld = <a class="code" href="../../d4/d1/userk_8h.html#a110">HMUnlockObject</a>(pobjOld);
01583     }
01584 
01585     <span class="keywordflow">return</span> pobjOld;
01586 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="handtabl.c::HMAssignmentUnlock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID FASTCALL HMAssignmentUnlock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVOID *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ppobj</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/handtabl_8c-source.html#l01599">1599</a> of file <a class="el" href="../../d5/d7/handtabl_8c-source.html">handtabl.c</a>.
<p>
References <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00034">FASTCALL</a>, <a class="el" href="../../d4/d8/handtabl_8c.html#a11">HMRecordLock()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01186">HMUnlockObject</a>, <a class="el" href="../../d4/d8/handtabl_8c.html#a12">HMUnrecordLock()</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
<pre class="fragment"><div>01601 {
01602     PVOID pobjOld;
01603 
01604     pobjOld = *ppobj;
01605     *ppobj = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01606 
01607     <span class="comment">/*</span>
01608 <span class="comment">     * Unlocks the old, locks the new.</span>
01609 <span class="comment">     */</span>
01610     <span class="keywordflow">if</span> (pobjOld != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01611 
01612 <span class="preprocessor">#if DEBUGTAGS</span>
01613 <span class="preprocessor"></span>
01614         <span class="comment">/*</span>
01615 <span class="comment">         * Track assignment locks.</span>
01616 <span class="comment">         */</span>
01617         <span class="keywordflow">if</span> (IsDbgTagEnabled(DBGTAG_TrackLocks)) {
01618             <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d8/handtabl_8c.html#a12">HMUnrecordLock</a>(ppobj, pobjOld)) {
01619                 <a class="code" href="../../d4/d8/handtabl_8c.html#a11">HMRecordLock</a>(ppobj, pobjOld, ((<a class="code" href="../../d4/d5/struct__HEAD.html">PHEAD</a>)pobjOld)-&gt;cLockObj - 1);
01620             }
01621         }
01622 <span class="preprocessor">#endif</span>
01623 <span class="preprocessor"></span>        pobjOld = <a class="code" href="../../d4/d1/userk_8h.html#a110">HMUnlockObject</a>(pobjOld);
01624     }
01625 
01626     <span class="keywordflow">return</span> pobjOld;
01627 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="handtabl.c::HMChangeOwnerPheProcess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID HMChangeOwnerPheProcess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d2/d4/struct__HANDLEENTRY.html">PHE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>phe</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pti</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/handtabl_8c-source.html#l02220">2220</a> of file <a class="el" href="../../d5/d7/handtabl_8c-source.html">handtabl.c</a>.
<p>
References <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01438">tagHANDLETYPEINFO::bObjectCreateFlags</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01514">_HANDLEENTRY::bType</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l00269">DBGValidateHandleQuota</a>, <a class="el" href="../../d0/d6/ntuser_2kernel_2globals_8h-source.html#l00496">gahti</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01475">HMObjectFlags</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03173">tagTDB::hTaskWow</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01345">OCF_MARKPROCESS</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01344">OCF_PROCESSOWNED</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01512">_HANDLEENTRY::phead</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01447">_HANDLEENTRY::pOwner</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03319">tagTHREADINFO::ppi</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03352">tagTHREADINFO::ptdb</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02827">TIF_16BIT</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03331">tagTHREADINFO::TIF_flags</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00908">TYPE_CURSOR</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d5/d7/handtabl_8c-source.html#l02511">DestroyProcessesObjects()</a>.
<p>
<pre class="fragment"><div>02223 {
02224     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppiOwner = (<a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a>)(phe-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o1">pOwner</a>);
02225     PVOID pobj = phe-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o0">phead</a>;
02226 
02227     UserAssert(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a437">HMObjectFlags</a>(pobj) &amp; OCF_PROCESSOWNED);
02228     UserAssert(pti != NULL);
02229     <span class="comment">/*</span>
02230 <span class="comment">     * Dec current owner handle count</span>
02231 <span class="comment">     */</span>
02232     ppiOwner-&gt;UserHandleCount--;
02233     <span class="comment">/*</span>
02234 <span class="comment">     * hTaskWow</span>
02235 <span class="comment">     */</span>
02236     <span class="keywordflow">if</span> ((pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>) &amp;&amp; (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o22">ptdb</a>)) {
02237         ((<a class="code" href="../../d8/d0/struct__PROCOBJHEAD.html">PPROCOBJHEAD</a>)pobj)-&gt;hTaskWow = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o22">ptdb</a>-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o5">hTaskWow</a>;
02238     } <span class="keywordflow">else</span> {
02239         ((<a class="code" href="../../d8/d0/struct__PROCOBJHEAD.html">PPROCOBJHEAD</a>)pobj)-&gt;hTaskWow = 0;
02240     }
02241     <span class="comment">/*</span>
02242 <span class="comment">     * ppi</span>
02243 <span class="comment">     */</span>
02244     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d6/ntuser_2kernel_2globals_8h.html#a241">gahti</a>[phe-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o2">bType</a>].<a class="code" href="../../d1/d6/structtagHANDLETYPEINFO.html#o2">bObjectCreateFlags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a415">OCF_MARKPROCESS</a>) {
02245         ((<a class="code" href="../../d7/d0/struct__PROCMARKHEAD.html">PPROCMARKHEAD</a>)pobj)-&gt;ppi = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>;
02246     }
02247     <span class="comment">/*</span>
02248 <span class="comment">     * Set new owner in handle entry</span>
02249 <span class="comment">     */</span>
02250     phe-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o1">pOwner</a> = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>;
02251     <span class="comment">/*</span>
02252 <span class="comment">     * Inc new owner handle count</span>
02253 <span class="comment">     */</span>
02254     ((<a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a>)(phe-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o1">pOwner</a>))-&gt;UserHandleCount++;
02255     <span class="comment">/*</span>
02256 <span class="comment">     * If the handle is a cursor, adjust GDI cursor handle count</span>
02257 <span class="comment">     */</span>
02258     <span class="keywordflow">if</span> (phe-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o2">bType</a> == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a239">TYPE_CURSOR</a>) {
02259         GreDecQuotaCount((PW32PROCESS)ppiOwner);
02260         GreIncQuotaCount((PW32PROCESS)phe-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o1">pOwner</a>);
02261 
02262         <span class="keywordflow">if</span> (((<a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a>)pobj)-&gt;hbmColor) {
02263             GreDecQuotaCount((PW32PROCESS)ppiOwner);
02264             GreIncQuotaCount((PW32PROCESS)phe-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o1">pOwner</a>);
02265         }
02266     }
02267 
02268     <a class="code" href="../../d4/d8/handtabl_8c.html#a2">DBGValidateHandleQuota</a>();
02269 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="handtabl.c::HMChangeOwnerThread" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID HMChangeOwnerThread           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>pobj</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pti</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/handtabl_8c-source.html#l02112">2112</a> of file <a class="el" href="../../d5/d7/handtabl_8c-source.html">handtabl.c</a>.
<p>
References <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01738">tagCLS::atomClassName</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01297">tagSERVERINFO::atomSysClass</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01514">_HANDLEENTRY::bType</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03391">tagTHREADINFO::cVisWindows</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03390">tagTHREADINFO::cWindows</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01662">tagCLS::cWndReferenceCount</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l00269">DBGValidateHandleQuota</a>, <a class="el" href="../../d3/d6/class_8c-source.html#l01735">DereferenceClass()</a>, <a class="el" href="../../d3/d7/swp_8c-source.html#l05107">FVisCountable()</a>, <a class="el" href="../../d3/d6/class_8c-source.html#l01036">GetClassPtr()</a>, <a class="el" href="../../d2/d7/clglobal_8c-source.html#l00051">gpsi</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00455">gptiRit</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01827">tagWND::head</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02007">HF_GLOBAL</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01475">HMObjectFlags</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00734">hModuleWin</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01510">HMPheFromObject</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00352">ICLS_ICONTITLE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01640">LockDesktop</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01343">OCF_THREADOWNED</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01843">tagWND::pcls</a>, <a class="el" href="../../d0/d0/client_2nt6_2user_8h.html#a1063">PHOOK</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01447">_HANDLEENTRY::pOwner</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03319">tagTHREADINFO::ppi</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00084">PpiCurrent</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03327">tagTHREADINFO::rpdesk</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02555">TestWF</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00910">TYPE_HOOK</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00906">TYPE_WINDOW</a>, <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02304">WFDESTROYED</a>, and <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02419">WFVISIBLE</a>.
<p>
Referenced by <a class="el" href="../../d5/d7/handtabl_8c-source.html#l02595">MarkThreadsObjects()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l01797">xxxCreateDesktop()</a>, <a class="el" href="../../d9/d7/winsta_8c-source.html#l00243">xxxCreateWindowStation()</a>, <a class="el" href="../../d5/d7/createw_8c-source.html#l01591">xxxDestroyWindow()</a>, <a class="el" href="../../d5/d7/createw_8c-source.html#l02218">xxxFreeWindow()</a>, and <a class="el" href="../../d3/d6/ntuser_2kernel_2menu_8c-source.html#l01934">xxxMNOpenHierarchy()</a>.
<p>
<pre class="fragment"><div>02115 {
02116     <a class="code" href="../../d2/d4/struct__HANDLEENTRY.html">PHE</a> phe = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a446">HMPheFromObject</a>(pobj);
02117     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiOld = ((<a class="code" href="../../d1/d1/struct__THROBJHEAD.html">PTHROBJHEAD</a>)(pobj))-&gt;pti;
02118     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
02119     <a class="code" href="../../d7/d0/structtagCLS.html">PPCLS</a> ppcls;
02120     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a>   ppi;
02121 
02122     UserAssert(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a437">HMObjectFlags</a>(pobj) &amp; OCF_THREADOWNED);
02123     UserAssert(pti != NULL);
02124 
02125     ((<a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>)phe-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o1">pOwner</a>)-&gt;ppi-&gt;UserHandleCount--;
02126 
02127     ((<a class="code" href="../../d1/d1/struct__THROBJHEAD.html">PTHROBJHEAD</a>)pobj)-&gt;pti = phe-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o1">pOwner</a> = pti;
02128 
02129     ((<a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>)phe-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o1">pOwner</a>)-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;UserHandleCount++;
02130 
02131     <a class="code" href="../../d4/d8/handtabl_8c.html#a2">DBGValidateHandleQuota</a>();
02132 
02133     <span class="comment">/*</span>
02134 <span class="comment">     * If this is a window, update the window counts.</span>
02135 <span class="comment">     */</span>
02136     <span class="keywordflow">switch</span> (phe-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o2">bType</a>) {
02137     <span class="keywordflow">case</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a237">TYPE_WINDOW</a>:
02138         <span class="comment">/*</span>
02139 <span class="comment">         * Desktop thread used to hit this assert in HYDRA</span>
02140 <span class="comment">         * because pti == ptiOld</span>
02141 <span class="comment">         */</span>
02142         UserAssert(ptiOld-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o49">cWindows</a> &gt; 0 || ptiOld == pti);
02143         pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o49">cWindows</a>++;
02144         ptiOld-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o49">cWindows</a>--;
02145 
02146         pwnd = (<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)pobj;
02147 
02148         <span class="comment">/*</span>
02149 <span class="comment">         * Make sure thread visible window count is properly updated.</span>
02150 <span class="comment">         */</span>
02151         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WFVISIBLE) &amp;&amp; <a class="code" href="../../d4/d1/userk_8h.html#a1625">FVisCountable</a>(pwnd)) {
02152             pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o50">cVisWindows</a>++;
02153             ptiOld-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o50">cVisWindows</a>--;
02154         }
02155 
02156         <span class="comment">/*</span>
02157 <span class="comment">         * If the owning process is changing, fix up</span>
02158 <span class="comment">         * the window class.</span>
02159 <span class="comment">         */</span>
02160         <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a> != ptiOld-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>) {
02161 
02162             ppcls = <a class="code" href="../../d4/d1/userk_8h.html#a1152">GetClassPtr</a>(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o9">pcls</a>-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o1">atomClassName</a>, pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>, hModuleWin);
02163 
02164             <span class="keywordflow">if</span> (ppcls == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02165                 <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.rpdesk)
02166                     ppi = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.rpdesk-&gt;rpwinstaParent-&gt;pTerm-&gt;ptiDesktop-&gt;ppi;
02167                 <span class="keywordflow">else</span>
02168                     ppi = <a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>();
02169                 ppcls = <a class="code" href="../../d4/d1/userk_8h.html#a1152">GetClassPtr</a>(<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o12">atomSysClass</a>[ICLS_ICONTITLE], ppi, hModuleWin);
02170             }
02171             UserAssert(ppcls);
02172 
02173             <span class="comment">/*</span>
02174 <span class="comment">             * The window is either destroyed or the desktop of the class is</span>
02175 <span class="comment">             * the same as the window's desktop</span>
02176 <span class="comment">             */</span>
02177             UserAssert((*ppcls)-&gt;rpdeskParent == pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.rpdesk ||
02178                        <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WFDESTROYED));
02179 
02180             <a class="code" href="../../d4/d1/userk_8h.html#a1154">DereferenceClass</a>(pwnd);
02181             pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o9">pcls</a> = *ppcls;
02182             pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o9">pcls</a>-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o5">cWndReferenceCount</a>++;
02183         }
02184         <span class="keywordflow">break</span>;
02185 
02186     <span class="keywordflow">case</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a241">TYPE_HOOK</a>:
02187         <span class="comment">/*</span>
02188 <span class="comment">         * If this is a global hook, remember this hook's desktop so we'll be</span>
02189 <span class="comment">         * able to unlink it later (gptiRit might switch to a different desktop</span>
02190 <span class="comment">         * at any time).</span>
02191 <span class="comment">         */</span>
02192         UserAssert(!!(((<a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a>)pobj)-&gt;flags &amp; HF_GLOBAL) ^ (((<a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a>)pobj)-&gt;ptiHooked != NULL));
02193         <span class="keywordflow">if</span> (((<a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a>)pobj)-&gt;flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a502">HF_GLOBAL</a>) {
02194             UserAssert(pti == gptiRit);
02195             <a class="code" href="../../d4/d1/userk_8h.html#a126">LockDesktop</a>(&amp;((<a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a>)pobj)-&gt;rpdesk, ptiOld-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>, LDL_HOOK_DESK, 0);
02196         } <span class="keywordflow">else</span> {
02197             <span class="comment">/*</span>
02198 <span class="comment">             * This must be a hook on another thread or it was supposed to be</span>
02199 <span class="comment">             *  gone by now.</span>
02200 <span class="comment">             */</span>
02201             UserAssert(((<a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a>)pobj)-&gt;ptiHooked != ptiOld);
02202         }
02203         <span class="keywordflow">break</span>;
02204 
02205     <span class="keywordflow">default</span>:
02206         <span class="keywordflow">break</span>;
02207     }
02208 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a32" doxytag="handtabl.c::HMCleanupGrantedHandle" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> void HMCleanupGrantedHandle           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">HANDLE&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>h</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/handtabl_8c-source.html#l02853">2853</a> of file <a class="el" href="../../d5/d7/handtabl_8c-source.html">handtabl.c</a>.
<p>
References <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00259">gpJobsList</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03453">tagW32JOB::pgh</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03444">tagW32JOB::pNext</a>, and <a class="el" href="../../d5/d0/userk_8h-source.html#l03451">tagW32JOB::ughCrt</a>.
<p>
Referenced by <a class="el" href="../../d5/d7/handtabl_8c-source.html#l01069">HMFreeObject()</a>.
<p>
<pre class="fragment"><div>02855 {
02856     <a class="code" href="../../d1/d9/structtagW32JOB.html">PW32JOB</a> pW32Job;
02857 
02858     pW32Job = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a113">gpJobsList</a>;
02859 
02860     <span class="keywordflow">while</span> (pW32Job != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02861         PULONG_PTR pgh;
02862         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>  dw;
02863 
02864         pgh = pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o9">pgh</a>;
02865 
02866         <span class="comment">/*</span>
02867 <span class="comment">         * search for the handle in the array.</span>
02868 <span class="comment">         */</span>
02869         <span class="keywordflow">for</span> (dw = 0; dw &lt; pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o7">ughCrt</a>; dw++) {
02870             <span class="keywordflow">if</span> (*(pgh + dw) == (ULONG_PTR)h) {
02871 
02872                 <span class="comment">/*</span>
02873 <span class="comment">                 * found the handle granted to this process</span>
02874 <span class="comment">                 */</span>
02875                 RtlMoveMemory(pgh + dw,
02876                               pgh + dw + 1,
02877                               (pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o7">ughCrt</a> - dw - 1) * <span class="keyword">sizeof</span>(*pgh));
02878 
02879                 (pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o7">ughCrt</a>)--;
02880 
02881                 <span class="comment">/*</span>
02882 <span class="comment">                 * we should shrink the array also</span>
02883 <span class="comment">                 */</span>
02884 
02885                 <span class="keywordflow">break</span>;
02886             }
02887         }
02888 
02889         pW32Job = pW32Job-&gt;<a class="code" href="../../d1/d9/structtagW32JOB.html#o0">pNext</a>;
02890     }
02891 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="handtabl.c::HMDestroyObject" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL HMDestroyObject           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pobj</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/handtabl_8c-source.html#l01299">1299</a> of file <a class="el" href="../../d5/d7/handtabl_8c-source.html">handtabl.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l01069">HMFreeObject()</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l01237">HMMarkObjectDestroy()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d5/d7/handtabl_8c-source.html#l00028">HMNullFnDestroy()</a>.
<p>
<pre class="fragment"><div>01301 {
01302     <span class="comment">/*</span>
01303 <span class="comment">     * First mark the object for destruction.  This tells the locking code</span>
01304 <span class="comment">     * that we want to destroy this object when the lock count goes to 0.</span>
01305 <span class="comment">     * If this returns FALSE, we can't destroy the object yet (and can't get</span>
01306 <span class="comment">     * rid of security yet either.)</span>
01307 <span class="comment">     */</span>
01308 
01309     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a971">HMMarkObjectDestroy</a>(pobj))
01310         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01311 
01312     <span class="comment">/*</span>
01313 <span class="comment">     * Ok to destroy...  Free the handle (which will free the object</span>
01314 <span class="comment">     * and the handle).</span>
01315 <span class="comment">     */</span>
01316     <a class="code" href="../../d4/d1/userk_8h.html#a970">HMFreeObject</a>(pobj);
01317     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01318 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="handtabl.c::HMDestroyUnlockedObject" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> void HMDestroyUnlockedObject           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d2/d4/struct__HANDLEENTRY.html">PHE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>phe</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/handtabl_8c-source.html#l02069">2069</a> of file <a class="el" href="../../d5/d7/handtabl_8c-source.html">handtabl.c</a>.
<p>
References <a class="el" href="../../d5/d0/userk_8h-source.html#l01838">BEGINATOMICCHECK</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01515">_HANDLEENTRY::bFlags</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01514">_HANDLEENTRY::bType</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01448">_HEAD::cLockObj</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01842">ENDATOMICCHECK</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01436">tagHANDLETYPEINFO::fnDestroy</a>, <a class="el" href="../../d0/d6/ntuser_2kernel_2globals_8h-source.html#l00496">gahti</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01429">HANDLEF_DESTROY</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01430">HANDLEF_INDESTROY</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01512">_HANDLEENTRY::phead</a>, and <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00905">TYPE_FREE</a>.
<p>
<pre class="fragment"><div>02071 {
02072     <a class="code" href="../../d4/d1/userk_8h.html#a159">BEGINATOMICCHECK</a>();
02073 
02074     <span class="comment">/*</span>
02075 <span class="comment">     * Remember that we're destroying this object so we don't try to destroy</span>
02076 <span class="comment">     * it again when the lock count goes from != 0 to 0 (especially true</span>
02077 <span class="comment">     * for thread locks).</span>
02078 <span class="comment">     */</span>
02079     phe-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o3">bFlags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a422">HANDLEF_INDESTROY</a>;
02080 
02081     <span class="comment">/*</span>
02082 <span class="comment">     * This'll call the destroy handler for this object type.</span>
02083 <span class="comment">     */</span>
02084     (*<a class="code" href="../../d9/d6/ntuser_2kernel_2globals_8h.html#a241">gahti</a>[phe-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o2">bType</a>].<a class="code" href="../../d1/d6/structtagHANDLETYPEINFO.html#o0">fnDestroy</a>)(phe-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o0">phead</a>);
02085 
02086     <span class="comment">/*</span>
02087 <span class="comment">     * HANDLEF_INDESTROY is supposed to be cleared either by HMMarkObjectDestroy</span>
02088 <span class="comment">     *  or by HMFreeObject; the destroy handler was supposed to call at least</span>
02089 <span class="comment">     *  the former.</span>
02090 <span class="comment">     */</span>
02091     UserAssert(!(phe-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o3">bFlags</a> &amp; HANDLEF_INDESTROY));
02092 
02093     <span class="comment">/*</span>
02094 <span class="comment">     * If the object wasn't freed, it must be marked as destroyed</span>
02095 <span class="comment">     *  and must have a lock count</span>
02096 <span class="comment">     */</span>
02097     UserAssert((phe-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o2">bType</a> == TYPE_FREE)
02098                 || ((phe-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o3">bFlags</a> &amp; HANDLEF_DESTROY) &amp;&amp; (phe-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o0">phead</a>-&gt;<a class="code" href="../../d4/d5/struct__HEAD.html#o1">cLockObj</a> &gt; 0)));
02099 
02100     <a class="code" href="../../d4/d1/userk_8h.html#a163">ENDATOMICCHECK</a>();
02101 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="handtabl.c::HMFreeObject" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL HMFreeObject           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pobj</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/handtabl_8c-source.html#l01069">1069</a> of file <a class="el" href="../../d5/d7/handtabl_8c-source.html">handtabl.c</a>.
<p>
References <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01278">tagSHAREDINFO::aheList</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01515">_HANDLEENTRY::bFlags</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01438">tagHANDLETYPEINFO::bObjectCreateFlags</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01514">_HANDLEENTRY::bType</a>, <a class="el" href="../../d0/d7/halvprnt_8c-source.html#l00031">BYTE</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l00455">DBGHMValidateFreeLists</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l00269">DBGValidateHandleQuota</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02697">DesktopFree</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l03328">ExQueryPoolBlockSize()</a>, <a class="el" href="../../d0/d6/ntuser_2kernel_2globals_8h-source.html#l00496">gahti</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l00208">gcHandlePages</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l00209">gpHandlePages</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00921">gpvSharedAlloc</a>, <a class="el" href="../../d2/d7/clglobal_8c-source.html#l00052">gSharedInfo</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01380">_HEAD::h</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01434">HANDLEF_GRANTED</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01500">HANDLEF_POOL</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l02853">HMCleanupGrantedHandle()</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01510">HMPheFromObject</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01467">HMUNIQBITS</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01169">HtoPqCat</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01139">_HANDLEPAGE::iheFreeEven</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01140">_HANDLEPAGE::iheFreeOdd</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01138">_HANDLEPAGE::iheLimit</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01131">tagPERFINFO::lCount</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01134">tagPERFINFO::lSize</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01347">OCF_DESKTOPHEAP</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01344">OCF_PROCESSOWNED</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01349">OCF_SHAREDHEAP</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01343">OCF_THREADOWNED</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01512">_HANDLEENTRY::phead</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02664">tagDESKTOP::pheapDesktop</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02375">_LOCKRECORD::plrNext</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01447">_HANDLEENTRY::pOwner</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01513">PtoHq</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l03655">RtlSizeHeap()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02143">SharedFree()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00905">TYPE_FREE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01649">UnlockDesktop</a>, and <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01516">_HANDLEENTRY::wUniq</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/swp_8c-source.html#l00272">_BeginDeferWindowPos()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00088">_ConvertMemHandle()</a>, <a class="el" href="../../d2/d1/mnaccel_8c-source.html#l00217">_CreateAcceleratorTable()</a>, <a class="el" href="../../d8/d1/mndstry_8c-source.html#l00027">_DestroyMenu()</a>, <a class="el" href="../../d8/d3/loadbits_8c-source.html#l00138">DestroyEmptyCursorObject()</a>, <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00879">DestroyEventHook()</a>, <a class="el" href="../../d7/d1/kbdlyout_8c-source.html#l00435">DestroyKF()</a>, <a class="el" href="../../d7/d1/kbdlyout_8c-source.html#l01688">DestroyKL()</a>, <a class="el" href="../../d2/d4/multimon_8c-source.html#l00249">DestroyMonitor()</a>, <a class="el" href="../../d3/d7/swp_8c-source.html#l00064">DestroySMWP()</a>, <a class="el" href="../../d6/d3/kernel_2ddetrack_8c-source.html#l02042">FreeDdeConv()</a>, <a class="el" href="../../d6/d3/kernel_2ddetrack_8c-source.html#l02285">FreeDdeXact()</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l01976">FreeHook()</a>, <a class="el" href="../../d6/d7/ntimm_8c-source.html#l00198">FreeInputContext()</a>, <a class="el" href="../../d5/d1/timers_8c-source.html#l00112">FreeTimer()</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l01299">HMDestroyObject()</a>, <a class="el" href="../../d5/d1/timers_8c-source.html#l00225">InternalSetTimer()</a>, <a class="el" href="../../d7/d1/kbdlyout_8c-source.html#l00316">LoadKeyboardLayoutFile()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00335">MungeClipData()</a>, <a class="el" href="../../d6/d3/kernel_2ddetrack_8c-source.html#l01766">NewConversation()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l04012">NtUserDestroyAcceleratorTable()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l00701">UT_FreeCBFormat()</a>, <a class="el" href="../../d5/d7/createw_8c-source.html#l00033">xxxCreateWindowEx()</a>, <a class="el" href="../../d2/d3/ddemlsvr_8c-source.html#l00019">xxxCsDdeInitialize()</a>, <a class="el" href="../../d2/d3/ddemlsvr_8c-source.html#l00127">xxxDestroyThreadDDEObject()</a>, <a class="el" href="../../d5/d7/createw_8c-source.html#l02218">xxxFreeWindow()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l01784">xxxGetDummyDib()</a>, <a class="el" href="../../d9/d7/ntuser_2kernel_2clipbrd_8c-source.html#l01907">xxxGetDummyDibV5()</a>, and <a class="el" href="../../d2/d1/hooks_8c-source.html#l00576">zzzSetWindowsHookEx()</a>.
<p>
<pre class="fragment"><div>01071 {
01072     <a class="code" href="../../d2/d4/struct__HANDLEENTRY.html">PHE</a>         pheT;
01073     WORD        wUniqT;
01074     <a class="code" href="../../d4/d4/struct__HANDLEPAGE.html">PHANDLEPAGE</a> php;
01075     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>       i;
01076     ULONG_PTR    iheCurrent, *piheCurrentHead;
01077     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>        bCreateFlags;
01078     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a>    pdesk;
01079     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppiQuotaCharge = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01080 <span class="preprocessor">#if DBG</span>
01081 <span class="preprocessor"></span>    <a class="code" href="../../d1/d3/struct__LOCKRECORD.html">PLR</a>         plrT, plrNextT;
01082     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>  notUsed;
01083 <span class="preprocessor">#endif</span>
01084 <span class="preprocessor"></span>
01085     UserAssert(((<a class="code" href="../../d4/d5/struct__HEAD.html">PHEAD</a>)pobj)-&gt;cLockObj == 0);
01086     UserAssert(pobj == <a class="code" href="../../d4/d1/userk_8h.html#a101">HtoPqCat</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a449">PtoHq</a>(pobj)));
01087     <span class="comment">/*</span>
01088 <span class="comment">     * Free the object first.</span>
01089 <span class="comment">     */</span>
01090     pheT = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a446">HMPheFromObject</a>(pobj);
01091     bCreateFlags = <a class="code" href="../../d9/d6/ntuser_2kernel_2globals_8h.html#a241">gahti</a>[pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o2">bType</a>].<a class="code" href="../../d1/d6/structtagHANDLETYPEINFO.html#o2">bObjectCreateFlags</a>;
01092 
01093     UserAssertMsg1(pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o2">bType</a> != TYPE_FREE,
01094                    <span class="stringliteral">"Object already marked as freed!!! %#p"</span>, pobj);
01095 
01096     <span class="comment">/*</span>
01097 <span class="comment">     * decr process handle use</span>
01098 <span class="comment">     */</span>
01099     <span class="keywordflow">if</span> (bCreateFlags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a414">OCF_PROCESSOWNED</a>) {
01100         ppiQuotaCharge = (<a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a>)pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o1">pOwner</a>;
01101         UserAssert(ppiQuotaCharge != NULL);
01102     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bCreateFlags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a413">OCF_THREADOWNED</a>) {
01103         ppiQuotaCharge = (<a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a>)(((<a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>)(pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o1">pOwner</a>))-&gt;ppi);
01104         UserAssert(ppiQuotaCharge != NULL);
01105     } <span class="keywordflow">else</span> {
01106         ppiQuotaCharge = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01107     }
01108 
01109     <span class="keywordflow">if</span> (ppiQuotaCharge != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01110         ppiQuotaCharge-&gt;UserHandleCount--;
01111     }
01112 
01113     <span class="keywordflow">if</span> (pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o3">bFlags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a426">HANDLEF_GRANTED</a>) {
01114         <a class="code" href="../../d4/d1/userk_8h.html#a978">HMCleanupGrantedHandle</a>(pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o0">phead</a>-&gt;<a class="code" href="../../d4/d5/struct__HEAD.html#o0">h</a>);
01115         pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o3">bFlags</a> &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a426">HANDLEF_GRANTED</a>;
01116     }
01117 
01118 <span class="preprocessor">#if DBG</span>
01119 <span class="preprocessor"></span>    <span class="comment">/*</span>
01120 <span class="comment">     *   performance counters</span>
01121 <span class="comment">     */</span>
01122     gaPerfhti[pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o2">bType</a>].lCount--;
01123 
01124     <span class="keywordflow">if</span> ((bCreateFlags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a417">OCF_DESKTOPHEAP</a>) &amp;&amp; ((<a class="code" href="../../d8/d2/struct__DESKOBJHEAD.html">PDESKOBJHEAD</a>)pobj)-&gt;rpdesk) {
01125         pdesk = ((<a class="code" href="../../d8/d2/struct__DESKOBJHEAD.html">PDESKOBJHEAD</a>)pobj)-&gt;rpdesk;
01126         gaPerfhti[pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o2">bType</a>].lSize -= <a class="code" href="../../d1/d9/rtl_2heap_8c.html#a21">RtlSizeHeap</a>(Win32HeapGetHandle(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o16">pheapDesktop</a>), 0, pobj);
01127     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bCreateFlags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a419">OCF_SHAREDHEAP</a>) {
01128         gaPerfhti[pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o2">bType</a>].lSize -= <a class="code" href="../../d1/d9/rtl_2heap_8c.html#a21">RtlSizeHeap</a>(Win32HeapGetHandle(gpvSharedAlloc), 0, pobj);
01129     } <span class="keywordflow">else</span> {
01130         gaPerfhti[pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o2">bType</a>].lSize -= <a class="code" href="../../d5/d8/ex_8h.html#a228">ExQueryPoolBlockSize</a>(pobj, &amp;notUsed);
01131     }
01132 
01133 <span class="preprocessor">#endif // DBG</span>
01134 <span class="preprocessor"></span>
01135     <span class="keywordflow">if</span> ((bCreateFlags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a417">OCF_DESKTOPHEAP</a>)) {
01136 <span class="preprocessor">#if DBG</span>
01137 <span class="preprocessor"></span>        <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bSuccess;
01138 <span class="preprocessor">#endif</span>
01139 <span class="preprocessor"></span>        UserAssert(((<a class="code" href="../../d8/d2/struct__DESKOBJHEAD.html">PDESKOBJHEAD</a>)pobj)-&gt;rpdesk != NULL);
01140 
01141         pdesk = ((<a class="code" href="../../d8/d2/struct__DESKOBJHEAD.html">PDESKOBJHEAD</a>)pobj)-&gt;rpdesk;
01142         <a class="code" href="../../d4/d1/userk_8h.html#a127">UnlockDesktop</a>(&amp;((<a class="code" href="../../d8/d2/struct__DESKOBJHEAD.html">PDESKOBJHEAD</a>)pobj)-&gt;rpdesk, LDU_OBJ_DESK, (ULONG_PTR)pobj);
01143 
01144         <span class="keywordflow">if</span> (pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o3">bFlags</a> &amp; <a class="code" href="../../d1/d0/inc_2user_8h.html#a417">HANDLEF_POOL</a>) {
01145             UserFreePool(pobj);
01146         } <span class="keywordflow">else</span> {
01147 
01148 <span class="preprocessor">#if DBG</span>
01149 <span class="preprocessor"></span>            bSuccess =
01150 <span class="preprocessor">#endif</span>
01151 <span class="preprocessor"></span>            <a class="code" href="../../d4/d1/userk_8h.html#a313">DesktopFree</a>(pdesk, pobj);
01152 <span class="preprocessor">#if DBG</span>
01153 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (!bSuccess) {
01154                 <span class="comment">/*</span>
01155 <span class="comment">                 * We would hit this assert in HYDRA trying to free the</span>
01156 <span class="comment">                 * mother desktop window which was allocated out of pool</span>
01157 <span class="comment">                 */</span>
01158                 RIPMSG1(RIP_ERROR, <span class="stringliteral">"Object already freed from desktop heap! %#p"</span>, pobj);
01159             }
01160 <span class="preprocessor">#endif</span>
01161 <span class="preprocessor"></span>        }
01162 
01163     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bCreateFlags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a419">OCF_SHAREDHEAP</a>) {
01164         <a class="code" href="../../d4/d1/userk_8h.html#a1001">SharedFree</a>(pobj);
01165     } <span class="keywordflow">else</span> {
01166         UserFreePool(pobj);
01167     }
01168 
01169 <span class="preprocessor">#if DBG</span>
01170 <span class="preprocessor"></span>    <span class="comment">/*</span>
01171 <span class="comment">     * Go through and delete the lock records, if they exist.</span>
01172 <span class="comment">     */</span>
01173     <span class="keywordflow">for</span> (plrT = pheT-&gt;plr; plrT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; plrT = plrNextT) {
01174 
01175         <span class="comment">/*</span>
01176 <span class="comment">         * Remember the next one before freeing this one.</span>
01177 <span class="comment">         */</span>
01178         plrNextT = plrT-&gt;<a class="code" href="../../d1/d3/struct__LOCKRECORD.html#o0">plrNext</a>;
01179         FreeLockRecord((HANDLE)plrT);
01180     }
01181 <span class="preprocessor">#endif</span>
01182 <span class="preprocessor"></span>
01183     <span class="comment">/*</span>
01184 <span class="comment">     * Clear the handle contents. Need to remember the uniqueness across</span>
01185 <span class="comment">     * the clear. Also, advance uniqueness on free so that uniqueness checking</span>
01186 <span class="comment">     * against old handles also fails.</span>
01187 <span class="comment">     */</span>
01188     wUniqT = (WORD)((pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o4">wUniq</a> + 1) &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a430">HMUNIQBITS</a>);
01189     RtlZeroMemory(pheT, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html">HANDLEENTRY</a>));
01190     pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o4">wUniq</a> = wUniqT;
01191 
01192     <span class="comment">/*</span>
01193 <span class="comment">     * Change the handle type to TYPE_FREE so we know what type this handle</span>
01194 <span class="comment">     * is. (TYPE_FREE is defined as zero)</span>
01195 <span class="comment">     */</span>
01196     <span class="comment">/* pheT-&gt;bType = TYPE_FREE; */</span>
01197     UserAssert(pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o2">bType</a> == TYPE_FREE);
01198 
01199     <span class="comment">/*</span>
01200 <span class="comment">     * Put the handle on the free list of the appropriate page.</span>
01201 <span class="comment">     */</span>
01202     php = <a class="code" href="../../d4/d8/handtabl_8c.html#a8">gpHandlePages</a>;
01203     iheCurrent = pheT - <a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o1">aheList</a>;
01204     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d4/d8/handtabl_8c.html#a7">gcHandlePages</a>; ++i, ++php) {
01205         <span class="keywordflow">if</span> (iheCurrent &lt; php-&gt;<a class="code" href="../../d4/d4/struct__HANDLEPAGE.html#o0">iheLimit</a>) {
01206             piheCurrentHead = (iheCurrent &amp; 0x1 ? &amp;php-&gt;<a class="code" href="../../d4/d4/struct__HANDLEPAGE.html#o2">iheFreeOdd</a> : &amp;php-&gt;<a class="code" href="../../d4/d4/struct__HANDLEPAGE.html#o1">iheFreeEven</a>);
01207             pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o0">phead</a> = (<a class="code" href="../../d4/d5/struct__HEAD.html">PHEAD</a>)*piheCurrentHead;
01208             *piheCurrentHead = iheCurrent;
01209             <a class="code" href="../../d4/d8/handtabl_8c.html#a3">DBGHMValidateFreeLists</a>();
01210             <span class="keywordflow">break</span>;
01211         }
01212     }
01213     <span class="comment">/*</span>
01214 <span class="comment">     * We must have found it.</span>
01215 <span class="comment">     */</span>
01216     UserAssert(i &lt; gcHandlePages);
01217 
01218     UserAssert(pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o1">pOwner</a> == NULL);
01219 
01220     <a class="code" href="../../d4/d8/handtabl_8c.html#a2">DBGValidateHandleQuota</a>();
01221 
01222     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01223 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="handtabl.c::HMGrowHandleTable" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL HMGrowHandleTable           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/handtabl_8c-source.html#l00704">704</a> of file <a class="el" href="../../d5/d7/handtabl_8c-source.html">handtabl.c</a>.
<p>
References <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01278">tagSHAREDINFO::aheList</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01514">_HANDLEENTRY::bType</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01292">tagSERVERINFO::cbHandleTable</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01189">tagSERVERINFO::cHandleEntries</a>, <a class="el" href="../../d5/d7/ex_8c-source.html#l00278">CommitReadOnlyMemory()</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l00206">CPAGEENTRIESINIT</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l00208">gcHandlePages</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00918">ghSectionShared</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l00209">gpHandlePages</a>, <a class="el" href="../../d2/d7/clglobal_8c-source.html#l00051">gpsi</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00921">gpvSharedAlloc</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00919">gpvSharedBase</a>, <a class="el" href="../../d2/d7/clglobal_8c-source.html#l00052">gSharedInfo</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01465">HMINDEXBITS</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l00529">HMInitHandleEntries()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01139">_HANDLEPAGE::iheFreeEven</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01140">_HANDLEPAGE::iheFreeOdd</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01138">_HANDLEPAGE::iheLimit</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d0/d7/halvprnt_8c-source.html#l00031">PBYTE</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01512">_HANDLEENTRY::phead</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00905">TYPE_FREE</a>, and <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01516">_HANDLEENTRY::wUniq</a>.
<p>
Referenced by <a class="el" href="../../d5/d7/handtabl_8c-source.html#l00828">HMAllocObject()</a>.
<p>
<pre class="fragment"><div>00705 {
00706     ULONG_PTR   i, iheFirstFree;
00707     <a class="code" href="../../d2/d4/struct__HANDLEENTRY.html">PHE</a>         pheT;
00708     PVOID       p;
00709     <a class="code" href="../../d4/d4/struct__HANDLEPAGE.html">PHANDLEPAGE</a> phpNew;
00710     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>       dwCommitOffset;
00711     SIZE_T      ulCommit;
00712     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00713 
00714     <span class="comment">/*</span>
00715 <span class="comment">     * If we've run out of handle space, fail.</span>
00716 <span class="comment">     */</span>
00717     i = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o4">cHandleEntries</a>;
00718     <span class="keywordflow">if</span> (i &amp; ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a428">HMINDEXBITS</a>)
00719         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00720 
00721     <span class="comment">/*</span>
00722 <span class="comment">     * Grow the page table if need be.</span>
00723 <span class="comment">     */</span>
00724     i = <a class="code" href="../../d4/d8/handtabl_8c.html#a7">gcHandlePages</a> + 1;
00725     <span class="keywordflow">if</span> (i &gt; <a class="code" href="../../d4/d8/handtabl_8c.html#a1">CPAGEENTRIESINIT</a>) {
00726         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwSize = <a class="code" href="../../d4/d8/handtabl_8c.html#a7">gcHandlePages</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d4/struct__HANDLEPAGE.html">HANDLEPAGE</a>);
00727 
00728         phpNew = UserReAllocPool(
00729                 gpHandlePages, dwSize, dwSize + <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d4/struct__HANDLEPAGE.html">HANDLEPAGE</a>), TAG_SYSTEM);
00730 
00731         <span class="keywordflow">if</span> (phpNew == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00732             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00733 
00734         <a class="code" href="../../d4/d8/handtabl_8c.html#a8">gpHandlePages</a> = phpNew;
00735     }
00736 
00737     <span class="comment">/*</span>
00738 <span class="comment">     * Commit some more pages to the table.  First find the</span>
00739 <span class="comment">     * address where the commitment needs to be.</span>
00740 <span class="comment">     */</span>
00741     p = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)<a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o1">aheList</a> + <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o11">cbHandleTable</a>;
00742 
00743     <span class="keywordflow">if</span> (p &gt;= Win32HeapGetHandle(gpvSharedAlloc)) {
00744         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00745     }
00746 
00747     dwCommitOffset = (ULONG)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)p - (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a321">gpvSharedBase</a>);
00748 
00749     ulCommit = <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
00750 
00751     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1002">CommitReadOnlyMemory</a>(ghSectionShared, &amp;ulCommit, dwCommitOffset, NULL);
00752 
00753     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
00754         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00755 
00756     phpNew = &amp;<a class="code" href="../../d4/d8/handtabl_8c.html#a8">gpHandlePages</a>[<a class="code" href="../../d4/d8/handtabl_8c.html#a7">gcHandlePages</a>++];
00757 
00758     <span class="comment">/*</span>
00759 <span class="comment">     * Update the global information to include the new</span>
00760 <span class="comment">     * page.</span>
00761 <span class="comment">     */</span>
00762     iheFirstFree = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o4">cHandleEntries</a>;
00763     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o4">cHandleEntries</a> &amp; 0x1) {
00764         phpNew-&gt;<a class="code" href="../../d4/d4/struct__HANDLEPAGE.html#o2">iheFreeOdd</a> = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o4">cHandleEntries</a>;
00765         phpNew-&gt;<a class="code" href="../../d4/d4/struct__HANDLEPAGE.html#o1">iheFreeEven</a> = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o4">cHandleEntries</a> + 1;
00766     } <span class="keywordflow">else</span> {
00767         phpNew-&gt;<a class="code" href="../../d4/d4/struct__HANDLEPAGE.html#o1">iheFreeEven</a> = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o4">cHandleEntries</a>;
00768         phpNew-&gt;<a class="code" href="../../d4/d4/struct__HANDLEPAGE.html#o2">iheFreeOdd</a> = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o4">cHandleEntries</a> + 1;
00769     }
00770     <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o11">cbHandleTable</a> += <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
00771 
00772     <span class="comment">/*</span>
00773 <span class="comment">     * Check for handle overflow</span>
00774 <span class="comment">     */</span>
00775     <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o4">cHandleEntries</a> = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o11">cbHandleTable</a> / <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html">HANDLEENTRY</a>);
00776     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o4">cHandleEntries</a> &amp; ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a428">HMINDEXBITS</a>) {
00777         <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o4">cHandleEntries</a> = (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a428">HMINDEXBITS</a> + 1);
00778     }
00779 
00780     phpNew-&gt;<a class="code" href="../../d4/d4/struct__HANDLEPAGE.html#o0">iheLimit</a> = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o4">cHandleEntries</a>;
00781     <span class="keywordflow">if</span> (phpNew-&gt;<a class="code" href="../../d4/d4/struct__HANDLEPAGE.html#o1">iheFreeEven</a> &gt;= phpNew-&gt;<a class="code" href="../../d4/d4/struct__HANDLEPAGE.html#o0">iheLimit</a>) {
00782         phpNew-&gt;<a class="code" href="../../d4/d4/struct__HANDLEPAGE.html#o1">iheFreeEven</a> = 0;
00783     }
00784     <span class="keywordflow">if</span> (phpNew-&gt;<a class="code" href="../../d4/d4/struct__HANDLEPAGE.html#o2">iheFreeOdd</a> &gt;= phpNew-&gt;<a class="code" href="../../d4/d4/struct__HANDLEPAGE.html#o0">iheLimit</a>) {
00785         phpNew-&gt;<a class="code" href="../../d4/d4/struct__HANDLEPAGE.html#o2">iheFreeOdd</a> = 0;
00786     }
00787 
00788     <a class="code" href="../../d4/d8/handtabl_8c.html#a14">HMInitHandleEntries</a>(iheFirstFree);
00789 
00790     <span class="comment">/*</span>
00791 <span class="comment">     * HMINDEXBITS has a special meaning. We used to handle this in HMAllocObject.</span>
00792 <span class="comment">     * Now we handle it here right after adding that handle to the table.</span>
00793 <span class="comment">     * Old Comment:</span>
00794 <span class="comment">     * Reserve this table entry so that PW(HMINDEXBITS) maps to a</span>
00795 <span class="comment">     * NULL pointer. Set it to TYPE_FREE so the cleanup code doesn't think</span>
00796 <span class="comment">     * it is allocated. Set wUniq to 1 so that RevalidateHandles on HMINDEXBITS</span>
00797 <span class="comment">     * will fail.</span>
00798 <span class="comment">     */</span>
00799     <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o4">cHandleEntries</a> &gt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a428">HMINDEXBITS</a>)
00800             &amp;&amp; (phpNew-&gt;<a class="code" href="../../d4/d4/struct__HANDLEPAGE.html#o2">iheFreeOdd</a> != 0)
00801             &amp;&amp; (phpNew-&gt;<a class="code" href="../../d4/d4/struct__HANDLEPAGE.html#o2">iheFreeOdd</a> &lt;= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a428">HMINDEXBITS</a>)) {
00802 
00803         pheT = &amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o1">aheList</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a428">HMINDEXBITS</a>];
00804         <span class="keywordflow">if</span> (phpNew-&gt;<a class="code" href="../../d4/d4/struct__HANDLEPAGE.html#o2">iheFreeOdd</a> == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a428">HMINDEXBITS</a>) {
00805             phpNew-&gt;<a class="code" href="../../d4/d4/struct__HANDLEPAGE.html#o2">iheFreeOdd</a> = (ULONG_PTR)pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o0">phead</a>;
00806         } <span class="keywordflow">else</span> {
00807             UserAssert(pheT - 2 &gt;= &amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o1">aheList</a>[iheFirstFree]);
00808             UserAssert((pheT - 2)-&gt;phead == (PVOID)HMINDEXBITS);
00809             (pheT - 2)-&gt;phead = pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o0">phead</a>;
00810         }
00811         pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o0">phead</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00812         UserAssert(pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o2">bType</a> == TYPE_FREE);
00813         UserAssert(pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o4">wUniq</a> == 1);
00814     }
00815 
00816     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00817 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="handtabl.c::HMInitHandleEntries" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> void HMInitHandleEntries           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">ULONG_PTR&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>iheFirstFree</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/handtabl_8c-source.html#l00529">529</a> of file <a class="el" href="../../d5/d7/handtabl_8c-source.html">handtabl.c</a>.
<p>
References <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01278">tagSHAREDINFO::aheList</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01189">tagSERVERINFO::cHandleEntries</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l00455">DBGHMValidateFreeLists</a>, <a class="el" href="../../d2/d7/clglobal_8c-source.html#l00051">gpsi</a>, <a class="el" href="../../d2/d7/clglobal_8c-source.html#l00052">gSharedInfo</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01512">_HANDLEENTRY::phead</a>, and <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01516">_HANDLEENTRY::wUniq</a>.
<p>
Referenced by <a class="el" href="../../d5/d7/handtabl_8c-source.html#l00704">HMGrowHandleTable()</a>, and <a class="el" href="../../d5/d7/handtabl_8c-source.html#l00575">HMInitHandleTable()</a>.
<p>
<pre class="fragment"><div>00530 {
00531     ULONG_PTR ihe;
00532     <a class="code" href="../../d2/d4/struct__HANDLEENTRY.html">PHE</a>      pheT;
00533     <span class="comment">/*</span>
00534 <span class="comment">     * Zero out all the new entries</span>
00535 <span class="comment">     */</span>
00536     RtlZeroMemory (&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o1">aheList</a>[iheFirstFree],
00537                     (<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o4">cHandleEntries</a> - iheFirstFree) * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html">HANDLEENTRY</a>));
00538     <span class="comment">/*</span>
00539 <span class="comment">     * Link them together.</span>
00540 <span class="comment">     * Each free odd/even entry points to the next odd/even free entry.</span>
00541 <span class="comment">     */</span>
00542     ihe = iheFirstFree;
00543     <span class="keywordflow">for</span> (pheT = &amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o1">aheList</a>[ihe]; ihe &lt; <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o4">cHandleEntries</a>; ihe++, pheT++) {
00544         pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o0">phead</a> = (<a class="code" href="../../d4/d5/struct__HEAD.html">PHEAD</a>)(ihe + 2);
00545         <span class="comment">/* pheT-&gt;bType = TYPE_FREE; */</span>
00546         pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o4">wUniq</a> = 1;
00547     }
00548     <span class="comment">/*</span>
00549 <span class="comment">     * Terminate the lists.</span>
00550 <span class="comment">     */</span>
00551     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o4">cHandleEntries</a> &gt; iheFirstFree) {
00552         UserAssert(pheT - 1 &gt;= &amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o1">aheList</a>[iheFirstFree]);
00553         (pheT - 1)-&gt;phead = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00554     }
00555     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o4">cHandleEntries</a> &gt; iheFirstFree + 1) {
00556         UserAssert(pheT - 2 &gt;= &amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o1">aheList</a>[iheFirstFree]);
00557         (pheT - 2)-&gt;phead = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00558     }
00559     <span class="comment">/*</span>
00560 <span class="comment">     * Let's check that we got it right</span>
00561 <span class="comment">     */</span>
00562     <a class="code" href="../../d4/d8/handtabl_8c.html#a3">DBGHMValidateFreeLists</a>();
00563 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="handtabl.c::HMInitHandleTable" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL HMInitHandleTable           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pReadOnlySharedSectionBase</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/handtabl_8c-source.html#l00575">575</a> of file <a class="el" href="../../d5/d7/handtabl_8c-source.html">handtabl.c</a>.
<p>
References <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01278">tagSHAREDINFO::aheList</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01438">tagHANDLETYPEINFO::bObjectCreateFlags</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01514">_HANDLEENTRY::bType</a>, <a class="el" href="../../d0/d7/halvprnt_8c-source.html#l00031">BYTE</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01292">tagSERVERINFO::cbHandleTable</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01189">tagSERVERINFO::cHandleEntries</a>, <a class="el" href="../../d5/d7/ex_8c-source.html#l00278">CommitReadOnlyMemory()</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l00206">CPAGEENTRIESINIT</a>, <a class="el" href="../../d0/d0/client_2nt6_2user_8h.html#a1024">DESKOBJHEAD</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d6/ntuser_2kernel_2globals_8h-source.html#l00496">gahti</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l00208">gcHandlePages</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00918">ghSectionShared</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l00209">gpHandlePages</a>, <a class="el" href="../../d2/d7/clglobal_8c-source.html#l00051">gpsi</a>, <a class="el" href="../../d2/d7/clglobal_8c-source.html#l00052">gSharedInfo</a>, <a class="el" href="../../d4/d1/userk_8h.html#a789">HANDLEPAGE</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01465">HMINDEXBITS</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l00529">HMInitHandleEntries()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01139">_HANDLEPAGE::iheFreeEven</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01140">_HANDLEPAGE::iheFreeOdd</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01138">_HANDLEPAGE::iheLimit</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01347">OCF_DESKTOPHEAP</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01345">OCF_MARKPROCESS</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01344">OCF_PROCESSOWNED</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01349">OCF_SHAREDHEAP</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01343">OCF_THREADOWNED</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01348">OCF_USEPOOLIFNODESKTOP</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01346">OCF_USEPOOLQUOTA</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01512">_HANDLEENTRY::phead</a>, <a class="el" href="../../d0/d0/client_2nt6_2user_8h.html#a1028">PROCDESKHEAD</a>, <a class="el" href="../../d0/d0/client_2nt6_2user_8h.html#a1018">PROCOBJHEAD</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d0/d0/client_2nt6_2user_8h.html#a1026">THRDESKHEAD</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00924">TYPE_CTYPES</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00905">TYPE_FREE</a>, <a class="el" href="../../d0/d5/ndismain_8h-source.html#l00026">UINT</a>, and <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01516">_HANDLEENTRY::wUniq</a>.
<p>
Referenced by <a class="el" href="../../d0/d6/kernel_2server_8c-source.html#l02249">Win32UserInitialize()</a>.
<p>
<pre class="fragment"><div>00577 {
00578     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00579     SIZE_T   ulCommit;
00580 
00581     <span class="comment">/*</span>
00582 <span class="comment">     * Allocate the handle page array.  Make it big enough</span>
00583 <span class="comment">     * for 4 pages, which should be sufficient for nearly</span>
00584 <span class="comment">     * all instances.</span>
00585 <span class="comment">     */</span>
00586     <a class="code" href="../../d4/d8/handtabl_8c.html#a8">gpHandlePages</a> = UserAllocPool(
00587             CPAGEENTRIESINIT * <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d4/struct__HANDLEPAGE.html">HANDLEPAGE</a>), TAG_SYSTEM);
00588 
00589     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/handtabl_8c.html#a8">gpHandlePages</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00590         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00591 
00592 <span class="preprocessor">#if DBG</span>
00593 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(InitLockRecordLookaside()))
00594         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00595 <span class="preprocessor">#endif</span>
00596 <span class="preprocessor"></span>
00597     <span class="comment">/*</span>
00598 <span class="comment">     * Allocate the array.  We have the space from</span>
00599 <span class="comment">     * NtCurrentPeb()-&gt;ReadOnlySharedMemoryBase to</span>
00600 <span class="comment">     * NtCurrentPeb()-&gt;ReadOnlySharedMemoryHeap reserved for</span>
00601 <span class="comment">     * the handle table.  All we need to do is commit the pages.</span>
00602 <span class="comment">     *</span>
00603 <span class="comment">     * Compute the minimum size of the table.  The allocation will</span>
00604 <span class="comment">     * round this up to the next page size.</span>
00605 <span class="comment">     */</span>
00606     ulCommit = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o11">cbHandleTable</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
00607     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1002">CommitReadOnlyMemory</a>(ghSectionShared, &amp;ulCommit, 0, NULL);
00608 
00609     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
00610         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00611 
00612     <a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o1">aheList</a> = pReadOnlySharedSectionBase;
00613     <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o4">cHandleEntries</a> = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o11">cbHandleTable</a> / <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html">HANDLEENTRY</a>);
00614     <a class="code" href="../../d4/d8/handtabl_8c.html#a7">gcHandlePages</a> = 1;
00615 
00616     <span class="comment">/*</span>
00617 <span class="comment">     * Initialize the handlepage info. Handle 0 is reserved so even free list</span>
00618 <span class="comment">     *  starts at 2.</span>
00619 <span class="comment">     */</span>
00620     <a class="code" href="../../d4/d8/handtabl_8c.html#a8">gpHandlePages</a>[0].<a class="code" href="../../d4/d4/struct__HANDLEPAGE.html#o2">iheFreeOdd</a> = 1;
00621     <a class="code" href="../../d4/d8/handtabl_8c.html#a8">gpHandlePages</a>[0].<a class="code" href="../../d4/d4/struct__HANDLEPAGE.html#o1">iheFreeEven</a> = 2;
00622     <a class="code" href="../../d4/d8/handtabl_8c.html#a8">gpHandlePages</a>[0].<a class="code" href="../../d4/d4/struct__HANDLEPAGE.html#o0">iheLimit</a> = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o4">cHandleEntries</a>;
00623     <span class="comment">/*</span>
00624 <span class="comment">     * Initialize the handle entries.</span>
00625 <span class="comment">     */</span>
00626     <a class="code" href="../../d4/d8/handtabl_8c.html#a14">HMInitHandleEntries</a>(0);
00627     <span class="comment">/*</span>
00628 <span class="comment">     * PW(NULL) (ie, handle 0) must map to a NULL pointer.</span>
00629 <span class="comment">     * Old comment:</span>
00630 <span class="comment">     * Reserve the first handle table entry so that PW(NULL) maps to a</span>
00631 <span class="comment">     * NULL pointer. Set it to TYPE_FREE so the cleanup code doesn't think</span>
00632 <span class="comment">     * it is allocated. Set wUniq to 1 so that RevalidateHandles on NULL</span>
00633 <span class="comment">     * will fail.</span>
00634 <span class="comment">     */</span>
00635     <a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o1">aheList</a>[0].<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o0">phead</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00636     UserAssert(<a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o1">aheList</a>[0].<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o2">bType</a> == TYPE_FREE);
00637     UserAssert(<a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o1">aheList</a>[0].<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o4">wUniq</a> == 1);
00638 
00639 <span class="preprocessor">#if DBG</span>
00640 <span class="preprocessor"></span>    <span class="comment">/*</span>
00641 <span class="comment">     * Make sure we don't need to add the special case to handle HMINDEXBITS in this function.</span>
00642 <span class="comment">     */</span>
00643     UserAssert(<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o4">cHandleEntries</a> &lt;= HMINDEXBITS);
00644     <span class="comment">/*</span>
00645 <span class="comment">     * PDESKOBJHEAD won't do the right casting unless these structs have</span>
00646 <span class="comment">     *  the same size.</span>
00647 <span class="comment">     */</span>
00648     UserAssert(<span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/struct__THROBJHEAD.html">THROBJHEAD</a>) == <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d0/struct__PROCOBJHEAD.html">PROCOBJHEAD</a>));
00649     UserAssert(<span class="keyword">sizeof</span>(<a class="code" href="../../d9/d0/struct__THRDESKHEAD.html">THRDESKHEAD</a>) == <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d9/struct__PROCDESKHEAD.html">PROCDESKHEAD</a>));
00650     UserAssert(<span class="keyword">sizeof</span>(THRDESKHEAD) == <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d2/struct__DESKOBJHEAD.html">DESKOBJHEAD</a>));
00651     <span class="comment">/*</span>
00652 <span class="comment">     * Validate type flags to make sure that assumptions made</span>
00653 <span class="comment">     *  throughout HM code are OK.</span>
00654 <span class="comment">     */</span>
00655     {
00656         <a class="code" href="../../d1/d6/structtagHANDLETYPEINFO.html">HANDLETYPEINFO</a> * pahti = (<a class="code" href="../../d1/d6/structtagHANDLETYPEINFO.html">HANDLETYPEINFO</a> *) <a class="code" href="../../d9/d6/ntuser_2kernel_2globals_8h.html#a241">gahti</a>;
00657         <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uTypes = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a254">TYPE_CTYPES</a>;
00658         <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> bObjectCreateFlags;
00659         <span class="keywordflow">while</span> (uTypes-- != 0) {
00660             bObjectCreateFlags = pahti-&gt;<a class="code" href="../../d1/d6/structtagHANDLETYPEINFO.html#o2">bObjectCreateFlags</a>;
00661             <span class="comment">/*</span>
00662 <span class="comment">             * Illegal flag combinations</span>
00663 <span class="comment">             */</span>
00664             UserAssert(!((bObjectCreateFlags &amp; OCF_DESKTOPHEAP) &amp;&amp; (bObjectCreateFlags &amp; OCF_MARKPROCESS)));
00665             <span class="comment">/*</span>
00666 <span class="comment">             * Pointless (and probably illegal) flag combinations</span>
00667 <span class="comment">             */</span>
00668             UserAssert(!((bObjectCreateFlags &amp; OCF_DESKTOPHEAP) &amp;&amp; (bObjectCreateFlags &amp; OCF_SHAREDHEAP)));
00669             UserAssert(!((bObjectCreateFlags &amp; OCF_USEPOOLQUOTA) &amp;&amp; (bObjectCreateFlags &amp; OCF_SHAREDHEAP)));
00670             UserAssert(!((bObjectCreateFlags &amp; OCF_THREADOWNED) &amp;&amp; (bObjectCreateFlags &amp; OCF_PROCESSOWNED)));
00671             UserAssert(!(bObjectCreateFlags &amp; OCF_USEPOOLQUOTA)
00672                         || !(bObjectCreateFlags &amp; OCF_DESKTOPHEAP)
00673                         || (bObjectCreateFlags &amp; OCF_USEPOOLIFNODESKTOP));
00674 
00675             <span class="comment">/*</span>
00676 <span class="comment">             * Required flag combinations</span>
00677 <span class="comment">             */</span>
00678             UserAssert(!(bObjectCreateFlags &amp; OCF_DESKTOPHEAP)
00679                         || (bObjectCreateFlags &amp; (OCF_PROCESSOWNED | OCF_THREADOWNED)));
00680 
00681             UserAssert(!(bObjectCreateFlags &amp; OCF_MARKPROCESS)
00682                         || (bObjectCreateFlags &amp; OCF_PROCESSOWNED));
00683 
00684             UserAssert(!(bObjectCreateFlags &amp; OCF_USEPOOLIFNODESKTOP)
00685                         || (bObjectCreateFlags &amp; OCF_DESKTOPHEAP));
00686 
00687 
00688             pahti++;
00689         } <span class="comment">/* while (uTypes-- != 0) */</span>
00690     }
00691 <span class="preprocessor">#endif</span>
00692 <span class="preprocessor"></span>
00693     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00694 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="handtabl.c::HMMarkObjectDestroy" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL HMMarkObjectDestroy           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pobj</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/handtabl_8c-source.html#l01237">1237</a> of file <a class="el" href="../../d5/d7/handtabl_8c-source.html">handtabl.c</a>.
<p>
References <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01515">_HANDLEENTRY::bFlags</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01429">HANDLEF_DESTROY</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01430">HANDLEF_INDESTROY</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01433">HANDLEF_MARKED_OK</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01510">HMPheFromObject</a>, <a class="el" href="../../d4/d8/handtabl_8c.html#a11">HMRecordLock()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02372">LOCKRECORD_MARKDESTROY</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d3/loadbits_8c-source.html#l00539">_DestroyCursor()</a>, <a class="el" href="../../d8/d1/mndstry_8c-source.html#l00027">_DestroyMenu()</a>, <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00879">DestroyEventHook()</a>, <a class="el" href="../../d7/d1/kbdlyout_8c-source.html#l00435">DestroyKF()</a>, <a class="el" href="../../d2/d4/multimon_8c-source.html#l00249">DestroyMonitor()</a>, <a class="el" href="../../d3/d7/swp_8c-source.html#l00064">DestroySMWP()</a>, <a class="el" href="../../d6/d3/kernel_2ddetrack_8c-source.html#l02042">FreeDdeConv()</a>, <a class="el" href="../../d6/d3/kernel_2ddetrack_8c-source.html#l02285">FreeDdeXact()</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l01976">FreeHook()</a>, <a class="el" href="../../d6/d7/ntimm_8c-source.html#l00198">FreeInputContext()</a>, <a class="el" href="../../d5/d1/timers_8c-source.html#l00112">FreeTimer()</a>, <a class="el" href="../../d9/d7/winsta_8c-source.html#l00745">FreeWindowStation()</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l01299">HMDestroyObject()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l04012">NtUserDestroyAcceleratorTable()</a>, <a class="el" href="../../d3/d6/class_8c-source.html#l01092">UnlockAndFreeCPDs()</a>, <a class="el" href="../../d8/d0/w32_2ntuser_2kernel_2init_8c-source.html#l00097">Win32kNtUserCleanup()</a>, <a class="el" href="../../d2/d3/ddemlsvr_8c-source.html#l00127">xxxDestroyThreadDDEObject()</a>, <a class="el" href="../../d5/d7/createw_8c-source.html#l02218">xxxFreeWindow()</a>, <a class="el" href="../../d7/d1/kbdlyout_8c-source.html#l01571">xxxInternalUnloadKeyboardLayout()</a>, and <a class="el" href="../../d7/d1/kbdlyout_8c-source.html#l00654">xxxLoadKeyboardLayoutEx()</a>.
<p>
<pre class="fragment"><div>01239 {
01240     <a class="code" href="../../d2/d4/struct__HANDLEENTRY.html">PHE</a> phe;
01241 
01242     phe = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a446">HMPheFromObject</a>(pobj);
01243 
01244 <span class="preprocessor">#if DEBUGTAGS</span>
01245 <span class="preprocessor"></span>    <span class="comment">/*</span>
01246 <span class="comment">     * Record where the object was marked for destruction.</span>
01247 <span class="comment">     */</span>
01248     <span class="keywordflow">if</span> (IsDbgTagEnabled(DBGTAG_TrackLocks)) {
01249         <span class="keywordflow">if</span> (!(phe-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o3">bFlags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a421">HANDLEF_DESTROY</a>)) {
01250             <a class="code" href="../../d4/d8/handtabl_8c.html#a11">HMRecordLock</a>(LOCKRECORD_MARKDESTROY, pobj, ((<a class="code" href="../../d4/d5/struct__HEAD.html">PHEAD</a>)pobj)-&gt;cLockObj);
01251         }
01252     }
01253 <span class="preprocessor">#endif</span>
01254 <span class="preprocessor"></span>
01255     <span class="comment">/*</span>
01256 <span class="comment">     * Set the destroy flag so our unlock code will know we're trying to</span>
01257 <span class="comment">     * destroy this object.</span>
01258 <span class="comment">     */</span>
01259     phe-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o3">bFlags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a421">HANDLEF_DESTROY</a>;
01260 
01261     <span class="comment">/*</span>
01262 <span class="comment">     * If this object can't be destroyed, then CLEAR the HANDLEF_INDESTROY</span>
01263 <span class="comment">     * flag - because this object won't be currently "in destruction"!</span>
01264 <span class="comment">     * (if we didn't clear it, when it was unlocked it wouldn't get destroyed).</span>
01265 <span class="comment">     */</span>
01266     <span class="keywordflow">if</span> (((<a class="code" href="../../d4/d5/struct__HEAD.html">PHEAD</a>)pobj)-&gt;cLockObj != 0) {
01267         phe-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o3">bFlags</a> &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a422">HANDLEF_INDESTROY</a>;
01268 
01269         <span class="comment">/*</span>
01270 <span class="comment">         * Return FALSE because we can't destroy this object.</span>
01271 <span class="comment">         */</span>
01272         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01273     }
01274 
01275 <span class="preprocessor">#if DBG</span>
01276 <span class="preprocessor"></span>    <span class="comment">/*</span>
01277 <span class="comment">     * Ensure that this function only returns TRUE once.</span>
01278 <span class="comment">     */</span>
01279     UserAssert(!(phe-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o3">bFlags</a> &amp; HANDLEF_MARKED_OK));
01280     phe-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o3">bFlags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a425">HANDLEF_MARKED_OK</a>;
01281 <span class="preprocessor">#endif</span>
01282 <span class="preprocessor"></span>
01283     <span class="comment">/*</span>
01284 <span class="comment">     * Return TRUE because Lock count is zero - ok to destroy this object.</span>
01285 <span class="comment">     */</span>
01286     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01287 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="handtabl.c::HMNullFnDestroy" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> void HMNullFnDestroy           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pobj</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/handtabl_8c-source.html#l00028">28</a> of file <a class="el" href="../../d5/d7/handtabl_8c-source.html">handtabl.c</a>.
<p>
References <a class="el" href="../../d5/d7/handtabl_8c-source.html#l01299">HMDestroyObject()</a>.
<p>
<pre class="fragment"><div>00029 {
00030     RIPMSG1(RIP_WARNING, <span class="stringliteral">"HM: No clean up function for %#p"</span>, pobj);
00031     <a class="code" href="../../d4/d1/userk_8h.html#a972">HMDestroyObject</a>(pobj);
00032     <span class="keywordflow">return</span>;
00033 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="handtabl.c::HMRecordLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> void HMRecordLock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>ppobj</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>pobj</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>cLockObj</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d5/d7/handtabl_8c-source.html#l01509">HMAssignmentLock()</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l01599">HMAssignmentUnlock()</a>, and <a class="el" href="../../d5/d7/handtabl_8c-source.html#l01237">HMMarkObjectDestroy()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="handtabl.c::HMUnlockObjectInternal" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID HMUnlockObjectInternal           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pobj</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/handtabl_8c-source.html#l01472">1472</a> of file <a class="el" href="../../d5/d7/handtabl_8c-source.html">handtabl.c</a>.
<p>
References <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01515">_HANDLEENTRY::bFlags</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01429">HANDLEF_DESTROY</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01430">HANDLEF_INDESTROY</a>, <a class="el" href="../../d4/d1/userk_8h.html#a977">HMDestroyUnlockedObject()</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01510">HMPheFromObject</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
<pre class="fragment"><div>01474 {
01475     <a class="code" href="../../d2/d4/struct__HANDLEENTRY.html">PHE</a> phe;
01476 
01477     <span class="comment">/*</span>
01478 <span class="comment">     * The object is not reference counted. If the object is not a zombie,</span>
01479 <span class="comment">     * return success because the object is still around.</span>
01480 <span class="comment">     */</span>
01481     phe = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a446">HMPheFromObject</a>(pobj);
01482     <span class="keywordflow">if</span> (!(phe-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o3">bFlags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a421">HANDLEF_DESTROY</a>))
01483         <span class="keywordflow">return</span> pobj;
01484 
01485     <span class="comment">/*</span>
01486 <span class="comment">     * We're destroying the object based on an unlock... Make sure it isn't</span>
01487 <span class="comment">     * currently being destroyed! (It is valid to have lock counts go from</span>
01488 <span class="comment">     * 0 to != 0 to 0 during destruction... don't want recursion into</span>
01489 <span class="comment">     * the destroy routine.</span>
01490 <span class="comment">     */</span>
01491     <span class="keywordflow">if</span> (phe-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o3">bFlags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a422">HANDLEF_INDESTROY</a>)
01492         <span class="keywordflow">return</span> pobj;
01493 
01494     <a class="code" href="../../d4/d1/userk_8h.html#a977">HMDestroyUnlockedObject</a>(phe);
01495     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01496 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="handtabl.c::HMUnrecordLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL HMUnrecordLock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>ppobj</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>pobj</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d5/d7/handtabl_8c-source.html#l01509">HMAssignmentLock()</a>, and <a class="el" href="../../d5/d7/handtabl_8c-source.html#l01599">HMAssignmentUnlock()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a30" doxytag="handtabl.c::MarkThreadsObjects" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> void MarkThreadsObjects           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pti</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/handtabl_8c-source.html#l02595">2595</a> of file <a class="el" href="../../d5/d7/handtabl_8c-source.html">handtabl.c</a>.
<p>
References <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01278">tagSHAREDINFO::aheList</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01515">_HANDLEENTRY::bFlags</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01438">tagHANDLETYPEINFO::bObjectCreateFlags</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01514">_HANDLEENTRY::bType</a>, <a class="el" href="../../d0/d6/ntuser_2kernel_2globals_8h-source.html#l00496">gahti</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00849">giheLast</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00455">gptiRit</a>, <a class="el" href="../../d2/d7/clglobal_8c-source.html#l00052">gSharedInfo</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00645">gTermIO</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01380">_HEAD::h</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01429">HANDLEF_DESTROY</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l02112">HMChangeOwnerThread()</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l03600">ISTS</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01344">OCF_PROCESSOWNED</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01512">_HANDLEENTRY::phead</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01447">_HANDLEENTRY::pOwner</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02023">tagTERMINAL::ptiDesktop</a>, <a class="el" href="../../d4/d8/handtabl_8c.html#a13">ShowLocks()</a>, and <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00905">TYPE_FREE</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/queue_8c-source.html#l02552">xxxDestroyThreadInfo()</a>.
<p>
<pre class="fragment"><div>02597 {
02598     <a class="code" href="../../d2/d4/struct__HANDLEENTRY.html">PHE</a> pheT, pheMax;
02599 
02600     pheMax = &amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o1">aheList</a>[<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a308">giheLast</a>];
02601     <span class="keywordflow">for</span> (pheT = <a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o1">aheList</a>; pheT &lt;= pheMax; pheT++) {
02602         <span class="comment">/*</span>
02603 <span class="comment">         * Check against free before we look at pti... because pti is stored</span>
02604 <span class="comment">         * in the object itself, which won't be there if TYPE_FREE.</span>
02605 <span class="comment">         */</span>
02606         <span class="keywordflow">if</span> (pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o2">bType</a> == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a236">TYPE_FREE</a>)
02607             <span class="keywordflow">continue</span>;
02608 
02609         <span class="comment">/*</span>
02610 <span class="comment">         * Change ownership!</span>
02611 <span class="comment">         */</span>
02612         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d6/ntuser_2kernel_2globals_8h.html#a241">gahti</a>[pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o2">bType</a>].<a class="code" href="../../d1/d6/structtagHANDLETYPEINFO.html#o2">bObjectCreateFlags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a414">OCF_PROCESSOWNED</a> ||
02613                 (<a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>)pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o1">pOwner</a> != pti)
02614             <span class="keywordflow">continue</span>;
02615 
02616 <span class="preprocessor">#if DBG</span>
02617 <span class="preprocessor"></span>        <span class="comment">/*</span>
02618 <span class="comment">         * This is just to make sure that RIT or DT never get here</span>
02619 <span class="comment">         */</span>
02620         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/inc_2user_8h.html#a882">ISTS</a>() &amp;&amp; (pti == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a175">gptiRit</a> || pti == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a239">gTermIO</a>.<a class="code" href="../../d1/d8/structtagTERMINAL.html#o2">ptiDesktop</a>)) {
02621             RIPMSG2(RIP_ERROR, <span class="stringliteral">"pti %#p is RIT or DT. phe %#p\n"</span>, pti, pheT);
02622         }
02623 <span class="preprocessor">#endif</span>
02624 <span class="preprocessor"></span>
02625         <a class="code" href="../../d4/d1/userk_8h.html#a980">HMChangeOwnerThread</a>(pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o0">phead</a>, gptiRit);
02626 
02627 <span class="preprocessor">#if DEBUGTAGS</span>
02628 <span class="preprocessor"></span>
02629         <span class="keywordflow">if</span> (IsDbgTagEnabled(DBGTAG_TrackLocks)) {
02630             <span class="comment">/*</span>
02631 <span class="comment">             * Object still around: print warning message.</span>
02632 <span class="comment">             */</span>
02633             <span class="keywordflow">if</span> (pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o3">bFlags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a421">HANDLEF_DESTROY</a>) {
02634                     TAGMSG2(DBGTAG_TrackLocks,
02635                           <span class="stringliteral">"Zombie %s %#p still locked"</span>,
02636                            gahti[pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o2">bType</a>].szObjectType, pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o0">phead</a>-&gt;<a class="code" href="../../d4/d5/struct__HEAD.html#o0">h</a>);
02637             } <span class="keywordflow">else</span> {
02638                 TAGMSG1(DBGTAG_TrackLocks,
02639                         <span class="stringliteral">"Thread object %#p not destroyed.\n"</span>,
02640                         pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o0">phead</a>-&gt;<a class="code" href="../../d4/d5/struct__HEAD.html#o0">h</a>);
02641             }
02642 
02643             <a class="code" href="../../d4/d8/handtabl_8c.html#a13">ShowLocks</a>(pheT);
02644         }
02645 
02646 <span class="preprocessor">#endif // DEBUGTAGS</span>
02647 <span class="preprocessor"></span>    }
02648 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="handtabl.c::ShowLocks" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ShowLocks           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d2/d4/struct__HANDLEENTRY.html">PHE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d5/d7/handtabl_8c-source.html#l02595">MarkThreadsObjects()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="handtabl.c::ThreadUnlock1" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID ThreadUnlock1           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/handtabl_8c-source.html#l01939">1939</a> of file <a class="el" href="../../d5/d7/handtabl_8c-source.html">handtabl.c</a>.
<p>
References <a class="el" href="../../d5/d0/userk_8h-source.html#l01186">HMUnlockObject</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03317">tagTHREADINFO::ptl</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>01942 {
01943     <a class="code" href="../../d4/d5/struct__HEAD.html">PHEAD</a> phead;
01944     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent;
01945     <a class="code" href="../../d5/d1/struct__TL.html">PTL</a> ptl;
01946 
01947     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
01948     ptl = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o1">ptl</a>;
01949     UserAssert(ptl != NULL);
01950      <span class="comment">/*</span>
01951 <span class="comment">      * Validate the thread lock list.</span>
01952 <span class="comment">      */</span>
01953      ValidateThreadLocks(NULL, ptl, (ULONG_PTR)&amp;ptlIn, TRUE);
01954     <span class="comment">/*</span>
01955 <span class="comment">     * Make sure the caller wants to unlock the top lock.</span>
01956 <span class="comment">     */</span>
01957     UserAssert(ptlIn == ptl);
01958     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o1">ptl</a> = ptl-&gt;next;
01959     <span class="comment">/*</span>
01960 <span class="comment">     * If the object address is not NULL, then unlock the object.</span>
01961 <span class="comment">     */</span>
01962     phead = (<a class="code" href="../../d4/d5/struct__HEAD.html">PHEAD</a>)(ptl-&gt;pobj);
01963     <span class="keywordflow">if</span> (phead != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01964 
01965         <span class="comment">/*</span>
01966 <span class="comment">         * Unlock the object.</span>
01967 <span class="comment">         */</span>
01968 
01969         phead = (<a class="code" href="../../d4/d5/struct__HEAD.html">PHEAD</a>)<a class="code" href="../../d4/d1/userk_8h.html#a110">HMUnlockObject</a>(phead);
01970     }
01971 <span class="preprocessor">#if DBG</span>
01972 <span class="preprocessor"></span>    {
01973         <span class="comment">/*</span>
01974 <span class="comment">         * Remove the corresponding element from gFreeTLList</span>
01975 <span class="comment">         */</span>
01976         ptl-&gt;ptl-&gt;next = gFreeTLList;
01977         ptl-&gt;ptl-&gt;uTLCount += TL_FREED_PATTERN;
01978         gFreeTLList = ptl-&gt;ptl;
01979     }
01980 <span class="preprocessor">#endif</span>
01981 <span class="preprocessor"></span>    <span class="keywordflow">return</span> (PVOID)phead;
01982 }
</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a6" doxytag="handtabl.c::gahti" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> CONST <a class="el" href="../../d1/d6/structtagHANDLETYPEINFO.html">HANDLETYPEINFO</a> <a class="el" href="../../d4/d8/handtabl_8c.html#a6">gahti</a>[TYPE_CTYPES]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/handtabl_8c-source.html#l00090">90</a> of file <a class="el" href="../../d5/d7/handtabl_8c-source.html">handtabl.c</a>.
<p>
Referenced by <a class="el" href="../../d5/d7/handtabl_8c-source.html#l02776">_QueryUserHandles()</a>, <a class="el" href="../../d0/d7/w32_2ntuser_2kernel_2cleanup_8c-source.html#l00218">_WOWCleanup()</a>, <a class="el" href="../../d8/d0/w32_2ntuser_2kernel_2init_8c-source.html#l00696">DestroyHandleTableObjects()</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l02511">DestroyProcessesObjects()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l04976">DestroyProcessInfo()</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l02284">DestroyThreadsObjects()</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l00828">HMAllocObject()</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l02220">HMChangeOwnerPheProcess()</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l02069">HMDestroyUnlockedObject()</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l01069">HMFreeObject()</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l00575">HMInitHandleTable()</a>, <a class="el" href="../../d8/d2/validate_8c-source.html#l00232">IsHandleEntrySecure()</a>, and <a class="el" href="../../d5/d7/handtabl_8c-source.html#l02595">MarkThreadsObjects()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="handtabl.c::gcHandlePages" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="el" href="../../d4/d8/handtabl_8c.html#a7">gcHandlePages</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/handtabl_8c-source.html#l00208">208</a> of file <a class="el" href="../../d5/d7/handtabl_8c-source.html">handtabl.c</a>.
<p>
Referenced by <a class="el" href="../../d5/d7/handtabl_8c-source.html#l00828">HMAllocObject()</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l01069">HMFreeObject()</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l00704">HMGrowHandleTable()</a>, and <a class="el" href="../../d5/d7/handtabl_8c-source.html#l00575">HMInitHandleTable()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="handtabl.c::gpHandlePages" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d4/d4/struct__HANDLEPAGE.html">PHANDLEPAGE</a> <a class="el" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a10">gpHandlePages</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/handtabl_8c-source.html#l00209">209</a> of file <a class="el" href="../../d5/d7/handtabl_8c-source.html">handtabl.c</a>.
<p>
Referenced by <a class="el" href="../../d5/d7/handtabl_8c-source.html#l00828">HMAllocObject()</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l01069">HMFreeObject()</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l00704">HMGrowHandleTable()</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l00575">HMInitHandleTable()</a>, and <a class="el" href="../../d8/d0/w32_2ntuser_2kernel_2init_8c-source.html#l00773">Win32KDriverUnload()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:02 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
