<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: umapview.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>umapview.c File Reference</h1><code>#include "<a class="el" href="../../d5/d7/mi_8h-source.html">mi.h</a>"</code><br>

<p>
<a href="../../d5/d8/umapview_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d9/umapview_8c.html#a0">NtUnmapViewOfSection</a> (IN HANDLE ProcessHandle, IN PVOID BaseAddress)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d9/umapview_8c.html#a1">MmUnmapViewOfSection</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process, IN PVOID BaseAddress)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d9/umapview_8c.html#a2">MiRemoveMappedView</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess, IN <a class="el" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Vad)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d9/umapview_8c.html#a3">MiPurgeImageSection</a> (IN <a class="el" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea, IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process OPTIONAL)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a3" doxytag="umapview.c::MiPurgeImageSection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiPurgeImageSection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ControlArea</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d8/umapview_8c-source.html#l00541">541</a> of file <a class="el" href="../../d5/d8/umapview_8c-source.html">umapview.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02114">_SUBSECTION::ControlArea</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00140">KeDelayExecutionThread()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02411">MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00909">MI_SET_PFN_DELETED</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02486">MI_WRITE_INVALID_PTE</a>, <a class="el" href="../../d7/d4/pfndec_8c-source.html#l00030">MiDecrementShareCount()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01591">MiGetSubsectionAddressForPte</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00059">MiInsertPageInList()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01945">MiIsPteOnPdeBoundary</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00837">MiMakeSystemAddressValidPfnWs()</a>, <a class="el" href="../../d9/d5/deleteva_8c-source.html#l01014">MiReleasePageFileSpace()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00667">MiUnlinkPageFromList()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04571">MmPageLocationList</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00109">MMSECTOR_SHIFT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00215">MmShortTime</a>, <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00081">NoAccessPte</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02120">_SUBSECTION::NumberOfFullSectors</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01297">_MMPFN::OriginalPte</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01298">_MMPFN::PteFrame</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02123">_SUBSECTION::PtesInSubsection</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02119">_SUBSECTION::StartingSector</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02121">_SUBSECTION::SubsectionBase</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d1/d7/struct__SUBSECTION.html#o3">_SUBSECTION::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>.
<p>
Referenced by <a class="el" href="../../d6/d4/sectsup_8c-source.html#l01823">MiCheckControlArea()</a>.
<p>
<pre class="fragment"><div>00548                    :
00549 
00550     This function locates subsections within an image section that
00551     contain global memory and resets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> global memory back to
00552     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initial subsection contents.
00553 
00554     Note, that <span class="keywordflow">for</span> <span class="keyword">this</span> routine to be called <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not
00555     referenced nor <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> mapped in any process.
00556 
00557 Arguments:
00558 
00559     ControlArea - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> area <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section.
00560 
00561     Process - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process IFF <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set mutex
00562               <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> held, <span class="keywordflow">else</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> supplied.  Note that IFF <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set
00563               mutex <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> held, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> must always be acquired unsafe.
00564 
00565 Return Value:
00566 
00567     None.
00568 
00569 Environment:
00570 
00571     PFN <a class="code" href="../../d4/d2/struct__LOCK.html">LOCK</a> held.
00572 
00573 --*/
00574 
00575 {
00576     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00577     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
00578     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
00579     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
00580     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> NewContents;
00581     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> NewContentsDemandZero;
00582     KIRQL OldIrql = <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>;
00583     ULONG i;
00584     ULONG SizeOfRawData;
00585     ULONG OffsetIntoSubsection;
00586     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> Subsection;
00587 <span class="preprocessor">#if DBG</span>
00588 <span class="preprocessor"></span>    ULONG DelayCount = 0;
00589 <span class="preprocessor">#endif //DBG</span>
00590 <span class="preprocessor"></span>
00591     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea-&gt;u.Flags.Image != 0);
00592 
00593     i = ControlArea-&gt;NumberOfSubsections;
00594 
00595     <span class="keywordflow">if</span> (ControlArea-&gt;u.Flags.GlobalOnlyPerSession == 0) {
00596         Subsection = (<a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a>)(ControlArea + 1);
00597     }
00598     <span class="keywordflow">else</span> {
00599         Subsection = (<a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a>)((<a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html">PLARGE_CONTROL_AREA</a>)ControlArea + 1);
00600     }
00601 
00602     <span class="comment">//</span>
00603     <span class="comment">// Loop through all the subsections</span>
00604 
00605     <span class="keywordflow">while</span> (i &gt; 0) {
00606 
00607         <span class="keywordflow">if</span> (Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o3">u</a>.SubsectionFlags.GlobalMemory == 1) {
00608 
00609             NewContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = 0;
00610             NewContentsDemandZero.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = 0;
00611             SizeOfRawData = 0;
00612             OffsetIntoSubsection = 0;
00613 
00614             <span class="comment">//</span>
00615             <span class="comment">// Purge this section.</span>
00616             <span class="comment">//</span>
00617 
00618             <span class="keywordflow">if</span> (Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o4">StartingSector</a> != 0) {
00619 
00620                 <span class="comment">//</span>
00621                 <span class="comment">// This is not a demand zero section.</span>
00622                 <span class="comment">//</span>
00623 
00624                 NewContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a149">MiGetSubsectionAddressForPte</a>(Subsection);
00625                 NewContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype = 1;
00626 
00627                 SizeOfRawData = (Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o5">NumberOfFullSectors</a> &lt;&lt; <a class="code" href="../../d4/d8/mi_8h.html#a27">MMSECTOR_SHIFT</a>) |
00628                                Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o3">u</a>.SubsectionFlags.SectorEndOffset;
00629             }
00630 
00631             NewContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection =
00632                                        Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o3">u</a>.SubsectionFlags.Protection;
00633             NewContentsDemandZero.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection =
00634                                         NewContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection;
00635 
00636             PointerPte = Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>;
00637             LastPte = &amp;Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>[Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a>];
00638             ControlArea = Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o0">ControlArea</a>;
00639 
00640             <span class="comment">//</span>
00641             <span class="comment">// The WS lock may be released and reacquired and our callers</span>
00642             <span class="comment">// always acquire it unsafe.</span>
00643             <span class="comment">//</span>
00644 
00645             <a class="code" href="../../d0/d2/mmsup_8c.html#a9">MiMakeSystemAddressValidPfnWs</a> (PointerPte, Process);
00646 
00647             <span class="keywordflow">while</span> (PointerPte &lt; LastPte) {
00648 
00649                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a>(PointerPte)) {
00650 
00651                     <span class="comment">//</span>
00652                     <span class="comment">// We are on a page boundary, make sure this PTE is resident.</span>
00653                     <span class="comment">//</span>
00654 
00655                     <a class="code" href="../../d0/d2/mmsup_8c.html#a9">MiMakeSystemAddressValidPfnWs</a> (PointerPte, Process);
00656                 }
00657 
00658                 PteContents = *PointerPte;
00659                 <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0) {
00660 
00661                     <span class="comment">//</span>
00662                     <span class="comment">// No more valid PTEs to deal with.</span>
00663                     <span class="comment">//</span>
00664 
00665                     <span class="keywordflow">break</span>;
00666                 }
00667 
00668                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
00669 
00670                 <span class="keywordflow">if</span> ((PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0) &amp;&amp;
00671                          (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 1)) {
00672 
00673                     <span class="comment">//</span>
00674                     <span class="comment">// The prototype PTE is in transition format.</span>
00675                     <span class="comment">//</span>
00676 
00677                     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Trans.PageFrameNumber);
00678 
00679                     <span class="comment">//</span>
00680                     <span class="comment">// If the prototype PTE is no longer pointing to</span>
00681                     <span class="comment">// the original image page (not in protopte format),</span>
00682                     <span class="comment">// or has been modified, remove it from memory.</span>
00683                     <span class="comment">//</span>
00684 
00685                     <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified == 1) ||
00686                         (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0)) {
00687                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
00688 
00689                         <span class="comment">//</span>
00690                         <span class="comment">// This is a transition PTE which has been</span>
00691                         <span class="comment">// modified or is no longer in protopte format.</span>
00692                         <span class="comment">//</span>
00693 
00694                         <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount != 0) {
00695 
00696                             <span class="comment">//</span>
00697                             <span class="comment">// There must be an I/O in progress on this</span>
00698                             <span class="comment">// page.  Wait for the I/O operation to complete.</span>
00699                             <span class="comment">//</span>
00700 
00701                             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00702 
00703                             <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a> (KernelMode, FALSE, &amp;MmShortTime);
00704 
00705                             <span class="comment">//</span>
00706                             <span class="comment">// Redo the loop.</span>
00707                             <span class="comment">//</span>
00708 <span class="preprocessor">#if DBG</span>
00709 <span class="preprocessor"></span>                            <span class="keywordflow">if</span> ((DelayCount % 1024) == 0) {
00710                                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MMFLUSHSEC: waiting for i/o to complete PFN %lx\n"</span>,
00711                                     Pfn1);
00712                             }
00713                             DelayCount += 1;
00714 <span class="preprocessor">#endif //DBG</span>
00715 <span class="preprocessor"></span>
00716                             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00717 
00718                             <a class="code" href="../../d0/d2/mmsup_8c.html#a9">MiMakeSystemAddressValidPfnWs</a> (PointerPte, Process);
00719                             <span class="keywordflow">continue</span>;
00720                         }
00721 
00722                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (!((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0) &amp;&amp;
00723                            (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 1)));
00724 
00725                         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>);
00726                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
00727 
00728                         <span class="comment">//</span>
00729                         <span class="comment">// Only reduce the number of PFN references if</span>
00730                         <span class="comment">// the original PTE is still in prototype PTE</span>
00731                         <span class="comment">// format.</span>
00732                         <span class="comment">//</span>
00733 
00734                         <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 1) {
00735                             ControlArea-&gt;NumberOfPfnReferences -= 1;
00736                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((LONG)ControlArea-&gt;NumberOfPfnReferences &gt;= 0);
00737                         }
00738                         <a class="code" href="../../d7/d5/pfnlist_8c.html#a11">MiUnlinkPageFromList</a> (Pfn1);
00739 
00740                         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
00741 
00742                         <a class="code" href="../../d6/d5/pfndec_8c.html#a1">MiDecrementShareCount</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
00743 
00744                         <span class="comment">//</span>
00745                         <span class="comment">// If the reference count for the page is zero, insert</span>
00746                         <span class="comment">// it into the free page list, otherwise leave it alone</span>
00747                         <span class="comment">// and when the reference count is decremented to zero</span>
00748                         <span class="comment">// the page will go to the free list.</span>
00749                         <span class="comment">//</span>
00750 
00751                         <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0) {
00752                             <a class="code" href="../../d4/d8/mi_8h.html#a889">MiReleasePageFileSpace</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>);
00753                             <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (MmPageLocationList[FreePageList],
00754                                                 MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE (&amp;PteContents));
00755                         }
00756 
00757                         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, NewContents);
00758                     }
00759                 } <span class="keywordflow">else</span> {
00760 
00761                     <span class="comment">//</span>
00762                     <span class="comment">// Prototype PTE is not in transition format.</span>
00763                     <span class="comment">//</span>
00764 
00765                     <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0) {
00766 
00767                         <span class="comment">//</span>
00768                         <span class="comment">// This refers to a page in the paging file,</span>
00769                         <span class="comment">// as it no longer references the image,</span>
00770                         <span class="comment">// restore the PTE contents to what they were</span>
00771                         <span class="comment">// at the initial image creation.</span>
00772                         <span class="comment">//</span>
00773 
00774                         <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long != <a class="code" href="../../d4/d2/datalpha_8c.html#a13">NoAccessPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long) {
00775                             <a class="code" href="../../d4/d8/mi_8h.html#a889">MiReleasePageFileSpace</a> (PteContents);
00776                             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, NewContents);
00777                         }
00778                     }
00779                 }
00780                 PointerPte += 1;
00781                 OffsetIntoSubsection += <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
00782 
00783                 <span class="keywordflow">if</span> (OffsetIntoSubsection &gt;= SizeOfRawData) {
00784 
00785                     <span class="comment">//</span>
00786                     <span class="comment">// There are trailing demand zero pages in this</span>
00787                     <span class="comment">// subsection, set the PTE contents to be demand</span>
00788                     <span class="comment">// zero for the remainder of the PTEs in this</span>
00789                     <span class="comment">// subsection.</span>
00790                     <span class="comment">//</span>
00791 
00792                     NewContents = NewContentsDemandZero;
00793                 }
00794 
00795 <span class="preprocessor">#if DBG</span>
00796 <span class="preprocessor"></span>                DelayCount = 0;
00797 <span class="preprocessor">#endif //DBG</span>
00798 <span class="preprocessor"></span>
00799             } <span class="comment">//end while</span>
00800         }
00801 
00802         i -=1;
00803         Subsection += 1;
00804      }
00805 
00806     <span class="keywordflow">return</span>;
00807 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="umapview.c::MiRemoveMappedView" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiRemoveMappedView           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>CurrentProcess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vad</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d8/umapview_8c-source.html#l00265">265</a> of file <a class="el" href="../../d5/d8/umapview_8c-source.html">umapview.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02655">_MMPTE_FLUSH_LIST::Count</a>, <a class="el" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe()</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d5/ppc_2flushtb_8c-source.html#l00033">KeFlushEntireTb()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00922">LOCK_AWE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01362">MI_DECREMENT_USED_PTES_BY_HANDLE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01357">MI_GET_USED_PTES_FROM_HANDLE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01355">MI_GET_USED_PTES_HANDLE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00763">MI_VPN_TO_VA</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00765">MI_VPN_TO_VA_ENDING</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02486">MI_WRITE_INVALID_PTE</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l01823">MiCheckControlArea()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02759">MiDecrementShareAndValidCount</a>, <a class="el" href="../../d9/d5/deleteva_8c-source.html#l00506">MiDeletePte()</a>, <a class="el" href="../../d9/d5/deleteva_8c-source.html#l00026">MiDeleteVirtualAddresses()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01643">MiGetPdeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01945">MiIsPteOnPdeBoundary</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00127">MM_MAXIMUM_FLUSH_COUNT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04833">MmSectionBasedMutex</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02062">_CONTROL_AREA::NumberOfMappedViews</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02065">_CONTROL_AREA::NumberOfUserReferences</a>, <a class="el" href="../../d4/d8/mi_8h.html#a454">PMMEXTEND_INFO</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00925">UNLOCK_AWE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02427">_MI_PHYSICAL_VIEW::Vad</a>, and <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00030">ZeroPte</a>.
<p>
Referenced by <a class="el" href="../../d5/d4/procsup_8c-source.html#l01695">MmCleanProcessAddressSpace()</a>, and <a class="el" href="../../d5/d8/umapview_8c-source.html#l00090">MmUnmapViewOfSection()</a>.
<p>
<pre class="fragment"><div>00272                    :
00273 
00274     This function removes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mapping from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current process's
00275     address space.  The physical VAD may be a normal mapping (backed by
00276     a control area) or <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> may have no <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> area (it was mapped by a driver).
00277 
00278 Arguments:
00279 
00280     Process - Supplies a referenced pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current process object.
00281 
00282     Vad - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> VAD which maps <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view.
00283 
00284 Return Value:
00285 
00286     None.
00287 
00288 Environment:
00289 
00290     APC level, working set mutex and address creation mutex held.
00291 
00292     NOTE:  THE WORKING <a class="code" href="../../d9/d7/profman_8c.html#a17">SET</a> MUTEXES MAY BE RELEASED THEN REACQUIRED!!!!
00293 
00294            SINCE <a class="code" href="../../d4/d8/mi_8h.html#a927">MiCheckControlArea</a> releases unsafe, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> WS mutex must be
00295            acquired UNSAFE.
00296 
00297 --*/
00298 
00299 {
00300     KIRQL OldIrql;
00301     BOOLEAN DereferenceSegment;
00302     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
00303     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00304     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
00305     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
00306     PFN_NUMBER PdePage;
00307     <a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> PurgeEvent;
00308     PVOID TempVa;
00309     BOOLEAN DeleteOnClose;
00310     <a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html">MMPTE_FLUSH_LIST</a> PteFlushList;
00311     PVOID UsedPageTableHandle;
00312     PLIST_ENTRY NextEntry;
00313     <a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html">PMI_PHYSICAL_VIEW</a> PhysicalView;
00314     PVOID PhysicalPool;
00315 <span class="preprocessor">#if defined (_WIN64)</span>
00316 <span class="preprocessor"></span>    <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe;
00317     PVOID UsedPageDirectoryHandle;
00318 <span class="preprocessor">#endif</span>
00319 <span class="preprocessor"></span>
00320     DereferenceSegment = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00321     PurgeEvent = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00322     DeleteOnClose = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00323     PhysicalPool = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00324 
00325     ControlArea = Vad-&gt;ControlArea;
00326 
00327     <span class="keywordflow">if</span> (Vad-&gt;u.VadFlags.PhysicalMapping == 1) {
00328 
00329         <span class="keywordflow">if</span> (Vad-&gt;u4.Banked) {
00330             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Vad-&gt;u4.Banked);
00331         }
00332 
00333 <span class="preprocessor">#ifdef LARGE_PAGES</span>
00334 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (Vad-&gt;u.VadFlags.LargePages == 1) {
00335 
00336             <span class="comment">//</span>
00337             <span class="comment">// Delete the subsection allocated to hold the large pages.</span>
00338             <span class="comment">//</span>
00339 
00340             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Vad-&gt;FirstPrototypePte);
00341             Vad-&gt;FirstPrototypePte = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00342             <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a0">KeFlushEntireTb</a> (TRUE, FALSE);
00343             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00344         } <span class="keywordflow">else</span> {
00345 
00346 <span class="preprocessor">#endif //LARGE_PAGES</span>
00347 <span class="preprocessor"></span>
00348             <span class="comment">//</span>
00349             <span class="comment">// This is a physical memory view.  The pages map physical memory</span>
00350             <span class="comment">// and are not accounted for in the working set list or in the PFN</span>
00351             <span class="comment">// database.</span>
00352             <span class="comment">//</span>
00353 
00354             <a class="code" href="../../d4/d8/mi_8h.html#a133">LOCK_AWE</a> (CurrentProcess, OldIrql);
00355 
00356             NextEntry = CurrentProcess-&gt;PhysicalVadList.Flink;
00357             <span class="keywordflow">while</span> (NextEntry != &amp;CurrentProcess-&gt;PhysicalVadList) {
00358     
00359                 PhysicalView = CONTAINING_RECORD(NextEntry,
00360                                                  <a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html">MI_PHYSICAL_VIEW</a>,
00361                                                  ListEntry);
00362     
00363                 <span class="keywordflow">if</span> (Vad == PhysicalView-&gt;<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o1">Vad</a>) {
00364                     RemoveEntryList (NextEntry);
00365                     PhysicalPool = (PVOID)PhysicalView;
00366                     <span class="keywordflow">break</span>;
00367                 }
00368                 NextEntry = NextEntry-&gt;Flink;
00369             }
00370 
00371             <a class="code" href="../../d4/d8/mi_8h.html#a134">UNLOCK_AWE</a> (CurrentProcess, OldIrql);
00372 
00373             <span class="comment">//</span>
00374             <span class="comment">// Set count so only flush entire TB operations are performed.</span>
00375             <span class="comment">//</span>
00376 
00377             PteFlushList.<a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html#o0">Count</a> = <a class="code" href="../../d4/d8/mi_8h.html#a34">MM_MAXIMUM_FLUSH_COUNT</a>;
00378 
00379             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00380 
00381             <span class="comment">//</span>
00382             <span class="comment">// Remove the PTES from the address space.</span>
00383             <span class="comment">//</span>
00384 
00385             PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (MI_VPN_TO_VA (Vad-&gt;StartingVpn));
00386             PdePage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPde);
00387             PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (MI_VPN_TO_VA (Vad-&gt;StartingVpn));
00388             LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (MI_VPN_TO_VA (Vad-&gt;EndingVpn));
00389 
00390             UsedPageTableHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (MI_VPN_TO_VA (Vad-&gt;StartingVpn));
00391 
00392             <span class="keywordflow">while</span> (PointerPte &lt;= LastPte) {
00393 
00394                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a> (PointerPte)) {
00395 
00396                     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPte);
00397                     PdePage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPde);
00398 
00399                     UsedPageTableHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (MiGetVirtualAddressMappedByPte (PointerPte));
00400                 }
00401 
00402                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, ZeroPte);
00403                 <a class="code" href="../../d4/d8/mi_8h.html#a242">MiDecrementShareAndValidCount</a> (PdePage);
00404 
00405                 <span class="comment">//</span>
00406                 <span class="comment">// Decrement the count of non-zero page table entries for this</span>
00407                 <span class="comment">// page table.</span>
00408                 <span class="comment">//</span>
00409 
00410                 <a class="code" href="../../d4/d8/mi_8h.html#a183">MI_DECREMENT_USED_PTES_BY_HANDLE</a> (UsedPageTableHandle);
00411 
00412                 <span class="comment">//</span>
00413                 <span class="comment">// If all the entries have been eliminated from the previous</span>
00414                 <span class="comment">// page table page, delete the page table page itself.  And if</span>
00415                 <span class="comment">// this results in an empty page directory page, then delete</span>
00416                 <span class="comment">// that too.</span>
00417                 <span class="comment">//</span>
00418 
00419                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a181">MI_GET_USED_PTES_FROM_HANDLE</a>(UsedPageTableHandle) == 0) {
00420 
00421                     TempVa = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPde);
00422 
00423                     PteFlushList.<a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html#o0">Count</a> = <a class="code" href="../../d4/d8/mi_8h.html#a34">MM_MAXIMUM_FLUSH_COUNT</a>;
00424 
00425                     <a class="code" href="../../d4/d8/mi_8h.html#a886">MiDeletePte</a> (PointerPde,
00426                                  TempVa,
00427                                  FALSE,
00428                                  CurrentProcess,
00429                                  (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)NULL,
00430                                  &amp;PteFlushList);
00431 
00432                     <span class="comment">//</span>
00433                     <span class="comment">// Add back in the private page MiDeletePte subtracted.</span>
00434                     <span class="comment">//</span>
00435     
00436                     CurrentProcess-&gt;NumberOfPrivatePages += 1;
00437 
00438 <span class="preprocessor">#if defined (_WIN64)</span>
00439 <span class="preprocessor"></span>                    UsedPageDirectoryHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (PointerPte);
00440     
00441                     <a class="code" href="../../d4/d8/mi_8h.html#a183">MI_DECREMENT_USED_PTES_BY_HANDLE</a> (UsedPageDirectoryHandle);
00442 
00443                     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a181">MI_GET_USED_PTES_FROM_HANDLE</a>(UsedPageDirectoryHandle) == 0) {
00444     
00445                         PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(PointerPte);
00446                         TempVa = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPpe);
00447     
00448                         PteFlushList.<a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html#o0">Count</a> = <a class="code" href="../../d4/d8/mi_8h.html#a34">MM_MAXIMUM_FLUSH_COUNT</a>;
00449     
00450                         <a class="code" href="../../d4/d8/mi_8h.html#a886">MiDeletePte</a> (PointerPpe,
00451                                      TempVa,
00452                                      FALSE,
00453                                      CurrentProcess,
00454                                      (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)NULL,
00455                                      &amp;PteFlushList);
00456 
00457                         <span class="comment">//</span>
00458                         <span class="comment">// Add back in the private page MiDeletePte subtracted.</span>
00459                         <span class="comment">//</span>
00460         
00461                         CurrentProcess-&gt;NumberOfPrivatePages += 1;
00462                     }
00463 <span class="preprocessor">#endif</span>
00464 <span class="preprocessor"></span>                }
00465                 PointerPte += 1;
00466             }
00467             <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a0">KeFlushEntireTb</a> (TRUE, FALSE);
00468 
00469 <span class="preprocessor">#ifdef LARGE_PAGES</span>
00470 <span class="preprocessor"></span>        }
00471 <span class="preprocessor">#endif //LARGE_PAGES</span>
00472 <span class="preprocessor"></span>    } <span class="keywordflow">else</span> {
00473 
00474         <span class="keywordflow">if</span> (Vad-&gt;u2.VadFlags2.ExtendableFile) {
00475             <a class="code" href="../../d0/d2/struct__MMEXTEND__INFO.html">PMMEXTEND_INFO</a> exinfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00476             <a class="code" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe</a> (&amp;MmSectionBasedMutex);
00477             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Vad-&gt;ControlArea-&gt;Segment-&gt;ExtendInfo == Vad-&gt;u4.ExtendedInfo);
00478             Vad-&gt;u4.ExtendedInfo-&gt;ReferenceCount -= 1;
00479             <span class="keywordflow">if</span> (Vad-&gt;u4.ExtendedInfo-&gt;ReferenceCount == 0) {
00480                 exinfo = Vad-&gt;u4.ExtendedInfo;
00481                 Vad-&gt;ControlArea-&gt;Segment-&gt;ExtendInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00482             }
00483             <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a> (&amp;MmSectionBasedMutex);
00484             <span class="keywordflow">if</span> (exinfo) {
00485                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (exinfo);
00486             }
00487         }
00488 
00489         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00490         <a class="code" href="../../d4/d8/mi_8h.html#a885">MiDeleteVirtualAddresses</a> (MI_VPN_TO_VA (Vad-&gt;StartingVpn),
00491                                   <a class="code" href="../../d4/d8/mi_8h.html#a109">MI_VPN_TO_VA_ENDING</a> (Vad-&gt;EndingVpn),
00492                                   FALSE,
00493                                   Vad);
00494     }
00495 
00496     <span class="comment">//</span>
00497     <span class="comment">// Only physical VADs mapped by drivers don't have control areas.</span>
00498     <span class="comment">// If this view has a control area, the view count must be decremented now.</span>
00499     <span class="comment">//</span>
00500 
00501     <span class="keywordflow">if</span> (ControlArea) {
00502 
00503         <span class="comment">//</span>
00504         <span class="comment">// Decrement the count of the number of views for the</span>
00505         <span class="comment">// Segment object.  This requires the PFN mutex to be held (it is</span>
00506         <span class="comment">// already).</span>
00507         <span class="comment">//</span>
00508     
00509         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o4">NumberOfMappedViews</a> -= 1;
00510         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o7">NumberOfUserReferences</a> -= 1;
00511     
00512         <span class="comment">//</span>
00513         <span class="comment">// Check to see if the control area (segment) should be deleted.</span>
00514         <span class="comment">// This routine releases the PFN lock.</span>
00515         <span class="comment">//</span>
00516     
00517         <a class="code" href="../../d5/d5/sectsup_8c.html#a24">MiCheckControlArea</a> (ControlArea, CurrentProcess, OldIrql);
00518     }
00519     <span class="keywordflow">else</span> {
00520 
00521         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00522 
00523         <span class="comment">//</span>
00524         <span class="comment">// Even though it says short VAD in VadFlags, it better be a long VAD.</span>
00525         <span class="comment">//</span>
00526 
00527         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Vad-&gt;u.VadFlags.PhysicalMapping == 1);
00528         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Vad-&gt;u4.Banked == NULL);
00529         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Vad-&gt;ControlArea == NULL);
00530         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Vad-&gt;FirstPrototypePte == NULL);
00531     }
00532     
00533     <span class="keywordflow">if</span> (PhysicalPool != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00534         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (PhysicalPool);
00535     }
00536 
00537     <span class="keywordflow">return</span>;
00538 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="umapview.c::MmUnmapViewOfSection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MmUnmapViewOfSection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>BaseAddress</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d8/umapview_8c-source.html#l00090">90</a> of file <a class="el" href="../../d5/d8/umapview_8c-source.html">umapview.c</a>.
<p>
References <a class="el" href="../../d8/d2/dbgkproc_8c-source.html#l00664">DbgkUnMapViewOfSection()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02385">_MMVAD::EndingVpn</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00166">KeAttachProcess()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00405">KeDetachProcess()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01093">LOCK_WS_AND_ADDRESS_SPACE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01044">LOCK_WS_UNSAFE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00763">MI_VPN_TO_VA</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00765">MI_VPN_TO_VA_ENDING</a>, <a class="el" href="../../d1/d8/protect_8c-source.html#l02244">MiCheckSecuredVad()</a>, <a class="el" href="../../d2/d9/miia64_8h.html#a308">MiDeleteFor4kPage()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00503">MiGetNextVad</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00480">MiGetPreviousVad</a>, <a class="el" href="../../d7/d2/vadtree_8c-source.html#l00380">MiLocateAddress()</a>, <a class="el" href="../../d5/d8/umapview_8c-source.html#l00265">MiRemoveMappedView()</a>, <a class="el" href="../../d7/d2/vadtree_8c-source.html#l00256">MiRemoveVad()</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00869">MiReturnPageTablePageCommitment()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00158">MM_SECURE_DELETE_CHECK</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02384">_MMVAD::StartingVpn</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d6/d6/struct__MMVAD.html#o7">_MMVAD::u</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01097">UNLOCK_WS_AND_ADDRESS_SPACE</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l01085">UNLOCK_WS_UNSAFE</a>.
<p>
Referenced by <a class="el" href="../../d5/d7/ex_8c-source.html#l00278">CommitReadOnlyMemory()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l02949">FreeView()</a>, <a class="el" href="../../d4/d5/lpcclose_8c-source.html#l00110">LpcpDeletePort()</a>, <a class="el" href="../../d1/d7/creasect_8c-source.html#l04868">MiGetWritablePagesInSection()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l01474">MiLoadImageSection()</a>, <a class="el" href="../../d5/d8/umapview_8c-source.html#l00033">NtUnmapViewOfSection()</a>, and <a class="el" href="../../d3/d8/w32_2ntuser_2kernel_2heap_8c-source.html#l00189">UserCreateHeap()</a>.
<p>
<pre class="fragment"><div>00097                    :
00098 
00099     This function unmaps a previously created view to a section.
00100 
00101 Arguments:
00102 
00103     Process - Supplies a referenced pointer to a process object.
00104 
00105     BaseAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view.
00106 
00107 Return Value:
00108 
00109     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status
00110 
00111     TBS
00112 
00113 
00114 --*/
00115 
00116 {
00117     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Vad;
00118     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> PreviousVad;
00119     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> NextVad;
00120     SIZE_T RegionSize;
00121     PVOID UnMapImageBase;
00122     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00123     BOOLEAN Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00124 
00125     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00126 
00127     UnMapImageBase = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00128 
00129     <span class="comment">//</span>
00130     <span class="comment">// If the specified process is not the current process, attach</span>
00131     <span class="comment">// to the specified process.</span>
00132     <span class="comment">//</span>
00133 
00134     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() != Process) {
00135         <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a> (&amp;Process-&gt;Pcb);
00136         Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00137     }
00138 
00139     <span class="comment">//</span>
00140     <span class="comment">// Get the address creation mutex to block multiple threads from</span>
00141     <span class="comment">// creating or deleting address space at the same time and</span>
00142     <span class="comment">// get the working set mutex so virtual address descriptors can</span>
00143     <span class="comment">// be inserted and walked.</span>
00144     <span class="comment">// Raise IRQL to block APCs.</span>
00145     <span class="comment">//</span>
00146     <span class="comment">// Get the working set mutex, no page faults allowed for now until</span>
00147     <span class="comment">// working set mutex released.</span>
00148     <span class="comment">//</span>
00149 
00150 
00151     <a class="code" href="../../d4/d8/mi_8h.html#a161">LOCK_WS_AND_ADDRESS_SPACE</a> (Process);
00152 
00153     <span class="comment">//</span>
00154     <span class="comment">// Make sure the address space was not deleted, if so, return an error.</span>
00155     <span class="comment">//</span>
00156 
00157     <span class="keywordflow">if</span> (Process-&gt;AddressSpaceDeleted != 0) {
00158         status = STATUS_PROCESS_IS_TERMINATING;
00159         <span class="keywordflow">goto</span> ErrorReturn;
00160     }
00161 
00162     <span class="comment">//</span>
00163     <span class="comment">// Find the associated vad.</span>
00164     <span class="comment">//</span>
00165 
00166     Vad = <a class="code" href="../../d6/d3/vadtree_8c.html#a2">MiLocateAddress</a> (BaseAddress);
00167 
00168     <span class="keywordflow">if</span> ((Vad == (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.PrivateMemory)) {
00169 
00170         <span class="comment">//</span>
00171         <span class="comment">// No Virtual Address Descriptor located for Base Address.</span>
00172         <span class="comment">//</span>
00173 
00174         status = STATUS_NOT_MAPPED_VIEW;
00175         <span class="keywordflow">goto</span> ErrorReturn;
00176     }
00177 
00178     <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.NoChange == 1) {
00179 
00180         <span class="comment">//</span>
00181         <span class="comment">// An attempt is being made to delete a secured VAD, check</span>
00182         <span class="comment">// the whole VAD to see if this deletion is allowed.</span>
00183         <span class="comment">//</span>
00184 
00185         status = <a class="code" href="../../d0/d9/protect_8c.html#a9">MiCheckSecuredVad</a> ((<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)Vad,
00186                                     MI_VPN_TO_VA (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a>),
00187                                     ((Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a> - Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a>) &lt;&lt; PAGE_SHIFT) +
00188                                             (PAGE_SIZE - 1),
00189                                     MM_SECURE_DELETE_CHECK);
00190 
00191         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
00192             <span class="keywordflow">goto</span> ErrorReturn;
00193         }
00194     }
00195 
00196     <span class="comment">//</span>
00197     <span class="comment">// If this Vad is for an image section, then</span>
00198     <span class="comment">// get the base address of the section</span>
00199     <span class="comment">//</span>
00200 
00201     <span class="keywordflow">if</span> ((Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.ImageMap == 1) &amp;&amp; (Process == <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>())) {
00202         UnMapImageBase = <a class="code" href="../../d4/d8/mi_8h.html#a108">MI_VPN_TO_VA</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a>);
00203     }
00204 
00205     RegionSize = <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> + ((Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a> - Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a>) &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
00206 
00207     PreviousVad = <a class="code" href="../../d4/d8/mi_8h.html#a95">MiGetPreviousVad</a> (Vad);
00208     NextVad = <a class="code" href="../../d4/d8/mi_8h.html#a96">MiGetNextVad</a> (Vad);
00209 
00210 
00211     <a class="code" href="../../d6/d3/vadtree_8c.html#a1">MiRemoveVad</a> (Vad);
00212 
00213     <span class="comment">//</span>
00214     <span class="comment">// Return commitment for page table pages if possible.</span>
00215     <span class="comment">//</span>
00216 
00217     <a class="code" href="../../d6/d1/mmquota_8c.html#a21">MiReturnPageTablePageCommitment</a> (MI_VPN_TO_VA (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a>),
00218                                      <a class="code" href="../../d4/d8/mi_8h.html#a109">MI_VPN_TO_VA_ENDING</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a>),
00219                                      Process,
00220                                      PreviousVad,
00221                                      NextVad);
00222 
00223     <a class="code" href="../../d4/d9/umapview_8c.html#a2">MiRemoveMappedView</a> (Process, Vad);
00224 
00225 <span class="preprocessor">#if defined(_MIALT4K_)</span>
00226 <span class="preprocessor"></span>
00227     <span class="keywordflow">if</span> (Process-&gt;Wow64Process != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00228 
00229         <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (Process);
00230 
00231         <a class="code" href="../../d2/d9/miia64_8h.html#a308">MiDeleteFor4kPage</a>(MI_VPN_TO_VA (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a>),
00232                           <a class="code" href="../../d4/d8/mi_8h.html#a109">MI_VPN_TO_VA_ENDING</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a>),
00233                           Process);
00234 
00235         <a class="code" href="../../d4/d8/mi_8h.html#a155">LOCK_WS_UNSAFE</a> (Process);
00236 
00237     }
00238 
00239 <span class="preprocessor">#endif</span>
00240 <span class="preprocessor"></span>
00241     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Vad);
00242 
00243     <span class="comment">//</span>
00244     <span class="comment">// Update the current virtual size in the process header.</span>
00245     <span class="comment">//</span>
00246 
00247     Process-&gt;VirtualSize -= RegionSize;
00248     status = STATUS_SUCCESS;
00249 
00250 ErrorReturn:
00251 
00252     <a class="code" href="../../d4/d8/mi_8h.html#a162">UNLOCK_WS_AND_ADDRESS_SPACE</a> (Process);
00253 
00254     <span class="keywordflow">if</span> ( UnMapImageBase ) {
00255         <a class="code" href="../../d4/d3/dbgk_8h.html#a4">DbgkUnMapViewOfSection</a>(UnMapImageBase);
00256     }
00257     <span class="keywordflow">if</span> (Attached == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00258         <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00259     }
00260 
00261     <span class="keywordflow">return</span> status;
00262 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="umapview.c::NtUnmapViewOfSection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtUnmapViewOfSection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>BaseAddress</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d8/umapview_8c-source.html#l00033">33</a> of file <a class="el" href="../../d5/d8/umapview_8c-source.html">umapview.c</a>.
<p>
References <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d5/d8/umapview_8c-source.html#l00090">MmUnmapViewOfSection()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d8/ntos_8h-source.html#l00088">PsProcessType</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/w32_2ntcon_2server_2bitmap_8c-source.html#l00027">CreateConsoleBitmap()</a>, <a class="el" href="../../d6/d0/w32_2ntcon_2server_2bitmap_8c-source.html#l00353">FreeConsoleBitmap()</a>, <a class="el" href="../../d2/d2/ldrrsrc_8c-source.html#l01989">LdrFlushAlternateResourceModules()</a>, <a class="el" href="../../d2/d2/ldrrsrc_8c-source.html#l01563">LdrLoadAlternateResourceModule()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l00832">LdrpCheckForLoadedDll()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l01261">LdrpMapDll()</a>, <a class="el" href="../../d2/d2/ldrrsrc_8c-source.html#l01882">LdrUnloadAlternateResourceModule()</a>, <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00528">LdrUnloadDll()</a>, <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l01069">LdrVerifyImageMatchesChecksum()</a>, <a class="el" href="../../d2/d6/ntcon_2server_2menu_8c-source.html#l00287">PropertiesDlgShow()</a>, <a class="el" href="../../d2/d6/ntcon_2server_2menu_8c-source.html#l00459">PropertiesUpdate()</a>, <a class="el" href="../../d2/d2/dll_2query_8c-source.html#l00316">RtlCreateQueryDebugBuffer()</a>, <a class="el" href="../../d2/d2/dll_2query_8c-source.html#l00399">RtlDestroyQueryDebugBuffer()</a>, <a class="el" href="../../d2/d2/dll_2query_8c-source.html#l00099">RtlpChangeQueryDebugBufferTarget()</a>, <a class="el" href="../../d2/d2/dll_2query_8c-source.html#l00032">RtlpQueryProcessDebugInformationRemote()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l01094">SrvRegisterConsoleVDM()</a>, and <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00980">UnregisterVDM()</a>.
<p>
<pre class="fragment"><div>00040                    :
00041 
00042     This function unmaps a previously created view to a section.
00043 
00044 Arguments:
00045 
00046     ProcessHandle - Supplies an open handle to a process object.
00047 
00048     BaseAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view.
00049 
00050 Return Value:
00051 
00052     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status
00053 
00054     TBS
00055 
00056 
00057 --*/
00058 
00059 {
00060     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
00061     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00062     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00063 
00064     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00065 
00066     PreviousMode = KeGetPreviousMode();
00067 
00068     <span class="keywordflow">if</span> ((PreviousMode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) &amp;&amp; (BaseAddress &gt; MM_HIGHEST_USER_ADDRESS)) {
00069         <span class="keywordflow">return</span> STATUS_NOT_MAPPED_VIEW;
00070     }
00071 
00072     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a> ( ProcessHandle,
00073                                          PROCESS_VM_OPERATION,
00074                                          PsProcessType,
00075                                          PreviousMode,
00076                                          (PVOID *)&amp;Process,
00077                                          NULL );
00078 
00079     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00080         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00081     }
00082 
00083     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d9/umapview_8c.html#a1">MmUnmapViewOfSection</a> ( Process, BaseAddress );
00084     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (Process);
00085 
00086     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00087 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:52 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
