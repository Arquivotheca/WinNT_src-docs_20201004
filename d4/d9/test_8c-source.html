<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: test.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>test.c</h1><a href="../../d3/d0/test_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*****************************************************************/</span> 
00004 <span class="comment">/*****************************************************************/</span> 
00005 
00006 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00007 <span class="preprocessor">#include &lt;<a class="code" href="../../d2/d5/process_8h.html">process.h</a>&gt;</span>
00008 <span class="preprocessor">#include &lt;setjmp.h&gt;</span>
00009 
00010 <span class="preprocessor">#include &lt;time.h&gt;</span>
00011 
00012 <span class="preprocessor">#include &lt;nt.h&gt;</span>
00013 <span class="preprocessor">#include &lt;ntrtl.h&gt;</span>
00014 <span class="preprocessor">#include &lt;nturtl.h&gt;</span>
00015 <span class="preprocessor">#include &lt;windows.h&gt;</span>
00016 
00017 <span class="comment">// declare a BSS value - see what the assemble looks like</span>
00018 
<a name="l00019"></a><a class="code" href="../../d3/d0/test_8c.html#a1">00019</a> CONTEXT     <a class="code" href="../../d3/d0/test_8c.html#a1">RegContext</a>;
<a name="l00020"></a><a class="code" href="../../d3/d0/test_8c.html#a2">00020</a> ULONG       <a class="code" href="../../d3/d0/test_8c.html#a2">DefaultValue</a>;
<a name="l00021"></a><a class="code" href="../../d3/d0/test_8c.html#a3">00021</a> ULONG       <a class="code" href="../../d3/d0/test_8c.html#a3">TestCount</a>;
<a name="l00022"></a><a class="code" href="../../d3/d0/test_8c.html#a4">00022</a> ULONG       <a class="code" href="../../d3/d0/test_8c.html#a4">ExpectedException</a>;
00023 
<a name="l00024"></a><a class="code" href="../../d3/d0/test_8c.html#a5">00024</a> <span class="keyword">extern</span>  ULONG   <a class="code" href="../../d3/d0/test_8c.html#a5">DivOperand</a>;
<a name="l00025"></a><a class="code" href="../../d3/d0/test_8c.html#a6">00025</a> <span class="keyword">extern</span>  ULONG   <a class="code" href="../../d3/d0/test_8c.html#a6">DivRegPointer</a>;
<a name="l00026"></a><a class="code" href="../../d3/d0/test_8c.html#a7">00026</a> <span class="keyword">extern</span>  LONG    <a class="code" href="../../d3/d0/test_8c.html#a7">DivRegScaler</a>;
<a name="l00027"></a><a class="code" href="../../d3/d0/test_8c.html#a8">00027</a> <span class="keyword">extern</span>  ULONG   <a class="code" href="../../d3/d0/test_8c.html#a8">ExceptEip</a>;
<a name="l00028"></a><a class="code" href="../../d3/d0/test_8c.html#a9">00028</a> <span class="keyword">extern</span>  ULONG   <a class="code" href="../../d3/d0/test_8c.html#a9">ExceptEsp</a>;
<a name="l00029"></a><a class="code" href="../../d3/d0/test_8c.html#a10">00029</a> <span class="keyword">extern</span>  ULONG   <a class="code" href="../../d3/d0/test_8c.html#a10">TestTable</a>[];
<a name="l00030"></a><a class="code" href="../../d3/d0/test_8c.html#a11">00030</a> <span class="keyword">extern</span>  ULONG   <a class="code" href="../../d3/d0/test_8c.html#a11">TestTableCenter</a>[];
<a name="l00031"></a><a class="code" href="../../d3/d0/test_8c.html#a0">00031</a> <span class="preprocessor">#define TESTTABLESIZE    (128*sizeof(ULONG))</span>
00032 <span class="preprocessor"></span>
00033 <span class="keyword">extern</span>  <a class="code" href="../../d3/d0/test_8c.html#a16">TestDiv</a>();
00034 
<a name="l00035"></a><a class="code" href="../../d3/d0/test_8c.html#a12">00035</a> BOOLEAN <a class="code" href="../../d3/d0/test_8c.html#a12">vInitialized</a>;
<a name="l00036"></a><a class="code" href="../../d3/d0/test_8c.html#a13">00036</a> ULONG   <a class="code" href="../../d3/d0/test_8c.html#a13">vZero</a> = 0;
<a name="l00037"></a><a class="code" href="../../d3/d0/test_8c.html#a14">00037</a> ULONG   <a class="code" href="../../d3/d0/test_8c.html#a14">vTwo</a>  = 0;
<a name="l00038"></a><a class="code" href="../../d3/d0/test_8c.html#a15">00038</a> ULONG   <a class="code" href="../../d3/d0/test_8c.html#a15">vDivOk</a> = 0x7f7f7f7f;
00039 
00040 
00041 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> __cdecl
<a name="l00042"></a><a class="code" href="../../d3/d0/test_8c.html#a17">00042</a> <a class="code" href="../../d2/d5/editreg_8c.html#a87">main</a> (argc, argv)
00043 int     argc;
00044 <span class="keywordtype">char</span>    *argv[];
00045 {
00046 
00047     <span class="comment">/***</span>
00048 <span class="comment">     *  This program tests the kernel's MOD/RM &amp; SIB decoding of</span>
00049 <span class="comment">     *  a processor trap 0.  The kernel needs to crack the MOD/RM &amp; SIB</span>
00050 <span class="comment">     *  on a div to determine if the exception is a divide_by_zero</span>
00051 <span class="comment">     *  or an overflow execption.</span>
00052 <span class="comment">     */</span>
00053 
00054     <span class="keywordflow">try</span> {
00055         <span class="comment">//</span>
00056         <span class="comment">// Setup for divide by zero test</span>
00057         <span class="comment">//</span>
00058 
00059         <a class="code" href="../../d3/d0/test_8c.html#a5">DivOperand</a> = 0;
00060         <a class="code" href="../../d3/d0/test_8c.html#a7">DivRegScaler</a> = 0;
00061         <a class="code" href="../../d3/d0/test_8c.html#a6">DivRegPointer</a> = <a class="code" href="../../d3/d0/test_8c.html#a11">TestTableCenter</a>;
00062         <a class="code" href="../../d3/d0/test_8c.html#a2">DefaultValue</a> = 0x01010101;
00063         <a class="code" href="../../d3/d0/test_8c.html#a4">ExpectedException</a> = STATUS_INTEGER_DIVIDE_BY_ZERO;
00064 
00065         printf (<span class="stringliteral">"Begin divide by zero test\n"</span>);
00066 
00067         <span class="keywordflow">for</span> (<a class="code" href="../../d3/d0/test_8c.html#a7">DivRegScaler</a> = -7; <a class="code" href="../../d3/d0/test_8c.html#a7">DivRegScaler</a> &lt;  7; <a class="code" href="../../d3/d0/test_8c.html#a7">DivRegScaler</a>++) {
00068             <a class="code" href="../../d3/d0/test_8c.html#a12">vInitialized</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00069             <a class="code" href="../../d3/d0/test_8c.html#a16">TestDiv</a> ();
00070         }
00071 
00072         printf (<span class="stringliteral">"End divide by zero test\n\n"</span>);
00073 
00074         <span class="comment">//</span>
00075         <span class="comment">// Setup for divide overflow test</span>
00076         <span class="comment">//</span>
00077 
00078         <a class="code" href="../../d3/d0/test_8c.html#a5">DivOperand</a> = 2;
00079         <a class="code" href="../../d3/d0/test_8c.html#a6">DivRegPointer</a> = <a class="code" href="../../d3/d0/test_8c.html#a11">TestTableCenter</a>;
00080         <a class="code" href="../../d3/d0/test_8c.html#a2">DefaultValue</a> = 0;
00081         <a class="code" href="../../d3/d0/test_8c.html#a4">ExpectedException</a> = STATUS_INTEGER_OVERFLOW;
00082 
00083         printf (<span class="stringliteral">"Begin divide overflow test\n"</span>);
00084 
00085         <span class="keywordflow">for</span> (<a class="code" href="../../d3/d0/test_8c.html#a7">DivRegScaler</a> = -7; <a class="code" href="../../d3/d0/test_8c.html#a7">DivRegScaler</a> &lt; 7; <a class="code" href="../../d3/d0/test_8c.html#a7">DivRegScaler</a>++) {
00086             <a class="code" href="../../d3/d0/test_8c.html#a12">vInitialized</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00087             <a class="code" href="../../d3/d0/test_8c.html#a16">TestDiv</a> ();
00088         }
00089         printf (<span class="stringliteral">"End divide overflow test\n\n"</span>);
00090 
00091     } except (<a class="code" href="../../d3/d0/test_8c.html#a18">HandleException</a>(GetExceptionInformation())) {
00092         printf (<span class="stringliteral">"FAIL: in divide by zero exception handler"</span>);
00093     }
00094 
00095     printf (<span class="stringliteral">"%ld varations run "</span>, <a class="code" href="../../d3/d0/test_8c.html#a3">TestCount</a>);
00096 }
00097 
<a name="l00098"></a><a class="code" href="../../d3/d0/test_8c.html#a18">00098</a> <a class="code" href="../../d3/d0/test_8c.html#a18">HandleException</a> (
00099     IN PEXCEPTION_POINTERS ExceptionPointers
00100     )
00101 {
00102     ULONG       i;
00103     PUCHAR      p;
00104     PCONTEXT    Context;
00105     ULONG       def;
00106 
00107     <span class="keywordflow">switch</span> (i = ExceptionPointers-&gt;ExceptionRecord-&gt;ExceptionCode) {
00108         <span class="keywordflow">case</span> 1:
00109             Context = ExceptionPointers-&gt;ContextRecord;
00110             Context-&gt;Eip = <a class="code" href="../../d3/d0/test_8c.html#a8">ExceptEip</a>;
00111             Context-&gt;Esp = <a class="code" href="../../d3/d0/test_8c.html#a9">ExceptEsp</a>;
00112 
00113             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d0/test_8c.html#a12">vInitialized</a>) {
00114                 printf (<span class="stringliteral">"Divide failed - div instruction completed\n"</span>);
00115                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a34">EXCEPTION_CONTINUE_SEARCH</a>;   <span class="comment">// to debugger</span>
00116             }
00117             <a class="code" href="../../d3/d0/test_8c.html#a12">vInitialized</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00118             <a class="code" href="../../d3/d0/test_8c.html#a3">TestCount</a>--;
00119             <span class="comment">// fall through...</span>
00120 
00121         <span class="keywordflow">case</span> STATUS_INTEGER_OVERFLOW:
00122         <span class="keywordflow">case</span> STATUS_INTEGER_DIVIDE_BY_ZERO:
00123             <span class="keywordflow">if</span> (i != <a class="code" href="../../d3/d0/test_8c.html#a4">ExpectedException</a>  &amp;&amp;  i != 1) {
00124                 <span class="keywordflow">break</span>;
00125             }
00126 
00127             <a class="code" href="../../d3/d0/test_8c.html#a3">TestCount</a>++;
00128 
00129             <span class="comment">// set context</span>
00130             def = <a class="code" href="../../d3/d0/test_8c.html#a2">DefaultValue</a>;
00131             Context = ExceptionPointers-&gt;ContextRecord;
00132             Context-&gt;Eax = def;
00133             Context-&gt;Ebx = def;
00134             Context-&gt;Ecx = def;
00135             Context-&gt;Edx = def;
00136             Context-&gt;Esi = def;
00137             Context-&gt;Edi = def;
00138             Context-&gt;Ebp = def;
00139 
00140             <span class="comment">// find next test</span>
00141             <span class="keywordflow">for</span> (p = (PUCHAR) Context-&gt;Eip; ((PULONG) p)[0] != 0xCCCCCCCC; p++) ;
00142             Context-&gt;Eip = (ULONG) (p + 4);
00143 
00144             <span class="comment">// clear global testable</span>
00145             RtlFillMemoryUlong (<a class="code" href="../../d3/d0/test_8c.html#a10">TestTable</a>, <a class="code" href="../../d3/d0/test_8c.html#a0">TESTTABLESIZE</a>, def);
00146             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a35">EXCEPTION_CONTINUE_EXECUTION</a>;
00147     }
00148 
00149     printf (<span class="stringliteral">"\nFailed - unexpected exception code %lx  (expected %lx)\n"</span>,
00150         ExceptionPointers-&gt;ExceptionRecord-&gt;ExceptionCode,
00151         <a class="code" href="../../d3/d0/test_8c.html#a4">ExpectedException</a>
00152         );
00153 
00154     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a34">EXCEPTION_CONTINUE_SEARCH</a>;
00155 }
00156 
00157 
00158 
00159 
<a name="l00160"></a><a class="code" href="../../d3/d0/test_8c.html#a19">00160</a> <a class="code" href="../../d3/d0/test_8c.html#a19">DivMarker</a>()
00161 {
00162     EXCEPTION_RECORD ExceptionRecord;
00163 
00164     <span class="comment">//</span>
00165     <span class="comment">// Construct an exception record.</span>
00166     <span class="comment">//</span>
00167 
00168     ExceptionRecord.ExceptionCode    = 1;
00169     ExceptionRecord.ExceptionRecord  = (PEXCEPTION_RECORD)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00170     ExceptionRecord.NumberParameters = 0;
00171     ExceptionRecord.ExceptionFlags   = 0;
00172     <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a9">RtlRaiseException</a>(&amp;ExceptionRecord);
00173 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:57 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
