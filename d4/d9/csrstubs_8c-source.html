<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: csrstubs.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>csrstubs.c</h1><a href="../../d3/d0/csrstubs_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/***************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: csrstubs.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* Routines to call CSR</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* 02-27-95 JimA             Created.</span>
00009 <span class="comment">*</span>
00010 <span class="comment">* Note: This file has been partitioned with #if defines so that the LPC</span>
00011 <span class="comment">* marsheling code can be inside 64bit code when running under wow64(32bit on 64bit NT).</span>
00012 <span class="comment">* In wow64, the system DLLs for 32bit processes are 32bit.</span>
00013 <span class="comment">*</span>
00014 <span class="comment">*       The marsheling code can only be depedent on functions NTDLL.</span>
00015 <span class="comment">\**************************************************************************/</span>
00016 
00017 <span class="preprocessor">#include "<a class="code" href="../../d7/d3/w32_2ntuser_2client_2precomp_8h.html">precomp.h</a>"</span>
00018 <span class="preprocessor">#pragma hdrstop</span>
00019 <span class="preprocessor"></span>
00020 <span class="preprocessor">#include "<a class="code" href="../../d2/d0/csrmsg_8h.html">csrmsg.h</a>"</span>
00021 <span class="preprocessor">#include "dbt.h"</span>
00022 <span class="preprocessor">#include "<a class="code" href="../../d0/d0/csrhlpr_8h.html">csrhlpr.h</a>"</span>
00023 
00024 <span class="preprocessor">#if defined(BUILD_CSRWOW64)</span>
00025 <span class="preprocessor"></span>
00026 <span class="preprocessor">#undef RIPERR0</span>
00027 <span class="preprocessor"></span><span class="preprocessor">#undef RIPNTERR0</span>
00028 <span class="preprocessor"></span><span class="preprocessor">#undef RIPMSG0</span>
00029 <span class="preprocessor"></span>
00030 <span class="preprocessor">#define RIPNTERR0(status, flags, szFmt) {if (NtCurrentTeb()) NtCurrentTeb()-&gt;LastErrorValue = RtlNtStatusToDosError(status);}</span>
00031 <span class="preprocessor"></span><span class="preprocessor">#define RIPERR0(idErr, flags, szFmt) {if (NtCurrentTeb()) NtCurrentTeb()-&gt;LastErrorValue = (idErr);}</span>
00032 <span class="preprocessor"></span><span class="preprocessor">#define RIPMSG0(flags, szFmt)</span>
00033 <span class="preprocessor"></span>
00034 <span class="preprocessor">#endif</span>
00035 <span class="preprocessor"></span>
<a name="l00036"></a><a class="code" href="../../d3/d0/csrstubs_8c.html#a0">00036</a> <span class="preprocessor">#define SET_LAST_ERROR_RETURNED()   if (a-&gt;dwLastError) RIPERR0(a-&gt;dwLastError, RIP_VERBOSE, "")</span>
00037 <span class="preprocessor"></span>
00038 <span class="preprocessor">#if !defined(BUILD_WOW6432)</span>
00039 <span class="preprocessor"></span>
00040 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00041 <a class="code" href="../../d1/d1/bench_8c.html#a0">APIENTRY</a>
<a name="l00042"></a><a class="code" href="../../d0/d0/csrhlpr_8h.html#a0">00042</a> <a class="code" href="../../d0/d0/csrhlpr_8h.html#a0">CallUserpExitWindowsEx</a>(
00043     IN UINT uFlags,
00044     IN DWORD dwReserved,
00045     OUT PBOOL pfSuccess)
00046 {
00047 
00048     <a class="code" href="../../d3/d4/struct__USER__API__MSG.html">USER_API_MSG</a> m;
00049     <a class="code" href="../../d1/d9/struct__EXITWINDOWSEXMSG.html">PEXITWINDOWSEXMSG</a> a = &amp;m.<a class="code" href="../../d3/d4/struct__USER__API__MSG.html#o15">u</a>.ExitWindowsEx;
00050 
00051     a-&gt;<a class="code" href="../../d1/d9/struct__EXITWINDOWSEXMSG.html#o1">uFlags</a> = uFlags;
00052     a-&gt;<a class="code" href="../../d1/d9/struct__EXITWINDOWSEXMSG.html#o2">dwReserved</a> = dwReserved;
00053     <a class="code" href="../../d8/d9/wow64csr_8c.html#a4">CsrClientCallServer</a>( (PCSR_API_MSG)&amp;m,
00054                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00055                          CSR_MAKE_API_NUMBER( USERSRV_SERVERDLL_INDEX,
00056                                               <a class="code" href="../../d2/d0/csrmsg_8h.html#a35a24">UserpExitWindowsEx</a>
00057                                             ),
00058                          <span class="keyword">sizeof</span>( *a )
00059                        );
00060 
00061     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( m.ReturnValue ) || m.ReturnValue == STATUS_CANT_WAIT) {
00062         <a class="code" href="../../d3/d0/csrstubs_8c.html#a0">SET_LAST_ERROR_RETURNED</a>();
00063         *pfSuccess = a-&gt;fSuccess;
00064     } <span class="keywordflow">else</span> {
00065         RIPNTERR0(m.ReturnValue, RIP_VERBOSE, <span class="stringliteral">""</span>);
00066         *pfSuccess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00067     }
00068 
00069     <span class="keywordflow">return</span> m.ReturnValue;
00070 
00071 }
00072 
00073 <span class="preprocessor">#endif</span>
00074 <span class="preprocessor"></span>
00075 <span class="preprocessor">#if !defined(BUILD_CSRWOW64)</span>
00076 <span class="preprocessor"></span>
<a name="l00077"></a><a class="code" href="../../d0/d9/struct__EXITWINDOWSDATA.html">00077</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d0/d9/struct__EXITWINDOWSDATA.html">_EXITWINDOWSDATA</a> {
<a name="l00078"></a><a class="code" href="../../d0/d9/struct__EXITWINDOWSDATA.html#o0">00078</a>     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d0/d9/struct__EXITWINDOWSDATA.html#o0">uFlags</a>;
<a name="l00079"></a><a class="code" href="../../d0/d9/struct__EXITWINDOWSDATA.html#o1">00079</a>     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d0/d9/struct__EXITWINDOWSDATA.html#o1">dwReserved</a>;
00080 } <a class="code" href="../../d0/d9/struct__EXITWINDOWSDATA.html">EXITWINDOWSDATA</a>, *<a class="code" href="../../d0/d9/struct__EXITWINDOWSDATA.html">PEXITWINDOWSDATA</a>;
00081 
00082 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d3/d0/csrstubs_8c.html#a5">ExitWindowsThread</a>(PVOID pvParam);
00083 
<a name="l00084"></a><a class="code" href="../../d3/d0/csrstubs_8c.html#a6">00084</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d3/d0/csrstubs_8c.html#a6">ExitWindowsWorker</a>(
00085     UINT uFlags,
00086     DWORD dwReserved,
00087     BOOL fSecondThread)
00088 {
00089     <a class="code" href="../../d0/d9/struct__EXITWINDOWSDATA.html">EXITWINDOWSDATA</a> ewd;
00090     HANDLE hThread;
00091     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwThreadId;
00092     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwExitCode;
00093     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> idWait;
00094     MSG <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>;
00095     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fSuccess;
00096     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00097 
00098     <span class="comment">/*</span>
00099 <span class="comment">     * Force a connection so apps will have a windowstation</span>
00100 <span class="comment">     * to log off of.</span>
00101 <span class="comment">     */</span>
00102     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>() == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00103         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00104 
00105     <span class="comment">/*</span>
00106 <span class="comment">     * Check for UI restrictions</span>
00107 <span class="comment">     */</span>
00108 
00109     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a174">NtUserCallOneParam</a>((ULONG_PTR)uFlags, SFI_PREPAREFORLOGOFF)) {
00110         RIPMSG0(RIP_WARNING, <span class="stringliteral">"ExitWindows called by a restricted thread\n"</span>);
00111         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00112     }
00113 
00114     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d0/csrhlpr_8h.html#a0">CallUserpExitWindowsEx</a>(uFlags, dwReserved, &amp;fSuccess);
00115 
00116     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00117         <span class="keywordflow">return</span> fSuccess;
00118     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_CANT_WAIT &amp;&amp; !fSecondThread) {
00119         ewd.<a class="code" href="../../d0/d9/struct__EXITWINDOWSDATA.html#o0">uFlags</a> = uFlags;
00120         ewd.<a class="code" href="../../d0/d9/struct__EXITWINDOWSDATA.html#o1">dwReserved</a> = dwReserved;
00121         hThread = CreateThread(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, <a class="code" href="../../d3/d0/csrstubs_8c.html#a5">ExitWindowsThread</a>, &amp;ewd,
00122                 0, &amp;dwThreadId);
00123         <span class="keywordflow">if</span> (hThread == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00124             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00125         }
00126         <span class="keywordflow">while</span> (1) {
00127             idWait = <a class="code" href="../../d3/d8/client_8c.html#a58">MsgWaitForMultipleObjectsEx</a>(1, &amp;hThread,
00128                     INFINITE, QS_ALLINPUT, 0);
00129 
00130             <span class="comment">/*</span>
00131 <span class="comment">             * If the thread was signaled, we're done.</span>
00132 <span class="comment">             */</span>
00133             <span class="keywordflow">if</span> (idWait == WAIT_OBJECT_0)
00134                 <span class="keywordflow">break</span>;
00135 
00136             <span class="comment">/*</span>
00137 <span class="comment">             * Process any waiting messages</span>
00138 <span class="comment">             */</span>
00139             <span class="keywordflow">while</span> (<a class="code" href="../../d5/d9/cltxt_8h.html#a14">PeekMessage</a>(&amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, 0, PM_REMOVE))
00140                 <a class="code" href="../../d5/d9/cltxt_8h.html#a24">DispatchMessage</a>(&amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>);
00141         }
00142         GetExitCodeThread(hThread, &amp;dwExitCode);
00143         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hThread);
00144         <span class="keywordflow">if</span> (dwExitCode == ERROR_SUCCESS)
00145             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00146         <span class="keywordflow">else</span> {
00147             RIPERR0(dwExitCode, RIP_VERBOSE, <span class="stringliteral">""</span>);
00148             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00149         }
00150     } <span class="keywordflow">else</span> {
00151         RIPNTERR0(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>, RIP_VERBOSE, <span class="stringliteral">""</span>);
00152         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00153     }
00154 }
00155 
<a name="l00156"></a><a class="code" href="../../d3/d0/csrstubs_8c.html#a5">00156</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d3/d0/csrstubs_8c.html#a5">ExitWindowsThread</a>(
00157     PVOID pvParam)
00158 {
00159     <a class="code" href="../../d3/d0/csrstubs_8c.html#a2">PEXITWINDOWSDATA</a> pewd = pvParam;
00160     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwExitCode;
00161 
00162     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d0/csrstubs_8c.html#a6">ExitWindowsWorker</a>(pewd-&gt;<a class="code" href="../../d0/d9/struct__EXITWINDOWSDATA.html#o0">uFlags</a>, pewd-&gt;<a class="code" href="../../d0/d9/struct__EXITWINDOWSDATA.html#o1">dwReserved</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>))
00163         dwExitCode = 0;
00164     <span class="keywordflow">else</span>
00165         dwExitCode = GetLastError();
00166     ExitThread(dwExitCode);
00167     <span class="keywordflow">return</span> 0;
00168 }
00169 
<a name="l00170"></a><a class="code" href="../../d3/d0/csrstubs_8c.html#a7">00170</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d3/d0/csrstubs_8c.html#a7">ExitWindowsEx</a>(
00171     UINT uFlags,
00172     DWORD dwReserved)
00173 {
00174     <span class="keywordflow">return</span> <a class="code" href="../../d3/d0/csrstubs_8c.html#a6">ExitWindowsWorker</a>(uFlags, dwReserved, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00175 }
00176 
00177 <span class="preprocessor">#endif</span>
00178 <span class="preprocessor"></span>
00179 <span class="preprocessor">#if !defined(BUILD_WOW6432)</span>
00180 <span class="preprocessor"></span>
<a name="l00181"></a><a class="code" href="../../d3/d0/csrstubs_8c.html#a8">00181</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d3/d0/csrstubs_8c.html#a8">EndTask</a>(
00182     HWND hwnd,
00183     BOOL fShutdown,
00184     BOOL fForce)
00185 {
00186     <a class="code" href="../../d3/d4/struct__USER__API__MSG.html">USER_API_MSG</a> m;
00187     <a class="code" href="../../d5/d3/struct__ENDTASKMSG.html">PENDTASKMSG</a> a = &amp;m.<a class="code" href="../../d3/d4/struct__USER__API__MSG.html#o15">u</a>.EndTask;
00188 
00189     a-&gt;<a class="code" href="../../d5/d3/struct__ENDTASKMSG.html#o1">hwnd</a> = hwnd;
00190     a-&gt;<a class="code" href="../../d5/d3/struct__ENDTASKMSG.html#o2">fShutdown</a> = fShutdown;
00191     a-&gt;<a class="code" href="../../d5/d3/struct__ENDTASKMSG.html#o3">fForce</a> = fForce;
00192     <a class="code" href="../../d8/d9/wow64csr_8c.html#a4">CsrClientCallServer</a>( (PCSR_API_MSG)&amp;m,
00193                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00194                          CSR_MAKE_API_NUMBER( USERSRV_SERVERDLL_INDEX,
00195                                               <a class="code" href="../../d2/d0/csrmsg_8h.html#a35a25">UserpEndTask</a>
00196                                             ),
00197                          <span class="keyword">sizeof</span>( *a )
00198                        );
00199     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( m.ReturnValue )) {
00200         <a class="code" href="../../d3/d0/csrstubs_8c.html#a0">SET_LAST_ERROR_RETURNED</a>();
00201         <span class="keywordflow">return</span> a-&gt;fSuccess;
00202     } <span class="keywordflow">else</span> {
00203         RIPNTERR0(m.ReturnValue, RIP_VERBOSE, <span class="stringliteral">""</span>);
00204         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00205     }
00206 }
00207 
00208 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00209 <a class="code" href="../../d1/d1/bench_8c.html#a0">APIENTRY</a>
<a name="l00210"></a><a class="code" href="../../d3/d0/csrstubs_8c.html#a9">00210</a> <a class="code" href="../../d0/d0/csrhlpr_8h.html#a2">Logon</a>(
00211     BOOL fLogon)
00212 {
00213     <a class="code" href="../../d3/d4/struct__USER__API__MSG.html">USER_API_MSG</a> m;
00214     <a class="code" href="../../d4/d3/struct__LOGONMSG.html">PLOGONMSG</a> a = &amp;m.<a class="code" href="../../d3/d4/struct__USER__API__MSG.html#o15">u</a>.Logon;
00215 
00216     a-&gt;<a class="code" href="../../d4/d3/struct__LOGONMSG.html#o0">fLogon</a> = fLogon;
00217     <a class="code" href="../../d8/d9/wow64csr_8c.html#a4">CsrClientCallServer</a>( (PCSR_API_MSG)&amp;m,
00218                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00219                          CSR_MAKE_API_NUMBER( USERSRV_SERVERDLL_INDEX,
00220                                               <a class="code" href="../../d2/d0/csrmsg_8h.html#a35a26">UserpLogon</a>
00221                                             ),
00222                          <span class="keyword">sizeof</span>(*a)
00223                        );
00224 }
00225 
00226 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00227 <a class="code" href="../../d1/d1/bench_8c.html#a0">APIENTRY</a>
<a name="l00228"></a><a class="code" href="../../d0/d0/csrhlpr_8h.html#a1">00228</a> <a class="code" href="../../d0/d0/csrhlpr_8h.html#a1">CallUserpRegisterLogonProcess</a>(
00229     IN DWORD dwProcessId)
00230 {
00231 
00232     <a class="code" href="../../d3/d4/struct__USER__API__MSG.html">USER_API_MSG</a> m;
00233     <a class="code" href="../../d4/d3/struct__LOGONMSG.html">PLOGONMSG</a> a = &amp;m.<a class="code" href="../../d3/d4/struct__USER__API__MSG.html#o15">u</a>.Logon;
00234     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00235 
00236     m.<a class="code" href="../../d3/d4/struct__USER__API__MSG.html#o15">u</a>.IdLogon = dwProcessId;
00237     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d9/wow64csr_8c.html#a4">CsrClientCallServer</a>( (PCSR_API_MSG)&amp;m,
00238                                   <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00239                                   CSR_MAKE_API_NUMBER( USERSRV_SERVERDLL_INDEX,
00240                                                        <a class="code" href="../../d2/d0/csrmsg_8h.html#a35a31">UserpRegisterLogonProcess</a>),
00241                                   <span class="keyword">sizeof</span>(*a));
00242 
00243     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00244 }
00245 
00246 <span class="preprocessor">#endif</span>
00247 <span class="preprocessor"></span>
00248 <span class="preprocessor">#if !defined(BUILD_CSRWOW64)</span>
00249 <span class="preprocessor"></span>
<a name="l00250"></a><a class="code" href="../../d3/d0/csrstubs_8c.html#a3">00250</a> <span class="keyword">extern</span> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d8/client_8c.html#a18">gfLogonProcess</a>;
00251 
<a name="l00252"></a><a class="code" href="../../d3/d0/csrstubs_8c.html#a11">00252</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d0/csrstubs_8c.html#a11">RegisterLogonProcess</a>(
00253     DWORD dwProcessId,
00254     BOOL fSecure)
00255 {
00256     <a class="code" href="../../d3/d8/client_8c.html#a18">gfLogonProcess</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a180">NtUserCallTwoParam</a>(dwProcessId, fSecure,
00257             SFI__REGISTERLOGONPROCESS);
00258 
00259     <span class="comment">/*</span>
00260 <span class="comment">     * Now, register the logon process into winsrv.</span>
00261 <span class="comment">     */</span>
00262     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/client_8c.html#a18">gfLogonProcess</a>) {
00263         <a class="code" href="../../d0/d0/csrhlpr_8h.html#a1">CallUserpRegisterLogonProcess</a>(dwProcessId);
00264     }
00265 
00266     <span class="keywordflow">return</span> <a class="code" href="../../d3/d8/client_8c.html#a18">gfLogonProcess</a>;
00267 }
00268 
00269 <span class="preprocessor">#endif</span>
00270 <span class="preprocessor"></span>
00271 <span class="preprocessor">#if !defined(BUILD_WOW6432)</span>
00272 <span class="preprocessor"></span>
00273 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
00274 WINAPI
<a name="l00275"></a><a class="code" href="../../d3/d0/csrstubs_8c.html#a12">00275</a> <a class="code" href="../../d3/d0/csrstubs_8c.html#a12">RegisterServicesProcess</a>(
00276     DWORD dwProcessId)
00277 {
00278     <a class="code" href="../../d3/d4/struct__USER__API__MSG.html">USER_API_MSG</a> m;
00279     <a class="code" href="../../d3/d3/struct__REGISTERSERVICESPROCESSMSG.html">PREGISTERSERVICESPROCESSMSG</a> a = &amp;m.<a class="code" href="../../d3/d4/struct__USER__API__MSG.html#o15">u</a>.RegisterServicesProcess;
00280 
00281     a-&gt;<a class="code" href="../../d3/d3/struct__REGISTERSERVICESPROCESSMSG.html#o1">dwProcessId</a> = dwProcessId;
00282     <a class="code" href="../../d8/d9/wow64csr_8c.html#a4">CsrClientCallServer</a>( (PCSR_API_MSG)&amp;m,
00283                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00284                          CSR_MAKE_API_NUMBER( USERSRV_SERVERDLL_INDEX,
00285                                               <a class="code" href="../../d2/d0/csrmsg_8h.html#a35a27">UserpRegisterServicesProcess</a>
00286                                             ),
00287                          <span class="keyword">sizeof</span>( *a )
00288                        );
00289     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( m.ReturnValue )) {
00290         <a class="code" href="../../d3/d0/csrstubs_8c.html#a0">SET_LAST_ERROR_RETURNED</a>();
00291         <span class="keywordflow">return</span> a-&gt;fSuccess;
00292     } <span class="keywordflow">else</span> {
00293         RIPNTERR0(m.ReturnValue, RIP_VERBOSE, <span class="stringliteral">""</span>);
00294         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00295     }
00296 }
00297 
<a name="l00298"></a><a class="code" href="../../d3/d0/csrstubs_8c.html#a13">00298</a> HDESK WINAPI <a class="code" href="../../d3/d0/csrstubs_8c.html#a13">GetThreadDesktop</a>(
00299     DWORD dwThreadId)
00300 {
00301     <a class="code" href="../../d3/d4/struct__USER__API__MSG.html">USER_API_MSG</a> m;
00302     <a class="code" href="../../d2/d2/struct__GETTHREADCONSOLEDESKTOPMSG.html">PGETTHREADCONSOLEDESKTOPMSG</a> a = &amp;m.<a class="code" href="../../d3/d4/struct__USER__API__MSG.html#o15">u</a>.GetThreadConsoleDesktop;
00303 
00304     a-&gt;<a class="code" href="../../d2/d2/struct__GETTHREADCONSOLEDESKTOPMSG.html#o0">dwThreadId</a> = dwThreadId;
00305     <a class="code" href="../../d8/d9/wow64csr_8c.html#a4">CsrClientCallServer</a>( (PCSR_API_MSG)&amp;m,
00306                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00307                          CSR_MAKE_API_NUMBER( USERSRV_SERVERDLL_INDEX,
00308                                               <a class="code" href="../../d2/d0/csrmsg_8h.html#a35a29">UserpGetThreadConsoleDesktop</a>
00309                                             ),
00310                          <span class="keyword">sizeof</span>( *a )
00311                        );
00312     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( m.ReturnValue )) {
00313         <span class="keywordflow">return</span> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a100">NtUserGetThreadDesktop</a>(dwThreadId, a-&gt;hdeskConsole);
00314     } <span class="keywordflow">else</span> {
00315         RIPNTERR0(m.ReturnValue, RIP_VERBOSE, <span class="stringliteral">""</span>);
00316         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00317     }
00318 }
00319 
00320 
00321 <span class="comment">/**************************************************************************\</span>
00322 <span class="comment">* DeviceEventWorker</span>
00323 <span class="comment">*</span>
00324 <span class="comment">* This is a private (not publicly exported) interface that the user-mode</span>
00325 <span class="comment">* pnp manager calls when it needs to send a WM_DEVICECHANGE message to a</span>
00326 <span class="comment">* specific window handle. The user-mode pnp manager is a service within</span>
00327 <span class="comment">* services.exe and as such is not on the interactive window station and</span>
00328 <span class="comment">* active desktop, so it can't directly call SendMessage. For broadcasted</span>
00329 <span class="comment">* messages (messages that go to all top-level windows), the user-mode pnp</span>
00330 <span class="comment">* manager calls BroadcastSystemMessage directly.</span>
00331 <span class="comment">*</span>
00332 <span class="comment">* PaulaT 06/04/97</span>
00333 <span class="comment">*</span>
00334 <span class="comment">\**************************************************************************/</span>
00335 
00336 ULONG
00337 WINAPI
<a name="l00338"></a><a class="code" href="../../d3/d0/csrstubs_8c.html#a14">00338</a> <a class="code" href="../../d3/d0/csrstubs_8c.html#a14">DeviceEventWorker</a>(
00339     IN HWND    hWnd,
00340     IN WPARAM  wParam,
00341     IN LPARAM  lParam,
00342     IN DWORD   dwFlags,
00343     OUT PDWORD pdwResult
00344     )
00345 {
00346     <a class="code" href="../../d3/d4/struct__USER__API__MSG.html">USER_API_MSG</a> m;
00347     <a class="code" href="../../d2/d5/struct__DEVICEEVENTMSG.html">PDEVICEEVENTMSG</a> a = &amp;m.<a class="code" href="../../d3/d4/struct__USER__API__MSG.html#o15">u</a>.DeviceEvent;
00348     PCSR_CAPTURE_HEADER CaptureBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00349     <span class="keywordtype">int</span> cb = 0;
00350 
00351     a-&gt;<a class="code" href="../../d2/d5/struct__DEVICEEVENTMSG.html#o0">hWnd</a>     = <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>;
00352     a-&gt;<a class="code" href="../../d2/d5/struct__DEVICEEVENTMSG.html#o1">wParam</a>   = wParam;
00353     a-&gt;<a class="code" href="../../d2/d5/struct__DEVICEEVENTMSG.html#o2">lParam</a>   = lParam;
00354     a-&gt;<a class="code" href="../../d2/d5/struct__DEVICEEVENTMSG.html#o3">dwFlags</a>  = <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>;
00355     a-&gt;<a class="code" href="../../d2/d5/struct__DEVICEEVENTMSG.html#o4">dwResult</a> = 0;
00356 
00357     <span class="comment">//</span>
00358     <span class="comment">// If lParam is specified, it must be marshalled (see the defines</span>
00359     <span class="comment">// for this structure in dbt.h - the structure always starts with</span>
00360     <span class="comment">// DEV_BROADCAST_HDR structure).</span>
00361     <span class="comment">//</span>
00362 
00363     <span class="keywordflow">if</span> (lParam) {
00364 
00365         cb = ((PDEV_BROADCAST_HDR)lParam)-&gt;dbch_size;
00366 
00367         CaptureBuffer = <a class="code" href="../../d8/d9/wow64csr_8c.html#a5">CsrAllocateCaptureBuffer</a>(1, cb);
00368         <span class="keywordflow">if</span> (CaptureBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00369             <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00370         }
00371 
00372         <a class="code" href="../../d8/d9/wow64csr_8c.html#a8">CsrCaptureMessageBuffer</a>(CaptureBuffer,
00373                                 (PCHAR)lParam,
00374                                 cb,
00375                                 (PVOID *)&amp;a-&gt;<a class="code" href="../../d2/d5/struct__DEVICEEVENTMSG.html#o2">lParam</a>);
00376 
00377         <span class="comment">//</span>
00378         <span class="comment">// This ends up calling SrvDeviceEvent routine in the server.</span>
00379         <span class="comment">//</span>
00380 
00381         <a class="code" href="../../d8/d9/wow64csr_8c.html#a4">CsrClientCallServer</a>((PCSR_API_MSG)&amp;m,
00382                             CaptureBuffer,
00383                             CSR_MAKE_API_NUMBER(USERSRV_SERVERDLL_INDEX,
00384                                                 <a class="code" href="../../d2/d0/csrmsg_8h.html#a35a30">UserpDeviceEvent</a>),
00385                             <span class="keyword">sizeof</span>(*a));
00386 
00387         <a class="code" href="../../d8/d9/wow64csr_8c.html#a6">CsrFreeCaptureBuffer</a>(CaptureBuffer);
00388 
00389     } <span class="keywordflow">else</span> {
00390 
00391         <span class="comment">//</span>
00392         <span class="comment">// This ends up calling SrvDeviceEvent routine in the server.</span>
00393         <span class="comment">//</span>
00394 
00395         <a class="code" href="../../d8/d9/wow64csr_8c.html#a4">CsrClientCallServer</a>((PCSR_API_MSG)&amp;m,
00396                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00397                             CSR_MAKE_API_NUMBER(USERSRV_SERVERDLL_INDEX,
00398                                                 <a class="code" href="../../d2/d0/csrmsg_8h.html#a35a30">UserpDeviceEvent</a>),
00399                             <span class="keyword">sizeof</span>(*a));
00400     }
00401 
00402 
00403     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(m.<a class="code" href="../../d3/d4/struct__USER__API__MSG.html#o3">ReturnValue</a>)) {
00404         *pdwResult = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)a-&gt;<a class="code" href="../../d2/d5/struct__DEVICEEVENTMSG.html#o4">dwResult</a>;
00405     } <span class="keywordflow">else</span> {
00406         RIPMSG0(RIP_WARNING, <span class="stringliteral">"DeviceEventWorker failed."</span>);
00407     }
00408 
00409     <span class="keywordflow">return</span> m.<a class="code" href="../../d3/d4/struct__USER__API__MSG.html#o3">ReturnValue</a>;
00410 
00411 } <span class="comment">// DeviceEventWorker</span>
00412 
00413 <span class="preprocessor">#if DBG</span>
00414 <span class="preprocessor"></span>
00415 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00416 <a class="code" href="../../d1/d1/bench_8c.html#a0">APIENTRY</a>
00417 <a class="code" href="../../d0/d0/csrhlpr_8h.html#a3">CsrWin32HeapFail</a>(
00418     IN DWORD dwFlags,
00419     IN BOOL  bFail)
00420 {
00421     <a class="code" href="../../d3/d4/struct__USER__API__MSG.html">USER_API_MSG</a> m;
00422     <a class="code" href="../../d7/d8/struct__WIN32HEAPFAILMSG.html">PWIN32HEAPFAILMSG</a> a = &amp;m.<a class="code" href="../../d3/d4/struct__USER__API__MSG.html#o15">u</a>.Win32HeapFail;
00423 
00424     a-&gt;<a class="code" href="../../d7/d8/struct__WIN32HEAPFAILMSG.html#o0">dwFlags</a> = <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>;
00425     a-&gt;<a class="code" href="../../d7/d8/struct__WIN32HEAPFAILMSG.html#o1">bFail</a> = bFail;
00426 
00427     <a class="code" href="../../d8/d9/wow64csr_8c.html#a4">CsrClientCallServer</a>((PCSR_API_MSG)&amp;m,
00428                         NULL,
00429                         CSR_MAKE_API_NUMBER(USERSRV_SERVERDLL_INDEX,
00430                                             UserpWin32HeapFail),
00431                         <span class="keyword">sizeof</span>(*a));
00432 
00433     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(m.ReturnValue)) {
00434         RIPNTERR0(m.ReturnValue, RIP_VERBOSE, <span class="stringliteral">"UserpWin32HeapFail failed"</span>);
00435     }
00436 }
00437 
00438 <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>
00439 <a class="code" href="../../d1/d1/bench_8c.html#a0">APIENTRY</a>
00440 <a class="code" href="../../d0/d0/csrhlpr_8h.html#a4">CsrWin32HeapStat</a>(
00441     PDBGHEAPSTAT    phs,
00442     DWORD   dwLen)
00443 {
00444     <a class="code" href="../../d3/d4/struct__USER__API__MSG.html">USER_API_MSG</a> m;
00445     <a class="code" href="../../d8/d8/struct__WIN32HEAPSTATMSG.html">PWIN32HEAPSTATMSG</a> a = &amp;m.<a class="code" href="../../d3/d4/struct__USER__API__MSG.html#o15">u</a>.Win32HeapStat;
00446     PCSR_CAPTURE_HEADER CaptureBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00447 
00448     a-&gt;<a class="code" href="../../d8/d8/struct__WIN32HEAPSTATMSG.html#o1">dwLen</a> = dwLen;
00449 
00450     CaptureBuffer = <a class="code" href="../../d8/d9/wow64csr_8c.html#a5">CsrAllocateCaptureBuffer</a>(1, dwLen);
00451     <span class="keywordflow">if</span> (CaptureBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00452         <span class="keywordflow">return</span> 0;
00453     }
00454 
00455     <a class="code" href="../../d8/d9/wow64csr_8c.html#a8">CsrCaptureMessageBuffer</a>(CaptureBuffer,
00456                             (PCHAR)phs,
00457                             dwLen,
00458                             (PVOID *)&amp;a-&gt;<a class="code" href="../../d8/d8/struct__WIN32HEAPSTATMSG.html#o0">phs</a>);
00459 
00460     <a class="code" href="../../d8/d9/wow64csr_8c.html#a4">CsrClientCallServer</a>((PCSR_API_MSG)&amp;m,
00461                         CaptureBuffer,
00462                         CSR_MAKE_API_NUMBER(USERSRV_SERVERDLL_INDEX,
00463                                             UserpWin32HeapStat),
00464                         <span class="keyword">sizeof</span>(*a));
00465 
00466     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(m.ReturnValue)) {
00467         RIPNTERR0(m.ReturnValue, RIP_VERBOSE, <span class="stringliteral">"UserpWin32HeapStat failed"</span>);
00468         a-&gt;<a class="code" href="../../d8/d8/struct__WIN32HEAPSTATMSG.html#o2">dwMaxTag</a> = 0;
00469         <span class="keywordflow">goto</span> ErrExit;
00470     }
00471     RtlMoveMemory(phs, a-&gt;<a class="code" href="../../d8/d8/struct__WIN32HEAPSTATMSG.html#o0">phs</a>, dwLen);
00472 
00473 ErrExit:
00474     <a class="code" href="../../d8/d9/wow64csr_8c.html#a6">CsrFreeCaptureBuffer</a>(CaptureBuffer);
00475 
00476     <span class="keywordflow">return</span> a-&gt;<a class="code" href="../../d8/d8/struct__WIN32HEAPSTATMSG.html#o2">dwMaxTag</a>;
00477 }
00478 
00479 <span class="preprocessor">#endif // DBG</span>
00480 <span class="preprocessor"></span>
00481 
00482 <span class="preprocessor">#endif</span>
00483 <span class="preprocessor"></span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:36 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
