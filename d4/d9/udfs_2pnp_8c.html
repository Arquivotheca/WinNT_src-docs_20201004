<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: udfs/pnp.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>pnp.c File Reference</h1><code>#include "UdfProcs.h"</code><br>

<p>
<a href="../../d5/d8/udfs_2pnp_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d9/udfs_2pnp_8c.html#a0">BugCheckFileId</a>&nbsp;&nbsp;&nbsp;(UDFS_BUG_CHECK_PNP)</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d9/udfs_2pnp_8c.html#a1">UdfPnpQueryRemove</a> (<a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d9/udfs_2pnp_8c.html#a2">UdfPnpRemove</a> (<a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d9/udfs_2pnp_8c.html#a3">UdfPnpSurpriseRemove</a> (<a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d9/udfs_2pnp_8c.html#a4">UdfPnpCancelRemove</a> (<a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d9/udfs_2pnp_8c.html#a5">UdfPnpCompletionRoutine</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IN PVOID Contxt)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d9/udfs_2pnp_8c.html#a6">UdfCommonPnp</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="udfs/pnp.c::BugCheckFileId" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define BugCheckFileId&nbsp;&nbsp;&nbsp;(UDFS_BUG_CHECK_PNP)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00028">28</a> of file <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html">udfs/pnp.c</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a6" doxytag="udfs/pnp.c::UdfCommonPnp" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS UdfCommonPnp           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00075">75</a> of file <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html">udfs/pnp.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l02488">_IO_STACK_LOCATION::DeviceObject</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00699">_VOLUME_DEVICE_OBJECT::DeviceObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02865">IoCallDriver</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l04044">IoSkipCurrentIrpStackLocation</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01235">IRP_CONTEXT_FLAG_WAIT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00163">IRP_MN_CANCEL_REMOVE_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00161">IRP_MN_QUERY_REMOVE_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00162">IRP_MN_REMOVE_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00184">IRP_MN_SURPRISE_REMOVAL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d1/d6/lfs_2nodetype_8h-source.html#l00051">NodeType</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01177">_DEVICE_OBJECT::Size</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00541">_VCB::TargetDeviceObject</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00809">UdfCompleteRequest()</a>, <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00632">UdfPnpCancelRemove()</a>, <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00194">UdfPnpQueryRemove()</a>, <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00350">UdfPnpRemove()</a>, <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00500">UdfPnpSurpriseRemove()</a>, <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00036">UDFS_NTC_VCB</a>, and <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00736">_VOLUME_DEVICE_OBJECT::Vcb</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00218">UdfFsdDispatch()</a>, and <a class="el" href="../../d1/d7/fspdisp_8c-source.html#l00038">UdfFspDispatch()</a>.
<p>
<pre class="fragment"><div>00082                    :
00083 
00084     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> common routine <span class="keywordflow">for</span> doing PnP operations called
00085     by both <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> fsd and fsp threads
00086 
00087 Arguments:
00088 
00089     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> to process
00090 
00091 Return Value:
00092 
00093     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - The <span class="keywordflow">return</span> status <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation
00094 
00095 --*/
00096 
00097 {
00098     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00099     
00100     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp;
00101 
00102     <a class="code" href="../../d6/d7/struct__VOLUME__DEVICE__OBJECT.html">PVOLUME_DEVICE_OBJECT</a> OurDeviceObject;
00103     <a class="code" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb;
00104 
00105     <span class="comment">//</span>
00106     <span class="comment">//  Get the current Irp stack location.</span>
00107     <span class="comment">//</span>
00108 
00109     IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp );
00110 
00111     <span class="comment">//</span>
00112     <span class="comment">//  Find our Vcb.  This is tricky since we have no file object in the Irp.</span>
00113     <span class="comment">//</span>
00114 
00115     OurDeviceObject = (<a class="code" href="../../d6/d7/struct__VOLUME__DEVICE__OBJECT.html">PVOLUME_DEVICE_OBJECT</a>) IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o57">DeviceObject</a>;
00116 
00117     <span class="comment">//</span>
00118     <span class="comment">//  Make sure this device object really is big enough to be a volume device</span>
00119     <span class="comment">//  object.  If it isn't, we need to get out before we try to reference some</span>
00120     <span class="comment">//  field that takes us past the end of an ordinary device object.</span>
00121     <span class="comment">//</span>
00122     
00123     <span class="keywordflow">if</span> (OurDeviceObject-&gt;<a class="code" href="../../d6/d7/struct__VOLUME__DEVICE__OBJECT.html#o0">DeviceObject</a>.<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o1">Size</a> != <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d7/struct__VOLUME__DEVICE__OBJECT.html">VOLUME_DEVICE_OBJECT</a>) ||
00124         <a class="code" href="../../d0/d7/lfs_2nodetype_8h.html#a6">NodeType</a>( &amp;OurDeviceObject-&gt;<a class="code" href="../../d6/d7/struct__VOLUME__DEVICE__OBJECT.html#o5">Vcb</a> ) != <a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a2">UDFS_NTC_VCB</a>) {
00125         
00126         <span class="comment">//</span>
00127         <span class="comment">//  We were called with something we don't understand.</span>
00128         <span class="comment">//</span>
00129         
00130         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00131         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, Status );
00132         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00133     }
00134 
00135     <span class="comment">//</span>
00136     <span class="comment">//  Force all PnP operations to be synchronous.</span>
00137     <span class="comment">//</span>
00138 
00139     <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( IrpContext-&gt;Flags, IRP_CONTEXT_FLAG_WAIT );
00140 
00141     Vcb = &amp;OurDeviceObject-&gt;<a class="code" href="../../d6/d7/struct__VOLUME__DEVICE__OBJECT.html#o5">Vcb</a>;
00142 
00143     <span class="comment">//</span>
00144     <span class="comment">//  Case on the minor code.</span>
00145     <span class="comment">//</span>
00146     
00147     <span class="keywordflow">switch</span> ( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> ) {
00148 
00149         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a66">IRP_MN_QUERY_REMOVE_DEVICE</a>:
00150             
00151             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d9/udfs_2pnp_8c.html#a1">UdfPnpQueryRemove</a>( IrpContext, Irp, Vcb );
00152             <span class="keywordflow">break</span>;
00153         
00154         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a87">IRP_MN_SURPRISE_REMOVAL</a>:
00155         
00156             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d9/udfs_2pnp_8c.html#a3">UdfPnpSurpriseRemove</a>( IrpContext, Irp, Vcb );
00157             <span class="keywordflow">break</span>;
00158 
00159         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a67">IRP_MN_REMOVE_DEVICE</a>:
00160 
00161             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d9/udfs_2pnp_8c.html#a2">UdfPnpRemove</a>( IrpContext, Irp, Vcb );
00162             <span class="keywordflow">break</span>;
00163 
00164         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a68">IRP_MN_CANCEL_REMOVE_DEVICE</a>:
00165     
00166             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d9/udfs_2pnp_8c.html#a4">UdfPnpCancelRemove</a>( IrpContext, Irp, Vcb );
00167             <span class="keywordflow">break</span>;
00168 
00169         <span class="keywordflow">default</span>:
00170     
00171             <span class="comment">//</span>
00172             <span class="comment">//  Just pass the IRP on.  As we do not need to be in the</span>
00173             <span class="comment">//  way on return, ellide ourselves out of the stack.</span>
00174             <span class="comment">//</span>
00175             
00176             <a class="code" href="../../d0/d5/io_8h.html#a240">IoSkipCurrentIrpStackLocation</a>( Irp );
00177     
00178             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>(Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o4">TargetDeviceObject</a>, Irp);
00179             
00180             <span class="comment">//</span>
00181             <span class="comment">//  Cleanup our Irp Context.  The driver has completed the Irp.</span>
00182             <span class="comment">//</span>
00183         
00184             <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, NULL, STATUS_SUCCESS );
00185             
00186             <span class="keywordflow">break</span>;
00187     }
00188         
00189     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00190 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="udfs/pnp.c::UdfPnpCancelRemove" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS UdfPnpCancelRemove           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vcb</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00632">632</a> of file <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html">udfs/pnp.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02865">IoCallDriver</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l04044">IoSkipCurrentIrpStackLocation</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00541">_VCB::TargetDeviceObject</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01515">UdfAcquireVcbExclusive</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00809">UdfCompleteRequest()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01521">UdfReleaseVcb</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00732">UdfUnlockVolumeInternal()</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00075">UdfCommonPnp()</a>.
<p>
<pre class="fragment"><div>00640                    :
00641 
00642     This routine handles <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PnP cancel remove operation.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> our
00643     notification that a previously proposed remove (query) was eventually
00644     vetoed by a component.  The filesystem is responsible for cleaning up
00645     and getting ready for more IO.
00646     
00647 Arguments:
00648 
00649     Irp - Supplies the Irp to process
00650     
00651     Vcb - Supplies the volume being removed.
00652 
00653 Return Value:
00654 
00655     NTSTATUS - The return status for the operation
00656 
00657 --*/
00658 
00659 {
00660     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00661 
00662     <span class="comment">//</span>
00663     <span class="comment">//  CANCEL - a previous QUERY has been rescinded as a result</span>
00664     <span class="comment">//  of someone vetoing.  Since PnP cannot figure out who may</span>
00665     <span class="comment">//  have gotten the QUERY (think about it: stacked drivers),</span>
00666     <span class="comment">//  we must expect to deal with getting a CANCEL without having</span>
00667     <span class="comment">//  seen the QUERY.</span>
00668     <span class="comment">//</span>
00669     <span class="comment">//  For UDFS, this is quite easy.  In fact, we can't get a</span>
00670     <span class="comment">//  CANCEL if the underlying drivers succeeded the QUERY since</span>
00671     <span class="comment">//  we disconnect the Vpb on our dismount initiation.  This is</span>
00672     <span class="comment">//  actually pretty important because if PnP could get to us</span>
00673     <span class="comment">//  after the disconnect we'd be thoroughly unsynchronized</span>
00674     <span class="comment">//  with respect to the Vcb getting torn apart - merely referencing</span>
00675     <span class="comment">//  the volume device object is insufficient to keep us intact.</span>
00676     <span class="comment">//</span>
00677     
00678     <a class="code" href="../../d3/d8/udfprocs_8h.html#a74">UdfAcquireVcbExclusive</a>( IrpContext, Vcb, FALSE );
00679     
00680     <span class="comment">//</span>
00681     <span class="comment">//  Unlock the volume.  This is benign if we never had seen</span>
00682     <span class="comment">//  a QUERY.</span>
00683     <span class="comment">//</span>
00684 
00685     (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d3/d8/udfprocs_8h.html#a191">UdfUnlockVolumeInternal</a>( IrpContext, Vcb, NULL );
00686 
00687     <a class="code" href="../../d3/d8/udfprocs_8h.html#a76">UdfReleaseVcb</a>( IrpContext, Vcb );
00688 
00689     <span class="comment">//</span>
00690     <span class="comment">//  Send the request.  The underlying driver will complete the</span>
00691     <span class="comment">//  IRP.  Since we don't need to be in the way, simply ellide</span>
00692     <span class="comment">//  ourselves out of the IRP stack.</span>
00693     <span class="comment">//</span>
00694 
00695     <a class="code" href="../../d0/d5/io_8h.html#a240">IoSkipCurrentIrpStackLocation</a>( Irp );
00696 
00697     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>(Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o4">TargetDeviceObject</a>, Irp);
00698 
00699     <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, NULL, STATUS_SUCCESS );
00700 
00701     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00702 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="udfs/pnp.c::UdfPnpCompletionRoutine" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS UdfPnpCompletionRoutine           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Contxt</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00710">710</a> of file <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html">udfs/pnp.c</a>.
<p>
References <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00086">Event()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, and <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>.
<p>
Referenced by <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00194">UdfPnpQueryRemove()</a>, <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00350">UdfPnpRemove()</a>, and <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00500">UdfPnpSurpriseRemove()</a>.
<p>
<pre class="fragment"><div>00715 {
00716     <a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> = (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) Contxt;
00717 
00718     <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( Event, 0, FALSE );
00719 
00720     <span class="keywordflow">return</span> STATUS_MORE_PROCESSING_REQUIRED;
00721 
00722     UNREFERENCED_PARAMETER( DeviceObject );
00723     UNREFERENCED_PARAMETER( Contxt );
00724 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="udfs/pnp.c::UdfPnpQueryRemove" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS UdfPnpQueryRemove           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vcb</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00194">194</a> of file <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html">udfs/pnp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00086">Event()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02865">IoCallDriver</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l04009">IoCopyCurrentIrpStackLocationToNext</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03913">IoSetCompletionRoutine</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00541">_VCB::TargetDeviceObject</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01509">UdfAcquireUdfData</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01515">UdfAcquireVcbExclusive</a>, <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00236">UdfCheckForDismount()</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00809">UdfCompleteRequest()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00621">UdfLockVolumeInternal()</a>, <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00710">UdfPnpCompletionRoutine()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01512">UdfReleaseUdfData</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01521">UdfReleaseVcb</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00559">_VCB::VcbCondition</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a130a121">VcbDismountInProgress</a>, and <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00612">_VCB::VcbReference</a>.
<p>
Referenced by <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00075">UdfCommonPnp()</a>.
<p>
<pre class="fragment"><div>00202                    :
00203 
00204     This routine handles <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PnP query remove operation.  The filesystem
00205     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> responsible <span class="keywordflow">for</span> answering whether there are any reasons <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> sees
00206     that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume can not go away (and the device removed).  Initiation
00207     of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dismount begins when we answer yes to <span class="keyword">this</span> question.
00208     
00209     Query will be followed by a Cancel or Remove.
00210 
00211 Arguments:
00212 
00213     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> to process
00214     
00215     Vcb - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume being queried.
00216 
00217 Return Value:
00218 
00219     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - The <span class="keywordflow">return</span> status <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation
00220 
00221 --*/
00222 
00223 {
00224     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00225     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
00226     BOOLEAN VcbPresent = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00227 
00228     <span class="comment">//</span>
00229     <span class="comment">//  Having said yes to a QUERY, any communication with the</span>
00230     <span class="comment">//  underlying storage stack is undefined (and may block)</span>
00231     <span class="comment">//  until the bounding CANCEL or REMOVE is sent.</span>
00232     <span class="comment">//</span>
00233 
00234     <span class="comment">//</span>
00235     <span class="comment">//  Acquire the global resource so that we can try to vaporize</span>
00236     <span class="comment">//  the volume, and the vcb resource itself.</span>
00237     <span class="comment">//</span>
00238     
00239     <a class="code" href="../../d3/d8/udfprocs_8h.html#a74">UdfAcquireVcbExclusive</a>( IrpContext, Vcb, FALSE );
00240 
00241     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a190">UdfLockVolumeInternal</a>( IrpContext, Vcb, NULL );
00242 
00243     <a class="code" href="../../d3/d8/udfprocs_8h.html#a76">UdfReleaseVcb</a>( IrpContext, Vcb );
00244     <a class="code" href="../../d3/d8/udfprocs_8h.html#a72">UdfAcquireUdfData</a>( IrpContext );
00245     <a class="code" href="../../d3/d8/udfprocs_8h.html#a74">UdfAcquireVcbExclusive</a>( IrpContext, Vcb, FALSE );
00246 
00247     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00248 
00249         <span class="comment">//</span>
00250         <span class="comment">//  We need to pass this down before starting the dismount, which</span>
00251         <span class="comment">//  could disconnect us immediately from the stack.</span>
00252         <span class="comment">//</span>
00253         
00254         <span class="comment">//</span>
00255         <span class="comment">//  Get the next stack location, and copy over the stack location</span>
00256         <span class="comment">//</span>
00257 
00258         <a class="code" href="../../d0/d5/io_8h.html#a239">IoCopyCurrentIrpStackLocationToNext</a>( Irp );
00259 
00260         <span class="comment">//</span>
00261         <span class="comment">//  Set up the completion routine</span>
00262         <span class="comment">//</span>
00263     
00264         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;Event, NotificationEvent, FALSE );
00265         <a class="code" href="../../d0/d5/io_8h.html#a237">IoSetCompletionRoutine</a>( Irp,
00266                                 UdfPnpCompletionRoutine,
00267                                 &amp;Event,
00268                                 TRUE,
00269                                 TRUE,
00270                                 TRUE );
00271 
00272         <span class="comment">//</span>
00273         <span class="comment">//  Send the request and wait.</span>
00274         <span class="comment">//</span>
00275 
00276         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>(Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o4">TargetDeviceObject</a>, Irp);
00277 
00278         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_PENDING) {
00279 
00280             <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;Event,
00281                                    Executive,
00282                                    KernelMode,
00283                                    FALSE,
00284                                    NULL );
00285 
00286             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status;
00287         }
00288 
00289         <span class="comment">//</span>
00290         <span class="comment">//  Now if no one below us failed already, initiate the dismount</span>
00291         <span class="comment">//  on this volume, make it go away.  PnP needs to see our internal</span>
00292         <span class="comment">//  streams close and drop their references to the target device.</span>
00293         <span class="comment">//</span>
00294         <span class="comment">//  Since we were able to lock the volume, we are guaranteed to</span>
00295         <span class="comment">//  move this volume into dismount state and disconnect it from</span>
00296         <span class="comment">//  the underlying storage stack.  The force on our part is actually</span>
00297         <span class="comment">//  unnecesary, though complete.</span>
00298         <span class="comment">//</span>
00299         <span class="comment">//  What is not strictly guaranteed, though, is that the closes</span>
00300         <span class="comment">//  for the metadata streams take effect synchronously underneath</span>
00301         <span class="comment">//  of this call.  This would leave references on the target device</span>
00302         <span class="comment">//  even though we are disconnected!</span>
00303         <span class="comment">//</span>
00304 
00305         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00306             
00307             VcbPresent = <a class="code" href="../../d8/d5/udfs_2verfysup_8c.html#a3">UdfCheckForDismount</a>( IrpContext, Vcb, TRUE );
00308     
00309             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( !VcbPresent || Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o8">VcbCondition</a> == VcbDismountInProgress );
00310         }
00311     }
00312     
00313     <span class="comment">//</span>
00314     <span class="comment">//  Release the Vcb if it could still remain.</span>
00315     <span class="comment">//</span>
00316     <span class="comment">//  Note: if everything else succeeded and the Vcb is persistent because the</span>
00317     <span class="comment">//  internal streams did not vaporize, we really need to pend this IRP off on</span>
00318     <span class="comment">//  the side until the dismount is completed.  I can't think of a reasonable</span>
00319     <span class="comment">//  case (in UDFS) where this would actually happen, though it might still need</span>
00320     <span class="comment">//  to be implemented.</span>
00321     <span class="comment">//</span>
00322     <span class="comment">//  The reason this is the case is that handles/fileobjects place a reference</span>
00323     <span class="comment">//  on the device objects they overly.  In the filesystem case, these references</span>
00324     <span class="comment">//  are on our target devices.  PnP correcly thinks that if references remain</span>
00325     <span class="comment">//  on the device objects in the stack that someone has a handle, and that this</span>
00326     <span class="comment">//  counts as a reason to not succeed the query - even though every interrogated</span>
00327     <span class="comment">//  driver thinks that it is OK.</span>
00328     <span class="comment">//</span>
00329     
00330     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( !(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) &amp;&amp; VcbPresent &amp;&amp; Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o16">VcbReference</a> != 0));
00331     
00332     <span class="keywordflow">if</span> (VcbPresent) {
00333 
00334         <a class="code" href="../../d3/d8/udfprocs_8h.html#a76">UdfReleaseVcb</a>( IrpContext, Vcb );
00335     }
00336 
00337     <a class="code" href="../../d3/d8/udfprocs_8h.html#a73">UdfReleaseUdfData</a>( IrpContext );
00338     
00339     <span class="comment">//</span>
00340     <span class="comment">//  Cleanup our IrpContext and complete the IRP if neccesary.</span>
00341     <span class="comment">//</span>
00342 
00343     <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, Status );
00344 
00345     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00346 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="udfs/pnp.c::UdfPnpRemove" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS UdfPnpRemove           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vcb</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00350">350</a> of file <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html">udfs/pnp.c</a>.
<p>
References <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00086">Event()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02865">IoCallDriver</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l04009">IoCopyCurrentIrpStackLocationToNext</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03913">IoSetCompletionRoutine</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00541">_VCB::TargetDeviceObject</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01509">UdfAcquireUdfData</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01515">UdfAcquireVcbExclusive</a>, <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00236">UdfCheckForDismount()</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00809">UdfCompleteRequest()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01559">UdfLockVcb</a>, <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00710">UdfPnpCompletionRoutine()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01512">UdfReleaseUdfData</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01521">UdfReleaseVcb</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01563">UdfUnlockVcb</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00732">UdfUnlockVolumeInternal()</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00559">_VCB::VcbCondition</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a130a121">VcbDismountInProgress</a>, and <a class="el" href="../../d6/d8/udfstruc_8h.html#a130a120">VcbInvalid</a>.
<p>
Referenced by <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00075">UdfCommonPnp()</a>.
<p>
<pre class="fragment"><div>00358                    :
00359 
00360     This routine handles <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PnP remove operation.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> our notification
00361     that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> underlying storage device <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume we have <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> gone, and
00362     an excellent indication that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume will never reappear. The filesystem
00363     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> responsible <span class="keywordflow">for</span> initiation or completion <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dismount.
00364     
00365 Arguments:
00366 
00367     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> to process
00368     
00369     Vcb - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume being removed.
00370 
00371 Return Value:
00372 
00373     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - The <span class="keywordflow">return</span> status <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation
00374 
00375 --*/
00376 
00377 {
00378     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00379     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
00380     BOOLEAN VcbPresent = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00381     
00382     <span class="comment">//</span>
00383     <span class="comment">//  REMOVE - a storage device is now gone.  We either got</span>
00384     <span class="comment">//  QUERY'd and said yes OR got a SURPRISE OR a storage</span>
00385     <span class="comment">//  stack failed to spin back up from a sleep/stop state</span>
00386     <span class="comment">//  (the only case in which this will be the first warning).</span>
00387     <span class="comment">//</span>
00388     <span class="comment">//  Note that it is entirely unlikely that we will be around</span>
00389     <span class="comment">//  for a REMOVE in the first two cases, as we try to intiate</span>
00390     <span class="comment">//  dismount.</span>
00391     <span class="comment">//</span>
00392     
00393     <span class="comment">//</span>
00394     <span class="comment">//  Acquire the global resource so that we can try to vaporize</span>
00395     <span class="comment">//  the volume, and the vcb resource itself.</span>
00396     <span class="comment">//</span>
00397     
00398     <a class="code" href="../../d3/d8/udfprocs_8h.html#a72">UdfAcquireUdfData</a>( IrpContext );
00399     <a class="code" href="../../d3/d8/udfprocs_8h.html#a74">UdfAcquireVcbExclusive</a>( IrpContext, Vcb, FALSE );
00400 
00401     <span class="comment">//</span>
00402     <span class="comment">//  The device will be going away.  Remove our lock and find</span>
00403     <span class="comment">//  out if we ever had one in the first place.</span>
00404     <span class="comment">//</span>
00405 
00406     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a191">UdfUnlockVolumeInternal</a>( IrpContext, Vcb, NULL );
00407 
00408     <span class="comment">//</span>
00409     <span class="comment">//  If the volume had not been locked, we must invalidate the</span>
00410     <span class="comment">//  volume to ensure it goes away properly.  The remove will</span>
00411     <span class="comment">//  succeed.</span>
00412     <span class="comment">//</span>
00413 
00414     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00415 
00416         <a class="code" href="../../d3/d8/udfprocs_8h.html#a88">UdfLockVcb</a>( IrpContext, Vcb );
00417         
00418         <span class="keywordflow">if</span> (Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o8">VcbCondition</a> != <a class="code" href="../../d6/d8/udfstruc_8h.html#a130a121">VcbDismountInProgress</a>) {
00419             Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o8">VcbCondition</a> = <a class="code" href="../../d6/d8/udfstruc_8h.html#a130a120">VcbInvalid</a>;
00420         }
00421         
00422         <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, Vcb );
00423         
00424         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00425     }
00426     
00427     <span class="comment">//</span>
00428     <span class="comment">//  We need to pass this down before starting the dismount, which</span>
00429     <span class="comment">//  could disconnect us immediately from the stack.</span>
00430     <span class="comment">//</span>
00431     
00432     <span class="comment">//</span>
00433     <span class="comment">//  Get the next stack location, and copy over the stack location</span>
00434     <span class="comment">//</span>
00435 
00436     <a class="code" href="../../d0/d5/io_8h.html#a239">IoCopyCurrentIrpStackLocationToNext</a>( Irp );
00437 
00438     <span class="comment">//</span>
00439     <span class="comment">//  Set up the completion routine</span>
00440     <span class="comment">//</span>
00441 
00442     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;Event, NotificationEvent, FALSE );
00443     <a class="code" href="../../d0/d5/io_8h.html#a237">IoSetCompletionRoutine</a>( Irp,
00444                             UdfPnpCompletionRoutine,
00445                             &amp;Event,
00446                             TRUE,
00447                             TRUE,
00448                             TRUE );
00449 
00450     <span class="comment">//</span>
00451     <span class="comment">//  Send the request and wait.</span>
00452     <span class="comment">//</span>
00453 
00454     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>(Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o4">TargetDeviceObject</a>, Irp);
00455 
00456     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_PENDING) {
00457 
00458         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;Event,
00459                                Executive,
00460                                KernelMode,
00461                                FALSE,
00462                                NULL );
00463 
00464         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status;
00465     }
00466 
00467     <span class="comment">//</span>
00468     <span class="comment">//  Now make our dismount happen.  This may not vaporize the</span>
00469     <span class="comment">//  Vcb, of course, since there could be any number of handles</span>
00470     <span class="comment">//  outstanding if we were not preceeded by a QUERY.</span>
00471     <span class="comment">//</span>
00472     <span class="comment">//  PnP will take care of disconnecting this stack if we</span>
00473     <span class="comment">//  couldn't get off of it immediately.</span>
00474     <span class="comment">//</span>
00475 
00476     VcbPresent = <a class="code" href="../../d8/d5/udfs_2verfysup_8c.html#a3">UdfCheckForDismount</a>( IrpContext, Vcb, TRUE );
00477 
00478     <span class="comment">//</span>
00479     <span class="comment">//  Release the Vcb if it could still remain.</span>
00480     <span class="comment">//</span>
00481     
00482     <span class="keywordflow">if</span> (VcbPresent) {
00483 
00484         <a class="code" href="../../d3/d8/udfprocs_8h.html#a76">UdfReleaseVcb</a>( IrpContext, Vcb );
00485     }
00486 
00487     <a class="code" href="../../d3/d8/udfprocs_8h.html#a73">UdfReleaseUdfData</a>( IrpContext );
00488     
00489     <span class="comment">//</span>
00490     <span class="comment">//  Cleanup our IrpContext and complete the IRP.</span>
00491     <span class="comment">//</span>
00492 
00493     <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, Status );
00494 
00495     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00496 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="udfs/pnp.c::UdfPnpSurpriseRemove" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS UdfPnpSurpriseRemove           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vcb</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00500">500</a> of file <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html">udfs/pnp.c</a>.
<p>
References <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00086">Event()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02865">IoCallDriver</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l04009">IoCopyCurrentIrpStackLocationToNext</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03913">IoSetCompletionRoutine</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00541">_VCB::TargetDeviceObject</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01509">UdfAcquireUdfData</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01515">UdfAcquireVcbExclusive</a>, <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00236">UdfCheckForDismount()</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00809">UdfCompleteRequest()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01559">UdfLockVcb</a>, <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00710">UdfPnpCompletionRoutine()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01512">UdfReleaseUdfData</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01521">UdfReleaseVcb</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01563">UdfUnlockVcb</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00559">_VCB::VcbCondition</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a130a121">VcbDismountInProgress</a>, and <a class="el" href="../../d6/d8/udfstruc_8h.html#a130a120">VcbInvalid</a>.
<p>
Referenced by <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00075">UdfCommonPnp()</a>.
<p>
<pre class="fragment"><div>00508                    :
00509 
00510     This routine handles <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PnP surprise remove operation.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> another
00511     <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of notification that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> underlying storage device <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume we
00512     have <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> gone, and <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> excellent indication that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume will never reappear.
00513     The filesystem <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> responsible <span class="keywordflow">for</span> initiation or completion <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dismount.
00514     
00515     For <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> most part, <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> <span class="stringliteral">"real"</span> drivers care about <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> distinction of a
00516     surprise remove, which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a result of our noticing that a user (usually)
00517     physically reached into the machine and pulled something out.
00518     
00519     Surprise will be followed by a Remove when all references have been shut down.
00520 
00521 Arguments:
00522 
00523     Irp - Supplies the Irp to process
00524     
00525     Vcb - Supplies the volume being removed.
00526 
00527 Return Value:
00528 
00529     NTSTATUS - The return status for the operation
00530 
00531 --*/
00532 
00533 {
00534     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00535     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
00536     BOOLEAN VcbPresent = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00537     
00538     <span class="comment">//</span>
00539     <span class="comment">//  SURPRISE - a device was physically yanked away without</span>
00540     <span class="comment">//  any warning.  This means external forces.</span>
00541     <span class="comment">//</span>
00542     
00543     <a class="code" href="../../d3/d8/udfprocs_8h.html#a72">UdfAcquireUdfData</a>( IrpContext );
00544     <a class="code" href="../../d3/d8/udfprocs_8h.html#a74">UdfAcquireVcbExclusive</a>( IrpContext, Vcb, FALSE );
00545         
00546     <span class="comment">//</span>
00547     <span class="comment">//  Invalidate the volume right now.</span>
00548     <span class="comment">//</span>
00549     <span class="comment">//  The intent here is to make every subsequent operation</span>
00550     <span class="comment">//  on the volume fail and grease the rails toward dismount.</span>
00551     <span class="comment">//  By definition there is no going back from a SURPRISE.</span>
00552     <span class="comment">//</span>
00553         
00554     <a class="code" href="../../d3/d8/udfprocs_8h.html#a88">UdfLockVcb</a>( IrpContext, Vcb );
00555     
00556     <span class="keywordflow">if</span> (Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o8">VcbCondition</a> != <a class="code" href="../../d6/d8/udfstruc_8h.html#a130a121">VcbDismountInProgress</a>) {
00557         Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o8">VcbCondition</a> = <a class="code" href="../../d6/d8/udfstruc_8h.html#a130a120">VcbInvalid</a>;
00558     }
00559     
00560     <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, Vcb );
00561     
00562     <span class="comment">//</span>
00563     <span class="comment">//  We need to pass this down before starting the dismount, which</span>
00564     <span class="comment">//  could disconnect us immediately from the stack.</span>
00565     <span class="comment">//</span>
00566     
00567     <span class="comment">//</span>
00568     <span class="comment">//  Get the next stack location, and copy over the stack location</span>
00569     <span class="comment">//</span>
00570 
00571     <a class="code" href="../../d0/d5/io_8h.html#a239">IoCopyCurrentIrpStackLocationToNext</a>( Irp );
00572 
00573     <span class="comment">//</span>
00574     <span class="comment">//  Set up the completion routine</span>
00575     <span class="comment">//</span>
00576 
00577     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;Event, NotificationEvent, FALSE );
00578     <a class="code" href="../../d0/d5/io_8h.html#a237">IoSetCompletionRoutine</a>( Irp,
00579                             UdfPnpCompletionRoutine,
00580                             &amp;Event,
00581                             TRUE,
00582                             TRUE,
00583                             TRUE );
00584 
00585     <span class="comment">//</span>
00586     <span class="comment">//  Send the request and wait.</span>
00587     <span class="comment">//</span>
00588 
00589     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>(Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o4">TargetDeviceObject</a>, Irp);
00590 
00591     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_PENDING) {
00592 
00593         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;Event,
00594                                Executive,
00595                                KernelMode,
00596                                FALSE,
00597                                NULL );
00598 
00599         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status;
00600     }
00601     
00602     <span class="comment">//</span>
00603     <span class="comment">//  Now make our dismount happen.  This may not vaporize the</span>
00604     <span class="comment">//  Vcb, of course, since there could be any number of handles</span>
00605     <span class="comment">//  outstanding since this is an out of band notification.</span>
00606     <span class="comment">//</span>
00607 
00608     VcbPresent = <a class="code" href="../../d8/d5/udfs_2verfysup_8c.html#a3">UdfCheckForDismount</a>( IrpContext, Vcb, TRUE );
00609     
00610     <span class="comment">//</span>
00611     <span class="comment">//  Release the Vcb if it could still remain.</span>
00612     <span class="comment">//</span>
00613     
00614     <span class="keywordflow">if</span> (VcbPresent) {
00615 
00616         <a class="code" href="../../d3/d8/udfprocs_8h.html#a76">UdfReleaseVcb</a>( IrpContext, Vcb );
00617     }
00618 
00619     <a class="code" href="../../d3/d8/udfprocs_8h.html#a73">UdfReleaseUdfData</a>( IrpContext );
00620     
00621     <span class="comment">//</span>
00622     <span class="comment">//  Cleanup our IrpContext and complete the IRP.</span>
00623     <span class="comment">//</span>
00624 
00625     <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, Status );
00626 
00627     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00628 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:09 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
