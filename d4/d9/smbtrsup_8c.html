<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: smbtrsup.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>smbtrsup.c File Reference</h1><code>#include &lt;ntsrv.h&gt;</code><br>
<code>#include &lt;smbtrace.h&gt;</code><br>
<code>#include &lt;smbtrsup.h&gt;</code><br>

<p>
<a href="../../d5/d8/smbtrsup_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Classes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html">_SMBTRACE_QUEUE_ENTRY</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d3/struct__INSTANCE__DATA.html">_INSTANCE_DATA</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d2/struct__TRACE__DEREFERENCE__ITEM.html">_TRACE_DEREFERENCE_ITEM</a></td></tr>

<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d9/smbtrsup_8c.html#a0">_SMBTRSUP_SYS_</a>&nbsp;&nbsp;&nbsp;1</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>(x)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d9/smbtrsup_8c.html#a2">PAGED_CODE_CHECK</a>()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d9/smbtrsup_8c.html#a3">ACQUIRE_SPIN_LOCK</a>(a, b)&nbsp;&nbsp;&nbsp;KeAcquireSpinLock(a, b)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d9/smbtrsup_8c.html#a4">RELEASE_SPIN_LOCK</a>(a, b)&nbsp;&nbsp;&nbsp;KeReleaseSpinLock(a, b)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d9/smbtrsup_8c.html#a5">LOCK_INC_ID</a>(var)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d9/smbtrsup_8c.html#a6">LOCK_ZERO_ID</a>(var)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(field)&nbsp;&nbsp;&nbsp;(<a class="el" href="../../d4/d9/smbtrsup_8c.html#a22">SmbTraceData</a>[Component].field)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d9/smbtrsup_8c.html#a8">ACL_LENGTH</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d9/smbtrsup_8c.html#a9">NUMBER_OF_BLOCKING_OBJECTS</a>&nbsp;&nbsp;&nbsp;4</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d9/smbtrsup_8c.html#a10">INDEX_WAIT_TERMINATIONEVENT</a>&nbsp;&nbsp;&nbsp;0</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d9/smbtrsup_8c.html#a11">INDEX_WAIT_APPTERMINATIONEVENT</a>&nbsp;&nbsp;&nbsp;1</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d9/smbtrsup_8c.html#a12">INDEX_WAIT_NEEDMEMORYEVENT</a>&nbsp;&nbsp;&nbsp;2</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d9/smbtrsup_8c.html#a13">INDEX_WAIT_QUEUESEMAPHORE</a>&nbsp;&nbsp;&nbsp;3</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d9/smbtrsup_8c.html#a14">STATUS_WAIT_TERMINATIONEVENT</a>&nbsp;&nbsp;&nbsp;STATUS_WAIT_0</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d9/smbtrsup_8c.html#a15">STATUS_WAIT_APPTERMINATIONEVENT</a>&nbsp;&nbsp;&nbsp;STATUS_WAIT_1</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d9/smbtrsup_8c.html#a16">STATUS_WAIT_NEEDMEMORYEVENT</a>&nbsp;&nbsp;&nbsp;STATUS_WAIT_2</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d9/smbtrsup_8c.html#a17">STATUS_WAIT_QUEUESEMAPHORE</a>&nbsp;&nbsp;&nbsp;STATUS_WAIT_3</td></tr>

<tr><td colspan=2><br><h2>Typedefs</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>typedef enum <a class="el" href="../../d4/d9/smbtrsup_8c.html#a52">_SMBTRACE_STATE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d9/smbtrsup_8c.html#a18">SMBTRACE_STATE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html">_SMBTRACE_QUEUE_ENTRY</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d9/smbtrsup_8c.html#a19">SMBTRACE_QUEUE_ENTRY</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html">_SMBTRACE_QUEUE_ENTRY</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d9/smbtrsup_8c.html#a20">PSMBTRACE_QUEUE_ENTRY</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d4/d3/struct__INSTANCE__DATA.html">_INSTANCE_DATA</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d9/smbtrsup_8c.html#a21">INSTANCE_DATA</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d0/d2/struct__TRACE__DEREFERENCE__ITEM.html">_TRACE_DEREFERENCE_ITEM</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d9/smbtrsup_8c.html#a27">TRACE_DEREFERENCE_ITEM</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d0/d2/struct__TRACE__DEREFERENCE__ITEM.html">_TRACE_DEREFERENCE_ITEM</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d9/smbtrsup_8c.html#a28">PTRACE_DEREFERENCE_ITEM</a></td></tr>

<tr><td colspan=2><br><h2>Enumerations</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>enum &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d9/smbtrsup_8c.html#a52">_SMBTRACE_STATE</a> { <br>
&nbsp;&nbsp;<a class="el" href="../../d4/d9/smbtrsup_8c.html#a52a29">TraceStopped</a>, 
<a class="el" href="../../d4/d9/smbtrsup_8c.html#a52a30">TraceStarting</a>, 
<a class="el" href="../../d4/d9/smbtrsup_8c.html#a52a31">TraceStartStopFile</a>, 
<a class="el" href="../../d4/d9/smbtrsup_8c.html#a52a32">TraceStartStopNull</a>, 
<br>
&nbsp;&nbsp;<a class="el" href="../../d4/d9/smbtrsup_8c.html#a52a33">TraceAppWaiting</a>, 
<a class="el" href="../../d4/d9/smbtrsup_8c.html#a52a34">TraceRunning</a>, 
<a class="el" href="../../d4/d9/smbtrsup_8c.html#a52a35">TraceStopping</a>
<br>
 }</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d9/smbtrsup_8c.html#a36">SmbTraceReferenceHeap</a> (IN SMBTRACE_COMPONENT Component)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d9/smbtrsup_8c.html#a37">SmbTraceDereferenceHeap</a> (IN SMBTRACE_COMPONENT Component)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d9/smbtrsup_8c.html#a38">SmbTraceDisconnect</a> (IN SMBTRACE_COMPONENT Component)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d9/smbtrsup_8c.html#a39">SmbTraceEmptyQueue</a> (IN SMBTRACE_COMPONENT Component)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d9/smbtrsup_8c.html#a40">SmbTraceThreadEntry</a> (IN PVOID Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d9/smbtrsup_8c.html#a41">SmbTraceFreeMemory</a> (IN SMBTRACE_COMPONENT Component)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d9/smbtrsup_8c.html#a42">SmbTraceToClient</a> (IN PVOID Smb, IN CLONG SmbLength, IN PVOID SmbAddress, IN SMBTRACE_COMPONENT Component)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d9/smbtrsup_8c.html#a43">SmbTraceMdlLength</a> (IN <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a> Mdl)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d9/smbtrsup_8c.html#a44">SmbTraceCopyMdlContiguous</a> (OUT PVOID Destination, IN <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a> Mdl, IN ULONG Length)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d9/smbtrsup_8c.html#a45">SmbTraceDeferredDereferenceHeap</a> (IN PVOID Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d9/smbtrsup_8c.html#a46">SmbTraceInitialize</a> (IN SMBTRACE_COMPONENT Component)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d9/smbtrsup_8c.html#a47">SmbTraceTerminate</a> (IN SMBTRACE_COMPONENT Component)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d9/smbtrsup_8c.html#a48">SmbTraceStart</a> (IN ULONG InputBufferLength, IN ULONG OutputBufferLength, IN OUT PVOID ConfigInOut, IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN SMBTRACE_COMPONENT Component)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d9/smbtrsup_8c.html#a49">SmbTraceStop</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject OPTIONAL, IN SMBTRACE_COMPONENT Component)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d9/smbtrsup_8c.html#a50">SmbTraceCompleteSrv</a> (IN <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a> SmbMdl, IN PVOID Smb, IN CLONG SmbLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d9/smbtrsup_8c.html#a51">SmbTraceCompleteRdr</a> (IN <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a> SmbMdl, IN PVOID Smb, IN CLONG SmbLength)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d4/d3/struct__INSTANCE__DATA.html">INSTANCE_DATA</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d9/smbtrsup_8c.html#a22">SmbTraceData</a> []</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d9/smbtrsup_8c.html#a23">SmbTraceActive</a> [] = {FALSE, FALSE}</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d9/smbtrsup_8c.html#a24">SmbTraceTransitioning</a> [] = {FALSE, FALSE}</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>HANDLE&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d9/smbtrsup_8c.html#a25">SmbTraceDiscardableCodeHandle</a> = 0</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>HANDLE&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d9/smbtrsup_8c.html#a26">SmbTraceDiscardableDataHandle</a> = 0</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="smbtrsup.c::_SMBTRSUP_SYS_" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define _SMBTRSUP_SYS_&nbsp;&nbsp;&nbsp;1          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00035">35</a> of file <a class="el" href="../../d5/d8/smbtrsup_8c-source.html">smbtrsup.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="smbtrsup.c::ACL_LENGTH" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ACL_LENGTH          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(ULONG)<span class="keyword">sizeof</span>(ACL) +                 \
                    (ULONG)<span class="keyword">sizeof</span>(ACCESS_ALLOWED_ACE) +  \
                    <span class="keyword">sizeof</span>(LUID) +                       \
                    8
</div></pre>
<p>
Referenced by <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00551">SmbTraceStart()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="smbtrsup.c::ACQUIRE_SPIN_LOCK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ACQUIRE_SPIN_LOCK          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">a,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>b&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;KeAcquireSpinLock(a, b)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00084">84</a> of file <a class="el" href="../../d5/d8/smbtrsup_8c-source.html">smbtrsup.c</a>.
<p>
Referenced by <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01794">SmbTraceDereferenceHeap()</a>, and <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01709">SmbTraceReferenceHeap()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="smbtrsup.c::ID" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ID          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">field&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;(<a class="el" href="../../d4/d9/smbtrsup_8c.html#a22">SmbTraceData</a>[Component].field)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00151">151</a> of file <a class="el" href="../../d5/d8/smbtrsup_8c-source.html">smbtrsup.c</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/netboot_8c-source.html#l04017">IopSetDefaultGateway()</a>, <a class="el" href="../../d5/d5/netboot_8c-source.html#l04377">IopTCPQueryInformationEx()</a>, <a class="el" href="../../d5/d5/netboot_8c-source.html#l04458">IopTCPSetInformationEx()</a>, <a class="el" href="../../d5/d8/clres_8c-source.html#l02292">LoadBitmapA()</a>, <a class="el" href="../../d5/d8/clres_8c-source.html#l02329">LoadCursorA()</a>, <a class="el" href="../../d5/d8/clres_8c-source.html#l02373">LoadIconA()</a>, <a class="el" href="../../d5/d8/clres_8c-source.html#l02414">LoadImageA()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01456">SmbTraceCompleteRdr()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01242">SmbTraceCompleteSrv()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01794">SmbTraceDereferenceHeap()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01879">SmbTraceDisconnect()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01949">SmbTraceEmptyQueue()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l02355">SmbTraceFreeMemory()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00438">SmbTraceInitialize()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01709">SmbTraceReferenceHeap()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00551">SmbTraceStart()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01050">SmbTraceStop()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00509">SmbTraceTerminate()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l02020">SmbTraceThreadEntry()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l02425">SmbTraceToClient()</a>, <a class="el" href="../../d5/d8/clres_8c-source.html#l04127">WOWFindResourceExWCover()</a>, <a class="el" href="../../d5/d8/clres_8c-source.html#l04158">WOWLoadBitmapA()</a>, and <a class="el" href="../../d9/d3/sbctl_8c-source.html#l01913">xxxContScroll()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="smbtrsup.c::INDEX_WAIT_APPTERMINATIONEVENT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define INDEX_WAIT_APPTERMINATIONEVENT&nbsp;&nbsp;&nbsp;1          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l02020">SmbTraceThreadEntry()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="smbtrsup.c::INDEX_WAIT_NEEDMEMORYEVENT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define INDEX_WAIT_NEEDMEMORYEVENT&nbsp;&nbsp;&nbsp;2          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l02020">SmbTraceThreadEntry()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="smbtrsup.c::INDEX_WAIT_QUEUESEMAPHORE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define INDEX_WAIT_QUEUESEMAPHORE&nbsp;&nbsp;&nbsp;3          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l02020">SmbTraceThreadEntry()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="smbtrsup.c::INDEX_WAIT_TERMINATIONEVENT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define INDEX_WAIT_TERMINATIONEVENT&nbsp;&nbsp;&nbsp;0          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l02020">SmbTraceThreadEntry()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="smbtrsup.c::LOCK_INC_ID" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LOCK_INC_ID          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">var&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div><a class="code" href="../../d5/d8/ex_8h.html#a235">ExInterlockedAddUlong</a>( (PULONG)&amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(var),                \
                            1, &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(var##Interlock) )
</div></pre>
<p>
Definition at line <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00091">91</a> of file <a class="el" href="../../d5/d8/smbtrsup_8c-source.html">smbtrsup.c</a>.
<p>
Referenced by <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01456">SmbTraceCompleteRdr()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01242">SmbTraceCompleteSrv()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l02020">SmbTraceThreadEntry()</a>, and <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l02425">SmbTraceToClient()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="smbtrsup.c::LOCK_ZERO_ID" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LOCK_ZERO_ID          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">var&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                                  \
     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(var) = 0;                                            \
     }
</div></pre>
<p>
Definition at line <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00098">98</a> of file <a class="el" href="../../d5/d8/smbtrsup_8c-source.html">smbtrsup.c</a>.
<p>
Referenced by <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l02425">SmbTraceToClient()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="smbtrsup.c::NUMBER_OF_BLOCKING_OBJECTS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define NUMBER_OF_BLOCKING_OBJECTS&nbsp;&nbsp;&nbsp;4          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l02020">SmbTraceThreadEntry()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="smbtrsup.c::PAGED_CODE_CHECK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PAGED_CODE_CHECK          </td>
          <td class="md" valign="top">(&nbsp;</td>
&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00069">69</a> of file <a class="el" href="../../d5/d8/smbtrsup_8c-source.html">smbtrsup.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="smbtrsup.c::RELEASE_SPIN_LOCK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define RELEASE_SPIN_LOCK          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">a,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>b&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;KeReleaseSpinLock(a, b)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00085">85</a> of file <a class="el" href="../../d5/d8/smbtrsup_8c-source.html">smbtrsup.c</a>.
<p>
Referenced by <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01794">SmbTraceDereferenceHeap()</a>, and <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01709">SmbTraceReferenceHeap()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="smbtrsup.c::STATUS_WAIT_APPTERMINATIONEVENT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define STATUS_WAIT_APPTERMINATIONEVENT&nbsp;&nbsp;&nbsp;STATUS_WAIT_1          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l02020">SmbTraceThreadEntry()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="smbtrsup.c::STATUS_WAIT_NEEDMEMORYEVENT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define STATUS_WAIT_NEEDMEMORYEVENT&nbsp;&nbsp;&nbsp;STATUS_WAIT_2          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l02020">SmbTraceThreadEntry()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="smbtrsup.c::STATUS_WAIT_QUEUESEMAPHORE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define STATUS_WAIT_QUEUESEMAPHORE&nbsp;&nbsp;&nbsp;STATUS_WAIT_3          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l02020">SmbTraceThreadEntry()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="smbtrsup.c::STATUS_WAIT_TERMINATIONEVENT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define STATUS_WAIT_TERMINATIONEVENT&nbsp;&nbsp;&nbsp;STATUS_WAIT_0          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l02020">SmbTraceThreadEntry()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="smbtrsup.c::TrPrint" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define TrPrint          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">x&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00042">42</a> of file <a class="el" href="../../d5/d8/smbtrsup_8c-source.html">smbtrsup.c</a>.
<p>
Referenced by <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01456">SmbTraceCompleteRdr()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01242">SmbTraceCompleteSrv()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01794">SmbTraceDereferenceHeap()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01879">SmbTraceDisconnect()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l02355">SmbTraceFreeMemory()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01709">SmbTraceReferenceHeap()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00551">SmbTraceStart()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01050">SmbTraceStop()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l02020">SmbTraceThreadEntry()</a>, and <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l02425">SmbTraceToClient()</a>.    </td>
  </tr>
</table>
<hr><h2>Typedef Documentation</h2>
<a class="anchor" name="a21" doxytag="smbtrsup.c::INSTANCE_DATA" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d4/d3/struct__INSTANCE__DATA.html">_INSTANCE_DATA</a>  <a class="el" href="../../d4/d3/struct__INSTANCE__DATA.html">INSTANCE_DATA</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="smbtrsup.c::PSMBTRACE_QUEUE_ENTRY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html">_SMBTRACE_QUEUE_ENTRY</a> * <a class="el" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html">PSMBTRACE_QUEUE_ENTRY</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01456">SmbTraceCompleteRdr()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01242">SmbTraceCompleteSrv()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01949">SmbTraceEmptyQueue()</a>, and <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l02020">SmbTraceThreadEntry()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a28" doxytag="smbtrsup.c::PTRACE_DEREFERENCE_ITEM" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d0/d2/struct__TRACE__DEREFERENCE__ITEM.html">_TRACE_DEREFERENCE_ITEM</a> * <a class="el" href="../../d0/d2/struct__TRACE__DEREFERENCE__ITEM.html">PTRACE_DEREFERENCE_ITEM</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01760">SmbTraceDeferredDereferenceHeap()</a>, and <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01794">SmbTraceDereferenceHeap()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="smbtrsup.c::SMBTRACE_QUEUE_ENTRY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html">_SMBTRACE_QUEUE_ENTRY</a>  <a class="el" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html">SMBTRACE_QUEUE_ENTRY</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="smbtrsup.c::SMBTRACE_STATE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef enum <a class="el" href="../../d4/d9/smbtrsup_8c.html#a52">_SMBTRACE_STATE</a>  <a class="el" href="../../d4/d9/smbtrsup_8c.html#a18">SMBTRACE_STATE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a27" doxytag="smbtrsup.c::TRACE_DEREFERENCE_ITEM" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d0/d2/struct__TRACE__DEREFERENCE__ITEM.html">_TRACE_DEREFERENCE_ITEM</a>  <a class="el" href="../../d0/d2/struct__TRACE__DEREFERENCE__ITEM.html">TRACE_DEREFERENCE_ITEM</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<hr><h2>Enumeration Type Documentation</h2>
<a class="anchor" name="a52" doxytag="smbtrsup.c::_SMBTRACE_STATE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> enum <a class="el" href="../../d4/d9/smbtrsup_8c.html#a52">_SMBTRACE_STATE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<dl compact><dt><b>Enumeration values: </b></dt><dd>
<table border=0 cellspacing=2 cellpadding=0>
<tr><td valign=top><em><a class="anchor" name="a52a29" doxytag="TraceStopped" ></a>TraceStopped</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a52a30" doxytag="TraceStarting" ></a>TraceStarting</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a52a31" doxytag="TraceStartStopFile" ></a>TraceStartStopFile</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a52a32" doxytag="TraceStartStopNull" ></a>TraceStartStopNull</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a52a33" doxytag="TraceAppWaiting" ></a>TraceAppWaiting</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a52a34" doxytag="TraceRunning" ></a>TraceRunning</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a52a35" doxytag="TraceStopping" ></a>TraceStopping</em>&nbsp;</td><td>
</td></tr>
</table>
</dl>

<p>
Definition at line <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00109">109</a> of file <a class="el" href="../../d5/d8/smbtrsup_8c-source.html">smbtrsup.c</a>.
<p>
<pre class="fragment"><div>00109                              {
00110     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a52a29">TraceStopped</a>,          <span class="comment">// not running</span>
00111     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a52a30">TraceStarting</a>,         <span class="comment">// preparing to run</span>
00112     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a52a31">TraceStartStopFile</a>,    <span class="comment">// starting, but want to shut down immediately</span>
00113                            <span class="comment">// because the FileObject closed</span>
00114     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a52a32">TraceStartStopNull</a>,    <span class="comment">// starting, but want to shut down immediately</span>
00115                            <span class="comment">// because a new fsctl came in</span>
00116     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a52a33">TraceAppWaiting</a>,       <span class="comment">// waiting for application to die</span>
00117     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a52a34">TraceRunning</a>,          <span class="comment">// processing SMBs</span>
00118     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a52a35">TraceStopping</a>          <span class="comment">// waiting for smbtrace thread to stop</span>
00119 } <a class="code" href="../../d4/d9/smbtrsup_8c.html#a18">SMBTRACE_STATE</a>;
</div></pre>    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a51" doxytag="smbtrsup.c::SmbTraceCompleteRdr" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SmbTraceCompleteRdr           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SmbMdl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Smb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN CLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SmbLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01456">1456</a> of file <a class="el" href="../../d5/d8/smbtrsup_8c-source.html">smbtrsup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00129">_SMBTRACE_QUEUE_ENTRY::Buffer</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00133">_SMBTRACE_QUEUE_ENTRY::BufferNonPaged</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00087">DISPATCH_LEVEL</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a238">ExInterlockedInsertTailList()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00151">ID</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00166">KeAttachProcess()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00405">KeDetachProcess()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d2/d5/semphobj_8c-source.html#l00118">KeReleaseSemaphore()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00127">_SMBTRACE_QUEUE_ENTRY::ListEntry</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00091">LOCK_INC_ID</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d4/d9/smbtrsup_8c.html#a20">PSMBTRACE_QUEUE_ENTRY</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00022">RtlAllocateHeap</a>, <a class="el" href="../../d8/d7/exboosts_8h-source.html#l00155">SEMAPHORE_INCREMENT</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00131">_SMBTRACE_QUEUE_ENTRY::SmbAddress</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00128">_SMBTRACE_QUEUE_ENTRY::SmbLength</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00333">SmbTraceActive</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l02636">SmbTraceCopyMdlContiguous()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01794">SmbTraceDereferenceHeap()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l02603">SmbTraceMdlLength()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01709">SmbTraceReferenceHeap()</a>, <a class="el" href="../../d4/d9/smbtrsup_8c.html#a52a34">TraceRunning</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00042">TrPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d9/ke_8h.html#a407a204">UserRequest</a>, and <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00136">_SMBTRACE_QUEUE_ENTRY::WaitEvent</a>.
<p>
<pre class="fragment"><div>01464                    :
01465 
01466     Redirector version
01467 
01468     Snapshot an SMB and export <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SmbTrace application.  How
01469     <span class="keyword">this</span> happens <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> determined by which mode (fast or slow) SmbTracing
01470     was requested in, and which context (DPC, Fsp or Fsd) <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current
01471     thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> executing in.
01472 
01473     Fast mode: <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SMB <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> copied into shared memory and an entry <span class="keywordflow">for</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>
01474     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> queued to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> redirector SmbTrace thread, which asynchronously
01475     passes SMBs to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> app.  (When in DPC, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SMB <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> copied to non-paged
01476     <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> instead of shared memory, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SmbTrace thread deals with
01477     moving <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> to shared memory later.)  If there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> insufficient memory
01478     <span class="keywordflow">for</span> anything (SMB, queue entry, etc.) the SMB is lost.
01479 
01480     Slow mode: identical to Fast mode except that <span class="keyword">this</span> thread waits
01481     until the server SmbTrace thread signals that the app has finished
01482     processing the SMB.  Because each thread waits until its SMB has
01483     been completely processed, there is much less chance of running
01484     out of any resources. If at DPC level, we behave exactly as in the
01485     fast mode <span class="keywordflow">case</span>, because it would be a Bad Thing to block <span class="keyword">this</span> thread
01486     at DPC level.
01487 
01488     The SMB is either contained in SmbMdl, or at address Smb with length
01489     SmbLength.
01490 
01491 Arguments:
01492 
01493     SmbMdl - an Mdl containing the SMB.
01494 
01495     Smb - a pointer to the SMB.
01496 
01497     SmbLength - the length of the SMB.
01498 
01499 Return Value:
01500 
01501     None
01502 
01503 --*/
01504 
01505 {
01506     <a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html">PSMBTRACE_QUEUE_ENTRY</a>  queueEntry;
01507     PVOID  buffer;
01508     BOOLEAN ProcessAttached = FALSE;
01509     BOOLEAN AtDpcLevel;
01510     SMBTRACE_COMPONENT Component = SMBTRACE_REDIRECTOR;
01511     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> WaitEvent;
01512 
01513     <span class="comment">//</span>
01514     <span class="comment">// This routine is redirector specific.</span>
01515     <span class="comment">//</span>
01516 
01517     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TraceState) == TraceRunning );
01518     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( SmbTraceActive[SMBTRACE_REDIRECTOR] );
01519 
01520     <span class="comment">//</span>
01521     <span class="comment">// We want either an Mdl, or a pointer and a length, or occasionally,</span>
01522     <span class="comment">// a completely NULL response</span>
01523     <span class="comment">//</span>
01524 
01525     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( ( SmbMdl == NULL  &amp;&amp;  Smb != NULL  &amp;&amp;  SmbLength != 0 )
01526          || ( SmbMdl != NULL  &amp;&amp;  Smb == NULL  &amp;&amp;  SmbLength == 0 )
01527          || ( SmbMdl == NULL  &amp;&amp;  Smb == NULL  &amp;&amp;  SmbLength == 0 ) );
01528 
01529     <span class="comment">//</span>
01530     <span class="comment">// Ensure that SmbTrace really is still active and hence, the</span>
01531     <span class="comment">// shared memory is still around.</span>
01532     <span class="comment">//</span>
01533 
01534     <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a36">SmbTraceReferenceHeap</a>( Component ) == FALSE ) {
01535         <span class="keywordflow">return</span>;
01536     }
01537 
01538     <span class="comment">//</span>
01539     <span class="comment">// To avoid multiple system calls, we find out once and for all.</span>
01540     <span class="comment">//</span>
01541 
01542     AtDpcLevel = (BOOLEAN)(KeGetCurrentIrql() &gt;= DISPATCH_LEVEL);
01543 
01544     <span class="comment">//</span>
01545     <span class="comment">// If the SMB is currently in an MDL, we don't yet have the length,</span>
01546     <span class="comment">// which we need to know how much memory to allocate.</span>
01547     <span class="comment">//</span>
01548 
01549     <span class="keywordflow">if</span> ( SmbMdl != NULL ) {
01550         SmbLength = <a class="code" href="../../d4/d9/smbtrsup_8c.html#a43">SmbTraceMdlLength</a>(SmbMdl);
01551     }
01552 
01553     <span class="comment">//</span>
01554     <span class="comment">// If we are in slow mode, then we wait after queuing the SMB</span>
01555     <span class="comment">// to the SmbTrace thread.  If we are set for fast mode we</span>
01556     <span class="comment">// garbage collect in case of no memory.  If we're at DPC level,</span>
01557     <span class="comment">// we store the SMB in non-paged pool.</span>
01558     <span class="comment">//</span>
01559 
01560     <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(SingleSmbMode) ) {
01561         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;WaitEvent, NotificationEvent, FALSE );
01562     }
01563 
01564     <span class="comment">//</span>
01565     <span class="comment">// allocate queue entry</span>
01566     <span class="comment">//</span>
01567 
01568     queueEntry = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
01569                      NonPagedPool,
01570                      <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html">SMBTRACE_QUEUE_ENTRY</a>),
01571                      'tbmS'
01572                      );
01573 
01574     <span class="keywordflow">if</span> ( queueEntry == NULL ) {
01575         <span class="comment">// No free memory, this SMB is lost.  Record its loss.</span>
01576         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a5">LOCK_INC_ID</a>(SmbsLost);
01577         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a37">SmbTraceDereferenceHeap</a>( Component );
01578         <span class="keywordflow">return</span>;
01579     }
01580 
01581     <span class="comment">//</span>
01582     <span class="comment">// allocate buffer for SMB, in non-paged pool or shared heap as</span>
01583     <span class="comment">// appropriate</span>
01584     <span class="comment">//</span>
01585 
01586     <span class="keywordflow">if</span> ( AtDpcLevel ) {
01587 
01588         buffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( NonPagedPool, SmbLength, 'tbmS' );
01589         queueEntry-&gt;BufferNonPaged = TRUE;
01590 
01591     } <span class="keywordflow">else</span> {
01592 
01593         <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() != <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(FspProcess) ) {
01594             <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a>(<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(FspProcess));
01595             ProcessAttached = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01596         }
01597 
01598         buffer = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(PortMemoryHeap), 0, SmbLength );
01599         queueEntry-&gt;BufferNonPaged = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01600 
01601     }
01602 
01603     <span class="keywordflow">if</span> ( buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01604 
01605         <span class="keywordflow">if</span> ( ProcessAttached ) {
01606             <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
01607         }
01608 
01609         <span class="comment">// No free memory, this SMB is lost.  Record its loss.</span>
01610         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a5">LOCK_INC_ID</a>(SmbsLost);
01611 
01612         <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(SingleSmbMode)) {
01613 
01614             <span class="comment">//</span>
01615             <span class="comment">// If it was shared memory we ran out of, encourage</span>
01616             <span class="comment">// some garbage collection.</span>
01617             <span class="comment">//</span>
01618             <span class="keywordflow">if</span> ( !queueEntry-&gt;BufferNonPaged ) {
01619                 <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(NeedMemoryEvent), 0, FALSE );
01620             }
01621         }
01622 
01623         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( queueEntry );
01624         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a37">SmbTraceDereferenceHeap</a>( Component );
01625         <span class="keywordflow">return</span>;
01626     }
01627 
01628     <span class="comment">//</span>
01629     <span class="comment">// Copy the SMB to shared or non-paged memory pointed to by the</span>
01630     <span class="comment">// queue entry, keeping in mind whether it's in an Mdl or contiguous</span>
01631     <span class="comment">// to begin with, and also preserving the address of the real SMB...</span>
01632     <span class="comment">//</span>
01633 
01634     <span class="keywordflow">if</span> ( SmbMdl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01635         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a44">SmbTraceCopyMdlContiguous</a>( buffer, SmbMdl, SmbLength );
01636         queueEntry-&gt;SmbAddress = SmbMdl;
01637     } <span class="keywordflow">else</span> {
01638         RtlCopyMemory( buffer, Smb, SmbLength );
01639         queueEntry-&gt;SmbAddress = Smb;
01640     }
01641 
01642     <span class="keywordflow">if</span> ( ProcessAttached ) {
01643         <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
01644     }
01645 
01646     queueEntry-&gt;SmbLength = SmbLength;
01647     queueEntry-&gt;Buffer = buffer;
01648 
01649     <span class="comment">//</span>
01650     <span class="comment">// In slow mode, we want to wait until the SMB has been eaten,</span>
01651     <span class="comment">// in fast mode, we don't want to pass the address of the real</span>
01652     <span class="comment">// SMB along, since the SMB is long gone by the time it gets</span>
01653     <span class="comment">// decoded and printed.</span>
01654     <span class="comment">//</span>
01655 
01656     <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(SingleSmbMode) &amp;&amp; !AtDpcLevel ) {
01657         queueEntry-&gt;WaitEvent = &amp;WaitEvent;
01658     } <span class="keywordflow">else</span> {
01659         queueEntry-&gt;WaitEvent = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01660         queueEntry-&gt;SmbAddress = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01661     }
01662 
01663     <span class="comment">//</span>
01664     <span class="comment">// ...queue the entry to the SmbTrace thread...</span>
01665     <span class="comment">//</span>
01666 
01667     <a class="code" href="../../d5/d8/ex_8h.html#a238">ExInterlockedInsertTailList</a>(
01668             &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(Queue),
01669             &amp;queueEntry-&gt;ListEntry,
01670             &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(QueueInterlock)
01671             );
01672 
01673     <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>(
01674             &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(QueueSemaphore),
01675             SEMAPHORE_INCREMENT,
01676             1,
01677             FALSE
01678             );
01679 
01680     <span class="comment">//</span>
01681     <span class="comment">// ...and wait for the SMB to be eaten, in slow mode.</span>
01682     <span class="comment">//</span>
01683 
01684     <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(SingleSmbMode) &amp;&amp; !AtDpcLevel ) {
01685         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>(( <span class="stringliteral">"%s!SmbTraceCompleteRdr: Slow mode wait\n"</span>, <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName) ));
01686         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(
01687             &amp;WaitEvent,
01688             UserRequest,
01689             KernelMode,
01690             FALSE,
01691             NULL
01692             );
01693         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>(( <span class="stringliteral">"%s!SmbTraceCompleteRdr: Slow mode wait done\n"</span>, <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName) ));
01694     }
01695 
01696     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a37">SmbTraceDereferenceHeap</a>( Component );
01697 
01698     <span class="keywordflow">return</span>;
01699 
01700 } <span class="comment">// SmbTraceCompleteRdr</span>

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a50" doxytag="smbtrsup.c::SmbTraceCompleteSrv" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SmbTraceCompleteSrv           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SmbMdl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Smb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN CLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SmbLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01242">1242</a> of file <a class="el" href="../../d5/d8/smbtrsup_8c-source.html">smbtrsup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00129">_SMBTRACE_QUEUE_ENTRY::Buffer</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00133">_SMBTRACE_QUEUE_ENTRY::BufferNonPaged</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00087">DISPATCH_LEVEL</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a238">ExInterlockedInsertTailList()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00151">ID</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d2/d5/semphobj_8c-source.html#l00118">KeReleaseSemaphore()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00127">_SMBTRACE_QUEUE_ENTRY::ListEntry</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00091">LOCK_INC_ID</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d4/d9/smbtrsup_8c.html#a20">PSMBTRACE_QUEUE_ENTRY</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00022">RtlAllocateHeap</a>, <a class="el" href="../../d8/d7/exboosts_8h-source.html#l00155">SEMAPHORE_INCREMENT</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00131">_SMBTRACE_QUEUE_ENTRY::SmbAddress</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00128">_SMBTRACE_QUEUE_ENTRY::SmbLength</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00333">SmbTraceActive</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l02636">SmbTraceCopyMdlContiguous()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01794">SmbTraceDereferenceHeap()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l02603">SmbTraceMdlLength()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01709">SmbTraceReferenceHeap()</a>, <a class="el" href="../../d4/d9/smbtrsup_8c.html#a52a34">TraceRunning</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00042">TrPrint</a>, <a class="el" href="../../d4/d9/ke_8h.html#a407a204">UserRequest</a>, and <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00136">_SMBTRACE_QUEUE_ENTRY::WaitEvent</a>.
<p>
<pre class="fragment"><div>01250                    :
01251 
01252     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a> version.
01253 
01254     Snapshot an SMB and export <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SmbTrace application.  How
01255     <span class="keyword">this</span> happens <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> determined by which mode (fast or slow) SmbTracing
01256     was requested in.  In <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> server, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> easy to guarantee that when
01257     tracing, a thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> always executing in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Fsp.
01258 
01259     Fast mode: <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SMB <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> copied into shared memory and an entry <span class="keywordflow">for</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>
01260     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> queued to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> server SmbTrace thread, which asynchronously
01261     passes SMBs to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> app.  If there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> insufficient memory
01262     <span class="keywordflow">for</span> anything (SMB, queue entry, etc.) the SMB is lost.
01263 
01264     Slow mode: identical to Fast mode except that <span class="keyword">this</span> thread waits
01265     until the server SmbTrace thread signals that the app has finished
01266     processing the SMB.  Because each thread waits until its SMB has
01267     been completely processed, there is much less chance of running
01268     out of any resources.
01269 
01270     The SMB is either contained in SmbMdl, or at address Smb with length
01271     SmbLength.
01272 
01273 Arguments:
01274 
01275     SmbMdl - an Mdl containing the SMB.
01276 
01277     Smb - a pointer to the SMB.
01278 
01279     SmbLength - the length of the SMB.
01280 
01281 Return Value:
01282 
01283     None
01284 
01285 --*/
01286 
01287 {
01288     <a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html">PSMBTRACE_QUEUE_ENTRY</a>  queueEntry;
01289     PVOID  buffer;
01290     SMBTRACE_COMPONENT Component = SMBTRACE_SERVER;
01291     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> WaitEvent;
01292 
01293     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01294 
01295     <span class="comment">//</span>
01296     <span class="comment">// This routine is server specific.</span>
01297     <span class="comment">//</span>
01298 
01299     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TraceState) == TraceRunning );
01300     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( SmbTraceActive[SMBTRACE_SERVER] );
01301 
01302     <span class="comment">//</span>
01303     <span class="comment">// We want either an Mdl, or a pointer and a length, or occasionally,</span>
01304     <span class="comment">// a completely NULL response.</span>
01305     <span class="comment">//</span>
01306 
01307     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( ( SmbMdl == NULL  &amp;&amp;  Smb != NULL  &amp;&amp;  SmbLength != 0 )
01308          || ( SmbMdl != NULL  &amp;&amp;  Smb == NULL  &amp;&amp;  SmbLength == 0 )
01309          || ( SmbMdl == NULL  &amp;&amp;  Smb == NULL  &amp;&amp;  SmbLength == 0 ) );
01310 
01311     <span class="comment">//</span>
01312     <span class="comment">// We've taken pains not to be at DPC level and to be in</span>
01313     <span class="comment">// the Fsp context too, for that matter.</span>
01314     <span class="comment">//</span>
01315 
01316     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( KeGetCurrentIrql() &lt; DISPATCH_LEVEL);
01317     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() == <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(FspProcess) );
01318 
01319     <span class="comment">//</span>
01320     <span class="comment">// Ensure that SmbTrace really is still active and hence, the</span>
01321     <span class="comment">// shared memory is still around.</span>
01322     <span class="comment">//</span>
01323 
01324     <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a36">SmbTraceReferenceHeap</a>( Component ) == FALSE ) {
01325         <span class="keywordflow">return</span>;
01326     }
01327 
01328     <span class="comment">//</span>
01329     <span class="comment">// If the SMB is currently in an MDL, we don't yet have the length,</span>
01330     <span class="comment">// which we need, to know how much memory to allocate.</span>
01331     <span class="comment">//</span>
01332 
01333     <span class="keywordflow">if</span> ( SmbMdl != NULL ) {
01334         SmbLength = <a class="code" href="../../d4/d9/smbtrsup_8c.html#a43">SmbTraceMdlLength</a>(SmbMdl);
01335     }
01336 
01337     <span class="comment">//</span>
01338     <span class="comment">// If we are in slow mode, then we wait after queuing the SMB</span>
01339     <span class="comment">// to the SmbTrace thread.  If we are set for fast mode we</span>
01340     <span class="comment">// garbage collect in case of no memory.</span>
01341     <span class="comment">//</span>
01342 
01343     <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(SingleSmbMode) ) {
01344         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;WaitEvent, NotificationEvent, FALSE );
01345     }
01346 
01347     queueEntry = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( NonPagedPool,
01348                                         <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html">SMBTRACE_QUEUE_ENTRY</a>),
01349                                         'tbmS'
01350                                         );
01351 
01352     <span class="keywordflow">if</span> ( queueEntry == NULL ) {
01353         <span class="comment">// No free memory, this SMB is lost.  Record its loss.</span>
01354         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a5">LOCK_INC_ID</a>(SmbsLost);
01355         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a37">SmbTraceDereferenceHeap</a>( Component );
01356         <span class="keywordflow">return</span>;
01357     }
01358 
01359     <span class="comment">//</span>
01360     <span class="comment">// Allocate the required amount of memory in our heap</span>
01361     <span class="comment">// in the shared memory.</span>
01362     <span class="comment">//</span>
01363 
01364     buffer = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(PortMemoryHeap), 0, SmbLength );
01365 
01366     <span class="keywordflow">if</span> ( buffer == NULL ) {
01367         <span class="comment">// No free memory, this SMB is lost.  Record its loss.</span>
01368         <span class="comment">// Very unlikely in slow mode.</span>
01369         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a5">LOCK_INC_ID</a>(SmbsLost);
01370         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( queueEntry );
01371 
01372         <span class="keywordflow">if</span> ( !<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(SingleSmbMode) ) {
01373             <span class="comment">//</span>
01374             <span class="comment">// Encourage some garbage collection.</span>
01375             <span class="comment">//</span>
01376             <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(NeedMemoryEvent), 0, FALSE );
01377         }
01378 
01379         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a37">SmbTraceDereferenceHeap</a>( Component );
01380         <span class="keywordflow">return</span>;
01381     }
01382 
01383     <span class="comment">//</span>
01384     <span class="comment">// Copy the SMB to shared memory pointed to by the queue entry,</span>
01385     <span class="comment">// keeping in mind whether it's in an Mdl or contiguous to begin</span>
01386     <span class="comment">// with, and also preserving the address of the real SMB...</span>
01387     <span class="comment">//</span>
01388 
01389     <span class="keywordflow">if</span> ( SmbMdl != NULL ) {
01390         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a44">SmbTraceCopyMdlContiguous</a>( buffer, SmbMdl, SmbLength );
01391         queueEntry-&gt;SmbAddress = SmbMdl;
01392     } <span class="keywordflow">else</span> {
01393         RtlCopyMemory( buffer, Smb, SmbLength );
01394         queueEntry-&gt;SmbAddress = Smb;
01395     }
01396 
01397     queueEntry-&gt;SmbLength = SmbLength;
01398     queueEntry-&gt;Buffer = buffer;
01399     queueEntry-&gt;BufferNonPaged = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01400 
01401     <span class="comment">//</span>
01402     <span class="comment">// In slow mode, we want to wait until the SMB has been eaten,</span>
01403     <span class="comment">// in fast mode, we don't want to pass the address of the real</span>
01404     <span class="comment">// SMB along, since the SMB is long gone by the time it gets</span>
01405     <span class="comment">// decoded and printed.</span>
01406     <span class="comment">//</span>
01407 
01408     <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(SingleSmbMode) ) {
01409         queueEntry-&gt;WaitEvent = &amp;WaitEvent;
01410     } <span class="keywordflow">else</span> {
01411         queueEntry-&gt;WaitEvent = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01412         queueEntry-&gt;SmbAddress = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01413     }
01414 
01415     <span class="comment">//</span>
01416     <span class="comment">// ...queue the entry to the SmbTrace thread...</span>
01417     <span class="comment">//</span>
01418 
01419     <a class="code" href="../../d5/d8/ex_8h.html#a238">ExInterlockedInsertTailList</a>(
01420             &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(Queue),
01421             &amp;queueEntry-&gt;ListEntry,
01422             &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(QueueInterlock)
01423             );
01424 
01425     <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>(
01426             &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(QueueSemaphore),
01427             SEMAPHORE_INCREMENT,
01428             1,
01429             FALSE
01430             );
01431 
01432     <span class="comment">//</span>
01433     <span class="comment">// ...and wait for the SMB to be eaten, in slow mode.</span>
01434     <span class="comment">//</span>
01435 
01436     <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(SingleSmbMode) ) {
01437         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>(( <span class="stringliteral">"%s!SmbTraceCompleteSrv: Slow mode wait\n"</span>, <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName) ));
01438         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(
01439             &amp;WaitEvent,
01440             UserRequest,
01441             KernelMode,
01442             FALSE,
01443             NULL
01444             );
01445         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>(( <span class="stringliteral">"%s!SmbTraceCompleteSrv: Slow mode wait done\n"</span>, <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName) ));
01446     }
01447 
01448     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a37">SmbTraceDereferenceHeap</a>( Component );
01449 
01450     <span class="keywordflow">return</span>;
01451 
01452 } <span class="comment">// SmbTraceCompleteSrv</span>

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a44" doxytag="smbtrsup.c::SmbTraceCopyMdlContiguous" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SmbTraceCopyMdlContiguous           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Destination</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Mdl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l02636">2636</a> of file <a class="el" href="../../d5/d8/smbtrsup_8c-source.html">smbtrsup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00324">MmGetMdlByteCount</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01874">MmGetSystemAddressForMdl</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01456">SmbTraceCompleteRdr()</a>, and <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01242">SmbTraceCompleteSrv()</a>.
<p>
<pre class="fragment"><div>02644                    :
02645 
02646     <a class="code" href="../../d9/d0/cmdata_8h.html#a104a97">Copy</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data stored in Mdl into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> contiguous memory at
02647     Destination.  Length <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> present to keep <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same interface
02648     as RtlCopyMemory.
02649 
02650 Arguments:
02651 
02652     Destination - a pointer to previously allocated memory into which
02653                   <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Mdl <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be copied.
02654 
02655     Mdl - a pointer to an Mdl which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be copied to Destination
02656 
02657     Length - number of data bytes expected in Mdl
02658 
02659 Return Value:
02660 
02661     None
02662 
02663 --*/
02664 
02665 {
02666     PCHAR Dest = Destination;
02667 
02668     UNREFERENCED_PARAMETER(Length);
02669 
02670     <span class="keywordflow">while</span> (Mdl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02671 
02672         RtlCopyMemory(
02673             Dest,
02674             <a class="code" href="../../d2/d1/mm_8h.html#a26">MmGetSystemAddressForMdl</a>(Mdl),
02675             <a class="code" href="../../d2/d1/mm_8h.html#a13">MmGetMdlByteCount</a>(Mdl)
02676             );
02677 
02678         Dest += <a class="code" href="../../d2/d1/mm_8h.html#a13">MmGetMdlByteCount</a>(Mdl);
02679         Mdl = Mdl-&gt;Next;
02680     }
02681 
02682     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((ULONG)(Dest - (PCHAR)Destination) == Length);
02683 
02684     <span class="keywordflow">return</span>;
02685 
02686 } <span class="comment">// SmbTraceCopyMdlContiguous</span>

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a45" doxytag="smbtrsup.c::SmbTraceDeferredDereferenceHeap" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SmbTraceDeferredDereferenceHeap           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Context</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01760">1760</a> of file <a class="el" href="../../d5/d8/smbtrsup_8c-source.html">smbtrsup.c</a>.
<p>
References <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01756">_TRACE_DEREFERENCE_ITEM::Component</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d4/d9/smbtrsup_8c.html#a28">PTRACE_DEREFERENCE_ITEM</a>, and <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01794">SmbTraceDereferenceHeap()</a>.
<p>
Referenced by <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01794">SmbTraceDereferenceHeap()</a>.
<p>
<pre class="fragment"><div>01765                    :
01766 
01767     If a caller dereferences a heap to 0 from DPC_LEVEL, <span class="keyword">this</span> routine will
01768     be called in a system thread to complete <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dereference at task time.
01769 
01770 Arguments:
01771 
01772     Component - Context from which we're called: server or redirector
01773 
01774 Return Value:
01775 
01776     None
01777 
01778 --*/
01779 
01780 {
01781     <a class="code" href="../../d0/d2/struct__TRACE__DEREFERENCE__ITEM.html">PTRACE_DEREFERENCE_ITEM</a> WorkItem = Context;
01782     SMBTRACE_COMPONENT Component = WorkItem-&gt;<a class="code" href="../../d0/d2/struct__TRACE__DEREFERENCE__ITEM.html#o1">Component</a>;
01783 
01784     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01785 
01786     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(WorkItem);
01787 
01788     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a37">SmbTraceDereferenceHeap</a>(Component);
01789 
01790 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a37" doxytag="smbtrsup.c::SmbTraceDereferenceHeap" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SmbTraceDereferenceHeap           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN SMBTRACE_COMPONENT&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Component</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01794">1794</a> of file <a class="el" href="../../d5/d8/smbtrsup_8c-source.html">smbtrsup.c</a>.
<p>
References <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00084">ACQUIRE_SPIN_LOCK</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01756">_TRACE_DEREFERENCE_ITEM::Component</a>, <a class="el" href="../../d5/d8/ex_8h.html#a332a206">DelayedWorkQueue</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00087">DISPATCH_LEVEL</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01961">ExInitializeWorkItem</a>, <a class="el" href="../../d2/d8/worker_8c-source.html#l00375">ExQueueWorkItem()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00151">ID</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a175">NonPagedPoolMustSucceed</a>, <a class="el" href="../../d4/d9/smbtrsup_8c.html#a28">PTRACE_DEREFERENCE_ITEM</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00085">RELEASE_SPIN_LOCK</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01760">SmbTraceDeferredDereferenceHeap()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01879">SmbTraceDisconnect()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00042">TrPrint</a>, and <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01755">_TRACE_DEREFERENCE_ITEM::WorkItem</a>.
<p>
Referenced by <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01456">SmbTraceCompleteRdr()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01242">SmbTraceCompleteSrv()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01760">SmbTraceDeferredDereferenceHeap()</a>, and <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l02020">SmbTraceThreadEntry()</a>.
<p>
<pre class="fragment"><div>01800                    :
01801 
01802     This routine dereferences <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SmbTrace shared memory heap,
01803     disposing of <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> reference count <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> zero.
01804 
01805 Arguments:
01806 
01807     Component - Context from which we're called: server or redirector
01808 
01809 Return Value:
01810 
01811     None
01812 
01813 --*/
01814 
01815 {
01816     ULONG oldCount;
01817     KIRQL OldIrql;
01818 
01819     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a3">ACQUIRE_SPIN_LOCK</a>( &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(HeapReferenceCountLock), &amp;OldIrql );
01820 
01821     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(HeapReferenceCount) &gt; 1) {
01822         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(HeapReferenceCount) --;
01823 
01824         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>(( <span class="stringliteral">"%s!SmbTraceDereferenceHeap: Count now %lx\n"</span>,
01825             <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName),
01826             <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(HeapReferenceCount) ));
01827 
01828         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a4">RELEASE_SPIN_LOCK</a>( &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(HeapReferenceCountLock), OldIrql );
01829 
01830         <span class="keywordflow">return</span>;
01831     }
01832 
01833     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a4">RELEASE_SPIN_LOCK</a>( &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(HeapReferenceCountLock), OldIrql );
01834 
01835     <span class="comment">//</span>
01836     <span class="comment">//  If we are executing at DPC_LEVEL, we cannot dereference the heap</span>
01837     <span class="comment">//  to 0.</span>
01838     <span class="comment">//</span>
01839 
01840     <span class="keywordflow">if</span> (KeGetCurrentIrql() &gt;= <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>) {
01841         <a class="code" href="../../d0/d2/struct__TRACE__DEREFERENCE__ITEM.html">PTRACE_DEREFERENCE_ITEM</a> WorkItem;
01842 
01843         WorkItem = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(NonPagedPoolMustSucceed, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d2/struct__TRACE__DEREFERENCE__ITEM.html">TRACE_DEREFERENCE_ITEM</a>), 'tbmS');
01844 
01845         <a class="code" href="../../d5/d8/ex_8h.html#a55">ExInitializeWorkItem</a>(&amp;WorkItem-&gt;<a class="code" href="../../d0/d2/struct__TRACE__DEREFERENCE__ITEM.html#o0">WorkItem</a>, SmbTraceDeferredDereferenceHeap, WorkItem);
01846         WorkItem-&gt;<a class="code" href="../../d0/d2/struct__TRACE__DEREFERENCE__ITEM.html#o1">Component</a> = Component;
01847 
01848         <a class="code" href="../../d5/d8/ex_8h.html#a261">ExQueueWorkItem</a>(&amp;WorkItem-&gt;<a class="code" href="../../d0/d2/struct__TRACE__DEREFERENCE__ITEM.html#o0">WorkItem</a>, DelayedWorkQueue);
01849 
01850         <span class="keywordflow">return</span>;
01851 
01852     }
01853 
01854     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a3">ACQUIRE_SPIN_LOCK</a>( &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(HeapReferenceCountLock), &amp;OldIrql );
01855 
01856     oldCount = <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(HeapReferenceCount)--;
01857 
01858     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>(( <span class="stringliteral">"%s!SmbTraceDereferenceHeap: Count now %lx\n"</span>,
01859         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName),
01860         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(HeapReferenceCount) ));
01861 
01862     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a4">RELEASE_SPIN_LOCK</a>( &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(HeapReferenceCountLock), OldIrql );
01863 
01864     <span class="keywordflow">if</span> ( oldCount == 1 ) {
01865 
01866         <span class="comment">//</span>
01867         <span class="comment">// Free the section, release the handles and such.</span>
01868         <span class="comment">//</span>
01869 
01870         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a38">SmbTraceDisconnect</a>( Component );
01871     }
01872 
01873     <span class="keywordflow">return</span>;
01874 
01875 } <span class="comment">// SmbTraceDereferenceHeap</span>

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a38" doxytag="smbtrsup.c::SmbTraceDisconnect" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SmbTraceDisconnect           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN SMBTRACE_COMPONENT&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Component</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01879">1879</a> of file <a class="el" href="../../d5/d8/smbtrsup_8c-source.html">smbtrsup.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00151">ID</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00166">KeAttachProcess()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00405">KeDetachProcess()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l01133">RtlDestroyHeap()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00042">TrPrint</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01794">SmbTraceDereferenceHeap()</a>, and <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00551">SmbTraceStart()</a>.
<p>
<pre class="fragment"><div>01885                    :
01886 
01887     This routine reverses all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> effects of <a class="code" href="../../d4/d9/smbtrsup_8c.html#a48">SmbTraceStart</a>. Mostly,
01888     <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> just needs to close certain handles to <span class="keywordflow">do</span> <span class="keyword">this</span>.
01889 
01890 Arguments:
01891 
01892     Component - Context from which we're called: server or redirector
01893 
01894 Return Value:
01895 
01896     None - always works
01897 
01898 --*/
01899 
01900 {
01901     BOOLEAN ProcessAttached = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01902 
01903     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01904 
01905     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() != <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(FspProcess)) {
01906         <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a>(<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(FspProcess));
01907         ProcessAttached = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01908 
01909     }
01910 
01911 
01912     <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(DoneSmbEvent) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01913         <span class="comment">// Worker thread may be blocked on this, so we set it first</span>
01914         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>(( <span class="stringliteral">"%s!SmbTraceDisconnect: Signal DoneSmbEvent, handle %x, process %x.\n"</span>,
01915                     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName), <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(DoneSmbEvent), <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()));
01916         ZwSetEvent( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(DoneSmbEvent), NULL );
01917 
01918         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>(( <span class="stringliteral">"%s!SmbTraceDisconnect: Close DoneSmbEvent, handle %x, process %x.\n"</span>,
01919                     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName), <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(DoneSmbEvent), <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()));
01920         ZwClose( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(DoneSmbEvent) );
01921         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(DoneSmbEvent) = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01922     }
01923 
01924     <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(NewSmbEvent) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01925         ZwClose( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(NewSmbEvent) );
01926         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(NewSmbEvent) = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01927     }
01928 
01929     <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(PortMemoryHeap) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01930         <a class="code" href="../../d1/d9/rtl_2heap_8c.html#a16">RtlDestroyHeap</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(PortMemoryHeap) );
01931         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(PortMemoryHeap) = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01932     }
01933 
01934     <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(SectionHandle) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01935         ZwClose( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(SectionHandle) );
01936         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(SectionHandle) = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01937     }
01938 
01939     <span class="keywordflow">if</span> (ProcessAttached) {
01940         <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
01941     }
01942 
01943     <span class="keywordflow">return</span>;
01944 
01945 } <span class="comment">// SmbTraceDisconnect</span>

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a39" doxytag="smbtrsup.c::SmbTraceEmptyQueue" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SmbTraceEmptyQueue           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN SMBTRACE_COMPONENT&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Component</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01949">1949</a> of file <a class="el" href="../../d5/d8/smbtrsup_8c-source.html">smbtrsup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00129">_SMBTRACE_QUEUE_ENTRY::Buffer</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00133">_SMBTRACE_QUEUE_ENTRY::BufferNonPaged</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a239">ExInterlockedRemoveHeadList()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00151">ID</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d4/d9/smbtrsup_8c.html#a20">PSMBTRACE_QUEUE_ENTRY</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00136">_SMBTRACE_QUEUE_ENTRY::WaitEvent</a>.
<p>
Referenced by <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l02020">SmbTraceThreadEntry()</a>.
<p>
<pre class="fragment"><div>01955                    :
01956 
01957     This routine empties <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> queue of unprocessed SMBs.
01958 
01959 Arguments:
01960 
01961     Component - Context from which we're called: server or redirector
01962 
01963 Return Value:
01964 
01965     None - always works
01966 
01967 --*/
01968 
01969 {
01970     PLIST_ENTRY            listEntry;
01971     <a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html">PSMBTRACE_QUEUE_ENTRY</a>  queueEntry;
01972 
01973     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01974 
01975     <span class="keywordflow">while</span> ( ( listEntry = <a class="code" href="../../d5/d8/ex_8h.html#a239">ExInterlockedRemoveHeadList</a>(
01976                               &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(Queue),
01977                               &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(QueueInterlock)
01978                               )
01979             ) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01980     ) {
01981         queueEntry = CONTAINING_RECORD(
01982                           listEntry,
01983                           <a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html">SMBTRACE_QUEUE_ENTRY</a>,
01984                           ListEntry
01985                           );
01986 
01987         <span class="comment">//</span>
01988         <span class="comment">// If data for this entry is in non-paged pool, free it too.</span>
01989         <span class="comment">// This only ever happens in the redirector.</span>
01990         <span class="comment">//</span>
01991 
01992         <span class="keywordflow">if</span> ( queueEntry-&gt;<a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o4">BufferNonPaged</a> ) {
01993 
01994             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Component == SMBTRACE_REDIRECTOR );
01995 
01996             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( queueEntry-&gt;<a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o2">Buffer</a> );
01997         }
01998 
01999         <span class="comment">//</span>
02000         <span class="comment">// If a worker thread is waiting on this event, let it go.</span>
02001         <span class="comment">// This only ever happens in slow mode.</span>
02002         <span class="comment">//</span>
02003 
02004         <span class="keywordflow">if</span> ( queueEntry-&gt;<a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o5">WaitEvent</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
02005 
02006             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(SingleSmbMode) == TRUE );
02007 
02008             <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( queueEntry-&gt;<a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o5">WaitEvent</a>, 0, FALSE );
02009         }
02010 
02011         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( queueEntry );
02012     }
02013 
02014     <span class="keywordflow">return</span>;
02015 
02016 } <span class="comment">// SmbTraceEmptyQueue</span>

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a41" doxytag="smbtrsup.c::SmbTraceFreeMemory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS SmbTraceFreeMemory           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN SMBTRACE_COMPONENT&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Component</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l02355">2355</a> of file <a class="el" href="../../d5/d8/smbtrsup_8c-source.html">smbtrsup.c</a>.
<p>
References <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00151">ID</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00023">RtlFreeHeap</a>, and <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00042">TrPrint</a>.
<p>
Referenced by <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l02020">SmbTraceThreadEntry()</a>.
<p>
<pre class="fragment"><div>02361                    :
02362 
02363     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> frees any memory that may have been allocated to an
02364     SMB that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client has already consumed. It does not alter table
02365     entries, except to record that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> memory buffer has been cleared.
02366     This routinue <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not espectally fast, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> should not be called often,
02367     <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> when needed.
02368 
02369 Arguments:
02370 
02371     Component - Context from which we're called: server or redirector
02372 
02373 Return Value:
02374 
02375     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - result of operation.
02376 
02377 --*/
02378 
02379 {
02380     PVOID    buffer;
02381     PSMBTRACE_TABLE_ENTRY    tableEntry;
02382     ULONG    tableIndex;
02383 
02384     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02385 
02386     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>(( <span class="stringliteral">"%s!SmbTraceFreeMemory: Called for garbage collection.\n"</span>,
02387               <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName) ));
02388 
02389     <span class="comment">//</span>
02390     <span class="comment">// No free memory in the heap, perhaps we can free some by freeing</span>
02391     <span class="comment">// memory in old table entries. This is expensive for time.</span>
02392     <span class="comment">//</span>
02393 
02394     tableIndex = <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TableHeader)-&gt;NextFree;
02395 
02396     <span class="keywordflow">while</span>( tableIndex != <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TableHeader)-&gt;HighestConsumed ) {
02397 
02398         tableEntry = <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(Table) + tableIndex;
02399 
02400         <span class="comment">//</span>
02401         <span class="comment">// Check if this table entry has been used but its memory has not</span>
02402         <span class="comment">// been freed yet. If so, free it.</span>
02403         <span class="comment">//</span>
02404 
02405         <span class="keywordflow">if</span> ( tableEntry-&gt;BufferOffset != 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a> ) {
02406 
02407             buffer = (PVOID)( (ULONG_PTR)tableEntry-&gt;BufferOffset
02408                         + (ULONG_PTR)<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(PortMemoryBase) );
02409 
02410             <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(PortMemoryHeap), 0, buffer);
02411 
02412             tableEntry-&gt;BufferOffset = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
02413         }
02414 
02415 
02416         tableIndex = (tableIndex + 1) % <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TableSize);
02417     }
02418 
02419     <span class="keywordflow">return</span>( STATUS_SUCCESS );
02420 
02421 } <span class="comment">// SmbTraceFreeMemory</span>

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a46" doxytag="smbtrsup.c::SmbTraceInitialize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS SmbTraceInitialize           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN SMBTRACE_COMPONENT&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Component</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00438">438</a> of file <a class="el" href="../../d5/d8/smbtrsup_8c-source.html">smbtrsup.c</a>.
<p>
References <a class="el" href="../../d5/d8/ex_8h.html#a125">ERESOURCE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02478">ExDeleteResource</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02473">ExInitializeResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00151">ID</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>00444                    :
00445 
00446     This routine initializes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SmbTrace component-specific instance
00447     globals.  On first-ever invocation, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> performs truly global
00448     initialization.
00449 
00450 Arguments:
00451 
00452     Component - Context from which we're called: server or redirector
00453 
00454 Return Value:
00455 
00456     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - Indicates <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a> <span class="keywordflow">if</span> unable to allocate resources
00457 
00458 --*/
00459 
00460 {
00461     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00462 
00463     <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(InstanceInitialized) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ) {
00464         <span class="comment">//</span>
00465         <span class="comment">// Component specific initialization -- events and locks.</span>
00466         <span class="comment">//</span>
00467 
00468         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ActiveEvent), NotificationEvent, FALSE);
00469         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TerminatedEvent), NotificationEvent, FALSE);
00470         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TerminationEvent), NotificationEvent, FALSE);
00471         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(AppTerminationEvent), NotificationEvent, FALSE);
00472         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(NeedMemoryEvent), NotificationEvent, FALSE);
00473 
00474         <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>( &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(SmbsLostInterlock) );
00475         <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>( &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(HeapReferenceCountLock) );
00476 
00477         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(StateInterlock) = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
00478                                 NonPagedPool,
00479                                 <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d4/struct__ERESOURCE.html">ERESOURCE</a>),
00480                                 'tbmS'
00481                                 );
00482         <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(StateInterlock) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00483             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00484         }
00485         <a class="code" href="../../d5/d8/ex_8h.html#a68">ExInitializeResource</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(StateInterlock) );
00486 
00487         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(HeapInterlock) = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
00488                                 NonPagedPool,
00489                                 <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d4/struct__ERESOURCE.html">ERESOURCE</a>),
00490                                 'tbmS'
00491                                 );
00492         <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(HeapInterlock) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00493             <a class="code" href="../../d5/d8/ex_8h.html#a73">ExDeleteResource</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(StateInterlock) );
00494             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(StateInterlock) );
00495             <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(StateInterlock) = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00496             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00497         }
00498         <a class="code" href="../../d5/d8/ex_8h.html#a68">ExInitializeResource</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(HeapInterlock) );
00499 
00500         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(InstanceInitialized) = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00501     }
00502 
00503     <span class="keywordflow">return</span> STATUS_SUCCESS;
00504 
00505 } <span class="comment">// SmbTraceInitialize</span>

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a43" doxytag="smbtrsup.c::SmbTraceMdlLength" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG SmbTraceMdlLength           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Mdl</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l02603">2603</a> of file <a class="el" href="../../d5/d8/smbtrsup_8c-source.html">smbtrsup.c</a>.
<p>
References <a class="el" href="../../d3/d0/mm_8h-source.html#l00324">MmGetMdlByteCount</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01456">SmbTraceCompleteRdr()</a>, and <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01242">SmbTraceCompleteSrv()</a>.
<p>
<pre class="fragment"><div>02609                    :
02610 
02611     Determine <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> total number of bytes of data found in an Mdl.
02612 
02613 Arguments:
02614 
02615     Mdl - a pointer to an Mdl whose length <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be calculated
02616 
02617 Return Value:
02618 
02619     ULONG - total number of data bytes in Mdl
02620 
02621 --*/
02622 
02623 {
02624     ULONG Bytes = 0;
02625 
02626     <span class="keywordflow">while</span> (Mdl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02627         Bytes += <a class="code" href="../../d2/d1/mm_8h.html#a13">MmGetMdlByteCount</a>(Mdl);
02628         Mdl = Mdl-&gt;Next;
02629     }
02630 
02631     <span class="keywordflow">return</span> Bytes;
02632 } <span class="comment">// SmbTraceMdlLength</span>

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a36" doxytag="smbtrsup.c::SmbTraceReferenceHeap" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN SmbTraceReferenceHeap           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN SMBTRACE_COMPONENT&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Component</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01709">1709</a> of file <a class="el" href="../../d5/d8/smbtrsup_8c-source.html">smbtrsup.c</a>.
<p>
References <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00084">ACQUIRE_SPIN_LOCK</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00151">ID</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00085">RELEASE_SPIN_LOCK</a>, <a class="el" href="../../d4/d9/smbtrsup_8c.html#a52a34">TraceRunning</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00042">TrPrint</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01456">SmbTraceCompleteRdr()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01242">SmbTraceCompleteSrv()</a>, and <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00551">SmbTraceStart()</a>.
<p>
<pre class="fragment"><div>01715                    :
01716 
01717     This routine references <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SmbTrace shared memory heap,
01718     ensuring <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> isn'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> disposed of <span class="keywordflow">while</span> caller <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keyword">using</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
01719 
01720 Arguments:
01721 
01722     Component - Context from which we're called: server or redirector
01723 
01724 Return Value:
01725 
01726     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> SmbTrace <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> still active, and hence
01727               heap exists and was successfully referenced.
01728               <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
01729 
01730 --*/
01731 
01732 {
01733     BOOLEAN retval = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;  <span class="comment">// assume we'll get it</span>
01734     KIRQL OldIrql;
01735 
01736     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a3">ACQUIRE_SPIN_LOCK</a>( &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(HeapReferenceCountLock), &amp;OldIrql );
01737 
01738     <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TraceState) != <a class="code" href="../../d4/d9/smbtrsup_8c.html#a52a34">TraceRunning</a> ) {
01739         retval = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01740     } <span class="keywordflow">else</span> {
01741         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(HeapReferenceCount) &gt; 0 );
01742         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(HeapReferenceCount)++;
01743         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>(( <span class="stringliteral">"%s!SmbTraceReferenceHeap: Count now %lx\n"</span>,
01744             <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName),
01745             <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(HeapReferenceCount) ));
01746     }
01747 
01748     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a4">RELEASE_SPIN_LOCK</a>( &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(HeapReferenceCountLock), OldIrql );
01749 
01750     <span class="keywordflow">return</span> retval;
01751 
01752 } <span class="comment">// SmbTraceReferenceHeap</span>

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a48" doxytag="smbtrsup.c::SmbTraceStart" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS SmbTraceStart           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>InputBufferLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>OutputBufferLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>ConfigInOut</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SMBTRACE_COMPONENT&nbsp;</td>
          <td class="mdname" nowrap> <em>Component</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00551">551</a> of file <a class="el" href="../../d5/d8/smbtrsup_8c-source.html">smbtrsup.c</a>.
<p>
References <a class="el" href="../../d4/d9/smbtrsup_8c.html#a8">ACL_LENGTH</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02475">ExAcquireResourceExclusive</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00151">ID</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00285">KeResetEvent()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06864">MmLockPagableDataSection()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00367">PKSTART_ROUTINE</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00175">PsCreateSystemThread()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l01607">RtlAddAccessAllowedAce()</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00022">RtlAllocateHeap</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l00099">RtlCreateAcl()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l00191">RtlCreateHeap()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01945">RtlCreateSecurityDescriptor()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l02543">RtlSetDaclSecurityDescriptor()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00377">_SE_EXPORTS::SeAliasAdminsSid</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01590">SeExports</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00333">SmbTraceActive</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00278">SmbTraceData</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00337">SmbTraceDiscardableCodeHandle</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00340">SmbTraceDiscardableDataHandle</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01879">SmbTraceDisconnect()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01709">SmbTraceReferenceHeap()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01050">SmbTraceStop()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l02020">SmbTraceThreadEntry()</a>, <a class="el" href="../../d4/d9/smbtrsup_8c.html#a52a34">TraceRunning</a>, <a class="el" href="../../d4/d9/smbtrsup_8c.html#a52a30">TraceStarting</a>, <a class="el" href="../../d4/d9/smbtrsup_8c.html#a52a31">TraceStartStopFile</a>, <a class="el" href="../../d4/d9/smbtrsup_8c.html#a52a32">TraceStartStopNull</a>, <a class="el" href="../../d4/d9/smbtrsup_8c.html#a52a29">TraceStopped</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00042">TrPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d9/ke_8h.html#a407a204">UserRequest</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
<pre class="fragment"><div>00561                    :
00562 
00563     This routine performs all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> work necessary to connect <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> server/
00564     redirector to SmbTrace.  It creates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section of shared memory to
00565     be used, then creates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> events needed. All these objects are then
00566     opened by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client (smbtrace) program. This code initializes the
00567     table, the heap stored in the section and table header.  This routine
00568     must be called from an Fsp process.
00569 
00570 Arguments:
00571 
00572     InputBufferLength - Length of the ConfigInOut packet
00573 
00574     OutputBufferLength - Length expected for the ConfigInOut packet returned
00575 
00576     ConfigInOut - A structure that has configuration information.
00577 
00578     FileObject - FileObject of the process requesting that SmbTrace be started,
00579                  used to automatically shut down when the app dies.
00580 
00581     Component - Context from which we're called: server or redirector
00582 
00583 Return Value:
00584 
00585     NTSTATUS - result of operation.
00586 
00587 --*/
00588 
00589 <span class="comment">// size of our one, particular, ACL</span>
00590 #define ACL_LENGTH  (ULONG)sizeof(ACL) +                 \
00591                     (ULONG)sizeof(ACCESS_ALLOWED_ACE) +  \
00592                     sizeof(LUID) +                       \
00593                     8
00594 
00595 {
00596     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00597     UNICODE_STRING memoryNameU;
00598 
00599     SID_IDENTIFIER_AUTHORITY NtAuthority = SECURITY_NT_AUTHORITY;
00600     UCHAR <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[<a class="code" href="../../d4/d9/smbtrsup_8c.html#a8">ACL_LENGTH</a>];
00601     PACL AdminAcl = (PACL)(&amp;<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[0]);
00602     SECURITY_DESCRIPTOR securityDescriptor;
00603 
00604     UNICODE_STRING eventNameU;
00605     OBJECT_ATTRIBUTES objectAttributes;
00606     ULONG i;
00607     LARGE_INTEGER sectionSize;
00608     PSMBTRACE_CONFIG_PACKET_REQ  ConfigPacket;
00609     PSMBTRACE_CONFIG_PACKET_RESP ConfigPacketResp;
00610     HANDLE threadHandle;
00611 
00612     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00613 
00614     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(InstanceInitialized) );
00615 
00616     <span class="comment">//</span>
00617     <span class="comment">// Validate the buffer lengths passed in.</span>
00618     <span class="comment">//</span>
00619 
00620     <span class="keywordflow">if</span> ( ( InputBufferLength  != <span class="keyword">sizeof</span>( SMBTRACE_CONFIG_PACKET_REQ ) )
00621       || ( OutputBufferLength != <span class="keyword">sizeof</span>( SMBTRACE_CONFIG_PACKET_RESP ) )
00622     ) {
00623 
00624         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>(( <span class="stringliteral">"%s!SmbTraceStart: config packet(s) of wrong size!\n"</span>,
00625                   <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName) ));
00626 
00627         <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
00628 
00629     }
00630 
00631     <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(StateInterlock), TRUE );
00632 
00633     <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TraceState) != <a class="code" href="../../d4/d9/smbtrsup_8c.html#a52a29">TraceStopped</a> ) {
00634         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(StateInterlock) );
00635         <span class="keywordflow">return</span> STATUS_INVALID_DEVICE_STATE;
00636     }
00637 
00638     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!SmbTraceActive[Component]);
00639 
00640     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (SmbTraceDiscardableDataHandle == NULL);
00641 
00642     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (SmbTraceDiscardableCodeHandle == NULL);
00643 
00644     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a25">SmbTraceDiscardableCodeHandle</a> = MmLockPagableCodeSection(SmbTraceReferenceHeap);
00645 
00646     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a26">SmbTraceDiscardableDataHandle</a> = <a class="code" href="../../d5/d6/iosup_8c.html#a79">MmLockPagableDataSection</a>(SmbTraceData);
00647 
00648     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TraceState) = <a class="code" href="../../d4/d9/smbtrsup_8c.html#a52a30">TraceStarting</a>;
00649 
00650     <span class="comment">//</span>
00651     <span class="comment">// Initialize global variables so that we know what to close on errexit</span>
00652     <span class="comment">//</span>
00653 
00654     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(SectionHandle) = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00655     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(PortMemoryHeap) = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00656     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(NewSmbEvent) = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00657     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(DoneSmbEvent) = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00658 
00659     <span class="comment">//</span>
00660     <span class="comment">// Caution! Both input and output packets are the same, we must</span>
00661     <span class="comment">// read all of the input before we write any output.</span>
00662     <span class="comment">//</span>
00663 
00664     ConfigPacket = (PSMBTRACE_CONFIG_PACKET_REQ) ConfigInOut;
00665     ConfigPacketResp = (PSMBTRACE_CONFIG_PACKET_RESP) ConfigInOut;
00666 
00667     <span class="comment">//</span>
00668     <span class="comment">// Set the mode of operation (read all values).</span>
00669     <span class="comment">//</span>
00670 
00671     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(SingleSmbMode)  = ConfigPacket-&gt;SingleSmbMode;
00672     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(Verbosity)      = ConfigPacket-&gt;Verbosity;
00673     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(PortMemorySize) = ConfigPacket-&gt;BufferSize;
00674     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TableSize)      = ConfigPacket-&gt;TableSize;
00675 
00676     <span class="comment">//</span>
00677     <span class="comment">// Create a security descriptor containing a discretionary Acl</span>
00678     <span class="comment">// allowing administrator access.  This SD will be used to allow</span>
00679     <span class="comment">// Smbtrace access to the shared memory and the notification events.</span>
00680     <span class="comment">//</span>
00681 
00682     <span class="comment">// Create Acl allowing administrator access using well-known Sid.</span>
00683 
00684     status = <a class="code" href="../../d2/d4/acledit_8c.html#a6">RtlCreateAcl</a>( AdminAcl, ACL_LENGTH, ACL_REVISION2 );
00685     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00686         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>((
00687             <span class="stringliteral">"%s!SmbTraceStart: RtlCreateAcl failed: %X\n"</span>,
00688             <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName), status ));
00689         <span class="keywordflow">goto</span> errexit;
00690     }
00691 
00692     status = <a class="code" href="../../d2/d4/acledit_8c.html#a16">RtlAddAccessAllowedAce</a>(
00693              AdminAcl,
00694              ACL_REVISION2,
00695              GENERIC_ALL,
00696              <a class="code" href="../../d0/d5/se_8h.html#a37">SeExports</a>-&gt;<a class="code" href="../../d2/d0/struct__SE__EXPORTS.html#o34">SeAliasAdminsSid</a>
00697              );
00698     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00699         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>((
00700             <span class="stringliteral">"%s!SmbTraceStart: RtlAddAccessAllowedAce failed: %X\n"</span>,
00701             <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName), status ));
00702         <span class="keywordflow">goto</span> errexit;
00703     }
00704 
00705     <span class="comment">// Create SecurityDescriptor containing AdminAcl as a discrectionary ACL.</span>
00706 
00707     <a class="code" href="../../d8/d6/sertl_8c.html#a53">RtlCreateSecurityDescriptor</a>(
00708              &amp;securityDescriptor,
00709              SECURITY_DESCRIPTOR_REVISION1
00710              );
00711     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00712         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>((
00713             <span class="stringliteral">"%s!SmbTraceStart: RtlCreateSecurityDescriptor failed: %X\n"</span>,
00714             <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName), status ));
00715         <span class="keywordflow">goto</span> errexit;
00716     }
00717 
00718     status = <a class="code" href="../../d8/d6/sertl_8c.html#a60">RtlSetDaclSecurityDescriptor</a>(
00719              &amp;securityDescriptor,
00720              TRUE,
00721              AdminAcl,
00722              FALSE
00723              );
00724     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00725         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>((
00726             <span class="stringliteral">"%s!SmbTraceStart: "</span>
00727             <span class="stringliteral">"RtlSetDAclAllowedSecurityDescriptor failed: %X\n"</span>,
00728             <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName), status ));
00729         <span class="keywordflow">goto</span> errexit;
00730     }
00731 
00732     <span class="comment">//</span>
00733     <span class="comment">// Create the section to be used for communication between the</span>
00734     <span class="comment">// server/redirector and SmbTrace.</span>
00735     <span class="comment">//</span>
00736 
00737     <span class="comment">// Define the object name.</span>
00738 
00739     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;memoryNameU, <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(SharedMemoryName) );
00740 
00741     <span class="comment">// Define the object information, including security descriptor and name.</span>
00742 
00743     InitializeObjectAttributes(
00744         &amp;objectAttributes,
00745         &amp;memoryNameU,
00746         OBJ_CASE_INSENSITIVE,
00747         NULL,
00748         &amp;securityDescriptor
00749         );
00750 
00751     <span class="comment">// Setup the section size.</span>
00752 
00753     sectionSize.QuadPart = <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(PortMemorySize);
00754 
00755     <span class="comment">// Create the named section of memory with all of our attributes.</span>
00756 
00757     status = ZwCreateSection(
00758                 &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(SectionHandle),
00759                 SECTION_MAP_READ | SECTION_MAP_WRITE,
00760                 &amp;objectAttributes,
00761                 &amp;sectionSize,
00762                 PAGE_READWRITE,
00763                 SEC_RESERVE,
00764                 NULL                        <span class="comment">// file handle</span>
00765                 );
00766 
00767     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00768         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>(( <span class="stringliteral">"%s!SmbTraceStart: ZwCreateSection failed: %X\n"</span>,
00769                   <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName), status ));
00770         <span class="keywordflow">goto</span> errexit;
00771     }
00772 
00773     <span class="comment">// Now, map it into our address space.</span>
00774 
00775     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(PortMemoryBase) = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00776 
00777     status = ZwMapViewOfSection(
00778                     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(SectionHandle),
00779                     NtCurrentProcess(),
00780                     &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(PortMemoryBase),
00781                     0,                        <span class="comment">// zero bits (don't care)</span>
00782                     0,                        <span class="comment">// commit size</span>
00783                     NULL,                     <span class="comment">// SectionOffset</span>
00784                     &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(PortMemorySize),      <span class="comment">// viewSize</span>
00785                     ViewUnmap,                <span class="comment">// inheritDisposition</span>
00786                     0L,                       <span class="comment">// allocation type</span>
00787                     PAGE_READWRITE            <span class="comment">// protection</span>
00788                     );
00789 
00790     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00791         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>(( <span class="stringliteral">"%s!SmbTraceStart: NtMapViewOfSection failed: %X\n"</span>,
00792                   <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName), status ));
00793         <span class="keywordflow">goto</span> errexit;
00794     }
00795 
00796     <span class="comment">//</span>
00797     <span class="comment">// Set up the shared section memory as a heap.</span>
00798     <span class="comment">//</span>
00799     <span class="comment">// *** Note that the HeapInterlock for the client instance is passed</span>
00800     <span class="comment">//     to the heap manager to be used for serialization of</span>
00801     <span class="comment">//     allocation and deallocation.  It is necessary for the</span>
00802     <span class="comment">//     resource to be allocated FROM NONPAGED POOL externally to the</span>
00803     <span class="comment">//     heap manager, because if we let the heap manager allocate</span>
00804     <span class="comment">//     the resource, if would allocate it from process virtual</span>
00805     <span class="comment">//     memory.</span>
00806     <span class="comment">//</span>
00807 
00808     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(PortMemoryHeap) = <a class="code" href="../../d1/d9/rtl_2heap_8c.html#a15">RtlCreateHeap</a>(
00809                               0,                            <span class="comment">// Flags</span>
00810                               <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(PortMemoryBase),           <span class="comment">// HeapBase</span>
00811                               <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(PortMemorySize),           <span class="comment">// ReserveSize</span>
00812                               PAGE_SIZE,                    <span class="comment">// CommitSize</span>
00813                               <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(HeapInterlock),            <span class="comment">// Lock</span>
00814                               0                             <span class="comment">// Reserved</span>
00815                               );
00816 
00817     <span class="comment">//</span>
00818     <span class="comment">// Allocate and initialize the table and its header.</span>
00819     <span class="comment">//</span>
00820 
00821     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TableHeader) = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(
00822                                     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(PortMemoryHeap), 0,
00823                                     <span class="keyword">sizeof</span>( SMBTRACE_TABLE_HEADER )
00824                                     );
00825 
00826     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(Table) = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(
00827                         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(PortMemoryHeap), 0,
00828                         <span class="keyword">sizeof</span>( SMBTRACE_TABLE_ENTRY ) * <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TableSize)
00829                         );
00830 
00831     <span class="keywordflow">if</span> ( (<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TableHeader) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(Table) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ) {
00832         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>((
00833             <span class="stringliteral">"%s!SmbTraceStart: Not enough memory!\n"</span>,
00834             <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName) ));
00835 
00836         status = STATUS_NO_MEMORY;
00837 
00838         <span class="keywordflow">goto</span> errexit;
00839     }
00840 
00841     <span class="comment">// Initialize the values inside.</span>
00842 
00843     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TableHeader)-&gt;HighestConsumed = 0;
00844     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TableHeader)-&gt;NextFree = 1;
00845     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TableHeader)-&gt;ApplicationStop = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00846 
00847     <span class="keywordflow">for</span> ( i = 0; i &lt; <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TableSize); i++) {
00848         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(Table)[i].BufferOffset = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00849         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(Table)[i].SmbLength = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00850     }
00851 
00852     <span class="comment">//</span>
00853     <span class="comment">// Create the required event handles.</span>
00854     <span class="comment">//</span>
00855 
00856     <span class="comment">// Define the object information.</span>
00857 
00858     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;eventNameU, <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(NewSmbEventName) );
00859 
00860     InitializeObjectAttributes(
00861         &amp;objectAttributes,
00862         &amp;eventNameU,
00863         OBJ_CASE_INSENSITIVE,
00864         NULL,
00865         &amp;securityDescriptor
00866         );
00867 
00868     <span class="comment">// Open the named object.</span>
00869 
00870     status = ZwCreateEvent(
00871                 &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(NewSmbEvent),
00872                 EVENT_ALL_ACCESS,
00873                 &amp;objectAttributes,
00874                 NotificationEvent,
00875                 FALSE                        <span class="comment">// initial state</span>
00876                 );
00877 
00878     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00879         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>(( <span class="stringliteral">"%s!SmbTraceStart: ZwCreateEvent (1st) failed: %X\n"</span>,
00880                   <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName), status ));
00881 
00882         <span class="keywordflow">goto</span> errexit;
00883     }
00884 
00885     <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(SingleSmbMode) ) {    <span class="comment">// this event may not be required.</span>
00886 
00887         <span class="comment">// Define the object information.</span>
00888 
00889         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;eventNameU, <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(DoneSmbEventName) );
00890 
00891         InitializeObjectAttributes(
00892             &amp;objectAttributes,
00893             &amp;eventNameU,
00894             OBJ_CASE_INSENSITIVE,
00895             NULL,
00896             &amp;securityDescriptor
00897             );
00898 
00899         <span class="comment">// Create the named object.</span>
00900 
00901         status = ZwCreateEvent(
00902                     &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(DoneSmbEvent),
00903                     EVENT_ALL_ACCESS,
00904                     &amp;objectAttributes,
00905                     NotificationEvent,
00906                     FALSE                    <span class="comment">// initial state</span>
00907                     );
00908 
00909         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00910             <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>((
00911                 <span class="stringliteral">"%s!SmbTraceStart: NtCreateEvent (2nd) failed: %X\n"</span>,
00912                  <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName), status ));
00913             <span class="keywordflow">goto</span> errexit;
00914         }
00915         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>(( <span class="stringliteral">"%s!SmbTraceStart: DoneSmbEvent handle %x in process %x\n"</span>,
00916                 <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName), <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(DoneSmbEvent), <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()));
00917 
00918     }
00919 
00920     <span class="comment">//</span>
00921     <span class="comment">//  Reset any events that may be in the wrong state from a previous run.</span>
00922     <span class="comment">//</span>
00923 
00924     <a class="code" href="../../d2/d8/eventobj_8c.html#a7">KeResetEvent</a>(&amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TerminationEvent));
00925     <a class="code" href="../../d2/d8/eventobj_8c.html#a7">KeResetEvent</a>(&amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TerminatedEvent));
00926 
00927     <span class="comment">//</span>
00928     <span class="comment">// Connection was successful, now start the SmbTrace thread.</span>
00929     <span class="comment">//</span>
00930 
00931     <span class="comment">//</span>
00932     <span class="comment">// Create the SmbTrace thread and wait for it to finish</span>
00933     <span class="comment">// initializing (at which point SmbTraceActiveEvent is set)</span>
00934     <span class="comment">//</span>
00935 
00936     status = <a class="code" href="../../d2/d8/ps_2create_8c.html#a11">PsCreateSystemThread</a>(
00937         &amp;threadHandle,
00938         THREAD_ALL_ACCESS,
00939         NULL,
00940         NtCurrentProcess(),
00941         NULL,
00942         (PKSTART_ROUTINE) SmbTraceThreadEntry,
00943         (PVOID)Component
00944         );
00945 
00946     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00947 
00948         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>((
00949             <span class="stringliteral">"%s!SmbTraceStart: PsCreateSystemThread failed: %X\n"</span>,
00950             <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName), status ));
00951 
00952         <span class="keywordflow">goto</span> errexit;
00953     }
00954 
00955     <span class="comment">//</span>
00956     <span class="comment">// Wait until SmbTraceThreadEntry has finished initializing</span>
00957     <span class="comment">//</span>
00958 
00959     (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(
00960             &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ActiveEvent),
00961             UserRequest,
00962             KernelMode,
00963             FALSE,
00964             NULL
00965             );
00966 
00967     <span class="comment">//</span>
00968     <span class="comment">// Close the handle to the process so the object will be</span>
00969     <span class="comment">// destroyed when the thread dies.</span>
00970     <span class="comment">//</span>
00971 
00972     ZwClose( threadHandle );
00973 
00974 
00975     <span class="comment">//</span>
00976     <span class="comment">// Record who started SmbTrace so we can stop if he dies or otherwise</span>
00977     <span class="comment">// closes this handle to us.</span>
00978     <span class="comment">//</span>
00979 
00980     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(StartersFileObject) = FileObject;
00981 
00982     <span class="comment">//</span>
00983     <span class="comment">// Record caller's process; which is always the appropriate Fsp</span>
00984     <span class="comment">// process.</span>
00985     <span class="comment">//</span>
00986 
00987     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(FspProcess) = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
00988 
00989 
00990     <span class="comment">//</span>
00991     <span class="comment">// Setup the response packet, since everything worked (write all values).</span>
00992     <span class="comment">//</span>
00993 
00994     ConfigPacketResp-&gt;HeaderOffset = (ULONG)
00995                                 ( (ULONG_PTR)<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TableHeader)
00996                                 - (ULONG_PTR)<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(PortMemoryBase) );
00997 
00998     ConfigPacketResp-&gt;TableOffset = (ULONG)
00999                                 ( (ULONG_PTR)<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(Table)
01000                                 - (ULONG_PTR)<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(PortMemoryBase) );
01001 
01002     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>(( <span class="stringliteral">"%s!SmbTraceStart: SmbTrace started.\n"</span>, <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName) ));
01003 
01004     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(StateInterlock) );
01005 
01006     <span class="comment">//</span>
01007     <span class="comment">// if someone wanted it shut down while it was starting, shut it down</span>
01008     <span class="comment">//</span>
01009 
01010     <span class="keywordflow">switch</span> ( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TraceState) ) {
01011 
01012     <span class="keywordflow">case</span> <a class="code" href="../../d4/d9/smbtrsup_8c.html#a52a31">TraceStartStopFile</a> :
01013         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a49">SmbTraceStop</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(StartersFileObject), Component );
01014         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;  <span class="comment">// app closed, so we should shut down</span>
01015         <span class="keywordflow">break</span>;
01016 
01017     <span class="keywordflow">case</span> <a class="code" href="../../d4/d9/smbtrsup_8c.html#a52a32">TraceStartStopNull</a> :
01018         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a49">SmbTraceStop</a>( NULL, Component );
01019         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;  <span class="comment">// someone requested a shut down</span>
01020         <span class="keywordflow">break</span>;
01021 
01022     <span class="keywordflow">default</span> :
01023         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TraceState) = <a class="code" href="../../d4/d9/smbtrsup_8c.html#a52a34">TraceRunning</a>;
01024         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a23">SmbTraceActive</a>[Component] = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01025         <span class="keywordflow">return</span> STATUS_SUCCESS;
01026     }
01027 
01028 errexit:
01029 
01030     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a38">SmbTraceDisconnect</a>( Component );
01031 
01032     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TraceState) = <a class="code" href="../../d4/d9/smbtrsup_8c.html#a52a29">TraceStopped</a>;
01033 
01034     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(StateInterlock) );
01035 
01036     <span class="comment">//</span>
01037     <span class="comment">// return original failure status code, not success of cleanup</span>
01038     <span class="comment">//</span>
01039 
01040     <span class="keywordflow">return</span> status;
01041 
01042 } <span class="comment">// SmbTraceStart</span>

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a49" doxytag="smbtrsup.c::SmbTraceStop" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS SmbTraceStop           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SMBTRACE_COMPONENT&nbsp;</td>
          <td class="mdname" nowrap> <em>Component</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01050">1050</a> of file <a class="el" href="../../d5/d8/smbtrsup_8c-source.html">smbtrsup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02475">ExAcquireResourceExclusive</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00151">ID</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00166">KeAttachProcess()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00405">KeDetachProcess()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07065">MmUnlockPagableImageSection()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00333">SmbTraceActive</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00337">SmbTraceDiscardableCodeHandle</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00340">SmbTraceDiscardableDataHandle</a>, <a class="el" href="../../d4/d9/smbtrsup_8c.html#a52a33">TraceAppWaiting</a>, <a class="el" href="../../d4/d9/smbtrsup_8c.html#a52a34">TraceRunning</a>, <a class="el" href="../../d4/d9/smbtrsup_8c.html#a52a30">TraceStarting</a>, <a class="el" href="../../d4/d9/smbtrsup_8c.html#a52a31">TraceStartStopFile</a>, <a class="el" href="../../d4/d9/smbtrsup_8c.html#a52a32">TraceStartStopNull</a>, <a class="el" href="../../d4/d9/smbtrsup_8c.html#a52a29">TraceStopped</a>, <a class="el" href="../../d4/d9/smbtrsup_8c.html#a52a35">TraceStopping</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00042">TrPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d4/d9/ke_8h.html#a407a204">UserRequest</a>.
<p>
Referenced by <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00551">SmbTraceStart()</a>.
<p>
<pre class="fragment"><div>01057                    :
01058 
01059     This routine stops tracing in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> server/redirector.  If no
01060     FileObject <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> provided, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SmbTrace application <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> stopped.
01061     If a FileObject <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> provided, SmbTrace <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> stopped <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01062     FileObject refers to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> one who started <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
01063 
01064 Arguments:
01065 
01066     FileObject - FileObject of a process that terminated.  If <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>'s <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process
01067                  that requested SmbTracing, we shut down automatically.
01068 
01069     Component - Context from which we're called: server or redirector
01070 
01071 Return Value:
01072 
01073     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - result of operation.  Possible results are:
01074         STATUS_SUCCESS - SmbTrace was stopped
01075         STATUS_UNSUCCESSFUL - SmbTrace was not stopped because <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01076             provided FileObject did not refer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SmbTrace starter
01077             or because SmbTrace was not running.
01078 
01079 --*/
01080 
01081 {
01082     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01083 
01084     <span class="comment">//</span>
01085     <span class="comment">// If we haven't been initialized, there's nothing to stop.  (And no</span>
01086     <span class="comment">// resource to acquire!)</span>
01087     <span class="comment">//</span>
01088 
01089     <span class="keywordflow">if</span> ( !<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(InstanceInitialized) ) {
01090         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
01091     }
01092 
01093     <span class="comment">//</span>
01094     <span class="comment">// If it's not the FileObject that started SmbTrace, we don't care.</span>
01095     <span class="comment">// From then on, if ARGUMENT_PRESENT(FileObject) it's the right one.</span>
01096     <span class="comment">//</span>
01097 
01098     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(FileObject) &amp;&amp;
01099          FileObject != <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(StartersFileObject)
01100     ) {
01101        <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
01102     }
01103 
01104     <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(StateInterlock), TRUE );
01105 
01106     <span class="comment">//</span>
01107     <span class="comment">// Depending on the current state of SmbTrace and whether this is</span>
01108     <span class="comment">// a FileObject or unconditional shutdown request, we do different</span>
01109     <span class="comment">// things.  It is always clear at this point, though, that</span>
01110     <span class="comment">// SmbTraceActive should be set to FALSE.</span>
01111     <span class="comment">//</span>
01112 
01113     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a23">SmbTraceActive</a>[Component] = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01114 
01115     <span class="keywordflow">switch</span> ( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TraceState) ) {
01116     <span class="keywordflow">case</span> <a class="code" href="../../d4/d9/smbtrsup_8c.html#a52a29">TraceStopped</a> :
01117     <span class="keywordflow">case</span> <a class="code" href="../../d4/d9/smbtrsup_8c.html#a52a35">TraceStopping</a> :
01118     <span class="keywordflow">case</span> <a class="code" href="../../d4/d9/smbtrsup_8c.html#a52a31">TraceStartStopFile</a> :
01119     <span class="keywordflow">case</span> <a class="code" href="../../d4/d9/smbtrsup_8c.html#a52a32">TraceStartStopNull</a> :
01120 
01121         <span class="comment">// if we're not running or already in a mode where we know we'll</span>
01122         <span class="comment">// soon be shut down, ignore the request.</span>
01123         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(StateInterlock) );
01124         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
01125         <span class="keywordflow">break</span>;
01126 
01127     <span class="keywordflow">case</span> <a class="code" href="../../d4/d9/smbtrsup_8c.html#a52a30">TraceStarting</a> :
01128 
01129         <span class="comment">// inform starting SmbTrace that it should shut down immediately</span>
01130         <span class="comment">// upon finishing initialization.  It needs to know whether this</span>
01131         <span class="comment">// is a FileObject or unconditional shutdown request.</span>
01132 
01133         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TraceState) = ARGUMENT_PRESENT(FileObject)
01134                        ? <a class="code" href="../../d4/d9/smbtrsup_8c.html#a52a31">TraceStartStopFile</a>
01135                        : <a class="code" href="../../d4/d9/smbtrsup_8c.html#a52a32">TraceStartStopNull</a>;
01136         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(StateInterlock) );
01137         <span class="keywordflow">return</span> STATUS_SUCCESS;
01138         <span class="keywordflow">break</span>;
01139 
01140     <span class="keywordflow">case</span> <a class="code" href="../../d4/d9/smbtrsup_8c.html#a52a33">TraceAppWaiting</a> :
01141 
01142         <span class="comment">// we're waiting for the application to die already, so ignore</span>
01143         <span class="comment">// new unconditional requests.  But FileObject requests are</span>
01144         <span class="comment">// welcomed.  We cause the SmbTrace thread to kill itself.</span>
01145         <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(FileObject) ) {
01146             <span class="keywordflow">break</span>;  <span class="comment">// thread kill code follows switch</span>
01147         } <span class="keywordflow">else</span> {
01148             <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(StateInterlock) );
01149             <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
01150         }
01151         <span class="keywordflow">break</span>;
01152 
01153     <span class="keywordflow">case</span> <a class="code" href="../../d4/d9/smbtrsup_8c.html#a52a34">TraceRunning</a> :
01154 
01155         <span class="comment">// if it's a FileObject request, the app is dead, so we cause</span>
01156         <span class="comment">// the SmbTrace thread to kill itself.  Otherwise, we need to</span>
01157         <span class="comment">// signal the app to stop and return.  When the app is gone, we</span>
01158         <span class="comment">// will be called again; this time with a FileObject.</span>
01159 
01160         <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(FileObject) ) {
01161             <span class="keywordflow">break</span>;  <span class="comment">// thread kill code follows switch</span>
01162         } <span class="keywordflow">else</span> {
01163             <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(AppTerminationEvent), 2, FALSE );
01164             <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TraceState) = <a class="code" href="../../d4/d9/smbtrsup_8c.html#a52a33">TraceAppWaiting</a>;
01165             <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(StateInterlock) );
01166             <span class="keywordflow">return</span> STATUS_SUCCESS;
01167         }
01168 
01169         <span class="keywordflow">break</span>;
01170 
01171     <span class="keywordflow">default</span> :
01172         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!<span class="stringliteral">"SmbTraceStop: invalid TraceState"</span>);
01173         <span class="keywordflow">break</span>;
01174     }
01175 
01176     <span class="comment">//</span>
01177     <span class="comment">// We reach here from within the switch only in the case where</span>
01178     <span class="comment">// we actually want to kill the SmbTrace thread.  Signal it to</span>
01179     <span class="comment">// wake up, and wait until it terminates.  Signal DoneSmbEvent</span>
01180     <span class="comment">// in case it is currently waiting for the application to signal</span>
01181     <span class="comment">// it in slow mode.</span>
01182     <span class="comment">//</span>
01183 
01184     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(StartersFileObject) = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01185 
01186     <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(SingleSmbMode)) {
01187 
01188         BOOLEAN ProcessAttached = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01189 
01190         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() != <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(FspProcess)) {
01191             <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a>(<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(FspProcess));
01192             ProcessAttached = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01193         }
01194 
01195         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>(( <span class="stringliteral">"%s!SmbTraceStop: Signal DoneSmbEvent, handle %x, process %x.\n"</span>,
01196                     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName), <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(DoneSmbEvent), <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()));
01197         ZwSetEvent( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(DoneSmbEvent), NULL );
01198 
01199         <span class="keywordflow">if</span> (ProcessAttached) {
01200             <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
01201         }
01202 
01203     }
01204 
01205     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>(( <span class="stringliteral">"%s!SmbTraceStop: Signal Termination Event.\n"</span>, <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName) ));
01206     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TraceState) = <a class="code" href="../../d4/d9/smbtrsup_8c.html#a52a35">TraceStopping</a>;
01207     <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TerminationEvent), 2, FALSE );
01208 
01209     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(StateInterlock) );
01210 
01211     <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(
01212         &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TerminatedEvent),
01213         UserRequest,
01214         KernelMode,
01215         FALSE,
01216         NULL
01217         );
01218 
01219     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>(( <span class="stringliteral">"%s!SmbTraceStop: Terminated Event is set.\n"</span>, <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName) ));
01220     <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(StateInterlock), TRUE );
01221 
01222     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TraceState) = <a class="code" href="../../d4/d9/smbtrsup_8c.html#a52a29">TraceStopped</a>;
01223 
01224     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(StateInterlock) );
01225 
01226     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>(( <span class="stringliteral">"%s!SmbTraceStop: SmbTrace stopped.\n"</span>, <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName) ));
01227 
01228     <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(SmbTraceDiscardableCodeHandle);
01229 
01230     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a25">SmbTraceDiscardableCodeHandle</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01231 
01232     <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(SmbTraceDiscardableDataHandle);
01233 
01234     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a26">SmbTraceDiscardableDataHandle</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01235 
01236     <span class="keywordflow">return</span> STATUS_SUCCESS;
01237 
01238 } <span class="comment">// SmbTraceStop</span>

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a47" doxytag="smbtrsup.c::SmbTraceTerminate" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SmbTraceTerminate           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN SMBTRACE_COMPONENT&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Component</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00509">509</a> of file <a class="el" href="../../d5/d8/smbtrsup_8c-source.html">smbtrsup.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l02478">ExDeleteResource</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00151">ID</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
<pre class="fragment"><div>00515                    :
00516 
00517     This routine cleans up <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SmbTrace component-specific instance
00518     globals.  It should be called by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> component when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> component
00519     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> unloaded.
00520 
00521 Arguments:
00522 
00523     Component - Context from which we're called: server or redirector
00524 
00525 Return Value:
00526 
00527     None
00528 
00529 --*/
00530 
00531 {
00532     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00533 
00534     <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(InstanceInitialized) ) {
00535 
00536         <a class="code" href="../../d5/d8/ex_8h.html#a73">ExDeleteResource</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(StateInterlock) );
00537         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(StateInterlock) );
00538 
00539         <a class="code" href="../../d5/d8/ex_8h.html#a73">ExDeleteResource</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(HeapInterlock) );
00540         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(HeapInterlock) );
00541 
00542         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(InstanceInitialized) = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00543     }
00544 
00545     <span class="keywordflow">return</span>;
00546 
00547 } <span class="comment">// SmbTraceTerminate</span>

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a40" doxytag="smbtrsup.c::SmbTraceThreadEntry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SmbTraceThreadEntry           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Context</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l02020">2020</a> of file <a class="el" href="../../d5/d8/smbtrsup_8c-source.html">smbtrsup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00129">_SMBTRACE_QUEUE_ENTRY::Buffer</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00133">_SMBTRACE_QUEUE_ENTRY::BufferNonPaged</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a239">ExInterlockedRemoveHeadList()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00151">ID</a>, <a class="el" href="../../d4/d9/smbtrsup_8c.html#a11">INDEX_WAIT_APPTERMINATIONEVENT</a>, <a class="el" href="../../d4/d9/smbtrsup_8c.html#a12">INDEX_WAIT_NEEDMEMORYEVENT</a>, <a class="el" href="../../d4/d9/smbtrsup_8c.html#a13">INDEX_WAIT_QUEUESEMAPHORE</a>, <a class="el" href="../../d4/d9/smbtrsup_8c.html#a10">INDEX_WAIT_TERMINATIONEVENT</a>, <a class="el" href="../../d2/d5/semphobj_8c-source.html#l00039">KeInitializeSemaphore()</a>, <a class="el" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock()</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00285">KeResetEvent()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00395">KeWaitForMultipleObjects()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00091">LOCK_INC_ID</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d9/smbtrsup_8c.html#a9">NUMBER_OF_BLOCKING_OBJECTS</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d4/d9/smbtrsup_8c.html#a20">PSMBTRACE_QUEUE_ENTRY</a>, <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00546">PsTerminateSystemThread()</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00022">RtlAllocateHeap</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00131">_SMBTRACE_QUEUE_ENTRY::SmbAddress</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00128">_SMBTRACE_QUEUE_ENTRY::SmbLength</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01794">SmbTraceDereferenceHeap()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01949">SmbTraceEmptyQueue()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l02355">SmbTraceFreeMemory()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l02425">SmbTraceToClient()</a>, <a class="el" href="../../d4/d9/smbtrsup_8c.html#a15">STATUS_WAIT_APPTERMINATIONEVENT</a>, <a class="el" href="../../d4/d9/smbtrsup_8c.html#a16">STATUS_WAIT_NEEDMEMORYEVENT</a>, <a class="el" href="../../d4/d9/smbtrsup_8c.html#a17">STATUS_WAIT_QUEUESEMAPHORE</a>, <a class="el" href="../../d4/d9/smbtrsup_8c.html#a14">STATUS_WAIT_TERMINATIONEVENT</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00079">THREAD_WAIT_OBJECTS</a>, <a class="el" href="../../d4/d9/smbtrsup_8c.html#a52a33">TraceAppWaiting</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00042">TrPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d9/ke_8h.html#a407a204">UserRequest</a>, and <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00136">_SMBTRACE_QUEUE_ENTRY::WaitEvent</a>.
<p>
Referenced by <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00551">SmbTraceStart()</a>.
<p>
<pre class="fragment"><div>02026                    :
02027 
02028     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entry point of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SmbTrace thread <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> server/
02029     redirector.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> started by <a class="code" href="../../d4/d9/smbtrsup_8c.html#a48">SmbTraceStart</a>. This thread loops
02030     continuously until <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client SmbTrace dies or another SmbTrace sends
02031     an FsCtl to stop <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> trace.
02032 
02033 Arguments:
02034 
02035     Context - pointer to context block containing component from which
02036               we're called: server or redirector
02037 
02038 Return Value:
02039 
02040     None
02041 
02042 --*/
02043 
02044 <span class="comment">// we wait for termination, work-to-do and need-memory events</span>
02045 <span class="preprocessor">#define NUMBER_OF_BLOCKING_OBJECTS 4</span>
02046 <span class="preprocessor"></span>
02047 <span class="comment">// keep these definitions in sync</span>
02048 
02049 <span class="preprocessor">#define INDEX_WAIT_TERMINATIONEVENT     0</span>
02050 <span class="preprocessor"></span><span class="preprocessor">#define INDEX_WAIT_APPTERMINATIONEVENT  1</span>
02051 <span class="preprocessor"></span><span class="preprocessor">#define INDEX_WAIT_NEEDMEMORYEVENT      2</span>
02052 <span class="preprocessor"></span><span class="preprocessor">#define INDEX_WAIT_QUEUESEMAPHORE       3</span>
02053 <span class="preprocessor"></span>
02054 <span class="preprocessor">#define STATUS_WAIT_TERMINATIONEVENT    STATUS_WAIT_0</span>
02055 <span class="preprocessor"></span><span class="preprocessor">#define STATUS_WAIT_APPTERMINATIONEVENT STATUS_WAIT_1</span>
02056 <span class="preprocessor"></span><span class="preprocessor">#define STATUS_WAIT_NEEDMEMORYEVENT     STATUS_WAIT_2</span>
02057 <span class="preprocessor"></span><span class="preprocessor">#define STATUS_WAIT_QUEUESEMAPHORE      STATUS_WAIT_3</span>
02058 <span class="preprocessor"></span>
02059 {
02060     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02061     PLIST_ENTRY listEntry;
02062     <a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html">PSMBTRACE_QUEUE_ENTRY</a>    queueEntry;
02063     PVOID buffer;
02064     PVOID waitObjects[<a class="code" href="../../d4/d9/smbtrsup_8c.html#a9">NUMBER_OF_BLOCKING_OBJECTS</a>];
02065     SMBTRACE_COMPONENT Component;
02066     BOOLEAN Looping;
02067 
02068 <span class="preprocessor">#if NUMBER_OF_BLOCKING_OBJECTS &gt; THREAD_WAIT_OBJECTS</span>
02069 <span class="preprocessor"></span>    <span class="comment">//</span>
02070     <span class="comment">// If we try to wait on too many objects, we need to allocate</span>
02071     <span class="comment">// our own wait blocks.</span>
02072     <span class="comment">//</span>
02073 
02074     <a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html">KWAIT_BLOCK</a> waitBlocks[<a class="code" href="../../d4/d9/smbtrsup_8c.html#a9">NUMBER_OF_BLOCKING_OBJECTS</a>];
02075 <span class="preprocessor">#endif</span>
02076 <span class="preprocessor"></span>
02077     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02078 
02079     <span class="comment">//</span>
02080     <span class="comment">// Context is really just the component</span>
02081     <span class="comment">//</span>
02082     Component = (SMBTRACE_COMPONENT)(UINT_PTR)Context;
02083 
02084     <span class="comment">//</span>
02085     <span class="comment">// Initialize the queue.</span>
02086     <span class="comment">//</span>
02087 
02088     InitializeListHead(    &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(Queue) );
02089     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>(  &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(QueueInterlock) );
02090     <a class="code" href="../../d1/d6/semphobj_8c.html#a1">KeInitializeSemaphore</a>( &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(QueueSemaphore), 0, 0x7FFFFFFF );
02091 
02092     <span class="comment">//</span>
02093     <span class="comment">// Set up the array of objects to wait on.  We wait (in order)</span>
02094     <span class="comment">// for our termination event, the appliction termination event,</span>
02095     <span class="comment">// a no shared memory event or an SMB request to show up in the</span>
02096     <span class="comment">// SmbTrace queue.</span>
02097     <span class="comment">//</span>
02098 
02099     waitObjects[<a class="code" href="../../d4/d9/smbtrsup_8c.html#a10">INDEX_WAIT_TERMINATIONEVENT</a>]    = &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TerminationEvent);
02100     waitObjects[<a class="code" href="../../d4/d9/smbtrsup_8c.html#a11">INDEX_WAIT_APPTERMINATIONEVENT</a>] = &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(AppTerminationEvent);
02101     waitObjects[<a class="code" href="../../d4/d9/smbtrsup_8c.html#a12">INDEX_WAIT_NEEDMEMORYEVENT</a>]     = &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(NeedMemoryEvent);
02102     waitObjects[<a class="code" href="../../d4/d9/smbtrsup_8c.html#a13">INDEX_WAIT_QUEUESEMAPHORE</a>]      = &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(QueueSemaphore);
02103 
02104     <span class="comment">//</span>
02105     <span class="comment">// No SMBs have been lost yet, and this thread is the first user</span>
02106     <span class="comment">// of the shared memory.  It's also a special user in that it gets</span>
02107     <span class="comment">// access before TraceState == TraceRunning, a requirement for all</span>
02108     <span class="comment">// subsequent referencers.</span>
02109     <span class="comment">//</span>
02110 
02111     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(SmbsLost) = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
02112     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(HeapReferenceCount) = 1;
02113 
02114     <span class="comment">//</span>
02115     <span class="comment">// Signal to the FSP that we are ready to start capturing SMBs.</span>
02116     <span class="comment">//</span>
02117 
02118     <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ActiveEvent), 0, FALSE );
02119 
02120     <span class="comment">//</span>
02121     <span class="comment">// Main loop, executed until the thread is terminated.</span>
02122     <span class="comment">//</span>
02123 
02124     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>(( <span class="stringliteral">"%s!SmbTraceThread: Tracing started.\n"</span>, <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName) ));
02125 
02126     Looping = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02127     <span class="keywordflow">while</span>( Looping ) {
02128 
02129         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>(( <span class="stringliteral">"%s!SmbTraceThread: WaitForMultiple.\n"</span>, <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName) ));
02130         status = <a class="code" href="../../d1/d7/wait_8c.html#a3">KeWaitForMultipleObjects</a>(
02131                     NUMBER_OF_BLOCKING_OBJECTS,
02132                     &amp;waitObjects[0],
02133                     WaitAny,
02134                     UserRequest,
02135                     KernelMode,
02136                     FALSE,
02137                     NULL,
02138 #<span class="keywordflow">if</span> NUMBER_OF_BLOCKING_OBJECTS &gt; THREAD_WAIT_OBJECTS
02139                     &amp;waitBlocks[0]
02140 #<span class="keywordflow">else</span>
02141                     NULL
02142 #endif
02143                     );
02144 
02145         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
02146             <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>((
02147                 <span class="stringliteral">"%s!SmbTraceThreadEntry: KeWaitForMultipleObjectsfailed: %X\n"</span>,
02148                 <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName), status ));
02149         } <span class="keywordflow">else</span> {
02150             <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>((
02151                 <span class="stringliteral">"%s!SmbTraceThreadEntry: %lx\n"</span>,
02152                 <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName), status ));
02153         }
02154 
02155         <span class="keywordflow">switch</span>( status ) {
02156 
02157         <span class="keywordflow">case</span> <a class="code" href="../../d4/d9/smbtrsup_8c.html#a14">STATUS_WAIT_TERMINATIONEVENT</a>:
02158 
02159             <span class="comment">//</span>
02160             <span class="comment">// Stop looping, and then proceed to clean up and die.</span>
02161             <span class="comment">//</span>
02162 
02163             Looping = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02164             <span class="keywordflow">break</span>;
02165 
02166         <span class="keywordflow">case</span> <a class="code" href="../../d4/d9/smbtrsup_8c.html#a15">STATUS_WAIT_APPTERMINATIONEVENT</a>:
02167 
02168             <span class="comment">//  Turn off the event so we don't go in a tight loop</span>
02169             <a class="code" href="../../d2/d8/eventobj_8c.html#a7">KeResetEvent</a>(&amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(AppTerminationEvent));
02170 
02171             <span class="comment">//</span>
02172             <span class="comment">// Inform the app that it is time to die.  The NULL SMB</span>
02173             <span class="comment">// sent here may not be the next to be processed by the</span>
02174             <span class="comment">// app, but the ApplicationStop bit will be detected</span>
02175             <span class="comment">// immediately.</span>
02176             <span class="comment">//</span>
02177 
02178             <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TableHeader)-&gt;ApplicationStop = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02179             <a class="code" href="../../d4/d9/smbtrsup_8c.html#a42">SmbTraceToClient</a>( NULL, 0, NULL, Component );
02180 
02181             <span class="keywordflow">break</span>;
02182 
02183         <span class="keywordflow">case</span> <a class="code" href="../../d4/d9/smbtrsup_8c.html#a16">STATUS_WAIT_NEEDMEMORYEVENT</a>:
02184 
02185             <span class="comment">//  Turn off the event so we don't go in a loop.</span>
02186             <a class="code" href="../../d2/d8/eventobj_8c.html#a7">KeResetEvent</a>(&amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(NeedMemoryEvent));
02187             <span class="comment">//</span>
02188             <span class="comment">// Do a garbage collection, freeing all memory that is</span>
02189             <span class="comment">// allocated in the shared memory but that has been read</span>
02190             <span class="comment">// by the client.</span>
02191             <span class="comment">//</span>
02192 
02193             <a class="code" href="../../d4/d9/smbtrsup_8c.html#a41">SmbTraceFreeMemory</a>( Component );
02194 
02195             <span class="keywordflow">break</span>;
02196 
02197         <span class="keywordflow">case</span> <a class="code" href="../../d4/d9/smbtrsup_8c.html#a17">STATUS_WAIT_QUEUESEMAPHORE</a>:
02198 
02199             <span class="comment">//</span>
02200             <span class="comment">// If any get through once we've gone into AppWaiting</span>
02201             <span class="comment">// state, don't bother sending them on, they're not</span>
02202             <span class="comment">// going to get processed.</span>
02203             <span class="comment">//</span>
02204 
02205             <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TraceState) == <a class="code" href="../../d4/d9/smbtrsup_8c.html#a52a33">TraceAppWaiting</a> ) {
02206                 <a class="code" href="../../d4/d9/smbtrsup_8c.html#a39">SmbTraceEmptyQueue</a>( Component );
02207                 <span class="keywordflow">break</span>;
02208             }
02209 
02210             <span class="comment">//</span>
02211             <span class="comment">// Remove the first element in the our queue.  A</span>
02212             <span class="comment">// work item is represented by our header followed by</span>
02213             <span class="comment">// an SMB. We must free the entry after we are done</span>
02214             <span class="comment">// with it.</span>
02215             <span class="comment">//</span>
02216 
02217             listEntry = <a class="code" href="../../d5/d8/ex_8h.html#a239">ExInterlockedRemoveHeadList</a>(
02218                             &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(Queue),
02219                             &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(QueueInterlock)
02220                             );
02221 
02222             <span class="keywordflow">if</span> ( listEntry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
02223 
02224                 <span class="comment">//</span>
02225                 <span class="comment">// Get the address of the queue entry.</span>
02226                 <span class="comment">//</span>
02227 
02228                 queueEntry = CONTAINING_RECORD(
02229                                   listEntry,
02230                                   <a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html">SMBTRACE_QUEUE_ENTRY</a>,
02231                                   ListEntry
02232                                   );
02233 
02234                 <span class="comment">//</span>
02235                 <span class="comment">// If the data is in non-paged pool, move it to shared</span>
02236                 <span class="comment">// memory and free the non-paged pool before passing</span>
02237                 <span class="comment">// the SMB to the client.  Note that in this case,</span>
02238                 <span class="comment">// there's no need to signal anyone.  They ain't waiting.</span>
02239                 <span class="comment">//</span>
02240 
02241                 <span class="keywordflow">if</span> ( queueEntry-&gt;<a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o4">BufferNonPaged</a> ) {
02242 
02243                     <span class="comment">//</span>
02244                     <span class="comment">// Server never uses non-paged pool.</span>
02245                     <span class="comment">//</span>
02246 
02247                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Component != SMBTRACE_SERVER );
02248 
02249                     buffer = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(PortMemoryHeap), 0,
02250                                               queueEntry-&gt;<a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o1">SmbLength</a> );
02251 
02252                     <span class="keywordflow">if</span> ( buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
02253 
02254                         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a5">LOCK_INC_ID</a>(SmbsLost);
02255 
02256                         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( queueEntry-&gt;<a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o2">Buffer</a> );
02257                         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( queueEntry );
02258 
02259                         <span class="keywordflow">break</span>;
02260 
02261                     }
02262 
02263                     RtlCopyMemory( buffer, queueEntry-&gt;<a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o2">Buffer</a>,
02264                                    queueEntry-&gt;<a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o1">SmbLength</a> );
02265 
02266                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( queueEntry-&gt;<a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o2">Buffer</a> );
02267 
02268                     <span class="comment">//</span>
02269                     <span class="comment">// Send it off.  Because the original SMB is long</span>
02270                     <span class="comment">// dead, we don't pass its real address along (not</span>
02271                     <span class="comment">// that we have it, anyway.)</span>
02272                     <span class="comment">//</span>
02273 
02274                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( queueEntry-&gt;<a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o3">SmbAddress</a> == NULL );
02275 
02276                     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a42">SmbTraceToClient</a>(
02277                             buffer,
02278                             queueEntry-&gt;<a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o1">SmbLength</a>,
02279                             NULL,
02280                             Component
02281                             );
02282 
02283                 } <span class="keywordflow">else</span> {
02284 
02285                     <span class="comment">//</span>
02286                     <span class="comment">// Enter the SMB into the table and send it to the</span>
02287                     <span class="comment">// client. Can block in slow mode.  When it does so, we'll</span>
02288                     <span class="comment">// signal the applicable thread.</span>
02289                     <span class="comment">//</span>
02290 
02291                     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a42">SmbTraceToClient</a>(
02292                             queueEntry-&gt;<a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o2">Buffer</a>,
02293                             queueEntry-&gt;<a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o1">SmbLength</a>,
02294                             queueEntry-&gt;<a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o3">SmbAddress</a>,
02295                             Component
02296                             );
02297 
02298                     <span class="keywordflow">if</span> ( queueEntry-&gt;<a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o5">WaitEvent</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
02299                         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( queueEntry-&gt;<a class="code" href="../../d4/d4/struct__SMBTRACE__QUEUE__ENTRY.html#o5">WaitEvent</a>, 0, FALSE );
02300                     }
02301                 }
02302 
02303                 <span class="comment">//</span>
02304                 <span class="comment">// Now, we must free the queue entry.</span>
02305                 <span class="comment">//</span>
02306 
02307                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( queueEntry );
02308 
02309             }
02310 
02311             <span class="keywordflow">break</span>;
02312 
02313         <span class="keywordflow">default</span>:
02314             <span class="keywordflow">break</span>;
02315         }
02316 
02317     }
02318 
02319     <span class="comment">//</span>
02320     <span class="comment">// Clean up!</span>
02321     <span class="comment">//</span>
02322     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>(( <span class="stringliteral">"%s!SmbTraceThread: Tracing clean up.\n"</span>, <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName) ));
02323 
02324     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a37">SmbTraceDereferenceHeap</a>( Component );
02325 
02326     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a39">SmbTraceEmptyQueue</a>( Component );
02327 
02328     <span class="comment">//</span>
02329     <span class="comment">// Signal to SmbTraceStop that we're dying.</span>
02330     <span class="comment">//</span>
02331 
02332     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>(( <span class="stringliteral">"%s!SmbTraceThread: Tracing terminated.\n"</span>, <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName) ));
02333 
02334     <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( &amp;<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TerminatedEvent), 0, FALSE );
02335 
02336     <span class="comment">//</span>
02337     <span class="comment">// Kill this thread.</span>
02338     <span class="comment">//</span>
02339 
02340     status = <a class="code" href="../../d8/d0/psdelete_8c.html#a7">PsTerminateSystemThread</a>( STATUS_SUCCESS );
02341 
02342     <span class="comment">// Shouldn't get here</span>
02343     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>((
02344         <span class="stringliteral">"%s!SmbTraceThreadEntry: PsTerminateSystemThread() failed: %X\n"</span>,
02345         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName), status ));
02346 
02347 } <span class="comment">// SmbTraceThreadEntry</span>

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a42" doxytag="smbtrsup.c::SmbTraceToClient" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SmbTraceToClient           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Smb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN CLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SmbLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>SmbAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SMBTRACE_COMPONENT&nbsp;</td>
          <td class="mdname" nowrap> <em>Component</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l02425">2425</a> of file <a class="el" href="../../d5/d8/smbtrsup_8c-source.html">smbtrsup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00151">ID</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00285">KeResetEvent()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00091">LOCK_INC_ID</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00098">LOCK_ZERO_ID</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00023">RtlFreeHeap</a>, <a class="el" href="../../d4/d9/smbtrsup_8c.html#a52a34">TraceRunning</a>, and <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00042">TrPrint</a>.
<p>
Referenced by <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l02020">SmbTraceThreadEntry()</a>.
<p>
<pre class="fragment"><div>02434                    :
02435 
02436     Enter an SMB already found in shared memory into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> table.  Set
02437     an event <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client.  If there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> no table space, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SMB <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
02438     not saved.  If in slow mode, wait <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client to finish with
02439     and then free <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> memory occupied by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SMB.
02440 
02441 Arguments:
02442 
02443     Smb - a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SMB (which is ALREADY in shared memory).
02444           Can be <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, indicating no <span class="keyword">new</span> SMB <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be added, but <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02445           application <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be signalled anyway.
02446 
02447     SmbLength - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SMB.
02448 
02449     SmbAddress - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> real SMB, not in shared memory.
02450 
02451     Component - Context from which we're called: server or redirector
02452 
02453 Return Value:
02454 
02455     None
02456 
02457 --*/
02458 
02459 {
02460     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02461     PVOID    buffer;
02462     PSMBTRACE_TABLE_ENTRY    tableEntry;
02463     ULONG    tableIndex;
02464 
02465     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02466 
02467     <span class="comment">//</span>
02468     <span class="comment">//  Reset DoneSmbEvent so we can determine when the request has been processed</span>
02469     <span class="comment">//</span>
02470 
02471     <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(SingleSmbMode) ) {
02472         <a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> DoneEvent;
02473 
02474         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>(( <span class="stringliteral">"%s!SmbTraceToClient: Reset DoneSmbEvent, handle %x, process %x.\n"</span>,
02475                     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName), <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(DoneSmbEvent), <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()));
02476 
02477         status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(DoneSmbEvent),
02478                                             EVENT_MODIFY_STATE,
02479                                             NULL,
02480                                             KernelMode,
02481                                             (PVOID *)&amp;DoneEvent,
02482                                             NULL
02483                                             );
02484 
02485         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) );
02486 
02487         <a class="code" href="../../d2/d8/eventobj_8c.html#a7">KeResetEvent</a>(DoneEvent);
02488 
02489         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(DoneEvent);
02490     }
02491 
02492     <span class="keywordflow">if</span> (Smb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02493 
02494         <span class="comment">//</span>
02495         <span class="comment">// See if there is room in the table for a pointer to our SMB.</span>
02496         <span class="comment">//</span>
02497 
02498         <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TableHeader)-&gt;NextFree == <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TableHeader)-&gt;HighestConsumed ) {
02499             <span class="comment">// Tough luck. No memory in the table, this SMB is lost.</span>
02500             <a class="code" href="../../d4/d9/smbtrsup_8c.html#a5">LOCK_INC_ID</a>( SmbsLost );
02501             <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(PortMemoryHeap), 0, Smb );
02502             <span class="keywordflow">return</span>;
02503         }
02504 
02505         tableIndex = <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TableHeader)-&gt;NextFree;
02506 
02507         tableEntry = <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(Table) + tableIndex;
02508 
02509         <span class="comment">//</span>
02510         <span class="comment">// Record the number of SMBs that were lost before this one and</span>
02511         <span class="comment">// (maybe) zero the count for the next one.</span>
02512         <span class="comment">//</span>
02513 
02514         tableEntry-&gt;NumberMissed = <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(SmbsLost);
02515 
02516         <span class="keywordflow">if</span> ( tableEntry-&gt;NumberMissed != 0 ) {
02517             <a class="code" href="../../d4/d9/smbtrsup_8c.html#a6">LOCK_ZERO_ID</a>(SmbsLost);
02518         }
02519 
02520         <span class="comment">//</span>
02521         <span class="comment">// Check if this table entry has been used but its memory has not</span>
02522         <span class="comment">// been freed yet. If so, free it.</span>
02523         <span class="comment">//</span>
02524         <span class="keywordflow">if</span> ( tableEntry-&gt;BufferOffset != 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a> ) {
02525 
02526             buffer = (PVOID)( (ULONG_PTR)tableEntry-&gt;BufferOffset
02527                         + (ULONG_PTR)<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(PortMemoryBase) );
02528 
02529             <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(PortMemoryHeap), 0, buffer);
02530             tableEntry-&gt;BufferOffset = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
02531         }
02532 
02533         <span class="comment">//</span>
02534         <span class="comment">// Record the location and size of this SMB in the table.</span>
02535         <span class="comment">//</span>
02536 
02537         tableEntry-&gt;BufferOffset = (ULONG)((ULONG_PTR)Smb - (ULONG_PTR)<a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(PortMemoryBase));
02538         tableEntry-&gt;SmbLength = SmbLength;
02539 
02540         <span class="comment">//</span>
02541         <span class="comment">// Record the real address of the actual SMB (i.e. not the shared</span>
02542         <span class="comment">// memory copy) if it's available.</span>
02543         <span class="comment">//</span>
02544 
02545         tableEntry-&gt;SmbAddress = SmbAddress;
02546 
02547         <span class="comment">//</span>
02548         <span class="comment">// Increment the Next Free counter.</span>
02549         <span class="comment">//</span>
02550 
02551         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TableHeader)-&gt;NextFree = (tableIndex + 1) % <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TableSize);
02552 
02553     }
02554 
02555 
02556     <span class="comment">//</span>
02557     <span class="comment">// Unlock the client so it will process this new SMB.</span>
02558     <span class="comment">//</span>
02559 
02560     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>(( <span class="stringliteral">"%s!SmbTraceToClient: Set NewSmbEvent.\n"</span>, <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName) ));
02561     status = ZwSetEvent( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(NewSmbEvent), NULL );
02562 
02563     <span class="comment">//</span>
02564     <span class="comment">//  When stopping the trace we set TraceState to TraceStopping and then</span>
02565     <span class="comment">//  DoneSmbEvent. This prevents this routine from blocking indefinitely</span>
02566     <span class="comment">//  because it Resets DoneSmbEvent processes the Smb and then checks TraceState</span>
02567     <span class="comment">//  before blocking.</span>
02568     <span class="comment">//</span>
02569     <span class="keywordflow">if</span> (( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(SingleSmbMode) ) &amp;&amp;
02570         ( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(TraceState) == <a class="code" href="../../d4/d9/smbtrsup_8c.html#a52a34">TraceRunning</a> )) {
02571 
02572         <span class="comment">//</span>
02573         <span class="comment">// Wait for the app to acknowledge that the SMB has been</span>
02574         <span class="comment">// processed.</span>
02575         <span class="comment">//</span>
02576 
02577         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>(( <span class="stringliteral">"%s!SmbTraceToClient: Waiting for DoneSmbEvent, handle %x, process %x.\n"</span>,
02578                     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName), <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(DoneSmbEvent), <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()));
02579         status = ZwWaitForSingleObject(
02580                     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(DoneSmbEvent),
02581                     FALSE,
02582                     NULL
02583                     );
02584 
02585         <a class="code" href="../../d4/d9/smbtrsup_8c.html#a1">TrPrint</a>(( <span class="stringliteral">"%s!SmbTraceToClient: DoneSmbEvent is set, handle %x, process %x.\n"</span>,
02586                     <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(ComponentName), <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(DoneSmbEvent), <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()));
02587         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) );
02588 
02589         <span class="keywordflow">if</span> (Smb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02590 
02591             tableEntry-&gt;BufferOffset = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
02592             <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>(PortMemoryHeap), 0, Smb);
02593         }
02594 
02595     }
02596 
02597     <span class="keywordflow">return</span>;
02598 
02599 } <span class="comment">// SmbTraceToClient</span>

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a23" doxytag="smbtrsup.c::SmbTraceActive" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d4/d9/smbtrsup_8c.html#a23">SmbTraceActive</a>[] = {FALSE, FALSE}          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00333">333</a> of file <a class="el" href="../../d5/d8/smbtrsup_8c-source.html">smbtrsup.c</a>.
<p>
Referenced by <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01456">SmbTraceCompleteRdr()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01242">SmbTraceCompleteSrv()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00551">SmbTraceStart()</a>, and <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01050">SmbTraceStop()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="smbtrsup.c::SmbTraceData" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d4/d3/struct__INSTANCE__DATA.html">INSTANCE_DATA</a> <a class="el" href="../../d4/d9/smbtrsup_8c.html#a22">SmbTraceData</a>[]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00278">278</a> of file <a class="el" href="../../d5/d8/smbtrsup_8c-source.html">smbtrsup.c</a>.
<p>
Referenced by <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00551">SmbTraceStart()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="smbtrsup.c::SmbTraceDiscardableCodeHandle" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> HANDLE <a class="el" href="../../d4/d9/smbtrsup_8c.html#a25">SmbTraceDiscardableCodeHandle</a> = 0          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00337">337</a> of file <a class="el" href="../../d5/d8/smbtrsup_8c-source.html">smbtrsup.c</a>.
<p>
Referenced by <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00551">SmbTraceStart()</a>, and <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01050">SmbTraceStop()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="smbtrsup.c::SmbTraceDiscardableDataHandle" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> HANDLE <a class="el" href="../../d4/d9/smbtrsup_8c.html#a26">SmbTraceDiscardableDataHandle</a> = 0          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00340">340</a> of file <a class="el" href="../../d5/d8/smbtrsup_8c-source.html">smbtrsup.c</a>.
<p>
Referenced by <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00551">SmbTraceStart()</a>, and <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01050">SmbTraceStop()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="smbtrsup.c::SmbTraceTransitioning" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d4/d9/smbtrsup_8c.html#a24">SmbTraceTransitioning</a>[] = {FALSE, FALSE}          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00334">334</a> of file <a class="el" href="../../d5/d8/smbtrsup_8c-source.html">smbtrsup.c</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:39 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
