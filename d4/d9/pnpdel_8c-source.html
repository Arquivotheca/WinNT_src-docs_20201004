<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: pnpdel.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>pnpdel.c</h1><a href="../../d3/d0/pnpdel_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1996 Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    enum.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains routines to perform device removal</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Robert B. Nelson (RobertN) Jun 1, 1998.</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:</span>
00018 <span class="comment"></span>
00019 <span class="comment">--*/</span>
00020 
00021 <span class="preprocessor">#include "<a class="code" href="../../d0/d6/iop_8h.html">iop.h</a>"</span>
00022 <span class="preprocessor">#include "wdmguid.h"</span>
00023 
00024 <span class="preprocessor">#ifdef POOL_TAGGING</span>
00025 <span class="preprocessor"></span><span class="preprocessor">#undef ExAllocatePool</span>
00026 <span class="preprocessor"></span><span class="preprocessor">#define ExAllocatePool(a,b) ExAllocatePoolWithTag(a,b,'edpP')</span>
00027 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00028 <span class="preprocessor"></span>
00029 <span class="comment">//</span>
00030 <span class="comment">// Kernel mode PNP specific routines.</span>
00031 <span class="comment">//</span>
00032 
00033 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00034 <a class="code" href="../../d3/d0/pnpdel_8c.html#a1">IopCancelPendingEject</a>(
00035     IN <a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html">PPENDING_RELATIONS_LIST_ENTRY</a> EjectEntry
00036     );
00037 
00038 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00039 <a class="code" href="../../d3/d0/pnpdel_8c.html#a2">IopDelayedRemoveWorker</a>(
00040     IN PVOID Context
00041     );
00042 
00043 BOOLEAN
00044 <a class="code" href="../../d3/d0/pnpdel_8c.html#a3">IopDeleteLockedDeviceNode</a>(
00045     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode,
00046     IN ULONG IrpCode,
00047     IN <a class="code" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a> RelationsList,
00048     IN BOOLEAN IsKernelInitiated,
00049     IN ULONG Problem
00050     );
00051 
00052 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00053 <a class="code" href="../../d3/d0/pnpdel_8c.html#a4">IopProcessRelation</a>(
00054     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject,
00055     IN PLUGPLAY_DEVICE_DELETE_TYPE OperationCode,
00056     IN <a class="code" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a> RelationsList,
00057     IN BOOLEAN IsKernelInitiated,
00058     IN BOOLEAN IsDirectDescendant
00059     );
00060 
00061 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00062 <a class="code" href="../../d3/d0/pnpdel_8c.html#a5">IopUnloadAttachedDriver</a>(
00063     IN <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject
00064     );
00065 
<a name="l00066"></a><a class="code" href="../../d3/d0/pnpdel_8c.html#a0">00066</a> <a class="code" href="../../d7/d9/struct__WORK__QUEUE__ITEM.html">WORK_QUEUE_ITEM</a> <a class="code" href="../../d3/d0/pnpdel_8c.html#a0">IopDeviceRemovalWorkItem</a>;
00067 
00068 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00069 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopChainDereferenceComplete)</span>
00070 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopDelayedRemoveWorker)</span>
00071 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopDeleteLockedDeviceNode)</span>
00072 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopDeleteLockedDeviceNodes)</span>
00073 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopLockDeviceRemovalRelations)</span>
00074 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopProcessCompletedEject)</span>
00075 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopProcessRelation)</span>
00076 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopQueuePendingEject)</span>
00077 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopQueuePendingSurpriseRemoval)</span>
00078 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopRequestDeviceRemoval)</span>
00079 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopUnloadAttachedDriver)</span>
00080 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopUnlockDeviceRemovalRelations)</span>
00081 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00082 <span class="preprocessor"></span>
00083 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00084"></a><a class="code" href="../../d9/d0/pnpiop_8h.html#a316">00084</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a316">IopChainDereferenceComplete</a>(
00085     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> PhysicalDeviceObject
00086     )
00087 
00088 <span class="comment">/*++</span>
00089 <span class="comment"></span>
00090 <span class="comment">Routine Description:</span>
00091 <span class="comment"></span>
00092 <span class="comment">    This routine is invoked when the reference count on a PDO and all its</span>
00093 <span class="comment">    attached devices transitions to a zero.  It tags the devnode as ready for</span>
00094 <span class="comment">    removal.  If all the devnodes are tagged then IopDelayedRemoveWorker is</span>
00095 <span class="comment">    called to actually send the remove IRPs.</span>
00096 <span class="comment"></span>
00097 <span class="comment">Arguments:</span>
00098 <span class="comment"></span>
00099 <span class="comment">    PhysicalDeviceObject - Supplies a pointer to the PDO whose references just</span>
00100 <span class="comment">        went to zero.</span>
00101 <span class="comment"></span>
00102 <span class="comment">Return Value:</span>
00103 <span class="comment"></span>
00104 <span class="comment">    None.</span>
00105 <span class="comment"></span>
00106 <span class="comment">--*/</span>
00107 
00108 {
00109     <a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html">PPENDING_RELATIONS_LIST_ENTRY</a>   entry;
00110     PLIST_ENTRY                     link;
00111     ULONG                           count;
00112     ULONG                           taggedCount;
00113     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                        status;
00114 
00115     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00116 
00117     <span class="comment">//</span>
00118     <span class="comment">// Lock the whole device node tree so no one can touch the tree.</span>
00119     <span class="comment">//</span>
00120 
00121     <a class="code" href="../../d9/d0/pnpiop_8h.html#a98">IopAcquireDeviceTreeLock</a>();
00122 
00123     <span class="comment">//</span>
00124     <span class="comment">// Find the relation list this devnode is a member of.</span>
00125     <span class="comment">//</span>
00126     <span class="keywordflow">for</span> (link = <a class="code" href="../../d1/d0/pnpdata_8c.html#a27">IopPendingSurpriseRemovals</a>.Flink;
00127          link != &amp;<a class="code" href="../../d1/d0/pnpdata_8c.html#a27">IopPendingSurpriseRemovals</a>;
00128          link = link-&gt;Flink) {
00129 
00130         entry = CONTAINING_RECORD(link, <a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html">PENDING_RELATIONS_LIST_ENTRY</a>, Link);
00131 
00132         <span class="comment">//</span>
00133         <span class="comment">// Tag the devnode as ready for remove.  If it isn't in this list</span>
00134         <span class="comment">//</span>
00135         status = <a class="code" href="../../d7/d1/pnprlist_8h.html#a18">IopSetRelationsTag</a>( entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o4">RelationsList</a>, PhysicalDeviceObject, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00136 
00137         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00138             taggedCount = <a class="code" href="../../d7/d1/pnprlist_8h.html#a12">IopGetRelationsTaggedCount</a>( entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o4">RelationsList</a> );
00139             count = <a class="code" href="../../d7/d1/pnprlist_8h.html#a11">IopGetRelationsCount</a>( entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o4">RelationsList</a> );
00140 
00141             <span class="keywordflow">if</span> (taggedCount == count) {
00142                 <span class="comment">//</span>
00143                 <span class="comment">// Remove relations list from list of pending surprise removals.</span>
00144                 <span class="comment">//</span>
00145                 RemoveEntryList( link );
00146 
00147                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a99">IopReleaseDeviceTreeLock</a>();
00148 
00149                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() != <a class="code" href="../../d1/d9/ps_8h.html#a53">PsInitialSystemProcess</a>) {
00150 
00151                     <span class="comment">//</span>
00152                     <span class="comment">// Queue a work item to do the removal so we call the driver</span>
00153                     <span class="comment">// in the system process context rather than the random one</span>
00154                     <span class="comment">// we're in now.</span>
00155                     <span class="comment">//</span>
00156 
00157                     <a class="code" href="../../d5/d8/ex_8h.html#a55">ExInitializeWorkItem</a>( &amp;entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o1">WorkItem</a>,
00158                                         <a class="code" href="../../d3/d0/pnpdel_8c.html#a2">IopDelayedRemoveWorker</a>,
00159                                         entry);
00160 
00161                     <a class="code" href="../../d5/d8/ex_8h.html#a261">ExQueueWorkItem</a>(&amp;entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o1">WorkItem</a>, <a class="code" href="../../d5/d8/ex_8h.html#a332a206">DelayedWorkQueue</a>);
00162 
00163                 } <span class="keywordflow">else</span> {
00164 
00165                     <span class="comment">//</span>
00166                     <span class="comment">// We are already in the system process, so call the</span>
00167                     <span class="comment">// worker inline.</span>
00168                     <span class="comment">//</span>
00169 
00170                     <a class="code" href="../../d3/d0/pnpdel_8c.html#a2">IopDelayedRemoveWorker</a>( entry );
00171 
00172                 }
00173 
00174                 <span class="keywordflow">return</span>;
00175             }
00176 
00177             <span class="keywordflow">break</span>;
00178         }
00179     }
00180 
00181     <a class="code" href="../../d9/d0/pnpiop_8h.html#a99">IopReleaseDeviceTreeLock</a>();
00182 
00183     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(link != &amp;<a class="code" href="../../d1/d0/pnpdata_8c.html#a27">IopPendingSurpriseRemovals</a>);
00184 }
00185 
00186 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00187"></a><a class="code" href="../../d3/d0/pnpdel_8c.html#a2">00187</a> <a class="code" href="../../d3/d0/pnpdel_8c.html#a2">IopDelayedRemoveWorker</a>(
00188     IN PVOID Context
00189     )
00190 
00191 <span class="comment">/*++</span>
00192 <span class="comment"></span>
00193 <span class="comment">Routine Description:</span>
00194 <span class="comment"></span>
00195 <span class="comment">    This routine is usually called from a worker thread to actually send the</span>
00196 <span class="comment">    remove IRPs once the reference count on a PDO and all its attached devices</span>
00197 <span class="comment">    transitions to a zero.</span>
00198 <span class="comment"></span>
00199 <span class="comment">Arguments:</span>
00200 <span class="comment"></span>
00201 <span class="comment">    Context - Supplies a pointer to the pending relations list entry which has</span>
00202 <span class="comment">        the relations list of PDOs we need to remove.</span>
00203 <span class="comment"></span>
00204 <span class="comment">Return Value:</span>
00205 <span class="comment"></span>
00206 <span class="comment">    None.</span>
00207 <span class="comment"></span>
00208 <span class="comment">--*/</span>
00209 
00210 {
00211     <a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html">PPENDING_RELATIONS_LIST_ENTRY</a> entry = (<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html">PPENDING_RELATIONS_LIST_ENTRY</a>)Context;
00212 
00213     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00214 
00215     <a class="code" href="../../d7/d1/pnprlist_8h.html#a17">IopSetAllRelationsTags</a>( entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o4">RelationsList</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00216 
00217     <a class="code" href="../../d9/d0/pnpiop_8h.html#a313">IopDeleteLockedDeviceNodes</a>( entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o3">DeviceObject</a>,
00218                                 entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o4">RelationsList</a>,
00219                                 RemoveDevice,           <span class="comment">// OperationCode</span>
00220                                 <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,                   <span class="comment">// IsKernelInitiated</span>
00221                                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,                  <span class="comment">// ProcessIndirectDescendants</span>
00222                                 entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o6">Problem</a>,         <span class="comment">// Problem</span>
00223                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);                  <span class="comment">// VetoingDevice</span>
00224 
00225     <a class="code" href="../../d7/d1/pnprlist_8h.html#a10">IopFreeRelationList</a>( entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o4">RelationsList</a> );
00226 
00227     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( entry );
00228 }
00229 
00230 
00231 BOOLEAN
<a name="l00232"></a><a class="code" href="../../d3/d0/pnpdel_8c.html#a3">00232</a> <a class="code" href="../../d3/d0/pnpdel_8c.html#a3">IopDeleteLockedDeviceNode</a>(
00233     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode,
00234     IN ULONG IrpCode,
00235     IN <a class="code" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a> RelationsList,
00236     IN BOOLEAN IsKernelInitiated,
00237     IN ULONG Problem
00238     )
00239 
00240 <span class="comment">/*++</span>
00241 <span class="comment"></span>
00242 <span class="comment">Routine Description:</span>
00243 <span class="comment"></span>
00244 <span class="comment">    This function assumes that the specified device is a bus and will</span>
00245 <span class="comment">    recursively remove all its children.</span>
00246 <span class="comment"></span>
00247 <span class="comment">Arguments:</span>
00248 <span class="comment"></span>
00249 <span class="comment">    DeviceNode - Supplies a pointer to the device node to be removed.</span>
00250 <span class="comment"></span>
00251 <span class="comment">Return Value:</span>
00252 <span class="comment"></span>
00253 <span class="comment">    NTSTATUS code.</span>
00254 <span class="comment"></span>
00255 <span class="comment">--*/</span>
00256 
00257 {
00258     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject = DeviceNode-&gt;PhysicalDeviceObject;
00259     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> *attachedDevices, device1, *device2;
00260     <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> *attachedDrivers, *driver;
00261     ULONG length = 0;
00262     BOOLEAN success = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00263     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00264 
00265     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00266 
00267     PIDBGMSG( PIDBG_REMOVAL,
00268               (<span class="stringliteral">"IopDeleteLockedDeviceNode: Entered\n    DeviceNode = 0x%p\n    IrpCode = 0x%08X\n    RelationsList = 0x%p\n    IsKernelInitiated = %d\n   Problem = %d\n"</span>,
00269               DeviceNode,
00270               IrpCode,
00271               RelationsList,
00272               IsKernelInitiated,
00273               Problem));
00274 
00275     <span class="comment">//</span>
00276     <span class="comment">// If this device has been deleted, simply return.</span>
00277     <span class="comment">//</span>
00278 
00279     <span class="keywordflow">if</span> (!IsKernelInitiated &amp;&amp; !(DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a11">DNF_ADDED</a>)) {
00280         PIDBGMSG(PIDBG_REMOVAL, (<span class="stringliteral">"IopDeleteLockedDeviceNode: Device already deleted\n"</span>));
00281         <span class="keywordflow">if</span> (IrpCode == <a class="code" href="../../d0/d5/io_8h.html#a67">IRP_MN_REMOVE_DEVICE</a>) {
00282             <span class="keywordflow">while</span> (deviceObject) {
00283                 deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o5">ExtensionFlags</a> &amp;= ~(<a class="code" href="../../d0/d5/io_8h.html#a140">DOE_REMOVE_PENDING</a> | <a class="code" href="../../d0/d5/io_8h.html#a141">DOE_REMOVE_PROCESSED</a>);
00284                 deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o5">ExtensionFlags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a142">DOE_START_PENDING</a>;
00285                 deviceObject = deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o5">AttachedDevice</a>;
00286             }
00287         }
00288         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00289     }
00290 
00291     <span class="keywordflow">if</span> (IrpCode == <a class="code" href="../../d0/d5/io_8h.html#a87">IRP_MN_SURPRISE_REMOVAL</a>) {
00292 
00293         <span class="comment">//</span>
00294         <span class="comment">// Send irp to remove the device...</span>
00295         <span class="comment">//</span>
00296 
00297         PIDBGMSG( PIDBG_REMOVAL,
00298                   (<span class="stringliteral">"IopDeleteLockedDeviceNode: Sending surprise remove irp to device = 0x%p\n"</span>,
00299                   deviceObject));
00300 
00301         status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a21">IopRemoveDevice</a>(deviceObject, <a class="code" href="../../d0/d5/io_8h.html#a87">IRP_MN_SURPRISE_REMOVAL</a>);
00302 
00303         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00304 
00305             PIDBGMSG(PIDBG_REMOVAL, (<span class="stringliteral">"IopDeleteLockedDeviceNode: Releasing devices resources\n"</span>));
00306 
00307             <a class="code" href="../../d9/d0/pnpiop_8h.html#a279">IopReleaseDeviceResources</a>(DeviceNode, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00308 
00309         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a15">DNF_NO_RESOURCE_REQUIRED</a>)) {
00310             success = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00311         }
00312 
00313         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DeviceNode-&gt;DockInfo.DockStatus != <a class="code" href="../../d9/d0/pnpiop_8h.html#a387a205">DOCK_ARRIVING</a>);
00314 
00315     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IrpCode == <a class="code" href="../../d0/d5/io_8h.html#a67">IRP_MN_REMOVE_DEVICE</a>) {
00316 
00317         <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> child, nextChild, parent;
00318         <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> childPDO;
00319 
00320         <span class="comment">//</span>
00321         <span class="comment">// Make sure we WILL drop our references to its children.</span>
00322         <span class="comment">//</span>
00323 
00324         child = DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o1">Child</a>;
00325         <span class="keywordflow">while</span> (child) {
00326             <span class="keywordflow">if</span> (child-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a9">DNF_ENUMERATED</a>) {
00327                 child-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a9">DNF_ENUMERATED</a>;
00328             }
00329 
00330             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!(child-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a11">DNF_ADDED</a>));
00331 
00332             <span class="keywordflow">if</span> (child-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; (<a class="code" href="../../d9/d0/pnpiop_8h.html#a46">DNF_HAS_RESOURCE</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a19">DNF_RESOURCE_REPORTED</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a12">DNF_HAS_BOOT_CONFIG</a>)) {
00333 
00334                 <span class="comment">//</span>
00335                 <span class="comment">// Send irp to remove the about to be orphaned child device...</span>
00336                 <span class="comment">//</span>
00337 
00338                 PIDBGMSG( PIDBG_REMOVAL,
00339                           (<span class="stringliteral">"IopDeleteLockedDeviceNode: Sending remove irp to orphaned child device = 0x%p\n"</span>,
00340                           child-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>));
00341 
00342                 <a class="code" href="../../d0/d1/pnpirp_8c.html#a21">IopRemoveDevice</a>(child-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>, <a class="code" href="../../d0/d5/io_8h.html#a67">IRP_MN_REMOVE_DEVICE</a>);
00343 
00344                 PIDBGMSG(PIDBG_REMOVAL,
00345                          (<span class="stringliteral">"IopDeleteLockedDeviceNode: Releasing resources for child device = 0x%p\n"</span>,
00346                          child-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>));
00347 
00348                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a279">IopReleaseDeviceResources</a>(child, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00349 
00350                 <span class="comment">//</span>
00351                 <span class="comment">// BUGBUG - what if the resources aren't released???</span>
00352                 <span class="comment">//</span>
00353             }
00354 
00355             <span class="comment">//</span>
00356             <span class="comment">//</span>
00357             nextChild = child-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o0">Sibling</a>;
00358             parent = child-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o2">Parent</a>;
00359 
00360             PIDBGMSG( PIDBG_REMOVAL,
00361                       (<span class="stringliteral">"IopDeleteLockedDeviceNode: Cleaning up registry values, instance = %wZ\n"</span>,
00362                       &amp;child-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>));
00363 
00364             <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00365             <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00366 
00367             <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a25">IopCleanupDeviceRegistryValues</a>(&amp;child-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00368 
00369             PIDBGMSG( PIDBG_REMOVAL,
00370                       (<span class="stringliteral">"IopDeleteLockedDeviceNode: Removing DevNode tree, DevNode = 0x%p\n"</span>,
00371                       child));
00372 
00373             childPDO = child-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>;
00374             <a class="code" href="../../d9/d0/pnpiop_8h.html#a251">IopRemoveTreeDeviceNode</a>(child);
00375             <a class="code" href="../../d7/d1/pnprlist_8h.html#a16">IopRemoveRelationFromList</a>(RelationsList, childPDO);
00376             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(childPDO); <span class="comment">// Added during Enum</span>
00377 
00378             <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>);
00379             <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00380 
00381             <span class="keywordflow">if</span> (child-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o36">LockCount</a> != 0) {
00382 
00383                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(child-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o36">LockCount</a> == 1);
00384 
00385                 child-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o36">LockCount</a> = 0;
00386 
00387                 <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(&amp;child-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o12">EnumerationMutex</a>, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00388                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(childPDO);
00389 
00390                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(parent-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o36">LockCount</a> &gt; 0);
00391 
00392                 <span class="keywordflow">if</span> (--parent-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o36">LockCount</a> == 0) {
00393                     <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(&amp;parent-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o12">EnumerationMutex</a>, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00394                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(parent-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>);
00395                 }
00396             }
00397 
00398             child = nextChild;
00399         }
00400 
00401         <span class="comment">//</span>
00402         <span class="comment">// Add a reference to each FDO attached to the PDO such that the FDOs won't</span>
00403         <span class="comment">// actually go away until the removal operation is completed.</span>
00404         <span class="comment">// Note we need to make a copy of all the attached devices because we won't be</span>
00405         <span class="comment">// able to traverse the attached chain when the removal operation is done.</span>
00406         <span class="comment">//</span>
00407 
00408         device1 = deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o5">AttachedDevice</a>;
00409         <span class="keywordflow">while</span> (device1) {
00410             length++;
00411             device1 = device1-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o5">AttachedDevice</a>;
00412         }
00413 
00414         attachedDevices = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00415         attachedDrivers = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00416         <span class="keywordflow">if</span> (length != 0) {
00417             length = (length + 2) * <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>);
00418             attachedDevices = (<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> *)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, length);
00419             <span class="keywordflow">if</span> (!attachedDevices) {
00420                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00421             }
00422             attachedDrivers = (<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> *)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, length);
00423             <span class="keywordflow">if</span> (!attachedDrivers) {
00424                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(attachedDevices);
00425                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00426             }
00427             RtlZeroMemory(attachedDevices, length);
00428             RtlZeroMemory(attachedDrivers, length);
00429             device1 = deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o5">AttachedDevice</a>;
00430             device2 = attachedDevices;
00431             driver = attachedDrivers;
00432             <span class="keywordflow">while</span> (device1) {
00433                 <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(device1);
00434                 *device2++ = device1;
00435                 *driver++ = device1-&gt;DriverObject;
00436                 device1 = device1-&gt;AttachedDevice;
00437             }
00438         }
00439 
00440         <span class="comment">//</span>
00441         <span class="comment">// Send irp to remove the device...</span>
00442         <span class="comment">//</span>
00443 
00444         PIDBGMSG( PIDBG_REMOVAL,
00445                   (<span class="stringliteral">"IopDeleteLockedDeviceNode: Sending remove irp to device = 0x%p\n"</span>,
00446                   deviceObject));
00447 
00448         <a class="code" href="../../d0/d1/pnpirp_8c.html#a21">IopRemoveDevice</a>(deviceObject, <a class="code" href="../../d0/d5/io_8h.html#a67">IRP_MN_REMOVE_DEVICE</a>);
00449 
00450         PIDBGMSG(PIDBG_REMOVAL, (<span class="stringliteral">"IopDeleteLockedDeviceNode: Releasing devices resources\n"</span>));
00451 
00452         <a class="code" href="../../d9/d0/pnpiop_8h.html#a279">IopReleaseDeviceResources</a>(DeviceNode, (BOOLEAN)!(DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a33">DNF_DEVICE_GONE</a>));
00453 
00454         <span class="keywordflow">if</span> (!(DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a9">DNF_ENUMERATED</a>)) {
00455             <span class="comment">//</span>
00456             <span class="comment">// If the device is a dock, remove it from the list of dock devices</span>
00457             <span class="comment">// and change the current Hardware Profile, if necessary.</span>
00458             <span class="comment">//</span>
00459             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DeviceNode-&gt;DockInfo.DockStatus != <a class="code" href="../../d9/d0/pnpiop_8h.html#a387a205">DOCK_ARRIVING</a>) ;
00460             <span class="keywordflow">if</span> ((DeviceNode-&gt;DockInfo.DockStatus == <a class="code" href="../../d9/d0/pnpiop_8h.html#a387a206">DOCK_DEPARTING</a>)||
00461                 (DeviceNode-&gt;DockInfo.DockStatus == <a class="code" href="../../d9/d0/pnpiop_8h.html#a387a207">DOCK_EJECTIRP_COMPLETED</a>)) {
00462                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a381">IopHardwareProfileCommitRemovedDock</a>(DeviceNode);
00463             }
00464         }
00465 
00466         <span class="comment">//</span>
00467         <span class="comment">// Remove the reference to the attached FDOs to allow them to be actually</span>
00468         <span class="comment">// deleted.</span>
00469         <span class="comment">//</span>
00470 
00471         <span class="keywordflow">if</span> (device2 = attachedDevices) {
00472             driver = attachedDrivers;
00473             <span class="keywordflow">while</span> (*device2) {
00474                 (*device2)-&gt;DeviceObjectExtension-&gt;ExtensionFlags &amp;= ~(<a class="code" href="../../d0/d5/io_8h.html#a140">DOE_REMOVE_PENDING</a> | <a class="code" href="../../d0/d5/io_8h.html#a141">DOE_REMOVE_PROCESSED</a>);
00475                 (*device2)-&gt;DeviceObjectExtension-&gt;ExtensionFlags |= <a class="code" href="../../d0/d5/io_8h.html#a142">DOE_START_PENDING</a>;
00476                 <a class="code" href="../../d3/d0/pnpdel_8c.html#a5">IopUnloadAttachedDriver</a>(*driver);
00477                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(*device2);
00478                 device2++;
00479                 driver++;
00480             }
00481             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(attachedDevices);
00482             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(attachedDrivers);
00483         }
00484 
00485         <span class="comment">//</span>
00486         <span class="comment">// Now mark this one deleted.</span>
00487         <span class="comment">//</span>
00488 
00489         <span class="keywordflow">if</span> (!(DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a31">DNF_HAS_PRIVATE_PROBLEM</a>)) {
00490 
00491             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!<a class="code" href="../../d9/d0/pnpiop_8h.html#a77">IopDoesDevNodeHaveProblem</a>(DeviceNode) ||
00492                     <a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(DeviceNode, Problem) ||
00493                     Problem == CM_PROB_DEVICE_NOT_THERE ||
00494                     Problem == CM_PROB_DISABLED);
00495 
00496             <a class="code" href="../../d9/d0/pnpiop_8h.html#a79">IopClearDevNodeProblem</a>(DeviceNode);
00497             <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(DeviceNode, Problem);
00498         }
00499 
00500         deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o5">ExtensionFlags</a> &amp;= ~(<a class="code" href="../../d0/d5/io_8h.html#a140">DOE_REMOVE_PENDING</a> | <a class="code" href="../../d0/d5/io_8h.html#a141">DOE_REMOVE_PROCESSED</a>);
00501         deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o5">ExtensionFlags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a142">DOE_START_PENDING</a>;
00502 
00503         <span class="keywordflow">if</span> (DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a32">DNF_REMOVE_PENDING_CLOSES</a>) {
00504 
00505             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DeviceNode-&gt;LockCount == 0);
00506 
00507             DeviceNode-&gt;Flags &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a32">DNF_REMOVE_PENDING_CLOSES</a>;
00508 
00509             <span class="keywordflow">if</span> ((DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a33">DNF_DEVICE_GONE</a>) &amp;&amp; DeviceNode-&gt;Parent != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00510 
00511                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DeviceNode-&gt;Child == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00512 
00513                 PIDBGMSG( PIDBG_REMOVAL,
00514                           (<span class="stringliteral">"IopDeleteLockedDeviceNode: Cleaning up registry values, instance = %wZ\n"</span>,
00515                           &amp;DeviceNode-&gt;InstancePath));
00516 
00517                 <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00518                 <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00519 
00520                 <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a25">IopCleanupDeviceRegistryValues</a>(&amp;DeviceNode-&gt;InstancePath, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00521 
00522                 <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>);
00523                 <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00524 
00525                 PIDBGMSG( PIDBG_REMOVAL,
00526                           (<span class="stringliteral">"IopDeleteLockedDeviceNode: Removing DevNode tree, DevNode = 0x%p\n"</span>,
00527                           DeviceNode));
00528 
00529                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a251">IopRemoveTreeDeviceNode</a>(DeviceNode);
00530                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(deviceObject); <span class="comment">// Added during Enum</span>
00531             }
00532         }
00533 
00534     } <span class="keywordflow">else</span> {
00535 
00536         <span class="comment">//</span>
00537         <span class="comment">// The request is QUERY or cancel.  If it is query return FALSE on failure.</span>
00538         <span class="comment">//</span>
00539 
00540         PIDBGMSG( PIDBG_REMOVAL,
00541                   (<span class="stringliteral">"IopDeleteLockedDeviceNode: Sending QueryRemove/CancelRemove irp to device = 0x%p\n"</span>,
00542                   deviceObject));
00543 
00544         status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a21">IopRemoveDevice</a>(deviceObject, IrpCode);
00545         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; IrpCode == <a class="code" href="../../d0/d5/io_8h.html#a66">IRP_MN_QUERY_REMOVE_DEVICE</a>) {
00546             PIDBGMSG( PIDBG_REMOVAL,
00547                       (<span class="stringliteral">"IopDeleteLockedDeviceNode: QueryRemove vetoed by device = 0x%p\n"</span>,
00548                       deviceObject));
00549 
00550             success = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00551         }
00552     }
00553     <span class="keywordflow">return</span> success;
00554 }
00555 
00556 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00557"></a><a class="code" href="../../d9/d0/pnpiop_8h.html#a313">00557</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a313">IopDeleteLockedDeviceNodes</a>(
00558     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject,
00559     IN <a class="code" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a> RelationsList,
00560     IN PLUGPLAY_DEVICE_DELETE_TYPE OperationCode,
00561     IN BOOLEAN IsKernelInitiated,
00562     IN BOOLEAN ProcessIndirectDescendants,
00563     IN ULONG Problem,
00564     OUT <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> *VetoingDevice OPTIONAL
00565     )
00566 
00567 <span class="comment">/*++</span>
00568 <span class="comment"></span>
00569 <span class="comment">Routine Description:</span>
00570 <span class="comment"></span>
00571 <span class="comment">    This routine performs requested operation on the DeviceObject and</span>
00572 <span class="comment">    the device objects specified in the DeviceRelations.</span>
00573 <span class="comment"></span>
00574 <span class="comment">Arguments:</span>
00575 <span class="comment"></span>
00576 <span class="comment">    DeviceObject - Supplies a pointer to the device object.</span>
00577 <span class="comment"></span>
00578 <span class="comment">    DeviceRelations - supplies a pointer to the device's removal relations.</span>
00579 <span class="comment"></span>
00580 <span class="comment">    OperationCode - Operation code, i.e., QueryRemove, CancelRemove, Remove...</span>
00581 <span class="comment"></span>
00582 <span class="comment">Return Value:</span>
00583 <span class="comment"></span>
00584 <span class="comment">    NTSTATUS code.</span>
00585 <span class="comment"></span>
00586 <span class="comment">--*/</span>
00587 
00588 {
00589     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
00590     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
00591     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject, relatedDeviceObject;
00592     ULONG i;
00593     ULONG marker;
00594     ULONG irpCode;
00595     BOOLEAN tagged, directDescendant;
00596 
00597     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00598 
00599     PIDBGMSG( PIDBG_REMOVAL,
00600               (<span class="stringliteral">"IopDeleteLockedDeviceNodes: Entered\n    DeviceObject = 0x%p\n    RelationsList = 0x%p\n    OperationCode = %d\n"</span>,
00601               DeviceObject,
00602               RelationsList,
00603               OperationCode));
00604 
00605     deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>) DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
00606 
00607     <span class="keywordflow">switch</span> (OperationCode) {
00608     <span class="keywordflow">case</span> QueryRemoveDevice:
00609         irpCode = <a class="code" href="../../d0/d5/io_8h.html#a66">IRP_MN_QUERY_REMOVE_DEVICE</a>;
00610         <span class="keywordflow">break</span>;
00611 
00612     <span class="keywordflow">case</span> CancelRemoveDevice:
00613         irpCode = <a class="code" href="../../d0/d5/io_8h.html#a68">IRP_MN_CANCEL_REMOVE_DEVICE</a>;
00614         <span class="keywordflow">break</span>;
00615 
00616     <span class="keywordflow">case</span> RemoveDevice:
00617         irpCode = <a class="code" href="../../d0/d5/io_8h.html#a67">IRP_MN_REMOVE_DEVICE</a>;
00618         <span class="keywordflow">break</span>;
00619 
00620     <span class="keywordflow">case</span> SurpriseRemoveDevice:
00621         irpCode = <a class="code" href="../../d0/d5/io_8h.html#a87">IRP_MN_SURPRISE_REMOVAL</a>;
00622         <span class="keywordflow">break</span>;
00623 
00624     <span class="keywordflow">case</span> EjectDevice:
00625     <span class="keywordflow">default</span>:
00626         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(0);
00627         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00628     }
00629 
00630     marker = 0;
00631     <span class="keywordflow">while</span> (<a class="code" href="../../d7/d1/pnprlist_8h.html#a9">IopEnumerateRelations</a>( RelationsList,
00632                                   &amp;marker,
00633                                   &amp;deviceObject,
00634                                   &amp;directDescendant,
00635                                   &amp;tagged,
00636                                   <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
00637 
00638         <span class="comment">//</span>
00639         <span class="comment">// Depending on the operation we need to do different things.</span>
00640         <span class="comment">//</span>
00641         <span class="comment">//  QueryRemoveDevice / CancelRemoveDevice</span>
00642         <span class="comment">//      Ignore tagged relations - they were processed by a previous eject</span>
00643         <span class="comment">//      Process both direct and indirect descendants</span>
00644         <span class="comment">//</span>
00645         <span class="comment">//  SurpriseRemoveDevice / RemoveDevice</span>
00646         <span class="comment">//      None of the relations should be tagged</span>
00647         <span class="comment">//      Ignore indirect descendants</span>
00648         <span class="comment">//</span>
00649 
00650         <span class="keywordflow">if</span> (!tagged &amp;&amp; (directDescendant || ProcessIndirectDescendants)) {
00651             deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
00652 
00653             <span class="keywordflow">if</span> (OperationCode == SurpriseRemoveDevice) {
00654                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a32">DNF_REMOVE_PENDING_CLOSES</a>;
00655             }
00656 
00657             <span class="keywordflow">if</span> (OperationCode == QueryRemoveDevice &amp;&amp; !(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a>)) {
00658                 <span class="comment">//</span>
00659                 <span class="comment">// Don't send Queries to devices without FDOs (or filters)</span>
00660                 <span class="comment">//</span>
00661                 <span class="keywordflow">continue</span>;
00662             }
00663 
00664             <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d0/pnpdel_8c.html#a3">IopDeleteLockedDeviceNode</a>( deviceNode,
00665                                             irpCode,
00666                                             RelationsList,
00667                                             IsKernelInitiated,
00668                                             Problem)) {
00669 
00670                 <span class="keywordflow">if</span> (OperationCode == QueryRemoveDevice) {
00671 
00672                     <span class="keywordflow">if</span> (VetoingDevice != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00673                         *VetoingDevice = deviceObject;
00674                     }
00675 
00676                     <a class="code" href="../../d3/d0/pnpdel_8c.html#a3">IopDeleteLockedDeviceNode</a>( deviceNode,
00677                                                <a class="code" href="../../d0/d5/io_8h.html#a68">IRP_MN_CANCEL_REMOVE_DEVICE</a>,
00678                                                RelationsList,
00679                                                IsKernelInitiated,
00680                                                Problem);
00681 
00682                     <span class="keywordflow">while</span> (<a class="code" href="../../d7/d1/pnprlist_8h.html#a9">IopEnumerateRelations</a>( RelationsList,
00683                                                   &amp;marker,
00684                                                   &amp;deviceObject,
00685                                                   <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00686                                                   &amp;tagged,
00687                                                   <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
00688 
00689                         <span class="keywordflow">if</span> (!tagged) {
00690 
00691                             deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
00692 
00693                             <a class="code" href="../../d3/d0/pnpdel_8c.html#a3">IopDeleteLockedDeviceNode</a>( deviceNode,
00694                                                        <a class="code" href="../../d0/d5/io_8h.html#a68">IRP_MN_CANCEL_REMOVE_DEVICE</a>,
00695                                                        RelationsList,
00696                                                        IsKernelInitiated,
00697                                                        Problem);
00698                         }
00699                     }
00700 
00701                     status = STATUS_UNSUCCESSFUL;
00702                     <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
00703                 }
00704             }
00705         }
00706     }
00707 
00708     <span class="comment">//</span>
00709     <span class="comment">// As long as there is device removed, try satisfy the DNF_INSUFFICIENT_RESOURCES</span>
00710     <span class="comment">// devices.</span>
00711     <span class="comment">//</span>
00712 
00713     <span class="keywordflow">if</span> (OperationCode == RemoveDevice) {
00714         PIDBGMSG( PIDBG_REMOVAL,
00715                   (<span class="stringliteral">"IopDeleteLockedDeviceNodes: Calling IopRequestDeviceEnumeration\n"</span>));
00716 
00717         <a class="code" href="../../d9/d0/pnpiop_8h.html#a305">IopRequestDeviceAction</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d9/d0/pnpiop_8h.html#a391a222">AssignResources</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00718     }
00719 
00720 <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>:
00721     <span class="keywordflow">return</span> status;
00722 }
00723 
00724 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00725"></a><a class="code" href="../../d9/d0/pnpiop_8h.html#a312">00725</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a312">IopLockDeviceRemovalRelations</a>(
00726     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject,
00727     IN PLUGPLAY_DEVICE_DELETE_TYPE OperationCode,
00728     OUT <a class="code" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a> *RelationsList,
00729     IN BOOLEAN IsKernelInitiated
00730     )
00731 
00732 <span class="comment">/*++</span>
00733 <span class="comment"></span>
00734 <span class="comment">Routine Description:</span>
00735 <span class="comment"></span>
00736 <span class="comment">    This routine locks the device subtrees for removal operation and returns</span>
00737 <span class="comment">    a list of device objects which need to be removed with the specified</span>
00738 <span class="comment">    DeviceObject.</span>
00739 <span class="comment"></span>
00740 <span class="comment">    Caller must hold a reference to the DeviceObject.</span>
00741 <span class="comment"></span>
00742 <span class="comment">Arguments:</span>
00743 <span class="comment"></span>
00744 <span class="comment">    DeviceObject - Supplies a pointer to the device object to be removed.</span>
00745 <span class="comment"></span>
00746 <span class="comment">    OperationCode - Operation code, i.e., QueryEject, CancelEject, Eject...</span>
00747 <span class="comment"></span>
00748 <span class="comment">    DeviceRelations - supplies a pointer to a variable to receive the device's</span>
00749 <span class="comment">                   removal relations.</span>
00750 <span class="comment"></span>
00751 <span class="comment">Return Value:</span>
00752 <span class="comment"></span>
00753 <span class="comment">    NTSTATUS code.</span>
00754 <span class="comment"></span>
00755 <span class="comment">--*/</span>
00756 
00757 {
00758     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                status;
00759     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>          deviceObject;
00760     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>            deviceNode, parent;
00761     <a class="code" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a>          relationsList;
00762     ULONG                   marker;
00763     BOOLEAN                 tagged;
00764 
00765     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00766 
00767     *RelationsList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00768 
00769     deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
00770 
00771     <span class="keywordflow">if</span> (!IsKernelInitiated &amp;&amp; !(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a11">DNF_ADDED</a>) &amp;&amp; OperationCode != EjectDevice) {
00772 
00773         <span class="keywordflow">return</span> STATUS_SUCCESS;
00774     }
00775 
00776     <span class="comment">//</span>
00777     <span class="comment">// Obviously no one should try to delete the whole device node tree.</span>
00778     <span class="comment">//</span>
00779 
00780     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DeviceObject != <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>);
00781 
00782     <span class="comment">//</span>
00783     <span class="comment">// Lock the whole device node tree so no one can touch the tree.</span>
00784     <span class="comment">//</span>
00785 
00786     <a class="code" href="../../d9/d0/pnpiop_8h.html#a98">IopAcquireDeviceTreeLock</a>();
00787 
00788     <span class="keywordflow">if</span> (IsKernelInitiated) {
00789         <span class="comment">//</span>
00790         <span class="comment">// For kernel initiated removes it means that the device itself is</span>
00791         <span class="comment">// physically gone.</span>
00792         <span class="comment">//</span>
00793 
00794         <span class="comment">//</span>
00795         <span class="comment">// We'll take advantage of that signal to go and check if there</span>
00796         <span class="comment">// previously was a QueryRemove done on this devnode.  If</span>
00797         <span class="comment">// so, we need to reenumerate the parents of all the relations in</span>
00798         <span class="comment">// case some of them were speculative.</span>
00799         <span class="comment">//</span>
00800     }
00801 
00802     <span class="keywordflow">if</span> ((relationsList = <a class="code" href="../../d6/d1/pnprlist_8c.html#a4">IopAllocateRelationList</a>()) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00803 
00804         <a class="code" href="../../d9/d0/pnpiop_8h.html#a99">IopReleaseDeviceTreeLock</a>();
00805         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00806     }
00807 
00808     <span class="comment">//</span>
00809     <span class="comment">// First process the object itself</span>
00810     <span class="comment">//</span>
00811     status = <a class="code" href="../../d3/d0/pnpdel_8c.html#a4">IopProcessRelation</a>( DeviceObject,
00812                                  OperationCode,
00813                                  relationsList,
00814                                  IsKernelInitiated,
00815                                  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00816 
00817     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(status != STATUS_INVALID_DEVICE_REQUEST);
00818 
00819     marker = 0;
00820     <span class="keywordflow">while</span> (<a class="code" href="../../d7/d1/pnprlist_8h.html#a9">IopEnumerateRelations</a>( relationsList,
00821                                   &amp;marker,
00822                                   &amp;deviceObject,
00823                                   <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00824                                   &amp;tagged,
00825                                   <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
00826 
00827         deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
00828 
00829         <span class="comment">//</span>
00830         <span class="comment">// If we were successful we need to lock the parents of each of the</span>
00831         <span class="comment">// relations, otherwise we need to unlock each relation.</span>
00832         <span class="comment">//</span>
00833 
00834 
00835         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00836             <span class="comment">//</span>
00837             <span class="comment">// For all the device nodes in the DeviceRelations, we need to lock</span>
00838             <span class="comment">// their parents' enumeration mutex.</span>
00839             <span class="comment">//</span>
00840 
00841             <span class="keywordflow">if</span> (tagged) {
00842 
00843                 <span class="comment">//</span>
00844                 <span class="comment">// If the tagged bit is set then the relation was merged from</span>
00845                 <span class="comment">// a pending eject.  In this case the devnode isn't locked so</span>
00846                 <span class="comment">// we do it now.</span>
00847                 <span class="comment">//</span>
00848 
00849                 <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o36">LockCount</a>++ == 0) {
00850                     <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>);
00851                     <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a>(&amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o12">EnumerationMutex</a>);
00852                 }
00853             }
00854 
00855             parent = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o2">Parent</a>;
00856 
00857             <span class="keywordflow">if</span> (parent-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o36">LockCount</a>++ == 0) {
00858                 <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(parent-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>);
00859                 <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a>(&amp;parent-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o12">EnumerationMutex</a>);
00860             }
00861 
00862         } <span class="keywordflow">else</span> {
00863 
00864             <span class="keywordflow">if</span> (!tagged) {
00865 
00866                 <span class="comment">//</span>
00867                 <span class="comment">// If the tagged bit is set then the relation was merged from</span>
00868                 <span class="comment">// an pending eject.  In this case the devnode isn't locked so</span>
00869                 <span class="comment">// we don't need to unlock it, all the others we unlock now.</span>
00870                 <span class="comment">//</span>
00871 
00872                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o36">LockCount</a> &gt; 0);
00873 
00874                 <span class="keywordflow">if</span> (--deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o36">LockCount</a> == 0) {
00875                     <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(&amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o12">EnumerationMutex</a>, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00876                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(deviceObject);
00877                 }
00878             }
00879         }
00880     }
00881 
00882     <span class="comment">//</span>
00883     <span class="comment">// Release the device tree.</span>
00884     <span class="comment">//</span>
00885 
00886     <a class="code" href="../../d9/d0/pnpiop_8h.html#a99">IopReleaseDeviceTreeLock</a>();
00887 
00888     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00889         <a class="code" href="../../d7/d1/pnprlist_8h.html#a8">IopCompressRelationList</a>(&amp;relationsList);
00890         *RelationsList = relationsList;
00891 
00892         <span class="comment">//</span>
00893         <span class="comment">// At this point we have a list of all the relations, those that are</span>
00894         <span class="comment">// direct descendants of the original device we are ejecting or</span>
00895         <span class="comment">// removing have the DirectDescendant bit set.</span>
00896         <span class="comment">//</span>
00897         <span class="comment">// Relations which were merged from an existing eject have the tagged</span>
00898         <span class="comment">// bit set.</span>
00899         <span class="comment">//</span>
00900         <span class="comment">// All of the relations and their parents are locked.</span>
00901         <span class="comment">//</span>
00902         <span class="comment">// There is a reference on each device object by virtue of it being in</span>
00903         <span class="comment">// the list.  There is another one on each device object because it is</span>
00904         <span class="comment">// locked and the lock count is &gt;= 1.</span>
00905         <span class="comment">//</span>
00906         <span class="comment">// There is also a reference on each relation's parent and it's lock</span>
00907         <span class="comment">// count is &gt;= 1.</span>
00908         <span class="comment">//</span>
00909     } <span class="keywordflow">else</span> {
00910         <a class="code" href="../../d7/d1/pnprlist_8h.html#a10">IopFreeRelationList</a>(relationsList);
00911     }
00912 
00913     <span class="keywordflow">return</span> status;
00914 }
00915 
00916 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00917"></a><a class="code" href="../../d3/d0/pnpdel_8c.html#a4">00917</a> <a class="code" href="../../d3/d0/pnpdel_8c.html#a4">IopProcessRelation</a>(
00918     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject,
00919     IN PLUGPLAY_DEVICE_DELETE_TYPE OperationCode,
00920     IN <a class="code" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a> RelationsList,
00921     IN BOOLEAN IsKernelInitiated,
00922     IN BOOLEAN IsDirectDescendant
00923     )
00924 <span class="comment">/*++</span>
00925 <span class="comment"></span>
00926 <span class="comment">Routine Description:</span>
00927 <span class="comment"></span>
00928 <span class="comment">    This routine builds the list of device objects that need to be removed or</span>
00929 <span class="comment">    examined when the passed in device object is torn down.</span>
00930 <span class="comment"></span>
00931 <span class="comment">    Caller must hold the device tree lock.</span>
00932 <span class="comment"></span>
00933 <span class="comment">Arguments:</span>
00934 <span class="comment"></span>
00935 <span class="comment">    ADRIAO BUGBUG 01/07/1999 - fill this out.</span>
00936 <span class="comment"></span>
00937 <span class="comment">Return Value:</span>
00938 <span class="comment"></span>
00939 <span class="comment">    NTSTATUS code.</span>
00940 <span class="comment"></span>
00941 <span class="comment">--*/</span>
00942 {
00943     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>                    deviceNode, relatedDeviceNode;
00944     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>                  relatedDeviceObject;
00945     <a class="code" href="../../d0/d5/struct__DEVICE__RELATIONS.html">PDEVICE_RELATIONS</a>               deviceRelations;
00946     PLIST_ENTRY                     ejectLink;
00947     <a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html">PPENDING_RELATIONS_LIST_ENTRY</a>   ejectEntry;
00948     <a class="code" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a>                  pendingRelationList;
00949     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a>                            pendingIrp;
00950     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                        status;
00951     ULONG                           i;
00952 
00953     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00954 
00955     deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
00956 
00957     <span class="keywordflow">if</span> (deviceNode == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o2">Parent</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00958         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(deviceNode != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00959 
00960         <span class="comment">//</span>
00961         <span class="comment">// The device has already been removed</span>
00962         <span class="comment">//</span>
00963         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
00964     }
00965 
00966     <span class="keywordflow">if</span> ((OperationCode == QueryRemoveDevice || OperationCode == EjectDevice) &amp;&amp;
00967         (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a32">DNF_REMOVE_PENDING_CLOSES</a>)) {
00968 
00969         <span class="comment">//</span>
00970         <span class="comment">// The device is in the process of being surprise removed, let it finish</span>
00971         <span class="comment">//</span>
00972         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
00973     }
00974 
00975     status = <a class="code" href="../../d7/d1/pnprlist_8h.html#a7">IopAddRelationToList</a>( RelationsList,
00976                                    DeviceObject,
00977                                    IsDirectDescendant,
00978                                    <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00979 
00980     <span class="keywordflow">if</span> (status == STATUS_SUCCESS) {
00981 
00982         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o36">LockCount</a> == 0);
00983 
00984         <span class="keywordflow">if</span> (!(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a36">DNF_LOCKED_FOR_EJECT</a>)) {
00985             <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(DeviceObject);
00986 
00987             <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a>(&amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o12">EnumerationMutex</a>);
00988 
00989             deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o36">LockCount</a>++;
00990 
00991             <span class="comment">//</span>
00992             <span class="comment">// Then process the bus relations</span>
00993             <span class="comment">//</span>
00994             <span class="keywordflow">for</span> (relatedDeviceNode = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o1">Child</a>;
00995                  relatedDeviceNode != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00996                  ) {
00997 
00998                 relatedDeviceObject = relatedDeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>;
00999 
01000                 relatedDeviceNode = relatedDeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o0">Sibling</a>;
01001 
01002                 status = <a class="code" href="../../d3/d0/pnpdel_8c.html#a4">IopProcessRelation</a>( relatedDeviceObject,
01003                                              OperationCode,
01004                                              RelationsList,
01005                                              IsKernelInitiated,
01006                                              IsDirectDescendant
01007                                              );
01008 
01009                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(status == STATUS_SUCCESS || status == STATUS_UNSUCCESSFUL);
01010 
01011                 <span class="keywordflow">if</span> (status == STATUS_INSUFFICIENT_RESOURCES ||
01012                     status == STATUS_INVALID_DEVICE_REQUEST) {
01013                     <span class="keywordflow">return</span> status;
01014                 }
01015             }
01016 
01017             <span class="comment">//</span>
01018             <span class="comment">// Next the removal relations</span>
01019             <span class="comment">//</span>
01020 
01021 
01022             <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a>) {
01023                 status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a22">IopQueryDeviceRelations</a>( <a class="code" href="../../d0/d5/io_8h.html#a602a415">RemovalRelations</a>,
01024                                                   DeviceObject,
01025                                                   <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01026                                                   &amp;deviceRelations);
01027 
01028                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; deviceRelations) {
01029 
01030                     <span class="keywordflow">for</span> (i = 0; i &lt; deviceRelations-&gt;<a class="code" href="../../d0/d5/struct__DEVICE__RELATIONS.html#o0">Count</a>; i++) {
01031 
01032                         relatedDeviceObject = deviceRelations-&gt;<a class="code" href="../../d0/d5/struct__DEVICE__RELATIONS.html#o1">Objects</a>[i];
01033 
01034                         status = <a class="code" href="../../d3/d0/pnpdel_8c.html#a4">IopProcessRelation</a>( relatedDeviceObject,
01035                                                      OperationCode,
01036                                                      RelationsList,
01037                                                      IsKernelInitiated,
01038                                                      <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01039 
01040 
01041                         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( relatedDeviceObject );
01042 
01043                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(status == STATUS_SUCCESS ||
01044                                status == STATUS_UNSUCCESSFUL);
01045 
01046                         <span class="keywordflow">if</span> (status == STATUS_INSUFFICIENT_RESOURCES ||
01047                             status == STATUS_INVALID_DEVICE_REQUEST) {
01048 
01049                             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(deviceRelations);
01050 
01051                             <span class="keywordflow">return</span> status;
01052                         }
01053                     }
01054 
01055                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(deviceRelations);
01056                 } <span class="keywordflow">else</span> {
01057                     <span class="keywordflow">if</span> (status != STATUS_NOT_SUPPORTED) {
01058                         PIDBGMSG( PIDBG_WARNING,
01059                                   (<span class="stringliteral">"IopProcessRelation: IopQueryDeviceRelations failed, DeviceObject = 0x%p, status = 0x%08X\n"</span>,
01060                                   DeviceObject, status));
01061                     }
01062                 }
01063             }
01064 
01065             <span class="comment">//</span>
01066             <span class="comment">// Finally the eject relations if we are doing an eject operation</span>
01067             <span class="comment">//</span>
01068 
01069             <span class="keywordflow">if</span> (OperationCode != QueryRemoveDevice &amp;&amp;
01070                 OperationCode != RemoveFailedDevice &amp;&amp;
01071                 OperationCode != RemoveUnstartedFailedDevice) {
01072                 status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a22">IopQueryDeviceRelations</a>( <a class="code" href="../../d0/d5/io_8h.html#a602a413">EjectionRelations</a>,
01073                                                   DeviceObject,
01074                                                   <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01075                                                   &amp;deviceRelations);
01076 
01077                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; deviceRelations) {
01078 
01079                     <span class="keywordflow">for</span> (i = 0; i &lt; deviceRelations-&gt;<a class="code" href="../../d0/d5/struct__DEVICE__RELATIONS.html#o0">Count</a>; i++) {
01080 
01081                         relatedDeviceObject = deviceRelations-&gt;<a class="code" href="../../d0/d5/struct__DEVICE__RELATIONS.html#o1">Objects</a>[i];
01082 
01083                         status = <a class="code" href="../../d3/d0/pnpdel_8c.html#a4">IopProcessRelation</a>( relatedDeviceObject,
01084                                                      OperationCode,
01085                                                      RelationsList,
01086                                                      IsKernelInitiated,
01087                                                      <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01088 
01089                         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( relatedDeviceObject );
01090 
01091                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(status == STATUS_SUCCESS ||
01092                                status == STATUS_UNSUCCESSFUL);
01093 
01094                         <span class="keywordflow">if</span> (status == STATUS_INSUFFICIENT_RESOURCES ||
01095                             status == STATUS_INVALID_DEVICE_REQUEST) {
01096 
01097                             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(deviceRelations);
01098 
01099                             <span class="keywordflow">return</span> status;
01100                         }
01101                     }
01102 
01103                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(deviceRelations);
01104                 } <span class="keywordflow">else</span> {
01105                     <span class="keywordflow">if</span> (status != STATUS_NOT_SUPPORTED) {
01106                         PIDBGMSG( PIDBG_WARNING,
01107                                   (<span class="stringliteral">"IopProcessRelation: IopQueryDeviceRelations failed, DeviceObject = 0x%p, status = 0x%08X\n"</span>,
01108                                   DeviceObject, status));
01109                     }
01110                 }
01111             }
01112 
01113             status = STATUS_SUCCESS;
01114 
01115         } <span class="keywordflow">else</span> {
01116 
01117             <span class="comment">//</span>
01118             <span class="comment">// Look to see if this device is already part of a pending ejection.</span>
01119             <span class="comment">// If it is and we are doing an ejection then we will subsume it</span>
01120             <span class="comment">// within the larger ejection.  If we aren't doing an ejection then</span>
01121             <span class="comment">// we better be processing the removal of one of the ejected devices.</span>
01122             <span class="comment">//</span>
01123 
01124             <span class="keywordflow">for</span> (ejectLink = <a class="code" href="../../d1/d0/pnpdata_8c.html#a26">IopPendingEjects</a>.Flink;
01125                  ejectLink != &amp;<a class="code" href="../../d1/d0/pnpdata_8c.html#a26">IopPendingEjects</a>;
01126                  ejectLink = ejectLink-&gt;Flink) {
01127 
01128                 ejectEntry = CONTAINING_RECORD( ejectLink,
01129                                                 <a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html">PENDING_RELATIONS_LIST_ENTRY</a>,
01130                                                 Link);
01131 
01132                 <span class="keywordflow">if</span> (ejectEntry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o4">RelationsList</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
01133                     <a class="code" href="../../d7/d1/pnprlist_8h.html#a13">IopIsRelationInList</a>(ejectEntry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o4">RelationsList</a>, DeviceObject)) {
01134 
01135 
01136                     <span class="keywordflow">if</span> (OperationCode == EjectDevice) {
01137 
01138                         status = <a class="code" href="../../d7/d1/pnprlist_8h.html#a16">IopRemoveRelationFromList</a>(RelationsList, DeviceObject);
01139 
01140                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status));
01141 
01142                         pendingIrp = InterlockedExchangePointer(&amp;ejectEntry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o5">EjectIrp</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01143                         pendingRelationList = ejectEntry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o4">RelationsList</a>;
01144                         ejectEntry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o4">RelationsList</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01145 
01146                         <span class="keywordflow">if</span> (pendingIrp != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01147                             <a class="code" href="../../d4/d6/iosubs_8c.html#a30">IoCancelIrp</a>(pendingIrp);
01148                         }
01149 
01150                         <span class="comment">//</span>
01151                         <span class="comment">// ADRIAO BUGBUG 11/10/98 -</span>
01152                         <span class="comment">//     If a parent fails eject and it has a child that is</span>
01153                         <span class="comment">// infinitely pending an eject, this means the child now</span>
01154                         <span class="comment">// wakes up. One suggestion brought up that does not involve</span>
01155                         <span class="comment">// a code change is to amend the WDM spec to say if driver</span>
01156                         <span class="comment">// gets a start IRP for a device pending eject, it should</span>
01157                         <span class="comment">// cancel the eject IRP automatically.</span>
01158                         <span class="comment">//</span>
01159                         <a class="code" href="../../d7/d1/pnprlist_8h.html#a14">IopMergeRelationLists</a>(RelationsList, pendingRelationList, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01160 
01161                         <a class="code" href="../../d7/d1/pnprlist_8h.html#a10">IopFreeRelationList</a>(pendingRelationList);
01162 
01163                         <span class="keywordflow">if</span> (IsDirectDescendant) {
01164                             <span class="comment">//</span>
01165                             <span class="comment">// If IsDirectDescendant is specified then we need to</span>
01166                             <span class="comment">// get that bit set on the relation that caused us to</span>
01167                             <span class="comment">// do the merge.  IopAddRelationToList will fail with</span>
01168                             <span class="comment">// STATUS_OBJECT_NAME_COLLISION but the bit will still</span>
01169                             <span class="comment">// be set as a side effect.</span>
01170                             <span class="comment">//</span>
01171                             <a class="code" href="../../d7/d1/pnprlist_8h.html#a7">IopAddRelationToList</a>( RelationsList,
01172                                                   DeviceObject,
01173                                                   <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01174                                                   <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01175                         }
01176                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (OperationCode == RemoveDevice) {
01177 
01178                         <span class="comment">//</span>
01179                         <span class="comment">// We haven't processed the completion of the eject IRP</span>
01180                         <span class="comment">// before this device went away.  We'll remove it from</span>
01181                         <span class="comment">// the list in the pending ejection and return it.</span>
01182                         <span class="comment">//</span>
01183 
01184                         status = <a class="code" href="../../d7/d1/pnprlist_8h.html#a16">IopRemoveRelationFromList</a>( ejectEntry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o4">RelationsList</a>,
01185                                                             DeviceObject);
01186 
01187                         deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a36">DNF_LOCKED_FOR_EJECT</a>;
01188 
01189                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status));
01190 
01191                         <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(DeviceObject);
01192 
01193                         <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a>(&amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o12">EnumerationMutex</a>);
01194 
01195                         deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o36">LockCount</a>++;
01196                     } <span class="keywordflow">else</span> {
01197 
01198                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(0);
01199 
01200                         <span class="keywordflow">return</span> STATUS_INVALID_DEVICE_REQUEST;
01201                     }
01202                     <span class="keywordflow">break</span>;
01203                 }
01204             }
01205 
01206             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ejectLink != &amp;<a class="code" href="../../d1/d0/pnpdata_8c.html#a26">IopPendingEjects</a>);
01207 
01208             <span class="keywordflow">if</span> (ejectLink == &amp;<a class="code" href="../../d1/d0/pnpdata_8c.html#a26">IopPendingEjects</a>) {
01209                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>( PNP_DETECTED_FATAL_ERROR,
01210                               <a class="code" href="../../d9/d0/pnpiop_8h.html#a52">PNP_ERR_DEVICE_MISSING_FROM_EJECT_LIST</a>,
01211                               (ULONG_PTR)DeviceObject,
01212                               0,
01213                               0);
01214             }
01215         }
01216     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (status == STATUS_OBJECT_NAME_COLLISION) {
01217         PIDBGMSG( PIDBG_INFORMATION,
01218                   (<span class="stringliteral">"IopProcessRelation: Duplicate relation, DeviceObject = 0x%p\n"</span>,
01219                   DeviceObject));
01220 
01221         status = STATUS_SUCCESS;
01222     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (status != STATUS_INSUFFICIENT_RESOURCES) {
01223         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>( PNP_DETECTED_FATAL_ERROR,
01224                       <a class="code" href="../../d9/d0/pnpiop_8h.html#a53">PNP_ERR_UNEXPECTED_ADD_RELATION_ERR</a>,
01225                       (ULONG_PTR)DeviceObject,
01226                       (ULONG_PTR)RelationsList,
01227                       status);
01228     }
01229 
01230     <span class="keywordflow">return</span> status;
01231 }
01232 
01233 BOOLEAN
<a name="l01234"></a><a class="code" href="../../d9/d0/pnpiop_8h.html#a317">01234</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a317">IopQueuePendingEject</a>(
01235     <a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html">PPENDING_RELATIONS_LIST_ENTRY</a> Entry
01236     )
01237 {
01238     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01239 
01240     <a class="code" href="../../d9/d0/pnpiop_8h.html#a98">IopAcquireDeviceTreeLock</a>();
01241 
01242     InsertTailList(&amp;<a class="code" href="../../d1/d0/pnpdata_8c.html#a26">IopPendingEjects</a>, &amp;Entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o0">Link</a>);
01243 
01244     <a class="code" href="../../d9/d0/pnpiop_8h.html#a99">IopReleaseDeviceTreeLock</a>();
01245 
01246     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01247 }
01248 
01249 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01250"></a><a class="code" href="../../d9/d0/pnpiop_8h.html#a315">01250</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a315">IopInvalidateRelationsInList</a>(
01251     <a class="code" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a> RelationsList,
01252     BOOLEAN OnlyIndirectDescendants,
01253     BOOLEAN UnlockDevNode,
01254     BOOLEAN RestartDevNode
01255     )
01256 
01257 <span class="comment">/*++</span>
01258 <span class="comment"></span>
01259 <span class="comment">Routine Description:</span>
01260 <span class="comment"></span>
01261 <span class="comment">    Iterate over the relations in the list creating a second list containing the</span>
01262 <span class="comment">    parent of each entry skipping parents which are also in the list.  In other</span>
01263 <span class="comment">    words, if the list contains node P and node C where node C is a child of node</span>
01264 <span class="comment">    P then the parent of node P would be added but not node P itself.</span>
01265 <span class="comment"></span>
01266 <span class="comment"></span>
01267 <span class="comment">Arguments:</span>
01268 <span class="comment"></span>
01269 <span class="comment">    RelationsList           - List of relations</span>
01270 <span class="comment"></span>
01271 <span class="comment">    OnlyIndirectDescendants - Indirect relations are those which aren't direct</span>
01272 <span class="comment">                              descendants (bus relations) of the PDO originally</span>
01273 <span class="comment">                              targetted for the operation or its direct</span>
01274 <span class="comment">                              descendants.  This would include Removal or</span>
01275 <span class="comment">                              Eject relations.</span>
01276 <span class="comment"></span>
01277 <span class="comment">    UnlockDevNode           - If true then any node who's parent was invalidated</span>
01278 <span class="comment">                              is unlocked.  In the case where the parent is also</span>
01279 <span class="comment">                              in the list the node is still unlocked as will the</span>
01280 <span class="comment">                              parent be once we process it.</span>
01281 <span class="comment"></span>
01282 <span class="comment">    RestartDevNode          - If true then any node who's parent was invalidated</span>
01283 <span class="comment">                              is restarted.  This flag requires that all the</span>
01284 <span class="comment">                              relations in the list have been previously</span>
01285 <span class="comment">                              sent a remove IRP.</span>
01286 <span class="comment"></span>
01287 <span class="comment"></span>
01288 <span class="comment">Return Value:</span>
01289 <span class="comment"></span>
01290 <span class="comment">    NTSTATUS code.</span>
01291 <span class="comment"></span>
01292 <span class="comment">--*/</span>
01293 
01294 {
01295     <a class="code" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a>                  parentsList;
01296     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>                  deviceObject, parentObject;
01297     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>                    deviceNode, parentNode;
01298     ULONG                           marker;
01299     BOOLEAN                         directDescendant, tagged;
01300 
01301     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01302 
01303     parentsList = <a class="code" href="../../d6/d1/pnprlist_8c.html#a4">IopAllocateRelationList</a>();
01304 
01305     <span class="keywordflow">if</span> (parentsList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01306         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01307     }
01308 
01309     <a class="code" href="../../d7/d1/pnprlist_8h.html#a17">IopSetAllRelationsTags</a>( RelationsList, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01310 
01311     <span class="comment">//</span>
01312     <span class="comment">// Traverse the list creating a new list with the topmost parents of</span>
01313     <span class="comment">// each sublist contained in RelationsList.</span>
01314     <span class="comment">//</span>
01315 
01316     marker = 0;
01317 
01318     <span class="keywordflow">while</span> (<a class="code" href="../../d7/d1/pnprlist_8h.html#a9">IopEnumerateRelations</a>( RelationsList,
01319                                   &amp;marker,
01320                                   &amp;deviceObject,
01321                                   &amp;directDescendant,
01322                                   &amp;tagged,
01323                                   <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
01324 
01325         <span class="keywordflow">if</span> (!OnlyIndirectDescendants || !directDescendant) {
01326 
01327             <span class="keywordflow">if</span> (!tagged) {
01328 
01329                 parentObject = deviceObject;
01330 
01331                 <span class="keywordflow">while</span> (<a class="code" href="../../d7/d1/pnprlist_8h.html#a18">IopSetRelationsTag</a>( RelationsList, parentObject, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ) == STATUS_SUCCESS) {
01332 
01333                     deviceNode = parentObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
01334 
01335                     <span class="keywordflow">if</span> (RestartDevNode)  {
01336 
01337                         deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a36">DNF_LOCKED_FOR_EJECT</a>;
01338 
01339                         <span class="keywordflow">if</span> ((deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; (<a class="code" href="../../d9/d0/pnpiop_8h.html#a8">DNF_PROCESSED</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a9">DNF_ENUMERATED</a>)) ==
01340                             (<a class="code" href="../../d9/d0/pnpiop_8h.html#a8">DNF_PROCESSED</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a9">DNF_ENUMERATED</a>)) {
01341 
01342                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o1">Child</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01343                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a11">DNF_ADDED</a>));
01344 
01345                             <a class="code" href="../../d9/d0/pnpiop_8h.html#a79">IopClearDevNodeProblem</a>( deviceNode );
01346                             <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a36">IopRestartDeviceNode</a>( deviceNode );
01347                         }
01348                     }
01349 
01350                     <span class="keywordflow">if</span> (UnlockDevNode) {
01351                         parentNode = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o2">Parent</a>;
01352 
01353                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(parentNode != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01354 
01355                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o36">LockCount</a> &gt; 0);
01356 
01357                         <span class="keywordflow">if</span> (--deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o36">LockCount</a> == 0) {
01358                             <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(&amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o12">EnumerationMutex</a>, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01359                             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>);
01360                         }
01361 
01362                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(parentNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o36">LockCount</a> &gt; 0);
01363 
01364                         <span class="keywordflow">if</span> (--parentNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o36">LockCount</a> == 0) {
01365                             <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(&amp;parentNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o12">EnumerationMutex</a>, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01366                             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(parentNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>);
01367                         }
01368                     }
01369 
01370                     <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o2">Parent</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01371 
01372                         parentObject = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o2">Parent</a>-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>;
01373 
01374                     } <span class="keywordflow">else</span> {
01375                         parentObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01376                         <span class="keywordflow">break</span>;
01377                     }
01378                 }
01379 
01380                 <span class="keywordflow">if</span> (parentObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)  {
01381                     <a class="code" href="../../d7/d1/pnprlist_8h.html#a7">IopAddRelationToList</a>( parentsList, parentObject, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01382                 }
01383             }
01384 
01385         }
01386     }
01387 
01388     <span class="comment">//</span>
01389     <span class="comment">// Reenumerate each of the parents</span>
01390     <span class="comment">//</span>
01391 
01392     marker = 0;
01393 
01394     <span class="keywordflow">while</span> (<a class="code" href="../../d7/d1/pnprlist_8h.html#a9">IopEnumerateRelations</a>( parentsList,
01395                                   &amp;marker,
01396                                   &amp;deviceObject,
01397                                   <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01398                                   <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01399                                   <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
01400 
01401         <a class="code" href="../../d9/d0/pnpiop_8h.html#a305">IopRequestDeviceAction</a>( deviceObject,
01402                                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a391a218">ReenumerateDeviceTree</a>,
01403                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01404                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
01405     }
01406 
01407     <span class="comment">//</span>
01408     <span class="comment">// Free the parents list</span>
01409     <span class="comment">//</span>
01410 
01411     <a class="code" href="../../d7/d1/pnprlist_8h.html#a10">IopFreeRelationList</a>( parentsList );
01412 
01413     <span class="keywordflow">return</span> STATUS_SUCCESS;
01414 }
01415 
01416 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01417"></a><a class="code" href="../../d9/d0/pnpiop_8h.html#a318">01417</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a318">IopProcessCompletedEject</a>(
01418     IN PVOID Context
01419     )
01420 <span class="comment">/*++</span>
01421 <span class="comment"></span>
01422 <span class="comment">Routine Description:</span>
01423 <span class="comment"></span>
01424 <span class="comment">    This routine is called at passive level from a worker thread that was queued</span>
01425 <span class="comment">    either when an eject IRP completed (see io\pnpirp.c - IopDeviceEjectComplete</span>
01426 <span class="comment">    or io\pnpirp.c - IopEjectDevice), or when a warm eject needs to be performed.</span>
01427 <span class="comment">    We also may need to fire off any enumerations of parents of ejected devices</span>
01428 <span class="comment">    to verify they have indeed left.</span>
01429 <span class="comment"></span>
01430 <span class="comment">Arguments:</span>
01431 <span class="comment"></span>
01432 <span class="comment">    Context - Pointer to the pending relations list which contains the device</span>
01433 <span class="comment">              to eject (warm) and the list of parents to reenumerate.</span>
01434 <span class="comment"></span>
01435 <span class="comment">Return Value:</span>
01436 <span class="comment"></span>
01437 <span class="comment">    None.</span>
01438 <span class="comment"></span>
01439 <span class="comment">--*/</span>
01440 {
01441     <a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html">PPENDING_RELATIONS_LIST_ENTRY</a> entry = (<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html">PPENDING_RELATIONS_LIST_ENTRY</a>)Context;
01442     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
01443 
01444     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01445 
01446     <span class="keywordflow">if</span> ((entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o9">LightestSleepState</a> != PowerSystemWorking) &amp;&amp;
01447         (entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o9">LightestSleepState</a> != PowerSystemUnspecified)) {
01448 
01449         <span class="comment">//</span>
01450         <span class="comment">// For docks, WinLogon gets to do the honors. For other devices, the</span>
01451         <span class="comment">// user must infer when it's safe to remove the device (if we've powered</span>
01452         <span class="comment">// up, it may not be safe now!)</span>
01453         <span class="comment">//</span>
01454         entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o8">DisplaySafeRemovalDialog</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01455 
01456         <span class="comment">//</span>
01457         <span class="comment">// This is a warm eject request, initiate it here.</span>
01458         <span class="comment">//</span>
01459         status = <a class="code" href="../../d4/d1/pnppower_8c.html#a4">IopWarmEjectDevice</a>(entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o3">DeviceObject</a>, entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o9">LightestSleepState</a>);
01460 
01461         <span class="comment">//</span>
01462         <span class="comment">// We're back and we either succeeded or failed. Either way...</span>
01463         <span class="comment">//</span>
01464     }
01465 
01466     <span class="keywordflow">if</span> (entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o10">DockInterface</a>) {
01467 
01468         entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o10">DockInterface</a>-&gt;ProfileDepartureSetMode(
01469             entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o10">DockInterface</a>-&gt;Context,
01470             PDS_UPDATE_DEFAULT
01471             );
01472 
01473         entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o10">DockInterface</a>-&gt;InterfaceDereference(
01474             entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o10">DockInterface</a>-&gt;Context
01475             );
01476     }
01477 
01478     <a class="code" href="../../d9/d0/pnpiop_8h.html#a98">IopAcquireDeviceTreeLock</a>();
01479 
01480     RemoveEntryList( &amp;entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o0">Link</a> );
01481 
01482     <span class="comment">//</span>
01483     <span class="comment">// Check if the RelationsList pointer in the context structure is NULL.  If</span>
01484     <span class="comment">// so, this means we were cancelled because this eject is part of a new</span>
01485     <span class="comment">// larger eject.  In that case all we want to do is unlink and free the</span>
01486     <span class="comment">// context structure.</span>
01487     <span class="comment">//</span>
01488 
01489     <span class="comment">//</span>
01490     <span class="comment">// Two interesting points about such code.</span>
01491     <span class="comment">//</span>
01492     <span class="comment">// 1) If you wait forever to complete an eject of a dock, we *wait* forever</span>
01493     <span class="comment">//    in the Query profile change state. No sneaky adding another dock. You</span>
01494     <span class="comment">//    must finish what you started...</span>
01495     <span class="comment">// 2) Let's say you are ejecting a dock, and it is taking a long time. If</span>
01496     <span class="comment">//    you try to eject the parent, that eject will *not* grab this lower</span>
01497     <span class="comment">//    eject as we will block on the profile change semaphore. Again, finish</span>
01498     <span class="comment">//    what you started...</span>
01499     <span class="comment">//</span>
01500 
01501     <span class="keywordflow">if</span> (entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o4">RelationsList</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)  {
01502 
01503         <span class="keywordflow">if</span> (entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o7">ProfileChangingEject</a>) {
01504 
01505             <a class="code" href="../../d9/d0/pnpiop_8h.html#a384">IopHardwareProfileSetMarkedDocksEjected</a>();
01506         }
01507 
01508         <a class="code" href="../../d9/d0/pnpiop_8h.html#a315">IopInvalidateRelationsInList</a>( entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o4">RelationsList</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
01509 
01510         <span class="comment">//</span>
01511         <span class="comment">// Free the relations list</span>
01512         <span class="comment">//</span>
01513 
01514         <a class="code" href="../../d7/d1/pnprlist_8h.html#a10">IopFreeRelationList</a>( entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o4">RelationsList</a> );
01515 
01516     } <span class="keywordflow">else</span> {
01517 
01518         entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o8">DisplaySafeRemovalDialog</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01519     }
01520 
01521     <a class="code" href="../../d9/d0/pnpiop_8h.html#a99">IopReleaseDeviceTreeLock</a>();
01522 
01523     <span class="comment">//</span>
01524     <span class="comment">// Complete the event</span>
01525     <span class="comment">//</span>
01526     <span class="keywordflow">if</span> (entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o2">DeviceEvent</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01527 
01528         PpCompleteDeviceEvent( entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o2">DeviceEvent</a>, status );
01529     }
01530 
01531     <span class="keywordflow">if</span> (entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o8">DisplaySafeRemovalDialog</a>) {
01532 
01533         <a class="code" href="../../d6/d9/pnp_8h.html#a159">PpSetDeviceRemovalSafe</a>(entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o3">DeviceObject</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01534     }
01535 
01536     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( entry );
01537 }
01538 
01539 BOOLEAN
<a name="l01540"></a><a class="code" href="../../d9/d0/pnpiop_8h.html#a319">01540</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a319">IopQueuePendingSurpriseRemoval</a>(
01541     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject,
01542     IN <a class="code" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a> List,
01543     IN ULONG Problem
01544     )
01545 {
01546     <a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html">PPENDING_RELATIONS_LIST_ENTRY</a>   entry;
01547 
01548     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01549 
01550     entry = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html">PENDING_RELATIONS_LIST_ENTRY</a>) );
01551 
01552     <span class="keywordflow">if</span> (entry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01553 
01554         entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o3">DeviceObject</a> = DeviceObject;
01555         entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o4">RelationsList</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>;
01556         entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o6">Problem</a> = Problem;
01557         entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o7">ProfileChangingEject</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
01558 
01559         <a class="code" href="../../d9/d0/pnpiop_8h.html#a98">IopAcquireDeviceTreeLock</a>();
01560 
01561         InsertTailList(&amp;<a class="code" href="../../d1/d0/pnpdata_8c.html#a27">IopPendingSurpriseRemovals</a>, &amp;entry-&gt;<a class="code" href="../../d8/d4/struct__PENDING__RELATIONS__LIST__ENTRY.html#o0">Link</a>);
01562 
01563         <a class="code" href="../../d9/d0/pnpiop_8h.html#a99">IopReleaseDeviceTreeLock</a>();
01564 
01565         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01566     }
01567 
01568     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01569 }
01570 
01571 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01572"></a><a class="code" href="../../d9/d0/pnpiop_8h.html#a314">01572</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a314">IopUnlockDeviceRemovalRelations</a>(
01573     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>       DeviceObject,
01574     IN <a class="code" href="../../d6/d3/struct__RELATION__LIST.html">PRELATION_LIST</a>       RelationsList,
01575     IN <a class="code" href="../../d9/d0/pnpiop_8h.html#a114">UNLOCK_UNLINK_ACTION</a> UnlinkAction
01576     )
01577 
01578 <span class="comment">/*++</span>
01579 <span class="comment"></span>
01580 <span class="comment">Routine Description:</span>
01581 <span class="comment"></span>
01582 <span class="comment">    This routine unlocks the device tree deletion operation.</span>
01583 <span class="comment">    If there is any pending kernel deletion, this routine initiates</span>
01584 <span class="comment">    a worker thread to perform the work.</span>
01585 <span class="comment"></span>
01586 <span class="comment">Arguments:</span>
01587 <span class="comment"></span>
01588 <span class="comment">    DeviceObject - Supplies a pointer to the device object to which the remove</span>
01589 <span class="comment">        was originally targetted (as opposed to one of the relations).</span>
01590 <span class="comment"></span>
01591 <span class="comment">    DeviceRelations - supplies a pointer to the device's removal relations.</span>
01592 <span class="comment"></span>
01593 <span class="comment">    UnlinkAction - Specifies which devnodes will be unlinked from the devnode</span>
01594 <span class="comment">        tree.</span>
01595 <span class="comment"></span>
01596 <span class="comment">        UnLinkRemovedDeviceNodes - Devnodes which are no longer enumerated and</span>
01597 <span class="comment">            have been sent a REMOVE_DEVICE IRP are unlinked.</span>
01598 <span class="comment"></span>
01599 <span class="comment">        UnlinkAllDeviceNodesPendingClose - This is used when a device is</span>
01600 <span class="comment">            surprise removed.  Devnodes in RelationsList are unlinked from the</span>
01601 <span class="comment">            tree if they don't have children and aren't consuming any resources.</span>
01602 <span class="comment"></span>
01603 <span class="comment">        UnlinkOnlyChildDeviceNodesPendingClose - This is used when a device fails</span>
01604 <span class="comment">            while started.  We unlink any child devnodes of the device which</span>
01605 <span class="comment">            failed but not the failed device's devnode.</span>
01606 <span class="comment"></span>
01607 <span class="comment">Return Value:</span>
01608 <span class="comment"></span>
01609 <span class="comment">    NTSTATUS code.</span>
01610 <span class="comment"></span>
01611 <span class="comment">--*/</span>
01612 
01613 {
01614     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01615     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode, parent;
01616     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject, relatedDeviceObject;
01617     ULONG i;
01618     ULONG marker;
01619 
01620     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01621 
01622     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
01623     <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01624 
01625     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(RelationsList)) {
01626         marker = 0;
01627         <span class="keywordflow">while</span> (<a class="code" href="../../d7/d1/pnprlist_8h.html#a9">IopEnumerateRelations</a>( RelationsList,
01628                                       &amp;marker,
01629                                       &amp;deviceObject,
01630                                       <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01631                                       <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01632                                       <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
01633 
01634             deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
01635             parent = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o2">Parent</a>;
01636 
01637             <span class="comment">//</span>
01638             <span class="comment">// There are three different scenarios in which we want to unlink a</span>
01639             <span class="comment">// devnode from the tree.  The first case is tested in the first</span>
01640             <span class="comment">// part of the condition.  The other two in the second part.</span>
01641             <span class="comment">//</span>
01642             <span class="comment">// 1) A devnode is no longer enumerated and has been sent a</span>
01643             <span class="comment">//    remove IRP.</span>
01644             <span class="comment">//</span>
01645             <span class="comment">// 2) A devnode has been surprise removed, has no children, has</span>
01646             <span class="comment">//    no resources or they've been freed.  UnlinkAction will be</span>
01647             <span class="comment">//    UnlinkAllDeviceNodesPendingClose.</span>
01648             <span class="comment">//</span>
01649             <span class="comment">// 3) A devnode has failed and a surprise remove IRP has been sent.</span>
01650             <span class="comment">//    Then we want to remove children without resources but not the</span>
01651             <span class="comment">//    failed devnode itself.  UnlinkAction will be</span>
01652             <span class="comment">//    UnlinkOnlyChildDeviceNodesPendingClose.</span>
01653             <span class="comment">//</span>
01654 
01655             <span class="keywordflow">if</span> ((!(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; (<a class="code" href="../../d9/d0/pnpiop_8h.html#a9">DNF_ENUMERATED</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a32">DNF_REMOVE_PENDING_CLOSES</a>)) &amp;&amp;
01656                     <a class="code" href="../../d9/d0/pnpiop_8h.html#a77">IopDoesDevNodeHaveProblem</a>(deviceNode)) ||
01657                 (UnlinkAction != <a class="code" href="../../d9/d0/pnpiop_8h.html#a389a211">UnlinkRemovedDeviceNodes</a> &amp;&amp;
01658                     (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a32">DNF_REMOVE_PENDING_CLOSES</a>) &amp;&amp;
01659                     !(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a18">DNF_RESOURCE_ASSIGNED</a>) &amp;&amp;
01660                     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o1">Child</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
01661                     (UnlinkAction == <a class="code" href="../../d9/d0/pnpiop_8h.html#a389a212">UnlinkAllDeviceNodesPendingClose</a> ||
01662                      deviceObject != DeviceObject))) {
01663 
01664                 PIDBGMSG( PIDBG_REMOVAL,
01665                           (<span class="stringliteral">"IopUnlockDeviceRemovalRelations: Cleaning up registry values, instance = %wZ\n"</span>,
01666                           &amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>));
01667 
01668                 <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a25">IopCleanupDeviceRegistryValues</a>(&amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01669 
01670                 PIDBGMSG( PIDBG_REMOVAL,
01671                           (<span class="stringliteral">"IopUnlockDeviceRemovalRelations: Removing DevNode tree, DevNode = 0x%p\n"</span>,
01672                           deviceNode));
01673 
01674                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a251">IopRemoveTreeDeviceNode</a>(deviceNode);
01675 
01676                 <span class="keywordflow">if</span> (!(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a32">DNF_REMOVE_PENDING_CLOSES</a>)) {
01677                     <a class="code" href="../../d7/d1/pnprlist_8h.html#a16">IopRemoveRelationFromList</a>(RelationsList, deviceObject);
01678                 }
01679                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(deviceObject); <span class="comment">// Added during enum</span>
01680             }
01681 
01682             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o36">LockCount</a> &gt; 0);
01683 
01684             <span class="keywordflow">if</span> (--deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o36">LockCount</a> == 0) {
01685                 <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(&amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o12">EnumerationMutex</a>, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01686                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(deviceObject);
01687             }
01688 
01689             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(parent-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o36">LockCount</a> &gt; 0);
01690 
01691             <span class="keywordflow">if</span> (--parent-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o36">LockCount</a> == 0) {
01692                 <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(&amp;parent-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o12">EnumerationMutex</a>, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01693                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(parent-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>);
01694             }
01695         }
01696     }
01697 
01698     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>);
01699     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
01700 
01701     <span class="keywordflow">return</span> STATUS_SUCCESS;
01702 }
01703 
01704 <span class="comment">//</span>
01705 <span class="comment">// The routines below are specific to kernel mode PnP configMgr.</span>
01706 <span class="comment">//</span>
01707 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01708"></a><a class="code" href="../../d9/d0/pnpiop_8h.html#a306">01708</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a306">IopRequestDeviceRemoval</a>(
01709     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject,
01710     IN ULONG Problem
01711     )
01712 
01713 <span class="comment">/*++</span>
01714 <span class="comment"></span>
01715 <span class="comment">Routine Description:</span>
01716 <span class="comment"></span>
01717 <span class="comment">    This routine queues a work item to delete a device.  (This is because</span>
01718 <span class="comment">    to delete a device we need to lock device tree.  Most of the places where</span>
01719 <span class="comment">    we want to delete a device have DeviceNode Enumeration lock acquired.)</span>
01720 <span class="comment">    This is for IO internal use only.</span>
01721 <span class="comment"></span>
01722 <span class="comment">Arguments:</span>
01723 <span class="comment"></span>
01724 <span class="comment">    DeviceObject - Supplies a pointer to the device object to be eject.</span>
01725 <span class="comment"></span>
01726 <span class="comment">Return Value:</span>
01727 <span class="comment"></span>
01728 <span class="comment">    NTSTATUS code.</span>
01729 <span class="comment"></span>
01730 <span class="comment">--*/</span>
01731 
01732 {
01733     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01734 
01735     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01736 
01737     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(((<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode)-&gt;InstancePath.Length != 0);
01738 
01739     <span class="comment">//</span>
01740     <span class="comment">// Queue the event, we'll return immediately after it's queued.</span>
01741     <span class="comment">//</span>
01742 
01743     <span class="keywordflow">return</span> <a class="code" href="../../d6/d9/pnp_8h.html#a158">PpSetTargetDeviceRemove</a>( DeviceObject,
01744                                     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01745                                     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01746                                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01747                                     Problem,
01748                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01749                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01750                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01751                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01752 }
01753 
01754 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01755"></a><a class="code" href="../../d3/d0/pnpdel_8c.html#a5">01755</a> <a class="code" href="../../d3/d0/pnpdel_8c.html#a5">IopUnloadAttachedDriver</a>(
01756     IN <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject
01757     )
01758 
01759 <span class="comment">/*++</span>
01760 <span class="comment"></span>
01761 <span class="comment">Routine Description:</span>
01762 <span class="comment"></span>
01763 <span class="comment">    This function unloads the driver for the specified device object if it does not</span>
01764 <span class="comment">    control any other device object.</span>
01765 <span class="comment"></span>
01766 <span class="comment">Arguments:</span>
01767 <span class="comment"></span>
01768 <span class="comment">    DeviceObject - Supplies a pointer to a device object</span>
01769 <span class="comment"></span>
01770 <span class="comment">Return Value:</span>
01771 <span class="comment"></span>
01772 <span class="comment">    NTSTATUS code.</span>
01773 <span class="comment"></span>
01774 <span class="comment">--*/</span>
01775 
01776 {
01777     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01778     PWCHAR buffer;
01779     UNICODE_STRING unicodeName;
01780     PUNICODE_STRING serviceName = &amp;DriverObject-&gt;DriverExtension-&gt;ServiceKeyName;
01781 
01782     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01783 
01784     <span class="keywordflow">if</span> (DriverObject-&gt;DriverSection != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01785         <span class="keywordflow">if</span> (DriverObject-&gt;DeviceObject == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01786             buffer = (PWCHAR) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(
01787                                  <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
01788                                  <a class="code" href="../../d6/d0/cmdat_8c.html#a25">CmRegistryMachineSystemCurrentControlSetServices</a>.Length +
01789                                      serviceName-&gt;Length + <span class="keyword">sizeof</span>(WCHAR) +
01790                                      <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\"</span>));
01791             <span class="keywordflow">if</span> (!buffer) {
01792                 <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01793             }
01794             swprintf(buffer,
01795                      <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"%s\\%s"</span>,
01796                      <a class="code" href="../../d6/d0/cmdat_8c.html#a25">CmRegistryMachineSystemCurrentControlSetServices</a>.Buffer,
01797                      serviceName-&gt;Buffer);
01798             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeName, buffer);
01799             status = ZwUnloadDriver(&amp;unicodeName);
01800 <span class="preprocessor">#if DBG</span>
01801 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01802                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"****** Unloaded driver (%wZ)\n"</span>, serviceName);
01803             } <span class="keywordflow">else</span> {
01804                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"****** Error unloading driver (%wZ), status = 0x%08X\n"</span>, serviceName, status);
01805             }
01806 <span class="preprocessor">#endif</span>
01807 <span class="preprocessor"></span>            <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(unicodeName.Buffer);
01808         }
01809 <span class="preprocessor">#if DBG</span>
01810 <span class="preprocessor"></span>        <span class="keywordflow">else</span> {
01811             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"****** Skipping unload of driver (%wZ), DriverObject-&gt;DeviceObject != NULL\n"</span>, serviceName);
01812         }
01813 <span class="preprocessor">#endif</span>
01814 <span class="preprocessor"></span>    }
01815 <span class="preprocessor">#if DBG</span>
01816 <span class="preprocessor"></span>    <span class="keywordflow">else</span> {
01817         <span class="comment">//</span>
01818         <span class="comment">// This is a boot driver, can't be unloaded just return SUCCESS</span>
01819         <span class="comment">//</span>
01820         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"****** Skipping unload of boot driver (%wZ)\n"</span>, serviceName);
01821     }
01822 <span class="preprocessor">#endif</span>
01823 <span class="preprocessor"></span>    <span class="keywordflow">return</span> STATUS_SUCCESS;
01824 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:16 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
