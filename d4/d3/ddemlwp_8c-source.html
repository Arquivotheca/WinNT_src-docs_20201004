<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: ddemlwp.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>ddemlwp.c</h1><a href="../../d3/d4/ddemlwp_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: ddemlwp.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* DDE Manager client side window procedures</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* Created: 11/3/91 Sanford Staab</span>
00009 <span class="comment">\***************************************************************************/</span>
00010 
00011 <span class="preprocessor">#include "<a class="code" href="../../d7/d3/w32_2ntuser_2client_2precomp_8h.html">precomp.h</a>"</span>
00012 <span class="preprocessor">#pragma hdrstop</span>
00013 <span class="preprocessor"></span>
00014 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d3/d4/ddemlwp_8c.html#a0">ProcessDDEMLInitiate</a>(<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html">PCL_INSTANCE_INFO</a> pcii, HWND hwndClient,
00015         GATOM aServer, GATOM aTopic);
00016 
00017 <span class="comment">/***************************************************************************\</span>
00018 <span class="comment">* DDEMLMotherWndProc</span>
00019 <span class="comment">*</span>
00020 <span class="comment">* Description:</span>
00021 <span class="comment">* Handles WM_DDE_INITIATE messages for DDEML and holds all the other windows</span>
00022 <span class="comment">* for a DDEML instance.</span>
00023 <span class="comment">*</span>
00024 <span class="comment">* History:</span>
00025 <span class="comment">* 12-29-92 sanfords Created.</span>
00026 <span class="comment">\***************************************************************************/</span>
<a name="l00027"></a><a class="code" href="../../d3/d4/ddemlwp_8c.html#a1">00027</a> LRESULT <a class="code" href="../../d3/d4/ddemlwp_8c.html#a1">DDEMLMotherWndProc</a>(
00028     HWND hwnd,
00029     UINT message,
00030     WPARAM wParam,
00031     LPARAM lParam)
00032 {
00033     <span class="keywordflow">switch</span> (message) {
00034     <span class="keywordflow">case</span> UM_REGISTER:
00035     <span class="keywordflow">case</span> UM_UNREGISTER:
00036         <span class="keywordflow">return</span>(<a class="code" href="../../d9/d6/register_8c.html#a2">ProcessRegistrationMessage</a>(hwnd, message, wParam, lParam));
00037 
00038     <span class="keywordflow">case</span> WM_DDE_INITIATE:
00039         <a class="code" href="../../d3/d4/ddemlwp_8c.html#a0">ProcessDDEMLInitiate</a>((<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html">PCL_INSTANCE_INFO</a>)<a class="code" href="../../d5/d9/cltxt_8h.html#a11">GetWindowLongPtr</a>(hwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a152">GWLP_PCI</a>),
00040                 (HWND)wParam, (ATOM)LOWORD(lParam), (ATOM)HIWORD(lParam));
00041         <span class="keywordflow">return</span>(0);
00042 
00043     }
00044     <span class="keywordflow">return</span>(<a class="code" href="../../d5/d9/cltxt_8h.html#a15">DefWindowProc</a>(hwnd, message, wParam, lParam));
00045 }
00046 
00047 
00048 
00049 <span class="comment">/***************************************************************************\</span>
00050 <span class="comment">* ProcessDDEMLInitiate</span>
00051 <span class="comment">*</span>
00052 <span class="comment">* Description:</span>
00053 <span class="comment">*</span>
00054 <span class="comment">*   WM_DDE_INITIATE messages are processed here.</span>
00055 <span class="comment">*</span>
00056 <span class="comment">* History:</span>
00057 <span class="comment">* 12-29-92   sanfords    Created.</span>
00058 <span class="comment">\***************************************************************************/</span>
<a name="l00059"></a><a class="code" href="../../d3/d4/ddemlwp_8c.html#a0">00059</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d3/d4/ddemlwp_8c.html#a0">ProcessDDEMLInitiate</a>(
00060 <a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html">PCL_INSTANCE_INFO</a> pcii,
00061 HWND hwndClient,
00062 GATOM aServer,
00063 GATOM aTopic)
00064 {
00065     CONVCONTEXT cc = {
00066         <span class="keyword">sizeof</span>(CONVCONTEXT),
00067         0,
00068         0,
00069         CP_WINANSI,
00070         0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
00071         0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
00072         {
00073             <span class="keyword">sizeof</span>(SECURITY_QUALITY_OF_SERVICE),
00074             SecurityImpersonation,
00075             SECURITY_STATIC_TRACKING,
00076             <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
00077         }
00078     };
00079     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> flags = ST_INLIST;
00080     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fWild;
00081     HDDEDATA hData;
00082     HWND hwndServer;
00083     <a class="code" href="../../d1/d6/structtagSERVER__LOOKUP.html">PSERVER_LOOKUP</a> psl;
00084     PHSZPAIR php;
00085     HSZPAIR hp[2];
00086     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a51">LATOM</a> laService, laFree1 = 0;
00087     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a51">LATOM</a> laTopic, laFree2 = 0;
00088     <a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html">PSVR_CONV_INFO</a> psi;
00089     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a51">LATOM</a> *plaNameService;
00090     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndClient;
00091     <a class="code" href="../../d7/d0/structtagCLS.html">PCLS</a> pcls;
00092 
00093     <span class="keywordflow">if</span> (pcii == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00094         <span class="keywordflow">return</span>;     <span class="comment">// we aren't done being initiated yet.</span>
00095     }
00096 
00097     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a6">EnterDDECrit</a>;
00098 
00099     <span class="keywordflow">if</span> (pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o7">afCmd</a> &amp; CBF_FAIL_CONNECTIONS || !<a class="code" href="../../d3/d9/client_2wow_8c.html#a11">IsWindow</a>(hwndClient)) {
00100         <span class="keywordflow">goto</span> Exit;
00101     }
00102 
00103     pwndClient = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hwndClient);
00104     <span class="keywordflow">if</span> (pwndClient == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) <span class="keywordflow">goto</span> Exit;
00105 
00106     pcls = (<a class="code" href="../../d7/d0/structtagCLS.html">PCLS</a>)<a class="code" href="../../d6/d0/usercli_8h.html#a24">REBASEALWAYS</a>(pwndClient, pcls);
00107     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndClient, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a570">WFANSIPROC</a>)) {
00108         <span class="keywordflow">if</span> (pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o1">atomClassName</a> == <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o12">atomSysClass</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a86">ICLS_DDEMLCLIENTW</a>]) {
00109             flags |= ST_ISLOCAL;
00110         }
00111     } <span class="keywordflow">else</span> {
00112         <span class="keywordflow">if</span> (pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o1">atomClassName</a> == <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o12">atomSysClass</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a85">ICLS_DDEMLCLIENTA</a>]) {
00113             flags |= ST_ISLOCAL;
00114         }
00115     }
00116 
00117     <span class="keywordflow">if</span> (flags &amp; ST_ISLOCAL) {
00118         <span class="comment">/*</span>
00119 <span class="comment">         * Make sure other guy allows self-connections if that's what this is.</span>
00120 <span class="comment">         */</span>
00121         <span class="keywordflow">if</span> (pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o1">hInstServer</a> == (HANDLE)<a class="code" href="../../d5/d9/cltxt_8h.html#a11">GetWindowLongPtr</a>(hwndClient, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a155">GWLP_SHINST</a>)) {
00122             <span class="keywordflow">if</span> (pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o7">afCmd</a> &amp; CBF_FAIL_SELFCONNECTIONS) {
00123                 <span class="keywordflow">goto</span> Exit;
00124             }
00125             flags |= ST_ISSELF;
00126         }
00127 
00128         <a class="code" href="../../d0/d1/xact_8c.html#a1">GetConvContext</a>(hwndClient, (LONG *)&amp;cc);
00129         <span class="keywordflow">if</span> (GetWindowLong(hwndClient, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a154">GWL_CONVSTATE</a>) &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a158">CLST_SINGLE_INITIALIZING</a>) {
00130             flags &amp;= ~ST_INLIST;
00131         }
00132     } <span class="keywordflow">else</span> {
00133         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a169">NtUserDdeGetQualityOfService</a>(hwndClient, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;cc.qos);
00134     }
00135 
00136 <span class="comment">/***************************************************************************\</span>
00137 <span class="comment">*</span>
00138 <span class="comment">* Server window creation is minimized by only creating one window per</span>
00139 <span class="comment">* Instance/Service/Topic set. This should be all that is needed and</span>
00140 <span class="comment">* duplicate connections (ie where the server/client window pair is identical</span>
00141 <span class="comment">* to another conversation) should not happen. However, if some dumb</span>
00142 <span class="comment">* server app attempts to create a duplicate conversation by having</span>
00143 <span class="comment">* duplicate service/topic pairs passed back from a XTYP_WILD_CONNECT</span>
00144 <span class="comment">* callback we will not honor the request.</span>
00145 <span class="comment">*</span>
00146 <span class="comment">* The INSTANCE_INFO structure holds a pointer to an array of SERVERLOOKUP</span>
00147 <span class="comment">* structures each entry of which references the hwndServer that supports</span>
00148 <span class="comment">* all conversations on that service/topic pair. The hwndServer windows</span>
00149 <span class="comment">* in turn have window words that reference the first member in a linked</span>
00150 <span class="comment">* list of SVR_CONV_INFO structures, one for each conversation on that</span>
00151 <span class="comment">* service/topic pair.</span>
00152 <span class="comment">*</span>
00153 <span class="comment">\***************************************************************************/</span>
00154 
00155     laFree1 = laService = <a class="code" href="../../d4/d2/hsz_8c.html#a13">GlobalToLocalAtom</a>(aServer);
00156     laFree2 = laTopic = <a class="code" href="../../d4/d2/hsz_8c.html#a13">GlobalToLocalAtom</a>(aTopic);
00157 
00158     plaNameService = pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o11">plaNameService</a>;
00159     <span class="keywordflow">if</span> (!laService &amp;&amp; pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o7">afCmd</a> &amp; APPCMD_FILTERINITS &amp;&amp; *plaNameService == 0) {
00160         <span class="comment">/*</span>
00161 <span class="comment">         * no WILDCONNECTS to servers with no registered names while filtering.</span>
00162 <span class="comment">         */</span>
00163         <span class="keywordflow">goto</span> Exit;
00164     }
00165     <span class="keywordflow">if</span> ((pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o7">afCmd</a> &amp; APPCMD_FILTERINITS) &amp;&amp; laService) {
00166         <span class="comment">/*</span>
00167 <span class="comment">         * if we can't find the aServer in this instance's service name</span>
00168 <span class="comment">         * list, don't bother the server.</span>
00169 <span class="comment">         */</span>
00170         <span class="keywordflow">while</span> (*plaNameService != 0 &amp;&amp; *plaNameService != laService) {
00171             plaNameService++;
00172         }
00173         <span class="keywordflow">if</span> (*plaNameService == 0) {
00174             <span class="keywordflow">goto</span> Exit;
00175         }
00176     }
00177     hp[0].hszSvc = <a class="code" href="../../d0/d4/ddemlcli_8h.html#a14">NORMAL_HSZ_FROM_LATOM</a>(laService);
00178     hp[0].hszTopic = <a class="code" href="../../d0/d4/ddemlcli_8h.html#a14">NORMAL_HSZ_FROM_LATOM</a>(laTopic);
00179     hp[1].hszSvc = 0;
00180     hp[1].hszTopic = 0;
00181     fWild = !laService || !laTopic;
00182 
00183     hData = <a class="code" href="../../d0/d4/ddemlcli_8h.html#a127">DoCallback</a>(pcii,
00184         (WORD)(fWild ? XTYP_WILDCONNECT : XTYP_CONNECT),
00185         0,
00186         (HCONV)0,
00187         hp[0].hszTopic,
00188         hp[0].hszSvc,
00189         (HDDEDATA)0,
00190         flags &amp; ST_ISLOCAL ? (ULONG_PTR)&amp;cc : 0,
00191         (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(flags &amp; ST_ISSELF) ? 1 : 0);
00192 
00193     <span class="keywordflow">if</span> (!hData) {
00194         <span class="keywordflow">goto</span> Exit;
00195     }
00196 
00197     <span class="keywordflow">if</span> (fWild) {
00198         php = (PHSZPAIR)<a class="code" href="../../d0/d9/hdata_8c.html#a5">DdeAccessData</a>(hData, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00199         <span class="keywordflow">if</span> (php == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00200             <span class="keywordflow">goto</span> Exit;
00201         }
00202     } <span class="keywordflow">else</span> {
00203         php = hp;
00204     }
00205 
00206     <span class="keywordflow">while</span> (php-&gt;hszSvc &amp;&amp; php-&gt;hszTopic) {
00207 
00208         psi = (<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html">PSVR_CONV_INFO</a>)<a class="code" href="../../d0/d4/ddemlcli_8h.html#a0">DDEMLAlloc</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html">SVR_CONV_INFO</a>));
00209         <span class="keywordflow">if</span> (psi == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00210             <span class="keywordflow">break</span>;
00211         }
00212 
00213         laService = <a class="code" href="../../d0/d4/ddemlcli_8h.html#a13">LATOM_FROM_HSZ</a>(php-&gt;hszSvc);
00214         laTopic = <a class="code" href="../../d0/d4/ddemlcli_8h.html#a13">LATOM_FROM_HSZ</a>(php-&gt;hszTopic);
00215 
00216         hwndServer = 0;
00217         <span class="keywordflow">if</span> (pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o14">cServerLookupAlloc</a>) {
00218             <span class="keywordtype">int</span> i;
00219             <span class="comment">/*</span>
00220 <span class="comment">             * See if there already exists a server window for this</span>
00221 <span class="comment">             * aServer/aTopic pair</span>
00222 <span class="comment">             */</span>
00223             <span class="keywordflow">for</span> (i = pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o14">cServerLookupAlloc</a>; i; i--) {
00224                 <span class="keywordflow">if</span> (pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o13">aServerLookup</a>[i - 1].<a class="code" href="../../d1/d6/structtagSERVER__LOOKUP.html#o0">laService</a> == laService &amp;&amp;
00225                         pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o13">aServerLookup</a>[i - 1].<a class="code" href="../../d1/d6/structtagSERVER__LOOKUP.html#o1">laTopic</a> == laTopic) {
00226                     <a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html">PSVR_CONV_INFO</a> psiT;
00227                     <a class="code" href="../../d2/d1/structtagCONV__INFO.html">PCONV_INFO</a> pcoi;
00228 
00229                     hwndServer = pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o13">aServerLookup</a>[i - 1].<a class="code" href="../../d1/d6/structtagSERVER__LOOKUP.html#o2">hwndServer</a>;
00230                     <span class="comment">/*</span>
00231 <span class="comment">                     * Now make sure this window isn't some bogus idiot</span>
00232 <span class="comment">                     * trying to create a second conversation from the</span>
00233 <span class="comment">                     * same client window that is already talking to</span>
00234 <span class="comment">                     * our existing server window.</span>
00235 <span class="comment">                     */</span>
00236                     psiT = (<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html">PSVR_CONV_INFO</a>)<a class="code" href="../../d5/d9/cltxt_8h.html#a11">GetWindowLongPtr</a>(hwndServer, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a160">GWLP_PSI</a>);
00237                     <span class="keywordflow">for</span> (pcoi = &amp;psiT-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>; pcoi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; pcoi = pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o0">next</a>) {
00238                         <span class="keywordflow">if</span> (pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o6">hwndPartner</a> == hwndClient) {
00239                             hwndServer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00240                             <span class="keywordflow">break</span>;
00241                         }
00242                     }
00243                     <span class="keywordflow">break</span>;
00244                 }
00245             }
00246         }
00247 
00248         <span class="keywordflow">if</span> (hwndServer == 0) {
00249 
00250             <span class="comment">// no server window exists - make one.</span>
00251 
00252             <a class="code" href="../../d0/d4/ddemlcli_8h.html#a7">LeaveDDECrit</a>;
00253             <span class="keywordflow">if</span> (pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o16">flags</a> &amp; <a class="code" href="../../d0/d4/ddemlcli_8h.html#a50">IIF_UNICODE</a>) {
00254                 hwndServer = CreateWindowW((LPWSTR)(<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o12">atomSysClass</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a88">ICLS_DDEMLSERVERW</a>]),
00255                                           <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">""</span>,
00256                                           WS_CHILD,
00257                                           0, 0, 0, 0,
00258                                           pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o4">hwndMother</a>,
00259                                           (HMENU)0,
00260                                           0,
00261                                           (<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00262             } <span class="keywordflow">else</span> {
00263                 hwndServer = CreateWindowA((LPSTR)(<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o12">atomSysClass</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a87">ICLS_DDEMLSERVERA</a>]),
00264                                           <span class="stringliteral">""</span>,
00265                                           WS_CHILD,
00266                                           0, 0, 0, 0,
00267                                           pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o4">hwndMother</a>,
00268                                           (HMENU)0,
00269                                           0,
00270                                           (<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00271             }
00272             <a class="code" href="../../d0/d4/ddemlcli_8h.html#a6">EnterDDECrit</a>;
00273 
00274             <span class="keywordflow">if</span> (hwndServer == 0) {
00275                 <a class="code" href="../../d0/d4/ddemlcli_8h.html#a2">DDEMLFree</a>(psi);
00276                 <span class="keywordflow">break</span>;
00277             }
00278             <span class="comment">// SetWindowLongPtr(hwndServer, GWLP_PSI, (LONG)NULL); // Zero init.</span>
00279 
00280             <span class="comment">// put the window into the lookup list</span>
00281 
00282             <span class="keywordflow">if</span> (pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o13">aServerLookup</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00283                 psl = (<a class="code" href="../../d1/d6/structtagSERVER__LOOKUP.html">PSERVER_LOOKUP</a>)<a class="code" href="../../d0/d4/ddemlcli_8h.html#a0">DDEMLAlloc</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d1/d6/structtagSERVER__LOOKUP.html">SERVER_LOOKUP</a>));
00284             } <span class="keywordflow">else</span> {
00285                 psl = (<a class="code" href="../../d1/d6/structtagSERVER__LOOKUP.html">PSERVER_LOOKUP</a>)<a class="code" href="../../d0/d4/ddemlcli_8h.html#a1">DDEMLReAlloc</a>(pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o13">aServerLookup</a>,
00286                         <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d6/structtagSERVER__LOOKUP.html">SERVER_LOOKUP</a>) * (pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o14">cServerLookupAlloc</a> + 1));
00287             }
00288             <span class="keywordflow">if</span> (psl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00289                 RIPMSG1(RIP_WARNING, <span class="stringliteral">"ProcessDDEMLInitiate:hwndServer (%x) destroyed due to low memory."</span>, hwndServer);
00290                 <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a159">NtUserDestroyWindow</a>(hwndServer);
00291                 <a class="code" href="../../d0/d4/ddemlcli_8h.html#a2">DDEMLFree</a>(psi);
00292                 <span class="keywordflow">break</span>;
00293             }
00294 
00295             <a class="code" href="../../d4/d2/hsz_8c.html#a15">IncLocalAtomCount</a>(laService); <span class="comment">// for SERVER_LOOKUP</span>
00296             psl[pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o14">cServerLookupAlloc</a>].<a class="code" href="../../d1/d6/structtagSERVER__LOOKUP.html#o0">laService</a> = laService;
00297             <a class="code" href="../../d4/d2/hsz_8c.html#a15">IncLocalAtomCount</a>(laTopic); <span class="comment">// for SERVER_LOOKUP</span>
00298             psl[pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o14">cServerLookupAlloc</a>].<a class="code" href="../../d1/d6/structtagSERVER__LOOKUP.html#o1">laTopic</a> = laTopic;
00299             psl[pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o14">cServerLookupAlloc</a>].<a class="code" href="../../d1/d6/structtagSERVER__LOOKUP.html#o2">hwndServer</a> = hwndServer;
00300             pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o13">aServerLookup</a> = psl;
00301             pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o14">cServerLookupAlloc</a>++;
00302             <span class="comment">// DumpServerLookupTable("After addition:", hwndServer, psl, pcii-&gt;cServerLookupAlloc);</span>
00303         }
00304 
00305         psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o0">next</a> = (<a class="code" href="../../d2/d1/structtagCONV__INFO.html">PCONV_INFO</a>)<a class="code" href="../../d5/d9/cltxt_8h.html#a11">GetWindowLongPtr</a>(hwndServer, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a160">GWLP_PSI</a>);
00306         <a class="code" href="../../d5/d9/cltxt_8h.html#a12">SetWindowLongPtr</a>(hwndServer, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a160">GWLP_PSI</a>, (LONG_PTR)psi);
00307         psi-&gt;ci.pcii = pcii;
00308         <span class="comment">// psi-&gt;ci.hUser = 0;</span>
00309         psi-&gt;ci.hConv = (HCONV)<a class="code" href="../../d3/d8/handles_8c.html#a6">CreateHandle</a>((ULONG_PTR)psi,
00310                 <a class="code" href="../../d0/d4/ddemlcli_8h.html#a35">HTYPE_SERVER_CONVERSATION</a>, <a class="code" href="../../d0/d4/ddemlcli_8h.html#a28">InstFromHandle</a>(pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o2">hInstClient</a>));
00311         psi-&gt;ci.laService = laService;
00312         <a class="code" href="../../d4/d2/hsz_8c.html#a15">IncLocalAtomCount</a>(laService); <span class="comment">// for server window</span>
00313         psi-&gt;ci.laTopic = laTopic;
00314         <a class="code" href="../../d4/d2/hsz_8c.html#a15">IncLocalAtomCount</a>(laTopic); <span class="comment">// for server window</span>
00315         psi-&gt;ci.hwndPartner = hwndClient;
00316         psi-&gt;ci.hwndConv = hwndServer;
00317         psi-&gt;ci.state = (WORD)(flags | ST_CONNECTED | pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o15">ConvStartupState</a>);
00318         <a class="code" href="../../d0/d4/ddemlcli_8h.html#a112">SetCommonStateFlags</a>(hwndClient, hwndServer, &amp;psi-&gt;ci.state);
00319         psi-&gt;ci.laServiceRequested = laFree1;
00320         <a class="code" href="../../d4/d2/hsz_8c.html#a15">IncLocalAtomCount</a>(psi-&gt;ci.laServiceRequested); <span class="comment">// for server window</span>
00321         <span class="comment">// psi-&gt;ci.pxiIn = NULL;</span>
00322         <span class="comment">// psi-&gt;ci.pxiOut = NULL;</span>
00323         <span class="comment">// psi-&gt;ci.dmqIn = NULL;</span>
00324         <span class="comment">// psi-&gt;ci.dmqOut = NULL;</span>
00325         <span class="comment">// psi-&gt;ci.aLinks = NULL;</span>
00326         <span class="comment">// psi-&gt;ci.cLinks = 0;</span>
00327         <span class="comment">// psi-&gt;ci.cLocks = 0;</span>
00328 
00329         <a class="code" href="../../d0/d4/ddemlcli_8h.html#a7">LeaveDDECrit</a>;
00330         <a class="code" href="../../d0/d4/ddemlcli_8h.html#a9">CheckDDECritOut</a>;
00331         <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(hwndClient, WM_DDE_ACK, (WPARAM)hwndServer,
00332                 MAKELONG(<a class="code" href="../../d4/d2/hsz_8c.html#a12">LocalToGlobalAtom</a>(laService), <a class="code" href="../../d4/d2/hsz_8c.html#a12">LocalToGlobalAtom</a>(laTopic)));
00333         <a class="code" href="../../d0/d4/ddemlcli_8h.html#a6">EnterDDECrit</a>;
00334 
00335         <span class="keywordflow">if</span> (!(pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o7">afCmd</a> &amp; CBF_SKIP_CONNECT_CONFIRMS)) {
00336             <a class="code" href="../../d0/d4/ddemlcli_8h.html#a127">DoCallback</a>(pcii,
00337                     (WORD)XTYP_CONNECT_CONFIRM,
00338                     0,
00339                     psi-&gt;ci.hConv,
00340                     (HSZ)laTopic,
00341                     (HSZ)laService,
00342                     (HDDEDATA)0,
00343                     0,
00344                     (flags &amp; ST_ISSELF) ? 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a> : 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
00345         }
00346 
00347         <a class="code" href="../../d0/d4/ddemlcli_8h.html#a5">MONCONV</a>((<a class="code" href="../../d2/d1/structtagCONV__INFO.html">PCONV_INFO</a>)psi, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00348 
00349         <span class="keywordflow">if</span> (!(flags &amp; ST_INLIST)) {
00350             <span class="keywordflow">break</span>;      <span class="comment">// our partner's only gonna take the first one anyway.</span>
00351         }
00352         php++;
00353     }
00354 
00355     <span class="keywordflow">if</span> (fWild) {
00356         <a class="code" href="../../d0/d9/hdata_8c.html#a6">DdeUnaccessData</a>(hData);
00357         <a class="code" href="../../d0/d9/hdata_8c.html#a8">InternalFreeDataHandle</a>(hData, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00358     }
00359 
00360 Exit:
00361     DeleteAtom(laFree1);
00362     DeleteAtom(laFree2);
00363     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a7">LeaveDDECrit</a>;
00364     <span class="keywordflow">return</span>;
00365 }
00366 
00367 <span class="comment">/***************************************************************************\</span>
00368 <span class="comment">* DDEMLClientWndProc</span>
00369 <span class="comment">*</span>
00370 <span class="comment">* Description:</span>
00371 <span class="comment">* Handles DDE client messages for DDEML.</span>
00372 <span class="comment">*</span>
00373 <span class="comment">* History:</span>
00374 <span class="comment">* 11-12-91 sanfords Created.</span>
00375 <span class="comment">\***************************************************************************/</span>
<a name="l00376"></a><a class="code" href="../../d3/d4/ddemlwp_8c.html#a2">00376</a> LRESULT <a class="code" href="../../d3/d4/ddemlwp_8c.html#a2">DDEMLClientWndProc</a>(
00377     HWND hwnd,
00378     UINT message,
00379     WPARAM wParam,
00380     LPARAM lParam)
00381 {
00382     <a class="code" href="../../d1/d0/structtagCL__CONV__INFO.html">PCL_CONV_INFO</a> pci, pciNew;
00383     LONG lState;
00384     LRESULT lRet = 0;
00385     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
00386     <a class="code" href="../../d7/d0/structtagCLS.html">PCLS</a> pcls;
00387 
00388     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a6">EnterDDECrit</a>;
00389 
00390     pci = (<a class="code" href="../../d1/d0/structtagCL__CONV__INFO.html">PCL_CONV_INFO</a>)<a class="code" href="../../d5/d9/cltxt_8h.html#a11">GetWindowLongPtr</a>(hwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a152">GWLP_PCI</a>);
00391     UserAssert(pci == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || pci-&gt;<a class="code" href="../../d1/d0/structtagCL__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o7">hwndConv</a> == hwnd);
00392 
00393     <span class="keywordflow">switch</span> (message) {
00394     <span class="keywordflow">case</span> WM_DDE_ACK:
00395         lState = GetWindowLong(hwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a154">GWL_CONVSTATE</a>);
00396         <span class="keywordflow">if</span> (lState != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a157">CLST_CONNECTED</a>) {
00397 
00398             <span class="comment">// Initiation mode</span>
00399 
00400             pciNew = (<a class="code" href="../../d1/d0/structtagCL__CONV__INFO.html">PCL_CONV_INFO</a>)<a class="code" href="../../d0/d4/ddemlcli_8h.html#a0">DDEMLAlloc</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d1/d0/structtagCL__CONV__INFO.html">CL_CONV_INFO</a>));
00401             <span class="keywordflow">if</span> (pciNew == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
00402                     (pci != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; lState == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a158">CLST_SINGLE_INITIALIZING</a>)) {
00403                 <a class="code" href="../../d0/d8/ntcftxt_8h.html#a20">PostMessage</a>((HWND)wParam, WM_DDE_TERMINATE, (WPARAM)hwnd, 0);
00404                 <span class="keywordflow">goto</span> Exit;
00405             }
00406 
00407             <span class="comment">// PCL_CONV_INFO initialization</span>
00408 
00409             pciNew-&gt;<a class="code" href="../../d1/d0/structtagCL__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o1">pcii</a> = <a class="code" href="../../d0/d4/instance_8c.html#a7">ValidateInstance</a>((HANDLE)<a class="code" href="../../d5/d9/cltxt_8h.html#a11">GetWindowLongPtr</a>(hwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a156">GWLP_CHINST</a>));
00410 
00411             <span class="keywordflow">if</span> (pciNew-&gt;<a class="code" href="../../d1/d0/structtagCL__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o1">pcii</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00412                 <a class="code" href="../../d0/d4/ddemlcli_8h.html#a2">DDEMLFree</a>(pciNew);
00413                 <span class="keywordflow">goto</span> Exit;
00414             }
00415 
00416             pciNew-&gt;<a class="code" href="../../d1/d0/structtagCL__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o0">next</a> = (<a class="code" href="../../d2/d1/structtagCONV__INFO.html">PCONV_INFO</a>)pci; <span class="comment">// pci may be NULL</span>
00417             <span class="comment">//</span>
00418             <span class="comment">// Seting GWLP_PCI gives feedback to ConnectConv() which issued</span>
00419             <span class="comment">// the WM_DDE_INITIATE message.</span>
00420             <span class="comment">//</span>
00421             <a class="code" href="../../d5/d9/cltxt_8h.html#a12">SetWindowLongPtr</a>(hwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a152">GWLP_PCI</a>, (LONG_PTR)pciNew);
00422             <span class="comment">// pciNew-&gt;hUser = 0; // Zero init.</span>
00423 
00424             <span class="comment">// BUG: If this fails we can have some nasty problems</span>
00425             pciNew-&gt;ci.hConv = (HCONV)<a class="code" href="../../d3/d8/handles_8c.html#a6">CreateHandle</a>((ULONG_PTR)pciNew,
00426                     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a36">HTYPE_CLIENT_CONVERSATION</a>, <a class="code" href="../../d0/d4/ddemlcli_8h.html#a28">InstFromHandle</a>(pciNew-&gt;ci.pcii-&gt;hInstClient));
00427 
00428             pciNew-&gt;ci.laService = <a class="code" href="../../d4/d2/hsz_8c.html#a13">GlobalToLocalAtom</a>(LOWORD(lParam)); <span class="comment">// pci copy</span>
00429             GlobalDeleteAtom(LOWORD(lParam));
00430             pciNew-&gt;ci.laTopic = <a class="code" href="../../d4/d2/hsz_8c.html#a13">GlobalToLocalAtom</a>(HIWORD(lParam)); <span class="comment">// pci copy</span>
00431             GlobalDeleteAtom(HIWORD(lParam));
00432             pciNew-&gt;ci.hwndPartner = (HWND)wParam;
00433             pciNew-&gt;ci.hwndConv = hwnd;
00434             pciNew-&gt;ci.state = (WORD)(ST_CONNECTED | ST_CLIENT |
00435                     pciNew-&gt;ci.pcii-&gt;ConvStartupState);
00436             <a class="code" href="../../d0/d4/ddemlcli_8h.html#a112">SetCommonStateFlags</a>(hwnd, (HWND)wParam, &amp;pciNew-&gt;ci.state);
00437 
00438             pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>((HWND)wParam);
00439 
00440             <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) <span class="keywordflow">goto</span> Exit;
00441             pcls = (<a class="code" href="../../d7/d0/structtagCLS.html">PCLS</a>)<a class="code" href="../../d6/d0/usercli_8h.html#a24">REBASEALWAYS</a>(pwnd, pcls);
00442 
00443             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a570">WFANSIPROC</a>)) {
00444                 <span class="keywordflow">if</span> (pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o1">atomClassName</a> == <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o12">atomSysClass</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a88">ICLS_DDEMLSERVERW</a>]) {
00445                     pciNew-&gt;ci.state |= ST_ISLOCAL;
00446                 }
00447             } <span class="keywordflow">else</span> {
00448                 <span class="keywordflow">if</span> (pcls-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o1">atomClassName</a> == <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o12">atomSysClass</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a87">ICLS_DDEMLSERVERA</a>]) {
00449                     pciNew-&gt;ci.state |= ST_ISLOCAL;
00450                 }
00451             }
00452 
00453             <span class="comment">// pciNew-&gt;ci.laServiceRequested = 0; // Set by InitiateEnumerationProc()</span>
00454             <span class="comment">// pciNew-&gt;ci.pxiIn = 0;</span>
00455             <span class="comment">// pciNew-&gt;ci.pxiOut = 0;</span>
00456             <span class="comment">// pciNew-&gt;ci.dmqIn = 0;</span>
00457             <span class="comment">// pciNew-&gt;ci.dmqOut = 0;</span>
00458             <span class="comment">// pciNew-&gt;ci.aLinks = NULL;</span>
00459             <span class="comment">// pciNew-&gt;ci.cLinks = 0;</span>
00460             <span class="comment">// pciNew-&gt;ci.cLocks = 0;</span>
00461             <span class="keywordflow">goto</span> Exit;
00462         }
00463         <span class="comment">// fall through to handle posted messages here.</span>
00464 
00465     <span class="keywordflow">case</span> WM_DDE_DATA:
00466         <a class="code" href="../../d3/d4/ddemlwp_8c.html#a5">ProcessAsyncDDEMsg</a>((<a class="code" href="../../d2/d1/structtagCONV__INFO.html">PCONV_INFO</a>)pci, message, (HWND)wParam, lParam);
00467         <span class="keywordflow">goto</span> Exit;
00468 
00469     <span class="keywordflow">case</span> WM_DDE_TERMINATE:
00470     <span class="keywordflow">case</span> WM_DESTROY:
00471         {
00472             <a class="code" href="../../d3/d4/ddemlwp_8c.html#a4">ProcessTerminateMsg</a>((<a class="code" href="../../d2/d1/structtagCONV__INFO.html">PCONV_INFO</a>)pci, (HWND)wParam);
00473             <span class="keywordflow">break</span>;
00474         }
00475     }
00476 
00477     lRet = <a class="code" href="../../d5/d9/cltxt_8h.html#a15">DefWindowProc</a>(hwnd, message, wParam, lParam);
00478 
00479 Exit:
00480     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a7">LeaveDDECrit</a>;
00481     <span class="keywordflow">return</span> (lRet);
00482 }
00483 
00484 
00485 
00486 
00487 <span class="comment">/***************************************************************************\</span>
00488 <span class="comment">* DDEMLServerWndProc</span>
00489 <span class="comment">*</span>
00490 <span class="comment">* Description:</span>
00491 <span class="comment">* Handles DDE server messages.</span>
00492 <span class="comment">*</span>
00493 <span class="comment">* History:</span>
00494 <span class="comment">* 11-12-91 sanfords Created.</span>
00495 <span class="comment">\***************************************************************************/</span>
<a name="l00496"></a><a class="code" href="../../d3/d4/ddemlwp_8c.html#a3">00496</a> LRESULT <a class="code" href="../../d3/d4/ddemlwp_8c.html#a3">DDEMLServerWndProc</a>(
00497     HWND hwnd,
00498     UINT message,
00499     WPARAM wParam,
00500     LPARAM lParam)
00501 {
00502     <a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html">PSVR_CONV_INFO</a> psi;
00503     LRESULT lRet = 0;
00504 
00505     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a6">EnterDDECrit</a>;
00506 
00507     psi = (<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html">PSVR_CONV_INFO</a>)<a class="code" href="../../d5/d9/cltxt_8h.html#a11">GetWindowLongPtr</a>(hwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a160">GWLP_PSI</a>);
00508     UserAssert(psi == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || psi-&gt;<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html#o0">ci</a>.<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o7">hwndConv</a> == hwnd);
00509 
00510     <span class="keywordflow">switch</span> (message) {
00511     <span class="keywordflow">case</span> WM_DDE_REQUEST:
00512     <span class="keywordflow">case</span> WM_DDE_POKE:
00513     <span class="keywordflow">case</span> WM_DDE_ADVISE:
00514     <span class="keywordflow">case</span> WM_DDE_EXECUTE:
00515     <span class="keywordflow">case</span> WM_DDE_ACK:
00516     <span class="keywordflow">case</span> WM_DDE_UNADVISE:
00517         <a class="code" href="../../d3/d4/ddemlwp_8c.html#a5">ProcessAsyncDDEMsg</a>((<a class="code" href="../../d2/d1/structtagCONV__INFO.html">PCONV_INFO</a>)psi, message, (HWND)wParam, lParam);
00518         <span class="keywordflow">goto</span> Exit;
00519 
00520     <span class="keywordflow">case</span> WM_DDE_TERMINATE:
00521     <span class="keywordflow">case</span> WM_DESTROY:
00522         <a class="code" href="../../d3/d4/ddemlwp_8c.html#a4">ProcessTerminateMsg</a>((<a class="code" href="../../d2/d1/structtagCONV__INFO.html">PCONV_INFO</a>)psi, (HWND)wParam);
00523         <span class="keywordflow">break</span>;
00524     }
00525     lRet = <a class="code" href="../../d5/d9/cltxt_8h.html#a15">DefWindowProc</a>(hwnd, message, wParam, lParam);
00526 Exit:
00527     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a7">LeaveDDECrit</a>;
00528     <span class="keywordflow">return</span> (lRet);
00529 }
00530 
00531 
00532 
00533 
00534 <span class="comment">/***************************************************************************\</span>
00535 <span class="comment">* ProcessTerminateMsg</span>
00536 <span class="comment">*</span>
00537 <span class="comment">* Description:</span>
00538 <span class="comment">* Handles WM_DDE_TERMINATE messages for both sides.</span>
00539 <span class="comment">*</span>
00540 <span class="comment">* History:</span>
00541 <span class="comment">* 11-26-91 sanfords Created.</span>
00542 <span class="comment">\***************************************************************************/</span>
<a name="l00543"></a><a class="code" href="../../d3/d4/ddemlwp_8c.html#a4">00543</a> <a class="code" href="../../d2/d1/structtagCONV__INFO.html">PCONV_INFO</a> <a class="code" href="../../d3/d4/ddemlwp_8c.html#a4">ProcessTerminateMsg</a>(
00544 <a class="code" href="../../d2/d1/structtagCONV__INFO.html">PCONV_INFO</a> pcoi,
00545 HWND hwndFrom)
00546 {
00547     <span class="keywordflow">while</span> (pcoi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o6">hwndPartner</a> != hwndFrom) {
00548         pcoi = pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o0">next</a>;
00549     }
00550     <span class="keywordflow">if</span> (pcoi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00551         pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o8">state</a> |= ST_TERMINATE_RECEIVED;
00552         <a class="code" href="../../d0/d4/ddemlcli_8h.html#a113">ShutdownConversation</a>(pcoi, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00553     }
00554     <span class="keywordflow">return</span> (pcoi);
00555 }
00556 
00557 
00558 
00559 <span class="comment">/***************************************************************************\</span>
00560 <span class="comment">* ProcessAsyncDDEMsg</span>
00561 <span class="comment">*</span>
00562 <span class="comment">* Description:</span>
00563 <span class="comment">* Handles incoming DDE messages by either calling ProcessSyncDDEMessage()</span>
00564 <span class="comment">* if the conversation is able to handle callbacks, or by queuing the</span>
00565 <span class="comment">* incoming message into the conversations message queue. Doing this</span>
00566 <span class="comment">* allows simpler code in that no message is processed unless the code</span>
00567 <span class="comment">* can perform synchronous callbacks.</span>
00568 <span class="comment">*</span>
00569 <span class="comment">* History:</span>
00570 <span class="comment">* 11-26-91 sanfords Created.</span>
00571 <span class="comment">\***************************************************************************/</span>
<a name="l00572"></a><a class="code" href="../../d3/d4/ddemlwp_8c.html#a5">00572</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d3/d4/ddemlwp_8c.html#a5">ProcessAsyncDDEMsg</a>(
00573 <a class="code" href="../../d2/d1/structtagCONV__INFO.html">PCONV_INFO</a> pcoi,
00574 UINT msg,
00575 HWND hwndFrom,
00576 LPARAM lParam)
00577 {
00578     <a class="code" href="../../d5/d2/structtagDDE__MESSAGE__QUEUE.html">PDDE_MESSAGE_QUEUE</a> pdmq;
00579 <span class="preprocessor">#if DBG</span>
00580 <span class="preprocessor"></span>    HWND hwndT = pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o7">hwndConv</a>;
00581 <span class="preprocessor">#endif // DBG</span>
00582 <span class="preprocessor"></span>
00583     <span class="keywordflow">while</span> (pcoi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o6">hwndPartner</a> != hwndFrom) {
00584         pcoi = pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o0">next</a>;
00585     }
00586     <span class="keywordflow">if</span> (pcoi == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00587         RIPMSG3(RIP_WARNING,
00588                 <span class="stringliteral">"Bogus DDE message %x received from %x by %x. Dumping."</span>,
00589                 <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, hwndFrom, hwndT);
00590         <a class="code" href="../../d3/d4/ddemlwp_8c.html#a7">DumpDDEMessage</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, lParam);
00591         <span class="keywordflow">return</span> ;
00592     }
00593     <span class="keywordflow">if</span> (pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o8">state</a> &amp; ST_CONNECTED) {
00594 
00595         <span class="keywordflow">if</span> (pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o13">dmqOut</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
00596                 !(pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o8">state</a> &amp; ST_BLOCKED)
00597 <span class="comment">//                &amp;&amp; !PctiCurrent()-&gt;cInDDEMLCallback</span>
00598                 ) {
00599 
00600             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d4/ddemlwp_8c.html#a8">ProcessSyncDDEMessage</a>(pcoi, <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, lParam)) {
00601                 <span class="keywordflow">return</span>; <span class="comment">// not blocked, ok to return.</span>
00602             }
00603         }
00604 
00605         <span class="comment">// enter into queue</span>
00606 
00607         pdmq = <a class="code" href="../../d0/d4/ddemlcli_8h.html#a0">DDEMLAlloc</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d5/d2/structtagDDE__MESSAGE__QUEUE.html">DDE_MESSAGE_QUEUE</a>));
00608         <span class="keywordflow">if</span> (pdmq == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00609 
00610             <span class="comment">// insufficient memory - we can't process this msg - we MUST</span>
00611             <span class="comment">// terminate.</span>
00612 
00613             <span class="keywordflow">if</span> (pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o8">state</a> &amp; ST_CONNECTED) {
00614                 <a class="code" href="../../d0/d8/ntcftxt_8h.html#a20">PostMessage</a>(pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o6">hwndPartner</a>, WM_DDE_TERMINATE,
00615                         (WPARAM)pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o7">hwndConv</a>, 0);
00616                 pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o8">state</a> &amp;= ~ST_CONNECTED;
00617             }
00618             <a class="code" href="../../d3/d4/ddemlwp_8c.html#a7">DumpDDEMessage</a>(!(pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o8">state</a> &amp; ST_INTRA_PROCESS), <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, lParam);
00619             <span class="keywordflow">return</span> ;
00620         }
00621         pdmq-&gt;<a class="code" href="../../d5/d2/structtagDDE__MESSAGE__QUEUE.html#o1">pcoi</a> = pcoi;
00622         pdmq-&gt;<a class="code" href="../../d5/d2/structtagDDE__MESSAGE__QUEUE.html#o2">msg</a> = <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>;
00623         pdmq-&gt;<a class="code" href="../../d5/d2/structtagDDE__MESSAGE__QUEUE.html#o3">lParam</a> = lParam;
00624         pdmq-&gt;<a class="code" href="../../d5/d2/structtagDDE__MESSAGE__QUEUE.html#o0">next</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00625 
00626         <span class="comment">// dmqOut-&gt;next-&gt;next-&gt;next-&gt;dmqIn-&gt;NULL</span>
00627 
00628         <span class="keywordflow">if</span> (pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o12">dmqIn</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00629             pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o12">dmqIn</a>-&gt;<a class="code" href="../../d5/d2/structtagDDE__MESSAGE__QUEUE.html#o0">next</a> = pdmq;
00630         }
00631         pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o12">dmqIn</a> = pdmq;
00632         <span class="keywordflow">if</span> (pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o13">dmqOut</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00633             pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o13">dmqOut</a> = pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o12">dmqIn</a>;
00634         }
00635         pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o16">cLocks</a>++;
00636         <a class="code" href="../../d3/d4/ddemlwp_8c.html#a6">CheckForQueuedMessages</a>(pcoi);
00637         pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o16">cLocks</a>--;
00638         <span class="keywordflow">if</span> (pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o16">cLocks</a> == 0 &amp;&amp; pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o8">state</a> &amp; ST_FREE_CONV_RES_NOW) {
00639             <a class="code" href="../../d0/d4/ddemlcli_8h.html#a114">FreeConversationResources</a>(pcoi);
00640         }
00641     } <span class="keywordflow">else</span> {
00642         <a class="code" href="../../d3/d4/ddemlwp_8c.html#a7">DumpDDEMessage</a>(!(pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o8">state</a> &amp; ST_INTRA_PROCESS), <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, lParam);
00643     }
00644 }
00645 
00646 
00647 
00648 
00649 
00650 
00651 
00652 <span class="comment">/***************************************************************************\</span>
00653 <span class="comment">* CheckForQueuedMessages</span>
00654 <span class="comment">*</span>
00655 <span class="comment">* Description:</span>
00656 <span class="comment">* Handles processing of DDE messages held in the given conversaion's</span>
00657 <span class="comment">* DDE message queue.</span>
00658 <span class="comment">*</span>
00659 <span class="comment">* Returns: fProcessed.</span>
00660 <span class="comment">*</span>
00661 <span class="comment">* History:</span>
00662 <span class="comment">* 11-12-91 sanfords Created.</span>
00663 <span class="comment">\***************************************************************************/</span>
<a name="l00664"></a><a class="code" href="../../d3/d4/ddemlwp_8c.html#a6">00664</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d4/ddemlwp_8c.html#a6">CheckForQueuedMessages</a>(
00665 <a class="code" href="../../d2/d1/structtagCONV__INFO.html">PCONV_INFO</a> pcoi)
00666 {
00667     <a class="code" href="../../d5/d2/structtagDDE__MESSAGE__QUEUE.html">PDDE_MESSAGE_QUEUE</a> pdmq;
00668     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fRet = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00669     <a class="code" href="../../d2/d2/struct__CLIENTINFO.html">PCLIENTINFO</a> pci;
00670 
00671     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a8">CheckDDECritIn</a>;
00672 
00673     <span class="keywordflow">if</span> (pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o8">state</a> &amp; ST_PROCESSING) {      <span class="comment">// recursion prevention</span>
00674         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00675     }
00676 
00677     UserAssert(pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o16">cLocks</a>);
00678 
00679     pci = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a16">GetClientInfo</a>();
00680 
00681     pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o8">state</a> |= ST_PROCESSING;
00682     <span class="keywordflow">while</span> (!(pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o8">state</a> &amp; ST_BLOCKED) &amp;&amp;
00683                 pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o13">dmqOut</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
00684                 !pci-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o11">cInDDEMLCallback</a>) {
00685         pci-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o0">CI_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a113">CI_PROCESSING_QUEUE</a>;
00686         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d4/ddemlwp_8c.html#a8">ProcessSyncDDEMessage</a>(pcoi, pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o13">dmqOut</a>-&gt;<a class="code" href="../../d5/d2/structtagDDE__MESSAGE__QUEUE.html#o2">msg</a>, pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o13">dmqOut</a>-&gt;<a class="code" href="../../d5/d2/structtagDDE__MESSAGE__QUEUE.html#o3">lParam</a>)) {
00687             fRet = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00688             pdmq = pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o13">dmqOut</a>;
00689             pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o13">dmqOut</a> = pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o13">dmqOut</a>-&gt;<a class="code" href="../../d5/d2/structtagDDE__MESSAGE__QUEUE.html#o0">next</a>;
00690             <span class="keywordflow">if</span> (pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o13">dmqOut</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00691                 pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o12">dmqIn</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00692             }
00693             <a class="code" href="../../d0/d4/ddemlcli_8h.html#a2">DDEMLFree</a>(pdmq);
00694         }
00695         pci-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o0">CI_flags</a> &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a113">CI_PROCESSING_QUEUE</a>;
00696     }
00697     pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o8">state</a> &amp;= ~ST_PROCESSING;
00698     <span class="keywordflow">return</span>(fRet);
00699 }
00700 
00701 
00702 
00703 
00704 <span class="comment">/***************************************************************************\</span>
00705 <span class="comment">* DumpDDEMessage</span>
00706 <span class="comment">*</span>
00707 <span class="comment">* Description:</span>
00708 <span class="comment">* Used to clean up resources referenced by DDE messages that for some</span>
00709 <span class="comment">* reason could not be processed.</span>
00710 <span class="comment">*</span>
00711 <span class="comment">* History:</span>
00712 <span class="comment">* 11-12-91 sanfords Created.</span>
00713 <span class="comment">\***************************************************************************/</span>
<a name="l00714"></a><a class="code" href="../../d3/d4/ddemlwp_8c.html#a7">00714</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d3/d4/ddemlwp_8c.html#a7">DumpDDEMessage</a>(
00715 BOOL fFreeData,
00716 UINT msg,
00717 LPARAM lParam)
00718 {
00719     UINT_PTR uiLo, uiHi;
00720 
00721     RIPMSG2(RIP_WARNING, <span class="stringliteral">"Dump DDE msg %x lParam %x"</span>, <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, lParam);
00722 
00723     <span class="keywordflow">switch</span> (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>) {
00724     <span class="keywordflow">case</span> WM_DDE_ACK:
00725     <span class="keywordflow">case</span> WM_DDE_DATA:
00726     <span class="keywordflow">case</span> WM_DDE_POKE:
00727     <span class="keywordflow">case</span> WM_DDE_ADVISE:
00728         <a class="code" href="../../d4/d4/client_2ddetrack_8c.html#a8">UnpackDDElParam</a>(<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, lParam, &amp;uiLo, &amp;uiHi);
00729         <span class="keywordflow">switch</span> (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>) {
00730         <span class="keywordflow">case</span> WM_DDE_DATA:
00731         <span class="keywordflow">case</span> WM_DDE_POKE:
00732             <span class="keywordflow">if</span> (uiLo) {
00733                 <span class="keywordflow">if</span> (fFreeData) {
00734                     <a class="code" href="../../d0/d9/hdata_8c.html#a10">FreeDDEData</a>((HANDLE)uiLo, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00735                 }
00736                 GlobalDeleteAtom((ATOM)uiHi);
00737             }
00738             <span class="keywordflow">break</span>;
00739 
00740         <span class="keywordflow">case</span> WM_DDE_ADVISE:
00741             <span class="keywordflow">if</span> (uiLo) {
00742                 <span class="keywordflow">if</span> (fFreeData) {
00743                     <a class="code" href="../../d0/d9/hdata_8c.html#a10">FreeDDEData</a>((HANDLE)uiLo, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00744                 }
00745                 GlobalDeleteAtom((ATOM)uiHi);
00746             }
00747             <span class="keywordflow">break</span>;
00748 
00749         <span class="keywordflow">case</span> WM_DDE_ACK:
00750             <span class="comment">// could be EXEC Ack - cant know what to do exactly.</span>
00751             <span class="keywordflow">break</span>;
00752         }
00753         <a class="code" href="../../d4/d4/client_2ddetrack_8c.html#a9">FreeDDElParam</a>(<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, lParam);
00754         <span class="keywordflow">break</span>;
00755 
00756     <span class="keywordflow">case</span> WM_DDE_EXECUTE:
00757         <span class="keywordflow">if</span> (fFreeData) {
00758             <a class="code" href="../../d6/d0/usercli_8h.html#a7">WOWGLOBALFREE</a>((HANDLE)lParam);
00759         }
00760         <span class="keywordflow">break</span>;
00761 
00762     <span class="keywordflow">case</span> WM_DDE_REQUEST:
00763     <span class="keywordflow">case</span> WM_DDE_UNADVISE:
00764         GlobalDeleteAtom((ATOM)HIWORD(lParam));
00765         <span class="keywordflow">break</span>;
00766     }
00767 }
00768 
00769 
00770 
00771 
00772 <span class="comment">/***************************************************************************\</span>
00773 <span class="comment">* ProcessSyncDDEMessage</span>
00774 <span class="comment">*</span>
00775 <span class="comment">* Description:</span>
00776 <span class="comment">* Handles processing of a received DDE message. TRUE is returned if</span>
00777 <span class="comment">* the message was handled. FALSE implies CBR_BLOCK.</span>
00778 <span class="comment">*</span>
00779 <span class="comment">* History:</span>
00780 <span class="comment">* 11-19-91 sanfords Created.</span>
00781 <span class="comment">\***************************************************************************/</span>
<a name="l00782"></a><a class="code" href="../../d3/d4/ddemlwp_8c.html#a8">00782</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d4/ddemlwp_8c.html#a8">ProcessSyncDDEMessage</a>(
00783 <a class="code" href="../../d2/d1/structtagCONV__INFO.html">PCONV_INFO</a> pcoi,
00784 UINT msg,
00785 LPARAM lParam)
00786 {
00787     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fNotBlocked = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00788     <a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html">PCL_INSTANCE_INFO</a> pcii;
00789     <a class="code" href="../../d5/d4/structtagENABLE__ENUM__STRUCT.html">ENABLE_ENUM_STRUCT</a> ees;
00790     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fRet;
00791 
00792     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a8">CheckDDECritIn</a>;
00793 
00794     <span class="comment">/*</span>
00795 <span class="comment">     * lock the conversation so its resources don't go away till we are</span>
00796 <span class="comment">     * done with them.  This function could generate a callback which could</span>
00797 <span class="comment">     * disconnect the conversation.</span>
00798 <span class="comment">     */</span>
00799     pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o16">cLocks</a>++;
00800 
00801     <span class="keywordflow">if</span> (pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o8">state</a> &amp; ST_BLOCKNEXT) {
00802         pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o8">state</a> ^= ST_BLOCKNEXT | ST_BLOCKED;
00803     }
00804     <span class="keywordflow">if</span> (pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o8">state</a> &amp; ST_BLOCKALLNEXT) {
00805         ees.<a class="code" href="../../d5/d4/structtagENABLE__ENUM__STRUCT.html#o0">pfRet</a> = &amp;fRet;
00806         ees.<a class="code" href="../../d5/d4/structtagENABLE__ENUM__STRUCT.html#o1">wCmd</a> = EC_DISABLE;
00807         ees.<a class="code" href="../../d5/d4/structtagENABLE__ENUM__STRUCT.html#o2">wCmd2</a> = 0;
00808         <a class="code" href="../../d0/d8/clenum_8c.html#a8">EnumChildWindows</a>(pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o1">pcii</a>-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o4">hwndMother</a>, (WNDENUMPROC)<a class="code" href="../../d8/d4/w32_2ntuser_2client_2callback_8c.html#a3">EnableEnumProc</a>,
00809                 (LPARAM)&amp;ees);
00810     }
00811 
00812     <span class="keywordflow">if</span> (pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o8">state</a> &amp; ST_CONNECTED) {
00813         <span class="keywordflow">if</span> (pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o11">pxiOut</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00814             <span class="keywordflow">if</span> (pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o8">state</a> &amp; ST_CLIENT) {
00815                 fNotBlocked = <a class="code" href="../../d2/d6/stdptcl_8c.html#a20">SpontaneousClientMessage</a>((<a class="code" href="../../d1/d0/structtagCL__CONV__INFO.html">PCL_CONV_INFO</a>)pcoi, <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, lParam);
00816             } <span class="keywordflow">else</span> {
00817                 fNotBlocked = <a class="code" href="../../d2/d6/stdptcl_8c.html#a21">SpontaneousServerMessage</a>((<a class="code" href="../../d5/d7/structtagSVR__CONV__INFO.html">PSVR_CONV_INFO</a>)pcoi, <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, lParam);
00818             }
00819         } <span class="keywordflow">else</span> {
00820             UserAssert(pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o11">pxiOut</a>-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o3">hXact</a> == (HANDLE)0 ||
00821                     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a89">ValidateCHandle</a>(pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o11">pxiOut</a>-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o3">hXact</a>, <a class="code" href="../../d0/d4/ddemlcli_8h.html#a38">HTYPE_TRANSACTION</a>,
00822                     <a class="code" href="../../d0/d4/ddemlcli_8h.html#a42">HINST_ANY</a>)
00823                     == (ULONG_PTR)pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o11">pxiOut</a>);
00824             fNotBlocked = (pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o11">pxiOut</a>-&gt;<a class="code" href="../../d0/d0/structtagXACT__INFO.html#o4">pfnResponse</a>)(pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o11">pxiOut</a>, <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, lParam);
00825         }
00826     } <span class="keywordflow">else</span> {
00827         <a class="code" href="../../d3/d4/ddemlwp_8c.html#a7">DumpDDEMessage</a>(!(pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o8">state</a> &amp; ST_INTRA_PROCESS), <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, lParam);
00828     }
00829     <span class="keywordflow">if</span> (!fNotBlocked) {
00830         pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o8">state</a> |= ST_BLOCKED;
00831         pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o8">state</a> &amp;= ~ST_BLOCKNEXT;
00832     }
00833 
00834     pcii = pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o1">pcii</a>;  <span class="comment">// save this incase unlocking makes pcoi go away.</span>
00835 
00836     pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o16">cLocks</a>--;
00837     <span class="keywordflow">if</span> (pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o16">cLocks</a> == 0 &amp;&amp; pcoi-&gt;<a class="code" href="../../d2/d1/structtagCONV__INFO.html#o8">state</a> &amp; ST_FREE_CONV_RES_NOW) {
00838         <a class="code" href="../../d0/d4/ddemlcli_8h.html#a114">FreeConversationResources</a>(pcoi);
00839     }
00840 
00841     <span class="comment">/*</span>
00842 <span class="comment">     * Because callbacks are capable of blocking DdeUninitialize(), we check</span>
00843 <span class="comment">     * before exit to see if it needs to be called.</span>
00844 <span class="comment">     */</span>
00845     <span class="keywordflow">if</span> (pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o7">afCmd</a> &amp; APPCMD_UNINIT_ASAP &amp;&amp;
00846             !(pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o16">flags</a> &amp; <a class="code" href="../../d0/d4/ddemlcli_8h.html#a49">IIF_IN_SYNC_XACT</a>) &amp;&amp;
00847             !pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o17">cInDDEMLCallback</a>) {
00848         <a class="code" href="../../d9/d3/ddemlcli_8c.html#a5">DdeUninitialize</a>(HandleToUlong(pcii-&gt;<a class="code" href="../../d2/d0/structtagCL__INSTANCE__INFO.html#o2">hInstClient</a>));
00849         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00850     }
00851     <span class="keywordflow">return</span> (fNotBlocked);
00852 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:39 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
