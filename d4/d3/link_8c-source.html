<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: link.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>link.c</h1><a href="../../d3/d4/link_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">//---------------------------------------------------------------------------</span>
00002 <span class="comment">//</span>
00003 <span class="comment">// link.c       link management routines (reading, etc.)</span>
00004 <span class="comment">//</span>
00005 <span class="comment">// Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00006 <span class="comment">//</span>
00007 <span class="comment">//---------------------------------------------------------------------------</span>
00008 
00009 
00010 
00011 <span class="preprocessor">#include "<a class="code" href="../../d6/d3/w32_2ntcon_2server_2precomp_8h.html">precomp.h</a>"</span>
00012 <span class="preprocessor">#pragma hdrstop</span>
00013 <span class="preprocessor"></span>
00014 
00015 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>
<a name="l00016"></a><a class="code" href="../../d3/d4/link_8c.html#a0">00016</a> <a class="code" href="../../d3/d4/link_8c.html#a0">GetTitleFromLinkName</a>(
00017     IN  LPWSTR szLinkName,
00018     OUT LPWSTR szTitle
00019     )
00020 <span class="comment">/*++</span>
00021 <span class="comment"></span>
00022 <span class="comment">Routine Description:</span>
00023 <span class="comment"></span>
00024 <span class="comment">    This routine returns the title (i.e., display name of the link) in szTitle,</span>
00025 <span class="comment">    and the number of bytes (not chars) in szTitle.</span>
00026 <span class="comment"></span>
00027 <span class="comment">Arguments:</span>
00028 <span class="comment"></span>
00029 <span class="comment">    szLinkName - fully qualified path to link file</span>
00030 <span class="comment">    szTitle    - pointer to buffer to contain title (display name) of the link</span>
00031 <span class="comment"></span>
00032 <span class="comment">    i.e.:</span>
00033 <span class="comment">    "C:\nt\desktop\A Link File Name.lnk" --&gt; "A Link File Name"</span>
00034 <span class="comment"></span>
00035 <span class="comment">Return Value:</span>
00036 <span class="comment"></span>
00037 <span class="comment">    number of bytes copied to szTitle</span>
00038 <span class="comment"></span>
00039 <span class="comment">--*/</span>
00040 {
00041     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwLen;
00042     LPWSTR pLnk, pDot;
00043     LPWSTR pPath = szLinkName;
00044 
00045     <span class="comment">// Error checking</span>
00046     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(szLinkName);
00047 
00048     <span class="comment">// find filename at end of fully qualified link name and point pLnk to it</span>
00049     <span class="keywordflow">for</span> (pLnk = pPath; *pPath; pPath++)
00050     {
00051         <span class="keywordflow">if</span> ( (pPath[0] == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span> || pPath[0] == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">':'</span>) &amp;&amp;
00052               pPath[1] &amp;&amp;
00053              (pPath[1] != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>)
00054             )
00055             pLnk = pPath + 1;
00056     }
00057 
00058     <span class="comment">// find extension (.lnk)</span>
00059     pPath = pLnk;
00060     <span class="keywordflow">for</span> (pDot = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; *pPath; pPath++)
00061     {
00062         <span class="keywordflow">switch</span> (*pPath) {
00063         <span class="keywordflow">case</span> <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'.'</span>:
00064             pDot = pPath;       <span class="comment">// remember the last dot</span>
00065             <span class="keywordflow">break</span>;
00066         <span class="keywordflow">case</span> <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>:
00067         <span class="keywordflow">case</span> <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">' '</span>:              <span class="comment">// extensions can't have spaces</span>
00068             pDot = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;        <span class="comment">// forget last dot, it was in a directory</span>
00069             <span class="keywordflow">break</span>;
00070         }
00071     }
00072 
00073     <span class="comment">// if we found the extension, pDot points to it, if not, pDot</span>
00074     <span class="comment">// is NULL.</span>
00075 
00076     <span class="keywordflow">if</span> (pDot)
00077     {
00078         dwLen = (ULONG)((pDot - pLnk) * <span class="keyword">sizeof</span>(WCHAR));
00079     }
00080     <span class="keywordflow">else</span>
00081     {
00082         dwLen = lstrlenW(pLnk) * <span class="keyword">sizeof</span>(WCHAR);
00083     }
00084     dwLen = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(dwLen, <a class="code" href="../../d5/d5/conmsg_8h.html#a2">MAX_TITLE_LENGTH</a>);
00085 
00086     RtlCopyMemory(<a class="code" href="../../d5/d6/ntcon_2conime_2globals_8h.html#a2">szTitle</a>, pLnk, dwLen);
00087 
00088     <span class="keywordflow">return</span> dwLen;
00089 }
00090 
00091 
<a name="l00092"></a><a class="code" href="../../d3/d4/link_8c.html#a1">00092</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d4/link_8c.html#a1">ReadString</a>( HANDLE hFile, LPVOID * lpVoid, BOOL bUnicode )
00093 {
00094 
00095     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> cch;
00096     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>  dwBytesRead;
00097     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>   fResult = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00098 
00099     <span class="keywordflow">if</span> (bUnicode)
00100     {
00101         LPWSTR lpWStr = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00102 
00103         fResult &amp;= ReadFile( hFile, (<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>)&amp;cch, <span class="keyword">sizeof</span>(cch), &amp;dwBytesRead, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00104         lpWStr = (LPWSTR)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>( HEAP_ZERO_MEMORY, (cch+1)*<span class="keyword">sizeof</span>(WCHAR) );
00105         <span class="keywordflow">if</span> (lpWStr) {
00106             fResult &amp;= ReadFile( hFile, (<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>)lpWStr, cch*<span class="keyword">sizeof</span>(WCHAR), &amp;dwBytesRead, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00107             lpWStr[cch] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00108         }
00109         *(LPWSTR *)lpVoid = lpWStr;
00110     }
00111     <span class="keywordflow">else</span>
00112     {
00113         LPSTR lpStr = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00114 
00115         fResult &amp;= ReadFile( hFile, (<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>)&amp;cch, <span class="keyword">sizeof</span>(cch), &amp;dwBytesRead, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00116         lpStr = (LPSTR)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>( HEAP_ZERO_MEMORY, (cch+1) );
00117         <span class="keywordflow">if</span> (lpStr) {
00118             fResult &amp;= ReadFile( hFile, (<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>)lpStr, cch, &amp;dwBytesRead, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00119             lpStr[cch] = <span class="charliteral">'\0'</span>;
00120         }
00121         *(LPSTR *)lpVoid = lpStr;
00122     }
00123 
00124     <span class="keywordflow">return</span> fResult;
00125 
00126 }
00127 
00128 
<a name="l00129"></a><a class="code" href="../../d3/d4/link_8c.html#a2">00129</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d4/link_8c.html#a2">LoadLink</a>( LPWSTR pszLinkName, <a class="code" href="../../d0/d7/structCShellLink.html">CShellLink</a> * <span class="keyword">this</span> )
00130 {
00131 
00132     HANDLE hFile;
00133     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwBytesRead, cbSize, cbTotal, cbToRead;
00134     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fResult = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00135     LPSTR pTemp = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00136 
00137     <span class="comment">// Try to open the file</span>
00138     hFile = CreateFile( pszLinkName,
00139                         GENERIC_READ,
00140                         FILE_SHARE_READ,
00141                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00142                         <a class="code" href="../../d4/d8/ntfsexp_8h.html#a141a69">OPEN_EXISTING</a>,
00143                         FILE_ATTRIBUTE_NORMAL,
00144                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00145                        );
00146 
00147     <span class="keywordflow">if</span> (hFile==<a class="code" href="../../d5/d4/rxact_8c.html#a0">INVALID_HANDLE_VALUE</a>)
00148         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00149 
00150 
00151     <span class="comment">// Now, read out data...</span>
00152 
00153     fResult = ReadFile( hFile, (<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>)&amp;this-&gt;<a class="code" href="../../d0/d7/structCShellLink.html#o8">sld</a>, <span class="keyword">sizeof</span>(this-&gt;<a class="code" href="../../d0/d7/structCShellLink.html#o8">sld</a>), &amp;dwBytesRead, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00154     fResult &amp;= ((dwBytesRead == <span class="keyword">sizeof</span>(this-&gt;sld)) &amp;&amp; (this-&gt;sld.cbSize == <span class="keyword">sizeof</span>(this-&gt;sld)));
00155 
00156     <span class="comment">// read all of the members</span>
00157 
00158     <span class="keywordflow">if</span> (this-&gt;sld.dwFlags &amp; SLDF_HAS_ID_LIST)
00159     {
00160         <span class="comment">// Read the size of the IDLIST</span>
00161         cbSize = 0; <span class="comment">// need to zero out to get HIWORD 0 'cause USHORT is only 2 bytes</span>
00162         fResult &amp;= ReadFile( hFile, (<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>)&amp;cbSize, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>), &amp;dwBytesRead, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00163         fResult &amp;= (dwBytesRead == <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>));
00164         <span class="keywordflow">if</span> (cbSize)
00165         {
00166             fResult &amp;=
00167                 (SetFilePointer(hFile,cbSize,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,FILE_CURRENT)!=0xFFFFFFFF);
00168         }
00169         <span class="keywordflow">else</span>
00170         {
00171             <span class="keywordflow">if</span> (hFile)
00172                 CloseHandle( hFile );
00173             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00174         }
00175     }
00176 
00177     <span class="comment">// BUGBUG: this part is not unicode ready, talk to daviddi</span>
00178 
00179     <span class="keywordflow">if</span> (this-&gt;sld.dwFlags &amp; (SLDF_HAS_LINK_INFO))
00180     {
00181 
00182         fResult &amp;= ReadFile( hFile, (<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>)&amp;cbSize, <span class="keyword">sizeof</span>(cbSize), &amp;dwBytesRead, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00183         fResult &amp;= (dwBytesRead == <span class="keyword">sizeof</span>(cbSize));
00184         <span class="keywordflow">if</span> (cbSize &gt;= <span class="keyword">sizeof</span>(cbSize))
00185         {
00186             cbSize -= <span class="keyword">sizeof</span>(cbSize);
00187             fResult &amp;=
00188                 (SetFilePointer(hFile,cbSize,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,FILE_CURRENT)!=0xFFFFFFFF);
00189         }
00190 
00191     }
00192 
00193     <span class="keywordflow">if</span> (this-&gt;sld.dwFlags &amp; SLDF_HAS_NAME)
00194         fResult &amp;= <a class="code" href="../../d3/d4/link_8c.html#a1">ReadString</a>( hFile, &amp;this-&gt;<a class="code" href="../../d0/d7/structCShellLink.html#o2">pszName</a>, this-&gt;<a class="code" href="../../d0/d7/structCShellLink.html#o8">sld</a>.dwFlags &amp; SLDF_UNICODE);
00195     <span class="keywordflow">if</span> (this-&gt;sld.dwFlags &amp; SLDF_HAS_RELPATH)
00196         fResult &amp;= <a class="code" href="../../d3/d4/link_8c.html#a1">ReadString</a>( hFile, &amp;this-&gt;<a class="code" href="../../d0/d7/structCShellLink.html#o3">pszRelPath</a>, this-&gt;<a class="code" href="../../d0/d7/structCShellLink.html#o8">sld</a>.dwFlags &amp; SLDF_UNICODE);
00197     <span class="keywordflow">if</span> (this-&gt;sld.dwFlags &amp; SLDF_HAS_WORKINGDIR)
00198         fResult &amp;= <a class="code" href="../../d3/d4/link_8c.html#a1">ReadString</a>( hFile, &amp;this-&gt;<a class="code" href="../../d0/d7/structCShellLink.html#o4">pszWorkingDir</a>, this-&gt;<a class="code" href="../../d0/d7/structCShellLink.html#o8">sld</a>.dwFlags &amp; SLDF_UNICODE);
00199     <span class="keywordflow">if</span> (this-&gt;sld.dwFlags &amp; SLDF_HAS_ARGS)
00200         fResult &amp;= <a class="code" href="../../d3/d4/link_8c.html#a1">ReadString</a>( hFile, &amp;this-&gt;<a class="code" href="../../d0/d7/structCShellLink.html#o5">pszArgs</a>, this-&gt;<a class="code" href="../../d0/d7/structCShellLink.html#o8">sld</a>.dwFlags &amp; SLDF_UNICODE);
00201     <span class="keywordflow">if</span> (this-&gt;sld.dwFlags &amp; SLDF_HAS_ICONLOCATION)
00202         fResult &amp;= <a class="code" href="../../d3/d4/link_8c.html#a1">ReadString</a>( hFile, &amp;this-&gt;<a class="code" href="../../d0/d7/structCShellLink.html#o6">pszIconLocation</a>, this-&gt;<a class="code" href="../../d0/d7/structCShellLink.html#o8">sld</a>.dwFlags &amp; SLDF_UNICODE);
00203 
00204     <span class="comment">// Read in extra data sections</span>
00205     this-&gt;pExtraData = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00206     cbTotal = 0;
00207     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)
00208     {
00209 
00210         LPSTR pReadData = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00211 
00212         cbSize = 0;
00213         fResult &amp;= ReadFile( hFile, (<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>)&amp;cbSize, <span class="keyword">sizeof</span>(cbSize), &amp;dwBytesRead, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00214 
00215         <span class="keywordflow">if</span> (cbSize &lt; <span class="keyword">sizeof</span>(cbSize))
00216             <span class="keywordflow">break</span>;
00217 
00218         <span class="keywordflow">if</span> (pTemp)
00219         {
00220             pTemp = (<span class="keywordtype">void</span> *)<a class="code" href="../../d8/d5/consrv_8h.html#a37">ConsoleHeapReAlloc</a>(
00221                                          HEAP_ZERO_MEMORY,
00222                                          this-&gt;<a class="code" href="../../d0/d7/structCShellLink.html#o7">pExtraData</a>,
00223                                          cbTotal + cbSize + <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)
00224                                         );
00225             <span class="keywordflow">if</span> (pTemp)
00226             {
00227                 this-&gt;pExtraData = pTemp;
00228             }
00229         }
00230         <span class="keywordflow">else</span>
00231         {
00232             this-&gt;pExtraData = pTemp = <a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>( HEAP_ZERO_MEMORY, cbTotal + cbSize + <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>) );
00233 
00234         }
00235 
00236         <span class="keywordflow">if</span> (!pTemp)
00237             <span class="keywordflow">break</span>;
00238 
00239         cbToRead = cbSize - <span class="keyword">sizeof</span>(cbSize);
00240         pReadData = pTemp + cbTotal;
00241 
00242         fResult &amp;= ReadFile( hFile, (<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>)(pReadData + <span class="keyword">sizeof</span>(cbSize)), cbToRead, &amp;dwBytesRead, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00243         <span class="keywordflow">if</span> (dwBytesRead==cbToRead)
00244         {
00245             <span class="comment">// got all of the extra data, comit it</span>
00246             *((UNALIGNED <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> *)pReadData) = cbSize;
00247             cbTotal += cbSize;
00248         }
00249         <span class="keywordflow">else</span>
00250             <span class="keywordflow">break</span>;
00251 
00252     }
00253 
00254 
00255     <span class="keywordflow">if</span> (hFile)
00256         CloseHandle( hFile );
00257 
00258     <span class="keywordflow">return</span> fResult;
00259 
00260 }
00261 
00262 
00263 
<a name="l00264"></a><a class="code" href="../../d3/d4/link_8c.html#a3">00264</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d3/d4/link_8c.html#a3">GetLinkProperties</a>( LPWSTR pszLinkName, LPVOID lpvBuffer, UINT cb )
00265 {
00266     <a class="code" href="../../d0/d7/structCShellLink.html">CShellLink</a> mld;
00267     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> fResult;
00268     LPNT_CONSOLE_PROPS lpExtraData;
00269     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwSize = 0;
00270 
00271 <span class="comment">/*</span>
00272 <span class="comment">    {</span>
00273 <span class="comment">        TCHAR szRick[ 1024 ];</span>
00274 <span class="comment">        STARTUPINFO si;</span>
00275 <span class="comment">        PROCESS_INFORMATION pi;</span>
00276 <span class="comment"></span>
00277 <span class="comment">        // HUGE, HUGE hack-o-rama to get NTSD started on this process!</span>
00278 <span class="comment">        wsprintf( szRick, TEXT("ntsd -d -p %d"), GetCurrentProcessId() );</span>
00279 <span class="comment">        GetStartupInfo( &amp;si );</span>
00280 <span class="comment">        CreateProcess( NULL, szRick, NULL, NULL, FALSE, 0, NULL, NULL, &amp;si, &amp;pi );</span>
00281 <span class="comment">        CloseHandle( pi.hProcess );</span>
00282 <span class="comment">        CloseHandle( pi.hThread );</span>
00283 <span class="comment">        Sleep( 5*1000 );</span>
00284 <span class="comment">        DebugBreak();</span>
00285 <span class="comment"></span>
00286 <span class="comment">    }</span>
00287 <span class="comment">*/</span>
00288 
00289 
00290 
00291     <span class="comment">// Zero out structure on the stack</span>
00292     RtlZeroMemory( &amp;mld, <span class="keyword">sizeof</span>(mld) );
00293 
00294     <span class="comment">// Load link data</span>
00295     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d4/link_8c.html#a2">LoadLink</a>( pszLinkName, &amp;mld )) {
00296         RIPMSG1(RIP_WARNING, <span class="stringliteral">"LoadLink %ws failed"</span>, pszLinkName);
00297         fResult = <a class="code" href="../../d8/d5/consrv_8h.html#a47">LINK_NOINFO</a>;
00298         <span class="keywordflow">goto</span> Cleanup;
00299     }
00300 
00301     <span class="comment">// Check return buffer -- is it big enough?</span>
00302     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(cb &gt;= <span class="keyword">sizeof</span>( <a class="code" href="../../d2/d9/structLNKPROPNTCONSOLE.html">LNKPROPNTCONSOLE</a>));
00303 
00304     <span class="comment">// Zero out callers buffer</span>
00305     RtlZeroMemory( lpvBuffer, cb );
00306 
00307     <span class="comment">// Copy relevant shell link data into caller's buffer</span>
00308     <span class="keywordflow">if</span> (mld.pszName)
00309         lstrcpy( ((<a class="code" href="../../d1/d7/server_8h.html#a120">LPLNKPROPNTCONSOLE</a>)lpvBuffer)-&gt;pszName, mld.pszName );
00310     <span class="keywordflow">if</span> (mld.pszIconLocation)
00311         lstrcpy( ((<a class="code" href="../../d1/d7/server_8h.html#a120">LPLNKPROPNTCONSOLE</a>)lpvBuffer)-&gt;pszIconLocation, mld.pszIconLocation );
00312     ((<a class="code" href="../../d1/d7/server_8h.html#a120">LPLNKPROPNTCONSOLE</a>)lpvBuffer)-&gt;uIcon = mld.sld.iIcon;
00313     ((<a class="code" href="../../d1/d7/server_8h.html#a120">LPLNKPROPNTCONSOLE</a>)lpvBuffer)-&gt;uShowCmd = mld.sld.iShowCmd;
00314     ((<a class="code" href="../../d1/d7/server_8h.html#a120">LPLNKPROPNTCONSOLE</a>)lpvBuffer)-&gt;uHotKey = mld.sld.wHotkey;
00315     fResult = <a class="code" href="../../d8/d5/consrv_8h.html#a48">LINK_SIMPLEINFO</a>;
00316 
00317     <span class="comment">// Find console properties in extra data section</span>
00318     <span class="keywordflow">for</span>( lpExtraData = (LPNT_CONSOLE_PROPS)mld.pExtraData;
00319          lpExtraData &amp;&amp; lpExtraData-&gt;cbSize;
00320          (LPBYTE)lpExtraData += dwSize
00321         )
00322     {
00323         dwSize = lpExtraData-&gt;cbSize;
00324         <span class="keywordflow">if</span> (dwSize)
00325         {
00326             <span class="keywordflow">if</span> (lpExtraData-&gt;dwSignature == NT_CONSOLE_PROPS_SIG)
00327             {
00328 
00329                 RtlCopyMemory( &amp;((<a class="code" href="../../d1/d7/server_8h.html#a120">LPLNKPROPNTCONSOLE</a>)lpvBuffer)-&gt;console_props,
00330                                lpExtraData,
00331                                <span class="keyword">sizeof</span>( NT_CONSOLE_PROPS )
00332                              );
00333                 fResult = <a class="code" href="../../d8/d5/consrv_8h.html#a49">LINK_FULLINFO</a>;
00334 <span class="preprocessor">#if !defined(FE_SB)</span>
00335 <span class="preprocessor"></span>                <span class="keywordflow">break</span>;
00336 <span class="preprocessor">#endif</span>
00337 <span class="preprocessor"></span>            }
00338 <span class="preprocessor">#if defined(FE_SB)</span>
00339 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (lpExtraData-&gt;dwSignature == NT_FE_CONSOLE_PROPS_SIG)
00340             {
00341                 LPNT_FE_CONSOLE_PROPS lpFEExtraData = (LPNT_FE_CONSOLE_PROPS)lpExtraData;
00342 
00343                 RtlCopyMemory( &amp;((<a class="code" href="../../d1/d7/server_8h.html#a120">LPLNKPROPNTCONSOLE</a>)lpvBuffer)-&gt;fe_console_props,
00344                                lpFEExtraData,
00345                                <span class="keyword">sizeof</span>( NT_FE_CONSOLE_PROPS )
00346                              );
00347             }
00348 <span class="preprocessor">#endif</span>
00349 <span class="preprocessor"></span>        }
00350     }
00351 
00352 <span class="preprocessor">#if 0</span>
00353 <span class="preprocessor"></span><span class="preprocessor">#define ConsoleInfo ((LPLNKPROPNTCONSOLE)lpvBuffer)</span>
00354 <span class="preprocessor"></span>    {
00355         TCHAR szTemp[ 256 ];
00356         <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> i;
00357 
00358         wsprintf( szTemp, TEXT(<span class="stringliteral">"[GetLinkProperties -- Link Properties for %s]\n"</span>), pszLinkName );
00359         OutputDebugString( szTemp );
00360         wsprintf( szTemp, TEXT(<span class="stringliteral">"    wFillAttribute      = 0x%04X\n"</span>), ConsoleInfo-&gt;console_props.wFillAttribute );
00361         OutputDebugString( szTemp );
00362         wsprintf( szTemp, TEXT(<span class="stringliteral">"    wPopupFillAttribute = 0x%04X\n"</span>), ConsoleInfo-&gt;console_props.wPopupFillAttribute );
00363         OutputDebugString( szTemp );
00364         wsprintf( szTemp, TEXT(<span class="stringliteral">"    dwScreenBufferSize  = (%d , %d)\n"</span>), ConsoleInfo-&gt;console_props.dwScreenBufferSize.X, ConsoleInfo-&gt;console_props.dwScreenBufferSize.Y );
00365         OutputDebugString( szTemp );
00366         wsprintf( szTemp, TEXT(<span class="stringliteral">"    dwWindowSize        = (%d , %d)\n"</span>), ConsoleInfo-&gt;console_props.dwWindowSize.X, ConsoleInfo-&gt;console_props.dwWindowSize.Y );
00367         OutputDebugString( szTemp );
00368         wsprintf( szTemp, TEXT(<span class="stringliteral">"    dwWindowOrigin      = (%d , %d)\n"</span>), ConsoleInfo-&gt;console_props.dwWindowOrigin.X, ConsoleInfo-&gt;console_props.dwWindowOrigin.Y );
00369         OutputDebugString( szTemp );
00370         wsprintf( szTemp, TEXT(<span class="stringliteral">"    nFont               = 0x%X\n"</span>), ConsoleInfo-&gt;console_props.nFont );
00371         OutputDebugString( szTemp );
00372         wsprintf( szTemp, TEXT(<span class="stringliteral">"    nInputBufferSize    = 0x%X\n"</span>), ConsoleInfo-&gt;console_props.nInputBufferSize );
00373         OutputDebugString( szTemp );
00374         wsprintf( szTemp, TEXT(<span class="stringliteral">"    dwFontSize          = (%d , %d)\n"</span>), ConsoleInfo-&gt;console_props.dwFontSize.X, ConsoleInfo-&gt;console_props.dwFontSize.Y );
00375         OutputDebugString( szTemp );
00376         wsprintf( szTemp, TEXT(<span class="stringliteral">"    uFontFamily         = 0x%08X\n"</span>), ConsoleInfo-&gt;console_props.uFontFamily );
00377         OutputDebugString( szTemp );
00378         wsprintf( szTemp, TEXT(<span class="stringliteral">"    uFontWeight         = 0x%08X\n"</span>), ConsoleInfo-&gt;console_props.uFontWeight );
00379         OutputDebugString( szTemp );
00380         wsprintf( szTemp, TEXT(<span class="stringliteral">"    FaceName            = %ws\n"</span>), ConsoleInfo-&gt;console_props.FaceName );
00381         OutputDebugString( szTemp );
00382         wsprintf( szTemp, TEXT(<span class="stringliteral">"    uCursorSize         = %d\n"</span>), ConsoleInfo-&gt;console_props.uCursorSize );
00383         OutputDebugString( szTemp );
00384         wsprintf( szTemp, TEXT(<span class="stringliteral">"    bFullScreen         = %s\n"</span>), ConsoleInfo-&gt;console_props.bFullScreen ? TEXT(<span class="stringliteral">"TRUE"</span>) : TEXT(<span class="stringliteral">"FALSE"</span>) );
00385         OutputDebugString( szTemp );
00386         wsprintf( szTemp, TEXT(<span class="stringliteral">"    bQuickEdit          = %s\n"</span>), ConsoleInfo-&gt;console_props.bQuickEdit  ? TEXT(<span class="stringliteral">"TRUE"</span>) : TEXT(<span class="stringliteral">"FALSE"</span>) );
00387         OutputDebugString( szTemp );
00388         wsprintf( szTemp, TEXT(<span class="stringliteral">"    bInsertMode         = %s\n"</span>), ConsoleInfo-&gt;console_props.bInsertMode ? TEXT(<span class="stringliteral">"TRUE"</span>) : TEXT(<span class="stringliteral">"FALSE"</span>) );
00389         OutputDebugString( szTemp );
00390         wsprintf( szTemp, TEXT(<span class="stringliteral">"    bAutoPosition       = %s\n"</span>), ConsoleInfo-&gt;console_props.bAutoPosition ? TEXT(<span class="stringliteral">"TRUE"</span>) : TEXT(<span class="stringliteral">"FALSE"</span>) );
00391         OutputDebugString( szTemp );
00392         wsprintf( szTemp, TEXT(<span class="stringliteral">"    uHistoryBufferSize  = %d\n"</span>), ConsoleInfo-&gt;console_props.uHistoryBufferSize );
00393         OutputDebugString( szTemp );
00394         wsprintf( szTemp, TEXT(<span class="stringliteral">"    uNumHistoryBuffers  = %d\n"</span>), ConsoleInfo-&gt;console_props.uNumberOfHistoryBuffers );
00395         OutputDebugString( szTemp );
00396         wsprintf( szTemp, TEXT(<span class="stringliteral">"    bHistoryNoDup       = %s\n"</span>), ConsoleInfo-&gt;console_props.bHistoryNoDup ? TEXT(<span class="stringliteral">"TRUE"</span>) : TEXT(<span class="stringliteral">"FALSE"</span>) );
00397         OutputDebugString( szTemp );
00398         OutputDebugString( TEXT(<span class="stringliteral">"    ColorTable = ["</span>) );
00399         i=0;
00400         <span class="keywordflow">while</span>( i &lt; 16 )
00401         {
00402             OutputDebugString( TEXT(<span class="stringliteral">"\n         "</span>) );
00403             wsprintf( szTemp, TEXT(<span class="stringliteral">"0x%08X "</span>), ConsoleInfo-&gt;console_props.ColorTable[i++]);
00404             OutputDebugString( szTemp );
00405             wsprintf( szTemp, TEXT(<span class="stringliteral">"0x%08X "</span>), ConsoleInfo-&gt;console_props.ColorTable[i++]);
00406             OutputDebugString( szTemp );
00407             wsprintf( szTemp, TEXT(<span class="stringliteral">"0x%08X "</span>), ConsoleInfo-&gt;console_props.ColorTable[i++]);
00408             OutputDebugString( szTemp );
00409             wsprintf( szTemp, TEXT(<span class="stringliteral">"0x%08X "</span>), ConsoleInfo-&gt;console_props.ColorTable[i++]);
00410             OutputDebugString( szTemp );
00411         }
00412         OutputDebugString( TEXT(<span class="stringliteral">"]\n\n"</span>) );
00413     }
00414 <span class="preprocessor">#undef ConsoleInfo</span>
00415 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00416 <span class="preprocessor"></span>
00417 Cleanup:
00418     <span class="keywordflow">if</span> (mld.pszName)
00419         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>( mld.pszName );
00420     <span class="keywordflow">if</span> (mld.pszRelPath)
00421         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>( mld.pszRelPath );
00422     <span class="keywordflow">if</span> (mld.pszWorkingDir)
00423         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>( mld.pszWorkingDir );
00424     <span class="keywordflow">if</span> (mld.pszArgs)
00425         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>( mld.pszArgs );
00426     <span class="keywordflow">if</span> (mld.pszIconLocation)
00427         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>( mld.pszIconLocation );
00428     <span class="keywordflow">if</span> (mld.pExtraData)
00429         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>( mld.pExtraData );
00430 
00431     <span class="keywordflow">return</span> fResult;
00432 
00433 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:38 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
