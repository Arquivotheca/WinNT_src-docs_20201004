<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: token.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>token.c File Reference</h1><code>#include "<a class="el" href="../../d7/d5/sep_8h-source.html">sep.h</a>"</code><br>
<code>#include "sertlp.h"</code><br>
<code>#include &lt;zwapi.h&gt;</code><br>
<code>#include "<a class="el" href="../../d9/d2/tokenp_8h-source.html">tokenp.h</a>"</code><br>

<p>
<a href="../../d5/d2/token_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>TOKEN_TYPE&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d3/token_8c.html#a3">SeTokenType</a> (IN PACCESS_TOKEN <a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d3/token_8c.html#a4">SeTokenIsAdmin</a> (IN PACCESS_TOKEN <a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d3/token_8c.html#a5">SeTokenIsRestricted</a> (IN PACCESS_TOKEN <a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>SECURITY_IMPERSONATION_LEVEL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d3/token_8c.html#a6">SeTokenImpersonationLevel</a> (IN PACCESS_TOKEN <a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d3/token_8c.html#a7">SeAssignPrimaryToken</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process, IN PACCESS_TOKEN <a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d3/token_8c.html#a8">SeDeassignPrimaryToken</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d3/token_8c.html#a9">SeExchangePrimaryToken</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process, IN PACCESS_TOKEN NewAccessToken, OUT PACCESS_TOKEN *OldAccessToken)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d3/token_8c.html#a10">SeGetTokenControlInformation</a> (IN PACCESS_TOKEN <a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a>, OUT PTOKEN_CONTROL TokenControl)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PACCESS_TOKEN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d3/token_8c.html#a11">SeMakeSystemToken</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PACCESS_TOKEN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d3/token_8c.html#a12">SeMakeAnonymousLogonToken</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d3/token_8c.html#a13">SeSubProcessToken</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ParentProcess, OUT PACCESS_TOKEN *ChildToken)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d3/token_8c.html#a14">SepTokenInitialization</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d3/token_8c.html#a15">NtCreateToken</a> (OUT PHANDLE TokenHandle, IN ACCESS_MASK DesiredAccess, IN POBJECT_ATTRIBUTES <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a1">ObjectAttributes</a> OPTIONAL, IN TOKEN_TYPE TokenType, IN PLUID AuthenticationId, IN PLARGE_INTEGER ExpirationTime, IN PTOKEN_USER User, IN PTOKEN_GROUPS Groups, IN PTOKEN_PRIVILEGES Privileges, IN PTOKEN_OWNER <a class="el" href="../../d2/d1/cttoken_8c.html#a53">Owner</a> OPTIONAL, IN PTOKEN_PRIMARY_GROUP PrimaryGroup, IN PTOKEN_DEFAULT_DACL DefaultDacl OPTIONAL, IN PTOKEN_SOURCE TokenSource)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d3/token_8c.html#a16">SepTokenDeleteMethod</a> (IN PVOID <a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d3/token_8c.html#a17">SepCreateToken</a> (OUT PHANDLE TokenHandle, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> RequestorMode, IN ACCESS_MASK DesiredAccess, IN POBJECT_ATTRIBUTES <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a1">ObjectAttributes</a> OPTIONAL, IN TOKEN_TYPE TokenType, IN SECURITY_IMPERSONATION_LEVEL ImpersonationLevel OPTIONAL, IN PLUID AuthenticationId, IN PLARGE_INTEGER ExpirationTime, IN PSID_AND_ATTRIBUTES User, IN ULONG GroupCount, IN PSID_AND_ATTRIBUTES Groups, IN ULONG GroupsLength, IN ULONG PrivilegeCount, IN PLUID_AND_ATTRIBUTES Privileges, IN ULONG PrivilegesLength, IN PSID <a class="el" href="../../d2/d1/cttoken_8c.html#a53">Owner</a> OPTIONAL, IN PSID PrimaryGroup, IN PACL DefaultDacl OPTIONAL, IN PTOKEN_SOURCE TokenSource, IN BOOLEAN SystemToken, IN PSECURITY_TOKEN_PROXY_DATA ProxyData OPTIONAL, IN PSECURITY_TOKEN_AUDIT_DATA AuditData OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d3/token_8c.html#a18">SepIdAssignableAsOwner</a> (IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a> <a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a>, IN ULONG <a class="el" href="../../d7/d0/cmdat2_8c.html#a27">Index</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d3/token_8c.html#a19">SeIsChildToken</a> (IN HANDLE <a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a>, OUT PBOOLEAN IsChild)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d3/token_8c.html#a20">SeIsChildTokenByPointer</a> (IN PACCESS_TOKEN <a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a>, OUT PBOOLEAN IsChild)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d3/token_8c.html#a21">NtImpersonateAnonymousToken</a> (IN HANDLE <a class="el" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>GENERIC_MAPPING&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d3/token_8c.html#a0">SepTokenMapping</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d3/token_8c.html#a1">SepTokenObjectType</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d6/d4/struct__ERESOURCE.html">ERESOURCE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d3/token_8c.html#a2">SepTokenLock</a></td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a15" doxytag="token.c::NtCreateToken" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtCreateToken           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>TokenHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN POBJECT_ATTRIBUTES <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a1">ObjectAttributes</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN TOKEN_TYPE&nbsp;</td>
          <td class="mdname" nowrap> <em>TokenType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLUID&nbsp;</td>
          <td class="mdname" nowrap> <em>AuthenticationId</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>ExpirationTime</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PTOKEN_USER&nbsp;</td>
          <td class="mdname" nowrap> <em>User</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PTOKEN_GROUPS&nbsp;</td>
          <td class="mdname" nowrap> <em>Groups</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PTOKEN_PRIVILEGES&nbsp;</td>
          <td class="mdname" nowrap> <em>Privileges</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PTOKEN_OWNER <a class="el" href="../../d2/d1/cttoken_8c.html#a53">Owner</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PTOKEN_PRIMARY_GROUP&nbsp;</td>
          <td class="mdname" nowrap> <em>PrimaryGroup</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PTOKEN_DEFAULT_DACL DefaultDacl&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PTOKEN_SOURCE&nbsp;</td>
          <td class="mdname" nowrap> <em>TokenSource</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d2/token_8c-source.html#l01690">1690</a> of file <a class="el" href="../../d5/d2/token_8c-source.html">token.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00159">Owner</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01564">ProbeForWriteHandle</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01863">RtlCopyLuid()</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l01370">SeCaptureAcl()</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l01608">SeCaptureLuidAndAttributesArray()</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l00953">SeCaptureSecurityQos()</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l01141">SeCaptureSid()</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l01850">SeCaptureSidAndAttributesArray()</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l00910">SeFreeCapturedSecurityQos()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l02213">SepCreateToken()</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l01560">SeReleaseAcl()</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l01797">SeReleaseLuidAndAttributesArray()</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l01320">SeReleaseSid()</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l02297">SeReleaseSidAndAttributesArray()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00299">CreateDAclToken()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l07648">TestTokenAssignPrimary()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00421">TestTokenCreate()</a>.
<p>
<pre class="fragment"><div>01708                    :
01709 
01710     <a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a> a token object and <span class="keywordflow">return</span> a handle opened <span class="keywordflow">for</span> access to
01711     that token.  This API requires <a class="code" href="../../d0/d5/se_8h.html#a79">SeCreateTokenPrivilege</a> privilege.
01712 
01713 Arguments:
01714 
01715     TokenHandle - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> newly created token.
01716 
01717     DesiredAccess - Is an access mask indicating which access types
01718         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to provide to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> object.
01719 
01720     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a> - Points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> standard object attributes data
01721         structure.  Refer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NT Object Management
01722         Specification <span class="keywordflow">for</span> a description of <span class="keyword">this</span> data structure.
01723 
01724         If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> TokenImpersonation, then <span class="keyword">this</span> parameter
01725         must specify <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> impersonation level of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token.
01726 
01727     TokenType - Type of token to be created.  Privilege <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> required
01728         to create any <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of token.
01729 
01730     AuthenticationId - Points to a LUID (or LUID) providing a unique
01731         identifier associated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> authentication.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used
01732         within security <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a>, <span class="keywordflow">for</span> audit purposes.
01733 
01734     ExpirationTime - <a class="code" href="../../d6/d6/ttime_8c.html#a14">Time</a> at which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token becomes invalid.  If <span class="keyword">this</span>
01735         value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified as zero, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token has no expiration
01736         time.
01737 
01738     User - Is <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user SID to place in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token.
01739 
01740     Groups - Are <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> group SIDs to place in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token.
01741 
01742     Privileges - Are <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> privileges to place in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token.
01743 
01744     <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a> - (Optionally) identifies an identifier that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be used
01745         as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">default</span> owner <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token.  If not provided, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01746         user <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">default</span> owner.
01747 
01748     PrimaryGroup - Identifies which of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> group IDs <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01749         primary group of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token.
01750 
01751     DefaultDacl - (optionally) establishes an ACL to be used as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01752         <span class="keywordflow">default</span> discretionary access protection <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token.
01753 
01754     TokenSource - Identifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token source name string and
01755         identifier to be assigned to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token.
01756 
01757 Return Value:
01758 
01759     STATUS_SUCCESS - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation was successful.
01760 
01761     STATUS_INVALID_OWNER - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a> provided to be assigned
01762         as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">default</span> owner of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token does not have an attribute
01763         indicating <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> may be assigned as an owner.
01764 
01765     STATUS_INVALID_PRIMARY_GROUP - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> group <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a> provided
01766         via <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PrimaryGroup parameter was not among those assigned
01767         to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Groups parameter.
01768 
01769     STATUS_BAD_IMPERSONATION_LEVEL - Indicates no impersonation level
01770         was provided when attempting to create a token of <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>
01771         TokenImpersonation.
01772 
01773 --*/
01774 
01775 {
01776 
01777     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
01778     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01779     ULONG Ignore;
01780 
01781 
01782     HANDLE LocalHandle;
01783 
01784     BOOLEAN SecurityQosPresent = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01785     SECURITY_ADVANCED_QUALITY_OF_SERVICE CapturedSecurityQos;
01786 
01787     LUID CapturedAuthenticationId;
01788     LARGE_INTEGER CapturedExpirationTime;
01789 
01790     PSID_AND_ATTRIBUTES CapturedUser = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01791     ULONG CapturedUserLength;
01792 
01793     ULONG CapturedGroupCount;
01794     PSID_AND_ATTRIBUTES CapturedGroups = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01795     ULONG CapturedGroupsLength;
01796 
01797     ULONG CapturedPrivilegeCount;
01798     PLUID_AND_ATTRIBUTES CapturedPrivileges = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01799     ULONG CapturedPrivilegesLength;
01800 
01801     PSID CapturedOwner = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01802 
01803     PSID CapturedPrimaryGroup = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01804 
01805     PACL CapturedDefaultDacl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01806 
01807     TOKEN_SOURCE CapturedTokenSource;
01808 
01809     PVOID CapturedAddress;
01810 
01811     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01812 
01813     PreviousMode = KeGetPreviousMode();
01814 
01815     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
01816 
01817         <span class="comment">//</span>
01818         <span class="comment">// Probe everything necessary for input to the capture subroutines.</span>
01819         <span class="comment">//</span>
01820 
01821         <span class="keywordflow">try</span> {
01822 
01823             <a class="code" href="../../d5/d8/ex_8h.html#a35">ProbeForWriteHandle</a>(TokenHandle);
01824 
01825 
01826             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( ExpirationTime, <span class="keyword">sizeof</span>(LARGE_INTEGER), <span class="keyword">sizeof</span>(ULONG) );
01827             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( Groups, <span class="keyword">sizeof</span>(TOKEN_GROUPS), <span class="keyword">sizeof</span>(ULONG) );
01828             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( Privileges, <span class="keyword">sizeof</span>(TOKEN_PRIVILEGES), <span class="keyword">sizeof</span>(ULONG) );
01829             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( TokenSource, <span class="keyword">sizeof</span>(TOKEN_SOURCE), <span class="keyword">sizeof</span>(ULONG) );
01830 
01831 
01832             <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(Owner) ) {
01833                 <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( Owner, <span class="keyword">sizeof</span>(TOKEN_OWNER), <span class="keyword">sizeof</span>(ULONG) );
01834             }
01835 
01836 
01837             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(
01838                 PrimaryGroup,
01839                 <span class="keyword">sizeof</span>(TOKEN_PRIMARY_GROUP),
01840                 <span class="keyword">sizeof</span>(ULONG)
01841                 );
01842 
01843 
01844             <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(DefaultDacl) ) {
01845                 <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(
01846                     DefaultDacl,
01847                     <span class="keyword">sizeof</span>(TOKEN_DEFAULT_DACL),
01848                     <span class="keyword">sizeof</span>(ULONG)
01849                     );
01850              }
01851 
01852             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(
01853                 AuthenticationId,
01854                 <span class="keyword">sizeof</span>(LUID),
01855                 <span class="keyword">sizeof</span>(ULONG)
01856                 );
01857 
01858         } except(EXCEPTION_EXECUTE_HANDLER) {
01859             <span class="keywordflow">return</span> GetExceptionCode();
01860         }  <span class="comment">// end_try</span>
01861 
01862     } <span class="comment">//end_if</span>
01863 
01864     <span class="comment">//</span>
01865     <span class="comment">//  Capture the security quality of service.</span>
01866     <span class="comment">//  This capture routine necessarily does some probing of its own.</span>
01867     <span class="comment">//</span>
01868 
01869     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/se_2capture_8c.html#a7">SeCaptureSecurityQos</a>(
01870                  ObjectAttributes,
01871                  PreviousMode,
01872                  &amp;SecurityQosPresent,
01873                  &amp;CapturedSecurityQos
01874                  );
01875 
01876     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01877         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01878     }
01879 
01880     <span class="keywordflow">if</span> (TokenType == TokenImpersonation) {
01881 
01882         <span class="keywordflow">if</span> (!SecurityQosPresent) {
01883             <span class="keywordflow">return</span> STATUS_BAD_IMPERSONATION_LEVEL;
01884         } <span class="comment">// endif</span>
01885 
01886     } <span class="comment">// endif</span>
01887 
01888 
01889     <span class="comment">//</span>
01890     <span class="comment">//  Capture the rest of the arguments.</span>
01891     <span class="comment">//  These arguments have already been probed.</span>
01892     <span class="comment">//</span>
01893 
01894     <span class="keywordflow">try</span> {
01895 
01896         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01897 
01898         <span class="comment">//</span>
01899         <span class="comment">//  Capture and validate AuthenticationID</span>
01900         <span class="comment">//</span>
01901 
01902         <a class="code" href="../../d8/d6/sertl_8c.html#a51">RtlCopyLuid</a>( &amp;CapturedAuthenticationId, AuthenticationId );
01903 
01904         <span class="comment">//</span>
01905         <span class="comment">//  Capture ExpirationTime</span>
01906         <span class="comment">//</span>
01907 
01908         CapturedExpirationTime = (*ExpirationTime);
01909 
01910         <span class="comment">//</span>
01911         <span class="comment">//  Capture User</span>
01912         <span class="comment">//</span>
01913 
01914         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01915             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/se_2capture_8c.html#a14">SeCaptureSidAndAttributesArray</a>(
01916                          &amp;(User-&gt;User),
01917                          1,
01918                          PreviousMode,
01919                          NULL, 0,
01920                          PagedPool,
01921                          TRUE,
01922                          &amp;CapturedUser,
01923                          &amp;CapturedUserLength
01924                          );
01925         }
01926 
01927 
01928         <span class="comment">//</span>
01929         <span class="comment">//  Capture Groups</span>
01930         <span class="comment">//</span>
01931 
01932         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01933             CapturedGroupCount = Groups-&gt;GroupCount;
01934             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/se_2capture_8c.html#a14">SeCaptureSidAndAttributesArray</a>(
01935                          (Groups-&gt;Groups),
01936                          CapturedGroupCount,
01937                          PreviousMode,
01938                          NULL, 0,
01939                          PagedPool,
01940                          TRUE,
01941                          &amp;CapturedGroups,
01942                          &amp;CapturedGroupsLength
01943                          );
01944         }
01945 
01946 
01947         <span class="comment">//</span>
01948         <span class="comment">//  Capture Privileges</span>
01949         <span class="comment">//</span>
01950 
01951         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01952             CapturedPrivilegeCount = Privileges-&gt;PrivilegeCount;
01953             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/se_2capture_8c.html#a12">SeCaptureLuidAndAttributesArray</a>(
01954                          (Privileges-&gt;Privileges),
01955                          CapturedPrivilegeCount,
01956                          PreviousMode,
01957                          NULL, 0,
01958                          PagedPool,
01959                          TRUE,
01960                          &amp;CapturedPrivileges,
01961                          &amp;CapturedPrivilegesLength
01962                          );
01963         }
01964 
01965 
01966         <span class="comment">//</span>
01967         <span class="comment">//  Capture Owner</span>
01968         <span class="comment">//</span>
01969 
01970         <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(Owner) &amp;&amp; <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01971             CapturedAddress = <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>-&gt;Owner;
01972             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/se_2capture_8c.html#a8">SeCaptureSid</a>(
01973                          (PSID)CapturedAddress,
01974                          PreviousMode,
01975                          NULL, 0,
01976                          PagedPool,
01977                          TRUE,
01978                          &amp;CapturedOwner
01979                          );
01980         }
01981 
01982 
01983         <span class="comment">//</span>
01984         <span class="comment">//  Capture PrimaryGroup</span>
01985         <span class="comment">//</span>
01986         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01987             CapturedAddress = PrimaryGroup-&gt;PrimaryGroup;
01988             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/se_2capture_8c.html#a8">SeCaptureSid</a>(
01989                          (PSID)CapturedAddress,
01990                          PreviousMode,
01991                          NULL, 0,
01992                          PagedPool,
01993                          TRUE,
01994                          &amp;CapturedPrimaryGroup
01995                          );
01996         }
01997 
01998 
01999         <span class="comment">//</span>
02000         <span class="comment">//  Capture DefaultDacl</span>
02001         <span class="comment">//</span>
02002 
02003         <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(DefaultDacl) &amp;&amp; <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
02004             CapturedAddress = DefaultDacl-&gt;DefaultDacl;
02005             <span class="keywordflow">if</span> (CapturedAddress != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02006                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/se_2capture_8c.html#a10">SeCaptureAcl</a>(
02007                              (PACL)CapturedAddress,
02008                              PreviousMode,
02009                              NULL, 0,
02010                              NonPagedPool,
02011                              TRUE,
02012                              &amp;CapturedDefaultDacl,
02013                              &amp;Ignore
02014                              );
02015             }
02016         }
02017 
02018         <span class="comment">//</span>
02019         <span class="comment">//  Capture TokenSource</span>
02020         <span class="comment">//</span>
02021 
02022         CapturedTokenSource = (*TokenSource);
02023 
02024 
02025     } except(EXCEPTION_EXECUTE_HANDLER) {
02026 
02027         <span class="keywordflow">if</span> (CapturedUser != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02028             <a class="code" href="../../d2/d5/se_2capture_8c.html#a15">SeReleaseSidAndAttributesArray</a>(
02029                 CapturedUser,
02030                 PreviousMode,
02031                 TRUE
02032                 );
02033         }
02034 
02035         <span class="keywordflow">if</span> (CapturedGroups != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02036             <a class="code" href="../../d2/d5/se_2capture_8c.html#a15">SeReleaseSidAndAttributesArray</a>(
02037                 CapturedGroups,
02038                 PreviousMode,
02039                 TRUE
02040                 );
02041         }
02042 
02043         <span class="keywordflow">if</span> (CapturedPrivileges != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02044             <a class="code" href="../../d2/d5/se_2capture_8c.html#a13">SeReleaseLuidAndAttributesArray</a>(
02045                 CapturedPrivileges,
02046                 PreviousMode,
02047                 TRUE
02048                 );
02049         }
02050 
02051         <span class="keywordflow">if</span> (CapturedOwner != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02052             <a class="code" href="../../d2/d5/se_2capture_8c.html#a9">SeReleaseSid</a>( CapturedOwner, PreviousMode, TRUE);
02053         }
02054 
02055         <span class="keywordflow">if</span> (CapturedPrimaryGroup != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02056             <a class="code" href="../../d2/d5/se_2capture_8c.html#a9">SeReleaseSid</a>( CapturedPrimaryGroup, PreviousMode, TRUE);
02057         }
02058 
02059         <span class="keywordflow">if</span> (CapturedDefaultDacl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02060             <a class="code" href="../../d2/d5/se_2capture_8c.html#a11">SeReleaseAcl</a>( CapturedDefaultDacl, PreviousMode, TRUE);
02061         }
02062 
02063         <span class="keywordflow">if</span> (SecurityQosPresent == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02064             <a class="code" href="../../d2/d5/se_2capture_8c.html#a6">SeFreeCapturedSecurityQos</a>( &amp;CapturedSecurityQos );
02065         }
02066 
02067         <span class="keywordflow">return</span> GetExceptionCode();
02068 
02069     }  <span class="comment">// end_try{}</span>
02070 
02071     <span class="comment">//</span>
02072     <span class="comment">//  Create the token</span>
02073     <span class="comment">//</span>
02074 
02075     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02076         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d3/token_8c.html#a17">SepCreateToken</a>(
02077                                 &amp;LocalHandle,
02078                                 PreviousMode,
02079                                 DesiredAccess,
02080                                 ObjectAttributes,
02081                                 TokenType,
02082                                 CapturedSecurityQos.ImpersonationLevel,
02083                                 &amp;CapturedAuthenticationId,
02084                                 &amp;CapturedExpirationTime,
02085                                 CapturedUser,
02086                                 CapturedGroupCount,
02087                                 CapturedGroups,
02088                                 CapturedGroupsLength,
02089                                 CapturedPrivilegeCount,
02090                                 CapturedPrivileges,
02091                                 CapturedPrivilegesLength,
02092                                 CapturedOwner,
02093                                 CapturedPrimaryGroup,
02094                                 CapturedDefaultDacl,
02095                                 &amp;CapturedTokenSource,
02096                                 FALSE,                       <span class="comment">// Not a system token</span>
02097                                 SecurityQosPresent ? CapturedSecurityQos.ProxyData : NULL,
02098                                 SecurityQosPresent ? CapturedSecurityQos.AuditData : NULL
02099                                 );
02100     }
02101 
02102     <span class="comment">//</span>
02103     <span class="comment">//  Clean up the temporary capture buffers</span>
02104     <span class="comment">//</span>
02105 
02106     <span class="keywordflow">if</span> (CapturedUser != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02107         <a class="code" href="../../d2/d5/se_2capture_8c.html#a15">SeReleaseSidAndAttributesArray</a>( CapturedUser, PreviousMode, TRUE);
02108     }
02109     <span class="keywordflow">if</span> (CapturedGroups != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02110         <a class="code" href="../../d2/d5/se_2capture_8c.html#a15">SeReleaseSidAndAttributesArray</a>( CapturedGroups, PreviousMode, TRUE);
02111     }
02112 
02113     <span class="keywordflow">if</span> (CapturedPrivileges != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02114         <a class="code" href="../../d2/d5/se_2capture_8c.html#a13">SeReleaseLuidAndAttributesArray</a>( CapturedPrivileges, PreviousMode, TRUE);
02115     }
02116 
02117     <span class="keywordflow">if</span> (CapturedOwner != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02118         <a class="code" href="../../d2/d5/se_2capture_8c.html#a9">SeReleaseSid</a>( CapturedOwner, PreviousMode, TRUE);
02119     }
02120 
02121     <span class="keywordflow">if</span> (CapturedPrimaryGroup != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02122         <a class="code" href="../../d2/d5/se_2capture_8c.html#a9">SeReleaseSid</a>( CapturedPrimaryGroup, PreviousMode, TRUE);
02123     }
02124 
02125     <span class="keywordflow">if</span> (CapturedDefaultDacl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02126         <a class="code" href="../../d2/d5/se_2capture_8c.html#a11">SeReleaseAcl</a>( CapturedDefaultDacl, PreviousMode, TRUE);
02127     }
02128 
02129     <span class="keywordflow">if</span> (SecurityQosPresent == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02130         <a class="code" href="../../d2/d5/se_2capture_8c.html#a6">SeFreeCapturedSecurityQos</a>( &amp;CapturedSecurityQos );
02131     }
02132 
02133     <span class="comment">//</span>
02134     <span class="comment">//  Return the handle to this new token</span>
02135     <span class="comment">//</span>
02136 
02137     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02138         <span class="keywordflow">try</span> { *TokenHandle = LocalHandle; }
02139             except(EXCEPTION_EXECUTE_HANDLER) { <span class="keywordflow">return</span> GetExceptionCode(); }
02140     }
02141 
02142     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02143 
02144 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="token.c::NtImpersonateAnonymousToken" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtImpersonateAnonymousToken           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ThreadHandle</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d2/token_8c-source.html#l03038">3038</a> of file <a class="el" href="../../d5/d2/token_8c-source.html">token.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l01022">ObReferenceObjectByPointer()</a>, <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l00650">PsImpersonateClient()</a>, <a class="el" href="../../d0/d8/ntos_8h-source.html#l00089">PsThreadType</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01645">SeAnonymousLogonToken</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01212">SepTokenObjectType</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00138">ThreadHandle</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>03044                    :
03045 
03046     Impersonates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system's anonymous logon token on <span class="keyword">this</span> thread.
03047 
03048 Arguments:
03049 
03050     <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a> - <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread to <span class="keywordflow">do</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> impersonation.
03051 
03052 Return Value:
03053 
03054     STATUS_SUCCESS - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation was successful.
03055 
03056     STATUS_INVALID_HANDLE - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread handle <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invalid.
03057 
03058     STATUS_ACCESS_DENIED - The thread handle <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not open <span class="keywordflow">for</span> impersonation
03059         access.
03060 --*/
03061 {
03062     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> CallerThread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03063     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
03064 
03065     <span class="comment">//</span>
03066     <span class="comment">// Reference the caller's thread to make sure we can impersonate</span>
03067     <span class="comment">//</span>
03068 
03069     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
03070                  ThreadHandle,
03071                  THREAD_IMPERSONATE,
03072                  PsThreadType,
03073                  KeGetPreviousMode(),
03074                  (PVOID *)&amp;CallerThread,
03075                  NULL
03076                  );
03077     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
03078         <span class="keywordflow">goto</span> Cleanup;
03079     }
03080 
03081     <span class="comment">//</span>
03082     <span class="comment">// Reference the impersonation token to make sure we are allowed to</span>
03083     <span class="comment">// impersonate it.</span>
03084     <span class="comment">//</span>
03085 
03086     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a6">ObReferenceObjectByPointer</a>(
03087                 SeAnonymousLogonToken,
03088                 TOKEN_IMPERSONATE,
03089                 SepTokenObjectType,
03090                 KeGetPreviousMode()
03091                 );
03092     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
03093     {
03094         <span class="keywordflow">goto</span> Cleanup;
03095     }
03096 
03097     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(SeAnonymousLogonToken);
03098 
03099     <span class="comment">//</span>
03100     <span class="comment">// Do the impersonation. We want copy on open so the caller can't</span>
03101     <span class="comment">// actually modify this system's copy of this token.</span>
03102     <span class="comment">//</span>
03103 
03104     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d5/ps_2security_8c.html#a6">PsImpersonateClient</a>(
03105                 CallerThread,
03106                 SeAnonymousLogonToken,
03107                 TRUE,                   <span class="comment">// copy on open</span>
03108                 FALSE,                  <span class="comment">// no effective only</span>
03109                 SecurityImpersonation
03110                 );
03111 Cleanup:
03112 
03113     <span class="keywordflow">if</span> (CallerThread != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03114         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(CallerThread);
03115     }
03116     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03117 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="token.c::SeAssignPrimaryToken" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SeAssignPrimaryToken           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PACCESS_TOKEN&nbsp;</td>
          <td class="mdname" nowrap> <em>Token</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d2/token_8c-source.html#l00241">241</a> of file <a class="el" href="../../d5/d2/token_8c-source.html">token.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00038">PTOKEN</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l00302">SeDeassignPrimaryToken()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l01117">PspInitializeProcessSecurity()</a>.
<p>
<pre class="fragment"><div>00249                    :
00250 
00251     This function establishes a primary token <span class="keywordflow">for</span> a process.
00252 
00253 Arguments:
00254 
00255     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> - Points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> primary token.
00256 
00257 Return Value:
00258 
00259     None.
00260 
00261 --*/
00262 
00263 {
00264 
00265     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00266         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00267 
00268     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>
00269         NewToken = (<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
00270 
00271     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00272 
00273     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(NewToken-&gt;TokenType == TokenPrimary);
00274     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( !NewToken-&gt;TokenInUse );
00275 
00276 
00277     <span class="comment">//</span>
00278     <span class="comment">// Dereference the old token if there is one.</span>
00279     <span class="comment">//</span>
00280     <span class="comment">// Processes typically already have a token that must be</span>
00281     <span class="comment">// dereferenced.  There are two cases where this may not</span>
00282     <span class="comment">// be the situation.  First, during phase 0 system initialization,</span>
00283     <span class="comment">// the initial system process starts out without a token.  Second,</span>
00284     <span class="comment">// if an error occurs during process creation, we may be cleaning</span>
00285     <span class="comment">// up a process that hasn't yet had a primary token assigned.</span>
00286     <span class="comment">//</span>
00287 
00288     <span class="keywordflow">if</span> (Process-&gt;Token != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00289         <a class="code" href="../../d4/d3/token_8c.html#a8">SeDeassignPrimaryToken</a>( Process );
00290     }
00291 
00292 
00293     Process-&gt;Token=<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
00294     NewToken-&gt;TokenInUse = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00295     <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(NewToken);
00296     <span class="keywordflow">return</span>;
00297 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="token.c::SeDeassignPrimaryToken" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SeDeassignPrimaryToken           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Process</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d2/token_8c-source.html#l00302">302</a> of file <a class="el" href="../../d5/d2/token_8c-source.html">token.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d6/d2/parseini_8c-source.html#l00038">PTOKEN</a>.
<p>
Referenced by <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l01206">PspDeleteProcessSecurity()</a>, and <a class="el" href="../../d5/d2/token_8c-source.html#l00241">SeAssignPrimaryToken()</a>.
<p>
<pre class="fragment"><div>00309                    :
00310 
00311     This function causes a process reference to a token to be
00312     dropped.
00313 
00314 Arguments:
00315 
00316     Process - Points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process whose primary token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> no longer needed.
00317         This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> probably <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">case</span> at process deletion or when
00318         a primary token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being replaced.
00319 
00320 Return Value:
00321 
00322     None.
00323 
00324 --*/
00325 
00326 {
00327 
00328     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>
00329         OldToken = (<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)(Process-&gt;Token);
00330 
00331     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00332 
00333     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(OldToken-&gt;TokenType == TokenPrimary);
00334     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(OldToken-&gt;TokenInUse);
00335 
00336     OldToken-&gt;TokenInUse = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00337     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( OldToken );
00338 
00339 
00340     <span class="keywordflow">return</span>;
00341 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="token.c::SeExchangePrimaryToken" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS SeExchangePrimaryToken           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PACCESS_TOKEN&nbsp;</td>
          <td class="mdname" nowrap> <em>NewAccessToken</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PACCESS_TOKEN *&nbsp;</td>
          <td class="mdname" nowrap> <em>OldAccessToken</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d2/token_8c-source.html#l00346">346</a> of file <a class="el" href="../../d5/d2/token_8c-source.html">token.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00038">PTOKEN</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l01256">PspAssignPrimaryToken()</a>.
<p>
<pre class="fragment"><div>00355                    :
00356 
00357     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to perform <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> portions of changing a primary
00358     token that reference <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> internals of token structures.
00359 
00360     The <span class="keyword">new</span> token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> checked to make sure <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not already in use.
00361 
00362     The
00363 
00364 
00365     !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
00366     !!!!!!!!       <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>        !!!!!!!!
00367     !!!!!!!!                                              !!!!!!!!
00368     !!!!!!!!  THIS ROUTINE MUST BE CALLED WITH THE GOBAL  !!!!!!!!
00369     !!!!!!!!  PROCESS SECURITY FIELDS <a class="code" href="../../d4/d2/struct__LOCK.html">LOCK</a> HELD           !!!!!!!!
00370     !!!!!!!!                                              !!!!!!!!
00371     !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
00372 
00373 Arguments:
00374 
00375     Process - Points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process whose primary token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being exchanged.
00376 
00377     NewAccessToken - Points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process's <span class="keyword">new</span> primary token.
00378 
00379     OldAccessToken - Receives a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process's current token.
00380         The caller <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> responsible <span class="keywordflow">for</span> dereferencing <span class="keyword">this</span> token when
00381         <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> no longer needed.  This can'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> be done <span class="keywordflow">while</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process
00382         security locks are held.
00383 
00384 
00385 Return Value:
00386 
00387     STATUS_SUCCESS - Everything has been updated.
00388 
00389     STATUS_TOKEN_ALREADY_IN_USE - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> primary token can <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> be used by a
00390         single process.  That <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>, each process must have its own primary
00391         token.  The token passed to  be assigned as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> primary token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00392         already in use as a primary token.
00393 
00394     STATUS_BAD_TOKEN_TYPE - The <span class="keyword">new</span> token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not a primary token.
00395 
00396 
00397 --*/
00398 
00399 {
00400     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00401         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00402 
00403     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>
00404         OldToken = (<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)(Process-&gt;Token);
00405 
00406     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>
00407         NewToken = (<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)NewAccessToken;
00408 
00409     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00410 
00411 
00412     <span class="comment">//</span>
00413     <span class="comment">// We need to access the security fields of both tokens.</span>
00414     <span class="comment">// Access to these fields is guarded by the global Process Security</span>
00415     <span class="comment">// fields lock.</span>
00416     <span class="comment">//</span>
00417 
00418     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(OldToken-&gt;TokenType == TokenPrimary);
00419     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(OldToken-&gt;TokenInUse);
00420 
00421 
00422     <span class="comment">//</span>
00423     <span class="comment">// Make sure the new token is a primary token...</span>
00424     <span class="comment">//</span>
00425 
00426     <span class="keywordflow">if</span> ( NewToken-&gt;TokenType != TokenPrimary ) {
00427         <span class="keywordflow">return</span>(STATUS_BAD_TOKEN_TYPE);
00428     }
00429 
00430     <span class="comment">//</span>
00431     <span class="comment">// and that it is not already in use...</span>
00432     <span class="comment">//</span>
00433 
00434     <span class="keywordflow">if</span> (NewToken-&gt;TokenInUse) {
00435         <span class="keywordflow">return</span>(STATUS_TOKEN_ALREADY_IN_USE);
00436     }
00437 
00438     <span class="comment">//</span>
00439     <span class="comment">// Ensure SessionId consistent for hydra</span>
00440     <span class="comment">//</span>
00441 
00442     NewToken-&gt;SessionId = OldToken-&gt;SessionId ;
00443 
00444 
00445 
00446     <span class="comment">//</span>
00447     <span class="comment">// Switch the tokens</span>
00448     <span class="comment">//</span>
00449 
00450     Process-&gt;Token=NewAccessToken;
00451     NewToken-&gt;TokenInUse = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00452     <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(NewToken);
00453 
00454     <span class="comment">//</span>
00455     <span class="comment">// Mark the token as "NOT USED"</span>
00456     <span class="comment">//</span>
00457 
00458     OldToken-&gt;TokenInUse = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00459 
00460     <span class="comment">//</span>
00461     <span class="comment">// Return the pointer to the old token.  The caller</span>
00462     <span class="comment">// is responsible for dereferencing it if they don't need it.</span>
00463     <span class="comment">//</span>
00464 
00465     (*OldAccessToken) = OldToken;
00466 
00467     <span class="keywordflow">return</span> (STATUS_SUCCESS);
00468 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="token.c::SeGetTokenControlInformation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SeGetTokenControlInformation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PACCESS_TOKEN&nbsp;</td>
          <td class="mdname" nowrap> <em>Token</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PTOKEN_CONTROL&nbsp;</td>
          <td class="mdname" nowrap> <em>TokenControl</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d2/token_8c-source.html#l00475">475</a> of file <a class="el" href="../../d5/d2/token_8c-source.html">token.c</a>.
<p>
References <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00038">PTOKEN</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00413">SepAcquireTokenReadLock</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00419">SepReleaseTokenReadLock</a>, and <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>.
<p>
Referenced by <a class="el" href="../../d5/d4/seclient_8c-source.html#l00062">SepCreateClientSecurity()</a>.
<p>
<pre class="fragment"><div>00482                    :
00483 
00484     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> provided <span class="keywordflow">for</span> communication session layers, or
00485     any other executive component that needs to keep track of
00486     whether a caller's security context has changed between calls.
00487     Communication session layers will need to check <span class="keyword">this</span>, <span class="keywordflow">for</span> some
00488     security quality of service modes, to determine whether or not
00489     a server's security context needs to be updated to reflect
00490     changes in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client's security context.
00491 
00492     This routine will also be useful to communications subsystems
00493     that need to retrieve client' authentication information from
00494     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> local security authority in order to perform a remote
00495     authentication.
00496 
00497 
00498 Parameters:
00499 
00500     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> - Points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token whose information <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be retrieved.
00501 
00502     TokenControl - Points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a>
00503         information.
00504 
00505 Return Value:
00506 
00507     None.
00508 
00509 --*/
00510 
00511 {
00512     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00513 
00514     <span class="comment">//</span>
00515     <span class="comment">//  acquire exclusive access to the token</span>
00516     <span class="comment">//</span>
00517 
00518     <a class="code" href="../../d8/d3/tokenp_8h.html#a6">SepAcquireTokenReadLock</a>( (PTOKEN)Token );
00519 
00520     <span class="comment">//</span>
00521     <span class="comment">//  Grab the data  and  run</span>
00522     <span class="comment">//</span>
00523 
00524     TokenControl-&gt;TokenId = ((<a class="code" href="../../d8/d1/struct__TOKEN.html">TOKEN</a> *)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>)-&gt;TokenId;
00525     TokenControl-&gt;AuthenticationId = ((<a class="code" href="../../d8/d1/struct__TOKEN.html">TOKEN</a> *)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>)-&gt;AuthenticationId;
00526     TokenControl-&gt;ModifiedId = ((<a class="code" href="../../d8/d1/struct__TOKEN.html">TOKEN</a> *)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>)-&gt;ModifiedId;
00527     TokenControl-&gt;TokenSource = ((<a class="code" href="../../d8/d1/struct__TOKEN.html">TOKEN</a> *)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>)-&gt;TokenSource;
00528 
00529     <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( (PTOKEN)Token );
00530 
00531     <span class="keywordflow">return</span>;
00532 
00533 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="token.c::SeIsChildToken" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS SeIsChildToken           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Token</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>IsChild</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d2/token_8c-source.html#l02867">2867</a> of file <a class="el" href="../../d5/d2/token_8c-source.html">token.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d8/client_2wow_8c-source.html#l00508">IsChild()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00810">PsDereferencePrimaryToken</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l00028">PsReferencePrimaryToken()</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00038">PTOKEN</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01824">RtlEqualLuid()</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00413">SepAcquireTokenReadLock</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00419">SepReleaseTokenReadLock</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01212">SepTokenObjectType</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>02873                    :
02874 
02875     This routine returns <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> supplied token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a child of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller's
02876     process token. This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> done by comparing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ParentTokenId field of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02877     supplied token to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> TokenId field of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current subject
02878     context.
02879 
02880 Arguments:
02881 
02882     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> - <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> to check <span class="keywordflow">for</span> childhood
02883 
02884     <a class="code" href="../../d3/d9/client_2wow_8c.html#a18">IsChild</a> - Contains results of comparison.
02885 
02886         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - The supplied token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a child of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller's token
02887         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>- The supplied token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not a child of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller's token
02888 
02889 Returns:
02890 
02891     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> codes from any NT services called.
02892 
02893 --*/
02894 {
02895     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> CallerToken;
02896     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> SuppliedToken;
02897     LUID CallerTokenId;
02898     LUID SuppliedParentTokenId;
02899     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
02900 
02901     *<a class="code" href="../../d3/d9/client_2wow_8c.html#a18">IsChild</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02902 
02903     <span class="comment">//</span>
02904     <span class="comment">// Capture the caller's token and get the token id</span>
02905     <span class="comment">//</span>
02906 
02907     CallerToken = (<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>) <a class="code" href="../../d6/d5/ps_2security_8c.html#a0">PsReferencePrimaryToken</a>(<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>());
02908 
02909 
02910     <a class="code" href="../../d8/d3/tokenp_8h.html#a6">SepAcquireTokenReadLock</a>( CallerToken );
02911 
02912     CallerTokenId = CallerToken-&gt;TokenId;
02913 
02914     <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( CallerToken );
02915 
02916     <a class="code" href="../../d1/d9/ps_8h.html#a24">PsDereferencePrimaryToken</a>(CallerToken);
02917 
02918     <span class="comment">//</span>
02919     <span class="comment">// Reference the supplied token and get the parent token id.</span>
02920     <span class="comment">//</span>
02921 
02922     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
02923                 Token,                   <span class="comment">// Handle</span>
02924                 0,                       <span class="comment">// DesiredAccess</span>
02925                 SepTokenObjectType,      <span class="comment">// ObjectType</span>
02926                 KeGetPreviousMode(),     <span class="comment">// AccessMode</span>
02927                 (PVOID *)&amp;SuppliedToken, <span class="comment">// Object</span>
02928                 NULL                     <span class="comment">// GrantedAccess</span>
02929                 );
02930 
02931     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
02932     {
02933         <a class="code" href="../../d8/d3/tokenp_8h.html#a6">SepAcquireTokenReadLock</a>( SuppliedToken );
02934 
02935         SuppliedParentTokenId = SuppliedToken-&gt;ParentTokenId;
02936 
02937         <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( SuppliedToken );
02938 
02939         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(SuppliedToken);
02940 
02941         <span class="comment">//</span>
02942         <span class="comment">// Check to see if the supplied token's parent ID is the ID</span>
02943         <span class="comment">// of the caller.</span>
02944         <span class="comment">//</span>
02945 
02946         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>(
02947                 &amp;SuppliedParentTokenId,
02948                 &amp;CallerTokenId
02949                 )) {
02950 
02951             *<a class="code" href="../../d3/d9/client_2wow_8c.html#a18">IsChild</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02952         }
02953 
02954     }
02955     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02956 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="token.c::SeIsChildTokenByPointer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS SeIsChildTokenByPointer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PACCESS_TOKEN&nbsp;</td>
          <td class="mdname" nowrap> <em>Token</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>IsChild</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d2/token_8c-source.html#l02960">2960</a> of file <a class="el" href="../../d5/d2/token_8c-source.html">token.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d8/client_2wow_8c-source.html#l00508">IsChild()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00810">PsDereferencePrimaryToken</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l00028">PsReferencePrimaryToken()</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00038">PTOKEN</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01824">RtlEqualLuid()</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00413">SepAcquireTokenReadLock</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00419">SepReleaseTokenReadLock</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d2/d0/psjob_8c-source.html#l01323">NtSetInformationJobObject()</a>, and <a class="el" href="../../d0/d1/psquery_8c-source.html#l00366">PspSetPrimaryToken()</a>.
<p>
<pre class="fragment"><div>02966                    :
02967 
02968     This routine returns <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> supplied token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a child of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller's
02969     token. This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> done by comparing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ParentTokenId field of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> supplied
02970     token to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> TokenId field of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current subject context.
02971 
02972 Arguments:
02973 
02974     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> - <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> to check <span class="keywordflow">for</span> childhood
02975 
02976     <a class="code" href="../../d3/d9/client_2wow_8c.html#a18">IsChild</a> - Contains results of comparison.
02977 
02978         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - The supplied token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a child of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller's token
02979         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>- The supplied token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not a child of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller's token
02980 
02981 Returns:
02982 
02983     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> codes from any NT services called.
02984 
02985 --*/
02986 {
02987     <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">SECURITY_SUBJECT_CONTEXT</a> SubjectSecurityContext;
02988     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> CallerToken;
02989     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> SuppliedToken;
02990     LUID CallerTokenId;
02991     LUID SuppliedParentTokenId;
02992     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
02993 
02994     *<a class="code" href="../../d3/d9/client_2wow_8c.html#a18">IsChild</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02995 
02996     <span class="comment">//</span>
02997     <span class="comment">// Capture the caller's token and get the token id</span>
02998     <span class="comment">//</span>
02999 
03000     CallerToken = (<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>) <a class="code" href="../../d6/d5/ps_2security_8c.html#a0">PsReferencePrimaryToken</a>(<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>());
03001 
03002 
03003     <a class="code" href="../../d8/d3/tokenp_8h.html#a6">SepAcquireTokenReadLock</a>( CallerToken );
03004 
03005     CallerTokenId = CallerToken-&gt;TokenId;
03006 
03007     <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( CallerToken );
03008 
03009     <a class="code" href="../../d1/d9/ps_8h.html#a24">PsDereferencePrimaryToken</a>(CallerToken);
03010 
03011     SuppliedToken = (<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>) <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> ;
03012 
03013     <a class="code" href="../../d8/d3/tokenp_8h.html#a6">SepAcquireTokenReadLock</a>( SuppliedToken );
03014 
03015     SuppliedParentTokenId = SuppliedToken-&gt;ParentTokenId;
03016 
03017     <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( SuppliedToken );
03018 
03019     <span class="comment">//</span>
03020     <span class="comment">// Check to see if the supplied token's parent ID is the ID</span>
03021     <span class="comment">// of the caller.</span>
03022     <span class="comment">//</span>
03023 
03024     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>(
03025             &amp;SuppliedParentTokenId,
03026             &amp;CallerTokenId
03027             )) {
03028 
03029         *<a class="code" href="../../d3/d9/client_2wow_8c.html#a18">IsChild</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03030     }
03031 
03032 
03033 
03034     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03035 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="token.c::SeMakeAnonymousLogonToken" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PACCESS_TOKEN SeMakeAnonymousLogonToken           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d2/token_8c-source.html#l01010">1010</a> of file <a class="el" href="../../d5/d2/token_8c-source.html">token.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00152">NoExpiration</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00144">NormalGroupAttributes</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l01183">ObAssignObjectSecurityDescriptor()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00159">Owner</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d8/d0/rtlassig_8c-source.html#l00360">RtlAbsoluteToSelfRelativeSD()</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l01607">RtlAddAccessAllowedAce()</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l00099">RtlCreateAcl()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01945">RtlCreateSecurityDescriptor()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l02543">RtlSetDaclSecurityDescriptor()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l03135">RtlSetGroupSecurityDescriptor()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l02963">RtlSetOwnerSecurityDescriptor()</a>, <a class="el" href="../../d2/d1/time_8c-source.html#l00822">RtlTimeFieldsToTime()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01630">SeAliasAdminsSid</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01600">SeAnonymousAuthenticationId</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01632">SeAnonymousLogonSid</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00540">SeLengthSid</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l02213">SepCreateToken()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01602">SeSystemTokenSource</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01609">SeWorldSid</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d5/ttime_8c-source.html#l00046">TimeFields</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>01016                    :
01017 
01018     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> provided <span class="keywordflow">for</span> use by executive components
01019     DURING SYSTEM INITIALIZATION ONLY.  It creates a token <span class="keywordflow">for</span>
01020     use by system components.
01021 
01022     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> system token has <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following characteristics:
01023 
01024          - It has ANONYMOUS_LOGON as its user <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>
01025 
01026          - It has <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following groups with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> corresponding
01027            attributes:
01028 
01029 
01030                WORLD             EnabledByDefault |
01031                                  Enabled          |
01032                                  Mandatory
01033 
01034 
01035          - It has WORLD as its primary group.
01036 
01037          - It has no privileges/
01038 
01039 
01040          - It has protection that provides TOKEN_ALL_ACCESS to
01041            <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> WORLD <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>.
01042 
01043 
01044          - It has a <span class="keywordflow">default</span> ACL that grants GENERIC_ALL access
01045            to WORLD.
01046 
01047 
01048 Parameters:
01049 
01050     None.
01051 
01052 Return Value:
01053 
01054     Pointer to a system token.
01055 
01056 --*/
01057 
01058 {
01059     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01060 
01061     PVOID <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
01062 
01063     SID_AND_ATTRIBUTES UserId;
01064     PSID_AND_ATTRIBUTES GroupIds;
01065     TOKEN_PRIMARY_GROUP PrimaryGroup;
01066     ULONG GroupIdsLength;
01067     PACL TokenAcl;
01068     PSID <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>;
01069     ULONG <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>;
01070     ULONG Length;
01071     OBJECT_ATTRIBUTES TokenObjectAttributes;
01072     PSECURITY_DESCRIPTOR TokenSecurityDescriptor;
01073     ULONG BufferLength;
01074     PVOID <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
01075 
01076     ULONG_PTR GroupIdsBuffer[128 * <span class="keyword">sizeof</span>(ULONG) / <span class="keyword">sizeof</span>(ULONG_PTR)];
01077 
01078     TIME_FIELDS <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>;
01079     LARGE_INTEGER <a class="code" href="../../d6/d0/ctaccess_8c.html#a49">NoExpiration</a>;
01080 
01081     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01082 
01083 
01084 
01085     <span class="comment">//</span>
01086     <span class="comment">// Set up expiration times</span>
01087     <span class="comment">//</span>
01088 
01089     <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>.Year = 3000;
01090     <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>.Month = 1;
01091     <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>.Day = 1;
01092     <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>.Hour = 1;
01093     <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>.Minute = 1;
01094     <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>.Second = 1;
01095     <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>.Milliseconds = 1;
01096     <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>.Weekday = 1;
01097 
01098     <a class="code" href="../../d1/d2/time_8c.html#a28">RtlTimeFieldsToTime</a>( &amp;TimeFields, &amp;NoExpiration );
01099 
01100 
01101 
01102     GroupIds = (PSID_AND_ATTRIBUTES)GroupIdsBuffer;
01103 
01104 
01105     <span class="comment">//</span>
01106     <span class="comment">// Set up the attributes to be assigned to groups</span>
01107     <span class="comment">//</span>
01108 
01109     <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a> =    (SE_GROUP_MANDATORY          |
01110                                 SE_GROUP_ENABLED_BY_DEFAULT |
01111                                 SE_GROUP_ENABLED
01112                                 );
01113 
01114 
01115     <span class="comment">//</span>
01116     <span class="comment">// Set up the user ID</span>
01117     <span class="comment">//</span>
01118 
01119     UserId.Sid = <a class="code" href="../../d0/d5/se_8h.html#a58">SeAnonymousLogonSid</a>;
01120     UserId.Attributes = 0;
01121 
01122     <span class="comment">//</span>
01123     <span class="comment">// Set up the groups</span>
01124     <span class="comment">//</span>
01125 
01126 
01127     GroupIds-&gt;Sid  = <a class="code" href="../../d0/d5/se_8h.html#a42">SeWorldSid</a>;
01128     GroupIds-&gt;Attributes = <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>;
01129 
01130 
01131     GroupIdsLength = (ULONG)LongAlignSize(<a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(GroupIds-&gt;Sid)) +
01132                                                     <span class="keyword">sizeof</span>(SID_AND_ATTRIBUTES);
01133 
01134     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( GroupIdsLength &lt;= 128 * <span class="keyword">sizeof</span>(ULONG) );
01135 
01136 
01137     <span class="comment">//</span>
01138     <span class="comment">// Privileges</span>
01139     <span class="comment">//</span>
01140 
01141 
01142     <span class="comment">//</span>
01143     <span class="comment">// Establish the primary group and default owner</span>
01144     <span class="comment">//</span>
01145 
01146     PrimaryGroup.PrimaryGroup = <a class="code" href="../../d0/d5/se_8h.html#a58">SeAnonymousLogonSid</a>;  <span class="comment">// Primary group</span>
01147 
01148 
01149 
01150 
01151 
01152     <span class="comment">//</span>
01153     <span class="comment">// Set up an ACL to protect token as well ...</span>
01154     <span class="comment">// give system full reign of terror.  This includes user-mode components</span>
01155     <span class="comment">// running as part of the system.</span>
01156     <span class="comment">//</span>
01157 
01158     Length = (ULONG)<span class="keyword">sizeof</span>(ACL) +
01159              (ULONG)<span class="keyword">sizeof</span>(ACCESS_ALLOWED_ACE) +
01160              <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( SeWorldSid ) +
01161              8; <span class="comment">// The 8 is just for good measure</span>
01162     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Length &lt; 200 );
01163 
01164     TokenAcl = (PACL)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(PagedPool, 200, 'cAeS');
01165 
01166     <span class="keywordflow">if</span> ( !TokenAcl ) {
01167 
01168         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
01169     }
01170 
01171     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a6">RtlCreateAcl</a>( TokenAcl, Length, ACL_REVISION2);
01172     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) );
01173 
01174     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a16">RtlAddAccessAllowedAce</a> (
01175                  TokenAcl,
01176                  ACL_REVISION2,
01177                  TOKEN_ALL_ACCESS,
01178                  SeWorldSid
01179                  );
01180     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) );
01181 
01182     TokenSecurityDescriptor =
01183     (PSECURITY_DESCRIPTOR)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
01184                               PagedPool,
01185                               SECURITY_DESCRIPTOR_MIN_LENGTH,
01186                               'dSeS'
01187                               );
01188 
01189     <span class="keywordflow">if</span> ( !TokenSecurityDescriptor ) {
01190 
01191         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( TokenAcl );
01192 
01193         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
01194     }
01195 
01196 
01197     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a53">RtlCreateSecurityDescriptor</a>(
01198                  TokenSecurityDescriptor,
01199                  SECURITY_DESCRIPTOR_REVISION
01200                  );
01201     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) );
01202 
01203     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a60">RtlSetDaclSecurityDescriptor</a> (
01204                  TokenSecurityDescriptor,
01205                  TRUE,
01206                  TokenAcl,
01207                  FALSE
01208                  );
01209     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) );
01210 
01211 
01212     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a64">RtlSetOwnerSecurityDescriptor</a> (
01213                  TokenSecurityDescriptor,
01214                  SeWorldSid,
01215                  FALSE <span class="comment">// Owner defaulted</span>
01216                  );
01217     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) );
01218 
01219     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a66">RtlSetGroupSecurityDescriptor</a> (
01220                  TokenSecurityDescriptor,
01221                  SeWorldSid,
01222                  FALSE <span class="comment">// Group defaulted</span>
01223                  );
01224     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) );
01225 
01226 
01227     <span class="comment">//</span>
01228     <span class="comment">// Create the system token</span>
01229     <span class="comment">//</span>
01230 
01231 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
01232 <span class="preprocessor"></span>
01233 <span class="comment">//</span>
01234 <span class="comment">// Debug</span>
01235     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n Creating system token...\n"</span>);
01236 <span class="comment">// Debug</span>
01237 <span class="comment">//</span>
01239 <span class="comment"></span><span class="preprocessor">#endif //TOKEN_DEBUG</span>
01240 <span class="preprocessor"></span>
01241     InitializeObjectAttributes(
01242         &amp;TokenObjectAttributes,
01243         NULL,
01244         0,
01245         NULL,
01246         TokenSecurityDescriptor
01247         );
01248 
01249 
01250 
01251     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d3/token_8c.html#a17">SepCreateToken</a>(
01252                  (PHANDLE)&amp;Token,
01253                  KernelMode,
01254                  0,               <span class="comment">// No handle created for system token</span>
01255                  &amp;TokenObjectAttributes,
01256                  TokenPrimary,
01257                  (SECURITY_IMPERSONATION_LEVEL)0,
01258                  &amp;SeAnonymousAuthenticationId,
01259                  &amp;NoExpiration,
01260                  &amp;UserId,
01261                  1,                         <span class="comment">// GroupCount</span>
01262                  GroupIds,
01263                  GroupIdsLength,
01264                  0,                         <span class="comment">// no privileges</span>
01265                  NULL,                      <span class="comment">// no Privileges,</span>
01266                  0,                         <span class="comment">// no privileges</span>
01267                  NULL,
01268                  PrimaryGroup.PrimaryGroup,
01269                  TokenAcl,
01270                  &amp;SeSystemTokenSource,
01271                  TRUE,                        <span class="comment">// System token</span>
01272                  NULL,
01273                  NULL
01274                  );
01275 
01276      <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
01277 
01278     <span class="comment">//</span>
01279     <span class="comment">// Assign the security descriptor here, since we don't do it</span>
01280     <span class="comment">// in SepCreateToken for the System Token.</span>
01281     <span class="comment">//</span>
01282 
01283     BufferLength = Length +
01284                    <span class="keyword">sizeof</span>(SECURITY_DESCRIPTOR) +
01285                    2 * <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(SeAliasAdminsSid);
01286 
01287     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> =  (PSECURITY_DESCRIPTOR)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( PagedPool,
01288                                                            BufferLength,
01289                                                            'dSeS'
01290                                                            );
01291 
01292     <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> ) {
01293 
01294         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> =  <a class="code" href="../../d7/d1/rtlassig_8c.html#a4">RtlAbsoluteToSelfRelativeSD</a>( TokenSecurityDescriptor,
01295                                                Buffer,
01296                                                &amp;BufferLength
01297                                                );
01298         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
01299 
01300         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> =  <a class="code" href="../../d9/d1/obse_8c.html#a7">ObAssignObjectSecurityDescriptor</a>( Token,
01301                                                     Buffer,
01302                                                     PagedPool
01303                                                     );
01304         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
01305 
01306     } <span class="keywordflow">else</span> {
01307 
01308         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
01309 
01310         <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
01311     }
01312 
01313 
01314     <span class="comment">//</span>
01315     <span class="comment">// We can free the old one now.</span>
01316     <span class="comment">//</span>
01317 
01318     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( TokenAcl );
01319     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( TokenSecurityDescriptor );
01320 
01321     <span class="keywordflow">return</span>  (PACCESS_TOKEN)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
01322 
01323 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="token.c::SeMakeSystemToken" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PACCESS_TOKEN SeMakeSystemToken           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d2/token_8c-source.html#l00536">536</a> of file <a class="el" href="../../d5/d2/token_8c-source.html">token.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00152">NoExpiration</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00144">NormalGroupAttributes</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l01183">ObAssignObjectSecurityDescriptor()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00159">Owner</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00145">OwnerGroupAttributes</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d8/d0/rtlassig_8c-source.html#l00360">RtlAbsoluteToSelfRelativeSD()</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l01607">RtlAddAccessAllowedAce()</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l00099">RtlCreateAcl()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01945">RtlCreateSecurityDescriptor()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l02543">RtlSetDaclSecurityDescriptor()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l03135">RtlSetGroupSecurityDescriptor()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l02963">RtlSetOwnerSecurityDescriptor()</a>, <a class="el" href="../../d2/d1/time_8c-source.html#l00822">RtlTimeFieldsToTime()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01630">SeAliasAdminsSid</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01671">SeAssignPrimaryTokenPrivilege</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01689">SeAuditPrivilege</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01629">SeAuthenticatedUsersSid</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01685">SeBackupPrivilege</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01691">SeChangeNotifyPrivilege</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01679">SeCreatePagefilePrivilege</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01684">SeCreatePermanentPrivilege</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01670">SeCreateTokenPrivilege</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01688">SeDebugPrivilege</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01680">SeIncreaseBasePriorityPrivilege</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01673">SeIncreaseQuotaPrivilege</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00540">SeLengthSid</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01678">SeLoadDriverPrivilege</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01628">SeLocalSystemSid</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01672">SeLockMemoryPrivilege</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l02213">SepCreateToken()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01683">SeProfileSingleProcessPrivilege</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01686">SeRestorePrivilege</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01676">SeSecurityPrivilege</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01687">SeShutdownPrivilege</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01599">SeSystemAuthenticationId</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01662">SeSystemDefaultDacl</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01690">SeSystemEnvironmentPrivilege</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01682">SeSystemtimePrivilege</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01602">SeSystemTokenSource</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01677">SeTakeOwnershipPrivilege</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01675">SeTcbPrivilege</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01693">SeUndockPrivilege</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01609">SeWorldSid</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d5/ttime_8c-source.html#l00046">TimeFields</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/seinit_8c-source.html#l00078">SepInitializationPhase0()</a>, and <a class="el" href="../../d2/d5/tse_8c-source.html#l00105">TestMakeSystemToken()</a>.
<p>
<pre class="fragment"><div>00540                    :
00541 
00542     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> provided <span class="keywordflow">for</span> use by executive components
00543     DURING SYSTEM INITIALIZATION ONLY.  It creates a token <span class="keywordflow">for</span>
00544     use by system components.
00545 
00546     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> system token has <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following characteristics:
00547 
00548          - It has LOCAL_SYSTEM as its user <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>
00549 
00550          - It has <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following groups with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> corresponding
00551            attributes:
00552 
00553                ADMINS_ALIAS      EnabledByDefault |
00554                                  Enabled          |
00555                                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>
00556 
00557                WORLD             EnabledByDefault |
00558                                  Enabled          |
00559                                  Mandatory
00560 
00561                ADMINISTRATORS (alias)  Owner   (disabled)
00562 
00563                AUTHENTICATED_USER
00564                                 EnabledByDefault  |
00565                                 Enabled           |
00566                                 Mandatory
00567 
00568 
00569          - It has LOCAL_SYSTEM as its primary group.
00570 
00571          - It has the privileges shown in comments below.
00572 
00573 
00574          - It has protection that provides TOKEN_ALL_ACCESS to
00575            the LOCAL_SYSTEM ID.
00576 
00577 
00578          - It has a default ACL that grants GENERIC_ALL access
00579            to LOCAL_SYSTEM and GENERIC_EXECUTE to WORLD.
00580 
00581 
00582 Parameters:
00583 
00584     None.
00585 
00586 Return Value:
00587 
00588     Pointer to a system token.
00589 
00590 --*/
00591 
00592 {
00593     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00594 
00595     PVOID <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
00596 
00597     SID_AND_ATTRIBUTES UserId;
00598     TOKEN_PRIMARY_GROUP PrimaryGroup;
00599     PSID_AND_ATTRIBUTES GroupIds;
00600     ULONG GroupIdsLength;
00601     LUID_AND_ATTRIBUTES Privileges[30];
00602     PACL TokenAcl;
00603     PSID <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>;
00604     ULONG <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>;
00605     ULONG <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>;
00606     ULONG Length;
00607     OBJECT_ATTRIBUTES TokenObjectAttributes;
00608     PSECURITY_DESCRIPTOR TokenSecurityDescriptor;
00609     ULONG BufferLength;
00610     PVOID <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00611 
00612     ULONG_PTR GroupIdsBuffer[128 * <span class="keyword">sizeof</span>(ULONG) / <span class="keyword">sizeof</span>(ULONG_PTR)];
00613 
00614     TIME_FIELDS <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>;
00615     LARGE_INTEGER <a class="code" href="../../d6/d0/ctaccess_8c.html#a49">NoExpiration</a>;
00616 
00617     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00618 
00619 
00620     <span class="comment">//</span>
00621     <span class="comment">// Make sure only one system token gets created.</span>
00622     <span class="comment">//</span>
00623 
00624 <span class="preprocessor">#if DBG</span>
00625 <span class="preprocessor"></span>    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( !SystemTokenCreated );
00626     SystemTokenCreated = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00627 <span class="preprocessor">#endif //DBG</span>
00628 <span class="preprocessor"></span>
00629 
00630     <span class="comment">//</span>
00631     <span class="comment">// Set up expiration times</span>
00632     <span class="comment">//</span>
00633 
00634     <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>.Year = 3000;
00635     <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>.Month = 1;
00636     <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>.Day = 1;
00637     <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>.Hour = 1;
00638     <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>.Minute = 1;
00639     <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>.Second = 1;
00640     <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>.Milliseconds = 1;
00641     <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>.Weekday = 1;
00642 
00643     <a class="code" href="../../d1/d2/time_8c.html#a28">RtlTimeFieldsToTime</a>( &amp;TimeFields, &amp;NoExpiration );
00644 
00645 
00646 <span class="comment">//    //</span>
00647 <span class="comment">//    //  The amount of memory used in the following is gross overkill, but</span>
00648 <span class="comment">//    //  it is freed up immediately after creating the token.</span>
00649 <span class="comment">//    //</span>
00650 <span class="comment">//</span>
00651 <span class="comment">//    GroupIds = (PSID_AND_ATTRIBUTES)ExAllocatePool( NonPagedPool, 512 );</span>
00652 
00653     GroupIds = (PSID_AND_ATTRIBUTES)GroupIdsBuffer;
00654 
00655 
00656     <span class="comment">//</span>
00657     <span class="comment">// Set up the attributes to be assigned to groups</span>
00658     <span class="comment">//</span>
00659 
00660     <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a> =    (SE_GROUP_MANDATORY          |
00661                                 SE_GROUP_ENABLED_BY_DEFAULT |
00662                                 SE_GROUP_ENABLED
00663                                 );
00664 
00665     <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>  =    (SE_GROUP_ENABLED_BY_DEFAULT |
00666                                 SE_GROUP_ENABLED            |
00667                                 SE_GROUP_OWNER
00668                                 );
00669 
00670     <span class="comment">//</span>
00671     <span class="comment">// Set up the user ID</span>
00672     <span class="comment">//</span>
00673 
00674     UserId.Sid = <a class="code" href="../../d0/d5/se_8h.html#a54">SeLocalSystemSid</a>;
00675     UserId.Attributes = 0;
00676 
00677     <span class="comment">//</span>
00678     <span class="comment">// Set up the groups</span>
00679     <span class="comment">//</span>
00680 
00681 
00682     GroupIds-&gt;Sid  = <a class="code" href="../../d0/d5/se_8h.html#a56">SeAliasAdminsSid</a>;
00683     (GroupIds+1)-&gt;Sid  = <a class="code" href="../../d0/d5/se_8h.html#a42">SeWorldSid</a>;
00684     (GroupIds+2)-&gt;Sid  = <a class="code" href="../../d0/d5/se_8h.html#a55">SeAuthenticatedUsersSid</a>;
00685 
00686     GroupIds-&gt;Attributes  = <a class="code" href="../../d6/d0/ctaccess_8c.html#a45">OwnerGroupAttributes</a>;
00687     (GroupIds+1)-&gt;Attributes  = <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>;
00688     (GroupIds+2)-&gt;Attributes  = <a class="code" href="../../d6/d0/ctaccess_8c.html#a44">NormalGroupAttributes</a>;
00689 
00690     GroupIdsLength = (ULONG)LongAlignSize(<a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(GroupIds-&gt;Sid)) +
00691                      (ULONG)LongAlignSize(<a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>((GroupIds+1)-&gt;Sid)) +
00692                      (ULONG)LongAlignSize(<a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>((GroupIds+2)-&gt;Sid)) +
00693                      <span class="keyword">sizeof</span>(SID_AND_ATTRIBUTES);
00694 
00695     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( GroupIdsLength &lt;= 128 * <span class="keyword">sizeof</span>(ULONG) );
00696 
00697 
00698     <span class="comment">//</span>
00699     <span class="comment">// Privileges</span>
00700     <span class="comment">//</span>
00701 
00702     <span class="comment">//</span>
00703     <span class="comment">// The privileges in the system token are as follows:</span>
00704     <span class="comment">//</span>
00705     <span class="comment">//    Privilege Name                           Attributes</span>
00706     <span class="comment">//    --------------                           ----------</span>
00707     <span class="comment">//</span>
00708     <span class="comment">// SeTcbPrivilege                        enabled/enabled by default</span>
00709     <span class="comment">// SeCreateTokenPrivilege                DISabled/NOT enabled by default</span>
00710     <span class="comment">// SeTakeOwnershipPrivilege              DISabled/NOT enabled by default</span>
00711     <span class="comment">// SeCreatePagefilePrivilege             enabled/enabled by default</span>
00712     <span class="comment">// SeLockMemoryPrivilege                 enabled/enabled by default</span>
00713     <span class="comment">// SeAssignPrimaryTokenPrivilege         DISabled/NOT enabled by default</span>
00714     <span class="comment">// SeIncreaseQuotaPrivilege              DISabled/NOT enabled by default</span>
00715     <span class="comment">// SeIncreaseBasePriorityPrivilege       enabled/enabled by default</span>
00716     <span class="comment">// SeCreatePermanentPrivilege            enabled/enabled by default</span>
00717     <span class="comment">// SeDebugPrivilege                      enabled/enabled by default</span>
00718     <span class="comment">// SeAuditPrivilege                      enabled/enabled by default</span>
00719     <span class="comment">// SeSecurityPrivilege                   DISabled/NOT enabled by default</span>
00720     <span class="comment">// SeSystemEnvironmentPrivilege          DISabled/NOT enabled by default</span>
00721     <span class="comment">// SeChangeNotifyPrivilege               enabled/enabled by default</span>
00722     <span class="comment">// SeBackupPrivilege                     DISabled/NOT enabled by default</span>
00723     <span class="comment">// SeRestorePrivilege                    DISabled/NOT enabled by default</span>
00724     <span class="comment">// SeShutdownPrivilege                   DISabled/NOT enabled by default</span>
00725     <span class="comment">// SeLoadDriverPrivilege                 DISabled/NOT enabled by default</span>
00726     <span class="comment">// SeProfileSingleProcessPrivilege       enabled/enabled by default</span>
00727     <span class="comment">// SeSystemtimePrivilege                 DISabled/NOT enabled by default</span>
00728     <span class="comment">// SeUndockPrivilege                     DISabled/NOT enabled by default</span>
00729     <span class="comment">//</span>
00730     <span class="comment">// The following privileges are not present, and should never be present in</span>
00731     <span class="comment">// the local system token:</span>
00732     <span class="comment">//</span>
00733     <span class="comment">// SeRemoteShutdownPrivilege             no one can come in as local system</span>
00734     <span class="comment">// SeSyncAgentPrivilege                  only users specified by the admin can</span>
00735     <span class="comment">//                                       be sync agents</span>
00736     <span class="comment">// SeEnableDelegationPrivilege           only users specified by the admin can</span>
00737     <span class="comment">//                                       enable delegation on accounts.</span>
00738     <span class="comment">//</span>
00739 
00740     Privileges[0].Luid = <a class="code" href="../../d0/d5/se_8h.html#a84">SeTcbPrivilege</a>;
00741     Privileges[0].Attributes =
00742         (SE_PRIVILEGE_ENABLED_BY_DEFAULT |    <span class="comment">// Enabled by default</span>
00743          SE_PRIVILEGE_ENABLED);               <span class="comment">// Enabled</span>
00744 
00745     Privileges[1].Luid = <a class="code" href="../../d0/d5/se_8h.html#a79">SeCreateTokenPrivilege</a>;
00746     Privileges[1].Attributes = 0;     <span class="comment">// Only the LSA should enable this.</span>
00747 
00748     Privileges[2].Luid = <a class="code" href="../../d0/d5/se_8h.html#a86">SeTakeOwnershipPrivilege</a>;
00749     Privileges[2].Attributes = 0;
00750 
00751     Privileges[3].Luid = <a class="code" href="../../d0/d5/se_8h.html#a88">SeCreatePagefilePrivilege</a>;
00752     Privileges[3].Attributes =
00753         (SE_PRIVILEGE_ENABLED_BY_DEFAULT |    <span class="comment">// Enabled by default</span>
00754          SE_PRIVILEGE_ENABLED);               <span class="comment">// Enabled</span>
00755 
00756     Privileges[4].Luid = <a class="code" href="../../d0/d5/se_8h.html#a81">SeLockMemoryPrivilege</a>;
00757     Privileges[4].Attributes =
00758         (SE_PRIVILEGE_ENABLED_BY_DEFAULT |    <span class="comment">// Enabled by default</span>
00759          SE_PRIVILEGE_ENABLED);               <span class="comment">// Enabled</span>
00760 
00761     Privileges[5].Luid = <a class="code" href="../../d0/d5/se_8h.html#a80">SeAssignPrimaryTokenPrivilege</a>;
00762     Privileges[5].Attributes = 0;    <span class="comment">// disabled, not enabled by default</span>
00763 
00764     Privileges[6].Luid = <a class="code" href="../../d0/d5/se_8h.html#a82">SeIncreaseQuotaPrivilege</a>;
00765     Privileges[6].Attributes = 0;    <span class="comment">// disabled, not enabled by default</span>
00766 
00767     Privileges[7].Luid = <a class="code" href="../../d0/d5/se_8h.html#a89">SeIncreaseBasePriorityPrivilege</a>;
00768     Privileges[7].Attributes =
00769         (SE_PRIVILEGE_ENABLED_BY_DEFAULT |    <span class="comment">// Enabled by default</span>
00770          SE_PRIVILEGE_ENABLED);               <span class="comment">// Enabled</span>
00771 
00772     Privileges[8].Luid = <a class="code" href="../../d0/d5/se_8h.html#a93">SeCreatePermanentPrivilege</a>;
00773     Privileges[8].Attributes =
00774         (SE_PRIVILEGE_ENABLED_BY_DEFAULT |    <span class="comment">// Enabled by default</span>
00775          SE_PRIVILEGE_ENABLED);               <span class="comment">// Enabled</span>
00776 
00777     Privileges[9].Luid = <a class="code" href="../../d0/d5/se_8h.html#a97">SeDebugPrivilege</a>;
00778     Privileges[9].Attributes =
00779         (SE_PRIVILEGE_ENABLED_BY_DEFAULT |   <span class="comment">// Enabled by default</span>
00780          SE_PRIVILEGE_ENABLED);               <span class="comment">// Enabled</span>
00781 
00782     Privileges[10].Luid = <a class="code" href="../../d0/d5/se_8h.html#a98">SeAuditPrivilege</a>;
00783     Privileges[10].Attributes =
00784         (SE_PRIVILEGE_ENABLED_BY_DEFAULT |    <span class="comment">// Enabled by default</span>
00785          SE_PRIVILEGE_ENABLED);               <span class="comment">// Enabled</span>
00786 
00787     Privileges[11].Luid = <a class="code" href="../../d0/d5/se_8h.html#a85">SeSecurityPrivilege</a>;
00788     Privileges[11].Attributes = 0;    <span class="comment">// disabled, not enabled by default</span>
00789 
00790     Privileges[12].Luid = <a class="code" href="../../d0/d5/se_8h.html#a99">SeSystemEnvironmentPrivilege</a>;
00791     Privileges[12].Attributes = 0;    <span class="comment">// disabled, not enabled by default</span>
00792 
00793     Privileges[13].Luid = <a class="code" href="../../d0/d5/se_8h.html#a100">SeChangeNotifyPrivilege</a>;
00794     Privileges[13].Attributes =
00795         (SE_PRIVILEGE_ENABLED_BY_DEFAULT |    <span class="comment">// Enabled by default</span>
00796          SE_PRIVILEGE_ENABLED);               <span class="comment">// Enabled</span>
00797 
00798 
00799     Privileges[14].Luid = <a class="code" href="../../d0/d5/se_8h.html#a94">SeBackupPrivilege</a>;
00800     Privileges[14].Attributes = 0;    <span class="comment">// disabled, not enabled by default</span>
00801 
00802     Privileges[15].Luid = <a class="code" href="../../d0/d5/se_8h.html#a95">SeRestorePrivilege</a>;
00803     Privileges[15].Attributes = 0;    <span class="comment">// disabled, not enabled by default</span>
00804 
00805     Privileges[16].Luid = <a class="code" href="../../d0/d5/se_8h.html#a96">SeShutdownPrivilege</a>;
00806     Privileges[16].Attributes = 0;    <span class="comment">// disabled, not enabled by default</span>
00807 
00808     Privileges[17].Luid = <a class="code" href="../../d0/d5/se_8h.html#a87">SeLoadDriverPrivilege</a>;
00809     Privileges[17].Attributes = 0;    <span class="comment">// disabled, not enabled by default</span>
00810 
00811     Privileges[18].Luid = <a class="code" href="../../d0/d5/se_8h.html#a92">SeProfileSingleProcessPrivilege</a>;
00812     Privileges[18].Attributes =
00813         (SE_PRIVILEGE_ENABLED_BY_DEFAULT |    <span class="comment">// Enabled by default</span>
00814          SE_PRIVILEGE_ENABLED);               <span class="comment">// Enabled</span>
00815 
00816     Privileges[19].Luid = <a class="code" href="../../d0/d5/se_8h.html#a91">SeSystemtimePrivilege</a>;
00817     Privileges[19].Attributes = 0;    <span class="comment">// disabled, not enabled by default</span>
00818 
00819     Privileges[20].Luid = <a class="code" href="../../d0/d5/se_8h.html#a102">SeUndockPrivilege</a> ;
00820     Privileges[20].Attributes = 0 ;   <span class="comment">// disabled, not enabled by default</span>
00821 
00822     <span class="comment">//BEFORE ADDING ANOTHER PRIVILEGE ^^ HERE ^^ CHECK THE ARRAY BOUND</span>
00823     <span class="comment">//ALSO INCREMENT THE PRIVILEGE COUNT IN THE SepCreateToken() call</span>
00824 
00825 
00826     <span class="comment">//</span>
00827     <span class="comment">// Establish the primary group and default owner</span>
00828     <span class="comment">//</span>
00829 
00830     PrimaryGroup.PrimaryGroup = <a class="code" href="../../d0/d5/se_8h.html#a54">SeLocalSystemSid</a>;  <span class="comment">// Primary group</span>
00831     <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a> = <a class="code" href="../../d0/d5/se_8h.html#a56">SeAliasAdminsSid</a>;                      <span class="comment">// Default owner</span>
00832 
00833 
00834 
00835 
00836 
00837     <span class="comment">//</span>
00838     <span class="comment">// Set up an ACL to protect token as well ...</span>
00839     <span class="comment">// give system full reign of terror.  This includes user-mode components</span>
00840     <span class="comment">// running as part of the system.</span>
00841     <span class="comment">//</span>
00842 
00843     Length = (ULONG)<span class="keyword">sizeof</span>(ACL) +
00844              ((ULONG)<span class="keyword">sizeof</span>(ACCESS_ALLOWED_ACE) - <span class="keyword">sizeof</span>(ULONG)) +
00845              <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( SeLocalSystemSid ) ;
00846 
00847     TokenAcl = (PACL)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(PagedPool, Length, 'cAeS');
00848 
00849     <span class="keywordflow">if</span> ( TokenAcl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00850 
00851         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
00852     }
00853 
00854     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a6">RtlCreateAcl</a>( TokenAcl, Length, ACL_REVISION2);
00855     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) );
00856 
00857     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a16">RtlAddAccessAllowedAce</a> (
00858                  TokenAcl,
00859                  ACL_REVISION2,
00860                  TOKEN_ALL_ACCESS,
00861                  SeLocalSystemSid
00862                  );
00863     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) );
00864 
00865     TokenSecurityDescriptor =
00866     (PSECURITY_DESCRIPTOR)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
00867                               PagedPool,
00868                               <span class="keyword">sizeof</span>(SECURITY_DESCRIPTOR),
00869                               'dSeS'
00870                               );
00871 
00872     <span class="keywordflow">if</span> ( TokenSecurityDescriptor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00873 
00874         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( TokenAcl );
00875 
00876         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
00877     }
00878 
00879     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a53">RtlCreateSecurityDescriptor</a>(
00880                  TokenSecurityDescriptor,
00881                  SECURITY_DESCRIPTOR_REVISION
00882                  );
00883     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) );
00884 
00885     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a60">RtlSetDaclSecurityDescriptor</a> (
00886                  TokenSecurityDescriptor,
00887                  TRUE,
00888                  TokenAcl,
00889                  FALSE
00890                  );
00891     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) );
00892 
00893 
00894     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a64">RtlSetOwnerSecurityDescriptor</a> (
00895                  TokenSecurityDescriptor,
00896                  SeAliasAdminsSid,
00897                  FALSE <span class="comment">// Owner defaulted</span>
00898                  );
00899     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) );
00900 
00901     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a66">RtlSetGroupSecurityDescriptor</a> (
00902                  TokenSecurityDescriptor,
00903                  SeAliasAdminsSid,
00904                  FALSE <span class="comment">// Group defaulted</span>
00905                  );
00906     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) );
00907 
00908 
00909     <span class="comment">//</span>
00910     <span class="comment">// Create the system token</span>
00911     <span class="comment">//</span>
00912 
00913 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
00914 <span class="preprocessor"></span>
00915 <span class="comment">//</span>
00916 <span class="comment">// Debug</span>
00917     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n Creating system token...\n"</span>);
00918 <span class="comment">// Debug</span>
00919 <span class="comment">//</span>
00921 <span class="comment"></span><span class="preprocessor">#endif //TOKEN_DEBUG</span>
00922 <span class="preprocessor"></span>
00923     InitializeObjectAttributes(
00924         &amp;TokenObjectAttributes,
00925         NULL,
00926         0,
00927         NULL,
00928         TokenSecurityDescriptor
00929         );
00930 
00931 
00932 
00933     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(SeSystemDefaultDacl != NULL);
00934     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d3/token_8c.html#a17">SepCreateToken</a>(
00935                  (PHANDLE)&amp;Token,
00936                  KernelMode,
00937                  0,               <span class="comment">// No handle created for system token</span>
00938                  &amp;TokenObjectAttributes,
00939                  TokenPrimary,
00940                  (SECURITY_IMPERSONATION_LEVEL)0,
00941                  &amp;SeSystemAuthenticationId,
00942                  &amp;NoExpiration,
00943                  &amp;UserId,
00944                  3,                         <span class="comment">// GroupCount</span>
00945                  GroupIds,
00946                  GroupIdsLength,
00947                  21,                        <span class="comment">// privileges</span>
00948                  Privileges,
00949                  <span class="keyword">sizeof</span>(Privileges),
00950                  Owner,
00951                  PrimaryGroup.PrimaryGroup,
00952                  SeSystemDefaultDacl,
00953                  &amp;SeSystemTokenSource,
00954                  TRUE,                        <span class="comment">// System token</span>
00955                  NULL,
00956                  NULL
00957                  );
00958 
00959      <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
00960 
00961     <span class="comment">//</span>
00962     <span class="comment">// Assign the security descriptor here, since we don't do it</span>
00963     <span class="comment">// in SepCreateToken for the System Token.</span>
00964     <span class="comment">//</span>
00965 
00966     BufferLength = Length +
00967                    <span class="keyword">sizeof</span>(SECURITY_DESCRIPTOR_RELATIVE) +
00968                    2 * <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(SeAliasAdminsSid);
00969 
00970     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> =  (PSECURITY_DESCRIPTOR)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( PagedPool,
00971                                                            BufferLength,
00972                                                            'dSeS'
00973                                                            );
00974 
00975     <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> ) {
00976 
00977         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> =  <a class="code" href="../../d7/d1/rtlassig_8c.html#a4">RtlAbsoluteToSelfRelativeSD</a>( TokenSecurityDescriptor,
00978                                                Buffer,
00979                                                &amp;BufferLength
00980                                                );
00981         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
00982 
00983         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> =  <a class="code" href="../../d9/d1/obse_8c.html#a7">ObAssignObjectSecurityDescriptor</a>( Token,
00984                                                     Buffer,
00985                                                     PagedPool
00986                                                     );
00987         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
00988 
00989     } <span class="keywordflow">else</span> {
00990 
00991         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00992 
00993         <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
00994 
00995     }
00996 
00997     <span class="comment">//</span>
00998     <span class="comment">// We can free the old one now.</span>
00999     <span class="comment">//</span>
01000 
01001     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( TokenAcl );
01002     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( TokenSecurityDescriptor );
01003 
01004     <span class="keywordflow">return</span>  (PACCESS_TOKEN)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
01005 
01006 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="token.c::SepCreateToken" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS SepCreateToken           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>TokenHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>RequestorMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN POBJECT_ATTRIBUTES <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a1">ObjectAttributes</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN TOKEN_TYPE&nbsp;</td>
          <td class="mdname" nowrap> <em>TokenType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SECURITY_IMPERSONATION_LEVEL ImpersonationLevel&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLUID&nbsp;</td>
          <td class="mdname" nowrap> <em>AuthenticationId</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>ExpirationTime</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID_AND_ATTRIBUTES&nbsp;</td>
          <td class="mdname" nowrap> <em>User</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>GroupCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID_AND_ATTRIBUTES&nbsp;</td>
          <td class="mdname" nowrap> <em>Groups</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>GroupsLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>PrivilegeCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLUID_AND_ATTRIBUTES&nbsp;</td>
          <td class="mdname" nowrap> <em>Privileges</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>PrivilegesLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID <a class="el" href="../../d2/d1/cttoken_8c.html#a53">Owner</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>PrimaryGroup</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PACL DefaultDacl&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PTOKEN_SOURCE&nbsp;</td>
          <td class="mdname" nowrap> <em>TokenSource</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemToken</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_TOKEN_PROXY_DATA ProxyData&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_TOKEN_AUDIT_DATA AuditData&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d2/token_8c-source.html#l02213">2213</a> of file <a class="el" href="../../d5/d2/token_8c-source.html">token.c</a>.
<p>
References <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00126">ALIGN_UP</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l03024">ExAllocateLocallyUniqueId</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00168">_OBJECT_TYPE_INITIALIZER::GenericMapping</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d9/obcreate_8c-source.html#l00055">ObCreateObject()</a>, <a class="el" href="../../d7/d9/obcreate_8c-source.html#l00713">ObDeleteCapturedInsertInfo()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d2/d0/obinsert_8c-source.html#l00029">ObInsertObject()</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00159">Owner</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00038">PTOKEN</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01380">RtlCopySid()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01436">RtlCopySidAndAttributesArray()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01824">RtlEqualLuid()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00871">RtlEqualSid()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01030">RtlLengthRequiredSid()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01630">SeAliasAdminsSid</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01691">SeChangeNotifyPrivilege</a>, <a class="el" href="../../d3/d4/seastate_8c-source.html#l00180">SeCreateAccessState()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01670">SeCreateTokenPrivilege</a>, <a class="el" href="../../d3/d4/seastate_8c-source.html#l00348">SeDeleteAccessState()</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00479">SepArrayGroupAttributes</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l00681">SepCopyProxyData()</a>, <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l00384">SepDeReferenceLogonSession()</a>, <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l00278">SepReferenceLogonSession()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01212">SepTokenObjectType</a>, <a class="el" href="../../d9/d3/privileg_8c-source.html#l00436">SeSinglePrivilegeCheck()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00124">TOKEN_DEFAULT_DYNAMIC_CHARGE</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00075">TOKEN_HAS_ADMIN_GROUP</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00072">TOKEN_HAS_TRAVERSE_PRIVILEGE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00196">_OBJECT_TYPE::TypeInfo</a>, and <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>.
<p>
Referenced by <a class="el" href="../../d5/d2/token_8c-source.html#l01690">NtCreateToken()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l01010">SeMakeAnonymousLogonToken()</a>, and <a class="el" href="../../d5/d2/token_8c-source.html#l00536">SeMakeSystemToken()</a>.
<p>
<pre class="fragment"><div>02240                    :
02241 
02242     <a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a> a token object and <span class="keywordflow">return</span> a handle opened <span class="keywordflow">for</span> access to
02243     that token.  This API implements <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bulk of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> work needed
02244     <span class="keywordflow">for</span> <a class="code" href="../../d4/d3/token_8c.html#a15">NtCreateToken</a>.
02245 
02246     All parameters except DesiredAccess and <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a> are assumed
02247     to have been probed and captured.
02248 
02249     The output parameter (TokenHandle) is expected to be returned to a
02250     safe address, rather than to a user mode address that may cause an
02251     exception.
02252 
02253     !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
02254     NOTE: This routine is also used to create the initial system token.
02255           In that case, the SystemToken parameter is TRUE and no handle
02256           is established to the token.  Instead, a pointer to the token
02257           is returned via the TokenHandle parameter.
02258     !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
02259 
02260 
02261 Arguments:
02262 
02263     TokenHandle - Receives the handle of the newly created token.  If the
02264         SystemToken parameter is specified is true, then this parameter
02265         receives a pointer to the token instead of a handle to the token.
02266 
02267     RequestorMode - The mode of the caller on whose behalf the token
02268         is being created.
02269 
02270     DesiredAccess - Is an access mask indicating which access types
02271         the handle is to provide to the new object.
02272 
02273     ObjectAttributes - Points to the standard object attributes data
02274         structure.  Refer to the NT Object Management
02275         Specification for a description of this data structure.
02276 
02277     TokenType - Type of token to be created.  Privilege is required
02278         to create any type of token.
02279 
02280     ImpersonationLevel - If the token type is TokenImpersonation, then
02281         this parameter is used to specify the impersonation level of
02282         the token.
02283 
02284     AuthenticationId - Points to a LUID (or LUID) providing a unique
02285         identifier associated with the authentication.  This is used
02286         within security only, for audit purposes.
02287 
02288     ExpirationTime - Time at which the token becomes invalid.  If this
02289         value is specified as zero, then the token has no expiration
02290         time.
02291 
02292     User - Is the user SID to place in the token.
02293 
02294     GroupCount - Indicates the number of groups in the 'Groups' parameter.
02295         This value may be zero, in which case the 'Groups' parameter is
02296         ignored.
02297 
02298     Groups - Are the group SIDs, and their corresponding attributes,
02299         to place in the token.
02300 
02301     GroupsLength - Indicates the length, in bytes, of the array of groups
02302         to place in the token.
02303 
02304     PrivilegeCount - Indicates the number of privileges in the 'Privileges'
02305         parameter.  This value may be zero, in which case the 'Privileges'
02306         parameter is ignored.
02307 
02308     Privileges - Are the privilege LUIDs, and their corresponding attributes,
02309         to place in the token.
02310 
02311     PrivilegesLength - Indicates the length, in bytes, of the array of
02312         privileges to place in the token.
02313 
02314     Owner - (Optionally) identifies an identifier that is to be used
02315         as the default owner for the token.  If not provided, the
02316         user ID is made the default owner.
02317 
02318     PrimaryGroup - Identifies which of the group IDs is to be the
02319         primary group of the token.
02320 
02321     DefaultDacl - (optionally) establishes an ACL to be used as the
02322         default discretionary access protection for the token.
02323 
02324     TokenSource - Identifies the token source name string and
02325         identifier to be assigned to the token.
02326 
02327 Return Value:
02328 
02329     STATUS_SUCCESS - Indicates the operation was successful.
02330 
02331     STATUS_INVALID_OWNER - Indicates the ID provided to be assigned
02332         as the default owner of the token does not have an attribute
02333         indicating it may be assigned as an owner.
02334 
02335     STATUS_INVALID_PRIMARY_GROUP - Indicates the group ID provided
02336         via the PrimaryGroup parameter was not among those assigned
02337         to the token in the Groups parameter.
02338 
02339     STATUS_INVALID_PARAMETER - Indicates that a required parameter,
02340         such as User or PrimaryGroup, was not provided with a legitimate
02341         value.
02342 
02343 --*/
02344 
02345 {
02346 
02347     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
02348     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02349 
02350     ULONG PagedPoolSize;
02351 
02352     ULONG PrimaryGroupLength;
02353 
02354     ULONG TokenBodyLength;
02355     ULONG VariableLength;
02356 
02357     ULONG DefaultOwnerIndex;
02358     PUCHAR Where ;
02359     ULONG ComputedPrivLength ;
02360 
02361     <span class="comment">//ULONG_PTR NextFree;</span>
02362     PSID NextSidFree;
02363 
02364     ULONG DynamicLength = <a class="code" href="../../d8/d3/tokenp_8h.html#a3">TOKEN_DEFAULT_DYNAMIC_CHARGE</a>;
02365     ULONG DynamicLengthUsed;
02366 
02367     ULONG SubAuthorityCount;
02368     ULONG GroupIndex;
02369     ULONG PrivilegeIndex;
02370     BOOLEAN OwnerFound;
02371 
02372     UCHAR TokenFlags = 0;
02373 
02374     <a class="code" href="../../d2/d5/struct__ACCESS__STATE.html">ACCESS_STATE</a> AccessState;
02375     <a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html">AUX_ACCESS_DATA</a> AuxData;
02376     LUID NewModifiedId;
02377 
02378     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02379 
02380     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <span class="keyword">sizeof</span>(SECURITY_IMPERSONATION_LEVEL) &lt;= <span class="keyword">sizeof</span>(ULONG) );
02381 
02382     <span class="comment">//</span>
02383     <span class="comment">// Make sure the Enabled and Enabled-by-default bits are set on every</span>
02384     <span class="comment">// mandatory group.</span>
02385     <span class="comment">//</span>
02386     <span class="comment">// Also, check to see if the local administrators alias is present.</span>
02387     <span class="comment">// if so, turn on the flag so that we can do restrictions later</span>
02388     <span class="comment">//</span>
02389 
02390     <span class="keywordflow">for</span> (GroupIndex=0; GroupIndex &lt; GroupCount; GroupIndex++) {
02391         <span class="keywordflow">if</span> (Groups[GroupIndex].Attributes &amp; SE_GROUP_MANDATORY) {
02392             Groups[GroupIndex].Attributes |= (SE_GROUP_ENABLED | SE_GROUP_ENABLED_BY_DEFAULT);
02393         }
02394         <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>( SeAliasAdminsSid, Groups[GroupIndex].Sid ) )
02395         {
02396             TokenFlags |= <a class="code" href="../../d0/d5/se_8h.html#a4">TOKEN_HAS_ADMIN_GROUP</a> ;
02397         }
02398     }
02399 
02400     <span class="comment">//</span>
02401     <span class="comment">// Check to see if the token being created is going to be granted</span>
02402     <span class="comment">// SeChangeNotifyPrivilege.  If so, set a flag in the TokenFlags field</span>
02403     <span class="comment">// so we can find this out quickly.</span>
02404     <span class="comment">//</span>
02405 
02406     <span class="keywordflow">for</span> (PrivilegeIndex = 0; PrivilegeIndex &lt; PrivilegeCount; PrivilegeIndex++) {
02407 
02408         <span class="keywordflow">if</span> (((<a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>(&amp;Privileges[PrivilegeIndex].Luid,&amp;SeChangeNotifyPrivilege))
02409                 &amp;&amp;
02410             (Privileges[PrivilegeIndex].Attributes &amp; SE_PRIVILEGE_ENABLED))) {
02411 
02412             TokenFlags |= <a class="code" href="../../d0/d5/se_8h.html#a1">TOKEN_HAS_TRAVERSE_PRIVILEGE</a>;
02413             <span class="keywordflow">break</span>;
02414         }
02415     }
02416 
02417 
02418     <span class="comment">//</span>
02419     <span class="comment">// Get a ModifiedId to use</span>
02420     <span class="comment">//</span>
02421 
02422     <a class="code" href="../../d5/d8/ex_8h.html#a79">ExAllocateLocallyUniqueId</a>( &amp;NewModifiedId );
02423 
02424     <span class="comment">//</span>
02425     <span class="comment">// Validate the owner ID, if provided and establish the default</span>
02426     <span class="comment">// owner index.</span>
02427     <span class="comment">//</span>
02428 
02429     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT(Owner)) {
02430 
02431         DefaultOwnerIndex = 0;
02432 
02433     } <span class="keywordflow">else</span> {
02434 
02435 
02436         <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>( Owner, User-&gt;Sid )  ) {
02437 
02438             DefaultOwnerIndex = 0;
02439 
02440         } <span class="keywordflow">else</span> {
02441 
02442             GroupIndex = 0;
02443             OwnerFound = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02444 
02445             <span class="keywordflow">while</span> ((GroupIndex &lt; GroupCount) &amp;&amp; (!OwnerFound)) {
02446 
02447                 <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>( Owner, (Groups[GroupIndex].Sid) )  ) {
02448 
02449                     <span class="comment">//</span>
02450                     <span class="comment">// Found a match - make sure it is assignable as owner.</span>
02451                     <span class="comment">//</span>
02452 
02453                     <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d3/tokenp_8h.html#a12">SepArrayGroupAttributes</a>( Groups, GroupIndex ) &amp;
02454                          SE_GROUP_OWNER ) {
02455 
02456                         DefaultOwnerIndex = GroupIndex + 1;
02457                         OwnerFound = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02458 
02459                     } <span class="keywordflow">else</span> {
02460 
02461                         <span class="keywordflow">return</span> STATUS_INVALID_OWNER;
02462 
02463                     } <span class="comment">// endif Owner attribute set</span>
02464 
02465                 } <span class="comment">// endif owner = group</span>
02466 
02467                 GroupIndex += 1;
02468 
02469             }  <span class="comment">// endwhile</span>
02470 
02471             <span class="keywordflow">if</span> (!OwnerFound) {
02472 
02473                 <span class="keywordflow">return</span> STATUS_INVALID_OWNER;
02474 
02475             } <span class="comment">// endif !OwnerFound</span>
02476         } <span class="comment">// endif owner = user</span>
02477     } <span class="comment">// endif owner specified</span>
02478 
02479 
02480 
02481     <span class="comment">//</span>
02482     <span class="comment">// Increment the reference count for this logon session</span>
02483     <span class="comment">// (fail if there is no corresponding logon session.)</span>
02484     <span class="comment">//</span>
02485 
02486     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/sep_8h.html#a40">SepReferenceLogonSession</a>( AuthenticationId );
02487     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
02488         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02489     }
02490 
02491 
02492 
02493 
02494     <span class="comment">//</span>
02495     <span class="comment">//  Calculate the length needed for the variable portion of the token</span>
02496     <span class="comment">//  This includes the User ID, Group IDs, and Privileges</span>
02497     <span class="comment">//</span>
02498     <span class="comment">//</span>
02499     <span class="comment">// Align the privilege chunk by pointer alignment so that the SIDs will</span>
02500     <span class="comment">// be correctly aligned.  Align the Groups Length so that the SID_AND_ATTR</span>
02501     <span class="comment">// array (which is</span>
02502     <span class="comment">//</span>
02503 
02504     ComputedPrivLength = PrivilegeCount * <span class="keyword">sizeof</span>( LUID_AND_ATTRIBUTES ) ;
02505 
02506     ComputedPrivLength = <a class="code" href="../../d0/d9/ntosdef_8h.html#a4">ALIGN_UP</a>( ComputedPrivLength, PVOID );
02507 
02508     GroupsLength = <a class="code" href="../../d0/d9/ntosdef_8h.html#a4">ALIGN_UP</a>( GroupsLength, PVOID );
02509 
02510 
02511     VariableLength  = GroupsLength + ComputedPrivLength +
02512                        <a class="code" href="../../d0/d9/ntosdef_8h.html#a4">ALIGN_UP</a>( (GroupCount * <span class="keyword">sizeof</span>( SID_AND_ATTRIBUTES )), PVOID ) ;
02513 
02514     SubAuthorityCount = ((SID *)(User-&gt;Sid))-&gt;SubAuthorityCount;
02515     VariableLength += <span class="keyword">sizeof</span>(SID_AND_ATTRIBUTES) +
02516                       (ULONG)LongAlignSize(<a class="code" href="../../d8/d6/sertl_8c.html#a38">RtlLengthRequiredSid</a>( SubAuthorityCount ));
02517 
02518 
02519 
02520     <span class="comment">//</span>
02521     <span class="comment">//  Calculate the length needed for the dynamic portion of the token</span>
02522     <span class="comment">//  This includes the default Dacl and the primary group.</span>
02523     <span class="comment">//</span>
02524 
02525     SubAuthorityCount = ((SID *)PrimaryGroup)-&gt;SubAuthorityCount;
02526     DynamicLengthUsed = (ULONG)LongAlignSize(<a class="code" href="../../d8/d6/sertl_8c.html#a38">RtlLengthRequiredSid</a>( SubAuthorityCount ));
02527 
02528     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(DefaultDacl)) {
02529         DynamicLengthUsed += (ULONG)LongAlignSize(DefaultDacl-&gt;AclSize);
02530     }
02531 
02532     <span class="keywordflow">if</span> (DynamicLengthUsed &gt; DynamicLength) {
02533         DynamicLength = DynamicLengthUsed;
02534     }
02535 
02536     <span class="comment">//</span>
02537     <span class="comment">// Now create the token body</span>
02538     <span class="comment">//</span>
02539 
02540     TokenBodyLength = <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d1/struct__TOKEN.html">TOKEN</a>) + VariableLength;
02541     PagedPoolSize = TokenBodyLength + DynamicLength;
02542 
02543 
02544     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d0/obcreate_8c.html#a5">ObCreateObject</a>(
02545                  RequestorMode,      <span class="comment">// ProbeMode</span>
02546                  SepTokenObjectType, <span class="comment">// ObjectType</span>
02547                  ObjectAttributes,   <span class="comment">// ObjectAttributes</span>
02548                  UserMode,           <span class="comment">// OwnershipMode</span>
02549                  NULL,               <span class="comment">// ParseContext</span>
02550                  TokenBodyLength,    <span class="comment">// ObjectBodySize</span>
02551                  PagedPoolSize,      <span class="comment">// PagedPoolCharge</span>
02552                  0,                  <span class="comment">// NonPagedPoolCharge</span>
02553                  (PVOID *)&amp;Token     <span class="comment">// Return pointer to object</span>
02554                  );
02555 
02556     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02557         <a class="code" href="../../d6/d6/sep_8h.html#a41">SepDeReferenceLogonSession</a>( AuthenticationId );
02558         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02559     }
02560 
02561     <span class="comment">//</span>
02562     <span class="comment">// After this point, we rely on token deletion to clean up the referenced</span>
02563     <span class="comment">// logon session if the creation fails.</span>
02564     <span class="comment">//</span>
02565 
02566 
02567     <span class="comment">//</span>
02568     <span class="comment">// Main Body initialization</span>
02569     <span class="comment">//</span>
02570 
02571 
02572     <a class="code" href="../../d5/d8/ex_8h.html#a79">ExAllocateLocallyUniqueId</a>( &amp;(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;TokenId) );
02573     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;ParentTokenId = RtlConvertLongToLuid(0);
02574     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;AuthenticationId = (*AuthenticationId);
02575     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;TokenInUse = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02576     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;ModifiedId = NewModifiedId;
02577     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;ExpirationTime = (*ExpirationTime);
02578     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;TokenType = TokenType;
02579     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;ImpersonationLevel = ImpersonationLevel;
02580     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;TokenSource = (*TokenSource);
02581 
02582     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;TokenFlags = TokenFlags;
02583     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;SessionId = 0;
02584 
02585     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicCharged  = DynamicLength;
02586     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicAvailable = DynamicLength - DynamicLengthUsed;
02587 
02588     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultOwnerIndex = DefaultOwnerIndex;
02589     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultDacl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02590 
02591     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;VariableLength = VariableLength;
02592 
02593     <span class="comment">// Ensure SepTokenDeleteMethod knows the buffers aren't allocated yet.</span>
02594     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;ProxyData = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02595     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;AuditData = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02596     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicPart = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02597 
02598     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ProxyData )) {
02599 
02600         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/sep_8h.html#a73">SepCopyProxyData</a>(
02601                     &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;ProxyData,
02602                     ProxyData
02603                     );
02604 
02605         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02606             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
02607             <span class="keywordflow">return</span>( STATUS_NO_MEMORY );
02608         }
02609 
02610     } <span class="keywordflow">else</span> {
02611 
02612         <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;ProxyData = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02613     }
02614 
02615     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( AuditData )) {
02616 
02617         <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;AuditData = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( PagedPool, <span class="keyword">sizeof</span>( SECURITY_TOKEN_AUDIT_DATA ));
02618 
02619         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;AuditData == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02620             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
02621             <span class="keywordflow">return</span>( STATUS_NO_MEMORY );
02622         }
02623 
02624         *(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;AuditData) = *AuditData;
02625 
02626     } <span class="keywordflow">else</span> {
02627 
02628         <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;AuditData = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02629     }
02630 
02631 
02632     <span class="comment">//</span>
02633     <span class="comment">//  Variable part initialization</span>
02634     <span class="comment">//  Data is in the following order:</span>
02635     <span class="comment">//</span>
02636     <span class="comment">//               Privileges array</span>
02637     <span class="comment">//               User (SID_AND_ATTRIBUTES)</span>
02638     <span class="comment">//               Groups (SID_AND_ATTRIBUTES)</span>
02639     <span class="comment">//               Restricted Sids (SID_AND_ATTRIBUTES)</span>
02640     <span class="comment">//               SIDs</span>
02641     <span class="comment">//</span>
02642 
02643     Where = (PUCHAR) &amp; <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;VariablePart ;
02644 
02645     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;Privileges = (PLUID_AND_ATTRIBUTES) Where ;
02646     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrivilegeCount = PrivilegeCount ;
02647 
02648     RtlCopyMemory(
02649         Where,
02650         Privileges,
02651         PrivilegeCount * <span class="keyword">sizeof</span>(LUID_AND_ATTRIBUTES) );
02652 
02653     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( ComputedPrivLength &gt;= PrivilegeCount * <span class="keyword">sizeof</span>( LUID_AND_ATTRIBUTES ) );
02654 
02655     Where += ComputedPrivLength ;
02656     VariableLength -= ComputedPrivLength ;
02657 
02658     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (((ULONG_PTR) Where ) &amp; (<span class="keyword">sizeof</span>(PVOID) - 1)) == 0 );
02659 
02660     <span class="comment">//</span>
02661     <span class="comment">// Now, copy the sid and attributes arrays.</span>
02662     <span class="comment">//</span>
02663 
02664     NextSidFree = (PSID) (Where + (<span class="keyword">sizeof</span>( SID_AND_ATTRIBUTES ) *
02665                                    (GroupCount + 1) ) );
02666 
02667     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroups = (PSID_AND_ATTRIBUTES) Where ;
02668     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroupCount = GroupCount + 1 ;
02669 
02670 
02671     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(VariableLength &gt;= ((GroupCount + 1) * (ULONG)<span class="keyword">sizeof</span>(SID_AND_ATTRIBUTES)));
02672 
02673     VariableLength -= ((GroupCount + 1) * (ULONG)<span class="keyword">sizeof</span>(SID_AND_ATTRIBUTES));
02674     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a47">RtlCopySidAndAttributesArray</a>(
02675                  1,
02676                  User,
02677                  VariableLength,
02678                  (PSID_AND_ATTRIBUTES)Where,
02679                  NextSidFree,
02680                  &amp;NextSidFree,
02681                  &amp;VariableLength
02682                  );
02683 
02684     Where += <span class="keyword">sizeof</span>( SID_AND_ATTRIBUTES );
02685 
02686     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (((ULONG_PTR) Where ) &amp; (<span class="keyword">sizeof</span>(PVOID) - 1)) == 0 );
02687 
02688     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a47">RtlCopySidAndAttributesArray</a>(
02689                  GroupCount,
02690                  Groups,
02691                  VariableLength,
02692                  (PSID_AND_ATTRIBUTES)Where,
02693                  NextSidFree,
02694                  &amp;NextSidFree,
02695                  &amp;VariableLength
02696                  );
02697 
02698 
02699     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
02700 
02701 
02702     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;RestrictedSids = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02703     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;RestrictedSidCount = 0;
02704 
02705 
02706     <span class="comment">//</span>
02707     <span class="comment">//  Dynamic part initialization</span>
02708     <span class="comment">//  Data is in the following order:</span>
02709     <span class="comment">//</span>
02710     <span class="comment">//                  PrimaryGroup (SID)</span>
02711     <span class="comment">//                  Default Discreationary Acl (ACL)</span>
02712     <span class="comment">//</span>
02713 
02714     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicPart = (PULONG)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( PagedPool, DynamicLength, 'dTeS' );
02715 
02716     <span class="comment">//</span>
02717     <span class="comment">// The attempt to allocate the DynamicPart of the token may have</span>
02718     <span class="comment">// failed.  Dereference the created object and exit with an error.</span>
02719     <span class="comment">//</span>
02720 
02721     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicPart == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02722         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
02723         <span class="keywordflow">return</span>( STATUS_NO_MEMORY );
02724     }
02725 
02726 
02727     Where = (PUCHAR) <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicPart;
02728 
02729     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrimaryGroup = (PSID) Where;
02730     PrimaryGroupLength = <a class="code" href="../../d8/d6/sertl_8c.html#a38">RtlLengthRequiredSid</a>( ((SID *)PrimaryGroup)-&gt;SubAuthorityCount );
02731     <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>( PrimaryGroupLength, (PSID)Where, PrimaryGroup );
02732     Where += (ULONG)LongAlignSize(PrimaryGroupLength);
02733 
02734     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(DefaultDacl)) {
02735         <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultDacl = (PACL)Where;
02736 
02737         RtlCopyMemory( (PVOID)Where,
02738                       (PVOID)DefaultDacl,
02739                       DefaultDacl-&gt;AclSize
02740                       );
02741     }
02742 
02743 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
02744 <span class="preprocessor"></span>
02745 <span class="comment">//</span>
02746 <span class="comment">// Debug</span>
02747     SepDumpToken( Token );
02748 <span class="comment">// Debug</span>
02749 <span class="comment">//</span>
02751 <span class="comment"></span><span class="preprocessor">#endif //TOKEN_DEBUG</span>
02752 <span class="preprocessor"></span>
02753 
02754     <span class="comment">//</span>
02755     <span class="comment">//  Insert the token unless it is a system token.</span>
02756     <span class="comment">//</span>
02757 
02758     <span class="keywordflow">if</span> (!SystemToken) {
02759 
02760         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/seastate_8c.html#a2">SeCreateAccessState</a>(
02761                      &amp;AccessState,
02762                      &amp;AuxData,
02763                      DesiredAccess,
02764                      &amp;<a class="code" href="../../d0/d5/se_8h.html#a36">SepTokenObjectType</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a>
02765                      );
02766 
02767         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
02768             BOOLEAN PrivilegeHeld;
02769 
02770             PrivilegeHeld = <a class="code" href="../../d8/d4/privileg_8c.html#a3">SeSinglePrivilegeCheck</a>(
02771                             SeCreateTokenPrivilege,
02772                             KeGetPreviousMode()
02773                             );
02774 
02775             <span class="keywordflow">if</span> (PrivilegeHeld) {
02776 
02777                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d1/obinsert_8c.html#a0">ObInsertObject</a>( Token,
02778                                          &amp;AccessState,
02779                                          0,
02780                                          0,
02781                                          (PVOID *)NULL,
02782                                          TokenHandle
02783                                          );
02784 
02785             } <span class="keywordflow">else</span> {
02786 
02787                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_PRIVILEGE_NOT_HELD;
02788                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
02789             }
02790 
02791             <a class="code" href="../../d2/d5/seastate_8c.html#a3">SeDeleteAccessState</a>( &amp;AccessState );
02792 
02793         } <span class="keywordflow">else</span> {
02794 
02795             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
02796         }
02797     } <span class="keywordflow">else</span> {
02798 
02799         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) );
02800         <a class="code" href="../../d6/d0/obcreate_8c.html#a10">ObDeleteCapturedInsertInfo</a>(Token);
02801         <span class="comment">//</span>
02802         <span class="comment">// Return pointer instead of handle.</span>
02803         <span class="comment">//</span>
02804 
02805         (*TokenHandle) = (HANDLE)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
02806     }
02807 
02808     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02809 
02810 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="token.c::SepIdAssignableAsOwner" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN SepIdAssignableAsOwner           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Token</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Index</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d2/token_8c-source.html#l02813">2813</a> of file <a class="el" href="../../d5/d2/token_8c-source.html">token.c</a>.
<p>
References <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00489">SepTokenGroupAttributes</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d1/d3/tokenset_8c-source.html#l00037">NtSetInformationToken()</a>, and <a class="el" href="../../d1/d7/subject_8c-source.html#l00381">SepValidOwnerSubjectContext()</a>.
<p>
<pre class="fragment"><div>02821                    :
02822 
02823     This routine returns a <span class="keywordtype">boolean</span> value indicating whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user
02824     or group <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a> in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified token with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified index <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
02825     assignable as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> owner of an object.
02826 
02827     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> index <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> 0, which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> always <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> USER <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
02828     assignable as owner.  Otherwise, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> that of a group, and
02829     <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> must have <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="stringliteral">"Owner"</span> attribute set to be assignable.
02830 
02831 
02832 
02833 Arguments:
02834 
02835     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> - Pointer to a locked <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> to use.
02836 
02837     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> - <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>'s UserAndGroupsArray.  This value
02838         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assumed to be valid.
02839 
02840 Return Value:
02841 
02842     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>  - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> index corresponds to an <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a> that may be assigned
02843             as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> owner of objects.
02844 
02845     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> index does not correspond to an <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a> that may be
02846             assigned as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> owner of objects.
02847 
02848 --*/
02849 {
02850     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02851 
02852     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> == 0) {
02853 
02854         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02855 
02856     } <span class="keywordflow">else</span> {
02857 
02858         <span class="keywordflow">return</span> (BOOLEAN)
02859                    ( (<a class="code" href="../../d8/d3/tokenp_8h.html#a13">SepTokenGroupAttributes</a>(Token,Index) &amp; SE_GROUP_OWNER)
02860                      != 0
02861                    );
02862     }
02863 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="token.c::SepTokenDeleteMethod" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SepTokenDeleteMethod           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Token</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d2/token_8c-source.html#l02156">2156</a> of file <a class="el" href="../../d5/d2/token_8c-source.html">token.c</a>.
<p>
References <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l00384">SepDeReferenceLogonSession()</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l00737">SepFreeProxyData()</a>, and <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>.
<p>
Referenced by <a class="el" href="../../d5/d2/token_8c-source.html#l01460">SepTokenInitialization()</a>.
<p>
<pre class="fragment"><div>02162                    :
02163 
02164     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>-specific <span class="keyword">delete</span> method.
02165     It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> needed to ensure that all memory allocated <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token
02166     gets deallocated.
02167 
02168 Arguments:
02169 
02170     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> - Points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token object being deleted.
02171 
02172 Return Value:
02173 
02174     None.
02175 
02176 --*/
02177 
02178 {
02179     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02180 
02181     <span class="comment">//</span>
02182     <span class="comment">// De-reference the logon session referenced by this token object</span>
02183     <span class="comment">//</span>
02184 
02185     <a class="code" href="../../d6/d6/sep_8h.html#a41">SepDeReferenceLogonSession</a>( &amp;(((<a class="code" href="../../d8/d1/struct__TOKEN.html">TOKEN</a> *)Token)-&gt;AuthenticationId) );
02186 
02187 
02188     <span class="comment">//</span>
02189     <span class="comment">// If the token has an associated Dynamic part, deallocate it.</span>
02190     <span class="comment">//</span>
02191 
02192     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ((<a class="code" href="../../d8/d1/struct__TOKEN.html">TOKEN</a> *)Token)-&gt;DynamicPart)) {
02193         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( ((<a class="code" href="../../d8/d1/struct__TOKEN.html">TOKEN</a> *)Token)-&gt;DynamicPart );
02194     }
02195 
02196     <span class="comment">//</span>
02197     <span class="comment">// Free the Proxy and Global audit structures if present.</span>
02198     <span class="comment">//</span>
02199 
02200     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(((<a class="code" href="../../d8/d1/struct__TOKEN.html">TOKEN</a> *) Token)-&gt;ProxyData)) {
02201         <a class="code" href="../../d6/d6/sep_8h.html#a74">SepFreeProxyData</a>( ((<a class="code" href="../../d8/d1/struct__TOKEN.html">TOKEN</a> *)Token)-&gt;ProxyData );
02202     }
02203 
02204     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(((<a class="code" href="../../d8/d1/struct__TOKEN.html">TOKEN</a> *)Token)-&gt;AuditData )) {
02205         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( (((<a class="code" href="../../d8/d1/struct__TOKEN.html">TOKEN</a> *)Token)-&gt;AuditData) );
02206     }
02207 
02208 
02209     <span class="keywordflow">return</span>;
02210 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="token.c::SepTokenInitialization" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN SepTokenInitialization           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d2/token_8c-source.html#l01460">1460</a> of file <a class="el" href="../../d5/d2/token_8c-source.html">token.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l02473">ExInitializeResource</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d1/obtype_8c-source.html#l00069">ObCreateObjectType()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l02156">SepTokenDeleteMethod()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l00093">SepTokenLock</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l00067">SepTokenMapping</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01212">SepTokenObjectType</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/seinit_8c-source.html#l00078">SepInitializationPhase0()</a>.
<p>
<pre class="fragment"><div>01464                    :
01465 
01466     This function creates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> descriptor at system
01467     initialization and stores <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> descriptor
01468     in global storage.  It also created token related global variables.
01469 
01470     Furthermore, some number of pseudo tokens are created during system
01471     initialization.  These tokens are tracked down and replaced with
01472     real tokens.
01473 
01474 Arguments:
01475 
01476     None.
01477 
01478 Return Value:
01479 
01480     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> descriptor <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
01481     successfully initialized. Otherwise a value of <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
01482 
01483 --*/
01484 
01485 {
01486 
01487     <a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html">OBJECT_TYPE_INITIALIZER</a> ObjectTypeInitializer;
01488     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01489     UNICODE_STRING TypeName;
01490 
01491     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01492 
01493     <span class="comment">//</span>
01494     <span class="comment">// Initialize string descriptor.</span>
01495     <span class="comment">//</span>
01496 
01497     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;TypeName, L<span class="stringliteral">"Token"</span>);
01498 
01499 
01500     <span class="comment">//</span>
01501     <span class="comment">// Create the global token lock</span>
01502     <span class="comment">//</span>
01503 
01504     <a class="code" href="../../d5/d8/ex_8h.html#a68">ExInitializeResource</a>(&amp;SepTokenLock);
01505 
01506 
01507 <span class="preprocessor">#if 0</span>
01508 <span class="preprocessor"></span>BUG, BUG   Need to get system <span class="keywordflow">default</span> ACL to protect token object
01509 <span class="preprocessor">#endif</span>
01510 <span class="preprocessor"></span>
01511     <span class="comment">//</span>
01512     <span class="comment">// Create object type descriptor.</span>
01513     <span class="comment">//</span>
01514 
01515     RtlZeroMemory(&amp;ObjectTypeInitializer,<span class="keyword">sizeof</span>(ObjectTypeInitializer));
01516     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o0">Length</a> = <span class="keyword">sizeof</span>(ObjectTypeInitializer);
01517     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o3">InvalidAttributes</a> = OBJ_OPENLINK;
01518     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a> = <a class="code" href="../../d4/d3/token_8c.html#a0">SepTokenMapping</a>;
01519     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o6">SecurityRequired</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01520     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o1">UseDefaultObject</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01521     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o9">PoolType</a> = <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>;
01522     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o5">ValidAccessMask</a> = TOKEN_ALL_ACCESS;
01523     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o15">DeleteProcedure</a> = <a class="code" href="../../d4/d3/token_8c.html#a16">SepTokenDeleteMethod</a>;
01524 
01525     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d2/obtype_8c.html#a2">ObCreateObjectType</a>(&amp;TypeName,
01526                                 &amp;ObjectTypeInitializer,
01527                                 (PSECURITY_DESCRIPTOR)NULL,   <span class="comment">// BUG, BUG assign real protection</span>
01528                                 &amp;SepTokenObjectType
01529                                 );
01530 
01531 
01532 <span class="preprocessor">#if 0</span>
01533 <span class="preprocessor"></span>BUG, BUG   Now track down all pseudo tokens used during system initialization
01534 BUG, BUG   and replace them with real ones.
01535 #endif
01536 
01537     <span class="comment">//</span>
01538     <span class="comment">// If the object type descriptor was successfully created, then</span>
01539     <span class="comment">// return a value of TRUE. Otherwise return a value of FALSE.</span>
01540     <span class="comment">//</span>
01541 
01542     <span class="keywordflow">return</span> (BOOLEAN)<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status);
01543 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="token.c::SeSubProcessToken" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS SeSubProcessToken           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ParentProcess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PACCESS_TOKEN *&nbsp;</td>
          <td class="mdname" nowrap> <em>ChildToken</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d2/token_8c-source.html#l01327">1327</a> of file <a class="el" href="../../d5/d2/token_8c-source.html">token.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d0/obinsert_8c-source.html#l00029">ObInsertObject()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00130">PrimaryTokenAttributes</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00810">PsDereferencePrimaryToken</a>, <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l00028">PsReferencePrimaryToken()</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00038">PTOKEN</a>, <a class="el" href="../../d7/d2/tokendup_8c-source.html#l00362">SepDuplicateToken()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l01117">PspInitializeProcessSecurity()</a>.
<p>
<pre class="fragment"><div>01334                    :
01335 
01336     This routine makes a token <span class="keywordflow">for</span> a sub-process that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a duplicate
01337     of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parent process's token.
01338 
01339 
01340 
01341 Parameters:
01342 
01343     ParentProcess - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parent process object.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used
01344         to locate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parent process's primary token, and <span class="keywordflow">for</span> logging
01345         purposes.
01346 
01347     ChildToken - Receives a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> child process's token.
01348 
01349 Return Value:
01350 
01351     STATUS_SUCCESS - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> sub-process's token has been created
01352         successfully.
01353 
01354     Other status values may be returned from memory allocation or object
01355     creation services used and typically indicate insufficient resources
01356     or quota on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requestor's part.
01357 
01358 
01359 
01360 --*/
01361 
01362 {
01363 
01364     <span class="comment">//</span>
01365     <span class="comment">//  NOTE:  THIS ROUTINE CAN BE MADE MUCH MORE EFFICIENT.</span>
01366     <span class="comment">//         IT IS DONE IN A BRUTE FORCE FASHION FOR THE LARGE_INTEGER</span>
01367     <span class="comment">//         BEING TO GET THINGS UP AND RUNNING.</span>
01368     <span class="comment">//</span>
01369     <span class="comment">//         THE PERFORMANCE OF THIS ROUTINE DIRECTLY IMPACTS</span>
01370     <span class="comment">//         THE PERFORMANCE OF SUB-PROCESS CREATION.</span>
01371     <span class="comment">//</span>
01372 
01373 
01374     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
01375     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> ParentToken;
01376     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> NewToken;
01377     HANDLE NewTokenHandle;
01378     OBJECT_ATTRIBUTES <a class="code" href="../../d6/d0/ctaccess_8c.html#a33">PrimaryTokenAttributes</a>;
01379 
01380     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> InsertedToken;
01381 
01382     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01383     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> IgnoreStatus;
01384 
01385     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01386 
01387     PreviousMode = KeGetPreviousMode();
01388 
01389     InitializeObjectAttributes(
01390         &amp;PrimaryTokenAttributes,
01391         NULL,
01392         0,
01393         NULL,
01394         NULL
01395         );
01396 
01397 <span class="preprocessor">#ifdef TOKEN_DEBUG</span>
01398 <span class="preprocessor"></span>    <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\nCreating sub-process token...\n"</span>);
01399     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Parent token address = 0x%lx\n"</span>, ParentProcess-&gt;Token);
01400 <span class="preprocessor">#endif //TOKEN_DEBUG</span>
01401 <span class="preprocessor"></span>
01402     ParentToken = (<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)<a class="code" href="../../d6/d5/ps_2security_8c.html#a0">PsReferencePrimaryToken</a>( ParentProcess );
01403 
01404     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d3/tokenp_8h.html#a27">SepDuplicateToken</a>(
01405                 ParentToken,                         <span class="comment">// ExistingToken</span>
01406                 &amp;PrimaryTokenAttributes,             <span class="comment">// ObjectAttributes</span>
01407                 FALSE,                               <span class="comment">// EffectiveOnly</span>
01408                 TokenPrimary,                        <span class="comment">// TokenType</span>
01409                 (SECURITY_IMPERSONATION_LEVEL)0,     <span class="comment">// ImpersonationLevel</span>
01410                 KernelMode,                          <span class="comment">// RequestorMode</span>
01411                 &amp;NewToken                            <span class="comment">// NewToken</span>
01412                 );
01413 
01414     <a class="code" href="../../d1/d9/ps_8h.html#a24">PsDereferencePrimaryToken</a>( (PACCESS_TOKEN)ParentToken );
01415 
01416     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01417 
01418         <span class="comment">//</span>
01419         <span class="comment">// Insert the new token object, up its ref count, and then</span>
01420         <span class="comment">// delete the new handle.</span>
01421         <span class="comment">//</span>
01422 
01423         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d1/obinsert_8c.html#a0">ObInsertObject</a>(
01424                      NewToken,
01425                      NULL,
01426                      0,
01427                      1,             <span class="comment">// ObjectPointerBias</span>
01428                      (PVOID *)&amp;InsertedToken,
01429                      &amp;NewTokenHandle
01430                      );
01431 
01432         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01433 
01434             *ChildToken = InsertedToken;
01435             InsertedToken-&gt;TokenInUse = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01436             IgnoreStatus = ZwClose( NewTokenHandle );
01437 
01438             <span class="comment">//</span>
01439             <span class="comment">// At this point, either the token has a reference</span>
01440             <span class="comment">// outstanding (and no handles), or the reference</span>
01441             <span class="comment">// failed.  If the reference failed, the status will</span>
01442             <span class="comment">// be returned indicating why.</span>
01443             <span class="comment">//</span>
01444 
01445         } <span class="keywordflow">else</span> {
01446 
01447             <span class="comment">//</span>
01448             <span class="comment">// ObInsertObject dereferences the passed object if it</span>
01449             <span class="comment">// fails, so we don't have to do any cleanup on NewToken</span>
01450             <span class="comment">// here.</span>
01451             <span class="comment">//</span>
01452         }
01453     }
01454 
01455     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01456 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="token.c::SeTokenImpersonationLevel" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> SECURITY_IMPERSONATION_LEVEL SeTokenImpersonationLevel           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PACCESS_TOKEN&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Token</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d2/token_8c-source.html#l00211">211</a> of file <a class="el" href="../../d5/d2/token_8c-source.html">token.c</a>.
<p>
References <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00038">PTOKEN</a>, and <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>.
<p>
Referenced by <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l01483">PsAssignImpersonationToken()</a>.
<p>
<pre class="fragment"><div>00217                    :
00218 
00219     This function returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> impersonation level of a token.  The token
00220     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assumed to be a TokenImpersonation <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> token.
00221 
00222 
00223 Arguments:
00224 
00225     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> - Points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token whose impersonation level <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be returned.
00226 
00227 Return Value:
00228 
00229     The token's impersonation level.
00230 
00231 --*/
00232 
00233 {
00234     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00235 
00236     <span class="keywordflow">return</span> ((<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>)-&gt;ImpersonationLevel;
00237 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="token.c::SeTokenIsAdmin" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI BOOLEAN SeTokenIsAdmin           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PACCESS_TOKEN&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Token</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d2/token_8c-source.html#l00150">150</a> of file <a class="el" href="../../d5/d2/token_8c-source.html">token.c</a>.
<p>
References <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00038">PTOKEN</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>, and <a class="el" href="../../d1/d4/se_8h-source.html#l00075">TOKEN_HAS_ADMIN_GROUP</a>.
<p>
Referenced by <a class="el" href="../../d2/d0/psjob_8c-source.html#l00266">NtAssignProcessToJobObject()</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l01323">NtSetInformationJobObject()</a>, <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l01483">PsAssignImpersonationToken()</a>, and <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l00650">PsImpersonateClient()</a>.
<p>
<pre class="fragment"><div>00156                    :
00157 
00158     Returns <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a member of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> local admin group.
00159 
00160 Arguments:
00161 
00162     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> - Points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token.
00163 
00164 Return Value:
00165 
00166     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> local admin group
00167     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - no admin.
00168 
00169 --*/
00170 
00171 {
00172     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00173 
00174     <span class="keywordflow">return</span> ((((<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>)-&gt;TokenFlags &amp; <a class="code" href="../../d0/d5/se_8h.html#a4">TOKEN_HAS_ADMIN_GROUP</a>) != 0 );
00175 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="token.c::SeTokenIsRestricted" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI BOOLEAN SeTokenIsRestricted           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PACCESS_TOKEN&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Token</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d2/token_8c-source.html#l00181">181</a> of file <a class="el" href="../../d5/d2/token_8c-source.html">token.c</a>.
<p>
References <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00038">PTOKEN</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>, and <a class="el" href="../../d1/d4/se_8h-source.html#l00076">TOKEN_IS_RESTRICTED</a>.
<p>
Referenced by <a class="el" href="../../d5/d7/ex_8c-source.html#l00095">IsRestricted()</a>, <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l01483">PsAssignImpersonationToken()</a>, <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l00650">PsImpersonateClient()</a>, and <a class="el" href="../../d1/d3/accessck_8c-source.html#l01564">SepAccessCheck()</a>.
<p>
<pre class="fragment"><div>00187                    :
00188 
00189     Returns <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a restricted token.
00190 
00191 Arguments:
00192 
00193     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> - Points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token.
00194 
00195 Return Value:
00196 
00197     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> contains restricted sids
00198     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - no admin.
00199 
00200 --*/
00201 
00202 {
00203     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00204 
00205     <span class="keywordflow">return</span> ((((<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>)-&gt;TokenFlags &amp; <a class="code" href="../../d0/d5/se_8h.html#a5">TOKEN_IS_RESTRICTED</a>) != 0 );
00206 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="token.c::SeTokenType" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> TOKEN_TYPE SeTokenType           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PACCESS_TOKEN&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Token</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d2/token_8c-source.html#l00118">118</a> of file <a class="el" href="../../d5/d2/token_8c-source.html">token.c</a>.
<p>
References <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00038">PTOKEN</a>, and <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>.
<p>
Referenced by <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l01483">PsAssignImpersonationToken()</a>.
<p>
<pre class="fragment"><div>00124                    :
00125 
00126     This function returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of an instance of a token (TokenPrimary,
00127     or TokenImpersonation).
00128 
00129 
00130 Arguments:
00131 
00132     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> - Points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token whose <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be returned.
00133 
00134 Return Value:
00135 
00136     The token's <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>.
00137 
00138 --*/
00139 
00140 {
00141     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00142 
00143     <span class="keywordflow">return</span> (((<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>)-&gt;TokenType);
00144 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a2" doxytag="token.c::SepTokenLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d6/d4/struct__ERESOURCE.html">ERESOURCE</a> <a class="el" href="../../d8/d3/tokenp_8h.html#a20">SepTokenLock</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d2/token_8c-source.html#l00093">93</a> of file <a class="el" href="../../d5/d2/token_8c-source.html">token.c</a>.
<p>
Referenced by <a class="el" href="../../d5/d2/token_8c-source.html#l01460">SepTokenInitialization()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="token.c::SepTokenMapping" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> GENERIC_MAPPING <a class="el" href="../../d8/d3/tokenp_8h.html#a18">SepTokenMapping</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Initial value:</b><pre class="fragment"><div> { TOKEN_READ,
                                    TOKEN_WRITE,
                                    TOKEN_EXECUTE,
                                    TOKEN_ALL_ACCESS
                                  }
</div></pre>
<p>
Definition at line <a class="el" href="../../d5/d2/token_8c-source.html#l00067">67</a> of file <a class="el" href="../../d5/d2/token_8c-source.html">token.c</a>.
<p>
Referenced by <a class="el" href="../../d5/d2/token_8c-source.html#l01460">SepTokenInitialization()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="token.c::SepTokenObjectType" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> <a class="el" href="../../d8/d3/tokenp_8h.html#a19">SepTokenObjectType</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d2/token_8c-source.html#l00077">77</a> of file <a class="el" href="../../d5/d2/token_8c-source.html">token.c</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:47 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
