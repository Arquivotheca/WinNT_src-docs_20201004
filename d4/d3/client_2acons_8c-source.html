<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: acons.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>acons.c</h1><a href="../../d3/d4/client_2acons_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: acons.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* This module contains code for dealing with animated icons/cursors.</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 10-02-91 DarrinM      Created.</span>
00010 <span class="comment">* 07-30-92 DarrinM      Unicodized.</span>
00011 <span class="comment">* 11-28-94 JimA         Moved to client from server.</span>
00012 <span class="comment">\***************************************************************************/</span>
00013 
00014 <span class="preprocessor">#include "<a class="code" href="../../d7/d3/w32_2ntuser_2client_2precomp_8h.html">precomp.h</a>"</span>
00015 <span class="preprocessor">#pragma hdrstop</span>
00016 <span class="preprocessor"></span>
00017 <span class="comment">/*</span>
00018 <span class="comment"> * Resource Directory format for IconEditor generated icon and cursor</span>
00019 <span class="comment"> * (.ICO &amp; .CUR) files.  All fields are shared except xHotspot and yHotspot</span>
00020 <span class="comment"> * which are only valid for cursors.</span>
00021 <span class="comment"> */</span>
<a name="l00022"></a><a class="code" href="../../d0/d0/struct__ICONFILERESDIR.html">00022</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d0/d0/struct__ICONFILERESDIR.html">_ICONFILERESDIR</a> {    <span class="comment">// ird</span>
<a name="l00023"></a><a class="code" href="../../d0/d0/struct__ICONFILERESDIR.html#o0">00023</a>     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> <a class="code" href="../../d0/d0/struct__ICONFILERESDIR.html#o0">bWidth</a>;
<a name="l00024"></a><a class="code" href="../../d0/d0/struct__ICONFILERESDIR.html#o1">00024</a>     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> <a class="code" href="../../d0/d0/struct__ICONFILERESDIR.html#o1">bHeight</a>;
<a name="l00025"></a><a class="code" href="../../d0/d0/struct__ICONFILERESDIR.html#o2">00025</a>     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> <a class="code" href="../../d0/d0/struct__ICONFILERESDIR.html#o2">bColorCount</a>;
<a name="l00026"></a><a class="code" href="../../d0/d0/struct__ICONFILERESDIR.html#o3">00026</a>     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> <a class="code" href="../../d0/d0/struct__ICONFILERESDIR.html#o3">bReserved</a>;
<a name="l00027"></a><a class="code" href="../../d0/d0/struct__ICONFILERESDIR.html#o4">00027</a>     WORD <a class="code" href="../../d0/d0/struct__ICONFILERESDIR.html#o4">xHotspot</a>;
<a name="l00028"></a><a class="code" href="../../d0/d0/struct__ICONFILERESDIR.html#o5">00028</a>     WORD <a class="code" href="../../d0/d0/struct__ICONFILERESDIR.html#o5">yHotspot</a>;
<a name="l00029"></a><a class="code" href="../../d0/d0/struct__ICONFILERESDIR.html#o6">00029</a>     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d0/d0/struct__ICONFILERESDIR.html#o6">dwDIBSize</a>;
<a name="l00030"></a><a class="code" href="../../d0/d0/struct__ICONFILERESDIR.html#o7">00030</a>     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d0/d0/struct__ICONFILERESDIR.html#o7">dwDIBOffset</a>;
00031 } <a class="code" href="../../d0/d0/struct__ICONFILERESDIR.html">ICONFILERESDIR</a>;
00032 
<a name="l00033"></a><a class="code" href="../../d4/d8/struct__HOTSPOTREC.html">00033</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d4/d8/struct__HOTSPOTREC.html">_HOTSPOTREC</a> {    <span class="comment">// hs</span>
<a name="l00034"></a><a class="code" href="../../d4/d8/struct__HOTSPOTREC.html#o0">00034</a>     WORD <a class="code" href="../../d4/d8/struct__HOTSPOTREC.html#o0">xHotspot</a>;
<a name="l00035"></a><a class="code" href="../../d4/d8/struct__HOTSPOTREC.html#o1">00035</a>     WORD <a class="code" href="../../d4/d8/struct__HOTSPOTREC.html#o1">yHotspot</a>;
00036 } <a class="code" href="../../d4/d8/struct__HOTSPOTREC.html">HOTSPOTREC</a>;
00037 
00038 <a class="code" href="../../d0/d2/structtagCURSORRESOURCE.html">PCURSORRESOURCE</a> <a class="code" href="../../d3/d4/client_2acons_8c.html#a15">ReadIconGuts</a>(
00039     IN  <a class="code" href="../../d1/d2/struct__FILEINFO.html">PFILEINFO</a>   pfi,
00040     IN  LPNEWHEADER pnhBase,
00041     IN  <span class="keywordtype">int</span>         offResBase,
00042     OUT LPWSTR     *prt,
00043     IN  <span class="keywordtype">int</span>         cxDesired,
00044     IN  <span class="keywordtype">int</span>         cyDesired,
00045     IN  DWORD       LR_flags);
00046 
00047 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d4/client_2acons_8c.html#a3">ReadTag</a>(
00048     IN  <a class="code" href="../../d1/d2/struct__FILEINFO.html">PFILEINFO</a> pfi,
00049     OUT PRTAG     ptag);
00050 
00051 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d4/client_2acons_8c.html#a4">ReadChunk</a>(
00052     IN  <a class="code" href="../../d1/d2/struct__FILEINFO.html">PFILEINFO</a> pfi,
00053     IN      PRTAG ptag,
00054     OUT     PVOID pv);
00055 
00056 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d4/client_2acons_8c.html#a5">SkipChunk</a>(
00057     IN <a class="code" href="../../d1/d2/struct__FILEINFO.html">PFILEINFO</a> pfi,
00058     IN PRTAG     ptag);
00059 
00060 HICON <a class="code" href="../../d3/d4/client_2acons_8c.html#a6">CreateAniIcon</a>(
00061     LPCWSTR pszName,
00062     LPWSTR rt,
00063     <span class="keywordtype">int</span> cicur,
00064     DWORD *aicur,
00065     <span class="keywordtype">int</span> cpcur,
00066     HCURSOR *ahcur,
00067     JIF jifRate,
00068     PJIF ajifRate,
00069     BOOL fPublic);
00070 
00071 HCURSOR <a class="code" href="../../d3/d4/client_2acons_8c.html#a16">ReadIconFromFileMap</a>(
00072     IN <a class="code" href="../../d1/d2/struct__FILEINFO.html">PFILEINFO</a>   pfi,
00073     IN <span class="keywordtype">int</span>         cbSize,
00074     IN DWORD       cxDesired,
00075     IN DWORD       cyDesired,
00076     IN DWORD       LR_flags);
00077 
00078 HICON <a class="code" href="../../d3/d4/client_2acons_8c.html#a8">LoadAniIcon</a>(
00079     IN <a class="code" href="../../d1/d2/struct__FILEINFO.html">PFILEINFO</a> pfi,
00080     IN LPWSTR    rt,
00081     IN DWORD     cxDesired,
00082     IN DWORD     cyDesired,
00083     IN DWORD     LR_flags);
00084 
00085 
00086 
00087 <span class="comment">/***************************************************************************\</span>
00088 <span class="comment">* LoadCursorFromFile (API)</span>
00089 <span class="comment">*</span>
00090 <span class="comment">* Called by SetSystemCursor.</span>
00091 <span class="comment">*</span>
00092 <span class="comment">* History:</span>
00093 <span class="comment">* 08-03-92 DarrinM      Created.</span>
00094 <span class="comment">\***************************************************************************/</span>
00095 
<a name="l00096"></a><a class="code" href="../../d3/d4/client_2acons_8c.html#a9">00096</a> HCURSOR WINAPI <a class="code" href="../../d3/d4/client_2acons_8c.html#a9">LoadCursorFromFileW</a>(
00097     LPCWSTR pszFilename)
00098 {
00099     <span class="keywordflow">return</span>(LoadImage(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00100                      pszFilename,
00101                      IMAGE_CURSOR,
00102                      0,
00103                      0,
00104                      LR_DEFAULTSIZE | LR_LOADFROMFILE));
00105 }
00106 
00107 
00108 
00109 <span class="comment">/***********************************************************************\</span>
00110 <span class="comment">* LoadCursorFromFileA</span>
00111 <span class="comment">*</span>
00112 <span class="comment">* Returns: hCursor</span>
00113 <span class="comment">*</span>
00114 <span class="comment">* 10/9/1995 Created SanfordS</span>
00115 <span class="comment">\***********************************************************************/</span>
00116 
<a name="l00117"></a><a class="code" href="../../d3/d4/client_2acons_8c.html#a10">00117</a> HCURSOR WINAPI <a class="code" href="../../d3/d4/client_2acons_8c.html#a10">LoadCursorFromFileA</a>(
00118     LPCSTR pszFilename)
00119 {
00120     LPWSTR lpUniName;
00121     HCURSOR hcur;
00122 
00123     <span class="keywordflow">if</span> (pszFilename == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
00124             !MBToWCS(pszFilename, -1, &amp;lpUniName, -1, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>))
00125         <span class="keywordflow">return</span> (HANDLE)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00126 
00127     hcur = <a class="code" href="../../d3/d4/client_2acons_8c.html#a9">LoadCursorFromFileW</a>(lpUniName);
00128 
00129     <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(lpUniName);
00130 
00131     <span class="keywordflow">return</span> hcur;
00132 }
00133 
00134 
00135 
00136 <span class="comment">/***********************************************************************\</span>
00137 <span class="comment">* ReadFilePtr</span>
00138 <span class="comment">*</span>
00139 <span class="comment">* Works like ReadFile but with pointers to a mapped file buffer.</span>
00140 <span class="comment">*</span>
00141 <span class="comment">* Returns:</span>
00142 <span class="comment">*</span>
00143 <span class="comment">* 11/16/1995 Created SanfordS</span>
00144 <span class="comment">\***********************************************************************/</span>
<a name="l00145"></a><a class="code" href="../../d3/d4/client_2acons_8c.html#a11">00145</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d4/client_2acons_8c.html#a11">ReadFilePtr</a>(
00146     IN  <a class="code" href="../../d1/d2/struct__FILEINFO.html">PFILEINFO</a> pfi,
00147     OUT LPVOID   *ppBuf,
00148     IN  DWORD     cb)
00149 {
00150     *ppBuf = pfi-&gt;pFilePtr;
00151     pfi-&gt;pFilePtr += cb;
00152     <span class="keywordflow">return</span> (pfi-&gt;pFilePtr &lt;= pfi-&gt;pFileEnd);
00153 }
00154 
00155 
00156 
00157 <span class="comment">/***********************************************************************\</span>
00158 <span class="comment">* ReadFilePtrUnaligned</span>
00159 <span class="comment">*</span>
00160 <span class="comment">* Works like ReadFile but with pointers to a mapped file buffer.</span>
00161 <span class="comment">*</span>
00162 <span class="comment">* Returns:</span>
00163 <span class="comment">*</span>
00164 <span class="comment">* 11/16/1995 Created SanfordS</span>
00165 <span class="comment">\***********************************************************************/</span>
<a name="l00166"></a><a class="code" href="../../d3/d4/client_2acons_8c.html#a12">00166</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d4/client_2acons_8c.html#a12">ReadFilePtrUnaligned</a>(
00167     IN  <a class="code" href="../../d1/d2/struct__FILEINFO.html">PFILEINFO</a> pfi,
00168     OUT VOID UNALIGNED **ppBuf,
00169     IN  DWORD     cb)
00170 {
00171     *ppBuf = pfi-&gt;pFilePtr;
00172     pfi-&gt;pFilePtr += cb;
00173     <span class="keywordflow">return</span> (pfi-&gt;pFilePtr &lt;= pfi-&gt;pFileEnd);
00174 }
00175 
00176 
00177 
00178 <span class="comment">/***********************************************************************\</span>
00179 <span class="comment">* ReadFilePtrCopy</span>
00180 <span class="comment">*</span>
00181 <span class="comment">* Works even more like ReadFile in that is copies data to the given buffer.</span>
00182 <span class="comment">*</span>
00183 <span class="comment">* Returns:</span>
00184 <span class="comment">*</span>
00185 <span class="comment">* 11/16/1995 Created SanfordS</span>
00186 <span class="comment">\***********************************************************************/</span>
<a name="l00187"></a><a class="code" href="../../d3/d4/client_2acons_8c.html#a13">00187</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d4/client_2acons_8c.html#a13">ReadFilePtrCopy</a>(
00188     IN     <a class="code" href="../../d1/d2/struct__FILEINFO.html">PFILEINFO</a> pfi,
00189     IN OUT LPVOID pBuf,
00190     IN     DWORD cb)
00191 {
00192     <span class="keywordflow">if</span> (pfi-&gt;pFilePtr + cb &gt; pfi-&gt;pFileEnd) {
00193         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00194     }
00195     RtlCopyMemory(pBuf, pfi-&gt;pFilePtr, cb);
00196     pfi-&gt;pFilePtr += cb;
00197     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00198 }
00199 
00200 
00201 
00202 <span class="comment">/***************************************************************************\</span>
00203 <span class="comment">* ReadTag, ReadChunk, SkipChunk</span>
00204 <span class="comment">*</span>
00205 <span class="comment">* Some handy functions for reading RIFF files.</span>
00206 <span class="comment">*</span>
00207 <span class="comment">* History:</span>
00208 <span class="comment">* 10-02-91 DarrinM      Created.</span>
00209 <span class="comment">* 03-25-93 Jonpa        Changed to use RIFF format instead of ASDF</span>
00210 <span class="comment">\***************************************************************************/</span>
<a name="l00211"></a><a class="code" href="../../d3/d4/client_2acons_8c.html#a3">00211</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d4/client_2acons_8c.html#a3">ReadTag</a>(
00212     IN  <a class="code" href="../../d1/d2/struct__FILEINFO.html">PFILEINFO</a> pfi,
00213     OUT PRTAG     ptag)
00214 {
00215     ptag-&gt;ckID = ptag-&gt;ckSize = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;  <span class="comment">// in case we fail the read.</span>
00216 
00217     <span class="keywordflow">return</span>(<a class="code" href="../../d3/d4/client_2acons_8c.html#a13">ReadFilePtrCopy</a>(pfi, ptag, <span class="keyword">sizeof</span>(RTAG)));
00218 }
00219 
00220 
00221 
<a name="l00222"></a><a class="code" href="../../d3/d4/client_2acons_8c.html#a4">00222</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d4/client_2acons_8c.html#a4">ReadChunk</a>(
00223     IN  <a class="code" href="../../d1/d2/struct__FILEINFO.html">PFILEINFO</a> pfi,
00224     IN  PRTAG     ptag,
00225     OUT PVOID     pv)
00226 {
00227     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d4/client_2acons_8c.html#a13">ReadFilePtrCopy</a>(pfi, pv, ptag-&gt;ckSize))
00228         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00229 
00230     <span class="comment">/* WORD align file pointer */</span>
00231     <span class="keywordflow">if</span>( ptag-&gt;ckSize &amp; 1 )
00232         pfi-&gt;pFilePtr++;
00233 
00234 
00235     <span class="keywordflow">if</span> (pfi-&gt;pFilePtr &lt;= pfi-&gt;pFileEnd) {
00236         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00237     } <span class="keywordflow">else</span> {
00238         RIPMSG0(RIP_WARNING, <span class="stringliteral">"ReadChunk: Advanced pointer past end of file map"</span>);
00239         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00240     }
00241 }
00242 
00243 
00244 
<a name="l00245"></a><a class="code" href="../../d3/d4/client_2acons_8c.html#a5">00245</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d4/client_2acons_8c.html#a5">SkipChunk</a>(
00246     IN <a class="code" href="../../d1/d2/struct__FILEINFO.html">PFILEINFO</a> pfi,
00247     IN PRTAG     ptag)
00248 {
00249     <span class="comment">/*</span>
00250 <span class="comment">     * Round ptag-&gt;ckSize up to nearest word boundary</span>
00251 <span class="comment">     * to maintain alignment</span>
00252 <span class="comment">     */</span>
00253     pfi-&gt;pFilePtr += (ptag-&gt;ckSize + 1) &amp; (~1);
00254     <span class="keywordflow">if</span> (pfi-&gt;pFilePtr &lt;= pfi-&gt;pFileEnd) {
00255         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00256     } <span class="keywordflow">else</span> {
00257         RIPMSG0(RIP_WARNING, <span class="stringliteral">"SkipChunk: Advanced pointer past end of file map"</span>);
00258         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00259     }
00260 }
00261 
00262 
00263 
00264 <span class="comment">/***************************************************************************\</span>
00265 <span class="comment">* LoadCursorIconFromFileMap</span>
00266 <span class="comment">*</span>
00267 <span class="comment">* If pszName is one of the IDC_* values then we use WIN.INI to find a</span>
00268 <span class="comment">* custom cursor/icon.  Otherwise, pszName points to a filename of a .ICO/.CUR</span>
00269 <span class="comment">* file to be loaded.  If the file is an .ANI file containing a multiframe</span>
00270 <span class="comment">* animation then LoadAniIcon is called to create an ACON.  Otherwise if</span>
00271 <span class="comment">* the file is an .ANI file containing just a single frame then it is loaded</span>
00272 <span class="comment">* and a normal CURSOR/ICON resource is created from it.</span>
00273 <span class="comment">*</span>
00274 <span class="comment">* 12-26-91 DarrinM      Wrote it.</span>
00275 <span class="comment">* 03-17-93 JonPa        Changed to use RIFF format for ani-cursors</span>
00276 <span class="comment">* 11/16/1995 SanfordS   Added LR_flags support</span>
00277 <span class="comment">\***************************************************************************/</span>
00278 
<a name="l00279"></a><a class="code" href="../../d6/d0/usercli_8h.html#a651">00279</a> HANDLE <a class="code" href="../../d6/d0/usercli_8h.html#a651">LoadCursorIconFromFileMap</a>(
00280     IN <a class="code" href="../../d1/d2/struct__FILEINFO.html">PFILEINFO</a>   pfi,
00281     IN OUT LPWSTR *prt,
00282     IN DWORD       cxDesired,
00283     IN DWORD       cyDesired,
00284     IN DWORD       LR_flags,
00285     OUT LPBOOL     pfAni)
00286 {
00287     LPNEWHEADER pnh;
00288     <span class="keywordtype">int</span> offResBase;
00289 
00290     *pfAni = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00291     offResBase = 0;
00292 
00293     <span class="comment">/*</span>
00294 <span class="comment">     * Determine if this is an .ICO/.CUR file or an .ANI file.</span>
00295 <span class="comment">     */</span>
00296     pnh = (LPNEWHEADER)pfi-&gt;pFileMap;
00297     <span class="keywordflow">if</span> (*(LPDWORD)pnh == FOURCC_RIFF) {
00298 
00299         RTAG tag;
00300 
00301         <span class="comment">/*</span>
00302 <span class="comment">         * It's an ANICURSOR!</span>
00303 <span class="comment">         * Seek back to beginning + 1 tag.</span>
00304 <span class="comment">         */</span>
00305         pfi-&gt;pFilePtr = pfi-&gt;pFileMap + <span class="keyword">sizeof</span>(tag);
00306 
00307         <span class="comment">/* check RIFF type for ACON */</span>
00308         <span class="keywordflow">if</span> (*(LPDWORD)pfi-&gt;pFilePtr != FOURCC_ACON) {
00309             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00310         }
00311         pfi-&gt;pFilePtr += <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>);
00312         <span class="keywordflow">if</span> (pfi-&gt;pFilePtr &gt; pfi-&gt;pFileEnd) {
00313             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00314         }
00315 
00316         <span class="comment">/*</span>
00317 <span class="comment">         * Ok, we have a ACON chunk.  Find the first ICON chunk and set</span>
00318 <span class="comment">         * things up so it looks we've just loaded the header of a normal</span>
00319 <span class="comment">         * .CUR file, then fall into the .CUR bits handling code below.</span>
00320 <span class="comment">         */</span>
00321         <span class="keywordflow">while</span> (<a class="code" href="../../d3/d4/client_2acons_8c.html#a3">ReadTag</a>(pfi, &amp;tag)) {
00322             <span class="comment">/*</span>
00323 <span class="comment">             * Handle each chunk type.</span>
00324 <span class="comment">             */</span>
00325             <span class="keywordflow">if</span> (tag.ckID == FOURCC_anih) {
00326 
00327                 ANIHEADER anih;
00328 
00329                 <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d4/client_2acons_8c.html#a4">ReadChunk</a>(pfi, &amp;tag, &amp;anih)) {
00330                     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00331                 }
00332 
00333                 <span class="keywordflow">if</span> (!(anih.fl &amp; AF_ICON) || (anih.cFrames == 0)) {
00334                     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00335                 }
00336 
00337                 <span class="comment">// If this ACON has more than one frame then go ahead</span>
00338                 <span class="comment">// and create an ACON, otherwise just use the first</span>
00339                 <span class="comment">// frame to create a normal ICON/CURSOR.</span>
00340 
00341                 <span class="keywordflow">if</span> (anih.cFrames &gt; 1) {
00342 
00343                     *pfAni = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00344                     *prt = RT_CURSOR;
00345                     <span class="keywordflow">return</span>(<a class="code" href="../../d3/d4/client_2acons_8c.html#a8">LoadAniIcon</a>(pfi,
00346                                        RT_CURSOR,
00347                                        cxDesired,
00348                                        cyDesired,
00349                                        LR_flags));
00350                 }
00351 
00352             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag.ckID == FOURCC_LIST) {
00353                 LPDWORD pdwType = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00354                 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fOK = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00355                 <span class="comment">/*</span>
00356 <span class="comment">                 * If this is the fram list, then get the first icon out of it</span>
00357 <span class="comment">                 */</span>
00358 
00359                 <span class="comment">/* check LIST type for fram */</span>
00360 
00361                 <span class="keywordflow">if</span>( tag.ckSize &gt;= <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>) &amp;&amp;
00362                         (fOK = <a class="code" href="../../d3/d4/client_2acons_8c.html#a11">ReadFilePtr</a>( pfi,
00363                                             &amp;pdwType,
00364                                             <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>))) &amp;&amp;
00365                         *pdwType == FOURCC_fram) {
00366 
00367                     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d4/client_2acons_8c.html#a3">ReadTag</a>(pfi, &amp;tag)) {
00368                         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00369                     }
00370 
00371                     <span class="keywordflow">if</span> (tag.ckID == FOURCC_icon) {
00372                         <span class="comment">/*</span>
00373 <span class="comment">                         * We've found what we're looking for.  Get current position</span>
00374 <span class="comment">                         * in file to be used as the base from which the icon data</span>
00375 <span class="comment">                         * offsets are offset from.</span>
00376 <span class="comment">                         */</span>
00377                         offResBase = (<span class="keywordtype">int</span>)(pfi-&gt;pFilePtr - pfi-&gt;pFileMap);
00378 
00379                         <span class="comment">/*</span>
00380 <span class="comment">                         * Grab the header first, since the following code assumes</span>
00381 <span class="comment">                         * it was read above.</span>
00382 <span class="comment">                         */</span>
00383                         <a class="code" href="../../d3/d4/client_2acons_8c.html#a11">ReadFilePtr</a>(pfi, &amp;pnh, <span class="keyword">sizeof</span>(NEWHEADER));
00384 
00385                         <span class="comment">/*</span>
00386 <span class="comment">                         * Break out and let the icon loading/cursor creating code</span>
00387 <span class="comment">                         * take it from here.</span>
00388 <span class="comment">                         */</span>
00389                         <span class="keywordflow">break</span>;
00390                     } <span class="keywordflow">else</span> {
00391                         <a class="code" href="../../d3/d4/client_2acons_8c.html#a5">SkipChunk</a>(pfi, &amp;tag);
00392                     }
00393                 } <span class="keywordflow">else</span> {
00394                     <span class="comment">/*</span>
00395 <span class="comment">                     * Something bad happened in the type read, if it was</span>
00396 <span class="comment">                     * a file error then close and exit, otherwise just</span>
00397 <span class="comment">                     * skip the rest of the chunk</span>
00398 <span class="comment">                     */</span>
00399                     <span class="keywordflow">if</span>(!fOK) {
00400                         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00401                     }
00402                     <span class="comment">/*</span>
00403 <span class="comment">                     * take the type we just read out of the tag size and</span>
00404 <span class="comment">                     * skip the rest</span>
00405 <span class="comment">                     */</span>
00406                     tag.ckSize -= <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>);
00407                     <a class="code" href="../../d3/d4/client_2acons_8c.html#a5">SkipChunk</a>(pfi, &amp;tag);
00408                 }
00409             } <span class="keywordflow">else</span> {
00410                 <span class="comment">/*</span>
00411 <span class="comment">                 * We're not interested in this chunk, skip it.</span>
00412 <span class="comment">                 */</span>
00413                 <a class="code" href="../../d3/d4/client_2acons_8c.html#a5">SkipChunk</a>(pfi, &amp;tag);
00414             }
00415         }
00416     } <span class="keywordflow">else</span> { <span class="comment">// not a RIFF file.</span>
00417         <span class="keywordflow">if</span> ((pnh-&gt;ResType != FT_ICON) &amp;&amp; (pnh-&gt;ResType != FT_CURSOR)) {
00418             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00419         }
00420     }
00421     {
00422         <a class="code" href="../../d0/d2/structtagCURSORRESOURCE.html">PCURSORRESOURCE</a> pcres;
00423 
00424         pcres = <a class="code" href="../../d3/d4/client_2acons_8c.html#a15">ReadIconGuts</a>(pfi,
00425                              pnh,
00426                              offResBase,
00427                              prt,
00428                              cxDesired,
00429                              cyDesired,
00430                              LR_flags);
00431 
00432         <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a660">ConvertDIBIcon</a>((LPBITMAPINFOHEADER)pcres,
00433                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00434                               pfi-&gt;pszName,
00435                               *prt == RT_ICON,
00436                               cxDesired,
00437                               cyDesired,
00438                               LR_flags);
00439     }
00440 }
00441 
00442 
00443 <span class="comment">/***********************************************************************\</span>
00444 <span class="comment">* ReadIconGuts</span>
00445 <span class="comment">*</span>
00446 <span class="comment">* Returns: a pointer to a locally allocated buffer extraced from the</span>
00447 <span class="comment">*          given file that looks like a icon/acon resource.</span>
00448 <span class="comment">*          Also returns the type of the icon (RT_ICON or RT_CURSOR)</span>
00449 <span class="comment">*</span>
00450 <span class="comment">*</span>
00451 <span class="comment">* 8/23/1995 SanfordS   Documented</span>
00452 <span class="comment">* 11/16/1995 SanfordS  Added LR_flags support</span>
00453 <span class="comment">\***********************************************************************/</span>
<a name="l00454"></a><a class="code" href="../../d3/d4/client_2acons_8c.html#a15">00454</a> <a class="code" href="../../d0/d2/structtagCURSORRESOURCE.html">PCURSORRESOURCE</a> <a class="code" href="../../d3/d4/client_2acons_8c.html#a15">ReadIconGuts</a>(
00455     IN  <a class="code" href="../../d1/d2/struct__FILEINFO.html">PFILEINFO</a>  pfi,
00456     IN  NEWHEADER *pnhBase,
00457     IN  <span class="keywordtype">int</span>        offResBase,
00458     OUT LPWSTR    *prt,
00459     IN  <span class="keywordtype">int</span>        cxDesired,
00460     IN  <span class="keywordtype">int</span>        cyDesired,
00461     IN  DWORD      LR_flags)
00462 {
00463     NEWHEADER *pnh;
00464     <span class="keywordtype">int</span> i, Id;
00465     <a class="code" href="../../d0/d0/struct__ICONFILERESDIR.html">ICONFILERESDIR</a> UNALIGNED *pird;
00466     <a class="code" href="../../d0/d2/structtagCURSORRESOURCE.html">PCURSORRESOURCE</a> pcres;
00467     RESDIR UNALIGNED *prd;
00468     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> cb;
00469     <a class="code" href="../../d4/d8/struct__HOTSPOTREC.html">HOTSPOTREC</a> UNALIGNED *phs;
00470     LPBITMAPINFOHEADER pbih;
00471 
00472     <span class="comment">/*</span>
00473 <span class="comment">     * Construct a fake array of RESDIR entries using the info at the head</span>
00474 <span class="comment">     * of the file.  Store the data offset in the idIcon WORD so it can be</span>
00475 <span class="comment">     * returned by RtlGetIdFromDirectory.</span>
00476 <span class="comment">     */</span>
00477     pnh = (NEWHEADER *)<a class="code" href="../../d6/d0/usercli_8h.html#a136">UserLocalAlloc</a>(0, <span class="keyword">sizeof</span>(NEWHEADER) +
00478             (pnhBase-&gt;ResCount * (<span class="keyword">sizeof</span>(RESDIR) + <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/struct__HOTSPOTREC.html">HOTSPOTREC</a>))));
00479     <span class="keywordflow">if</span> (pnh == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00480         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00481 
00482     *pnh = *pnhBase;
00483     prd = (RESDIR UNALIGNED *)(pnh + 1);
00484     phs = (<a class="code" href="../../d3/d4/client_2acons_8c.html#a1">HOTSPOTREC</a> UNALIGNED *)(prd + pnhBase-&gt;ResCount);
00485 
00486     <span class="keywordflow">for</span> (i = 0; i &lt; (<span class="keywordtype">int</span>)pnh-&gt;ResCount; i++, prd++) {
00487         <span class="comment">/*</span>
00488 <span class="comment">         * Read the resource directory from the icon file.</span>
00489 <span class="comment">         */</span>
00490         <a class="code" href="../../d3/d4/client_2acons_8c.html#a12">ReadFilePtrUnaligned</a>(pfi, &amp;pird, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d0/struct__ICONFILERESDIR.html">ICONFILERESDIR</a>));
00491 
00492         <span class="comment">/*</span>
00493 <span class="comment">         * Convert from the icon editor's resource directory format</span>
00494 <span class="comment">         * to the post-RC.EXE format LookupIconIdFromDirectory expects.</span>
00495 <span class="comment">         */</span>
00496         prd-&gt;Icon.Width = pird-&gt;bWidth;
00497         prd-&gt;Icon.Height = pird-&gt;bHeight;
00498         <span class="keywordflow">if</span> (pnh-&gt;ResType == FT_ICON) {     <span class="comment">// ICON</span>
00499             prd-&gt;Icon.ColorCount = pird-&gt;bColorCount;
00500             prd-&gt;Icon.reserved = 0;
00501         }
00502         prd-&gt;Planes = 0;                <span class="comment">// Hopefully nobody uses this</span>
00503         prd-&gt;BitCount = 0;              <span class="comment">//        "        "</span>
00504         prd-&gt;BytesInRes = pird-&gt;dwDIBSize;
00505         prd-&gt;idIcon = (WORD)pird-&gt;dwDIBOffset;
00506 
00507         phs-&gt;xHotspot = pird-&gt;xHotspot;
00508         phs-&gt;yHotspot = pird-&gt;yHotspot;
00509         phs++;
00510     }
00511 
00512     *prt = pnhBase-&gt;ResType == FT_ICON ? RT_ICON : RT_CURSOR;
00513     Id = <a class="code" href="../../d6/d0/usercli_8h.html#a428">RtlGetIdFromDirectory</a>((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pnh,
00514                                 *prt == RT_ICON,
00515                                 cxDesired,
00516                                 cyDesired,
00517                                 LR_flags,
00518                                 &amp;cb);
00519 
00520     <span class="comment">/*</span>
00521 <span class="comment">     * Allocate for worst case (cursor).</span>
00522 <span class="comment">     */</span>
00523     pcres = (<a class="code" href="../../d0/d2/structtagCURSORRESOURCE.html">PCURSORRESOURCE</a>)<a class="code" href="../../d6/d0/usercli_8h.html#a136">UserLocalAlloc</a>(0,
00524             cb + FIELD_OFFSET(<a class="code" href="../../d0/d2/structtagCURSORRESOURCE.html">CURSORRESOURCE</a>, bih));
00525     <span class="keywordflow">if</span> (pcres == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00526         <span class="keywordflow">goto</span> CleanExit;
00527     }
00528 
00529     <span class="keywordflow">if</span> (*prt == RT_CURSOR) {
00530         <span class="comment">/*</span>
00531 <span class="comment">         * Fill in hotspot info for cursors.</span>
00532 <span class="comment">         */</span>
00533         prd = (RESDIR UNALIGNED *)(pnh + 1);
00534         phs = (<a class="code" href="../../d3/d4/client_2acons_8c.html#a1">HOTSPOTREC</a> UNALIGNED *)(prd + pnh-&gt;ResCount);
00535 
00536         <span class="keywordflow">for</span>( i = 0; i &lt; pnh-&gt;ResCount; i++ ) {
00537             <span class="keywordflow">if</span> (prd[i].idIcon == (WORD)Id) {
00538                 pcres-&gt;<a class="code" href="../../d0/d2/structtagCURSORRESOURCE.html#o0">xHotspot</a> = phs[i].xHotspot;
00539                 pcres-&gt;<a class="code" href="../../d0/d2/structtagCURSORRESOURCE.html#o1">yHotspot</a> = phs[i].yHotspot;
00540                 <span class="keywordflow">break</span>;
00541             }
00542         }
00543 
00544         <span class="keywordflow">if</span> (i == pnh-&gt;ResCount) {
00545             pcres-&gt;<a class="code" href="../../d0/d2/structtagCURSORRESOURCE.html#o0">xHotspot</a> = pird-&gt;xHotspot;
00546             pcres-&gt;<a class="code" href="../../d0/d2/structtagCURSORRESOURCE.html#o1">yHotspot</a> = pird-&gt;yHotspot;
00547         }
00548         pbih = &amp;pcres-&gt;<a class="code" href="../../d0/d2/structtagCURSORRESOURCE.html#o2">bih</a>;
00549     } <span class="keywordflow">else</span> {
00550         pbih = (LPBITMAPINFOHEADER)pcres;
00551     }
00552 
00553     <span class="comment">/*</span>
00554 <span class="comment">     * Read in the header information into pcres.</span>
00555 <span class="comment">     */</span>
00556     pfi-&gt;pFilePtr = pfi-&gt;pFileMap + offResBase + Id;
00557     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d4/client_2acons_8c.html#a13">ReadFilePtrCopy</a>(pfi, pbih, cb)) {
00558         <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(pnh);
00559         <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(pcres);
00560         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00561     }
00562 
00563 
00564 CleanExit:
00565     <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(pnh);
00566     <span class="keywordflow">return</span> pcres;
00567 }
00568 
00569 
00570 <span class="comment">/***************************************************************************\</span>
00571 <span class="comment">* CreateAniIcon</span>
00572 <span class="comment">*</span>
00573 <span class="comment">* For now, CreateAniIcon copies the jif rate table and the sequence table</span>
00574 <span class="comment">* but not the CURSOR structs.  This is ok as long as this routine is</span>
00575 <span class="comment">* internal only.</span>
00576 <span class="comment">*</span>
00577 <span class="comment">* History:</span>
00578 <span class="comment">* 10-02-91 DarrinM      Created.</span>
00579 <span class="comment">\***************************************************************************/</span>
00580 
<a name="l00581"></a><a class="code" href="../../d3/d4/client_2acons_8c.html#a6">00581</a> HCURSOR <a class="code" href="../../d3/d4/client_2acons_8c.html#a6">CreateAniIcon</a>(
00582     LPCWSTR pszName,
00583     LPWSTR  rt,
00584     <span class="keywordtype">int</span>     cicur,
00585     DWORD   *aicur,
00586     <span class="keywordtype">int</span>     cpcur,
00587     HCURSOR *ahcur,
00588     JIF     jifRate,
00589     PJIF    ajifRate,
00590     BOOL    fPublic)
00591 {
00592     HCURSOR hacon;
00593     <a class="code" href="../../d8/d1/structtagCURSORDATA.html">CURSORDATA</a> acon;
00594     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> cbacon;
00595     HCURSOR *ahcurT;             <span class="comment">// Array of image frame pointers</span>
00596     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> *aicurT;               <span class="comment">// Array of frame indices (sequence table)</span>
00597     PJIF ajifRateT;              <span class="comment">// Array of time offsets</span>
00598     <span class="keywordtype">int</span> i;
00599 
00600     <span class="comment">/*</span>
00601 <span class="comment">     * Start by allocating space for the ACON structure and the ahcur and</span>
00602 <span class="comment">     * ajifRate arrays.</span>
00603 <span class="comment">     */</span>
00604     hacon = (HCURSOR)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a174">NtUserCallOneParam</a>(fPublic,
00605                                         SFI__CREATEEMPTYCURSOROBJECT);
00606     <span class="keywordflow">if</span> (hacon == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00607         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00608 
00609     <span class="comment">/*</span>
00610 <span class="comment">     * Save a couple LocalAlloc calls by allocating the memory needed for</span>
00611 <span class="comment">     * the CURSOR, JIF, and SEQ arrays at once.</span>
00612 <span class="comment">     */</span>
00613     RtlZeroMemory(&amp;acon, <span class="keyword">sizeof</span>(acon));
00614     cbacon = (cpcur * <span class="keyword">sizeof</span>(HCURSOR)) +
00615             (cicur * <span class="keyword">sizeof</span>(JIF)) + (cicur * <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>));
00616     ahcurT = (HCURSOR *)<a class="code" href="../../d6/d0/usercli_8h.html#a136">UserLocalAlloc</a>(HEAP_ZERO_MEMORY, cbacon);
00617     <span class="keywordflow">if</span> (ahcurT == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00618         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a156">NtUserDestroyCursor</a>((HCURSOR)hacon, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a531">CURSOR_ALWAYSDESTROY</a>);
00619         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00620     }
00621     acon.aspcur = (<a class="code" href="../../d6/d1/structtagCURSOR.html">PCURSOR</a> *)ahcurT;
00622 
00623     <span class="comment">/*</span>
00624 <span class="comment">     * Set up work pointers</span>
00625 <span class="comment">     */</span>
00626     ajifRateT = (PJIF)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)ahcurT + (cpcur * <span class="keyword">sizeof</span>(HCURSOR)));
00627     aicurT = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> *)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)ajifRateT + (cicur * <span class="keyword">sizeof</span>(JIF)));
00628 
00629     <span class="comment">/*</span>
00630 <span class="comment">     * Save offsets to arrays to make copying them to the server</span>
00631 <span class="comment">     * easier.</span>
00632 <span class="comment">     */</span>
00633     acon.ajifRate = (PJIF)(cpcur * <span class="keyword">sizeof</span>(HCURSOR));
00634     acon.aicur = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> *)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)acon.ajifRate + (cicur * <span class="keyword">sizeof</span>(JIF)));
00635 
00636     acon.cpcur = cpcur;
00637     acon.cicur = cicur;
00638 
00639     acon.CURSORF_flags = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a537">CURSORF_ACON</a>;
00640 
00641     <span class="comment">/*</span>
00642 <span class="comment">     * Store this information away so we can identify</span>
00643 <span class="comment">     * repeated calls to LoadCursor/Icon for the same</span>
00644 <span class="comment">     * resource type/id.</span>
00645 <span class="comment">     */</span>
00646     acon.rt = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a99">PTR_TO_ID</a>(rt);
00647     acon.lpModName = <a class="code" href="../../d1/d8/clglobal_8c.html#a12">szUSER32</a>;
00648     acon.lpName = (LPWSTR)pszName;
00649 
00650     <span class="comment">/*</span>
00651 <span class="comment">     * Make a private copy of the cursor pointers and the animation rate table.</span>
00652 <span class="comment">     */</span>
00653     <span class="keywordflow">for</span> (i = 0; i &lt; cpcur; i++) {
00654         ahcurT[i] = ahcur[i];
00655 <span class="comment">//        ahcurT[i]-&gt;fPointer |= PTRI_ANIMATED;   // if GDI needs it</span>
00656 
00657     }
00658 
00659     <span class="keywordflow">for</span> (i = 0; i &lt; cicur; i++) {
00660 
00661         <span class="comment">/*</span>
00662 <span class="comment">         * If constant rate, initialize the rate table to a single value.</span>
00663 <span class="comment">         */</span>
00664         <span class="keywordflow">if</span> (ajifRate == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00665             ajifRateT[i] = jifRate;
00666         <span class="keywordflow">else</span>
00667             ajifRateT[i] = ajifRate[i];
00668 
00669         <span class="comment">/*</span>
00670 <span class="comment">         * If no sequence table then build a unity map to the cursor table.</span>
00671 <span class="comment">         */</span>
00672         <span class="keywordflow">if</span> (aicur == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00673             aicurT[i] = i;
00674         <span class="keywordflow">else</span>
00675             aicurT[i] = aicur[i];
00676     }
00677 
00678     <span class="comment">/*</span>
00679 <span class="comment">     * Stuff acon data into the cursor</span>
00680 <span class="comment">     */</span>
00681     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1114">_SetCursorIconData</a>(hacon, &amp;acon)) {
00682         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a156">NtUserDestroyCursor</a>(hacon, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a531">CURSOR_ALWAYSDESTROY</a>);
00683         hacon = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00684     }
00685     <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(ahcurT);
00686 
00687     <span class="keywordflow">return</span> hacon;
00688 }
00689 
00690 
00691 <span class="comment">/***************************************************************************\</span>
00692 <span class="comment">* ReadIconFromFileMap</span>
00693 <span class="comment">*</span>
00694 <span class="comment">* LATER: Error handling.</span>
00695 <span class="comment">*</span>
00696 <span class="comment">* History:</span>
00697 <span class="comment">* 12-21-91 DarrinM      Created.</span>
00698 <span class="comment">\***************************************************************************/</span>
00699 
<a name="l00700"></a><a class="code" href="../../d3/d4/client_2acons_8c.html#a16">00700</a> HCURSOR <a class="code" href="../../d3/d4/client_2acons_8c.html#a16">ReadIconFromFileMap</a>(
00701     <a class="code" href="../../d1/d2/struct__FILEINFO.html">PFILEINFO</a>   pfi,
00702     <span class="keywordtype">int</span>         cbSize,   <span class="comment">// used to seek past this chunk in case of error</span>
00703     DWORD       cxDesired,
00704     DWORD       cyDesired,
00705     DWORD       LR_flags)
00706 {
00707     <a class="code" href="../../d0/d2/structtagCURSORRESOURCE.html">PCURSORRESOURCE</a> pcres;
00708     HCURSOR         hcur = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00709     LPNEWHEADER     pnh;
00710     <span class="keywordtype">int</span>             offResBase;
00711     LPWSTR          rt;
00712 
00713     <span class="comment">/*</span>
00714 <span class="comment">     * Get current position in file to be used as the base from which</span>
00715 <span class="comment">     * the icon data offsets are offset from.</span>
00716 <span class="comment">     */</span>
00717     offResBase = (<span class="keywordtype">int</span>)(pfi-&gt;<a class="code" href="../../d1/d2/struct__FILEINFO.html#o1">pFilePtr</a> - pfi-&gt;<a class="code" href="../../d1/d2/struct__FILEINFO.html#o0">pFileMap</a>);
00718 
00719     <span class="comment">/*</span>
00720 <span class="comment">     * Read the .ICO/.CUR data's header.</span>
00721 <span class="comment">     */</span>
00722     <a class="code" href="../../d3/d4/client_2acons_8c.html#a11">ReadFilePtr</a>(pfi, &amp;pnh, <span class="keyword">sizeof</span>(NEWHEADER));
00723 
00724     pcres = <a class="code" href="../../d3/d4/client_2acons_8c.html#a15">ReadIconGuts</a>(pfi,
00725                          pnh,
00726                          offResBase,
00727                          &amp;rt,
00728                          cxDesired,
00729                          cyDesired,
00730                          LR_flags);
00731 
00732     <span class="keywordflow">if</span> (pcres != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00733         hcur = (HCURSOR)<a class="code" href="../../d6/d0/usercli_8h.html#a660">ConvertDIBIcon</a>((LPBITMAPINFOHEADER)pcres,
00734                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00735                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00736                                        (rt == RT_ICON),
00737                                        cxDesired,
00738                                        cyDesired,
00739                                        LR_ACONFRAME | LR_flags);
00740 
00741         <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(pcres);
00742     }
00743 
00744     <span class="comment">/*</span>
00745 <span class="comment">     * Seek to the end of this chunk, regardless of our current position.</span>
00746 <span class="comment">     */</span>
00747     pfi-&gt;<a class="code" href="../../d1/d2/struct__FILEINFO.html#o1">pFilePtr</a> = pfi-&gt;<a class="code" href="../../d1/d2/struct__FILEINFO.html#o0">pFileMap</a> + ((offResBase + cbSize + 1) &amp; (~1));
00748 
00749     <span class="keywordflow">return</span> hcur;
00750 }
00751 
00752 
00753 <span class="comment">/***************************************************************************\</span>
00754 <span class="comment">* LoadAniIcon</span>
00755 <span class="comment">*</span>
00756 <span class="comment">*   Loads an animatied cursor from a RIFF file.  The RIFF file format for</span>
00757 <span class="comment">*   animated cursors looks like this:</span>
00758 <span class="comment">*</span>
00759 <span class="comment">*   RIFF( 'ACON'</span>
00760 <span class="comment">*       LIST( 'INFO'</span>
00761 <span class="comment">*           INAM( &lt;name&gt; )</span>
00762 <span class="comment">*           IART( &lt;artist&gt; )</span>
00763 <span class="comment">*       )</span>
00764 <span class="comment">*       anih( &lt;anihdr&gt; )</span>
00765 <span class="comment">*       [rate( &lt;rateinfo&gt; )  ]</span>
00766 <span class="comment">*       ['seq '( &lt;seq_info&gt; )]</span>
00767 <span class="comment">*   LIST( 'fram' icon( &lt;icon_file&gt; ) ... )</span>
00768 <span class="comment">*   )</span>
00769 <span class="comment">*</span>
00770 <span class="comment">*</span>
00771 <span class="comment">* History:</span>
00772 <span class="comment">* 10-02-91 DarrinM      Created.</span>
00773 <span class="comment">* 03-17-93 JonPa        Rewrote to use RIFF format instead of RAD</span>
00774 <span class="comment">* 04-22-93 JonPa        Finalized RIFF format (changed from ANI to ACON etc)</span>
00775 <span class="comment">* 11/16/1995 SanfordS   Added LR_flags support.</span>
00776 <span class="comment">\***************************************************************************/</span>
<a name="l00777"></a><a class="code" href="../../d3/d4/client_2acons_8c.html#a8">00777</a> HICON <a class="code" href="../../d3/d4/client_2acons_8c.html#a8">LoadAniIcon</a>(
00778     IN <a class="code" href="../../d1/d2/struct__FILEINFO.html">PFILEINFO</a> pfi,
00779     IN LPWSTR    rt,
00780     IN DWORD     cxDesired,
00781     IN DWORD     cyDesired,
00782     IN DWORD     LR_flags)
00783 {
00784     <span class="keywordtype">int</span> cpcur, ipcur = 0, i, cicur;
00785     ANIHEADER anih;
00786     ANIHEADER *panih = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00787     HICON hacon = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00788     HCURSOR *phcur;
00789     JIF jifRate, *pjifRate;
00790     RTAG tag;
00791     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> *picur;
00792 
00793     <span class="comment">/*</span>
00794 <span class="comment">     * Position to the beginning of the file.</span>
00795 <span class="comment">     */</span>
00796     pfi-&gt;pFilePtr = pfi-&gt;pFileMap + <span class="keyword">sizeof</span>(tag);
00797 
00798 <span class="preprocessor">#if DBG</span>
00799 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ((ULONG_PTR)pfi-&gt;pFileEnd != ((ULONG_PTR)(pfi-&gt;pFileMap + <span class="keyword">sizeof</span> (RTAG) + ((RTAG *)(pfi-&gt;pFileMap))-&gt;ckSize + 1) &amp; ~1)) {
00800         RIPMSG2(RIP_WARNING, <span class="stringliteral">"LoadAniIcon: First RIFF chunk has invalid ckSize. Actual:%#lx Expected:%#lx"</span>,
00801                 ((RTAG *)(pfi-&gt;pFileMap))-&gt;ckSize, (pfi-&gt;pFileEnd - pfi-&gt;pFileMap - <span class="keyword">sizeof</span>(RTAG)) &amp; ~1);
00802     }
00803 <span class="preprocessor">#endif</span>
00804 <span class="preprocessor"></span>
00805     <span class="comment">/* read the chunk type */</span>
00806     <span class="keywordflow">if</span>(!<a class="code" href="../../d3/d4/client_2acons_8c.html#a13">ReadFilePtrCopy</a>(pfi,
00807                         &amp;tag.ckID,
00808                         <span class="keyword">sizeof</span>(tag.ckID))) {
00809         <span class="keywordflow">goto</span> laiFileErr;
00810     }
00811 
00812     <span class="keywordflow">if</span> (tag.ckID != FOURCC_ACON)
00813         <span class="keywordflow">goto</span> laiFileErr;
00814 
00815     <span class="comment">/* look for 'anih', 'rate', 'seq ', and 'icon' chunks */</span>
00816     <span class="keywordflow">while</span>( <a class="code" href="../../d3/d4/client_2acons_8c.html#a3">ReadTag</a>(pfi, &amp;tag)) {
00817 
00818         <span class="keywordflow">switch</span>( tag.ckID ) {
00819         <span class="keywordflow">case</span> FOURCC_anih:
00820             <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d4/client_2acons_8c.html#a4">ReadChunk</a>(pfi, &amp;tag, &amp;anih))
00821                 <span class="keywordflow">goto</span> laiFileErr;
00822 
00823             <span class="keywordflow">if</span> (!(anih.fl &amp; AF_ICON) || (anih.cFrames == 0))
00824                 <span class="keywordflow">goto</span> laiFileErr;
00825 
00826             <span class="comment">/*</span>
00827 <span class="comment">             * Allocate space for the ANIHEADER, HCURSOR array and a</span>
00828 <span class="comment">             * rate table (in case we run into one later).</span>
00829 <span class="comment">             */</span>
00830             cpcur = anih.cFrames;
00831             cicur = anih.cSteps;
00832             panih = (PANIHEADER)<a class="code" href="../../d6/d0/usercli_8h.html#a136">UserLocalAlloc</a>(HEAP_ZERO_MEMORY, <span class="keyword">sizeof</span>(ANIHEADER) +
00833                     (cicur * <span class="keyword">sizeof</span>(JIF)) + (cpcur * <span class="keyword">sizeof</span>(HCURSOR)) +
00834                     (cicur * <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)));
00835 
00836             <span class="keywordflow">if</span> (panih == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00837                 <span class="keywordflow">goto</span> laiFileErr;
00838 
00839 
00840             phcur = (HCURSOR *)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)panih + <span class="keyword">sizeof</span>(ANIHEADER));
00841             pjifRate = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00842             picur = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00843 
00844             *panih = anih;
00845             jifRate = panih-&gt;jifRate;
00846             <span class="keywordflow">break</span>;
00847 
00848 
00849         <span class="keywordflow">case</span> FOURCC_rate:
00850             <span class="comment">/*</span>
00851 <span class="comment">             * If we find a rate chunk, read it into its preallocated</span>
00852 <span class="comment">             * space.</span>
00853 <span class="comment">             */</span>
00854             pjifRate = (PJIF)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)phcur + cpcur * <span class="keyword">sizeof</span>(HCURSOR));
00855             <span class="keywordflow">if</span>(!<a class="code" href="../../d3/d4/client_2acons_8c.html#a4">ReadChunk</a>(pfi, &amp;tag, (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pjifRate))
00856                 <span class="keywordflow">goto</span> laiFileErr;
00857             <span class="keywordflow">break</span>;
00858 
00859 
00860         <span class="keywordflow">case</span> FOURCC_seq:
00861             <span class="comment">/*</span>
00862 <span class="comment">             * If we find a seq chunk, read it into its preallocated</span>
00863 <span class="comment">             * space.</span>
00864 <span class="comment">             */</span>
00865             picur = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> *)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)phcur + cpcur * <span class="keyword">sizeof</span>(HCURSOR) +
00866                     cicur * <span class="keyword">sizeof</span>(JIF));
00867             <span class="keywordflow">if</span>(!<a class="code" href="../../d3/d4/client_2acons_8c.html#a4">ReadChunk</a>(pfi, &amp;tag, (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)picur))
00868                 <span class="keywordflow">goto</span> laiFileErr;
00869             <span class="keywordflow">break</span>;
00870 
00871 
00872         <span class="keywordflow">case</span> FOURCC_LIST:
00873             {
00874                 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> cbChunk = (tag.ckSize + 1) &amp; ~1;
00875 
00876                 <span class="comment">/*</span>
00877 <span class="comment">                 * See if this list is the 'fram' list of icon chunks</span>
00878 <span class="comment">                 */</span>
00879                 <span class="keywordflow">if</span>(!<a class="code" href="../../d3/d4/client_2acons_8c.html#a13">ReadFilePtrCopy</a>(pfi, &amp;tag.ckID, <span class="keyword">sizeof</span>(tag.ckID))) {
00880                     <span class="keywordflow">goto</span> laiFileErr;
00881                 }
00882 
00883                 cbChunk -= <span class="keyword">sizeof</span>(tag.ckID);
00884 
00885                 <span class="keywordflow">if</span> (tag.ckID != FOURCC_fram) {
00886                     <span class="comment">/*</span>
00887 <span class="comment">                     * Not the fram list (probably the INFO list).  Skip</span>
00888 <span class="comment">                     * the rest of this chunk.  (Don't forget that we have</span>
00889 <span class="comment">                     * already skipped one dword!)</span>
00890 <span class="comment">                     */</span>
00891                     tag.ckSize = cbChunk;
00892                     <a class="code" href="../../d3/d4/client_2acons_8c.html#a5">SkipChunk</a>(pfi, &amp;tag);
00893                     <span class="keywordflow">break</span>;
00894                 }
00895 
00896                 <span class="keywordflow">while</span>(cbChunk &gt;= <span class="keyword">sizeof</span>(tag)) {
00897                     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d4/client_2acons_8c.html#a3">ReadTag</a>(pfi, &amp;tag))
00898                         <span class="keywordflow">goto</span> laiFileErr;
00899 
00900                     cbChunk -= <span class="keyword">sizeof</span>(tag);
00901 
00902                     <span class="keywordflow">if</span>(tag.ckID == FOURCC_icon) {
00903 
00904                         <span class="comment">/*</span>
00905 <span class="comment">                         * Ok, load the icon/cursor bits, create a cursor from</span>
00906 <span class="comment">                         * them, and save a pointer to it away in the ACON</span>
00907 <span class="comment">                         * cursor pointer array.</span>
00908 <span class="comment">                         */</span>
00909                         phcur[ipcur] = <a class="code" href="../../d3/d4/client_2acons_8c.html#a16">ReadIconFromFileMap</a>(pfi,
00910                                                            tag.ckSize,
00911                                                            cxDesired,
00912                                                            cyDesired,
00913                                                            LR_flags);
00914 
00915                         <span class="keywordflow">if</span> (phcur[ipcur] == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00916                             <span class="keywordflow">for</span> (i = 0; i &lt; ipcur; i++)
00917                                 <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a156">NtUserDestroyCursor</a>(phcur[i], 0);
00918                             <span class="keywordflow">goto</span> laiFileErr;
00919                         }
00920 
00921                         ipcur++;
00922                     } <span class="keywordflow">else</span> {
00923                         <span class="comment">/*</span>
00924 <span class="comment">                         * Unknown chunk in fram list, just ignore it</span>
00925 <span class="comment">                         */</span>
00926                         <a class="code" href="../../d3/d4/client_2acons_8c.html#a5">SkipChunk</a>(pfi, &amp;tag);
00927                     }
00928 
00929                     cbChunk -= (tag.ckSize + 1) &amp; ~1;
00930                 }
00931             }
00932             <span class="keywordflow">break</span>;
00933 
00934         <span class="keywordflow">default</span>:
00935             <span class="comment">/*</span>
00936 <span class="comment">             * We're not interested in this chunk, skip it.</span>
00937 <span class="comment">             */</span>
00938             <span class="keywordflow">if</span>(!<a class="code" href="../../d3/d4/client_2acons_8c.html#a5">SkipChunk</a>(pfi, &amp;tag))
00939                 <span class="keywordflow">goto</span> laiFileErr;
00940             <span class="keywordflow">break</span>;
00941 
00942         }
00943 
00944     }
00945 
00946     <span class="comment">/*</span>
00947 <span class="comment">     * Sanity check the count of frames so we won't fault trying</span>
00948 <span class="comment">     * to select a nonexistant cursor</span>
00949 <span class="comment">     */</span>
00950     <span class="keywordflow">if</span> (cpcur != ipcur) {
00951         RIPMSG2(RIP_WARNING, <span class="stringliteral">"LoadAniIcon: Invalid number of frames; Actual:%#lx Expected:%#lx"</span>,
00952                 ipcur, cpcur);
00953         <span class="keywordflow">for</span> (i = 0; i &lt; ipcur; i++)
00954             <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a156">NtUserDestroyCursor</a>(phcur[i], <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a531">CURSOR_ALWAYSDESTROY</a>);
00955         <span class="keywordflow">goto</span> laiFileErr;
00956     }
00957 
00958 
00959 
00960     <span class="keywordflow">if</span> (cpcur != 0)
00961         hacon = <a class="code" href="../../d3/d4/client_2acons_8c.html#a6">CreateAniIcon</a>(pfi-&gt;pszName,
00962                               rt,
00963                               cicur,
00964                               picur,
00965                               cpcur,
00966                               phcur,
00967                               jifRate,
00968                               pjifRate,
00969                               LR_flags &amp; LR_GLOBAL);
00970 
00971 laiFileErr:
00972 
00973 <span class="preprocessor">#if DBG</span>
00974 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (hacon == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00975         RIPMSG0(RIP_WARNING, <span class="stringliteral">"LoadAniIcon: Invalid icon data format"</span>);
00976     }
00977 <span class="preprocessor">#endif</span>
00978 <span class="preprocessor"></span>
00979     <span class="keywordflow">if</span> (panih != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00980         <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(panih);
00981 
00982     <span class="keywordflow">return</span> hacon;
00983 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:13 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
