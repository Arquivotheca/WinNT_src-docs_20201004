<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: alignem.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>alignem.c</h1><a href="../../d6/d5/mips_2alignem_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1991  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    alignem.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implement the code necessary to emulate unaliged data</span>
00012 <span class="comment">    references.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    David N. Cutler (davec) 17-Jun-1991</span>
00017 <span class="comment"></span>
00018 <span class="comment">Environment:</span>
00019 <span class="comment"></span>
00020 <span class="comment">    Kernel mode only.</span>
00021 <span class="comment"></span>
00022 <span class="comment">Revision History:</span>
00023 <span class="comment"></span>
00024 <span class="comment">--*/</span>
00025 
00026 <span class="preprocessor">#include "<a class="code" href="../../d0/d0/ki_8h.html">ki.h</a>"</span>
00027 
00028 BOOLEAN
<a name="l00029"></a><a class="code" href="../../d6/d5/mips_2alignem_8c.html#a0">00029</a> <a class="code" href="../../d7/d5/ppc_2alignem_8c.html#a18">KiEmulateReference</a> (
00030     IN OUT PEXCEPTION_RECORD ExceptionRecord,
00031     IN OUT PKEXCEPTION_FRAME ExceptionFrame,
00032     IN OUT PKTRAP_FRAME TrapFrame
00033     )
00034 
00035 <span class="comment">/*++</span>
00036 <span class="comment"></span>
00037 <span class="comment">Routine Description:</span>
00038 <span class="comment"></span>
00039 <span class="comment">    This function is called to emulate an unaligned data reference to an</span>
00040 <span class="comment">    address in the user part of the address space.</span>
00041 <span class="comment"></span>
00042 <span class="comment">Arguments:</span>
00043 <span class="comment"></span>
00044 <span class="comment">    ExceptionRecord - Supplies a pointer to an exception record.</span>
00045 <span class="comment"></span>
00046 <span class="comment">    ExceptionFrame - Supplies a pointer to an exception frame.</span>
00047 <span class="comment"></span>
00048 <span class="comment">    TrapFrame - Supplies a pointer to a trap frame.</span>
00049 <span class="comment"></span>
00050 <span class="comment">Return Value:</span>
00051 <span class="comment"></span>
00052 <span class="comment">    A value of TRUE is returned if the data reference is successfully</span>
00053 <span class="comment">    emulated. Otherwise, a value of FALSE is returned.</span>
00054 <span class="comment"></span>
00055 <span class="comment">--*/</span>
00056 
00057 {
00058 
00059     ULONG BranchAddress;
00060     PUCHAR DataAddress;
00061 
00062     <span class="keyword">union </span>{
00063         ULONGLONG Longlong;
00064         ULONG Long;
00065         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> Short;
00066     } DataReference;
00067 
00068     PUCHAR DataValue;
00069     PVOID ExceptionAddress;
00070     MIPS_INSTRUCTION FaultInstruction;
00071     ULONG Rt;
00072     KIRQL  OldIrql;
00073 
00074     <span class="comment">//</span>
00075     <span class="comment">// If alignment profiling is active, then call the proper profile</span>
00076     <span class="comment">// routine.</span>
00077     <span class="comment">//</span>
00078 
00079     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d9/kernldat_8c.html#a52">KiProfileAlignmentFixup</a>) {
00080         <a class="code" href="../../d5/d9/kernldat_8c.html#a54">KiProfileAlignmentFixupCount</a> += 1;
00081         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d9/kernldat_8c.html#a54">KiProfileAlignmentFixupCount</a> &gt;= <a class="code" href="../../d5/d9/kernldat_8c.html#a53">KiProfileAlignmentFixupInterval</a>) {
00082             <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a56">PROFILE_LEVEL</a>, &amp;OldIrql);
00083             <a class="code" href="../../d5/d9/kernldat_8c.html#a54">KiProfileAlignmentFixupCount</a> = 0;
00084             <a class="code" href="../../d1/d9/clock_8c.html#a6">KeProfileInterruptWithSource</a>(TrapFrame, ProfileAlignmentFixup);
00085             <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00086         }
00087     }
00088 
00089     <span class="comment">//</span>
00090     <span class="comment">// Save the original exception address in case another exception</span>
00091     <span class="comment">// occurs.</span>
00092     <span class="comment">//</span>
00093 
00094     ExceptionAddress = ExceptionRecord-&gt;ExceptionAddress;
00095 
00096     <span class="comment">//</span>
00097     <span class="comment">// Any exception that occurs during the attempted emulation of the</span>
00098     <span class="comment">// unaligned reference causes the emulation to be aborted. The new</span>
00099     <span class="comment">// exception code and information is copied to the original exception</span>
00100     <span class="comment">// record and a value of FALSE is returned.</span>
00101     <span class="comment">//</span>
00102 
00103     <span class="keywordflow">try</span> {
00104 
00105         <span class="comment">//</span>
00106         <span class="comment">// If the exception PC is equal to the fault instruction address</span>
00107         <span class="comment">// plus four, then the misalignment exception occurred in the delay</span>
00108         <span class="comment">// slot of a branch instruction and the continuation address must</span>
00109         <span class="comment">// be computed by emulating the branch instruction. Note that it</span>
00110         <span class="comment">// is possible for an exception to occur when the branch instruction</span>
00111         <span class="comment">// is read from user memory.</span>
00112         <span class="comment">//</span>
00113 
00114         <span class="keywordflow">if</span> ((TrapFrame-&gt;Fir + 4) == (ULONG)ExceptionRecord-&gt;ExceptionAddress) {
00115             BranchAddress = <a class="code" href="../../d7/d1/branchem_8c.html#a0">KiEmulateBranch</a>(ExceptionFrame, TrapFrame);
00116 
00117         } <span class="keywordflow">else</span> {
00118             BranchAddress = TrapFrame-&gt;Fir + 4;
00119         }
00120 
00121         <span class="comment">//</span>
00122         <span class="comment">// Compute the effective address of the reference and check to make</span>
00123         <span class="comment">// sure it is within the user part of the address space. Alignment</span>
00124         <span class="comment">// exceptions take precedence over memory management exceptions and</span>
00125         <span class="comment">// the address could be a system address.</span>
00126         <span class="comment">//</span>
00127 
00128         FaultInstruction.Long = *((PULONG)ExceptionRecord-&gt;ExceptionAddress);
00129         DataAddress = (PUCHAR)<a class="code" href="../../d7/d5/mips_2getsetrg_8c.html#a1">KiGetRegisterValue64</a>(FaultInstruction.i_format.Rs,
00130                                                    ExceptionFrame,
00131                                                    TrapFrame);
00132 
00133         DataAddress = (PUCHAR)((LONG)DataAddress +
00134                                     (LONG)FaultInstruction.i_format.Simmediate);
00135 
00136         <span class="comment">//</span>
00137         <span class="comment">// The emulated data reference must be in user space and must be less</span>
00138         <span class="comment">// than 16 types from the end of user space.</span>
00139         <span class="comment">//</span>
00140 
00141         <span class="keywordflow">if</span> ((ULONG)DataAddress &lt; 0x7ffffff0) {
00142 
00143             <span class="comment">//</span>
00144             <span class="comment">// Dispatch on the opcode value.</span>
00145             <span class="comment">//</span>
00146 
00147             DataValue = (PUCHAR)&amp;DataReference;
00148             Rt = FaultInstruction.i_format.Rt;
00149             <span class="keywordflow">switch</span> (FaultInstruction.i_format.Opcode) {
00150 
00151                 <span class="comment">//</span>
00152                 <span class="comment">// Load halfword integer.</span>
00153                 <span class="comment">//</span>
00154 
00155             <span class="keywordflow">case</span> LH_OP:
00156                 DataValue[0] = DataAddress[0];
00157                 DataValue[1] = DataAddress[1];
00158                 <a class="code" href="../../d7/d5/mips_2getsetrg_8c.html#a3">KiSetRegisterValue64</a>(Rt,
00159                                      (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)DataReference.Short,
00160                                      ExceptionFrame,
00161                                      TrapFrame);
00162 
00163                 <span class="keywordflow">break</span>;
00164 
00165                 <span class="comment">//</span>
00166                 <span class="comment">// Load halfword unsigned integer.</span>
00167                 <span class="comment">//</span>
00168 
00169             <span class="keywordflow">case</span> LHU_OP:
00170                 DataValue[0] = DataAddress[0];
00171                 DataValue[1] = DataAddress[1];
00172                 <a class="code" href="../../d7/d5/mips_2getsetrg_8c.html#a3">KiSetRegisterValue64</a>(Rt,
00173                                      DataReference.Short,
00174                                      ExceptionFrame,
00175                                      TrapFrame);
00176 
00177                 <span class="keywordflow">break</span>;
00178 
00179                 <span class="comment">//</span>
00180                 <span class="comment">// Load word floating.</span>
00181                 <span class="comment">//</span>
00182 
00183             <span class="keywordflow">case</span> LWC1_OP:
00184                 DataValue[0] = DataAddress[0];
00185                 DataValue[1] = DataAddress[1];
00186                 DataValue[2] = DataAddress[2];
00187                 DataValue[3] = DataAddress[3];
00188                 <a class="code" href="../../d8/d5/ppc_2getsetrg_8c.html#a1">KiSetRegisterValue</a>(Rt + 32,
00189                                    DataReference.Long,
00190                                    ExceptionFrame,
00191                                    TrapFrame);
00192 
00193                 <span class="keywordflow">break</span>;
00194 
00195                 <span class="comment">//</span>
00196                 <span class="comment">// Load word integer.</span>
00197                 <span class="comment">//</span>
00198 
00199             <span class="keywordflow">case</span> LW_OP:
00200                 DataValue[0] = DataAddress[0];
00201                 DataValue[1] = DataAddress[1];
00202                 DataValue[2] = DataAddress[2];
00203                 DataValue[3] = DataAddress[3];
00204                 <a class="code" href="../../d7/d5/mips_2getsetrg_8c.html#a3">KiSetRegisterValue64</a>(Rt,
00205                                      (LONG)DataReference.Long,
00206                                      ExceptionFrame,
00207                                      TrapFrame);
00208 
00209                 <span class="keywordflow">break</span>;
00210 
00211                 <span class="comment">//</span>
00212                 <span class="comment">// Load double integer.</span>
00213                 <span class="comment">//</span>
00214 
00215             <span class="keywordflow">case</span> <a class="code" href="../../d5/d5/ia64_2alignem_8c.html#a1">LD_OP</a>:
00216                 DataValue[0] = DataAddress[0];
00217                 DataValue[1] = DataAddress[1];
00218                 DataValue[2] = DataAddress[2];
00219                 DataValue[3] = DataAddress[3];
00220                 DataValue[4] = DataAddress[4];
00221                 DataValue[5] = DataAddress[5];
00222                 DataValue[6] = DataAddress[6];
00223                 DataValue[7] = DataAddress[7];
00224                 <a class="code" href="../../d7/d5/mips_2getsetrg_8c.html#a3">KiSetRegisterValue64</a>(Rt,
00225                                      DataReference.Longlong,
00226                                      ExceptionFrame,
00227                                      TrapFrame);
00228 
00229                 <span class="keywordflow">break</span>;
00230 
00231                 <span class="comment">//</span>
00232                 <span class="comment">// Load double floating.</span>
00233                 <span class="comment">//</span>
00234 
00235             <span class="keywordflow">case</span> LDC1_OP:
00236                 Rt = (Rt &amp; 0x1e) + 32;
00237                 DataValue[0] = DataAddress[0];
00238                 DataValue[1] = DataAddress[1];
00239                 DataValue[2] = DataAddress[2];
00240                 DataValue[3] = DataAddress[3];
00241                 <a class="code" href="../../d8/d5/ppc_2getsetrg_8c.html#a1">KiSetRegisterValue</a>(Rt,
00242                                    DataReference.Long,
00243                                    ExceptionFrame,
00244                                    TrapFrame);
00245 
00246                 DataValue[0] = DataAddress[4];
00247                 DataValue[1] = DataAddress[5];
00248                 DataValue[2] = DataAddress[6];
00249                 DataValue[3] = DataAddress[7];
00250                 <a class="code" href="../../d8/d5/ppc_2getsetrg_8c.html#a1">KiSetRegisterValue</a>(Rt + 1,
00251                                    DataReference.Long,
00252                                    ExceptionFrame,
00253                                    TrapFrame);
00254 
00255                 <span class="keywordflow">break</span>;
00256 
00257                 <span class="comment">//</span>
00258                 <span class="comment">// Store halfword integer.</span>
00259                 <span class="comment">//</span>
00260 
00261             <span class="keywordflow">case</span> SH_OP:
00262                 DataReference.Longlong = <a class="code" href="../../d7/d5/mips_2getsetrg_8c.html#a1">KiGetRegisterValue64</a>(Rt,
00263                                                               ExceptionFrame,
00264                                                               TrapFrame);
00265 
00266                 DataAddress[0] = DataValue[0];
00267                 DataAddress[1] = DataValue[1];
00268                 <span class="keywordflow">break</span>;
00269 
00270                 <span class="comment">//</span>
00271                 <span class="comment">// Store word floating.</span>
00272                 <span class="comment">//</span>
00273 
00274             <span class="keywordflow">case</span> SWC1_OP:
00275                 DataReference.Long = <a class="code" href="../../d8/d5/ppc_2getsetrg_8c.html#a0">KiGetRegisterValue</a>(Rt + 32,
00276                                                         ExceptionFrame,
00277                                                         TrapFrame);
00278 
00279                 DataAddress[0] = DataValue[0];
00280                 DataAddress[1] = DataValue[1];
00281                 DataAddress[2] = DataValue[2];
00282                 DataAddress[3] = DataValue[3];
00283                 <span class="keywordflow">break</span>;
00284 
00285                 <span class="comment">//</span>
00286                 <span class="comment">// Store word integer.</span>
00287                 <span class="comment">//</span>
00288 
00289             <span class="keywordflow">case</span> SW_OP:
00290                 DataReference.Longlong = <a class="code" href="../../d7/d5/mips_2getsetrg_8c.html#a1">KiGetRegisterValue64</a>(Rt,
00291                                                               ExceptionFrame,
00292                                                               TrapFrame);
00293 
00294                 DataAddress[0] = DataValue[0];
00295                 DataAddress[1] = DataValue[1];
00296                 DataAddress[2] = DataValue[2];
00297                 DataAddress[3] = DataValue[3];
00298                 <span class="keywordflow">break</span>;
00299 
00300                 <span class="comment">//</span>
00301                 <span class="comment">// Store double integer.</span>
00302                 <span class="comment">//</span>
00303 
00304             <span class="keywordflow">case</span> SD_OP:
00305                 DataReference.Longlong = <a class="code" href="../../d7/d5/mips_2getsetrg_8c.html#a1">KiGetRegisterValue64</a>(Rt,
00306                                                               ExceptionFrame,
00307                                                               TrapFrame);
00308 
00309                 DataAddress[0] = DataValue[0];
00310                 DataAddress[1] = DataValue[1];
00311                 DataAddress[2] = DataValue[2];
00312                 DataAddress[3] = DataValue[3];
00313                 DataAddress[4] = DataValue[4];
00314                 DataAddress[5] = DataValue[5];
00315                 DataAddress[6] = DataValue[6];
00316                 DataAddress[7] = DataValue[7];
00317                 <span class="keywordflow">break</span>;
00318 
00319                 <span class="comment">//</span>
00320                 <span class="comment">// Store double floating.</span>
00321                 <span class="comment">//</span>
00322 
00323             <span class="keywordflow">case</span> SDC1_OP:
00324                 Rt = (Rt &amp; 0x1e) + 32;
00325                 DataReference.Long = <a class="code" href="../../d8/d5/ppc_2getsetrg_8c.html#a0">KiGetRegisterValue</a>(Rt,
00326                                                         ExceptionFrame,
00327                                                         TrapFrame);
00328 
00329                 DataAddress[0] = DataValue[0];
00330                 DataAddress[1] = DataValue[1];
00331                 DataAddress[2] = DataValue[2];
00332                 DataAddress[3] = DataValue[3];
00333                 DataReference.Long = <a class="code" href="../../d8/d5/ppc_2getsetrg_8c.html#a0">KiGetRegisterValue</a>(Rt + 1,
00334                                                         ExceptionFrame,
00335                                                         TrapFrame);
00336 
00337                 DataAddress[4] = DataValue[0];
00338                 DataAddress[5] = DataValue[1];
00339                 DataAddress[6] = DataValue[2];
00340                 DataAddress[7] = DataValue[3];
00341                 <span class="keywordflow">break</span>;
00342 
00343                 <span class="comment">//</span>
00344                 <span class="comment">// All other instructions are not emulated.</span>
00345                 <span class="comment">//</span>
00346 
00347             <span class="keywordflow">default</span>:
00348                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00349             }
00350 
00351             TrapFrame-&gt;Fir = BranchAddress;
00352             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00353         }
00354 
00355     <span class="comment">//</span>
00356     <span class="comment">// If an exception occurs, then copy the new exception information to the</span>
00357     <span class="comment">// original exception record and handle the exception.</span>
00358     <span class="comment">//</span>
00359 
00360     } except (<a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a12">KiCopyInformation</a>(ExceptionRecord,
00361                                (GetExceptionInformation())-&gt;ExceptionRecord)) {
00362 
00363         <span class="comment">//</span>
00364         <span class="comment">// Preserve the original exception address.</span>
00365         <span class="comment">//</span>
00366 
00367         ExceptionRecord-&gt;ExceptionAddress = ExceptionAddress;
00368     }
00369 
00370     <span class="comment">//</span>
00371     <span class="comment">// Return a value of FALSE.</span>
00372     <span class="comment">//</span>
00373 
00374     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00375 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:14 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
