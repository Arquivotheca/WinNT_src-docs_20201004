<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: security.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>security.c</h1><a href="../../d6/d5/ps_2security_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    security.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements the security related portions of the process</span>
00012 <span class="comment">    structure.</span>
00013 <span class="comment"></span>
00014 <span class="comment"></span>
00015 <span class="comment">Author:</span>
00016 <span class="comment"></span>
00017 <span class="comment">    Mark Lucovsky (markl) 25-Apr-1989</span>
00018 <span class="comment">    Jim Kelly (JimK) 2-August-1990</span>
00019 <span class="comment"></span>
00020 <span class="comment">Revision History:</span>
00021 <span class="comment"></span>
00022 <span class="comment">--*/</span>
00023 
00024 <span class="preprocessor">#include "<a class="code" href="../../d8/d1/psp_8h.html">psp.h</a>"</span>
00025 
00026 
00027 PACCESS_TOKEN
<a name="l00028"></a><a class="code" href="../../d6/d5/ps_2security_8c.html#a0">00028</a> <a class="code" href="../../d6/d5/ps_2security_8c.html#a0">PsReferencePrimaryToken</a>(
00029     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
00030     )
00031 
00032 <span class="comment">/*++</span>
00033 <span class="comment"></span>
00034 <span class="comment">Routine Description:</span>
00035 <span class="comment"></span>
00036 <span class="comment">    This function returns a pointer to the primary token of a process.</span>
00037 <span class="comment">    The reference count of that primary token is incremented to protect</span>
00038 <span class="comment">    the pointer returned.</span>
00039 <span class="comment"></span>
00040 <span class="comment">    When the pointer is no longer needed, it should be freed using</span>
00041 <span class="comment">    PsDereferencePrimaryToken().</span>
00042 <span class="comment"></span>
00043 <span class="comment"></span>
00044 <span class="comment">Arguments:</span>
00045 <span class="comment"></span>
00046 <span class="comment">    Process - Supplies the address of the process whose primary token</span>
00047 <span class="comment">        is to be referenced.</span>
00048 <span class="comment"></span>
00049 <span class="comment">Return Value:</span>
00050 <span class="comment"></span>
00051 <span class="comment">    A pointer to the specified process's primary token.</span>
00052 <span class="comment"></span>
00053 <span class="comment">--*/</span>
00054 
00055 {
00056     PACCESS_TOKEN
00057         <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
00058 
00059     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Process-&gt;Pcb.Header.Type == <a class="code" href="../../d4/d9/ke_8h.html#a402a160">ProcessObject</a> );
00060 
00061     <span class="comment">//</span>
00062     <span class="comment">//  For performance sake, we may want to change this to use</span>
00063     <span class="comment">//  an executive interlocked add routine in the future.</span>
00064     <span class="comment">//</span>
00065 
00066 
00067     <span class="comment">//</span>
00068     <span class="comment">//  Lock the process security fields.</span>
00069     <span class="comment">//</span>
00070 
00071     <a class="code" href="../../d1/d9/ps_8h.html#a21">PsLockProcessSecurityFields</a>();
00072 
00073     <span class="comment">//</span>
00074     <span class="comment">//  Grab the current token pointer value</span>
00075     <span class="comment">//</span>
00076 
00077     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> = Process-&gt;Token;
00078 
00079     <span class="comment">//</span>
00080     <span class="comment">//  Increment the reference count of the primary token to protect our</span>
00081     <span class="comment">//  pointer.</span>
00082     <span class="comment">//</span>
00083 
00084     <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>);
00085 
00086     <span class="comment">//</span>
00087     <span class="comment">//  Release the process security fields</span>
00088     <span class="comment">//</span>
00089 
00090     <a class="code" href="../../d1/d9/ps_8h.html#a22">PsFreeProcessSecurityFields</a>();
00091 
00092     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
00093 
00094 }
00095 
00096 PACCESS_TOKEN
<a name="l00097"></a><a class="code" href="../../d6/d5/ps_2security_8c.html#a1">00097</a> <a class="code" href="../../d6/d5/ps_2security_8c.html#a1">PsReferenceImpersonationToken</a>(
00098     IN <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread,
00099     OUT PBOOLEAN CopyOnOpen,
00100     OUT PBOOLEAN EffectiveOnly,
00101     OUT PSECURITY_IMPERSONATION_LEVEL ImpersonationLevel
00102     )
00103 
00104 <span class="comment">/*++</span>
00105 <span class="comment"></span>
00106 <span class="comment">Routine Description:</span>
00107 <span class="comment"></span>
00108 <span class="comment">    This function returns a pointer to the impersonation token of a thread.</span>
00109 <span class="comment">    The reference count of that impersonation token is incremented to protect</span>
00110 <span class="comment">    the pointer returned.</span>
00111 <span class="comment"></span>
00112 <span class="comment">    If the thread is not currently impersonating a client, then a null pointer</span>
00113 <span class="comment">    is returned.</span>
00114 <span class="comment"></span>
00115 <span class="comment">    If the thread is impersonating a client, then information about the</span>
00116 <span class="comment">    means of impersonation are also returned (ImpersonationLevel).</span>
00117 <span class="comment"></span>
00118 <span class="comment">    If a non-null value is returned, then PsDereferenceImpersonationToken()</span>
00119 <span class="comment">    must be called to decrement the token's reference count when the pointer</span>
00120 <span class="comment">    is no longer needed.</span>
00121 <span class="comment"></span>
00122 <span class="comment"></span>
00123 <span class="comment">Arguments:</span>
00124 <span class="comment"></span>
00125 <span class="comment">    Thread - Supplies the address of the thread whose impersonation token</span>
00126 <span class="comment">        is to be referenced.</span>
00127 <span class="comment"></span>
00128 <span class="comment">    CopyOnOpen - The current value of the Thread-&gt;ImpersonationInfo-&gt;CopyOnOpen field.</span>
00129 <span class="comment"></span>
00130 <span class="comment">    EffectiveOnly - The current value of the Thread-&gt;ImpersonationInfo-&gt;EffectiveOnly field.</span>
00131 <span class="comment"></span>
00132 <span class="comment">    ImpersonationLevel - The current value of the Thread-&gt;ImpersonationInfo-&gt;ImpersonationLevel</span>
00133 <span class="comment">        field.</span>
00134 <span class="comment"></span>
00135 <span class="comment">Return Value:</span>
00136 <span class="comment"></span>
00137 <span class="comment">    A pointer to the specified thread's impersonation token.</span>
00138 <span class="comment"></span>
00139 <span class="comment">    If the thread is not currently impersonating a client, then NULL is</span>
00140 <span class="comment">    returned.</span>
00141 <span class="comment"></span>
00142 <span class="comment">--*/</span>
00143 
00144 {
00145     PACCESS_TOKEN
00146         <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
00147 
00148     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Thread-&gt;Tcb.Header.Type == <a class="code" href="../../d4/d9/ke_8h.html#a402a163">ThreadObject</a> );
00149     <span class="comment">//</span>
00150     <span class="comment">// before going through the lock overhead just look to see if it is</span>
00151     <span class="comment">// null. There is no race.  Grabbing the lock is not needed until</span>
00152     <span class="comment">// we decide to use the token at which point we re check to see it</span>
00153     <span class="comment">// it is null.</span>
00154     <span class="comment">// This check saves about 300 instructions.</span>
00155     <span class="comment">//</span>
00156 
00157     <span class="keywordflow">if</span> ( !Thread-&gt;ActiveImpersonationInfo ) {
00158         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00159     }
00160 
00161 
00162     <span class="comment">//</span>
00163     <span class="comment">//  Lock the process security fields.</span>
00164     <span class="comment">//</span>
00165 
00166     <a class="code" href="../../d1/d9/ps_8h.html#a21">PsLockProcessSecurityFields</a>();
00167 
00168     <span class="comment">//</span>
00169     <span class="comment">//  Grab the current token pointer value</span>
00170     <span class="comment">//</span>
00171 
00172 
00173     <span class="keywordflow">if</span> ( Thread-&gt;ActiveImpersonationInfo ) {
00174 
00175         <span class="comment">//</span>
00176         <span class="comment">//  Return the thread's impersonation level, etc.</span>
00177         <span class="comment">//</span>
00178 
00179         <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> = Thread-&gt;ImpersonationInfo-&gt;Token;
00180         (*ImpersonationLevel) = Thread-&gt;ImpersonationInfo-&gt;ImpersonationLevel;
00181         (*CopyOnOpen) = Thread-&gt;ImpersonationInfo-&gt;CopyOnOpen;
00182         (*EffectiveOnly) = Thread-&gt;ImpersonationInfo-&gt;EffectiveOnly;
00183 
00184 
00185         <span class="comment">//</span>
00186         <span class="comment">//  Increment the reference count of the token to protect our</span>
00187         <span class="comment">//  pointer.</span>
00188         <span class="comment">//</span>
00189 
00190         <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>);
00191 
00192     } <span class="keywordflow">else</span> {
00193         <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00194     }
00195 
00196 
00197     <span class="comment">//</span>
00198     <span class="comment">//  Release the security fields.</span>
00199     <span class="comment">//</span>
00200 
00201     <a class="code" href="../../d1/d9/ps_8h.html#a22">PsFreeProcessSecurityFields</a>();
00202 
00203     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
00204 
00205 }
00206 
00207 PACCESS_TOKEN
<a name="l00208"></a><a class="code" href="../../d6/d5/ps_2security_8c.html#a2">00208</a> <a class="code" href="../../d6/d5/ps_2security_8c.html#a2">PsReferenceEffectiveToken</a>(
00209     IN <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread,
00210     OUT PTOKEN_TYPE TokenType,
00211     OUT PBOOLEAN EffectiveOnly,
00212     OUT PSECURITY_IMPERSONATION_LEVEL ImpersonationLevel
00213     )
00214 
00215 <span class="comment">/*++</span>
00216 <span class="comment"></span>
00217 <span class="comment">Routine Description:</span>
00218 <span class="comment"></span>
00219 <span class="comment">    This function returns a pointer to the effective token of a thread.  The</span>
00220 <span class="comment">    effective token of a thread is the thread's impersonation token if it has</span>
00221 <span class="comment">    one.  Otherwise, it is the primary token of the thread's process.</span>
00222 <span class="comment"></span>
00223 <span class="comment">    The reference count of the effective token is incremented to protect</span>
00224 <span class="comment">    the pointer returned.</span>
00225 <span class="comment"></span>
00226 <span class="comment">    If the thread is impersonating a client, then the impersonation level</span>
00227 <span class="comment">    is also returned.</span>
00228 <span class="comment"></span>
00229 <span class="comment">    Either PsDereferenceImpersonationToken() (for an impersonation token) or</span>
00230 <span class="comment">    PsDereferencePrimaryToken() (for a primary token) must be called to</span>
00231 <span class="comment">    decrement the token's reference count when the pointer is no longer</span>
00232 <span class="comment">    needed.</span>
00233 <span class="comment"></span>
00234 <span class="comment"></span>
00235 <span class="comment">Arguments:</span>
00236 <span class="comment"></span>
00237 <span class="comment">    Thread - Supplies the address of the thread whose effective token</span>
00238 <span class="comment">        is to be referenced.</span>
00239 <span class="comment"></span>
00240 <span class="comment">    TokenType - Receives the type of the effective token.  If the thread</span>
00241 <span class="comment">        is currently impersonating a client, then this will be</span>
00242 <span class="comment">        TokenImpersonation.  Othwerwise, it will be TokenPrimary.</span>
00243 <span class="comment"></span>
00244 <span class="comment">    EffectiveOnly - If the token type is TokenImpersonation, then this</span>
00245 <span class="comment">        receives the value of the client thread's Thread-&gt;Client-&gt;EffectiveOnly field.</span>
00246 <span class="comment">        Otherwise, it is set to FALSE.</span>
00247 <span class="comment"></span>
00248 <span class="comment">    ImpersonationLevel - The current value of the Thread-&gt;Client-&gt;ImpersonationLevel</span>
00249 <span class="comment">        field for an impersonation token and is not set for a primary token.</span>
00250 <span class="comment"></span>
00251 <span class="comment">Return Value:</span>
00252 <span class="comment"></span>
00253 <span class="comment">    A pointer to the specified thread's effective token.</span>
00254 <span class="comment"></span>
00255 <span class="comment">--*/</span>
00256 
00257 {
00258     PACCESS_TOKEN
00259         <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
00260 
00261     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Thread-&gt;Tcb.Header.Type == <a class="code" href="../../d4/d9/ke_8h.html#a402a163">ThreadObject</a> );
00262 
00263     <span class="comment">//</span>
00264     <span class="comment">//  Lock the process security fields.</span>
00265     <span class="comment">//</span>
00266 
00267     <a class="code" href="../../d1/d9/ps_8h.html#a21">PsLockProcessSecurityFields</a>();
00268 
00269     <span class="comment">//</span>
00270     <span class="comment">//  Grab the current impersonation token pointer value</span>
00271     <span class="comment">//</span>
00272 
00273 
00274     <span class="keywordflow">if</span> ( Thread-&gt;ActiveImpersonationInfo ) {
00275 
00276         <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> = Thread-&gt;ImpersonationInfo-&gt;Token;
00277 
00278         <span class="comment">//</span>
00279         <span class="comment">//  Return the thread's impersonation level, etc.</span>
00280         <span class="comment">//</span>
00281 
00282         (*TokenType) = TokenImpersonation;
00283         (*EffectiveOnly) = Thread-&gt;ImpersonationInfo-&gt;EffectiveOnly;
00284         (*ImpersonationLevel) = Thread-&gt;ImpersonationInfo-&gt;ImpersonationLevel;
00285 
00286 
00287 
00288     } <span class="keywordflow">else</span> {
00289 
00290         <span class="comment">//</span>
00291         <span class="comment">// Get the thread's primary token if it wasn't impersonating a client.</span>
00292         <span class="comment">//</span>
00293 
00294         <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> = <a class="code" href="../../d1/d9/ps_8h.html#a17">THREAD_TO_PROCESS</a>(Thread)-&gt;Token;
00295 
00296 
00297         <span class="comment">//</span>
00298         <span class="comment">//  Only the TokenType and CopyOnOpen OUT parameters are</span>
00299         <span class="comment">//  returned for a primary token.</span>
00300         <span class="comment">//</span>
00301 
00302         (*TokenType) = TokenPrimary;
00303         (*EffectiveOnly) = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00304 
00305     }
00306 
00307     <span class="comment">//</span>
00308     <span class="comment">//  Increment the reference count of the token to protect our</span>
00309     <span class="comment">//  pointer.</span>
00310     <span class="comment">//</span>
00311 
00312     <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>);
00313 
00314     <span class="comment">//</span>
00315     <span class="comment">//  Release the security fields.</span>
00316     <span class="comment">//</span>
00317 
00318     <a class="code" href="../../d1/d9/ps_8h.html#a22">PsFreeProcessSecurityFields</a>();
00319 
00320 
00321     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
00322 
00323 }
00324 
00325 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00326"></a><a class="code" href="../../d6/d5/ps_2security_8c.html#a3">00326</a> <a class="code" href="../../d6/d5/ps_2security_8c.html#a3">PsOpenTokenOfThread</a>(
00327     IN HANDLE ThreadHandle,
00328     IN BOOLEAN OpenAsSelf,
00329     OUT PACCESS_TOKEN *Token,
00330     OUT PBOOLEAN CopyOnOpen,
00331     OUT PBOOLEAN EffectiveOnly,
00332     OUT PSECURITY_IMPERSONATION_LEVEL ImpersonationLevel
00333     )
00334 
00335 <span class="comment">/*++</span>
00336 <span class="comment"></span>
00337 <span class="comment">Routine Description:</span>
00338 <span class="comment"></span>
00339 <span class="comment">    This function does the thread specific processing of</span>
00340 <span class="comment">    an NtOpenThreadToken() service.</span>
00341 <span class="comment"></span>
00342 <span class="comment">    The service validates that the handle has appropriate access</span>
00343 <span class="comment">    to reference the thread.  If so, it goes on to increment</span>
00344 <span class="comment">    the reference count of the token object to prevent it from</span>
00345 <span class="comment">    going away while the rest of the NtOpenThreadToken() request</span>
00346 <span class="comment">    is processed.</span>
00347 <span class="comment"></span>
00348 <span class="comment">    NOTE: If this call completes successfully, the caller is responsible</span>
00349 <span class="comment">          for decrementing the reference count of the target token.</span>
00350 <span class="comment">          This must be done using PsDereferenceImpersonationToken().</span>
00351 <span class="comment"></span>
00352 <span class="comment">Arguments:</span>
00353 <span class="comment"></span>
00354 <span class="comment">    ThreadHandle - Supplies a handle to a thread object.</span>
00355 <span class="comment"></span>
00356 <span class="comment">    OpenAsSelf - Is a boolean value indicating whether the access should</span>
00357 <span class="comment">        be made using the calling thread's current security context, which</span>
00358 <span class="comment">        may be that of a client (if impersonating), or using the caller's</span>
00359 <span class="comment">        process-level security context.  A value of FALSE indicates the</span>
00360 <span class="comment">        caller's current context should be used un-modified.  A value of</span>
00361 <span class="comment">        TRUE indicates the request should be fulfilled using the process</span>
00362 <span class="comment">        level security context.</span>
00363 <span class="comment"></span>
00364 <span class="comment">    Token - If successful, receives a pointer to the thread's token</span>
00365 <span class="comment">        object.</span>
00366 <span class="comment"></span>
00367 <span class="comment">    CopyOnOpen - The current value of the Thread-&gt;Client-&gt;CopyOnOpen field.</span>
00368 <span class="comment"></span>
00369 <span class="comment">    EffectiveOnly - The current value of the Thread-&gt;Client-&gt;EffectiveOnly field.</span>
00370 <span class="comment"></span>
00371 <span class="comment">    ImpersonationLevel - The current value of the Thread-&gt;Client-&gt;ImpersonationLevel</span>
00372 <span class="comment">        field.</span>
00373 <span class="comment"></span>
00374 <span class="comment">Return Value:</span>
00375 <span class="comment"></span>
00376 <span class="comment">    STATUS_SUCCESS - Indicates the call completed successfully.</span>
00377 <span class="comment"></span>
00378 <span class="comment">    STATUS_NO_TOKEN - Indicates the referenced thread is not currently</span>
00379 <span class="comment">        impersonating a client.</span>
00380 <span class="comment"></span>
00381 <span class="comment">    STATUS_CANT_OPEN_ANONYMOUS - Indicates the client requested anonymous</span>
00382 <span class="comment">        impersonation level.  An anonymous token can not be openned.</span>
00383 <span class="comment"></span>
00384 <span class="comment">    status may also be any value returned by an attemp the reference</span>
00385 <span class="comment">    the thread object for THREAD_QUERY_INFORMATION access.</span>
00386 <span class="comment"></span>
00387 <span class="comment">--*/</span>
00388 
00389 {
00390 
00391     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00392         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00393 
00394     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>
00395         Thread;
00396 
00397     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>
00398         PreviousMode;
00399 
00400     SE_IMPERSONATION_STATE
00401         DisabledImpersonationState;
00402 
00403     BOOLEAN
00404         RestoreImpersonationState = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00405 
00406     PreviousMode = KeGetPreviousMode();
00407 
00408 
00409 
00410     <span class="comment">//</span>
00411     <span class="comment">// Disable impersonation if necessary</span>
00412     <span class="comment">//</span>
00413 
00414     <span class="keywordflow">if</span> (OpenAsSelf) {
00415          RestoreImpersonationState = <a class="code" href="../../d6/d5/ps_2security_8c.html#a7">PsDisableImpersonation</a>(
00416                                          <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>(),
00417                                          &amp;DisabledImpersonationState
00418                                          );
00419     }
00420 
00421     <span class="comment">//</span>
00422     <span class="comment">//  Make sure the handle grants the appropriate access to the specified</span>
00423     <span class="comment">//  thread.</span>
00424     <span class="comment">//</span>
00425 
00426     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00427                  <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>,
00428                  THREAD_QUERY_INFORMATION,
00429                  <a class="code" href="../../d9/d8/ntos_8h.html#a3">PsThreadType</a>,
00430                  PreviousMode,
00431                  (PVOID *)&amp;Thread,
00432                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00433                  );
00434 
00435 
00436 
00437 
00438     <span class="keywordflow">if</span> (RestoreImpersonationState) {
00439         <a class="code" href="../../d6/d5/ps_2security_8c.html#a8">PsRestoreImpersonation</a>(
00440             <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>(),
00441             &amp;DisabledImpersonationState
00442             );
00443     }
00444 
00445     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00446         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00447     }
00448 
00449     <span class="comment">//</span>
00450     <span class="comment">//  Reference the impersonation token, if there is one</span>
00451     <span class="comment">//</span>
00452 
00453     (*Token) = <a class="code" href="../../d6/d5/ps_2security_8c.html#a1">PsReferenceImpersonationToken</a>( Thread,
00454                                               CopyOnOpen,
00455                                               EffectiveOnly,
00456                                               ImpersonationLevel
00457                                               );
00458 
00459 
00460     <span class="comment">//</span>
00461     <span class="comment">//  dereference the target thread.</span>
00462     <span class="comment">//</span>
00463 
00464     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Thread );
00465 
00466     <span class="comment">//</span>
00467     <span class="comment">// Make sure there is a token</span>
00468     <span class="comment">//</span>
00469 
00470     <span class="keywordflow">if</span> ((*Token) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00471         <span class="keywordflow">return</span> STATUS_NO_TOKEN;
00472     }
00473 
00474     <span class="comment">//</span>
00475     <span class="comment">//  Make sure the ImpersonationLevel is high enough to allow</span>
00476     <span class="comment">//  the token to be openned.</span>
00477     <span class="comment">//</span>
00478 
00479     <span class="keywordflow">if</span> ((*ImpersonationLevel) &lt;= SecurityAnonymous) {
00480         <a class="code" href="../../d1/d9/ps_8h.html#a26">PsDereferenceImpersonationToken</a>( (*<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>) );
00481         (*Token) = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00482         <span class="keywordflow">return</span> STATUS_CANT_OPEN_ANONYMOUS;
00483     }
00484 
00485 
00486     <span class="keywordflow">return</span> STATUS_SUCCESS;
00487 
00488 }
00489 
00490 
00491 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00492"></a><a class="code" href="../../d6/d5/ps_2security_8c.html#a4">00492</a> <a class="code" href="../../d6/d5/ps_2security_8c.html#a4">PsOpenTokenOfProcess</a>(
00493     IN HANDLE ProcessHandle,
00494     OUT PACCESS_TOKEN *Token
00495     )
00496 
00497 <span class="comment">/*++</span>
00498 <span class="comment"></span>
00499 <span class="comment">Routine Description:</span>
00500 <span class="comment"></span>
00501 <span class="comment">    This function does the process specific processing of</span>
00502 <span class="comment">    an NtOpenProcessToken() service.</span>
00503 <span class="comment"></span>
00504 <span class="comment">    The service validates that the handle has appropriate access</span>
00505 <span class="comment">    to referenced process.  If so, it goes on to reference the</span>
00506 <span class="comment">    primary token object to prevent it from going away while the</span>
00507 <span class="comment">    rest of the NtOpenProcessToken() request is processed.</span>
00508 <span class="comment"></span>
00509 <span class="comment">    NOTE: If this call completes successfully, the caller is responsible</span>
00510 <span class="comment">          for decrementing the reference count of the target token.</span>
00511 <span class="comment">          This must be done using the PsDereferencePrimaryToken() API.</span>
00512 <span class="comment"></span>
00513 <span class="comment">Arguments:</span>
00514 <span class="comment"></span>
00515 <span class="comment">    ProcessHandle - Supplies a handle to a process object whose primary</span>
00516 <span class="comment">        token is to be opened.</span>
00517 <span class="comment"></span>
00518 <span class="comment">    Token - If successful, receives a pointer to the process's token</span>
00519 <span class="comment">        object.</span>
00520 <span class="comment"></span>
00521 <span class="comment">Return Value:</span>
00522 <span class="comment"></span>
00523 <span class="comment">    STATUS_SUCCESS - Indicates the call completed successfully.</span>
00524 <span class="comment"></span>
00525 <span class="comment">    status may also be any value returned by an attemp the reference</span>
00526 <span class="comment">    the process object for PROCESS_QUERY_INFORMATION access.</span>
00527 <span class="comment"></span>
00528 <span class="comment">--*/</span>
00529 
00530 {
00531 
00532     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00533         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00534 
00535     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>
00536         Process;
00537 
00538     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>
00539         PreviousMode;
00540 
00541 
00542     PreviousMode = KeGetPreviousMode();
00543 
00544     <span class="comment">//</span>
00545     <span class="comment">//  Make sure the handle grants the appropriate access to the specified</span>
00546     <span class="comment">//  process.</span>
00547     <span class="comment">//</span>
00548 
00549     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00550                  ProcessHandle,
00551                  PROCESS_QUERY_INFORMATION,
00552                  <a class="code" href="../../d9/d8/ntos_8h.html#a2">PsProcessType</a>,
00553                  PreviousMode,
00554                  (PVOID *)&amp;Process,
00555                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00556                  );
00557 
00558     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00559 
00560         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00561 
00562     }
00563 
00564     <span class="comment">//</span>
00565     <span class="comment">//  Reference the primary token</span>
00566     <span class="comment">//  (This takes care of gaining exlusive access to the process</span>
00567     <span class="comment">//   security fields for us)</span>
00568     <span class="comment">//</span>
00569 
00570     (*Token) = <a class="code" href="../../d6/d5/ps_2security_8c.html#a0">PsReferencePrimaryToken</a>( Process );
00571 
00572 
00573 
00574     <span class="comment">//</span>
00575     <span class="comment">// Done with the process object</span>
00576     <span class="comment">//</span>
00577 
00578     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Process );
00579 
00580     <span class="keywordflow">return</span> STATUS_SUCCESS;
00581 
00582 
00583 }
00584 
00585 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00586"></a><a class="code" href="../../d6/d5/ps_2security_8c.html#a5">00586</a> <a class="code" href="../../d6/d5/ps_2security_8c.html#a5">PsOpenTokenOfJobObject</a>(
00587     IN HANDLE JobObject,
00588     OUT PACCESS_TOKEN * Token
00589     )
00590 
00591 <span class="comment">/*++</span>
00592 <span class="comment"></span>
00593 <span class="comment">Routine Description:</span>
00594 <span class="comment"></span>
00595 <span class="comment">    This function does the ps/job specific work for NtOpenJobObjectToken.</span>
00596 <span class="comment"></span>
00597 <span class="comment"></span>
00598 <span class="comment">Arguments:</span>
00599 <span class="comment"></span>
00600 <span class="comment">    JobObject - Supplies a handle to a job object whose limit token</span>
00601 <span class="comment">        token is to be opened.</span>
00602 <span class="comment"></span>
00603 <span class="comment">    Token - If successful, receives a pointer to the process's token</span>
00604 <span class="comment">        object.</span>
00605 <span class="comment"></span>
00606 <span class="comment">Return Value:</span>
00607 <span class="comment"></span>
00608 <span class="comment">    STATUS_SUCCESS - Indicates the call completed successfully.</span>
00609 <span class="comment"></span>
00610 <span class="comment">    STATUS_NO_TOKEN - indicates the job object does  not have a token</span>
00611 <span class="comment"></span>
00612 <span class="comment"></span>
00613 <span class="comment">--*/</span>
00614 {
00615     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
00616     <a class="code" href="../../d0/d3/struct__EJOB.html">PEJOB</a> Job ;
00617     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode ;
00618 
00619     PreviousMode = KeGetPreviousMode();
00620 
00621     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00622                     JobObject,
00623                     JOB_OBJECT_QUERY,
00624                     <a class="code" href="../../d9/d8/ntos_8h.html#a4">PsJobType</a>,
00625                     PreviousMode,
00626                     &amp;Job,
00627                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00628 
00629     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) )
00630     {
00631         <span class="keywordflow">if</span> ( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o22">Token</a> )
00632         {
00633             <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>( Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o22">Token</a> );
00634 
00635             *<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> = Job-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o22">Token</a> ;
00636 
00637         }
00638         <span class="keywordflow">else</span>
00639         {
00640             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_TOKEN ;
00641         }
00642 
00643     }
00644 
00645     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
00646 }
00647 
00648 
00649 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00650"></a><a class="code" href="../../d6/d5/ps_2security_8c.html#a6">00650</a> <a class="code" href="../../d6/d5/ps_2security_8c.html#a6">PsImpersonateClient</a>(
00651     IN <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread,
00652     IN PACCESS_TOKEN Token,
00653     IN BOOLEAN CopyOnOpen,
00654     IN BOOLEAN EffectiveOnly,
00655     IN SECURITY_IMPERSONATION_LEVEL ImpersonationLevel
00656     )
00657 
00658 <span class="comment">/*++</span>
00659 <span class="comment"></span>
00660 <span class="comment">Routine Description:</span>
00661 <span class="comment"></span>
00662 <span class="comment">    This routine sets up the specified thread so that it is impersonating</span>
00663 <span class="comment">    the specified client.  This will result in the reference count of the</span>
00664 <span class="comment">    token representing the client being incremented to reflect the new</span>
00665 <span class="comment">    reference.</span>
00666 <span class="comment"></span>
00667 <span class="comment">    If the thread is currently impersonating a client, that token will be</span>
00668 <span class="comment">    dereferenced.</span>
00669 <span class="comment"></span>
00670 <span class="comment"></span>
00671 <span class="comment"></span>
00672 <span class="comment">Arguments:</span>
00673 <span class="comment"></span>
00674 <span class="comment">    Thread - points to the thread which is going to impersonate a client.</span>
00675 <span class="comment"></span>
00676 <span class="comment">    Token - Points to the token to be assigned as the impersonation token.</span>
00677 <span class="comment">        This does NOT have to be a TokenImpersonation type token.  This</span>
00678 <span class="comment">        allows direct reference of client process's primary tokens.</span>
00679 <span class="comment"></span>
00680 <span class="comment">    CopyOnOpen - If TRUE, indicates the token is considered to be private</span>
00681 <span class="comment">        by the assigner and should be copied if opened.  For example, a</span>
00682 <span class="comment">        session layer may be using a token to represent a client's context.</span>
00683 <span class="comment">        If the session is trying to synchronize the context of the client,</span>
00684 <span class="comment">        then user mode code should not be given direct access to the session</span>
00685 <span class="comment">        layer's token.</span>
00686 <span class="comment"></span>
00687 <span class="comment">        Basically, session layers should always specify TRUE for this, while</span>
00688 <span class="comment">        tokens assigned by the server itself (handle based) should specify</span>
00689 <span class="comment">        FALSE.</span>
00690 <span class="comment"></span>
00691 <span class="comment"></span>
00692 <span class="comment">    EffectiveOnly - Is a boolean value to be assigned as the</span>
00693 <span class="comment">        Thread-&gt;ImpersonationInfo-&gt;EffectiveOnly field value for the</span>
00694 <span class="comment">        impersonation.  A value of FALSE indicates the server is allowed</span>
00695 <span class="comment">        to enable currently disabled groups and privileges.</span>
00696 <span class="comment"></span>
00697 <span class="comment">    ImpersonationLevel - Is the impersonation level that the server is allowed</span>
00698 <span class="comment">        to access the token with.</span>
00699 <span class="comment"></span>
00700 <span class="comment"></span>
00701 <span class="comment">Return Value:</span>
00702 <span class="comment"></span>
00703 <span class="comment">    STATUS_SUCCESS - Indicates the call completed successfully.</span>
00704 <span class="comment"></span>
00705 <span class="comment"></span>
00706 <span class="comment">--*/</span>
00707 
00708 {
00709 
00710     <a class="code" href="../../d5/d1/struct__PS__IMPERSONATION__INFORMATION.html">PPS_IMPERSONATION_INFORMATION</a>
00711         NewClient;
00712 
00713     PACCESS_TOKEN
00714         OldToken;
00715 
00716     PACCESS_TOKEN NewerToken ;
00717     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
00718     <a class="code" href="../../d6/d1/struct__PS__JOB__TOKEN__FILTER.html">PPS_JOB_TOKEN_FILTER</a> <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a> ;
00719     BOOLEAN DontRefToken = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
00720 
00721     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Thread-&gt;Tcb.Header.Type == <a class="code" href="../../d4/d9/ke_8h.html#a402a163">ThreadObject</a> );
00722 
00723 
00724     <span class="comment">//</span>
00725     <span class="comment">//  Lock the process security fields</span>
00726     <span class="comment">//</span>
00727 
00728     <a class="code" href="../../d1/d9/ps_8h.html#a21">PsLockProcessSecurityFields</a>();
00729 
00730 
00731     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>)) {
00732 
00733         <span class="comment">//</span>
00734         <span class="comment">// This is a request to revert to self.</span>
00735         <span class="comment">// Clean up any client information.</span>
00736         <span class="comment">//</span>
00737 
00738         <span class="keywordflow">if</span> ( Thread-&gt;ActiveImpersonationInfo ) {
00739 
00740             OldToken = Thread-&gt;ImpersonationInfo-&gt;Token;
00741             Thread-&gt;ActiveImpersonationInfo = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00742         } <span class="keywordflow">else</span> {
00743             OldToken = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00744         }
00745 
00746     } <span class="keywordflow">else</span> {
00747 
00748         <span class="comment">//</span>
00749         <span class="comment">// Check if we're allowed to impersonate based on the job</span>
00750         <span class="comment">// restrictions:</span>
00751         <span class="comment">//</span>
00752 
00753         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS ;
00754 
00755         <span class="keywordflow">if</span> ( Thread-&gt;ThreadsProcess-&gt;Job ) {
00756 
00757             <span class="keywordflow">if</span> ( ( Thread-&gt;ThreadsProcess-&gt;Job-&gt;SecurityLimitFlags &amp; JOB_OBJECT_SECURITY_NO_ADMIN ) &amp;&amp;
00758                  ( <a class="code" href="../../d4/d3/token_8c.html#a4">SeTokenIsAdmin</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> ) ) ) {
00759 
00760                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED ;
00761 
00762             }
00763 
00764             <span class="keywordflow">if</span> ( ( Thread-&gt;ThreadsProcess-&gt;Job-&gt;SecurityLimitFlags &amp; JOB_OBJECT_SECURITY_RESTRICTED_TOKEN ) &amp;&amp;
00765                  ( !<a class="code" href="../../d4/d3/token_8c.html#a5">SeTokenIsRestricted</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> ) ) )
00766             {
00767                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED ;
00768             }
00769 
00770             <span class="keywordflow">if</span> ( Thread-&gt;ThreadsProcess-&gt;Job-&gt;Filter )
00771             {
00772                 <span class="comment">//</span>
00773                 <span class="comment">// Filter installed.  Need to create a restricted token</span>
00774                 <span class="comment">// dynamically.</span>
00775                 <span class="comment">//</span>
00776                 <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a> = Thread-&gt;ThreadsProcess-&gt;Job-&gt;Filter ;
00777 
00778                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d3/tokendup_8c.html#a9">SeFastFilterToken</a>(
00779                                 <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,
00780                                 <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00781                                 0,
00782                                 <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedGroupCount,
00783                                 <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedGroups,
00784                                 <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedPrivilegeCount,
00785                                 <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedPrivileges,
00786                                 <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedSidCount,
00787                                 <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedSids,
00788                                 <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedSidsLength,
00789                                 &amp;NewerToken );
00790 
00791                 <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) )
00792                 {
00793                     DontRefToken = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
00794 
00795                     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> = NewerToken ;
00796                 }
00797 
00798             }
00799         }
00800 
00801         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) )
00802         {
00803             <a class="code" href="../../d1/d9/ps_8h.html#a22">PsFreeProcessSecurityFields</a>();
00804 
00805             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
00806         }
00807 
00808         <span class="comment">//</span>
00809         <span class="comment">// If we are already impersonating someone,</span>
00810         <span class="comment">// use the already allocated block.  This avoids</span>
00811         <span class="comment">// an alloc and a free.</span>
00812         <span class="comment">//</span>
00813 
00814         <span class="keywordflow">if</span> ( Thread-&gt;ActiveImpersonationInfo ) {
00815 
00816             <span class="comment">//</span>
00817             <span class="comment">// capture the old token pointer.</span>
00818             <span class="comment">// We'll dereference it after unlocking the security fields.</span>
00819             <span class="comment">//</span>
00820 
00821             OldToken = Thread-&gt;ImpersonationInfo-&gt;Token;
00822             NewClient = Thread-&gt;ImpersonationInfo;
00823 
00824         } <span class="keywordflow">else</span> {
00825 
00826             OldToken = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00827 
00828             <span class="keywordflow">if</span> ( Thread-&gt;ImpersonationInfo ) {
00829                 NewClient = Thread-&gt;ImpersonationInfo;
00830             } <span class="keywordflow">else</span> {
00831 
00832                 <span class="comment">//</span>
00833                 <span class="comment">// Allocate and set up the Client block</span>
00834                 <span class="comment">//</span>
00835 
00836                 NewClient = (<a class="code" href="../../d5/d1/struct__PS__IMPERSONATION__INFORMATION.html">PPS_IMPERSONATION_INFORMATION</a>)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
00837                                 <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00838                                 <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d1/struct__PS__IMPERSONATION__INFORMATION.html">PS_IMPERSONATION_INFORMATION</a>),
00839                                 'mIsP');
00840 
00841                 <span class="keywordflow">if</span> (NewClient == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00842 
00843                     <a class="code" href="../../d1/d9/ps_8h.html#a22">PsFreeProcessSecurityFields</a>();
00844 
00845                     <span class="keywordflow">return</span> STATUS_NO_MEMORY ;
00846 
00847                 }
00848 
00849                 Thread-&gt;ImpersonationInfo = NewClient;
00850             }
00851         }
00852 
00853         NewClient-&gt;<a class="code" href="../../d5/d1/struct__PS__IMPERSONATION__INFORMATION.html#o3">ImpersonationLevel</a> = ImpersonationLevel;
00854         NewClient-&gt;<a class="code" href="../../d5/d1/struct__PS__IMPERSONATION__INFORMATION.html#o2">EffectiveOnly</a> = EffectiveOnly;
00855         NewClient-&gt;<a class="code" href="../../d5/d1/struct__PS__IMPERSONATION__INFORMATION.html#o1">CopyOnOpen</a> = CopyOnOpen;
00856         NewClient-&gt;<a class="code" href="../../d5/d1/struct__PS__IMPERSONATION__INFORMATION.html#o0">Token</a> = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
00857         Thread-&gt;ActiveImpersonationInfo = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00858 
00859         <span class="keywordflow">if</span> ( !DontRefToken )
00860         {
00861             <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(NewClient-&gt;<a class="code" href="../../d5/d1/struct__PS__IMPERSONATION__INFORMATION.html#o0">Token</a>);
00862         }
00863     }
00864 
00865     <span class="comment">//</span>
00866     <span class="comment">//  Release the security fields</span>
00867     <span class="comment">//</span>
00868 
00869     <a class="code" href="../../d1/d9/ps_8h.html#a22">PsFreeProcessSecurityFields</a>();
00870 
00871 
00872     <span class="comment">//</span>
00873     <span class="comment">// Free the old client token, if necessary.</span>
00874     <span class="comment">//</span>
00875 
00876     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( OldToken )) {
00877 
00878         <a class="code" href="../../d1/d9/ps_8h.html#a26">PsDereferenceImpersonationToken</a>( OldToken );
00879     }
00880 
00881 
00882     <span class="keywordflow">return</span> STATUS_SUCCESS ;
00883 
00884 }
00885 
00886 
00887 BOOLEAN
<a name="l00888"></a><a class="code" href="../../d6/d5/ps_2security_8c.html#a7">00888</a> <a class="code" href="../../d6/d5/ps_2security_8c.html#a7">PsDisableImpersonation</a>(
00889     IN <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread,
00890     IN PSE_IMPERSONATION_STATE ImpersonationState
00891     )
00892 
00893 <span class="comment">/*++</span>
00894 <span class="comment"></span>
00895 <span class="comment">Routine Description:</span>
00896 <span class="comment"></span>
00897 <span class="comment">    This routine temporarily disables the impersonation of a thread.</span>
00898 <span class="comment">    The impersonation state is saved for quick replacement later.  The</span>
00899 <span class="comment">    impersonation token is left referenced and a pointer to it is held</span>
00900 <span class="comment">    in the IMPERSONATION_STATE data structure.</span>
00901 <span class="comment"></span>
00902 <span class="comment">    PsRestoreImpersonation() must be used after this routine is called.</span>
00903 <span class="comment"></span>
00904 <span class="comment"></span>
00905 <span class="comment"></span>
00906 <span class="comment">Arguments:</span>
00907 <span class="comment"></span>
00908 <span class="comment">    Thread - points to the thread whose impersonation (if any) is to</span>
00909 <span class="comment">        be temporarily disabled.</span>
00910 <span class="comment"></span>
00911 <span class="comment">    ImpersonationState - receives the current impersonation information,</span>
00912 <span class="comment">        including a pointer to the impersonation token.</span>
00913 <span class="comment"></span>
00914 <span class="comment"></span>
00915 <span class="comment">Return Value:</span>
00916 <span class="comment"></span>
00917 <span class="comment">    TRUE - Indicates the impersonation state has been saved and the</span>
00918 <span class="comment">        impersonation has been temporarily disabled.</span>
00919 <span class="comment"></span>
00920 <span class="comment">    FALSE - Indicates the specified thread was not impersonating a client.</span>
00921 <span class="comment">       No action has been taken.</span>
00922 <span class="comment"></span>
00923 <span class="comment">--*/</span>
00924 
00925 {
00926 
00927 
00928     <a class="code" href="../../d5/d1/struct__PS__IMPERSONATION__INFORMATION.html">PPS_IMPERSONATION_INFORMATION</a>
00929         OldClient;
00930 
00931     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Thread-&gt;Tcb.Header.Type == <a class="code" href="../../d4/d9/ke_8h.html#a402a163">ThreadObject</a> );
00932 
00933     <span class="comment">//</span>
00934     <span class="comment">//  Lock the process security fields</span>
00935     <span class="comment">//</span>
00936 
00937     <a class="code" href="../../d1/d9/ps_8h.html#a21">PsLockProcessSecurityFields</a>();
00938 
00939     <span class="comment">//</span>
00940     <span class="comment">//  Capture the impersonation information (if there is any).</span>
00941     <span class="comment">//</span>
00942 
00943     <span class="keywordflow">if</span> ( Thread-&gt;ActiveImpersonationInfo ) {
00944 
00945         OldClient = Thread-&gt;ImpersonationInfo;
00946         ImpersonationState-&gt;Level         = OldClient-&gt;<a class="code" href="../../d5/d1/struct__PS__IMPERSONATION__INFORMATION.html#o3">ImpersonationLevel</a>;
00947         ImpersonationState-&gt;EffectiveOnly = OldClient-&gt;<a class="code" href="../../d5/d1/struct__PS__IMPERSONATION__INFORMATION.html#o2">EffectiveOnly</a>;
00948         ImpersonationState-&gt;CopyOnOpen    = OldClient-&gt;<a class="code" href="../../d5/d1/struct__PS__IMPERSONATION__INFORMATION.html#o1">CopyOnOpen</a>;
00949         ImpersonationState-&gt;Token         = OldClient-&gt;<a class="code" href="../../d5/d1/struct__PS__IMPERSONATION__INFORMATION.html#o0">Token</a>;
00950     } <span class="keywordflow">else</span> {
00951 
00952         <span class="comment">//</span>
00953         <span class="comment">// Not impersonating.  Just make up some values.</span>
00954         <span class="comment">// The NULL for the token indicates we aren't impersonating.</span>
00955         <span class="comment">//</span>
00956 
00957         OldClient = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00958         ImpersonationState-&gt;Level         = SecurityAnonymous;
00959         ImpersonationState-&gt;EffectiveOnly = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00960         ImpersonationState-&gt;CopyOnOpen    = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00961         ImpersonationState-&gt;Token         = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00962     }
00963 
00964     <span class="comment">//</span>
00965     <span class="comment">// Clear the Client field to indicate the thread is not impersonating.</span>
00966     <span class="comment">//</span>
00967 
00968     Thread-&gt;ActiveImpersonationInfo = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00969 
00970 
00971     <span class="comment">//</span>
00972     <span class="comment">//  Release the security fields</span>
00973     <span class="comment">//</span>
00974 
00975     <a class="code" href="../../d1/d9/ps_8h.html#a22">PsFreeProcessSecurityFields</a>();
00976 
00977 
00978     <span class="keywordflow">if</span> ( OldClient ) {
00979 
00980         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00981 
00982     } <span class="keywordflow">else</span> {
00983         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00984     }
00985 
00986 }
00987 
00988 
00989 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00990"></a><a class="code" href="../../d6/d5/ps_2security_8c.html#a8">00990</a> <a class="code" href="../../d6/d5/ps_2security_8c.html#a8">PsRestoreImpersonation</a>(
00991     IN <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread,
00992     IN PSE_IMPERSONATION_STATE ImpersonationState
00993     )
00994 
00995 <span class="comment">/*++</span>
00996 <span class="comment"></span>
00997 <span class="comment">Routine Description:</span>
00998 <span class="comment"></span>
00999 <span class="comment">    This routine restores an impersonation that has been temporarily disabled</span>
01000 <span class="comment">    using PsDisableImpersonation().</span>
01001 <span class="comment"></span>
01002 <span class="comment">    Notice that if this routine finds the thread is already impersonating</span>
01003 <span class="comment">    (again), then restoring the temporarily disabled impersonation will cause</span>
01004 <span class="comment">    the current impersonation to be abandoned.</span>
01005 <span class="comment"></span>
01006 <span class="comment"></span>
01007 <span class="comment"></span>
01008 <span class="comment">Arguments:</span>
01009 <span class="comment"></span>
01010 <span class="comment">    Thread - points to the thread whose impersonation is to be restored.</span>
01011 <span class="comment"></span>
01012 <span class="comment">    ImpersontionState - receives the current impersontion information,</span>
01013 <span class="comment">        including a pointer ot the impersonation token.</span>
01014 <span class="comment"></span>
01015 <span class="comment"></span>
01016 <span class="comment">Return Value:</span>
01017 <span class="comment"></span>
01018 <span class="comment">    TRUE - Indicates the impersonation state has been saved and the</span>
01019 <span class="comment">        impersonation has been temporarily disabled.</span>
01020 <span class="comment"></span>
01021 <span class="comment">    FALSE - Indicates the specified thread was not impersonating a client.</span>
01022 <span class="comment">       No action has been taken.</span>
01023 <span class="comment"></span>
01024 <span class="comment">--*/</span>
01025 
01026 {
01027 
01028 
01029     <span class="comment">//</span>
01030     <span class="comment">// The processing for restore is identical to that for Impersonation,</span>
01031     <span class="comment">// except that the token's reference count will be incremented (and</span>
01032     <span class="comment">// so we need to do one dereference).</span>
01033 
01034     <a class="code" href="../../d6/d5/ps_2security_8c.html#a6">PsImpersonateClient</a>(
01035         Thread,
01036         ImpersonationState-&gt;Token,
01037         ImpersonationState-&gt;CopyOnOpen,
01038         ImpersonationState-&gt;EffectiveOnly,
01039         ImpersonationState-&gt;Level
01040         );
01041 
01042 
01043     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( ImpersonationState-&gt;Token );
01044 
01045     <span class="keywordflow">return</span>;
01046 
01047 }
01048 
01049 
01050 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01051"></a><a class="code" href="../../d6/d5/ps_2security_8c.html#a9">01051</a> <a class="code" href="../../d6/d5/ps_2security_8c.html#a9">PsRevertToSelf</a>( )
01052 
01053 <span class="comment">/*++</span>
01054 <span class="comment"></span>
01055 <span class="comment">Routine Description:</span>
01056 <span class="comment"></span>
01057 <span class="comment">    This routine causes the calling thread to discontinue</span>
01058 <span class="comment">    impersonating a client.  If the thread is not currently</span>
01059 <span class="comment">    impersonating a client, no action is taken.</span>
01060 <span class="comment"></span>
01061 <span class="comment">Arguments:</span>
01062 <span class="comment"></span>
01063 <span class="comment">    None.</span>
01064 <span class="comment"></span>
01065 <span class="comment">Return Value:</span>
01066 <span class="comment"></span>
01067 <span class="comment">    None.</span>
01068 <span class="comment"></span>
01069 <span class="comment">--*/</span>
01070 
01071 {
01072     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>
01073         Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
01074 
01075     PACCESS_TOKEN OldToken;
01076 
01077     <span class="comment">//</span>
01078     <span class="comment">//  Lock the process security fields</span>
01079     <span class="comment">//</span>
01080 
01081     <a class="code" href="../../d1/d9/ps_8h.html#a21">PsLockProcessSecurityFields</a>();
01082 
01083     <span class="comment">//</span>
01084     <span class="comment">//  See if the thread is impersonating a client</span>
01085     <span class="comment">//  and dereference that token if so.</span>
01086     <span class="comment">//</span>
01087 
01088     <span class="keywordflow">if</span> ( Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o35">ActiveImpersonationInfo</a> ) {
01089 
01090         Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o35">ActiveImpersonationInfo</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01091         OldToken = Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o17">ImpersonationInfo</a>-&gt;<a class="code" href="../../d5/d1/struct__PS__IMPERSONATION__INFORMATION.html#o0">Token</a>;
01092     } <span class="keywordflow">else</span> {
01093         OldToken = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01094     }
01095 
01096 
01097     <span class="comment">//</span>
01098     <span class="comment">//  Release the security fields</span>
01099     <span class="comment">//</span>
01100 
01101     <a class="code" href="../../d1/d9/ps_8h.html#a22">PsFreeProcessSecurityFields</a>();
01102 
01103 
01104     <span class="comment">//</span>
01105     <span class="comment">// Free the old client info...</span>
01106     <span class="comment">//</span>
01107 
01108     <span class="keywordflow">if</span> ( OldToken ) {
01109         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( OldToken );
01110     }
01111 
01112     <span class="keywordflow">return</span>;
01113 }
01114 
01115 
01116 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01117"></a><a class="code" href="../../d6/d5/ps_2security_8c.html#a10">01117</a> <a class="code" href="../../d6/d5/ps_2security_8c.html#a10">PspInitializeProcessSecurity</a>(
01118     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Parent OPTIONAL,
01119     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Child
01120     )
01121 
01122 <span class="comment">/*++</span>
01123 <span class="comment"></span>
01124 <span class="comment">Routine Description:</span>
01125 <span class="comment"></span>
01126 <span class="comment">    This function initializes a new process's security fields, including</span>
01127 <span class="comment">    the assignment of a new primary token.</span>
01128 <span class="comment"></span>
01129 <span class="comment">    The child process is assumed to not yet have been inserted into</span>
01130 <span class="comment">    an object table.</span>
01131 <span class="comment"></span>
01132 <span class="comment">    NOTE: IT IS EXPECTED THAT THIS SERVICE WILL BE CALLED WITH A NULL</span>
01133 <span class="comment">          PARENT PROCESS POINTER EXACTLY ONCE - FOR THE INITIAL SYSTEM</span>
01134 <span class="comment">          PROCESS.</span>
01135 <span class="comment"></span>
01136 <span class="comment"></span>
01137 <span class="comment">Arguments:</span>
01138 <span class="comment"></span>
01139 <span class="comment">    Parent - An optional pointer to the process being used as the parent</span>
01140 <span class="comment">        of the new process.  If this value is NULL, then the process is</span>
01141 <span class="comment">        assumed to be the initial system process, and the boot token is</span>
01142 <span class="comment">        assigned rather than a duplicate of the parent process's primary</span>
01143 <span class="comment">        token.</span>
01144 <span class="comment"></span>
01145 <span class="comment">    Child - Supplies the address of the process being initialized.  This</span>
01146 <span class="comment">        process does not yet require security field contention protection.</span>
01147 <span class="comment">        In particular, the security fields may be accessed without first</span>
01148 <span class="comment">        acquiring the process security fields lock.</span>
01149 <span class="comment"></span>
01150 <span class="comment"></span>
01151 <span class="comment"></span>
01152 <span class="comment">Return Value:</span>
01153 <span class="comment"></span>
01154 <span class="comment"></span>
01155 <span class="comment">--*/</span>
01156 
01157 {
01158     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
01159         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01160 
01161 
01162     <span class="comment">//</span>
01163     <span class="comment">// Assign the primary token</span>
01164     <span class="comment">//</span>
01165 
01166     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(Parent)) {
01167 
01168         <span class="comment">//</span>
01169         <span class="comment">// create the primary token</span>
01170         <span class="comment">// This is a duplicate of the parent's token.</span>
01171         <span class="comment">//</span>
01172 
01173         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d3/token_8c.html#a13">SeSubProcessToken</a>(
01174                      Parent,
01175                      &amp;Child-&gt;Token
01176                      );
01177 
01178         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01179             Child-&gt;Token = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;       <span class="comment">// Needed to ensure proper deletion</span>
01180         }
01181 
01182     } <span class="keywordflow">else</span> {
01183 
01184         <span class="comment">//</span>
01185         <span class="comment">//  Reference and assign the boot token</span>
01186         <span class="comment">//</span>
01187         <span class="comment">//  The use of a single boot access token assumes there is</span>
01188         <span class="comment">//  exactly one parentless process in the system - the initial</span>
01189         <span class="comment">//  process.  If this ever changes, this code will need to change</span>
01190         <span class="comment">//  to match the new condition (so that a token doesn't end up</span>
01191         <span class="comment">//  being shared by multiple processes.</span>
01192         <span class="comment">//</span>
01193 
01194         Child-&gt;Token = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01195         <a class="code" href="../../d4/d3/token_8c.html#a7">SeAssignPrimaryToken</a>( Child, <a class="code" href="../../d0/d1/psinit_8c.html#a14">PspBootAccessToken</a> );
01196         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01197 
01198 
01199     }
01200 
01201     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01202 
01203 }
01204 
01205 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01206"></a><a class="code" href="../../d6/d5/ps_2security_8c.html#a11">01206</a> <a class="code" href="../../d6/d5/ps_2security_8c.html#a11">PspDeleteProcessSecurity</a>(
01207     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
01208     )
01209 
01210 <span class="comment">/*++</span>
01211 <span class="comment"></span>
01212 <span class="comment">Routine Description:</span>
01213 <span class="comment"></span>
01214 <span class="comment">    This function cleans up a process's security fields as part of process</span>
01215 <span class="comment">    deletion.  It is assumed no other references to the process can occur</span>
01216 <span class="comment">    during or after a call to this routine.  This enables us to reference</span>
01217 <span class="comment">    the process security fields without acquiring the lock protecting those</span>
01218 <span class="comment">    fields.</span>
01219 <span class="comment"></span>
01220 <span class="comment">    NOTE: It may be desirable to add auditing capability to this routine</span>
01221 <span class="comment">          at some point.</span>
01222 <span class="comment"></span>
01223 <span class="comment"></span>
01224 <span class="comment">Arguments:</span>
01225 <span class="comment"></span>
01226 <span class="comment">    Process - A pointer to the process being deleted.</span>
01227 <span class="comment"></span>
01228 <span class="comment"></span>
01229 <span class="comment">Return Value:</span>
01230 <span class="comment"></span>
01231 <span class="comment">    None.</span>
01232 <span class="comment"></span>
01233 <span class="comment">--*/</span>
01234 
01235 {
01236 
01237 
01238 
01239 
01240     <span class="comment">//</span>
01241     <span class="comment">// If we are deleting a process that didn't successfully complete</span>
01242     <span class="comment">// process initialization, then there may be no token associated</span>
01243     <span class="comment">// with it yet.</span>
01244     <span class="comment">//</span>
01245 
01246     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(Process-&gt;Token)) {
01247         <a class="code" href="../../d4/d3/token_8c.html#a8">SeDeassignPrimaryToken</a>( Process );
01248         Process-&gt;Token = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01249     }
01250 
01251     <span class="keywordflow">return</span>;
01252 }
01253 
01254 
01255 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01256"></a><a class="code" href="../../d6/d5/ps_2security_8c.html#a12">01256</a> <a class="code" href="../../d6/d5/ps_2security_8c.html#a12">PspAssignPrimaryToken</a>(
01257     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
01258     IN HANDLE Token OPTIONAL,
01259     IN PACCESS_TOKEN TokenPointer OPTIONAL
01260     )
01261 
01262 <span class="comment">/*++</span>
01263 <span class="comment"></span>
01264 <span class="comment">Routine Description:</span>
01265 <span class="comment"></span>
01266 <span class="comment">    This function performs the security portions of primary token assignment.</span>
01267 <span class="comment">    It is expected that the proper access to the process and thread objects,</span>
01268 <span class="comment">    as well as necessary privilege, has already been established.</span>
01269 <span class="comment"></span>
01270 <span class="comment">    A primary token can only be replaced if the process has no threads, or</span>
01271 <span class="comment">    has one thread.  This is because the thread objects point to the primary</span>
01272 <span class="comment">    token and must have those pointers updated when the primary token is</span>
01273 <span class="comment">    changed.  This is only expected to be necessary at logon time, when</span>
01274 <span class="comment">    the process is in its infancy and either has zero threads or maybe one</span>
01275 <span class="comment">    inactive thread.</span>
01276 <span class="comment"></span>
01277 <span class="comment">    If the assignment is successful, the old token is dereferenced and the</span>
01278 <span class="comment">    new one is referenced.</span>
01279 <span class="comment"></span>
01280 <span class="comment"></span>
01281 <span class="comment"></span>
01282 <span class="comment">Arguments:</span>
01283 <span class="comment"></span>
01284 <span class="comment">    Process - A pointer to the process whose primary token is being</span>
01285 <span class="comment">        replaced.</span>
01286 <span class="comment"></span>
01287 <span class="comment">    Token - The handle value of the token to be assigned as the primary</span>
01288 <span class="comment">        token.</span>
01289 <span class="comment"></span>
01290 <span class="comment"></span>
01291 <span class="comment">Return Value:</span>
01292 <span class="comment"></span>
01293 <span class="comment">    STATUS_SUCCESS - Indicates the primary token has been successfully</span>
01294 <span class="comment">        replaced.</span>
01295 <span class="comment"></span>
01296 <span class="comment">    STATUS_BAD_TOKEN_TYPE - Indicates the token is not of type TokenPrimary.</span>
01297 <span class="comment"></span>
01298 <span class="comment">    STATUS_TOKEN_IN_USE - Indicates the token is already in use by</span>
01299 <span class="comment">        another process.</span>
01300 <span class="comment"></span>
01301 <span class="comment">    Other status may be returned when attempting to reference the token</span>
01302 <span class="comment">    object.</span>
01303 <span class="comment"></span>
01304 <span class="comment">--*/</span>
01305 
01306 {
01307     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
01308         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01309 
01310     PACCESS_TOKEN
01311         NewToken,
01312         OldToken;
01313 
01314     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>
01315         PreviousMode;
01316 
01317 
01318     <span class="keywordflow">if</span> ( TokenPointer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> )
01319     {
01320         PreviousMode = KeGetPreviousMode();
01321 
01322         <span class="comment">//</span>
01323         <span class="comment">// Reference the specified token, and make sure it can be assigned</span>
01324         <span class="comment">// as a primary token.</span>
01325         <span class="comment">//</span>
01326 
01327         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a> (
01328                     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,
01329                     TOKEN_ASSIGN_PRIMARY,
01330                     <a class="code" href="../../d0/d5/se_8h.html#a17">SeTokenObjectType</a>(),
01331                     PreviousMode,
01332                     (PVOID *)&amp;NewToken,
01333                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01334                     );
01335 
01336         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
01337             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01338         }
01339     }
01340     <span class="keywordflow">else</span>
01341     {
01342         NewToken = TokenPointer ;
01343     }
01344 
01345 
01346     <span class="comment">//</span>
01347     <span class="comment">//  Lock the process security fields.</span>
01348     <span class="comment">//</span>
01349 
01350     <a class="code" href="../../d1/d9/ps_8h.html#a21">PsLockProcessSecurityFields</a>();
01351 
01352 
01353 
01354 
01355 
01356     <span class="comment">//</span>
01357     <span class="comment">// This routine makes sure the NewToken is suitable for assignment</span>
01358     <span class="comment">// as a primary token.</span>
01359     <span class="comment">//</span>
01360 
01361     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d3/token_8c.html#a9">SeExchangePrimaryToken</a>( Process, NewToken, &amp;OldToken );
01362 
01363 
01364     <span class="comment">//</span>
01365     <span class="comment">//  Release the process security fields</span>
01366     <span class="comment">//</span>
01367 
01368     <a class="code" href="../../d1/d9/ps_8h.html#a22">PsFreeProcessSecurityFields</a>();
01369 
01370     <span class="comment">//</span>
01371     <span class="comment">// Free the old token (we don't need it).</span>
01372     <span class="comment">// This can't be done while the security fields are locked.</span>
01373     <span class="comment">//</span>
01374 
01375     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01376 
01377         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( OldToken );
01378     }
01379 
01380     <span class="comment">//</span>
01381     <span class="comment">// Undo the handle reference</span>
01382     <span class="comment">//</span>
01383 
01384     <span class="keywordflow">if</span> ( TokenPointer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> )
01385     {
01386         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( NewToken );
01387     }
01388 
01389 
01390     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01391 }
01392 
01393 
01394 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01395"></a><a class="code" href="../../d6/d5/ps_2security_8c.html#a13">01395</a> <a class="code" href="../../d6/d5/ps_2security_8c.html#a13">PspInitializeThreadSecurity</a>(
01396     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
01397     IN <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread
01398     )
01399 
01400 <span class="comment">/*++</span>
01401 <span class="comment"></span>
01402 <span class="comment">Routine Description:</span>
01403 <span class="comment"></span>
01404 <span class="comment">    This function initializes a new thread's security fields.</span>
01405 <span class="comment"></span>
01406 <span class="comment"></span>
01407 <span class="comment">Arguments:</span>
01408 <span class="comment"></span>
01409 <span class="comment">    Process - Points to the process the thread belongs to.</span>
01410 <span class="comment"></span>
01411 <span class="comment">    Thread - Points to the thread object being initialized.</span>
01412 <span class="comment"></span>
01413 <span class="comment"></span>
01414 <span class="comment">Return Value:</span>
01415 <span class="comment"></span>
01416 <span class="comment">    None.</span>
01417 <span class="comment"></span>
01418 <span class="comment">--*/</span>
01419 
01420 {
01421 
01422 
01423     <span class="comment">//</span>
01424     <span class="comment">// Initially not impersonating anyone.</span>
01425     <span class="comment">//</span>
01426 
01427     Thread-&gt;ImpersonationInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01428     Thread-&gt;ActiveImpersonationInfo = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01429 
01430     <span class="keywordflow">return</span>;
01431 
01432 }
01433 
01434 
01435 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01436"></a><a class="code" href="../../d6/d5/ps_2security_8c.html#a14">01436</a> <a class="code" href="../../d6/d5/ps_2security_8c.html#a14">PspDeleteThreadSecurity</a>(
01437     IN <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread
01438     )
01439 
01440 <span class="comment">/*++</span>
01441 <span class="comment"></span>
01442 <span class="comment">Routine Description:</span>
01443 <span class="comment"></span>
01444 <span class="comment">    This function cleans up a thread's security fields as part of thread</span>
01445 <span class="comment">    deletion.  It is assumed no other references to the thread can occur</span>
01446 <span class="comment">    during or after a call to this routine, so no locking is necessary</span>
01447 <span class="comment">    to access the thread security fields.</span>
01448 <span class="comment"></span>
01449 <span class="comment"></span>
01450 <span class="comment">Arguments:</span>
01451 <span class="comment"></span>
01452 <span class="comment">    Thread - A pointer to the thread being deleted.</span>
01453 <span class="comment"></span>
01454 <span class="comment"></span>
01455 <span class="comment">Return Value:</span>
01456 <span class="comment"></span>
01457 <span class="comment">    None.</span>
01458 <span class="comment"></span>
01459 <span class="comment">--*/</span>
01460 
01461 {
01462 
01463     <span class="comment">//</span>
01464     <span class="comment">// clean-up client information, if there is any.</span>
01465     <span class="comment">//</span>
01466 
01467     <span class="keywordflow">if</span> ( Thread-&gt;ActiveImpersonationInfo ) {
01468         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Thread-&gt;ImpersonationInfo-&gt;Token );
01469     }
01470 
01471     <span class="keywordflow">if</span> ( Thread-&gt;ImpersonationInfo ) {
01472         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( Thread-&gt;ImpersonationInfo );
01473         Thread-&gt;ActiveImpersonationInfo = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01474         Thread-&gt;ImpersonationInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01475     }
01476 
01477     <span class="keywordflow">return</span>;
01478 
01479 }
01480 
01481 
01482 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01483"></a><a class="code" href="../../d6/d5/ps_2security_8c.html#a15">01483</a> <a class="code" href="../../d6/d5/ps_2security_8c.html#a15">PsAssignImpersonationToken</a>(
01484     IN <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread,
01485     IN HANDLE Token
01486     )
01487 
01488 <span class="comment">/*++</span>
01489 <span class="comment"></span>
01490 <span class="comment">Routine Description:</span>
01491 <span class="comment"></span>
01492 <span class="comment">    This function performs the security portions of establishing an</span>
01493 <span class="comment">    impersonation token.  This routine is expected to be used only in</span>
01494 <span class="comment">    the case where the subject has asked for impersonation explicitly</span>
01495 <span class="comment">    providing an impersonation token.  Other services are provided for</span>
01496 <span class="comment">    use by communication session layers that need to establish an</span>
01497 <span class="comment">    impersonation on a server's behalf.</span>
01498 <span class="comment"></span>
01499 <span class="comment">    It is expected that the proper access to the thread object has already</span>
01500 <span class="comment">    been established.</span>
01501 <span class="comment"></span>
01502 <span class="comment">    The following rules apply:</span>
01503 <span class="comment"></span>
01504 <span class="comment">         1) The caller must have TOKEN_IMPERSONATE access to the token</span>
01505 <span class="comment">            for any action to be taken.</span>
01506 <span class="comment"></span>
01507 <span class="comment">         2) If the token may NOT be used for impersonation (e.g., not an</span>
01508 <span class="comment">            impersonation token) no action is taken.</span>
01509 <span class="comment"></span>
01510 <span class="comment">         3) Otherwise, any existing impersonation token is dereferenced and</span>
01511 <span class="comment">            the new token is established as the impersonation token.</span>
01512 <span class="comment"></span>
01513 <span class="comment"></span>
01514 <span class="comment"></span>
01515 <span class="comment">Arguments:</span>
01516 <span class="comment"></span>
01517 <span class="comment">    Thread - A pointer to the thread whose impersonation token is being</span>
01518 <span class="comment">        set.</span>
01519 <span class="comment"></span>
01520 <span class="comment">    Token - The handle value of the token to be assigned as the impersonation</span>
01521 <span class="comment">        token.  If this value is NULL, then current impersonation (if any)</span>
01522 <span class="comment">        is terminated and no new impersonation is established.</span>
01523 <span class="comment"></span>
01524 <span class="comment"></span>
01525 <span class="comment">Return Value:</span>
01526 <span class="comment"></span>
01527 <span class="comment">    STATUS_SUCCESS - Indicates the primary token has been successfully</span>
01528 <span class="comment">        replaced.</span>
01529 <span class="comment"></span>
01530 <span class="comment">    STATUS_BAD_TOKEN_TYPE - Indicates the token is not of type</span>
01531 <span class="comment">        TokenImpersonation.</span>
01532 <span class="comment"></span>
01533 <span class="comment">    Other status may be returned when attempting to reference the token</span>
01534 <span class="comment">    object.</span>
01535 <span class="comment"></span>
01536 <span class="comment">--*/</span>
01537 
01538 {
01539     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
01540         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01541 
01542     PACCESS_TOKEN
01543         NewToken, NewerToken ;
01544 
01545     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>
01546         PreviousMode;
01547 
01548     SECURITY_IMPERSONATION_LEVEL
01549         ImpersonationLevel;
01550 
01551     <a class="code" href="../../d6/d1/struct__PS__JOB__TOKEN__FILTER.html">PPS_JOB_TOKEN_FILTER</a> <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a> ;
01552 
01553     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ThreadProcess;
01554     BOOLEAN  AttachedToProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01555 
01556     PreviousMode = KeGetPreviousMode();
01557 
01558     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>)) {
01559 
01560         NewToken = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01561 
01562         <span class="comment">//</span>
01563         <span class="comment">// Don't care what value ImpersonationLevel has, it won't</span>
01564         <span class="comment">// be used.</span>
01565         <span class="comment">//</span>
01566 
01567     } <span class="keywordflow">else</span> {
01568 
01569         <span class="comment">//</span>
01570         <span class="comment">// Reference the specified token for TOKEN_IMPERSONATE access</span>
01571         <span class="comment">//</span>
01572 
01573         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a> (
01574                     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,
01575                     TOKEN_IMPERSONATE,
01576                     <a class="code" href="../../d0/d5/se_8h.html#a17">SeTokenObjectType</a>(),
01577                     PreviousMode,
01578                     (PVOID *)&amp;NewToken,
01579                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01580                     );
01581 
01582         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
01583             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01584         }
01585 
01586         <span class="comment">//</span>
01587         <span class="comment">// Make sure the token is an impersonation token.</span>
01588         <span class="comment">//</span>
01589 
01590         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d3/token_8c.html#a3">SeTokenType</a>( NewToken ) != TokenImpersonation ) {
01591             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( NewToken );
01592             <span class="keywordflow">return</span> STATUS_BAD_TOKEN_TYPE;
01593         }
01594 
01595         <span class="keywordflow">if</span> ( Thread-&gt;ThreadsProcess-&gt;Job ) {
01596 
01597             <span class="keywordflow">if</span> ( ( Thread-&gt;ThreadsProcess-&gt;Job-&gt;SecurityLimitFlags &amp; JOB_OBJECT_SECURITY_NO_ADMIN ) &amp;&amp;
01598                  ( <a class="code" href="../../d4/d3/token_8c.html#a4">SeTokenIsAdmin</a>( NewToken ) ) ) {
01599 
01600                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( NewToken );
01601 
01602                 <span class="keywordflow">return</span> STATUS_ACCESS_DENIED ;
01603 
01604             }
01605 
01606             <span class="keywordflow">if</span> ( ( Thread-&gt;ThreadsProcess-&gt;Job-&gt;SecurityLimitFlags &amp; JOB_OBJECT_SECURITY_RESTRICTED_TOKEN ) &amp;&amp;
01607                  ( !<a class="code" href="../../d4/d3/token_8c.html#a5">SeTokenIsRestricted</a>( NewToken ) ) )
01608             {
01609                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( NewToken );
01610 
01611                 <span class="keywordflow">return</span> STATUS_ACCESS_DENIED ;
01612             }
01613 
01614             <span class="keywordflow">if</span> ( Thread-&gt;ThreadsProcess-&gt;Job-&gt;Filter )
01615             {
01616                 <span class="comment">//</span>
01617                 <span class="comment">// Filter installed.  Need to create a restricted token</span>
01618                 <span class="comment">// dynamically.</span>
01619                 <span class="comment">//</span>
01620                 <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a> = Thread-&gt;ThreadsProcess-&gt;Job-&gt;Filter ;
01621 
01622                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d3/tokendup_8c.html#a9">SeFastFilterToken</a>(
01623                                 NewToken,
01624                                 PreviousMode,
01625                                 0,
01626                                 <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedGroupCount,
01627                                 <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedGroups,
01628                                 <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedPrivilegeCount,
01629                                 <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedPrivileges,
01630                                 <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedSidCount,
01631                                 <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedSids,
01632                                 <a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>-&gt;CapturedSidsLength,
01633                                 &amp;NewerToken );
01634 
01635                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( NewToken );
01636 
01637                 <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) )
01638                 {
01639                     NewToken = NewerToken ;
01640                 }
01641                 <span class="keywordflow">else</span>
01642                 {
01643                     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
01644                 }
01645 
01646 
01647             }
01648         }
01649 
01650         ImpersonationLevel = <a class="code" href="../../d4/d3/token_8c.html#a6">SeTokenImpersonationLevel</a>( NewToken );
01651     }
01652 
01653     <span class="comment">//</span>
01654     <span class="comment">// The rest can be done by PsImpersonateClient.</span>
01655     <span class="comment">//</span>
01656     <span class="comment">// PsImpersonateClient will reference the passed token</span>
01657     <span class="comment">// on success.</span>
01658     <span class="comment">//</span>
01659 
01660     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d5/ps_2security_8c.html#a6">PsImpersonateClient</a>(
01661                  Thread,
01662                  NewToken,
01663                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,          <span class="comment">// CopyOnOpen</span>
01664                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,          <span class="comment">//EffectiveOnly</span>
01665                  ImpersonationLevel
01666                  );
01667 
01668 
01669     <span class="comment">//</span>
01670     <span class="comment">// dereference the passed token, if there is one.</span>
01671     <span class="comment">//</span>
01672     <span class="comment">// Note that if PsImpersonateClient failed, this will</span>
01673     <span class="comment">// be the final dereference of NewToken/NewerToken,</span>
01674     <span class="comment">// and it will be freed.</span>
01675     <span class="comment">//</span>
01676 
01677     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(NewToken)) {
01678         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( NewToken );
01679     }
01680 
01681     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01682 
01683         <span class="comment">//</span>
01684         <span class="comment">//   Indicate that 'Thread' has started to do impersonation.</span>
01685         <span class="comment">//   This info is useful for GetUserDefaultLCID()</span>
01686         <span class="comment">//</span>
01687 
01688         <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d9/ps_8h.html#a18">IS_SYSTEM_THREAD</a>(Thread)) {
01689 
01690             ThreadProcess = <a class="code" href="../../d1/d9/ps_8h.html#a17">THREAD_TO_PROCESS</a>(Thread);
01691 
01692             <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() != ThreadProcess ) {
01693                 <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a>( &amp;ThreadProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a> );
01694                 AttachedToProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01695             }
01696 
01697             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(NewToken)) {
01698                 ((PTEB)(Thread-&gt;Tcb.Teb))-&gt;ImpersonationLocale = (LCID)-1;
01699                 ((PTEB)(Thread-&gt;Tcb.Teb))-&gt;IsImpersonating = 1;
01700             } <span class="keywordflow">else</span> {
01701                 ((PTEB)(Thread-&gt;Tcb.Teb))-&gt;ImpersonationLocale = (LCID) 0;
01702                 ((PTEB)(Thread-&gt;Tcb.Teb))-&gt;IsImpersonating = 0;
01703             }
01704 
01705             <span class="keywordflow">if</span> (AttachedToProcess) {
01706                 <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
01707             }
01708         }
01709     }
01710 
01711     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01712 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:45 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
