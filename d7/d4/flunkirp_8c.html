<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: flunkirp.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>flunkirp.c File Reference</h1><code>#include "<a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>"</code><br>
<code>#include "<a class="el" href="../../d5/d9/ob_8h-source.html">ob.h</a>"</code><br>
<code>#include &lt;initguid.h&gt;</code><br>

<p>
<a href="../../d8/d3/flunkirp_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/flunkirp_8c.html#a1">DEFINE_GUID</a> (GUID_BOGUS_INTERFACE, 0x00000000L, 0x0000, 0x0000, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PCHAR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/flunkirp_8c.html#a2">KeBugCheckUnicodeToAnsi</a> (IN PUNICODE_STRING UnicodeString, OUT PCHAR AnsiBuffer, IN ULONG MaxAnsiLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/flunkirp_8c.html#a3">IovpAssertIsNewRequest</a> (IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpLastSp OPTIONAL, IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/flunkirp_8c.html#a4">IovpAssertDoAdvanceStatus</a> (IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp, IN NTSTATUS OriginalStatus, IN OUT NTSTATUS *StatusToAdvance)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/flunkirp_8c.html#a5">IovpAssertNewIrps</a> (IN <a class="el" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a> IrpTrackingData, IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp, IN <a class="el" href="../../d9/d1/struct__IOV__STACK__LOCATION.html">PIOV_STACK_LOCATION</a> StackLocationData)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/flunkirp_8c.html#a6">IovpAssertFinalIrpStack</a> (IN <a class="el" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a> IrpTrackingData, IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/flunkirp_8c.html#a7">IovpAssertNewRequest</a> (IN <a class="el" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a> IrpTrackingData, IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpLastSp OPTIONAL, IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp, IN <a class="el" href="../../d9/d1/struct__IOV__STACK__LOCATION.html">PIOV_STACK_LOCATION</a> StackLocationData)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/flunkirp_8c.html#a8">IovpAssertIrpStackDownward</a> (IN <a class="el" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a> IrpTrackingData, IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpLastSp OPTIONAL, IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp, IN <a class="el" href="../../d9/d1/struct__IOV__STACK__LOCATION.html">PIOV_STACK_LOCATION</a> StackLocationData)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/flunkirp_8c.html#a9">IovpAssertIrpStackUpward</a> (IN <a class="el" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a> IrpTrackingData, IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp, IN <a class="el" href="../../d9/d1/struct__IOV__STACK__LOCATION.html">PIOV_STACK_LOCATION</a> StackLocationData, IN BOOLEAN IsNewlyCompleted, IN BOOLEAN RequestFinalized)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/flunkirp_8c.html#a10">IovpAssertIsValidIrpStatus</a> (IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp, IN NTSTATUS <a class="el" href="../../d2/d1/cttoken_8c.html#a18">Status</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/flunkirp_8c.html#a11">IovpThrowChaffAtStartedPdoStack</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/flunkirp_8c.html#a12">IovpThrowBogusSynchronousIrp</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> TopStackLocation, IN OUT OPTIONAL ULONG_PTR Information, IN OUT ULONG_PTR *InformationOut OPTIONAL, IN BOOLEAN IsBogus)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/flunkirp_8c.html#a13">IovpStartObRefMonitoring</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/flunkirp_8c.html#a14">IovpStopObRefMonitoring</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN LONG StartSkew)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/flunkirp_8c.html#a15">IovpIsSystemRestrictedIrp</a> (<a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>PUCHAR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/flunkirp_8c.html#a0">PnPIrpNames</a> []</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a1" doxytag="flunkirp.c::DEFINE_GUID" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> DEFINE_GUID           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">GUID_BOGUS_INTERFACE&nbsp;</td>
          <td class="mdname" nowrap>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>0x00000000L&nbsp;</td>
          <td class="mdname" nowrap>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>0x0000&nbsp;</td>
          <td class="mdname" nowrap>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>0x0000&nbsp;</td>
          <td class="mdname" nowrap>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>0x00&nbsp;</td>
          <td class="mdname" nowrap>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>0x00&nbsp;</td>
          <td class="mdname" nowrap>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>0x00&nbsp;</td>
          <td class="mdname" nowrap>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>0x00&nbsp;</td>
          <td class="mdname" nowrap>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>0x00&nbsp;</td>
          <td class="mdname" nowrap>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>0x00&nbsp;</td>
          <td class="mdname" nowrap>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>0x00&nbsp;</td>
          <td class="mdname" nowrap>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>0x00&nbsp;</td>
          <td class="mdname" nowrap></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="flunkirp.c::IovpAssertDoAdvanceStatus" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IovpAssertDoAdvanceStatus           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpSp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN NTSTATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>OriginalStatus</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT NTSTATUS *&nbsp;</td>
          <td class="mdname" nowrap> <em>StatusToAdvance</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/flunkirp_8c-source.html#l00120">120</a> of file <a class="el" href="../../d8/d3/flunkirp_8c-source.html">flunkirp.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00082">IRP_MJ_PNP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00077">IRP_MJ_POWER</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/trackirp_8c-source.html#l01416">IovpCompleteRequest2()</a>.
<p>
<pre class="fragment"><div>00127              :
00128 
00129      Given an <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> stack pointer, <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> legal to change <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status <span class="keywordflow">for</span>
00130      debug-ability? If so, <span class="keyword">this</span> function determines what <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> status
00131      should be. Note that <span class="keywordflow">for</span> each stack location, <span class="keyword">this</span> function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> iterated
00132      over <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> times where <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> equal to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of drivers who IoSkip'd <span class="keyword">this</span>
00133      location.
00134 
00135   Arguments:
00136 
00137      IrpSp           - Current stack right after complete <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given stack
00138                        location, but before <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> completion routine <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00139                        stack location above has been called.
00140 
00141      OriginalStatus  - The status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> time listed above. Does
00142                        not change over iteration per skipping driver.
00143 
00144      StatusToAdvance - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current status that should be updated.
00145 
00146   Return Value:
00147 
00148      <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status has been adjusted, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
00149 
00150 --*/
00151 {
00152     <span class="keywordflow">switch</span>(IrpSp-&gt;MajorFunction) {
00153 
00154         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a>:
00155         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a35">IRP_MJ_POWER</a>:
00156             <span class="keywordflow">if</span> (((ULONG) OriginalStatus) &lt; 256) {
00157 
00158                 (*StatusToAdvance)++;
00159                 <span class="keywordflow">if</span> ((*StatusToAdvance) == STATUS_PENDING) {
00160                     (*StatusToAdvance)++;
00161                 }
00162                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00163             }
00164             <span class="keywordflow">break</span>;
00165 
00166         <span class="keywordflow">default</span>:
00167             <span class="keywordflow">break</span>;
00168     }
00169     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00170 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="flunkirp.c::IovpAssertFinalIrpStack" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IovpAssertFinalIrpStack           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpTrackingData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpSp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/flunkirp_8c-source.html#l00182">182</a> of file <a class="el" href="../../d8/d3/flunkirp_8c-source.html">flunkirp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/trackirp_8c-source.html#l01416">IovpCompleteRequest2()</a>, and <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02751">IovpSwapSurrogateIrp()</a>.
<p>
<pre class="fragment"><div>00186 {
00187     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!IrpTrackingData-&gt;RefTrackingCount);
00188 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="flunkirp.c::IovpAssertIrpStackDownward" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IovpAssertIrpStackDownward           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpTrackingData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpLastSp&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpSp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d1/struct__IOV__STACK__LOCATION.html">PIOV_STACK_LOCATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>StackLocationData</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/flunkirp_8c-source.html#l00433">433</a> of file <a class="el" href="../../d8/d3/flunkirp_8c-source.html">flunkirp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d5/io_8h.html#a604a423">BusQueryCompatibleIDs</a>, <a class="el" href="../../d0/d5/io_8h.html#a604a421">BusQueryDeviceID</a>, <a class="el" href="../../d0/d5/io_8h.html#a604a422">BusQueryHardwareIDs</a>, <a class="el" href="../../d0/d5/io_8h.html#a604a424">BusQueryInstanceID</a>, <a class="el" href="../../d0/d5/io_8h.html#a602a412">BusRelations</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00121">CHANGED_STACKS_AT_BOTTOM</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00122">CHANGED_STACKS_MID_STACK</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a57">DCERROR_BOGUS_FUNC_TRASHED</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a59">DCERROR_BOGUS_INFO_TRASHED</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a98">DCERROR_BOGUS_MINOR_STATUS_TRASHED</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a58">DCERROR_BOGUS_STATUS_TRASHED</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a97">DCERROR_DISPATCH_CALLED_AT_BAD_IRQL</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a66">DCERROR_INVALID_STATUS</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a70">DCERROR_MISSING_DISPATCH_FUNCTION</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a60">DCERROR_PNP_FAILURE_FORWARDED</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a63">DCERROR_PNP_IRP_FDO_HANDS_OFF</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a62">DCERROR_PNP_IRP_NEEDS_FDO_HANDLING</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a61">DCERROR_PNP_IRP_STATUS_RESET</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a64">DCERROR_POWER_FAILURE_FORWARDED</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a65">DCERROR_POWER_IRP_STATUS_RESET</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a56">DCERROR_SKIPPED_DEVICE_OBJECT</a>, <a class="el" href="../../d3/d4/ioassert_8h-source.html#l00130">DCPARAM_IRP</a>, <a class="el" href="../../d3/d4/ioassert_8h-source.html#l00131">DCPARAM_ROUTINE</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00183">_IOV_SESSION_DATA::DeviceLastCalled</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00087">DISPATCH_LEVEL</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00088">DOE_DESIGNATED_FDO</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00090">DOE_RAW_FDO</a>, <a class="el" href="../../d0/d5/io_8h.html#a602a413">EjectionRelations</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01268">_DEVOBJ_EXTENSION::ExtensionFlags</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00118">FORWARDED_TO_NEXT_DO</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00184">_IOV_SESSION_DATA::ForwardMethod</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l03087">IopInvalidDeviceRequest()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d8/d3/flunkirp_8c-source.html#l00089">IovpAssertIsNewRequest()</a>, <a class="el" href="../../d8/d3/flunkirp_8c-source.html#l01290">IovpAssertIsValidIrpStatus()</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00657">IovpTrackingDataGetCurrentSessionData()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00069">IRP_MJ_DEVICE_CONTROL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00070">IRP_MJ_INTERNAL_DEVICE_CONTROL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00082">IRP_MJ_PNP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00077">IRP_MJ_POWER</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00058">IRP_MJ_READ</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00078">IRP_MJ_SYSTEM_CONTROL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00059">IRP_MJ_WRITE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00163">IRP_MN_CANCEL_REMOVE_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00166">IRP_MN_CANCEL_STOP_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00183">IRP_MN_DEVICE_USAGE_NOTIFICATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00178">IRP_MN_EJECT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00174">IRP_MN_FILTER_RESOURCE_REQUIREMENTS</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00182">IRP_MN_QUERY_BUS_INFORMATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00170">IRP_MN_QUERY_CAPABILITIES</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00168">IRP_MN_QUERY_DEVICE_RELATIONS</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00173">IRP_MN_QUERY_DEVICE_TEXT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00180">IRP_MN_QUERY_ID</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00169">IRP_MN_QUERY_INTERFACE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00186">IRP_MN_QUERY_LEGACY_BUS_INFORMATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00181">IRP_MN_QUERY_PNP_DEVICE_STATE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00161">IRP_MN_QUERY_REMOVE_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00172">IRP_MN_QUERY_RESOURCE_REQUIREMENTS</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00171">IRP_MN_QUERY_RESOURCES</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00165">IRP_MN_QUERY_STOP_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00176">IRP_MN_READ_CONFIG</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00162">IRP_MN_REMOVE_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00179">IRP_MN_SET_LOCK</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00160">IRP_MN_START_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00164">IRP_MN_STOP_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00184">IRP_MN_SURPRISE_REMOVAL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00177">IRP_MN_WRITE_CONFIG</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01414">_DRIVER_OBJECT::MajorFunction</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00142">PIOV_SESSION_DATA</a>, <a class="el" href="../../d0/d5/io_8h.html#a602a414">PowerRelations</a>, <a class="el" href="../../d0/d5/io_8h.html#a602a415">RemovalRelations</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00119">SKIPPED_A_DO</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00098">STACKFLAG_FIRST_REQUEST</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00094">STACKFLAG_NO_HANDLER</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00120">STARTED_INSIDE_STACK</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00117">STARTED_TOP_OF_STACK</a>, <a class="el" href="../../d0/d5/io_8h.html#a602a416">TargetDeviceRelation</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00076">TRACKFLAG_BOGUS</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00084">TRACKFLAG_PASSED_AT_BAD_IRQL</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00083">TRACKFLAG_PASSED_FAILURE</a>, <a class="el" href="../../d3/d4/ioassert_8h-source.html#l00157">WDM_FAIL_CALLER4</a>, <a class="el" href="../../d3/d4/ioassert_8h-source.html#l00159">WDM_FAIL_CALLER6</a>, and <a class="el" href="../../d3/d4/ioassert_8h-source.html#l00160">WDM_FAIL_ROUTINE</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00493">IovpCallDriver1()</a>.
<p>
<pre class="fragment"><div>00440 {
00441     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp = IrpTrackingData-&gt;TrackedIrp;
00442     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> currentStatus, lastStatus;
00443     BOOLEAN newRequest, statusChanged, infoChanged, firstRequest;
00444     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> possiblePdo;
00445     ULONG doeFlags;
00446     <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> driverObject;
00447     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
00448     UCHAR ansiBuffer[ 256 ];
00449     <a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html">PDEVICE_CAPABILITIES</a> deviceCapabilities;
00450     <a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html">PIOV_SESSION_DATA</a> iovSessionData;
00451 
00452     currentStatus = irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status;
00453     lastStatus = StackLocationData-&gt;RequestsFirstStackLocation-&gt;LastStatusBlock.Status;
00454     statusChanged = (currentStatus != lastStatus);
00455     infoChanged = (irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information != StackLocationData-&gt;RequestsFirstStackLocation-&gt;LastStatusBlock.Information);
00456     firstRequest = ((StackLocationData-&gt;RequestsFirstStackLocation-&gt;Flags&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a50">STACKFLAG_FIRST_REQUEST</a>) != 0);
00457     iovSessionData = <a class="code" href="../../d9/d8/hashirp_8h.html#a16">IovpTrackingDataGetCurrentSessionData</a>(IrpTrackingData);
00458 
00459     <span class="comment">//</span>
00460     <span class="comment">// Do we have a "new" function to process?</span>
00461     <span class="comment">//</span>
00462     newRequest = <a class="code" href="../../d8/d4/flunkirp_8h.html#a0">IovpAssertIsNewRequest</a>(IrpLastSp, IrpSp);
00463 
00464     <span class="comment">//</span>
00465     <span class="comment">// Verify the IRP was forwarded properly</span>
00466     <span class="comment">//</span>
00467     <span class="keywordflow">switch</span>(iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o7">ForwardMethod</a>) {
00468 
00469         <span class="keywordflow">case</span> <a class="code" href="../../d9/d4/trackirp_8h.html#a64">SKIPPED_A_DO</a>:
00470 
00471             <span class="keywordflow">switch</span>(IrpSp-&gt;MajorFunction) {
00472                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a>:
00473                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a36">IRP_MJ_SYSTEM_CONTROL</a>:
00474 
00475                     <a class="code" href="../../d2/d5/ioassert_8h.html#a18">WDM_FAIL_CALLER4</a>(
00476                         (DCERROR_SKIPPED_DEVICE_OBJECT, DCPARAM_IRP, irp)
00477                         );
00478 
00479                     <span class="keywordflow">break</span>;
00480                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a35">IRP_MJ_POWER</a>:
00481                     <span class="comment">//</span>
00482                     <span class="comment">// Unwind back through PoCallDriver...</span>
00483                     <span class="comment">//</span>
00484                     <a class="code" href="../../d2/d5/ioassert_8h.html#a20">WDM_FAIL_CALLER6</a>(
00485                         (DCERROR_SKIPPED_DEVICE_OBJECT, DCPARAM_IRP, irp)
00486                         );
00487 
00488                     <span class="keywordflow">break</span>;
00489 
00490                 <span class="keywordflow">default</span>:
00491                     <span class="keywordflow">break</span>;
00492 
00493             }
00494             <span class="keywordflow">break</span>;
00495 
00496         <span class="keywordflow">case</span> <a class="code" href="../../d9/d4/trackirp_8h.html#a62">STARTED_TOP_OF_STACK</a>:
00497         <span class="keywordflow">case</span> <a class="code" href="../../d9/d4/trackirp_8h.html#a63">FORWARDED_TO_NEXT_DO</a>:
00498             <span class="comment">//</span>
00499             <span class="comment">// Perfectly normal</span>
00500             <span class="comment">//</span>
00501             <span class="keywordflow">break</span>;
00502 
00503         <span class="keywordflow">case</span> <a class="code" href="../../d9/d4/trackirp_8h.html#a65">STARTED_INSIDE_STACK</a>:
00504             <span class="comment">//</span>
00505             <span class="comment">// Probably an Internal irp (query cap's, etc)</span>
00506             <span class="comment">//</span>
00507             <span class="keywordflow">break</span>;
00508 
00509         <span class="keywordflow">case</span> <a class="code" href="../../d9/d4/trackirp_8h.html#a67">CHANGED_STACKS_MID_STACK</a>:
00510             <span class="comment">//ASSERT(0);</span>
00511             <span class="keywordflow">break</span> ;
00512 
00513         <span class="keywordflow">case</span> <a class="code" href="../../d9/d4/trackirp_8h.html#a66">CHANGED_STACKS_AT_BOTTOM</a>:
00514 
00515             <span class="comment">//</span>
00516             <span class="comment">// This is scary as we are very likely to run out of</span>
00517             <span class="comment">// stack locations. In theory, it is safe to do this if one</span>
00518             <span class="comment">// is careful though...</span>
00519             <span class="comment">//</span>
00520             <span class="comment">// ADRIAO BUGBUG ?? - I should check to see if there are</span>
00521             <span class="comment">//                    enough theoritical stack locations:</span>
00522             <span class="comment">//                    If there are we may be OK. Also</span>
00523             <span class="comment">//                    verify the "jump" in stack loc's from</span>
00524             <span class="comment">//                    the lower dude (5 to 8 instead of 5 to 6)</span>
00525             <span class="comment">//                    account for the stack size of the</span>
00526             <span class="comment">//                    "outbound" forward (ie, 2)</span>
00527 <span class="preprocessor">#if 0</span>
00528 <span class="preprocessor"></span>            <span class="keywordflow">switch</span>(IrpSp-&gt;MajorFunction) {
00529                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a>:
00530                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(0);
00531             }
00532 <span class="preprocessor">#endif</span>
00533 <span class="preprocessor"></span>            <span class="keywordflow">break</span> ;
00534     }
00535 
00536     <span class="comment">//</span>
00537     <span class="comment">// For some IRP major's going down a stack, there *must* be a handler</span>
00538     <span class="comment">//</span>
00539     driverObject = DeviceObject-&gt;DriverObject;
00540     <span class="keywordflow">switch</span>(IrpSp-&gt;MajorFunction) {
00541 
00542         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a>:
00543             <span class="comment">//</span>
00544             <span class="comment">// Umm, this would be waaay too bizarre to fail. Actually, video</span>
00545             <span class="comment">// miniports do this. Yick.</span>
00546             <span class="comment">//</span>
00547 <span class="preprocessor">#if 0</span>
00548 <span class="preprocessor"></span>            <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o14">MajorFunction</a>[IrpSp-&gt;MajorFunction] != IopInvalidDeviceRequest) ||
00549                     ((DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode == NULL) &amp;&amp;
00550                     (DeviceObject-&gt;DeviceObjectExtension-&gt;AttachedTo == NULL)));
00551 <span class="preprocessor">#endif</span>
00552 <span class="preprocessor"></span>            <span class="keywordflow">break</span>;
00553 
00554         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a35">IRP_MJ_POWER</a>:
00555         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a36">IRP_MJ_SYSTEM_CONTROL</a>:
00556             <span class="keywordflow">if</span> (driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o14">MajorFunction</a>[IrpSp-&gt;MajorFunction] == <a class="code" href="../../d2/d4/internal_8c.html#a45">IopInvalidDeviceRequest</a>) {
00557 
00558                 <a class="code" href="../../d2/d5/ioassert_8h.html#a21">WDM_FAIL_ROUTINE</a>((
00559                     DCERROR_MISSING_DISPATCH_FUNCTION,
00560                     DCPARAM_IRP + DCPARAM_ROUTINE,
00561                     irp,
00562                     driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o14">MajorFunction</a>[IRP_MJ_PNP]
00563                     ));
00564 
00565                 StackLocationData-&gt;Flags |= <a class="code" href="../../d9/d4/trackirp_8h.html#a46">STACKFLAG_NO_HANDLER</a>;
00566             }
00567             <span class="keywordflow">break</span>;
00568 
00569         <span class="keywordflow">default</span>:
00570             <span class="keywordflow">break</span>;
00571     }
00572 
00573     <span class="comment">//</span>
00574     <span class="comment">// Verify IRQL's are legal</span>
00575     <span class="comment">//</span>
00576     <span class="keywordflow">switch</span>(IrpSp-&gt;MajorFunction) {
00577 
00578         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a35">IRP_MJ_POWER</a>:
00579         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a16">IRP_MJ_READ</a>:
00580         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a17">IRP_MJ_WRITE</a>:
00581 
00582             <span class="comment">//</span>
00583             <span class="comment">// Fall through</span>
00584             <span class="comment">//</span>
00585             <span class="comment">// ADRIAO BUGBUG #06 06/11/98 - Figure out when the next two are</span>
00586             <span class="comment">// restricted to IRQL&lt;DISPATCH_LEVEL...</span>
00587             <span class="comment">//</span>
00588         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a27">IRP_MJ_DEVICE_CONTROL</a>:
00589         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a28">IRP_MJ_INTERNAL_DEVICE_CONTROL</a>:
00590             <span class="keywordflow">break</span>;
00591         <span class="keywordflow">default</span>:
00592             <span class="keywordflow">if</span> (iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o7">ForwardMethod</a> != <a class="code" href="../../d9/d4/trackirp_8h.html#a63">FORWARDED_TO_NEXT_DO</a>) {
00593                 <span class="keywordflow">break</span>;
00594             }
00595 
00596             <span class="keywordflow">if</span> ((IrpTrackingData-&gt;CallerIrql &gt;= <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>) &amp;&amp;
00597                 (!(IrpTrackingData-&gt;Flags &amp; <a class="code" href="../../d9/d4/trackirp_8h.html#a38">TRACKFLAG_PASSED_AT_BAD_IRQL</a>))) {
00598 
00599                 <a class="code" href="../../d2/d5/ioassert_8h.html#a18">WDM_FAIL_CALLER4</a>(
00600                     (DCERROR_DISPATCH_CALLED_AT_BAD_IRQL, DCPARAM_IRP, irp)
00601                     );
00602 
00603                 IrpTrackingData-&gt;Flags |= <a class="code" href="../../d9/d4/trackirp_8h.html#a38">TRACKFLAG_PASSED_AT_BAD_IRQL</a>;
00604             }
00605     }
00606 
00607     <span class="comment">//</span>
00608     <span class="comment">// The following is only executed if we are not a new IRP...</span>
00609     <span class="comment">//</span>
00610     <span class="keywordflow">if</span> (IrpLastSp == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00611         <span class="keywordflow">return</span>;
00612     }
00613 
00614     <span class="comment">//</span>
00615     <span class="comment">// Let's verify bogus IRPs haven't been touched...</span>
00616     <span class="comment">//</span>
00617     <span class="comment">// BUGBUG ADRIAO ?? - Invent better Info/Status/Func memory...</span>
00618     <span class="comment">//</span>
00619     <span class="keywordflow">if</span> (IrpTrackingData-&gt;Flags&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a30">TRACKFLAG_BOGUS</a>) {
00620 
00621         <span class="keywordflow">if</span> (newRequest &amp;&amp; (!firstRequest)) {
00622 
00623             <a class="code" href="../../d2/d5/ioassert_8h.html#a18">WDM_FAIL_CALLER4</a>(
00624                 (DCERROR_BOGUS_FUNC_TRASHED, DCPARAM_IRP, irp)
00625                 );
00626         }
00627 
00628         <span class="keywordflow">if</span> (statusChanged) {
00629 
00630             <span class="keywordflow">if</span> (IrpSp-&gt;MinorFunction == 0xFF) {
00631 
00632                 <a class="code" href="../../d2/d5/ioassert_8h.html#a18">WDM_FAIL_CALLER4</a>(
00633                     (DCERROR_BOGUS_MINOR_STATUS_TRASHED, DCPARAM_IRP, irp)
00634                     );
00635 
00636             } <span class="keywordflow">else</span> {
00637 
00638                 <a class="code" href="../../d2/d5/ioassert_8h.html#a18">WDM_FAIL_CALLER4</a>(
00639                     (DCERROR_BOGUS_STATUS_TRASHED, DCPARAM_IRP, irp)
00640                     );
00641             }
00642 
00643         }
00644 
00645         <span class="keywordflow">if</span> (infoChanged) {
00646 
00647             <a class="code" href="../../d2/d5/ioassert_8h.html#a18">WDM_FAIL_CALLER4</a>(
00648                 (DCERROR_BOGUS_INFO_TRASHED, DCPARAM_IRP, irp)
00649                 );
00650         }
00651     }
00652 
00653     <span class="comment">//</span>
00654     <span class="comment">// Verify PnP IRPs</span>
00655     <span class="comment">//</span>
00656     <span class="comment">// ADRIAO BUGBUG 01/02/1999 -</span>
00657     <span class="comment">//     This doesn't quite work right for RAW PDO's, as they in truth have</span>
00658     <span class="comment">// no one to IoCallDriver so we never see those IRPs. This needs to be</span>
00659     <span class="comment">// *request* based in the upward code...</span>
00660     <span class="comment">//</span>
00661     <span class="keywordflow">if</span> (IrpSp-&gt;MajorFunction == <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a>) {
00662 
00663         <span class="comment">//</span>
00664         <span class="comment">// The only legit failure code to pass down is STATUS_NOT_SUPPORTED</span>
00665         <span class="comment">//</span>
00666         <span class="keywordflow">if</span> ((!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(currentStatus)) &amp;&amp; (currentStatus != STATUS_NOT_SUPPORTED) &amp;&amp;
00667             (!(IrpTrackingData-&gt;Flags&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a37">TRACKFLAG_PASSED_FAILURE</a>))) {
00668 
00669             <a class="code" href="../../d2/d5/ioassert_8h.html#a18">WDM_FAIL_CALLER4</a>(
00670                 (DCERROR_PNP_FAILURE_FORWARDED, DCPARAM_IRP, irp)
00671                 );
00672 
00673             <span class="comment">//</span>
00674             <span class="comment">// Don't blame anyone else for this dude's mistakes...</span>
00675             <span class="comment">//</span>
00676             IrpTrackingData-&gt;Flags |= <a class="code" href="../../d9/d4/trackirp_8h.html#a37">TRACKFLAG_PASSED_FAILURE</a>;
00677         }
00678 
00679         <span class="comment">//</span>
00680         <span class="comment">// Status of a PnP IRP may not be converted to</span>
00681         <span class="comment">// STATUS_NOT_SUPPORTED on the way down</span>
00682         <span class="comment">//</span>
00683         <span class="keywordflow">if</span> ((currentStatus == STATUS_NOT_SUPPORTED)&amp;&amp;statusChanged) {
00684 
00685             <a class="code" href="../../d2/d5/ioassert_8h.html#a18">WDM_FAIL_CALLER4</a>(
00686                 (DCERROR_PNP_IRP_STATUS_RESET, DCPARAM_IRP, irp)
00687                 );
00688         }
00689 
00690         <span class="comment">//</span>
00691         <span class="comment">// Some IRPs FDO's are required to handle before passing down. And</span>
00692         <span class="comment">// some IRPs should not be touched by the FDO. Assert it is so...</span>
00693         <span class="comment">//</span>
00694         <span class="keywordflow">if</span> (iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o6">DeviceLastCalled</a>) {
00695             doeFlags = iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o6">DeviceLastCalled</a>-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o5">ExtensionFlags</a>;
00696         } <span class="keywordflow">else</span> {
00697             doeFlags = 0;
00698         }
00699 
00700         <span class="comment">//</span>
00701         <span class="comment">// How could a Raw FDO (aka a PDO) get here? Well, a PDO could forward</span>
00702         <span class="comment">// to another stack if he's purposely reserved enough stack locations</span>
00703         <span class="comment">// for that eventuality...</span>
00704         <span class="comment">//</span>
00705         <span class="comment">//ASSERT(!(doeFlags&amp;DOE_RAW_FDO));</span>
00706 
00707         <span class="keywordflow">if</span> (doeFlags&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a41">DOE_DESIGNATED_FDO</a>) {
00708 
00709             <span class="keywordflow">switch</span>(IrpSp-&gt;MinorFunction) {
00710 
00711                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a87">IRP_MN_SURPRISE_REMOVAL</a>:
00712                     <span class="comment">//</span>
00713                     <span class="comment">// ADRIAO BUGBUG 01/22/1999 -</span>
00714                     <span class="comment">//     We are exempting this IRP from support</span>
00715                     <span class="comment">// (ie, voting success or failure) because it is</span>
00716                     <span class="comment">// late in the product. This is in my opinion quite</span>
00717                     <span class="comment">// braindead, but so be it.</span>
00718                     <span class="comment">//</span>
00719                     <span class="keywordflow">break</span>;
00720                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a65">IRP_MN_START_DEVICE</a>:
00721                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a66">IRP_MN_QUERY_REMOVE_DEVICE</a>:
00722                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a67">IRP_MN_REMOVE_DEVICE</a>:
00723                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a68">IRP_MN_CANCEL_REMOVE_DEVICE</a>:
00724                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a69">IRP_MN_STOP_DEVICE</a>:
00725                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a70">IRP_MN_QUERY_STOP_DEVICE</a>:
00726                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a71">IRP_MN_CANCEL_STOP_DEVICE</a>:
00727 
00728                     <span class="comment">//</span>
00729                     <span class="comment">// The FDO must set the status as appropriate. If he set a</span>
00730                     <span class="comment">// completion routine, he can do it there (and thus we cannot</span>
00731                     <span class="comment">// check). If he has not though, we can indeed verify he has</span>
00732                     <span class="comment">// responded to the IRP!</span>
00733                     <span class="comment">//</span>
00734                     <span class="keywordflow">if</span> ((currentStatus == STATUS_NOT_SUPPORTED)&amp;&amp;(!IrpSp-&gt;CompletionRoutine)) {
00735 
00736                         <a class="code" href="../../d2/d5/ioassert_8h.html#a18">WDM_FAIL_CALLER4</a>(
00737                             (DCERROR_PNP_IRP_NEEDS_FDO_HANDLING, DCPARAM_IRP, irp)
00738                             );
00739                     }
00740                     <span class="keywordflow">break</span> ;
00741                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a72">IRP_MN_QUERY_DEVICE_RELATIONS</a>:
00742                     <span class="keywordflow">switch</span>(IrpSp-&gt;Parameters.QueryDeviceRelations.Type) {
00743                         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a602a416">TargetDeviceRelation</a>:
00744                             <span class="keywordflow">if</span> ((currentStatus != STATUS_NOT_SUPPORTED)&amp;&amp;(!(doeFlags&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a43">DOE_RAW_FDO</a>))) {
00745 
00746                                 <a class="code" href="../../d2/d5/ioassert_8h.html#a18">WDM_FAIL_CALLER4</a>(
00747                                     (DCERROR_PNP_IRP_FDO_HANDS_OFF, DCPARAM_IRP, irp)
00748                                     );
00749                             }
00750                             <span class="keywordflow">break</span>;
00751                        <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a602a412">BusRelations</a>:
00752                        <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a602a414">PowerRelations</a>:
00753                        <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a602a415">RemovalRelations</a>:
00754 
00755                        <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a602a413">EjectionRelations</a>:
00756 
00757                            <span class="comment">//</span>
00758                            <span class="comment">// Ejection relations are usually a bad idea for</span>
00759                            <span class="comment">// FDO's - As stopping a device implies powerdown,</span>
00760                            <span class="comment">// RemovalRelations are usually the proper response</span>
00761                            <span class="comment">// for an FDO. One exception is ISAPNP, as PCI-to-ISA</span>
00762                            <span class="comment">// bridges can never be powered down.</span>
00763                            <span class="comment">//</span>
00764 
00765                        <span class="keywordflow">default</span>:
00766                            <span class="keywordflow">break</span>;
00767                     }
00768                     <span class="keywordflow">break</span>;
00769                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a73">IRP_MN_QUERY_INTERFACE</a>:
00770                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a74">IRP_MN_QUERY_CAPABILITIES</a>:
00771                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a78">IRP_MN_FILTER_RESOURCE_REQUIREMENTS</a>:
00772                     <span class="keywordflow">break</span>;
00773                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a77">IRP_MN_QUERY_DEVICE_TEXT</a>:
00774                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a79">IRP_MN_READ_CONFIG</a>:
00775                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a80">IRP_MN_WRITE_CONFIG</a>:
00776                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a81">IRP_MN_EJECT</a>:
00777                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a82">IRP_MN_SET_LOCK</a>:
00778                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a75">IRP_MN_QUERY_RESOURCES</a>:
00779                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a76">IRP_MN_QUERY_RESOURCE_REQUIREMENTS</a>:
00780                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a85">IRP_MN_QUERY_BUS_INFORMATION</a>:
00781                     <span class="keywordflow">if</span> ((currentStatus != STATUS_NOT_SUPPORTED)&amp;&amp;(!(doeFlags&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a43">DOE_RAW_FDO</a>))) {
00782 
00783                         <a class="code" href="../../d2/d5/ioassert_8h.html#a18">WDM_FAIL_CALLER4</a>(
00784                             (DCERROR_PNP_IRP_FDO_HANDS_OFF, DCPARAM_IRP, irp)
00785                             );
00786                     }
00787                     <span class="keywordflow">break</span>;
00788                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a83">IRP_MN_QUERY_ID</a>:
00789                     <span class="keywordflow">switch</span>(IrpSp-&gt;Parameters.QueryId.IdType) {
00790 
00791                         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a604a421">BusQueryDeviceID</a>:
00792                         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a604a422">BusQueryHardwareIDs</a>:
00793                         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a604a423">BusQueryCompatibleIDs</a>:
00794                         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a604a424">BusQueryInstanceID</a>:
00795                             <span class="keywordflow">if</span> ((currentStatus != STATUS_NOT_SUPPORTED)&amp;&amp;(!(doeFlags&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a43">DOE_RAW_FDO</a>))) {
00796 
00797                                 <a class="code" href="../../d2/d5/ioassert_8h.html#a18">WDM_FAIL_CALLER4</a>(
00798                                     (DCERROR_PNP_IRP_FDO_HANDS_OFF, DCPARAM_IRP, irp)
00799                                     );
00800                             }
00801                             <span class="keywordflow">break</span>;
00802                         <span class="keywordflow">default</span>:
00803                             <span class="keywordflow">break</span>;
00804                     }
00805                     <span class="keywordflow">break</span>;
00806                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a84">IRP_MN_QUERY_PNP_DEVICE_STATE</a>:
00807                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a88">IRP_MN_QUERY_LEGACY_BUS_INFORMATION</a>:
00808                     <span class="keywordflow">break</span>;
00809                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a86">IRP_MN_DEVICE_USAGE_NOTIFICATION</a>:
00810                     <span class="comment">//</span>
00811                     <span class="comment">// ADRIAO BUGBUG 09/25/98 - Is this really optional for an FDO?</span>
00812                     <span class="comment">//</span>
00813                     <span class="keywordflow">break</span>;
00814                 <span class="keywordflow">default</span>:
00815                     <span class="keywordflow">break</span>;
00816             }
00817         }
00818     }
00819 
00820     <span class="comment">//</span>
00821     <span class="comment">// Verify Power IRPs</span>
00822     <span class="comment">//</span>
00823     <span class="keywordflow">if</span> (IrpSp-&gt;MajorFunction == <a class="code" href="../../d0/d5/io_8h.html#a35">IRP_MJ_POWER</a>) {
00824 
00825         <span class="comment">//</span>
00826         <span class="comment">// The only legit failure code to pass down is STATUS_NOT_SUPPORTED</span>
00827         <span class="comment">//</span>
00828         <span class="keywordflow">if</span> ((!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(currentStatus)) &amp;&amp; (currentStatus != STATUS_NOT_SUPPORTED) &amp;&amp;
00829             (!(IrpTrackingData-&gt;Flags&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a37">TRACKFLAG_PASSED_FAILURE</a>))) {
00830 
00831             <a class="code" href="../../d2/d5/ioassert_8h.html#a20">WDM_FAIL_CALLER6</a>(
00832                 (DCERROR_POWER_FAILURE_FORWARDED, DCPARAM_IRP, irp)
00833                 );
00834 
00835             <span class="comment">//</span>
00836             <span class="comment">// Don't blame anyone else for this dude's mistakes...</span>
00837             <span class="comment">//</span>
00838             IrpTrackingData-&gt;Flags |= <a class="code" href="../../d9/d4/trackirp_8h.html#a37">TRACKFLAG_PASSED_FAILURE</a>;
00839         }
00840 
00841         <span class="comment">//</span>
00842         <span class="comment">// Status of a Power IRP may not be converted to</span>
00843         <span class="comment">// STATUS_NOT_SUPPORTED on the way down</span>
00844         <span class="comment">//</span>
00845         <span class="keywordflow">if</span> ((currentStatus == STATUS_NOT_SUPPORTED)&amp;&amp;statusChanged) {
00846 
00847             <a class="code" href="../../d2/d5/ioassert_8h.html#a20">WDM_FAIL_CALLER6</a>(
00848                 (DCERROR_POWER_IRP_STATUS_RESET, DCPARAM_IRP, irp)
00849                 );
00850         }
00851     }
00852 
00853     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d4/flunkirp_8h.html#a7">IovpAssertIsValidIrpStatus</a>(IrpSp, currentStatus)) {
00854 
00855         <span class="keywordflow">switch</span>(IrpSp-&gt;MajorFunction) {
00856             <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a35">IRP_MJ_POWER</a>:
00857 
00858                 <a class="code" href="../../d2/d5/ioassert_8h.html#a20">WDM_FAIL_CALLER6</a>((DCERROR_INVALID_STATUS, DCPARAM_IRP, irp));
00859                 <span class="keywordflow">break</span>;
00860 
00861             <span class="keywordflow">default</span>:
00862 
00863                 <a class="code" href="../../d2/d5/ioassert_8h.html#a18">WDM_FAIL_CALLER4</a>((DCERROR_INVALID_STATUS, DCPARAM_IRP, irp));
00864                 <span class="keywordflow">break</span>;
00865         }
00866     }
00867 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="flunkirp.c::IovpAssertIrpStackUpward" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IovpAssertIrpStackUpward           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpTrackingData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpSp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d1/struct__IOV__STACK__LOCATION.html">PIOV_STACK_LOCATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>StackLocationData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>IsNewlyCompleted</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>RequestFinalized</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/flunkirp_8c-source.html#l00870">870</a> of file <a class="el" href="../../d8/d3/flunkirp_8c-source.html">flunkirp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d5/io_8h.html#a604a423">BusQueryCompatibleIDs</a>, <a class="el" href="../../d0/d5/io_8h.html#a604a421">BusQueryDeviceID</a>, <a class="el" href="../../d0/d5/io_8h.html#a604a422">BusQueryHardwareIDs</a>, <a class="el" href="../../d0/d5/io_8h.html#a604a424">BusQueryInstanceID</a>, <a class="el" href="../../d0/d5/io_8h.html#a602a412">BusRelations</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a59">DCERROR_BOGUS_INFO_TRASHED</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a98">DCERROR_BOGUS_MINOR_STATUS_TRASHED</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a84">DCERROR_BOGUS_PNP_IRP_COMPLETED</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a87">DCERROR_BOGUS_POWER_IRP_COMPLETED</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a58">DCERROR_BOGUS_STATUS_TRASHED</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a66">DCERROR_INVALID_STATUS</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a81">DCERROR_PNP_IRP_NEEDS_PDO_HANDLING</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a61">DCERROR_PNP_IRP_STATUS_RESET</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a65">DCERROR_POWER_IRP_STATUS_RESET</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a85">DCERROR_SUCCESSFUL_PNP_IRP_NOT_FORWARDED</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a88">DCERROR_SUCCESSFUL_POWER_IRP_NOT_FORWARDED</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a82">DCERROR_TARGET_RELATION_LIST_EMPTY</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a83">DCERROR_TARGET_RELATION_NEEDS_REF</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a86">DCERROR_UNTOUCHED_PNP_IRP_NOT_FORWARDED</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a89">DCERROR_UNTOUCHED_POWER_IRP_NOT_FORWARDED</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a71">DCERROR_WMI_IRP_NOT_FORWARDED</a>, <a class="el" href="../../d3/d4/ioassert_8h-source.html#l00132">DCPARAM_DEVOBJ</a>, <a class="el" href="../../d3/d4/ioassert_8h-source.html#l00130">DCPARAM_IRP</a>, <a class="el" href="../../d3/d4/ioassert_8h-source.html#l00131">DCPARAM_ROUTINE</a>, <a class="el" href="../../d0/d5/io_8h.html#a602a413">EjectionRelations</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00159">_IOV_STACK_LOCATION::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d8/d3/flunkirp_8c-source.html#l01290">IovpAssertIsValidIrpStatus()</a>, <a class="el" href="../../d8/d3/flunkirp_8c-source.html#l01722">IovpStopObRefMonitoring()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00082">IRP_MJ_PNP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00077">IRP_MJ_POWER</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00078">IRP_MJ_SYSTEM_CONTROL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00163">IRP_MN_CANCEL_REMOVE_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00166">IRP_MN_CANCEL_STOP_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00183">IRP_MN_DEVICE_USAGE_NOTIFICATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00178">IRP_MN_EJECT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00174">IRP_MN_FILTER_RESOURCE_REQUIREMENTS</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00182">IRP_MN_QUERY_BUS_INFORMATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00170">IRP_MN_QUERY_CAPABILITIES</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00168">IRP_MN_QUERY_DEVICE_RELATIONS</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00173">IRP_MN_QUERY_DEVICE_TEXT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00180">IRP_MN_QUERY_ID</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00169">IRP_MN_QUERY_INTERFACE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00186">IRP_MN_QUERY_LEGACY_BUS_INFORMATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00181">IRP_MN_QUERY_PNP_DEVICE_STATE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00161">IRP_MN_QUERY_REMOVE_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00172">IRP_MN_QUERY_RESOURCE_REQUIREMENTS</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00171">IRP_MN_QUERY_RESOURCES</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00165">IRP_MN_QUERY_STOP_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00176">IRP_MN_READ_CONFIG</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00162">IRP_MN_REMOVE_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00179">IRP_MN_SET_LOCK</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00160">IRP_MN_START_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00164">IRP_MN_STOP_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00184">IRP_MN_SURPRISE_REMOVAL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00177">IRP_MN_WRITE_CONFIG</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d5/io_8h.html#a602a414">PowerRelations</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00167">_IOV_STACK_LOCATION::ReferencingCount</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00166">_IOV_STACK_LOCATION::ReferencingObject</a>, <a class="el" href="../../d0/d5/io_8h.html#a602a415">RemovalRelations</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00160">_IOV_STACK_LOCATION::RequestsFirstStackLocation</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00096">STACKFLAG_CHECK_FOR_REFERENCE</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00094">STACKFLAG_NO_HANDLER</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00097">STACKFLAG_REACHED_PDO</a>, <a class="el" href="../../d0/d5/io_8h.html#a602a416">TargetDeviceRelation</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00076">TRACKFLAG_BOGUS</a>, and <a class="el" href="../../d3/d4/ioassert_8h-source.html#l00160">WDM_FAIL_ROUTINE</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/trackirp_8c-source.html#l01416">IovpCompleteRequest2()</a>.
<p>
<pre class="fragment"><div>00877 {
00878     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp = IrpTrackingData-&gt;TrackedIrp;
00879     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> currentStatus, lastStatus;
00880     BOOLEAN mustPassDown, isBogusIrp, isPdo, statusChanged, infoChanged;
00881     <a class="code" href="../../d9/d1/struct__IOV__STACK__LOCATION.html">PIOV_STACK_LOCATION</a> originalRequestSLD;
00882     PVOID routine;
00883     LONG referencesTaken;
00884     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> possiblePdo;
00885     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
00886     UCHAR ansiBuffer[ 256 ];
00887 
00888     currentStatus = irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status;
00889     lastStatus = StackLocationData-&gt;RequestsFirstStackLocation-&gt;LastStatusBlock.Status;
00890     statusChanged = (currentStatus != lastStatus);
00891     infoChanged = (irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information != StackLocationData-&gt;RequestsFirstStackLocation-&gt;LastStatusBlock.Information);
00892 
00893     <span class="comment">//</span>
00894     <span class="comment">// Who'd we call for this one?</span>
00895     <span class="comment">//</span>
00896     routine = StackLocationData-&gt;LastDispatch;
00897     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(routine) ;
00898 
00899     <span class="comment">//</span>
00900     <span class="comment">// If this "Request" has been "Completed", perform some checks</span>
00901     <span class="comment">//</span>
00902     <span class="keywordflow">if</span> (IsNewlyCompleted) {
00903 
00904         <span class="comment">//</span>
00905         <span class="comment">// Remember bogosity...</span>
00906         <span class="comment">//</span>
00907         isBogusIrp = ((IrpTrackingData-&gt;Flags&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a30">TRACKFLAG_BOGUS</a>)!=0);
00908 
00909         <span class="comment">//</span>
00910         <span class="comment">// Is this a PDO?</span>
00911         <span class="comment">//</span>
00912         isPdo = ((StackLocationData-&gt;Flags&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a49">STACKFLAG_REACHED_PDO</a>)!=0);
00913 
00914         <span class="comment">//</span>
00915         <span class="comment">// Was anything completed too early?</span>
00916         <span class="comment">// A driver may outright fail almost anything but a bogus IRP</span>
00917         <span class="comment">//</span>
00918         mustPassDown = (!(StackLocationData-&gt;Flags&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a46">STACKFLAG_NO_HANDLER</a>));
00919         mustPassDown &amp;= (!isPdo);
00920 
00921         <span class="keywordflow">switch</span>(IrpSp-&gt;MajorFunction) {
00922 
00923             <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a36">IRP_MJ_SYSTEM_CONTROL</a>:
00924                 mustPassDown &amp;= ((<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>) IrpSp-&gt;Parameters.WMI.ProviderId != IrpSp-&gt;DeviceObject);
00925                 <span class="keywordflow">if</span> (mustPassDown) {
00926 
00927                      <a class="code" href="../../d2/d5/ioassert_8h.html#a21">WDM_FAIL_ROUTINE</a>((
00928                          DCERROR_WMI_IRP_NOT_FORWARDED,
00929                          DCPARAM_IRP + DCPARAM_ROUTINE + DCPARAM_DEVOBJ,
00930                          irp,
00931                          routine,
00932                          IrpSp-&gt;Parameters.WMI.ProviderId
00933                          ));
00934                 }
00935                 <span class="keywordflow">break</span>;
00936 
00937             <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a>:
00938                 mustPassDown &amp;= (isBogusIrp || <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(currentStatus) || (currentStatus == STATUS_NOT_SUPPORTED));
00939                 <span class="keywordflow">if</span> (mustPassDown) {
00940 
00941                     <span class="comment">//</span>
00942                     <span class="comment">// Print appropriate error message</span>
00943                     <span class="comment">//</span>
00944                     <span class="keywordflow">if</span> (IrpTrackingData-&gt;Flags&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a30">TRACKFLAG_BOGUS</a>) {
00945 
00946                         <a class="code" href="../../d2/d5/ioassert_8h.html#a21">WDM_FAIL_ROUTINE</a>((
00947                             DCERROR_BOGUS_PNP_IRP_COMPLETED,
00948                             DCPARAM_IRP + DCPARAM_ROUTINE,
00949                             irp,
00950                             routine
00951                             ));
00952 
00953                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(currentStatus)) {
00954 
00955                         <a class="code" href="../../d2/d5/ioassert_8h.html#a21">WDM_FAIL_ROUTINE</a>((
00956                             DCERROR_SUCCESSFUL_PNP_IRP_NOT_FORWARDED,
00957                             DCPARAM_IRP + DCPARAM_ROUTINE,
00958                             irp,
00959                             routine
00960                             ));
00961 
00962                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (currentStatus == STATUS_NOT_SUPPORTED) {
00963 
00964                         <a class="code" href="../../d2/d5/ioassert_8h.html#a21">WDM_FAIL_ROUTINE</a>((
00965                             DCERROR_UNTOUCHED_PNP_IRP_NOT_FORWARDED,
00966                             DCPARAM_IRP + DCPARAM_ROUTINE,
00967                             irp,
00968                             routine
00969                             ));
00970                     }
00971                 }
00972                 <span class="keywordflow">break</span>;
00973 
00974             <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a35">IRP_MJ_POWER</a>:
00975                 mustPassDown &amp;= (isBogusIrp || <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(currentStatus) || (currentStatus == STATUS_NOT_SUPPORTED));
00976                 <span class="keywordflow">if</span> (mustPassDown) {
00977 
00978                     <span class="comment">//</span>
00979                     <span class="comment">// Print appropriate error message</span>
00980                     <span class="comment">//</span>
00981                     <span class="keywordflow">if</span> (IrpTrackingData-&gt;Flags&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a30">TRACKFLAG_BOGUS</a>) {
00982 
00983                         <a class="code" href="../../d2/d5/ioassert_8h.html#a21">WDM_FAIL_ROUTINE</a>((
00984                             DCERROR_BOGUS_POWER_IRP_COMPLETED,
00985                             DCPARAM_IRP + DCPARAM_ROUTINE,
00986                             irp,
00987                             routine
00988                             ));
00989 
00990                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(currentStatus)) {
00991 
00992                         <a class="code" href="../../d2/d5/ioassert_8h.html#a21">WDM_FAIL_ROUTINE</a>((
00993                             DCERROR_SUCCESSFUL_POWER_IRP_NOT_FORWARDED,
00994                             DCPARAM_IRP + DCPARAM_ROUTINE,
00995                             irp,
00996                             routine
00997                             ));
00998 
00999                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (currentStatus == STATUS_NOT_SUPPORTED) {
01000 
01001                         <a class="code" href="../../d2/d5/ioassert_8h.html#a21">WDM_FAIL_ROUTINE</a>((
01002                             DCERROR_UNTOUCHED_POWER_IRP_NOT_FORWARDED,
01003                             DCPARAM_IRP + DCPARAM_ROUTINE,
01004                             irp,
01005                             routine
01006                             ));
01007                     }
01008                 }
01009                 <span class="keywordflow">break</span>;
01010         }
01011 
01012         <span class="comment">//</span>
01013         <span class="comment">// Did the PDO respond to it's required set of IRPs?</span>
01014         <span class="comment">//</span>
01015         <span class="keywordflow">if</span> (isPdo) {
01016 
01017             <span class="keywordflow">switch</span>(IrpSp-&gt;MajorFunction) {
01018 
01019                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a>:
01020 
01021                     <span class="keywordflow">switch</span>(IrpSp-&gt;MinorFunction) {
01022 
01023                         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a87">IRP_MN_SURPRISE_REMOVAL</a>:
01024 
01025                             <span class="comment">//</span>
01026                             <span class="comment">// ADRIAO BUGBUG 01/22/1999 -</span>
01027                             <span class="comment">//     We are exempting this IRP from support</span>
01028                             <span class="comment">// (ie, voting success or failure) because it is</span>
01029                             <span class="comment">// late in the product. This is in my opinion quite</span>
01030                             <span class="comment">// braindead, but so be it.</span>
01031                             <span class="comment">//</span>
01032                             <span class="keywordflow">break</span>;
01033 
01034                         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a65">IRP_MN_START_DEVICE</a>:
01035                         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a66">IRP_MN_QUERY_REMOVE_DEVICE</a>:
01036                         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a67">IRP_MN_REMOVE_DEVICE</a>:
01037                         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a68">IRP_MN_CANCEL_REMOVE_DEVICE</a>:
01038                         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a69">IRP_MN_STOP_DEVICE</a>:
01039                         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a70">IRP_MN_QUERY_STOP_DEVICE</a>:
01040                         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a71">IRP_MN_CANCEL_STOP_DEVICE</a>:
01041                             <span class="keywordflow">if</span> (currentStatus == STATUS_NOT_SUPPORTED) {
01042 
01043                                 <a class="code" href="../../d2/d5/ioassert_8h.html#a21">WDM_FAIL_ROUTINE</a>((
01044                                     DCERROR_PNP_IRP_NEEDS_PDO_HANDLING,
01045                                     DCPARAM_IRP + DCPARAM_ROUTINE,
01046                                     irp,
01047                                     routine
01048                                     ));
01049                             }
01050                             <span class="keywordflow">break</span>;
01051                         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a72">IRP_MN_QUERY_DEVICE_RELATIONS</a>:
01052                             <span class="keywordflow">switch</span>(IrpSp-&gt;Parameters.QueryDeviceRelations.Type) {
01053                                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a602a412">BusRelations</a>:
01054                                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a602a414">PowerRelations</a>:
01055                                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a602a415">RemovalRelations</a>:
01056                                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a602a413">EjectionRelations</a>:
01057                                     <span class="comment">//</span>
01058                                     <span class="comment">// Optionals or FDO's</span>
01059                                     <span class="comment">//</span>
01060                                     <span class="keywordflow">break</span>;
01061                                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a602a416">TargetDeviceRelation</a>:
01062                                     <span class="keywordflow">if</span> (currentStatus == STATUS_NOT_SUPPORTED) {
01063 
01064                                         <a class="code" href="../../d2/d5/ioassert_8h.html#a21">WDM_FAIL_ROUTINE</a>((
01065                                             DCERROR_PNP_IRP_NEEDS_PDO_HANDLING,
01066                                             DCPARAM_IRP + DCPARAM_ROUTINE,
01067                                             irp,
01068                                             routine
01069                                             ));
01070 
01071                                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(currentStatus)) {
01072 
01073                                         <span class="keywordflow">if</span> (irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information == (ULONG_PTR) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01074 
01075                                             <a class="code" href="../../d2/d5/ioassert_8h.html#a21">WDM_FAIL_ROUTINE</a>((
01076                                                 DCERROR_TARGET_RELATION_LIST_EMPTY,
01077                                                 DCPARAM_IRP + DCPARAM_ROUTINE,
01078                                                 irp,
01079                                                 routine
01080                                                 ));
01081                                         }
01082 
01083                                         <span class="comment">//</span>
01084                                         <span class="comment">// ADRIAO BUGBUG ?? - I could also assert the Information</span>
01085                                         <span class="comment">// matches DeviceObject.</span>
01086                                         <span class="comment">//</span>
01087                                     }
01088                                     <span class="keywordflow">break</span>;
01089                                 <span class="keywordflow">default</span>:
01090                                     <span class="keywordflow">break</span>;
01091                             }
01092                             <span class="keywordflow">break</span>;
01093                         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a73">IRP_MN_QUERY_INTERFACE</a>:
01094                         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a74">IRP_MN_QUERY_CAPABILITIES</a>:
01095                         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a78">IRP_MN_FILTER_RESOURCE_REQUIREMENTS</a>:
01096                         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a77">IRP_MN_QUERY_DEVICE_TEXT</a>:
01097                         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a79">IRP_MN_READ_CONFIG</a>:
01098                         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a80">IRP_MN_WRITE_CONFIG</a>:
01099                         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a81">IRP_MN_EJECT</a>:
01100                         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a82">IRP_MN_SET_LOCK</a>:
01101                         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a75">IRP_MN_QUERY_RESOURCES</a>:
01102                         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a76">IRP_MN_QUERY_RESOURCE_REQUIREMENTS</a>:
01103                         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a88">IRP_MN_QUERY_LEGACY_BUS_INFORMATION</a>:
01104                             <span class="keywordflow">break</span>;
01105                         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a83">IRP_MN_QUERY_ID</a>:
01106                             <span class="keywordflow">switch</span>(IrpSp-&gt;Parameters.QueryId.IdType) {
01107 
01108                                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a604a421">BusQueryDeviceID</a>:
01109                                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a604a422">BusQueryHardwareIDs</a>:
01110                                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a604a423">BusQueryCompatibleIDs</a>:
01111                                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a604a424">BusQueryInstanceID</a>:
01112                                 <span class="keywordflow">default</span>:
01113                                     <span class="keywordflow">break</span>;
01114                             }
01115                             <span class="keywordflow">break</span> ;
01116                         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a84">IRP_MN_QUERY_PNP_DEVICE_STATE</a>:
01117                         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a85">IRP_MN_QUERY_BUS_INFORMATION</a>:
01118                         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a86">IRP_MN_DEVICE_USAGE_NOTIFICATION</a>:
01119                         <span class="keywordflow">default</span>:
01120                             <span class="keywordflow">break</span> ;
01121                     }
01122                 <span class="keywordflow">default</span>:
01123                     <span class="keywordflow">break</span>;
01124             }
01125         }
01126 
01127         <span class="comment">//</span>
01128         <span class="comment">// Was TargetDeviceRelation implemented correctly?</span>
01129         <span class="comment">//</span>
01130         originalRequestSLD = StackLocationData-&gt;<a class="code" href="../../d9/d1/struct__IOV__STACK__LOCATION.html#o2">RequestsFirstStackLocation</a>;
01131 
01132         <span class="keywordflow">if</span> (originalRequestSLD-&gt;<a class="code" href="../../d9/d1/struct__IOV__STACK__LOCATION.html#o1">Flags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a48">STACKFLAG_CHECK_FOR_REFERENCE</a>) {
01133 
01134             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((IrpSp-&gt;MajorFunction == IRP_MJ_PNP)&amp;&amp;
01135                 (IrpSp-&gt;MinorFunction == IRP_MN_QUERY_DEVICE_RELATIONS)&amp;&amp;
01136                 (IrpSp-&gt;Parameters.QueryDeviceRelations.Type == TargetDeviceRelation));
01137 
01138             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(originalRequestSLD-&gt;<a class="code" href="../../d9/d1/struct__IOV__STACK__LOCATION.html#o8">ReferencingObject</a>);
01139             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IrpTrackingData-&gt;RefTrackingCount);
01140 
01141             referencesTaken = <a class="code" href="../../d8/d4/flunkirp_8h.html#a11">IovpStopObRefMonitoring</a>(
01142                 originalRequestSLD-&gt;<a class="code" href="../../d9/d1/struct__IOV__STACK__LOCATION.html#o8">ReferencingObject</a>,
01143                 originalRequestSLD-&gt;<a class="code" href="../../d9/d1/struct__IOV__STACK__LOCATION.html#o9">ReferencingCount</a>
01144                 );
01145 
01146             IrpTrackingData-&gt;RefTrackingCount--;
01147             originalRequestSLD-&gt;<a class="code" href="../../d9/d1/struct__IOV__STACK__LOCATION.html#o8">ReferencingObject</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01148 
01149             originalRequestSLD-&gt;<a class="code" href="../../d9/d1/struct__IOV__STACK__LOCATION.html#o1">Flags</a>&amp;=~<a class="code" href="../../d9/d4/trackirp_8h.html#a48">STACKFLAG_CHECK_FOR_REFERENCE</a>;
01150 
01151             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(currentStatus)&amp;&amp;(!referencesTaken)) {
01152 
01153                 <a class="code" href="../../d2/d5/ioassert_8h.html#a21">WDM_FAIL_ROUTINE</a>((
01154                     DCERROR_TARGET_RELATION_NEEDS_REF,
01155                     DCPARAM_IRP + DCPARAM_ROUTINE,
01156                     irp,
01157                     routine
01158                     ));
01159             }
01160         }
01161     }
01162 
01163     <span class="comment">//</span>
01164     <span class="comment">// Did anyone stomp the status erroneously?</span>
01165     <span class="comment">//</span>
01166     <span class="keywordflow">if</span> ((currentStatus == STATUS_NOT_SUPPORTED)&amp;&amp;statusChanged) {
01167 
01168         <span class="comment">//</span>
01169         <span class="comment">// Status of a PnP or Power IRP may not be converted from success to</span>
01170         <span class="comment">// STATUS_NOT_SUPPORTED on the way down.</span>
01171         <span class="comment">//</span>
01172         <span class="keywordflow">switch</span>(IrpSp-&gt;MajorFunction) {
01173 
01174             <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a>:
01175 
01176                 <a class="code" href="../../d2/d5/ioassert_8h.html#a21">WDM_FAIL_ROUTINE</a>((
01177                     DCERROR_PNP_IRP_STATUS_RESET,
01178                     DCPARAM_IRP + DCPARAM_ROUTINE,
01179                     irp,
01180                     routine
01181                     ));
01182 
01183                 <span class="keywordflow">break</span>;
01184 
01185             <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a35">IRP_MJ_POWER</a>:
01186 
01187                 <a class="code" href="../../d2/d5/ioassert_8h.html#a21">WDM_FAIL_ROUTINE</a>((
01188                     DCERROR_POWER_IRP_STATUS_RESET,
01189                     DCPARAM_IRP + DCPARAM_ROUTINE,
01190                     irp,
01191                     routine
01192                     ));
01193 
01194                 <span class="keywordflow">break</span>;
01195         }
01196     }
01197 
01198     <span class="comment">//</span>
01199     <span class="comment">// Did they touch something stupid?</span>
01200     <span class="comment">//</span>
01201     <span class="keywordflow">if</span> (IrpTrackingData-&gt;Flags&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a30">TRACKFLAG_BOGUS</a>) {
01202 
01203         <span class="keywordflow">if</span> (statusChanged) {
01204 
01205             <span class="keywordflow">if</span> (IrpSp-&gt;MinorFunction == 0xFF) {
01206 
01207                 <a class="code" href="../../d2/d5/ioassert_8h.html#a21">WDM_FAIL_ROUTINE</a>((
01208                     DCERROR_BOGUS_MINOR_STATUS_TRASHED,
01209                     DCPARAM_IRP + DCPARAM_ROUTINE,
01210                     irp,
01211                     routine
01212                     ));
01213 
01214             } <span class="keywordflow">else</span> {
01215 
01216                 <a class="code" href="../../d2/d5/ioassert_8h.html#a21">WDM_FAIL_ROUTINE</a>((
01217                     DCERROR_BOGUS_STATUS_TRASHED,
01218                     DCPARAM_IRP + DCPARAM_ROUTINE,
01219                     irp,
01220                     routine
01221                     ));
01222             }
01223         }
01224 
01225         <span class="keywordflow">if</span> (infoChanged) {
01226 
01227             <a class="code" href="../../d2/d5/ioassert_8h.html#a21">WDM_FAIL_ROUTINE</a>((
01228                 DCERROR_BOGUS_INFO_TRASHED,
01229                 DCPARAM_IRP + DCPARAM_ROUTINE,
01230                 irp,
01231                 routine
01232                 ));
01233         }
01234     }
01235 
01236     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d4/flunkirp_8h.html#a7">IovpAssertIsValidIrpStatus</a>(IrpSp, currentStatus)) {
01237 
01238         <a class="code" href="../../d2/d5/ioassert_8h.html#a21">WDM_FAIL_ROUTINE</a>(
01239             (DCERROR_INVALID_STATUS, DCPARAM_IRP + DCPARAM_ROUTINE, irp, routine)
01240             );
01241     }
01242 
01243 <span class="comment">/*</span>
01244 <span class="comment">    //</span>
01245 <span class="comment">    // Print out some stuff...</span>
01246 <span class="comment">    //</span>
01247 <span class="comment">    if (RequestFinalized&amp;&amp;(IrpSp-&gt;MajorFunction == IRP_MJ_PNP)) {</span>
01248 <span class="comment">        switch(IrpSp-&gt;MinorFunction) {</span>
01249 <span class="comment"></span>
01250 <span class="comment">            case IRP_MN_QUERY_DEVICE_RELATIONS:</span>
01251 <span class="comment">                if (IrpSp-&gt;Parameters.QueryDeviceRelations.Type != BusRelations) {</span>
01252 <span class="comment">                   break;</span>
01253 <span class="comment">                }</span>
01254 <span class="comment"></span>
01255 <span class="comment">                //</span>
01256 <span class="comment">                // Fall through...</span>
01257 <span class="comment">                //</span>
01258 <span class="comment"></span>
01259 <span class="comment">            case IRP_MN_START_DEVICE:</span>
01260 <span class="comment">            case IRP_MN_REMOVE_DEVICE:</span>
01261 <span class="comment">            case IRP_MN_STOP_DEVICE:</span>
01262 <span class="comment">                possiblePdo = IovpGetLowestDevice(IrpSp-&gt;DeviceObject) ;</span>
01263 <span class="comment">                deviceNode = (PDEVICE_NODE) possiblePdo-&gt;DeviceObjectExtension-&gt;DeviceNode ;</span>
01264 <span class="comment">                if (deviceNode) {</span>
01265 <span class="comment"></span>
01266 <span class="comment">                    strcpy(ansiBuffer, "&lt;not set&gt;") ;</span>
01267 <span class="comment"></span>
01268 <span class="comment">                    if (deviceNode-&gt;InstancePath.Buffer) {</span>
01269 <span class="comment"></span>
01270 <span class="comment">                        KeBugCheckUnicodeToAnsi( &amp;deviceNode-&gt;InstancePath, ansiBuffer, sizeof( ansiBuffer ));</span>
01271 <span class="comment">                    }</span>
01272 <span class="comment"></span>
01273 <span class="comment">                    DbgPrint("PNP: %s ( %08lx) completing IRP_MJ_PNP.%s with %08lx\n",</span>
01274 <span class="comment">                        ansiBuffer,</span>
01275 <span class="comment">                        possiblePdo,</span>
01276 <span class="comment">                        PnPIrpNames[IrpSp-&gt;MinorFunction],</span>
01277 <span class="comment">                        currentStatus</span>
01278 <span class="comment">                        );</span>
01279 <span class="comment">                }</span>
01280 <span class="comment">                ObDereferenceObject(possiblePdo) ;</span>
01281 <span class="comment">                break;</span>
01282 <span class="comment">            default:</span>
01283 <span class="comment">                break;</span>
01284 <span class="comment">        }</span>
01285 <span class="comment">    }</span>
01286 <span class="comment">*/</span>
01287 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="flunkirp.c::IovpAssertIsNewRequest" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IovpAssertIsNewRequest           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpLastSp&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpSp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/flunkirp_8c-source.html#l00089">89</a> of file <a class="el" href="../../d8/d3/flunkirp_8c-source.html">flunkirp.c</a>.
<p>
References <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d8/d3/flunkirp_8c-source.html#l00433">IovpAssertIrpStackDownward()</a>, and <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00493">IovpCallDriver1()</a>.
<p>
<pre class="fragment"><div>00095              :
00096 
00097      Determines whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> two <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> stacks refer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same <span class="stringliteral">"request"</span>,
00098      ie starting <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same device, etc. This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to detect whether an <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>
00099      has been simply forwarded or rather <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> has been reused to initiate
00100      a <span class="keyword">new</span> request.
00101 
00102   Arguments:
00103 
00104      The two <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> stacks to compare.
00105 
00106      N.B. - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not currently part of those <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> stacks.
00107 
00108   Return Value:
00109 
00110      <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> stacks represent <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same request, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
00111 
00112 --*/
00113 {
00114     <span class="keywordflow">return</span> ((IrpLastSp==<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)||
00115         (IrpSp-&gt;MajorFunction != IrpLastSp-&gt;MajorFunction) ||
00116         (IrpSp-&gt;MinorFunction != IrpLastSp-&gt;MinorFunction));
00117 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="flunkirp.c::IovpAssertIsValidIrpStatus" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IovpAssertIsValidIrpStatus           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpSp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN NTSTATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>Status</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/flunkirp_8c-source.html#l01290">1290</a> of file <a class="el" href="../../d8/d3/flunkirp_8c-source.html">flunkirp.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d3/flunkirp_8c-source.html#l00433">IovpAssertIrpStackDownward()</a>, and <a class="el" href="../../d8/d3/flunkirp_8c-source.html#l00870">IovpAssertIrpStackUpward()</a>.
<p>
<pre class="fragment"><div>01296                :
01297         As per <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> title, <span class="keyword">this</span> function determines whether an <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> status <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
01298         valid or probably random trash. See NTStatus.h <span class="keywordflow">for</span> info on how status
01299         codes <span class="keywordflow">break</span> down...
01300 
01301     Returns:
01302 
01303         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> iff <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> status looks to be valid. <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
01304 --*/
01305 {
01306     ULONG severity;
01307     ULONG customer;
01308     ULONG reserved;
01309     ULONG facility;
01310     ULONG code;
01311     ULONG lanManClass;
01312 
01313     severity = (((ULONG)<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) &gt;&gt; 30)&amp;3;
01314     customer = (((ULONG)<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) &gt;&gt; 29)&amp;1;
01315     reserved = (((ULONG)<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) &gt;&gt; 28)&amp;1;
01316     facility = (((ULONG)<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) &gt;&gt; 16)&amp;0xFFF;
01317     code =     (((ULONG)<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) &amp; 0xFFFF);
01318 
01319     <span class="comment">//</span>
01320     <span class="comment">// If reserved set, definitely bogus...</span>
01321     <span class="comment">//</span>
01322     <span class="keywordflow">if</span> (reserved) {
01323 
01324         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01325     }
01326 
01327     <span class="comment">//</span>
01328     <span class="comment">// Is this a microsoft defined return code? If not, do no checking.</span>
01329     <span class="comment">//</span>
01330     <span class="keywordflow">if</span> (customer) {
01331 
01332         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01333     }
01334 
01335     <span class="comment">//</span>
01336     <span class="comment">// ADRIAO N.B. 10/04/1999 -</span>
01337     <span class="comment">//     The current methodology for doling out error codes appears to be</span>
01338     <span class="comment">// fairly chaotic. The primary kernel mode status codes are defined in</span>
01339     <span class="comment">// ntstatus.h. However, rtl\generr.c should also be consulted to see which</span>
01340     <span class="comment">// error codes can bubble up to user mode. Many OLE error codes from</span>
01341     <span class="comment">// winerror.h are now being used within the kernel itself.</span>
01342     <span class="comment">//</span>
01343     <span class="keywordflow">if</span> (facility &lt; 0x20) {
01344 
01345         <span class="comment">//</span>
01346         <span class="comment">// Facilities under 20 are currently legal.</span>
01347         <span class="comment">//</span>
01348         <span class="keywordflow">switch</span>(severity) {
01349             <span class="keywordflow">case</span> STATUS_SEVERITY_SUCCESS:       <span class="keywordflow">return</span> (code &lt; 0x200);
01350             <span class="keywordflow">case</span> STATUS_SEVERITY_INFORMATIONAL:
01351 
01352                 <span class="comment">//</span>
01353                 <span class="comment">// ADRIAO BUGBUG 10/09/1999 -</span>
01354                 <span class="comment">//     This should really be 0x50, but we've been testing with</span>
01355                 <span class="comment">// 0x400 for a while (and we don't want to change it just before</span>
01356                 <span class="comment">// Win2k ships).</span>
01357                 <span class="comment">//</span>
01358                                                 <span class="keywordflow">return</span> (code &lt; 0x400);
01359             <span class="keywordflow">case</span> STATUS_SEVERITY_WARNING:       <span class="keywordflow">return</span> (code &lt; 0x400);
01360             <span class="keywordflow">case</span> STATUS_SEVERITY_ERROR:         <span class="keywordflow">break</span>;
01361         }
01362 
01363         <span class="comment">//</span>
01364         <span class="comment">// Why the heck does WOW use such an odd error code?</span>
01365         <span class="comment">//</span>
01366         <span class="keywordflow">return</span> (code &lt; 0x400)||(code == 0x9898);
01367 
01368     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (facility == 0x98) {
01369 
01370         <span class="comment">//</span>
01371         <span class="comment">// This is the lan manager service. In the case on Lan Man, the code</span>
01372         <span class="comment">// field is further subdivided into a class field.</span>
01373         <span class="comment">//</span>
01374         lanManClass = code &gt;&gt; 12;
01375         code &amp;= 0xFFF;
01376 
01377         <span class="comment">//</span>
01378         <span class="comment">// Do no testing here.</span>
01379         <span class="comment">//</span>
01380         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01381 
01382     } <span class="keywordflow">else</span> {
01383 
01384         <span class="comment">//</span>
01385         <span class="comment">// Not known, probably bogus.</span>
01386         <span class="comment">//</span>
01387         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01388     }
01389 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="flunkirp.c::IovpAssertNewIrps" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IovpAssertNewIrps           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpTrackingData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpSp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d1/struct__IOV__STACK__LOCATION.html">PIOV_STACK_LOCATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>StackLocationData</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/flunkirp_8c-source.html#l00173">173</a> of file <a class="el" href="../../d8/d3/flunkirp_8c-source.html">flunkirp.c</a>.
<p>
References <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00141">PIOV_REQUEST_PACKET</a>, and <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00140">PIOV_STACK_LOCATION</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00493">IovpCallDriver1()</a>.
<p>
<pre class="fragment"><div>00178 {
00179 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="flunkirp.c::IovpAssertNewRequest" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IovpAssertNewRequest           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpTrackingData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpLastSp&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpSp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d1/struct__IOV__STACK__LOCATION.html">PIOV_STACK_LOCATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>StackLocationData</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/flunkirp_8c-source.html#l00191">191</a> of file <a class="el" href="../../d8/d3/flunkirp_8c-source.html">flunkirp.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01974">_DEVICE_CAPABILITIES::Address</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a53">DCERROR_PNP_IRP_BAD_INITIAL_STATUS</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a92">DCERROR_PNP_QUERY_CAP_BAD_ADDRESS</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a91">DCERROR_PNP_QUERY_CAP_BAD_SIZE</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a93">DCERROR_PNP_QUERY_CAP_BAD_UI_NUM</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a90">DCERROR_PNP_QUERY_CAP_BAD_VERSION</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a54">DCERROR_POWER_IRP_BAD_INITIAL_STATUS</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a94">DCERROR_RESTRICTED_IRP</a>, <a class="el" href="../../d2/d5/ioassert_8h.html#a114a55">DCERROR_WMI_IRP_BAD_INITIAL_STATUS</a>, <a class="el" href="../../d3/d4/ioassert_8h-source.html#l00130">DCPARAM_IRP</a>, <a class="el" href="../../d0/d5/io_8h.html#a365">DEVICE_CAPABILITIES</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01274">_DEVOBJ_EXTENSION::DeviceNode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d2/d4/ioassert_8c-source.html#l01320">IopIsMemoryRangeReadable()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l03648">IovpGetLowestDevice()</a>, <a class="el" href="../../d8/d3/flunkirp_8c-source.html#l01788">IovpIsSystemRestrictedIrp()</a>, <a class="el" href="../../d8/d3/flunkirp_8c-source.html#l01664">IovpStartObRefMonitoring()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00082">IRP_MJ_PNP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00077">IRP_MJ_POWER</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00078">IRP_MJ_SYSTEM_CONTROL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00174">IRP_MN_FILTER_RESOURCE_REQUIREMENTS</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00170">IRP_MN_QUERY_CAPABILITIES</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00168">IRP_MN_QUERY_DEVICE_RELATIONS</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d0/d5/io_8h.html#a366">PDEVICE_CAPABILITIES</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01952">_DEVICE_CAPABILITIES::Size</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00096">STACKFLAG_CHECK_FOR_REFERENCE</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00098">STACKFLAG_FIRST_REQUEST</a>, <a class="el" href="../../d0/d5/io_8h.html#a602a416">TargetDeviceRelation</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00081">TRACKFLAG_IO_ALLOCATED</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00083">TRACKFLAG_PASSED_FAILURE</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00080">TRACKFLAG_WATERMARKED</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01975">_DEVICE_CAPABILITIES::UINumber</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01953">_DEVICE_CAPABILITIES::Version</a>, <a class="el" href="../../d3/d4/ioassert_8h-source.html#l00157">WDM_FAIL_CALLER4</a>, and <a class="el" href="../../d3/d4/ioassert_8h-source.html#l00159">WDM_FAIL_CALLER6</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00493">IovpCallDriver1()</a>.
<p>
<pre class="fragment"><div>00198 {
00199     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp = IrpTrackingData-&gt;TrackedIrp;
00200     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> currentStatus, lastStatus;
00201     BOOLEAN newRequest, statusChanged, infoChanged, firstRequest;
00202     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> possiblePdo;
00203     ULONG doeFlags;
00204     <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> driverObject;
00205     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
00206     UCHAR ansiBuffer[ 256 ];
00207     <a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html">PDEVICE_CAPABILITIES</a> deviceCapabilities;
00208 
00209     currentStatus = irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status;
00210     lastStatus = StackLocationData-&gt;RequestsFirstStackLocation-&gt;LastStatusBlock.Status;
00211     statusChanged = (currentStatus != lastStatus);
00212     infoChanged = (irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information != StackLocationData-&gt;RequestsFirstStackLocation-&gt;LastStatusBlock.Information);
00213     firstRequest = ((StackLocationData-&gt;RequestsFirstStackLocation-&gt;Flags&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a50">STACKFLAG_FIRST_REQUEST</a>) != 0);
00214 
00215     <span class="keywordflow">if</span> ((IrpTrackingData-&gt;Flags&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a35">TRACKFLAG_IO_ALLOCATED</a>)&amp;&amp;
00216         (!(IrpTrackingData-&gt;Flags&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a34">TRACKFLAG_WATERMARKED</a>))) {
00217 
00218         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d4/flunkirp_8h.html#a12">IovpIsSystemRestrictedIrp</a>(IrpSp)) {
00219 
00220             <span class="comment">//</span>
00221             <span class="comment">// We've caught somebody initiating an IRP they shouldn't be sending!</span>
00222             <span class="comment">//</span>
00223             <span class="comment">// ADRIAO BUGBUG 01/02/1999 -</span>
00224             <span class="comment">//     This can't be enabled until all the restricted system IRP's</span>
00225             <span class="comment">// in the kernel have been watermarked!</span>
00226             <span class="comment">//</span>
00227 <span class="preprocessor">#if 0</span>
00228 <span class="preprocessor"></span>            <a class="code" href="../../d2/d5/ioassert_8h.html#a18">WDM_FAIL_CALLER4</a>(
00229                 (DCERROR_RESTRICTED_IRP, DCPARAM_IRP, irp)
00230                 );
00231 <span class="preprocessor">#endif</span>
00232 <span class="preprocessor"></span>        }
00233     }
00234 
00235     <span class="comment">//</span>
00236     <span class="comment">// Verify new IRPs start out life accordingly</span>
00237     <span class="comment">//</span>
00238     <span class="keywordflow">switch</span>(IrpSp-&gt;MajorFunction) {
00239 
00240         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a>:
00241 
00242             <span class="keywordflow">if</span> (currentStatus!=STATUS_NOT_SUPPORTED) {
00243 
00244                 <span class="comment">//</span>
00245                 <span class="comment">// This is a special WDM (9x) compatibility hack.</span>
00246                 <span class="comment">//</span>
00247                 <span class="keywordflow">if</span> (IrpSp-&gt;MinorFunction != <a class="code" href="../../d0/d5/io_8h.html#a78">IRP_MN_FILTER_RESOURCE_REQUIREMENTS</a>) {
00248 
00249                     <a class="code" href="../../d2/d5/ioassert_8h.html#a18">WDM_FAIL_CALLER4</a>(
00250                         (DCERROR_PNP_IRP_BAD_INITIAL_STATUS, DCPARAM_IRP, irp)
00251                         );
00252                 }
00253 
00254                 <span class="comment">//</span>
00255                 <span class="comment">// Don't blame anyone else for this guy's mistake.</span>
00256                 <span class="comment">//</span>
00257                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(currentStatus)) {
00258 
00259                     IrpTrackingData-&gt;Flags |= <a class="code" href="../../d9/d4/trackirp_8h.html#a37">TRACKFLAG_PASSED_FAILURE</a>;
00260                 }
00261             }
00262 
00263             <span class="keywordflow">if</span> (IrpSp-&gt;MinorFunction == <a class="code" href="../../d0/d5/io_8h.html#a74">IRP_MN_QUERY_CAPABILITIES</a>) {
00264 
00265                 deviceCapabilities = IrpSp-&gt;Parameters.DeviceCapabilities.Capabilities;
00266 
00267                 <span class="keywordflow">if</span> (<a class="code" href="../../d2/d5/ioassert_8h.html#a113">IopIsMemoryRangeReadable</a>(deviceCapabilities, <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html">DEVICE_CAPABILITIES</a>))) {
00268 
00269                     <span class="comment">//</span>
00270                     <span class="comment">// Verify fields are initialized correctly</span>
00271                     <span class="comment">//</span>
00272                     <span class="keywordflow">if</span> (deviceCapabilities-&gt;<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html#o1">Version</a> &lt; 1) {
00273 
00274                         <span class="comment">//</span>
00275                         <span class="comment">// Whoops, it didn't initialize the version correctly!</span>
00276                         <span class="comment">//</span>
00277                         <a class="code" href="../../d2/d5/ioassert_8h.html#a18">WDM_FAIL_CALLER4</a>(
00278                             (DCERROR_PNP_QUERY_CAP_BAD_VERSION, DCPARAM_IRP, irp)
00279                             );
00280 
00281                     }
00282 
00283                     <span class="keywordflow">if</span> (deviceCapabilities-&gt;<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html#o0">Size</a> &lt; <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html">DEVICE_CAPABILITIES</a>)) {
00284 
00285                         <span class="comment">//</span>
00286                         <span class="comment">// Whoops, it didn't initialize the size field correctly!</span>
00287                         <span class="comment">//</span>
00288                         <a class="code" href="../../d2/d5/ioassert_8h.html#a18">WDM_FAIL_CALLER4</a>(
00289                             (DCERROR_PNP_QUERY_CAP_BAD_SIZE, DCPARAM_IRP, irp)
00290                             );
00291                     }
00292 
00293                     <span class="keywordflow">if</span> (deviceCapabilities-&gt;<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html#o21">Address</a> != (ULONG) -1) {
00294 
00295                         <span class="comment">//</span>
00296                         <span class="comment">// Whoops, it didn't initialize the address field correctly!</span>
00297                         <span class="comment">//</span>
00298                         <a class="code" href="../../d2/d5/ioassert_8h.html#a18">WDM_FAIL_CALLER4</a>(
00299                             (DCERROR_PNP_QUERY_CAP_BAD_ADDRESS, DCPARAM_IRP, irp)
00300                             );
00301                     }
00302 
00303                     <span class="keywordflow">if</span> (deviceCapabilities-&gt;<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html#o22">UINumber</a> != (ULONG) -1) {
00304 
00305                         <span class="comment">//</span>
00306                         <span class="comment">// Whoops, it didn't initialize the UI number field correctly!</span>
00307                         <span class="comment">//</span>
00308                         <a class="code" href="../../d2/d5/ioassert_8h.html#a18">WDM_FAIL_CALLER4</a>(
00309                             (DCERROR_PNP_QUERY_CAP_BAD_UI_NUM, DCPARAM_IRP, irp)
00310                             );
00311                     }
00312                 }
00313             }
00314 
00315             <span class="keywordflow">break</span>;
00316 
00317         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a35">IRP_MJ_POWER</a>:
00318             <span class="keywordflow">if</span> (currentStatus!=STATUS_NOT_SUPPORTED) {
00319 
00320                 <a class="code" href="../../d2/d5/ioassert_8h.html#a20">WDM_FAIL_CALLER6</a>(
00321                     (DCERROR_POWER_IRP_BAD_INITIAL_STATUS, DCPARAM_IRP, irp)
00322                     );
00323 
00324                 <span class="comment">//</span>
00325                 <span class="comment">// Don't blame anyone else for this guy's mistake.</span>
00326                 <span class="comment">//</span>
00327                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(currentStatus)) {
00328 
00329                     IrpTrackingData-&gt;Flags |= <a class="code" href="../../d9/d4/trackirp_8h.html#a37">TRACKFLAG_PASSED_FAILURE</a>;
00330                 }
00331             }
00332             <span class="keywordflow">break</span>;
00333 
00334         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a36">IRP_MJ_SYSTEM_CONTROL</a>:
00335 
00336             <span class="keywordflow">if</span> (currentStatus!=STATUS_NOT_SUPPORTED) {
00337 
00338                 <a class="code" href="../../d2/d5/ioassert_8h.html#a18">WDM_FAIL_CALLER4</a>(
00339                     (DCERROR_WMI_IRP_BAD_INITIAL_STATUS, DCPARAM_IRP, irp)
00340                     );
00341 
00342                 <span class="comment">//</span>
00343                 <span class="comment">// Don't blame anyone else for this guy's mistake.</span>
00344                 <span class="comment">//</span>
00345                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(currentStatus)) {
00346 
00347                     IrpTrackingData-&gt;Flags |= <a class="code" href="../../d9/d4/trackirp_8h.html#a37">TRACKFLAG_PASSED_FAILURE</a>;
00348                 }
00349             }
00350             <span class="keywordflow">break</span>;
00351 
00352         <span class="keywordflow">default</span>:
00353             <span class="keywordflow">break</span>;
00354     }
00355 
00356     <span class="comment">//</span>
00357     <span class="comment">// If this is a target device relation IRP, verify the appropriate</span>
00358     <span class="comment">// object will be referenced.</span>
00359     <span class="comment">//</span>
00360     <span class="keywordflow">if</span> ((IrpSp-&gt;MajorFunction == <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a>)&amp;&amp;
00361         (IrpSp-&gt;MinorFunction == <a class="code" href="../../d0/d5/io_8h.html#a72">IRP_MN_QUERY_DEVICE_RELATIONS</a>)&amp;&amp;
00362         (IrpSp-&gt;Parameters.QueryDeviceRelations.Type == <a class="code" href="../../d0/d5/io_8h.html#a602a416">TargetDeviceRelation</a>)) {
00363 
00364         possiblePdo = <a class="code" href="../../d9/d4/trackirp_8h.html#a128">IovpGetLowestDevice</a>(DeviceObject);
00365         <span class="keywordflow">if</span> (possiblePdo) {
00366 
00367             <span class="keywordflow">if</span> ((possiblePdo-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>)&amp;&amp;(StackLocationData-&gt;ReferencingObject == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00368 
00369                 <span class="comment">//</span>
00370                 <span class="comment">// Got'm!</span>
00371                 <span class="comment">//</span>
00372                 StackLocationData-&gt;Flags |= <a class="code" href="../../d9/d4/trackirp_8h.html#a48">STACKFLAG_CHECK_FOR_REFERENCE</a>;
00373                 StackLocationData-&gt;ReferencingObject = possiblePdo;
00374                 StackLocationData-&gt;ReferencingCount = <a class="code" href="../../d8/d4/flunkirp_8h.html#a10">IovpStartObRefMonitoring</a>(possiblePdo);
00375                 IrpTrackingData-&gt;RefTrackingCount++;
00376             }
00377 
00378             <span class="comment">//</span>
00379             <span class="comment">// Free our reference (we will have one if we are snapshotting anyway)</span>
00380             <span class="comment">//</span>
00381             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(possiblePdo);
00382         }
00383     }
00384 
00385 <span class="comment">/*</span>
00386 <span class="comment">    //</span>
00387 <span class="comment">    // Print out some stuff...</span>
00388 <span class="comment">    //</span>
00389 <span class="comment">    if (IrpSp-&gt;MajorFunction == IRP_MJ_PNP) {</span>
00390 <span class="comment">        switch(IrpSp-&gt;MinorFunction) {</span>
00391 <span class="comment"></span>
00392 <span class="comment">            case IRP_MN_QUERY_DEVICE_RELATIONS:</span>
00393 <span class="comment">                if (IrpSp-&gt;Parameters.QueryDeviceRelations.Type != BusRelations) {</span>
00394 <span class="comment">                    break;</span>
00395 <span class="comment">                }</span>
00396 <span class="comment"></span>
00397 <span class="comment">                //</span>
00398 <span class="comment">                // Fall through...</span>
00399 <span class="comment">                //</span>
00400 <span class="comment"></span>
00401 <span class="comment">            case IRP_MN_START_DEVICE:</span>
00402 <span class="comment">            case IRP_MN_REMOVE_DEVICE:</span>
00403 <span class="comment">            case IRP_MN_STOP_DEVICE:</span>
00404 <span class="comment">                possiblePdo = IovpGetLowestDevice(DeviceObject) ;</span>
00405 <span class="comment">                deviceNode = (PDEVICE_NODE) possiblePdo-&gt;DeviceObjectExtension-&gt;DeviceNode ;</span>
00406 <span class="comment"></span>
00407 <span class="comment">                if (deviceNode) {</span>
00408 <span class="comment"></span>
00409 <span class="comment">                    strcpy(ansiBuffer, "&lt;not set&gt;") ;</span>
00410 <span class="comment"></span>
00411 <span class="comment">                    if (deviceNode-&gt;InstancePath.Buffer) {</span>
00412 <span class="comment"></span>
00413 <span class="comment">                        KeBugCheckUnicodeToAnsi( &amp;deviceNode-&gt;InstancePath, ansiBuffer, sizeof( ansiBuffer ));</span>
00414 <span class="comment">                    }</span>
00415 <span class="comment"></span>
00416 <span class="comment">                    DbgPrint("PNP: %s ( %08lx) initiating IRP_MJ_PNP.%s\n",</span>
00417 <span class="comment">                        ansiBuffer,</span>
00418 <span class="comment">                        possiblePdo,</span>
00419 <span class="comment">                        PnPIrpNames[IrpSp-&gt;MinorFunction]</span>
00420 <span class="comment">                        );</span>
00421 <span class="comment">                }</span>
00422 <span class="comment"></span>
00423 <span class="comment">                ObDereferenceObject(possiblePdo) ;</span>
00424 <span class="comment">                break;</span>
00425 <span class="comment">            default:</span>
00426 <span class="comment">                break;</span>
00427 <span class="comment">        }</span>
00428 <span class="comment">    }</span>
00429 <span class="comment">*/</span>
00430 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="flunkirp.c::IovpIsSystemRestrictedIrp" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IovpIsSystemRestrictedIrp           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>IrpSp</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/flunkirp_8c-source.html#l01788">1788</a> of file <a class="el" href="../../d8/d3/flunkirp_8c-source.html">flunkirp.c</a>.
<p>
References <a class="el" href="../../d0/d5/io_8h.html#a604a423">BusQueryCompatibleIDs</a>, <a class="el" href="../../d0/d5/io_8h.html#a604a421">BusQueryDeviceID</a>, <a class="el" href="../../d0/d5/io_8h.html#a604a422">BusQueryHardwareIDs</a>, <a class="el" href="../../d0/d5/io_8h.html#a604a424">BusQueryInstanceID</a>, <a class="el" href="../../d0/d5/io_8h.html#a602a412">BusRelations</a>, <a class="el" href="../../d0/d5/io_8h.html#a602a413">EjectionRelations</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00082">IRP_MJ_PNP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00077">IRP_MJ_POWER</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00163">IRP_MN_CANCEL_REMOVE_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00166">IRP_MN_CANCEL_STOP_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00183">IRP_MN_DEVICE_USAGE_NOTIFICATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00178">IRP_MN_EJECT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00174">IRP_MN_FILTER_RESOURCE_REQUIREMENTS</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00193">IRP_MN_POWER_SEQUENCE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00182">IRP_MN_QUERY_BUS_INFORMATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00170">IRP_MN_QUERY_CAPABILITIES</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00168">IRP_MN_QUERY_DEVICE_RELATIONS</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00173">IRP_MN_QUERY_DEVICE_TEXT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00180">IRP_MN_QUERY_ID</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00169">IRP_MN_QUERY_INTERFACE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00186">IRP_MN_QUERY_LEGACY_BUS_INFORMATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00181">IRP_MN_QUERY_PNP_DEVICE_STATE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00195">IRP_MN_QUERY_POWER</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00161">IRP_MN_QUERY_REMOVE_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00172">IRP_MN_QUERY_RESOURCE_REQUIREMENTS</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00171">IRP_MN_QUERY_RESOURCES</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00165">IRP_MN_QUERY_STOP_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00176">IRP_MN_READ_CONFIG</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00162">IRP_MN_REMOVE_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00179">IRP_MN_SET_LOCK</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00194">IRP_MN_SET_POWER</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00160">IRP_MN_START_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00164">IRP_MN_STOP_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00184">IRP_MN_SURPRISE_REMOVAL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00192">IRP_MN_WAIT_WAKE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00177">IRP_MN_WRITE_CONFIG</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d0/d5/io_8h.html#a602a414">PowerRelations</a>, <a class="el" href="../../d0/d5/io_8h.html#a602a415">RemovalRelations</a>, <a class="el" href="../../d0/d5/io_8h.html#a602a416">TargetDeviceRelation</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d3/flunkirp_8c-source.html#l00191">IovpAssertNewRequest()</a>.
<p>
<pre class="fragment"><div>01791 {
01792     <span class="keywordflow">switch</span>(IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a>) {
01793 
01794         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a>:
01795             <span class="keywordflow">switch</span>(IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a>) {
01796                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a65">IRP_MN_START_DEVICE</a>:
01797                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a66">IRP_MN_QUERY_REMOVE_DEVICE</a>:
01798                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a67">IRP_MN_REMOVE_DEVICE</a>:
01799                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a68">IRP_MN_CANCEL_REMOVE_DEVICE</a>:
01800                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a69">IRP_MN_STOP_DEVICE</a>:
01801                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a70">IRP_MN_QUERY_STOP_DEVICE</a>:
01802                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a71">IRP_MN_CANCEL_STOP_DEVICE</a>:
01803                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a87">IRP_MN_SURPRISE_REMOVAL</a>:
01804                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01805 
01806                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a72">IRP_MN_QUERY_DEVICE_RELATIONS</a>:
01807                     <span class="keywordflow">switch</span>(IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryDeviceRelations.Type) {
01808                         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a602a412">BusRelations</a>:
01809                         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a602a414">PowerRelations</a>:
01810                             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01811                         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a602a415">RemovalRelations</a>:
01812                         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a602a413">EjectionRelations</a>:
01813                         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a602a416">TargetDeviceRelation</a>:
01814                             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01815                         <span class="keywordflow">default</span>:
01816                             <span class="keywordflow">break</span>;
01817                     }
01818                     <span class="keywordflow">break</span>;
01819                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a73">IRP_MN_QUERY_INTERFACE</a>:
01820                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a74">IRP_MN_QUERY_CAPABILITIES</a>:
01821                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01822                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a78">IRP_MN_FILTER_RESOURCE_REQUIREMENTS</a>:
01823                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a77">IRP_MN_QUERY_DEVICE_TEXT</a>:
01824                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01825                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a79">IRP_MN_READ_CONFIG</a>:
01826                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a80">IRP_MN_WRITE_CONFIG</a>:
01827                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01828                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a81">IRP_MN_EJECT</a>:
01829                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a82">IRP_MN_SET_LOCK</a>:
01830                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a75">IRP_MN_QUERY_RESOURCES</a>:
01831                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a76">IRP_MN_QUERY_RESOURCE_REQUIREMENTS</a>:
01832                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a88">IRP_MN_QUERY_LEGACY_BUS_INFORMATION</a>:
01833                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01834                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a83">IRP_MN_QUERY_ID</a>:
01835                     <span class="keywordflow">switch</span>(IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryId.IdType) {
01836 
01837                         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a604a422">BusQueryHardwareIDs</a>:
01838                         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a604a423">BusQueryCompatibleIDs</a>:
01839                             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01840                         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a604a421">BusQueryDeviceID</a>:
01841                         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a604a424">BusQueryInstanceID</a>:
01842                             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01843                         <span class="keywordflow">default</span>:
01844                             <span class="keywordflow">break</span>;
01845                     }
01846                     <span class="keywordflow">break</span> ;
01847                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a84">IRP_MN_QUERY_PNP_DEVICE_STATE</a>:
01848                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a85">IRP_MN_QUERY_BUS_INFORMATION</a>:
01849                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01850                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a86">IRP_MN_DEVICE_USAGE_NOTIFICATION</a>:
01851                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01852                 <span class="keywordflow">default</span>:
01853                     <span class="keywordflow">break</span> ;
01854             }
01855 
01856         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a35">IRP_MJ_POWER</a>:
01857             <span class="keywordflow">switch</span>(IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a>) {
01858                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a90">IRP_MN_POWER_SEQUENCE</a>:
01859                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01860                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a92">IRP_MN_QUERY_POWER</a>:
01861                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a91">IRP_MN_SET_POWER</a>:
01862                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a89">IRP_MN_WAIT_WAKE</a>:
01863                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01864                 <span class="keywordflow">default</span>:
01865                     <span class="keywordflow">break</span>;
01866             }
01867         <span class="keywordflow">default</span>:
01868             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01869     }
01870 
01871     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01872 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="flunkirp.c::IovpStartObRefMonitoring" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LONG IovpStartObRefMonitoring           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeviceObject</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/flunkirp_8c-source.html#l01664">1664</a> of file <a class="el" href="../../d8/d3/flunkirp_8c-source.html">flunkirp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00368">OBJECT_HEADER_TO_NAME_INFO</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00355">OBJECT_TO_OBJECT_HEADER</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, and <a class="el" href="../../d5/d9/ob_8h-source.html#l00297">_OBJECT_HEADER::PointerCount</a>.
<p>
Referenced by <a class="el" href="../../d8/d3/flunkirp_8c-source.html#l00191">IovpAssertNewRequest()</a>.
<p>
<pre class="fragment"><div>01669              :
01670 
01671      Determines <span class="keywordflow">if</span> ObRef has not been called between a call to <span class="keyword">this</span>
01672      function and a subsequent call to <a class="code" href="../../d7/d4/flunkirp_8c.html#a14">IovpStopObRefMonitoring</a>.
01673 
01674   Arguments:
01675 
01676      Device object to monitor.
01677 
01678   Return Value:
01679 
01680      <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> start skew time to pass into <a class="code" href="../../d7/d4/flunkirp_8c.html#a14">IovpStopObRefMonitoring</a>.
01681 
01682      N.B. - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> reference count <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> taken by <span class="keyword">this</span> API and released
01683             by <a class="code" href="../../d7/d4/flunkirp_8c.html#a14">IovpStopObRefMonitoring</a>. That reference <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not
01684             counted among <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> noticed calls to ObRef.
01685 --*/
01686 {
01687     <span class="comment">//</span>
01688     <span class="comment">// ADRIAO BUGBUG 10/05/1999 -</span>
01689     <span class="comment">//     Parclass reroutes target-device-relation IRPs around the tree. That</span>
01690     <span class="comment">// design will be fixed for NT5.1, but in the meantime this means we will</span>
01691     <span class="comment">// not be able to test this driver functionality.</span>
01692     <span class="comment">//</span>
01693 <span class="preprocessor">#if  0</span>
01694 <span class="preprocessor"></span>    <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
01695     <a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html">POBJECT_HEADER_NAME_INFO</a> NameInfo;
01696     LONG startSkew, pointerCount ;
01697 
01698     <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(DeviceObject) ;
01699 
01700     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>(DeviceObject);
01701     NameInfo = <a class="code" href="../../d4/d0/ob_8h.html#a12">OBJECT_HEADER_TO_NAME_INFO</a>( ObjectHeader );
01702 
01703     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(NameInfo) ;
01704     <span class="comment">//</span>
01705     <span class="comment">// We will always decrement DbgDereferenceCount prior to PointerCount,</span>
01706     <span class="comment">// so any race conditions will look like an increment occured, which</span>
01707     <span class="comment">// is an allowable misread...</span>
01708     <span class="comment">//</span>
01709     <span class="keywordflow">do</span> {
01710         pointerCount = ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o0">PointerCount</a> ;
01711         startSkew = pointerCount - NameInfo-&gt;DbgDereferenceCount ;
01712 
01713     } <span class="keywordflow">while</span>(pointerCount != ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o0">PointerCount</a>) ;
01714 
01715     <span class="keywordflow">return</span> startSkew ;
01716 <span class="preprocessor">#else</span>
01717 <span class="preprocessor"></span>    <span class="keywordflow">return</span> 1;
01718 <span class="preprocessor">#endif</span>
01719 <span class="preprocessor"></span>}

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="flunkirp.c::IovpStopObRefMonitoring" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LONG IovpStopObRefMonitoring           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LONG&nbsp;</td>
          <td class="mdname" nowrap> <em>StartSkew</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/flunkirp_8c-source.html#l01722">1722</a> of file <a class="el" href="../../d8/d3/flunkirp_8c-source.html">flunkirp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00368">OBJECT_HEADER_TO_NAME_INFO</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00355">OBJECT_TO_OBJECT_HEADER</a>, and <a class="el" href="../../d5/d9/ob_8h-source.html#l00297">_OBJECT_HEADER::PointerCount</a>.
<p>
Referenced by <a class="el" href="../../d8/d3/flunkirp_8c-source.html#l00870">IovpAssertIrpStackUpward()</a>.
<p>
<pre class="fragment"><div>01728              :
01729 
01730      Determines <span class="keywordflow">if</span> ObRef has not been called between a call to
01731      <a class="code" href="../../d7/d4/flunkirp_8c.html#a13">IovpStartObRefMonitoring</a> and a call to <span class="keyword">this</span> API.
01732 
01733      In a race condition (say ObDereferenceObject is ran in-simo
01734      with <span class="keyword">this</span> function), <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">return</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> gaurenteed to err on
01735      <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> side of a reference occuring.
01736 
01737   Arguments:
01738 
01739      Device Object and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> skew returned by <a class="code" href="../../d7/d4/flunkirp_8c.html#a13">IovpStartObRefMonitoring</a>
01740 
01741   Return Value:
01742 
01743      Number of calls to ObRef that occured throughout <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> monitored timeframe.
01744      Note that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">return</span> could be positive even though <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> reference count
01745      actually dropped (ie, one ObRef and two ObDeref's).
01746 
01747 --*/
01748 {
01749     <span class="comment">//</span>
01750     <span class="comment">// ADRIAO BUGBUG 10/05/1999 -</span>
01751     <span class="comment">//     Parclass reroutes target-device-relation IRPs around the tree. That</span>
01752     <span class="comment">// design will be fixed for NT5.1, but in the meantime this means we will</span>
01753     <span class="comment">// not be able to test this driver functionality.</span>
01754     <span class="comment">//</span>
01755 <span class="preprocessor">#if  0</span>
01756 <span class="preprocessor"></span>    <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
01757     <a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html">POBJECT_HEADER_NAME_INFO</a> NameInfo;
01758     LONG currentSkew, refDelta, pointerCount ;
01759 
01760     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>(DeviceObject);
01761     NameInfo = <a class="code" href="../../d4/d0/ob_8h.html#a12">OBJECT_HEADER_TO_NAME_INFO</a>( ObjectHeader );
01762 
01763     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(NameInfo) ;
01764 
01765     <span class="comment">//</span>
01766     <span class="comment">// We will always decrement DbgDereferenceCount prior to PointerCount,</span>
01767     <span class="comment">// so any race conditions will look like an increment occured, which</span>
01768     <span class="comment">// is an allowable misread...</span>
01769     <span class="comment">//</span>
01770     <span class="keywordflow">do</span> {
01771         pointerCount = ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o0">PointerCount</a> ;
01772         currentSkew = pointerCount - NameInfo-&gt;DbgDereferenceCount ;
01773 
01774     } <span class="keywordflow">while</span>(pointerCount != ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o0">PointerCount</a>) ;
01775 
01776     refDelta = currentSkew - StartSkew ;
01777     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(refDelta&gt;=0) ;
01778 
01779     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(DeviceObject) ;
01780 
01781     <span class="keywordflow">return</span> refDelta ;
01782 <span class="preprocessor">#else</span>
01783 <span class="preprocessor"></span>    <span class="keywordflow">return</span> 1;
01784 <span class="preprocessor">#endif</span>
01785 <span class="preprocessor"></span>}

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="flunkirp.c::IovpThrowBogusSynchronousIrp" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IovpThrowBogusSynchronousIrp           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TopStackLocation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT OPTIONAL ULONG_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>Information</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT ULONG_PTR *InformationOut&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>IsBogus</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/flunkirp_8c-source.html#l01531">1531</a> of file <a class="el" href="../../d8/d3/flunkirp_8c-source.html">flunkirp.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00652">IoAllocateIrp()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02865">IoCallDriver</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06829">IoGetAttachedDeviceReference()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l01103">IopQueueThreadIrp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00111">IRP_BOGUS</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00690">SPECIALIRP_WATERMARK_IRP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01189">_DEVICE_OBJECT::StackSize</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o38">_IRP::Tail</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01687">_IRP::UserEvent</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01686">_IRP::UserIosb</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d8/d3/flunkirp_8c-source.html#l01392">IovpThrowChaffAtStartedPdoStack()</a>.
<p>
<pre class="fragment"><div>01541                    :
01542 
01543     This function sends a synchronous irp to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> top level device
01544     object which roots on DeviceObject. It differs from IopSynchronousIrp
01545     in that <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IRP_DIAG_IS_BOGUS flag, and passes in possibly
01546     nonzero information.
01547 
01548 Parameters:
01549 
01550     DeviceObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device being removed.
01551 
01552     TopStackLocation - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parameter block <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> irp.
01553 
01554 Return Value:
01555 
01556     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code.
01557 
01558 --*/
01559 
01560 {
01561     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
01562     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
01563     IO_STATUS_BLOCK statusBlock;
01564     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> event;
01565     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01566     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> topDeviceObject;
01567 
01568     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01569 
01570     <span class="comment">//</span>
01571     <span class="comment">// Get a pointer to the topmost device object in the stack of devices,</span>
01572     <span class="comment">// beginning with the deviceObject.</span>
01573     <span class="comment">//</span>
01574 
01575     topDeviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a67">IoGetAttachedDeviceReference</a>(DeviceObject);
01576 
01577     <span class="comment">//</span>
01578     <span class="comment">// Begin by allocating the IRP for this request.  Do not charge quota to</span>
01579     <span class="comment">// the current process for this IRP.</span>
01580     <span class="comment">//</span>
01581 
01582     irp = <a class="code" href="../../d4/d6/iosubs_8c.html#a17">IoAllocateIrp</a>(topDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o13">StackSize</a>, FALSE);
01583     <span class="keywordflow">if</span> (irp == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>){
01584 
01585         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(topDeviceObject) ;
01586         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01587     }
01588 
01589     <span class="keywordflow">if</span> (IsBogus) {
01590 
01591         <a class="code" href="../../d9/d4/trackirp_8h.html#a86">SPECIALIRP_WATERMARK_IRP</a>(irp, IRP_BOGUS);
01592     }
01593 
01594     <span class="comment">//</span>
01595     <span class="comment">// Initialize it to failure.</span>
01596     <span class="comment">//</span>
01597     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = statusBlock.Status = STATUS_NOT_SUPPORTED;
01598     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = statusBlock.Information = Information;
01599 
01600     <span class="comment">//</span>
01601     <span class="comment">// Set the pointer to the status block and initialized event.</span>
01602     <span class="comment">//</span>
01603 
01604     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;event,
01605                        SynchronizationEvent,
01606                        FALSE );
01607 
01608     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a> = &amp;statusBlock;
01609     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a> = &amp;event;
01610 
01611     <span class="comment">//</span>
01612     <span class="comment">// Set the address of the current thread (for debugging)</span>
01613     <span class="comment">//</span>
01614     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
01615 
01616     <span class="comment">//</span>
01617     <span class="comment">// Queue this irp onto the current thread. We do this because we are not</span>
01618     <span class="comment">// collecting this IRP with a STATUS_MORE_PROCESSING_REQUIRED completion</span>
01619     <span class="comment">// routine - an APC will be scheduled and we *must* give it a thread.</span>
01620     <span class="comment">//</span>
01621     <a class="code" href="../../d0/d6/iop_8h.html#a21">IopQueueThreadIrp</a>(irp);
01622 
01623     <span class="comment">//</span>
01624     <span class="comment">// Get a pointer to the stack location of the first driver which will be</span>
01625     <span class="comment">// invoked.  This is where the function codes and parameters are set.</span>
01626     <span class="comment">//</span>
01627 
01628     irpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>(irp);
01629 
01630     <span class="comment">//</span>
01631     <span class="comment">// Copy in the caller-supplied stack location contents</span>
01632     <span class="comment">//</span>
01633 
01634     *irpSp = *TopStackLocation;
01635 
01636     <span class="comment">//</span>
01637     <span class="comment">// Call the driver</span>
01638     <span class="comment">//</span>
01639 
01640     status = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>(topDeviceObject, irp);
01641     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(topDeviceObject) ;
01642 
01643     <span class="comment">//</span>
01644     <span class="comment">// If a driver returns STATUS_PENDING, we will wait for it to complete</span>
01645     <span class="comment">//</span>
01646     <span class="keywordflow">if</span> (status == STATUS_PENDING) {
01647         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;event,
01648                                       Executive,
01649                                       KernelMode,
01650                                       FALSE,
01651                                       (PLARGE_INTEGER) NULL );
01652         status = statusBlock.Status;
01653     }
01654 
01655     <span class="keywordflow">if</span> (InformationOut) {
01656 
01657         *InformationOut = statusBlock.Information ;
01658     }
01659 
01660     <span class="keywordflow">return</span> status;
01661 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="flunkirp.c::IovpThrowChaffAtStartedPdoStack" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IovpThrowChaffAtStartedPdoStack           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeviceObject</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/flunkirp_8c-source.html#l01392">1392</a> of file <a class="el" href="../../d8/d3/flunkirp_8c-source.html">flunkirp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01991">BUS_QUERY_ID_TYPE</a>, <a class="el" href="../../d0/d5/io_8h.html#a358">DEVICE_RELATION_TYPE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02008">DEVICE_TEXT_TYPE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01274">_DEVOBJ_EXTENSION::DeviceNode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00052">HACKFLAG_FOR_ACPI</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00053">HACKFLAG_FOR_BOGUSIRPS</a>, <a class="el" href="../../d0/d5/io_8h.html#a363">INTERFACE</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l03648">IovpGetLowestDevice()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00122">IovpHackFlags</a>, <a class="el" href="../../d8/d3/flunkirp_8c-source.html#l01531">IovpThrowBogusSynchronousIrp()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00082">IRP_MJ_PNP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00077">IRP_MJ_POWER</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00078">IRP_MJ_SYSTEM_CONTROL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00168">IRP_MN_QUERY_DEVICE_RELATIONS</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00173">IRP_MN_QUERY_DEVICE_TEXT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00180">IRP_MN_QUERY_ID</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00169">IRP_MN_QUERY_INTERFACE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d0/d5/io_8h.html#a361">PDEVICE_RELATIONS</a>, <a class="el" href="../../d0/d5/io_8h.html#a602a416">TargetDeviceRelation</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>01397                :
01398         As per <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> title, we are going to <span class="keywordflow">throw</span> some IRPs at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> stack to
01399         see <span class="keywordflow">if</span> they are handled correctly.
01400 
01401     Returns:
01402 
01403         Nothing
01404 --*/
01405 
01406 {
01407     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a> irpSp;
01408     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> lowestDeviceObject;
01409     <a class="code" href="../../d0/d5/struct__DEVICE__RELATIONS.html">PDEVICE_RELATIONS</a> targetDeviceRelationList;
01410     <a class="code" href="../../d8/d3/struct__INTERFACE.html">INTERFACE</a> interface;
01411     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01412 
01413     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01414 
01415     <span class="comment">//</span>
01416     <span class="comment">// Initialize the stack location to pass to IopSynchronousCall()</span>
01417     <span class="comment">//</span>
01418     RtlZeroMemory(&amp;irpSp, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a>));
01419 
01420     <span class="comment">//</span>
01421     <span class="comment">// send lots of bogus PNP IRPs</span>
01422     <span class="comment">//</span>
01423     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a>;
01424     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = 0xff;
01425     <a class="code" href="../../d8/d4/flunkirp_8h.html#a9">IovpThrowBogusSynchronousIrp</a>(DeviceObject, &amp;irpSp, (ULONG_PTR) 0, NULL, TRUE);
01426 
01427     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a72">IRP_MN_QUERY_DEVICE_RELATIONS</a> ;
01428     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryDeviceRelations.Type = (<a class="code" href="../../d0/d5/io_8h.html#a358">DEVICE_RELATION_TYPE</a>) -1 ;
01429     <a class="code" href="../../d8/d4/flunkirp_8h.html#a9">IovpThrowBogusSynchronousIrp</a>(DeviceObject, &amp;irpSp, (ULONG_PTR) 0, NULL, TRUE);
01430 
01431 <span class="preprocessor">#ifdef HACKHACKS_ENABLED</span>
01432 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (!(<a class="code" href="../../d8/d4/trackirp_8c.html#a8">IovpHackFlags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a17">HACKFLAG_FOR_ACPI</a>)) {
01433 <span class="preprocessor">#endif</span>
01434 <span class="preprocessor"></span>        <span class="comment">//</span>
01435         <span class="comment">// ADRIAO HACKHACK 08/16/1999 - Fix ACPI to enable more chaff</span>
01436         <span class="comment">//</span>
01437         irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a72">IRP_MN_QUERY_DEVICE_RELATIONS</a> ;
01438         irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryDeviceRelations.Type = (<a class="code" href="../../d0/d5/io_8h.html#a358">DEVICE_RELATION_TYPE</a>) -1 ;
01439         <a class="code" href="../../d8/d4/flunkirp_8h.html#a9">IovpThrowBogusSynchronousIrp</a>(DeviceObject, &amp;irpSp, (ULONG_PTR) -1, NULL, TRUE) ;
01440 <span class="preprocessor">#ifdef HACKHACKS_ENABLED</span>
01441 <span class="preprocessor"></span>    }
01442 <span class="preprocessor">#endif</span>
01443 <span class="preprocessor"></span>
01444     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a77">IRP_MN_QUERY_DEVICE_TEXT</a> ;
01445     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryDeviceText.DeviceTextType = (<a class="code" href="../../d0/d5/io_8h.html#a605">DEVICE_TEXT_TYPE</a>) -1 ;
01446     <a class="code" href="../../d8/d4/flunkirp_8h.html#a9">IovpThrowBogusSynchronousIrp</a>(DeviceObject, &amp;irpSp, (ULONG_PTR) 0, NULL, TRUE);
01447 
01448     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a83">IRP_MN_QUERY_ID</a> ;
01449     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryId.IdType = (<a class="code" href="../../d0/d5/io_8h.html#a604">BUS_QUERY_ID_TYPE</a>) -1 ;
01450     <a class="code" href="../../d8/d4/flunkirp_8h.html#a9">IovpThrowBogusSynchronousIrp</a>(DeviceObject, &amp;irpSp, (ULONG_PTR) 0, NULL, TRUE);
01451 
01452 <span class="preprocessor">#ifdef HACKHACKS_ENABLED</span>
01453 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (!(<a class="code" href="../../d8/d4/trackirp_8c.html#a8">IovpHackFlags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a18">HACKFLAG_FOR_BOGUSIRPS</a>)) {
01454 <span class="preprocessor">#endif</span>
01455 <span class="preprocessor"></span>
01456         <span class="comment">//</span>
01457         <span class="comment">// Send a bogus WMI IRP</span>
01458         <span class="comment">//</span>
01459         <span class="comment">// Note that we aren't sending this IRP to any stack that doesn't terminate</span>
01460         <span class="comment">// with a devnode. The WmiSystemControl export from WmiLib says</span>
01461         <span class="comment">// "NotWmiIrp if it sees these. The callers should still pass down the</span>
01462         <span class="comment">// IRP.</span>
01463         <span class="comment">//</span>
01464         lowestDeviceObject = <a class="code" href="../../d9/d4/trackirp_8h.html#a128">IovpGetLowestDevice</a>(DeviceObject) ;
01465         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(lowestDeviceObject) ;
01466         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(lowestDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>) ;
01467 
01468         irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a36">IRP_MJ_SYSTEM_CONTROL</a> ;
01469         irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = 0xff;
01470         irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.WMI.ProviderId = (ULONG_PTR) lowestDeviceObject ;
01471         <a class="code" href="../../d8/d4/flunkirp_8h.html#a9">IovpThrowBogusSynchronousIrp</a>(DeviceObject, &amp;irpSp, (ULONG_PTR) 0, NULL, TRUE);
01472         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(lowestDeviceObject) ;
01473 
01474         <span class="comment">//</span>
01475         <span class="comment">// And a bogus Power IRP</span>
01476         <span class="comment">//</span>
01477         irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a35">IRP_MJ_POWER</a> ;
01478         irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = 0xff;
01479         <a class="code" href="../../d8/d4/flunkirp_8h.html#a9">IovpThrowBogusSynchronousIrp</a>(DeviceObject, &amp;irpSp, (ULONG_PTR) 0, NULL, TRUE);
01480 
01481 <span class="preprocessor">#ifdef HACKHACKS_ENABLED</span>
01482 <span class="preprocessor"></span>    }
01483 <span class="preprocessor">#endif</span>
01484 <span class="preprocessor"></span>
01485     <span class="comment">//</span>
01486     <span class="comment">// Target device relation test...</span>
01487     <span class="comment">//</span>
01488     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a> ;
01489     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a72">IRP_MN_QUERY_DEVICE_RELATIONS</a> ;
01490     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryDeviceRelations.Type = <a class="code" href="../../d0/d5/io_8h.html#a602a416">TargetDeviceRelation</a> ;
01491     targetDeviceRelationList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
01492     status = <a class="code" href="../../d8/d4/flunkirp_8h.html#a9">IovpThrowBogusSynchronousIrp</a>(
01493         DeviceObject,
01494         &amp;irpSp,
01495         (ULONG_PTR) 0,
01496         (ULONG_PTR *) &amp;targetDeviceRelationList,
01497         FALSE
01498         );
01499 
01500     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01501 
01502         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(targetDeviceRelationList) ;
01503         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(targetDeviceRelationList-&gt;<a class="code" href="../../d0/d5/struct__DEVICE__RELATIONS.html#o0">Count</a> == 1) ;
01504         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(targetDeviceRelationList-&gt;<a class="code" href="../../d0/d5/struct__DEVICE__RELATIONS.html#o1">Objects</a>[0]) ;
01505         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(targetDeviceRelationList-&gt;<a class="code" href="../../d0/d5/struct__DEVICE__RELATIONS.html#o1">Objects</a>[0]) ;
01506         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(targetDeviceRelationList) ;
01507 
01508     } <span class="keywordflow">else</span> {
01509 
01510         <span class="comment">//</span>
01511         <span class="comment">// IRP was asserted in other code. We need to do nothing here...</span>
01512         <span class="comment">//</span>
01513     }
01514 
01515     RtlZeroMemory(&amp;interface, <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d3/struct__INTERFACE.html">INTERFACE</a>));
01516     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a73">IRP_MN_QUERY_INTERFACE</a>;
01517     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryInterface.Size = -1;
01518     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryInterface.Version = 1;
01519     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryInterface.InterfaceType = &amp;GUID_BOGUS_INTERFACE;
01520     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryInterface.Interface = &amp;interface;
01521     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryInterface.InterfaceSpecificData = (PVOID) -1;
01522     <a class="code" href="../../d8/d4/flunkirp_8h.html#a9">IovpThrowBogusSynchronousIrp</a>(DeviceObject, &amp;irpSp, (ULONG_PTR) 0, NULL, TRUE);
01523 
01524     <span class="comment">//</span>
01525     <span class="comment">// ADRIAO BUGBUG #03 06/05/98 - Need more chaff. Very much more.</span>
01526     <span class="comment">// For example, bogus device usage notifications, etc...</span>
01527     <span class="comment">//</span>
01528 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="flunkirp.c::KeBugCheckUnicodeToAnsi" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PCHAR KeBugCheckUnicodeToAnsi           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>UnicodeString</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>AnsiBuffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>MaxAnsiLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00160">160</a> of file <a class="el" href="../../d0/d1/bugcheck_8c-source.html">bugcheck.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>.
<p>
<pre class="fragment"><div>00165 {
00166     PCHAR Dst;
00167     PWSTR Src;
00168     ULONG Length;
00169 
00170     Length = UnicodeString-&gt;Length / <span class="keyword">sizeof</span>( WCHAR );
00171     <span class="keywordflow">if</span> (Length &gt;= MaxAnsiLength) {
00172         Length = MaxAnsiLength - 1;
00173         }
00174     Src = UnicodeString-&gt;Buffer;
00175     Dst = AnsiBuffer;
00176     <span class="keywordflow">while</span> (Length--) {
00177         *Dst++ = (UCHAR)*Src++;
00178         }
00179     *Dst = <span class="charliteral">'\0'</span>;
00180     <span class="keywordflow">return</span> AnsiBuffer;
00181 }
</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a0" doxytag="flunkirp.c::PnPIrpNames" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PUCHAR <a class="el" href="../../d1/d5/ioassert_8c.html#a23">PnPIrpNames</a>[]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/flunkirp_8c-source.html#l00075">75</a> of file <a class="el" href="../../d8/d3/flunkirp_8c-source.html">flunkirp.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d4/ioassert_8c-source.html#l01516">IopDriverCorrectnessPrintIrpStack()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:43 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
