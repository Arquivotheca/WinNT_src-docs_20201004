<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: pfndec.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>pfndec.c</h1><a href="../../d6/d5/pfndec_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">   pfndec.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains the routines to decrement the share count and</span>
00012 <span class="comment">    the reference counts within the Page Frame Database.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Lou Perazzoli (loup) 5-Apr-1989</span>
00017 <span class="comment">    Landy Wang (landyw) 2-Jun-1997</span>
00018 <span class="comment"></span>
00019 <span class="comment">Revision History:</span>
00020 <span class="comment"></span>
00021 <span class="comment">--*/</span>
00022 
00023 <span class="preprocessor">#include "<a class="code" href="../../d4/d8/mi_8h.html">mi.h</a>"</span>
00024 
<a name="l00025"></a><a class="code" href="../../d6/d5/pfndec_8c.html#a0">00025</a> ULONG <a class="code" href="../../d1/d5/mapcache_8c.html#a1">MmFrontOfList</a>;
00026 
00027 
00028 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00029 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l00030"></a><a class="code" href="../../d6/d5/pfndec_8c.html#a1">00030</a> <a class="code" href="../../d6/d5/pfndec_8c.html#a1">MiDecrementShareCount</a> (
00031     IN PFN_NUMBER PageFrameIndex
00032     )
00033 
00034 <span class="comment">/*++</span>
00035 <span class="comment"></span>
00036 <span class="comment">Routine Description:</span>
00037 <span class="comment"></span>
00038 <span class="comment">    This routine decrements the share count within the PFN element</span>
00039 <span class="comment">    for the specified physical page.  If the share count becomes</span>
00040 <span class="comment">    zero the corresponding PTE is converted to the transition state</span>
00041 <span class="comment">    and the reference count is decremented and the ValidPte count</span>
00042 <span class="comment">    of the PTEframe is decremented.</span>
00043 <span class="comment"></span>
00044 <span class="comment">Arguments:</span>
00045 <span class="comment"></span>
00046 <span class="comment">    PageFrameIndex - Supplies the physical page number of which to decrement</span>
00047 <span class="comment">                     the share count.</span>
00048 <span class="comment"></span>
00049 <span class="comment">Return Value:</span>
00050 <span class="comment"></span>
00051 <span class="comment">    None.</span>
00052 <span class="comment"></span>
00053 <span class="comment">Environment:</span>
00054 <span class="comment"></span>
00055 <span class="comment">    Must be holding the PFN database mutex with APCs disabled.</span>
00056 <span class="comment"></span>
00057 <span class="comment">--*/</span>
00058 
00059 {
00060     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
00061     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00062     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
00063     KIRQL OldIrql;
00064 
00065     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((PageFrameIndex &lt;= <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>) &amp;&amp;
00066             (PageFrameIndex &gt; 0));
00067 
00068     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
00069 
00070     <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation != <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a> &amp;&amp;
00071         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation != <a class="code" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>) {
00072             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (PFN_LIST_CORRUPT,
00073                       0x99,
00074                       PageFrameIndex,
00075                       Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation,
00076                       0);
00077     }
00078 
00079 <span class="preprocessor">#if PFN_CONSISTENCY</span>
00080 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageTablePage == 1) {
00081 
00082         <span class="comment">// Need to run the page and see if the number of transition &amp; valid</span>
00083         <span class="comment">// pages + 1 matches up to the share count.</span>
00084         <span class="comment">//</span>
00085         <span class="comment">// For the page being freed (share == 1), need to snap the caller here</span>
00086 
00087     }
00088 <span class="preprocessor">#endif</span>
00089 <span class="preprocessor"></span>
00090     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount -= 1;
00091 
00092     <a class="code" href="../../d2/d1/mm_8h.html#a40">PERFINFO_DECREFCNT</a>(Pfn1, PERFINFO_LOG_WSCHANGE, PERFINFO_LOG_TYPE_DECSHARCNT)
00093 
00094     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount &lt; 0xF000000);
00095 
00096     <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 0) {
00097 
00098         <a class="code" href="../../d2/d1/mm_8h.html#a40">PERFINFO_DECREFCNT</a>(Pfn1, PERFINFO_LOG_EMPTYQ, PERFINFO_LOG_TYPE_ZEROSHARECOUNT)
00099 
00100         <span class="comment">//</span>
00101         <span class="comment">// The share count is now zero, decrement the reference count</span>
00102         <span class="comment">// for the PFN element and turn the referenced PTE into</span>
00103         <span class="comment">// the transition state if it refers to a prototype PTE.</span>
00104         <span class="comment">// PTEs which are not prototype PTEs do not need to be placed</span>
00105         <span class="comment">// into transition as they are placed in transition when</span>
00106         <span class="comment">// they are removed from the working set (working set free routine).</span>
00107         <span class="comment">//</span>
00108 
00109         <span class="comment">//</span>
00110         <span class="comment">// If the PTE referenced by this PFN element is actually</span>
00111         <span class="comment">// a prototype PTE, it must be mapped into hyperspace and</span>
00112         <span class="comment">// then operated on.</span>
00113         <span class="comment">//</span>
00114 
00115         <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PrototypePte == 1) {
00116 
00117             OldIrql = 99;
00118             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>)) {
00119                 PointerPte = Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>;
00120             } <span class="keywordflow">else</span> {
00121 
00122                 <span class="comment">//</span>
00123                 <span class="comment">// The address is not valid in this process, map it into</span>
00124                 <span class="comment">// hyperspace so it can be operated upon.</span>
00125                 <span class="comment">//</span>
00126 
00127                 PointerPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a>(Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>,
00128                                                            &amp;OldIrql);
00129                 PointerPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)((PCHAR)PointerPte +
00130                                         <a class="code" href="../../d4/d8/mi_8h.html#a110">MiGetByteOffset</a>(Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>));
00131             }
00132 
00133             TempPte = *PointerPte;
00134             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a106">MI_MAKE_VALID_PTE_TRANSITION</a> (TempPte,
00135                                           Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection);
00136             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, TempPte);
00137 
00138             <span class="keywordflow">if</span> (OldIrql != 99) {
00139                 <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql);
00140             }
00141 
00142             <span class="comment">//</span>
00143             <span class="comment">// There is no need to flush the translation buffer at this</span>
00144             <span class="comment">// time as we only invalidated a prototype PTE.</span>
00145             <span class="comment">//</span>
00146 
00147         }
00148 
00149         <span class="comment">//</span>
00150         <span class="comment">// Change the page location to inactive (from active and valid).</span>
00151         <span class="comment">//</span>
00152 
00153         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a178">TransitionPage</a>;
00154 
00155         <span class="comment">//</span>
00156         <span class="comment">// Decrement the reference count as the share count is now zero.</span>
00157         <span class="comment">//</span>
00158 
00159         <a class="code" href="../../d6/d5/pfndec_8c.html#a2">MiDecrementReferenceCount</a> (PageFrameIndex);
00160     }
00161 
00162     <span class="keywordflow">return</span>;
00163 }
00164 
00165 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00166 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l00167"></a><a class="code" href="../../d6/d5/pfndec_8c.html#a2">00167</a> <a class="code" href="../../d6/d5/pfndec_8c.html#a2">MiDecrementReferenceCount</a> (
00168     IN PFN_NUMBER PageFrameIndex
00169     )
00170 
00171 <span class="comment">/*++</span>
00172 <span class="comment"></span>
00173 <span class="comment">Routine Description:</span>
00174 <span class="comment"></span>
00175 <span class="comment">    This routine decrements the reference count for the specified page.</span>
00176 <span class="comment">    If the reference count becomes zero, the page is placed on the</span>
00177 <span class="comment">    appropriate list (free, modified, standby or bad).  If the page</span>
00178 <span class="comment">    is placed on the free or standby list, the number of available</span>
00179 <span class="comment">    pages is incremented and if it transitions from zero to one, the</span>
00180 <span class="comment">    available page event is set.</span>
00181 <span class="comment"></span>
00182 <span class="comment"></span>
00183 <span class="comment">Arguments:</span>
00184 <span class="comment"></span>
00185 <span class="comment">    PageFrameIndex - Supplies the physical page number of which to</span>
00186 <span class="comment">                     decrement the reference count.</span>
00187 <span class="comment"></span>
00188 <span class="comment">Return Value:</span>
00189 <span class="comment"></span>
00190 <span class="comment">    none.</span>
00191 <span class="comment"></span>
00192 <span class="comment">Environment:</span>
00193 <span class="comment"></span>
00194 <span class="comment">    Must be holding the PFN database mutex with APCs disabled.</span>
00195 <span class="comment"></span>
00196 <span class="comment">--*/</span>
00197 
00198 {
00199     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
00200 
00201     <a class="code" href="../../d4/d8/mi_8h.html#a136">MM_PFN_LOCK_ASSERT</a>();
00202 
00203     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PageFrameIndex &lt;= <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>);
00204 
00205     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
00206     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount != 0);
00207     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount -= 1;
00208 
00209 
00210     <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount != 0) {
00211 
00212         <span class="comment">//</span>
00213         <span class="comment">// The reference count is not zero, return.</span>
00214         <span class="comment">//</span>
00215 
00216         <span class="keywordflow">return</span>;
00217     }
00218 
00219     <span class="comment">//</span>
00220     <span class="comment">// The reference count is now zero, put the page on some</span>
00221     <span class="comment">// list.</span>
00222     <span class="comment">//</span>
00223 
00224 
00225     <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount != 0) {
00226 
00227         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (PFN_LIST_CORRUPT,
00228                       7,
00229                       PageFrameIndex,
00230                       Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount,
00231                       0);
00232         <span class="keywordflow">return</span>;
00233     }
00234 
00235     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation != <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>);
00236 
00237     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a121">MI_IS_PFN_DELETED</a> (Pfn1)) {
00238 
00239         <span class="comment">//</span>
00240         <span class="comment">// There is no referenced PTE for this page, delete the page file</span>
00241         <span class="comment">// space (if any), and place the page on the free list.</span>
00242         <span class="comment">//</span>
00243 
00244         <a class="code" href="../../d4/d8/mi_8h.html#a889">MiReleasePageFileSpace</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>);
00245 
00246         <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.RemovalRequested == 1) {
00247             <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (<a class="code" href="../../d4/d8/mi_8h.html#a606">MmPageLocationList</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a176">BadPageList</a>],
00248                                 PageFrameIndex);
00249         }
00250         <span class="keywordflow">else</span> {
00251             <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (<a class="code" href="../../d4/d8/mi_8h.html#a606">MmPageLocationList</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>],
00252                                 PageFrameIndex);
00253         }
00254 
00255         <span class="keywordflow">return</span>;
00256     }
00257 
00258     <span class="comment">//</span>
00259     <span class="comment">// Place the page on the modified or standby list depending</span>
00260     <span class="comment">// on the state of the modify bit in the PFN element.</span>
00261     <span class="comment">//</span>
00262 
00263     <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified == 1) {
00264         <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (<a class="code" href="../../d4/d8/mi_8h.html#a606">MmPageLocationList</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a174">ModifiedPageList</a>], PageFrameIndex);
00265     } <span class="keywordflow">else</span> {
00266 
00267         <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.RemovalRequested == 1) {
00268 
00269             <span class="comment">//</span>
00270             <span class="comment">// The page may still be marked as on the modified list if the</span>
00271             <span class="comment">// current thread is the modified writer completing the write.</span>
00272             <span class="comment">// Mark it as standby so restoration of the transition PTE</span>
00273             <span class="comment">// doesn't flag this as illegal.</span>
00274             <span class="comment">//</span>
00275 
00276             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>;
00277 
00278             <a class="code" href="../../d0/d2/mmsup_8c.html#a15">MiRestoreTransitionPte</a> (PageFrameIndex);
00279             <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (<a class="code" href="../../d4/d8/mi_8h.html#a606">MmPageLocationList</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a176">BadPageList</a>],
00280                                 PageFrameIndex);
00281             <span class="keywordflow">return</span>;
00282         }
00283 
00284         <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d5/mapcache_8c.html#a1">MmFrontOfList</a>) {
00285             <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (<a class="code" href="../../d4/d8/mi_8h.html#a606">MmPageLocationList</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>],
00286                                 PageFrameIndex);
00287         } <span class="keywordflow">else</span> {
00288             <a class="code" href="../../d7/d5/pfnlist_8c.html#a9">MiInsertStandbyListAtFront</a> (PageFrameIndex);
00289         }
00290     }
00291 
00292     <span class="keywordflow">return</span>;
00293 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:09 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
