<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: server/private.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>private.c File Reference</h1><code>#include "<a class="el" href="../../d7/d2/w32_2ntcon_2server_2precomp_8h-source.html">precomp.h</a>"</code><br>

<p>
<a href="../../d8/d3/server_2private_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Classes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d8/struct__MODE__FONT__PAIR.html">_MODE_FONT_PAIR</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/struct__FONTFILEHEADER.html">_FONTFILEHEADER</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d0/struct__FONTINFOHEADER.html">_FONTINFOHEADER</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d9/struct__CPENTRYHEADER.html">_CPENTRYHEADER</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d9/struct__FONTDATAHEADER.html">_FONTDATAHEADER</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d8/struct__SCREENFONTHEADER.html">_SCREENFONTHEADER</a></td></tr>

<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a0">PAL_BLACK</a>&nbsp;&nbsp;&nbsp;0</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a1">PAL_BLUE</a>&nbsp;&nbsp;&nbsp;1</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a2">PAL_GREEN</a>&nbsp;&nbsp;&nbsp;2</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a3">PAL_RED</a>&nbsp;&nbsp;&nbsp;4</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a4">PAL_YELLOW</a>&nbsp;&nbsp;&nbsp;(PAL_RED | PAL_GREEN)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a5">PAL_CYAN</a>&nbsp;&nbsp;&nbsp;(PAL_GREEN | PAL_BLUE)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a6">PAL_MAGENTA</a>&nbsp;&nbsp;&nbsp;(PAL_BLUE | PAL_RED)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a7">PAL_WHITE</a>&nbsp;&nbsp;&nbsp;(PAL_RED | PAL_GREEN | PAL_BLUE)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a8">PAL_I_BLACK</a>&nbsp;&nbsp;&nbsp;(PAL_BLACK      + (PAL_WHITE    &lt;&lt; 3))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a9">PAL_I_RED</a>&nbsp;&nbsp;&nbsp;(PAL_RED        + (PAL_RED      &lt;&lt; 3))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a10">PAL_I_GREEN</a>&nbsp;&nbsp;&nbsp;(PAL_GREEN      + (PAL_GREEN    &lt;&lt; 3))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a11">PAL_I_YELLOW</a>&nbsp;&nbsp;&nbsp;(PAL_YELLOW     + (PAL_YELLOW   &lt;&lt; 3))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a12">PAL_I_BLUE</a>&nbsp;&nbsp;&nbsp;(PAL_BLUE       + (PAL_BLUE     &lt;&lt; 3))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a13">PAL_I_CYAN</a>&nbsp;&nbsp;&nbsp;(PAL_CYAN       + (PAL_CYAN     &lt;&lt; 3))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a14">PAL_I_MAGENTA</a>&nbsp;&nbsp;&nbsp;(PAL_MAGENTA    + (PAL_MAGENTA  &lt;&lt; 3))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a15">PAL_I_WHITE</a>&nbsp;&nbsp;&nbsp;(PAL_WHITE      + (PAL_WHITE    &lt;&lt; 3))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a16">INITIAL_PALETTE_SIZE</a>&nbsp;&nbsp;&nbsp;18</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a17">NUMBER_OF_MODE_FONT_PAIRS</a>&nbsp;&nbsp;&nbsp;5</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a18">CONSOLE_WINDOWS_DIR_LENGTH</a>&nbsp;&nbsp;&nbsp;256</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a19">CONSOLE_EGACPI_LENGTH</a>&nbsp;&nbsp;&nbsp;9</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a20">CONSOLE_EGACPI</a>&nbsp;&nbsp;&nbsp;"\\ega.cpi"</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a21">CONSOLE_FONT_BUFFER_LENGTH</a>&nbsp;&nbsp;&nbsp;50</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a22">CONSOLE_DEFAULT_ROM_FONT</a>&nbsp;&nbsp;&nbsp;437</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a23">CONSOLE_VDM_TIMEOUT</a>&nbsp;&nbsp;&nbsp;200000</td></tr>

<tr><td colspan=2><br><h2>Typedefs</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d9/d8/struct__MODE__FONT__PAIR.html">_MODE_FONT_PAIR</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a26">MODE_FONT_PAIR</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d9/d8/struct__MODE__FONT__PAIR.html">_MODE_FONT_PAIR</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a27">PMODE_FONT_PAIR</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d9/d9/struct__FONTFILEHEADER.html">_FONTFILEHEADER</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a30">FONTFILEHEADER</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d9/d9/struct__FONTFILEHEADER.html">_FONTFILEHEADER</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a31">LPFONTFILEHEADER</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d0/d0/struct__FONTINFOHEADER.html">_FONTINFOHEADER</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a32">FONTINFOHEADER</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d0/d0/struct__FONTINFOHEADER.html">_FONTINFOHEADER</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a33">LPFONTINFOHEADER</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d4/d9/struct__CPENTRYHEADER.html">_CPENTRYHEADER</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a34">CPENTRYHEADER</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d4/d9/struct__CPENTRYHEADER.html">_CPENTRYHEADER</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a35">LPCPENTRYHEADER</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d7/d9/struct__FONTDATAHEADER.html">_FONTDATAHEADER</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a36">FONTDATAHEADER</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d7/d9/struct__FONTDATAHEADER.html">_FONTDATAHEADER</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a37">LPFONTDATAHEADER</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d9/d8/struct__SCREENFONTHEADER.html">_SCREENFONTHEADER</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a38">SCREENFONTHEADER</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d9/d8/struct__SCREENFONTHEADER.html">_SCREENFONTHEADER</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a39">LPSCREENFONTHEADER</a></td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a40">MapViewOfSection</a> (PHANDLE SectionHandle, ULONG CommitSize, PVOID *BaseAddress, PSIZE_T ViewSize, HANDLE ClientHandle, PVOID *BaseClientAddress)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a41">ConnectToEmulator</a> (IN BOOL Connect, IN <a class="el" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a42">SrvSetConsoleCursor</a> (IN OUT PCSR_API_MSG m, IN OUT PCSR_REPLY_STATUS ReplyStatus)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a43">SrvShowConsoleCursor</a> (IN OUT PCSR_API_MSG m, IN OUT PCSR_REPLY_STATUS ReplyStatus)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a44">SrvConsoleMenuControl</a> (IN OUT PCSR_API_MSG m, IN OUT PCSR_REPLY_STATUS ReplyStatus)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a45">SrvSetConsolePalette</a> (IN OUT PCSR_API_MSG m, IN OUT PCSR_REPLY_STATUS ReplyStatus)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a46">SetActivePalette</a> (IN <a class="el" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a47">UnsetActivePalette</a> (IN <a class="el" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a48">ConvertToFullScreen</a> (IN <a class="el" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a49">ConvertToWindowed</a> (IN <a class="el" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a50">SrvSetConsoleDisplayMode</a> (IN OUT PCSR_API_MSG m, IN OUT PCSR_REPLY_STATUS ReplyStatus)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a51">UnregisterVDM</a> (IN <a class="el" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a52">SrvRegisterConsoleVDM</a> (IN OUT PCSR_API_MSG m, IN OUT PCSR_REPLY_STATUS ReplyStatus)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a53">SrvConsoleNotifyLastClose</a> (IN OUT PCSR_API_MSG m, IN OUT PCSR_REPLY_STATUS ReplyStatus)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a54">DisplayModeTransition</a> (IN BOOL bForeground, IN <a class="el" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console, IN <a class="el" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a55">InitializeFullScreen</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a56">SrvGetConsoleHardwareState</a> (IN OUT PCSR_API_MSG m, IN OUT PCSR_REPLY_STATUS ReplyStatus)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a57">SrvSetConsoleHardwareState</a> (IN OUT PCSR_API_MSG m, IN OUT PCSR_REPLY_STATUS ReplyStatus)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a58">SrvGetConsoleDisplayMode</a> (IN OUT PCSR_API_MSG m, IN OUT PCSR_REPLY_STATUS ReplyStatus)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a59">SrvSetConsoleMenuClose</a> (IN OUT PCSR_API_MSG m, IN OUT PCSR_REPLY_STATUS ReplyStatus)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a60">ConvertHotKey</a> (IN LPAPPKEY UserAppKey)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a61">SrvSetConsoleKeyShortcuts</a> (IN OUT PCSR_API_MSG m, IN OUT PCSR_REPLY_STATUS ReplyStatus)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a62">GetThreadConsoleDesktop</a> (<a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwThreadId, HDESK *phdeskConsole)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a63">SetRAMFontCodePage</a> (IN <a class="el" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a64">SetRAMFont</a> (IN <a class="el" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo, IN PCHAR_INFO ScreenBufPtr, IN <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> Length)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a24">InitialPalette</a> [INITIAL_PALETTE_SIZE]</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>UCHAR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a25">ColorBuffer</a> []</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d9/d8/struct__MODE__FONT__PAIR.html">MODE_FONT_PAIR</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a28">ModeFontPairs</a> [<a class="el" href="../../d0/d3/dbcs_8h.html#a23">NUMBER_OF_MODE_FONT_PAIRS</a>]</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>HANDLE&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/server_2private_8c.html#a29">hCPIFile</a></td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a22" doxytag="server/private.c::CONSOLE_DEFAULT_ROM_FONT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CONSOLE_DEFAULT_ROM_FONT&nbsp;&nbsp;&nbsp;437          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00174">174</a> of file <a class="el" href="../../d8/d3/server_2private_8c-source.html">server/private.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="server/private.c::CONSOLE_EGACPI" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CONSOLE_EGACPI&nbsp;&nbsp;&nbsp;"\\ega.cpi"          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00172">172</a> of file <a class="el" href="../../d8/d3/server_2private_8c-source.html">server/private.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d3/server_2private_8c-source.html#l02089">InitializeFullScreen()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="server/private.c::CONSOLE_EGACPI_LENGTH" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CONSOLE_EGACPI_LENGTH&nbsp;&nbsp;&nbsp;9          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00171">171</a> of file <a class="el" href="../../d8/d3/server_2private_8c-source.html">server/private.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d3/server_2private_8c-source.html#l02089">InitializeFullScreen()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="server/private.c::CONSOLE_FONT_BUFFER_LENGTH" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CONSOLE_FONT_BUFFER_LENGTH&nbsp;&nbsp;&nbsp;50          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00173">173</a> of file <a class="el" href="../../d8/d3/server_2private_8c-source.html">server/private.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="server/private.c::CONSOLE_VDM_TIMEOUT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CONSOLE_VDM_TIMEOUT&nbsp;&nbsp;&nbsp;200000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/server_2private_8c-source.html#l01564">1564</a> of file <a class="el" href="../../d8/d3/server_2private_8c-source.html">server/private.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d3/server_2private_8c-source.html#l01567">DisplayModeTransition()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="server/private.c::CONSOLE_WINDOWS_DIR_LENGTH" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CONSOLE_WINDOWS_DIR_LENGTH&nbsp;&nbsp;&nbsp;256          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00170">170</a> of file <a class="el" href="../../d8/d3/server_2private_8c-source.html">server/private.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d3/server_2private_8c-source.html#l02089">InitializeFullScreen()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="server/private.c::INITIAL_PALETTE_SIZE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define INITIAL_PALETTE_SIZE&nbsp;&nbsp;&nbsp;18          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00055">55</a> of file <a class="el" href="../../d8/d3/server_2private_8c-source.html">server/private.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="server/private.c::NUMBER_OF_MODE_FONT_PAIRS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define <a class="el" href="../../d0/d3/dbcs_8h.html#a23">NUMBER_OF_MODE_FONT_PAIRS</a>&nbsp;&nbsp;&nbsp;5          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00118">118</a> of file <a class="el" href="../../d8/d3/server_2private_8c-source.html">server/private.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d3/server_2private_8c-source.html#l02089">InitializeFullScreen()</a>, and <a class="el" href="../../d8/d3/server_2private_8c-source.html#l02280">SrvSetConsoleHardwareState()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="server/private.c::PAL_BLACK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PAL_BLACK&nbsp;&nbsp;&nbsp;0          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00037">37</a> of file <a class="el" href="../../d8/d3/server_2private_8c-source.html">server/private.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="server/private.c::PAL_BLUE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PAL_BLUE&nbsp;&nbsp;&nbsp;1          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00038">38</a> of file <a class="el" href="../../d8/d3/server_2private_8c-source.html">server/private.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="server/private.c::PAL_CYAN" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PAL_CYAN&nbsp;&nbsp;&nbsp;(PAL_GREEN | PAL_BLUE)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00042">42</a> of file <a class="el" href="../../d8/d3/server_2private_8c-source.html">server/private.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="server/private.c::PAL_GREEN" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PAL_GREEN&nbsp;&nbsp;&nbsp;2          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00039">39</a> of file <a class="el" href="../../d8/d3/server_2private_8c-source.html">server/private.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="server/private.c::PAL_I_BLACK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PAL_I_BLACK&nbsp;&nbsp;&nbsp;(PAL_BLACK      + (PAL_WHITE    &lt;&lt; 3))          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00046">46</a> of file <a class="el" href="../../d8/d3/server_2private_8c-source.html">server/private.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="server/private.c::PAL_I_BLUE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PAL_I_BLUE&nbsp;&nbsp;&nbsp;(PAL_BLUE       + (PAL_BLUE     &lt;&lt; 3))          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00050">50</a> of file <a class="el" href="../../d8/d3/server_2private_8c-source.html">server/private.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="server/private.c::PAL_I_CYAN" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PAL_I_CYAN&nbsp;&nbsp;&nbsp;(PAL_CYAN       + (PAL_CYAN     &lt;&lt; 3))          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00051">51</a> of file <a class="el" href="../../d8/d3/server_2private_8c-source.html">server/private.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="server/private.c::PAL_I_GREEN" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PAL_I_GREEN&nbsp;&nbsp;&nbsp;(PAL_GREEN      + (PAL_GREEN    &lt;&lt; 3))          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00048">48</a> of file <a class="el" href="../../d8/d3/server_2private_8c-source.html">server/private.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="server/private.c::PAL_I_MAGENTA" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PAL_I_MAGENTA&nbsp;&nbsp;&nbsp;(PAL_MAGENTA    + (PAL_MAGENTA  &lt;&lt; 3))          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00052">52</a> of file <a class="el" href="../../d8/d3/server_2private_8c-source.html">server/private.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="server/private.c::PAL_I_RED" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PAL_I_RED&nbsp;&nbsp;&nbsp;(PAL_RED        + (PAL_RED      &lt;&lt; 3))          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00047">47</a> of file <a class="el" href="../../d8/d3/server_2private_8c-source.html">server/private.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="server/private.c::PAL_I_WHITE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PAL_I_WHITE&nbsp;&nbsp;&nbsp;(PAL_WHITE      + (PAL_WHITE    &lt;&lt; 3))          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00053">53</a> of file <a class="el" href="../../d8/d3/server_2private_8c-source.html">server/private.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="server/private.c::PAL_I_YELLOW" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PAL_I_YELLOW&nbsp;&nbsp;&nbsp;(PAL_YELLOW     + (PAL_YELLOW   &lt;&lt; 3))          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00049">49</a> of file <a class="el" href="../../d8/d3/server_2private_8c-source.html">server/private.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="server/private.c::PAL_MAGENTA" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PAL_MAGENTA&nbsp;&nbsp;&nbsp;(PAL_BLUE | PAL_RED)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00043">43</a> of file <a class="el" href="../../d8/d3/server_2private_8c-source.html">server/private.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="server/private.c::PAL_RED" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PAL_RED&nbsp;&nbsp;&nbsp;4          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00040">40</a> of file <a class="el" href="../../d8/d3/server_2private_8c-source.html">server/private.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="server/private.c::PAL_WHITE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PAL_WHITE&nbsp;&nbsp;&nbsp;(PAL_RED | PAL_GREEN | PAL_BLUE)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00044">44</a> of file <a class="el" href="../../d8/d3/server_2private_8c-source.html">server/private.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="server/private.c::PAL_YELLOW" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PAL_YELLOW&nbsp;&nbsp;&nbsp;(PAL_RED | PAL_GREEN)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00041">41</a> of file <a class="el" href="../../d8/d3/server_2private_8c-source.html">server/private.c</a>.    </td>
  </tr>
</table>
<hr><h2>Typedef Documentation</h2>
<a class="anchor" name="a34" doxytag="server/private.c::CPENTRYHEADER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d4/d9/struct__CPENTRYHEADER.html">_CPENTRYHEADER</a>  <a class="el" href="../../d4/d9/struct__CPENTRYHEADER.html">CPENTRYHEADER</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a36" doxytag="server/private.c::FONTDATAHEADER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d7/d9/struct__FONTDATAHEADER.html">_FONTDATAHEADER</a>  <a class="el" href="../../d7/d9/struct__FONTDATAHEADER.html">FONTDATAHEADER</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a30" doxytag="server/private.c::FONTFILEHEADER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d9/d9/struct__FONTFILEHEADER.html">_FONTFILEHEADER</a>  <a class="el" href="../../d9/d9/struct__FONTFILEHEADER.html">FONTFILEHEADER</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a32" doxytag="server/private.c::FONTINFOHEADER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d0/d0/struct__FONTINFOHEADER.html">_FONTINFOHEADER</a>  <a class="el" href="../../d0/d0/struct__FONTINFOHEADER.html">FONTINFOHEADER</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a35" doxytag="server/private.c::LPCPENTRYHEADER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d4/d9/struct__CPENTRYHEADER.html">_CPENTRYHEADER</a> * <a class="el" href="../../d4/d9/struct__CPENTRYHEADER.html">LPCPENTRYHEADER</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a37" doxytag="server/private.c::LPFONTDATAHEADER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d7/d9/struct__FONTDATAHEADER.html">_FONTDATAHEADER</a> * <a class="el" href="../../d7/d9/struct__FONTDATAHEADER.html">LPFONTDATAHEADER</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a31" doxytag="server/private.c::LPFONTFILEHEADER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d9/d9/struct__FONTFILEHEADER.html">_FONTFILEHEADER</a> * <a class="el" href="../../d9/d9/struct__FONTFILEHEADER.html">LPFONTFILEHEADER</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a33" doxytag="server/private.c::LPFONTINFOHEADER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d0/d0/struct__FONTINFOHEADER.html">_FONTINFOHEADER</a> * <a class="el" href="../../d0/d0/struct__FONTINFOHEADER.html">LPFONTINFOHEADER</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a39" doxytag="server/private.c::LPSCREENFONTHEADER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d9/d8/struct__SCREENFONTHEADER.html">_SCREENFONTHEADER</a> * <a class="el" href="../../d9/d8/struct__SCREENFONTHEADER.html">LPSCREENFONTHEADER</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="server/private.c::MODE_FONT_PAIR" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d9/d8/struct__MODE__FONT__PAIR.html">_MODE_FONT_PAIR</a>  <a class="el" href="../../d9/d8/struct__MODE__FONT__PAIR.html">MODE_FONT_PAIR</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a27" doxytag="server/private.c::PMODE_FONT_PAIR" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d9/d8/struct__MODE__FONT__PAIR.html">_MODE_FONT_PAIR</a>  <a class="el" href="../../d9/d8/struct__MODE__FONT__PAIR.html">PMODE_FONT_PAIR</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a38" doxytag="server/private.c::SCREENFONTHEADER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d9/d8/struct__SCREENFONTHEADER.html">_SCREENFONTHEADER</a>  <a class="el" href="../../d9/d8/struct__SCREENFONTHEADER.html">SCREENFONTHEADER</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a41" doxytag="server/private.c::ConnectToEmulator" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ConnectToEmulator           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN BOOL&nbsp;</td>
          <td class="mdname" nowrap> <em>Connect</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Console</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/server_2private_8c-source.html#l01519">1519</a> of file <a class="el" href="../../d8/d3/server_2private_8c-source.html">server/private.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00098">CONSOLE_CONNECTED_TO_EMULATOR</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00087">CONSOLE_HAS_FOCUS</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00042">DBGFULLSCR</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l07575">NtUserSetInformationThread()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02843">TIF_DOSEMULATOR</a>.
<p>
Referenced by <a class="el" href="../../d8/d3/server_2private_8c-source.html#l01567">DisplayModeTransition()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l01094">SrvRegisterConsoleVDM()</a>, and <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00980">UnregisterVDM()</a>.
<p>
<pre class="fragment"><div>01523 {
01524     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01525     FULLSCREENCONTROL fsctl;
01526     VIDEO_VDM ConnectInfo;
01527     HANDLE ProcessHandle = Console-&gt;VDMProcessHandle;
01528     USERTHREAD_FLAGS Flags;
01529 
01530     <a class="code" href="../../d8/d5/consrv_8h.html#a4">DBGFULLSCR</a>((<span class="stringliteral">"ConnectToEmulator :  %s - entering\n"</span>, Connect ? <span class="stringliteral">"CONNECT"</span> : <span class="stringliteral">"DISCONNECT"</span>));
01531 
01532     Flags.dwMask = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a811">TIF_DOSEMULATOR</a>;
01533     <span class="keywordflow">if</span> (Connect) {
01534         fsctl = FullscreenControlEnable;
01535         Console-&gt;Flags |= <a class="code" href="../../d1/d7/server_8h.html#a13">CONSOLE_CONNECTED_TO_EMULATOR</a>;
01536         Flags.dwFlags = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a811">TIF_DOSEMULATOR</a>;
01537     } <span class="keywordflow">else</span> {
01538         fsctl = FullscreenControlDisable;
01539         Console-&gt;Flags &amp;= ~<a class="code" href="../../d1/d7/server_8h.html#a13">CONSOLE_CONNECTED_TO_EMULATOR</a>;
01540         Flags.dwFlags = 0;
01541     }
01542 
01543     <span class="keywordflow">if</span> (Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a2">CONSOLE_HAS_FOCUS</a>) {
01544         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a277">NtUserSetInformationThread</a>(Console-&gt;InputThreadInfo-&gt;ThreadHandle,
01545                 UserThreadFlags, &amp;Flags, <span class="keyword">sizeof</span>(Flags));
01546     }
01547 
01548     ConnectInfo.ProcessHandle = ProcessHandle;
01549 
01550 
01551     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GdiFullscreenControl(fsctl,
01552                                      &amp;ConnectInfo,
01553                                      <span class="keyword">sizeof</span>(ConnectInfo),
01554                                      NULL,
01555                                      NULL);
01556 
01557     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Status == STATUS_SUCCESS || Status == STATUS_PROCESS_IS_TERMINATING);
01558 
01559     <a class="code" href="../../d8/d5/consrv_8h.html#a4">DBGFULLSCR</a>((<span class="stringliteral">"ConnectToEmulator : leaving, staus = %08lx\n"</span>, Status));
01560 
01561     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01562 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a60" doxytag="server/private.c::ConvertHotKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> ConvertHotKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN LPAPPKEY&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>UserAppKey</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/server_2private_8c-source.html#l02403">2403</a> of file <a class="el" href="../../d8/d3/server_2private_8c-source.html">server/private.c</a>.
<p>
References <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, and <a class="el" href="../../d1/d7/ntcftxt_8h-source.html#l00339">MapVirtualKey()</a>.
<p>
Referenced by <a class="el" href="../../d8/d3/server_2private_8c-source.html#l02423">SrvSetConsoleKeyShortcuts()</a>.
<p>
<pre class="fragment"><div>02406 {
02407     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> wParam;
02408 
02409     wParam = <a class="code" href="../../d0/d8/ntcftxt_8h.html#a18">MapVirtualKey</a>(UserAppKey-&gt;ScanCode,1);
02410     <span class="keywordflow">if</span> (UserAppKey-&gt;Modifier &amp; CONSOLE_MODIFIER_SHIFT) {
02411         wParam |= 0x0100;
02412     }
02413     <span class="keywordflow">if</span> (UserAppKey-&gt;Modifier &amp; CONSOLE_MODIFIER_CONTROL) {
02414         wParam |= 0x0200;
02415     }
02416     <span class="keywordflow">if</span> (UserAppKey-&gt;Modifier &amp; CONSOLE_MODIFIER_ALT) {
02417         wParam |= 0x0400;
02418     }
02419     <span class="keywordflow">return</span> wParam;
02420 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a48" doxytag="server/private.c::ConvertToFullScreen" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ConvertToFullScreen           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Console</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00603">603</a> of file <a class="el" href="../../d8/d3/server_2private_8c-source.html">server/private.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">_SCREEN_INFORMATION::BufferInfo</a>, <a class="el" href="../../d8/d1/output_8h-source.html#l00149">CONSOLE_GRAPHICS_BUFFER</a>, <a class="el" href="../../d8/d1/output_8h-source.html#l00150">CONSOLE_OEMFONT_DISPLAY</a>, <a class="el" href="../../d8/d1/output_8h-source.html#l00148">CONSOLE_TEXTMODE_BUFFER</a>, <a class="el" href="../../d8/d1/output_8h-source.html#l00269">CONSOLE_WINDOW_SIZE_X</a>, <a class="el" href="../../d8/d1/output_8h-source.html#l00270">CONSOLE_WINDOW_SIZE_Y</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00040">DBGCHARS</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d9/w32_2ntcon_2server_2misc_8c-source.html#l01676">FalseUnicodeToRealUnicode()</a>, <a class="el" href="../../d8/d1/output_8h-source.html#l00154">_SCREEN_INFORMATION::Flags</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00332">max</a>, <a class="el" href="../../d8/d1/output_8h-source.html#l00177">_SCREEN_INFORMATION::Next</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d1/output_8c-source.html#l02231">ResizeScreenBuffer()</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00112">SCR_FACENAME()</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00104">SCR_FAMILY()</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00124">SCR_FONTCODEPAGE()</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00108">SCR_FONTNUMBER()</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00116">SCR_FONTSIZE()</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00120">SCR_FONTWEIGHT()</a>, <a class="el" href="../../d8/d1/output_8h-source.html#l00158">_SCREEN_INFORMATION::ScreenBufferSize</a>, <a class="el" href="../../d7/d1/output_8c-source.html#l03953">SetWindowSize()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d5/d9/w32_2ntcon_2server_2misc_8c-source.html#l00881">StoreTextBufferFontInfo()</a>, <a class="el" href="../../d8/d1/output_8h-source.html#l00212">TEXT_VALID_HINT</a>, <a class="el" href="../../d8/d1/output_8h-source.html#l00159">_SCREEN_INFORMATION::Window</a>, and <a class="el" href="../../d7/d7/dispatch_8h-source.html#l00061">WriteToScreen</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/output_8c-source.html#l04700">ConsoleWindowProc()</a>, <a class="el" href="../../d7/d1/output_8c-source.html#l00834">CreateWindowsWindow()</a>, <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l02272">HandleSysKeyEvent()</a>, and <a class="el" href="../../d2/d6/ntcon_2server_2menu_8c-source.html#l00459">PropertiesUpdate()</a>.
<p>
<pre class="fragment"><div>00606 {
00607 <span class="preprocessor">#ifdef i386</span>
00608 <span class="preprocessor"></span>    <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> Cur;
00609     COORD WindowedWindowSize, WindowSize;
00610 
00611     <span class="comment">// for each charmode screenbuffer</span>
00612     <span class="comment">//     match window size to a mode/font</span>
00613     <span class="comment">//     grow screen buffer if necessary</span>
00614     <span class="comment">//     save old window dimensions</span>
00615     <span class="comment">//     set new window dimensions</span>
00616 
00617     <span class="keywordflow">for</span> (Cur=Console-&gt;ScreenBuffers;Cur!=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;Cur=Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o23">Next</a>) {
00618 
00619         <span class="keywordflow">if</span> (Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o1">Flags</a> &amp; <a class="code" href="../../d7/d2/output_8h.html#a1">CONSOLE_GRAPHICS_BUFFER</a>) {
00620             <span class="keywordflow">continue</span>;
00621         }
00622 
00623         <span class="comment">// save old window dimensions</span>
00624 
00625         WindowedWindowSize.X = <a class="code" href="../../d7/d2/output_8h.html#a17">CONSOLE_WINDOW_SIZE_X</a>(Cur);
00626         WindowedWindowSize.Y = <a class="code" href="../../d7/d2/output_8h.html#a18">CONSOLE_WINDOW_SIZE_Y</a>(Cur);
00627 
00628         Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.WindowedWindowSize = WindowedWindowSize;
00629         Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.WindowedScreenSize = Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>;
00630 
00631         <span class="comment">// match window size to a mode/font</span>
00632 
00633         Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.ModeIndex = MatchWindowSize(
00634                 Console-&gt;OutputCP,
00635                 Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>, &amp;WindowSize);
00636 
00637         <span class="comment">// grow screen buffer if necessary</span>
00638 
00639         <span class="keywordflow">if</span> (WindowSize.X &gt; Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.X ||
00640             WindowSize.Y &gt; Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.Y) {
00641             COORD NewScreenSize;
00642 
00643             NewScreenSize.X = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(WindowSize.X,Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.X);
00644             NewScreenSize.Y = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(WindowSize.Y,Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.Y);
00645 
00646             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/output_8c.html#a58">ResizeScreenBuffer</a>(Cur, NewScreenSize, FALSE) == STATUS_INVALID_HANDLE) {
00647                 <span class="keywordflow">return</span> STATUS_INVALID_HANDLE;
00648             }
00649         }
00650 
00651 <span class="preprocessor">#if 0</span>
00652 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"new window size is %d %d\n"</span>,WindowSize.X,WindowSize.Y);
00653 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"existing window size is %d %d\n"</span>,WindowedWindowSize.X,WindowedWindowSize.Y);
00654 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"existing window is %d %d %d %d\n"</span>,Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Left,Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Top,Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Right,Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Bottom);
00655 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"screenbuffersize is %d %d\n"</span>,Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.X,Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.Y);
00656 <span class="preprocessor">#endif</span>
00657 <span class="preprocessor"></span>        <span class="comment">// set new window dimensions</span>
00658         <span class="comment">// we always resize horizontally from the right (change the</span>
00659         <span class="comment">// right edge).</span>
00660         <span class="comment">// we resize vertically from the bottom, keeping the cursor visible.</span>
00661 
00662         <span class="keywordflow">if</span> (WindowedWindowSize.X != WindowSize.X) {
00663             Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Right -= WindowedWindowSize.X - WindowSize.X;
00664             <span class="keywordflow">if</span> (Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Right &gt;= Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.X) {
00665                 Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Left -= Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Right - Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.X + 1;
00666                 Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Right -= Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Right - Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.X + 1;
00667             }
00668         }
00669         <span class="keywordflow">if</span> (WindowedWindowSize.Y &gt; WindowSize.Y) {
00670             Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Bottom -= WindowedWindowSize.Y - WindowSize.Y;
00671             <span class="keywordflow">if</span> (Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Bottom &gt;= Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.Y) {
00672                 Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Top -= Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Bottom - Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.Y + 1;
00673                 Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Bottom = Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.Y - 1;
00674             }
00675         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (WindowedWindowSize.Y &lt; WindowSize.Y) {
00676             Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Top -= WindowSize.Y - WindowedWindowSize.Y;
00677             <span class="keywordflow">if</span> (Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Top &lt; 0) {
00678                 Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Bottom -= Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Top;
00679                 Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Top = 0;
00680             }
00681         }
00682         <span class="keywordflow">if</span> (Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.Y &gt; Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Bottom) {
00683             Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Top += Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.Y - Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Bottom;
00684             Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Bottom = Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.Y;
00685         }
00686 <span class="preprocessor">#if 0</span>
00687 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"new window is %d %d %d %d\n"</span>,Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Left,Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Top,Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Right,Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Bottom);
00688 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"cursor is %d %d\n"</span>,Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.X,Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.Y);
00689 <span class="preprocessor">#endif</span>
00690 <span class="preprocessor"></span>        <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(WindowSize.X == <a class="code" href="../../d7/d2/output_8h.html#a17">CONSOLE_WINDOW_SIZE_X</a>(Cur));
00691         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(WindowSize.Y == <a class="code" href="../../d7/d2/output_8h.html#a18">CONSOLE_WINDOW_SIZE_Y</a>(Cur));
00692         Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.MousePosition.X = Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Left;
00693         Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.MousePosition.Y = Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Top;
00694 
00695         <span class="keywordflow">if</span> (Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o1">Flags</a> &amp; <a class="code" href="../../d7/d2/output_8h.html#a2">CONSOLE_OEMFONT_DISPLAY</a>) {
00696             <a class="code" href="../../d8/d5/consrv_8h.html#a2">DBGCHARS</a>((<span class="stringliteral">"ConvertToFullScreen converts UnicodeOem -&gt; Unicode\n"</span>));
00697             <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a43">FalseUnicodeToRealUnicode</a>(
00698                     Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.TextRows,
00699                     Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.X * Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.Y,
00700                     Console-&gt;OutputCP);
00701         } <span class="keywordflow">else</span> {
00702             <a class="code" href="../../d8/d5/consrv_8h.html#a2">DBGCHARS</a>((<span class="stringliteral">"ConvertToFullScreen needs no conversion\n"</span>));
00703         }
00704         <a class="code" href="../../d8/d5/consrv_8h.html#a2">DBGCHARS</a>((<span class="stringliteral">"Cur-&gt;BufferInfo.TextInfo.Rows = %lx\n"</span>,
00705                 Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.Rows));
00706         <a class="code" href="../../d8/d5/consrv_8h.html#a2">DBGCHARS</a>((<span class="stringliteral">"Cur-&gt;BufferInfo.TextInfo.TextRows = %lx\n"</span>,
00707                 Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.TextRows));
00708     }
00709 
00710     Cur = Console-&gt;CurrentScreenBuffer;
00711 
00712     <span class="keywordflow">if</span> (Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o1">Flags</a> &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>) {
00713         <span class="keywordflow">if</span> (CONSOLE_IS_DBCS_OUTPUTCP(Console)) {
00714             PCONVERSIONAREA_INFORMATION ConvAreaInfo;
00715             ConvAreaInfo = Console-&gt;ConsoleIme.ConvAreaRoot;
00716             <span class="keywordflow">while</span> (ConvAreaInfo) {
00717                 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00718 
00719                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a27">StoreTextBufferFontInfo</a>(ConvAreaInfo-&gt;ScreenBuffer,
00720                                                  <a class="code" href="../../d8/d5/consrv_8h.html#a64">SCR_FONTNUMBER</a>(Cur),
00721                                                  <a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(Cur),
00722                                                  <a class="code" href="../../d8/d5/consrv_8h.html#a63">SCR_FAMILY</a>(Cur),
00723                                                  <a class="code" href="../../d8/d5/consrv_8h.html#a67">SCR_FONTWEIGHT</a>(Cur),
00724                                                  <a class="code" href="../../d8/d5/consrv_8h.html#a65">SCR_FACENAME</a>(Cur),
00725                                                  <a class="code" href="../../d8/d5/consrv_8h.html#a68">SCR_FONTCODEPAGE</a>(Cur));
00726                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00727                     <span class="keywordflow">return</span>((ULONG) <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00728                 }
00729 
00730                 ConvAreaInfo-&gt;ScreenBuffer-&gt;BufferInfo.TextInfo.ModeIndex = Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.ModeIndex;
00731                 ConvAreaInfo = ConvAreaInfo-&gt;ConvAreaNext;
00732             }
00733         }
00734         Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.Flags &amp;= ~<a class="code" href="../../d7/d2/output_8h.html#a3">TEXT_VALID_HINT</a>;
00735     }
00736 
00737     <a class="code" href="../../d6/d2/output_8c.html#a68">SetWindowSize</a>(Cur);
00738     <a class="code" href="../../d6/d8/dispatch_8h.html#a4">WriteToScreen</a>(Cur, &amp;Console-&gt;CurrentScreenBuffer-&gt;Window);
00739 
00740 <span class="preprocessor">#else</span>
00741 <span class="preprocessor"></span>    UNREFERENCED_PARAMETER(Console);
00742 <span class="preprocessor">#endif</span>
00743 <span class="preprocessor"></span>    <span class="keywordflow">return</span> STATUS_SUCCESS;
00744 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a49" doxytag="server/private.c::ConvertToWindowed" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ConvertToWindowed           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Console</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00747">747</a> of file <a class="el" href="../../d8/d3/server_2private_8c-source.html">server/private.c</a>.
<p>
References <a class="el" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">_SCREEN_INFORMATION::BufferInfo</a>, <a class="el" href="../../d8/d1/output_8h-source.html#l00150">CONSOLE_OEMFONT_DISPLAY</a>, <a class="el" href="../../d8/d1/output_8h-source.html#l00148">CONSOLE_TEXTMODE_BUFFER</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00040">DBGCHARS</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d1/output_8h-source.html#l00154">_SCREEN_INFORMATION::Flags</a>, <a class="el" href="../../d8/d1/output_8h-source.html#l00177">_SCREEN_INFORMATION::Next</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/w32_2ntcon_2server_2misc_8c-source.html#l01573">RealUnicodeToFalseUnicode()</a>, <a class="el" href="../../d7/d1/output_8c-source.html#l02231">ResizeScreenBuffer()</a>, <a class="el" href="../../d7/d1/output_8c-source.html#l03858">ResizeWindow()</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00112">SCR_FACENAME()</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00104">SCR_FAMILY()</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00124">SCR_FONTCODEPAGE()</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00108">SCR_FONTNUMBER()</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00116">SCR_FONTSIZE()</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00120">SCR_FONTWEIGHT()</a>, <a class="el" href="../../d8/d1/output_8h-source.html#l00158">_SCREEN_INFORMATION::ScreenBufferSize</a>, <a class="el" href="../../d5/d9/w32_2ntcon_2server_2misc_8c-source.html#l01260">SetFont()</a>, <a class="el" href="../../d7/d1/output_8c-source.html#l03953">SetWindowSize()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d5/d9/w32_2ntcon_2server_2misc_8c-source.html#l00881">StoreTextBufferFontInfo()</a>, <a class="el" href="../../d8/d1/output_8h-source.html#l00212">TEXT_VALID_HINT</a>, <a class="el" href="../../d8/d1/output_8h-source.html#l00159">_SCREEN_INFORMATION::Window</a>, and <a class="el" href="../../d7/d7/dispatch_8h-source.html#l00061">WriteToScreen</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/output_8c-source.html#l04700">ConsoleWindowProc()</a>, <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l02272">HandleSysKeyEvent()</a>, and <a class="el" href="../../d2/d6/ntcon_2server_2menu_8c-source.html#l00459">PropertiesUpdate()</a>.
<p>
<pre class="fragment"><div>00750 {
00751 <span class="preprocessor">#ifdef i386</span>
00752 <span class="preprocessor"></span>    <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> Cur;
00753     SMALL_RECT WindowedWindow;
00754 
00755     <span class="comment">// for each charmode screenbuffer</span>
00756     <span class="comment">//     restore window dimensions</span>
00757 
00758     <span class="keywordflow">for</span> (Cur=Console-&gt;ScreenBuffers;Cur!=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;Cur=Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o23">Next</a>) {
00759         <span class="keywordflow">if</span> ((Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o1">Flags</a> &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>) == 0) {
00760             <span class="keywordflow">continue</span>;
00761         }
00762 
00763         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/output_8c.html#a58">ResizeScreenBuffer</a>(Cur,
00764                            Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.WindowedScreenSize,
00765                            FALSE) == STATUS_INVALID_HANDLE) {
00766             <span class="comment">/*</span>
00767 <span class="comment">             * Something really went wrong. All we can do is just to</span>
00768 <span class="comment">             * bail out.</span>
00769 <span class="comment">             */</span>
00770             <span class="keywordflow">return</span> STATUS_INVALID_HANDLE;
00771         }
00772 
00773         WindowedWindow.Right  = Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Right;
00774         WindowedWindow.Bottom = Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Bottom;
00775         WindowedWindow.Left   = Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Right + 1 -
00776                                 Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.WindowedWindowSize.X;
00777         WindowedWindow.Top    = Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Bottom + 1 -
00778                                 Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.WindowedWindowSize.Y;
00779         <span class="keywordflow">if</span> (WindowedWindow.Left &gt; Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Left) {
00780             WindowedWindow.Right -= WindowedWindow.Left - Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Left;
00781             WindowedWindow.Left = Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Left;
00782         }
00783         <span class="keywordflow">if</span> (WindowedWindow.Right &lt; Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.X) {
00784             WindowedWindow.Left += Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.X - WindowedWindow.Right;
00785             WindowedWindow.Right = Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.X;
00786         }
00787         <span class="keywordflow">if</span> (WindowedWindow.Top &gt; Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Top) {
00788             WindowedWindow.Bottom -= WindowedWindow.Top - Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Top;
00789             WindowedWindow.Top = Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Top;
00790         }
00791         <span class="keywordflow">if</span> (WindowedWindow.Bottom &lt; Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.Y) {
00792             WindowedWindow.Top += Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.Y - WindowedWindow.Bottom;
00793             WindowedWindow.Bottom = Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.Y;
00794         }
00795         <a class="code" href="../../d6/d2/output_8c.html#a67">ResizeWindow</a>(Cur, &amp;WindowedWindow, FALSE);
00796 
00797         <span class="keywordflow">if</span> (CONSOLE_IS_DBCS_OUTPUTCP(Console)) {
00798             <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a34">SetFont</a>(Cur);
00799         }
00800 
00801         <span class="keywordflow">if</span> (Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o1">Flags</a> &amp; <a class="code" href="../../d7/d2/output_8h.html#a2">CONSOLE_OEMFONT_DISPLAY</a>) {
00802             <a class="code" href="../../d8/d5/consrv_8h.html#a2">DBGCHARS</a>((<span class="stringliteral">"ConvertToWindowed converts Unicode -&gt; UnicodeOem\n"</span>));
00803             <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a42">RealUnicodeToFalseUnicode</a>(
00804                     Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.TextRows,
00805                     Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.X * Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.Y,
00806                     Console-&gt;OutputCP);
00807         } <span class="keywordflow">else</span> {
00808             <a class="code" href="../../d8/d5/consrv_8h.html#a2">DBGCHARS</a>((<span class="stringliteral">"ConvertToWindowed needs no conversion\n"</span>));
00809         }
00810         <a class="code" href="../../d8/d5/consrv_8h.html#a2">DBGCHARS</a>((<span class="stringliteral">"Cur-&gt;BufferInfo.TextInfo.Rows = %lx\n"</span>,
00811                 Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.Rows));
00812         <a class="code" href="../../d8/d5/consrv_8h.html#a2">DBGCHARS</a>((<span class="stringliteral">"Cur-&gt;BufferInfo.TextInfo.TextRows = %lx\n"</span>,
00813                 Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.TextRows));
00814     }
00815 
00816     Cur = Console-&gt;CurrentScreenBuffer;
00817 
00818     <span class="keywordflow">if</span> (Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o1">Flags</a> &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>) {
00819         <span class="keywordflow">if</span> (CONSOLE_IS_DBCS_OUTPUTCP(Console)) {
00820             PCONVERSIONAREA_INFORMATION ConvAreaInfo;
00821             ConvAreaInfo = Console-&gt;ConsoleIme.ConvAreaRoot;
00822             <span class="keywordflow">while</span> (ConvAreaInfo) {
00823                 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00824 
00825                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a27">StoreTextBufferFontInfo</a>(ConvAreaInfo-&gt;ScreenBuffer,
00826                                                  <a class="code" href="../../d8/d5/consrv_8h.html#a64">SCR_FONTNUMBER</a>(Cur),
00827                                                  <a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(Cur),
00828                                                  <a class="code" href="../../d8/d5/consrv_8h.html#a63">SCR_FAMILY</a>(Cur),
00829                                                  <a class="code" href="../../d8/d5/consrv_8h.html#a67">SCR_FONTWEIGHT</a>(Cur),
00830                                                  <a class="code" href="../../d8/d5/consrv_8h.html#a65">SCR_FACENAME</a>(Cur),
00831                                                  <a class="code" href="../../d8/d5/consrv_8h.html#a68">SCR_FONTCODEPAGE</a>(Cur));
00832                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00833                     <span class="keywordflow">return</span>((ULONG) <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00834                 }
00835 
00836                 ConvAreaInfo-&gt;ScreenBuffer-&gt;BufferInfo.TextInfo.ModeIndex = Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.ModeIndex;
00837                 ConvAreaInfo = ConvAreaInfo-&gt;ConvAreaNext;
00838             }
00839         }
00840         Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.Flags &amp;= ~<a class="code" href="../../d7/d2/output_8h.html#a3">TEXT_VALID_HINT</a>;
00841     }
00842 
00843     <a class="code" href="../../d6/d2/output_8c.html#a68">SetWindowSize</a>(Cur);
00844     <a class="code" href="../../d6/d8/dispatch_8h.html#a4">WriteToScreen</a>(Cur, &amp;Console-&gt;CurrentScreenBuffer-&gt;Window);
00845 
00846 <span class="preprocessor">#else</span>
00847 <span class="preprocessor"></span>    UNREFERENCED_PARAMETER(Console);
00848 <span class="preprocessor">#endif</span>
00849 <span class="preprocessor"></span>    <span class="keywordflow">return</span> STATUS_SUCCESS;
00850 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a54" doxytag="server/private.c::DisplayModeTransition" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS DisplayModeTransition           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN BOOL&nbsp;</td>
          <td class="mdname" nowrap> <em>bForeground</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Console</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ScreenInfo</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/server_2private_8c-source.html#l01567">1567</a> of file <a class="el" href="../../d8/d3/server_2private_8c-source.html">server/private.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">_SCREEN_INFORMATION::BufferInfo</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l01519">ConnectToEmulator()</a>, <a class="el" href="../../d8/d1/output_8h-source.html#l00153">_SCREEN_INFORMATION::Console</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00098">CONSOLE_CONNECTED_TO_EMULATOR</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00099">CONSOLE_FULLSCREEN_NOPAINT</a>, <a class="el" href="../../d8/d1/output_8h-source.html#l00149">CONSOLE_GRAPHICS_BUFFER</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00094">CONSOLE_VDM_REGISTERED</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l01564">CONSOLE_VDM_TIMEOUT</a>, <a class="el" href="../../d7/d5/ntcon_2server_2globals_8h-source.html#l00040">ConsoleVDMCriticalSection</a>, <a class="el" href="../../d7/d5/ntcon_2server_2globals_8h-source.html#l00041">ConsoleVDMOnSwitching</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d1/output_8h-source.html#l00154">_SCREEN_INFORMATION::Flags</a>, <a class="el" href="../../d1/d2/dbcs_8h-source.html#l00051">FS_MODE_GRAPHICS</a>, <a class="el" href="../../d7/d5/ntcon_2server_2globals_8h-source.html#l00039">FullScreenInitialized</a>, <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l03369">HandleFocusEvent()</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00139">_CONSOLE_INFORMATION::hDC</a>, <a class="el" href="../../d8/d1/output_8h-source.html#l00169">_SCREEN_INFORMATION::hPalette</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00142">_CONSOLE_INFORMATION::hSysPalette</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d8/d1/output_8h-source.html#l00223">INVALID_OLD_LENGTH</a>, <a class="el" href="../../d0/d3/dbcs_8h.html#a51">IsAvailableFsCodePage()</a>, <a class="el" href="../../d1/d2/dbcs_8h-source.html#l00049">_MODE_FONT_PAIR::Mode</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00120">ModeFontPairs</a>, <a class="el" href="../../d7/d1/output_8c-source.html#l04227">ModifyConsoleProcessFocus()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d2/d1/obwait_8c-source.html#l00038">NtSignalAndWaitForSingleObject()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l00870">NtUserConsoleControl()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d2/dbcs_8h-source.html#l00069">RegModeFontPairs</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00114">_MODE_FONT_PAIR::Resolution</a>, <a class="el" href="../../d8/d1/output_8h-source.html#l00158">_SCREEN_INFORMATION::ScreenBufferSize</a>, <a class="el" href="../../d4/d9/user32_8def-source.html#l00718">SelectPalette</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00544">SetActivePalette()</a>, <a class="el" href="../../d8/d5/consrv_8h.html#a313">SetConsoleReserveKeys()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00980">UnregisterVDM()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00573">UnsetActivePalette()</a>, <a class="el" href="../../d8/d1/output_8h-source.html#l00159">_SCREEN_INFORMATION::Window</a>, and <a class="el" href="../../d7/d7/dispatch_8h-source.html#l00068">WriteRegionToScreen</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/output_8c-source.html#l04700">ConsoleWindowProc()</a>.
<p>
<pre class="fragment"><div>01572 {
01573 <span class="preprocessor">#ifdef i386</span>
01574 <span class="preprocessor"></span>    <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01575     LARGE_INTEGER li;
01576 
01577     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a12">FullScreenInitialized</a>)
01578         <span class="keywordflow">return</span> STATUS_SUCCESS;
01579 
01580     <span class="keywordflow">if</span> (bForeground) {
01581 
01582         <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo = Console-&gt;CurrentScreenBuffer;
01583         LARGE_INTEGER li;
01584         <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01585 
01586         KdPrint((<span class="stringliteral">"    CONSRV - Display Mode transition to fullscreen \n"</span>));
01587 
01588         <span class="keywordflow">if</span> (!(Console-&gt;FullScreenFlags &amp; CONSOLE_FULLSCREEN)) {
01589             KdPrint((<span class="stringliteral">"CONSRV: received fullscreen message too early\n"</span>));
01590             <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
01591         }
01592 
01593         Console-&gt;FullScreenFlags |= CONSOLE_FULLSCREEN_HARDWARE;
01594 
01595         <span class="keywordflow">if</span> (!(ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o1">Flags</a> &amp; <a class="code" href="../../d7/d2/output_8h.html#a1">CONSOLE_GRAPHICS_BUFFER</a>)) {
01596 <span class="preprocessor">#if defined(FE_SB)</span>
01597 <span class="preprocessor"></span>            <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fGraphics = fFullScreenGraphics ? <a class="code" href="../../d0/d3/dbcs_8h.html#a51">IsAvailableFsCodePage</a>(Console-&gt;OutputCP) : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01598 <span class="preprocessor">#endif</span>
01599 <span class="preprocessor"></span><span class="preprocessor">#if 1</span>
01600 <span class="preprocessor"></span>            DEVMODEW Devmode;
01601             ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01602 
01603             KdPrint((<span class="stringliteral">"CONSRV: ChangeDispSettings fullscreen\n"</span>));
01604 
01605             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = Console-&gt;CurrentScreenBuffer-&gt;BufferInfo.TextInfo.ModeIndex;
01606 
01607             <span class="comment">//</span>
01608             <span class="comment">// set mode to go to full screen</span>
01609             <span class="comment">//</span>
01610 
01611             ZeroMemory(&amp;Devmode, <span class="keyword">sizeof</span>(Devmode));
01612 
01613             Devmode.dmSize = <span class="keyword">sizeof</span>(Devmode);
01614             Devmode.dmDriverExtra = 0;
01615             Devmode.dmFields = DM_BITSPERPEL   |
01616                                DM_PELSWIDTH    |
01617                                DM_PELSHEIGHT   |
01618                                DM_DISPLAYFLAGS;
01619 
01620             Devmode.dmBitsPerPel   = 4;
01621 <span class="preprocessor">#if defined(FE_SB)</span>
01622 <span class="preprocessor"></span>            Devmode.dmPelsWidth    = <a class="code" href="../../d0/d3/dbcs_8h.html#a24">RegModeFontPairs</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o2">Resolution</a>.X;
01623             Devmode.dmPelsHeight   = <a class="code" href="../../d0/d3/dbcs_8h.html#a24">RegModeFontPairs</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o2">Resolution</a>.Y;
01624             Devmode.dmDisplayFlags = (fGraphics &amp;&amp; (<a class="code" href="../../d0/d3/dbcs_8h.html#a24">RegModeFontPairs</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o0">Mode</a> &amp; <a class="code" href="../../d0/d3/dbcs_8h.html#a9">FS_MODE_GRAPHICS</a>)) ? 0 : DMDISPLAYFLAGS_TEXTMODE;
01625 <span class="preprocessor">#else</span>
01626 <span class="preprocessor"></span>            Devmode.dmPelsWidth    = <a class="code" href="../../d7/d4/server_2private_8c.html#a28">ModeFontPairs</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o2">Resolution</a>.X;
01627             Devmode.dmPelsHeight   = <a class="code" href="../../d7/d4/server_2private_8c.html#a28">ModeFontPairs</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o2">Resolution</a>.Y;
01628             Devmode.dmDisplayFlags = DMDISPLAYFLAGS_TEXTMODE;
01629 <span class="preprocessor">#endif</span>
01630 <span class="preprocessor"></span>
01631             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(GdiFullscreenControl(FullscreenControlSetMode,
01632                                                    &amp;Devmode,
01633                                                    <span class="keyword">sizeof</span>(Devmode),
01634                                                    NULL,
01635                                                    NULL)))
01636             {
01637 <span class="preprocessor">#endif</span>
01638 <span class="preprocessor"></span>                <span class="comment">// set video mode and font</span>
01639                 <span class="keywordflow">if</span> (SetVideoMode(ScreenInfo)) {
01640 
01641 <span class="preprocessor">#if defined(FE_SB)</span>
01642 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (!(Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a9">CONSOLE_VDM_REGISTERED</a>)) {
01643                         <span class="keywordtype">int</span>     i ;
01644                         <span class="keywordflow">for</span> (i = 0 ; i &lt; ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.Y; i++) {
01645                             ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.Rows[i].CharRow.OldLeft = <a class="code" href="../../d7/d2/output_8h.html#a5">INVALID_OLD_LENGTH</a> ;
01646                             ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.Rows[i].CharRow.OldRight = <a class="code" href="../../d7/d2/output_8h.html#a5">INVALID_OLD_LENGTH</a> ;
01647                         }
01648                     }
01649 <span class="preprocessor">#endif</span>
01650 <span class="preprocessor"></span>                    <span class="comment">//set up cursor</span>
01651 
01652                     SetCursorInformationHW(ScreenInfo,
01653                                     ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorSize,
01654                                     ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorVisible);
01655                     SetCursorPositionHW(ScreenInfo,
01656                                     ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition);
01657                 }
01658             }
01659         }
01660 
01661         <span class="comment">// tell VDM to unmap memory</span>
01662 
01663         <span class="keywordflow">if</span> (Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a9">CONSOLE_VDM_REGISTERED</a>) {
01664             li.QuadPart = (LONGLONG)-10000 * <a class="code" href="../../d7/d4/server_2private_8c.html#a23">CONSOLE_VDM_TIMEOUT</a>;
01665             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/obwait_8c.html#a3">NtSignalAndWaitForSingleObject</a>(Console-&gt;VDMStartHardwareEvent,
01666                                                     Console-&gt;VDMEndHardwareEvent,
01667                                                     FALSE, &amp;li);
01668              <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != 0) {
01669                 Console-&gt;Flags &amp;= ~<a class="code" href="../../d1/d7/server_8h.html#a14">CONSOLE_FULLSCREEN_NOPAINT</a>;
01670                 <a class="code" href="../../d0/d5/srvinit_8c.html#a22">UnregisterVDM</a>(Console);
01671                 KdPrint((<span class="stringliteral">"CONSRV: VDM not responding.\n"</span>));
01672              }
01673         }
01674 
01675         <span class="keywordflow">if</span> (!(ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o1">Flags</a> &amp; <a class="code" href="../../d7/d2/output_8h.html#a1">CONSOLE_GRAPHICS_BUFFER</a>)) {
01676 
01677             <a class="code" href="../../d6/d8/dispatch_8h.html#a5">WriteRegionToScreen</a>(ScreenInfo,&amp;ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>);
01678         }
01679 
01680         <span class="keywordflow">if</span> (Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a9">CONSOLE_VDM_REGISTERED</a>) {
01681 
01682             <span class="comment">// connect emulator and map memory into the VDMs address space.</span>
01683             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!(Console-&gt;Flags &amp; CONSOLE_CONNECTED_TO_EMULATOR));
01684 
01685             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d4/server_2private_8c.html#a41">ConnectToEmulator</a>(TRUE, Console);
01686 
01687             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01688 
01689                 VIDEO_HARDWARE_STATE State;
01690                 ULONG StateSize = <span class="keyword">sizeof</span>(State);
01691 
01692                 State.StateHeader = Console-&gt;StateBuffer;
01693                 State.StateLength = Console-&gt;StateLength;
01694 
01695 
01696                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GdiFullscreenControl(FullscreenControlRestoreHardwareState,
01697                                                  &amp;State,
01698                                                  StateSize,
01699                                                  &amp;State,
01700                                                  &amp;StateSize);
01701             }
01702 
01703             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) {
01704                 Console-&gt;Flags &amp;= ~<a class="code" href="../../d1/d7/server_8h.html#a14">CONSOLE_FULLSCREEN_NOPAINT</a>;
01705                 <a class="code" href="../../d0/d5/srvinit_8c.html#a22">UnregisterVDM</a>(Console);
01706                 KdPrint((<span class="stringliteral">"CONSRV: set hardware state failed.\n"</span>));
01707             } <span class="keywordflow">else</span> {
01708 
01709                 <span class="comment">//</span>
01710                 <span class="comment">// tell VDM that it's getting the hardware.</span>
01711                 <span class="comment">//</span>
01712 
01713                 RECT CursorRect;
01714                 CursorRect.left = -32767;
01715                 CursorRect.top = -32767;
01716                 CursorRect.right = 32767;
01717                 CursorRect.bottom = 32767;
01718                 <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a86">NtUserConsoleControl</a>(ConsoleSetVDMCursorBounds,
01719                         &amp;CursorRect, <span class="keyword">sizeof</span>(RECT));
01720 
01721                 <span class="comment">// wait for vdm to say ok. We could initiate another switch</span>
01722                 <span class="comment">// (set hStartHardwareEvent which vdm is now waiting for to</span>
01723                 <span class="comment">//  complete the handshaking) when we return(WM_FULLSCREEN</span>
01724                 <span class="comment">// could be in the message queue already). If we don't wait</span>
01725                 <span class="comment">// for vdm to get signaled here, the hStartHardwareEvent</span>
01726                 <span class="comment">// can get set twice and signaled once so the vdm will never</span>
01727                 <span class="comment">// gets the newly switch request we may post after return.</span>
01728                 <a class="code" href="../../d1/d2/obwait_8c.html#a3">NtSignalAndWaitForSingleObject</a>(Console-&gt;VDMStartHardwareEvent,
01729                                                Console-&gt;VDMEndHardwareEvent,
01730                                                FALSE, &amp;li);
01731                 <span class="comment">// no need to check time out here</span>
01732 
01733             }
01734 
01735         }
01736 
01737         <span class="comment">//</span>
01738         <span class="comment">// let the app know that it has the focus.</span>
01739         <span class="comment">//</span>
01740 
01741         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a48">HandleFocusEvent</a>(Console,TRUE);
01742 
01743         <span class="comment">// unset palette</span>
01744 
01745         <span class="keywordflow">if</span> (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o16">hPalette</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01746             <a class="code" href="../../d3/d0/user32_8def.html#a83">SelectPalette</a>(ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o0">Console</a>-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o10">hDC</a>,
01747                              ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o0">Console</a>-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o13">hSysPalette</a>,
01748                              FALSE);
01749             <a class="code" href="../../d7/d4/server_2private_8c.html#a47">UnsetActivePalette</a>(ScreenInfo);
01750         }
01751         <a class="code" href="../../d8/d5/consrv_8h.html#a313">SetConsoleReserveKeys</a>(Console-&gt;hWnd, Console-&gt;ReserveKeys);
01752         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a48">HandleFocusEvent</a>(Console,TRUE);
01753 
01754     } <span class="keywordflow">else</span> {
01755 
01756         KdPrint((<span class="stringliteral">"    CONSRV - Display Mode transition to windowed \n"</span>));
01757 
01758         <span class="comment">//</span>
01759         <span class="comment">// Check first to see if we're not already fullscreen. If we aren't,</span>
01760         <span class="comment">// don't allow this. Temporary BETA fix till USER gets fixed.</span>
01761         <span class="comment">//</span>
01762         <span class="keywordflow">if</span> (!(Console-&gt;FullScreenFlags &amp; CONSOLE_FULLSCREEN_HARDWARE)) {
01763             KdPrint((<span class="stringliteral">"CONSRV: received multiple windowed messages\n"</span>));
01764             <span class="keywordflow">return</span> STATUS_SUCCESS;
01765         }
01766 
01767         <span class="comment">// turn off mouse pointer so VDM doesn't see it when saving</span>
01768         <span class="comment">// hardware</span>
01769         <span class="keywordflow">if</span> (!(ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o1">Flags</a> &amp; <a class="code" href="../../d7/d2/output_8h.html#a1">CONSOLE_GRAPHICS_BUFFER</a>)) {
01770             ReverseMousePointer(ScreenInfo, &amp;ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>);
01771         }
01772 
01773 
01774         Console-&gt;FullScreenFlags &amp;= ~CONSOLE_FULLSCREEN_HARDWARE;
01775         <span class="keywordflow">if</span> (Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a9">CONSOLE_VDM_REGISTERED</a>) {
01776 
01777             <span class="comment">//</span>
01778             <span class="comment">// tell vdm that it's losing the hardware</span>
01779             <span class="comment">//</span>
01780 
01781             li.QuadPart = (LONGLONG)-10000 * <a class="code" href="../../d7/d4/server_2private_8c.html#a23">CONSOLE_VDM_TIMEOUT</a>;
01782             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/obwait_8c.html#a3">NtSignalAndWaitForSingleObject</a>(Console-&gt;VDMStartHardwareEvent,
01783                                                     Console-&gt;VDMEndHardwareEvent,
01784                                                     FALSE, &amp;li);
01785 
01786             <span class="comment">// if ntvdm didn't respond or we failed to save the video hardware</span>
01787             <span class="comment">// states, kick ntvdm out of our world. The ntvdm process eventually</span>
01788             <span class="comment">// would die but what choice do have here?</span>
01789 
01790             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01791 
01792                 VIDEO_HARDWARE_STATE State;
01793                 ULONG StateSize = <span class="keyword">sizeof</span>(State);
01794 
01795                 State.StateHeader = Console-&gt;StateBuffer;
01796                 State.StateLength = Console-&gt;StateLength;
01797 
01798 
01799                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GdiFullscreenControl(FullscreenControlSaveHardwareState,
01800                                                  &amp;State,
01801                                                  StateSize,
01802                                                  &amp;State,
01803                                                  &amp;StateSize);
01804             }
01805 
01806             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01807 
01808 
01809                 <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a86">NtUserConsoleControl</a>(ConsoleSetVDMCursorBounds, NULL, 0);
01810 
01811                 <span class="comment">// disconnect emulator and unmap video memory</span>
01812 
01813                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Console-&gt;Flags &amp; CONSOLE_CONNECTED_TO_EMULATOR);
01814                 <a class="code" href="../../d7/d4/server_2private_8c.html#a41">ConnectToEmulator</a>(FALSE, Console);
01815 
01816             } <span class="keywordflow">else</span> {
01817 
01818                 Console-&gt;Flags &amp;= ~<a class="code" href="../../d1/d7/server_8h.html#a14">CONSOLE_FULLSCREEN_NOPAINT</a>;
01819                 <a class="code" href="../../d0/d5/srvinit_8c.html#a22">UnregisterVDM</a>(Console);
01820                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != 0) {
01821                     KdPrint((<span class="stringliteral">"CONSRV: VDM not responding.\n"</span>));
01822                 }
01823                 <span class="keywordflow">else</span>
01824                     KdPrint((<span class="stringliteral">"CONSRV: Save Video States Failed\n"</span>));
01825 
01826             }
01827         }
01828 
01829         <span class="comment">// tell VDM to map memory</span>
01830 
01831         <span class="keywordflow">if</span> (Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a9">CONSOLE_VDM_REGISTERED</a>) {
01832 
01833             <span class="comment">// make a special case for ntvdm during switching because</span>
01834             <span class="comment">// ntvdm has to make console api calls. We don't want to</span>
01835             <span class="comment">// unlock the console at this moment because as soon as</span>
01836             <span class="comment">// we release the lock, other theads which are waiting</span>
01837             <span class="comment">// for the lock will claim the lock and the ntvdm thread doing</span>
01838             <span class="comment">// the screen switch will have to wait for the lock. In an</span>
01839             <span class="comment">// extreme case, the following NtWaitForSingleObject will time</span>
01840             <span class="comment">// out because the ntvdm may be still waiting for the lock.</span>
01841             <span class="comment">// We keep this thing in a single global variable because</span>
01842             <span class="comment">// there is only one process who can own the screen at any moment.</span>
01843 
01844             RtlEnterCriticalSection(&amp;ConsoleVDMCriticalSection);
01845             <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a14">ConsoleVDMOnSwitching</a> = Console;
01846             RtlLeaveCriticalSection(&amp;ConsoleVDMCriticalSection);
01847             li.QuadPart = (LONGLONG)-10000 * <a class="code" href="../../d7/d4/server_2private_8c.html#a23">CONSOLE_VDM_TIMEOUT</a>;
01848             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/obwait_8c.html#a3">NtSignalAndWaitForSingleObject</a>(Console-&gt;VDMStartHardwareEvent,
01849                                                     Console-&gt;VDMEndHardwareEvent,
01850                                                     FALSE, &amp;li);
01851 
01852             <span class="comment">// time to go back to normal</span>
01853             RtlEnterCriticalSection(&amp;ConsoleVDMCriticalSection);
01854             <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a14">ConsoleVDMOnSwitching</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01855             RtlLeaveCriticalSection(&amp;ConsoleVDMCriticalSection);
01856 
01857             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != 0) {
01858                 Console-&gt;Flags &amp;= ~<a class="code" href="../../d1/d7/server_8h.html#a14">CONSOLE_FULLSCREEN_NOPAINT</a>;
01859                 <a class="code" href="../../d0/d5/srvinit_8c.html#a22">UnregisterVDM</a>(Console);
01860                 KdPrint((<span class="stringliteral">"CONSRV: VDM not responding. - second wait\n"</span>));
01861                 <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01862             }
01863             ScreenInfo = Console-&gt;CurrentScreenBuffer;
01864         }
01865 
01866         <span class="comment">// set palette</span>
01867 
01868         <span class="keywordflow">if</span> (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o16">hPalette</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01869             <a class="code" href="../../d3/d0/user32_8def.html#a83">SelectPalette</a>(ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o0">Console</a>-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o10">hDC</a>,
01870                              ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o16">hPalette</a>,
01871                              FALSE);
01872             <a class="code" href="../../d7/d4/server_2private_8c.html#a46">SetActivePalette</a>(ScreenInfo);
01873         }
01874         <a class="code" href="../../d8/d5/consrv_8h.html#a313">SetConsoleReserveKeys</a>(Console-&gt;hWnd, CONSOLE_NOSHORTCUTKEY);
01875         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a48">HandleFocusEvent</a>(Console,FALSE);
01876 
01877     }
01878 
01879     <span class="comment">/*</span>
01880 <span class="comment">     * Boost or lower the priority if we are going fullscreen or away.</span>
01881 <span class="comment">     *</span>
01882 <span class="comment">     * Note that console usually boosts and lowers its priority based</span>
01883 <span class="comment">     * on WM_FOCUSS and WM_KILLFOCUS but when you switch to full screen</span>
01884 <span class="comment">     * the implementation actually sends a WM_KILLFOCUS so we reboost the</span>
01885 <span class="comment">     * correct console here.</span>
01886 <span class="comment">     */</span>
01887     <a class="code" href="../../d6/d2/output_8c.html#a74">ModifyConsoleProcessFocus</a>(Console, bForeground);
01888 
01889 
01890 <span class="preprocessor">#else</span>
01891 <span class="preprocessor"></span>    UNREFERENCED_PARAMETER(bForeground);
01892     UNREFERENCED_PARAMETER(Console);
01893     UNREFERENCED_PARAMETER(ScreenInfo);
01894 <span class="preprocessor">#endif</span>
01895 <span class="preprocessor"></span>    <span class="keywordflow">return</span> STATUS_SUCCESS;
01896 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a62" doxytag="server/private.c::GetThreadConsoleDesktop" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS GetThreadConsoleDesktop           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>dwThreadId</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HDESK *&nbsp;</td>
          <td class="mdname" nowrap> <em>phdeskConsole</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/server_2private_8c-source.html#l03139">3139</a> of file <a class="el" href="../../d8/d3/server_2private_8c-source.html">server/private.c</a>.
<p>
References <a class="el" href="../../d2/d6/server_8h-source.html#l00392">CONSOLE_FROMTHREADPERPROCESSDATA</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00322">_CONSOLE_PER_PROCESS_DATA::ConsoleHandle</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00136">_CONSOLE_INFORMATION::hDesk</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d7/server_8h.html#a115">PCONSOLE_PER_PROCESS_DATA</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01686">RevalidateConsole()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l04103">UnlockConsole()</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/server_2server_8c-source.html#l01235">SrvGetThreadConsoleDesktop()</a>.
<p>
<pre class="fragment"><div>03142 {
03143     PCSR_THREAD pcsrt;
03144     <a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a> ProcessData;
03145     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
03146     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03147     HANDLE ConsoleHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03148 
03149     *phdeskConsole = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03150     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = CsrLockThreadByClientId((HANDLE)dwThreadId, &amp;pcsrt);
03151     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
03152         ProcessData = <a class="code" href="../../d1/d7/server_8h.html#a83">CONSOLE_FROMTHREADPERPROCESSDATA</a>(pcsrt);
03153         ConsoleHandle = ProcessData-&gt;<a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html#o0">ConsoleHandle</a>;
03154         CsrUnlockThread(pcsrt);
03155     }
03156 
03157     <span class="comment">//</span>
03158     <span class="comment">// If this process is a console app, return the</span>
03159     <span class="comment">// handle to its desktop.  Otherwise, return NULL.</span>
03160     <span class="comment">//</span>
03161 
03162     <span class="keywordflow">if</span> (ConsoleHandle != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03163         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a34">RevalidateConsole</a>(ConsoleHandle, &amp;Console);
03164         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
03165             *phdeskConsole = Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o7">hDesk</a>;
03166         }
03167         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
03168     }
03169 
03170     <span class="keywordflow">return</span> STATUS_SUCCESS;
03171 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a55" doxytag="server/private.c::InitializeFullScreen" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL InitializeFullScreen           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/server_2private_8c-source.html#l02089">2089</a> of file <a class="el" href="../../d8/d3/server_2private_8c-source.html">server/private.c</a>.
<p>
References <a class="el" href="../../d2/d0/bench_8c-source.html#l00050">CHAR</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00172">CONSOLE_EGACPI</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00171">CONSOLE_EGACPI_LENGTH</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00170">CONSOLE_WINDOWS_DIR_LENGTH</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00040">DBGCHARS</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d2/dbcs_8h-source.html#l00052">FS_MODE_FIND</a>, <a class="el" href="../../d1/d2/dbcs_8h-source.html#l00051">FS_MODE_GRAPHICS</a>, <a class="el" href="../../d1/d2/dbcs_8h-source.html#l00050">FS_MODE_TEXT</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00130">hCPIFile</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d1/d2/dbcs_8h-source.html#l00049">_MODE_FONT_PAIR::Mode</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l09357">NtUserEnumDisplaySettings()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00118">NUMBER_OF_MODE_FONT_PAIRS</a>, <a class="el" href="../../d4/d8/ntfsexp_8h.html#a141a69">OPEN_EXISTING</a>, <a class="el" href="../../d1/d2/dbcs_8h-source.html#l00069">RegModeFontPairs</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00114">_MODE_FONT_PAIR::Resolution</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00062">SHORT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d0/d5/ndismain_8h-source.html#l00026">UINT</a>.
<p>
Referenced by <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00626">InitWindowsStuff()</a>.
<p>
<pre class="fragment"><div>02090 {
02091     UNICODE_STRING vgaString;
02092     DEVMODEW devmode;
02093     ULONG   i;
02094 <span class="preprocessor">#if !defined(FE_SB)</span>
02095 <span class="preprocessor"></span>    BOOLEAN mode1 = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02096     BOOLEAN mode2 = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02097 <span class="preprocessor">#else</span>
02098 <span class="preprocessor"></span>    <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> mode1 = 0;
02099     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> mode2 = 0;
02100 <span class="preprocessor">#endif</span>
02101 <span class="preprocessor"></span>
02102     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> WindowsDir[<a class="code" href="../../d7/d4/server_2private_8c.html#a18">CONSOLE_WINDOWS_DIR_LENGTH</a>+<a class="code" href="../../d7/d4/server_2private_8c.html#a19">CONSOLE_EGACPI_LENGTH</a>];
02103     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> WindowsDirLength;
02104 
02105     <span class="comment">//</span>
02106     <span class="comment">// query number of available modes</span>
02107     <span class="comment">//</span>
02108 
02109     ZeroMemory(&amp;devmode, <span class="keyword">sizeof</span>(DEVMODEW));
02110     devmode.dmSize = <span class="keyword">sizeof</span>(DEVMODEW);
02111 
02112     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;vgaString, L<span class="stringliteral">"VGACOMPATIBLE"</span>);
02113 
02114     <a class="code" href="../../d8/d5/consrv_8h.html#a2">DBGCHARS</a>((<span class="stringliteral">"Number of modes = %d\n"</span>, NUMBER_OF_MODE_FONT_PAIRS));
02115 
02116     <span class="keywordflow">for</span> (i=0; ; i++)
02117     {
02118         <a class="code" href="../../d8/d5/consrv_8h.html#a2">DBGCHARS</a>((<span class="stringliteral">"EnumDisplaySettings %d\n"</span>, i));
02119 
02120         <span class="keywordflow">if</span> (!(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a321">NtUserEnumDisplaySettings</a>(&amp;vgaString,
02121                                                    i,
02122                                                    &amp;devmode,
02123                                                    0))))
02124         {
02125             <span class="keywordflow">break</span>;
02126         }
02127 
02128 <span class="preprocessor">#if defined(FE_SB)</span>
02129 <span class="preprocessor"></span>        {
02130             ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
02131 
02132             <a class="code" href="../../d8/d5/consrv_8h.html#a2">DBGCHARS</a>((<span class="stringliteral">"Mode X = %d, Y = %d\n"</span>,
02133                      devmode.dmPelsWidth, devmode.dmPelsHeight));
02134 
02135             <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>=0;<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>&lt;<a class="code" href="../../d7/d4/server_2private_8c.html#a17">NUMBER_OF_MODE_FONT_PAIRS</a>;<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>++)
02136             {
02137                 <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)devmode.dmPelsWidth == <a class="code" href="../../d0/d3/dbcs_8h.html#a24">RegModeFontPairs</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o2">Resolution</a>.X &amp;&amp;
02138                     (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)devmode.dmPelsHeight == <a class="code" href="../../d0/d3/dbcs_8h.html#a24">RegModeFontPairs</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o2">Resolution</a>.Y  )
02139                 {
02140                     <span class="keywordflow">if</span> (devmode.dmDisplayFlags &amp; DMDISPLAYFLAGS_TEXTMODE)
02141                     {
02142                         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d3/dbcs_8h.html#a24">RegModeFontPairs</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o0">Mode</a> &amp; <a class="code" href="../../d0/d3/dbcs_8h.html#a8">FS_MODE_TEXT</a>)
02143                         {
02144                             <a class="code" href="../../d0/d3/dbcs_8h.html#a24">RegModeFontPairs</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o0">Mode</a> |= <a class="code" href="../../d0/d3/dbcs_8h.html#a10">FS_MODE_FIND</a>;
02145                             mode1++;
02146                         }
02147                     }
02148                     <span class="keywordflow">else</span>
02149                     {
02150                         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d3/dbcs_8h.html#a24">RegModeFontPairs</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o0">Mode</a> &amp; <a class="code" href="../../d0/d3/dbcs_8h.html#a9">FS_MODE_GRAPHICS</a>)
02151                         {
02152                             <a class="code" href="../../d0/d3/dbcs_8h.html#a24">RegModeFontPairs</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o0">Mode</a> |= <a class="code" href="../../d0/d3/dbcs_8h.html#a10">FS_MODE_FIND</a>;
02153                             mode2++;
02154                         }
02155                     }
02156                 }
02157             }
02158 
02159             <a class="code" href="../../d8/d5/consrv_8h.html#a2">DBGCHARS</a>((<span class="stringliteral">"mode1 = %d, mode2 = %d\n"</span>, mode1, mode2));
02160         }
02161 <span class="preprocessor">#else</span>
02162 <span class="preprocessor"></span>
02163         <span class="keywordflow">if</span> (devmode.dmPelsWidth == 720 &amp;&amp;
02164             devmode.dmPelsHeight == 400)
02165         {
02166             mode1 = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02167         }
02168         <span class="keywordflow">if</span> (devmode.dmPelsWidth == 640 &amp;&amp;
02169             devmode.dmPelsHeight == 350)
02170         {
02171             mode2 = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02172         }
02173 <span class="preprocessor">#endif</span>
02174 <span class="preprocessor"></span>    }
02175 
02176 <span class="preprocessor">#if !defined(FE_SB)</span>
02177 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (!(mode1 &amp;&amp; mode2))
02178 <span class="preprocessor">#else</span>
02179 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (mode1 &lt; 2)
02180 <span class="preprocessor">#endif</span>
02181 <span class="preprocessor"></span>    {
02182         <span class="comment">//</span>
02183         <span class="comment">// One of the modes we expected to get was not returned.</span>
02184         <span class="comment">// lets just fail fullscreen initialization.</span>
02185         <span class="comment">//</span>
02186 
02187         KdPrint((<span class="stringliteral">"CONSRV: InitializeFullScreen Missing text mode\n"</span>));
02188         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02189     }
02190 
02191 <span class="preprocessor">#if defined(FE_SB)</span>
02192 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (mode2 &gt; 0)
02193     {
02194         <span class="comment">// Can do trun graphics mode.</span>
02195         fFullScreenGraphics = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02196     }
02197 <span class="preprocessor">#endif</span>
02198 <span class="preprocessor"></span>
02199     <span class="comment">//</span>
02200     <span class="comment">// open ega.cpi</span>
02201     <span class="comment">//</span>
02202 
02203     WindowsDirLength = GetSystemDirectoryA(WindowsDir,
02204                                            CONSOLE_WINDOWS_DIR_LENGTH);
02205     <span class="keywordflow">if</span> (WindowsDirLength == 0)
02206     {
02207         KdPrint((<span class="stringliteral">"CONSRV: InitializeFullScreen Finding Font file failed\n"</span>));
02208         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02209     }
02210 
02211     RtlCopyMemory(&amp;WindowsDir[WindowsDirLength],
02212                   CONSOLE_EGACPI,
02213                   CONSOLE_EGACPI_LENGTH);
02214 
02215     <span class="keywordflow">if</span> ((<a class="code" href="../../d7/d4/server_2private_8c.html#a29">hCPIFile</a> = CreateFileA(WindowsDir,
02216                                 GENERIC_READ,
02217                                 FILE_SHARE_READ,
02218                                 NULL,
02219                                 OPEN_EXISTING,
02220                                 0,
02221                                 NULL)) == (HANDLE)-1)
02222     {
02223         KdPrint((<span class="stringliteral">"CONSRV: InitializeFullScreen Opening Font file failed\n"</span>));
02224         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02225     }
02226 
02227     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02228 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a40" doxytag="server/private.c::MapViewOfSection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MapViewOfSection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>SectionHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>CommitSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>BaseAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PSIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>ViewSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ClientHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>BaseClientAddress</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/server_2private_8c-source.html#l01407">1407</a> of file <a class="el" href="../../d8/d3/server_2private_8c-source.html">server/private.c</a>.
<p>
References <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d1/d7/creasect_8c-source.html#l00134">NtCreateSection()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l00199">NtMapViewOfSection()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d8/d3/server_2private_8c-source.html#l01094">SrvRegisterConsoleVDM()</a>.
<p>
<pre class="fragment"><div>01415 {
01416 
01417     OBJECT_ATTRIBUTES Obja;
01418     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01419     LARGE_INTEGER secSize;
01420 
01421     <span class="comment">//</span>
01422     <span class="comment">// open section and map a view of it.</span>
01423     <span class="comment">//</span>
01424     InitializeObjectAttributes(
01425         &amp;Obja,
01426         NULL,
01427         OBJ_CASE_INSENSITIVE,
01428         NULL,
01429         NULL
01430         );
01431 
01432     secSize.QuadPart = CommitSize;
01433     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d8/creasect_8c.html#a19">NtCreateSection</a> (SectionHandle,
01434                               SECTION_ALL_ACCESS,
01435                               &amp;Obja,
01436                               &amp;secSize,
01437                               PAGE_READWRITE,
01438                               SEC_RESERVE,
01439                               NULL
01440                              );
01441     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01442         <span class="keywordflow">return</span>((ULONG) <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01443     }
01444 
01445     *BaseAddress = 0;
01446     *ViewSize = 0;
01447 
01448     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d5/mapview_8c.html#a20">NtMapViewOfSection</a>(*SectionHandle,
01449                                 NtCurrentProcess(),
01450                                 BaseAddress,        <span class="comment">// Receives the base</span>
01451                                                     <span class="comment">// address of the section.</span>
01452 
01453                                 0,                  <span class="comment">// No specific type of</span>
01454                                                     <span class="comment">// address required.</span>
01455 
01456                                 CommitSize,         <span class="comment">// Commit size. It was</span>
01457                                                     <span class="comment">// passed by the caller.</span>
01458                                                     <span class="comment">// NULL for a save, and</span>
01459                                                     <span class="comment">// size of the section</span>
01460                                                     <span class="comment">// for a set.</span>
01461 
01462                                 NULL,               <span class="comment">// Section offset it NULL;</span>
01463                                                     <span class="comment">// Map from the start.</span>
01464 
01465                                 ViewSize,           <span class="comment">// View Size is NULL since</span>
01466                                                     <span class="comment">// we want to map the</span>
01467                                                     <span class="comment">// entire section.</span>
01468 
01469                                 ViewUnmap,
01470                                 0L,
01471                                 PAGE_READWRITE
01472                                );
01473     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01474         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(*SectionHandle);
01475         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01476     }
01477 
01478     *BaseClientAddress = 0;
01479     *ViewSize = 0;
01480     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d5/mapview_8c.html#a20">NtMapViewOfSection</a>(*SectionHandle,
01481                                 ClientHandle,
01482                                 BaseClientAddress,  <span class="comment">// Receives the base</span>
01483                                                     <span class="comment">// address of the section.</span>
01484 
01485                                 0,                  <span class="comment">// No specific type of</span>
01486                                                     <span class="comment">// address required.</span>
01487 
01488                                 CommitSize,         <span class="comment">// Commit size. It was</span>
01489                                                     <span class="comment">// passed by the caller.</span>
01490                                                     <span class="comment">// NULL for a save, and</span>
01491                                                     <span class="comment">// size of the section</span>
01492                                                     <span class="comment">// for a set.</span>
01493 
01494                                 NULL,               <span class="comment">// Section offset it NULL;</span>
01495                                                     <span class="comment">// Map from the start.</span>
01496 
01497                                 ViewSize,           <span class="comment">// View Size is NULL since</span>
01498                                                     <span class="comment">// we want to map the</span>
01499                                                     <span class="comment">// entire section.</span>
01500 
01501                                 ViewUnmap,
01502 <span class="comment">// williamh, Jan 28 1994</span>
01503 <span class="comment">// This MEM_TOP_DOWN is necessary.</span>
01504 <span class="comment">// if the console has VDM registered, ntvdm would have released its video memory</span>
01505 <span class="comment">// address space(0xA0000 ~ 0xBFFFF). Without the MEM_TOP_DOWN, the</span>
01506 <span class="comment">// NtMapViewOfSection can grab the address space and we will have trouble of</span>
01507 <span class="comment">// mapping the address space to the physical video ram. We don't do a test</span>
01508 <span class="comment">// for VDM because there is no harm of doing this for non-vdm application.</span>
01509                                 MEM_TOP_DOWN,
01510                                 PAGE_READWRITE
01511                                );
01512     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01513         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(*SectionHandle);
01514     }
01515     <span class="keywordflow">return</span>((ULONG) <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01516 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a46" doxytag="server/private.c::SetActivePalette" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SetActivePalette           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ScreenInfo</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00544">544</a> of file <a class="el" href="../../d8/d3/server_2private_8c-source.html">server/private.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l07575">NtUserSetInformationThread()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d9/user32_8def-source.html#l00720">RealizePalette</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/output_8c-source.html#l04700">ConsoleWindowProc()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l01567">DisplayModeTransition()</a>, and <a class="el" href="../../d7/d1/output_8c-source.html#l04072">SetActiveScreenBuffer()</a>.
<p>
<pre class="fragment"><div>00547 {
00548     USERTHREAD_USEDESKTOPINFO utudi;
00549     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bReset = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00550 
00551     <span class="keywordflow">if</span> (GetCurrentThreadId() != ScreenInfo-&gt;Console-&gt;InputThreadInfo-&gt;ThreadId) {
00552         bReset = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00553         utudi.hThread = ScreenInfo-&gt;Console-&gt;InputThreadInfo-&gt;ThreadHandle;
00554         utudi.drdRestore.pdeskRestore = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00555         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a277">NtUserSetInformationThread</a>(NtCurrentThread(),
00556                 UserThreadUseDesktop,
00557                 &amp;utudi, <span class="keyword">sizeof</span>(utudi));
00558     }
00559 
00560     SetSystemPaletteUse(ScreenInfo-&gt;Console-&gt;hDC,
00561                         ScreenInfo-&gt;dwUsage
00562                        );
00563     <a class="code" href="../../d3/d0/user32_8def.html#a84">RealizePalette</a>(ScreenInfo-&gt;Console-&gt;hDC);
00564 
00565     <span class="keywordflow">if</span> (bReset == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00566         utudi.hThread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00567         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a277">NtUserSetInformationThread</a>(NtCurrentThread(),
00568                 UserThreadUseDesktop, &amp;utudi, <span class="keyword">sizeof</span>(utudi));
00569     }
00570 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a64" doxytag="server/private.c::SetRAMFont" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS SetRAMFont           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ScreenInfo</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCHAR_INFO&nbsp;</td>
          <td class="mdname" nowrap> <em>ScreenBufPtr</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/server_2private_8c-source.html#l03336">3336</a> of file <a class="el" href="../../d8/d3/server_2private_8c-source.html">server/private.c</a>.
<p>
References <a class="el" href="../../d1/d2/dbcs_8h-source.html#l00078">tagSTRINGBITMAP::ajBits</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00045">BufferSize</a>, <a class="el" href="../../d0/d7/halvprnt_8c-source.html#l00031">BYTE</a>, <a class="el" href="../../d7/d5/foncache_8h-source.html#l00074">BYTE_ALIGN</a>, <a class="el" href="../../d5/d5/fullscr_2vga_2foncache_8c-source.html#l00041">CalcBitmapBufferSize()</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00180">ConsoleHeapAlloc</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00193">ConsoleHeapFree</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00199">ConsoleHeapSize</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d7/d5/ntcon_2server_2globals_8h-source.html#l00023">FontInfo</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00115">_MODE_FONT_PAIR::FontSize</a>, <a class="el" href="../../d7/d5/foncache_8h-source.html#l00046">_FONT_CACHE_INFORMATION::FullScreenFontIndex</a>, <a class="el" href="../../d7/d5/foncache_8h-source.html#l00047">_FONT_CACHE_INFORMATION::FullScreenFontSize</a>, <a class="el" href="../../d6/d6/foncache_8h.html#a30">GetExpandFontImage()</a>, <a class="el" href="../../d6/d6/foncache_8h.html#a25">GetFontImage()</a>, <a class="el" href="../../d0/d3/dbcs_8h.html#a28">GetStringBitmapW()</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00457">MAKE_TAG</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d2/dbcs_8h-source.html#l00069">RegModeFontPairs</a>, <a class="el" href="../../d6/d6/foncache_8h.html#a28">SetFontImage()</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00062">SHORT</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d5/foncache_8h-source.html#l00075">WORD_ALIGN</a>.
<p>
Referenced by <a class="el" href="../../d0/d2/__priv_8h-source.html#l00041">FE_WriteRegionToScreenHW()</a>.
<p>
<pre class="fragment"><div>03341 {
03342     ULONG ModeIndex = ScreenInfo-&gt;BufferInfo.TextInfo.ModeIndex;
03343     COORD FsFontSize1 = <a class="code" href="../../d0/d3/dbcs_8h.html#a24">RegModeFontPairs</a>[ModeIndex].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o3">FontSize</a>;
03344     COORD FsFontSize2 = FsFontSize1;
03345     COORD GdiFontSize1;
03346     COORD GdiFontSize2;
03347     COORD RetFontSize;
03348     WCHAR wCharBuf[2];
03349     <a class="code" href="../../d4/d7/structtagSTRINGBITMAP.html">LPSTRINGBITMAP</a> StringBitmap;
03350     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>;
03351     PWORD FontImage;
03352     <a class="code" href="../../d1/d9/struct__FONT__CACHE__INFORMATION.html">PFONT_CACHE_INFORMATION</a> FontCache;
03353     HFONT hOldFont;
03354     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03355 
03356     FontCache = (<a class="code" href="../../d1/d9/struct__FONT__CACHE__INFORMATION.html">PFONT_CACHE_INFORMATION</a>)ScreenInfo-&gt;Console-&gt;FontCacheInformation;
03357     <span class="keywordflow">if</span> (FontCache==<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
03358     {
03359         RIPMSG0(RIP_ERROR, <span class="stringliteral">"SetRAMFont: ScreenInfo-&gt;Console-&gt;FontCacheInformation == NULL."</span>);
03360         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
03361     }
03362 
03363     GdiFontSize1 = FontCache-&gt;<a class="code" href="../../d1/d9/struct__FONT__CACHE__INFORMATION.html#o1">FullScreenFontSize</a>;
03364     GdiFontSize2 = GdiFontSize1;
03365     GdiFontSize2.X *= 2;
03366     FsFontSize2.X *= 2;
03367 
03368     <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> = <a class="code" href="../../d6/d6/foncache_8h.html#a29">CalcBitmapBufferSize</a>(GdiFontSize2,BYTE_ALIGN);
03369     StringBitmap = <a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>( <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>(TMP_DBCS_TAG),
03370                              <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d7/structtagSTRINGBITMAP.html">STRINGBITMAP</a>) + <span class="keyword">sizeof</span>(StringBitmap-&gt;<a class="code" href="../../d4/d7/structtagSTRINGBITMAP.html#o2">ajBits</a>) * BufferSize);
03371     <span class="keywordflow">if</span> (StringBitmap==<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
03372     {
03373         RIPMSG0(RIP_WARNING, <span class="stringliteral">"SetRAMFont: failed to allocate StringBitmap"</span>);
03374         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
03375     }
03376 
03377     <span class="comment">/*</span>
03378 <span class="comment">     * Change GDI font to full screen font that best matched.</span>
03379 <span class="comment">     */</span>
03380     hOldFont = SelectObject(ScreenInfo-&gt;Console-&gt;hDC,FontInfo[FontCache-&gt;<a class="code" href="../../d1/d9/struct__FONT__CACHE__INFORMATION.html#o0">FullScreenFontIndex</a>].hFont);
03381 
03382     <span class="keywordflow">while</span> (Length--)
03383     {
03384         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/foncache_8h.html#a25">GetFontImage</a>(ScreenInfo-&gt;Console-&gt;FontCacheInformation,
03385                               ScreenBufPtr-&gt;Char.UnicodeChar,
03386                               (ScreenBufPtr-&gt;Attributes &amp; COMMON_LVB_SBCSDBCS) ? FsFontSize2 : FsFontSize1,
03387                               0,
03388                               NULL);
03389         <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) )
03390         {
03391             wCharBuf[0] = ScreenBufPtr-&gt;Char.UnicodeChar;
03392             wCharBuf[1] = TEXT(<span class="charliteral">'\0'</span>);
03393             <a class="code" href="../../d0/d3/dbcs_8h.html#a28">GetStringBitmapW</a>(ScreenInfo-&gt;Console-&gt;hDC,
03394                              wCharBuf,
03395                              1,
03396                              (ULONG)<a class="code" href="../../d8/d5/consrv_8h.html#a39">ConsoleHeapSize</a>(StringBitmap),
03397                              (BYTE*)StringBitmap
03398                             );
03399 
03400             RetFontSize.X = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)StringBitmap-&gt;uiWidth;
03401             RetFontSize.Y = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)StringBitmap-&gt;uiHeight;
03402 
03403             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/foncache_8h.html#a28">SetFontImage</a>(ScreenInfo-&gt;Console-&gt;FontCacheInformation,
03404                                   ScreenBufPtr-&gt;Char.UnicodeChar,
03405                                   RetFontSize,
03406                                   BYTE_ALIGN,
03407                                   StringBitmap-&gt;ajBits
03408                                  );
03409             <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
03410                 RIPMSG3(RIP_WARNING, <span class="stringliteral">"SetRAMFont: failed to set font image. wc=%04x sz=(%x,%x)"</span>,
03411                         ScreenBufPtr-&gt;Char.UnicodeChar, RetFontSize.X, RetFontSize.Y);
03412             }
03413 
03414             <span class="keywordflow">if</span> ( ( (ScreenBufPtr-&gt;Attributes &amp; COMMON_LVB_SBCSDBCS) &amp;&amp;
03415                     (GdiFontSize2.X != FsFontSize2.X || GdiFontSize2.Y != FsFontSize2.Y)) ||
03416                  (!(ScreenBufPtr-&gt;Attributes &amp; COMMON_LVB_SBCSDBCS) &amp;&amp;
03417                     (GdiFontSize1.X != FsFontSize1.X || GdiFontSize1.Y != FsFontSize1.Y))    )
03418             {
03419                 <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> = <a class="code" href="../../d6/d6/foncache_8h.html#a29">CalcBitmapBufferSize</a>(FsFontSize2,WORD_ALIGN);
03420                 FontImage = <a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>( <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>(TMP_DBCS_TAG),
03421                                       BufferSize
03422                                      );
03423                 <span class="keywordflow">if</span> (FontImage!=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03424 
03425                     <a class="code" href="../../d6/d6/foncache_8h.html#a30">GetExpandFontImage</a>(ScreenInfo-&gt;Console-&gt;FontCacheInformation,
03426                                        ScreenBufPtr-&gt;Char.UnicodeChar,
03427                                        (ScreenBufPtr-&gt;Attributes &amp; COMMON_LVB_SBCSDBCS) ? GdiFontSize2 : GdiFontSize1,
03428                                        (ScreenBufPtr-&gt;Attributes &amp; COMMON_LVB_SBCSDBCS) ? FsFontSize2 : FsFontSize1,
03429                                        FontImage
03430                                       );
03431 
03432                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/foncache_8h.html#a28">SetFontImage</a>(ScreenInfo-&gt;Console-&gt;FontCacheInformation,
03433                                           ScreenBufPtr-&gt;Char.UnicodeChar,
03434                                           (ScreenBufPtr-&gt;Attributes &amp; COMMON_LVB_SBCSDBCS) ? FsFontSize2 : FsFontSize1,
03435                                           WORD_ALIGN,
03436                                           FontImage
03437                                          );
03438                     <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
03439                         RIPMSG3(RIP_WARNING, <span class="stringliteral">"SetRAMFont: failed to set font image. wc=%04x sz=(%x,%x)"</span>,
03440                                 ScreenBufPtr-&gt;Char.UnicodeChar,
03441                                 ((ScreenBufPtr-&gt;Attributes &amp; COMMON_LVB_SBCSDBCS) ? FsFontSize2 : FsFontSize1).X,
03442                                 ((ScreenBufPtr-&gt;Attributes &amp; COMMON_LVB_SBCSDBCS) ? FsFontSize2 : FsFontSize1).Y);
03443                     }
03444 
03445                     <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(FontImage);
03446                 } <span class="keywordflow">else</span> {
03447                     RIPMSG0(RIP_WARNING, <span class="stringliteral">"SetRAMFont: failed to allocate FontImage."</span>);
03448                 }
03449             }
03450         }
03451 
03452         <span class="keywordflow">if</span> (ScreenBufPtr-&gt;Attributes &amp; COMMON_LVB_SBCSDBCS)
03453         {
03454             ScreenBufPtr += 2;
03455             <span class="keywordflow">if</span> (Length &gt;= 1)
03456                 Length -= 1;
03457             <span class="keywordflow">else</span>
03458                 <span class="keywordflow">break</span>;
03459         }
03460         <span class="keywordflow">else</span>
03461         {
03462             ScreenBufPtr++;
03463         }
03464     }
03465 
03466     <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(StringBitmap);
03467 
03468     <span class="comment">/*</span>
03469 <span class="comment">     * Back to GDI font</span>
03470 <span class="comment">     */</span>
03471     SelectObject(ScreenInfo-&gt;Console-&gt;hDC,hOldFont);
03472 
03473     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03474 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a63" doxytag="server/private.c::SetRAMFontCodePage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS SetRAMFontCodePage           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ScreenInfo</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/server_2private_8c-source.html#l03175">3175</a> of file <a class="el" href="../../d8/d3/server_2private_8c-source.html">server/private.c</a>.
<p>
References <a class="el" href="../../d1/d2/dbcs_8h-source.html#l00078">tagSTRINGBITMAP::ajBits</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00045">BufferSize</a>, <a class="el" href="../../d0/d7/halvprnt_8c-source.html#l00031">BYTE</a>, <a class="el" href="../../d7/d5/foncache_8h-source.html#l00074">BYTE_ALIGN</a>, <a class="el" href="../../d5/d5/fullscr_2vga_2foncache_8c-source.html#l00041">CalcBitmapBufferSize()</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00180">ConsoleHeapAlloc</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00193">ConsoleHeapFree</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00199">ConsoleHeapSize</a>, <a class="el" href="../../d6/d6/foncache_8h.html#a23">CreateFontCache()</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d7/d5/ntcon_2server_2globals_8h-source.html#l00023">FontInfo</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00115">_MODE_FONT_PAIR::FontSize</a>, <a class="el" href="../../d7/d5/foncache_8h-source.html#l00046">_FONT_CACHE_INFORMATION::FullScreenFontIndex</a>, <a class="el" href="../../d7/d5/foncache_8h-source.html#l00047">_FONT_CACHE_INFORMATION::FullScreenFontSize</a>, <a class="el" href="../../d6/d6/foncache_8h.html#a30">GetExpandFontImage()</a>, <a class="el" href="../../d0/d3/dbcs_8h.html#a28">GetStringBitmapW()</a>, <a class="el" href="../../d0/d3/dbcs_8h.html#a27">LPSTRINGBITMAP</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00457">MAKE_TAG</a>, <a class="el" href="../../d0/d3/dbcs_8h.html#a43">MakeAltRasterFont()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d5/ntcon_2server_2globals_8h-source.html#l00025">OEMCP</a>, <a class="el" href="../../d6/d6/foncache_8h.html#a20">PFONT_CACHE_INFORMATION</a>, <a class="el" href="../../d1/d2/dbcs_8h-source.html#l00069">RegModeFontPairs</a>, <a class="el" href="../../d9/d4/consrv_8h-source.html#l00124">SCR_FONTCODEPAGE()</a>, <a class="el" href="../../d1/d2/dbcs_8h-source.html#l00055">_MODE_FONT_PAIR::ScreenSize</a>, <a class="el" href="../../d6/d6/foncache_8h.html#a28">SetFontImage()</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00062">SHORT</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d0/d3/dbcs_8h.html#a26">STRINGBITMAP</a>, and <a class="el" href="../../d7/d5/foncache_8h-source.html#l00075">WORD_ALIGN</a>.
<p>
Referenced by <a class="el" href="../../d0/d2/__priv_8h-source.html#l00041">FE_WriteRegionToScreenHW()</a>.
<p>
<pre class="fragment"><div>03178 {
03179     FSVIDEO_SCREEN_INFORMATION ScreenInformation;
03180     ULONG ModeIndex = ScreenInfo-&gt;BufferInfo.TextInfo.ModeIndex;
03181     COORD FontSize;
03182     WCHAR wChar;
03183     WCHAR wCharBuf[2];
03184     <a class="code" href="../../d4/d7/structtagSTRINGBITMAP.html">LPSTRINGBITMAP</a> StringBitmap;
03185     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>;
03186     PWORD FontImage;
03187     <a class="code" href="../../d1/d9/struct__FONT__CACHE__INFORMATION.html">PFONT_CACHE_INFORMATION</a> FontCache;
03188     WCHAR AltFaceName[LF_FACESIZE];
03189     COORD AltFontSize;
03190     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>  AltFontFamily;
03191     ULONG AltFontIndex = 0;
03192     HFONT hOldFont;
03193     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03194 
03195     ScreenInformation.ScreenSize = <a class="code" href="../../d0/d3/dbcs_8h.html#a24">RegModeFontPairs</a>[ModeIndex].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o1">ScreenSize</a>;
03196     ScreenInformation.FontSize = <a class="code" href="../../d0/d3/dbcs_8h.html#a24">RegModeFontPairs</a>[ModeIndex].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o3">FontSize</a>;
03197     <span class="keywordflow">if</span> (ScreenInfo-&gt;Console-&gt;FontCacheInformation == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
03198     {
03199         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/foncache_8h.html#a23">CreateFontCache</a>(&amp;FontCache);
03200         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
03201             RIPMSG1(RIP_WARNING, <span class="stringliteral">"SetRAMFontCodePage: failed in CreateFontCache. Status=%08x"</span>, Status);
03202             <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
03203         }
03204         (<a class="code" href="../../d1/d9/struct__FONT__CACHE__INFORMATION.html">PFONT_CACHE_INFORMATION</a>)ScreenInfo-&gt;Console-&gt;FontCacheInformation = FontCache;
03205 
03206         <a class="code" href="../../d0/d3/dbcs_8h.html#a43">MakeAltRasterFont</a>(<a class="code" href="../../d8/d5/consrv_8h.html#a68">SCR_FONTCODEPAGE</a>(ScreenInfo),
03207                           RegModeFontPairs[ModeIndex].FontSize,
03208                           &amp;AltFontSize, &amp;AltFontFamily, &amp;AltFontIndex, AltFaceName);
03209         FontCache-&gt;<a class="code" href="../../d1/d9/struct__FONT__CACHE__INFORMATION.html#o0">FullScreenFontIndex</a> = AltFontIndex;
03210         FontCache-&gt;<a class="code" href="../../d1/d9/struct__FONT__CACHE__INFORMATION.html#o1">FullScreenFontSize</a>  = AltFontSize;
03211 
03212         <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> = <a class="code" href="../../d6/d6/foncache_8h.html#a29">CalcBitmapBufferSize</a>(FontCache-&gt;<a class="code" href="../../d1/d9/struct__FONT__CACHE__INFORMATION.html#o1">FullScreenFontSize</a>,BYTE_ALIGN);
03213         StringBitmap = <a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>( <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>(TMP_DBCS_TAG),
03214                                  <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d7/structtagSTRINGBITMAP.html">STRINGBITMAP</a>) + <span class="keyword">sizeof</span>(StringBitmap-&gt;<a class="code" href="../../d4/d7/structtagSTRINGBITMAP.html#o2">ajBits</a>) * BufferSize);
03215         <span class="keywordflow">if</span> (StringBitmap==<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
03216         {
03217             RIPMSG0(RIP_WARNING, <span class="stringliteral">"SetRAMFontCodePage: failed to allocate StringBitmap"</span>);
03218             <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
03219         }
03220 
03221 
03222         <span class="comment">/*</span>
03223 <span class="comment">         * Change GDI font to full screen font that best matched.</span>
03224 <span class="comment">         */</span>
03225         hOldFont = SelectObject(ScreenInfo-&gt;Console-&gt;hDC,FontInfo[FontCache-&gt;<a class="code" href="../../d1/d9/struct__FONT__CACHE__INFORMATION.html#o0">FullScreenFontIndex</a>].hFont);
03226 
03227 
03228         <span class="keywordflow">for</span> (wChar=0x00; wChar &lt; 0x80; wChar++) {
03229             wCharBuf[0] = wChar;
03230             wCharBuf[1] = TEXT(<span class="charliteral">'\0'</span>);
03231             <a class="code" href="../../d0/d3/dbcs_8h.html#a28">GetStringBitmapW</a>(ScreenInfo-&gt;Console-&gt;hDC,
03232                              wCharBuf,
03233                              1,
03234                              (ULONG)<a class="code" href="../../d8/d5/consrv_8h.html#a39">ConsoleHeapSize</a>(StringBitmap),
03235                              (BYTE*)StringBitmap
03236                             );
03237 
03238             FontSize.X = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)StringBitmap-&gt;uiWidth;
03239             FontSize.Y = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)StringBitmap-&gt;uiHeight;
03240 
03241 <span class="preprocessor">#if defined(LATER_DBCS_FOR_GRID_CHAR)  // by kazum</span>
03242 <span class="preprocessor"></span>            <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> = <a class="code" href="../../d6/d6/foncache_8h.html#a29">CalcBitmapBufferSize</a>(FontSize,BYTE_ALIGN);
03243             *(StringBitmap-&gt;ajBits + <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>) = 0;
03244             *(StringBitmap-&gt;ajBits + <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> + 1) = 0;
03245 
03246             <span class="keywordflow">if</span> (gpGridCharacter) {
03247                 PGRID_CHARACTER_INFORMATION GridCharacter;
03248                 PWCHAR CodePoint;
03249 
03250                 GridCharacter = gpGridCharacter;
03251                 <span class="keywordflow">do</span> {
03252                     <span class="keywordflow">if</span> (GridCharacter-&gt;CodePage == <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a2">OEMCP</a>) {
03253                         CodePoint = GridCharacter-&gt;CodePoint;
03254                         <span class="keywordflow">while</span> (*CodePoint) {
03255                             <span class="keywordflow">if</span> (*CodePoint == wChar) {
03256                                 <span class="keywordflow">if</span> (FontSize.X &lt;= 8)
03257                                     *(StringBitmap-&gt;ajBits + <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>) = *(StringBitmap-&gt;ajBits + <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> - 1);
03258                                 <span class="keywordflow">else</span> {
03259                                     *(StringBitmap-&gt;ajBits + <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>) = *(StringBitmap-&gt;ajBits + <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> - 2);
03260                                     *(StringBitmap-&gt;ajBits + <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> + 1) = *(StringBitmap-&gt;ajBits + <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> - 1);
03261                                 }
03262                                 <span class="keywordflow">break</span>;
03263                             }
03264                             <span class="keywordflow">else</span>
03265                                 CodePoint++;
03266                         }
03267                         <span class="keywordflow">break</span>;
03268                     }
03269                 } <span class="keywordflow">while</span> (GridCharacter = GridCharacter-&gt;pNext);
03270             }
03271 <span class="preprocessor">#endif // LATER_DBCS_FOR_GRID_CHAR  // by kazum</span>
03272 <span class="preprocessor"></span>
03273             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/foncache_8h.html#a28">SetFontImage</a>(ScreenInfo-&gt;Console-&gt;FontCacheInformation,
03274                                   wChar,
03275                                   FontSize,
03276                                   BYTE_ALIGN,
03277                                   StringBitmap-&gt;ajBits
03278                                  );
03279             <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
03280                 RIPMSG3(RIP_WARNING, <span class="stringliteral">"SetRAMFontCodePage: failed to set font image. wc=%04x sz=(%x, %x)."</span>,
03281                         wChar, FontSize.X, FontSize.Y);
03282             }
03283 
03284             <span class="keywordflow">if</span> (FontSize.X != ScreenInformation.FontSize.X ||
03285                 FontSize.Y != ScreenInformation.FontSize.Y)
03286             {
03287                 <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> = <a class="code" href="../../d6/d6/foncache_8h.html#a29">CalcBitmapBufferSize</a>(ScreenInformation.FontSize,WORD_ALIGN);
03288                 FontImage = <a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>( <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>(TMP_DBCS_TAG),
03289                                       BufferSize
03290                                      );
03291                 <span class="keywordflow">if</span> (FontImage!=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03292 
03293                     <a class="code" href="../../d6/d6/foncache_8h.html#a30">GetExpandFontImage</a>(ScreenInfo-&gt;Console-&gt;FontCacheInformation,
03294                                        wChar,
03295                                        FontSize,
03296                                        ScreenInformation.FontSize,
03297                                        FontImage
03298                                       );
03299 
03300                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/foncache_8h.html#a28">SetFontImage</a>(ScreenInfo-&gt;Console-&gt;FontCacheInformation,
03301                                           wChar,
03302                                           ScreenInformation.FontSize,
03303                                           WORD_ALIGN,
03304                                           FontImage
03305                                          );
03306                     <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
03307                         RIPMSG3(RIP_WARNING, <span class="stringliteral">"SetRAMFontCodePage: failed to set font image. wc=%04x, sz=(%x,%x)"</span>,
03308                                 wChar, ScreenInformation.FontSize.X, ScreenInformation.FontSize.Y);
03309                     }
03310 
03311                     <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(FontImage);
03312                 } <span class="keywordflow">else</span> {
03313                     RIPMSG0(RIP_WARNING, <span class="stringliteral">"SetRAMFontCodePage: failed to allocate FontImage."</span>);
03314                 }
03315             }
03316         }
03317 
03318         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(StringBitmap);
03319 
03320         <span class="comment">/*</span>
03321 <span class="comment">         * Back to GDI font</span>
03322 <span class="comment">         */</span>
03323         SelectObject(ScreenInfo-&gt;Console-&gt;hDC,hOldFont);
03324     }
03325 
03326     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GdiFullscreenControl(FullscreenControlSetScreenInformation,
03327                                   &amp;ScreenInformation,
03328                                   <span class="keyword">sizeof</span>(ScreenInformation),
03329                                   NULL,
03330                                   NULL);
03331 
03332     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03333 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a44" doxytag="server/private.c::SrvConsoleMenuControl" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG SrvConsoleMenuControl           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PCSR_API_MSG&nbsp;</td>
          <td class="mdname" nowrap> <em>m</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PCSR_REPLY_STATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>ReplyStatus</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00373">373</a> of file <a class="el" href="../../d8/d3/server_2private_8c-source.html">server/private.c</a>.
<p>
References <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01627">ApiPreamble()</a>, <a class="el" href="../../d4/d3/struct__HANDLE__DATA.html#o5">_HANDLE_DATA::Buffer</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00659">_CONSOLE_MENUCONTROL_MSG::CommandIdHigh</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00658">_CONSOLE_MENUCONTROL_MSG::CommandIdLow</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00298">CONSOLE_GRAPHICS_OUTPUT_HANDLE</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00027">CONSOLE_OUTPUT_HANDLE</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00395">CONSOLE_PERPROCESSDATA</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00656">_CONSOLE_MENUCONTROL_MSG::ConsoleHandle</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01536">DereferenceIoHandle()</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00660">_CONSOLE_MENUCONTROL_MSG::hMenu</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00657">_CONSOLE_MENUCONTROL_MSG::OutputHandle</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l04103">UnlockConsole()</a>.
<p>
<pre class="fragment"><div>00380            :
00381 
00382     Sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> command <span class="keywordtype">id</span> range <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current screen buffer and returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00383     menu handle.
00384 
00385 Parameters:
00386 
00387     hConsoleOutput - Supplies a console output handle.
00388 
00389     dwCommandIdLow - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lowest command <span class="keywordtype">id</span> to store in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input buffer.
00390 
00391     dwCommandIdHigh - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> highest command <span class="keywordtype">id</span> to store in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input
00392         buffer.
00393 
00394 Return value:
00395 
00396     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - The operation was successful.
00397 
00398     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>/<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> - The operation failed. Extended error status <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> available
00399         <span class="keyword">using</span> GetLastError.
00400 
00401 --*/
00402 
00403 {
00404     <a class="code" href="../../d5/d3/struct__CONSOLE__MENUCONTROL__MSG.html">PCONSOLE_MENUCONTROL_MSG</a> a = (<a class="code" href="../../d5/d3/struct__CONSOLE__MENUCONTROL__MSG.html">PCONSOLE_MENUCONTROL_MSG</a>)&amp;m-&gt;u.ApiMessageData;
00405     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00406     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
00407     <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> HandleData;
00408 
00409     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a33">ApiPreamble</a>(a-&gt;<a class="code" href="../../d5/d3/struct__CONSOLE__MENUCONTROL__MSG.html#o0">ConsoleHandle</a>,
00410                          &amp;Console
00411                         );
00412     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00413         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00414     }
00415     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a31">DereferenceIoHandle</a>(<a class="code" href="../../d1/d7/server_8h.html#a84">CONSOLE_PERPROCESSDATA</a>(),
00416                                  a-&gt;<a class="code" href="../../d5/d3/struct__CONSOLE__MENUCONTROL__MSG.html#o1">OutputHandle</a>,
00417                                  CONSOLE_OUTPUT_HANDLE | CONSOLE_GRAPHICS_OUTPUT_HANDLE,
00418                                  GENERIC_WRITE,
00419                                  &amp;HandleData
00420                                 );
00421     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00422         a-&gt;<a class="code" href="../../d5/d3/struct__CONSOLE__MENUCONTROL__MSG.html#o4">hMenu</a> = HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer-&gt;Console-&gt;hMenu;
00423         HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer-&gt;CommandIdLow = a-&gt;<a class="code" href="../../d5/d3/struct__CONSOLE__MENUCONTROL__MSG.html#o2">CommandIdLow</a>;
00424         HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer-&gt;CommandIdHigh = a-&gt;<a class="code" href="../../d5/d3/struct__CONSOLE__MENUCONTROL__MSG.html#o3">CommandIdHigh</a>;
00425     }
00426     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
00427     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00428     UNREFERENCED_PARAMETER(ReplyStatus);    <span class="comment">// get rid of unreferenced parameter warning message</span>
00429 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a53" doxytag="server/private.c::SrvConsoleNotifyLastClose" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS SrvConsoleNotifyLastClose           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PCSR_API_MSG&nbsp;</td>
          <td class="mdname" nowrap> <em>m</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PCSR_REPLY_STATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>ReplyStatus</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/server_2private_8c-source.html#l01346">1346</a> of file <a class="el" href="../../d8/d3/server_2private_8c-source.html">server/private.c</a>.
<p>
References <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01627">ApiPreamble()</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00380">CONSOLE_CLIENTPROCESSHANDLE</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00383">CONSOLE_CLIENTPROCESSID</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00092">CONSOLE_NOTIFY_LAST_CLOSE</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00750">_CONSOLE_NOTIFYLASTCLOSE_MSG::ConsoleHandle</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00164">_CONSOLE_INFORMATION::Flags</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00231">_CONSOLE_INFORMATION::hProcessLastNotifyClose</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l00163">NtDuplicateObject()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d5/conmsg_8h.html#a154">PCONSOLE_NOTIFYLASTCLOSE_MSG</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00232">_CONSOLE_INFORMATION::ProcessIdLastNotifyClose</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l04103">UnlockConsole()</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00195">_CONSOLE_INFORMATION::VDMProcessHandle</a>, and <a class="el" href="../../d2/d6/server_8h-source.html#l00196">_CONSOLE_INFORMATION::VDMProcessId</a>.
<p>
<pre class="fragment"><div>01350 {
01351     <a class="code" href="../../d8/d3/struct__CONSOLE__NOTIFYLASTCLOSE__MSG.html">PCONSOLE_NOTIFYLASTCLOSE_MSG</a> a = (<a class="code" href="../../d8/d3/struct__CONSOLE__NOTIFYLASTCLOSE__MSG.html">PCONSOLE_NOTIFYLASTCLOSE_MSG</a>)&amp;m-&gt;u.ApiMessageData;
01352     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01353     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
01354 
01355     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a33">ApiPreamble</a>(a-&gt;<a class="code" href="../../d8/d3/struct__CONSOLE__NOTIFYLASTCLOSE__MSG.html#o0">ConsoleHandle</a>,
01356                          &amp;Console
01357                         );
01358     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01359         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01360     }
01361 <span class="comment">// williamh, Feb 2 1994.</span>
01362 <span class="comment">// this non-X86 special case is not necessary. We expect</span>
01363 <span class="comment">// ntvdm to call RegisterConsoleVDM API and there we do duplicate</span>
01364 <span class="comment">// the vdm process handle and grab its process id.</span>
01365 <span class="comment">// If we continue to do this we may hit the assert below</span>
01366 <span class="comment">// because when RegisterConsoleVDM failed(short of memory, for example)</span>
01367 <span class="comment">// the VDMProcessHandle may have been set and next time a vdm application</span>
01368 <span class="comment">// was launched from the same console(ntvdm will do the NotifyLastClose</span>
01369 <span class="comment">// before RegisterConsoleVDM).</span>
01370 <span class="preprocessor">#if 0</span>
01371 <span class="preprocessor"></span><span class="preprocessor">#if !defined(_X86_)</span>
01372 <span class="preprocessor"></span>    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o51">VDMProcessHandle</a> == NULL);
01373     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d0/obhandle_8c.html#a4">NtDuplicateObject</a>(NtCurrentProcess(), <a class="code" href="../../d1/d7/server_8h.html#a79">CONSOLE_CLIENTPROCESSHANDLE</a>(),
01374             NtCurrentProcess(), &amp;Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o51">VDMProcessHandle</a>,
01375             0, FALSE, DUPLICATE_SAME_ACCESS);
01376     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01377         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01378     }
01379     Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o52">VDMProcessId</a> = <a class="code" href="../../d1/d7/server_8h.html#a80">CONSOLE_CLIENTPROCESSID</a>();
01380 <span class="preprocessor">#endif</span>
01381 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
01382 <span class="preprocessor"></span>    <span class="comment">// Doesn't allow two or more processes to have last-close notify on</span>
01383     <span class="comment">// the same console</span>
01384     <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a7">CONSOLE_NOTIFY_LAST_CLOSE</a>) {
01385         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01386         <span class="keywordflow">return</span> (ULONG)STATUS_ACCESS_DENIED;
01387     }
01388 
01389     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d0/obhandle_8c.html#a4">NtDuplicateObject</a>(NtCurrentProcess(), <a class="code" href="../../d1/d7/server_8h.html#a79">CONSOLE_CLIENTPROCESSHANDLE</a>(),
01390                                NtCurrentProcess(),
01391                                &amp;Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o72">hProcessLastNotifyClose</a>,
01392                                0, FALSE, DUPLICATE_SAME_ACCESS
01393                                );
01394     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01395         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01396         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01397     }
01398 
01399     Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> |= <a class="code" href="../../d1/d7/server_8h.html#a7">CONSOLE_NOTIFY_LAST_CLOSE</a>;
01400     Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o73">ProcessIdLastNotifyClose</a> = <a class="code" href="../../d1/d7/server_8h.html#a80">CONSOLE_CLIENTPROCESSID</a>();
01401     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01402     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01403     UNREFERENCED_PARAMETER(ReplyStatus);    <span class="comment">// get rid of unreferenced parameter warning message</span>
01404 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a58" doxytag="server/private.c::SrvGetConsoleDisplayMode" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG SrvGetConsoleDisplayMode           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PCSR_API_MSG&nbsp;</td>
          <td class="mdname" nowrap> <em>m</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PCSR_REPLY_STATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>ReplyStatus</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/server_2private_8c-source.html#l02355">2355</a> of file <a class="el" href="../../d8/d3/server_2private_8c-source.html">server/private.c</a>.
<p>
References <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01627">ApiPreamble()</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00708">_CONSOLE_GETDISPLAYMODE_MSG::ConsoleHandle</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00188">_CONSOLE_INFORMATION::FullScreenFlags</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00709">_CONSOLE_GETDISPLAYMODE_MSG::ModeFlags</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l04103">UnlockConsole()</a>.
<p>
<pre class="fragment"><div>02359 {
02360     <a class="code" href="../../d7/d1/struct__CONSOLE__GETDISPLAYMODE__MSG.html">PCONSOLE_GETDISPLAYMODE_MSG</a> a = (<a class="code" href="../../d7/d1/struct__CONSOLE__GETDISPLAYMODE__MSG.html">PCONSOLE_GETDISPLAYMODE_MSG</a>)&amp;m-&gt;u.ApiMessageData;
02361     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02362     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
02363 
02364     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a33">ApiPreamble</a>(a-&gt;<a class="code" href="../../d7/d1/struct__CONSOLE__GETDISPLAYMODE__MSG.html#o0">ConsoleHandle</a>,
02365                          &amp;Console
02366                         );
02367     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02368         a-&gt;<a class="code" href="../../d7/d1/struct__CONSOLE__GETDISPLAYMODE__MSG.html#o1">ModeFlags</a> = Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o47">FullScreenFlags</a>;
02369         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
02370     }
02371     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02372     UNREFERENCED_PARAMETER(ReplyStatus);
02373 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a56" doxytag="server/private.c::SrvGetConsoleHardwareState" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG SrvGetConsoleHardwareState           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PCSR_API_MSG&nbsp;</td>
          <td class="mdname" nowrap> <em>m</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PCSR_REPLY_STATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>ReplyStatus</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/server_2private_8c-source.html#l02232">2232</a> of file <a class="el" href="../../d8/d3/server_2private_8c-source.html">server/private.c</a>.
<p>
References <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01627">ApiPreamble()</a>, <a class="el" href="../../d4/d3/struct__HANDLE__DATA.html#o5">_HANDLE_DATA::Buffer</a>, <a class="el" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">_SCREEN_INFORMATION::BufferInfo</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00027">CONSOLE_OUTPUT_HANDLE</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00395">CONSOLE_PERPROCESSDATA</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00694">_CONSOLE_GETHARDWARESTATE_MSG::ConsoleHandle</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01536">DereferenceIoHandle()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00115">_MODE_FONT_PAIR::FontSize</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00697">_CONSOLE_GETHARDWARESTATE_MSG::FontSize</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00120">ModeFontPairs</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00695">_CONSOLE_GETHARDWARESTATE_MSG::OutputHandle</a>, <a class="el" href="../../d1/d2/dbcs_8h-source.html#l00069">RegModeFontPairs</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00114">_MODE_FONT_PAIR::Resolution</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00696">_CONSOLE_GETHARDWARESTATE_MSG::Resolution</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l04103">UnlockConsole()</a>.
<p>
<pre class="fragment"><div>02236 {
02237 <span class="preprocessor">#ifdef i386</span>
02238 <span class="preprocessor"></span>    <a class="code" href="../../d1/d2/struct__CONSOLE__GETHARDWARESTATE__MSG.html">PCONSOLE_GETHARDWARESTATE_MSG</a> a = (<a class="code" href="../../d1/d2/struct__CONSOLE__GETHARDWARESTATE__MSG.html">PCONSOLE_GETHARDWARESTATE_MSG</a>)&amp;m-&gt;u.ApiMessageData;
02239     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02240     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
02241     <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> HandleData;
02242     <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo;
02243 
02244     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a33">ApiPreamble</a>(a-&gt;<a class="code" href="../../d1/d2/struct__CONSOLE__GETHARDWARESTATE__MSG.html#o0">ConsoleHandle</a>,
02245                          &amp;Console
02246                         );
02247     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02248         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02249     }
02250     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a31">DereferenceIoHandle</a>(<a class="code" href="../../d1/d7/server_8h.html#a84">CONSOLE_PERPROCESSDATA</a>(),
02251                                  a-&gt;<a class="code" href="../../d1/d2/struct__CONSOLE__GETHARDWARESTATE__MSG.html#o1">OutputHandle</a>,
02252                                  CONSOLE_OUTPUT_HANDLE,
02253                                  GENERIC_READ,
02254                                  &amp;HandleData
02255                                 );
02256     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02257         ScreenInfo = HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer;
02258         <span class="keywordflow">if</span> (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.ModeIndex == -1) {
02259             <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
02260             <span class="keywordflow">return</span> (ULONG)STATUS_UNSUCCESSFUL;
02261         }
02262 <span class="preprocessor">#if defined(FE_SB)</span>
02263 <span class="preprocessor"></span>        a-&gt;<a class="code" href="../../d1/d2/struct__CONSOLE__GETHARDWARESTATE__MSG.html#o2">Resolution</a> = <a class="code" href="../../d0/d3/dbcs_8h.html#a24">RegModeFontPairs</a>[ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.ModeIndex].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o2">Resolution</a>;
02264         a-&gt;<a class="code" href="../../d1/d2/struct__CONSOLE__GETHARDWARESTATE__MSG.html#o3">FontSize</a> = <a class="code" href="../../d0/d3/dbcs_8h.html#a24">RegModeFontPairs</a>[ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.ModeIndex].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o3">FontSize</a>;
02265 <span class="preprocessor">#else</span>
02266 <span class="preprocessor"></span>        a-&gt;<a class="code" href="../../d1/d2/struct__CONSOLE__GETHARDWARESTATE__MSG.html#o2">Resolution</a> = <a class="code" href="../../d7/d4/server_2private_8c.html#a28">ModeFontPairs</a>[ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.ModeIndex].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o2">Resolution</a>;
02267         a-&gt;<a class="code" href="../../d1/d2/struct__CONSOLE__GETHARDWARESTATE__MSG.html#o3">FontSize</a> = <a class="code" href="../../d7/d4/server_2private_8c.html#a28">ModeFontPairs</a>[ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.ModeIndex].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o3">FontSize</a>;
02268 <span class="preprocessor">#endif</span>
02269 <span class="preprocessor"></span>    }
02270     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
02271     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02272 <span class="preprocessor">#else</span>
02273 <span class="preprocessor"></span>    <span class="keywordflow">return</span> (ULONG)STATUS_UNSUCCESSFUL;
02274     UNREFERENCED_PARAMETER(m);    <span class="comment">// get rid of unreferenced parameter warning message</span>
02275 <span class="preprocessor">#endif</span>
02276 <span class="preprocessor"></span>    UNREFERENCED_PARAMETER(ReplyStatus);    <span class="comment">// get rid of unreferenced parameter warning message</span>
02277 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a52" doxytag="server/private.c::SrvRegisterConsoleVDM" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG SrvRegisterConsoleVDM           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PCSR_API_MSG&nbsp;</td>
          <td class="mdname" nowrap> <em>m</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PCSR_REPLY_STATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>ReplyStatus</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/server_2private_8c-source.html#l01094">1094</a> of file <a class="el" href="../../d8/d3/server_2private_8c-source.html">server/private.c</a>.
<p>
References <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01627">ApiPreamble()</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">_SCREEN_INFORMATION::BufferInfo</a>, <a class="el" href="../../d0/d7/halvprnt_8c-source.html#l00031">BYTE</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l01519">ConnectToEmulator()</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00380">CONSOLE_CLIENTPROCESSHANDLE</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00383">CONSOLE_CLIENTPROCESSID</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00098">CONSOLE_CONNECTED_TO_EMULATOR</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00099">CONSOLE_FULLSCREEN_NOPAINT</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00087">CONSOLE_HAS_FOCUS</a>, <a class="el" href="../../d8/d1/output_8h-source.html#l00148">CONSOLE_TEXTMODE_BUFFER</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00094">CONSOLE_VDM_REGISTERED</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00103">CONSOLE_WOW_REGISTERED</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00679">_CONSOLE_REGISTERVDM_MSG::ConsoleHandle</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00133">_CONSOLE_INFORMATION::CurrentScreenBuffer</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00682">_CONSOLE_REGISTERVDM_MSG::EndEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d1/output_8h-source.html#l00154">_SCREEN_INFORMATION::Flags</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00164">_CONSOLE_INFORMATION::Flags</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00188">_CONSOLE_INFORMATION::FullScreenFlags</a>, <a class="el" href="../../d7/d5/ntcon_2server_2globals_8h-source.html#l00039">FullScreenInitialized</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00235">_CONSOLE_INFORMATION::InputThreadInfo</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l01407">MapViewOfSection()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l00163">NtDuplicateObject()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d8/umapview_8c-source.html#l00033">NtUnmapViewOfSection()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l00870">NtUserConsoleControl()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l07575">NtUserSetInformationThread()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00680">_CONSOLE_REGISTERVDM_MSG::RegisterFlags</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00681">_CONSOLE_REGISTERVDM_MSG::StartEvent</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00686">_CONSOLE_REGISTERVDM_MSG::StateBuffer</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00204">_CONSOLE_INFORMATION::StateBuffer</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00205">_CONSOLE_INFORMATION::StateBufferClient</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00206">_CONSOLE_INFORMATION::StateLength</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00685">_CONSOLE_REGISTERVDM_MSG::StateLength</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00203">_CONSOLE_INFORMATION::StateSectionHandle</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00683">_CONSOLE_REGISTERVDM_MSG::StateSectionName</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00684">_CONSOLE_REGISTERVDM_MSG::StateSectionNameLength</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00055">_INPUT_THREAD_INFO::ThreadHandle</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02842">TIF_VDMAPP</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l04103">UnlockConsole()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00980">UnregisterVDM()</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00690">_CONSOLE_REGISTERVDM_MSG::VDMBuffer</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00199">_CONSOLE_INFORMATION::VDMBuffer</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00200">_CONSOLE_INFORMATION::VDMBufferClient</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00198">_CONSOLE_INFORMATION::VDMBufferSectionHandle</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00687">_CONSOLE_REGISTERVDM_MSG::VDMBufferSectionName</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00688">_CONSOLE_REGISTERVDM_MSG::VDMBufferSectionNameLength</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00201">_CONSOLE_INFORMATION::VDMBufferSize</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00689">_CONSOLE_REGISTERVDM_MSG::VDMBufferSize</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00194">_CONSOLE_INFORMATION::VDMEndHardwareEvent</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00195">_CONSOLE_INFORMATION::VDMProcessHandle</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00196">_CONSOLE_INFORMATION::VDMProcessId</a>, and <a class="el" href="../../d2/d6/server_8h-source.html#l00193">_CONSOLE_INFORMATION::VDMStartHardwareEvent</a>.
<p>
<pre class="fragment"><div>01098 {
01099     <a class="code" href="../../d6/d4/struct__CONSOLE__REGISTERVDM__MSG.html">PCONSOLE_REGISTERVDM_MSG</a> a = (<a class="code" href="../../d6/d4/struct__CONSOLE__REGISTERVDM__MSG.html">PCONSOLE_REGISTERVDM_MSG</a>)&amp;m-&gt;u.ApiMessageData;
01100     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01101     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
01102     SIZE_T ViewSize;
01103 <span class="preprocessor">#ifdef i386</span>
01104 <span class="preprocessor"></span>    VIDEO_REGISTER_VDM RegisterVdm;
01105     ULONG RegisterVdmSize = <span class="keyword">sizeof</span>(RegisterVdm);
01106     VIDEO_VDM Vdm;
01107 <span class="preprocessor">#endif  //i386</span>
01108 <span class="preprocessor"></span>    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a33">ApiPreamble</a>(a-&gt;<a class="code" href="../../d6/d4/struct__CONSOLE__REGISTERVDM__MSG.html#o0">ConsoleHandle</a>,
01109                          &amp;Console
01110                         );
01111     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01112         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01113     }
01114 
01115 
01116     <span class="keywordflow">if</span> (!a-&gt;<a class="code" href="../../d6/d4/struct__CONSOLE__REGISTERVDM__MSG.html#o1">RegisterFlags</a>) {
01117 <span class="comment">//      williamh, Jan 28 1994</span>
01118 <span class="comment">//      do not do an assert here because we may have unregistered the ntvdm</span>
01119 <span class="comment">//      and the ntvdm doesn't necessarily know this(and it could post another</span>
01120 <span class="comment">//      unregistervdm). Return error here so NTVDM knows what to do</span>
01121 <span class="comment">//      ASSERT(Console-&gt;Flags &amp; CONSOLE_VDM_REGISTERED);</span>
01122 
01123         <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a9">CONSOLE_VDM_REGISTERED</a>) {
01124             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; CONSOLE_FULLSCREEN_NOPAINT));
01125             <a class="code" href="../../d0/d5/srvinit_8c.html#a22">UnregisterVDM</a>(Console);
01126 <span class="preprocessor">#ifdef i386</span>
01127 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o47">FullScreenFlags</a> &amp; CONSOLE_FULLSCREEN_HARDWARE &amp;&amp;
01128                 Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o4">CurrentScreenBuffer</a>-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o1">Flags</a> &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>) {
01129             <span class="comment">//    SetVideoMode(Console-&gt;CurrentScreenBuffer);</span>
01130                 <span class="comment">//set up cursor</span>
01131                 SetCursorInformationHW(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o4">CurrentScreenBuffer</a>,
01132                                        Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o4">CurrentScreenBuffer</a>-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorSize,
01133                                        Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o4">CurrentScreenBuffer</a>-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorVisible);
01134                 SetCursorPositionHW(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o4">CurrentScreenBuffer</a>,
01135                                     Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o4">CurrentScreenBuffer</a>-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition);
01136             }
01137 <span class="preprocessor">#endif</span>
01138 <span class="preprocessor"></span>            <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01139         } <span class="keywordflow">else</span> {
01140             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED;
01141         }
01142         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01143         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01144     }
01145 
01146     <span class="keywordflow">if</span> (!CsrValidateMessageBuffer(m, &amp;a-&gt;<a class="code" href="../../d6/d4/struct__CONSOLE__REGISTERVDM__MSG.html#o4">StateSectionName</a>, a-&gt;<a class="code" href="../../d6/d4/struct__CONSOLE__REGISTERVDM__MSG.html#o5">StateSectionNameLength</a>, <span class="keyword">sizeof</span>(BYTE)) ||
01147         !CsrValidateMessageBuffer(m, &amp;a-&gt;<a class="code" href="../../d6/d4/struct__CONSOLE__REGISTERVDM__MSG.html#o8">VDMBufferSectionName</a>, a-&gt;<a class="code" href="../../d6/d4/struct__CONSOLE__REGISTERVDM__MSG.html#o9">VDMBufferSectionNameLength</a>, <span class="keyword">sizeof</span>(BYTE))) {
01148 
01149         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01150         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01151     }
01152 
01153     <span class="comment">// check it out. A console should have only one VDM registered.</span>
01154     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; CONSOLE_VDM_REGISTERED));
01155 
01156     <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a9">CONSOLE_VDM_REGISTERED</a>) {
01157         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01158         <span class="keywordflow">return</span> (ULONG) STATUS_ACCESS_DENIED;
01159     }
01160 
01161     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o51">VDMProcessHandle</a>);
01162 
01163     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d0/obhandle_8c.html#a4">NtDuplicateObject</a>(NtCurrentProcess(), <a class="code" href="../../d1/d7/server_8h.html#a79">CONSOLE_CLIENTPROCESSHANDLE</a>(),
01164                                NtCurrentProcess(), &amp;Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o51">VDMProcessHandle</a>,
01165                                0, FALSE, DUPLICATE_SAME_ACCESS);
01166     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01167         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01168         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01169     }
01170     Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o52">VDMProcessId</a> = <a class="code" href="../../d1/d7/server_8h.html#a80">CONSOLE_CLIENTPROCESSID</a>();
01171 
01172 <span class="preprocessor">#ifdef i386</span>
01173 <span class="preprocessor"></span>
01174     Vdm.ProcessHandle = Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o51">VDMProcessHandle</a>;
01175 
01176     <span class="comment">//</span>
01177     <span class="comment">// Assume fullscreen initialization will fail.</span>
01178     <span class="comment">// have state length set to zero so that NTVDM will know</span>
01179     <span class="comment">// full screen is disabled.</span>
01180     <span class="comment">//</span>
01181 
01182     a-&gt;<a class="code" href="../../d6/d4/struct__CONSOLE__REGISTERVDM__MSG.html#o6">StateLength</a> = 0;
01183     Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o60">StateLength</a> = 0;
01184     Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o59">StateBufferClient</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01185 
01186     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a12">FullScreenInitialized</a>) {
01187 
01188     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d0/obhandle_8c.html#a4">NtDuplicateObject</a>(<a class="code" href="../../d1/d7/server_8h.html#a79">CONSOLE_CLIENTPROCESSHANDLE</a>(),
01189                    a-&gt;<a class="code" href="../../d6/d4/struct__CONSOLE__REGISTERVDM__MSG.html#o2">StartEvent</a>,
01190                    NtCurrentProcess(),
01191                    &amp;Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o49">VDMStartHardwareEvent</a>,
01192                    0,
01193                    FALSE,
01194                    DUPLICATE_SAME_ACCESS
01195                   );
01196     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01197         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d0/obhandle_8c.html#a4">NtDuplicateObject</a>(<a class="code" href="../../d1/d7/server_8h.html#a79">CONSOLE_CLIENTPROCESSHANDLE</a>(),
01198                        a-&gt;<a class="code" href="../../d6/d4/struct__CONSOLE__REGISTERVDM__MSG.html#o3">EndEvent</a>,
01199                        NtCurrentProcess(),
01200                        &amp;Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o50">VDMEndHardwareEvent</a>,
01201                        0,
01202                        FALSE,
01203                        DUPLICATE_SAME_ACCESS
01204                       );
01205         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01206                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GdiFullscreenControl(FullscreenControlRegisterVdm,
01207                                          &amp;Vdm,
01208                                          <span class="keyword">sizeof</span>(Vdm),
01209                                          &amp;RegisterVdm,
01210                                          &amp;RegisterVdmSize
01211                                         );
01212 
01213           <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01214 
01215                     <span class="comment">//</span>
01216                     <span class="comment">// create state section and map a view of it into server and vdm.</span>
01217                     <span class="comment">// this section is used to get/set video hardware state during</span>
01218                     <span class="comment">// the fullscreen&lt;-&gt;windowed transition.  we create the section</span>
01219                     <span class="comment">// instead of the vdm for security purposes.</span>
01220                     <span class="comment">//</span>
01221 
01222             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d4/server_2private_8c.html#a40">MapViewOfSection</a>(&amp;Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o57">StateSectionHandle</a>,
01223                           RegisterVdm.MinimumStateSize,
01224                           &amp;Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o58">StateBuffer</a>,
01225                           &amp;ViewSize,
01226                           Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o51">VDMProcessHandle</a>,
01227                           &amp;a-&gt;<a class="code" href="../../d6/d4/struct__CONSOLE__REGISTERVDM__MSG.html#o7">StateBuffer</a>
01228                          );
01229 
01230             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01231                         a-&gt;<a class="code" href="../../d6/d4/struct__CONSOLE__REGISTERVDM__MSG.html#o6">StateLength</a> = RegisterVdm.MinimumStateSize;
01232                         Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o60">StateLength</a> = RegisterVdm.MinimumStateSize;
01233                         Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o59">StateBufferClient</a> = a-&gt;<a class="code" href="../../d6/d4/struct__CONSOLE__REGISTERVDM__MSG.html#o7">StateBuffer</a>;
01234             }
01235 
01236           } <span class="keywordflow">else</span> {
01237 
01238             CloseHandle(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o49">VDMStartHardwareEvent</a>);
01239             CloseHandle(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o50">VDMEndHardwareEvent</a>);
01240           }
01241 
01242         } <span class="keywordflow">else</span> {
01243 
01244         <span class="comment">// ASSERT(FALSE);</span>
01245         CloseHandle(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o49">VDMStartHardwareEvent</a>);
01246         CloseHandle(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o50">VDMEndHardwareEvent</a>);
01247        }
01248 
01249     } <span class="keywordflow">else</span> {
01250         CloseHandle(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o49">VDMStartHardwareEvent</a>);
01251     }
01252     <span class="comment">//</span>
01253     <span class="comment">// if failed to duplicate screen switch events or  map view</span>
01254     <span class="comment">// to video state shared buffer, fails this API</span>
01255     <span class="comment">//</span>
01256     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01257         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01258         <span class="keywordflow">return</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01259     }
01260     }
01261 
01262 <span class="preprocessor">#endif</span>
01263 <span class="preprocessor"></span>    <span class="comment">//</span>
01264     <span class="comment">// create vdm char section and map a view of it into server and vdm.</span>
01265     <span class="comment">// this section is used by the vdm to update the screen when in a</span>
01266     <span class="comment">// charmode window.  this is a performance optimization.  we create</span>
01267     <span class="comment">// the section instead of the vdm for security purposes.</span>
01268     <span class="comment">//</span>
01269 
01270     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d4/server_2private_8c.html#a40">MapViewOfSection</a>(&amp;Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o53">VDMBufferSectionHandle</a>,
01271 #ifdef i386
01272                               a-&gt;<a class="code" href="../../d6/d4/struct__CONSOLE__REGISTERVDM__MSG.html#o10">VDMBufferSize</a>.X*a-&gt;<a class="code" href="../../d6/d4/struct__CONSOLE__REGISTERVDM__MSG.html#o10">VDMBufferSize</a>.Y*2,
01273 #<span class="keywordflow">else</span> <span class="comment">//risc</span>
01274                               a-&gt;<a class="code" href="../../d6/d4/struct__CONSOLE__REGISTERVDM__MSG.html#o10">VDMBufferSize</a>.X*a-&gt;<a class="code" href="../../d6/d4/struct__CONSOLE__REGISTERVDM__MSG.html#o10">VDMBufferSize</a>.Y*4,
01275 #endif
01276                               &amp;Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o54">VDMBuffer</a>,
01277                               &amp;ViewSize,
01278                               Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o51">VDMProcessHandle</a>,
01279                               &amp;a-&gt;<a class="code" href="../../d6/d4/struct__CONSOLE__REGISTERVDM__MSG.html#o11">VDMBuffer</a>
01280                              );
01281     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01282 
01283         Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o54">VDMBuffer</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01284 
01285 <span class="preprocessor">#ifdef i386</span>
01286 <span class="preprocessor"></span>
01287         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a12">FullScreenInitialized</a>) {
01288 
01289             <a class="code" href="../../d4/d9/umapview_8c.html#a0">NtUnmapViewOfSection</a>(NtCurrentProcess(),Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o58">StateBuffer</a>);
01290             <a class="code" href="../../d4/d9/umapview_8c.html#a0">NtUnmapViewOfSection</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o51">VDMProcessHandle</a>,Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o59">StateBufferClient</a>);
01291             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o57">StateSectionHandle</a>);
01292             CloseHandle(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o49">VDMStartHardwareEvent</a>);
01293             CloseHandle(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o50">VDMEndHardwareEvent</a>);
01294         }
01295 
01296 <span class="preprocessor">#endif</span>
01297 <span class="preprocessor"></span>        CloseHandle(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o51">VDMProcessHandle</a>);
01298         Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o51">VDMProcessHandle</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01299         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01300         <span class="keywordflow">return</span>((ULONG) <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01301     }
01302     Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o55">VDMBufferClient</a> = a-&gt;<a class="code" href="../../d6/d4/struct__CONSOLE__REGISTERVDM__MSG.html#o11">VDMBuffer</a>;
01303 
01304     Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> |= <a class="code" href="../../d1/d7/server_8h.html#a9">CONSOLE_VDM_REGISTERED</a>;
01305 
01306     <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a2">CONSOLE_HAS_FOCUS</a>) {
01307         USERTHREAD_FLAGS Flags;
01308 
01309         Flags.dwFlags = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a810">TIF_VDMAPP</a>;
01310         Flags.dwMask = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a810">TIF_VDMAPP</a>;
01311         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a277">NtUserSetInformationThread</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o75">InputThreadInfo</a>-&gt;<a class="code" href="../../d9/d2/struct__INPUT__THREAD__INFO.html#o0">ThreadHandle</a>,
01312                 UserThreadFlags, &amp;Flags, <span class="keyword">sizeof</span>(Flags));
01313     }
01314     Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o56">VDMBufferSize</a> = a-&gt;<a class="code" href="../../d6/d4/struct__CONSOLE__REGISTERVDM__MSG.html#o10">VDMBufferSize</a>;
01315 
01316     <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d6/d4/struct__CONSOLE__REGISTERVDM__MSG.html#o1">RegisterFlags</a> &amp; CONSOLE_REGISTER_WOW)
01317         Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> |= <a class="code" href="../../d1/d7/server_8h.html#a18">CONSOLE_WOW_REGISTERED</a>;
01318     <span class="keywordflow">else</span>
01319         Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp;= ~<a class="code" href="../../d1/d7/server_8h.html#a18">CONSOLE_WOW_REGISTERED</a>;
01320 
01321     <span class="comment">//</span>
01322     <span class="comment">// if we're already in fullscreen and we run a DOS app for</span>
01323     <span class="comment">// the first time, connect the emulator.</span>
01324     <span class="comment">//</span>
01325 
01326 <span class="preprocessor">#ifdef i386</span>
01327 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o47">FullScreenFlags</a> &amp; CONSOLE_FULLSCREEN_HARDWARE) {
01328         RECT CursorRect;
01329         CursorRect.left = -32767;
01330         CursorRect.top = -32767;
01331         CursorRect.right = 32767;
01332         CursorRect.bottom = 32767;
01333         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a86">NtUserConsoleControl</a>(ConsoleSetVDMCursorBounds, &amp;CursorRect, <span class="keyword">sizeof</span>(RECT));
01334         <span class="comment">// connect emulator</span>
01335         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; CONSOLE_CONNECTED_TO_EMULATOR));
01336         <a class="code" href="../../d7/d4/server_2private_8c.html#a41">ConnectToEmulator</a>(TRUE, Console);
01337     }
01338 <span class="preprocessor">#endif</span>
01339 <span class="preprocessor"></span>
01340     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
01341     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01342     UNREFERENCED_PARAMETER(ReplyStatus);    <span class="comment">// get rid of unreferenced parameter warning message</span>
01343 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a42" doxytag="server/private.c::SrvSetConsoleCursor" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG SrvSetConsoleCursor           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PCSR_API_MSG&nbsp;</td>
          <td class="mdname" nowrap> <em>m</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PCSR_REPLY_STATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>ReplyStatus</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00213">213</a> of file <a class="el" href="../../d8/d3/server_2private_8c-source.html">server/private.c</a>.
<p>
References <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01627">ApiPreamble()</a>, <a class="el" href="../../d4/d3/struct__HANDLE__DATA.html#o5">_HANDLE_DATA::Buffer</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00298">CONSOLE_GRAPHICS_OUTPUT_HANDLE</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00395">CONSOLE_PERPROCESSDATA</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00643">_CONSOLE_SETCURSOR_MSG::ConsoleHandle</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00645">_CONSOLE_SETCURSOR_MSG::CursorHandle</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01536">DereferenceIoHandle()</a>, <a class="el" href="../../d7/d5/ntcon_2server_2globals_8h-source.html#l00030">ghNormalCursor</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00644">_CONSOLE_SETCURSOR_MSG::OutputHandle</a>, <a class="el" href="../../d1/d7/ntcftxt_8h-source.html#l00427">PostMessage()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l04103">UnlockConsole()</a>.
<p>
<pre class="fragment"><div>00220            :
00221 
00222     Sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mouse pointer <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified screen buffer.
00223 
00224 Parameters:
00225 
00226     hConsoleOutput - Supplies a console output handle.
00227 
00228     hCursor - win32 cursor handle, should be <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> to set <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">default</span>
00229         cursor.
00230 
00231 Return value:
00232 
00233     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - The operation was successful.
00234 
00235     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>/<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> - The operation failed. Extended error status <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> available
00236         <span class="keyword">using</span> GetLastError.
00237 
00238 --*/
00239 
00240 {
00241     <a class="code" href="../../d2/d5/struct__CONSOLE__SETCURSOR__MSG.html">PCONSOLE_SETCURSOR_MSG</a> a = (<a class="code" href="../../d2/d5/struct__CONSOLE__SETCURSOR__MSG.html">PCONSOLE_SETCURSOR_MSG</a>)&amp;m-&gt;u.ApiMessageData;
00242     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00243     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
00244     <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> HandleData;
00245 
00246     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a33">ApiPreamble</a>(a-&gt;<a class="code" href="../../d2/d5/struct__CONSOLE__SETCURSOR__MSG.html#o0">ConsoleHandle</a>,
00247                          &amp;Console
00248                         );
00249     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00250         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00251     }
00252     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a31">DereferenceIoHandle</a>(<a class="code" href="../../d1/d7/server_8h.html#a84">CONSOLE_PERPROCESSDATA</a>(),
00253                                  a-&gt;<a class="code" href="../../d2/d5/struct__CONSOLE__SETCURSOR__MSG.html#o1">OutputHandle</a>,
00254                                  CONSOLE_GRAPHICS_OUTPUT_HANDLE,
00255                                  GENERIC_WRITE,
00256                                  &amp;HandleData
00257                                 );
00258     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00259         <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d2/d5/struct__CONSOLE__SETCURSOR__MSG.html#o2">CursorHandle</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00260             HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer-&gt;CursorHandle = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a7">ghNormalCursor</a>;
00261         } <span class="keywordflow">else</span> {
00262             HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer-&gt;CursorHandle = a-&gt;<a class="code" href="../../d2/d5/struct__CONSOLE__SETCURSOR__MSG.html#o2">CursorHandle</a>;
00263         }
00264         <a class="code" href="../../d0/d8/ntcftxt_8h.html#a20">PostMessage</a>(HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer-&gt;Console-&gt;hWnd,
00265                      WM_SETCURSOR,
00266                      0,
00267                      -1
00268                     );
00269     }
00270     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
00271     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00272     UNREFERENCED_PARAMETER(ReplyStatus);    <span class="comment">// get rid of unreferenced parameter warning message</span>
00273 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a50" doxytag="server/private.c::SrvSetConsoleDisplayMode" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG SrvSetConsoleDisplayMode           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PCSR_API_MSG&nbsp;</td>
          <td class="mdname" nowrap> <em>m</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PCSR_REPLY_STATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>ReplyStatus</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00853">853</a> of file <a class="el" href="../../d8/d3/server_2private_8c-source.html">server/private.c</a>.
<p>
References <a class="el" href="../../d8/d1/output_8h-source.html#l00258">ACTIVE_SCREEN_BUFFER</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01627">ApiPreamble()</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d4/d3/struct__HANDLE__DATA.html#o5">_HANDLE_DATA::Buffer</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00363">CM_MODE_TRANSITION</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00380">CONSOLE_CLIENTPROCESSHANDLE</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00298">CONSOLE_GRAPHICS_OUTPUT_HANDLE</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00027">CONSOLE_OUTPUT_HANDLE</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00395">CONSOLE_PERPROCESSDATA</a>, <a class="el" href="../../d8/d1/output_8h-source.html#l00148">CONSOLE_TEXTMODE_BUFFER</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00671">_CONSOLE_SETDISPLAYMODE_MSG::ConsoleHandle</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01536">DereferenceIoHandle()</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00673">_CONSOLE_SETDISPLAYMODE_MSG::dwFlags</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d1/output_8h-source.html#l00154">_SCREEN_INFORMATION::Flags</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00188">_CONSOLE_INFORMATION::FullScreenFlags</a>, <a class="el" href="../../d7/d5/ntcon_2server_2globals_8h-source.html#l00039">FullScreenInitialized</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00675">_CONSOLE_SETDISPLAYMODE_MSG::hEvent</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l00163">NtDuplicateObject()</a>, <a class="el" href="../../d1/d7/ex_2event_8c-source.html#l00748">NtSetEvent()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00672">_CONSOLE_SETDISPLAYMODE_MSG::OutputHandle</a>, <a class="el" href="../../d7/d1/output_8c-source.html#l04267">QueueConsoleMessage()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d0/d5/ndismain_8h-source.html#l00026">UINT</a>, and <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l04103">UnlockConsole()</a>.
<p>
<pre class="fragment"><div>00860            :
00861 
00862     This routine sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> console display mode <span class="keywordflow">for</span> an output buffer.
00863     This API <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> supported on x86 machines.  Jazz consoles are always
00864     windowed.
00865 
00866 Parameters:
00867 
00868     hConsoleOutput - Supplies a console output handle.
00869 
00870     <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> display mode. Options are:
00871 
00872         CONSOLE_FULLSCREEN_MODE - data <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> displayed fullscreen
00873 
00874         CONSOLE_WINDOWED_MODE - data <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> displayed in a window
00875 
00876     lpNewScreenBufferDimensions - On output, contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> dimensions of
00877         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> screen buffer.  The dimensions are in rows and columns <span class="keywordflow">for</span>
00878         textmode screen buffers.
00879 
00880 Return value:
00881 
00882     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - The operation was successful.
00883 
00884     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>/<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> - The operation failed. Extended error status <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> available
00885         <span class="keyword">using</span> GetLastError.
00886 
00887 --*/
00888 
00889 {
00890     <a class="code" href="../../d5/d5/struct__CONSOLE__SETDISPLAYMODE__MSG.html">PCONSOLE_SETDISPLAYMODE_MSG</a> a = (<a class="code" href="../../d5/d5/struct__CONSOLE__SETDISPLAYMODE__MSG.html">PCONSOLE_SETDISPLAYMODE_MSG</a>)&amp;m-&gt;u.ApiMessageData;
00891     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00892     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
00893     <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> HandleData;
00894     <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo;
00895     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> State;
00896     HANDLE  hEvent = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00897 
00898     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a33">ApiPreamble</a>(a-&gt;<a class="code" href="../../d5/d5/struct__CONSOLE__SETDISPLAYMODE__MSG.html#o0">ConsoleHandle</a>,
00899                          &amp;Console
00900                         );
00901     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00902         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00903     }
00904 
00905     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d0/obhandle_8c.html#a4">NtDuplicateObject</a>(<a class="code" href="../../d1/d7/server_8h.html#a79">CONSOLE_CLIENTPROCESSHANDLE</a>(),
00906                                a-&gt;<a class="code" href="../../d5/d5/struct__CONSOLE__SETDISPLAYMODE__MSG.html#o4">hEvent</a>,
00907                                NtCurrentProcess(),
00908                                &amp;hEvent,
00909                                0,
00910                                FALSE,
00911                                DUPLICATE_SAME_ACCESS
00912                                );
00913     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00914         <span class="keywordflow">goto</span> SrvSetConsoleDisplayModeFailure;
00915     }
00916     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a31">DereferenceIoHandle</a>(<a class="code" href="../../d1/d7/server_8h.html#a84">CONSOLE_PERPROCESSDATA</a>(),
00917                                  a-&gt;<a class="code" href="../../d5/d5/struct__CONSOLE__SETDISPLAYMODE__MSG.html#o1">OutputHandle</a>,
00918                                  CONSOLE_OUTPUT_HANDLE | CONSOLE_GRAPHICS_OUTPUT_HANDLE,
00919                                  GENERIC_WRITE,
00920                                  &amp;HandleData
00921                                 );
00922     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00923         ScreenInfo = HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer;
00924         <span class="keywordflow">if</span> (!<a class="code" href="../../d7/d2/output_8h.html#a12">ACTIVE_SCREEN_BUFFER</a>(ScreenInfo))  {
00925             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00926             <span class="keywordflow">goto</span> SrvSetConsoleDisplayModeFailure;
00927         }
00928         <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d5/d5/struct__CONSOLE__SETDISPLAYMODE__MSG.html#o2">dwFlags</a> == CONSOLE_FULLSCREEN_MODE) {
00929 <span class="preprocessor">#if !defined(_X86_)</span>
00930 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o1">Flags</a> &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>) {
00931                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00932                 <span class="keywordflow">goto</span> SrvSetConsoleDisplayModeFailure;
00933             }
00934 <span class="preprocessor">#else</span>
00935 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a12">FullScreenInitialized</a>) {
00936                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00937                 <span class="keywordflow">goto</span> SrvSetConsoleDisplayModeFailure;
00938             }
00939 <span class="preprocessor">#endif</span>
00940 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o47">FullScreenFlags</a> &amp; CONSOLE_FULLSCREEN) {
00941                 KdPrint((<span class="stringliteral">"CONSRV: VDM converting to fullscreen twice\n"</span>));
00942                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FALSE);
00943                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00944                 <span class="keywordflow">goto</span> SrvSetConsoleDisplayModeFailure;
00945             }
00946             State = FULLSCREEN;
00947         } <span class="keywordflow">else</span> {
00948             <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o47">FullScreenFlags</a> == 0) {
00949                 KdPrint((<span class="stringliteral">"CONSRV: VDM converting to windowed twice\n"</span>));
00950                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FALSE);
00951                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00952                 <span class="keywordflow">goto</span> SrvSetConsoleDisplayModeFailure;
00953             }
00954             State = WINDOWED;
00955         }
00956         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d2/output_8c.html#a76">QueueConsoleMessage</a>(Console,
00957                     CM_MODE_TRANSITION,
00958                     State,
00959                     (LPARAM)hEvent
00960                     );
00961         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00962             <span class="keywordflow">goto</span> SrvSetConsoleDisplayModeFailure;
00963         }
00964     }
00965     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
00966     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00967 
00968 SrvSetConsoleDisplayModeFailure:
00969     <span class="keywordflow">if</span> (hEvent) {
00970         <a class="code" href="../../d0/d8/ex_2event_8c.html#a10">NtSetEvent</a>(hEvent, NULL);
00971         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hEvent);
00972     }
00973     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
00974     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00975 
00976     UNREFERENCED_PARAMETER(ReplyStatus);    <span class="comment">// get rid of unreferenced parameter warning message</span>
00977 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a57" doxytag="server/private.c::SrvSetConsoleHardwareState" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG SrvSetConsoleHardwareState           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PCSR_API_MSG&nbsp;</td>
          <td class="mdname" nowrap> <em>m</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PCSR_REPLY_STATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>ReplyStatus</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/server_2private_8c-source.html#l02280">2280</a> of file <a class="el" href="../../d8/d3/server_2private_8c-source.html">server/private.c</a>.
<p>
References <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01627">ApiPreamble()</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d4/d3/struct__HANDLE__DATA.html#o5">_HANDLE_DATA::Buffer</a>, <a class="el" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">_SCREEN_INFORMATION::BufferInfo</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00027">CONSOLE_OUTPUT_HANDLE</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00395">CONSOLE_PERPROCESSDATA</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00701">_CONSOLE_SETHARDWARESTATE_MSG::ConsoleHandle</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01536">DereferenceIoHandle()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00115">_MODE_FONT_PAIR::FontSize</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00704">_CONSOLE_SETHARDWARESTATE_MSG::FontSize</a>, <a class="el" href="../../d1/d2/dbcs_8h-source.html#l00054">FS_GRAPHICS</a>, <a class="el" href="../../d1/d2/dbcs_8h-source.html#l00053">FS_TEXT</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00188">_CONSOLE_INFORMATION::FullScreenFlags</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d0/d3/dbcs_8h.html#a51">IsAvailableFsCodePage()</a>, <a class="el" href="../../d1/d2/dbcs_8h-source.html#l00049">_MODE_FONT_PAIR::Mode</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00120">ModeFontPairs</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00118">NUMBER_OF_MODE_FONT_PAIRS</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00211">_CONSOLE_INFORMATION::OutputCP</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00702">_CONSOLE_SETHARDWARESTATE_MSG::OutputHandle</a>, <a class="el" href="../../d1/d2/dbcs_8h-source.html#l00069">RegModeFontPairs</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00114">_MODE_FONT_PAIR::Resolution</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00703">_CONSOLE_SETHARDWARESTATE_MSG::Resolution</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l04103">UnlockConsole()</a>.
<p>
<pre class="fragment"><div>02284 {
02285 <span class="preprocessor">#ifdef i386</span>
02286 <span class="preprocessor"></span>    <a class="code" href="../../d8/d5/struct__CONSOLE__SETHARDWARESTATE__MSG.html">PCONSOLE_SETHARDWARESTATE_MSG</a> a = (<a class="code" href="../../d8/d5/struct__CONSOLE__SETHARDWARESTATE__MSG.html">PCONSOLE_SETHARDWARESTATE_MSG</a>)&amp;m-&gt;u.ApiMessageData;
02287     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02288     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
02289     <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> HandleData;
02290     <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo;
02291     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
02292 
02293     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a33">ApiPreamble</a>(a-&gt;<a class="code" href="../../d8/d5/struct__CONSOLE__SETHARDWARESTATE__MSG.html#o0">ConsoleHandle</a>,
02294                          &amp;Console
02295                         );
02296     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02297         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02298     }
02299     <span class="keywordflow">if</span> (!(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o47">FullScreenFlags</a> &amp; CONSOLE_FULLSCREEN_HARDWARE)) {
02300         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
02301         <span class="keywordflow">return</span> (ULONG)STATUS_UNSUCCESSFUL;
02302     }
02303     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a31">DereferenceIoHandle</a>(<a class="code" href="../../d1/d7/server_8h.html#a84">CONSOLE_PERPROCESSDATA</a>(),
02304                                  a-&gt;<a class="code" href="../../d8/d5/struct__CONSOLE__SETHARDWARESTATE__MSG.html#o1">OutputHandle</a>,
02305                                  CONSOLE_OUTPUT_HANDLE,
02306                                  GENERIC_READ,
02307                                  &amp;HandleData
02308                                 );
02309     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02310 <span class="preprocessor">#if defined(FE_SB)</span>
02311 <span class="preprocessor"></span>        <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fGraphics = fFullScreenGraphics ? <a class="code" href="../../d0/d3/dbcs_8h.html#a51">IsAvailableFsCodePage</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o62">OutputCP</a>) : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02312 <span class="preprocessor">#endif</span>
02313 <span class="preprocessor"></span>        ScreenInfo = HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer;
02314 
02315         <span class="comment">// match requested mode</span>
02316 
02317         <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>=0;<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>&lt;<a class="code" href="../../d7/d4/server_2private_8c.html#a17">NUMBER_OF_MODE_FONT_PAIRS</a>;<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>++) {
02318 <span class="preprocessor">#if defined(FE_SB)</span>
02319 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d8/d5/struct__CONSOLE__SETHARDWARESTATE__MSG.html#o2">Resolution</a>.X == <a class="code" href="../../d0/d3/dbcs_8h.html#a24">RegModeFontPairs</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o2">Resolution</a>.X &amp;&amp;
02320                 a-&gt;<a class="code" href="../../d8/d5/struct__CONSOLE__SETHARDWARESTATE__MSG.html#o2">Resolution</a>.Y == <a class="code" href="../../d0/d3/dbcs_8h.html#a24">RegModeFontPairs</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o2">Resolution</a>.Y &amp;&amp;
02321                 a-&gt;<a class="code" href="../../d8/d5/struct__CONSOLE__SETHARDWARESTATE__MSG.html#o3">FontSize</a>.Y == <a class="code" href="../../d0/d3/dbcs_8h.html#a24">RegModeFontPairs</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o3">FontSize</a>.Y &amp;&amp;
02322                 a-&gt;<a class="code" href="../../d8/d5/struct__CONSOLE__SETHARDWARESTATE__MSG.html#o3">FontSize</a>.X == <a class="code" href="../../d0/d3/dbcs_8h.html#a24">RegModeFontPairs</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o3">FontSize</a>.X &amp;&amp;
02323                 ( ( fGraphics &amp;&amp; (<a class="code" href="../../d0/d3/dbcs_8h.html#a24">RegModeFontPairs</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o0">Mode</a> &amp; <a class="code" href="../../d0/d3/dbcs_8h.html#a12">FS_GRAPHICS</a>)==<a class="code" href="../../d0/d3/dbcs_8h.html#a12">FS_GRAPHICS</a>) ||
02324                   (!fGraphics &amp;&amp; (<a class="code" href="../../d0/d3/dbcs_8h.html#a24">RegModeFontPairs</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o0">Mode</a> &amp; <a class="code" href="../../d0/d3/dbcs_8h.html#a11">FS_TEXT</a>)==<a class="code" href="../../d0/d3/dbcs_8h.html#a11">FS_TEXT</a>)           )
02325                ) {
02326                 <span class="keywordflow">break</span>;
02327             }
02328 <span class="preprocessor">#else</span>
02329 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d8/d5/struct__CONSOLE__SETHARDWARESTATE__MSG.html#o2">Resolution</a>.X == <a class="code" href="../../d7/d4/server_2private_8c.html#a28">ModeFontPairs</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o2">Resolution</a>.X &amp;&amp;
02330                 a-&gt;<a class="code" href="../../d8/d5/struct__CONSOLE__SETHARDWARESTATE__MSG.html#o2">Resolution</a>.Y == <a class="code" href="../../d7/d4/server_2private_8c.html#a28">ModeFontPairs</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o2">Resolution</a>.Y &amp;&amp;
02331                 a-&gt;<a class="code" href="../../d8/d5/struct__CONSOLE__SETHARDWARESTATE__MSG.html#o3">FontSize</a>.Y == <a class="code" href="../../d7/d4/server_2private_8c.html#a28">ModeFontPairs</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o3">FontSize</a>.Y &amp;&amp;
02332                 a-&gt;<a class="code" href="../../d8/d5/struct__CONSOLE__SETHARDWARESTATE__MSG.html#o3">FontSize</a>.X == <a class="code" href="../../d7/d4/server_2private_8c.html#a28">ModeFontPairs</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o3">FontSize</a>.X) {
02333                 <span class="keywordflow">break</span>;
02334             }
02335 <span class="preprocessor">#endif</span>
02336 <span class="preprocessor"></span>        }
02337         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> == <a class="code" href="../../d7/d4/server_2private_8c.html#a17">NUMBER_OF_MODE_FONT_PAIRS</a>) {
02338             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
02339         } <span class="keywordflow">else</span> {
02340             <span class="comment">// set requested mode</span>
02341             ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.ModeIndex = <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
02342             SetVideoMode(ScreenInfo);
02343         }
02344     }
02345     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
02346     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02347 <span class="preprocessor">#else</span>
02348 <span class="preprocessor"></span>    <span class="keywordflow">return</span> (ULONG)STATUS_UNSUCCESSFUL;
02349     UNREFERENCED_PARAMETER(m);    <span class="comment">// get rid of unreferenced parameter warning message</span>
02350 <span class="preprocessor">#endif</span>
02351 <span class="preprocessor"></span>    UNREFERENCED_PARAMETER(ReplyStatus);    <span class="comment">// get rid of unreferenced parameter warning message</span>
02352 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a61" doxytag="server/private.c::SrvSetConsoleKeyShortcuts" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG SrvSetConsoleKeyShortcuts           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PCSR_API_MSG&nbsp;</td>
          <td class="mdname" nowrap> <em>m</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PCSR_REPLY_STATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>ReplyStatus</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/server_2private_8c-source.html#l02423">2423</a> of file <a class="el" href="../../d8/d3/server_2private_8c-source.html">server/private.c</a>.
<p>
References <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01627">ApiPreamble()</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00741">_CONSOLE_SETKEYSHORTCUTS_MSG::AppKeys</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00087">CONSOLE_HAS_FOCUS</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00446">CONSOLE_MAX_APP_SHORTCUTS</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00737">_CONSOLE_SETKEYSHORTCUTS_MSG::ConsoleHandle</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l02403">ConvertHotKey()</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00164">_CONSOLE_INFORMATION::Flags</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00137">_CONSOLE_INFORMATION::hWnd</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00740">_CONSOLE_SETKEYSHORTCUTS_MSG::NumAppKeys</a>, <a class="el" href="../../d1/d7/ntcftxt_8h-source.html#l00427">PostMessage()</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00739">_CONSOLE_SETKEYSHORTCUTS_MSG::ReserveKeys</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00163">_CONSOLE_INFORMATION::ReserveKeys</a>, <a class="el" href="../../d8/d5/consrv_8h.html#a313">SetConsoleReserveKeys()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l04103">UnlockConsole()</a>.
<p>
<pre class="fragment"><div>02427 {
02428     <a class="code" href="../../d0/d6/struct__CONSOLE__SETKEYSHORTCUTS__MSG.html">PCONSOLE_SETKEYSHORTCUTS_MSG</a> a = (<a class="code" href="../../d0/d6/struct__CONSOLE__SETKEYSHORTCUTS__MSG.html">PCONSOLE_SETKEYSHORTCUTS_MSG</a>)&amp;m-&gt;u.ApiMessageData;
02429     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02430     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
02431 
02432     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a33">ApiPreamble</a>(a-&gt;<a class="code" href="../../d0/d6/struct__CONSOLE__SETKEYSHORTCUTS__MSG.html#o0">ConsoleHandle</a>,
02433                          &amp;Console
02434                         );
02435     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02436         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02437     }
02438 
02439     <span class="keywordflow">if</span> (!CsrValidateMessageBuffer(m, &amp;a-&gt;<a class="code" href="../../d0/d6/struct__CONSOLE__SETKEYSHORTCUTS__MSG.html#o4">AppKeys</a>, a-&gt;<a class="code" href="../../d0/d6/struct__CONSOLE__SETKEYSHORTCUTS__MSG.html#o3">NumAppKeys</a>, <span class="keyword">sizeof</span>(*a-&gt;<a class="code" href="../../d0/d6/struct__CONSOLE__SETKEYSHORTCUTS__MSG.html#o4">AppKeys</a>))) {
02440         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
02441         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
02442     }
02443 
02444     <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d0/d6/struct__CONSOLE__SETKEYSHORTCUTS__MSG.html#o3">NumAppKeys</a> &lt;= <a class="code" href="../../d1/d7/server_8h.html#a94">CONSOLE_MAX_APP_SHORTCUTS</a>) {
02445         Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o34">ReserveKeys</a> = a-&gt;<a class="code" href="../../d0/d6/struct__CONSOLE__SETKEYSHORTCUTS__MSG.html#o2">ReserveKeys</a>;
02446         <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a2">CONSOLE_HAS_FOCUS</a>) {
02447             <span class="keywordflow">if</span> (!(<a class="code" href="../../d8/d5/consrv_8h.html#a313">SetConsoleReserveKeys</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o8">hWnd</a>,a-&gt;<a class="code" href="../../d0/d6/struct__CONSOLE__SETKEYSHORTCUTS__MSG.html#o2">ReserveKeys</a>))) {
02448                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
02449             }
02450         }
02451         <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d0/d6/struct__CONSOLE__SETKEYSHORTCUTS__MSG.html#o3">NumAppKeys</a>) {
02452             <a class="code" href="../../d0/d8/ntcftxt_8h.html#a20">PostMessage</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o8">hWnd</a>,
02453                          WM_SETHOTKEY,
02454                          <a class="code" href="../../d7/d4/server_2private_8c.html#a60">ConvertHotKey</a>(a-&gt;<a class="code" href="../../d0/d6/struct__CONSOLE__SETKEYSHORTCUTS__MSG.html#o4">AppKeys</a>),
02455                          0
02456                         );
02457         }
02458     } <span class="keywordflow">else</span> {
02459         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
02460     }
02461     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
02462     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02463     UNREFERENCED_PARAMETER(ReplyStatus);    <span class="comment">// get rid of unreferenced parameter warning message</span>
02464 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a59" doxytag="server/private.c::SrvSetConsoleMenuClose" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG SrvSetConsoleMenuClose           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PCSR_API_MSG&nbsp;</td>
          <td class="mdname" nowrap> <em>m</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PCSR_REPLY_STATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>ReplyStatus</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/server_2private_8c-source.html#l02376">2376</a> of file <a class="el" href="../../d8/d3/server_2private_8c-source.html">server/private.c</a>.
<p>
References <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01627">ApiPreamble()</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00091">CONSOLE_DISABLE_CLOSE</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00745">_CONSOLE_SETMENUCLOSE_MSG::ConsoleHandle</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00746">_CONSOLE_SETMENUCLOSE_MSG::Enable</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00164">_CONSOLE_INFORMATION::Flags</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l04103">UnlockConsole()</a>.
<p>
<pre class="fragment"><div>02380 {
02381     <a class="code" href="../../d1/d6/struct__CONSOLE__SETMENUCLOSE__MSG.html">PCONSOLE_SETMENUCLOSE_MSG</a> a = (<a class="code" href="../../d1/d6/struct__CONSOLE__SETMENUCLOSE__MSG.html">PCONSOLE_SETMENUCLOSE_MSG</a>)&amp;m-&gt;u.ApiMessageData;
02382     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02383     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
02384 
02385     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a33">ApiPreamble</a>(a-&gt;<a class="code" href="../../d1/d6/struct__CONSOLE__SETMENUCLOSE__MSG.html#o0">ConsoleHandle</a>,
02386                          &amp;Console
02387                         );
02388     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02389         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02390     }
02391     <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d1/d6/struct__CONSOLE__SETMENUCLOSE__MSG.html#o1">Enable</a>) {
02392         Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp;= ~<a class="code" href="../../d1/d7/server_8h.html#a6">CONSOLE_DISABLE_CLOSE</a>;
02393     } <span class="keywordflow">else</span> {
02394         Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> |= <a class="code" href="../../d1/d7/server_8h.html#a6">CONSOLE_DISABLE_CLOSE</a>;
02395     }
02396     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
02397     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02398     UNREFERENCED_PARAMETER(ReplyStatus);    <span class="comment">// get rid of unreferenced parameter warning message</span>
02399 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a45" doxytag="server/private.c::SrvSetConsolePalette" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG SrvSetConsolePalette           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PCSR_API_MSG&nbsp;</td>
          <td class="mdname" nowrap> <em>m</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PCSR_REPLY_STATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>ReplyStatus</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00432">432</a> of file <a class="el" href="../../d8/d3/server_2private_8c-source.html">server/private.c</a>.
<p>
References <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01627">ApiPreamble()</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d4/d3/struct__HANDLE__DATA.html#o5">_HANDLE_DATA::Buffer</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00298">CONSOLE_GRAPHICS_OUTPUT_HANDLE</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00085">CONSOLE_IS_ICONIC</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00395">CONSOLE_PERPROCESSDATA</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00664">_CONSOLE_SETPALETTE_MSG::ConsoleHandle</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01536">DereferenceIoHandle()</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00667">_CONSOLE_SETPALETTE_MSG::dwUsage</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00666">_CONSOLE_SETPALETTE_MSG::hPalette</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00235">_CONSOLE_INFORMATION::InputThreadInfo</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l00870">NtUserConsoleControl()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l07575">NtUserSetInformationThread()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00665">_CONSOLE_SETPALETTE_MSG::OutputHandle</a>, <a class="el" href="../../d4/d9/user32_8def-source.html#l00720">RealizePalette</a>, <a class="el" href="../../d4/d9/user32_8def-source.html#l00718">SelectPalette</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00056">_INPUT_THREAD_INFO::ThreadId</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l04103">UnlockConsole()</a>.
<p>
<pre class="fragment"><div>00439            :
00440 
00441     Sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> palette <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> console screen buffer.
00442 
00443 Parameters:
00444 
00445     hOutput - Supplies a console output handle.
00446 
00447     hPalette - Supplies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> palette to set.
00448 
00449     dwUsage - Specifies use of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system palette.
00450 
00451         SYSPAL_NOSTATIC - System palette contains no <span class="keyword">static</span> colors
00452                           except black and white.
00453 
00454         SYSPAL_STATIC -   System palette contains <span class="keyword">static</span> colors
00455                           which will not change when an application
00456                           realizes its logical palette.
00457 
00458 Return value:
00459 
00460     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - The operation was successful.
00461 
00462     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>/<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> - The operation failed. Extended error status <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> available
00463         <span class="keyword">using</span> GetLastError.
00464 
00465 --*/
00466 
00467 {
00468     <a class="code" href="../../d3/d6/struct__CONSOLE__SETPALETTE__MSG.html">PCONSOLE_SETPALETTE_MSG</a> a = (<a class="code" href="../../d3/d6/struct__CONSOLE__SETPALETTE__MSG.html">PCONSOLE_SETPALETTE_MSG</a>)&amp;m-&gt;u.ApiMessageData;
00469     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00470     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
00471     <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> HandleData;
00472     HPALETTE hOldPalette;
00473 
00474     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a33">ApiPreamble</a>(a-&gt;<a class="code" href="../../d3/d6/struct__CONSOLE__SETPALETTE__MSG.html#o0">ConsoleHandle</a>,
00475                          &amp;Console
00476                         );
00477     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00478         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00479     }
00480     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a31">DereferenceIoHandle</a>(<a class="code" href="../../d1/d7/server_8h.html#a84">CONSOLE_PERPROCESSDATA</a>(),
00481                                  a-&gt;<a class="code" href="../../d3/d6/struct__CONSOLE__SETPALETTE__MSG.html#o1">OutputHandle</a>,
00482                                  CONSOLE_GRAPHICS_OUTPUT_HANDLE,
00483                                  GENERIC_WRITE,
00484                                  &amp;HandleData
00485                                 );
00486     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00487         USERTHREAD_USEDESKTOPINFO utudi;
00488         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bReset = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00489 
00490         <span class="comment">/*</span>
00491 <span class="comment">         * Palette handle was converted in the client.</span>
00492 <span class="comment">         */</span>
00493         <span class="keywordflow">if</span> (GetCurrentThreadId() != HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer-&gt;
00494                 Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o75">InputThreadInfo</a>-&gt;<a class="code" href="../../d9/d2/struct__INPUT__THREAD__INFO.html#o1">ThreadId</a>) {
00495             bReset = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00496             utudi.hThread = HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer-&gt;Console-&gt;InputThreadInfo-&gt;ThreadHandle;
00497             utudi.drdRestore.pdeskRestore = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00498             <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a277">NtUserSetInformationThread</a>(NtCurrentThread(),
00499                     UserThreadUseDesktop,
00500                     &amp;utudi, <span class="keyword">sizeof</span>(utudi));
00501         }
00502 
00503         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a86">NtUserConsoleControl</a>(ConsolePublicPalette, &amp;(a-&gt;<a class="code" href="../../d3/d6/struct__CONSOLE__SETPALETTE__MSG.html#o2">hPalette</a>), <span class="keyword">sizeof</span>(HPALETTE));
00504 
00505         hOldPalette = <a class="code" href="../../d3/d0/user32_8def.html#a83">SelectPalette</a>(
00506                 HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer-&gt;Console-&gt;hDC,
00507                 a-&gt;<a class="code" href="../../d3/d6/struct__CONSOLE__SETPALETTE__MSG.html#o2">hPalette</a>,
00508                 FALSE);
00509 
00510         <span class="keywordflow">if</span> (hOldPalette == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00511             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00512         } <span class="keywordflow">else</span> {
00513             <span class="keywordflow">if</span> ((HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer-&gt;hPalette != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00514                     (a-&gt;<a class="code" href="../../d3/d6/struct__CONSOLE__SETPALETTE__MSG.html#o2">hPalette</a> != HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer-&gt;hPalette)) {
00515                 DeleteObject(HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer-&gt;hPalette);
00516             }
00517             HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer-&gt;hPalette = a-&gt;<a class="code" href="../../d3/d6/struct__CONSOLE__SETPALETTE__MSG.html#o2">hPalette</a>;
00518             HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer-&gt;dwUsage = a-&gt;<a class="code" href="../../d3/d6/struct__CONSOLE__SETPALETTE__MSG.html#o3">dwUsage</a>;
00519             <span class="keywordflow">if</span> (!(HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer-&gt;Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a0">CONSOLE_IS_ICONIC</a>) &amp;&amp;
00520                     HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer-&gt;Console-&gt;FullScreenFlags == 0) {
00521 
00522                 SetSystemPaletteUse(HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer-&gt;Console-&gt;hDC,
00523                         HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer-&gt;dwUsage);
00524                 <a class="code" href="../../d3/d0/user32_8def.html#a84">RealizePalette</a>(HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer-&gt;Console-&gt;hDC);
00525             }
00526             <span class="keywordflow">if</span> (HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer-&gt;Console-&gt;hSysPalette == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00527                     HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer-&gt;Console-&gt;hSysPalette = hOldPalette;
00528             }
00529         }
00530 
00531         <span class="keywordflow">if</span> (bReset) {
00532             utudi.hThread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00533             <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a277">NtUserSetInformationThread</a>(NtCurrentThread(),
00534                     UserThreadUseDesktop, &amp;utudi, <span class="keyword">sizeof</span>(utudi));
00535         }
00536     }
00537     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
00538     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00539     UNREFERENCED_PARAMETER(ReplyStatus);    <span class="comment">// get rid of unreferenced parameter warning message</span>
00540 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a43" doxytag="server/private.c::SrvShowConsoleCursor" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG SrvShowConsoleCursor           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PCSR_API_MSG&nbsp;</td>
          <td class="mdname" nowrap> <em>m</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PCSR_REPLY_STATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>ReplyStatus</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00298">298</a> of file <a class="el" href="../../d8/d3/server_2private_8c-source.html">server/private.c</a>.
<p>
References <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01627">ApiPreamble()</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00651">_CONSOLE_SHOWCURSOR_MSG::bShow</a>, <a class="el" href="../../d4/d3/struct__HANDLE__DATA.html#o5">_HANDLE_DATA::Buffer</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00298">CONSOLE_GRAPHICS_OUTPUT_HANDLE</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00027">CONSOLE_OUTPUT_HANDLE</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00395">CONSOLE_PERPROCESSDATA</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00649">_CONSOLE_SHOWCURSOR_MSG::ConsoleHandle</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00133">_CONSOLE_INFORMATION::CurrentScreenBuffer</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01536">DereferenceIoHandle()</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00652">_CONSOLE_SHOWCURSOR_MSG::DisplayCount</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00188">_CONSOLE_INFORMATION::FullScreenFlags</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00311">_HANDLE_DATA::HandleType</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d6/d4/conmsg_8h-source.html#l00650">_CONSOLE_SHOWCURSOR_MSG::OutputHandle</a>, <a class="el" href="../../d1/d7/ntcftxt_8h-source.html#l00427">PostMessage()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l04103">UnlockConsole()</a>.
<p>
<pre class="fragment"><div>00305            :
00306 
00307     Sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mouse pointer visibility counter.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> counter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> less than
00308     zero, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mouse pointer <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not shown.
00309 
00310 Parameters:
00311 
00312     hOutput - Supplies a console output handle.
00313 
00314     bShow - <span class="keywordflow">if</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> display count <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be increased. <span class="keywordflow">if</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00315         decreased.
00316 
00317 Return value:
00318 
00319     The <span class="keywordflow">return</span> value specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> display count.
00320 
00321 --*/
00322 
00323 {
00324     <a class="code" href="../../d9/d6/struct__CONSOLE__SHOWCURSOR__MSG.html">PCONSOLE_SHOWCURSOR_MSG</a> a = (<a class="code" href="../../d9/d6/struct__CONSOLE__SHOWCURSOR__MSG.html">PCONSOLE_SHOWCURSOR_MSG</a>)&amp;m-&gt;u.ApiMessageData;
00325     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00326     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
00327     <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> HandleData;
00328 
00329     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a33">ApiPreamble</a>(a-&gt;<a class="code" href="../../d9/d6/struct__CONSOLE__SHOWCURSOR__MSG.html#o0">ConsoleHandle</a>,
00330                          &amp;Console
00331                         );
00332     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00333         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00334     }
00335     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a31">DereferenceIoHandle</a>(<a class="code" href="../../d1/d7/server_8h.html#a84">CONSOLE_PERPROCESSDATA</a>(),
00336                                  a-&gt;<a class="code" href="../../d9/d6/struct__CONSOLE__SHOWCURSOR__MSG.html#o1">OutputHandle</a>,
00337                                  CONSOLE_OUTPUT_HANDLE | CONSOLE_GRAPHICS_OUTPUT_HANDLE,
00338                                  GENERIC_WRITE,
00339                                  &amp;HandleData
00340                                 );
00341     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00342         <span class="keywordflow">if</span> (!(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o47">FullScreenFlags</a> &amp; CONSOLE_FULLSCREEN_HARDWARE) ) {
00343             <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d9/d6/struct__CONSOLE__SHOWCURSOR__MSG.html#o2">bShow</a>) {
00344                 HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer-&gt;CursorDisplayCount += 1;
00345             } <span class="keywordflow">else</span> {
00346                 HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer-&gt;CursorDisplayCount -= 1;
00347             }
00348             <span class="keywordflow">if</span> (HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer == Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o4">CurrentScreenBuffer</a>) {
00349                 <a class="code" href="../../d0/d8/ntcftxt_8h.html#a20">PostMessage</a>(HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer-&gt;Console-&gt;hWnd,
00350                              WM_SETCURSOR,
00351                              0,
00352                              -1
00353                             );
00354             }
00355         } <span class="keywordflow">else</span> {
00356 <span class="preprocessor">#ifdef i386</span>
00357 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o0">HandleType</a> != <a class="code" href="../../d1/d7/server_8h.html#a48">CONSOLE_GRAPHICS_OUTPUT_HANDLE</a> &amp;&amp;
00358                 Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o47">FullScreenFlags</a> &amp; CONSOLE_FULLSCREEN_HARDWARE &amp;&amp;
00359                 HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer == Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o4">CurrentScreenBuffer</a>) {
00360                 FullScreenCursor(HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer,a-&gt;<a class="code" href="../../d9/d6/struct__CONSOLE__SHOWCURSOR__MSG.html#o2">bShow</a>);
00361             }
00362 <span class="preprocessor">#endif</span>
00363 <span class="preprocessor"></span>        }
00364         a-&gt;<a class="code" href="../../d9/d6/struct__CONSOLE__SHOWCURSOR__MSG.html#o3">DisplayCount</a> = HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer-&gt;CursorDisplayCount;
00365     }
00366     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
00367     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00368     UNREFERENCED_PARAMETER(ReplyStatus);    <span class="comment">// get rid of unreferenced parameter warning message</span>
00369 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a51" doxytag="server/private.c::UnregisterVDM" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UnregisterVDM           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Console</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00980">980</a> of file <a class="el" href="../../d8/d3/server_2private_8c-source.html">server/private.c</a>.
<p>
References <a class="el" href="../../d7/d7/dispatch_8h-source.html#l00115">AdjustCursorPosition</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l01519">ConnectToEmulator()</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00098">CONSOLE_CONNECTED_TO_EMULATOR</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00087">CONSOLE_HAS_FOCUS</a>, <a class="el" href="../../d8/d1/output_8h-source.html#l00148">CONSOLE_TEXTMODE_BUFFER</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00094">CONSOLE_VDM_REGISTERED</a>, <a class="el" href="../../d2/d6/server_8h-source.html#l00103">CONSOLE_WOW_REGISTERED</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d2/dbcs_8h-source.html#l00051">FS_MODE_GRAPHICS</a>, <a class="el" href="../../d7/d5/ntcon_2server_2globals_8h-source.html#l00039">FullScreenInitialized</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d0/d3/dbcs_8h.html#a51">IsAvailableFsCodePage()</a>, <a class="el" href="../../d1/d2/dbcs_8h-source.html#l00028">JAPAN_CP</a>, <a class="el" href="../../d1/d2/dbcs_8h-source.html#l00027">KOREAN_CP</a>, <a class="el" href="../../d1/d2/dbcs_8h-source.html#l00049">_MODE_FONT_PAIR::Mode</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d5/d8/umapview_8c-source.html#l00033">NtUnmapViewOfSection()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l00870">NtUserConsoleControl()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l07575">NtUserSetInformationThread()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d2/dbcs_8h-source.html#l00069">RegModeFontPairs</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00114">_MODE_FONT_PAIR::Resolution</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02843">TIF_DOSEMULATOR</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02842">TIF_VDMAPP</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d3/server_2private_8c-source.html#l01567">DisplayModeTransition()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01355">RemoveConsole()</a>, and <a class="el" href="../../d8/d3/server_2private_8c-source.html#l01094">SrvRegisterConsoleVDM()</a>.
<p>
<pre class="fragment"><div>00983 {
00984 <span class="comment">// williamh, Feb 2 1994.</span>
00985 <span class="comment">// catch multiple calls to unregister vdm. Believe it or not, this could</span>
00986 <span class="comment">// happen</span>
00987     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Console-&gt;Flags &amp; CONSOLE_VDM_REGISTERED);
00988     <span class="keywordflow">if</span> (!(Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a9">CONSOLE_VDM_REGISTERED</a>))
00989         <span class="keywordflow">return</span>;
00990 
00991 <span class="preprocessor">#if defined(FE_SB) &amp;&amp; defined(i386)</span>
00992 <span class="preprocessor"></span><span class="comment">// When HDOS apps exit, console screen resolution is changed to 640*400. Because HBIOS set</span>
00993 <span class="comment">// Screen resolution to 640*400. So, we should replace current screen resoultion(640*480).</span>
00994 <span class="comment">// 09/11/96 bklee</span>
00995     {
00996 
00997     <span class="keywordflow">if</span> ((Console-&gt;FullScreenFlags &amp; CONSOLE_FULLSCREEN_HARDWARE)  &amp;&amp;
00998         ( Console-&gt;OutputCP == <a class="code" href="../../d0/d3/dbcs_8h.html#a6">KOREAN_CP</a> ||
00999          (Console-&gt;OutputCP == <a class="code" href="../../d0/d3/dbcs_8h.html#a7">JAPAN_CP</a> &amp;&amp; ISNECPC98(gdwMachineId) ) )) {
01000 
01001          ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01002          DEVMODEW Devmode;
01003          <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fGraphics = fFullScreenGraphics ? <a class="code" href="../../d0/d3/dbcs_8h.html#a51">IsAvailableFsCodePage</a>(Console-&gt;OutputCP) : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01004 
01005          <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = Console-&gt;CurrentScreenBuffer-&gt;BufferInfo.TextInfo.ModeIndex;
01006 
01007          ZeroMemory(&amp;Devmode, <span class="keyword">sizeof</span>(Devmode));
01008 
01009          Devmode.dmSize = <span class="keyword">sizeof</span>(Devmode);
01010          Devmode.dmDriverExtra = 0;
01011          Devmode.dmFields = DM_BITSPERPEL   |
01012                             DM_PELSWIDTH    |
01013                             DM_PELSHEIGHT   |
01014                             DM_DISPLAYFLAGS;
01015 
01016          Devmode.dmBitsPerPel   = 4;
01017 
01018          Devmode.dmPelsWidth  = <a class="code" href="../../d0/d3/dbcs_8h.html#a24">RegModeFontPairs</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o2">Resolution</a>.X;
01019          Devmode.dmPelsHeight = <a class="code" href="../../d0/d3/dbcs_8h.html#a24">RegModeFontPairs</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o2">Resolution</a>.Y;
01020          Devmode.dmDisplayFlags = (fGraphics &amp;&amp; (<a class="code" href="../../d0/d3/dbcs_8h.html#a24">RegModeFontPairs</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d9/d8/struct__MODE__FONT__PAIR.html#o0">Mode</a> &amp; <a class="code" href="../../d0/d3/dbcs_8h.html#a9">FS_MODE_GRAPHICS</a>)) ? 0 : DMDISPLAYFLAGS_TEXTMODE;
01021 
01022          GdiFullscreenControl(FullscreenControlSetMode,
01023                               &amp;Devmode,
01024                               <span class="keyword">sizeof</span>(Devmode),
01025                               NULL,
01026                               NULL);
01027     }
01028     }
01029 <span class="preprocessor">#endif</span>
01030 <span class="preprocessor"></span><span class="preprocessor">#ifdef i386</span>
01031 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (Console-&gt;FullScreenFlags &amp; CONSOLE_FULLSCREEN_HARDWARE &amp;&amp;
01032         Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a13">CONSOLE_CONNECTED_TO_EMULATOR</a>) {
01033     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a86">NtUserConsoleControl</a>(ConsoleSetVDMCursorBounds, NULL, 0);
01034         <span class="comment">// connect emulator</span>
01035         <a class="code" href="../../d7/d4/server_2private_8c.html#a41">ConnectToEmulator</a>(FALSE, Console);
01036     }
01037 
01038     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a12">FullScreenInitialized</a>) {
01039         CloseHandle(Console-&gt;VDMStartHardwareEvent);
01040         CloseHandle(Console-&gt;VDMEndHardwareEvent);
01041         <a class="code" href="../../d4/d9/umapview_8c.html#a0">NtUnmapViewOfSection</a>(NtCurrentProcess(),Console-&gt;StateBuffer);
01042         <a class="code" href="../../d4/d9/umapview_8c.html#a0">NtUnmapViewOfSection</a>(Console-&gt;VDMProcessHandle,Console-&gt;StateBufferClient);
01043         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(Console-&gt;StateSectionHandle);
01044         Console-&gt;StateLength = 0;
01045     }
01046 
01047 <span class="preprocessor">#endif</span>
01048 <span class="preprocessor"></span>
01049     Console-&gt;Flags &amp;= ~<a class="code" href="../../d1/d7/server_8h.html#a9">CONSOLE_VDM_REGISTERED</a>;
01050 
01051     <span class="keywordflow">if</span> (Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a2">CONSOLE_HAS_FOCUS</a>) {
01052         USERTHREAD_FLAGS Flags;
01053 
01054         Flags.dwFlags = 0;
01055         Flags.dwMask = (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a810">TIF_VDMAPP</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a811">TIF_DOSEMULATOR</a>);
01056         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a277">NtUserSetInformationThread</a>(Console-&gt;InputThreadInfo-&gt;ThreadHandle,
01057                 UserThreadFlags, &amp;Flags, <span class="keyword">sizeof</span>(Flags));
01058     }
01059     Console-&gt;Flags &amp;= ~<a class="code" href="../../d1/d7/server_8h.html#a18">CONSOLE_WOW_REGISTERED</a>;
01060     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Console-&gt;VDMBuffer != NULL);
01061     <span class="keywordflow">if</span> (Console-&gt;VDMBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01062         <a class="code" href="../../d4/d9/umapview_8c.html#a0">NtUnmapViewOfSection</a>(Console-&gt;VDMProcessHandle,Console-&gt;VDMBufferClient);
01063         <a class="code" href="../../d4/d9/umapview_8c.html#a0">NtUnmapViewOfSection</a>(NtCurrentProcess(),Console-&gt;VDMBuffer);
01064         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(Console-&gt;VDMBufferSectionHandle);
01065         Console-&gt;VDMBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01066     }
01067 <span class="preprocessor">#ifdef i386</span>
01068 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (Console-&gt;CurrentScreenBuffer &amp;&amp;
01069         Console-&gt;CurrentScreenBuffer-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>) {
01070         Console-&gt;CurrentScreenBuffer-&gt;BufferInfo.TextInfo.MousePosition.X = 0;
01071         Console-&gt;CurrentScreenBuffer-&gt;BufferInfo.TextInfo.MousePosition.Y = 0;
01072     }
01073 <span class="preprocessor">#endif</span>
01074 <span class="preprocessor"></span>    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Console-&gt;VDMProcessHandle);
01075     CloseHandle(Console-&gt;VDMProcessHandle);
01076     Console-&gt;VDMProcessHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01077 
01078 <span class="preprocessor">#if defined(FE_SB) &amp;&amp; defined(FE_IME) &amp;&amp; defined(i386)</span>
01079 <span class="preprocessor"></span>    {
01080         <span class="keywordflow">if</span> (Console-&gt;FullScreenFlags &amp; CONSOLE_FULLSCREEN) {
01081             Console-&gt;Flags |= CONSOLE_JUST_VDM_UNREGISTERED ;
01082         }
01083         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Console-&gt;CurrentScreenBuffer-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>) {
01084             <a class="code" href="../../d6/d8/dispatch_8h.html#a10">AdjustCursorPosition</a>(Console-&gt;CurrentScreenBuffer,
01085                                  Console-&gt;CurrentScreenBuffer-&gt;BufferInfo.TextInfo.CursorPosition,
01086                                  TRUE,
01087                                  NULL);
01088         }
01089     }
01090 <span class="preprocessor">#endif</span>
01091 <span class="preprocessor"></span>}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a47" doxytag="server/private.c::UnsetActivePalette" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UnsetActivePalette           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ScreenInfo</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00573">573</a> of file <a class="el" href="../../d8/d3/server_2private_8c-source.html">server/private.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l07575">NtUserSetInformationThread()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d9/user32_8def-source.html#l00720">RealizePalette</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/output_8c-source.html#l04700">ConsoleWindowProc()</a>, and <a class="el" href="../../d8/d3/server_2private_8c-source.html#l01567">DisplayModeTransition()</a>.
<p>
<pre class="fragment"><div>00576 {
00577     USERTHREAD_USEDESKTOPINFO utudi;
00578     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bReset = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00579 
00580     <span class="keywordflow">if</span> (GetCurrentThreadId() != ScreenInfo-&gt;Console-&gt;InputThreadInfo-&gt;ThreadId) {
00581         bReset = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00582         utudi.hThread = ScreenInfo-&gt;Console-&gt;InputThreadInfo-&gt;ThreadHandle;
00583         utudi.drdRestore.pdeskRestore = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00584         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a277">NtUserSetInformationThread</a>(NtCurrentThread(),
00585                 UserThreadUseDesktop,
00586                 &amp;utudi, <span class="keyword">sizeof</span>(utudi));
00587     }
00588 
00589     SetSystemPaletteUse(ScreenInfo-&gt;Console-&gt;hDC,
00590                         SYSPAL_STATIC
00591                        );
00592     <a class="code" href="../../d3/d0/user32_8def.html#a84">RealizePalette</a>(ScreenInfo-&gt;Console-&gt;hDC);
00593 
00594 
00595     <span class="keywordflow">if</span> (bReset == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00596         utudi.hThread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00597         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a277">NtUserSetInformationThread</a>(NtCurrentThread(),
00598                 UserThreadUseDesktop, &amp;utudi, <span class="keyword">sizeof</span>(utudi));
00599     }
00600 }
</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a25" doxytag="server/private.c::ColorBuffer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> UCHAR <a class="el" href="../../d7/d4/server_2private_8c.html#a25">ColorBuffer</a>[]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Initial value:</b><pre class="fragment"><div> {

        16, 
        0,
        0,
        0,  
        0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x2A, 0x00, 
        0x00, 0x2A, 0x00, 0x00, 
        0x00, 0x2A, 0x2A, 0x00, 
        0x2A, 0x00, 0x00, 0x00, 
        0x2A, 0x00, 0x2A, 0x00, 
        0x2A, 0x2A, 0x00, 0x00, 
        0x36, 0x36, 0x36, 0x00, 
        0x28, 0x28, 0x28, 0x00, 
        0x00, 0x00, 0x3F, 0x00, 
        0x00, 0x3F, 0x00, 0x00, 
        0x00, 0x3F, 0x3F, 0x00, 
        0x3F, 0x00, 0x00, 0x00, 
        0x3F, 0x00, 0x3F, 0x00, 
        0x3F, 0x3F, 0x00, 0x00, 
        0x3F, 0x3F, 0x3F, 0x00  
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00068">68</a> of file <a class="el" href="../../d8/d3/server_2private_8c-source.html">server/private.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a29" doxytag="server/private.c::hCPIFile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> HANDLE <a class="el" href="../../d7/d4/server_2private_8c.html#a29">hCPIFile</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00130">130</a> of file <a class="el" href="../../d8/d3/server_2private_8c-source.html">server/private.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d3/server_2private_8c-source.html#l02089">InitializeFullScreen()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="server/private.c::InitialPalette" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> <a class="el" href="../../d7/d4/server_2private_8c.html#a24">InitialPalette</a>[INITIAL_PALETTE_SIZE]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Initial value:</b><pre class="fragment"><div> {

        16, 
        0,  
        0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00057">57</a> of file <a class="el" href="../../d8/d3/server_2private_8c-source.html">server/private.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a28" doxytag="server/private.c::ModeFontPairs" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d9/d8/struct__MODE__FONT__PAIR.html">MODE_FONT_PAIR</a> <a class="el" href="../../d7/d4/server_2private_8c.html#a28">ModeFontPairs</a>[<a class="el" href="../../d0/d3/dbcs_8h.html#a23">NUMBER_OF_MODE_FONT_PAIRS</a>]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Initial value:</b><pre class="fragment"><div> {
    {21, 640, 350, 8, 16},
    {25, 720, 400, 8, 16},
    {28, 720, 400, 8, 14},
    {43, 640, 350, 8, 8 },
    {50, 720, 400, 8, 8 }
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00120">120</a> of file <a class="el" href="../../d8/d3/server_2private_8c-source.html">server/private.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d3/server_2private_8c-source.html#l01567">DisplayModeTransition()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l02232">SrvGetConsoleHardwareState()</a>, and <a class="el" href="../../d8/d3/server_2private_8c-source.html#l02280">SrvSetConsoleHardwareState()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:18 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
