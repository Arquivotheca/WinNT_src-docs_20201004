<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: ke/ia64/region.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>region.c File Reference</h1><code>#include "<a class="el" href="../../d1/d9/ki_8h-source.html">ki.h</a>"</code><br>
<code>#include "<a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>"</code><br>
<code>#include "<a class="el" href="../../d5/d7/mi_8h-source.html">..\..\mm\mi.h</a>"</code><br>

<p>
<a href="../../d8/d5/ke_2ia64_2region_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/ke_2ia64_2region_8c.html#a0">KiMakeValidRegionRegister</a>(Rid, Ps)&nbsp;&nbsp;&nbsp;(((ULONGLONG)Rid &lt;&lt; RR_RID) | (Ps &lt;&lt; RR_PS) | (1 &lt;&lt; RR_VE))</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/ke_2ia64_2region_8c.html#a2">KiSetRegionRegister</a> (PVOID VirtualAddress, ULONGLONG Contents)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/ke_2ia64_2region_8c.html#a3">KiSyncNewRegionIdTarget</a> (IN PULONG SignalDone, IN PVOID Parameter1, IN PVOID Parameter2, IN PVOID Parameter3)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/ke_2ia64_2region_8c.html#a4">KiSyncNewRegionId</a> (IN PREGION_MAP_INFO ProcessRegion, IN PREGION_MAP_INFO SessionRegion)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/ke_2ia64_2region_8c.html#a5">KeEnableSessionSharing</a> (PREGION_MAP_INFO SessionMapInfo)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/ke_2ia64_2region_8c.html#a6">KeDisableSessionSharing</a> (PREGION_MAP_INFO SessionMapInfo)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/ke_2ia64_2region_8c.html#a7">KeAttachSessionSpace</a> (PREGION_MAP_INFO SessionMapInfo)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/ke_2ia64_2region_8c.html#a8">KiSyncSessionTarget</a> (IN PULONG SignalDone, IN <a class="el" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process, IN PVOID Parameter1, IN PVOID Parameter2)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/ke_2ia64_2region_8c.html#a9">KeDetachSessionSpace</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/ke_2ia64_2region_8c.html#a10">KeAddSessionSpace</a> (<a class="el" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process, PREGION_MAP_INFO SessionMapInfo)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/ke_2ia64_2region_8c.html#a1">KiMaximumRid</a> = MAXIMUM_RID</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="ke/ia64/region.c::KiMakeValidRegionRegister" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define KiMakeValidRegionRegister          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Rid,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>Ps&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;(((ULONGLONG)Rid &lt;&lt; RR_RID) | (Ps &lt;&lt; RR_PS) | (1 &lt;&lt; RR_VE))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d5/ke_2ia64_2region_8c-source.html#l00034">34</a> of file <a class="el" href="../../d8/d5/ke_2ia64_2region_8c-source.html">ke/ia64/region.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d5/ke_2ia64_2region_8c-source.html#l00543">KeDetachSessionSpace()</a>, <a class="el" href="../../d8/d5/ke_2ia64_2region_8c-source.html#l00122">KiSyncNewRegionId()</a>, <a class="el" href="../../d8/d5/ke_2ia64_2region_8c-source.html#l00041">KiSyncNewRegionIdTarget()</a>, and <a class="el" href="../../d8/d5/ke_2ia64_2region_8c-source.html#l00468">KiSyncSessionTarget()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a10" doxytag="ke/ia64/region.c::KeAddSessionSpace" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KeAddSessionSpace           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PREGION_MAP_INFO&nbsp;</td>
          <td class="mdname" nowrap> <em>SessionMapInfo</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d5/ke_2ia64_2region_8c-source.html#l00628">628</a> of file <a class="el" href="../../d8/d5/ke_2ia64_2region_8c-source.html">ke/ia64/region.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d4/d6/session_8c-source.html#l00178">MiSessionAddProcess()</a>.
<p>
<pre class="fragment"><div>00634                    :
00635     
00636     Add <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> session map info to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d5/d7/struct__KPROCESS.html">KPROCESS</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> process.
00637 
00638 Arguments:
00639 
00640     Process - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process being created.
00641 
00642     SessionMapInfo - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SessionMapInfo.
00643 
00644 Return Value: 
00645 
00646     None.
00647 
00648 Environment:
00649 
00650     Kernel mode, APCs disabled.  
00651 
00652 Remarks:
00653     
00654     KiLockDispaterLock or LockQueuedDispatcherLock <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not necessary 
00655     since <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process has not run yet.
00656 
00657 --*/
00658 {
00659     KIRQL OldIrql;
00660 
00661     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Process-&gt;SessionMapInfo == NULL);
00662 
00663 <span class="comment">//    KiLockDispatcherDatabase(&amp;OldIrql);</span>
00664 
00665     Process-&gt;SessionMapInfo = SessionMapInfo;
00666 
00667 <span class="comment">//    KiUnLockDispatherDatabase(OldIrql);</span>
00668 
00669 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="ke/ia64/region.c::KeAttachSessionSpace" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KeAttachSessionSpace           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PREGION_MAP_INFO&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>SessionMapInfo</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d5/ke_2ia64_2region_8c-source.html#l00413">413</a> of file <a class="el" href="../../d8/d5/ke_2ia64_2region_8c-source.html">ke/ia64/region.c</a>.
<p>
References <a class="el" href="../../d5/d8/ke_8h-source.html#l00575">_KTHREAD::ApcState</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00070">KeGetCurrentThread</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01907">KiLockDispatcherDatabase</a>, <a class="el" href="../../d8/d5/ke_2ia64_2region_8c-source.html#l00122">KiSyncNewRegionId()</a>, <a class="el" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d5/d8/ke_8h-source.html#l00244">_KAPC_STATE::Process</a>.
<p>
Referenced by <a class="el" href="../../d4/d6/session_8c-source.html#l01181">MiAttachSession()</a>.
<p>
<pre class="fragment"><div>00418                     :
00419 
00420     This routine attaches a session map info to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current process.
00421 
00422  Arguments: 
00423 
00424     SessionMapInfo - Supplies a session map info to be attached.
00425 
00426  Return Value:
00427 
00428     None.
00429 
00430  Environment:
00431 
00432     Kernel mode.
00433 
00434 --*/
00435 {
00436     KIRQL OldIrql;
00437     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread;
00438     <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process;
00439 
00440     Thread = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
00441     Process = Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o1">Process</a>;
00442 
00443     <span class="comment">//</span>
00444     <span class="comment">// Raise IRQL to dispatcher level and lock the dispatcher database.</span>
00445     <span class="comment">//</span>
00446 
00447     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00448 
00449     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(SessionMapInfo != NULL);
00450 
00451     <span class="comment">//</span>
00452     <span class="comment">// Attach the given session map</span>
00453     <span class="comment">//</span>
00454 
00455     Process-&gt;SessionMapInfo = SessionMapInfo;
00456 
00457     <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a4">KiSyncNewRegionId</a>(&amp;Process-&gt;ProcessRegion, SessionMapInfo);
00458 
00459     <span class="comment">//</span>
00460     <span class="comment">// unlock the dispatcher database</span>
00461     <span class="comment">//</span>
00462 
00463     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00464     
00465 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="ke/ia64/region.c::KeDetachSessionSpace" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KeDetachSessionSpace           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d5/ke_2ia64_2region_8c-source.html#l00543">543</a> of file <a class="el" href="../../d8/d5/ke_2ia64_2region_8c-source.html">ke/ia64/region.c</a>.
<p>
References <a class="el" href="../../d5/d8/ke_8h-source.html#l00575">_KTHREAD::ApcState</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02766">KeActiveProcessors</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00070">KeGetCurrentThread</a>, <a class="el" href="../../d0/d3/mpipi_8c-source.html#l00319">KiIpiSendPacket()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01907">KiLockDispatcherDatabase</a>, <a class="el" href="../../d8/d5/ke_2ia64_2region_8c-source.html#l00034">KiMakeValidRegionRegister</a>, <a class="el" href="../../d0/d5/ia64_2flushtb_8c-source.html#l00029">KiMasterRidLock</a>, <a class="el" href="../../d7/d6/ke_2ia64_2region_8c.html#a2">KiSetRegionRegister()</a>, <a class="el" href="../../d8/d5/ke_2ia64_2region_8c-source.html#l00468">KiSyncSessionTarget()</a>, <a class="el" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00141">MM_SESSION_SPACE_DEFAULT</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, and <a class="el" href="../../d5/d8/ke_8h-source.html#l00244">_KAPC_STATE::Process</a>.
<p>
Referenced by <a class="el" href="../../d4/d6/session_8c-source.html#l01544">MiDereferenceSession()</a>, and <a class="el" href="../../d4/d6/session_8c-source.html#l01253">MiDetachSession()</a>.
<p>
<pre class="fragment"><div>00548                     :
00549     
00550     This routine removes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> session space and synchronize <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> all threads on 
00551     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> other processors.
00552 
00553  Arguments:
00554  
00555     DeleteSessionMapInfo - <span class="keywordflow">if</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> session map info will be deleted.
00556         <span class="keywordflow">if</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> session map info will not be deleted.
00557 
00558  Return Value:
00559   
00560     None.
00561 
00562  Environment:
00563  
00564     Kernel mode.
00565 
00566 --*/
00567 {
00568     KIRQL OldIrql;
00569     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread;
00570     <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process;
00571 <span class="preprocessor">#if !defined(NT_UP)</span>
00572 <span class="preprocessor"></span>    KAFFINITY TargetProcessors;
00573 <span class="preprocessor">#endif</span>
00574 <span class="preprocessor"></span>
00575     <span class="comment">//</span>
00576     <span class="comment">// Raise IRQL to dispatcher level and lock the dispatcher database.</span>
00577     <span class="comment">//</span>
00578 
00579     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00580 
00581     Thread = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
00582     Process = Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o1">Process</a>;
00583 
00584     <span class="comment">//</span>
00585     <span class="comment">// Lock the region Id resource.</span>
00586     <span class="comment">//</span>
00587     
00588     KiAcquireSpinLock(&amp;KiMasterRidLock);
00589 
00590     Process-&gt;SessionMapInfo = &amp;Process-&gt;SessionRegion;
00591     
00592     <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a2">KiSetRegionRegister</a>((PVOID)MM_SESSION_SPACE_DEFAULT, 
00593                         <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a0">KiMakeValidRegionRegister</a>(Process-&gt;SessionMapInfo-&gt;RegionId, PAGE_SHIFT));
00594 
00595     <span class="comment">//</span>
00596     <span class="comment">// Unlock the region Id resource.</span>
00597     <span class="comment">//</span>
00598 
00599     KiReleaseSpinLock(&amp;KiMasterRidLock);
00600 
00601 <span class="preprocessor">#if !defined(NT_UP)</span>
00602 <span class="preprocessor"></span>
00603     <span class="comment">//</span>
00604     <span class="comment">// broadcast Region Id sync</span>
00605     <span class="comment">//</span>
00606 
00607     TargetProcessors = <a class="code" href="../../d4/d9/ke_8h.html#a123">KeActiveProcessors</a>;
00608     TargetProcessors &amp;= PCR-&gt;NotMember;
00609 
00610     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00611         <a class="code" href="../../d0/d0/ki_8h.html#a91">KiIpiSendPacket</a>(TargetProcessors,
00612                         KiSyncSessionTarget,
00613                         Process,
00614                         NULL,
00615                         NULL);
00616     }
00617 
00618 <span class="preprocessor">#endif</span>
00619 <span class="preprocessor"></span>
00620     <span class="comment">//</span>
00621     <span class="comment">// Unlock the dispatcher database</span>
00622     <span class="comment">//</span>
00623 
00624     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00625 }    

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="ke/ia64/region.c::KeDisableSessionSharing" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KeDisableSessionSharing           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PREGION_MAP_INFO&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>SessionMapInfo</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d5/ke_2ia64_2region_8c-source.html#l00364">364</a> of file <a class="el" href="../../d8/d5/ke_2ia64_2region_8c-source.html">ke/ia64/region.c</a>.
<p>
References <a class="el" href="../../d5/d8/ke_8h-source.html#l00575">_KTHREAD::ApcState</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00070">KeGetCurrentThread</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01907">KiLockDispatcherDatabase</a>, <a class="el" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase()</a>, and <a class="el" href="../../d5/d8/ke_8h-source.html#l00244">_KAPC_STATE::Process</a>.
<p>
Referenced by <a class="el" href="../../d4/d6/session_8c-source.html#l01544">MiDereferenceSession()</a>.
<p>
<pre class="fragment"><div>00369                     :
00370 
00371     This routine disables session sharing by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> other process.
00372 
00373  Arguments: 
00374 
00375     SessionMapInfo - Supplies a session map info to be disabled 
00376            <span class="keywordflow">for</span> sharing.
00377 
00378  Return Value:
00379 
00380     None.
00381 
00382  Environment:
00383 
00384     Kernel mode.
00385 
00386 --*/
00387 {
00388     <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process;
00389     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread;
00390     KIRQL OldIrql;
00391 
00392     Thread = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
00393     Process = Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o1">Process</a>;
00394 
00395     <span class="comment">//</span>
00396     <span class="comment">// Raise IRQL to dispatcher level and lock the dispatcher database.</span>
00397     <span class="comment">//</span>
00398 
00399     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00400 
00401     Process-&gt;SessionRegion.RegionId = SessionMapInfo-&gt;RegionId;
00402     Process-&gt;SessionRegion.SequenceNumber = SessionMapInfo-&gt;SequenceNumber;
00403     Process-&gt;SessionMapInfo = &amp;Process-&gt;SessionRegion;
00404 
00405     <span class="comment">//</span>
00406     <span class="comment">// unlock the dispatcher database</span>
00407     <span class="comment">//</span>
00408 
00409     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00410 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="ke/ia64/region.c::KeEnableSessionSharing" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KeEnableSessionSharing           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PREGION_MAP_INFO&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>SessionMapInfo</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d5/ke_2ia64_2region_8c-source.html#l00315">315</a> of file <a class="el" href="../../d8/d5/ke_2ia64_2region_8c-source.html">ke/ia64/region.c</a>.
<p>
References <a class="el" href="../../d5/d8/ke_8h-source.html#l00575">_KTHREAD::ApcState</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00070">KeGetCurrentThread</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01907">KiLockDispatcherDatabase</a>, <a class="el" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase()</a>, and <a class="el" href="../../d5/d8/ke_8h-source.html#l00244">_KAPC_STATE::Process</a>.
<p>
Referenced by <a class="el" href="../../d4/d6/session_8c-source.html#l00394">MiSessionCreateInternal()</a>.
<p>
<pre class="fragment"><div>00320                     :
00321 
00322     This routine enables session sharing by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> other processes.
00323 
00324  Arguments: 
00325 
00326     SessionMapInfo - Supplies a session map info to be shared.
00327 
00328  Return Value:
00329 
00330     None.
00331 
00332  Environment:
00333 
00334     Kernel mode.
00335 
00336 --*/
00337 {
00338     <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process;
00339     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread;
00340     KIRQL OldIrql;
00341 
00342     Thread = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
00343     Process = Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o1">Process</a>;
00344 
00345     <span class="comment">//</span>
00346     <span class="comment">// Raise IRQL to dispatcher level and lock the dispatcher database.</span>
00347     <span class="comment">//</span>
00348 
00349     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00350 
00351     SessionMapInfo-&gt;RegionId = Process-&gt;SessionRegion.RegionId;
00352     SessionMapInfo-&gt;SequenceNumber = Process-&gt;SessionRegion.SequenceNumber;
00353 
00354     Process-&gt;SessionMapInfo = SessionMapInfo;
00355 
00356     <span class="comment">//</span>
00357     <span class="comment">// unlock the dispatcher database</span>
00358     <span class="comment">//</span>
00359 
00360     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00361 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="ke/ia64/region.c::KiSetRegionRegister" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiSetRegionRegister           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>VirtualAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONGLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Contents</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d8/d5/ke_2ia64_2region_8c-source.html#l00543">KeDetachSessionSpace()</a>, <a class="el" href="../../d8/d5/ke_2ia64_2region_8c-source.html#l00122">KiSyncNewRegionId()</a>, <a class="el" href="../../d8/d5/ke_2ia64_2region_8c-source.html#l00041">KiSyncNewRegionIdTarget()</a>, and <a class="el" href="../../d8/d5/ke_2ia64_2region_8c-source.html#l00468">KiSyncSessionTarget()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="ke/ia64/region.c::KiSyncNewRegionId" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN KiSyncNewRegionId           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PREGION_MAP_INFO&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessRegion</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PREGION_MAP_INFO&nbsp;</td>
          <td class="mdname" nowrap> <em>SessionRegion</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d5/ke_2ia64_2region_8c-source.html#l00122">122</a> of file <a class="el" href="../../d8/d5/ke_2ia64_2region_8c-source.html">ke/ia64/region.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02766">KeActiveProcessors</a>, <a class="el" href="../../d4/d9/ke_8h.html#a374">KeFlushCurrentTb()</a>, <a class="el" href="../../d0/d3/mpipi_8c-source.html#l00319">KiIpiSendPacket()</a>, <a class="el" href="../../d3/d0/xipi_8c-source.html#l00182">KiIpiStallOnPacketTargets()</a>, <a class="el" href="../../d8/d5/ke_2ia64_2region_8c-source.html#l00034">KiMakeValidRegionRegister</a>, <a class="el" href="../../d0/d5/ia64_2flushtb_8c-source.html#l00029">KiMasterRidLock</a>, <a class="el" href="../../d8/d5/ke_2ia64_2region_8c-source.html#l00037">KiMaximumRid</a>, <a class="el" href="../../d7/d6/ke_2ia64_2region_8c.html#a2">KiSetRegionRegister()</a>, <a class="el" href="../../d8/d5/ke_2ia64_2region_8c-source.html#l00041">KiSyncNewRegionIdTarget()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00141">MM_SESSION_SPACE_DEFAULT</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d5/ke_2ia64_2region_8c-source.html#l00413">KeAttachSessionSpace()</a>.
<p>
<pre class="fragment"><div>00128                     :
00129 
00130     Generate a <span class="keyword">new</span> region <span class="keywordtype">id</span> and synchronze <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> region Ids on all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> processors
00131     <span class="keywordflow">if</span> necessary. If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> region ids wrap then flush all processor TLB's.
00132 
00133  Arguments:
00134 
00135     ProcessRegion - Supplies a pointer to REGION_MAP_INFO <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user space.
00136     SessionRegion - Supplies a pointer to REGION_MAP_INFO <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> session space.
00137 
00138  Return Value:
00139 
00140     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> -- when region <span class="keywordtype">id</span> has not been recycled.
00141 
00142     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> -- when region <span class="keywordtype">id</span> has been recycled.
00143 
00144  Notes:
00145 
00146     This routine called by <a class="code" href="../../d0/d0/ki_8h.html#a137">KiSwapProcess</a>, <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a7">KeAttachSessionSpace</a> and 
00147     KeCreateSessionSpace.
00148 
00149  Environment:
00150 
00151     Kernel mode.
00152     KiLockDispaterLock or LockQueuedDispatcherLock <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> held
00153 
00154 --*/
00155 
00156 {
00157     BOOLEAN RidRecycled = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00158     KAFFINITY TargetProcessors;
00159     ULONG i;
00160 
00161     <span class="comment">//</span>
00162     <span class="comment">// Invalidate the ForwardProgressTb buffer</span>
00163     <span class="comment">//</span>
00164 
00165     <span class="keywordflow">for</span> (i = 0; i &lt; MAXIMUM_FWP_BUFFER_ENTRY; i += 1) {
00166         
00167         PCR-&gt;ForwardProgressBuffer[(i*2)+1] = 0;
00168 
00169     }
00170     
00171     KiAcquireSpinLock(&amp;KiMasterRidLock);
00172 
00173     <span class="keywordflow">if</span> ((ProcessRegion-&gt;SequenceNumber == KiMasterSequence) &amp;&amp; 
00174         (SessionRegion-&gt;SequenceNumber == KiMasterSequence)) {
00175         
00176         <span class="keywordflow">goto</span> not_recycled;
00177 
00178     }
00179 
00180     <span class="keywordflow">if</span> (ProcessRegion-&gt;SequenceNumber != KiMasterSequence) {
00181 
00182         <span class="keywordflow">if</span> (KiMasterRid + 1 &gt; <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a1">KiMaximumRid</a>) {
00183 
00184             RidRecycled = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00185 
00186         } <span class="keywordflow">else</span> {
00187 
00188             KiMasterRid += 1;
00189             ProcessRegion-&gt;RegionId = KiMasterRid;
00190             ProcessRegion-&gt;SequenceNumber = KiMasterSequence;
00191         }
00192                 
00193     }
00194 
00195     <span class="keywordflow">if</span> ((RidRecycled == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp; 
00196         (SessionRegion-&gt;SequenceNumber != KiMasterSequence)) {
00197         
00198         <span class="keywordflow">if</span> (KiMasterRid + 1 &gt; <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a1">KiMaximumRid</a>) {
00199 
00200             RidRecycled = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00201 
00202         } <span class="keywordflow">else</span> {
00203 
00204             KiMasterRid += 1;
00205             SessionRegion-&gt;RegionId = KiMasterRid;
00206             SessionRegion-&gt;SequenceNumber = KiMasterSequence;
00207         }
00208     }
00209 
00210     <span class="keywordflow">if</span> (RidRecycled == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00211     
00212         <span class="keywordflow">goto</span> not_recycled;
00213 
00214     }
00215 
00216     <span class="comment">//</span>
00217     <span class="comment">//  Region Id must be recycled</span>
00218     <span class="comment">//</span>
00219 
00220     KiMasterRid = START_PROCESS_RID;
00221 
00222     <span class="comment">//</span>
00223     <span class="comment">// Since KiMasterSequence is 64-bit wide, it will not be recycled in your life time.</span>
00224     <span class="comment">//</span>
00225 
00226     <span class="keywordflow">if</span> (KiMasterSequence + 1 &gt; MAXIMUM_SEQUENCE) {
00227 
00228         KiMasterSequence = START_SEQUENCE;
00229 
00230     } <span class="keywordflow">else</span> {
00231 
00232         KiMasterSequence += 1;
00233     }
00234         
00235     <span class="comment">//</span>
00236     <span class="comment">// update new process's ProcessRid and ProcessSequence</span>
00237     <span class="comment">//</span>
00238 
00239     ProcessRegion-&gt;RegionId = KiMasterRid;
00240     ProcessRegion-&gt;SequenceNumber = KiMasterSequence;
00241 
00242     <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a2">KiSetRegionRegister</a>(MM_LOWEST_USER_ADDRESS,
00243                         <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a0">KiMakeValidRegionRegister</a>(ProcessRegion-&gt;RegionId, PAGE_SHIFT));
00244 
00245     KiMasterRid += 1;
00246 
00247     SessionRegion-&gt;RegionId = KiMasterRid;
00248     SessionRegion-&gt;SequenceNumber = KiMasterSequence;
00249 
00250     <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a2">KiSetRegionRegister</a>((PVOID)MM_SESSION_SPACE_DEFAULT,
00251                         <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a0">KiMakeValidRegionRegister</a>(SessionRegion-&gt;RegionId, PAGE_SHIFT));
00252 
00253     <span class="comment">//</span>
00254     <span class="comment">// release mutex for master region id lock</span>
00255     <span class="comment">//</span>
00256 
00257     KiReleaseSpinLock(&amp;KiMasterRidLock);
00258 
00259 <span class="preprocessor">#if !defined(NT_UP)</span>
00260 <span class="preprocessor"></span>
00261     <span class="comment">//</span>
00262     <span class="comment">// broadcast Region Id sync</span>
00263     <span class="comment">//</span>
00264 
00265     TargetProcessors = <a class="code" href="../../d4/d9/ke_8h.html#a123">KeActiveProcessors</a>;
00266     TargetProcessors &amp;= PCR-&gt;NotMember;
00267 
00268     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00269         <a class="code" href="../../d0/d0/ki_8h.html#a91">KiIpiSendPacket</a>(TargetProcessors,
00270                         KiSyncNewRegionIdTarget,
00271                         (PVOID)TRUE,
00272                         NULL,
00273                         NULL);
00274     }
00275 
00276 <span class="preprocessor">#endif</span>
00277 <span class="preprocessor"></span>
00278     <a class="code" href="../../d4/d9/ke_8h.html#a374">KeFlushCurrentTb</a>();
00279 
00280 
00281 <span class="preprocessor">#if !defined(NT_UP)</span>
00282 <span class="preprocessor"></span>
00283     <span class="comment">//</span>
00284     <span class="comment">// Wait until all target processors have finished.</span>
00285     <span class="comment">//</span>
00286 
00287     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00288         <a class="code" href="../../d2/d1/xipi_8c.html#a2">KiIpiStallOnPacketTargets</a>(TargetProcessors);
00289     }
00290 
00291 <span class="preprocessor">#endif</span>
00292 <span class="preprocessor"></span>
00293     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00294 
00295 
00296 not_recycled:
00297 
00298     <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a2">KiSetRegionRegister</a>(MM_LOWEST_USER_ADDRESS,
00299                         <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a0">KiMakeValidRegionRegister</a>(ProcessRegion-&gt;RegionId, PAGE_SHIFT));
00300 
00301     <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a2">KiSetRegionRegister</a>((PVOID)MM_SESSION_SPACE_DEFAULT,
00302                             <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a0">KiMakeValidRegionRegister</a>(SessionRegion-&gt;RegionId, PAGE_SHIFT));
00303 
00304     <span class="comment">//</span>
00305     <span class="comment">// release mutex for master region id lock</span>
00306     <span class="comment">//</span>
00307 
00308     KiReleaseSpinLock(&amp;KiMasterRidLock);
00309         
00310     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00311 
00312 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="ke/ia64/region.c::KiSyncNewRegionIdTarget" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiSyncNewRegionIdTarget           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SignalDone</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Parameter1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Parameter2</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Parameter3</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d5/ke_2ia64_2region_8c-source.html#l00041">41</a> of file <a class="el" href="../../d8/d5/ke_2ia64_2region_8c-source.html">ke/ia64/region.c</a>.
<p>
References <a class="el" href="../../d5/d8/ke_8h-source.html#l00575">_KTHREAD::ApcState</a>, <a class="el" href="../../d4/d9/ke_8h.html#a374">KeFlushCurrentTb()</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00070">KeGetCurrentThread</a>, <a class="el" href="../../d0/d0/ki_8h.html#a93">KiIpiSignalPacketDone()</a>, <a class="el" href="../../d8/d5/ke_2ia64_2region_8c-source.html#l00034">KiMakeValidRegionRegister</a>, <a class="el" href="../../d0/d5/ia64_2flushtb_8c-source.html#l00029">KiMasterRidLock</a>, <a class="el" href="../../d7/d6/ke_2ia64_2region_8c.html#a2">KiSetRegionRegister()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00141">MM_SESSION_SPACE_DEFAULT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, and <a class="el" href="../../d5/d8/ke_8h-source.html#l00244">_KAPC_STATE::Process</a>.
<p>
Referenced by <a class="el" href="../../d8/d5/ke_2ia64_2region_8c-source.html#l00122">KiSyncNewRegionId()</a>.
<p>
<pre class="fragment"><div>00050                    :
00051 
00052     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target function <span class="keywordflow">for</span> synchronizing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> region Ids
00053 
00054 Arguments:
00055 
00056     SignalDone Supplies a pointer to a variable that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> cleared when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00057         requested operation has been performed.
00058 
00059     Parameter1 - Parameter3 - Not used.
00060 
00061 Return Value:
00062 
00063     None.
00064 
00065 --*/
00066 
00067 {
00068 <span class="preprocessor">#if !defined(NT_UP)</span>
00069 <span class="preprocessor"></span>
00070     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread;
00071     <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process;
00072     PREGION_MAP_INFO ProcessRegion;
00073     PREGION_MAP_INFO MappedSession;
00074     ULONG NewRid;
00075  
00076     <span class="comment">//</span>
00077     <span class="comment">// Flush the entire TB on the current processor.</span>
00078     <span class="comment">//</span>
00079 
00080     Thread = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
00081     Process = Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o1">Process</a>;
00082     ProcessRegion = &amp;Process-&gt;ProcessRegion;
00083     MappedSession = Process-&gt;SessionMapInfo;
00084 
00085     KiAcquireSpinLock(&amp;KiMasterRidLock);
00086 
00087     <span class="keywordflow">if</span> (ProcessRegion-&gt;SequenceNumber != KiMasterSequence) {
00088         
00089         KiMasterRid += 1;
00090 
00091         ProcessRegion-&gt;RegionId = KiMasterRid;
00092         ProcessRegion-&gt;SequenceNumber = KiMasterSequence;
00093 
00094         <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a2">KiSetRegionRegister</a>(MM_LOWEST_USER_ADDRESS,
00095             <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a0">KiMakeValidRegionRegister</a>(ProcessRegion-&gt;RegionId, PAGE_SHIFT));
00096 
00097     }
00098 
00099     <span class="keywordflow">if</span> (MappedSession-&gt;SequenceNumber != KiMasterSequence) {
00100 
00101         KiMasterRid += 1;
00102         
00103         MappedSession-&gt;RegionId = KiMasterRid;
00104         MappedSession-&gt;SequenceNumber = KiMasterSequence;
00105 
00106         <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a2">KiSetRegionRegister</a>((PVOID)MM_SESSION_SPACE_DEFAULT,
00107             <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a0">KiMakeValidRegionRegister</a>(MappedSession-&gt;RegionId, PAGE_SHIFT));
00108     }
00109 
00110 
00111     KiReleaseSpinLock(&amp;KiMasterRidLock);
00112 
00113     <a class="code" href="../../d0/d0/ki_8h.html#a93">KiIpiSignalPacketDone</a>(SignalDone);
00114 
00115     <a class="code" href="../../d4/d9/ke_8h.html#a374">KeFlushCurrentTb</a>();
00116 
00117 <span class="preprocessor">#endif</span>
00118 <span class="preprocessor"></span>    <span class="keywordflow">return</span>;
00119 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="ke/ia64/region.c::KiSyncSessionTarget" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiSyncSessionTarget           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SignalDone</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Parameter1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Parameter2</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d5/ke_2ia64_2region_8c-source.html#l00468">468</a> of file <a class="el" href="../../d8/d5/ke_2ia64_2region_8c-source.html">ke/ia64/region.c</a>.
<p>
References <a class="el" href="../../d5/d8/ke_8h-source.html#l00575">_KTHREAD::ApcState</a>, <a class="el" href="../../d4/d9/ke_8h.html#a374">KeFlushCurrentTb()</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00070">KeGetCurrentThread</a>, <a class="el" href="../../d0/d0/ki_8h.html#a93">KiIpiSignalPacketDone()</a>, <a class="el" href="../../d8/d5/ke_2ia64_2region_8c-source.html#l00034">KiMakeValidRegionRegister</a>, <a class="el" href="../../d0/d5/ia64_2flushtb_8c-source.html#l00029">KiMasterRidLock</a>, <a class="el" href="../../d7/d6/ke_2ia64_2region_8c.html#a2">KiSetRegionRegister()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00141">MM_SESSION_SPACE_DEFAULT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, and <a class="el" href="../../d5/d8/ke_8h-source.html#l00244">_KAPC_STATE::Process</a>.
<p>
Referenced by <a class="el" href="../../d8/d5/ke_2ia64_2region_8c-source.html#l00543">KeDetachSessionSpace()</a>.
<p>
<pre class="fragment"><div>00476                     :
00477 
00478     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target function <span class="keywordflow">for</span> synchronizing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> session 
00479     region <span class="keywordtype">id</span>.  This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> session space <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> removed 
00480     and all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> processors need to be notified.
00481 
00482  Arguments:
00483 
00484     SignalDone - Supplies a pointer to a variable that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> cleared when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00485         requested operation has been performed.
00486 
00487     Process - Supplies a <a class="code" href="../../d5/d7/struct__KPROCESS.html">KPROCESS</a> pointer which needs to be sync'ed.
00488 
00489  Return Value:
00490 
00491     None.
00492 
00493  Environment:
00494 
00495     Kernel mode.
00496 
00497 --*/
00498 {
00499 <span class="preprocessor">#if !defined(NT_UP)</span>
00500 <span class="preprocessor"></span>
00501     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread;
00502     ULONG NewRid;
00503  
00504     <span class="comment">//</span>
00505     <span class="comment">// Flush the entire TB on the current processor.</span>
00506     <span class="comment">//</span>
00507 
00508     Thread = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
00509 
00510     <span class="comment">//</span>
00511     <span class="comment">// check to see if the current process is the process that needs to be </span>
00512     <span class="comment">// sync'ed</span>
00513     <span class="comment">//</span>
00514 
00515     <span class="keywordflow">if</span> (Process == Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o1">Process</a>) {
00516         
00517         KiAcquireSpinLock(&amp;KiMasterRidLock);
00518 
00519         <span class="comment">//</span>
00520         <span class="comment">// disable the session region.</span>
00521         <span class="comment">//</span>
00522 
00523         <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a2">KiSetRegionRegister</a>((PVOID)MM_SESSION_SPACE_DEFAULT, 
00524                             <a class="code" href="../../d7/d6/ke_2ia64_2region_8c.html#a0">KiMakeValidRegionRegister</a>(Process-&gt;SessionMapInfo-&gt;RegionId, PAGE_SHIFT));
00525 
00526         KiReleaseSpinLock(&amp;KiMasterRidLock);
00527 
00528         <span class="comment">//</span>
00529         <span class="comment">// flush the entire tb.</span>
00530         <span class="comment">//</span>
00531 
00532         <a class="code" href="../../d4/d9/ke_8h.html#a374">KeFlushCurrentTb</a>();
00533     }
00534 
00535     <a class="code" href="../../d0/d0/ki_8h.html#a93">KiIpiSignalPacketDone</a>(SignalDone);
00536 
00537 <span class="preprocessor">#endif</span>
00538 <span class="preprocessor"></span>    <span class="keywordflow">return</span>;
00539 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a1" doxytag="ke/ia64/region.c::KiMaximumRid" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d7/d6/ke_2ia64_2region_8c.html#a1">KiMaximumRid</a> = MAXIMUM_RID          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d5/ke_2ia64_2region_8c-source.html#l00037">37</a> of file <a class="el" href="../../d8/d5/ke_2ia64_2region_8c-source.html">ke/ia64/region.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d5/ke_2ia64_2region_8c-source.html#l00122">KiSyncNewRegionId()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:27 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
