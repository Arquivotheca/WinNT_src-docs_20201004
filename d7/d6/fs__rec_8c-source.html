<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: fs_rec.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>fs_rec.c</h1><a href="../../d6/d7/fs__rec_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1992  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    fs_rec.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains the main functions for the mini-file system recognizer</span>
00012 <span class="comment">    driver.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Darryl E. Havens (darrylh) 22-nov-1993</span>
00017 <span class="comment"></span>
00018 <span class="comment">Environment:</span>
00019 <span class="comment"></span>
00020 <span class="comment">    Kernel mode, local to I/O system</span>
00021 <span class="comment"></span>
00022 <span class="comment">Revision History:</span>
00023 <span class="comment"></span>
00024 <span class="comment"></span>
00025 <span class="comment">--*/</span>
00026 
00027 <span class="preprocessor">#include "<a class="code" href="../../d7/d7/fs__rec_8h.html">fs_rec.h</a>"</span>
00028 
00029 <span class="comment">//</span>
00030 <span class="comment">//  The local debug trace level</span>
00031 <span class="comment">//</span>
00032 
<a name="l00033"></a><a class="code" href="../../d6/d7/fs__rec_8c.html#a0">00033</a> <span class="preprocessor">#define Dbg                              (FSREC_DEBUG_LEVEL_FSREC)</span>
00034 <span class="preprocessor"></span>
00035 <span class="preprocessor">#if DBG</span>
00036 <span class="preprocessor"></span>
00037 <span class="preprocessor">#include &lt;stdarg.h&gt;</span>
00038 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00039 
00040 LONG FsRecDebugTraceLevel = 0;
00041 LONG FsRecDebugTraceIndent = 0;
00042 
00043 <span class="preprocessor">#endif</span>
00044 <span class="preprocessor"></span>
00045 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00046 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,DriverEntry)</span>
00047 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,FsRecCreateAndRegisterDO)</span>
00048 <span class="preprocessor"></span>
00049 <span class="preprocessor">#pragma alloc_text(PAGE,FsRecCleanupClose)</span>
00050 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,FsRecCreate)</span>
00051 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,FsRecFsControl)</span>
00052 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,FsRecGetDeviceSectorSize)</span>
00053 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,FsRecGetDeviceSectors)</span>
00054 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,FsRecLoadFileSystem)</span>
00055 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,FsRecReadBlock)</span>
00056 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,FsRecUnload)</span>
00057 <span class="preprocessor"></span><span class="preprocessor">#endif // ALLOC_PRAGMA</span>
00058 <span class="preprocessor"></span>
00059 <span class="comment">//</span>
00060 <span class="comment">//  Mutex for serializing driver loads.</span>
00061 <span class="comment">//</span>
00062 
<a name="l00063"></a><a class="code" href="../../d6/d7/fs__rec_8c.html#a2">00063</a> <a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> <a class="code" href="../../d6/d7/fs__rec_8c.html#a2">FsRecLoadSync</a>;
00064 
00065 
00066 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00067"></a><a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a22">00067</a> <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a22">DriverEntry</a> (
00068     IN <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject,
00069     IN PUNICODE_STRING RegistryPath
00070     )
00071 
00072 <span class="comment">/*++</span>
00073 <span class="comment"></span>
00074 <span class="comment">Routine Description:</span>
00075 <span class="comment"></span>
00076 <span class="comment">    This routine is invoked once when the driver is loaded to allow the driver</span>
00077 <span class="comment">    to initialize itself.  The initialization for the driver consists of simply</span>
00078 <span class="comment">    creating a device object for each type of file system recognized by this</span>
00079 <span class="comment">    driver, and then registering each as active file systems.</span>
00080 <span class="comment"></span>
00081 <span class="comment">Arguments:</span>
00082 <span class="comment"></span>
00083 <span class="comment">    DriverObject - Pointer to the driver object for this driver.</span>
00084 <span class="comment"></span>
00085 <span class="comment">    RegistryPath - Pointer to the registry service node for this driver.</span>
00086 <span class="comment"></span>
00087 <span class="comment">Return Value:</span>
00088 <span class="comment"></span>
00089 <span class="comment">    The function value is the final status of the initialization for the driver.</span>
00090 <span class="comment"></span>
00091 <span class="comment">--*/</span>
00092 
00093 {
00094     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> UdfsMainRecognizerDeviceObject;
00095     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00096     ULONG count = 0;
00097 
00098     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00099 
00100     <span class="comment">//</span>
00101     <span class="comment">// Mark the entire driver as pagable.</span>
00102     <span class="comment">//</span>
00103 
00104     <a class="code" href="../../d8/d8/sysload_8c.html#a56">MmPageEntireDriver</a> ((PVOID)<a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a>);
00105 
00106     <span class="comment">//</span>
00107     <span class="comment">// Begin by initializing the driver object so that it the driver is</span>
00108     <span class="comment">// prepared to provide services.</span>
00109     <span class="comment">//</span>
00110 
00111     DriverObject-&gt;MajorFunction[<a class="code" href="../../d0/d5/io_8h.html#a26">IRP_MJ_FILE_SYSTEM_CONTROL</a>] = <a class="code" href="../../d6/d7/fs__rec_8c.html#a7">FsRecFsControl</a>;
00112     DriverObject-&gt;MajorFunction[<a class="code" href="../../d0/d5/io_8h.html#a13">IRP_MJ_CREATE</a>] = <a class="code" href="../../d6/d7/fs__rec_8c.html#a5">FsRecCreate</a>;
00113     DriverObject-&gt;MajorFunction[<a class="code" href="../../d0/d5/io_8h.html#a31">IRP_MJ_CLEANUP</a>] = <a class="code" href="../../d6/d7/fs__rec_8c.html#a4">FsRecCleanupClose</a>;
00114     DriverObject-&gt;MajorFunction[<a class="code" href="../../d0/d5/io_8h.html#a15">IRP_MJ_CLOSE</a>] = <a class="code" href="../../d6/d7/fs__rec_8c.html#a4">FsRecCleanupClose</a>;
00115     DriverObject-&gt;DriverUnload = <a class="code" href="../../d6/d7/fs__rec_8c.html#a8">FsRecUnload</a>;
00116 
00117     <a class="code" href="../../d6/d7/fs__rec_8c.html#a2">FsRecLoadSync</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a>), <a class="code" href="../../d7/d7/fs__rec_8h.html#a5">FSREC_POOL_TAG</a> );
00118 
00119     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d7/fs__rec_8c.html#a2">FsRecLoadSync</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00120 
00121         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00122     }
00123 
00124     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( <a class="code" href="../../d6/d7/fs__rec_8c.html#a2">FsRecLoadSync</a>, SynchronizationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00125 
00126     <span class="comment">//</span>
00127     <span class="comment">// Create and initialize each of the file system driver type device</span>
00128     <span class="comment">// objects.</span>
00129     <span class="comment">//</span>
00130 
00131     status = <a class="code" href="../../d7/d7/fs__rec_8h.html#a26">FsRecCreateAndRegisterDO</a>( DriverObject,
00132                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00133                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00134                                        <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Cdfs"</span>,
00135                                        <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\FileSystem\\CdfsRecognizer"</span>,
00136                                        <a class="code" href="../../d7/d7/fs__rec_8h.html#a38a15">CdfsFileSystem</a>,
00137                                        FILE_DEVICE_CD_ROM_FILE_SYSTEM );
00138     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00139         count++;
00140     }
00141 
00142     status = <a class="code" href="../../d7/d7/fs__rec_8h.html#a26">FsRecCreateAndRegisterDO</a>( DriverObject,
00143                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00144                                        &amp;UdfsMainRecognizerDeviceObject,
00145                                        <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\UdfsCdRom"</span>,
00146                                        <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\FileSystem\\UdfsCdRomRecognizer"</span>,
00147                                        <a class="code" href="../../d7/d7/fs__rec_8h.html#a38a19">UdfsFileSystem</a>,
00148                                        FILE_DEVICE_CD_ROM_FILE_SYSTEM );
00149     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00150         count++;
00151     }
00152 
00153     status = <a class="code" href="../../d7/d7/fs__rec_8h.html#a26">FsRecCreateAndRegisterDO</a>( DriverObject,
00154                                        UdfsMainRecognizerDeviceObject,
00155                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00156                                        <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\UdfsDisk"</span>,
00157                                        <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\FileSystem\\UdfsDiskRecognizer"</span>,
00158                                        <a class="code" href="../../d7/d7/fs__rec_8h.html#a38a19">UdfsFileSystem</a>,
00159                                        FILE_DEVICE_DISK_FILE_SYSTEM );
00160     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00161         count++;
00162     }
00163 
00164     status = <a class="code" href="../../d7/d7/fs__rec_8h.html#a26">FsRecCreateAndRegisterDO</a>( DriverObject,
00165                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00166                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00167                                        <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Fat"</span>,
00168                                        <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\FileSystem\\FatRecognizer"</span>,
00169                                        <a class="code" href="../../d7/d7/fs__rec_8h.html#a38a16">FatFileSystem</a>,
00170                                        FILE_DEVICE_DISK_FILE_SYSTEM );
00171     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00172         count++;
00173     }
00174 
00175     status = <a class="code" href="../../d7/d7/fs__rec_8h.html#a26">FsRecCreateAndRegisterDO</a>( DriverObject,
00176                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00177                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00178                                        <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Ntfs"</span>,
00179                                        <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\FileSystem\\NtfsRecognizer"</span>,
00180                                        <a class="code" href="../../d7/d7/fs__rec_8h.html#a38a18">NtfsFileSystem</a>,
00181                                        FILE_DEVICE_DISK_FILE_SYSTEM );
00182     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00183         count++;
00184     }
00185 
00186     <span class="keywordflow">if</span> (count) {
00187         <span class="keywordflow">return</span> STATUS_SUCCESS;
00188     } <span class="keywordflow">else</span> {
00189         <span class="keywordflow">return</span> STATUS_IMAGE_ALREADY_LOADED;
00190     }
00191 }
00192 
00193 
00194 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00195"></a><a class="code" href="../../d7/d7/fs__rec_8h.html#a24">00195</a> <a class="code" href="../../d7/d7/fs__rec_8h.html#a24">FsRecCleanupClose</a> (
00196     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject,
00197     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp
00198     )
00199 
00200 <span class="comment">/*++</span>
00201 <span class="comment"></span>
00202 <span class="comment">Routine Description:</span>
00203 <span class="comment"></span>
00204 <span class="comment">    This routine is invoked when someone attempts to cleanup or close one of</span>
00205 <span class="comment">    the system recognizer's registered device objects.</span>
00206 <span class="comment"></span>
00207 <span class="comment">Arguments:</span>
00208 <span class="comment"></span>
00209 <span class="comment">    DeviceObject - Pointer to the device object being closed.</span>
00210 <span class="comment"></span>
00211 <span class="comment">    Irp - Pointer to the cleanup/close IRP.</span>
00212 <span class="comment"></span>
00213 <span class="comment">Return Value:</span>
00214 <span class="comment"></span>
00215 <span class="comment">    The final function value is STATUS_SUCCESS.</span>
00216 <span class="comment"></span>
00217 <span class="comment">--*/</span>
00218 
00219 {
00220     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00221 
00222     <span class="comment">//</span>
00223     <span class="comment">// Simply complete the request successfully (note that IoStatus.Status in</span>
00224     <span class="comment">// Irp is already initialized to STATUS_SUCCESS).</span>
00225     <span class="comment">//</span>
00226 
00227     <a class="code" href="../../d0/d5/io_8h.html#a224">IoCompleteRequest</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, <a class="code" href="../../d7/d8/exboosts_8h.html#a3">IO_NO_INCREMENT</a> );
00228     <span class="keywordflow">return</span> STATUS_SUCCESS;
00229 }
00230 
00231 
00232 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00233"></a><a class="code" href="../../d7/d7/fs__rec_8h.html#a25">00233</a> <a class="code" href="../../d7/d7/fs__rec_8h.html#a25">FsRecCreate</a> (
00234     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject,
00235     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp
00236     )
00237 
00238 <span class="comment">/*++</span>
00239 <span class="comment"></span>
00240 <span class="comment">Routine Description:</span>
00241 <span class="comment"></span>
00242 <span class="comment">    This routine is invoked when someone attempts to open one of the file</span>
00243 <span class="comment">    system recognizer's registered device objects.</span>
00244 <span class="comment"></span>
00245 <span class="comment">Arguments:</span>
00246 <span class="comment"></span>
00247 <span class="comment">    DeviceObject - Pointer to the device object being opened.</span>
00248 <span class="comment"></span>
00249 <span class="comment">    Irp - Pointer to the create IRP.</span>
00250 <span class="comment"></span>
00251 <span class="comment">Return Value:</span>
00252 <span class="comment"></span>
00253 <span class="comment">    The final function value indicates whether or not the open was successful.</span>
00254 <span class="comment"></span>
00255 <span class="comment">--*/</span>
00256 
00257 {
00258     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00259     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00260 
00261     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00262 
00263     <span class="comment">//</span>
00264     <span class="comment">// Simply ensure that the name of the "file" being opened is NULL, and</span>
00265     <span class="comment">// complete the request accordingly.</span>
00266     <span class="comment">//</span>
00267 
00268     <span class="keywordflow">if</span> (irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o19">FileName</a>.Length) {
00269         status = STATUS_OBJECT_PATH_NOT_FOUND;
00270     } <span class="keywordflow">else</span> {
00271         status = STATUS_SUCCESS;
00272     }
00273 
00274     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = status;
00275     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = FILE_OPENED;
00276     <a class="code" href="../../d0/d5/io_8h.html#a224">IoCompleteRequest</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, <a class="code" href="../../d7/d8/exboosts_8h.html#a3">IO_NO_INCREMENT</a> );
00277     <span class="keywordflow">return</span> status;
00278 }
00279 
00280 
00281 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00282"></a><a class="code" href="../../d7/d7/fs__rec_8h.html#a26">00282</a> <a class="code" href="../../d7/d7/fs__rec_8h.html#a26">FsRecCreateAndRegisterDO</a> (
00283     IN <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject,
00284     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> HeadRecognizer OPTIONAL,
00285     OUT <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> *NewRecognizer OPTIONAL,
00286     IN PWCHAR RecFileSystem,
00287     IN PWCHAR FileSystemName,
00288     IN <a class="code" href="../../d7/d7/fs__rec_8h.html#a9">FILE_SYSTEM_TYPE</a> FileSystemType,
00289     IN DEVICE_TYPE DeviceType
00290     )
00291 
00292 <span class="comment">/*++</span>
00293 <span class="comment"></span>
00294 <span class="comment">Routine Description:</span>
00295 <span class="comment"></span>
00296 <span class="comment">    This routine creates a device object for the specified file system type and</span>
00297 <span class="comment">    registers it as an active file system.</span>
00298 <span class="comment"></span>
00299 <span class="comment">Arguments:</span>
00300 <span class="comment"></span>
00301 <span class="comment">    DriverObject - Pointer to the driver object for this driver.</span>
00302 <span class="comment">    </span>
00303 <span class="comment">    HeadRecognizer - Optionally supplies a pre-existing recognizer that the</span>
00304 <span class="comment">        newly created DO should be jointly serialized and unregistered with.</span>
00305 <span class="comment">        This is useful if a given filesystem exists on multiple device types</span>
00306 <span class="comment">        and thus requires multiple recognizers.</span>
00307 <span class="comment">    </span>
00308 <span class="comment">    NewDeviceObject - Receives the created DO on success..</span>
00309 <span class="comment"></span>
00310 <span class="comment">    RecFileSystem - Name of the file system to be recognized.</span>
00311 <span class="comment"></span>
00312 <span class="comment">    FileSystemName - Name of file system device object to be registered.</span>
00313 <span class="comment"></span>
00314 <span class="comment">    FileSystemType - Type of this file system recognizer device object.</span>
00315 <span class="comment">    </span>
00316 <span class="comment">    DeviceType - Type of media this file system recognizer device object will inspect.</span>
00317 <span class="comment"></span>
00318 <span class="comment">Return Value:</span>
00319 <span class="comment"></span>
00320 <span class="comment">    The final function value indicates whether or not the device object was</span>
00321 <span class="comment">    successfully created and registered.</span>
00322 <span class="comment"></span>
00323 <span class="comment">--*/</span>
00324 
00325 {
00326     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
00327     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00328     UNICODE_STRING nameString;
00329     OBJECT_ATTRIBUTES objectAttributes;
00330     HANDLE fsHandle;
00331     IO_STATUS_BLOCK ioStatus;
00332     <a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html">PDEVICE_EXTENSION</a> deviceExtension;
00333 
00334     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00335 
00336     <span class="keywordflow">if</span> (NewRecognizer) {
00337 
00338         *NewRecognizer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00339     }
00340 
00341     <span class="comment">//</span>
00342     <span class="comment">// Begin by attempting to open the file system driver's device object.  If</span>
00343     <span class="comment">// it works, then the file system is already loaded, so don't load this</span>
00344     <span class="comment">// driver.  Otherwise, this mini-driver is the one that should be loaded.</span>
00345     <span class="comment">//</span>
00346 
00347     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;nameString, RecFileSystem );
00348     InitializeObjectAttributes( &amp;objectAttributes,
00349                                 &amp;nameString,
00350                                 OBJ_CASE_INSENSITIVE,
00351                                 (HANDLE) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00352                                 (PSECURITY_DESCRIPTOR) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00353 
00354     status = <a class="code" href="../../d6/d9/restrfil_8c.html#a31">ZwCreateFile</a>( &amp;fsHandle,
00355                            SYNCHRONIZE,
00356                            &amp;objectAttributes,
00357                            &amp;ioStatus,
00358                            (PLARGE_INTEGER) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00359                            0,
00360                            FILE_SHARE_READ | FILE_SHARE_WRITE,
00361                            FILE_OPEN,
00362                            0,
00363                            (PVOID) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00364                            0 );
00365 
00366     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00367         ZwClose( fsHandle );
00368     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (status != STATUS_OBJECT_NAME_NOT_FOUND) {
00369         status = STATUS_SUCCESS;
00370     }
00371 
00372     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00373         <span class="keywordflow">return</span> STATUS_IMAGE_ALREADY_LOADED;
00374     }
00375 
00376     <span class="comment">//</span>
00377     <span class="comment">// Attempt to create a device object for this driver.  This device object</span>
00378     <span class="comment">// will be used to represent the driver as an active file system in the</span>
00379     <span class="comment">// system.</span>
00380     <span class="comment">//</span>
00381 
00382     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;nameString, FileSystemName );
00383 
00384     status = <a class="code" href="../../d4/d6/iosubs_8c.html#a45">IoCreateDevice</a>( DriverObject,
00385                              <span class="keyword">sizeof</span>( <a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html">DEVICE_EXTENSION</a> ),
00386                              &amp;nameString,
00387                              DeviceType,
00388                              0,
00389                              <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00390                              &amp;deviceObject );
00391     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00392         <span class="keywordflow">return</span> status;
00393     }
00394 
00395     <span class="comment">//</span>
00396     <span class="comment">// Initialize the device extension for this device object.</span>
00397     <span class="comment">//</span>
00398 
00399     deviceExtension = (<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html">PDEVICE_EXTENSION</a>) deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o11">DeviceExtension</a>;
00400     deviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o1">FileSystemType</a> = FileSystemType;
00401     deviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o2">State</a> = <a class="code" href="../../d7/d7/fs__rec_8h.html#a39a20">Active</a>;
00402 
00403     <span class="comment">//</span>
00404     <span class="comment">//  Is this a filesystem being jointly recognized by recognizers for</span>
00405     <span class="comment">//  different device types?</span>
00406     <span class="comment">//</span>
00407     
00408     <span class="keywordflow">if</span> (HeadRecognizer) {
00409 
00410         <span class="comment">//</span>
00411         <span class="comment">//  Link into the list.</span>
00412         <span class="comment">//</span>
00413         
00414         deviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o0">CoRecognizer</a> = ((<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html">PDEVICE_EXTENSION</a>)HeadRecognizer-&gt;DeviceExtension)-&gt;CoRecognizer;
00415         ((<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html">PDEVICE_EXTENSION</a>)HeadRecognizer-&gt;DeviceExtension)-&gt;CoRecognizer = deviceObject;
00416     
00417     } <span class="keywordflow">else</span> {
00418 
00419         <span class="comment">//</span>
00420         <span class="comment">//  Initialize the list of codependant recognizer objects.</span>
00421         <span class="comment">//</span>
00422         
00423         deviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o0">CoRecognizer</a> = deviceObject;
00424     }
00425     
00426 <span class="preprocessor">#if _PNP_POWER_</span>
00427 <span class="preprocessor"></span>    deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;PowerControlNeeded = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00428 <span class="preprocessor">#endif</span>
00429 <span class="preprocessor"></span>
00430     <span class="comment">//</span>
00431     <span class="comment">// Finally, register this driver as an active, loaded file system and</span>
00432     <span class="comment">// return to the caller.</span>
00433     <span class="comment">//</span>
00434 
00435     <span class="keywordflow">if</span> (NewRecognizer) {
00436 
00437         *NewRecognizer = deviceObject;
00438     }
00439 
00440     <a class="code" href="../../d4/d6/iosubs_8c.html#a97">IoRegisterFileSystem</a>( deviceObject );
00441     <span class="keywordflow">return</span> STATUS_SUCCESS;
00442 }
00443 
00444 
00445 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00446"></a><a class="code" href="../../d7/d7/fs__rec_8h.html#a27">00446</a> <a class="code" href="../../d7/d7/fs__rec_8h.html#a27">FsRecFsControl</a> (
00447     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject,
00448     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp
00449     )
00450 
00451 <span class="comment">/*++</span>
00452 <span class="comment"></span>
00453 <span class="comment">Routine Description:</span>
00454 <span class="comment"></span>
00455 <span class="comment">    This function performs the mount and driver reload functions for this mini-</span>
00456 <span class="comment">    file system recognizer driver.</span>
00457 <span class="comment"></span>
00458 <span class="comment">Arguments:</span>
00459 <span class="comment"></span>
00460 <span class="comment">    DeviceObject - Pointer to this driver's device object.</span>
00461 <span class="comment"></span>
00462 <span class="comment">    Irp - Pointer to the I/O Request Packet (IRP) representing the function to</span>
00463 <span class="comment">        be performed.</span>
00464 <span class="comment"></span>
00465 <span class="comment">Return Value:</span>
00466 <span class="comment"></span>
00467 <span class="comment">    The function value is the final status of the operation.</span>
00468 <span class="comment"></span>
00469 <span class="comment"></span>
00470 <span class="comment">--*/</span>
00471 
00472 {
00473     <a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html">PDEVICE_EXTENSION</a> deviceExtension;
00474     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
00475     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00476 
00477     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00478 
00479     <span class="comment">//</span>
00480     <span class="comment">// Simply vector to the appropriate FS control function given the type</span>
00481     <span class="comment">// of file system being interrogated.</span>
00482     <span class="comment">//</span>
00483 
00484     deviceExtension = (<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html">PDEVICE_EXTENSION</a>) DeviceObject-&gt;DeviceExtension;
00485     irpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00486 
00487     <span class="comment">//</span>
00488     <span class="comment">//  Handle the inactive recognizer states directly.</span>
00489     <span class="comment">//</span>
00490     
00491     <span class="keywordflow">if</span> (deviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o2">State</a> != <a class="code" href="../../d7/d7/fs__rec_8h.html#a39a20">Active</a> &amp;&amp; irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> == <a class="code" href="../../d0/d5/io_8h.html#a47">IRP_MN_MOUNT_VOLUME</a>) {
00492         
00493         <span class="keywordflow">if</span> (deviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o2">State</a> == <a class="code" href="../../d7/d7/fs__rec_8h.html#a39a21">Transparent</a>) {
00494 
00495             status = STATUS_UNRECOGNIZED_VOLUME;
00496         
00497         } <span class="keywordflow">else</span> {
00498         
00499             status = STATUS_FS_DRIVER_REQUIRED;
00500         }
00501 
00502         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = status;
00503         <a class="code" href="../../d0/d5/io_8h.html#a224">IoCompleteRequest</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, <a class="code" href="../../d7/d8/exboosts_8h.html#a3">IO_NO_INCREMENT</a> );
00504         <span class="keywordflow">return</span> status;
00505     }
00506 
00507     <span class="keywordflow">switch</span> ( deviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o1">FileSystemType</a> ) {
00508 
00509         <span class="keywordflow">case</span> <a class="code" href="../../d7/d7/fs__rec_8h.html#a38a16">FatFileSystem</a>:
00510 
00511             status = <a class="code" href="../../d7/d7/fs__rec_8h.html#a35">FatRecFsControl</a>( DeviceObject, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00512             <span class="keywordflow">break</span>;
00513 
00514         <span class="keywordflow">case</span> <a class="code" href="../../d7/d7/fs__rec_8h.html#a38a18">NtfsFileSystem</a>:
00515 
00516             status = <a class="code" href="../../d2/d8/ntfs__rec_8c.html#a1">NtfsRecFsControl</a>( DeviceObject, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00517             <span class="keywordflow">break</span>;
00518 
00519         <span class="keywordflow">case</span> <a class="code" href="../../d7/d7/fs__rec_8h.html#a38a15">CdfsFileSystem</a>:
00520 
00521             status = <a class="code" href="../../d7/d7/fs__rec_8h.html#a33">CdfsRecFsControl</a>( DeviceObject, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00522             <span class="keywordflow">break</span>;
00523 
00524         <span class="keywordflow">case</span> <a class="code" href="../../d7/d7/fs__rec_8h.html#a38a19">UdfsFileSystem</a>:
00525 
00526             status = <a class="code" href="../../d4/d8/udfs__rec_8c.html#a2">UdfsRecFsControl</a>( DeviceObject, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00527             <span class="keywordflow">break</span>;
00528 
00529         <span class="keywordflow">default</span>:
00530 
00531             status = STATUS_INVALID_DEVICE_REQUEST;
00532     }
00533 
00534     <span class="keywordflow">return</span> status;
00535 }
00536 
00537 
00538 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00539"></a><a class="code" href="../../d7/d7/fs__rec_8h.html#a28">00539</a> <a class="code" href="../../d7/d7/fs__rec_8h.html#a28">FsRecUnload</a> (
00540     IN <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject
00541     )
00542 
00543 <span class="comment">/*++</span>
00544 <span class="comment"></span>
00545 <span class="comment">Routine Description:</span>
00546 <span class="comment"></span>
00547 <span class="comment">    This routine cleans up the driver's data structures so that it can be</span>
00548 <span class="comment">    unloaded.</span>
00549 <span class="comment"></span>
00550 <span class="comment">Arguments:</span>
00551 <span class="comment"></span>
00552 <span class="comment">    DriverObject - Pointer to the driver object for this driver.</span>
00553 <span class="comment"></span>
00554 <span class="comment">Return Value:</span>
00555 <span class="comment"></span>
00556 <span class="comment">    None.</span>
00557 <span class="comment"></span>
00558 <span class="comment">--*/</span>
00559 
00560 {
00561     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00562 
00563     <span class="comment">//</span>
00564     <span class="comment">// Simply delete all of the device objects that this driver has created, the</span>
00565     <span class="comment">// load event, and return.</span>
00566     <span class="comment">//</span>
00567 
00568     <span class="keywordflow">while</span> (DriverObject-&gt;DeviceObject) {
00569         <a class="code" href="../../d4/d6/iosubs_8c.html#a55">IoDeleteDevice</a>( DriverObject-&gt;DeviceObject );
00570     }
00571 
00572     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( <a class="code" href="../../d6/d7/fs__rec_8c.html#a2">FsRecLoadSync</a> );
00573 
00574     <span class="keywordflow">return</span>;
00575 }
00576 
00577 
00578 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00579"></a><a class="code" href="../../d7/d7/fs__rec_8h.html#a29">00579</a> <a class="code" href="../../d7/d7/fs__rec_8h.html#a29">FsRecLoadFileSystem</a> (
00580     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject,
00581     IN PWCHAR DriverServiceName
00582     )
00583 
00584 <span class="comment">/*++</span>
00585 <span class="comment"></span>
00586 <span class="comment"></span>
00587 <span class="comment">Routine Description:</span>
00588 <span class="comment"></span>
00589 <span class="comment">    This routine performs the common work of loading a filesystem on behalf</span>
00590 <span class="comment">    of one of our recognizers.</span>
00591 <span class="comment"></span>
00592 <span class="comment">Arguments:</span>
00593 <span class="comment"></span>
00594 <span class="comment">    DeviceObject - Pointer to the device object for the recognizer.</span>
00595 <span class="comment"></span>
00596 <span class="comment">    DriverServiceName - Specifies the name of the node in the registry</span>
00597 <span class="comment">        associated with the driver to be loaded.</span>
00598 <span class="comment"></span>
00599 <span class="comment">Return Value:</span>
00600 <span class="comment"></span>
00601 <span class="comment">    NTSTATUS.  The recognizer will be set into a transparent mode on return.</span>
00602 <span class="comment">    </span>
00603 <span class="comment">--*/</span>
00604 
00605 {
00606     UNICODE_STRING driverName;
00607     <a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html">PDEVICE_EXTENSION</a> deviceExtension = (<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html">PDEVICE_EXTENSION</a>) DeviceObject-&gt;DeviceExtension;
00608     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_IMAGE_ALREADY_LOADED;
00609 
00610     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00611 
00612     <span class="comment">//</span>
00613     <span class="comment">//  Quickly check if the recognizer has already fired.</span>
00614     <span class="comment">//</span>
00615     
00616     <span class="keywordflow">if</span> (deviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o2">State</a> != <a class="code" href="../../d7/d7/fs__rec_8h.html#a39a21">Transparent</a>) {
00617     
00618         <span class="comment">//</span>
00619         <span class="comment">//  Serialize all threads trying to load this filesystem.</span>
00620         <span class="comment">//</span>
00621         <span class="comment">//  We need to do this for several reasons.  With the new behavior in</span>
00622         <span class="comment">//  IoRegisterFileSystem, we do not know ahead of time whether the</span>
00623         <span class="comment">//  filesystem has been loaded ahead or behind this recognizer in the</span>
00624         <span class="comment">//  scan queue.  This means that we cannot make this recognizer transparent</span>
00625         <span class="comment">//  before the real filesystem has become registered, or else if the</span>
00626         <span class="comment">//  filesystem loads behind us we may let threads go through that will</span>
00627         <span class="comment">//  not find it in that window of time.</span>
00628         <span class="comment">//</span>
00629         <span class="comment">//  The reason this is possible is that NtLoadDriver does not guarantee</span>
00630         <span class="comment">//  that if it returns STATUS_IMAGE_ALREADY_LOADED, that the driver in</span>
00631         <span class="comment">//  question has actually initialized itself, which *is* guaranteed if</span>
00632         <span class="comment">//  it returns STATUS_SUCCESS.  We have to keep these threads bottled</span>
00633         <span class="comment">//  up until they can rescan with the promise that what they need is there.</span>
00634         <span class="comment">//</span>
00635         <span class="comment">//  As a bonus, we can now guarantee that the recognizer goes away in</span>
00636         <span class="comment">//  all cases, not just when the driver successfully loads itself.</span>
00637         <span class="comment">//</span>
00638         
00639         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( <a class="code" href="../../d6/d7/fs__rec_8c.html#a2">FsRecLoadSync</a>,
00640                                <a class="code" href="../../d6/d7/halmips_8h.html#a455">Executive</a>,
00641                                <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00642                                <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00643                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00644         <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00645     
00646         <span class="comment">//</span>
00647         <span class="comment">//  Attempt the filesystem load precisely once for all recognizers</span>
00648         <span class="comment">//  of a given filesystem.</span>
00649         <span class="comment">//</span>
00650         
00651         <span class="keywordflow">if</span> (deviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o2">State</a> == <a class="code" href="../../d7/d7/fs__rec_8h.html#a39a20">Active</a>) {
00652 
00653             <span class="comment">//</span>
00654             <span class="comment">//  For bonus points, in the future we may want to log an event</span>
00655             <span class="comment">//  on failure.</span>
00656             <span class="comment">//</span>
00657 
00658             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;driverName, DriverServiceName );
00659             status = <a class="code" href="../../d7/d7/fs__rec_8h.html#a37">ZwLoadDriver</a>( &amp;driverName );
00660 
00661             <span class="comment">//</span>
00662             <span class="comment">//  Now walk all codependant recognizers and instruct them to go</span>
00663             <span class="comment">//  into the fast unload state.  Since IO only expects the fsDO</span>
00664             <span class="comment">//  it is asking to load a filesystem to to unregister itself, if</span>
00665             <span class="comment">//  we unregistered all of the co-recognizers they would dangle.</span>
00666             <span class="comment">//  Unfortunately, this means that fsrec may wind up hanging around</span>
00667             <span class="comment">//  quite a bit longer than strictly neccesary.</span>
00668             <span class="comment">//</span>
00669             <span class="comment">//  Note: we come right back to the original DeviceObject at the</span>
00670             <span class="comment">//  end of this loop (important).  It is also very important that</span>
00671             <span class="comment">//  we only did this once since after we release the mutex the co-</span>
00672             <span class="comment">//  recognizers may begin going away in any order.</span>
00673             <span class="comment">//</span>
00674 
00675             <span class="keywordflow">while</span> (deviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o2">State</a> != <a class="code" href="../../d7/d7/fs__rec_8h.html#a39a22">FastUnload</a>) {
00676 
00677                 deviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o2">State</a> = <a class="code" href="../../d7/d7/fs__rec_8h.html#a39a22">FastUnload</a>;
00678 
00679                 DeviceObject = deviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o0">CoRecognizer</a>;
00680                 deviceExtension = DeviceObject-&gt;DeviceExtension;
00681             } 
00682         }
00683         
00684         <span class="comment">//</span>
00685         <span class="comment">//  Unregister this recognizer precisely once.</span>
00686         <span class="comment">//</span>
00687 
00688         <span class="keywordflow">if</span> (deviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o2">State</a> != <a class="code" href="../../d7/d7/fs__rec_8h.html#a39a21">Transparent</a>) {
00689             
00690             <a class="code" href="../../d4/d6/iosubs_8c.html#a118">IoUnregisterFileSystem</a>( DeviceObject );
00691             deviceExtension-&gt;<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html#o2">State</a> = <a class="code" href="../../d7/d7/fs__rec_8h.html#a39a21">Transparent</a>;
00692         }
00693         
00694         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( <a class="code" href="../../d6/d7/fs__rec_8c.html#a2">FsRecLoadSync</a>, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00695         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00696     }
00697     
00698     <span class="keywordflow">return</span> status;
00699 }
00700 
00701 
00702 BOOLEAN
<a name="l00703"></a><a class="code" href="../../d7/d7/fs__rec_8h.html#a31">00703</a> <a class="code" href="../../d7/d7/fs__rec_8h.html#a31">FsRecGetDeviceSectors</a> (
00704     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject,
00705     IN ULONG BytesPerSector,
00706     OUT PLARGE_INTEGER NumberOfSectors
00707     )
00708 
00709 <span class="comment">/*++</span>
00710 <span class="comment"></span>
00711 <span class="comment">Routine Description:</span>
00712 <span class="comment"></span>
00713 <span class="comment">    This routine returns information about the partition represented by the</span>
00714 <span class="comment">    device object.</span>
00715 <span class="comment"></span>
00716 <span class="comment">Arguments:</span>
00717 <span class="comment"></span>
00718 <span class="comment">    DeviceObject - Pointer to the device object from which to read.</span>
00719 <span class="comment"></span>
00720 <span class="comment">    BytesPerSector - The number of bytes per sector for the device being read.</span>
00721 <span class="comment"></span>
00722 <span class="comment">    NumberOfSectors - Variable to receive the number of sectors for this</span>
00723 <span class="comment">        partition.</span>
00724 <span class="comment"></span>
00725 <span class="comment">Return Value:</span>
00726 <span class="comment"></span>
00727 <span class="comment">    The function value is TRUE if the information was found, otherwise FALSE.</span>
00728 <span class="comment"></span>
00729 <span class="comment">--*/</span>
00730 
00731 {
00732     PARTITION_INFORMATION partitionInfo;
00733     IO_STATUS_BLOCK ioStatus;
00734     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> event;
00735     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
00736     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00737     ULONG remainder;
00738 
00739     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00740 
00741     <span class="comment">//</span>
00742     <span class="comment">//  We only do this for disks right now. This is likely to change when we</span>
00743     <span class="comment">//  have to recognize CDUDF media.</span>
00744     <span class="comment">//</span>
00745 
00746     <span class="keywordflow">if</span> (DeviceObject-&gt;DeviceType != FILE_DEVICE_DISK) {
00747 
00748         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00749     }
00750 
00751     <span class="comment">//</span>
00752     <span class="comment">// Get the number of sectors on this partition.</span>
00753     <span class="comment">//</span>
00754 
00755     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;event, SynchronizationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00756 
00757     irp = <a class="code" href="../../d4/d6/iosubs_8c.html#a25">IoBuildDeviceIoControlRequest</a>( IOCTL_DISK_GET_PARTITION_INFO,
00758                                          DeviceObject,
00759                                          (PVOID) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00760                                          0,
00761                                          &amp;partitionInfo,
00762                                          <span class="keyword">sizeof</span>( partitionInfo ),
00763                                          <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00764                                          &amp;event,
00765                                          &amp;ioStatus );
00766     <span class="keywordflow">if</span> (!irp) {
00767         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00768     }
00769 
00770     <span class="comment">//</span>
00771     <span class="comment">//  Override verify logic - we don't care. The fact we're in the picture means</span>
00772     <span class="comment">//  someone is trying to mount new/changed media in the first place.</span>
00773     <span class="comment">//</span>
00774     
00775     <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( irp )-&gt;Flags, <a class="code" href="../../d0/d5/io_8h.html#a203">SL_OVERRIDE_VERIFY_VOLUME</a> );
00776 
00777     status = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( DeviceObject, irp );
00778     <span class="keywordflow">if</span> (status == STATUS_PENDING) {
00779         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;event,
00780                                       <a class="code" href="../../d6/d7/halmips_8h.html#a455">Executive</a>,
00781                                       <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00782                                       <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00783                                       (PLARGE_INTEGER) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00784         status = ioStatus.Status;
00785     }
00786 
00787     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00788         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00789     }
00790 
00791     *NumberOfSectors = <a class="code" href="../../d0/d1/largeic_8c.html#a0">RtlExtendedLargeIntegerDivide</a>( partitionInfo.PartitionLength,
00792                                                       BytesPerSector,
00793                                                       &amp;remainder );
00794 
00795     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00796 }
00797 
00798 
00799 BOOLEAN
<a name="l00800"></a><a class="code" href="../../d7/d7/fs__rec_8h.html#a30">00800</a> <a class="code" href="../../d7/d7/fs__rec_8h.html#a30">FsRecGetDeviceSectorSize</a> (
00801     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject,
00802     OUT PULONG BytesPerSector
00803     )
00804 
00805 <span class="comment">/*++</span>
00806 <span class="comment"></span>
00807 <span class="comment">Routine Description:</span>
00808 <span class="comment"></span>
00809 <span class="comment">    This routine returns the sector size of the underlying device.</span>
00810 <span class="comment"></span>
00811 <span class="comment">Arguments:</span>
00812 <span class="comment"></span>
00813 <span class="comment">    DeviceObject - Pointer to the device object from which to read.</span>
00814 <span class="comment"></span>
00815 <span class="comment">    BytesPerSector - Variable to receive the number of bytes per sector for the</span>
00816 <span class="comment">        device being read.</span>
00817 <span class="comment"></span>
00818 <span class="comment">Return Value:</span>
00819 <span class="comment"></span>
00820 <span class="comment">    The function value is TRUE if the information was found, otherwise FALSE.</span>
00821 <span class="comment"></span>
00822 <span class="comment">--*/</span>
00823 
00824 {
00825     DISK_GEOMETRY diskGeometry;
00826     IO_STATUS_BLOCK ioStatus;
00827     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> event;
00828     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
00829     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00830     ULONG ControlCode;
00831 
00832     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00833 
00834     <span class="comment">//</span>
00835     <span class="comment">//  Figure out what kind of device we have so we can use the right IOCTL.</span>
00836     <span class="comment">//</span>
00837 
00838     <span class="keywordflow">switch</span> (DeviceObject-&gt;DeviceType) {
00839         <span class="keywordflow">case</span> FILE_DEVICE_CD_ROM:
00840             ControlCode = IOCTL_CDROM_GET_DRIVE_GEOMETRY;
00841             <span class="keywordflow">break</span>;
00842 
00843         <span class="keywordflow">case</span> FILE_DEVICE_DISK:
00844             ControlCode = IOCTL_DISK_GET_DRIVE_GEOMETRY;
00845             <span class="keywordflow">break</span>;
00846 
00847         <span class="keywordflow">default</span>:
00848             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00849     }
00850 
00851     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;event, SynchronizationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00852     irp = <a class="code" href="../../d4/d6/iosubs_8c.html#a25">IoBuildDeviceIoControlRequest</a>( ControlCode,
00853                                          DeviceObject,
00854                                          (PVOID) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00855                                          0,
00856                                          &amp;diskGeometry,
00857                                          <span class="keyword">sizeof</span>( diskGeometry ),
00858                                          <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00859                                          &amp;event,
00860                                          &amp;ioStatus );
00861 
00862     <span class="keywordflow">if</span> (!irp) {
00863         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00864     }
00865 
00866     <span class="comment">//</span>
00867     <span class="comment">//  Override verify logic - we don't care. The fact we're in the picture means</span>
00868     <span class="comment">//  someone is trying to mount new/changed media in the first place.</span>
00869     <span class="comment">//</span>
00870     
00871     <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( irp )-&gt;Flags, <a class="code" href="../../d0/d5/io_8h.html#a203">SL_OVERRIDE_VERIFY_VOLUME</a> );
00872     
00873     status = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( DeviceObject, irp );
00874     <span class="keywordflow">if</span> (status == STATUS_PENDING) {
00875         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;event,
00876                                       <a class="code" href="../../d6/d7/halmips_8h.html#a455">Executive</a>,
00877                                       <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00878                                       <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00879                                       (PLARGE_INTEGER) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00880         status = ioStatus.Status;
00881     }
00882 
00883     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00884         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00885     }
00886 
00887     <span class="comment">//</span>
00888     <span class="comment">// Ensure that the drive actually knows how many bytes there are per</span>
00889     <span class="comment">// sector.  Floppy drives do not know if the media is unformatted.</span>
00890     <span class="comment">//</span>
00891 
00892     <span class="keywordflow">if</span> (!diskGeometry.BytesPerSector) {
00893         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00894     }
00895 
00896     <span class="comment">//</span>
00897     <span class="comment">// Store the return values for the caller.</span>
00898     <span class="comment">//</span>
00899 
00900     *BytesPerSector = diskGeometry.BytesPerSector;
00901 
00902     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00903 }
00904 
00905 
00906 BOOLEAN
<a name="l00907"></a><a class="code" href="../../d7/d7/fs__rec_8h.html#a32">00907</a> <a class="code" href="../../d7/d7/fs__rec_8h.html#a32">FsRecReadBlock</a>(
00908     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject,
00909     IN PLARGE_INTEGER ByteOffset,
00910     IN ULONG MinimumBytes,
00911     IN ULONG BytesPerSector,
00912     OUT PVOID *Buffer,
00913     OUT PBOOLEAN IsDeviceFailure OPTIONAL
00914     )
00915 
00916 <span class="comment">/*++</span>
00917 <span class="comment"></span>
00918 <span class="comment">Routine Description:</span>
00919 <span class="comment"></span>
00920 <span class="comment">    This routine reads a minimum numbers of bytes into a buffer starting at</span>
00921 <span class="comment">    the byte offset from the base of the device represented by the device</span>
00922 <span class="comment">    object.</span>
00923 <span class="comment"></span>
00924 <span class="comment">Arguments:</span>
00925 <span class="comment"></span>
00926 <span class="comment">    DeviceObject - Pointer to the device object from which to read.</span>
00927 <span class="comment"></span>
00928 <span class="comment">    ByteOffset - Pointer to a 64-bit byte offset from the base of the device</span>
00929 <span class="comment">        from which to start the read.</span>
00930 <span class="comment"></span>
00931 <span class="comment">    MinimumBytes - Supplies the minimum number of bytes to be read.</span>
00932 <span class="comment"></span>
00933 <span class="comment">    BytesPerSector - The number of bytes per sector for the device being read.</span>
00934 <span class="comment"></span>
00935 <span class="comment">    Buffer - Variable to receive a pointer to the allocated buffer containing</span>
00936 <span class="comment">        the bytes read.</span>
00937 <span class="comment">        </span>
00938 <span class="comment">    IsDeviceFailure - Variable to receive an indication whether a failure</span>
00939 <span class="comment">        was a result of talking to the device.</span>
00940 <span class="comment"></span>
00941 <span class="comment">Return Value:</span>
00942 <span class="comment"></span>
00943 <span class="comment">    The function value is TRUE if the bytes were read, otherwise FALSE.</span>
00944 <span class="comment"></span>
00945 <span class="comment">--*/</span>
00946 
00947 {
00948 <span class="preprocessor">    #define RoundUp( x, y ) ( ((x + (y-1)) / y) * y )</span>
00949 <span class="preprocessor"></span>
00950     IO_STATUS_BLOCK ioStatus;
00951     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> event;
00952     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
00953     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00954 
00955     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00956 
00957     <span class="keywordflow">if</span> (IsDeviceFailure) {
00958         *IsDeviceFailure = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00959     }
00960     
00961     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;event, SynchronizationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00962 
00963     <span class="comment">//</span>
00964     <span class="comment">// Set the minimum number of bytes to read to the maximum of the bytes that</span>
00965     <span class="comment">// the caller wants to read, and the number of bytes in a sector.</span>
00966     <span class="comment">//</span>
00967 
00968     <span class="keywordflow">if</span> (MinimumBytes &lt; BytesPerSector) {
00969         MinimumBytes = BytesPerSector;
00970     } <span class="keywordflow">else</span> {
00971         MinimumBytes = <a class="code" href="../../d6/d7/fs__rec_8c.html#a1">RoundUp</a>( MinimumBytes, BytesPerSector );
00972     }
00973 
00974     <span class="comment">//</span>
00975     <span class="comment">// Allocate a buffer large enough to contain the bytes required, round the</span>
00976     <span class="comment">// request to a page boundary to solve any alignment requirements.</span>
00977     <span class="comment">//</span>
00978 
00979     <span class="keywordflow">if</span> (!*<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>) {
00980 
00981         *<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
00982                                          (MinimumBytes + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1) &amp; ~(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1),
00983                                          <a class="code" href="../../d7/d7/fs__rec_8h.html#a5">FSREC_POOL_TAG</a> );
00984         <span class="keywordflow">if</span> (!*<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>) {
00985             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00986         }
00987     }
00988 
00989     <span class="comment">//</span>
00990     <span class="comment">// Read the actual bytes off of the media.</span>
00991     <span class="comment">//</span>
00992 
00993     irp = <a class="code" href="../../d4/d6/iosubs_8c.html#a27">IoBuildSynchronousFsdRequest</a>( <a class="code" href="../../d0/d5/io_8h.html#a16">IRP_MJ_READ</a>,
00994                                         DeviceObject,
00995                                         *<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00996                                         MinimumBytes,
00997                                         ByteOffset,
00998                                         &amp;event,
00999                                         &amp;ioStatus );
01000     <span class="keywordflow">if</span> (!irp) {
01001         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01002     }
01003     
01004     <span class="comment">//</span>
01005     <span class="comment">//  Override verify logic - we don't care. The fact we're in the picture means</span>
01006     <span class="comment">//  someone is trying to mount new/changed media in the first place.</span>
01007     <span class="comment">//</span>
01008     
01009     <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( irp )-&gt;Flags, <a class="code" href="../../d0/d5/io_8h.html#a203">SL_OVERRIDE_VERIFY_VOLUME</a> );
01010 
01011     status = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( DeviceObject, irp );
01012     <span class="keywordflow">if</span> (status == STATUS_PENDING) {
01013         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;event,
01014                                       <a class="code" href="../../d6/d7/halmips_8h.html#a455">Executive</a>,
01015                                       <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
01016                                       <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01017                                       (PLARGE_INTEGER) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
01018         status = ioStatus.Status;
01019     }
01020 
01021     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01022 
01023         <span class="keywordflow">if</span> (IsDeviceFailure) {
01024             *IsDeviceFailure = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01025         }
01026         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01027     }
01028 
01029     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01030 }
01031 
01032 
01033 <span class="preprocessor">#if DBG</span>
01034 <span class="preprocessor"></span>BOOLEAN
01035 FsRecDebugTrace (
01036     LONG IndentIncrement,
01037     ULONG TraceMask,
01038     PCHAR Format,
01039     ...
01040     )
01041 
01042 <span class="comment">/*++</span>
01043 <span class="comment"></span>
01044 <span class="comment">Routine Description:</span>
01045 <span class="comment"></span>
01046 <span class="comment">    This routine is a simple debug info printer that returns a constant boolean value.  This</span>
01047 <span class="comment">    makes it possible to splice it into the middle of boolean expressions to discover which</span>
01048 <span class="comment">    elements are firing.</span>
01049 <span class="comment">    </span>
01050 <span class="comment">    We will use this as our general debug printer.  See udfdata.h for how we use the DebugTrace</span>
01051 <span class="comment">    macro to accomplish the effect.</span>
01052 <span class="comment">    </span>
01053 <span class="comment">Arguments:</span>
01054 <span class="comment"></span>
01055 <span class="comment">    IndentIncrement - amount to change the indentation by.</span>
01056 <span class="comment">    </span>
01057 <span class="comment">    TraceMask - specification of what debug trace level this call should be noisy at.</span>
01058 <span class="comment"></span>
01059 <span class="comment">Return Value:</span>
01060 <span class="comment"></span>
01061 <span class="comment">    USHORT - The 16bit CRC</span>
01062 <span class="comment"></span>
01063 <span class="comment">--*/</span>
01064 
01065 {
01066     va_list Arglist;
01067     LONG i;
01068     UCHAR <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[128];
01069     <span class="keywordtype">int</span> Bytes;
01070 
01071 <span class="preprocessor">#define Min(a, b)   ((a) &lt; (b) ? (a) : (b))</span>
01072 <span class="preprocessor"></span>    
01073     <span class="keywordflow">if</span> (TraceMask == 0 || (FsRecDebugTraceLevel &amp; TraceMask) != 0) {
01074 
01075         <span class="comment">//</span>
01076         <span class="comment">//  Emit a preamble of our thread ID.</span>
01077         <span class="comment">//</span>
01078         
01079         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"%p:"</span>, <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>());
01080 
01081         <span class="keywordflow">if</span> (IndentIncrement &lt; 0) {
01082             
01083             FsRecDebugTraceIndent += IndentIncrement;
01084         }
01085 
01086         <span class="keywordflow">if</span> (FsRecDebugTraceIndent &lt; 0) {
01087             
01088             FsRecDebugTraceIndent = 0;
01089         }
01090 
01091         <span class="comment">//</span>
01092         <span class="comment">//  Build the indent in big chunks since calling DbgPrint repeatedly is expensive.</span>
01093         <span class="comment">//</span>
01094         
01095         <span class="keywordflow">for</span> (i = FsRecDebugTraceIndent; i &gt; 0; i -= (<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>) - 1)) {
01096 
01097             RtlFillMemory( Buffer, <a class="code" href="../../d3/d8/udfprocs_8h.html#a3">Min</a>( i, (<span class="keyword">sizeof</span>(Buffer) - 1 )), <span class="charliteral">' '</span>);
01098             *(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> + <a class="code" href="../../d3/d8/udfprocs_8h.html#a3">Min</a>( i, (<span class="keyword">sizeof</span>(Buffer) - 1 ))) = <span class="charliteral">'\0'</span>;
01099             
01100             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( Buffer );
01101         }
01102 
01103         <span class="comment">//</span>
01104         <span class="comment">// Format the output into a buffer and then print it.</span>
01105         <span class="comment">//</span>
01106 
01107         va_start( Arglist, Format );
01108         Bytes = _vsnprintf( Buffer, <span class="keyword">sizeof</span>(Buffer), Format, Arglist );
01109         va_end( Arglist );
01110 
01111         <span class="comment">//</span>
01112         <span class="comment">// detect buffer overflow</span>
01113         <span class="comment">//</span>
01114 
01115         <span class="keywordflow">if</span> (Bytes == -1) {
01116 
01117             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>) - 1] = <span class="charliteral">'\n'</span>;
01118         }
01119 
01120         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( Buffer );
01121 
01122         <span class="keywordflow">if</span> (IndentIncrement &gt; 0) {
01123 
01124             FsRecDebugTraceIndent += IndentIncrement;
01125         }
01126     }
01127 
01128     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01129 }
01130 <span class="preprocessor">#endif</span>
01131 <span class="preprocessor"></span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:04 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
