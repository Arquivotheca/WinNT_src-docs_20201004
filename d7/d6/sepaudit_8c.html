<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: sepaudit.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>sepaudit.c File Reference</h1><code>#include &lt;nt.h&gt;</code><br>
<code>#include &lt;ntlsa.h&gt;</code><br>
<code>#include &lt;msaudite.h&gt;</code><br>
<code>#include "<a class="el" href="../../d9/d2/tokenp_8h-source.html">tokenp.h</a>"</code><br>
<code>#include "<a class="el" href="../../d8/d3/adt_8h-source.html">adt.h</a>"</code><br>
<code>#include "<a class="el" href="../../d2/d4/adtp_8h-source.html">adtp.h</a>"</code><br>

<p>
<a href="../../d8/d5/sepaudit_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/sepaudit_8c.html#a0">SepSetParmTypeSid</a>(AuditParameters, <a class="el" href="../../d7/d0/cmdat2_8c.html#a27">Index</a>, Sid)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/sepaudit_8c.html#a1">SepSetParmTypeString</a>(AuditParameters, <a class="el" href="../../d7/d0/cmdat2_8c.html#a27">Index</a>, <a class="el" href="../../d0/d0/tdetach_8c.html#a0">String</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/sepaudit_8c.html#a2">SepSetParmTypeFileSpec</a>(AuditParameters, <a class="el" href="../../d7/d0/cmdat2_8c.html#a27">Index</a>, <a class="el" href="../../d0/d0/tdetach_8c.html#a0">String</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/sepaudit_8c.html#a3">SepSetParmTypeUlong</a>(AuditParameters, <a class="el" href="../../d7/d0/cmdat2_8c.html#a27">Index</a>, Ulong)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/sepaudit_8c.html#a4">SepSetParmTypeNoLogon</a>(AuditParameters, <a class="el" href="../../d7/d0/cmdat2_8c.html#a27">Index</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/sepaudit_8c.html#a5">SepSetParmTypeLogonId</a>(AuditParameters, <a class="el" href="../../d7/d0/cmdat2_8c.html#a27">Index</a>, LogonId)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/sepaudit_8c.html#a6">SepSetParmTypeAccessMask</a>(AuditParameters, <a class="el" href="../../d7/d0/cmdat2_8c.html#a27">Index</a>, AccessMask, ObjectTypeIndex)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/sepaudit_8c.html#a7">SepSetParmTypePrivileges</a>(AuditParameters, <a class="el" href="../../d7/d0/cmdat2_8c.html#a27">Index</a>, Privileges)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/sepaudit_8c.html#a8">SepSetParmTypeObjectTypes</a>(AuditParameters, <a class="el" href="../../d7/d0/cmdat2_8c.html#a27">Index</a>, ObjectTypes, ObjectTypeCount, ObjectTypeIndex)</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/sepaudit_8c.html#a9">SepAdtPrivilegeObjectAuditAlarm</a> (IN PUNICODE_STRING CapturedSubsystemName OPTIONAL, IN PVOID HandleId, IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a> <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a11">ClientToken</a> OPTIONAL, IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a> <a class="el" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a>, IN PVOID ProcessId, IN ACCESS_MASK DesiredAccess, IN PPRIVILEGE_SET CapturedPrivileges, IN BOOLEAN AccessGranted)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/sepaudit_8c.html#a10">SepAdtPrivilegedServiceAuditAlarm</a> (IN PUNICODE_STRING CapturedSubsystemName, IN PUNICODE_STRING CapturedServiceName, IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a> <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a11">ClientToken</a> OPTIONAL, IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a> <a class="el" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a>, IN PPRIVILEGE_SET CapturedPrivileges, IN BOOLEAN AccessGranted)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/sepaudit_8c.html#a11">SepAdtOpenObjectAuditAlarm</a> (IN PUNICODE_STRING CapturedSubsystemName, IN PVOID *HandleId OPTIONAL, IN PUNICODE_STRING CapturedObjectTypeName, IN PVOID Object OPTIONAL, IN PUNICODE_STRING CapturedObjectName OPTIONAL, IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a> <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a11">ClientToken</a> OPTIONAL, IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a> <a class="el" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a>, IN ACCESS_MASK DesiredAccess, IN ACCESS_MASK GrantedAccess, IN PLUID OperationId, IN PPRIVILEGE_SET CapturedPrivileges OPTIONAL, IN BOOLEAN ObjectCreated, IN BOOLEAN AccessGranted, IN BOOLEAN GenerateAudit, IN BOOLEAN GenerateAlarm, IN HANDLE ProcessID, IN POLICY_AUDIT_EVENT_TYPE AuditType, IN <a class="el" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">PIOBJECT_TYPE_LIST</a> ObjectTypeList OPTIONAL, IN ULONG ObjectTypeListLength, IN PACCESS_MASK GrantedAccessArray OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/sepaudit_8c.html#a12">SepAdtOpenObjectForDeleteAuditAlarm</a> (IN PUNICODE_STRING CapturedSubsystemName, IN PVOID *HandleId OPTIONAL, IN PUNICODE_STRING CapturedObjectTypeName, IN PVOID Object OPTIONAL, IN PUNICODE_STRING CapturedObjectName OPTIONAL, IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a> <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a11">ClientToken</a> OPTIONAL, IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a> <a class="el" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a>, IN ACCESS_MASK DesiredAccess, IN ACCESS_MASK GrantedAccess, IN PLUID OperationId, IN PPRIVILEGE_SET CapturedPrivileges OPTIONAL, IN BOOLEAN ObjectCreated, IN BOOLEAN AccessGranted, IN BOOLEAN GenerateAudit, IN BOOLEAN GenerateAlarm, IN HANDLE ProcessID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/sepaudit_8c.html#a13">SepAdtCloseObjectAuditAlarm</a> (IN PUNICODE_STRING CapturedSubsystemName, IN PVOID HandleId, IN PVOID Object, IN PSID UserSid, IN LUID AuthenticationId)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/sepaudit_8c.html#a14">SepAdtDeleteObjectAuditAlarm</a> (IN PUNICODE_STRING CapturedSubsystemName, IN PVOID HandleId, IN PVOID Object, IN PSID UserSid, IN LUID AuthenticationId)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/sepaudit_8c.html#a15">SepAdtHandleAuditAlarm</a> (IN PUNICODE_STRING Source, IN LUID OperationId, IN HANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>, IN PSID UserSid)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">*++  <a href="#a15"></a><br><br></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/sepaudit_8c.html#a16">SepAdtObjectReferenceAuditAlarm</a> (IN PLUID OperationId OPTIONAL, IN PVOID Object, IN <a class="el" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">PSECURITY_SUBJECT_CONTEXT</a> SubjectSecurityContext, IN ACCESS_MASK DesiredAccess, IN PPRIVILEGE_SET Privileges OPTIONAL, IN BOOLEAN AccessGranted, IN BOOLEAN GenerateAudit, IN BOOLEAN GenerateAlarm)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>POBJECT_NAME_INFORMATION&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/sepaudit_8c.html#a17">SepQueryNameString</a> (IN PVOID Object)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">*++  <a href="#a17"></a><br><br></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>PUNICODE_STRING&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/sepaudit_8c.html#a18">SepQueryTypeString</a> (IN PVOID Object)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/sepaudit_8c.html#a19">SeAuditProcessCreation</a> (<a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process, <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Parent, PUNICODE_STRING ImageFileName)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/sepaudit_8c.html#a20">SeAuditHandleDuplication</a> (PVOID SourceHandle, PVOID NewHandle, <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> SourceProcess, <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> TargetProcess)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/sepaudit_8c.html#a21">SeAuditProcessExit</a> (<a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/sepaudit_8c.html#a22">SepAdtGenerateDiscardAudit</a> (VOID)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a6" doxytag="sepaudit.c::SepSetParmTypeAccessMask" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SepSetParmTypeAccessMask          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">AuditParameters,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d0/cmdat2_8c.html#a27">Index</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>AccessMask,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ObjectTypeIndex&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                                                                                    \
        (AuditParameters).Parameters[(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>)].Type = SeAdtParmTypeAccessMask;            \
        (AuditParameters).Parameters[(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>)].Length = <span class="keyword">sizeof</span>( ACCESS_MASK );            \
        (AuditParameters).Parameters[(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>)].Data[0] = (AccessMask);                    \
        (AuditParameters).Parameters[(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>)].Data[1] = (ObjectTypeIndex);               \
    }
</div></pre>
<p>
Definition at line <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00098">98</a> of file <a class="el" href="../../d8/d5/sepaudit_8c-source.html">sepaudit.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l01907">SepAdtObjectReferenceAuditAlarm()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00571">SepAdtOpenObjectAuditAlarm()</a>, and <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l01003">SepAdtOpenObjectForDeleteAuditAlarm()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="sepaudit.c::SepSetParmTypeFileSpec" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SepSetParmTypeFileSpec          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">AuditParameters,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d0/cmdat2_8c.html#a27">Index</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d0/tdetach_8c.html#a0">String</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                                                                          \
        (AuditParameters).Parameters[(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>)].Type = SeAdtParmTypeFileSpec;    \
        (AuditParameters).Parameters[(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>)].Length =                         \
                <span class="keyword">sizeof</span>(UNICODE_STRING)+(<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>)-&gt;Length;                       \
        (AuditParameters).Parameters[(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>)].Address = (<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>);              \
    }
</div></pre>
<p>
Definition at line <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00068">68</a> of file <a class="el" href="../../d8/d5/sepaudit_8c-source.html">sepaudit.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00571">SepAdtOpenObjectAuditAlarm()</a>, and <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l01003">SepAdtOpenObjectForDeleteAuditAlarm()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="sepaudit.c::SepSetParmTypeLogonId" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SepSetParmTypeLogonId          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">AuditParameters,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d0/cmdat2_8c.html#a27">Index</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LogonId&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                                                                          \
        LUID UNALIGNED * TmpLuid;                                                           \
                                                                                 \
        (AuditParameters).Parameters[(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>)].Type = SeAdtParmTypeLogonId;       \
        (AuditParameters).Parameters[(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>)].Length =  <span class="keyword">sizeof</span>( (LogonId) );     \
        TmpLuid = (LUID UNALIGNED *)(&amp;(AuditParameters).Parameters[(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>)].Data[0]);                  \
        *TmpLuid = (LogonId);                                                     \
    }
</div></pre>
<p>
Definition at line <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00088">88</a> of file <a class="el" href="../../d8/d5/sepaudit_8c-source.html">sepaudit.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l02466">SeAuditProcessCreation()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l02653">SeAuditProcessExit()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l01907">SepAdtObjectReferenceAuditAlarm()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00571">SepAdtOpenObjectAuditAlarm()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l01003">SepAdtOpenObjectForDeleteAuditAlarm()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00346">SepAdtPrivilegedServiceAuditAlarm()</a>, and <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00125">SepAdtPrivilegeObjectAuditAlarm()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="sepaudit.c::SepSetParmTypeNoLogon" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SepSetParmTypeNoLogon          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">AuditParameters,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d0/cmdat2_8c.html#a27">Index</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                                                                          \
        (AuditParameters).Parameters[(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>)].Type = SeAdtParmTypeNoLogonId;   \
    }
</div></pre>
<p>
Definition at line <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00083">83</a> of file <a class="el" href="../../d8/d5/sepaudit_8c-source.html">sepaudit.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l01907">SepAdtObjectReferenceAuditAlarm()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00571">SepAdtOpenObjectAuditAlarm()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l01003">SepAdtOpenObjectForDeleteAuditAlarm()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00346">SepAdtPrivilegedServiceAuditAlarm()</a>, and <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00125">SepAdtPrivilegeObjectAuditAlarm()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="sepaudit.c::SepSetParmTypeObjectTypes" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SepSetParmTypeObjectTypes          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">AuditParameters,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d0/cmdat2_8c.html#a27">Index</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ObjectTypes,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ObjectTypeCount,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ObjectTypeIndex&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                                                                               \
        (AuditParameters).Parameters[(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>)].Type = SeAdtParmTypeObjectTypes;            \
        (AuditParameters).Parameters[(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>)].Length = <span class="keyword">sizeof</span>( SE_ADT_OBJECT_TYPE ) * (ObjectTypeCount);\
        (AuditParameters).Parameters[(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>)].Address = (ObjectTypes);                    \
        (AuditParameters).Parameters[(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>)].Data[1] = (ObjectTypeIndex);               \
    }
</div></pre>
<p>
Definition at line <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00113">113</a> of file <a class="el" href="../../d8/d5/sepaudit_8c-source.html">sepaudit.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00571">SepAdtOpenObjectAuditAlarm()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="sepaudit.c::SepSetParmTypePrivileges" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SepSetParmTypePrivileges          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">AuditParameters,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d0/cmdat2_8c.html#a27">Index</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>Privileges&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                                                                                       \
        (AuditParameters).Parameters[(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>)].Type = SeAdtParmTypePrivs;                    \
        (AuditParameters).Parameters[(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>)].Length = <a class="code" href="../../d6/d6/sep_8h.html#a6">SepPrivilegeSetSize</a>( (Privileges) ); \
        (AuditParameters).Parameters[(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>)].Address = (Privileges);                       \
    }
</div></pre>
<p>
Definition at line <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00106">106</a> of file <a class="el" href="../../d8/d5/sepaudit_8c-source.html">sepaudit.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00571">SepAdtOpenObjectAuditAlarm()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l01003">SepAdtOpenObjectForDeleteAuditAlarm()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00346">SepAdtPrivilegedServiceAuditAlarm()</a>, and <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00125">SepAdtPrivilegeObjectAuditAlarm()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="sepaudit.c::SepSetParmTypeSid" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SepSetParmTypeSid          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">AuditParameters,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d0/cmdat2_8c.html#a27">Index</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>Sid&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                                                                          \
        (AuditParameters).Parameters[(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>)].Type = SeAdtParmTypeSid;         \
        (AuditParameters).Parameters[(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>)].Length = <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( (Sid) );   \
        (AuditParameters).Parameters[(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>)].Address = (Sid);                 \
    }
</div></pre>
<p>
Definition at line <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00051">51</a> of file <a class="el" href="../../d8/d5/sepaudit_8c-source.html">sepaudit.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l02573">SeAuditHandleDuplication()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l02466">SeAuditProcessCreation()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l02653">SeAuditProcessExit()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l01312">SepAdtCloseObjectAuditAlarm()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l01465">SepAdtDeleteObjectAuditAlarm()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l02717">SepAdtGenerateDiscardAudit()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l01794">SepAdtHandleAuditAlarm()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l01907">SepAdtObjectReferenceAuditAlarm()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00571">SepAdtOpenObjectAuditAlarm()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l01003">SepAdtOpenObjectForDeleteAuditAlarm()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00346">SepAdtPrivilegedServiceAuditAlarm()</a>, and <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00125">SepAdtPrivilegeObjectAuditAlarm()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="sepaudit.c::SepSetParmTypeString" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SepSetParmTypeString          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">AuditParameters,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d0/cmdat2_8c.html#a27">Index</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d0/tdetach_8c.html#a0">String</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                                                                          \
        (AuditParameters).Parameters[(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>)].Type = SeAdtParmTypeString;      \
        (AuditParameters).Parameters[(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>)].Length =                         \
                <span class="keyword">sizeof</span>(UNICODE_STRING)+(<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>)-&gt;Length;                       \
        (AuditParameters).Parameters[(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>)].Address = (<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>);              \
    }
</div></pre>
<p>
Definition at line <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00059">59</a> of file <a class="el" href="../../d8/d5/sepaudit_8c-source.html">sepaudit.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l02573">SeAuditHandleDuplication()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l02466">SeAuditProcessCreation()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l02653">SeAuditProcessExit()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l01312">SepAdtCloseObjectAuditAlarm()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l01465">SepAdtDeleteObjectAuditAlarm()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l02717">SepAdtGenerateDiscardAudit()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l01794">SepAdtHandleAuditAlarm()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l01907">SepAdtObjectReferenceAuditAlarm()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00571">SepAdtOpenObjectAuditAlarm()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l01003">SepAdtOpenObjectForDeleteAuditAlarm()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00346">SepAdtPrivilegedServiceAuditAlarm()</a>, and <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00125">SepAdtPrivilegeObjectAuditAlarm()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="sepaudit.c::SepSetParmTypeUlong" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SepSetParmTypeUlong          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">AuditParameters,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d0/cmdat2_8c.html#a27">Index</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>Ulong&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                                                                          \
        (AuditParameters).Parameters[(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>)].Type = SeAdtParmTypeUlong;       \
        (AuditParameters).Parameters[(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>)].Length =  <span class="keyword">sizeof</span>( (<a class="code" href="../../d4/d3/v86emul_8h.html#a15a14">Ulong</a>) );     \
        (AuditParameters).Parameters[(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>)].Data[0] = (ULONG)(<a class="code" href="../../d4/d3/v86emul_8h.html#a15a14">Ulong</a>);        \
    }
</div></pre>
<p>
Definition at line <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00076">76</a> of file <a class="el" href="../../d8/d5/sepaudit_8c-source.html">sepaudit.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l02573">SeAuditHandleDuplication()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l02466">SeAuditProcessCreation()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l02653">SeAuditProcessExit()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l01312">SepAdtCloseObjectAuditAlarm()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l01465">SepAdtDeleteObjectAuditAlarm()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l02717">SepAdtGenerateDiscardAudit()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l01794">SepAdtHandleAuditAlarm()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l01907">SepAdtObjectReferenceAuditAlarm()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00571">SepAdtOpenObjectAuditAlarm()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l01003">SepAdtOpenObjectForDeleteAuditAlarm()</a>, and <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00125">SepAdtPrivilegeObjectAuditAlarm()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a20" doxytag="sepaudit.c::SeAuditHandleDuplication" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SeAuditHandleDuplication           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>SourceHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>NewHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SourceProcess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetProcess</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l02573">2573</a> of file <a class="el" href="../../d8/d5/sepaudit_8c-source.html">sepaudit.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00165">EffectiveToken</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00814">PsProcessAuditId</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00046">SeCaptureSubjectContext()</a>, <a class="el" href="../../d1/d4/adtlog_8c-source.html#l00052">SepAdtLogAuditRecord()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00051">SepSetParmTypeSid</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00059">SepSetParmTypeString</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00076">SepSetParmTypeUlong</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00176">SepTokenUserSid</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00196">SeReleaseSubjectContext()</a>, and <a class="el" href="../../d1/d4/se_8h-source.html#l01711">SeSubsystemName</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/obhandle_8c-source.html#l00163">NtDuplicateObject()</a>, and <a class="el" href="../../d1/d0/obinit_8c-source.html#l00759">ObAuditInheritedHandleProcedure()</a>.
<p>
<pre class="fragment"><div>02582                    :
02583 
02584     This routine generates a handle duplication audit.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> up to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller
02585     to determine <span class="keywordflow">if</span> <span class="keyword">this</span> routine should be called or not.
02586 
02587 Arguments:
02588 
02589     SourceHandle -  Original handle
02590 
02591     NewHandle - New handle
02592 
02593     SourceProcess - Process containing SourceHandle
02594 
02595     TargetProcess - Process containing NewHandle
02596 
02597 Return Value:
02598 
02599     None.
02600 
02601 --*/
02602 
02603 {
02604     SE_ADT_PARAMETER_ARRAY AuditParameters;
02605     <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">SECURITY_SUBJECT_CONTEXT</a> SubjectSecurityContext;
02606     PSID UserSid;
02607 
02608     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02609 
02610     <a class="code" href="../../d0/d8/subject_8c.html#a0">SeCaptureSubjectContext</a>( &amp;SubjectSecurityContext );
02611 
02612     UserSid = <a class="code" href="../../d6/d6/sep_8h.html#a8">SepTokenUserSid</a>( <a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a>( &amp;SubjectSecurityContext ));
02613 
02614     RtlZeroMemory (
02615        (PVOID) &amp;AuditParameters,
02616        <span class="keyword">sizeof</span>( AuditParameters )
02617        );
02618 
02619 
02620     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( SeAdtParmTypeNone == 0 );
02621 
02622     AuditParameters.CategoryId = SE_CATEGID_DETAILED_TRACKING;
02623     AuditParameters.AuditId = SE_AUDITID_DUPLICATE_HANDLE;
02624     AuditParameters.ParameterCount = 0;
02625     AuditParameters.Type = EVENTLOG_AUDIT_SUCCESS;
02626 
02627     <a class="code" href="../../d7/d6/sepaudit_8c.html#a0">SepSetParmTypeSid</a>( AuditParameters, AuditParameters.ParameterCount, UserSid );
02628     AuditParameters.ParameterCount++;
02629 
02630     <a class="code" href="../../d7/d6/sepaudit_8c.html#a1">SepSetParmTypeString</a>( AuditParameters, AuditParameters.ParameterCount, &amp;SeSubsystemName );
02631     AuditParameters.ParameterCount++;
02632 
02633     <a class="code" href="../../d7/d6/sepaudit_8c.html#a3">SepSetParmTypeUlong</a>( AuditParameters, AuditParameters.ParameterCount, (ULONG)((ULONG_PTR)SourceHandle) );
02634     AuditParameters.ParameterCount++;
02635 
02636     <a class="code" href="../../d7/d6/sepaudit_8c.html#a3">SepSetParmTypeUlong</a>( AuditParameters, AuditParameters.ParameterCount, (ULONG)((ULONG_PTR)<a class="code" href="../../d1/d9/ps_8h.html#a25">PsProcessAuditId</a>( SourceProcess )));
02637     AuditParameters.ParameterCount++;
02638 
02639     <a class="code" href="../../d7/d6/sepaudit_8c.html#a3">SepSetParmTypeUlong</a>( AuditParameters, AuditParameters.ParameterCount, (ULONG)((ULONG_PTR)NewHandle) );
02640     AuditParameters.ParameterCount++;
02641 
02642     <a class="code" href="../../d7/d6/sepaudit_8c.html#a3">SepSetParmTypeUlong</a>( AuditParameters, AuditParameters.ParameterCount, (ULONG)((ULONG_PTR)<a class="code" href="../../d1/d9/ps_8h.html#a25">PsProcessAuditId</a>( TargetProcess )));
02643     AuditParameters.ParameterCount++;
02644 
02645 
02646     <a class="code" href="../../d0/d5/adtlog_8c.html#a0">SepAdtLogAuditRecord</a>( &amp;AuditParameters );
02647 
02648     <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a>( &amp;SubjectSecurityContext );
02649 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="sepaudit.c::SeAuditProcessCreation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SeAuditProcessCreation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Parent</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ImageFileName</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l02466">2466</a> of file <a class="el" href="../../d8/d5/sepaudit_8c-source.html">sepaudit.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00102">_SECURITY_SUBJECT_CONTEXT::PrimaryToken</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00046">SeCaptureSubjectContext()</a>, <a class="el" href="../../d1/d4/adtlog_8c-source.html#l00052">SepAdtLogAuditRecord()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00088">SepSetParmTypeLogonId</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00051">SepSetParmTypeSid</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00059">SepSetParmTypeString</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00076">SepSetParmTypeUlong</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00183">SepTokenAuthenticationId</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00176">SepTokenUserSid</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00196">SeReleaseSubjectContext()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01711">SeSubsystemName</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00969">PspCreateProcess()</a>.
<p>
<pre class="fragment"><div>02473                    :
02474 
02475     Audits <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> creation of a process.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller's responsibility
02476     to determine <span class="keywordflow">if</span> process auditing <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> in progress.
02477 
02478 
02479 Arguments:
02480 
02481     Process - Points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> process object.
02482 
02483     Parent - Points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> creator (parent) process object.
02484     
02485     ImageFileName - the name of the image
02486 
02487 Return Value:
02488 
02489     None.
02490 
02491 --*/
02492 
02493 {
02494     ANSI_STRING Ansi;
02495     LUID UserAuthenticationId;
02496     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02497     PSID UserSid;
02498     <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">SECURITY_SUBJECT_CONTEXT</a> SubjectSecurityContext;
02499     SE_ADT_PARAMETER_ARRAY AuditParameters;
02500     
02501     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02502 
02503     <span class="keywordflow">if</span> ( ImageFileName == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> )
02504     {
02505         <span class="keywordflow">return</span> ;
02506     }
02507 
02508     <span class="comment">//</span>
02509     <span class="comment">// NtCreateProcess with no section will cause this to be NULL</span>
02510     <span class="comment">// fork() for posix will do this, or someone calling NtCreateProcess</span>
02511     <span class="comment">// directly.</span>
02512     <span class="comment">//</span>
02513 
02514     <span class="keywordflow">if</span> ( ImageFileName-&gt;Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> )
02515     {
02516         <span class="keywordflow">return</span>;
02517     }
02518 
02519     <a class="code" href="../../d0/d8/subject_8c.html#a0">SeCaptureSubjectContext</a>( &amp;SubjectSecurityContext );
02520 
02521     RtlZeroMemory (
02522        (PVOID) &amp;AuditParameters,
02523        <span class="keyword">sizeof</span>( AuditParameters )
02524        );
02525 
02526     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( SeAdtParmTypeNone == 0 );
02527 
02528     AuditParameters.CategoryId = SE_CATEGID_DETAILED_TRACKING;
02529     AuditParameters.AuditId = SE_AUDITID_PROCESS_CREATED;
02530     AuditParameters.ParameterCount = 0;
02531     AuditParameters.Type = EVENTLOG_AUDIT_SUCCESS;
02532 
02533     <span class="comment">//</span>
02534     <span class="comment">// Use the primary token here, because that's what's going to show up</span>
02535     <span class="comment">// when the created process exits.</span>
02536     <span class="comment">//</span>
02537 
02538     UserSid = <a class="code" href="../../d6/d6/sep_8h.html#a8">SepTokenUserSid</a>( SubjectSecurityContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o2">PrimaryToken</a> );
02539 
02540     UserAuthenticationId = <a class="code" href="../../d6/d6/sep_8h.html#a9">SepTokenAuthenticationId</a>( SubjectSecurityContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o2">PrimaryToken</a> );
02541 
02542     <span class="comment">//</span>
02543     <span class="comment">// Fill in the AuditParameters structure.</span>
02544     <span class="comment">//</span>
02545 
02546     <a class="code" href="../../d7/d6/sepaudit_8c.html#a0">SepSetParmTypeSid</a>( AuditParameters, AuditParameters.ParameterCount, UserSid );
02547     AuditParameters.ParameterCount++;
02548 
02549     <a class="code" href="../../d7/d6/sepaudit_8c.html#a1">SepSetParmTypeString</a>( AuditParameters, AuditParameters.ParameterCount, &amp;SeSubsystemName );
02550     AuditParameters.ParameterCount++;
02551 
02552     <a class="code" href="../../d7/d6/sepaudit_8c.html#a3">SepSetParmTypeUlong</a>( AuditParameters, AuditParameters.ParameterCount, (ULONG)((ULONG_PTR)Process) );
02553     AuditParameters.ParameterCount++;
02554 
02555     <a class="code" href="../../d7/d6/sepaudit_8c.html#a1">SepSetParmTypeString</a>( AuditParameters, AuditParameters.ParameterCount, ImageFileName );
02556     AuditParameters.ParameterCount++;
02557 
02558     <a class="code" href="../../d7/d6/sepaudit_8c.html#a3">SepSetParmTypeUlong</a>( AuditParameters, AuditParameters.ParameterCount, (ULONG)((ULONG_PTR)Parent) );
02559     AuditParameters.ParameterCount++;
02560 
02561     <a class="code" href="../../d7/d6/sepaudit_8c.html#a5">SepSetParmTypeLogonId</a>( AuditParameters, AuditParameters.ParameterCount, UserAuthenticationId );
02562     AuditParameters.ParameterCount++;
02563 
02564     <a class="code" href="../../d0/d5/adtlog_8c.html#a0">SepAdtLogAuditRecord</a>( &amp;AuditParameters );
02565 
02566     <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a>( &amp;SubjectSecurityContext );
02567 
02568     <span class="keywordflow">return</span>;
02569 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="sepaudit.c::SeAuditProcessExit" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SeAuditProcessExit           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Process</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l02653">2653</a> of file <a class="el" href="../../d8/d5/sepaudit_8c-source.html">sepaudit.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00814">PsProcessAuditId</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00038">PTOKEN</a>, <a class="el" href="../../d1/d4/adtlog_8c-source.html#l00052">SepAdtLogAuditRecord()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00088">SepSetParmTypeLogonId</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00051">SepSetParmTypeSid</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00059">SepSetParmTypeString</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00076">SepSetParmTypeUlong</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00183">SepTokenAuthenticationId</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00176">SepTokenUserSid</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01711">SeSubsystemName</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00207">_EPROCESS::Token</a>, and <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/psdelete_8c-source.html#l01363">PspProcessDelete()</a>.
<p>
<pre class="fragment"><div>02658                    :
02659 
02660     Audits <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a> of a process.  The caller <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> responsible <span class="keywordflow">for</span>
02661     determining <span class="keywordflow">if</span> <span class="keyword">this</span> should be called.
02662 
02663 Arguments:
02664 
02665     Process - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process object that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> exiting.
02666 
02667 Return Value:
02668 
02669     None.
02670 
02671 --*/
02672 
02673 {
02674     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
02675     SE_ADT_PARAMETER_ARRAY AuditParameters;
02676     PSID UserSid;
02677     LUID LogonId;
02678 
02679     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02680 
02681     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> = (<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o21">Token</a>;
02682 
02683     UserSid = <a class="code" href="../../d6/d6/sep_8h.html#a8">SepTokenUserSid</a>( Token );
02684     LogonId = <a class="code" href="../../d6/d6/sep_8h.html#a9">SepTokenAuthenticationId</a>( Token );
02685 
02686     RtlZeroMemory (
02687        (PVOID) &amp;AuditParameters,
02688        <span class="keyword">sizeof</span>( AuditParameters )
02689        );
02690 
02691 
02692     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( SeAdtParmTypeNone == 0 );
02693 
02694     AuditParameters.CategoryId = SE_CATEGID_DETAILED_TRACKING;
02695     AuditParameters.AuditId = SE_AUDITID_PROCESS_EXIT;
02696     AuditParameters.ParameterCount = 0;
02697     AuditParameters.Type = EVENTLOG_AUDIT_SUCCESS;
02698 
02699     <a class="code" href="../../d7/d6/sepaudit_8c.html#a0">SepSetParmTypeSid</a>( AuditParameters, AuditParameters.ParameterCount, UserSid );
02700     AuditParameters.ParameterCount++;
02701 
02702     <a class="code" href="../../d7/d6/sepaudit_8c.html#a1">SepSetParmTypeString</a>( AuditParameters, AuditParameters.ParameterCount, &amp;SeSubsystemName );
02703     AuditParameters.ParameterCount++;
02704 
02705     <a class="code" href="../../d7/d6/sepaudit_8c.html#a3">SepSetParmTypeUlong</a>( AuditParameters, AuditParameters.ParameterCount, (ULONG)((ULONG_PTR)<a class="code" href="../../d1/d9/ps_8h.html#a25">PsProcessAuditId</a>( Process )));
02706     AuditParameters.ParameterCount++;
02707 
02708     <a class="code" href="../../d7/d6/sepaudit_8c.html#a5">SepSetParmTypeLogonId</a>( AuditParameters, AuditParameters.ParameterCount, LogonId );
02709     AuditParameters.ParameterCount++;
02710 
02711     <a class="code" href="../../d0/d5/adtlog_8c.html#a0">SepAdtLogAuditRecord</a>( &amp;AuditParameters );
02712 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="sepaudit.c::SepAdtCloseObjectAuditAlarm" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SepAdtCloseObjectAuditAlarm           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>CapturedSubsystemName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>HandleId</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>UserSid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LUID&nbsp;</td>
          <td class="mdname" nowrap> <em>AuthenticationId</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l01312">1312</a> of file <a class="el" href="../../d8/d5/sepaudit_8c-source.html">sepaudit.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d4/adtp_8h-source.html#l00320">_SEP_AUDIT_OPTIONS::DoNotAuditCloseObjectEvents</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00814">PsProcessAuditId</a>, <a class="el" href="../../d2/d4/adtp_8h-source.html#l00264">SepAdtAuditThisEvent</a>, <a class="el" href="../../d1/d4/adtlog_8c-source.html#l00052">SepAdtLogAuditRecord()</a>, <a class="el" href="../../d2/d4/adtp_8h-source.html#l00323">SepAuditOptions</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00051">SepSetParmTypeSid</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00059">SepSetParmTypeString</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00076">SepSetParmTypeUlong</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d4/d4/seaudit_8c-source.html#l02492">NtCloseObjectAuditAlarm()</a>, and <a class="el" href="../../d4/d4/seaudit_8c-source.html#l03826">SeCloseObjectAuditAlarm()</a>.
<p>
<pre class="fragment"><div>01322                    :
01323 
01324     This routine implements <a class="code" href="../../d3/d5/seaudit_8c.html#a21">NtCloseObjectAuditAlarm</a> after parameters have
01325     been captured.
01326 
01327     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to generate audit and alarm messages when a handle
01328     to a <span class="keyword">protected</span> subsystem object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> deleted.  This routine may result in
01329     several messages being generated and sent to Port objects.  This may
01330     result in a significant latency before returning.  Design of <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a>
01331     that must call <span class="keyword">this</span> routine must take <span class="keyword">this</span> potential latency into
01332     account.  This may have an impact on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> approach taken <span class="keywordflow">for</span> data
01333     structure mutex locking, <span class="keywordflow">for</span> example.
01334 
01335     This API requires <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller have <a class="code" href="../../d0/d5/se_8h.html#a84">SeTcbPrivilege</a> privilege.  The test
01336     <span class="keywordflow">for</span> <span class="keyword">this</span> privilege <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> always against <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> primary token of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> calling
01337     process, allowing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller to be impersonating a client during <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01338     call with no ill effects.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assumed that <span class="keyword">this</span> privilege has been
01339     tested at a higher level.
01340 
01341     This routine will create an SE_ADT_PARAMETERS array organized as follows:
01342 
01343     Parameter[0] - User Sid
01344 
01345     Parameter[1] - Subsystem name (<span class="keywordflow">if</span> available)
01346 
01347     Parameter[2] - New handle <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>
01348 
01349     Parameter[3] - Subject's process <span class="keywordtype">id</span>
01350 
01351 Arguments:
01352 
01353     CapturedSubsystemName - Supplies a name string identifying <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01354         subsystem calling <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> routine.
01355 
01356     HandleId - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> unique value representing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client's handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01357         object.
01358 
01359     Object - The address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object being closed
01360 
01361     UserSid - The Sid identifying <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current caller.
01362 
01363 
01364 
01365 Return value:
01366 
01367     None.
01368 
01369 
01370 --*/
01371 
01372 {
01373 
01374     SE_ADT_PARAMETER_ARRAY AuditParameters;
01375     BOOLEAN AccessGranted = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01376     HANDLE ProcessId;
01377 
01378     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01379 
01380     <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d5/adtp_8h.html#a14">SepAuditOptions</a>.<a class="code" href="../../d4/d1/struct__SEP__AUDIT__OPTIONS.html#o0">DoNotAuditCloseObjectEvents</a> ) {
01381 
01382         <span class="keywordflow">return</span>;
01383     }
01384     
01385     <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d5/adtp_8h.html#a1">SepAdtAuditThisEvent</a>( AuditCategoryObjectAccess, &amp;AccessGranted ) ) {
01386 
01387         <span class="comment">//</span>
01388         <span class="comment">// A completely zero'd entry will be interpreted</span>
01389         <span class="comment">// as a "null string" or not supplied parameter.</span>
01390         <span class="comment">//</span>
01391         <span class="comment">// Initializing the entire array up front will allow</span>
01392         <span class="comment">// us to avoid filling in each not supplied entry.</span>
01393         <span class="comment">//</span>
01394 
01395         RtlZeroMemory (
01396            (PVOID) &amp;AuditParameters,
01397            <span class="keyword">sizeof</span>( AuditParameters )
01398            );
01399 
01400         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( SeAdtParmTypeNone == 0 );
01401 
01402         AuditParameters.CategoryId = SE_CATEGID_OBJECT_ACCESS;
01403         AuditParameters.AuditId = SE_AUDITID_CLOSE_HANDLE;
01404         AuditParameters.ParameterCount = 0;
01405         AuditParameters.Type = EVENTLOG_AUDIT_SUCCESS;
01406 
01407 
01408         <span class="comment">//</span>
01409         <span class="comment">//  Parameter[0] - User Sid</span>
01410         <span class="comment">//</span>
01411 
01412         <a class="code" href="../../d7/d6/sepaudit_8c.html#a0">SepSetParmTypeSid</a>( AuditParameters, AuditParameters.ParameterCount, UserSid );
01413 
01414         AuditParameters.ParameterCount++;
01415 
01416 
01417         <span class="comment">//</span>
01418         <span class="comment">//  Parameter[1] - Subsystem name (if available)</span>
01419         <span class="comment">//</span>
01420 
01421         <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( CapturedSubsystemName )) {
01422 
01423             <a class="code" href="../../d7/d6/sepaudit_8c.html#a1">SepSetParmTypeString</a>( AuditParameters, AuditParameters.ParameterCount, CapturedSubsystemName );
01424         }
01425 
01426         AuditParameters.ParameterCount++;
01427 
01428         <span class="comment">//</span>
01429         <span class="comment">//  Parameter[2] - Subsystem name (if available)</span>
01430         <span class="comment">//</span>
01431 
01432         <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( CapturedSubsystemName )) {
01433 
01434             <a class="code" href="../../d7/d6/sepaudit_8c.html#a1">SepSetParmTypeString</a>( AuditParameters, AuditParameters.ParameterCount, CapturedSubsystemName );
01435         }
01436 
01437         AuditParameters.ParameterCount++;
01438 
01439         <span class="comment">//</span>
01440         <span class="comment">//    Parameter[3] - New handle ID</span>
01441         <span class="comment">//</span>
01442 
01443         <a class="code" href="../../d7/d6/sepaudit_8c.html#a3">SepSetParmTypeUlong</a>( AuditParameters, AuditParameters.ParameterCount, (ULONG)((ULONG_PTR)HandleId) );
01444 
01445         AuditParameters.ParameterCount++;
01446 
01447         <span class="comment">//</span>
01448         <span class="comment">//    Parameter[4] - Subject's process id</span>
01449         <span class="comment">//</span>
01450 
01451         ProcessId =  <a class="code" href="../../d1/d9/ps_8h.html#a25">PsProcessAuditId</a>( <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() );
01452 
01453         <a class="code" href="../../d7/d6/sepaudit_8c.html#a3">SepSetParmTypeUlong</a>( AuditParameters, AuditParameters.ParameterCount, (ULONG)((ULONG_PTR)ProcessId) );
01454 
01455         AuditParameters.ParameterCount++;
01456 
01457         <a class="code" href="../../d0/d5/adtlog_8c.html#a0">SepAdtLogAuditRecord</a>( &amp;AuditParameters );
01458 
01459     }
01460 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="sepaudit.c::SepAdtDeleteObjectAuditAlarm" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SepAdtDeleteObjectAuditAlarm           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>CapturedSubsystemName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>HandleId</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>UserSid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LUID&nbsp;</td>
          <td class="mdname" nowrap> <em>AuthenticationId</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l01465">1465</a> of file <a class="el" href="../../d8/d5/sepaudit_8c-source.html">sepaudit.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00814">PsProcessAuditId</a>, <a class="el" href="../../d2/d4/adtp_8h-source.html#l00264">SepAdtAuditThisEvent</a>, <a class="el" href="../../d1/d4/adtlog_8c-source.html#l00052">SepAdtLogAuditRecord()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00051">SepSetParmTypeSid</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00059">SepSetParmTypeString</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00076">SepSetParmTypeUlong</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d4/d4/seaudit_8c-source.html#l02627">NtDeleteObjectAuditAlarm()</a>, and <a class="el" href="../../d4/d4/seaudit_8c-source.html#l03892">SeDeleteObjectAuditAlarm()</a>.
<p>
<pre class="fragment"><div>01475                    :
01476 
01477     This routine implements <a class="code" href="../../d3/d5/seaudit_8c.html#a22">NtDeleteObjectAuditAlarm</a> after parameters have
01478     been captured.
01479 
01480     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to generate audit and alarm messages when an object
01481     in a <span class="keyword">protected</span> subsystem object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> deleted.  This routine may result in
01482     several messages being generated and sent to Port objects.  This may
01483     result in a significant latency before returning.  Design of <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a>
01484     that must call <span class="keyword">this</span> routine must take <span class="keyword">this</span> potential latency into
01485     account.  This may have an impact on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> approach taken <span class="keywordflow">for</span> data
01486     structure mutex locking, <span class="keywordflow">for</span> example.
01487 
01488     This API requires <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller have <a class="code" href="../../d0/d5/se_8h.html#a84">SeTcbPrivilege</a> privilege.  The test
01489     <span class="keywordflow">for</span> <span class="keyword">this</span> privilege <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> always against <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> primary token of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> calling
01490     process, allowing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller to be impersonating a client during <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01491     call with no ill effects.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assumed that <span class="keyword">this</span> privilege has been
01492     tested at a higher level.
01493 
01494     This routine will create an SE_ADT_PARAMETERS array organized as follows:
01495 
01496     Parameter[0] - User Sid
01497 
01498     Parameter[1] - Subsystem name (<span class="keywordflow">if</span> available)
01499 
01500     Parameter[2] - <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>
01501 
01502     Parameter[3] - Subject's process <span class="keywordtype">id</span>
01503 
01504 Arguments:
01505 
01506     CapturedSubsystemName - Supplies a name string identifying <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01507         subsystem calling <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> routine.
01508 
01509     HandleId - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> unique value representing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client's handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01510         object.
01511 
01512     Object - The address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object being closed
01513 
01514     UserSid - The Sid identifying <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current caller.
01515 
01516 
01517 
01518 Return value:
01519 
01520     None.
01521 
01522 
01523 --*/
01524 
01525 {
01526 
01527     SE_ADT_PARAMETER_ARRAY AuditParameters;
01528     BOOLEAN AccessGranted = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01529     HANDLE ProcessId;
01530 
01531     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01532 
01533     <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d5/adtp_8h.html#a1">SepAdtAuditThisEvent</a>( AuditCategoryObjectAccess, &amp;AccessGranted ) ) {
01534 
01535         <span class="comment">//</span>
01536         <span class="comment">// A completely zero'd entry will be interpreted</span>
01537         <span class="comment">// as a "null string" or not supplied parameter.</span>
01538         <span class="comment">//</span>
01539         <span class="comment">// Initializing the entire array up front will allow</span>
01540         <span class="comment">// us to avoid filling in each not supplied entry.</span>
01541         <span class="comment">//</span>
01542 
01543         RtlZeroMemory (
01544            (PVOID) &amp;AuditParameters,
01545            <span class="keyword">sizeof</span>( AuditParameters )
01546            );
01547 
01548         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( SeAdtParmTypeNone == 0 );
01549 
01550         AuditParameters.CategoryId = SE_CATEGID_OBJECT_ACCESS;
01551         AuditParameters.AuditId = SE_AUDITID_DELETE_OBJECT;
01552         AuditParameters.ParameterCount = 0;
01553         AuditParameters.Type = EVENTLOG_AUDIT_SUCCESS;
01554 
01555 
01556         <span class="comment">//</span>
01557         <span class="comment">//  Parameter[0] - User Sid</span>
01558         <span class="comment">//</span>
01559 
01560         <a class="code" href="../../d7/d6/sepaudit_8c.html#a0">SepSetParmTypeSid</a>( AuditParameters, AuditParameters.ParameterCount, UserSid );
01561 
01562         AuditParameters.ParameterCount++;
01563 
01564 
01565         <span class="comment">//</span>
01566         <span class="comment">//  Parameter[1] - Subsystem name (if available)</span>
01567         <span class="comment">//</span>
01568 
01569         <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( CapturedSubsystemName )) {
01570 
01571             <a class="code" href="../../d7/d6/sepaudit_8c.html#a1">SepSetParmTypeString</a>( AuditParameters, AuditParameters.ParameterCount, CapturedSubsystemName );
01572         }
01573 
01574         AuditParameters.ParameterCount++;
01575 
01576         <span class="comment">//</span>
01577         <span class="comment">//  Parameter[2] - Subsystem name (if available)</span>
01578         <span class="comment">//</span>
01579 
01580         <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( CapturedSubsystemName )) {
01581 
01582             <a class="code" href="../../d7/d6/sepaudit_8c.html#a1">SepSetParmTypeString</a>( AuditParameters, AuditParameters.ParameterCount, CapturedSubsystemName );
01583         }
01584 
01585         AuditParameters.ParameterCount++;
01586 
01587         <span class="comment">//</span>
01588         <span class="comment">//    Parameter[3] - New handle ID</span>
01589         <span class="comment">//</span>
01590 
01591         <a class="code" href="../../d7/d6/sepaudit_8c.html#a3">SepSetParmTypeUlong</a>( AuditParameters, AuditParameters.ParameterCount, (ULONG)((ULONG_PTR)HandleId) );
01592 
01593         AuditParameters.ParameterCount++;
01594 
01595         <span class="comment">//</span>
01596         <span class="comment">//    Parameter[4] - Subject's process id</span>
01597         <span class="comment">//</span>
01598 
01599         ProcessId =  <a class="code" href="../../d1/d9/ps_8h.html#a25">PsProcessAuditId</a>( <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() );
01600 
01601         <a class="code" href="../../d7/d6/sepaudit_8c.html#a3">SepSetParmTypeUlong</a>( AuditParameters, AuditParameters.ParameterCount, (ULONG)((ULONG_PTR)ProcessId) );
01602 
01603         AuditParameters.ParameterCount++;
01604 
01605         <a class="code" href="../../d0/d5/adtlog_8c.html#a0">SepAdtLogAuditRecord</a>( &amp;AuditParameters );
01606 
01607     }
01608 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="sepaudit.c::SepAdtGenerateDiscardAudit" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SepAdtGenerateDiscardAudit           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l02717">2717</a> of file <a class="el" href="../../d8/d5/sepaudit_8c-source.html">sepaudit.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01628">SeLocalSystemSid</a>, <a class="el" href="../../d2/d4/adtp_8h-source.html#l00056">SepAdtCountEventsDiscarded</a>, <a class="el" href="../../d1/d4/adtlog_8c-source.html#l00052">SepAdtLogAuditRecord()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00051">SepSetParmTypeSid</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00059">SepSetParmTypeString</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00076">SepSetParmTypeUlong</a>, and <a class="el" href="../../d1/d4/se_8h-source.html#l01711">SeSubsystemName</a>.
<p>
Referenced by <a class="el" href="../../d1/d4/adtlog_8c-source.html#l00600">SepQueueWorkItem()</a>.
<p>
<pre class="fragment"><div>02723                    :
02724 
02725     Generates an 'audits discarded' audit.
02726 
02727 Arguments:
02728 
02729     none
02730 
02731 Return Value:
02732 
02733     None.
02734 
02735 --*/
02736 
02737 {
02738 
02739     SE_ADT_PARAMETER_ARRAY AuditParameters;
02740     PSID UserSid;
02741 
02742     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02743 
02744     UserSid = <a class="code" href="../../d0/d5/se_8h.html#a54">SeLocalSystemSid</a>;
02745 
02746     RtlZeroMemory (
02747        (PVOID) &amp;AuditParameters,
02748        <span class="keyword">sizeof</span>( AuditParameters )
02749        );
02750 
02751 
02752     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( SeAdtParmTypeNone == 0 );
02753 
02754     AuditParameters.CategoryId = SE_CATEGID_SYSTEM;
02755     AuditParameters.AuditId = SE_AUDITID_AUDITS_DISCARDED;
02756     AuditParameters.ParameterCount = 0;
02757     AuditParameters.Type = EVENTLOG_AUDIT_SUCCESS;
02758 
02759     <a class="code" href="../../d7/d6/sepaudit_8c.html#a0">SepSetParmTypeSid</a>( AuditParameters, AuditParameters.ParameterCount, UserSid );
02760     AuditParameters.ParameterCount++;
02761 
02762     <a class="code" href="../../d7/d6/sepaudit_8c.html#a1">SepSetParmTypeString</a>( AuditParameters, AuditParameters.ParameterCount, &amp;SeSubsystemName );
02763     AuditParameters.ParameterCount++;
02764 
02765     <a class="code" href="../../d7/d6/sepaudit_8c.html#a3">SepSetParmTypeUlong</a>( AuditParameters, AuditParameters.ParameterCount, SepAdtCountEventsDiscarded );
02766     AuditParameters.ParameterCount++;
02767 
02768     <a class="code" href="../../d0/d5/adtlog_8c.html#a0">SepAdtLogAuditRecord</a>( &amp;AuditParameters );
02769 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="sepaudit.c::SepAdtHandleAuditAlarm" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SepAdtHandleAuditAlarm           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>Source</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LUID&nbsp;</td>
          <td class="mdname" nowrap> <em>OperationId</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Handle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>UserSid</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
*++ 
<p>

<p>
Definition at line <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l01794">1794</a> of file <a class="el" href="../../d8/d5/sepaudit_8c-source.html">sepaudit.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00814">PsProcessAuditId</a>, <a class="el" href="../../d2/d4/adtp_8h-source.html#l00264">SepAdtAuditThisEvent</a>, <a class="el" href="../../d1/d4/adtlog_8c-source.html#l00052">SepAdtLogAuditRecord()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00051">SepSetParmTypeSid</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00059">SepSetParmTypeString</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00076">SepSetParmTypeUlong</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>01803                    :
01804 
01805     Creates an audit record <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> creation of an object handle.
01806 
01807 Arguments:
01808 
01809 
01810 Return Value:
01811 
01812     None.
01813 
01814 --*/
01815 
01816 {
01817     BOOLEAN AccessGranted = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01818     SE_ADT_PARAMETER_ARRAY AuditParameters;
01819     HANDLE ProcessID;
01820 
01821     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01822 
01823     <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d5/adtp_8h.html#a1">SepAdtAuditThisEvent</a>( AuditCategoryObjectAccess, &amp;AccessGranted )) {
01824 
01825         <span class="comment">//</span>
01826         <span class="comment">// A completely zero'd entry will be interpreted</span>
01827         <span class="comment">// as a "null string" or not supplied parameter.</span>
01828         <span class="comment">//</span>
01829         <span class="comment">// Initializing the entire array up front will allow</span>
01830         <span class="comment">// us to avoid filling in each not supplied entry.</span>
01831         <span class="comment">//</span>
01832 
01833         RtlZeroMemory (
01834            (PVOID) &amp;AuditParameters,
01835            <span class="keyword">sizeof</span>( AuditParameters )
01836            );
01837 
01838         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( SeAdtParmTypeNone == 0 );
01839 
01840         AuditParameters.CategoryId = SE_CATEGID_OBJECT_ACCESS;
01841         AuditParameters.AuditId = SE_AUDITID_CREATE_HANDLE;
01842         AuditParameters.ParameterCount = 0;
01843         AuditParameters.Type = EVENTLOG_AUDIT_SUCCESS;
01844 
01845 
01846         <span class="comment">//</span>
01847         <span class="comment">//  Parameter[0] - User Sid</span>
01848         <span class="comment">//</span>
01849 
01850         <a class="code" href="../../d7/d6/sepaudit_8c.html#a0">SepSetParmTypeSid</a>( AuditParameters, AuditParameters.ParameterCount, UserSid );
01851 
01852         AuditParameters.ParameterCount++;
01853 
01854 
01855         <span class="comment">//</span>
01856         <span class="comment">//  Parameter[1] - Subsystem name (if available)</span>
01857         <span class="comment">//</span>
01858 
01859         <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( Source )) {
01860 
01861             <a class="code" href="../../d7/d6/sepaudit_8c.html#a1">SepSetParmTypeString</a>( AuditParameters, AuditParameters.ParameterCount, Source );
01862         }
01863 
01864         AuditParameters.ParameterCount++;
01865 
01866         <span class="comment">//</span>
01867         <span class="comment">//    Parameter[2] - New handle ID</span>
01868         <span class="comment">//</span>
01869 
01870         <a class="code" href="../../d7/d6/sepaudit_8c.html#a3">SepSetParmTypeUlong</a>( AuditParameters, AuditParameters.ParameterCount, (ULONG)((ULONG_PTR)Handle) );
01871 
01872         AuditParameters.ParameterCount++;
01873 
01874         <span class="comment">//</span>
01875         <span class="comment">//    Parameters 3,4 - Operation ID</span>
01876         <span class="comment">//</span>
01877 
01878 
01879         <a class="code" href="../../d7/d6/sepaudit_8c.html#a3">SepSetParmTypeUlong</a>( AuditParameters, AuditParameters.ParameterCount, OperationId.HighPart );
01880 
01881         AuditParameters.ParameterCount++;
01882 
01883         <a class="code" href="../../d7/d6/sepaudit_8c.html#a3">SepSetParmTypeUlong</a>( AuditParameters, AuditParameters.ParameterCount, OperationId.LowPart );
01884 
01885         AuditParameters.ParameterCount++;
01886 
01887 
01888         <span class="comment">//</span>
01889         <span class="comment">//    Parameter[5] - Subject's process id</span>
01890         <span class="comment">//</span>
01891 
01892         ProcessID =  <a class="code" href="../../d1/d9/ps_8h.html#a25">PsProcessAuditId</a>( <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() );
01893 
01894         <a class="code" href="../../d7/d6/sepaudit_8c.html#a3">SepSetParmTypeUlong</a>( AuditParameters, AuditParameters.ParameterCount, (ULONG)((ULONG_PTR)ProcessID) );
01895 
01896         AuditParameters.ParameterCount++;
01897 
01898         <a class="code" href="../../d0/d5/adtlog_8c.html#a0">SepAdtLogAuditRecord</a>( &amp;AuditParameters );
01899 
01900     }
01901 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="sepaudit.c::SepAdtObjectReferenceAuditAlarm" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SepAdtObjectReferenceAuditAlarm           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PLUID OperationId&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">PSECURITY_SUBJECT_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SubjectSecurityContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PPRIVILEGE_SET Privileges&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessGranted</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>GenerateAudit</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>GenerateAlarm</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l01907">1907</a> of file <a class="el" href="../../d8/d5/sepaudit_8c-source.html">sepaudit.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00039">ClientToken</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00126">PrimaryToken</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00038">PTOKEN</a>, <a class="el" href="../../d1/d4/adtlog_8c-source.html#l00052">SepAdtLogAuditRecord()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l02324">SepQueryNameString()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l02400">SepQueryTypeString()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00098">SepSetParmTypeAccessMask</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00088">SepSetParmTypeLogonId</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00083">SepSetParmTypeNoLogon</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00051">SepSetParmTypeSid</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00059">SepSetParmTypeString</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00076">SepSetParmTypeUlong</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00183">SepTokenAuthenticationId</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00176">SepTokenUserSid</a>, and <a class="el" href="../../d1/d4/se_8h-source.html#l01711">SeSubsystemName</a>.
<p>
Referenced by <a class="el" href="../../d4/d4/seaudit_8c-source.html#l03660">SeObjectReferenceAuditAlarm()</a>.
<p>
<pre class="fragment"><div>01920                    :
01921 
01922     description-of-function.
01923 
01924     This routine will create an SE_ADT_PARAMETERS array organized as follows:
01925 
01926     Parameter[0] - User Sid
01927 
01928     Parameter[1] - Subsystem name (<span class="keywordflow">if</span> available)
01929 
01930     Parameter[2] - Object Type <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>
01931 
01932     Parameter[3] - Object <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>
01933 
01934     Parameter[4] - Subject's process <span class="keywordtype">id</span>
01935 
01936     Parameter[5] - Subject's primary authentication <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>
01937 
01938     Parameter[6] - Subject's client authentication <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>
01939 
01940     Parameter[7] - DesiredAccess mask
01941 
01942 
01943 Arguments:
01944 
01945     GenerateAudit - Indicates <span class="keywordflow">if</span> we should generate an audit <span class="keywordflow">for</span> <span class="keyword">this</span> operation.
01946 
01947     GenerateAlarm - Indicates <span class="keywordflow">if</span> we should generate an alarm <span class="keywordflow">for</span> <span class="keyword">this</span> operation.
01948 
01949 Return Value:
01950 
01951     <span class="keywordflow">return</span>-value - <a class="code" href="../../d4/d9/heapdbg_8c.html#a4">Description</a> of conditions needed to <span class="keywordflow">return</span> value. - or -
01952     None.
01953 
01954 --*/
01955 
01956 {
01957     SE_ADT_PARAMETER_ARRAY AuditParameters;
01958     ULONG ObjectTypeIndex;
01959     POBJECT_NAME_INFORMATION ObjectNameInformation;
01960     PUNICODE_STRING ObjectTypeInformation;
01961     PSID UserSid;
01962     LUID PrimaryAuthenticationId;
01963     LUID ClientAuthenticationId;
01964 
01965     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a16">ClientToken</a> = (<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)SubjectSecurityContext-&gt;ClientToken;
01966     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a> = (<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)SubjectSecurityContext-&gt;PrimaryToken;
01967 
01968     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01969 
01970 
01971     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( ClientToken )) {
01972 
01973         UserSid = <a class="code" href="../../d6/d6/sep_8h.html#a8">SepTokenUserSid</a>( ClientToken );
01974         ClientAuthenticationId =  <a class="code" href="../../d6/d6/sep_8h.html#a9">SepTokenAuthenticationId</a>( ClientToken );
01975 
01976     } <span class="keywordflow">else</span> {
01977 
01978         UserSid = <a class="code" href="../../d6/d6/sep_8h.html#a8">SepTokenUserSid</a>( PrimaryToken );
01979     }
01980 
01981     PrimaryAuthenticationId = <a class="code" href="../../d6/d6/sep_8h.html#a9">SepTokenAuthenticationId</a>( PrimaryToken );
01982 
01983     <span class="comment">//</span>
01984     <span class="comment">// A completely zero'd entry will be interpreted</span>
01985     <span class="comment">// as a "null string" or not supplied parameter.</span>
01986     <span class="comment">//</span>
01987     <span class="comment">// Initializing the entire array up front will allow</span>
01988     <span class="comment">// us to avoid filling in each not supplied entry.</span>
01989     <span class="comment">//</span>
01990 
01991     RtlZeroMemory (
01992        (PVOID) &amp;AuditParameters,
01993        <span class="keyword">sizeof</span>( AuditParameters )
01994        );
01995 
01996     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( SeAdtParmTypeNone == 0 );
01997 
01998     AuditParameters.CategoryId = SE_CATEGID_DETAILED_TRACKING;
01999     AuditParameters.AuditId = SE_AUDITID_INDIRECT_REFERENCE;
02000     AuditParameters.ParameterCount = 8;
02001 
02002     <span class="keywordflow">if</span> ( AccessGranted ) {
02003 
02004         AuditParameters.Type = EVENTLOG_AUDIT_SUCCESS;
02005 
02006     } <span class="keywordflow">else</span> {
02007 
02008         AuditParameters.Type = EVENTLOG_AUDIT_FAILURE;
02009     }
02010 
02011     <span class="comment">//</span>
02012     <span class="comment">// Obtain the object name and object type name from the</span>
02013     <span class="comment">// object.</span>
02014     <span class="comment">//</span>
02015 
02016     ObjectNameInformation = <a class="code" href="../../d7/d6/sepaudit_8c.html#a17">SepQueryNameString</a>( Object );
02017 
02018 
02019     ObjectTypeInformation = <a class="code" href="../../d7/d6/sepaudit_8c.html#a18">SepQueryTypeString</a>( Object );
02020 
02021 
02022 
02023 
02024     <span class="comment">//</span>
02025     <span class="comment">//  Parameter[0] - User Sid</span>
02026     <span class="comment">//</span>
02027 
02028     <a class="code" href="../../d7/d6/sepaudit_8c.html#a0">SepSetParmTypeSid</a>( AuditParameters, 0, UserSid );
02029 
02030 
02031     <span class="comment">//</span>
02032     <span class="comment">//  Parameter[1] - Subsystem name (if available)</span>
02033     <span class="comment">//</span>
02034 
02035     <a class="code" href="../../d7/d6/sepaudit_8c.html#a1">SepSetParmTypeString</a>( AuditParameters, 1, &amp;SeSubsystemName );
02036 
02037 
02038     <span class="comment">//</span>
02039     <span class="comment">//  Parameter[2] - Object Type Name</span>
02040     <span class="comment">//</span>
02041 
02042     <span class="keywordflow">if</span> ( ObjectTypeInformation != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
02043 
02044         <a class="code" href="../../d7/d6/sepaudit_8c.html#a1">SepSetParmTypeString</a>( AuditParameters, 2, ObjectTypeInformation );
02045         ObjectTypeIndex = 2;
02046     }
02047 
02048 
02049 
02050     <span class="comment">//</span>
02051     <span class="comment">//  Parameter[3] - Object Name</span>
02052     <span class="comment">//</span>
02053 
02054     <span class="keywordflow">if</span> ( ObjectNameInformation != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
02055 
02056         <a class="code" href="../../d7/d6/sepaudit_8c.html#a1">SepSetParmTypeString</a>( AuditParameters, 3, &amp;ObjectNameInformation-&gt;Name );
02057     }
02058 
02059 
02060 
02061 
02062     <span class="comment">//</span>
02063     <span class="comment">//  Parameter[4] - Subject's process id</span>
02064     <span class="comment">//</span>
02065 
02066     <span class="comment">//</span>
02067     <span class="comment">// BUGWARNING: The process Id is currently unavailable.</span>
02068     <span class="comment">//</span>
02069 
02070     <a class="code" href="../../d7/d6/sepaudit_8c.html#a3">SepSetParmTypeUlong</a>( AuditParameters, 4, (ULONG)((ULONG_PTR)(SubjectSecurityContext-&gt;ProcessAuditId)) );
02071 
02072 
02073 
02074 
02075     <span class="comment">//</span>
02076     <span class="comment">//  Parameter[5] - Subject's primary authentication ID</span>
02077     <span class="comment">//</span>
02078 
02079 
02080     <a class="code" href="../../d7/d6/sepaudit_8c.html#a5">SepSetParmTypeLogonId</a>( AuditParameters, 5, PrimaryAuthenticationId );
02081 
02082 
02083 
02084 
02085     <span class="comment">//</span>
02086     <span class="comment">//  Parameter[6] - Subject's client authentication ID</span>
02087     <span class="comment">//</span>
02088 
02089     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( ClientToken )) {
02090 
02091         <a class="code" href="../../d7/d6/sepaudit_8c.html#a5">SepSetParmTypeLogonId</a>( AuditParameters, 6, ClientAuthenticationId );
02092 
02093     } <span class="keywordflow">else</span> {
02094 
02095         <a class="code" href="../../d7/d6/sepaudit_8c.html#a4">SepSetParmTypeNoLogon</a>( AuditParameters, 6 );
02096 
02097     }
02098 
02099     <span class="comment">//</span>
02100     <span class="comment">//  Parameter[7] - DesiredAccess mask</span>
02101     <span class="comment">//</span>
02102 
02103 
02104     <a class="code" href="../../d7/d6/sepaudit_8c.html#a6">SepSetParmTypeAccessMask</a>( AuditParameters, 7, DesiredAccess, ObjectTypeIndex );
02105 
02106 
02107     <a class="code" href="../../d0/d5/adtlog_8c.html#a0">SepAdtLogAuditRecord</a>( &amp;AuditParameters );
02108 
02109     <span class="keywordflow">if</span> ( ObjectNameInformation != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
02110         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( ObjectNameInformation );
02111     }
02112 
02113     <span class="keywordflow">if</span> ( ObjectTypeInformation != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
02114         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( ObjectTypeInformation );
02115     }
02116 
02117 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="sepaudit.c::SepAdtOpenObjectAuditAlarm" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN SepAdtOpenObjectAuditAlarm           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>CapturedSubsystemName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *HandleId&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>CapturedObjectTypeName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID Object&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING CapturedObjectName&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a> <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a11">ClientToken</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PrimaryToken</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>GrantedAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLUID&nbsp;</td>
          <td class="mdname" nowrap> <em>OperationId</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PPRIVILEGE_SET CapturedPrivileges&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectCreated</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessGranted</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>GenerateAudit</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>GenerateAlarm</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessID</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN POLICY_AUDIT_EVENT_TYPE&nbsp;</td>
          <td class="mdname" nowrap> <em>AuditType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">PIOBJECT_TYPE_LIST</a> ObjectTypeList&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectTypeListLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PACCESS_MASK GrantedAccessArray&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00571">571</a> of file <a class="el" href="../../d8/d5/sepaudit_8c-source.html">sepaudit.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00039">ClientToken</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00068">FlagMask</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00377">OBJECT_FAILURE_AUDIT</a>, <a class="el" href="../../d9/d2/tokenp_8h-source.html#l00376">OBJECT_SUCCESS_AUDIT</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00126">PrimaryToken</a>, <a class="el" href="../../d1/d4/adtlog_8c-source.html#l00052">SepAdtLogAuditRecord()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00098">SepSetParmTypeAccessMask</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00068">SepSetParmTypeFileSpec</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00088">SepSetParmTypeLogonId</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00083">SepSetParmTypeNoLogon</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00113">SepSetParmTypeObjectTypes</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00106">SepSetParmTypePrivileges</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00051">SepSetParmTypeSid</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00059">SepSetParmTypeString</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00076">SepSetParmTypeUlong</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00183">SepTokenAuthenticationId</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00176">SepTokenUserSid</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d4/d4/seaudit_8c-source.html#l02072">NtOpenObjectAuditAlarm()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l03736">SeAuditHandleCreation()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l02765">SeOpenObjectAuditAlarm()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l03085">SeOpenObjectForDeleteAuditAlarm()</a>, and <a class="el" href="../../d4/d4/seaudit_8c-source.html#l01050">SepAccessCheckAndAuditAlarm()</a>.
<p>
<pre class="fragment"><div>00596                        :
00597 
00598     Implements <a class="code" href="../../d3/d5/seaudit_8c.html#a20">NtOpenObjectAuditAlarm</a> after parameters have been captured.
00599 
00600     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to generate audit and alarm messages when an
00601     attempt <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> to access an existing <span class="keyword">protected</span> subsystem object or
00602     create a <span class="keyword">new</span> one.  This routine may result in several messages being
00603     generated and sent to Port objects.  This may result in a significant
00604     latency before returning.  Design of <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a> that must call <span class="keyword">this</span>
00605     routine must take <span class="keyword">this</span> potential latency into account.  This may have
00606     an impact on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> approach taken <span class="keywordflow">for</span> data structure mutex locking, <span class="keywordflow">for</span>
00607     example.  This API requires <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller have <a class="code" href="../../d0/d5/se_8h.html#a84">SeTcbPrivilege</a> privilege.
00608     The test <span class="keywordflow">for</span> <span class="keyword">this</span> privilege <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> always against <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> primary token of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00609     calling process, not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> impersonation token of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread.
00610 
00611 
00612     This routine will create an SE_ADT_PARAMETERS array organized as follows:
00613 
00614     Parameter[0] - User Sid
00615 
00616     Parameter[1] - Subsystem name (<span class="keywordflow">if</span> available)
00617 
00618     Parameter[2] - <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a> name (<span class="keywordflow">if</span> available)
00619 
00620     Parameter[3] - Object Type <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>
00621 
00622     Parameter[4] - Object <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>
00623 
00624     Parameter[5] - New handle <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>
00625 
00626     Parameter[6] - Subject's process <span class="keywordtype">id</span>
00627 
00628     Parameter[7] - Subject's primary authentication <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>
00629 
00630     Parameter[8] - Subject's client authentication <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>
00631 
00632     Parameter[9] - DesiredAccess mask
00633 
00634     Parameter[10] - Privileges used <span class="keywordflow">for</span> open
00635 
00636     Parameter[11] - Guid/Level/AccessMask of objects/property sets/properties accesses.
00637 
00638 Arguments:
00639 
00640     CapturedSubsystemName - Supplies a name string identifying <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00641         subsystem calling <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> routine.
00642 
00643     HandleId - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> unique value representing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client's handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00644         object.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access attempt was not successful (AccessGranted is
00645         FALSE), then <span class="keyword">this</span> parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> ignored.
00646 
00647     CapturedObjectTypeName - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of object being
00648         accessed.
00649 
00650     CapturedObjectName - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client
00651         accessed or attempted to access.
00652 
00653     CapturedSecurityDescriptor - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor of
00654         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object being accessed.
00655 
00656     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a16">ClientToken</a> - Optionally provides a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client token
00657         (<a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> currently impersonating)
00658 
00659     <a class="code" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a> - Provides a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller's primary token.
00660 
00661     DesiredAccess - The desired access mask.  This mask must have been
00662         previously mapped to contain no generic accesses.
00663 
00664     GrantedAccess - The mask of accesses that were actually granted.
00665 
00666     CapturedPrivileges - Optionally points to a set of privileges that were
00667         required <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access attempt.  Those privileges that were held
00668         by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subject are marked <span class="keyword">using</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> UsedForAccess flag of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00669         attributes associated with each privilege.
00670 
00671     ObjectCreation - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <span class="keywordtype">boolean</span> flag indicating whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access will
00672         result in a <span class="keyword">new</span> object being created <span class="keywordflow">if</span> granted.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
00673         indicates an object will be created, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> indicates an existing
00674         object will be opened.
00675 
00676     AccessGranted - Indicates whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested access was granted or
00677         not.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access was granted.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of
00678         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access was not granted.
00679 
00680     GenerateOnClose - Points to a <span class="keywordtype">boolean</span> that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> audit
00681         generation routine and must be passed to <a class="code" href="../../d3/d5/seaudit_8c.html#a21">NtCloseObjectAuditAlarm</a>()
00682         when the object handle is closed.
00683 
00684     GenerateAudit - Indicates if we should generate an audit for this operation.
00685 
00686     GenerateAlarm - Indicates if we should generate an alarm for this operation.
00687 
00688     AuditType - Specifies the type of audit to be generated.  Valid values
00689         are: AuditCategoryObjectAccess and AuditCategoryDirectoryServiceAccess.
00690 
00691     ObjectTypeList - Supplies a list of GUIDs representing the object (and
00692         sub-objects) being accessed.
00693 
00694     ObjectTypeListLength - Specifies the number of elements in the ObjectTypeList.
00695 
00696     GrantedAccessArray - If non NULL, specifies an array of access mask granted
00697         to each object in ObjectTypeList.
00698 
00699 Return Value:
00700 
00701     Returns TRUE if audit is generated, FALSE otherwise.
00702 
00703 --*/
00704 
00705 {
00706     SE_ADT_PARAMETER_ARRAY AuditParameters;
00707     ULONG ObjectTypeIndex;
00708     PSID CapturedUserSid;
00709     LUID PrimaryAuthenticationId;
00710     LUID ClientAuthenticationId;
00711     PSE_ADT_OBJECT_TYPE AdtObjectTypeBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00712 
00713     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00714 
00715     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( ClientToken )) {
00716 
00717         CapturedUserSid = <a class="code" href="../../d6/d6/sep_8h.html#a8">SepTokenUserSid</a>( ClientToken );
00718         ClientAuthenticationId =  <a class="code" href="../../d6/d6/sep_8h.html#a9">SepTokenAuthenticationId</a>( ClientToken );
00719 
00720     } <span class="keywordflow">else</span> {
00721 
00722         CapturedUserSid = <a class="code" href="../../d6/d6/sep_8h.html#a8">SepTokenUserSid</a>( PrimaryToken );
00723     }
00724 
00725     PrimaryAuthenticationId = <a class="code" href="../../d6/d6/sep_8h.html#a9">SepTokenAuthenticationId</a>( PrimaryToken );
00726 
00727     <span class="comment">//</span>
00728     <span class="comment">// A completely zero'd entry will be interpreted</span>
00729     <span class="comment">// as a "null string" or not supplied parameter.</span>
00730     <span class="comment">//</span>
00731     <span class="comment">// Initializing the entire array up front will allow</span>
00732     <span class="comment">// us to avoid filling in each not supplied entry.</span>
00733     <span class="comment">//</span>
00734 
00735     RtlZeroMemory (
00736        (PVOID) &amp;AuditParameters,
00737        <span class="keyword">sizeof</span>( AuditParameters )
00738        );
00739 
00740     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( SeAdtParmTypeNone == 0 );
00741 
00742     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( ( AuditType == AuditCategoryObjectAccess ) ||
00743             ( AuditType == AuditCategoryDirectoryServiceAccess ) );
00744     
00745     <span class="keywordflow">if</span> (AuditType == AuditCategoryObjectAccess) {
00746         
00747         AuditParameters.CategoryId = SE_CATEGID_OBJECT_ACCESS;
00748     } <span class="keywordflow">else</span> {
00749 
00750         AuditParameters.CategoryId = SE_CATEGID_DS_ACCESS;
00751     }
00752 
00753     AuditParameters.AuditId = SE_AUDITID_OPEN_HANDLE;
00754     AuditParameters.ParameterCount = 0;
00755 
00756     <span class="keywordflow">if</span> ( AccessGranted ) {
00757 
00758         AuditParameters.Type = EVENTLOG_AUDIT_SUCCESS;
00759 
00760     } <span class="keywordflow">else</span> {
00761 
00762         AuditParameters.Type = EVENTLOG_AUDIT_FAILURE;
00763     }
00764 
00765     <span class="comment">//</span>
00766     <span class="comment">//  Parameter[0] - User Sid</span>
00767     <span class="comment">//</span>
00768 
00769     <a class="code" href="../../d7/d6/sepaudit_8c.html#a0">SepSetParmTypeSid</a>( AuditParameters, AuditParameters.ParameterCount, CapturedUserSid );
00770 
00771     AuditParameters.ParameterCount++;
00772 
00773     <span class="comment">//</span>
00774     <span class="comment">//  Parameter[1] - Subsystem name (if available)</span>
00775     <span class="comment">//</span>
00776 
00777     <a class="code" href="../../d7/d6/sepaudit_8c.html#a1">SepSetParmTypeString</a>( AuditParameters, AuditParameters.ParameterCount, CapturedSubsystemName );
00778 
00779     AuditParameters.ParameterCount++;
00780 
00781     <span class="comment">//</span>
00782     <span class="comment">//  Parameter[2] - Object Server (if available)</span>
00783     <span class="comment">//</span>
00784 
00785     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( CapturedSubsystemName )) {
00786 
00787         <a class="code" href="../../d7/d6/sepaudit_8c.html#a1">SepSetParmTypeString</a>( AuditParameters, AuditParameters.ParameterCount, CapturedSubsystemName );
00788     }
00789 
00790     AuditParameters.ParameterCount++;
00791 
00792     <span class="comment">//</span>
00793     <span class="comment">//  Parameter[3] - Object Type Name</span>
00794     <span class="comment">//</span>
00795 
00796     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( CapturedObjectTypeName )) {
00797 
00798         <a class="code" href="../../d7/d6/sepaudit_8c.html#a1">SepSetParmTypeString</a>( AuditParameters, AuditParameters.ParameterCount, CapturedObjectTypeName );
00799         ObjectTypeIndex = AuditParameters.ParameterCount;
00800     }
00801 
00802     AuditParameters.ParameterCount++;
00803 
00804     <span class="comment">//</span>
00805     <span class="comment">//  Parameter[4] - Object Name</span>
00806     <span class="comment">//</span>
00807 
00808     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( CapturedObjectName )) {
00809 
00810         <a class="code" href="../../d7/d6/sepaudit_8c.html#a2">SepSetParmTypeFileSpec</a>( AuditParameters, AuditParameters.ParameterCount, CapturedObjectName );
00811     }
00812 
00813     AuditParameters.ParameterCount++;
00814 
00815     <span class="comment">//</span>
00816     <span class="comment">//  Parameter[5] - New handle ID</span>
00817     <span class="comment">//</span>
00818 
00819     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( HandleId )) {
00820 
00821         <a class="code" href="../../d7/d6/sepaudit_8c.html#a3">SepSetParmTypeUlong</a>( AuditParameters, AuditParameters.ParameterCount, (ULONG)((ULONG_PTR)*HandleId) );
00822     }
00823 
00824     AuditParameters.ParameterCount++;
00825 
00826     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( OperationId )) {
00827 
00828         <a class="code" href="../../d7/d6/sepaudit_8c.html#a3">SepSetParmTypeUlong</a>( AuditParameters, AuditParameters.ParameterCount, (*OperationId).HighPart );
00829 
00830         AuditParameters.ParameterCount++;
00831 
00832         <a class="code" href="../../d7/d6/sepaudit_8c.html#a3">SepSetParmTypeUlong</a>( AuditParameters, AuditParameters.ParameterCount, (*OperationId).LowPart );
00833 
00834         AuditParameters.ParameterCount++;
00835 
00836     } <span class="keywordflow">else</span> {
00837 
00838         AuditParameters.ParameterCount += 2;
00839     }
00840 
00841     <span class="comment">//</span>
00842     <span class="comment">//  Parameter[6] - Subject's process id</span>
00843     <span class="comment">//</span>
00844 
00845     <a class="code" href="../../d7/d6/sepaudit_8c.html#a3">SepSetParmTypeUlong</a>( AuditParameters, AuditParameters.ParameterCount, (ULONG)((ULONG_PTR)ProcessID) );
00846 
00847     AuditParameters.ParameterCount++;
00848 
00849     <span class="comment">//</span>
00850     <span class="comment">//  Parameter[7] - Subject's primary authentication ID</span>
00851     <span class="comment">//</span>
00852 
00853     <a class="code" href="../../d7/d6/sepaudit_8c.html#a5">SepSetParmTypeLogonId</a>( AuditParameters, AuditParameters.ParameterCount, PrimaryAuthenticationId );
00854 
00855     AuditParameters.ParameterCount++;
00856 
00857     <span class="comment">//</span>
00858     <span class="comment">//  Parameter[8] - Subject's client authentication ID</span>
00859     <span class="comment">//</span>
00860 
00861     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( ClientToken )) {
00862 
00863         <a class="code" href="../../d7/d6/sepaudit_8c.html#a5">SepSetParmTypeLogonId</a>( AuditParameters, AuditParameters.ParameterCount, ClientAuthenticationId );
00864 
00865     } <span class="keywordflow">else</span> {
00866 
00867         <a class="code" href="../../d7/d6/sepaudit_8c.html#a4">SepSetParmTypeNoLogon</a>( AuditParameters, AuditParameters.ParameterCount  );
00868     }
00869 
00870     AuditParameters.ParameterCount++;
00871 
00872     <span class="comment">//</span>
00873     <span class="comment">//  Parameter[9] - DesiredAccess mask</span>
00874     <span class="comment">//</span>
00875 
00876     <span class="keywordflow">if</span> ( AccessGranted ) {
00877 
00878         <a class="code" href="../../d7/d6/sepaudit_8c.html#a6">SepSetParmTypeAccessMask</a>( AuditParameters, AuditParameters.ParameterCount, GrantedAccess, ObjectTypeIndex );
00879 
00880     } <span class="keywordflow">else</span> {
00881 
00882         <a class="code" href="../../d7/d6/sepaudit_8c.html#a6">SepSetParmTypeAccessMask</a>( AuditParameters, AuditParameters.ParameterCount, DesiredAccess, ObjectTypeIndex );
00883     }
00884 
00885     AuditParameters.ParameterCount++;
00886 
00887     <span class="comment">//</span>
00888     <span class="comment">//    Parameter[10] - Privileges used for open</span>
00889     <span class="comment">//</span>
00890 
00891     <span class="keywordflow">if</span> ( (CapturedPrivileges != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (CapturedPrivileges-&gt;PrivilegeCount &gt; 0) ) {
00892 
00893         <a class="code" href="../../d7/d6/sepaudit_8c.html#a7">SepSetParmTypePrivileges</a>( AuditParameters, AuditParameters.ParameterCount, CapturedPrivileges );
00894     }
00895 
00896     AuditParameters.ParameterCount++;
00897 
00898     <span class="comment">//</span>
00899     <span class="comment">//    Parameter[11] - ObjectTypes of Audited objects/parameter sets/parameters</span>
00900     <span class="comment">//</span>
00901 
00902     <span class="keywordflow">if</span> ( ObjectTypeListLength != 0 ) {
00903         ULONG GuidCount;
00904         ULONG i;
00905         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> <a class="code" href="../../d3/d8/udfprocs_8h.html#a5">FlagMask</a> = AccessGranted ? <a class="code" href="../../d8/d3/tokenp_8h.html#a4">OBJECT_SUCCESS_AUDIT</a> : <a class="code" href="../../d8/d3/tokenp_8h.html#a5">OBJECT_FAILURE_AUDIT</a>;
00906 
00907         <span class="comment">//</span>
00908         <span class="comment">// Count the number of GUIDs to audit.</span>
00909         <span class="comment">//</span>
00910 
00911         GuidCount = 0;
00912         <span class="keywordflow">for</span> ( i=0; i&lt;ObjectTypeListLength; i++ ) {
00913 
00914             <span class="keywordflow">if</span> ( i == 0 ) {
00915                 GuidCount++;
00916             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( ObjectTypeList[i].Flags &amp; <a class="code" href="../../d3/d8/udfprocs_8h.html#a5">FlagMask</a> ) {
00917                 GuidCount ++;
00918             } 
00919         }
00920 
00921         <span class="comment">//</span>
00922         <span class="comment">// If there are any Guids to audit,</span>
00923         <span class="comment">//  copy them into a locally allocated buffer.</span>
00924         <span class="comment">//</span>
00925 
00926         <span class="keywordflow">if</span> ( GuidCount &gt; 0 ) {
00927 
00928             AdtObjectTypeBuffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( PagedPool, GuidCount * <span class="keyword">sizeof</span>(SE_ADT_OBJECT_TYPE), 'pAeS' );
00929 
00930             <span class="comment">//</span>
00931             <span class="comment">// If the buffer can be allocated,</span>
00932             <span class="comment">//  fill it in.</span>
00933             <span class="comment">// If not,</span>
00934             <span class="comment">//  generate a truncated audit.</span>
00935             <span class="comment">//</span>
00936 
00937             <span class="keywordflow">if</span> ( AdtObjectTypeBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00938 
00939                 <span class="comment">//</span>
00940                 <span class="comment">// Copy the GUIDs and optional access masks to the buffer.</span>
00941                 <span class="comment">//</span>
00942 
00943                 GuidCount = 0;
00944                 <span class="keywordflow">for</span> ( i=0; i&lt;ObjectTypeListLength; i++ ) {
00945 
00946                     <span class="keywordflow">if</span> ( ( i &gt; 0 ) &amp;&amp; !( ObjectTypeList[i].Flags &amp; <a class="code" href="../../d3/d8/udfprocs_8h.html#a5">FlagMask</a> ) ) {
00947 
00948                         <span class="keywordflow">continue</span>;
00949                         
00950                     } <span class="keywordflow">else</span> {
00951                     
00952                         AdtObjectTypeBuffer[GuidCount].ObjectType = ObjectTypeList[i].ObjectType;
00953                         AdtObjectTypeBuffer[GuidCount].Level      = ObjectTypeList[i].Level;
00954 
00955                         <span class="keywordflow">if</span> ( i == 0 ) {
00956                             <span class="comment">//</span>
00957                             <span class="comment">// Always copy the GUID representing the object itself.</span>
00958                             <span class="comment">//  Mark it as a such to avoid including it in the audit.</span>
00959                             <span class="comment">//</span>
00960                             AdtObjectTypeBuffer[GuidCount].Flags      = SE_ADT_OBJECT_ONLY;
00961                             AdtObjectTypeBuffer[GuidCount].AccessMask = 0;
00962 
00963                         } <span class="keywordflow">else</span>  {
00964 
00965                             AdtObjectTypeBuffer[GuidCount].Flags = 0;
00966                             <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(GrantedAccessArray) &amp;&amp; AccessGranted ) {
00967 
00968                                 AdtObjectTypeBuffer[GuidCount].AccessMask = GrantedAccessArray[i];
00969                             }
00970                         }
00971                         GuidCount ++;
00972                     }
00973                 }
00974 
00975                 <span class="comment">//</span>
00976                 <span class="comment">// Store the Object Types.</span>
00977                 <span class="comment">//</span>
00978 
00979                 <a class="code" href="../../d7/d6/sepaudit_8c.html#a8">SepSetParmTypeObjectTypes</a>( AuditParameters, AuditParameters.ParameterCount, AdtObjectTypeBuffer, GuidCount, ObjectTypeIndex );
00980                 AuditParameters.ParameterCount ++;
00981                 AuditParameters.AuditId = SE_AUDITID_OPEN_HANDLE_OBJECT_TYPE;
00982             }
00983         }
00984 
00985     }
00986 
00987 
00988 
00989     <span class="comment">//</span>
00990     <span class="comment">// Audit it.</span>
00991     <span class="comment">//</span>
00992     <a class="code" href="../../d0/d5/adtlog_8c.html#a0">SepAdtLogAuditRecord</a>( &amp;AuditParameters );
00993 
00994     <span class="keywordflow">if</span> ( AdtObjectTypeBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00995         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( AdtObjectTypeBuffer );
00996     }
00997 
00998     <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00999 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="sepaudit.c::SepAdtOpenObjectForDeleteAuditAlarm" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN SepAdtOpenObjectForDeleteAuditAlarm           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>CapturedSubsystemName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *HandleId&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>CapturedObjectTypeName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID Object&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING CapturedObjectName&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a> <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a11">ClientToken</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PrimaryToken</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>GrantedAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLUID&nbsp;</td>
          <td class="mdname" nowrap> <em>OperationId</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PPRIVILEGE_SET CapturedPrivileges&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectCreated</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessGranted</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>GenerateAudit</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>GenerateAlarm</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessID</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l01003">1003</a> of file <a class="el" href="../../d8/d5/sepaudit_8c-source.html">sepaudit.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00039">ClientToken</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00126">PrimaryToken</a>, <a class="el" href="../../d1/d4/adtlog_8c-source.html#l00052">SepAdtLogAuditRecord()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00098">SepSetParmTypeAccessMask</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00068">SepSetParmTypeFileSpec</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00088">SepSetParmTypeLogonId</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00083">SepSetParmTypeNoLogon</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00106">SepSetParmTypePrivileges</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00051">SepSetParmTypeSid</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00059">SepSetParmTypeString</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00076">SepSetParmTypeUlong</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00183">SepTokenAuthenticationId</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00176">SepTokenUserSid</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d4/d4/seaudit_8c-source.html#l03085">SeOpenObjectForDeleteAuditAlarm()</a>.
<p>
<pre class="fragment"><div>01024                        :
01025 
01026     Implements <a class="code" href="../../d0/d5/se_8h.html#a142">SeOpenObjectForDeleteAuditAlarm</a> after parameters have been
01027     captured.
01028 
01029     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to generate audit and alarm messages when an
01030     attempt <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> to access an existing <span class="keyword">protected</span> subsystem object or
01031     create a <span class="keyword">new</span> one.  This routine may result in several messages being
01032     generated and sent to Port objects.  This may result in a significant
01033     latency before returning.  Design of <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a> that must call <span class="keyword">this</span>
01034     routine must take <span class="keyword">this</span> potential latency into account.  This may have
01035     an impact on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> approach taken <span class="keywordflow">for</span> data structure mutex locking, <span class="keywordflow">for</span>
01036     example.  This API requires <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller have <a class="code" href="../../d0/d5/se_8h.html#a84">SeTcbPrivilege</a> privilege.
01037     The test <span class="keywordflow">for</span> <span class="keyword">this</span> privilege <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> always against <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> primary token of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01038     calling process, not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> impersonation token of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread.
01039 
01040 
01041     This routine will create an SE_ADT_PARAMETERS array organized as follows:
01042 
01043     Parameter[0] - User Sid
01044 
01045     Parameter[1] - Subsystem name (<span class="keywordflow">if</span> available)
01046 
01047     Parameter[2] - <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a> name (<span class="keywordflow">if</span> available)
01048 
01049     Parameter[3] - Object Type <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>
01050 
01051     Parameter[4] - Object <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>
01052 
01053     Parameter[5] - New handle <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>
01054 
01055     Parameter[6] - Subject's process <span class="keywordtype">id</span>
01056 
01057     Parameter[7] - Subject's primary authentication <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>
01058 
01059     Parameter[8] - Subject's client authentication <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>
01060 
01061     Parameter[9] - DesiredAccess mask
01062 
01063     Parameter[10] - Privileges used <span class="keywordflow">for</span> open
01064 
01065 Arguments:
01066 
01067     CapturedSubsystemName - Supplies a name string identifying <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01068         subsystem calling <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> routine.
01069 
01070     HandleId - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> unique value representing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client's handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01071         object.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access attempt was not successful (AccessGranted is
01072         FALSE), then <span class="keyword">this</span> parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> ignored.
01073 
01074     CapturedObjectTypeName - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of object being
01075         accessed.
01076 
01077     CapturedObjectName - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client
01078         accessed or attempted to access.
01079 
01080     CapturedSecurityDescriptor - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor of
01081         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object being accessed.
01082 
01083     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a16">ClientToken</a> - Optionally provides a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client token
01084         (<a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> currently impersonating)
01085 
01086     <a class="code" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a> - Provides a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller's primary token.
01087 
01088     DesiredAccess - The desired access mask.  This mask must have been
01089         previously mapped to contain no generic accesses.
01090 
01091     GrantedAccess - The mask of accesses that were actually granted.
01092 
01093     CapturedPrivileges - Optionally points to a set of privileges that were
01094         required <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access attempt.  Those privileges that were held
01095         by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subject are marked <span class="keyword">using</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> UsedForAccess flag of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01096         attributes associated with each privilege.
01097 
01098     ObjectCreation - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <span class="keywordtype">boolean</span> flag indicating whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access will
01099         result in a <span class="keyword">new</span> object being created <span class="keywordflow">if</span> granted.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
01100         indicates an object will be created, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> indicates an existing
01101         object will be opened.
01102 
01103     AccessGranted - Indicates whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested access was granted or
01104         not.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access was granted.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of
01105         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access was not granted.
01106 
01107     GenerateOnClose - Points to a <span class="keywordtype">boolean</span> that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> audit
01108         generation routine and must be passed to <a class="code" href="../../d3/d5/seaudit_8c.html#a21">NtCloseObjectAuditAlarm</a>()
01109         when the object handle is closed.
01110 
01111     GenerateAudit - Indicates if we should generate an audit for this operation.
01112 
01113     GenerateAlarm - Indicates if we should generate an alarm for this operation.
01114 
01115 Return Value:
01116 
01117     Returns TRUE if audit is generated, FALSE otherwise.
01118 
01119 --*/
01120 
01121 {
01122     SE_ADT_PARAMETER_ARRAY AuditParameters;
01123     ULONG ObjectTypeIndex;
01124     PSID CapturedUserSid;
01125     LUID PrimaryAuthenticationId;
01126     LUID ClientAuthenticationId;
01127 
01128     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01129 
01130     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( ClientToken )) {
01131 
01132         CapturedUserSid = <a class="code" href="../../d6/d6/sep_8h.html#a8">SepTokenUserSid</a>( ClientToken );
01133         ClientAuthenticationId =  <a class="code" href="../../d6/d6/sep_8h.html#a9">SepTokenAuthenticationId</a>( ClientToken );
01134 
01135     } <span class="keywordflow">else</span> {
01136 
01137         CapturedUserSid = <a class="code" href="../../d6/d6/sep_8h.html#a8">SepTokenUserSid</a>( PrimaryToken );
01138     }
01139 
01140     PrimaryAuthenticationId = <a class="code" href="../../d6/d6/sep_8h.html#a9">SepTokenAuthenticationId</a>( PrimaryToken );
01141 
01142     <span class="comment">//</span>
01143     <span class="comment">// A completely zero'd entry will be interpreted</span>
01144     <span class="comment">// as a "null string" or not supplied parameter.</span>
01145     <span class="comment">//</span>
01146     <span class="comment">// Initializing the entire array up front will allow</span>
01147     <span class="comment">// us to avoid filling in each not supplied entry.</span>
01148     <span class="comment">//</span>
01149 
01150     RtlZeroMemory (
01151        (PVOID) &amp;AuditParameters,
01152        <span class="keyword">sizeof</span>( AuditParameters )
01153        );
01154 
01155     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( SeAdtParmTypeNone == 0 );
01156 
01157     AuditParameters.CategoryId = SE_CATEGID_OBJECT_ACCESS;
01158     AuditParameters.AuditId = SE_AUDITID_OPEN_OBJECT_FOR_DELETE;
01159     AuditParameters.ParameterCount = 0;
01160 
01161     <span class="keywordflow">if</span> ( AccessGranted ) {
01162 
01163         AuditParameters.Type = EVENTLOG_AUDIT_SUCCESS;
01164 
01165     } <span class="keywordflow">else</span> {
01166 
01167         AuditParameters.Type = EVENTLOG_AUDIT_FAILURE;
01168     }
01169 
01170     <span class="comment">//</span>
01171     <span class="comment">//  Parameter[0] - User Sid</span>
01172     <span class="comment">//</span>
01173 
01174     <a class="code" href="../../d7/d6/sepaudit_8c.html#a0">SepSetParmTypeSid</a>( AuditParameters, AuditParameters.ParameterCount, CapturedUserSid );
01175 
01176     AuditParameters.ParameterCount++;
01177 
01178     <span class="comment">//</span>
01179     <span class="comment">//  Parameter[1] - Subsystem name (if available)</span>
01180     <span class="comment">//</span>
01181 
01182     <a class="code" href="../../d7/d6/sepaudit_8c.html#a1">SepSetParmTypeString</a>( AuditParameters, AuditParameters.ParameterCount, CapturedSubsystemName );
01183 
01184     AuditParameters.ParameterCount++;
01185 
01186     <span class="comment">//</span>
01187     <span class="comment">//  Parameter[2] - Object Server (if available)</span>
01188     <span class="comment">//</span>
01189 
01190     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( CapturedSubsystemName )) {
01191 
01192         <a class="code" href="../../d7/d6/sepaudit_8c.html#a1">SepSetParmTypeString</a>( AuditParameters, AuditParameters.ParameterCount, CapturedSubsystemName );
01193     }
01194 
01195     AuditParameters.ParameterCount++;
01196 
01197     <span class="comment">//</span>
01198     <span class="comment">//  Parameter[3] - Object Type Name</span>
01199     <span class="comment">//</span>
01200 
01201     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( CapturedObjectTypeName )) {
01202 
01203         <a class="code" href="../../d7/d6/sepaudit_8c.html#a1">SepSetParmTypeString</a>( AuditParameters, AuditParameters.ParameterCount, CapturedObjectTypeName );
01204         ObjectTypeIndex = AuditParameters.ParameterCount;
01205     }
01206 
01207     AuditParameters.ParameterCount++;
01208 
01209     <span class="comment">//</span>
01210     <span class="comment">//  Parameter[4] - Object Name</span>
01211     <span class="comment">//</span>
01212 
01213     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( CapturedObjectName )) {
01214 
01215         <a class="code" href="../../d7/d6/sepaudit_8c.html#a2">SepSetParmTypeFileSpec</a>( AuditParameters, AuditParameters.ParameterCount, CapturedObjectName );
01216     }
01217 
01218     AuditParameters.ParameterCount++;
01219 
01220     <span class="comment">//</span>
01221     <span class="comment">//  Parameter[5] - New handle ID</span>
01222     <span class="comment">//</span>
01223 
01224     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( HandleId )) {
01225 
01226         <a class="code" href="../../d7/d6/sepaudit_8c.html#a3">SepSetParmTypeUlong</a>( AuditParameters, AuditParameters.ParameterCount, (ULONG)((ULONG_PTR)*HandleId) );
01227     }
01228 
01229     AuditParameters.ParameterCount++;
01230 
01231     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( OperationId )) {
01232 
01233         <a class="code" href="../../d7/d6/sepaudit_8c.html#a3">SepSetParmTypeUlong</a>( AuditParameters, AuditParameters.ParameterCount, (*OperationId).HighPart );
01234 
01235         AuditParameters.ParameterCount++;
01236 
01237         <a class="code" href="../../d7/d6/sepaudit_8c.html#a3">SepSetParmTypeUlong</a>( AuditParameters, AuditParameters.ParameterCount, (*OperationId).LowPart );
01238 
01239         AuditParameters.ParameterCount++;
01240 
01241     } <span class="keywordflow">else</span> {
01242 
01243         AuditParameters.ParameterCount += 2;
01244     }
01245 
01246     <span class="comment">//</span>
01247     <span class="comment">//  Parameter[6] - Subject's process id</span>
01248     <span class="comment">//</span>
01249 
01250     <a class="code" href="../../d7/d6/sepaudit_8c.html#a3">SepSetParmTypeUlong</a>( AuditParameters, AuditParameters.ParameterCount, (ULONG)((ULONG_PTR)ProcessID) );
01251 
01252     AuditParameters.ParameterCount++;
01253 
01254     <span class="comment">//</span>
01255     <span class="comment">//  Parameter[7] - Subject's primary authentication ID</span>
01256     <span class="comment">//</span>
01257 
01258     <a class="code" href="../../d7/d6/sepaudit_8c.html#a5">SepSetParmTypeLogonId</a>( AuditParameters, AuditParameters.ParameterCount, PrimaryAuthenticationId );
01259 
01260     AuditParameters.ParameterCount++;
01261 
01262     <span class="comment">//</span>
01263     <span class="comment">//  Parameter[8] - Subject's client authentication ID</span>
01264     <span class="comment">//</span>
01265 
01266     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( ClientToken )) {
01267 
01268         <a class="code" href="../../d7/d6/sepaudit_8c.html#a5">SepSetParmTypeLogonId</a>( AuditParameters, AuditParameters.ParameterCount, ClientAuthenticationId );
01269 
01270     } <span class="keywordflow">else</span> {
01271 
01272         <a class="code" href="../../d7/d6/sepaudit_8c.html#a4">SepSetParmTypeNoLogon</a>( AuditParameters, AuditParameters.ParameterCount  );
01273     }
01274 
01275     AuditParameters.ParameterCount++;
01276 
01277     <span class="comment">//</span>
01278     <span class="comment">//  Parameter[9] - DesiredAccess mask</span>
01279     <span class="comment">//</span>
01280 
01281     <span class="keywordflow">if</span> ( AccessGranted ) {
01282 
01283         <a class="code" href="../../d7/d6/sepaudit_8c.html#a6">SepSetParmTypeAccessMask</a>( AuditParameters, AuditParameters.ParameterCount, GrantedAccess, ObjectTypeIndex );
01284 
01285     } <span class="keywordflow">else</span> {
01286 
01287         <a class="code" href="../../d7/d6/sepaudit_8c.html#a6">SepSetParmTypeAccessMask</a>( AuditParameters, AuditParameters.ParameterCount, DesiredAccess, ObjectTypeIndex );
01288     }
01289 
01290     AuditParameters.ParameterCount++;
01291 
01292     <span class="comment">//</span>
01293     <span class="comment">//    Parameter[10] - Privileges used for open</span>
01294     <span class="comment">//</span>
01295 
01296     <span class="keywordflow">if</span> ( (CapturedPrivileges != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (CapturedPrivileges-&gt;PrivilegeCount &gt; 0) ) {
01297 
01298         <a class="code" href="../../d7/d6/sepaudit_8c.html#a7">SepSetParmTypePrivileges</a>( AuditParameters, AuditParameters.ParameterCount, CapturedPrivileges );
01299     }
01300 
01301     AuditParameters.ParameterCount++;
01302 
01303     <a class="code" href="../../d0/d5/adtlog_8c.html#a0">SepAdtLogAuditRecord</a>( &amp;AuditParameters );
01304 
01305     <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
01306 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="sepaudit.c::SepAdtPrivilegedServiceAuditAlarm" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SepAdtPrivilegedServiceAuditAlarm           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>CapturedSubsystemName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>CapturedServiceName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a> <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a11">ClientToken</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PrimaryToken</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PPRIVILEGE_SET&nbsp;</td>
          <td class="mdname" nowrap> <em>CapturedPrivileges</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessGranted</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00346">346</a> of file <a class="el" href="../../d8/d5/sepaudit_8c-source.html">sepaudit.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00039">ClientToken</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00126">PrimaryToken</a>, <a class="el" href="../../d2/d4/adtp_8h-source.html#l00264">SepAdtAuditThisEvent</a>, <a class="el" href="../../d1/d4/adtlog_8c-source.html#l00052">SepAdtLogAuditRecord()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00088">SepSetParmTypeLogonId</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00083">SepSetParmTypeNoLogon</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00106">SepSetParmTypePrivileges</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00051">SepSetParmTypeSid</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00059">SepSetParmTypeString</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00183">SepTokenAuthenticationId</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00176">SepTokenUserSid</a>, and <a class="el" href="../../d1/d4/se_8h-source.html#l01711">SeSubsystemName</a>.
<p>
Referenced by <a class="el" href="../../d4/d4/seaudit_8c-source.html#l00731">NtPrivilegedServiceAuditAlarm()</a>, and <a class="el" href="../../d4/d4/seaudit_8c-source.html#l00989">SePrivilegedServiceAuditAlarm()</a>.
<p>
<pre class="fragment"><div>00357                    :
00358 
00359     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> active part of <a class="code" href="../../d3/d5/seaudit_8c.html#a14">NtPrivilegedServiceAuditAlarm</a>.
00360 
00361     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to generate audit and alarm messages when an
00362     attempt <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> to perform privileged system service operations.  This
00363     routine may result in several messages being generated and sent to Port
00364     objects.  This may result in a significant latency before returning.
00365     Design of <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a> that must call <span class="keyword">this</span> routine must take <span class="keyword">this</span> potential
00366     latency into account.  This may have an impact on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> approach taken
00367     <span class="keywordflow">for</span> data structure mutex locking, <span class="keywordflow">for</span> example.
00368 
00369     This API requires <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller have <a class="code" href="../../d0/d5/se_8h.html#a84">SeTcbPrivilege</a> privilege.  The test
00370     <span class="keywordflow">for</span> <span class="keyword">this</span> privilege <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> always against <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> primary token of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> calling
00371     process, allowing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller to be impersonating a client during <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00372     call with no ill effects.  The test <span class="keywordflow">for</span> <span class="keyword">this</span> privilege <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assumed to
00373     have occurred at a higher level.
00374 
00375     This routine will create an SE_ADT_PARAMETERS array organized as follows:
00376 
00377     Parameter[0] - User Sid
00378 
00379     Parameter[1] - Subsystem name (<span class="keywordflow">if</span> available)
00380 
00381     Parameter[2] - Subject's primary authentication <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>
00382 
00383     Parameter[3] - Subject's client authentication <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>
00384 
00385     Parameter[4] - Privileges used <span class="keywordflow">for</span> open
00386 
00387 Arguments:
00388 
00389     SubsystemName - Supplies a name string identifying <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subsystem
00390         calling <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> routine.
00391 
00392     ServiceName - Supplies a name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> privileged subsystem service.  For
00393         example, <span class="stringliteral">"RESET RUNTIME LOCAL SECURITY POLICY"</span> might be specified
00394         by a Local Security Authority service used to update <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> local
00395         security policy database.
00396 
00397     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a16">ClientToken</a> - Optionally provides a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client token
00398         (<a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> currently impersonating)
00399 
00400     <a class="code" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a> - Provides a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller's primary token.
00401 
00402     Privileges - Points to a set of privileges required to perform <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00403         privileged operation.  Those privileges that were held by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00404         subject are marked <span class="keyword">using</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> UsedForAccess flag of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00405         attributes associated with each privilege.
00406 
00407     AccessGranted - Indicates whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested access was granted or
00408         not.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access was granted.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of
00409         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access was not granted.
00410 
00411 
00412 Return value:
00413 
00414 
00415 --*/
00416 
00417 {
00418 
00419     SE_ADT_PARAMETER_ARRAY AuditParameters;
00420     PSID CapturedUserSid;
00421     LUID ClientAuthenticationId;
00422     LUID PrimaryAuthenticationId;
00423     PUNICODE_STRING SubsystemName;
00424 
00425     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00426 
00427     <span class="comment">//</span>
00428     <span class="comment">// Determine if we are auditing privileged services</span>
00429     <span class="comment">//</span>
00430 
00431     <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d5/adtp_8h.html#a1">SepAdtAuditThisEvent</a>( AuditCategoryPrivilegeUse, &amp;AccessGranted )) {
00432 
00433         <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( ClientToken )) {
00434 
00435             CapturedUserSid = <a class="code" href="../../d6/d6/sep_8h.html#a8">SepTokenUserSid</a>( ClientToken );
00436             ClientAuthenticationId =  <a class="code" href="../../d6/d6/sep_8h.html#a9">SepTokenAuthenticationId</a>( ClientToken );
00437 
00438         } <span class="keywordflow">else</span> {
00439 
00440             CapturedUserSid = <a class="code" href="../../d6/d6/sep_8h.html#a8">SepTokenUserSid</a>( PrimaryToken );
00441         }
00442 
00443         PrimaryAuthenticationId = <a class="code" href="../../d6/d6/sep_8h.html#a9">SepTokenAuthenticationId</a>( PrimaryToken );
00444 
00445         <span class="keywordflow">if</span> ( !ARGUMENT_PRESENT( CapturedSubsystemName )) {
00446 
00447             SubsystemName = &amp;<a class="code" href="../../d0/d5/se_8h.html#a107">SeSubsystemName</a>;
00448 
00449         } <span class="keywordflow">else</span> {
00450 
00451             SubsystemName = CapturedSubsystemName;
00452         }
00453 
00454         <span class="comment">//</span>
00455         <span class="comment">// A completely zero'd entry will be interpreted</span>
00456         <span class="comment">// as a "null string" or not supplied parameter.</span>
00457         <span class="comment">//</span>
00458         <span class="comment">// Initializing the entire array up front will allow</span>
00459         <span class="comment">// us to avoid filling in each not supplied entry.</span>
00460         <span class="comment">//</span>
00461 
00462         RtlZeroMemory (
00463            (PVOID) &amp;AuditParameters,
00464            <span class="keyword">sizeof</span>( AuditParameters )
00465            );
00466 
00467         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( SeAdtParmTypeNone == 0 );
00468 
00469         AuditParameters.CategoryId = SE_CATEGID_PRIVILEGE_USE;
00470         AuditParameters.AuditId = SE_AUDITID_PRIVILEGED_SERVICE;
00471         AuditParameters.ParameterCount = 0;
00472 
00473         <span class="keywordflow">if</span> ( AccessGranted ) {
00474 
00475             AuditParameters.Type = EVENTLOG_AUDIT_SUCCESS;
00476 
00477         } <span class="keywordflow">else</span> {
00478 
00479             AuditParameters.Type = EVENTLOG_AUDIT_FAILURE;
00480         }
00481 
00482 
00483     <span class="comment">//</span>
00484     <span class="comment">//    Parameter[0] - User Sid</span>
00485     <span class="comment">//</span>
00486 
00487         <a class="code" href="../../d7/d6/sepaudit_8c.html#a0">SepSetParmTypeSid</a>( AuditParameters, AuditParameters.ParameterCount, CapturedUserSid );
00488 
00489         AuditParameters.ParameterCount++;
00490 
00491     <span class="comment">//</span>
00492     <span class="comment">//    Parameter[1] - Subsystem name (if available)</span>
00493     <span class="comment">//</span>
00494 
00495     <a class="code" href="../../d7/d6/sepaudit_8c.html#a1">SepSetParmTypeString</a>( AuditParameters, AuditParameters.ParameterCount, SubsystemName );
00496 
00497     AuditParameters.ParameterCount++;
00498 
00499 
00500     <span class="comment">//</span>
00501     <span class="comment">//    Parameter[2] - Server</span>
00502     <span class="comment">//</span>
00503 
00504     <a class="code" href="../../d7/d6/sepaudit_8c.html#a1">SepSetParmTypeString</a>( AuditParameters, AuditParameters.ParameterCount, SubsystemName );
00505 
00506     AuditParameters.ParameterCount++;
00507 
00508 
00509     <span class="comment">//</span>
00510     <span class="comment">//    Parameter[3] - Service name (if available)</span>
00511     <span class="comment">//</span>
00512 
00513     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( CapturedServiceName )) {
00514 
00515         <a class="code" href="../../d7/d6/sepaudit_8c.html#a1">SepSetParmTypeString</a>( AuditParameters, AuditParameters.ParameterCount, CapturedServiceName );
00516     }
00517 
00518     AuditParameters.ParameterCount++;
00519 
00520     <span class="comment">//</span>
00521     <span class="comment">//    Parameter[3] - Subject's primary authentication ID</span>
00522     <span class="comment">//</span>
00523 
00524 
00525     <a class="code" href="../../d7/d6/sepaudit_8c.html#a5">SepSetParmTypeLogonId</a>( AuditParameters, AuditParameters.ParameterCount, PrimaryAuthenticationId );
00526 
00527     AuditParameters.ParameterCount++;
00528 
00529 
00530     <span class="comment">//</span>
00531     <span class="comment">//    Parameter[4] - Subject's client authentication ID</span>
00532     <span class="comment">//</span>
00533 
00534     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( ClientToken )) {
00535 
00536         <a class="code" href="../../d7/d6/sepaudit_8c.html#a5">SepSetParmTypeLogonId</a>( AuditParameters, AuditParameters.ParameterCount, ClientAuthenticationId );
00537 
00538     } <span class="keywordflow">else</span> {
00539 
00540         <a class="code" href="../../d7/d6/sepaudit_8c.html#a4">SepSetParmTypeNoLogon</a>( AuditParameters, AuditParameters.ParameterCount );
00541     }
00542 
00543     AuditParameters.ParameterCount++;
00544 
00545 
00546     <span class="comment">//</span>
00547     <span class="comment">//    Parameter[5] - Privileges used for open</span>
00548     <span class="comment">//</span>
00549 
00550 
00551     <span class="keywordflow">if</span> ( (CapturedPrivileges != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (CapturedPrivileges-&gt;PrivilegeCount &gt; 0) ) {
00552 
00553         <a class="code" href="../../d7/d6/sepaudit_8c.html#a7">SepSetParmTypePrivileges</a>( AuditParameters, AuditParameters.ParameterCount, CapturedPrivileges );
00554     }
00555 
00556     AuditParameters.ParameterCount++;
00557 
00558 
00559     <a class="code" href="../../d0/d5/adtlog_8c.html#a0">SepAdtLogAuditRecord</a>( &amp;AuditParameters );
00560 
00561     }
00562 
00563 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="sepaudit.c::SepAdtPrivilegeObjectAuditAlarm" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN SepAdtPrivilegeObjectAuditAlarm           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING CapturedSubsystemName&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>HandleId</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a> <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a11">ClientToken</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PrimaryToken</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessId</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PPRIVILEGE_SET&nbsp;</td>
          <td class="mdname" nowrap> <em>CapturedPrivileges</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessGranted</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00125">125</a> of file <a class="el" href="../../d8/d5/sepaudit_8c-source.html">sepaudit.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00039">ClientToken</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00126">PrimaryToken</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00871">RtlEqualSid()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01628">SeLocalSystemSid</a>, <a class="el" href="../../d2/d4/adtp_8h-source.html#l00264">SepAdtAuditThisEvent</a>, <a class="el" href="../../d1/d4/adtlog_8c-source.html#l00052">SepAdtLogAuditRecord()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l04587">SepFilterPrivilegeAudits()</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00088">SepSetParmTypeLogonId</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00083">SepSetParmTypeNoLogon</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00106">SepSetParmTypePrivileges</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00051">SepSetParmTypeSid</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00059">SepSetParmTypeString</a>, <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00076">SepSetParmTypeUlong</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00183">SepTokenAuthenticationId</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00176">SepTokenUserSid</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d4/d4/seaudit_8c-source.html#l02072">NtOpenObjectAuditAlarm()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l00406">NtPrivilegeObjectAuditAlarm()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l03736">SeAuditHandleCreation()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l01050">SepAccessCheckAndAuditAlarm()</a>, and <a class="el" href="../../d4/d4/seaudit_8c-source.html#l00650">SePrivilegeObjectAuditAlarm()</a>.
<p>
<pre class="fragment"><div>00138                    :
00139 
00140     Implements <a class="code" href="../../d3/d5/seaudit_8c.html#a12">NtPrivilegeObjectAuditAlarm</a> after parameters have been
00141     captured.
00142 
00143     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to generate audit and alarm messages when an
00144     attempt <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> to perform privileged operations on a <span class="keyword">protected</span>
00145     subsystem object after <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> already opened.  This routine may
00146     result in several messages being generated and sent to Port objects.
00147     This may result in a significant latency before returning.  Design of
00148     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a> that must call <span class="keyword">this</span> routine must take <span class="keyword">this</span> potential latency
00149     into account.  This may have an impact on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> approach taken <span class="keywordflow">for</span> data
00150     structure mutex locking, <span class="keywordflow">for</span> example.
00151 
00152     This API requires <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller have <a class="code" href="../../d0/d5/se_8h.html#a84">SeTcbPrivilege</a> privilege.  The test
00153     <span class="keywordflow">for</span> <span class="keyword">this</span> privilege <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> always against <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> primary token of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> calling
00154     process, allowing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller to be impersonating a client during <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00155     call with no ill effects.
00156 
00157     This routine will create an SE_ADT_PARAMETERS array organized as follows:
00158 
00159     Parameter[0] - User Sid
00160 
00161     Parameter[1] - Subsystem name (<span class="keywordflow">if</span> available)
00162 
00163     Parameter[2] - New handle <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>
00164 
00165     Parameter[3] - Subject's process <span class="keywordtype">id</span>
00166 
00167     Parameter[4] - Subject's primary authentication <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>
00168 
00169     Parameter[5] - Subject's client authentication <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a>
00170 
00171     Parameter[6] - Privileges used <span class="keywordflow">for</span> open
00172 
00173 Arguments:
00174 
00175     CapturedSubsystemName - Supplies a name string identifying <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00176         subsystem calling <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> routine.
00177 
00178     HandleId - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> unique value representing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client's handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00179         object.
00180 
00181     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a16">ClientToken</a> - Optionally provides a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client token
00182         (<a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> currently impersonating)
00183 
00184     <a class="code" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a> - Provides a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller's primary token.
00185 
00186     DesiredAccess - The desired access mask.  This mask must have been
00187         previously mapped to contain no generic accesses.
00188 
00189     CapturedPrivileges - The set of privileges required <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested
00190         operation.  Those privileges that were held by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subject are
00191         marked <span class="keyword">using</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> UsedForAccess flag of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> attributes
00192         associated with each privilege.
00193 
00194     AccessGranted - Indicates whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested access was granted or
00195         not.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access was granted.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of
00196         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access was not granted.
00197 
00198 Return value:
00199 
00200 --*/
00201 {
00202     SE_ADT_PARAMETER_ARRAY AuditParameters;
00203     PSID CapturedUserSid;
00204     LUID ClientAuthenticationId;
00205     LUID PrimaryAuthenticationId;
00206 
00207     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00208 
00209     <span class="comment">//</span>
00210     <span class="comment">// Determine if we are auditing the use of privileges</span>
00211     <span class="comment">//</span>
00212 
00213     <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d5/adtp_8h.html#a1">SepAdtAuditThisEvent</a>( AuditCategoryPrivilegeUse, &amp;AccessGranted ) &amp;&amp;
00214          <a class="code" href="../../d6/d6/sep_8h.html#a67">SepFilterPrivilegeAudits</a>( CapturedPrivileges )) {
00215 
00216         <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( ClientToken )) {
00217 
00218             CapturedUserSid = <a class="code" href="../../d6/d6/sep_8h.html#a8">SepTokenUserSid</a>( ClientToken );
00219             ClientAuthenticationId =  <a class="code" href="../../d6/d6/sep_8h.html#a9">SepTokenAuthenticationId</a>( ClientToken );
00220 
00221         } <span class="keywordflow">else</span> {
00222 
00223             CapturedUserSid = <a class="code" href="../../d6/d6/sep_8h.html#a8">SepTokenUserSid</a>( PrimaryToken );
00224         }
00225 
00226         <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>( SeLocalSystemSid, CapturedUserSid )) {
00227 
00228             <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00229         }
00230 
00231         PrimaryAuthenticationId = <a class="code" href="../../d6/d6/sep_8h.html#a9">SepTokenAuthenticationId</a>( PrimaryToken );
00232 
00233         <span class="comment">//</span>
00234         <span class="comment">// A completely zero'd entry will be interpreted</span>
00235         <span class="comment">// as a "null string" or not supplied parameter.</span>
00236         <span class="comment">//</span>
00237         <span class="comment">// Initializing the entire array up front will allow</span>
00238         <span class="comment">// us to avoid filling in each not supplied entry.</span>
00239         <span class="comment">//</span>
00240 
00241         RtlZeroMemory (
00242            (PVOID) &amp;AuditParameters,
00243            <span class="keyword">sizeof</span>( AuditParameters )
00244            );
00245 
00246         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( SeAdtParmTypeNone == 0 );
00247 
00248         AuditParameters.CategoryId = SE_CATEGID_PRIVILEGE_USE;
00249         AuditParameters.AuditId = SE_AUDITID_PRIVILEGED_OBJECT;
00250         AuditParameters.ParameterCount = 0;
00251 
00252         <span class="keywordflow">if</span> ( AccessGranted ) {
00253 
00254             AuditParameters.Type = EVENTLOG_AUDIT_SUCCESS;
00255 
00256         } <span class="keywordflow">else</span> {
00257 
00258             AuditParameters.Type = EVENTLOG_AUDIT_FAILURE;
00259         }
00260 
00261         <span class="comment">//</span>
00262         <span class="comment">//    Parameter[0] - User Sid</span>
00263         <span class="comment">//</span>
00264 
00265         <a class="code" href="../../d7/d6/sepaudit_8c.html#a0">SepSetParmTypeSid</a>( AuditParameters, AuditParameters.ParameterCount, CapturedUserSid );
00266 
00267         AuditParameters.ParameterCount++;
00268 
00269         <span class="comment">//</span>
00270         <span class="comment">//    Parameter[1] - Subsystem name (if available)</span>
00271         <span class="comment">//</span>
00272 
00273         <a class="code" href="../../d7/d6/sepaudit_8c.html#a1">SepSetParmTypeString</a>( AuditParameters, AuditParameters.ParameterCount, CapturedSubsystemName );
00274 
00275         AuditParameters.ParameterCount++;
00276 
00277         <span class="comment">//</span>
00278         <span class="comment">//    Parameter[1] - Subsystem name (if available)</span>
00279         <span class="comment">//</span>
00280 
00281         <a class="code" href="../../d7/d6/sepaudit_8c.html#a1">SepSetParmTypeString</a>( AuditParameters, AuditParameters.ParameterCount, CapturedSubsystemName );
00282 
00283         AuditParameters.ParameterCount++;
00284 
00285         <span class="comment">//</span>
00286         <span class="comment">//    Parameter[2] - New handle ID</span>
00287         <span class="comment">//</span>
00288 
00289         <a class="code" href="../../d7/d6/sepaudit_8c.html#a3">SepSetParmTypeUlong</a>( AuditParameters, AuditParameters.ParameterCount, (ULONG)((ULONG_PTR)HandleId) );
00290 
00291         AuditParameters.ParameterCount++;
00292 
00293         <span class="comment">//</span>
00294         <span class="comment">//    Parameter[3] - Subject's process id</span>
00295         <span class="comment">//</span>
00296 
00297         <a class="code" href="../../d7/d6/sepaudit_8c.html#a3">SepSetParmTypeUlong</a>( AuditParameters, AuditParameters.ParameterCount, (ULONG)((ULONG_PTR)ProcessId) );
00298 
00299         AuditParameters.ParameterCount++;
00300 
00301         <span class="comment">//</span>
00302         <span class="comment">//    Parameter[4] - Subject's primary authentication ID</span>
00303         <span class="comment">//</span>
00304 
00305         <a class="code" href="../../d7/d6/sepaudit_8c.html#a5">SepSetParmTypeLogonId</a>( AuditParameters, AuditParameters.ParameterCount, PrimaryAuthenticationId );
00306 
00307         AuditParameters.ParameterCount++;
00308 
00309         <span class="comment">//</span>
00310         <span class="comment">//    Parameter[5] - Subject's client authentication ID</span>
00311         <span class="comment">//</span>
00312 
00313         <span class="keywordflow">if</span> ( ARGUMENT_PRESENT( ClientToken )) {
00314 
00315             <a class="code" href="../../d7/d6/sepaudit_8c.html#a5">SepSetParmTypeLogonId</a>( AuditParameters, AuditParameters.ParameterCount, ClientAuthenticationId );
00316 
00317         } <span class="keywordflow">else</span> {
00318 
00319             <a class="code" href="../../d7/d6/sepaudit_8c.html#a4">SepSetParmTypeNoLogon</a>( AuditParameters, AuditParameters.ParameterCount );
00320         }
00321 
00322         AuditParameters.ParameterCount++;
00323 
00324         <span class="comment">//</span>
00325         <span class="comment">//    Parameter[6] - Privileges used for open</span>
00326         <span class="comment">//</span>
00327 
00328         <span class="keywordflow">if</span> ( (CapturedPrivileges != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (CapturedPrivileges-&gt;PrivilegeCount &gt; 0) ) {
00329 
00330             <a class="code" href="../../d7/d6/sepaudit_8c.html#a7">SepSetParmTypePrivileges</a>( AuditParameters, AuditParameters.ParameterCount, CapturedPrivileges );
00331         }
00332 
00333         AuditParameters.ParameterCount++;
00334 
00335         <a class="code" href="../../d0/d5/adtlog_8c.html#a0">SepAdtLogAuditRecord</a>( &amp;AuditParameters );
00336 
00337         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00338 
00339     }
00340 
00341     <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00342 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="sepaudit.c::SepQueryNameString" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> POBJECT_NAME_INFORMATION SepQueryNameString           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Object</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
*++ 
<p>

<p>
Definition at line <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l02324">2324</a> of file <a class="el" href="../../d8/d5/sepaudit_8c-source.html">sepaudit.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d0/obquery_8c-source.html#l00713">ObQueryNameString()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d4/d4/seaudit_8c-source.html#l03538">SeCreateObjectAuditAlarm()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l02765">SeOpenObjectAuditAlarm()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l03085">SeOpenObjectForDeleteAuditAlarm()</a>, and <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l01907">SepAdtObjectReferenceAuditAlarm()</a>.
<p>
<pre class="fragment"><div>02330                    :
02331 
02332     Takes a pointer to an object and returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.
02333 
02334 Arguments:
02335 
02336     Object - a pointer to an object.
02337 
02338 
02339 Return Value:
02340 
02341     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to a buffer containing a POBJECT_NAME_INFORMATION
02342     structure containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.  The string <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
02343     allocated <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> of paged <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> and should be freed by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller.
02344 
02345     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> may also be returned.
02346 
02347 
02348 --*/
02349 
02350 {
02351     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02352     ULONG ReturnLength = 0;
02353     POBJECT_NAME_INFORMATION ObjectNameInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02354     PUNICODE_STRING ObjectName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02355 
02356     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02357 
02358     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d1/obquery_8c.html#a7">ObQueryNameString</a>(
02359                  Object,
02360                  ObjectNameInfo,
02361                  0,
02362                  &amp;ReturnLength
02363                  );
02364 
02365     <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_INFO_LENGTH_MISMATCH ) {
02366 
02367         ObjectNameInfo = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( PagedPool, ReturnLength, 'nOeS' );
02368 
02369         <span class="keywordflow">if</span> ( ObjectNameInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
02370 
02371             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d1/obquery_8c.html#a7">ObQueryNameString</a>(
02372                         Object,
02373                         ObjectNameInfo,
02374                         ReturnLength,
02375                         &amp;ReturnLength
02376                         );
02377 
02378             <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
02379 
02380                 <span class="keywordflow">if</span> (ObjectNameInfo-&gt;Name.Length != 0) {
02381 
02382                     <span class="keywordflow">return</span>( ObjectNameInfo );
02383 
02384                 } <span class="keywordflow">else</span> {
02385 
02386                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( ObjectNameInfo );
02387                     <span class="keywordflow">return</span>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
02388                 }
02389             }
02390         }
02391     }
02392 
02393     <span class="keywordflow">return</span>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
02394 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="sepaudit.c::SepQueryTypeString" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PUNICODE_STRING SepQueryTypeString           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Object</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l02400">2400</a> of file <a class="el" href="../../d8/d5/sepaudit_8c-source.html">sepaudit.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d0/obquery_8c-source.html#l01082">ObQueryTypeName()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d4/d4/seaudit_8c-source.html#l02765">SeOpenObjectAuditAlarm()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l03085">SeOpenObjectForDeleteAuditAlarm()</a>, and <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l01907">SepAdtObjectReferenceAuditAlarm()</a>.
<p>
<pre class="fragment"><div>02405                    :
02406 
02407     Takes a pointer to an object and returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.
02408 
02409 Arguments:
02410 
02411     Object - a pointer to an object.
02412 
02413 
02414 Return Value:
02415 
02416     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to a UNICODE_STRING that contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object
02417     <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>.  The string <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allocated <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> of paged <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> and should be freed
02418     by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller.
02419 
02420     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> may also be returned.
02421 
02422 
02423 --*/
02424 
02425 {
02426 
02427     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02428     PUNICODE_STRING TypeName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02429     ULONG ReturnLength;
02430 
02431     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02432 
02433     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d1/obquery_8c.html#a8">ObQueryTypeName</a>(
02434                  Object,
02435                  TypeName,
02436                  0,
02437                  &amp;ReturnLength
02438                  );
02439 
02440     <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_INFO_LENGTH_MISMATCH ) {
02441 
02442         TypeName = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( PagedPool, ReturnLength, 'nTeS' );
02443 
02444         <span class="keywordflow">if</span> ( TypeName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
02445 
02446             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d1/obquery_8c.html#a8">ObQueryTypeName</a>(
02447                         Object,
02448                         TypeName,
02449                         ReturnLength,
02450                         &amp;ReturnLength
02451                         );
02452 
02453             <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
02454 
02455                 <span class="keywordflow">return</span>( TypeName );
02456             }
02457         }
02458     }
02459 
02460     <span class="keywordflow">return</span>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
02461 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:35 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
