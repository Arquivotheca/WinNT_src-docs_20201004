<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: lpcsend.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>lpcsend.c</h1><a href="../../d6/d7/lpcsend_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    lpcsend.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    Local Inter-Process Communication (LPC) request system services.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Steve Wood (stevewo) 15-May-1989</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:</span>
00018 <span class="comment"></span>
00019 <span class="comment">--*/</span>
00020 
00021 <span class="preprocessor">#include "<a class="code" href="../../d0/d7/lpcp_8h.html">lpcp.h</a>"</span>
00022 
00023 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00024 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtRequestPort)</span>
00025 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtRequestWaitReplyPort)</span>
00026 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,LpcRequestPort)</span>
00027 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,LpcRequestWaitReplyPort)</span>
00028 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00029 <span class="preprocessor"></span>
00030 
00031 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00032"></a><a class="code" href="../../d6/d7/lpcsend_8c.html#a0">00032</a> <a class="code" href="../../d6/d7/lpcsend_8c.html#a0">NtRequestPort</a> (
00033     IN HANDLE PortHandle,
00034     IN PPORT_MESSAGE RequestMessage
00035     )
00036 
00037 <span class="comment">/*++</span>
00038 <span class="comment"></span>
00039 <span class="comment">Routine Description:</span>
00040 <span class="comment"></span>
00041 <span class="comment">    A client and server process send datagram messages using this procedure.</span>
00042 <span class="comment"></span>
00043 <span class="comment">    The message pointed to by the RequestMessage parameter is placed in the</span>
00044 <span class="comment">    message queue of the port connected to the communication port specified</span>
00045 <span class="comment">    by the PortHandle parameter.  This service returns an error if PortHandle</span>
00046 <span class="comment">    is invalid or if the MessageId field of the PortMessage structure is</span>
00047 <span class="comment">    non-zero.</span>
00048 <span class="comment"></span>
00049 <span class="comment">Arguments:</span>
00050 <span class="comment"></span>
00051 <span class="comment">    PortHandle - Specifies the handle of the communication port to send</span>
00052 <span class="comment">        the request message to.</span>
00053 <span class="comment"></span>
00054 <span class="comment">    RequestMessage - Specifies a pointer to the request message.  The Type</span>
00055 <span class="comment">        field of the message is set to LPC_DATAGRAM by the service.</span>
00056 <span class="comment"></span>
00057 <span class="comment">Return Value:</span>
00058 <span class="comment"></span>
00059 <span class="comment">    NTSTATUS - A status code that indicates whether or not the operation was</span>
00060 <span class="comment">        successful.</span>
00061 <span class="comment"></span>
00062 <span class="comment">--*/</span>
00063 
00064 {
00065     <a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html">PLPCP_PORT_OBJECT</a> PortObject;
00066     <a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html">PLPCP_PORT_OBJECT</a> QueuePort;
00067     PORT_MESSAGE CapturedRequestMessage;
00068     ULONG MsgType;
00069     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00070     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00071     <a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html">PLPCP_MESSAGE</a> Msg;
00072 
00073     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00074 
00075     <span class="comment">//</span>
00076     <span class="comment">//  Get previous processor mode and validate parameters</span>
00077     <span class="comment">//</span>
00078 
00079     PreviousMode = KeGetPreviousMode();
00080 
00081     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00082 
00083         <span class="keywordflow">try</span> {
00084 
00085             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a>,
00086                           <span class="keyword">sizeof</span>( *<a class="code" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a> ),
00087                           <span class="keyword">sizeof</span>( ULONG ));
00088 
00089             CapturedRequestMessage = *<a class="code" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a>;
00090             CapturedRequestMessage.u2.s2.Type &amp;= ~LPC_KERNELMODE_MESSAGE;
00091 
00092         } except( <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
00093 
00094             <span class="keywordflow">return</span> GetExceptionCode();
00095         }
00096 
00097         <span class="keywordflow">if</span> (CapturedRequestMessage.u2.s2.Type != 0) {
00098 
00099             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00100         }
00101 
00102     } <span class="keywordflow">else</span> {
00103 
00104         <span class="comment">//</span>
00105         <span class="comment">//  This is a kernel mode caller</span>
00106         <span class="comment">//</span>
00107 
00108         CapturedRequestMessage = *<a class="code" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a>;
00109 
00110         <span class="keywordflow">if</span> ((CapturedRequestMessage.u2.s2.Type &amp; ~LPC_KERNELMODE_MESSAGE) != 0) {
00111 
00112             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00113         }
00114     }
00115 
00116     <span class="comment">//</span>
00117     <span class="comment">//  Make sure that the caller has given us some data to send</span>
00118     <span class="comment">//</span>
00119 
00120     <span class="keywordflow">if</span> (CapturedRequestMessage.u2.s2.DataInfoOffset != 0) {
00121 
00122         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00123     }
00124 
00125     <span class="comment">//</span>
00126     <span class="comment">//  Make sure DataLength is valid with respect to header size and total length</span>
00127     <span class="comment">//</span>
00128 
00129     <span class="keywordflow">if</span> ((((CLONG)CapturedRequestMessage.u1.s1.DataLength) + <span class="keyword">sizeof</span>( PORT_MESSAGE )) &gt;
00130         ((CLONG)CapturedRequestMessage.u1.s1.TotalLength)) {
00131 
00132         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00133     }
00134 
00135     <span class="comment">//</span>
00136     <span class="comment">//  Reference the communication port object by handle.  Return status if</span>
00137     <span class="comment">//  unsuccessful.</span>
00138     <span class="comment">//</span>
00139 
00140     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d7/lpcp_8h.html#a10">LpcpReferencePortObject</a>( <a class="code" href="../../d7/d7/uclient_8c.html#a3">PortHandle</a>,
00141                                       0,
00142                                       PreviousMode,
00143                                       &amp;PortObject );
00144 
00145     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00146 
00147         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00148     }
00149 
00150     <span class="comment">//</span>
00151     <span class="comment">//  Validate the message length</span>
00152     <span class="comment">//</span>
00153 
00154     <span class="keywordflow">if</span> (((ULONG)CapturedRequestMessage.u1.s1.TotalLength &gt; PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o9">MaxMessageLength</a>) ||
00155         ((ULONG)CapturedRequestMessage.u1.s1.TotalLength &lt;= (ULONG)CapturedRequestMessage.u1.s1.DataLength)) {
00156 
00157         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( PortObject );
00158 
00159         <span class="keywordflow">return</span> STATUS_PORT_MESSAGE_TOO_LONG;
00160     }
00161 
00162     <span class="comment">//</span>
00163     <span class="comment">//  Determine which port to queue the message to and get client</span>
00164     <span class="comment">//  port context if client sending to server.  Also validate</span>
00165     <span class="comment">//  length of message being sent.</span>
00166     <span class="comment">//</span>
00167 
00168     <span class="comment">//</span>
00169     <span class="comment">//  Allocate and initialize the LPC message to send off</span>
00170     <span class="comment">//</span>
00171 
00172     <a class="code" href="../../d0/d7/lpcp_8h.html#a3">LpcpAcquireLpcpLock</a>();
00173 
00174     Msg = (<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html">PLPCP_MESSAGE</a>)<a class="code" href="../../d3/d7/lpcqueue_8c.html#a4">LpcpAllocateFromPortZone</a>( CapturedRequestMessage.u1.s1.TotalLength );
00175 
00176     <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
00177 
00178     <span class="keywordflow">if</span> (Msg == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00179 
00180         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( PortObject );
00181 
00182         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00183     }
00184 
00185     Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o6">RepliedToThread</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00186     Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o7">PortContext</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00187     MsgType = CapturedRequestMessage.u2.s2.Type | LPC_DATAGRAM;
00188 
00189     <span class="keywordflow">try</span> {
00190 
00191         <a class="code" href="../../d0/d7/lpcp_8h.html#a31">LpcpMoveMessage</a>( &amp;Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>,
00192                          &amp;CapturedRequestMessage,
00193                          (<a class="code" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a> + 1),
00194                          MsgType,
00195                          &amp;<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;Cid );
00196 
00197     } except( <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
00198 
00199         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00200     }
00201 
00202     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00203 
00204         <a class="code" href="../../d3/d7/lpcqueue_8c.html#a5">LpcpFreeToPortZone</a>( Msg, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00205 
00206         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( PortObject );
00207 
00208         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00209     }
00210 
00211     <span class="comment">//</span>
00212     <span class="comment">//  Acquire the global Lpc mutex that guards the LpcReplyMessage</span>
00213     <span class="comment">//  field of the thread and the request message queue.  Stamp the</span>
00214     <span class="comment">//  request message with a serial number, insert the message at</span>
00215     <span class="comment">//  the tail of the request message queue and remember the address</span>
00216     <span class="comment">//  of the message in the LpcReplyMessage field for the current thread.</span>
00217     <span class="comment">//</span>
00218     <span class="comment">//  This all needs to be performed with APCs disabled to avoid</span>
00219     <span class="comment">//  the situation where something gets put on the queue and this</span>
00220     <span class="comment">//  thread gets suspended before being able to release the semaphore.</span>
00221     <span class="comment">//</span>
00222 
00223     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00224 
00225     <a class="code" href="../../d0/d7/lpcp_8h.html#a3">LpcpAcquireLpcpLock</a>();
00226 
00227     <span class="comment">//</span>
00228     <span class="comment">//  Based on what type of port the caller gave us we'll need to get</span>
00229     <span class="comment">//  the port to actually queue the message off to.</span>
00230     <span class="comment">//</span>
00231 
00232     <span class="keywordflow">if</span> ((PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o1">Flags</a> &amp; <a class="code" href="../../d2/d6/lpc_8h.html#a3">PORT_TYPE</a>) != <a class="code" href="../../d2/d6/lpc_8h.html#a4">SERVER_CONNECTION_PORT</a>) {
00233 
00234         <span class="comment">//</span>
00235         <span class="comment">//  The caller didn't give us a connection port so find the</span>
00236         <span class="comment">//  connection port for this port.  If it is null then we'll</span>
00237         <span class="comment">//  fall through without sending a message</span>
00238         <span class="comment">//</span>
00239 
00240         QueuePort = PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o3">ConnectedPort</a>;
00241 
00242         <span class="comment">//</span>
00243         <span class="comment">//  Check if the queue port is in process of going away</span>
00244         <span class="comment">//</span>
00245 
00246         <span class="keywordflow">if</span> ( (QueuePort != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00247              (QueuePort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o1">Flags</a> &amp; <a class="code" href="../../d2/d6/lpc_8h.html#a11">PORT_DELETED</a>) ){
00248 
00249 <span class="comment">//            DbgPrint("Queueport %08lx is going away\n", QueuePort);</span>
00250 
00251             QueuePort = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00252         }
00253 
00254         <span class="keywordflow">if</span> ( QueuePort != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00255 
00256             <span class="comment">//</span>
00257             <span class="comment">//  If the port is a client communication port then give the</span>
00258             <span class="comment">//  message the proper port context</span>
00259             <span class="comment">//</span>
00260 
00261             <span class="keywordflow">if</span> ((PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o1">Flags</a> &amp; <a class="code" href="../../d2/d6/lpc_8h.html#a3">PORT_TYPE</a>) == <a class="code" href="../../d2/d6/lpc_8h.html#a7">CLIENT_COMMUNICATION_PORT</a>) {
00262 
00263                 Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o7">PortContext</a> = QueuePort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o8">PortContext</a>;
00264                 QueuePort = PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o2">ConnectionPort</a>;
00265 
00266             <span class="comment">//</span>
00267             <span class="comment">//  **** this test and conditional assignment looks bogus because</span>
00268             <span class="comment">//       we already set queue port</span>
00269             <span class="comment">//</span>
00270 
00271             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o1">Flags</a> &amp; <a class="code" href="../../d2/d6/lpc_8h.html#a3">PORT_TYPE</a>) != <a class="code" href="../../d2/d6/lpc_8h.html#a6">SERVER_COMMUNICATION_PORT</a>) {
00272 
00273                 QueuePort = PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o2">ConnectionPort</a>;
00274             }
00275         }
00276 
00277     } <span class="keywordflow">else</span> {
00278 
00279         <span class="comment">//</span>
00280         <span class="comment">//  The caller supplied a server connection port so that is the port</span>
00281         <span class="comment">//  we queue off to</span>
00282         <span class="comment">//</span>
00283 
00284         QueuePort = PortObject;
00285     }
00286 
00287     <span class="comment">//</span>
00288     <span class="comment">//  At this point we have an LPC message ready to send and if queue port is</span>
00289     <span class="comment">//  not null then we have a port to actually send the message off to</span>
00290     <span class="comment">//</span>
00291 
00292     <span class="keywordflow">if</span> (QueuePort != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00293 
00294         <span class="comment">//</span>
00295         <span class="comment">//  Reference the QueuePort to prevent this port evaporating under us</span>
00296         <span class="comment">//</span>
00297 
00298         <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>( QueuePort );
00299 
00300         <span class="comment">//</span>
00301         <span class="comment">//  Finish filling in the messsage and then insert it in the queue</span>
00302         <span class="comment">//</span>
00303 
00304         Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>.MessageId = <a class="code" href="../../d0/d7/lpcp_8h.html#a0">LpcpGenerateMessageId</a>();
00305         Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>.CallbackId = 0;
00306 
00307         <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;LpcReplyMessageId = 0;
00308 
00309         InsertTailList( &amp;QueuePort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o4">MsgQueue</a>.<a class="code" href="../../d0/d5/struct__LPCP__PORT__QUEUE.html#o2">ReceiveHead</a>, &amp;Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o0">Entry</a> );
00310 
00311         <a class="code" href="../../d0/d7/lpcp_8h.html#a13">LpcpTrace</a>(( <span class="stringliteral">"%s Send DataGram (%s) Msg %lx [%08x %08x %08x %08x] to Port %lx (%s)\n"</span>,
00312                     <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;ImageFileName,
00313                     LpcpMessageTypeName[ Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>.u2.s2.Type &amp; ~LPC_KERNELMODE_MESSAGE ],
00314                     Msg,
00315                     *((PULONG)(Msg+1)+0),
00316                     *((PULONG)(Msg+1)+1),
00317                     *((PULONG)(Msg+1)+2),
00318                     *((PULONG)(Msg+1)+3),
00319                     QueuePort,
00320                     <a class="code" href="../../d7/d6/lpcinit_8c.html#a5">LpcpGetCreatorName</a>( QueuePort )));
00321 
00322         <span class="comment">//</span>
00323         <span class="comment">//  Release the mutex, increment the request message queue</span>
00324         <span class="comment">//  semaphore by one for the newly inserted request message</span>
00325         <span class="comment">//  then exit the critical region.</span>
00326         <span class="comment">//</span>
00327 
00328         <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
00329 
00330         <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>( QueuePort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o4">MsgQueue</a>.<a class="code" href="../../d0/d5/struct__LPCP__PORT__QUEUE.html#o1">Semaphore</a>,
00331                             <a class="code" href="../../d7/d8/exboosts_8h.html#a2">LPC_RELEASE_WAIT_INCREMENT</a>,
00332                             1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
00333                             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00334 
00335         <span class="comment">//</span>
00336         <span class="comment">//  If this is a waitable port then we'll need to set the event for</span>
00337         <span class="comment">//  anyone that was waiting on the port</span>
00338         <span class="comment">//</span>
00339 
00340         <span class="keywordflow">if</span> ( QueuePort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o1">Flags</a> &amp; <a class="code" href="../../d2/d6/lpc_8h.html#a8">PORT_WAITABLE</a> ) {
00341 
00342             <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( &amp;QueuePort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o18">WaitEvent</a>,
00343                         <a class="code" href="../../d7/d8/exboosts_8h.html#a2">LPC_RELEASE_WAIT_INCREMENT</a>,
00344                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00345         }
00346 
00347         <span class="comment">//</span>
00348         <span class="comment">//  Exit the critical region and release the port object</span>
00349         <span class="comment">//</span>
00350 
00351         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00352 
00353         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( QueuePort );
00354         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( PortObject );
00355 
00356         <span class="comment">//</span>
00357         <span class="comment">//  And return to our caller.  This is the only successful way out</span>
00358         <span class="comment">//  of this routine</span>
00359         <span class="comment">//</span>
00360 
00361         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00362 
00363     }
00364 
00365     <span class="comment">//</span>
00366     <span class="comment">//  At this point we have a message but not a valid port to queue it off</span>
00367     <span class="comment">//  to so we'll free up the port object and release the unused message</span>
00368     <span class="comment">//</span>
00369     <span class="comment">//  We have to do the dereference outside of the lpcp lock because the</span>
00370     <span class="comment">//  object manager now speical cases lpc object types and synchronizes</span>
00371     <span class="comment">//  their removal with the lpcp lock.</span>
00372     <span class="comment">//</span>
00373 
00374     <a class="code" href="../../d3/d7/lpcqueue_8c.html#a5">LpcpFreeToPortZone</a>( Msg, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00375 
00376     <span class="comment">//</span>
00377     <span class="comment">//  Release our lock and enable APC again</span>
00378     <span class="comment">//</span>
00379 
00380     <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
00381 
00382     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( PortObject );
00383 
00384     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00385 
00386     <span class="comment">//</span>
00387     <span class="comment">//  And return the error status to our caller</span>
00388     <span class="comment">//</span>
00389 
00390     <span class="keywordflow">return</span> STATUS_PORT_DISCONNECTED;
00391 }
00392 
00393 
00394 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00395"></a><a class="code" href="../../d6/d7/lpcsend_8c.html#a1">00395</a> <a class="code" href="../../d6/d7/lpcsend_8c.html#a1">NtRequestWaitReplyPort</a> (
00396     IN HANDLE PortHandle,
00397     IN PPORT_MESSAGE RequestMessage,
00398     OUT PPORT_MESSAGE ReplyMessage
00399     )
00400 
00401 <span class="comment">/*++</span>
00402 <span class="comment"></span>
00403 <span class="comment">Routine Description:</span>
00404 <span class="comment"></span>
00405 <span class="comment">    A client and server process can send a request and wait for a reply using</span>
00406 <span class="comment">    the NtRequestWaitReplyPort service.</span>
00407 <span class="comment"></span>
00408 <span class="comment">    If the Type field of the RequestMessage structure is euqal to LPC_REQUEST,</span>
00409 <span class="comment">    then this is identified as a callback request.  The ClientId and MessageId</span>
00410 <span class="comment">    fields are used to identify the thread that is waiting for a reply.  This</span>
00411 <span class="comment">    thread is unblocked and the current thread that called this service then</span>
00412 <span class="comment">    blocks waiting for a reply.</span>
00413 <span class="comment"></span>
00414 <span class="comment">    The Type field of the message is set to LPC_REQUEST by the service.</span>
00415 <span class="comment">    Otherwise the Type field of the message must be zero and it will be set to</span>
00416 <span class="comment">    LPC_REQUEST by the service.  The message pointed to by the RequestMessage</span>
00417 <span class="comment">    parameter is placed in the message queue of the port connected to the</span>
00418 <span class="comment">    communication port specified by the PortHandle parameter.  This service</span>
00419 <span class="comment">    returns an error if PortHandle is invalid.  The calling thread then blocks</span>
00420 <span class="comment">    waiting for a reply.</span>
00421 <span class="comment"></span>
00422 <span class="comment">    The reply message is stored in the location pointed to by the ReplyMessage</span>
00423 <span class="comment">    parameter.  The ClientId, MessageId and message type fields will be filled</span>
00424 <span class="comment">    in by the service.</span>
00425 <span class="comment"></span>
00426 <span class="comment">Arguments:</span>
00427 <span class="comment"></span>
00428 <span class="comment">    PortHandle - Specifies the handle of the communication port to send the</span>
00429 <span class="comment">        request message to.</span>
00430 <span class="comment"></span>
00431 <span class="comment">    RequestMessage - Specifies a pointer to a request message to send.</span>
00432 <span class="comment"></span>
00433 <span class="comment">    ReplyMessage - Specifies the address of a variable that will receive the</span>
00434 <span class="comment">        reply message.  This parameter may point to the same buffer as the</span>
00435 <span class="comment">        RequestMessage parameter.</span>
00436 <span class="comment"></span>
00437 <span class="comment">Return Value:</span>
00438 <span class="comment"></span>
00439 <span class="comment">    NTSTATUS - A status code that indicates whether or not the operation was</span>
00440 <span class="comment">        successful.</span>
00441 <span class="comment"></span>
00442 <span class="comment">--*/</span>
00443 
00444 {
00445     <a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html">PLPCP_PORT_OBJECT</a> PortObject;
00446     <a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html">PLPCP_PORT_OBJECT</a> QueuePort;
00447     <a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html">PLPCP_PORT_OBJECT</a> RundownPort;
00448     PORT_MESSAGE CapturedRequestMessage;
00449     ULONG MsgType;
00450     <a class="code" href="../../d8/d7/struct__KSEMAPHORE.html">PKSEMAPHORE</a> ReleaseSemaphore;
00451     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00452     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00453     <a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html">PLPCP_MESSAGE</a> Msg;
00454     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> CurrentThread;
00455     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> WakeupThread;
00456     BOOLEAN CallbackRequest;
00457     PORT_DATA_INFORMATION CapturedDataInfo;
00458 
00459     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00460 
00461     <span class="comment">//</span>
00462     <span class="comment">//  We cannot wait for a reply if the current thread is exiting</span>
00463     <span class="comment">//</span>
00464 
00465     CurrentThread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00466 
00467     <span class="keywordflow">if</span> (CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o32">LpcExitThreadCalled</a>) {
00468 
00469         <span class="keywordflow">return</span> STATUS_THREAD_IS_TERMINATING;
00470     }
00471 
00472     <span class="comment">//</span>
00473     <span class="comment">//  Get previous processor mode and probe output arguments if necessary.</span>
00474     <span class="comment">//</span>
00475 
00476     PreviousMode = KeGetPreviousMode();
00477 
00478     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00479 
00480         <span class="keywordflow">try</span> {
00481 
00482             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a>,
00483                           <span class="keyword">sizeof</span>( *<a class="code" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a> ),
00484                           <span class="keyword">sizeof</span>( ULONG ));
00485 
00486             CapturedRequestMessage = *<a class="code" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a>;
00487             CapturedRequestMessage.u2.s2.Type &amp;= ~LPC_KERNELMODE_MESSAGE;
00488 
00489             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>( <a class="code" href="../../d3/d8/client_8c.html#a125">ReplyMessage</a>,
00490                            <span class="keyword">sizeof</span>( *<a class="code" href="../../d3/d8/client_8c.html#a125">ReplyMessage</a> ),
00491                            <span class="keyword">sizeof</span>( ULONG ));
00492 
00493             <span class="comment">//</span>
00494             <span class="comment">//  Make sure that if this message has a data info offset that</span>
00495             <span class="comment">//  the port data information actually fits in the message.</span>
00496             <span class="comment">//</span>
00497             <span class="comment">//  We first check that the DataInfoOffset doesn't put us beyond</span>
00498             <span class="comment">//  the end of the message.</span>
00499             <span class="comment">//</span>
00500             <span class="comment">//  Then we capture the data info record and compute a pointer to</span>
00501             <span class="comment">//  the first unused data entry based on the supplied count.  If</span>
00502             <span class="comment">//  the start of the message plus its total length doesn't come</span>
00503             <span class="comment">//  up to the first unsused data entry then the last valid data</span>
00504             <span class="comment">//  entry doesn't fit in the message buffer.  Also if the data</span>
00505             <span class="comment">//  entry pointer that we compute is less than the data info</span>
00506             <span class="comment">//  pointer then we must have wrapped.</span>
00507             <span class="comment">//</span>
00508 
00509             <span class="keywordflow">if</span> (CapturedRequestMessage.u2.s2.DataInfoOffset != 0) {
00510 
00511                 PPORT_DATA_INFORMATION DataInfo;
00512                 PPORT_DATA_ENTRY DataEntry;
00513 
00514                 <span class="keywordflow">if</span> (((ULONG)CapturedRequestMessage.u2.s2.DataInfoOffset) &gt; (CapturedRequestMessage.u1.s1.TotalLength - <span class="keyword">sizeof</span>(PORT_DATA_INFORMATION))) {
00515 
00516                     <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00517                 }
00518 
00519                 <span class="keywordflow">if</span> ((ULONG)CapturedRequestMessage.u2.s2.DataInfoOffset &lt; <span class="keyword">sizeof</span>(PORT_MESSAGE)) {
00520 
00521                     <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00522                 }
00523 
00524                 DataInfo = (PPORT_DATA_INFORMATION)(((PUCHAR)<a class="code" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a>) + CapturedRequestMessage.u2.s2.DataInfoOffset);
00525 
00526                 <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( DataInfo,
00527                               <span class="keyword">sizeof</span>( *DataInfo ),
00528                               <span class="keyword">sizeof</span>( ULONG ));
00529 
00530                 CapturedDataInfo = *DataInfo;
00531 
00532                 DataEntry = &amp;(DataInfo-&gt;DataEntries[CapturedDataInfo.CountDataEntries]);
00533 
00534 
00535                 <span class="comment">//</span>
00536                 <span class="comment">//  The computation of above address, could overflow. So we have to return STATUS_INVALID_PARAMETER if :</span>
00537                 <span class="comment">//      CountDataEntries * sizeof(DataEntries) &lt; CountDataEntries</span>
00538                 <span class="comment">//</span>
00539                 <span class="comment">//  But CountDataEntries * sizeof(DataEntries) = DataEntry - DataInfo - sizeof(CountDataEntries)</span>
00540                 <span class="comment">//  and the final condition will be:</span>
00541                 <span class="comment">//</span>
00542                 <span class="comment">//      DataEntry - DataInfo - sizeof(CountDataEntries) &lt; CountDataEntries</span>
00543                 <span class="comment">//</span>
00544                 <span class="comment">//  That is equivalent with:</span>
00545                 <span class="comment">//      DataEntry &lt; DataInfo + sizeof(CountDataEntries) + CountDataEntries</span>
00546                 <span class="comment">//</span>
00547                 <span class="comment">//  ( The condition (DataEntry &lt; DataInfo) used in the previous versions</span>
00548                 <span class="comment">//    is always verified by this one )</span>
00549                 <span class="comment">//</span>
00550 
00551 
00552                 <span class="keywordflow">if</span> (((PUCHAR)DataEntry &lt; (PUCHAR)DataInfo + <span class="keyword">sizeof</span>(CapturedDataInfo.CountDataEntries) + CapturedDataInfo.CountDataEntries) ||
00553                     ((((PUCHAR)<a class="code" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a>) + CapturedRequestMessage.u1.s1.TotalLength) &lt; (PUCHAR)DataEntry)) {
00554 
00555                     <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00556                 }
00557             }
00558 
00559         } except( <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
00560 
00561             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00562 
00563             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00564         }
00565 
00566     } <span class="keywordflow">else</span> {
00567 
00568         CapturedRequestMessage = *<a class="code" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a>;
00569 
00570         <span class="keywordflow">if</span> (CapturedRequestMessage.u2.s2.DataInfoOffset != 0) {
00571 
00572             PPORT_DATA_INFORMATION DataInfo;
00573 
00574             DataInfo = (PPORT_DATA_INFORMATION)(((PUCHAR)<a class="code" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a>) + CapturedRequestMessage.u2.s2.DataInfoOffset);
00575 
00576             CapturedDataInfo = *DataInfo;
00577         }
00578     }
00579 
00580     <span class="comment">//</span>
00581     <span class="comment">//  If the message type is an lpc request then say we need a callback.</span>
00582     <span class="comment">//  Otherwise if it not an lpc request and it is not a kernel mode message</span>
00583     <span class="comment">//  then it is an illegal parameter.  A third case is if the type is</span>
00584     <span class="comment">//  a kernel mode message in which case we make it look like an lpc request</span>
00585     <span class="comment">//  but without the callback.</span>
00586     <span class="comment">//</span>
00587 
00588     <span class="keywordflow">if</span> ((CapturedRequestMessage.u2.s2.Type &amp; ~LPC_KERNELMODE_MESSAGE) == LPC_REQUEST) {
00589 
00590         CallbackRequest = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00591 
00592     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((CapturedRequestMessage.u2.s2.Type &amp; ~LPC_KERNELMODE_MESSAGE) != 0) {
00593 
00594         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00595 
00596     } <span class="keywordflow">else</span> {
00597 
00598         CapturedRequestMessage.u2.s2.Type |= LPC_REQUEST;
00599         CallbackRequest = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00600     }
00601 
00602     <span class="comment">//</span>
00603     <span class="comment">//  Make sure DataLength is valid with respect to header size and total length</span>
00604     <span class="comment">//</span>
00605 
00606     <span class="keywordflow">if</span> ((((CLONG)CapturedRequestMessage.u1.s1.DataLength) + <span class="keyword">sizeof</span>( PORT_MESSAGE )) &gt;
00607         ((CLONG)CapturedRequestMessage.u1.s1.TotalLength)) {
00608 
00609         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00610     }
00611 
00612     <span class="comment">//</span>
00613     <span class="comment">//  Reference the communication port object by handle.  Return status if</span>
00614     <span class="comment">//  unsuccessful.</span>
00615     <span class="comment">//</span>
00616 
00617     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d7/lpcp_8h.html#a10">LpcpReferencePortObject</a>( <a class="code" href="../../d7/d7/uclient_8c.html#a3">PortHandle</a>,
00618                                       0,
00619                                       PreviousMode,
00620                                       &amp;PortObject );
00621 
00622     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00623 
00624         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00625     }
00626 
00627     <span class="comment">//</span>
00628     <span class="comment">//  Validate the message length</span>
00629     <span class="comment">//</span>
00630 
00631     <span class="keywordflow">if</span> (((ULONG)CapturedRequestMessage.u1.s1.TotalLength &gt; PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o9">MaxMessageLength</a>) ||
00632         ((ULONG)CapturedRequestMessage.u1.s1.TotalLength &lt;= (ULONG)CapturedRequestMessage.u1.s1.DataLength)) {
00633 
00634         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( PortObject );
00635 
00636         <span class="keywordflow">return</span> STATUS_PORT_MESSAGE_TOO_LONG;
00637     }
00638 
00639     <span class="comment">//</span>
00640     <span class="comment">//  Determine which port to queue the message to and get client</span>
00641     <span class="comment">//  port context if client sending to server.  Also validate</span>
00642     <span class="comment">//  length of message being sent.</span>
00643     <span class="comment">//</span>
00644 
00645     <span class="comment">//</span>
00646     <span class="comment">//  Allocate and initialize the LPC message to send off</span>
00647     <span class="comment">//</span>
00648 
00649     <a class="code" href="../../d0/d7/lpcp_8h.html#a3">LpcpAcquireLpcpLock</a>();
00650 
00651     Msg = (<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html">PLPCP_MESSAGE</a>)<a class="code" href="../../d3/d7/lpcqueue_8c.html#a4">LpcpAllocateFromPortZone</a>( CapturedRequestMessage.u1.s1.TotalLength );
00652 
00653     <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
00654 
00655     <span class="keywordflow">if</span> (Msg == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00656 
00657         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( PortObject );
00658 
00659         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00660     }
00661 
00662     MsgType = CapturedRequestMessage.u2.s2.Type;
00663 
00664     <span class="comment">//</span>
00665     <span class="comment">//  Check if we need to do a callback</span>
00666     <span class="comment">//</span>
00667 
00668     <span class="keywordflow">if</span> (CallbackRequest) {
00669 
00670         <span class="comment">//</span>
00671         <span class="comment">//  Check for a valid request message id</span>
00672         <span class="comment">//</span>
00673 
00674         <span class="keywordflow">if</span> (CapturedRequestMessage.MessageId == 0) {
00675 
00676             <a class="code" href="../../d3/d7/lpcqueue_8c.html#a5">LpcpFreeToPortZone</a>( Msg, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00677 
00678             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( PortObject );
00679 
00680             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00681         }
00682 
00683         <span class="comment">//</span>
00684         <span class="comment">//  Translate the ClientId from the request into a</span>
00685         <span class="comment">//  thread pointer.  This is a referenced pointer to keep the thread</span>
00686         <span class="comment">//  from evaporating out from under us.</span>
00687         <span class="comment">//</span>
00688 
00689         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d0/pscid_8c.html#a0">PsLookupProcessThreadByCid</a>( &amp;CapturedRequestMessage.ClientId,
00690                                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00691                                              &amp;WakeupThread );
00692 
00693         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00694 
00695             <a class="code" href="../../d3/d7/lpcqueue_8c.html#a5">LpcpFreeToPortZone</a>( Msg, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00696 
00697             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( PortObject );
00698 
00699             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00700         }
00701 
00702         <span class="comment">//</span>
00703         <span class="comment">//  Acquire the mutex that guards the LpcReplyMessage field of</span>
00704         <span class="comment">//  the thread and get the pointer to the message that the thread</span>
00705         <span class="comment">//  is waiting for a reply to.</span>
00706         <span class="comment">//</span>
00707 
00708         <a class="code" href="../../d0/d7/lpcp_8h.html#a3">LpcpAcquireLpcpLock</a>();
00709 
00710         <span class="comment">//</span>
00711         <span class="comment">//  See if the thread is waiting for a reply to the message</span>
00712         <span class="comment">//  specified on this call.  If not then a bogus message has been</span>
00713         <span class="comment">//  specified, so release the mutex, dereference the thread</span>
00714         <span class="comment">//  and return failure.</span>
00715         <span class="comment">//</span>
00716 
00717         <span class="keywordflow">if</span> ((WakeupThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o15">LpcReplyMessageId</a> != CapturedRequestMessage.MessageId)
00718 
00719                 ||
00720 
00721             ((WakeupThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o14">LpcReplyMessage</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00722              (((<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html">PLPCP_MESSAGE</a>)(WakeupThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o14">LpcReplyMessage</a>))-&gt;Request.u2.s2.Type &amp; ~LPC_KERNELMODE_MESSAGE) != LPC_REQUEST)) {
00723 
00724             <a class="code" href="../../d0/d7/lpcp_8h.html#a12">LpcpPrint</a>(( <span class="stringliteral">"%s Attempted CallBack Request to Thread %lx (%s)\n"</span>,
00725                         <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;ImageFileName,
00726                         WakeupThread,
00727                         <a class="code" href="../../d1/d9/ps_8h.html#a17">THREAD_TO_PROCESS</a>( WakeupThread )-&gt;ImageFileName ));
00728 
00729             <a class="code" href="../../d0/d7/lpcp_8h.html#a12">LpcpPrint</a>(( <span class="stringliteral">"failed.  MessageId == %u  Client Id: %x.%x\n"</span>,
00730                         CapturedRequestMessage.MessageId,
00731                         CapturedRequestMessage.ClientId.UniqueProcess,
00732                         CapturedRequestMessage.ClientId.UniqueThread ));
00733 
00734             <a class="code" href="../../d0/d7/lpcp_8h.html#a12">LpcpPrint</a>(( <span class="stringliteral">"         Thread MessageId == %u  Client Id: %x.%x\n"</span>,
00735                         WakeupThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o15">LpcReplyMessageId</a>,
00736                         WakeupThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o12">Cid</a>.UniqueProcess,
00737                         WakeupThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o12">Cid</a>.UniqueThread ));
00738 
00739 <span class="preprocessor">#if DBG</span>
00740 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (LpcpStopOnReplyMismatch) {
00741 
00742                 DbgBreakPoint();
00743             }
00744 <span class="preprocessor">#endif</span>
00745 <span class="preprocessor"></span>
00746             <a class="code" href="../../d3/d7/lpcqueue_8c.html#a5">LpcpFreeToPortZone</a>( Msg, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00747 
00748             <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
00749 
00750             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( WakeupThread );
00751             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( PortObject );
00752 
00753             <span class="keywordflow">return</span> STATUS_REPLY_MESSAGE_MISMATCH;
00754         }
00755 
00756         <span class="comment">//</span>
00757         <span class="comment">//  Copy over the text of the message</span>
00758         <span class="comment">//</span>
00759 
00760         <span class="keywordflow">try</span> {
00761 
00762             <a class="code" href="../../d0/d7/lpcp_8h.html#a31">LpcpMoveMessage</a>( &amp;Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>,
00763                              &amp;CapturedRequestMessage,
00764                              (<a class="code" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a> + 1),
00765                              MsgType,
00766                              &amp;CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o12">Cid</a> );
00767 
00768             <span class="keywordflow">if</span> (CapturedRequestMessage.u2.s2.DataInfoOffset != 0) {
00769 
00770                 PPORT_DATA_INFORMATION DataInfo;
00771 
00772                 DataInfo = (PPORT_DATA_INFORMATION)(((PUCHAR)<a class="code" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a>) + CapturedRequestMessage.u2.s2.DataInfoOffset);
00773 
00774                 <span class="keywordflow">if</span> ( DataInfo-&gt;CountDataEntries != CapturedDataInfo.CountDataEntries ) {
00775 
00776                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00777                 }
00778             }
00779         } except( <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
00780 
00781             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00782         }
00783 
00784         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00785 
00786             <a class="code" href="../../d3/d7/lpcqueue_8c.html#a5">LpcpFreeToPortZone</a>( Msg, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00787 
00788             <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
00789 
00790             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( WakeupThread );
00791             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( PortObject );
00792 
00793             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00794         }
00795 
00796         <span class="comment">//</span>
00797         <span class="comment">//  Under the protect of the global lock we'll get everything</span>
00798         <span class="comment">//  ready for the callback</span>
00799         <span class="comment">//</span>
00800 
00801         QueuePort = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00802         Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o7">PortContext</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00803 
00804         <span class="keywordflow">if</span> ((PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o1">Flags</a> &amp; <a class="code" href="../../d2/d6/lpc_8h.html#a3">PORT_TYPE</a>) == <a class="code" href="../../d2/d6/lpc_8h.html#a4">SERVER_CONNECTION_PORT</a>) {
00805 
00806             RundownPort = PortObject;
00807 
00808         } <span class="keywordflow">else</span> {
00809 
00810             RundownPort = PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o3">ConnectedPort</a>;
00811 
00812             <span class="keywordflow">if</span> (RundownPort == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00813 
00814                 <a class="code" href="../../d3/d7/lpcqueue_8c.html#a5">LpcpFreeToPortZone</a>( Msg, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00815 
00816                 <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
00817 
00818                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( WakeupThread );
00819                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( PortObject );
00820 
00821                 <span class="keywordflow">return</span> STATUS_PORT_DISCONNECTED;
00822             }
00823 
00824             <span class="keywordflow">if</span> ((PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o1">Flags</a> &amp; <a class="code" href="../../d2/d6/lpc_8h.html#a3">PORT_TYPE</a>) == <a class="code" href="../../d2/d6/lpc_8h.html#a7">CLIENT_COMMUNICATION_PORT</a>) {
00825 
00826                 Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o7">PortContext</a> = RundownPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o8">PortContext</a>;
00827             }
00828         }
00829 
00830         Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>.CallbackId = <a class="code" href="../../d0/d7/lpcp_8h.html#a1">LpcpGenerateCallbackId</a>();
00831 
00832         <a class="code" href="../../d0/d7/lpcp_8h.html#a13">LpcpTrace</a>(( <span class="stringliteral">"%s CallBack Request (%s) Msg %lx (%u.%u) [%08x %08x %08x %08x] to Thread %lx (%s)\n"</span>,
00833                     <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;ImageFileName,
00834                     LpcpMessageTypeName[ Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>.u2.s2.Type &amp; ~LPC_KERNELMODE_MESSAGE ],
00835                     Msg,
00836                     Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>.MessageId,
00837                     Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>.CallbackId,
00838                     *((PULONG)(Msg+1)+0),
00839                     *((PULONG)(Msg+1)+1),
00840                     *((PULONG)(Msg+1)+2),
00841                     *((PULONG)(Msg+1)+3),
00842                     WakeupThread,
00843                     <a class="code" href="../../d1/d9/ps_8h.html#a17">THREAD_TO_PROCESS</a>( WakeupThread )-&gt;ImageFileName ));
00844 
00845         <span class="comment">//</span>
00846         <span class="comment">//  Add an extra reference so LpcExitThread does not evaporate</span>
00847         <span class="comment">//  the pointer before we get to the wait below</span>
00848         <span class="comment">//</span>
00849 
00850         <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>( WakeupThread );
00851 
00852         Msg-&gt;RepliedToThread = WakeupThread;
00853 
00854         WakeupThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o15">LpcReplyMessageId</a> = 0;
00855         WakeupThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o14">LpcReplyMessage</a> = (PVOID)Msg;
00856 
00857         <span class="comment">//</span>
00858         <span class="comment">//  Remove the thread from the reply rundown list as we are sending a callback</span>
00859         <span class="comment">//</span>
00860 
00861         <span class="keywordflow">if</span> (!IsListEmpty( &amp;WakeupThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o5">LpcReplyChain</a> )) {
00862 
00863             RemoveEntryList( &amp;WakeupThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o5">LpcReplyChain</a> );
00864 
00865             InitializeListHead( &amp;WakeupThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o5">LpcReplyChain</a> );
00866         }
00867 
00868         CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o15">LpcReplyMessageId</a> = Msg-&gt;Request.MessageId;
00869         CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o14">LpcReplyMessage</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00870 
00871         InsertTailList( &amp;RundownPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o14">LpcReplyChainHead</a>, &amp;CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o5">LpcReplyChain</a> );
00872 
00873         <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
00874 
00875         <span class="comment">//</span>
00876         <span class="comment">//  Wake up the thread that is waiting for an answer to its request</span>
00877         <span class="comment">//  inside of NtRequestWaitReplyPort or NtReplyWaitReplyPort</span>
00878         <span class="comment">//</span>
00879 
00880         ReleaseSemaphore = &amp;WakeupThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o13">LpcReplySemaphore</a>;
00881 
00882     } <span class="keywordflow">else</span> {
00883 
00884         <span class="comment">//</span>
00885         <span class="comment">//  A callback is not required, so continue setting up the</span>
00886         <span class="comment">//  lpc message</span>
00887         <span class="comment">//</span>
00888 
00889         <span class="keywordflow">try</span> {
00890 
00891             <a class="code" href="../../d0/d7/lpcp_8h.html#a31">LpcpMoveMessage</a>( &amp;Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>,
00892                              &amp;CapturedRequestMessage,
00893                              (<a class="code" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a> + 1),
00894                              MsgType,
00895                              &amp;CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o12">Cid</a> );
00896 
00897             <span class="keywordflow">if</span> (CapturedRequestMessage.u2.s2.DataInfoOffset != 0) {
00898 
00899                 PPORT_DATA_INFORMATION DataInfo;
00900 
00901                 DataInfo = (PPORT_DATA_INFORMATION)(((PUCHAR)<a class="code" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a>) + CapturedRequestMessage.u2.s2.DataInfoOffset);
00902 
00903                 <span class="keywordflow">if</span> ( DataInfo-&gt;CountDataEntries != CapturedDataInfo.CountDataEntries ) {
00904 
00905                     <a class="code" href="../../d3/d7/lpcqueue_8c.html#a5">LpcpFreeToPortZone</a>( Msg, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00906 
00907                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( PortObject );
00908 
00909                     <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00910                 }
00911             }
00912         } except( <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
00913 
00914             <a class="code" href="../../d3/d7/lpcqueue_8c.html#a5">LpcpFreeToPortZone</a>( Msg, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00915 
00916             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( PortObject );
00917 
00918             <span class="keywordflow">return</span> GetExceptionCode();
00919         }
00920 
00921         <span class="comment">//</span>
00922         <span class="comment">//  Acquire the global Lpc mutex that guards the LpcReplyMessage</span>
00923         <span class="comment">//  field of the thread and the request message queue.  Stamp the</span>
00924         <span class="comment">//  request message with a serial number, insert the message at</span>
00925         <span class="comment">//  the tail of the request message queue and remember the address</span>
00926         <span class="comment">//  of the message in the LpcReplyMessage field for the current thread.</span>
00927         <span class="comment">//</span>
00928         <span class="comment">//  **** does this also need to be done with APC's disabled?</span>
00929         <span class="comment">//</span>
00930 
00931         <a class="code" href="../../d0/d7/lpcp_8h.html#a3">LpcpAcquireLpcpLock</a>();
00932 
00933         Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o7">PortContext</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00934 
00935         <span class="keywordflow">if</span> ((PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o1">Flags</a> &amp; <a class="code" href="../../d2/d6/lpc_8h.html#a3">PORT_TYPE</a>) != <a class="code" href="../../d2/d6/lpc_8h.html#a4">SERVER_CONNECTION_PORT</a>) {
00936 
00937             QueuePort = PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o3">ConnectedPort</a>;
00938 
00939             <span class="keywordflow">if</span> (QueuePort == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00940 
00941                 <a class="code" href="../../d3/d7/lpcqueue_8c.html#a5">LpcpFreeToPortZone</a>( Msg, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00942 
00943                 <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
00944 
00945                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( PortObject );
00946 
00947                 <span class="keywordflow">return</span> STATUS_PORT_DISCONNECTED;
00948             }
00949 
00950             RundownPort = QueuePort;
00951 
00952             <span class="keywordflow">if</span> ((PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o1">Flags</a> &amp; <a class="code" href="../../d2/d6/lpc_8h.html#a3">PORT_TYPE</a>) == <a class="code" href="../../d2/d6/lpc_8h.html#a7">CLIENT_COMMUNICATION_PORT</a>) {
00953 
00954                 Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o7">PortContext</a> = QueuePort-&gt;PortContext;
00955                 QueuePort = PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o2">ConnectionPort</a>;
00956 
00957             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o1">Flags</a> &amp; <a class="code" href="../../d2/d6/lpc_8h.html#a3">PORT_TYPE</a>) != <a class="code" href="../../d2/d6/lpc_8h.html#a6">SERVER_COMMUNICATION_PORT</a>) {
00958 
00959                 QueuePort = PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o2">ConnectionPort</a>;
00960             }
00961 
00962         } <span class="keywordflow">else</span> {
00963 
00964             QueuePort = PortObject;
00965             RundownPort = PortObject;
00966         }
00967 
00968         <span class="comment">//</span>
00969         <span class="comment">//  Stamp the request message with a serial number, insert the message</span>
00970         <span class="comment">//  at the tail of the request message queue</span>
00971         <span class="comment">//</span>
00972 
00973         Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o6">RepliedToThread</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00974         Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>.MessageId = <a class="code" href="../../d0/d7/lpcp_8h.html#a0">LpcpGenerateMessageId</a>();
00975         Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>.CallbackId = 0;
00976 
00977         CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o15">LpcReplyMessageId</a> = Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>.MessageId;
00978         CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o14">LpcReplyMessage</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00979 
00980         InsertTailList( &amp;QueuePort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o4">MsgQueue</a>.<a class="code" href="../../d0/d5/struct__LPCP__PORT__QUEUE.html#o2">ReceiveHead</a>, &amp;Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o0">Entry</a> );
00981         InsertTailList( &amp;RundownPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o14">LpcReplyChainHead</a>, &amp;CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o5">LpcReplyChain</a> );
00982 
00983         <a class="code" href="../../d0/d7/lpcp_8h.html#a13">LpcpTrace</a>(( <span class="stringliteral">"%s Send Request (%s) Msg %lx (%u) [%08x %08x %08x %08x] to Port %lx (%s)\n"</span>,
00984                     <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;ImageFileName,
00985                     LpcpMessageTypeName[ Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>.u2.s2.Type &amp; ~LPC_KERNELMODE_MESSAGE ],
00986                     Msg,
00987                     Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>.MessageId,
00988                     *((PULONG)(Msg+1)+0),
00989                     *((PULONG)(Msg+1)+1),
00990                     *((PULONG)(Msg+1)+2),
00991                     *((PULONG)(Msg+1)+3),
00992                     QueuePort,
00993                     <a class="code" href="../../d7/d6/lpcinit_8c.html#a5">LpcpGetCreatorName</a>( QueuePort )));
00994 
00995         <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
00996 
00997         <span class="comment">//</span>
00998         <span class="comment">//  Increment the request message queue semaphore by one for</span>
00999         <span class="comment">//  the newly inserted request message.</span>
01000         <span class="comment">//</span>
01001 
01002         ReleaseSemaphore = QueuePort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o4">MsgQueue</a>.<a class="code" href="../../d0/d5/struct__LPCP__PORT__QUEUE.html#o1">Semaphore</a>;
01003 
01004         <span class="comment">//</span>
01005         <span class="comment">//  If port is waitable then set the event that someone could</span>
01006         <span class="comment">//  be waiting on</span>
01007         <span class="comment">//</span>
01008 
01009         <span class="keywordflow">if</span> ( QueuePort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o1">Flags</a> &amp; <a class="code" href="../../d2/d6/lpc_8h.html#a8">PORT_WAITABLE</a> ) {
01010 
01011             <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( &amp;QueuePort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o18">WaitEvent</a>,
01012                         <a class="code" href="../../d7/d8/exboosts_8h.html#a2">LPC_RELEASE_WAIT_INCREMENT</a>,
01013                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01014         }
01015     }
01016 
01017     <span class="comment">//</span>
01018     <span class="comment">//  At this point we've enqueued our request and if necessary</span>
01019     <span class="comment">//  set ourselves up for the callback or reply.</span>
01020     <span class="comment">//</span>
01021     <span class="comment">//  So now wake up the other end</span>
01022     <span class="comment">//</span>
01023 
01024     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>( ReleaseSemaphore,
01025                                  1,
01026                                  1,
01027                                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01028 
01029     <span class="keywordflow">if</span> (CallbackRequest) {
01030 
01031         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( WakeupThread );
01032     }
01033 
01034     <span class="comment">//</span>
01035     <span class="comment">//  And wait for a reply</span>
01036     <span class="comment">//</span>
01037 
01038     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o13">LpcReplySemaphore</a>,
01039                                     <a class="code" href="../../d4/d9/ke_8h.html#a407a215">WrLpcReply</a>,
01040                                     PreviousMode,
01041                                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01042                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
01043 
01044     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_USER_APC) {
01045 
01046         <span class="comment">//</span>
01047         <span class="comment">//  if the semaphore is signaled, then clear it</span>
01048         <span class="comment">//</span>
01049 
01050         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d6/semphobj_8c.html#a2">KeReadStateSemaphore</a>( &amp;CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o13">LpcReplySemaphore</a> )) {
01051 
01052             <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o13">LpcReplySemaphore</a>,
01053                                    <a class="code" href="../../d6/d7/halmips_8h.html#a0">WrExecutive</a>,
01054                                    <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
01055                                    <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01056                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
01057 
01058             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01059         }
01060     }
01061 
01062     <span class="comment">//</span>
01063     <span class="comment">//  Acquire the LPC mutex.  Remove the reply message from the current thread</span>
01064     <span class="comment">//</span>
01065 
01066     <a class="code" href="../../d0/d7/lpcp_8h.html#a3">LpcpAcquireLpcpLock</a>();
01067 
01068     Msg = CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o14">LpcReplyMessage</a>;
01069 
01070     CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o14">LpcReplyMessage</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01071     CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o15">LpcReplyMessageId</a> = 0;
01072 
01073     <span class="comment">//</span>
01074     <span class="comment">//  Remove the thread from the reply rundown list in case we did not wakeup due to</span>
01075     <span class="comment">//  a reply</span>
01076     <span class="comment">//</span>
01077 
01078     <span class="keywordflow">if</span> (!IsListEmpty( &amp;CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o5">LpcReplyChain</a> )) {
01079 
01080         RemoveEntryList( &amp;CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o5">LpcReplyChain</a> );
01081 
01082         InitializeListHead( &amp;CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o5">LpcReplyChain</a> );
01083     }
01084 
01085 <span class="preprocessor">#if DBG</span>
01086 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS &amp;&amp; Msg != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01087 
01088         <a class="code" href="../../d0/d7/lpcp_8h.html#a13">LpcpTrace</a>(( <span class="stringliteral">"%s Got Reply Msg %lx (%u) [%08x %08x %08x %08x] for Thread %lx (%s)\n"</span>,
01089                     <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;ImageFileName,
01090                     Msg,
01091                     Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>.MessageId,
01092                     *((PULONG)(Msg+1)+0),
01093                     *((PULONG)(Msg+1)+1),
01094                     *((PULONG)(Msg+1)+2),
01095                     *((PULONG)(Msg+1)+3),
01096                     CurrentThread,
01097                     <a class="code" href="../../d1/d9/ps_8h.html#a17">THREAD_TO_PROCESS</a>( CurrentThread )-&gt;ImageFileName ));
01098 
01099         <span class="keywordflow">if</span> (!IsListEmpty( &amp;Msg-&gt;Entry )) {
01100 
01101             <a class="code" href="../../d0/d7/lpcp_8h.html#a13">LpcpTrace</a>(( <span class="stringliteral">"Reply Msg %lx has non-empty list entry\n"</span>, Msg ));
01102         }
01103     }
01104 <span class="preprocessor">#endif</span>
01105 <span class="preprocessor"></span>
01106     <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
01107 
01108     <span class="comment">//</span>
01109     <span class="comment">//  If the wait succeeded, copy the reply to the reply buffer.</span>
01110     <span class="comment">//</span>
01111 
01112     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS) {
01113 
01114         <span class="keywordflow">if</span> (Msg != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01115 
01116             <span class="keywordflow">try</span> {
01117 
01118                 <a class="code" href="../../d0/d7/lpcp_8h.html#a31">LpcpMoveMessage</a>( <a class="code" href="../../d3/d8/client_8c.html#a125">ReplyMessage</a>,
01119                                  &amp;Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>,
01120                                  (&amp;Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>) + 1,
01121                                  0,
01122                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
01123 
01124             } except( <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
01125 
01126                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
01127             }
01128 
01129             <span class="comment">//</span>
01130             <span class="comment">//  Acquire the LPC mutex and decrement the reference count for the</span>
01131             <span class="comment">//  message.  If the reference count goes to zero the message will be</span>
01132             <span class="comment">//  deleted.</span>
01133             <span class="comment">//</span>
01134 
01135             <span class="keywordflow">if</span> (((Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>.u2.s2.Type &amp; ~LPC_KERNELMODE_MESSAGE) == LPC_REQUEST) &amp;&amp;
01136                 (Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>.u2.s2.DataInfoOffset != 0)) {
01137 
01138                 <a class="code" href="../../d3/d7/lpcqueue_8c.html#a6">LpcpSaveDataInfoMessage</a>( PortObject, Msg );
01139 
01140             } <span class="keywordflow">else</span> {
01141 
01142                 <a class="code" href="../../d3/d7/lpcqueue_8c.html#a5">LpcpFreeToPortZone</a>( Msg, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01143             }
01144 
01145         } <span class="keywordflow">else</span> {
01146 
01147             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_LPC_REPLY_LOST;
01148         }
01149 
01150     } <span class="keywordflow">else</span> {
01151 
01152         <span class="comment">//</span>
01153         <span class="comment">//  Wait failed, acquire the LPC mutex and free the message.</span>
01154         <span class="comment">//</span>
01155 
01156         <a class="code" href="../../d0/d7/lpcp_8h.html#a3">LpcpAcquireLpcpLock</a>();
01157 
01158         <a class="code" href="../../d0/d7/lpcp_8h.html#a13">LpcpTrace</a>(( <span class="stringliteral">"%s NtRequestWaitReply wait failed - Status == %lx\n"</span>,
01159                     <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;ImageFileName,
01160                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ));
01161 
01162         <span class="keywordflow">if</span> (Msg != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01163 
01164             <a class="code" href="../../d3/d7/lpcqueue_8c.html#a5">LpcpFreeToPortZone</a>( Msg, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
01165         }
01166 
01167         <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
01168     }
01169 
01170     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( PortObject );
01171 
01172     <span class="comment">//</span>
01173     <span class="comment">//  And return to our caller</span>
01174     <span class="comment">//</span>
01175 
01176     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01177 }
01178 
01179 
01180 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01181"></a><a class="code" href="../../d6/d7/lpcsend_8c.html#a2">01181</a> <a class="code" href="../../d6/d7/lpcsend_8c.html#a2">LpcRequestPort</a> (
01182     IN PVOID PortAddress,
01183     IN PPORT_MESSAGE RequestMessage
01184     )
01185 
01186 <span class="comment">/*++</span>
01187 <span class="comment"></span>
01188 <span class="comment">Routine Description:</span>
01189 <span class="comment"></span>
01190 <span class="comment">    This procedure is similar to NtRequestPort but without the Handle based</span>
01191 <span class="comment">    interface.</span>
01192 <span class="comment"></span>
01193 <span class="comment">Arguments:</span>
01194 <span class="comment"></span>
01195 <span class="comment">    PortAddress - Supplies a pointer to the communication port to send</span>
01196 <span class="comment">        the request message to.</span>
01197 <span class="comment"></span>
01198 <span class="comment">    RequestMessage - Specifies a pointer to the request message.  The Type</span>
01199 <span class="comment">        field of the message is set to LPC_DATAGRAM by the service.</span>
01200 <span class="comment"></span>
01201 <span class="comment">Return Value:</span>
01202 <span class="comment"></span>
01203 <span class="comment">    NTSTATUS - A status code that indicates whether or not the operation was</span>
01204 <span class="comment">        successful.</span>
01205 <span class="comment"></span>
01206 <span class="comment">--*/</span>
01207 
01208 {
01209     <a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html">PLPCP_PORT_OBJECT</a> PortObject = (<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html">PLPCP_PORT_OBJECT</a>)PortAddress;
01210     <a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html">PLPCP_PORT_OBJECT</a> QueuePort;
01211     ULONG MsgType;
01212     <a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html">PLPCP_MESSAGE</a> Msg;
01213     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
01214 
01215     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01216 
01217     <span class="comment">//</span>
01218     <span class="comment">//  Get previous processor mode and validate parameters</span>
01219     <span class="comment">//</span>
01220 
01221     PreviousMode = KeGetPreviousMode();
01222 
01223     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a>-&gt;u2.s2.Type != 0) {
01224 
01225         MsgType = <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a>-&gt;u2.s2.Type &amp; ~LPC_KERNELMODE_MESSAGE;
01226 
01227         <span class="keywordflow">if</span> ((MsgType &lt; LPC_DATAGRAM) ||
01228             (MsgType &gt; LPC_CLIENT_DIED)) {
01229 
01230             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01231         }
01232 
01233         <span class="comment">//</span>
01234         <span class="comment">//  If previous mode is kernel, allow the LPC_KERNELMODE_MESSAGE</span>
01235         <span class="comment">//  bit to be passed in message type field.</span>
01236         <span class="comment">//</span>
01237 
01238         <span class="keywordflow">if</span> ((PreviousMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) &amp;&amp;
01239             (<a class="code" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a>-&gt;u2.s2.Type &amp; LPC_KERNELMODE_MESSAGE)) {
01240 
01241             MsgType |= LPC_KERNELMODE_MESSAGE;
01242         }
01243 
01244     } <span class="keywordflow">else</span> {
01245 
01246         MsgType = LPC_DATAGRAM;
01247     }
01248 
01249     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a>-&gt;u2.s2.DataInfoOffset != 0) {
01250 
01251         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01252     }
01253 
01254     <span class="comment">//</span>
01255     <span class="comment">//  Validate the message length</span>
01256     <span class="comment">//</span>
01257 
01258     <span class="keywordflow">if</span> (((ULONG)<a class="code" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a>-&gt;u1.s1.TotalLength &gt; PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o9">MaxMessageLength</a>) ||
01259         ((ULONG)<a class="code" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a>-&gt;u1.s1.TotalLength &lt;= (ULONG)<a class="code" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a>-&gt;u1.s1.DataLength)) {
01260 
01261         <span class="keywordflow">return</span> STATUS_PORT_MESSAGE_TOO_LONG;
01262     }
01263 
01264     <span class="comment">//</span>
01265     <span class="comment">//  Allocate a message block</span>
01266     <span class="comment">//</span>
01267 
01268     <a class="code" href="../../d0/d7/lpcp_8h.html#a3">LpcpAcquireLpcpLock</a>();
01269 
01270     Msg = (<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html">PLPCP_MESSAGE</a>)<a class="code" href="../../d3/d7/lpcqueue_8c.html#a4">LpcpAllocateFromPortZone</a>( <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a>-&gt;u1.s1.TotalLength );
01271 
01272     <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
01273 
01274     <span class="keywordflow">if</span> (Msg == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01275 
01276         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01277     }
01278 
01279     <span class="comment">//</span>
01280     <span class="comment">//  Fill in the message block.</span>
01281     <span class="comment">//</span>
01282 
01283     Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o6">RepliedToThread</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01284     Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o7">PortContext</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01285 
01286     <a class="code" href="../../d0/d7/lpcp_8h.html#a31">LpcpMoveMessage</a>( &amp;Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>,
01287                      <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a>,
01288                      (<a class="code" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a> + 1),
01289                      MsgType,
01290                      &amp;<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;Cid );
01291 
01292     <span class="comment">//</span>
01293     <span class="comment">//  Acquire the global Lpc mutex that guards the LpcReplyMessage</span>
01294     <span class="comment">//  field of the thread and the request message queue.  Stamp the</span>
01295     <span class="comment">//  request message with a serial number, insert the message at</span>
01296     <span class="comment">//  the tail of the request message queue</span>
01297     <span class="comment">//</span>
01298     <span class="comment">//  This all needs to be performed with APCs disabled to avoid</span>
01299     <span class="comment">//  the situation where something gets put on the queue and this</span>
01300     <span class="comment">//  thread gets suspended before being able to release the semaphore.</span>
01301     <span class="comment">//</span>
01302 
01303     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
01304 
01305     <a class="code" href="../../d0/d7/lpcp_8h.html#a3">LpcpAcquireLpcpLock</a>();
01306 
01307     <span class="keywordflow">if</span> ((PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o1">Flags</a> &amp; <a class="code" href="../../d2/d6/lpc_8h.html#a3">PORT_TYPE</a>) != <a class="code" href="../../d2/d6/lpc_8h.html#a4">SERVER_CONNECTION_PORT</a>) {
01308 
01309         QueuePort = PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o3">ConnectedPort</a>;
01310 
01311         <span class="keywordflow">if</span> (QueuePort != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01312 
01313             <span class="keywordflow">if</span> ((PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o1">Flags</a> &amp; <a class="code" href="../../d2/d6/lpc_8h.html#a3">PORT_TYPE</a>) == <a class="code" href="../../d2/d6/lpc_8h.html#a7">CLIENT_COMMUNICATION_PORT</a>) {
01314 
01315                 Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o7">PortContext</a> = QueuePort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o8">PortContext</a>;
01316                 QueuePort = PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o2">ConnectionPort</a>;
01317 
01318             <span class="comment">//</span>
01319             <span class="comment">//  **** this test and assignment are bogus because we earlier</span>
01320             <span class="comment">//       unconditionally set the QueuePort value</span>
01321             <span class="comment">//</span>
01322 
01323             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o1">Flags</a> &amp; <a class="code" href="../../d2/d6/lpc_8h.html#a3">PORT_TYPE</a>) != <a class="code" href="../../d2/d6/lpc_8h.html#a6">SERVER_COMMUNICATION_PORT</a>) {
01324 
01325                 QueuePort = PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o2">ConnectionPort</a>;
01326             }
01327         }
01328 
01329     } <span class="keywordflow">else</span> {
01330 
01331         QueuePort = PortObject;
01332     }
01333 
01334     <span class="comment">//</span>
01335     <span class="comment">//  At this point we have an LPC message ready to send and if queue port is</span>
01336     <span class="comment">//  not null then we have a port to actually send the message off to</span>
01337     <span class="comment">//</span>
01338 
01339     <span class="keywordflow">if</span> (QueuePort != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01340 
01341         Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>.MessageId = <a class="code" href="../../d0/d7/lpcp_8h.html#a0">LpcpGenerateMessageId</a>();
01342         Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>.CallbackId = 0;
01343 
01344         <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;LpcReplyMessageId = 0;
01345 
01346         InsertTailList( &amp;QueuePort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o4">MsgQueue</a>.<a class="code" href="../../d0/d5/struct__LPCP__PORT__QUEUE.html#o2">ReceiveHead</a>, &amp;Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o0">Entry</a> );
01347 
01348         <a class="code" href="../../d0/d7/lpcp_8h.html#a13">LpcpTrace</a>(( <span class="stringliteral">"%s Send DataGram (%s) Msg %lx [%08x %08x %08x %08x] to Port %lx (%s)\n"</span>,
01349                     <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;ImageFileName,
01350                     LpcpMessageTypeName[ Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>.u2.s2.Type &amp; ~LPC_KERNELMODE_MESSAGE ],
01351                     Msg,
01352                     *((PULONG)(Msg+1)+0),
01353                     *((PULONG)(Msg+1)+1),
01354                     *((PULONG)(Msg+1)+2),
01355                     *((PULONG)(Msg+1)+3),
01356                     QueuePort,
01357                     <a class="code" href="../../d7/d6/lpcinit_8c.html#a5">LpcpGetCreatorName</a>( QueuePort )));
01358 
01359         <span class="comment">//</span>
01360         <span class="comment">//  Release the mutex, increment the request message queue</span>
01361         <span class="comment">//  semaphore by one for the newly inserted request message,</span>
01362         <span class="comment">//  then exit the critical region.</span>
01363         <span class="comment">//</span>
01364 
01365         <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
01366 
01367         <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>( QueuePort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o4">MsgQueue</a>.<a class="code" href="../../d0/d5/struct__LPCP__PORT__QUEUE.html#o1">Semaphore</a>,
01368                             <a class="code" href="../../d7/d8/exboosts_8h.html#a2">LPC_RELEASE_WAIT_INCREMENT</a>,
01369                             1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
01370                             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01371 
01372 
01373         <span class="keywordflow">if</span> ( QueuePort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o1">Flags</a> &amp; <a class="code" href="../../d2/d6/lpc_8h.html#a8">PORT_WAITABLE</a> ) {
01374 
01375             <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( &amp;QueuePort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o18">WaitEvent</a>,
01376                         <a class="code" href="../../d7/d8/exboosts_8h.html#a2">LPC_RELEASE_WAIT_INCREMENT</a>,
01377                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01378         }
01379 
01380         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
01381 
01382         <span class="keywordflow">return</span> STATUS_SUCCESS;
01383 
01384     }
01385 
01386     <span class="comment">//</span>
01387     <span class="comment">//  At this point we have a message but not a valid port to queue it off</span>
01388     <span class="comment">//  to so we'll release the unused message, release our lock and enable</span>
01389     <span class="comment">//  APC again</span>
01390     <span class="comment">//</span>
01391 
01392     <a class="code" href="../../d3/d7/lpcqueue_8c.html#a5">LpcpFreeToPortZone</a>( Msg, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
01393 
01394     <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
01395 
01396     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
01397 
01398     <span class="comment">//</span>
01399     <span class="comment">//  And return the error status to our caller</span>
01400     <span class="comment">//</span>
01401 
01402     <span class="keywordflow">return</span> STATUS_PORT_DISCONNECTED;
01403 }
01404 
01405 
01406 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01407"></a><a class="code" href="../../d6/d7/lpcsend_8c.html#a3">01407</a> <a class="code" href="../../d6/d7/lpcsend_8c.html#a3">LpcRequestWaitReplyPort</a> (
01408     IN PVOID PortAddress,
01409     IN PPORT_MESSAGE RequestMessage,
01410     OUT PPORT_MESSAGE ReplyMessage
01411     )
01412 
01413 <span class="comment">/*++</span>
01414 <span class="comment"></span>
01415 <span class="comment">Routine Description:</span>
01416 <span class="comment"></span>
01417 <span class="comment">    This procedure is similar to NtRequestWaitReplyPort but without the</span>
01418 <span class="comment">    handle based interface</span>
01419 <span class="comment"></span>
01420 <span class="comment">Arguments:</span>
01421 <span class="comment"></span>
01422 <span class="comment">    PortAddress - Supplies the communication port object to send the</span>
01423 <span class="comment">        request message to.</span>
01424 <span class="comment"></span>
01425 <span class="comment">    RequestMessage - Specifies a pointer to a request message to send.</span>
01426 <span class="comment"></span>
01427 <span class="comment">    ReplyMessage - Specifies the address of a variable that will receive the</span>
01428 <span class="comment">        reply message.  This parameter may point to the same buffer as the</span>
01429 <span class="comment">        RequestMessage parameter.</span>
01430 <span class="comment"></span>
01431 <span class="comment">Return Value:</span>
01432 <span class="comment"></span>
01433 <span class="comment">    NTSTATUS - A status code that indicates whether or not the operation was</span>
01434 <span class="comment">        successful.</span>
01435 <span class="comment"></span>
01436 <span class="comment">--*/</span>
01437 
01438 {
01439     <a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html">PLPCP_PORT_OBJECT</a> PortObject = (<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html">PLPCP_PORT_OBJECT</a>)PortAddress;
01440     <a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html">PLPCP_PORT_OBJECT</a> QueuePort;
01441     <a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html">PLPCP_PORT_OBJECT</a> RundownPort;
01442     <a class="code" href="../../d8/d7/struct__KSEMAPHORE.html">PKSEMAPHORE</a> ReleaseSemaphore;
01443     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01444     ULONG MsgType;
01445     <a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html">PLPCP_MESSAGE</a> Msg;
01446     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> CurrentThread;
01447     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> WakeupThread;
01448     BOOLEAN CallbackRequest;
01449     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
01450 
01451     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01452 
01453     CurrentThread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
01454 
01455     <span class="keywordflow">if</span> (CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o32">LpcExitThreadCalled</a>) {
01456 
01457         <span class="keywordflow">return</span> STATUS_THREAD_IS_TERMINATING;
01458     }
01459 
01460     <span class="comment">//</span>
01461     <span class="comment">//  Get previous processor mode and validate parameters</span>
01462     <span class="comment">//</span>
01463 
01464     PreviousMode = KeGetPreviousMode();
01465     MsgType = <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a>-&gt;u2.s2.Type &amp; ~LPC_KERNELMODE_MESSAGE;
01466     CallbackRequest = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01467 
01468     <span class="keywordflow">switch</span> (MsgType) {
01469 
01470     <span class="keywordflow">case</span> 0:
01471 
01472         MsgType = LPC_REQUEST;
01473         <span class="keywordflow">break</span>;
01474 
01475     <span class="keywordflow">case</span> LPC_REQUEST:
01476 
01477         CallbackRequest = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01478         <span class="keywordflow">break</span>;
01479 
01480     <span class="keywordflow">case</span> LPC_CLIENT_DIED:
01481     <span class="keywordflow">case</span> LPC_PORT_CLOSED:
01482     <span class="keywordflow">case</span> LPC_EXCEPTION:
01483     <span class="keywordflow">case</span> LPC_DEBUG_EVENT:
01484     <span class="keywordflow">case</span> LPC_ERROR_EVENT:
01485 
01486         <span class="keywordflow">break</span>;
01487 
01488     <span class="keywordflow">default</span> :
01489 
01490         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01491     }
01492 
01493     <span class="comment">//</span>
01494     <span class="comment">//  Allow the LPC_KERNELMODE_MESSAGE</span>
01495     <span class="comment">//  bit to be passed in message type field. Don't check the previous mode !!!</span>
01496     <span class="comment">//</span>
01497 
01498     <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a>-&gt;u2.s2.Type &amp; LPC_KERNELMODE_MESSAGE) {
01499 
01500         MsgType |= LPC_KERNELMODE_MESSAGE;
01501     }
01502 
01503     <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a>-&gt;u2.s2.Type = (CSHORT)MsgType;
01504 
01505     <span class="comment">//</span>
01506     <span class="comment">//  Validate the message length</span>
01507     <span class="comment">//</span>
01508 
01509     <span class="keywordflow">if</span> (((ULONG)<a class="code" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a>-&gt;u1.s1.TotalLength &gt; PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o9">MaxMessageLength</a>) ||
01510         ((ULONG)<a class="code" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a>-&gt;u1.s1.TotalLength &lt;= (ULONG)<a class="code" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a>-&gt;u1.s1.DataLength)) {
01511 
01512         <span class="keywordflow">return</span> STATUS_PORT_MESSAGE_TOO_LONG;
01513     }
01514 
01515     <span class="comment">//</span>
01516     <span class="comment">//  Determine which port to queue the message to and get client</span>
01517     <span class="comment">//  port context if client sending to server.  Also validate</span>
01518     <span class="comment">//  length of message being sent.</span>
01519     <span class="comment">//</span>
01520 
01521     <a class="code" href="../../d0/d7/lpcp_8h.html#a3">LpcpAcquireLpcpLock</a>();
01522 
01523     Msg = (<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html">PLPCP_MESSAGE</a>)<a class="code" href="../../d3/d7/lpcqueue_8c.html#a4">LpcpAllocateFromPortZone</a>( <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a>-&gt;u1.s1.TotalLength );
01524 
01525     <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
01526 
01527     <span class="keywordflow">if</span> (Msg == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01528 
01529         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01530     }
01531 
01532     <span class="keywordflow">if</span> (CallbackRequest) {
01533 
01534         <span class="comment">//</span>
01535         <span class="comment">//  Check for a valid request message id</span>
01536         <span class="comment">//</span>
01537 
01538         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a>-&gt;MessageId == 0) {
01539 
01540             <a class="code" href="../../d3/d7/lpcqueue_8c.html#a5">LpcpFreeToPortZone</a>( Msg, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01541 
01542             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01543         }
01544 
01545         <span class="comment">//</span>
01546         <span class="comment">//  Translate the ClientId from the request into a</span>
01547         <span class="comment">//  thread pointer.  This is a referenced pointer to keep the thread</span>
01548         <span class="comment">//  from evaporating out from under us.</span>
01549         <span class="comment">//</span>
01550 
01551         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d0/pscid_8c.html#a0">PsLookupProcessThreadByCid</a>( &amp;<a class="code" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a>-&gt;ClientId,
01552                                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01553                                              &amp;WakeupThread );
01554 
01555         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01556 
01557             <a class="code" href="../../d3/d7/lpcqueue_8c.html#a5">LpcpFreeToPortZone</a>( Msg, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01558 
01559             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01560         }
01561 
01562         <span class="comment">//</span>
01563         <span class="comment">//  Acquire the mutex that gaurds the LpcReplyMessage field of</span>
01564         <span class="comment">//  the thread and get the pointer to the message that the thread</span>
01565         <span class="comment">//  is waiting for a reply to.</span>
01566         <span class="comment">//</span>
01567 
01568         <a class="code" href="../../d0/d7/lpcp_8h.html#a3">LpcpAcquireLpcpLock</a>();
01569 
01570         <span class="comment">//</span>
01571         <span class="comment">//  See if the thread is waiting for a reply to the message</span>
01572         <span class="comment">//  specified on this call.  If not then a bogus message</span>
01573         <span class="comment">//  has been specified, so release the mutex, dereference the thread</span>
01574         <span class="comment">//  and return failure.</span>
01575         <span class="comment">//</span>
01576 
01577         <span class="keywordflow">if</span> ((WakeupThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o15">LpcReplyMessageId</a> != <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a>-&gt;MessageId)
01578 
01579                 ||
01580 
01581             ((WakeupThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o14">LpcReplyMessage</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01582              (((<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html">PLPCP_MESSAGE</a>)(WakeupThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o14">LpcReplyMessage</a>))-&gt;Request.u2.s2.Type &amp; ~LPC_KERNELMODE_MESSAGE) != LPC_REQUEST)) {
01583 
01584             <a class="code" href="../../d3/d7/lpcqueue_8c.html#a5">LpcpFreeToPortZone</a>( Msg, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
01585 
01586             <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
01587 
01588             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( WakeupThread );
01589 
01590             <span class="keywordflow">return</span> STATUS_REPLY_MESSAGE_MISMATCH;
01591         }
01592 
01593         QueuePort = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01594         Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o7">PortContext</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01595 
01596         <span class="keywordflow">if</span> ((PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o1">Flags</a> &amp; <a class="code" href="../../d2/d6/lpc_8h.html#a3">PORT_TYPE</a>) == <a class="code" href="../../d2/d6/lpc_8h.html#a4">SERVER_CONNECTION_PORT</a>) {
01597 
01598             RundownPort = PortObject;
01599 
01600         } <span class="keywordflow">else</span> {
01601 
01602             RundownPort = PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o3">ConnectedPort</a>;
01603 
01604             <span class="keywordflow">if</span> (RundownPort == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01605 
01606                 <a class="code" href="../../d3/d7/lpcqueue_8c.html#a5">LpcpFreeToPortZone</a>( Msg, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
01607 
01608                 <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
01609 
01610                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( WakeupThread );
01611 
01612                 <span class="keywordflow">return</span> STATUS_PORT_DISCONNECTED;
01613             }
01614 
01615             <span class="keywordflow">if</span> ((PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o1">Flags</a> &amp; <a class="code" href="../../d2/d6/lpc_8h.html#a3">PORT_TYPE</a>) == <a class="code" href="../../d2/d6/lpc_8h.html#a7">CLIENT_COMMUNICATION_PORT</a>) {
01616 
01617                 Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o7">PortContext</a> = RundownPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o8">PortContext</a>;
01618             }
01619         }
01620 
01621         <span class="comment">//</span>
01622         <span class="comment">//  Allocate and initialize a request message</span>
01623         <span class="comment">//</span>
01624 
01625         <a class="code" href="../../d0/d7/lpcp_8h.html#a31">LpcpMoveMessage</a>( &amp;Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>,
01626                          <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a>,
01627                          (<a class="code" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a> + 1),
01628                          0,
01629                          &amp;CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o12">Cid</a> );
01630 
01631         Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>.CallbackId = <a class="code" href="../../d0/d7/lpcp_8h.html#a1">LpcpGenerateCallbackId</a>();
01632 
01633         <a class="code" href="../../d0/d7/lpcp_8h.html#a13">LpcpTrace</a>(( <span class="stringliteral">"%s CallBack Request (%s) Msg %lx (%u.%u) [%08x %08x %08x %08x] to Thread %lx (%s)\n"</span>,
01634                     <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;ImageFileName,
01635                     LpcpMessageTypeName[ Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>.u2.s2.Type &amp; ~LPC_KERNELMODE_MESSAGE ],
01636                     Msg,
01637                     Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>.MessageId,
01638                     Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>.CallbackId,
01639                     *((PULONG)(Msg+1)+0),
01640                     *((PULONG)(Msg+1)+1),
01641                     *((PULONG)(Msg+1)+2),
01642                     *((PULONG)(Msg+1)+3),
01643                     WakeupThread,
01644                     <a class="code" href="../../d1/d9/ps_8h.html#a17">THREAD_TO_PROCESS</a>( WakeupThread )-&gt;ImageFileName ));
01645 
01646         <span class="comment">//</span>
01647         <span class="comment">//  Add an extra reference so LpcExitThread does not evaporate</span>
01648         <span class="comment">//  the pointer before we get to the wait below</span>
01649         <span class="comment">//</span>
01650 
01651         <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>( WakeupThread );
01652 
01653         Msg-&gt;RepliedToThread = WakeupThread;
01654 
01655         WakeupThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o15">LpcReplyMessageId</a> = 0;
01656         WakeupThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o14">LpcReplyMessage</a> = (PVOID)Msg;
01657 
01658         <span class="comment">//</span>
01659         <span class="comment">//  Remove the thread from the reply rundown list as we are sending a callback</span>
01660         <span class="comment">//</span>
01661 
01662         <span class="keywordflow">if</span> (!IsListEmpty( &amp;WakeupThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o5">LpcReplyChain</a> )) {
01663 
01664             RemoveEntryList( &amp;WakeupThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o5">LpcReplyChain</a> );
01665 
01666             InitializeListHead( &amp;WakeupThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o5">LpcReplyChain</a> );
01667         }
01668 
01669         CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o15">LpcReplyMessageId</a> = Msg-&gt;Request.MessageId;
01670         CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o14">LpcReplyMessage</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01671 
01672         InsertTailList( &amp;RundownPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o14">LpcReplyChainHead</a>, &amp;CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o5">LpcReplyChain</a> );
01673 
01674         <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
01675 
01676         <span class="comment">//</span>
01677         <span class="comment">//  Wake up the thread that is waiting for an answer to its request</span>
01678         <span class="comment">//  inside of NtRequestWaitReplyPort or NtReplyWaitReplyPort</span>
01679         <span class="comment">//</span>
01680 
01681         ReleaseSemaphore = &amp;WakeupThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o13">LpcReplySemaphore</a>;
01682 
01683     } <span class="keywordflow">else</span> {
01684 
01685         <span class="comment">//</span>
01686         <span class="comment">//  There is no callbreak requested</span>
01687         <span class="comment">//</span>
01688 
01689         <a class="code" href="../../d0/d7/lpcp_8h.html#a31">LpcpMoveMessage</a>( &amp;Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>,
01690                          <a class="code" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a>,
01691                          (<a class="code" href="../../d8/d0/ctlpcqos_8c.html#a8">RequestMessage</a> + 1),
01692                          0,
01693                          &amp;CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o12">Cid</a> );
01694 
01695         <span class="comment">//</span>
01696         <span class="comment">//  Acquire the global Lpc mutex that gaurds the LpcReplyMessage</span>
01697         <span class="comment">//  field of the thread and the request message queue.  Stamp the</span>
01698         <span class="comment">//  request message with a serial number, insert the message at</span>
01699         <span class="comment">//  the tail of the request message queue and remember the address</span>
01700         <span class="comment">//  of the message in the LpcReplyMessage field for the current thread.</span>
01701         <span class="comment">//</span>
01702 
01703         <a class="code" href="../../d0/d7/lpcp_8h.html#a3">LpcpAcquireLpcpLock</a>();
01704 
01705         Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o7">PortContext</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01706 
01707         <span class="keywordflow">if</span> ((PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o1">Flags</a> &amp; <a class="code" href="../../d2/d6/lpc_8h.html#a3">PORT_TYPE</a>) != <a class="code" href="../../d2/d6/lpc_8h.html#a4">SERVER_CONNECTION_PORT</a>) {
01708 
01709             QueuePort = PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o3">ConnectedPort</a>;
01710 
01711             <span class="keywordflow">if</span> (QueuePort == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01712 
01713                 <a class="code" href="../../d3/d7/lpcqueue_8c.html#a5">LpcpFreeToPortZone</a>( Msg, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
01714 
01715                 <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
01716 
01717                 <span class="keywordflow">return</span> STATUS_PORT_DISCONNECTED;
01718             }
01719 
01720             RundownPort = QueuePort;
01721 
01722             <span class="keywordflow">if</span> ((PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o1">Flags</a> &amp; <a class="code" href="../../d2/d6/lpc_8h.html#a3">PORT_TYPE</a>) == <a class="code" href="../../d2/d6/lpc_8h.html#a7">CLIENT_COMMUNICATION_PORT</a>) {
01723 
01724                 Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o7">PortContext</a> = QueuePort-&gt;PortContext;
01725                 QueuePort = PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o2">ConnectionPort</a>;
01726 
01727             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o1">Flags</a> &amp; <a class="code" href="../../d2/d6/lpc_8h.html#a3">PORT_TYPE</a>) != <a class="code" href="../../d2/d6/lpc_8h.html#a6">SERVER_COMMUNICATION_PORT</a>) {
01728 
01729                 QueuePort = PortObject-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o2">ConnectionPort</a>;
01730             }
01731 
01732         } <span class="keywordflow">else</span> {
01733 
01734             QueuePort = PortObject;
01735             RundownPort = PortObject;
01736         }
01737 
01738         Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o6">RepliedToThread</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01739         Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>.MessageId = <a class="code" href="../../d0/d7/lpcp_8h.html#a0">LpcpGenerateMessageId</a>();
01740         Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>.CallbackId = 0;
01741 
01742         CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o15">LpcReplyMessageId</a> = Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>.MessageId;
01743         CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o14">LpcReplyMessage</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01744 
01745         InsertTailList( &amp;QueuePort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o4">MsgQueue</a>.<a class="code" href="../../d0/d5/struct__LPCP__PORT__QUEUE.html#o2">ReceiveHead</a>, &amp;Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o0">Entry</a> );
01746         InsertTailList( &amp;RundownPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o14">LpcReplyChainHead</a>, &amp;CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o5">LpcReplyChain</a> );
01747 
01748         <a class="code" href="../../d0/d7/lpcp_8h.html#a13">LpcpTrace</a>(( <span class="stringliteral">"%s Send Request (%s) Msg %lx (%u) [%08x %08x %08x %08x] to Port %lx (%s)\n"</span>,
01749                     <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;ImageFileName,
01750                     LpcpMessageTypeName[ Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>.u2.s2.Type &amp; ~LPC_KERNELMODE_MESSAGE ],
01751                     Msg,
01752                     Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>.MessageId,
01753                     *((PULONG)(Msg+1)+0),
01754                     *((PULONG)(Msg+1)+1),
01755                     *((PULONG)(Msg+1)+2),
01756                     *((PULONG)(Msg+1)+3),
01757                     QueuePort,
01758                     <a class="code" href="../../d7/d6/lpcinit_8c.html#a5">LpcpGetCreatorName</a>( QueuePort )));
01759 
01760         <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
01761 
01762         <span class="comment">//</span>
01763         <span class="comment">//  Increment the request message queue semaphore by one for</span>
01764         <span class="comment">//  the newly inserted request message.  Release the spin</span>
01765         <span class="comment">//  lock, while remaining at the dispatcher IRQL.  Then wait for the</span>
01766         <span class="comment">//  reply to this request by waiting on the LpcReplySemaphore</span>
01767         <span class="comment">//  for the current thread.</span>
01768         <span class="comment">//</span>
01769 
01770         ReleaseSemaphore = QueuePort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o4">MsgQueue</a>.<a class="code" href="../../d0/d5/struct__LPCP__PORT__QUEUE.html#o1">Semaphore</a>;
01771 
01772         <span class="keywordflow">if</span> ( QueuePort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o1">Flags</a> &amp; <a class="code" href="../../d2/d6/lpc_8h.html#a8">PORT_WAITABLE</a> ) {
01773 
01774             <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( &amp;QueuePort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o18">WaitEvent</a>,
01775                         <a class="code" href="../../d7/d8/exboosts_8h.html#a2">LPC_RELEASE_WAIT_INCREMENT</a>,
01776                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01777         }
01778     }
01779 
01780     <span class="comment">//</span>
01781     <span class="comment">//  At this point we've enqueued our request and if necessary</span>
01782     <span class="comment">//  set ourselves up for the callback or reply.</span>
01783     <span class="comment">//</span>
01784     <span class="comment">//  So now wake up the other end</span>
01785     <span class="comment">//</span>
01786 
01787     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>( ReleaseSemaphore,
01788                                  1,
01789                                  1,
01790                                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01791 
01792     <span class="keywordflow">if</span> (CallbackRequest) {
01793 
01794         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( WakeupThread );
01795     }
01796 
01797     <span class="comment">//</span>
01798     <span class="comment">//  And wait for a reply</span>
01799     <span class="comment">//</span>
01800 
01801     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o13">LpcReplySemaphore</a>,
01802                                     <a class="code" href="../../d4/d9/ke_8h.html#a407a215">WrLpcReply</a>,
01803                                     <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
01804                                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01805                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
01806 
01807     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_USER_APC) {
01808 
01809         <span class="comment">//</span>
01810         <span class="comment">//  if the semaphore is signaled, then clear it</span>
01811         <span class="comment">//</span>
01812 
01813         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d6/semphobj_8c.html#a2">KeReadStateSemaphore</a>( &amp;CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o13">LpcReplySemaphore</a> )) {
01814 
01815             <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o13">LpcReplySemaphore</a>,
01816                                    <a class="code" href="../../d6/d7/halmips_8h.html#a0">WrExecutive</a>,
01817                                    <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
01818                                    <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01819                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
01820 
01821             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01822         }
01823     }
01824 
01825     <span class="comment">//</span>
01826     <span class="comment">//  Acquire the LPC mutex.  Remove the reply message from the current thread</span>
01827     <span class="comment">//</span>
01828 
01829     <a class="code" href="../../d0/d7/lpcp_8h.html#a3">LpcpAcquireLpcpLock</a>();
01830 
01831     Msg = CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o14">LpcReplyMessage</a>;
01832 
01833     CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o14">LpcReplyMessage</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01834     CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o15">LpcReplyMessageId</a> = 0;
01835 
01836     <span class="comment">//</span>
01837     <span class="comment">//  Remove the thread from the reply rundown list in case we did not wakeup due to</span>
01838     <span class="comment">//  a reply</span>
01839     <span class="comment">//</span>
01840 
01841     <span class="keywordflow">if</span> (!IsListEmpty( &amp;CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o5">LpcReplyChain</a> )) {
01842 
01843         RemoveEntryList( &amp;CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o5">LpcReplyChain</a> );
01844 
01845         InitializeListHead( &amp;CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o5">LpcReplyChain</a> );
01846     }
01847 
01848 <span class="preprocessor">#if DBG</span>
01849 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (Msg != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01850 
01851         <a class="code" href="../../d0/d7/lpcp_8h.html#a13">LpcpTrace</a>(( <span class="stringliteral">"%s Got Reply Msg %lx (%u) [%08x %08x %08x %08x] for Thread %lx (%s)\n"</span>,
01852                     <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;ImageFileName,
01853                     Msg,
01854                     Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>.MessageId,
01855                     *((PULONG)(Msg+1)+0),
01856                     *((PULONG)(Msg+1)+1),
01857                     *((PULONG)(Msg+1)+2),
01858                     *((PULONG)(Msg+1)+3),
01859                     CurrentThread,
01860                     <a class="code" href="../../d1/d9/ps_8h.html#a17">THREAD_TO_PROCESS</a>( CurrentThread )-&gt;ImageFileName ));
01861     }
01862 <span class="preprocessor">#endif</span>
01863 <span class="preprocessor"></span>
01864     <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
01865 
01866     <span class="comment">//</span>
01867     <span class="comment">//  If the wait succeeded, copy the reply to the reply buffer.</span>
01868     <span class="comment">//</span>
01869 
01870     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS) {
01871 
01872         <span class="keywordflow">if</span> (Msg != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01873 
01874             <a class="code" href="../../d0/d7/lpcp_8h.html#a31">LpcpMoveMessage</a>( <a class="code" href="../../d3/d8/client_8c.html#a125">ReplyMessage</a>,
01875                              &amp;Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>,
01876                              (&amp;Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o8">Request</a>) + 1,
01877                              0,
01878                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
01879 
01880             <span class="comment">//</span>
01881             <span class="comment">//  Acquire the LPC mutex and decrement the reference count for the</span>
01882             <span class="comment">//  message.  If the reference count goes to zero the message will be</span>
01883             <span class="comment">//  deleted.</span>
01884             <span class="comment">//</span>
01885 
01886             <a class="code" href="../../d0/d7/lpcp_8h.html#a3">LpcpAcquireLpcpLock</a>();
01887 
01888             <span class="keywordflow">if</span> (Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o6">RepliedToThread</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01889 
01890                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o6">RepliedToThread</a> );
01891 
01892                 Msg-&gt;<a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html#o6">RepliedToThread</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01893             }
01894 
01895             <a class="code" href="../../d3/d7/lpcqueue_8c.html#a5">LpcpFreeToPortZone</a>( Msg, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
01896 
01897             <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
01898 
01899         } <span class="keywordflow">else</span> {
01900 
01901             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_LPC_REPLY_LOST;
01902         }
01903 
01904     } <span class="keywordflow">else</span> {
01905 
01906         <span class="comment">//</span>
01907         <span class="comment">//  Wait failed, acquire the LPC mutex and free the message.</span>
01908         <span class="comment">//</span>
01909 
01910         <a class="code" href="../../d0/d7/lpcp_8h.html#a3">LpcpAcquireLpcpLock</a>();
01911 
01912         <span class="keywordflow">if</span> (Msg != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01913 
01914             <a class="code" href="../../d3/d7/lpcqueue_8c.html#a5">LpcpFreeToPortZone</a>( Msg, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
01915         }
01916 
01917         <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
01918     }
01919 
01920     <span class="comment">//</span>
01921     <span class="comment">//  And return to our caller</span>
01922     <span class="comment">//</span>
01923 
01924     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01925 }
01926 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:40 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
