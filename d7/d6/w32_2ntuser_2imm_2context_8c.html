<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: w32/ntuser/imm/context.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>context.c File Reference</h1><code>#include "<a class="el" href="../../d9/d2/w32_2ntuser_2imm_2precomp_8h-source.html">precomp.h</a>"</code><br>

<p>
<a href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a0">IMCC_ALLOC_TOOLARGE</a>&nbsp;&nbsp;&nbsp;0x1000</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>HIMC WINAPI&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a1">ImmCreateContext</a> (void)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL WINAPI&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a2">ImmDestroyContext</a> (HIMC hImc)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>HIMC WINAPI&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a3">ImmAssociateContext</a> (HWND <a class="el" href="../../d5/d8/jul98_2test_2main_8c.html#a29">hWnd</a>, HIMC hImc)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL WINAPI&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a4">ImmAssociateContextEx</a> (HWND <a class="el" href="../../d5/d8/jul98_2test_2main_8c.html#a29">hWnd</a>, HIMC hImc, <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwFlag)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>HIMC WINAPI&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a5">ImmGetContext</a> (HWND <a class="el" href="../../d5/d8/jul98_2test_2main_8c.html#a29">hWnd</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>HIMC&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a6">ImmGetSaveContext</a> (HWND <a class="el" href="../../d5/d8/jul98_2test_2main_8c.html#a29">hWnd</a>, <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwFlag)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL WINAPI&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a7">ImmReleaseContext</a> (HWND <a class="el" href="../../d5/d8/jul98_2test_2main_8c.html#a29">hWnd</a>, HIMC hImc)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a8">ImmSetActiveContext</a> (HWND <a class="el" href="../../d5/d8/jul98_2test_2main_8c.html#a29">hWnd</a>, HIMC hImc, BOOL fActivate)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d2/d8/structtagIMEMODESAVER.html">PIMEMODESAVER</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a9">GetImeModeSaver</a> (PINPUTCONTEXT pInputContext, HKL hkl)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a10">DestroyImeModeSaver</a> (PINPUTCONTEXT pInputContext)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d8/structtagIMEPRIVATESAVER.html">PIMEPRIVATEMODESAVER</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a11">GetImePrivateModeSaver</a> (<a class="el" href="../../d2/d8/structtagIMEMODESAVER.html">PIMEMODESAVER</a> pImeModeSaver, HKL hkl)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a12">SavePrivateMode</a> (PINPUTCONTEXT pInputContext, <a class="el" href="../../d2/d8/structtagIMEMODESAVER.html">PIMEMODESAVER</a> pImeModeSaver, HKL hkl)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a13">RestorePrivateMode</a> (PINPUTCONTEXT pInputContext, <a class="el" href="../../d2/d8/structtagIMEMODESAVER.html">PIMEMODESAVER</a> pImeModeSaver, HKL hkl)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a14">CreateInputContext</a> (HIMC hImc, HKL hKL, BOOL fCanCallImeSelect)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a15">DestroyInputContext</a> (HIMC hImc, HKL hKL, BOOL bTerminate)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a16">SelectInputContext</a> (HKL hSelKL, HKL hUnSelKL, HIMC hImc)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a17">SendNotificationProc</a> (HIMC hImc, LPARAM lParam)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a18">ImmSendNotification</a> (BOOL fForProcess)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL WINAPI&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a19">ImmEnumInputContext</a> (<a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> idThread, IMCENUMPROC lpfn, LPARAM lParam)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a20">BuildHimcList</a> (<a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> idThread, HIMC **pphimcFirst)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="w32/ntuser/imm/context.c::IMCC_ALLOC_TOOLARGE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IMCC_ALLOC_TOOLARGE&nbsp;&nbsp;&nbsp;0x1000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html#l00015">15</a> of file <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html">w32/ntuser/imm/context.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html#l00837">SelectInputContext()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a20" doxytag="w32/ntuser/imm/context.c::BuildHimcList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> BuildHimcList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>idThread</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HIMC **&nbsp;</td>
          <td class="mdname" nowrap> <em>pphimcFirst</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html#l01259">1259</a> of file <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html">w32/ntuser/imm/context.c</a>.
<p>
<pre class="fragment"><div>01262 {
01263     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> cHimc;
01264     HIMC *phimcFirst;
01265     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01266     <span class="keywordtype">int</span> cTries;
01267 
01268     <span class="comment">/*</span>
01269 <span class="comment">     * Allocate a buffer to hold the names.</span>
01270 <span class="comment">     */</span>
01271     cHimc = 64;
01272     phimcFirst = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a22">ImmLocalAlloc</a>(0, cHimc * <span class="keyword">sizeof</span>(HIMC));
01273     <span class="keywordflow">if</span> (phimcFirst == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01274         <span class="keywordflow">return</span> 0;
01275 
01276     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a390">NtUserBuildHimcList</a>(idThread, cHimc, phimcFirst, &amp;cHimc);
01277 
01278     <span class="comment">/*</span>
01279 <span class="comment">     * If the buffer wasn't big enough, reallocate</span>
01280 <span class="comment">     * the buffer and try again.</span>
01281 <span class="comment">     */</span>
01282     cTries = 0;
01283     <span class="keywordflow">while</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_TOO_SMALL) {
01284         <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(phimcFirst);
01285 
01286         <span class="comment">/*</span>
01287 <span class="comment">         * If we can't seem to get it right,</span>
01288 <span class="comment">         * call it quits</span>
01289 <span class="comment">         */</span>
01290         <span class="keywordflow">if</span> (cTries++ == 10)
01291             <span class="keywordflow">return</span> 0;
01292 
01293         phimcFirst = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a22">ImmLocalAlloc</a>(0, cHimc * <span class="keyword">sizeof</span>(HIMC));
01294         <span class="keywordflow">if</span> (phimcFirst == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01295             <span class="keywordflow">return</span> 0;
01296 
01297         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a390">NtUserBuildHimcList</a>(idThread, cHimc, phimcFirst, &amp;cHimc);
01298     }
01299 
01300     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) || cHimc == 0) {
01301         <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(phimcFirst);
01302         <span class="keywordflow">return</span> 0;
01303     }
01304 
01305     *pphimcFirst = phimcFirst;
01306 
01307     <span class="keywordflow">return</span> cHimc;
01308 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="w32/ntuser/imm/context.c::CreateInputContext" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL CreateInputContext           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">HIMC&nbsp;</td>
          <td class="mdname" nowrap> <em>hImc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HKL&nbsp;</td>
          <td class="mdname" nowrap> <em>hKL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOL&nbsp;</td>
          <td class="mdname" nowrap> <em>fCanCallImeSelect</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html#l00563">563</a> of file <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html">w32/ntuser/imm/context.c</a>.
<p>
<pre class="fragment"><div>00567 {
00568     <a class="code" href="../../d2/d7/structtagIMEDPI.html">PIMEDPI</a>            pImeDpi;
00569     <a class="code" href="../../d3/d0/structtagCLIENTIMC.html">PCLIENTIMC</a>         pClientImc;
00570     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>              dwPrivateDataSize;
00571     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>              fdwInitConvMode = 0;    <span class="comment">// do it later</span>
00572     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>               fInitOpen = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;      <span class="comment">// do it later</span>
00573     PINPUTCONTEXT      pInputContext;
00574     PCOMPOSITIONSTRING pCompStr;
00575     PCANDIDATEINFO     pCandInfo;
00576     PGUIDELINE         pGuideLine;
00577     <span class="keywordtype">int</span>                i;
00578 
00579     pInputContext = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a12">ImmLockIMC</a>(hImc);
00580     <span class="keywordflow">if</span> (!pInputContext) {
00581         RIPMSG1(RIP_WARNING, <span class="stringliteral">"CreateContext: Lock hIMC %x failure"</span>, hImc);
00582         <span class="keywordflow">goto</span> CrIMCLockErrOut;
00583     }
00584 
00585     <span class="comment">/*</span>
00586 <span class="comment">     * Initialize the member of INPUTCONTEXT</span>
00587 <span class="comment">     */</span>
00588     pInputContext-&gt;hCompStr = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a15">ImmCreateIMCC</a>(<span class="keyword">sizeof</span>(COMPOSITIONSTRING));
00589     <span class="keywordflow">if</span> (!pInputContext-&gt;hCompStr) {
00590         RIPMSG0(RIP_WARNING, <span class="stringliteral">"CreateContext: Create hCompStr failure"</span>);
00591         <span class="keywordflow">goto</span> CrIMCUnlockIMC;
00592     }
00593 
00594     pCompStr = (PCOMPOSITIONSTRING)<a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a17">ImmLockIMCC</a>(pInputContext-&gt;hCompStr);
00595     <span class="keywordflow">if</span> (!pCompStr) {
00596         RIPMSG1(RIP_WARNING,
00597               <span class="stringliteral">"CreateContext: Lock hCompStr %x failure"</span>, pInputContext-&gt;hCompStr);
00598         <span class="keywordflow">goto</span> CrIMCFreeCompStr;
00599     }
00600 
00601     pCompStr-&gt;dwSize = <span class="keyword">sizeof</span>(COMPOSITIONSTRING);
00602     <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a18">ImmUnlockIMCC</a>(pInputContext-&gt;hCompStr);
00603 
00604     pInputContext-&gt;hCandInfo = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a15">ImmCreateIMCC</a>(<span class="keyword">sizeof</span>(CANDIDATEINFO));
00605     <span class="keywordflow">if</span> (!pInputContext-&gt;hCandInfo) {
00606         RIPMSG0(RIP_WARNING, <span class="stringliteral">"CreateContext: Create hCandInfo failure"</span>);
00607         <span class="keywordflow">goto</span> CrIMCFreeCompStr;
00608     }
00609 
00610     pCandInfo = (PCANDIDATEINFO)<a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a17">ImmLockIMCC</a>(pInputContext-&gt;hCandInfo);
00611     <span class="keywordflow">if</span> (!pCandInfo) {
00612         RIPMSG1(RIP_WARNING,
00613               <span class="stringliteral">"CreateContext: Lock hCandInfo %x failure"</span>, pInputContext-&gt;hCandInfo);
00614         <span class="keywordflow">goto</span> CrIMCFreeCandInfo;
00615     }
00616 
00617     pCandInfo-&gt;dwSize = <span class="keyword">sizeof</span>(CANDIDATEINFO);
00618     <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a18">ImmUnlockIMCC</a>(pInputContext-&gt;hCandInfo);
00619 
00620     pInputContext-&gt;hGuideLine = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a15">ImmCreateIMCC</a>(<span class="keyword">sizeof</span>(GUIDELINE));
00621     <span class="keywordflow">if</span> (!pInputContext-&gt;hGuideLine) {
00622         RIPMSG0(RIP_WARNING, <span class="stringliteral">"CreateContext: Create hGuideLine failure"</span>);
00623         <span class="keywordflow">goto</span> CrIMCFreeCandInfo;
00624     }
00625 
00626     pGuideLine = (PGUIDELINE)<a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a17">ImmLockIMCC</a>(pInputContext-&gt;hGuideLine);
00627     <span class="keywordflow">if</span> (!pGuideLine) {
00628         RIPMSG1(RIP_WARNING,
00629               <span class="stringliteral">"CreateContext: Lock hGuideLine %x failure"</span>, pInputContext-&gt;hGuideLine);
00630         <span class="keywordflow">goto</span> CrIMCFreeGuideLine;
00631     }
00632 
00633     pGuideLine-&gt;dwSize = <span class="keyword">sizeof</span>(GUIDELINE);
00634     <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a18">ImmUnlockIMCC</a>(pInputContext-&gt;hGuideLine);
00635 
00636     pInputContext-&gt;hMsgBuf = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a15">ImmCreateIMCC</a>(<span class="keyword">sizeof</span>(UINT));
00637     <span class="keywordflow">if</span> (!pInputContext-&gt;hMsgBuf) {
00638         RIPMSG0(RIP_WARNING, <span class="stringliteral">"CreateContext: Create hMsgBuf failure"</span>);
00639         <span class="keywordflow">goto</span> CrIMCFreeGuideLine;
00640     }
00641 
00642     pInputContext-&gt;dwNumMsgBuf = 0;
00643     pInputContext-&gt;fOpen = fInitOpen;
00644     pInputContext-&gt;fdwConversion = fdwInitConvMode;
00645     pInputContext-&gt;fdwSentence = 0;
00646 
00647     <span class="keywordflow">for</span> (i = 0; i &lt; 4; i++) {
00648         pInputContext-&gt;cfCandForm[i].dwIndex = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(-1);
00649     }
00650 
00651     pImeDpi = <a class="code" href="../../d9/d0/immuser_8h.html#a45">ImmLockImeDpi</a>(hKL);
00652     <span class="keywordflow">if</span> (pImeDpi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00653         <span class="keywordflow">if</span> ((pClientImc = <a class="code" href="../../d9/d0/immuser_8h.html#a43">ImmLockClientImc</a>(hImc)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00654             RIPMSG0(RIP_WARNING, <span class="stringliteral">"CreateContext: ImmLockClientImc() failure"</span>);
00655             <a class="code" href="../../d9/d0/immuser_8h.html#a46">ImmUnlockImeDpi</a>(pImeDpi);
00656             <span class="keywordflow">goto</span> CrIMCFreeMsgBuf;
00657         }
00658 
00659         <span class="comment">/*</span>
00660 <span class="comment">         * Unicode based IME expects an Uncode based input context.</span>
00661 <span class="comment">         */</span>
00662         <span class="keywordflow">if</span> (pImeDpi-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o3">ImeInfo</a>.fdwProperty &amp; IME_PROP_UNICODE)
00663             <a class="code" href="../../d4/d0/immcli_8h.html#a19">SetICF</a>(pClientImc, IMCF_UNICODE);
00664 
00665         pClientImc-&gt;<a class="code" href="../../d3/d0/structtagCLIENTIMC.html#o5">dwCodePage</a> = <a class="code" href="../../d4/d0/immcli_8h.html#a25">IMECodePage</a>(pImeDpi);
00666 
00667         <a class="code" href="../../d9/d0/immuser_8h.html#a44">ImmUnlockClientImc</a>(pClientImc);
00668 
00669         dwPrivateDataSize = pImeDpi-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o3">ImeInfo</a>.dwPrivateDataSize;
00670     }
00671     <span class="keywordflow">else</span> {
00672         dwPrivateDataSize = <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>);
00673     }
00674 
00675     pInputContext-&gt;hPrivate = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a15">ImmCreateIMCC</a>(dwPrivateDataSize);
00676     <span class="keywordflow">if</span> (!pInputContext-&gt;hPrivate) {
00677         RIPMSG0(RIP_WARNING, <span class="stringliteral">"CreateContext: Create hPrivate failure"</span>);
00678         <a class="code" href="../../d9/d0/immuser_8h.html#a46">ImmUnlockImeDpi</a>(pImeDpi);
00679         <span class="keywordflow">goto</span> CrIMCFreeMsgBuf;
00680     }
00681 
00682     pInputContext-&gt;pImeModeSaver = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00683 
00684     <span class="keywordflow">if</span> (pImeDpi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00685         <span class="keywordflow">if</span> (fCanCallImeSelect) {
00686             (*pImeDpi-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o8">pfn</a>.<a class="code" href="../../d3/d7/structtagIMEDPI_1_1__tagImeFunctions.html#o23">ImeSelect</a>)(hImc, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00687         }
00688         <a class="code" href="../../d9/d0/immuser_8h.html#a46">ImmUnlockImeDpi</a>(pImeDpi);
00689     }
00690 
00691     <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a13">ImmUnlockIMC</a>(hImc);
00692     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00693 
00694     <span class="comment">/*</span>
00695 <span class="comment">     * context failure case</span>
00696 <span class="comment">     */</span>
00697 CrIMCFreeMsgBuf:
00698     <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a16">ImmDestroyIMCC</a>(pInputContext-&gt;hMsgBuf);
00699 CrIMCFreeGuideLine:
00700     <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a16">ImmDestroyIMCC</a>(pInputContext-&gt;hGuideLine);
00701 CrIMCFreeCandInfo:
00702     <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a16">ImmDestroyIMCC</a>(pInputContext-&gt;hCandInfo);
00703 CrIMCFreeCompStr:
00704     <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a16">ImmDestroyIMCC</a>(pInputContext-&gt;hCompStr);
00705 CrIMCUnlockIMC:
00706     <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a13">ImmUnlockIMC</a>(hImc);
00707 CrIMCLockErrOut:
00708     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00709 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="w32/ntuser/imm/context.c::DestroyImeModeSaver" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID DestroyImeModeSaver           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PINPUTCONTEXT&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pInputContext</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html#l00464">464</a> of file <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html">w32/ntuser/imm/context.c</a>.
<p>
References <a class="el" href="../../d5/d9/immcli_8h-source.html#l00137">ImmLocalFree</a>, <a class="el" href="../../d0/d0/immuser_8h-source.html#l00102">tagIMEPRIVATESAVER::next</a>, <a class="el" href="../../d0/d0/immuser_8h-source.html#l00108">tagIMEMODESAVER::next</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d0/immuser_8h-source.html#l00114">tagIMEMODESAVER::pImePrivateModeSaver</a>, <a class="el" href="../../d9/d0/immuser_8h.html#a33">PIMEPRIVATEMODESAVER</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html#l00718">DestroyInputContext()</a>.
<p>
<pre class="fragment"><div>00466 {
00467     <a class="code" href="../../d2/d8/structtagIMEMODESAVER.html">PIMEMODESAVER</a> pModeSaver = pInputContext-&gt;pImeModeSaver;
00468 
00469     <span class="comment">//</span>
00470     <span class="comment">// Destroy mode savers</span>
00471     <span class="comment">//</span>
00472     <span class="keywordflow">while</span> (pModeSaver) {
00473         <a class="code" href="../../d2/d8/structtagIMEMODESAVER.html">PIMEMODESAVER</a> pNext = pModeSaver-&gt;<a class="code" href="../../d2/d8/structtagIMEMODESAVER.html#o0">next</a>;
00474         <a class="code" href="../../d3/d8/structtagIMEPRIVATESAVER.html">PIMEPRIVATEMODESAVER</a> pPrivateModeSaver = pModeSaver-&gt;<a class="code" href="../../d2/d8/structtagIMEMODESAVER.html#o6">pImePrivateModeSaver</a>;
00475 
00476         <span class="comment">//</span>
00477         <span class="comment">// Destroy private mode savers</span>
00478         <span class="comment">//</span>
00479         <span class="keywordflow">while</span> (pPrivateModeSaver) {
00480             <a class="code" href="../../d3/d8/structtagIMEPRIVATESAVER.html">PIMEPRIVATEMODESAVER</a> pPrivateNext = pPrivateModeSaver-&gt;<a class="code" href="../../d3/d8/structtagIMEPRIVATESAVER.html#o0">next</a>;
00481             <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(pPrivateModeSaver);
00482             pPrivateModeSaver = pPrivateNext;
00483         }
00484 
00485         <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(pModeSaver);
00486         pModeSaver = pNext;
00487     }
00488 
00489     pInputContext-&gt;pImeModeSaver = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00490 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="w32/ntuser/imm/context.c::DestroyInputContext" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL DestroyInputContext           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">HIMC&nbsp;</td>
          <td class="mdname" nowrap> <em>hImc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HKL&nbsp;</td>
          <td class="mdname" nowrap> <em>hKL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOL&nbsp;</td>
          <td class="mdname" nowrap> <em>bTerminate</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html#l00718">718</a> of file <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html">w32/ntuser/imm/context.c</a>.
<p>
<pre class="fragment"><div>00722 {
00723     PINPUTCONTEXT pInputContext;
00724     <a class="code" href="../../d2/d7/structtagIMEDPI.html">PIMEDPI</a>       pImeDpi;
00725     <a class="code" href="../../d1/d7/structtagIMC.html">PIMC</a>          pImc;
00726     <a class="code" href="../../d3/d0/structtagCLIENTIMC.html">PCLIENTIMC</a>    pClientImc;
00727 
00728     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a126">IS_IME_ENABLED</a>()) {
00729         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00730 
00731     }
00732     <span class="keywordflow">if</span> (hImc == <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a>) {
00733         RIPMSG0(RIP_VERBOSE, <span class="stringliteral">"DestroyInputContext: hImc is NULL."</span>);
00734         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00735     }
00736 
00737     pImc = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a6">HMValidateHandle</a>((HANDLE)hImc, TYPE_INPUTCONTEXT);
00738 
00739     <span class="comment">/*</span>
00740 <span class="comment">     * Cannot destroy input context from other thread.</span>
00741 <span class="comment">     */</span>
00742     <span class="keywordflow">if</span> (pImc == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pImc) != <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>())
00743         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00744 
00745     <span class="comment">/*</span>
00746 <span class="comment">     * We are destroying this hImc so we don't bother calling</span>
00747 <span class="comment">     * ImmLockClientImc() to get the pClientImc. Instead, we</span>
00748 <span class="comment">     * reference the pImc-&gt;dwClientImcData directly and call</span>
00749 <span class="comment">     * InterlockedIncrement(&amp;pClientImc-&gt;cLockObj) right after</span>
00750 <span class="comment">     * several quick checks.</span>
00751 <span class="comment">     */</span>
00752     pClientImc = (<a class="code" href="../../d3/d0/structtagCLIENTIMC.html">PCLIENTIMC</a>)pImc-&gt;<a class="code" href="../../d1/d7/structtagIMC.html#o2">dwClientImcData</a>;
00753 
00754     <span class="keywordflow">if</span> (pClientImc == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00755         <span class="comment">/*</span>
00756 <span class="comment">         * Client side Imc has not been initialzed yet.</span>
00757 <span class="comment">         * We simply destroy this input context from kernel.</span>
00758 <span class="comment">         */</span>
00759         <span class="keywordflow">if</span> (bTerminate) {
00760             <span class="comment">/*</span>
00761 <span class="comment">             * If called from THREAD_DETACH, we don't</span>
00762 <span class="comment">             * have to destroy kernel side Input Context.</span>
00763 <span class="comment">             */</span>
00764             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00765         }
00766         <span class="keywordflow">return</span> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a386">NtUserDestroyInputContext</a>(hImc);
00767     }
00768 
00769     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/immcli_8h.html#a21">TestICF</a>(pClientImc, IMCF_DEFAULTIMC) &amp;&amp; !bTerminate) {
00770         <span class="comment">/*</span>
00771 <span class="comment">         * Cannot destroy default input context unless the</span>
00772 <span class="comment">         * thread is terminating.</span>
00773 <span class="comment">         */</span>
00774         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00775     }
00776 
00777     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/immcli_8h.html#a21">TestICF</a>(pClientImc, IMCF_INDESTROY)) {
00778         <span class="comment">/*</span>
00779 <span class="comment">         * This hImc is being destroyed. Returns as success.</span>
00780 <span class="comment">         */</span>
00781         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00782     }
00783 
00784     <span class="comment">/*</span>
00785 <span class="comment">     * Time to lock up the pClientImc.</span>
00786 <span class="comment">     */</span>
00787     InterlockedIncrement(&amp;pClientImc-&gt;<a class="code" href="../../d3/d0/structtagCLIENTIMC.html#o1">cLockObj</a>);
00788 
00789     <span class="keywordflow">if</span> (pClientImc-&gt;<a class="code" href="../../d3/d0/structtagCLIENTIMC.html#o0">hInputContext</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00790 
00791         pInputContext = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a12">ImmLockIMC</a>(hImc);
00792         <span class="keywordflow">if</span> (!pInputContext) {
00793             RIPMSG1(RIP_WARNING, <span class="stringliteral">"DestroyContext: Lock hImc %x failure"</span>, hImc);
00794             <a class="code" href="../../d9/d0/immuser_8h.html#a44">ImmUnlockClientImc</a>(pClientImc);
00795             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00796         }
00797 
00798         pImeDpi = <a class="code" href="../../d9/d0/immuser_8h.html#a45">ImmLockImeDpi</a>(hKL);
00799         <span class="keywordflow">if</span> (pImeDpi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00800             (*pImeDpi-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o8">pfn</a>.<a class="code" href="../../d3/d7/structtagIMEDPI_1_1__tagImeFunctions.html#o23">ImeSelect</a>)(hImc, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00801             <a class="code" href="../../d9/d0/immuser_8h.html#a46">ImmUnlockImeDpi</a>(pImeDpi);
00802         }
00803 
00804         <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a16">ImmDestroyIMCC</a>(pInputContext-&gt;hPrivate);
00805         <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a16">ImmDestroyIMCC</a>(pInputContext-&gt;hMsgBuf);
00806         <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a16">ImmDestroyIMCC</a>(pInputContext-&gt;hGuideLine);
00807         <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a16">ImmDestroyIMCC</a>(pInputContext-&gt;hCandInfo);
00808         <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a16">ImmDestroyIMCC</a>(pInputContext-&gt;hCompStr);
00809 
00810         <span class="comment">/*</span>
00811 <span class="comment">         * Free all ImeModeSaver.</span>
00812 <span class="comment">         */</span>
00813         <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a10">DestroyImeModeSaver</a>(pInputContext);
00814 
00815         <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a13">ImmUnlockIMC</a>(hImc);
00816     }
00817 
00818     <a class="code" href="../../d4/d0/immcli_8h.html#a19">SetICF</a>(pClientImc, IMCF_INDESTROY);
00819 
00820     <span class="comment">/*</span>
00821 <span class="comment">     * ImmUnlockClientImc() will free up the pClientImc</span>
00822 <span class="comment">     * when InterlockedDecrement(&amp;pClientImc-&gt;cLockObj)</span>
00823 <span class="comment">     * reaches 0.</span>
00824 <span class="comment">     */</span>
00825     <a class="code" href="../../d9/d0/immuser_8h.html#a44">ImmUnlockClientImc</a>(pClientImc);
00826 
00827     <span class="keywordflow">return</span> (bTerminate) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a386">NtUserDestroyInputContext</a>(hImc);
00828 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="w32/ntuser/imm/context.c::GetImeModeSaver" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d2/d8/structtagIMEMODESAVER.html">PIMEMODESAVER</a> GetImeModeSaver           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PINPUTCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>pInputContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HKL&nbsp;</td>
          <td class="mdname" nowrap> <em>hkl</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html#l00436">436</a> of file <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html">w32/ntuser/imm/context.c</a>.
<p>
References <a class="el" href="../../d5/d4/conimep_8h-source.html#l00150">HKL_TO_LANGID</a>, <a class="el" href="../../d6/d9/w32_2ntuser_2imm_2misc_8c-source.html#l00557">ImmLocalAlloc()</a>, <a class="el" href="../../d0/d0/immuser_8h-source.html#l00109">tagIMEMODESAVER::langId</a>, <a class="el" href="../../d0/d0/immuser_8h-source.html#l00108">tagIMEMODESAVER::next</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d9/d0/immuser_8h.html#a35">PIMEMODESAVER</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html#l00837">SelectInputContext()</a>.
<p>
<pre class="fragment"><div>00439 {
00440     <a class="code" href="../../d2/d8/structtagIMEMODESAVER.html">PIMEMODESAVER</a> pModeSaver;
00441     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> langId = PRIMARYLANGID(<a class="code" href="../../d4/d5/conimep_8h.html#a50">HKL_TO_LANGID</a>(hkl));
00442 
00443     <span class="keywordflow">for</span> (pModeSaver = pInputContext-&gt;pImeModeSaver; pModeSaver; pModeSaver = pModeSaver-&gt;<a class="code" href="../../d2/d8/structtagIMEMODESAVER.html#o0">next</a>) {
00444         <span class="keywordflow">if</span> (pModeSaver-&gt;<a class="code" href="../../d2/d8/structtagIMEMODESAVER.html#o1">langId</a> == langId) {
00445             <span class="keywordflow">break</span>;
00446         }
00447     }
00448 
00449     <span class="keywordflow">if</span> (pModeSaver == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00450         TAGMSG1(DBGTAG_IMM, <span class="stringliteral">"GetImeModeSaver: creating ModeSaver for langId=%04x"</span>, langId);
00451         pModeSaver = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a22">ImmLocalAlloc</a>(HEAP_ZERO_MEMORY, <span class="keyword">sizeof</span> *pModeSaver);
00452         <span class="keywordflow">if</span> (pModeSaver == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00453             RIPMSG1(RIP_WARNING, <span class="stringliteral">"GetImeModeSaver: failed to create ModeSaver for langId=%04x"</span>, langId);
00454             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00455         }
00456         pModeSaver-&gt;<a class="code" href="../../d2/d8/structtagIMEMODESAVER.html#o1">langId</a> = langId;
00457         pModeSaver-&gt;<a class="code" href="../../d2/d8/structtagIMEMODESAVER.html#o0">next</a> = pInputContext-&gt;pImeModeSaver;
00458         pInputContext-&gt;pImeModeSaver = pModeSaver;
00459     }
00460 
00461     <span class="keywordflow">return</span> pModeSaver;
00462 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="w32/ntuser/imm/context.c::GetImePrivateModeSaver" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d8/structtagIMEPRIVATESAVER.html">PIMEPRIVATEMODESAVER</a> GetImePrivateModeSaver           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d2/d8/structtagIMEMODESAVER.html">PIMEMODESAVER</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pImeModeSaver</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HKL&nbsp;</td>
          <td class="mdname" nowrap> <em>hkl</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html#l00492">492</a> of file <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html">w32/ntuser/imm/context.c</a>.
<p>
References <a class="el" href="../../d0/d0/immuser_8h-source.html#l00103">tagIMEPRIVATESAVER::hkl</a>, <a class="el" href="../../d6/d9/w32_2ntuser_2imm_2misc_8c-source.html#l00557">ImmLocalAlloc()</a>, <a class="el" href="../../d0/d0/immuser_8h-source.html#l00102">tagIMEPRIVATESAVER::next</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d0/d0/immuser_8h-source.html#l00114">tagIMEMODESAVER::pImePrivateModeSaver</a>.
<p>
Referenced by <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html#l00538">RestorePrivateMode()</a>, and <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html#l00520">SavePrivateMode()</a>.
<p>
<pre class="fragment"><div>00495 {
00496     <a class="code" href="../../d3/d8/structtagIMEPRIVATESAVER.html">PIMEPRIVATEMODESAVER</a> pPrivateModeSaver;
00497 
00498     <span class="keywordflow">for</span> (pPrivateModeSaver = pImeModeSaver-&gt;<a class="code" href="../../d2/d8/structtagIMEMODESAVER.html#o6">pImePrivateModeSaver</a>; pPrivateModeSaver; pPrivateModeSaver = pPrivateModeSaver-&gt;<a class="code" href="../../d3/d8/structtagIMEPRIVATESAVER.html#o0">next</a>) {
00499         <span class="keywordflow">if</span> (pPrivateModeSaver-&gt;<a class="code" href="../../d3/d8/structtagIMEPRIVATESAVER.html#o1">hkl</a> == hkl) {
00500             <span class="keywordflow">break</span>;
00501         }
00502     }
00503 
00504     <span class="keywordflow">if</span> (pPrivateModeSaver == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00505         TAGMSG1(DBGTAG_IMM, <span class="stringliteral">"GetImePrivateModeSaver: creating private mode saver for hkl=%08x"</span>, hkl);
00506         pPrivateModeSaver = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a22">ImmLocalAlloc</a>(0, <span class="keyword">sizeof</span> *pPrivateModeSaver);
00507         <span class="keywordflow">if</span> (pPrivateModeSaver == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00508             RIPMSG1(RIP_WARNING, <span class="stringliteral">"GetImePrivateModeSaver: failed to create PrivateModeSaver for hlk=%08x"</span>, hkl);
00509             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00510         }
00511         pPrivateModeSaver-&gt;<a class="code" href="../../d3/d8/structtagIMEPRIVATESAVER.html#o1">hkl</a> = hkl;
00512         pPrivateModeSaver-&gt;<a class="code" href="../../d3/d8/structtagIMEPRIVATESAVER.html#o2">fdwSentence</a> = 0;
00513         pPrivateModeSaver-&gt;<a class="code" href="../../d3/d8/structtagIMEPRIVATESAVER.html#o0">next</a> = pImeModeSaver-&gt;<a class="code" href="../../d2/d8/structtagIMEMODESAVER.html#o6">pImePrivateModeSaver</a>;
00514         pImeModeSaver-&gt;<a class="code" href="../../d2/d8/structtagIMEMODESAVER.html#o6">pImePrivateModeSaver</a> = pPrivateModeSaver;
00515     }
00516 
00517     <span class="keywordflow">return</span> pPrivateModeSaver;
00518 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="w32/ntuser/imm/context.c::ImmAssociateContext" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> HIMC WINAPI ImmAssociateContext           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">HWND&nbsp;</td>
          <td class="mdname" nowrap> <em>hWnd</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HIMC&nbsp;</td>
          <td class="mdname" nowrap> <em>hImc</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html#l00086">86</a> of file <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html">w32/ntuser/imm/context.c</a>.
<p>
References <a class="el" href="../../d8/d0/immstruc_8h.html#a72a44">AIC_FOCUSCONTEXTCHANGED</a>, <a class="el" href="../../d8/d0/immstruc_8h.html#a39">AIC_STATUS</a>, <a class="el" href="../../d8/d0/immstruc_8h.html#a72a43">AIC_SUCCESS</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d9/immcli_8h-source.html#l00152">GetInputContextThread</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01770">tagWND::hImc</a>, <a class="el" href="../../d4/d7/aug98_2test_2main_8c-source.html#l00110">hWnd</a>, <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html#l00309">ImmSetActiveContext()</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00591">IS_IME_ENABLED</a>, <a class="el" href="../../d5/d9/immcli_8h-source.html#l00168">IsWndEqual</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l12635">NtUserAssociateInputContext()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l09643">NtUserQueryWindow()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d9/d9/immstruc_8h-source.html#l00025">NULL_HIMC</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d9/immcli_8h-source.html#l00120">ValidateHwnd</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/fareast_8c-source.html#l00238">_InitializeImmEntryTable()</a>, <a class="el" href="../../d1/d4/ntcon_2conime_2conime_8c-source.html#l00950">ConsoleKillFocus()</a>, <a class="el" href="../../d1/d4/ntcon_2conime_2conime_8c-source.html#l00903">ConsoleSetFocus()</a>, <a class="el" href="../../d1/d4/ntcon_2conime_2conime_8c-source.html#l00611">ExitList()</a>, and <a class="el" href="../../d1/d5/consubs_8c-source.html#l00670">SetNLSMode()</a>.
<p>
<pre class="fragment"><div>00089 {
00090     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pWnd;
00091     HIMC  hPrevImc;
00092     <a class="code" href="../../d8/d0/immstruc_8h.html#a39">AIC_STATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00093 
00094     <span class="comment">// early out</span>
00095     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a126">IS_IME_ENABLED</a>()) {
00096         <span class="keywordflow">return</span> <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a>;
00097     }
00098 
00099     <span class="keywordflow">if</span> ((pWnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hWnd)) == (<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00100         RIPMSG1(RIP_WARNING,
00101               <span class="stringliteral">"ImmAssociateContext: invalid window handle %x"</span>, hWnd);
00102         <span class="keywordflow">return</span> <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a>;
00103     }
00104 
00105 
00106 
00107     <span class="keywordflow">if</span> (hImc != <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a> &amp;&amp;
00108             <a class="code" href="../../d4/d0/immcli_8h.html#a15">GetInputContextThread</a>(hImc) != GetCurrentThreadId()) {
00109         RIPMSG1(RIP_WARNING,
00110               <span class="stringliteral">"ImmAssociateContext: Invalid input context access %lx."</span>, hImc);
00111         <span class="keywordflow">return</span> <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a>;
00112     }
00113 
00114     <span class="comment">/*</span>
00115 <span class="comment">     * associate to the same input context, do nothing.</span>
00116 <span class="comment">     */</span>
00117     <span class="keywordflow">if</span> (pWnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o20">hImc</a> == hImc)
00118         <span class="keywordflow">return</span> hImc;
00119 
00120     hPrevImc = pWnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o20">hImc</a>;
00121 
00122     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a387">NtUserAssociateInputContext</a>(hWnd, hImc, 0);
00123 
00124     <span class="keywordflow">switch</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) {
00125     <span class="keywordflow">case</span> <a class="code" href="../../d8/d0/immstruc_8h.html#a72a44">AIC_FOCUSCONTEXTCHANGED</a>:
00126         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/immcli_8h.html#a22">IsWndEqual</a>(<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a328">NtUserQueryWindow</a>(hWnd, WindowFocusWindow), hWnd)) {
00127             <a class="code" href="../../d9/d0/immuser_8h.html#a36">ImmSetActiveContext</a>(hWnd, hPrevImc, FALSE);
00128             <a class="code" href="../../d9/d0/immuser_8h.html#a36">ImmSetActiveContext</a>(hWnd, hImc, TRUE);
00129         }
00130 
00131         <span class="comment">// Fall thru.</span>
00132 
00133     <span class="keywordflow">case</span> <a class="code" href="../../d8/d0/immstruc_8h.html#a72a43">AIC_SUCCESS</a>:
00134         <span class="keywordflow">return</span> hPrevImc;
00135 
00136     <span class="keywordflow">default</span>:
00137         <span class="keywordflow">return</span> <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a>;
00138     }
00139 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="w32/ntuser/imm/context.c::ImmAssociateContextEx" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL WINAPI ImmAssociateContextEx           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">HWND&nbsp;</td>
          <td class="mdname" nowrap> <em>hWnd</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HIMC&nbsp;</td>
          <td class="mdname" nowrap> <em>hImc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>dwFlag</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html#l00142">142</a> of file <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html">w32/ntuser/imm/context.c</a>.
<p>
References <a class="el" href="../../d8/d0/immstruc_8h.html#a72a44">AIC_FOCUSCONTEXTCHANGED</a>, <a class="el" href="../../d8/d0/immstruc_8h.html#a39">AIC_STATUS</a>, <a class="el" href="../../d8/d0/immstruc_8h.html#a72a43">AIC_SUCCESS</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d9/immcli_8h-source.html#l00152">GetInputContextThread</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01770">tagWND::hImc</a>, <a class="el" href="../../d4/d7/aug98_2test_2main_8c-source.html#l00110">hWnd</a>, <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html#l00309">ImmSetActiveContext()</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00591">IS_IME_ENABLED</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l12635">NtUserAssociateInputContext()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l09643">NtUserQueryWindow()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d9/d9/immstruc_8h-source.html#l00025">NULL_HIMC</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d9/immcli_8h-source.html#l00120">ValidateHwnd</a>.
<p>
<pre class="fragment"><div>00146 {
00147     HWND hWndFocus;
00148     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pWndFocus;
00149     HIMC hImcFocusOld;
00150     <a class="code" href="../../d8/d0/immstruc_8h.html#a39">AIC_STATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00151 
00152     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a126">IS_IME_ENABLED</a>()) {
00153         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00154     }
00155 
00156     hWndFocus = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a328">NtUserQueryWindow</a>(hWnd, WindowFocusWindow);
00157 
00158     <span class="keywordflow">if</span> (hImc != <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a> &amp;&amp; !(dwFlag &amp; IACE_DEFAULT) &amp;&amp;
00159             <a class="code" href="../../d4/d0/immcli_8h.html#a15">GetInputContextThread</a>(hImc) != GetCurrentThreadId()) {
00160         RIPMSG1(RIP_WARNING,
00161               <span class="stringliteral">"ImmAssociateContextEx: Invalid input context access %lx."</span>, hImc);
00162         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00163     }
00164 
00165     <span class="keywordflow">if</span> ((pWndFocus = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hWndFocus)) != (<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00166         hImcFocusOld = pWndFocus-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o20">hImc</a>;
00167     <span class="keywordflow">else</span>
00168         hImcFocusOld = <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a>;
00169 
00170     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a387">NtUserAssociateInputContext</a>(hWnd, hImc, dwFlag);
00171 
00172     <span class="keywordflow">switch</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) {
00173     <span class="keywordflow">case</span> <a class="code" href="../../d8/d0/immstruc_8h.html#a72a44">AIC_FOCUSCONTEXTCHANGED</a>:
00174         <span class="keywordflow">if</span> ((pWndFocus = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hWndFocus)) != (<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00175             hImc = pWndFocus-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o20">hImc</a>;
00176             <span class="keywordflow">if</span> (hImc != hImcFocusOld) {
00177                 <a class="code" href="../../d9/d0/immuser_8h.html#a36">ImmSetActiveContext</a>(hWndFocus, hImcFocusOld, FALSE);
00178                 <a class="code" href="../../d9/d0/immuser_8h.html#a36">ImmSetActiveContext</a>(hWndFocus, hImc, TRUE);
00179             };
00180         };
00181 
00182         <span class="comment">// Fall thru.</span>
00183 
00184     <span class="keywordflow">case</span> <a class="code" href="../../d8/d0/immstruc_8h.html#a72a43">AIC_SUCCESS</a>:
00185         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00186 
00187     <span class="keywordflow">default</span>:
00188         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00189     }
00190 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="w32/ntuser/imm/context.c::ImmCreateContext" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> HIMC WINAPI ImmCreateContext           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">void&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html#l00026">26</a> of file <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html">w32/ntuser/imm/context.c</a>.
<p>
References <a class="el" href="../../d9/d0/immuser_8h.html#a6">CLIENTIMC</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d6/d9/w32_2ntuser_2imm_2misc_8c-source.html#l00557">ImmLocalAlloc()</a>, <a class="el" href="../../d5/d9/immcli_8h-source.html#l00137">ImmLocalFree</a>, <a class="el" href="../../d0/d0/immuser_8h-source.html#l00032">InitImcCrit</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00591">IS_IME_ENABLED</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l12596">NtUserCreateInputContext()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l07799">NtUserGetThreadState()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d9/d9/immstruc_8h-source.html#l00025">NULL_HIMC</a>.
<p>
Referenced by <a class="el" href="../../d1/d4/ntcon_2conime_2conime_8c-source.html#l00664">InsertConsole()</a>.
<p>
<pre class="fragment"><div>00027 {
00028     <a class="code" href="../../d3/d0/structtagCLIENTIMC.html">PCLIENTIMC</a> pClientImc;
00029     HIMC       hImc = <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a>;
00030 
00031     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a126">IS_IME_ENABLED</a>()) {
00032         <span class="keywordflow">return</span> <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a>;
00033     }
00034 
00035     pClientImc = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a22">ImmLocalAlloc</a>(HEAP_ZERO_MEMORY, <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d0/structtagCLIENTIMC.html">CLIENTIMC</a>));
00036 
00037     <span class="keywordflow">if</span> (pClientImc != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00038 
00039         hImc = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a385">NtUserCreateInputContext</a>((ULONG_PTR)pClientImc);
00040         <span class="keywordflow">if</span> (hImc == <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a>) {
00041             <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(pClientImc);
00042             <span class="keywordflow">return</span> <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a>;
00043         }
00044 
00045         <a class="code" href="../../d9/d0/immuser_8h.html#a0">InitImcCrit</a>(pClientImc);
00046         pClientImc-&gt;<a class="code" href="../../d3/d0/structtagCLIENTIMC.html#o3">dwImeCompatFlags</a> = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a287">NtUserGetThreadState</a>(UserThreadStateImeCompatFlags);
00047     }
00048 
00049     <span class="keywordflow">return</span> hImc;
00050 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="w32/ntuser/imm/context.c::ImmDestroyContext" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL WINAPI ImmDestroyContext           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">HIMC&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>hImc</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html#l00061">61</a> of file <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html">w32/ntuser/imm/context.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d6/d7/ntimm_8c-source.html#l00122">DestroyInputContext()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d9/immcli_8h-source.html#l00152">GetInputContextThread</a>, <a class="el" href="../../d4/d7/client_8c-source.html#l04502">GetKeyboardLayout()</a>, and <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00591">IS_IME_ENABLED</a>.
<p>
Referenced by <a class="el" href="../../d1/d4/ntcon_2conime_2conime_8c-source.html#l00611">ExitList()</a>, and <a class="el" href="../../d1/d4/ntcon_2conime_2conime_8c-source.html#l00824">RemoveConsoleWorker()</a>.
<p>
<pre class="fragment"><div>00063 {
00064     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a126">IS_IME_ENABLED</a>()) {
00065         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00066     }
00067 
00068     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/immcli_8h.html#a15">GetInputContextThread</a>(hImc) != GetCurrentThreadId()) {
00069         RIPMSG1(RIP_WARNING,
00070               <span class="stringliteral">"ImmDestroyContext: Invalid input context access %lx."</span>, hImc);
00071         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00072     }
00073 
00074     <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a2031">DestroyInputContext</a>(hImc, <a class="code" href="../../d3/d8/client_8c.html#a154">GetKeyboardLayout</a>(0), FALSE);
00075 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="w32/ntuser/imm/context.c::ImmEnumInputContext" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL WINAPI ImmEnumInputContext           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>idThread</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IMCENUMPROC&nbsp;</td>
          <td class="mdname" nowrap> <em>lpfn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPARAM&nbsp;</td>
          <td class="mdname" nowrap> <em>lParam</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html#l01211">1211</a> of file <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html">w32/ntuser/imm/context.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d6/d7/ntimm_8c-source.html#l00475">BuildHimcList()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d9/immcli_8h-source.html#l00137">ImmLocalFree</a>, <a class="el" href="../../d5/d9/immcli_8h-source.html#l00126">RevalidateHimc</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d0/d5/ndismain_8h-source.html#l00026">UINT</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/fareast_8c-source.html#l00238">_InitializeImmEntryTable()</a>, <a class="el" href="../../d7/d9/immime_8c-source.html#l00495">ImmActivateLayout()</a>, and <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html#l01191">ImmSendNotification()</a>.
<p>
<pre class="fragment"><div>01215 {
01216     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> i;
01217     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> cHimc;
01218     HIMC *phimcT;
01219     HIMC *phimcFirst;
01220     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fSuccess = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01221 
01222     <span class="comment">/*</span>
01223 <span class="comment">     * Get the himc list.  It is returned in a block of memory</span>
01224 <span class="comment">     * allocated with ImmLocalAlloc.</span>
01225 <span class="comment">     */</span>
01226     <span class="keywordflow">if</span> ((cHimc = <a class="code" href="../../d4/d1/userk_8h.html#a2037">BuildHimcList</a>(idThread, &amp;phimcFirst)) == 0) {
01227         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01228     }
01229 
01230     <span class="comment">/*</span>
01231 <span class="comment">     * Loop through the input contexts, call the function pointer back for</span>
01232 <span class="comment">     * each one. End loop if either FALSE is returned or the end-of-list is</span>
01233 <span class="comment">     * reached.</span>
01234 <span class="comment">     */</span>
01235     phimcT = phimcFirst;
01236     <span class="keywordflow">for</span> (i = 0; i &lt; cHimc; i++) {
01237         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/immcli_8h.html#a6">RevalidateHimc</a>(*phimcT)) {
01238             <span class="keywordflow">if</span> (!(fSuccess = (*lpfn)(*phimcT, lParam)))
01239                 <span class="keywordflow">break</span>;
01240         }
01241         phimcT++;
01242     }
01243 
01244     <span class="comment">/*</span>
01245 <span class="comment">     * Free up buffer and return status - TRUE if entire list was enumerated,</span>
01246 <span class="comment">     * FALSE otherwise.</span>
01247 <span class="comment">     */</span>
01248     <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(phimcFirst);
01249 
01250     <span class="keywordflow">return</span> fSuccess;
01251 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="w32/ntuser/imm/context.c::ImmGetContext" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> HIMC WINAPI ImmGetContext           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">HWND&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>hWnd</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html#l00201">201</a> of file <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html">w32/ntuser/imm/context.c</a>.
<p>
References <a class="el" href="../../d4/d7/aug98_2test_2main_8c-source.html#l00110">hWnd</a>, <a class="el" href="../../d9/d9/immstruc_8h-source.html#l00047">IGSC_WINNLSCHECK</a>, <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html#l00225">ImmGetSaveContext()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d9/d9/immstruc_8h-source.html#l00025">NULL_HIMC</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/fareast_8c-source.html#l00238">_InitializeImmEntryTable()</a>, <a class="el" href="../../d1/d5/consubs_8c-source.html#l00023">Create()</a>, <a class="el" href="../../d9/d6/country3_8c-source.html#l00070">GetCompStrJapan()</a>, <a class="el" href="../../d9/d6/country3_8c-source.html#l00700">GetCompStrKorea()</a>, <a class="el" href="../../d9/d6/country3_8c-source.html#l00486">GetCompStrPRC()</a>, <a class="el" href="../../d9/d6/country3_8c-source.html#l00272">GetCompStrTaiwan()</a>, <a class="el" href="../../d1/d5/consubs_8c-source.html#l00640">GetNLSMode()</a>, <a class="el" href="../../d1/d9/imefull_8c-source.html#l00030">ImeOpenClose()</a>, <a class="el" href="../../d8/d6/country2_8c-source.html#l01204">ImeUICloseCandidate()</a>, <a class="el" href="../../d1/d5/consubs_8c-source.html#l00576">ImeUIGuideLine()</a>, <a class="el" href="../../d8/d6/country2_8c-source.html#l00024">ImeUIOpenCandidate()</a>, <a class="el" href="../../d1/d5/consubs_8c-source.html#l00406">ImeUIOpenStatusWindow()</a>, <a class="el" href="../../d1/d5/consubs_8c-source.html#l00522">ImeUISetConversionMode()</a>, <a class="el" href="../../d1/d5/consubs_8c-source.html#l00468">ImeUISetOpenStatus()</a>, <a class="el" href="../../d2/d4/ntuser_2imm_2conime_8c-source.html#l00034">ImmCallImeConsoleIME()</a>, <a class="el" href="../../d6/d9/w32_2ntuser_2imm_2misc_8c-source.html#l00271">ImmGetVirtualKey()</a>, <a class="el" href="../../d7/d9/immime_8c-source.html#l01128">ImmPenAuxInput()</a>, <a class="el" href="../../d5/d2/ntuser_2imm_2input_8c-source.html#l00030">ImmProcessKey()</a>, <a class="el" href="../../d2/d4/ntuser_2imm_2conime_8c-source.html#l00188">ImmSetActiveContextConsoleIME()</a>, <a class="el" href="../../d3/d1/hotkey_8c-source.html#l00057">ImmSimulateHotKey()</a>, <a class="el" href="../../d5/d2/ntuser_2imm_2input_8c-source.html#l00196">ImmTranslateMessage()</a>, <a class="el" href="../../d1/d5/consubs_8c-source.html#l00670">SetNLSMode()</a>, and <a class="el" href="../../d3/d4/transsub_8c-source.html#l00828">TransSendVKey()</a>.
<p>
<pre class="fragment"><div>00203 {
00204     <span class="keywordflow">if</span> ( <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00205         RIPMSG1(RIP_WARNING,
00206               <span class="stringliteral">"ImmGetContext: invalid window handle %x"</span>, hWnd);
00207         <span class="keywordflow">return</span> <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a>;
00208     }
00209     <span class="comment">/*</span>
00210 <span class="comment">     * for non-NULL hWnd, ImmGetSaveContext will do the</span>
00211 <span class="comment">     * validation and "same process" checking.</span>
00212 <span class="comment">     */</span>
00213     <span class="keywordflow">return</span> <a class="code" href="../../d4/d0/immcli_8h.html#a72">ImmGetSaveContext</a>( hWnd, IGSC_WINNLSCHECK );
00214 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="w32/ntuser/imm/context.c::ImmGetSaveContext" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> HIMC ImmGetSaveContext           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">HWND&nbsp;</td>
          <td class="mdname" nowrap> <em>hWnd</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>dwFlag</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html#l00225">225</a> of file <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html">w32/ntuser/imm/context.c</a>.
<p>
References <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01770">tagWND::hImc</a>, <a class="el" href="../../d4/d7/aug98_2test_2main_8c-source.html#l00110">hWnd</a>, <a class="el" href="../../d9/d9/immstruc_8h-source.html#l00046">IGSC_DEFIMCFALLBACK</a>, <a class="el" href="../../d9/d9/immstruc_8h-source.html#l00047">IGSC_WINNLSCHECK</a>, <a class="el" href="../../d9/d9/immstruc_8h-source.html#l00040">IMCF_WINNLSDISABLE</a>, <a class="el" href="../../d6/d9/w32_2ntuser_2imm_2misc_8c-source.html#l00689">ImmLockClientImc()</a>, <a class="el" href="../../d6/d9/w32_2ntuser_2imm_2misc_8c-source.html#l00747">ImmUnlockClientImc()</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00591">IS_IME_ENABLED</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l07799">NtUserGetThreadState()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l09643">NtUserQueryWindow()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d9/d9/immstruc_8h-source.html#l00025">NULL_HIMC</a>, <a class="el" href="../../d5/d9/immcli_8h-source.html#l00166">TestICF</a>, <a class="el" href="../../d0/d7/kernel_2winmgr_8c-source.html#l01178">TestWindowProcess()</a>, and <a class="el" href="../../d5/d9/immcli_8h-source.html#l00120">ValidateHwnd</a>.
<p>
Referenced by <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html#l00201">ImmGetContext()</a>, <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html#l00309">ImmSetActiveContext()</a>, <a class="el" href="../../d7/d8/clwinnls_8c-source.html#l00037">ImmWINNLSGetEnableStatus()</a>, and <a class="el" href="../../d3/d4/transsub_8c-source.html#l00054">TranslateIMESubFunctions()</a>.
<p>
<pre class="fragment"><div>00228 {
00229     HIMC       hRetImc;
00230     <a class="code" href="../../d3/d0/structtagCLIENTIMC.html">PCLIENTIMC</a> pClientImc;
00231     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pwnd;
00232 
00233     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a126">IS_IME_ENABLED</a>()) {
00234         <span class="keywordflow">return</span> <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a>;
00235     }
00236 
00237     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00238         <span class="comment">/*</span>
00239 <span class="comment">         * Retrieves the default input context of current thread.</span>
00240 <span class="comment">         */</span>
00241         hRetImc = (HIMC)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a287">NtUserGetThreadState</a>(UserThreadStateDefaultInputContext);
00242     }
00243     <span class="keywordflow">else</span> {
00244         <span class="comment">/*</span>
00245 <span class="comment">         * Retrieves the input context associated to the given window.</span>
00246 <span class="comment">         */</span>
00247         <span class="keywordflow">if</span> ((pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hWnd)) == (<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00248             RIPMSG1(RIP_WARNING,
00249                   <span class="stringliteral">"ImmGetSaveContext: invalid window handle %x"</span>, hWnd);
00250             <span class="keywordflow">return</span> <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a>;
00251         }
00252         <span class="comment">/*</span>
00253 <span class="comment">         * Don't allow other process to access input context</span>
00254 <span class="comment">         */</span>
00255         <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a16">TestWindowProcess</a>(pwnd)) {
00256             RIPMSG0(RIP_WARNING,
00257                   <span class="stringliteral">"ImmGetSaveContext: can not get input context of other process"</span>);
00258             <span class="keywordflow">return</span> <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a>;
00259         }
00260         hRetImc = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o20">hImc</a>;
00261 
00262         <span class="keywordflow">if</span> (hRetImc == <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a> &amp;&amp; (dwFlag &amp; <a class="code" href="../../d8/d0/immstruc_8h.html#a13">IGSC_DEFIMCFALLBACK</a>)) {
00263             <span class="comment">/*</span>
00264 <span class="comment">             * hWnd associated with NULL input context, retrieves the</span>
00265 <span class="comment">             * default input context of the hWnd's creator thread.</span>
00266 <span class="comment">             */</span>
00267             hRetImc = (HIMC)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a328">NtUserQueryWindow</a>(hWnd, WindowDefaultInputContext);
00268         }
00269     }
00270 
00271     pClientImc = <a class="code" href="../../d9/d0/immuser_8h.html#a43">ImmLockClientImc</a>(hRetImc);
00272     <span class="keywordflow">if</span> (pClientImc == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00273         <span class="keywordflow">return</span> <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a>;
00274 
00275     <span class="keywordflow">if</span> ((dwFlag &amp; <a class="code" href="../../d8/d0/immstruc_8h.html#a14">IGSC_WINNLSCHECK</a>) &amp;&amp; <a class="code" href="../../d4/d0/immcli_8h.html#a21">TestICF</a>(pClientImc, IMCF_WINNLSDISABLE))
00276         hRetImc = <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a>;
00277 
00278     <a class="code" href="../../d9/d0/immuser_8h.html#a44">ImmUnlockClientImc</a>(pClientImc);
00279 
00280     <span class="keywordflow">return</span> hRetImc;
00281 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="w32/ntuser/imm/context.c::ImmReleaseContext" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL WINAPI ImmReleaseContext           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">HWND&nbsp;</td>
          <td class="mdname" nowrap> <em>hWnd</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HIMC&nbsp;</td>
          <td class="mdname" nowrap> <em>hImc</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html#l00292">292</a> of file <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html">w32/ntuser/imm/context.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d4/d7/aug98_2test_2main_8c-source.html#l00110">hWnd</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/fareast_8c-source.html#l00238">_InitializeImmEntryTable()</a>, <a class="el" href="../../d9/d6/country3_8c-source.html#l00070">GetCompStrJapan()</a>, <a class="el" href="../../d9/d6/country3_8c-source.html#l00700">GetCompStrKorea()</a>, <a class="el" href="../../d9/d6/country3_8c-source.html#l00486">GetCompStrPRC()</a>, <a class="el" href="../../d9/d6/country3_8c-source.html#l00272">GetCompStrTaiwan()</a>, <a class="el" href="../../d1/d5/consubs_8c-source.html#l00640">GetNLSMode()</a>, <a class="el" href="../../d1/d9/imefull_8c-source.html#l00030">ImeOpenClose()</a>, <a class="el" href="../../d8/d6/country2_8c-source.html#l01204">ImeUICloseCandidate()</a>, <a class="el" href="../../d1/d5/consubs_8c-source.html#l00576">ImeUIGuideLine()</a>, <a class="el" href="../../d8/d6/country2_8c-source.html#l00024">ImeUIOpenCandidate()</a>, <a class="el" href="../../d1/d5/consubs_8c-source.html#l00406">ImeUIOpenStatusWindow()</a>, <a class="el" href="../../d1/d5/consubs_8c-source.html#l00522">ImeUISetConversionMode()</a>, <a class="el" href="../../d1/d5/consubs_8c-source.html#l00468">ImeUISetOpenStatus()</a>, <a class="el" href="../../d5/d2/ntuser_2imm_2input_8c-source.html#l00030">ImmProcessKey()</a>, <a class="el" href="../../d3/d1/hotkey_8c-source.html#l00057">ImmSimulateHotKey()</a>, <a class="el" href="../../d5/d2/ntuser_2imm_2input_8c-source.html#l00196">ImmTranslateMessage()</a>, and <a class="el" href="../../d1/d5/consubs_8c-source.html#l00670">SetNLSMode()</a>.
<p>
<pre class="fragment"><div>00295 {
00296     UNREFERENCED_PARAMETER(hWnd);
00297     UNREFERENCED_PARAMETER(hImc);
00298 
00299     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00300 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="w32/ntuser/imm/context.c::ImmSendNotification" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ImmSendNotification           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">BOOL&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>fForProcess</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html#l01191">1191</a> of file <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html">w32/ntuser/imm/context.c</a>.
<p>
References <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html#l01211">ImmEnumInputContext()</a>, <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html#l01157">SendNotificationProc()</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/w32_2ntuser_2imm_2misc_8c-source.html#l00955">ImmSystemHandler()</a>.
<p>
<pre class="fragment"><div>01193 {
01194     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwThreadId;
01195 
01196     <span class="keywordflow">if</span> (fForProcess) {
01197         dwThreadId = -1;
01198     } <span class="keywordflow">else</span> {
01199         dwThreadId = 0;
01200     }
01201 
01202     <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a19">ImmEnumInputContext</a>(dwThreadId, (IMCENUMPROC)SendNotificationProc, 0);
01203 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="w32/ntuser/imm/context.c::ImmSetActiveContext" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL ImmSetActiveContext           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">HWND&nbsp;</td>
          <td class="mdname" nowrap> <em>hWnd</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HIMC&nbsp;</td>
          <td class="mdname" nowrap> <em>hImc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOL&nbsp;</td>
          <td class="mdname" nowrap> <em>fActivate</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html#l00309">309</a> of file <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html">w32/ntuser/imm/context.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d5/d9/immcli_8h-source.html#l00164">ClrICF</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d7/client_8c-source.html#l04502">GetKeyboardLayout()</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01547">GETPTI</a>, <a class="el" href="../../d4/d7/aug98_2test_2main_8c-source.html#l00110">hWnd</a>, <a class="el" href="../../d9/d9/immstruc_8h-source.html#l00046">IGSC_DEFIMCFALLBACK</a>, <a class="el" href="../../d9/d9/immstruc_8h-source.html#l00034">IMCF_ACTIVE</a>, <a class="el" href="../../d0/d0/immuser_8h-source.html#l00088">tagIMEDPI::_tagImeFunctions::ImeSetActiveContext</a>, <a class="el" href="../../d6/d9/w32_2ntuser_2imm_2misc_8c-source.html#l00027">ImmGetDefaultIMEWnd()</a>, <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html#l00225">ImmGetSaveContext()</a>, <a class="el" href="../../d6/d9/w32_2ntuser_2imm_2misc_8c-source.html#l00689">ImmLockClientImc()</a>, <a class="el" href="../../d6/d9/w32_2ntuser_2imm_2misc_8c-source.html#l00371">ImmLockIMC()</a>, <a class="el" href="../../d6/d9/w32_2ntuser_2imm_2misc_8c-source.html#l00793">ImmLockImeDpi()</a>, <a class="el" href="../../d6/d9/w32_2ntuser_2imm_2misc_8c-source.html#l00747">ImmUnlockClientImc()</a>, <a class="el" href="../../d6/d9/w32_2ntuser_2imm_2misc_8c-source.html#l00383">ImmUnlockIMC()</a>, <a class="el" href="../../d6/d9/w32_2ntuser_2imm_2misc_8c-source.html#l00824">ImmUnlockImeDpi()</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00591">IS_IME_ENABLED</a>, <a class="el" href="../../d4/d8/client_2wow_8c-source.html#l00277">IsWindow()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l13072">NtUserNotifyIMEStatus()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d9/d9/immstruc_8h-source.html#l00025">NULL_HIMC</a>, <a class="el" href="../../d2/d7/structtagIMEDPI.html#o8">tagIMEDPI::pfn</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, <a class="el" href="../../d6/d8/cltxt_8h-source.html#l00652">SendMessage()</a>, <a class="el" href="../../d5/d9/immcli_8h-source.html#l00162">SetICF</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d9/immcli_8h-source.html#l00120">ValidateHwnd</a>.
<p>
Referenced by <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html#l00086">ImmAssociateContext()</a>, <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html#l00142">ImmAssociateContextEx()</a>, <a class="el" href="../../d7/d8/clwinnls_8c-source.html#l00484">ImmEnableIME()</a>, and <a class="el" href="../../d2/d4/ntuser_2imm_2conime_8c-source.html#l00188">ImmSetActiveContextConsoleIME()</a>.
<p>
<pre class="fragment"><div>00313 {
00314     <a class="code" href="../../d3/d0/structtagCLIENTIMC.html">PCLIENTIMC</a>    pClientImc;
00315     PINPUTCONTEXT pInputContext;
00316     <a class="code" href="../../d2/d7/structtagIMEDPI.html">PIMEDPI</a>       pImeDpi;
00317     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>         dwISC;
00318     HIMC          hSaveImc;
00319     HWND          hDefImeWnd;
00320     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>         dwOpenStatus = 0;
00321     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>         dwConversion = 0;
00322 <span class="preprocessor">#ifdef DEBUG</span>
00323 <span class="preprocessor"></span>    <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>          pWnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hWnd);
00324 
00325     <span class="keywordflow">if</span> (pWnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pWnd) != <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()) {
00326         RIPMSG1(RIP_WARNING, <span class="stringliteral">"hWnd (=%lx) is not of current thread."</span>, hWnd);
00327     }
00328 <span class="preprocessor">#endif</span>
00329 <span class="preprocessor"></span>
00330     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a126">IS_IME_ENABLED</a>()) {
00331         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00332     }
00333 
00334     dwISC = ISC_SHOWUIALL;
00335 
00336     pClientImc = <a class="code" href="../../d9/d0/immuser_8h.html#a43">ImmLockClientImc</a>(hImc);
00337 
00338     <span class="keywordflow">if</span> (!fActivate) {
00339         <span class="keywordflow">if</span> (pClientImc != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00340             <a class="code" href="../../d4/d0/immcli_8h.html#a20">ClrICF</a>(pClientImc, IMCF_ACTIVE);
00341         <span class="keywordflow">goto</span> NotifySetActive;
00342     }
00343 
00344     <span class="keywordflow">if</span> (hImc == <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a>) {
00345         hSaveImc = <a class="code" href="../../d4/d0/immcli_8h.html#a72">ImmGetSaveContext</a>(hWnd, IGSC_DEFIMCFALLBACK);
00346         pInputContext = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a12">ImmLockIMC</a>(hSaveImc);
00347         <span class="keywordflow">if</span> (pInputContext != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00348             pInputContext-&gt;hWnd = <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>;
00349             <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a13">ImmUnlockIMC</a>(hSaveImc);
00350         }
00351         <span class="keywordflow">goto</span> NotifySetActive;
00352     }
00353 
00354     <span class="comment">/*</span>
00355 <span class="comment">     * Non-NULL input context, window handle have to be updated.</span>
00356 <span class="comment">     */</span>
00357     <span class="keywordflow">if</span> (pClientImc == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00358         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00359 
00360     pInputContext = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a12">ImmLockIMC</a>(hImc);
00361     <span class="keywordflow">if</span> (pInputContext == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00362         <a class="code" href="../../d9/d0/immuser_8h.html#a44">ImmUnlockClientImc</a>(pClientImc);
00363         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00364     }
00365 
00366     pInputContext-&gt;hWnd = <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>;
00367     <a class="code" href="../../d4/d0/immcli_8h.html#a19">SetICF</a>(pClientImc, IMCF_ACTIVE);
00368 
00369 <span class="preprocessor">#ifdef LATER</span>
00370 <span class="preprocessor"></span>    <span class="comment">// Do uNumLangVKey checking later</span>
00371 <span class="preprocessor">#endif</span>
00372 <span class="preprocessor"></span>
00373     <span class="keywordflow">if</span> (pInputContext-&gt;fdw31Compat &amp; F31COMPAT_MCWHIDDEN)
00374         dwISC = ISC_SHOWUIALL - ISC_SHOWUICOMPOSITIONWINDOW;
00375 
00376     dwOpenStatus = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)pInputContext-&gt;fOpen;
00377     dwConversion = pInputContext-&gt;fdwConversion;
00378     <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a13">ImmUnlockIMC</a>(hImc);
00379 
00380 NotifySetActive:
00381 
00382     pImeDpi = <a class="code" href="../../d9/d0/immuser_8h.html#a45">ImmLockImeDpi</a>(<a class="code" href="../../d3/d8/client_8c.html#a154">GetKeyboardLayout</a>(0));
00383     <span class="keywordflow">if</span> (pImeDpi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00384         (*pImeDpi-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o8">pfn</a>.<a class="code" href="../../d3/d7/structtagIMEDPI_1_1__tagImeFunctions.html#o24">ImeSetActiveContext</a>)(hImc, fActivate);
00385         <a class="code" href="../../d9/d0/immuser_8h.html#a46">ImmUnlockImeDpi</a>(pImeDpi);
00386     }
00387 
00388     <span class="comment">/*</span>
00389 <span class="comment">     * Notify UI</span>
00390 <span class="comment">     */</span>
00391     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d9/client_2wow_8c.html#a11">IsWindow</a>(hWnd)) {
00392         <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(hWnd, WM_IME_SETCONTEXT, fActivate, dwISC);
00393 
00394         <span class="comment">/*</span>
00395 <span class="comment">         * send notify to shell / keyboard driver</span>
00396 <span class="comment">         */</span>
00397         <span class="keywordflow">if</span> ( fActivate )
00398             <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a400">NtUserNotifyIMEStatus</a>( hWnd, dwOpenStatus, dwConversion );
00399     }
00400     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!fActivate) {
00401         <span class="comment">/*</span>
00402 <span class="comment">         * Because hWnd is not there (maybe destroyed), we send</span>
00403 <span class="comment">         * WM_IME_SETCONTEXT to the default IME window.</span>
00404 <span class="comment">         */</span>
00405         <span class="keywordflow">if</span> ((hDefImeWnd = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a4">ImmGetDefaultIMEWnd</a>(NULL)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00406             <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(hDefImeWnd, WM_IME_SETCONTEXT, fActivate, dwISC);
00407         }
00408         <span class="keywordflow">else</span> {
00409             RIPMSG0(RIP_WARNING,
00410                   <span class="stringliteral">"ImmSetActiveContext: can't send WM_IME_SETCONTEXT(FALSE)."</span>);
00411         }
00412     }
00413 <span class="preprocessor">#ifdef DEBUG</span>
00414 <span class="preprocessor"></span>    <span class="keywordflow">else</span> {
00415         RIPMSG0(RIP_WARNING,
00416               <span class="stringliteral">"ImmSetActiveContext: can't send WM_IME_SETCONTEXT(TRUE)."</span>);
00417     }
00418 <span class="preprocessor">#endif</span>
00419 <span class="preprocessor"></span>
00420 <span class="preprocessor">#ifdef LATER</span>
00421 <span class="preprocessor"></span>    <span class="comment">// Implements ProcessIMCEvent() later.</span>
00422 <span class="preprocessor">#endif</span>
00423 <span class="preprocessor"></span>
00424     <span class="keywordflow">if</span> (pClientImc != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00425         <a class="code" href="../../d9/d0/immuser_8h.html#a44">ImmUnlockClientImc</a>(pClientImc);
00426 
00427     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00428 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="w32/ntuser/imm/context.c::RestorePrivateMode" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL RestorePrivateMode           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PINPUTCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>pInputContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d2/d8/structtagIMEMODESAVER.html">PIMEMODESAVER</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pImeModeSaver</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HKL&nbsp;</td>
          <td class="mdname" nowrap> <em>hkl</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html#l00538">538</a> of file <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html">w32/ntuser/imm/context.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/immuser_8h-source.html#l00104">tagIMEPRIVATESAVER::fdwSentence</a>, <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html#l00492">GetImePrivateModeSaver()</a>, <a class="el" href="../../d5/d9/immcli_8h-source.html#l00059">ImmAssert</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html#l00837">SelectInputContext()</a>.
<p>
<pre class="fragment"><div>00542 {
00543     <a class="code" href="../../d3/d8/structtagIMEPRIVATESAVER.html">PIMEPRIVATEMODESAVER</a> pPrivateModeSaver = <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a11">GetImePrivateModeSaver</a>(pImeModeSaver, hkl);
00544 
00545     <span class="keywordflow">if</span> (pPrivateModeSaver == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00546         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00547     }
00548 
00549     <span class="comment">//</span>
00550     <span class="comment">// Restore private sentence mode</span>
00551     <span class="comment">//</span>
00552     <a class="code" href="../../d4/d0/immcli_8h.html#a2">ImmAssert</a>(LOWORD(pPrivateModeSaver-&gt;<a class="code" href="../../d3/d8/structtagIMEPRIVATESAVER.html#o2">fdwSentence</a>) == 0);
00553     pInputContext-&gt;fdwSentence |= pPrivateModeSaver-&gt;<a class="code" href="../../d3/d8/structtagIMEPRIVATESAVER.html#o2">fdwSentence</a>;
00554     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00555 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="w32/ntuser/imm/context.c::SavePrivateMode" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL SavePrivateMode           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PINPUTCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>pInputContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d2/d8/structtagIMEMODESAVER.html">PIMEMODESAVER</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pImeModeSaver</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HKL&nbsp;</td>
          <td class="mdname" nowrap> <em>hkl</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html#l00520">520</a> of file <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html">w32/ntuser/imm/context.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/immuser_8h-source.html#l00104">tagIMEPRIVATESAVER::fdwSentence</a>, <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html#l00492">GetImePrivateModeSaver()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html#l00837">SelectInputContext()</a>.
<p>
<pre class="fragment"><div>00524 {
00525     <a class="code" href="../../d3/d8/structtagIMEPRIVATESAVER.html">PIMEPRIVATEMODESAVER</a> pPrivateModeSaver = <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a11">GetImePrivateModeSaver</a>(pImeModeSaver, hkl);
00526 
00527     <span class="keywordflow">if</span> (pPrivateModeSaver == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00528         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00529     }
00530 
00531     <span class="comment">//</span>
00532     <span class="comment">// Save private sentence mode</span>
00533     <span class="comment">//</span>
00534     pPrivateModeSaver-&gt;<a class="code" href="../../d3/d8/structtagIMEPRIVATESAVER.html#o2">fdwSentence</a> = pInputContext-&gt;fdwSentence &amp; 0xffff0000;
00535     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00536 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="w32/ntuser/imm/context.c::SelectInputContext" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SelectInputContext           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">HKL&nbsp;</td>
          <td class="mdname" nowrap> <em>hSelKL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HKL&nbsp;</td>
          <td class="mdname" nowrap> <em>hUnSelKL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HIMC&nbsp;</td>
          <td class="mdname" nowrap> <em>hImc</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html#l00837">837</a> of file <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html">w32/ntuser/imm/context.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d5/d9/immcli_8h-source.html#l00164">ClrICF</a>, <a class="el" href="../../d0/d0/immuser_8h-source.html#l00029">tagCLIENTIMC::dwCodePage</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/immuser_8h-source.html#l00111">tagIMEMODESAVER::fdwConversion</a>, <a class="el" href="../../d0/d0/immuser_8h-source.html#l00113">tagIMEMODESAVER::fdwInit</a>, <a class="el" href="../../d0/d0/immuser_8h-source.html#l00112">tagIMEMODESAVER::fdwSentence</a>, <a class="el" href="../../d0/d0/immuser_8h-source.html#l00110">tagIMEMODESAVER::fOpen</a>, <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html#l00436">GetImeModeSaver()</a>, <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html#l00015">IMCC_ALLOC_TOOLARGE</a>, <a class="el" href="../../d9/d9/immstruc_8h-source.html#l00033">IMCF_UNICODE</a>, <a class="el" href="../../d5/d9/immcli_8h-source.html#l00182">IMECodePage</a>, <a class="el" href="../../d0/d0/immuser_8h-source.html#l00070">tagIMEDPI::ImeInfo</a>, <a class="el" href="../../d0/d0/immuser_8h-source.html#l00087">tagIMEDPI::_tagImeFunctions::ImeSelect</a>, <a class="el" href="../../d5/d9/immcli_8h-source.html#l00059">ImmAssert</a>, <a class="el" href="../../d6/d9/w32_2ntuser_2imm_2misc_8c-source.html#l00436">ImmCreateIMCC()</a>, <a class="el" href="../../d6/d9/w32_2ntuser_2imm_2misc_8c-source.html#l00454">ImmDestroyIMCC()</a>, <a class="el" href="../../d6/d9/w32_2ntuser_2imm_2misc_8c-source.html#l00505">ImmGetIMCCLockCount()</a>, <a class="el" href="../../d6/d9/w32_2ntuser_2imm_2misc_8c-source.html#l00540">ImmGetIMCCSize()</a>, <a class="el" href="../../d6/d9/w32_2ntuser_2imm_2misc_8c-source.html#l00689">ImmLockClientImc()</a>, <a class="el" href="../../d6/d9/w32_2ntuser_2imm_2misc_8c-source.html#l00471">ImmLockIMCC()</a>, <a class="el" href="../../d6/d9/w32_2ntuser_2imm_2misc_8c-source.html#l00793">ImmLockImeDpi()</a>, <a class="el" href="../../d6/d9/w32_2ntuser_2imm_2misc_8c-source.html#l00522">ImmReSizeIMCC()</a>, <a class="el" href="../../d6/d9/w32_2ntuser_2imm_2misc_8c-source.html#l00747">ImmUnlockClientImc()</a>, <a class="el" href="../../d6/d9/w32_2ntuser_2imm_2misc_8c-source.html#l00383">ImmUnlockIMC()</a>, <a class="el" href="../../d6/d9/w32_2ntuser_2imm_2misc_8c-source.html#l00488">ImmUnlockIMCC()</a>, <a class="el" href="../../d6/d9/w32_2ntuser_2imm_2misc_8c-source.html#l00824">ImmUnlockImeDpi()</a>, <a class="el" href="../../d6/d9/w32_2ntuser_2imm_2misc_8c-source.html#l00303">InternalImmLockIMC()</a>, <a class="el" href="../../d5/d0/ctxtinfo_8c-source.html#l03113">LFontAtoLFontW()</a>, <a class="el" href="../../d5/d0/ctxtinfo_8c-source.html#l03134">LFontWtoLFontA()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00332">max</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d7/structtagIMEDPI.html#o8">tagIMEDPI::pfn</a>, <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html#l00538">RestorePrivateMode()</a>, <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html#l00520">SavePrivateMode()</a>, <a class="el" href="../../d5/d9/immcli_8h-source.html#l00162">SetICF</a>, <a class="el" href="../../d5/d9/immcli_8h-source.html#l00166">TestICF</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d0/d5/ndismain_8h-source.html#l00026">UINT</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/immime_8c-source.html#l00031">SelectContextProc()</a>.
<p>
<pre class="fragment"><div>00841 {
00842     <a class="code" href="../../d2/d7/structtagIMEDPI.html">PIMEDPI</a>            pSelImeDpi, pUnSelImeDpi;
00843     <a class="code" href="../../d3/d0/structtagCLIENTIMC.html">PCLIENTIMC</a>         pClientImc;
00844     PINPUTCONTEXT      pInputContext;
00845     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>              dwSelPriv = 0, dwUnSelPriv = 0, dwSize;
00846     HIMCC              hImcc;
00847     PCOMPOSITIONSTRING pCompStr;
00848     PCANDIDATEINFO     pCandInfo;
00849     PGUIDELINE         pGuideLine;
00850     BOOLEAN            fLogFontInited;
00851 
00852     TAGMSG3(DBGTAG_IMM, <span class="stringliteral">"SelectInputContext: called for sel=%08p unsel=%08p hImc=%08p"</span>,
00853             hSelKL, hUnSelKL, hImc);
00854 
00855     pClientImc = <a class="code" href="../../d9/d0/immuser_8h.html#a43">ImmLockClientImc</a>(hImc);
00856     <span class="keywordflow">if</span> (pClientImc == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00857         RIPMSG0(RIP_VERBOSE, <span class="stringliteral">"SelectInputContext: cannot lock client Imc. Bailing out."</span>);
00858         <span class="keywordflow">return</span>;
00859     }
00860 
00861     pSelImeDpi   = <a class="code" href="../../d9/d0/immuser_8h.html#a45">ImmLockImeDpi</a>(hSelKL);
00862 
00863     <span class="keywordflow">if</span> (hSelKL != hUnSelKL) {
00864         <span class="comment">/*</span>
00865 <span class="comment">         * If those new sel and unsel do no match but</span>
00866 <span class="comment">         * somehow SelectInput is called, that means</span>
00867 <span class="comment">         * we should initialize the input contex again</span>
00868 <span class="comment">         * without dumping the old information.</span>
00869 <span class="comment">         */</span>
00870         pUnSelImeDpi = <a class="code" href="../../d9/d0/immuser_8h.html#a45">ImmLockImeDpi</a>(hUnSelKL);
00871     } <span class="keywordflow">else</span> {
00872         pUnSelImeDpi = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00873     }
00874 
00875     <span class="keywordflow">if</span> (pSelImeDpi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00876         <span class="comment">/*</span>
00877 <span class="comment">         * According to private memory size of the two layout, we decide</span>
00878 <span class="comment">         * whether we nee to reallocate this memory block</span>
00879 <span class="comment">         */</span>
00880         dwSelPriv = pSelImeDpi-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o3">ImeInfo</a>.dwPrivateDataSize;
00881 
00882         <span class="comment">/*</span>
00883 <span class="comment">         * Setup the code page of the newly selected IME.</span>
00884 <span class="comment">         */</span>
00885         pClientImc-&gt;<a class="code" href="../../d3/d0/structtagCLIENTIMC.html#o5">dwCodePage</a> = <a class="code" href="../../d4/d0/immcli_8h.html#a25">IMECodePage</a>(pSelImeDpi);
00886     }
00887     <span class="keywordflow">else</span> {
00888         pClientImc-&gt;<a class="code" href="../../d3/d0/structtagCLIENTIMC.html#o5">dwCodePage</a> = CP_ACP;
00889     }
00890 
00891     <span class="keywordflow">if</span> (pUnSelImeDpi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00892         dwUnSelPriv = pUnSelImeDpi-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o3">ImeInfo</a>.dwPrivateDataSize;
00893 
00894     dwSelPriv   = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(dwSelPriv,   <span class="keyword">sizeof</span>(UINT));
00895     dwUnSelPriv = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(dwUnSelPriv, <span class="keyword">sizeof</span>(UINT));
00896 
00897     <span class="comment">/*</span>
00898 <span class="comment">     * Unselect the input context.</span>
00899 <span class="comment">     */</span>
00900     <span class="keywordflow">if</span> (pUnSelImeDpi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00901         (*pUnSelImeDpi-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o8">pfn</a>.<a class="code" href="../../d3/d7/structtagIMEDPI_1_1__tagImeFunctions.html#o23">ImeSelect</a>)(hImc, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00902 
00903     <span class="comment">/*</span>
00904 <span class="comment">     * Reinitialize the client side input context for the selected layout.</span>
00905 <span class="comment">     */</span>
00906     <span class="keywordflow">if</span> ((pInputContext = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a11">InternalImmLockIMC</a>(hImc, FALSE)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00907         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> fdwOldConversion = pInputContext-&gt;fdwConversion;
00908         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> fdwOldSentence = pInputContext-&gt;fdwSentence;
00909         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fOldOpen = pInputContext-&gt;fOpen;
00910         <a class="code" href="../../d2/d8/structtagIMEMODESAVER.html">PIMEMODESAVER</a> pUnSelModeSaver, pSelModeSaver;
00911         <span class="keyword">const</span> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> fdwConvPreserve = IME_CMODE_EUDC;
00912 
00913         fLogFontInited = ((pInputContext-&gt;fdwInit &amp; INIT_LOGFONT) == INIT_LOGFONT);
00914 
00915         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/immcli_8h.html#a21">TestICF</a>(pClientImc, IMCF_UNICODE) &amp;&amp; pSelImeDpi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
00916                 !(pSelImeDpi-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o3">ImeInfo</a>.fdwProperty &amp; IME_PROP_UNICODE)) {
00917             <span class="comment">/*</span>
00918 <span class="comment">             * Check if there is any LOGFONT to be converted.</span>
00919 <span class="comment">             */</span>
00920             <span class="keywordflow">if</span> (fLogFontInited) {
00921                 LOGFONTA LogFontA;
00922 
00923                 <a class="code" href="../../d4/d0/immcli_8h.html#a84">LFontWtoLFontA</a>(&amp;pInputContext-&gt;lfFont.W, &amp;LogFontA);
00924                 RtlCopyMemory(&amp;pInputContext-&gt;lfFont.A, &amp;LogFontA, <span class="keyword">sizeof</span>(LOGFONTA));
00925             }
00926 
00927             <a class="code" href="../../d4/d0/immcli_8h.html#a20">ClrICF</a>(pClientImc, IMCF_UNICODE);
00928         }
00929         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d0/immcli_8h.html#a21">TestICF</a>(pClientImc, IMCF_UNICODE) &amp;&amp; pSelImeDpi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
00930                  (pSelImeDpi-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o3">ImeInfo</a>.fdwProperty &amp; IME_PROP_UNICODE)) {
00931             <span class="comment">/*</span>
00932 <span class="comment">             * Check if there is any LOGFONT to be converted.</span>
00933 <span class="comment">             */</span>
00934             <span class="keywordflow">if</span> (fLogFontInited) {
00935                 LOGFONTW LogFontW;
00936 
00937                 <a class="code" href="../../d4/d0/immcli_8h.html#a83">LFontAtoLFontW</a>(&amp;pInputContext-&gt;lfFont.A, &amp;LogFontW);
00938                 RtlCopyMemory(&amp;pInputContext-&gt;lfFont.W, &amp;LogFontW, <span class="keyword">sizeof</span>(LOGFONTW));
00939             }
00940 
00941             <a class="code" href="../../d4/d0/immcli_8h.html#a19">SetICF</a>(pClientImc, IMCF_UNICODE);
00942         }
00943 
00944         <span class="comment">/*</span>
00945 <span class="comment">         * hPrivate</span>
00946 <span class="comment">         */</span>
00947         <span class="keywordflow">if</span> (dwUnSelPriv != dwSelPriv) {
00948             hImcc = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a20">ImmReSizeIMCC</a>(pInputContext-&gt;hPrivate, dwSelPriv);
00949             <span class="keywordflow">if</span> (hImcc) {
00950                 pInputContext-&gt;hPrivate = hImcc;
00951             }
00952             <span class="keywordflow">else</span> {
00953                 RIPMSG1(RIP_WARNING,
00954                       <span class="stringliteral">"SelectContext: resize hPrivate %lX failure"</span>,
00955                       pInputContext-&gt;hPrivate);
00956                 <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a16">ImmDestroyIMCC</a>(pInputContext-&gt;hPrivate);
00957                 pInputContext-&gt;hPrivate = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a15">ImmCreateIMCC</a>(dwSelPriv);
00958             }
00959         }
00960 
00961         <span class="comment">/*</span>
00962 <span class="comment">         * hMsgBuf</span>
00963 <span class="comment">         */</span>
00964         dwSize = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a21">ImmGetIMCCSize</a>(pInputContext-&gt;hMsgBuf);
00965 
00966         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a19">ImmGetIMCCLockCount</a>(pInputContext-&gt;hMsgBuf) != 0 ||
00967                 dwSize &gt; <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a0">IMCC_ALLOC_TOOLARGE</a>) {
00968 
00969             RIPMSG0(RIP_WARNING, <span class="stringliteral">"SelectContext: create new hMsgBuf"</span>);
00970             <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a16">ImmDestroyIMCC</a>(pInputContext-&gt;hMsgBuf);
00971             pInputContext-&gt;hMsgBuf = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a15">ImmCreateIMCC</a>(<span class="keyword">sizeof</span>(UINT));
00972             pInputContext-&gt;dwNumMsgBuf = 0;
00973         }
00974 
00975         <span class="comment">/*</span>
00976 <span class="comment">         * hGuideLine</span>
00977 <span class="comment">         */</span>
00978         dwSize = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a21">ImmGetIMCCSize</a>(pInputContext-&gt;hGuideLine);
00979 
00980         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a19">ImmGetIMCCLockCount</a>(pInputContext-&gt;hGuideLine) != 0 ||
00981                 dwSize &lt; sizeof(GUIDELINE) || dwSize &gt; <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a0">IMCC_ALLOC_TOOLARGE</a>) {
00982 
00983             RIPMSG0(RIP_WARNING, <span class="stringliteral">"SelectContext: create new hGuideLine"</span>);
00984             <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a16">ImmDestroyIMCC</a>(pInputContext-&gt;hGuideLine);
00985             pInputContext-&gt;hGuideLine = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a15">ImmCreateIMCC</a>(<span class="keyword">sizeof</span>(GUIDELINE));
00986             pGuideLine = (PGUIDELINE)<a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a17">ImmLockIMCC</a>(pInputContext-&gt;hGuideLine);
00987 
00988             <span class="keywordflow">if</span> (pGuideLine != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00989                 pGuideLine-&gt;dwSize = <span class="keyword">sizeof</span>(GUIDELINE);
00990                 <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a18">ImmUnlockIMCC</a>(pInputContext-&gt;hGuideLine);
00991             }
00992         }
00993 
00994         <span class="comment">/*</span>
00995 <span class="comment">         * hCandInfo</span>
00996 <span class="comment">         */</span>
00997         dwSize = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a21">ImmGetIMCCSize</a>(pInputContext-&gt;hCandInfo);
00998 
00999         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a19">ImmGetIMCCLockCount</a>(pInputContext-&gt;hCandInfo) != 0 ||
01000                 dwSize &lt; sizeof(CANDIDATEINFO) || dwSize &gt; <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a0">IMCC_ALLOC_TOOLARGE</a>) {
01001 
01002             RIPMSG0(RIP_WARNING, <span class="stringliteral">"SelectContext: create new hCandInfo"</span>);
01003             <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a16">ImmDestroyIMCC</a>(pInputContext-&gt;hCandInfo);
01004             pInputContext-&gt;hCandInfo = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a15">ImmCreateIMCC</a>(<span class="keyword">sizeof</span>(CANDIDATEINFO));
01005             pCandInfo = (PCANDIDATEINFO)<a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a17">ImmLockIMCC</a>(pInputContext-&gt;hCandInfo);
01006 
01007             <span class="keywordflow">if</span> (pCandInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01008                 pCandInfo-&gt;dwSize = <span class="keyword">sizeof</span>(CANDIDATEINFO);
01009                 <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a18">ImmUnlockIMCC</a>(pInputContext-&gt;hCandInfo);
01010             }
01011         }
01012 
01013         <span class="comment">/*</span>
01014 <span class="comment">         * hCompStr</span>
01015 <span class="comment">         */</span>
01016         dwSize = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a21">ImmGetIMCCSize</a>(pInputContext-&gt;hCompStr);
01017 
01018         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a19">ImmGetIMCCLockCount</a>(pInputContext-&gt;hCompStr) != 0 ||
01019                 dwSize &lt; sizeof(COMPOSITIONSTRING) || dwSize &gt; <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a0">IMCC_ALLOC_TOOLARGE</a>) {
01020 
01021             RIPMSG0(RIP_WARNING, <span class="stringliteral">"SelectContext: create new hCompStr"</span>);
01022             <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a16">ImmDestroyIMCC</a>(pInputContext-&gt;hCompStr);
01023             pInputContext-&gt;hCompStr = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a15">ImmCreateIMCC</a>(<span class="keyword">sizeof</span>(COMPOSITIONSTRING));
01024             pCompStr = (PCOMPOSITIONSTRING)<a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a17">ImmLockIMCC</a>(pInputContext-&gt;hCompStr);
01025 
01026             <span class="keywordflow">if</span> (pCompStr != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01027                 pCompStr-&gt;dwSize = <span class="keyword">sizeof</span>(COMPOSITIONSTRING);
01028                 <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a18">ImmUnlockIMCC</a>(pInputContext-&gt;hCompStr);
01029             }
01030         }
01031 
01032         <span class="comment">//</span>
01033         <span class="comment">// Save and restore the IME modes when the primary</span>
01034         <span class="comment">// language changes.</span>
01035         <span class="comment">//</span>
01036 
01037         <span class="keywordflow">if</span> (pUnSelImeDpi) {
01038             <span class="comment">//</span>
01039             <span class="comment">// If UnSelKL is IME, get ModeSaver per language.</span>
01040             <span class="comment">//</span>
01041             pUnSelModeSaver = <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a9">GetImeModeSaver</a>(pInputContext, hUnSelKL);
01042             TAGMSG1(DBGTAG_IMM, <span class="stringliteral">"pUnSelModeSaver=%p"</span>, pUnSelModeSaver);
01043 
01044             <span class="comment">//</span>
01045             <span class="comment">// Firstly save the private sentence mode per IME.</span>
01046             <span class="comment">//</span>
01047             <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a12">SavePrivateMode</a>(pInputContext, pUnSelModeSaver, hUnSelKL);
01048         }
01049         <span class="keywordflow">else</span> {
01050             pUnSelModeSaver = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01051         }
01052 
01053         <span class="keywordflow">if</span> (pSelImeDpi) {
01054             <span class="comment">//</span>
01055             <span class="comment">// If SelKL is IME, get is ModeSaver per language.</span>
01056             <span class="comment">//</span>
01057             pSelModeSaver = <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a9">GetImeModeSaver</a>(pInputContext, hSelKL);
01058             TAGMSG1(DBGTAG_IMM, <span class="stringliteral">"pSelImeDpi. pImeModeSaver=%p"</span>, pSelModeSaver);
01059         }
01060         <span class="keywordflow">else</span> {
01061             pSelModeSaver = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01062         }
01063 
01064         <span class="comment">//</span>
01065         <span class="comment">// If the primary language of KL changes, save the current mode</span>
01066         <span class="comment">// and restore the previous modes of new language.</span>
01067         <span class="comment">//</span>
01068         <span class="keywordflow">if</span> (pUnSelModeSaver != pSelModeSaver) {
01069             <span class="comment">//</span>
01070             <span class="comment">// If old KL is IME, save the current conversion, sentence and open mode.</span>
01071             <span class="comment">//</span>
01072             <span class="keywordflow">if</span> (pUnSelModeSaver) {
01073                 pUnSelModeSaver-&gt;<a class="code" href="../../d2/d8/structtagIMEMODESAVER.html#o2">fOpen</a> = (pInputContext-&gt;fOpen != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01074 
01075                 <span class="comment">//</span>
01076                 <span class="comment">// Don't have to save the preserved bits for conversion mode.</span>
01077                 <span class="comment">//</span>
01078                 pUnSelModeSaver-&gt;<a class="code" href="../../d2/d8/structtagIMEMODESAVER.html#o3">fdwConversion</a> = pInputContext-&gt;fdwConversion &amp; ~fdwConvPreserve;
01079 
01080                 pUnSelModeSaver-&gt;<a class="code" href="../../d2/d8/structtagIMEMODESAVER.html#o4">fdwSentence</a> = LOWORD(pInputContext-&gt;fdwSentence);
01081                 pUnSelModeSaver-&gt;<a class="code" href="../../d2/d8/structtagIMEMODESAVER.html#o5">fdwInit</a> = pInputContext-&gt;fdwInit;
01082             }
01083 
01084             <span class="comment">//</span>
01085             <span class="comment">// If new KL is IME, restore the previous conversion, sentence and open mode.</span>
01086             <span class="comment">//</span>
01087             <span class="keywordflow">if</span> (pSelModeSaver) {
01088                 <span class="keywordflow">if</span> (pInputContext-&gt;fdwDirty &amp; IMSS_INIT_OPEN) {
01089                     <span class="comment">//</span>
01090                     <span class="comment">// HKL change may be kicked from private IME hotkey, and</span>
01091                     <span class="comment">// a user wants it opened when switched.</span>
01092                     <span class="comment">//</span>
01093                     pInputContext-&gt;fOpen = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01094                     pInputContext-&gt;fdwDirty &amp;= ~IMSS_INIT_OPEN;
01095                 } <span class="keywordflow">else</span> {
01096                     pInputContext-&gt;fOpen = pSelModeSaver-&gt;<a class="code" href="../../d2/d8/structtagIMEMODESAVER.html#o2">fOpen</a>;
01097                 }
01098 
01099                 <span class="comment">//</span>
01100                 <span class="comment">// Some bits are preserved across the languages.</span>
01101                 <span class="comment">//</span>
01102                 pInputContext-&gt;fdwConversion &amp;= fdwConvPreserve;
01103                 <a class="code" href="../../d4/d0/immcli_8h.html#a2">ImmAssert</a>((pSelModeSaver-&gt;<a class="code" href="../../d2/d8/structtagIMEMODESAVER.html#o3">fdwConversion</a> &amp; fdwConvPreserve) == 0);
01104                 pInputContext-&gt;fdwConversion |= pSelModeSaver-&gt;<a class="code" href="../../d2/d8/structtagIMEMODESAVER.html#o3">fdwConversion</a> &amp; ~fdwConvPreserve;
01105 
01106                 <a class="code" href="../../d4/d0/immcli_8h.html#a2">ImmAssert</a>(HIWORD(pSelModeSaver-&gt;<a class="code" href="../../d2/d8/structtagIMEMODESAVER.html#o4">fdwSentence</a>) == 0);
01107                 pInputContext-&gt;fdwSentence = pSelModeSaver-&gt;<a class="code" href="../../d2/d8/structtagIMEMODESAVER.html#o4">fdwSentence</a>;
01108                 pInputContext-&gt;fdwInit = pSelModeSaver-&gt;<a class="code" href="../../d2/d8/structtagIMEMODESAVER.html#o5">fdwInit</a>;
01109             }
01110         }
01111         <span class="keywordflow">if</span> (pSelModeSaver) {
01112             <span class="comment">//</span>
01113             <span class="comment">// Restore the private sentence mode per IME.</span>
01114             <span class="comment">//</span>
01115             <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a13">RestorePrivateMode</a>(pInputContext, pSelModeSaver, hSelKL);
01116         }
01117 
01118         <span class="comment">/*</span>
01119 <span class="comment">         * Select the input context.</span>
01120 <span class="comment">         */</span>
01121         <span class="keywordflow">if</span> (pSelImeDpi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01122             (*pSelImeDpi-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o8">pfn</a>.<a class="code" href="../../d3/d7/structtagIMEDPI_1_1__tagImeFunctions.html#o23">ImeSelect</a>)(hImc, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01123 
01124         <span class="comment">//</span>
01125         <span class="comment">// Set the dirty bits so that IMM can send notifications later.</span>
01126         <span class="comment">// See SendNotificatonProc.</span>
01127         <span class="comment">//</span>
01128         pInputContext-&gt;fdwDirty = 0;
01129         <span class="keywordflow">if</span> (pInputContext-&gt;fOpen != fOldOpen) {
01130             pInputContext-&gt;fdwDirty |= IMSS_UPDATE_OPEN;
01131         }
01132         <span class="keywordflow">if</span> (pInputContext-&gt;fdwConversion != fdwOldConversion) {
01133             pInputContext-&gt;fdwDirty |= IMSS_UPDATE_CONVERSION;
01134         }
01135         <span class="keywordflow">if</span> (pInputContext-&gt;fdwSentence != fdwOldSentence) {
01136             pInputContext-&gt;fdwDirty |= IMSS_UPDATE_SENTENCE;
01137         }
01138         TAGMSG4(DBGTAG_IMM, <span class="stringliteral">"fOpen:%d fdwConv:%08x fdwSent:%08x dirty:%02x"</span>,
01139                 pInputContext-&gt;fOpen, pInputContext-&gt;fdwConversion, pInputContext-&gt;fdwSentence, pInputContext-&gt;fdwDirty);
01140 
01141         <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a13">ImmUnlockIMC</a>(hImc);
01142     }
01143     <span class="keywordflow">else</span> {
01144         <span class="comment">//</span>
01145         <span class="comment">// To keep the backward compatibility,</span>
01146         <span class="comment">// select the input context here.</span>
01147         <span class="comment">//</span>
01148         <span class="keywordflow">if</span> (pSelImeDpi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01149             (*pSelImeDpi-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o8">pfn</a>.<a class="code" href="../../d3/d7/structtagIMEDPI_1_1__tagImeFunctions.html#o23">ImeSelect</a>)(hImc, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01150     }
01151 
01152     <a class="code" href="../../d9/d0/immuser_8h.html#a46">ImmUnlockImeDpi</a>(pUnSelImeDpi);
01153     <a class="code" href="../../d9/d0/immuser_8h.html#a46">ImmUnlockImeDpi</a>(pSelImeDpi);
01154     <a class="code" href="../../d9/d0/immuser_8h.html#a44">ImmUnlockClientImc</a>(pClientImc);
01155 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="w32/ntuser/imm/context.c::SendNotificationProc" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL SendNotificationProc           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">HIMC&nbsp;</td>
          <td class="mdname" nowrap> <em>hImc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPARAM&nbsp;</td>
          <td class="mdname" nowrap> <em>lParam</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html#l01157">1157</a> of file <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html">w32/ntuser/imm/context.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d6/d9/w32_2ntuser_2imm_2misc_8c-source.html#l00371">ImmLockIMC()</a>, <a class="el" href="../../d4/d8/client_2wow_8c-source.html#l00277">IsWindow()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l13072">NtUserNotifyIMEStatus()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d5/w32_2ntuser_2imm_2context_8c-source.html#l01191">ImmSendNotification()</a>.
<p>
<pre class="fragment"><div>01160 {
01161     PINPUTCONTEXT pInputContext = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a12">ImmLockIMC</a>(hImc);
01162 
01163     UNREFERENCED_PARAMETER(lParam);
01164 
01165     <span class="keywordflow">if</span> (pInputContext != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01166         HWND hwnd = pInputContext-&gt;hWnd;
01167 
01168         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d9/client_2wow_8c.html#a11">IsWindow</a>(hwnd)) {
01169             TAGMSG2(DBGTAG_IMM, <span class="stringliteral">"SendNotificationProc: updating hImc=%08x dirty=%04x"</span>,
01170                     hImc, pInputContext-&gt;fdwDirty);
01171 
01172             <span class="keywordflow">if</span> (pInputContext-&gt;fdwDirty &amp; IMSS_UPDATE_OPEN) {
01173                 SendMessageW(hwnd, WM_IME_NOTIFY, IMN_SETOPENSTATUS, 0);
01174             }
01175             <span class="keywordflow">if</span> (pInputContext-&gt;fdwDirty &amp; IMSS_UPDATE_CONVERSION) {
01176                 SendMessageW(hwnd, WM_IME_NOTIFY, IMN_SETCONVERSIONMODE, 0);
01177             }
01178             <span class="keywordflow">if</span> (pInputContext-&gt;fdwDirty &amp; (IMSS_UPDATE_OPEN | IMSS_UPDATE_CONVERSION)) {
01179                 <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a400">NtUserNotifyIMEStatus</a>(hwnd, pInputContext-&gt;fOpen, pInputContext-&gt;fdwConversion);
01180             }
01181             <span class="keywordflow">if</span> (pInputContext-&gt;fdwDirty &amp; IMSS_UPDATE_SENTENCE) {
01182                 SendMessageW(hwnd, WM_IME_NOTIFY, IMN_SETSENTENCEMODE, 0);
01183             }
01184         }
01185         pInputContext-&gt;fdwDirty = 0;
01186     }
01187 
01188     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01189 }
</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:16 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
