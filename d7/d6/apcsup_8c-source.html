<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: apcsup.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>apcsup.c</h1><a href="../../d6/d7/apcsup_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    apcsup.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains the support routines for the APC object. Functions</span>
00012 <span class="comment">    are provided to insert in an APC queue and to deliver user and kernel</span>
00013 <span class="comment">    mode APC's.</span>
00014 <span class="comment"></span>
00015 <span class="comment">Author:</span>
00016 <span class="comment"></span>
00017 <span class="comment">    David N. Cutler (davec) 14-Mar-1989</span>
00018 <span class="comment"></span>
00019 <span class="comment">Environment:</span>
00020 <span class="comment"></span>
00021 <span class="comment">    Kernel mode only.</span>
00022 <span class="comment"></span>
00023 <span class="comment">Revision History:</span>
00024 <span class="comment"></span>
00025 <span class="comment">--*/</span>
00026 
00027 <span class="preprocessor">#include "<a class="code" href="../../d0/d0/ki_8h.html">ki.h</a>"</span>
00028 
00029 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00030"></a><a class="code" href="../../d0/d0/ki_8h.html#a105">00030</a> <a class="code" href="../../d0/d0/ki_8h.html#a105">KiDeliverApc</a> (
00031     IN KPROCESSOR_MODE PreviousMode,
00032     IN PKEXCEPTION_FRAME ExceptionFrame,
00033     IN PKTRAP_FRAME TrapFrame
00034     )
00035 
00036 <span class="comment">/*++</span>
00037 <span class="comment"></span>
00038 <span class="comment">Routine Description:</span>
00039 <span class="comment"></span>
00040 <span class="comment">    This function is called from the APC interrupt code and when one or</span>
00041 <span class="comment">    more of the APC pending flags are set at system exit and the previous</span>
00042 <span class="comment">    IRQL is zero. All special kernel APC's are delivered first, followed</span>
00043 <span class="comment">    by normal kernel APC's if one is not already in progress, and finally</span>
00044 <span class="comment">    if the user APC queue is not empty, the user APC pending flag is set,</span>
00045 <span class="comment">    and the previous mode is user, then a user APC is delivered. On entry</span>
00046 <span class="comment">    to this routine IRQL is set to APC_LEVEL.</span>
00047 <span class="comment"></span>
00048 <span class="comment">    N.B. The exception frame and trap frame addresses are only guaranteed</span>
00049 <span class="comment">         to be valid if, and only if, the previous mode is user.</span>
00050 <span class="comment"></span>
00051 <span class="comment">Arguments:</span>
00052 <span class="comment"></span>
00053 <span class="comment">    PreviousMode - Supplies the previous processor mode.</span>
00054 <span class="comment"></span>
00055 <span class="comment">    ExceptionFrame - Supplies a pointer to an exception frame.</span>
00056 <span class="comment"></span>
00057 <span class="comment">    TrapFrame - Supplies a pointer to a trap frame.</span>
00058 <span class="comment"></span>
00059 <span class="comment">Return Value:</span>
00060 <span class="comment"></span>
00061 <span class="comment">    None.</span>
00062 <span class="comment"></span>
00063 <span class="comment">--*/</span>
00064 
00065 {
00066 
00067     <a class="code" href="../../d1/d5/struct__KAPC.html">PKAPC</a> Apc;
00068     <a class="code" href="../../d0/d9/ntosdef_8h.html#a42">PKKERNEL_ROUTINE</a> KernelRoutine;
00069     PLIST_ENTRY NextEntry;
00070     PVOID NormalContext;
00071     <a class="code" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a> NormalRoutine;
00072     KIRQL OldIrql;
00073     PVOID SystemArgument1;
00074     PVOID SystemArgument2;
00075     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread;
00076 
00077     <span class="comment">//</span>
00078     <span class="comment">// Raise IRQL to dispatcher level and lock the APC queue.</span>
00079     <span class="comment">//</span>
00080 
00081     Thread = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
00082     <a class="code" href="../../d0/d0/ki_8h.html#a9">KiLockApcQueue</a>(Thread, &amp;OldIrql);
00083 
00084     <span class="comment">//</span>
00085     <span class="comment">// Get address of current thread object, clear kernel APC pending, and</span>
00086     <span class="comment">// check if any kernel mode APC's can be delivered.</span>
00087     <span class="comment">//</span>
00088 
00089     Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o3">KernelApcPending</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00090     <span class="keywordflow">while</span> (IsListEmpty(&amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o0">ApcListHead</a>[<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>]) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00091         NextEntry = Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o0">ApcListHead</a>[<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>].Flink;
00092         Apc = CONTAINING_RECORD(NextEntry, <a class="code" href="../../d1/d5/struct__KAPC.html">KAPC</a>, ApcListEntry);
00093         KernelRoutine = Apc-&gt;<a class="code" href="../../d1/d5/struct__KAPC.html#o5">KernelRoutine</a>;
00094         NormalRoutine = Apc-&gt;<a class="code" href="../../d1/d5/struct__KAPC.html#o7">NormalRoutine</a>;
00095         NormalContext = Apc-&gt;<a class="code" href="../../d1/d5/struct__KAPC.html#o8">NormalContext</a>;
00096         SystemArgument1 = Apc-&gt;<a class="code" href="../../d1/d5/struct__KAPC.html#o9">SystemArgument1</a>;
00097         SystemArgument2 = Apc-&gt;<a class="code" href="../../d1/d5/struct__KAPC.html#o10">SystemArgument2</a>;
00098         <span class="keywordflow">if</span> (NormalRoutine == (<a class="code" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00099 
00100             <span class="comment">//</span>
00101             <span class="comment">// First entry in the kernel APC queue is a special kernel APC.</span>
00102             <span class="comment">// Remove the entry from the APC queue, set its inserted state</span>
00103             <span class="comment">// to FALSE, release dispatcher database lock, and call the kernel</span>
00104             <span class="comment">// routine. On return raise IRQL to dispatcher level and lock</span>
00105             <span class="comment">// dispatcher database lock.</span>
00106             <span class="comment">//</span>
00107 
00108             RemoveEntryList(NextEntry);
00109             Apc-&gt;<a class="code" href="../../d1/d5/struct__KAPC.html#o13">Inserted</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00110             <a class="code" href="../../d0/d0/ki_8h.html#a10">KiUnlockApcQueue</a>(Thread, OldIrql);
00111             (KernelRoutine)(Apc, &amp;NormalRoutine, &amp;NormalContext,
00112                             &amp;SystemArgument1, &amp;SystemArgument2);
00113 
00114 <span class="preprocessor">#if DBG</span>
00115 <span class="preprocessor"></span>
00116                 <span class="keywordflow">if</span> (KeGetCurrentIrql() != OldIrql) {
00117                     <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(IRQL_UNEXPECTED_VALUE,
00118                                  KeGetCurrentIrql() &lt;&lt; 16 | OldIrql &lt;&lt; 8,
00119                                  (ULONG_PTR)KernelRoutine,
00120                                  (ULONG_PTR)Apc,
00121                                  (ULONG_PTR)NormalRoutine);
00122                 }
00123 
00124 <span class="preprocessor">#endif</span>
00125 <span class="preprocessor"></span>
00126             <a class="code" href="../../d0/d0/ki_8h.html#a9">KiLockApcQueue</a>(Thread, &amp;OldIrql);
00127 
00128         } <span class="keywordflow">else</span> {
00129 
00130             <span class="comment">//</span>
00131             <span class="comment">// First entry in the kernel APC queue is a normal kernel APC.</span>
00132             <span class="comment">// If there is not a normal kernel APC in progress and kernel</span>
00133             <span class="comment">// APC's are not disabled, then remove the entry from the APC</span>
00134             <span class="comment">// queue, set its inserted state to FALSE, release the APC queue</span>
00135             <span class="comment">// lock, call the specified kernel routine, set kernel APC in</span>
00136             <span class="comment">// progress, lower the IRQL to zero, and call the normal kernel</span>
00137             <span class="comment">// APC routine. On return raise IRQL to dispatcher level, lock</span>
00138             <span class="comment">// the APC queue, and clear kernel APC in progress.</span>
00139             <span class="comment">//</span>
00140 
00141             <span class="keywordflow">if</span> ((Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o2">KernelApcInProgress</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp;
00142                (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o30">KernelApcDisable</a> == 0)) {
00143                 RemoveEntryList(NextEntry);
00144                 Apc-&gt;<a class="code" href="../../d1/d5/struct__KAPC.html#o13">Inserted</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00145                 <a class="code" href="../../d0/d0/ki_8h.html#a10">KiUnlockApcQueue</a>(Thread, OldIrql);
00146                 (KernelRoutine)(Apc, &amp;NormalRoutine, &amp;NormalContext,
00147                                 &amp;SystemArgument1, &amp;SystemArgument2);
00148 
00149 <span class="preprocessor">#if DBG</span>
00150 <span class="preprocessor"></span>
00151                 <span class="keywordflow">if</span> (KeGetCurrentIrql() != OldIrql) {
00152                     <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(IRQL_UNEXPECTED_VALUE,
00153                                  KeGetCurrentIrql() &lt;&lt; 16 | OldIrql &lt;&lt; 8 | 1,
00154                                  (ULONG_PTR)KernelRoutine,
00155                                  (ULONG_PTR)Apc,
00156                                  (ULONG_PTR)NormalRoutine);
00157                 }
00158 
00159 <span class="preprocessor">#endif</span>
00160 <span class="preprocessor"></span>
00161                 <span class="keywordflow">if</span> (NormalRoutine != (<a class="code" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00162                     Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o2">KernelApcInProgress</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00163                     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(0);
00164                     (NormalRoutine)(NormalContext, SystemArgument1,
00165                                     SystemArgument2);
00166                     <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>, &amp;OldIrql);
00167                 }
00168 
00169                 <a class="code" href="../../d0/d0/ki_8h.html#a9">KiLockApcQueue</a>(Thread, &amp;OldIrql);
00170                 Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o2">KernelApcInProgress</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00171 
00172             } <span class="keywordflow">else</span> {
00173                 <a class="code" href="../../d0/d0/ki_8h.html#a10">KiUnlockApcQueue</a>(Thread, OldIrql);
00174                 <span class="keywordflow">return</span>;
00175             }
00176         }
00177     }
00178 
00179     <span class="comment">//</span>
00180     <span class="comment">// Kernel APC queue is empty. If the previous mode is user, user APC</span>
00181     <span class="comment">// pending is set, and the user APC queue is not empty, then remove</span>
00182     <span class="comment">// the first entry from the user APC queue, set its inserted state to</span>
00183     <span class="comment">// FALSE, clear user APC pending, release the dispatcher database lock,</span>
00184     <span class="comment">// and call the specified kernel routine. If the normal routine address</span>
00185     <span class="comment">// is not NULL on return from the kernel routine, then initialize the</span>
00186     <span class="comment">// user mode APC context and return. Otherwise, check to determine if</span>
00187     <span class="comment">// another user mode APC can be processed.</span>
00188     <span class="comment">//</span>
00189 
00190     <span class="keywordflow">if</span> ((IsListEmpty(&amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o0">ApcListHead</a>[<a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>]) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp;
00191        (PreviousMode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) &amp;&amp; (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o4">UserApcPending</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
00192         Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o4">UserApcPending</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00193         NextEntry = Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o0">ApcListHead</a>[<a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>].Flink;
00194         Apc = CONTAINING_RECORD(NextEntry, <a class="code" href="../../d1/d5/struct__KAPC.html">KAPC</a>, ApcListEntry);
00195         KernelRoutine = Apc-&gt;<a class="code" href="../../d1/d5/struct__KAPC.html#o5">KernelRoutine</a>;
00196         NormalRoutine = Apc-&gt;<a class="code" href="../../d1/d5/struct__KAPC.html#o7">NormalRoutine</a>;
00197         NormalContext = Apc-&gt;<a class="code" href="../../d1/d5/struct__KAPC.html#o8">NormalContext</a>;
00198         SystemArgument1 = Apc-&gt;<a class="code" href="../../d1/d5/struct__KAPC.html#o9">SystemArgument1</a>;
00199         SystemArgument2 = Apc-&gt;<a class="code" href="../../d1/d5/struct__KAPC.html#o10">SystemArgument2</a>;
00200         RemoveEntryList(NextEntry);
00201         Apc-&gt;<a class="code" href="../../d1/d5/struct__KAPC.html#o13">Inserted</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00202         <a class="code" href="../../d0/d0/ki_8h.html#a10">KiUnlockApcQueue</a>(Thread, OldIrql);
00203         (KernelRoutine)(Apc, &amp;NormalRoutine, &amp;NormalContext,
00204                         &amp;SystemArgument1, &amp;SystemArgument2);
00205 
00206         <span class="keywordflow">if</span> (NormalRoutine == (<a class="code" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00207             <a class="code" href="../../d9/d1/thredobj_8c.html#a27">KeTestAlertThread</a>(<a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>);
00208 
00209         } <span class="keywordflow">else</span> {
00210             <a class="code" href="../../d1/d8/ppc_2apcuser_8c.html#a1">KiInitializeUserApc</a>(ExceptionFrame, TrapFrame, NormalRoutine,
00211                                 NormalContext, SystemArgument1, SystemArgument2);
00212         }
00213 
00214     } <span class="keywordflow">else</span> {
00215         <a class="code" href="../../d0/d0/ki_8h.html#a10">KiUnlockApcQueue</a>(Thread, OldIrql);
00216     }
00217 
00218     <span class="keywordflow">return</span>;
00219 }
00220 
00221 BOOLEAN
00222 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l00223"></a><a class="code" href="../../d0/d0/ki_8h.html#a123">00223</a> <a class="code" href="../../d0/d0/ki_8h.html#a123">KiInsertQueueApc</a> (
00224     IN <a class="code" href="../../d1/d5/struct__KAPC.html">PKAPC</a> Apc,
00225     IN KPRIORITY Increment
00226     )
00227 
00228 <span class="comment">/*++</span>
00229 <span class="comment"></span>
00230 <span class="comment">Routine Description:</span>
00231 <span class="comment"></span>
00232 <span class="comment">    This function inserts an APC object into a thread's APC queue. The address</span>
00233 <span class="comment">    of the thread object, the APC queue, and the type of APC are all derived</span>
00234 <span class="comment">    from the APC object. If the APC object is already in an APC queue, then</span>
00235 <span class="comment">    no opertion is performed and a function value of FALSE is returned. Else</span>
00236 <span class="comment">    the APC is inserted in the specified APC queue, its inserted state is set</span>
00237 <span class="comment">    to TRUE, and a function value of TRUE is returned. The APC will actually</span>
00238 <span class="comment">    be delivered when proper enabling conditions exist.</span>
00239 <span class="comment"></span>
00240 <span class="comment">Arguments:</span>
00241 <span class="comment"></span>
00242 <span class="comment">    Apc - Supplies a pointer to a control object of type APC.</span>
00243 <span class="comment"></span>
00244 <span class="comment">    Increment - Supplies the priority increment that is to be applied if</span>
00245 <span class="comment">        queuing the APC causes a thread wait to be satisfied.</span>
00246 <span class="comment"></span>
00247 <span class="comment">Return Value:</span>
00248 <span class="comment"></span>
00249 <span class="comment">    If the APC object is already in an APC queue, then a value of FALSE is</span>
00250 <span class="comment">    returned. Else a value of TRUE is returned.</span>
00251 <span class="comment"></span>
00252 <span class="comment">--*/</span>
00253 
00254 {
00255 
00256     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> ApcMode;
00257     <a class="code" href="../../d1/d5/struct__KAPC.html">PKAPC</a> ApcEntry;
00258     <a class="code" href="../../d3/d5/struct__KAPC__STATE.html">PKAPC_STATE</a> ApcState;
00259     BOOLEAN Inserted;
00260     PLIST_ENTRY ListEntry;
00261     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread;
00262 
00263     <span class="comment">//</span>
00264     <span class="comment">// If the APC object is already in an APC queue, then set inserted to</span>
00265     <span class="comment">// FALSE. Else insert the APC object in the proper queue, set the APC</span>
00266     <span class="comment">// inserted state to TRUE, check to determine if the APC should be delivered</span>
00267     <span class="comment">// immediately, and set inserted to TRUE.</span>
00268     <span class="comment">//</span>
00269     <span class="comment">// For multiprocessor performance, the following code utilizes the fact</span>
00270     <span class="comment">// that kernel APC disable count is incremented before checking whether</span>
00271     <span class="comment">// the kernel APC queue is nonempty.</span>
00272     <span class="comment">//</span>
00273     <span class="comment">// See KeLeaveCriticalRegion().</span>
00274     <span class="comment">//</span>
00275 
00276     Thread = Apc-&gt;Thread;
00277     KiAcquireSpinLock(&amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o38">ApcQueueLock</a>);
00278     <span class="keywordflow">if</span> (Apc-&gt;Inserted) {
00279         Inserted = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00280 
00281     } <span class="keywordflow">else</span> {
00282         ApcState = Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o49">ApcStatePointer</a>[Apc-&gt;ApcStateIndex];
00283 
00284         <span class="comment">//</span>
00285         <span class="comment">// Insert the APC after all other special APC entries selected by</span>
00286         <span class="comment">// the processor mode if the normal routine value is null. Else</span>
00287         <span class="comment">// insert the APC object at the tail of the APC queue selected by</span>
00288         <span class="comment">// the processor mode unless the APC mode is user and the address</span>
00289         <span class="comment">// of the special APC routine is exit thread, in which case insert</span>
00290         <span class="comment">// the APC at the front of the list and set user APC pending.</span>
00291         <span class="comment">//</span>
00292 
00293         ApcMode = Apc-&gt;ApcMode;
00294         <span class="keywordflow">if</span> (Apc-&gt;NormalRoutine != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00295             <span class="keywordflow">if</span> ((ApcMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) &amp;&amp; (Apc-&gt;KernelRoutine == <a class="code" href="../../d1/d9/ps_8h.html#a117">PsExitSpecialApc</a>)) {
00296                 Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o4">UserApcPending</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00297                 InsertHeadList(&amp;ApcState-&gt;<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o0">ApcListHead</a>[ApcMode],
00298                                &amp;Apc-&gt;ApcListEntry);
00299 
00300             } <span class="keywordflow">else</span> {
00301                 InsertTailList(&amp;ApcState-&gt;<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o0">ApcListHead</a>[ApcMode],
00302                                &amp;Apc-&gt;ApcListEntry);
00303             }
00304 
00305         } <span class="keywordflow">else</span> {
00306             ListEntry = ApcState-&gt;<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o0">ApcListHead</a>[ApcMode].Flink;
00307             <span class="keywordflow">while</span> (ListEntry != &amp;ApcState-&gt;<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o0">ApcListHead</a>[ApcMode]) {
00308                 ApcEntry = CONTAINING_RECORD(ListEntry, <a class="code" href="../../d1/d5/struct__KAPC.html">KAPC</a>, ApcListEntry);
00309                 <span class="keywordflow">if</span> (ApcEntry-&gt;<a class="code" href="../../d1/d5/struct__KAPC.html#o7">NormalRoutine</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00310                     <span class="keywordflow">break</span>;
00311                 }
00312 
00313                 ListEntry = ListEntry-&gt;Flink;
00314             }
00315 
00316             ListEntry = ListEntry-&gt;Blink;
00317             InsertHeadList(ListEntry, &amp;Apc-&gt;ApcListEntry);
00318         }
00319 
00320         Apc-&gt;Inserted = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00321 
00322         <span class="comment">//</span>
00323         <span class="comment">// If the APC index from the APC object matches the APC Index of</span>
00324         <span class="comment">// the thread, then check to determine if the APC should interrupt</span>
00325         <span class="comment">// thread execution or sequence the thread out of a wait state.</span>
00326         <span class="comment">//</span>
00327 
00328         <span class="keywordflow">if</span> (Apc-&gt;ApcStateIndex == Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o58">ApcStateIndex</a>) {
00329 
00330             <span class="comment">//</span>
00331             <span class="comment">// If the processor mode of the APC is kernel, then check if</span>
00332             <span class="comment">// the APC should either interrupt the thread or sequence the</span>
00333             <span class="comment">// thread out of a Waiting state. Else check if the APC should</span>
00334             <span class="comment">// sequence the thread out of an alertable Waiting state.</span>
00335             <span class="comment">//</span>
00336 
00337             <span class="keywordflow">if</span> (ApcMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00338                 Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o3">KernelApcPending</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00339                 <span class="keywordflow">if</span> (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o8">State</a> == <a class="code" href="../../d4/d9/ke_8h.html#a406a193">Running</a>) {
00340                     <a class="code" href="../../d0/d0/ki_8h.html#a23">KiRequestApcInterrupt</a>(Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o45">NextProcessor</a>);
00341 
00342                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o8">State</a> == <a class="code" href="../../d4/d9/ke_8h.html#a406a196">Waiting</a>) &amp;&amp;
00343                           (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o17">WaitIrql</a> == 0) &amp;&amp;
00344                           ((Apc-&gt;NormalRoutine == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
00345                           ((Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o30">KernelApcDisable</a> == 0) &amp;&amp;
00346                           (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o2">KernelApcInProgress</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)))) {
00347                     <a class="code" href="../../d2/d7/waitsup_8c.html#a0">KiUnwaitThread</a>(Thread, STATUS_KERNEL_APC, <a class="code" href="../../d6/d4/rtl_2random_8c.html#a1">Increment</a>);
00348                 }
00349 
00350             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o8">State</a> == <a class="code" href="../../d4/d9/ke_8h.html#a406a196">Waiting</a>) &amp;&amp;
00351                       (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o18">WaitMode</a> == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) &amp;&amp;
00352                       (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o57">Alertable</a>)) {
00353                 Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o4">UserApcPending</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00354                 <a class="code" href="../../d2/d7/waitsup_8c.html#a0">KiUnwaitThread</a>(Thread, STATUS_USER_APC, <a class="code" href="../../d6/d4/rtl_2random_8c.html#a1">Increment</a>);
00355             }
00356         }
00357 
00358         Inserted = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00359     }
00360 
00361     <span class="comment">//</span>
00362     <span class="comment">// Unlock the APC queue lock, and return whether the APC object was</span>
00363     <span class="comment">// inserted in an APC queue.</span>
00364     <span class="comment">//</span>
00365 
00366     KiReleaseSpinLock(&amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o38">ApcQueueLock</a>);
00367     <span class="keywordflow">return</span> Inserted;
00368 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:15 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
