<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: stktrace.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>stktrace.c File Reference</h1><code>#include &lt;<a class="el" href="../../d0/d8/ntos_8h-source.html">ntos.h</a>&gt;</code><br>
<code>#include &lt;ntrtl.h&gt;</code><br>
<code>#include &lt;nturtl.h&gt;</code><br>
<code>#include &lt;zwapi.h&gt;</code><br>
<code>#include &lt;<a class="el" href="../../d9/d5/stktrace_8h-source.html">stktrace.h</a>&gt;</code><br>
<code>#include &lt;<a class="el" href="../../d4/d8/heap_8h-source.html">heap.h</a>&gt;</code><br>
<code>#include &lt;<a class="el" href="../../d0/d9/heappriv_8h-source.html">heappriv.h</a>&gt;</code><br>

<p>
<a href="../../d8/d5/stktrace_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/stktrace_8c.html#a0">_KERNEL_MODE_STACK_TRACES_</a>&nbsp;&nbsp;&nbsp;0</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/stktrace_8c.html#a1">_COLLECT_FRAME_WALK_STATISTICS_</a>&nbsp;&nbsp;&nbsp;0</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/stktrace_8c.html#a2">SIZE_1_KB</a>&nbsp;&nbsp;&nbsp;((ULONG_PTR) 0x400)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/stktrace_8c.html#a3">SIZE_1_GB</a>&nbsp;&nbsp;&nbsp;((ULONG_PTR) 0x40000000)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/stktrace_8c.html#a4">PAGE_START</a>(address)&nbsp;&nbsp;&nbsp;(((ULONG_PTR)address) &amp; ~((ULONG_PTR)PAGE_SIZE - 1))</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/stktrace_8c.html#a5">NtdllOkayToLockRoutine</a> (IN PVOID Lock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/stktrace_8c.html#a6">CollectFrameWalkStatistics</a> (ULONG <a class="el" href="../../d7/d0/cmdat2_8c.html#a27">Index</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d6/stktrace_8c.html#a7">RtlWalkFrameChain</a> (OUT PVOID *Callers, IN ULONG <a class="el" href="../../d6/d0/cmdat_8c.html#a5">Count</a>, IN ULONG Flags)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a1" doxytag="stktrace.c::_COLLECT_FRAME_WALK_STATISTICS_" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define _COLLECT_FRAME_WALK_STATISTICS_&nbsp;&nbsp;&nbsp;0          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d5/stktrace_8c-source.html#l00726">726</a> of file <a class="el" href="../../d8/d5/stktrace_8c-source.html">stktrace.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="stktrace.c::_KERNEL_MODE_STACK_TRACES_" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define _KERNEL_MODE_STACK_TRACES_&nbsp;&nbsp;&nbsp;0          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d5/stktrace_8c-source.html#l00725">725</a> of file <a class="el" href="../../d8/d5/stktrace_8c-source.html">stktrace.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="stktrace.c::PAGE_START" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PAGE_START          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">address&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;(((ULONG_PTR)address) &amp; ~((ULONG_PTR)PAGE_SIZE - 1))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d5/stktrace_8c-source.html#l00732">732</a> of file <a class="el" href="../../d8/d5/stktrace_8c-source.html">stktrace.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d5/stktrace_8c-source.html#l00741">RtlWalkFrameChain()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="stktrace.c::SIZE_1_GB" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SIZE_1_GB&nbsp;&nbsp;&nbsp;((ULONG_PTR) 0x40000000)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d5/stktrace_8c-source.html#l00730">730</a> of file <a class="el" href="../../d8/d5/stktrace_8c-source.html">stktrace.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="stktrace.c::SIZE_1_KB" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SIZE_1_KB&nbsp;&nbsp;&nbsp;((ULONG_PTR) 0x400)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d5/stktrace_8c-source.html#l00729">729</a> of file <a class="el" href="../../d8/d5/stktrace_8c-source.html">stktrace.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d5/stktrace_8c-source.html#l00741">RtlWalkFrameChain()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a6" doxytag="stktrace.c::CollectFrameWalkStatistics" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CollectFrameWalkStatistics           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">ULONG&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Index</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d8/d5/stktrace_8c-source.html#l00741">RtlWalkFrameChain()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="stktrace.c::NtdllOkayToLockRoutine" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN NtdllOkayToLockRoutine           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Lock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00236">236</a> of file <a class="el" href="../../d8/d7/dll_2resource_8c-source.html">dll/resource.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>00239 {
00240     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00241 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="stktrace.c::RtlWalkFrameChain" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG RtlWalkFrameChain           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>Callers</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Count</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d5/stktrace_8c-source.html#l00741">741</a> of file <a class="el" href="../../d8/d5/stktrace_8c-source.html">stktrace.c</a>.
<p>
References <a class="el" href="../../d7/d6/stktrace_8c.html#a6">CollectFrameWalkStatistics()</a>, <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00051">Count</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00070">KeGetCurrentThread</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03883">MmIsAddressValid()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d8/d5/stktrace_8c-source.html#l00732">PAGE_START</a>, and <a class="el" href="../../d8/d5/stktrace_8c-source.html#l00729">SIZE_1_KB</a>.
<p>
<pre class="fragment"><div>00749                    :
00750 
00751     <a class="code" href="../../d7/d6/stktrace_8c.html#a7">RtlWalkFrameChain</a>
00752 
00753 <a class="code" href="../../d4/d9/heapdbg_8c.html#a4">Description</a>:
00754 
00755     This function tries to walk <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> EBP chain and fill <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> a vector of
00756     <span class="keywordflow">return</span> addresses. The function works <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> on x86. It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> possible that
00757     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function cannot fill <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested number of callers because somewhere
00758     on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> stack we have a function compiled FPO (the frame <span class="keyword">register</span> (EBP) is
00759     used as a normal <span class="keyword">register</span>. In <span class="keyword">this</span> <span class="keywordflow">case</span> the function will just <span class="keywordflow">return</span> with
00760     a less then requested count. In kernel mode the function should not take
00761     any exceptions (page faults) because it can be called at all sorts of
00762     irql levels.
00763 
00764     The `Flags' parameter is used <span class="keywordflow">for</span> future extensions. A zero value will be
00765     compatible with <span class="keyword">new</span> stack walking algorithms.
00766 
00767     Note. The algorithm can be somewhat improved by unassembling the <span class="keywordflow">return</span>
00768     addresses identified. However <span class="keyword">this</span> is impractical in kernel mode because
00769     the function might get called at high irql levels where page faults are
00770     not allowed.
00771 
00772 Return value:
00773 
00774     The number of identified <span class="keywordflow">return</span> addresses on the stack. This can be less
00775     then the Count requested <span class="keywordflow">if</span> the stack ends or we encounter a FPO compiled
00776     function.
00777 
00778 --*/
00779 
00780 {
00781 #<span class="keywordflow">if</span> defined(_X86_)
00782 
00783     ULONG_PTR Fp, NewFp, ReturnAddress;
00784     ULONG Index;
00785     ULONG_PTR StackEnd, StackStart;
00786     BOOLEAN Result;
00787 
00788     <span class="comment">//</span>
00789     <span class="comment">// Get the current EBP pointer which is supposed to</span>
00790     <span class="comment">// be the start of the EBP chain.</span>
00791     <span class="comment">//</span>
00792 
00793     _asm mov Fp, EBP;
00794 
00795     StackStart = Fp;
00796 
00797 #<span class="keywordflow">if</span> _KERNEL_MODE_STACK_TRACES_
00798 
00799     StackEnd = (ULONG_PTR)(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;StackBase);
00800 
00801     <span class="comment">//</span>
00802     <span class="comment">// bugbug: find a reliable way to get the stack limit in kernel mode.</span>
00803     <span class="comment">// `StackBase' is not a reliable way to get the stack end in kernel</span>
00804     <span class="comment">// mode because we might execute a DPC routine on thread's behalf.</span>
00805     <span class="comment">// There are a few other reasons why we cannot trust this completely.</span>
00806     <span class="comment">//</span>
00807     <span class="comment">// Note. The condition `PAGE_START(StackEnd) - PAGE_START(StackStart) &gt; PAGE_SIZE'</span>
00808     <span class="comment">// is not totally safe. We can encounter a situation where in this case we</span>
00809     <span class="comment">// do not have the same stack. Can we?</span>
00810     <span class="comment">//</span>
00811     <span class="comment">// The DPC stack is actually the stack of the idle thread corresponding to</span>
00812     <span class="comment">// the current processor. Based on that we probably can figure out in almost</span>
00813     <span class="comment">// all contexts what are the real limits of the stack.</span>
00814     <span class="comment">//</span>
00815 
00816     <span class="keywordflow">if</span> ((StackStart &gt; StackEnd)
00817         || (<a class="code" href="../../d7/d6/stktrace_8c.html#a4">PAGE_START</a>(StackEnd) - <a class="code" href="../../d7/d6/stktrace_8c.html#a4">PAGE_START</a>(StackStart) &gt; PAGE_SIZE)) {
00818 
00819         StackEnd = (StackStart + PAGE_SIZE) &amp; ~((ULONG_PTR)PAGE_SIZE - 1);
00820     
00821         <span class="comment">//</span>
00822         <span class="comment">// Try to get one more page if possible. Note that this is not</span>
00823         <span class="comment">// 100% reliable because a non faulting address can fault if</span>
00824         <span class="comment">// appropriate locks are not held.</span>
00825         <span class="comment">//</span>
00826 
00827         <span class="keywordflow">if</span> (MmIsAddressValid ((PVOID)StackEnd)) {
00828             StackEnd += PAGE_SIZE;
00829         }
00830     }
00831 
00832 #<span class="keywordflow">else</span>
00833 
00834     StackEnd = (ULONG_PTR)(NtCurrentTeb()-&gt;NtTib.StackBase);
00835 
00836 #endif <span class="comment">// #if _KERNEL_MODE_STACK_TRACES_</span>
00837 
00838     <span class="keywordflow">try</span> {
00839 
00840         for (Index = 0; Index &lt; Count; Index++) {
00841 
00842             <span class="keywordflow">if</span> (Fp + <span class="keyword">sizeof</span>(ULONG_PTR) &gt;= StackEnd) {
00843                 <span class="keywordflow">break</span>;
00844             }
00845 
00846             NewFp = *((PULONG_PTR)(Fp + 0));
00847             ReturnAddress = *((PULONG_PTR)(Fp + <span class="keyword">sizeof</span>(ULONG_PTR)));
00848 
00849             <span class="comment">//</span>
00850             <span class="comment">// Figure out if the new frame pointer is ok. This validation</span>
00851             <span class="comment">// should avoid all exceptions in kernel mode because we always</span>
00852             <span class="comment">// read within the current thread's stack and the stack is</span>
00853             <span class="comment">// guaranteed to be in memory (no page faults). It is also guaranteed</span>
00854             <span class="comment">// that we do not take random exceptions in user mode because we always</span>
00855             <span class="comment">// keep the frame pointer within stack limits.</span>
00856             <span class="comment">//</span>
00857 
00858             <span class="keywordflow">if</span> (! (Fp &lt; NewFp &amp;&amp; NewFp &lt; StackEnd)) {
00859                 <span class="keywordflow">break</span>;
00860             }
00861 
00862             <span class="comment">//</span>
00863             <span class="comment">// Figure out if the return address is ok. If return address</span>
00864             <span class="comment">// is a stack address or &lt;64k then something is wrong. There is</span>
00865             <span class="comment">// no reason to return garbage to the caller therefore we stop.</span>
00866             <span class="comment">//</span>
00867 
00868             <span class="keywordflow">if</span> (StackStart &lt; ReturnAddress &amp;&amp; ReturnAddress &lt; StackEnd) {
00869                 <span class="keywordflow">break</span>;
00870             }
00871 
00872             <span class="keywordflow">if</span> (ReturnAddress &lt; 64 * SIZE_1_KB) {
00873                 <span class="keywordflow">break</span>;
00874             }
00875 
00876             <span class="comment">//</span>
00877             <span class="comment">// Store new fp and return address and move on.</span>
00878             <span class="comment">//</span>
00879 
00880             Fp = NewFp;
00881             Callers[Index] = (PVOID)ReturnAddress;
00882         }
00883     }
00884     except (EXCEPTION_EXECUTE_HANDLER) {
00885 
00886         <span class="comment">//</span>
00887         <span class="comment">// The frame traversal algorithm is written so that we should</span>
00888         <span class="comment">// not get any exception. Therefore if we get some exception</span>
00889         <span class="comment">// we better debug it.</span>
00890         <span class="comment">//</span>
00891         <span class="comment">// bugbug: enable bkpt only on checked builds</span>
00892         <span class="comment">// After we get some coverage on this we should leave it active</span>
00893         <span class="comment">// only on checked builds.</span>
00894         <span class="comment">//</span>
00895 
00896         DbgPrint (<span class="stringliteral">"Unexpected exception in RtlWalkFrameChain ...\n"</span>);
00897         DbgBreakPoint ();
00898     }
00899 
00900     <span class="comment">//</span>
00901     <span class="comment">// Return the number of return addresses identified on the stack.</span>
00902     <span class="comment">//</span>
00903 
00904 #<span class="keywordflow">if</span> _COLLECT_FRAME_WALK_STATISTICS_
00905     CollectFrameWalkStatistics (Index);
00906 #endif <span class="comment">// #if _COLLECT_FRAME_WALK_STATISTICS_</span>
00907 
00908     <span class="keywordflow">return</span> Index;
00909 
00910 #<span class="keywordflow">else</span>
00911 
00912     <span class="keywordflow">return</span> 0;
00913 
00914 #endif <span class="comment">// #if defined(_X86_)</span>
00915 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:41 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
