<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: queue.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>queue.c</h1><a href="../../d6/d3/queue_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: queue.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* This module contains the low-level code for working with the Q structure.</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 12-02-90 DavidPe      Created.</span>
00010 <span class="comment">* 02-06-91 IanJa        HWND revalidation added</span>
00011 <span class="comment">\***************************************************************************/</span>
00012 
00013 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00014 <span class="preprocessor">#pragma hdrstop</span>
00015 <span class="preprocessor"></span>
00016 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d6/d3/queue_8c.html#a16">DestroyProcessesObjects</a>(<a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppi);
00017 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d6/d3/queue_8c.html#a17">DestroyThreadsMessages</a>(<a class="code" href="../../d7/d4/structtagQ.html">PQ</a> pq, <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti);
00018 <span class="keywordtype">void</span> <a class="code" href="../../d6/d3/queue_8c.html#a18">CheckProcessForeground</a>(<a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti);
00019 <span class="keywordtype">void</span> <a class="code" href="../../d6/d3/queue_8c.html#a19">ScreenSaverCheck</a>(<a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti);
00020 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d6/d3/queue_8c.html#a20">xxxPollAndWaitForSingleObject</a>(<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> pEvent, PVOID pExecObject,
00021         DWORD dwMilliseconds);
00022 
00023 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d6/d3/queue_8c.html#a21">InitiateShutdown</a>(<a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread, PULONG lpdwFlags);
00024 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d6/d3/queue_8c.html#a22">EndShutdown</a>(<a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread, NTSTATUS StatusShutdown);
00025 <span class="keywordtype">void</span> <a class="code" href="../../d6/d3/queue_8c.html#a23">SetVDMCursorBounds</a>(LPRECT lprc);
00026 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d6/d3/queue_8c.html#a55">InitQEntryLookaside</a>(VOID);
00027 <span class="keywordtype">void</span> <a class="code" href="../../d6/d3/queue_8c.html#a25">SetAppStarting</a> (<a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppi);
00028 
00029 <span class="preprocessor">#pragma alloc_text(INIT, InitQEntryLookaside)</span>
00030 <span class="preprocessor"></span>
<a name="l00031"></a><a class="code" href="../../d6/d3/queue_8c.html#a10">00031</a> PW32PROCESS <a class="code" href="../../d6/d3/queue_8c.html#a10">gpwpCalcFirst</a>;
00032 
00033 <span class="preprocessor">#if DBG</span>
00034 <span class="preprocessor"></span><span class="preprocessor">#define MSG_SENT    0</span>
00035 <span class="preprocessor"></span><span class="preprocessor">#define MSG_POST    1</span>
00036 <span class="preprocessor"></span><span class="preprocessor">#define MSG_RECV    2</span>
00037 <span class="preprocessor"></span><span class="preprocessor">#define MSG_PEEK    3</span>
00038 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a5">TraceDdeMsg</a>(UINT msg, HWND hwndFrom, HWND hwndTo, UINT code);
00039 <span class="preprocessor">#else</span>
<a name="l00040"></a><a class="code" href="../../d6/d3/queue_8c.html#a0">00040</a> <span class="preprocessor"></span><span class="preprocessor">#define TraceDdeMsg(m, h1, h2, c)</span>
00041 <span class="preprocessor"></span><span class="preprocessor">#endif // DBG</span>
00042 <span class="preprocessor"></span>
<a name="l00043"></a><a class="code" href="../../d6/d3/queue_8c.html#a11">00043</a> <a class="code" href="../../d1/d8/struct__PAGED__LOOKASIDE__LIST.html">PPAGED_LOOKASIDE_LIST</a> <a class="code" href="../../d6/d3/queue_8c.html#a11">QLookaside</a>;
<a name="l00044"></a><a class="code" href="../../d6/d3/queue_8c.html#a12">00044</a> <a class="code" href="../../d1/d8/struct__PAGED__LOOKASIDE__LIST.html">PPAGED_LOOKASIDE_LIST</a> <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a20">QEntryLookaside</a>;
00045 
00046 <span class="preprocessor">#if DBG</span>
00047 <span class="preprocessor"></span><span class="keywordtype">void</span> <a class="code" href="../../d6/d3/queue_8c.html#a1">DebugValidateMLIST</a>(<a class="code" href="../../d6/d1/structtagMLIST.html">PMLIST</a> pml)
00048 {
00049     <span class="keywordtype">int</span>     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>;
00050     <a class="code" href="../../d8/d4/structtagQMSG.html">PQMSG</a>   pqmsg;
00051 
00052     <span class="comment">/*</span>
00053 <span class="comment">     * Check that the message list is properly terminated.</span>
00054 <span class="comment">     */</span>
00055     UserAssert(!pml-&gt;<a class="code" href="../../d6/d1/structtagMLIST.html#o0">pqmsgRead</a> || !pml-&gt;<a class="code" href="../../d6/d1/structtagMLIST.html#o0">pqmsgRead</a>-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o1">pqmsgPrev</a>);
00056     UserAssert(!pml-&gt;<a class="code" href="../../d6/d1/structtagMLIST.html#o1">pqmsgWriteLast</a> || !pml-&gt;<a class="code" href="../../d6/d1/structtagMLIST.html#o1">pqmsgWriteLast</a>-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o0">pqmsgNext</a>);
00057 
00058     <span class="comment">/*</span>
00059 <span class="comment">     * Check that there aren't loops in the Next list.</span>
00060 <span class="comment">     */</span>
00061     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> = pml-&gt;<a class="code" href="../../d6/d1/structtagMLIST.html#o2">cMsgs</a>;
00062     UserAssert(<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> &gt;= 0);
00063     pqmsg = pml-&gt;<a class="code" href="../../d6/d1/structtagMLIST.html#o0">pqmsgRead</a>;
00064     <span class="keywordflow">while</span> (--<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> &gt;= 0) {
00065         UserAssert(pqmsg);
00066         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> == 0) {
00067             UserAssert(pqmsg == pml-&gt;<a class="code" href="../../d6/d1/structtagMLIST.html#o1">pqmsgWriteLast</a>);
00068         }
00069 
00070         pqmsg = pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o0">pqmsgNext</a>;
00071     }
00072 
00073     UserAssert(!pqmsg);
00074 
00075     <span class="comment">/*</span>
00076 <span class="comment">     * Check that there aren't loops in the Prev list.</span>
00077 <span class="comment">     */</span>
00078     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> = pml-&gt;<a class="code" href="../../d6/d1/structtagMLIST.html#o2">cMsgs</a>;
00079     pqmsg = pml-&gt;<a class="code" href="../../d6/d1/structtagMLIST.html#o1">pqmsgWriteLast</a>;
00080     <span class="keywordflow">while</span> (--<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> &gt;= 0) {
00081         UserAssert(pqmsg);
00082         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> == 0) {
00083             UserAssert(pqmsg == pml-&gt;<a class="code" href="../../d6/d1/structtagMLIST.html#o0">pqmsgRead</a>);
00084         }
00085 
00086         pqmsg = pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o1">pqmsgPrev</a>;
00087     }
00088 
00089     UserAssert(!pqmsg);
00090 }
00091 
00092 <span class="keywordtype">void</span> <a class="code" href="../../d6/d3/queue_8c.html#a2">DebugValidateMLISTandQMSG</a>(<a class="code" href="../../d6/d1/structtagMLIST.html">PMLIST</a> pml, <a class="code" href="../../d8/d4/structtagQMSG.html">PQMSG</a> pqmsg)
00093 {
00094     <a class="code" href="../../d8/d4/structtagQMSG.html">PQMSG</a> pqmsgT;
00095 
00096     <a class="code" href="../../d6/d3/queue_8c.html#a1">DebugValidateMLIST</a>(pml);
00097     <span class="keywordflow">for</span> (pqmsgT = pml-&gt;<a class="code" href="../../d6/d1/structtagMLIST.html#o0">pqmsgRead</a>; pqmsgT; pqmsgT = pqmsgT-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o0">pqmsgNext</a>) {
00098         <span class="keywordflow">if</span> (pqmsgT == pqmsg) {
00099             <span class="keywordflow">return</span>;
00100         }
00101     }
00102 
00103     UserAssert(pqmsgT == pqmsg);
00104 }
00105 
00106 <span class="preprocessor">#else</span>
<a name="l00107"></a><a class="code" href="../../d6/d3/queue_8c.html#a1">00107</a> <span class="preprocessor"></span><span class="preprocessor">#define DebugValidateMLIST(pml)</span>
<a name="l00108"></a><a class="code" href="../../d6/d3/queue_8c.html#a2">00108</a> <span class="preprocessor"></span><span class="preprocessor">#define DebugValidateMLISTandQMSG(pml, pqmsg)</span>
00109 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00110 <span class="preprocessor"></span>
00111 <span class="comment">/***************************************************************************\</span>
00112 <span class="comment">* xxxSetProcessInitState</span>
00113 <span class="comment">*</span>
00114 <span class="comment">* Set process initialization state.  What state is set depends</span>
00115 <span class="comment">* on whether another process is waiting on this process.</span>
00116 <span class="comment">*</span>
00117 <span class="comment">* 04-02-95 JimA         Created.</span>
00118 <span class="comment">\***************************************************************************/</span>
00119 
<a name="l00120"></a><a class="code" href="../../d6/d3/queue_8c.html#a26">00120</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d3/queue_8c.html#a26">xxxSetProcessInitState</a>(
00121     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
00122     DWORD dwFlags)
00123 {
00124     PW32PROCESS W32Process;
00125     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00126 
00127     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00128     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a616">IsWinEventNotifyDeferredOK</a>());
00129 
00130     <span class="comment">/*</span>
00131 <span class="comment">     * If the W32Process structure has not been allocated, do it now.</span>
00132 <span class="comment">     */</span>
00133     W32Process = (PW32PROCESS)Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o72">Win32Process</a>;
00134     <span class="keywordflow">if</span> (W32Process == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00135         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = AllocateW32Process(Process);
00136         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00137             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00138         }
00139         W32Process = (PW32PROCESS)Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o72">Win32Process</a>;
00140 <span class="preprocessor">#if DBG</span>
00141 <span class="preprocessor"></span>        <span class="comment">/*</span>
00142 <span class="comment">         * The above AllocateW32Process(Process, FALSE) won't set the</span>
00143 <span class="comment">         * W32PF_PROCESSCONNECTED flag (and if it wasn't previously set),</span>
00144 <span class="comment">         * make sure we're not on the gppiStarting list, because if we are,</span>
00145 <span class="comment">         * we will not be removed without the W32PF_PROCESSCONNECTED bit.</span>
00146 <span class="comment">         */</span>
00147         <span class="keywordflow">if</span> ((W32Process-&gt;W32PF_Flags &amp; W32PF_PROCESSCONNECTED) == 0) {
00148             UserAssert((W32Process-&gt;W32PF_Flags &amp; W32PF_APPSTARTING) == 0);
00149         }
00150 <span class="preprocessor">#endif</span>
00151 <span class="preprocessor"></span>    }
00152 
00153     <span class="comment">/*</span>
00154 <span class="comment">     * Defer WinEvent notifications, because the thread isn't initialized yet.</span>
00155 <span class="comment">     */</span>
00156     <a class="code" href="../../d4/d1/userk_8h.html#a614">DeferWinEventNotify</a>();
00157     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> == 0) {
00158         <span class="keywordflow">if</span> (!(W32Process-&gt;W32PF_Flags &amp; W32PF_WOW)) {
00159 
00160             <span class="comment">/*</span>
00161 <span class="comment">             * Check to see if the startglass is on, and if so turn it off and update.</span>
00162 <span class="comment">             */</span>
00163             <span class="keywordflow">if</span> (W32Process-&gt;W32PF_Flags &amp; W32PF_STARTGLASS) {
00164                 W32Process-&gt;W32PF_Flags &amp;= ~W32PF_STARTGLASS;
00165                 <a class="code" href="../../d4/d1/userk_8h.html#a1490">zzzCalcStartCursorHide</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0);
00166             }
00167 
00168             <span class="comment">/*</span>
00169 <span class="comment">             * Found it.  Set the console bit and reset the wait event so any sleepers</span>
00170 <span class="comment">             * wake up.</span>
00171 <span class="comment">             */</span>
00172             W32Process-&gt;W32PF_Flags |= W32PF_CONSOLEAPPLICATION;
00173             <a class="code" href="../../d4/d1/userk_8h.html#a365">SET_PSEUDO_EVENT</a>(&amp;W32Process-&gt;InputIdleEvent);
00174         }
00175     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(W32Process-&gt;W32PF_Flags &amp; W32PF_INITIALIZED)) {
00176         W32Process-&gt;W32PF_Flags |= W32PF_INITIALIZED;
00177 
00178         <span class="comment">/*</span>
00179 <span class="comment">         * Set global state to allow the new process to become</span>
00180 <span class="comment">         * foreground.  xxxInitProcessInfo() will set</span>
00181 <span class="comment">         * W32PF_ALLOWFOREGROUNDACTIVATE when the process initializes.</span>
00182 <span class="comment">         */</span>
00183         <a class="code" href="../../d4/d1/userk_8h.html#a659">SET_PUDF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a647">PUDF_ALLOWFOREGROUNDACTIVATE</a>);
00184         TAGMSG1(DBGTAG_FOREGROUND, <span class="stringliteral">"xxxSetProcessInitState set PUDF. %#p"</span>, W32Process);
00185 
00186 
00187         <span class="comment">/*</span>
00188 <span class="comment">         * If this is the win32 server process, force off start glass feedback</span>
00189 <span class="comment">         */</span>
00190         <span class="keywordflow">if</span> (Process == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a299">gpepCSRSS</a>) {
00191             <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> |= STARTF_FORCEOFFFEEDBACK;
00192         }
00193 
00194         <span class="comment">/*</span>
00195 <span class="comment">         * Show the app start cursor for 2 seconds if it was requested from</span>
00196 <span class="comment">         * the application.</span>
00197 <span class="comment">         */</span>
00198         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; STARTF_FORCEOFFFEEDBACK) {
00199             W32Process-&gt;W32PF_Flags |= W32PF_FORCEOFFFEEDBACK;
00200             <a class="code" href="../../d4/d1/userk_8h.html#a1490">zzzCalcStartCursorHide</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0);
00201         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; STARTF_FORCEONFEEDBACK) {
00202             <a class="code" href="../../d4/d1/userk_8h.html#a1490">zzzCalcStartCursorHide</a>(W32Process, 2000);
00203         }
00204     }
00205     <span class="comment">/*</span>
00206 <span class="comment">     * Have to defer without processing, because we don't have a ptiCurrent yet</span>
00207 <span class="comment">     */</span>
00208     <a class="code" href="../../d4/d1/userk_8h.html#a618">EndDeferWinEventNotifyWithoutProcessing</a>();
00209     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00210 }
00211 
00212 <span class="comment">/***************************************************************************\</span>
00213 <span class="comment">* CheckAllowForeground</span>
00214 <span class="comment">*</span>
00215 <span class="comment">* Bug 273518 - joejo</span>
00216 <span class="comment">*</span>
00217 <span class="comment">* Removed this loop from xxxInitProcessInfo to allow code shareing between</span>
00218 <span class="comment">* that function and xxxUserNotifyConsoleApplication. This will allow console</span>
00219 <span class="comment">* windows to set foreground correctly on new process' it launches, as opposed</span>
00220 <span class="comment">* it just forcing foreground.</span>
00221 <span class="comment">\***************************************************************************/</span>
<a name="l00222"></a><a class="code" href="../../d6/d3/queue_8c.html#a27">00222</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d3/queue_8c.html#a27">CheckAllowForeground</a>(
00223     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> pep)
00224 {
00225     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fCreator = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00226     HANDLE hpid = (HANDLE)<a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a2">pep</a>-&gt;InheritedFromUniqueProcessId;
00227     LUID luid;
00228     PACCESS_TOKEN pat;
00229     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> pepParent;
00230     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppiParent;
00231     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uAncestors = 0;
00232     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fAllowForeground = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00233     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00234 
00235     <span class="keywordflow">do</span> {
00236         <span class="comment">/*</span>
00237 <span class="comment">         * Get the ppi for the parent process.</span>
00238 <span class="comment">         */</span>
00239         <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
00240         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1258">LockProcessByClientId</a>(hpid, &amp;pepParent);
00241         <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
00242         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00243             <span class="comment">/*</span>
00244 <span class="comment">             * Bug 294193 - joejo</span>
00245 <span class="comment">             *</span>
00246 <span class="comment">             * If this is a process that was created after it'a creator was</span>
00247 <span class="comment">             * destroyed, then lets attempt to give it foreground. This is a</span>
00248 <span class="comment">             * typical scenario when a stub exe trys to create another process</span>
00249 <span class="comment">             * in it's place.</span>
00250 <span class="comment">             */</span>
00251             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1938">HasForegroundActivateRight</a>(<a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a2">pep</a>-&gt;InheritedFromUniqueProcessId)) {
00252                 fAllowForeground = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00253             }
00254             <span class="keywordflow">break</span>;
00255         }
00256 
00257         ppiParent = <a class="code" href="../../d4/d1/userk_8h.html#a18">PpiFromProcess</a>(pepParent);
00258         <span class="keywordflow">if</span> (ppiParent == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00259             <a class="code" href="../../d4/d1/userk_8h.html#a517">UnlockProcess</a>(pepParent);
00260             <span class="keywordflow">break</span>;
00261         }
00262         <span class="comment">/*</span>
00263 <span class="comment">         * If we're walking the parent chain,</span>
00264 <span class="comment">         * stop when we get to the shell or to a process that</span>
00265 <span class="comment">         * is not running on the IO winsta</span>
00266 <span class="comment">         */</span>
00267         <span class="keywordflow">if</span> (!fCreator
00268                 &amp;&amp; (<a class="code" href="../../d4/d1/userk_8h.html#a1822">IsShellProcess</a>(ppiParent)
00269                     || ((ppiParent-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o14">rpwinsta</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00270                         &amp;&amp; (ppiParent-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o14">rpwinsta</a>-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a316">WSF_NOIO</a>)))) {
00271 
00272             <a class="code" href="../../d4/d1/userk_8h.html#a517">UnlockProcess</a>(pepParent);
00273             <span class="keywordflow">break</span>;
00274         }
00275         fAllowForeground = <a class="code" href="../../d4/d1/userk_8h.html#a1663">CanForceForeground</a>(ppiParent);
00276         <span class="keywordflow">if</span> (!fAllowForeground) {
00277             <span class="comment">/*</span>
00278 <span class="comment">             * Bug 285639 - joejo</span>
00279 <span class="comment">             *</span>
00280 <span class="comment">             * If the first thread of the parent process has allow set foreground</span>
00281 <span class="comment">             * than we allow the setting of the foreground.</span>
00282 <span class="comment">             */</span>
00283             <span class="keywordflow">if</span> (ppiParent-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o1">ptiList</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00284                 &amp;&amp; (ppiParent-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o1">ptiList</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a800">TIF_ALLOWFOREGROUNDACTIVATE</a>)) {
00285                     fAllowForeground = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00286             }
00287 
00288             <span class="keywordflow">if</span> (!fAllowForeground){
00289                 <span class="comment">/*</span>
00290 <span class="comment">                 * Let's try an ancestor (this might be a worker process).</span>
00291 <span class="comment">                 */</span>
00292                 hpid = (HANDLE)pepParent-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o53">InheritedFromUniqueProcessId</a>;
00293                 <span class="comment">/*</span>
00294 <span class="comment">                 * If this is launched by a system process, let it come to</span>
00295 <span class="comment">                 *  the foreground (i.e. CSRSS launching an OLE server).</span>
00296 <span class="comment">                 */</span>
00297                 <span class="keywordflow">if</span> (fCreator) {
00298                     fCreator = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00299                     pat = <a class="code" href="../../d6/d5/ps_2security_8c.html#a0">PsReferencePrimaryToken</a>(pepParent);
00300                     <span class="keywordflow">if</span> (pat != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00301                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a1">SeQueryAuthenticationIdToken</a>(pat, &amp;luid);
00302                         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00303                             fAllowForeground = <a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>(&amp;luid, &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a244">luidSystem</a>);
00304                             <span class="comment">/*</span>
00305 <span class="comment">                             * If it is a system process, give it the</span>
00306 <span class="comment">                             *  permanent right so we won't have to check</span>
00307 <span class="comment">                             *  its luid again</span>
00308 <span class="comment">                             */</span>
00309                              <span class="keywordflow">if</span> (fAllowForeground) {
00310                                  ppiParent-&gt;W32PF_Flags |= <a class="code" href="../../d8/d5/consrv_8h.html#a57">W32PF_ALLOWSETFOREGROUND</a>;
00311                              }
00312                         }
00313                         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pat);
00314                     }
00315                 }
00316             }
00317         }
00318         <a class="code" href="../../d4/d1/userk_8h.html#a517">UnlockProcess</a>(pepParent);
00319       <span class="comment">/*</span>
00320 <span class="comment">       * InheritedFromUniqueProcessId cannot be quite trusted because</span>
00321 <span class="comment">       *  process ids get reused very often. So we just check few levels up</span>
00322 <span class="comment">       */</span>
00323     } <span class="keywordflow">while</span> (!fAllowForeground &amp;&amp; (uAncestors++ &lt; 5));
00324 
00325     <span class="keywordflow">return</span>  fAllowForeground || <a class="code" href="../../d4/d1/userk_8h.html#a2026">GiveUpForeground</a>();
00326 }
00327 
00328 <span class="comment">/***************************************************************************\</span>
00329 <span class="comment">* xxxUserNotifyConsoleApplication</span>
00330 <span class="comment">*</span>
00331 <span class="comment">* This is called by the console init code - it tells us that the starting</span>
00332 <span class="comment">* application is a console application. We want to know this for various</span>
00333 <span class="comment">* reasons, one being that WinExec() doesn't wait on a starting console</span>
00334 <span class="comment">* application.</span>
00335 <span class="comment">*</span>
00336 <span class="comment">* 09-18-91 ScottLu      Created.</span>
00337 <span class="comment">* 01-12-99  JoeJo       Bug 273518</span>
00338 <span class="comment">*           Adding bug fix and optimization for bug fix</span>
00339 <span class="comment">\***************************************************************************/</span>
00340 
<a name="l00341"></a><a class="code" href="../../d6/d3/queue_8c.html#a28">00341</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d3/queue_8c.html#a28">xxxUserNotifyConsoleApplication</a>(
00342     PCONSOLE_PROCESS_INFO pcpi)
00343 {
00344     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>  <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00345     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
00346     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> retval;
00347 
00348     <span class="comment">/*</span>
00349 <span class="comment">     * First search for this process in our process information list.</span>
00350 <span class="comment">     */</span>
00351     <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
00352     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1258">LockProcessByClientId</a>((HANDLE)LongToHandle( pcpi-&gt;dwProcessID ), &amp;Process);
00353     <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
00354 
00355     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00356         RIPMSG2(RIP_WARNING, <span class="stringliteral">"xxxUserNotifyConsoleApplication: Failed with Process ID == %X, Status = %x\n"</span>,
00357                 pcpi-&gt;dwProcessID, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00358         <span class="keywordflow">return</span>;
00359     }
00360 
00361     retval = <a class="code" href="../../d6/d3/queue_8c.html#a26">xxxSetProcessInitState</a>(Process, 0);
00362     <span class="comment">/*</span>
00363 <span class="comment">     * Bug 273518 - joejo</span>
00364 <span class="comment">     *</span>
00365 <span class="comment">     * This will allow console windows to set foreground correctly on new</span>
00366 <span class="comment">     * process' it launches, as opposed it just forcing foreground.</span>
00367 <span class="comment">     */</span>
00368     <span class="keywordflow">if</span> (retval) {
00369         <span class="keywordflow">if</span> (pcpi-&gt;dwFlags &amp; CPI_NEWPROCESSWINDOW) {
00370             <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>();
00371             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d3/queue_8c.html#a27">CheckAllowForeground</a>(Process)) {
00372                 <span class="keywordflow">if</span> (!(ppiCurrent-&gt;W32PF_Flags &amp; W32PF_APPSTARTING)) {
00373                     <a class="code" href="../../d6/d3/queue_8c.html#a25">SetAppStarting</a>(ppiCurrent);
00374                 }
00375                 <a class="code" href="../../d4/d1/userk_8h.html#a659">SET_PUDF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a647">PUDF_ALLOWFOREGROUNDACTIVATE</a>);
00376                 TAGMSG0(DBGTAG_FOREGROUND, <span class="stringliteral">"xxxUserNotifyConsoleApplication set PUDF"</span>);
00377                 ppiCurrent-&gt;W32PF_Flags |= W32PF_ALLOWFOREGROUNDACTIVATE;
00378             }
00379 
00380             TAGMSG3(DBGTAG_FOREGROUND, <span class="stringliteral">"xxxUserNotifyConsoleApplication %s W32PF %#p-%#p"</span>,
00381                     ((ppiCurrent-&gt;W32PF_Flags &amp; W32PF_ALLOWFOREGROUNDACTIVATE) ? <span class="stringliteral">"set"</span> : <span class="stringliteral">"NOT"</span>),
00382                     ppiCurrent, <a class="code" href="../../d4/d1/userk_8h.html#a18">PpiFromProcess</a>(Process));
00383         }
00384     } <span class="keywordflow">else</span> {
00385         RIPMSG1(RIP_WARNING, <span class="stringliteral">"xxxUserNotifyConsoleApplication - SetProcessInitState failed on %#p"</span>, Process);
00386     }
00387 
00388 
00389 
00390     <a class="code" href="../../d4/d1/userk_8h.html#a517">UnlockProcess</a>(Process);
00391 }
00392 
00393 
00394 <span class="comment">/***************************************************************************\</span>
00395 <span class="comment">* UserSetConsoleProcessWindowStation</span>
00396 <span class="comment">*</span>
00397 <span class="comment">* This is called by the console init code - it tells us that the starting</span>
00398 <span class="comment">* application is a console application and which window station they are associated</span>
00399 <span class="comment">* with.  The window station pointer is stored in the EPROCESS for the Global atom</span>
00400 <span class="comment">* calls to find the correct global atom table when called from a console application</span>
00401 <span class="comment">*</span>
00402 <span class="comment">\***************************************************************************/</span>
00403 
<a name="l00404"></a><a class="code" href="../../d6/d3/queue_8c.html#a29">00404</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d3/queue_8c.html#a29">UserSetConsoleProcessWindowStation</a>(
00405     DWORD idProcess,
00406     HWINSTA hwinsta
00407     )
00408 {
00409     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>  <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00410     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
00411 
00412     <span class="comment">/*</span>
00413 <span class="comment">     * First search for this process in our process information list.</span>
00414 <span class="comment">     */</span>
00415     <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
00416     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1258">LockProcessByClientId</a>((HANDLE)LongToHandle( idProcess ), &amp;Process);
00417     <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
00418 
00419     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00420         RIPMSG2(RIP_WARNING, <span class="stringliteral">"UserSetConsoleProcessWindowStation: Failed with Process ID == %X, Status = %x\n"</span>,
00421                 idProcess, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00422         <span class="keywordflow">return</span>;
00423     }
00424 
00425     Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o52">Win32WindowStation</a> = hwinsta;
00426 
00427     <a class="code" href="../../d4/d1/userk_8h.html#a517">UnlockProcess</a>(Process);
00428 }
00429 
00430 
00431 <span class="comment">/***************************************************************************\</span>
00432 <span class="comment">* xxxUserNotifyProcessCreate</span>
00433 <span class="comment">*</span>
00434 <span class="comment">* This is a special notification that we get from the base while process data</span>
00435 <span class="comment">* structures are being created, but before the process has started. We use</span>
00436 <span class="comment">* this notification for startup synchronization matters (winexec, startup</span>
00437 <span class="comment">* activation, type ahead, etc).</span>
00438 <span class="comment">*</span>
00439 <span class="comment">* This notification is called on the server thread for the client thread</span>
00440 <span class="comment">* starting the process.</span>
00441 <span class="comment">*</span>
00442 <span class="comment">* 09-09-91 ScottLu      Created.</span>
00443 <span class="comment">\***************************************************************************/</span>
00444 
<a name="l00445"></a><a class="code" href="../../d6/d3/queue_8c.html#a30">00445</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d3/queue_8c.html#a30">xxxUserNotifyProcessCreate</a>(
00446     DWORD idProcess,
00447     DWORD idParentThread,
00448     ULONG_PTR dwData,
00449     DWORD dwFlags)
00450 {
00451     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
00452     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
00453     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti;
00454     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00455     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> retval;
00456 
00457     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00458 
00459 
00460     <a class="code" href="../../d4/d1/userk_8h.html#a1937">GiveForegroundActivateRight</a>((HANDLE)idProcess);
00461 
00462     <span class="comment">/*</span>
00463 <span class="comment">     * 0x1 bit means give feedback (app start cursor).</span>
00464 <span class="comment">     * 0x2 bit means this is a gui app (meaning, call CreateProcessInfo()</span>
00465 <span class="comment">     *     so we get app start synchronization (WaitForInputIdle()).</span>
00466 <span class="comment">     * 0x8 bit means this process is a WOW process, set W32PF_WOW.  0x1</span>
00467 <span class="comment">     *     and 0x2 bits will also be set.</span>
00468 <span class="comment">     * 0x4 value means this is really a shared WOW task starting</span>
00469 <span class="comment">     */</span>
00470 
00471     <span class="comment">/*</span>
00472 <span class="comment">     * If we want feedback, we need to create a process info structure,</span>
00473 <span class="comment">     * so do it: it will be properly cleaned up.</span>
00474 <span class="comment">     */</span>
00475     <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; 0xb) != 0) {
00476         <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
00477         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1258">LockProcessByClientId</a>((HANDLE)LongToHandle( idProcess ), &amp;Process);
00478         <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
00479 
00480         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00481             RIPMSG2(RIP_WARNING, <span class="stringliteral">"xxxUserNotifyProcessCreate: Failed with Process ID == %X, Status = %x\n"</span>,
00482                     idProcess, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00483             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00484         }
00485 
00486         retval = <a class="code" href="../../d6/d3/queue_8c.html#a26">xxxSetProcessInitState</a>(Process, ((<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; 1) ? STARTF_FORCEONFEEDBACK : STARTF_FORCEOFFFEEDBACK));
00487         <span class="keywordflow">if</span> (!retval) {
00488             RIPMSG1(RIP_WARNING, <span class="stringliteral">"xxxUserNotifyProcessCreate - SetProcessInitState failed on %#p"</span>, Process);
00489         }
00490         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; 0x8) {
00491             <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o72">Win32Process</a>)
00492                 ((PW32PROCESS)Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o72">Win32Process</a>)-&gt;W32PF_Flags |= W32PF_WOW;
00493         }
00494 
00495         <a class="code" href="../../d4/d1/userk_8h.html#a517">UnlockProcess</a>(Process);
00496 
00497         <span class="comment">/*</span>
00498 <span class="comment">         * Find out who is starting this app. If it is a 16 bit app, allow</span>
00499 <span class="comment">         * it to bring itself back to the foreground if it calls</span>
00500 <span class="comment">         * SetActiveWindow() or SetFocus(). This is because this could be</span>
00501 <span class="comment">         * related to OLE to DDE activation. Notes has a case where after it</span>
00502 <span class="comment">         * lauches pbrush to edit an embedded bitmap, it brings up a message</span>
00503 <span class="comment">         * box on top if the bitmap is read only. This message box won't appear</span>
00504 <span class="comment">         * foreground unless we allow it to. This usually isn't a problem</span>
00505 <span class="comment">         * because most apps don't bring up windows on top of editors</span>
00506 <span class="comment">         * like this. 32 bit apps will call SetForegroundWindow().</span>
00507 <span class="comment">         */</span>
00508 
00509         <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
00510         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1259">LockThreadByClientId</a>((HANDLE)LongToHandle( idParentThread ), &amp;Thread);
00511         <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
00512 
00513         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00514             RIPMSG2(RIP_WARNING, <span class="stringliteral">"xxxUserNotifyProcessCreate: Failed with Thread ID == %X, Status = %x\n"</span>,
00515                     idParentThread, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00516             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00517         }
00518 
00519         pti = <a class="code" href="../../d4/d1/userk_8h.html#a17">PtiFromThread</a>(Thread);
00520         <span class="keywordflow">if</span> (pti &amp;&amp; (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>)) {
00521             pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a800">TIF_ALLOWFOREGROUNDACTIVATE</a>;
00522             TAGMSG1(DBGTAG_FOREGROUND, <span class="stringliteral">"xxxUserNotifyProcessCreate set TIF %#p"</span>, pti);
00523         }
00524 
00525         <a class="code" href="../../d4/d1/userk_8h.html#a518">UnlockThread</a>(Thread);
00526 
00527     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> == 4) {
00528         <span class="comment">/*</span>
00529 <span class="comment">         * A WOW task is starting up. Create the WOW per thread info</span>
00530 <span class="comment">         * structure here in case someone calls WaitForInputIdle</span>
00531 <span class="comment">         * before the thread is created.</span>
00532 <span class="comment">         */</span>
00533         <a class="code" href="../../d8/d9/structtagWOWTHREADINFO.html">PWOWTHREADINFO</a> pwti;
00534 
00535         <span class="comment">/*</span>
00536 <span class="comment">         * Look for a matching thread in the WOW thread info list.</span>
00537 <span class="comment">         */</span>
00538         <span class="keywordflow">for</span> (pwti = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a27">gpwtiFirst</a>; pwti != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; pwti = pwti-&gt;<a class="code" href="../../d8/d9/structtagWOWTHREADINFO.html#o0">pwtiNext</a>) {
00539             <span class="keywordflow">if</span> (pwti-&gt;<a class="code" href="../../d8/d9/structtagWOWTHREADINFO.html#o1">idTask</a> == idProcess) {
00540                 <span class="keywordflow">break</span>;
00541             }
00542         }
00543 
00544         <span class="comment">/*</span>
00545 <span class="comment">         * If we didn't find one, allocate a new one and add it to</span>
00546 <span class="comment">         * the head of the list.</span>
00547 <span class="comment">         */</span>
00548         <span class="keywordflow">if</span> (pwti == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00549             pwti = (<a class="code" href="../../d8/d9/structtagWOWTHREADINFO.html">PWOWTHREADINFO</a>)UserAllocPoolWithQuota(
00550                     <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d9/structtagWOWTHREADINFO.html">WOWTHREADINFO</a>), TAG_WOWTHREADINFO);
00551             <span class="keywordflow">if</span> (pwti == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00552                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00553             }
00554             <a class="code" href="../../d4/d1/userk_8h.html#a364">INIT_PSEUDO_EVENT</a>(&amp;pwti-&gt;<a class="code" href="../../d8/d9/structtagWOWTHREADINFO.html#o4">pIdleEvent</a>);
00555             pwti-&gt;<a class="code" href="../../d8/d9/structtagWOWTHREADINFO.html#o1">idTask</a> = idProcess;
00556             pwti-&gt;<a class="code" href="../../d8/d9/structtagWOWTHREADINFO.html#o0">pwtiNext</a> = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a27">gpwtiFirst</a>;
00557             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a27">gpwtiFirst</a> = pwti;
00558         } <span class="keywordflow">else</span> {
00559             <a class="code" href="../../d4/d1/userk_8h.html#a366">RESET_PSEUDO_EVENT</a>(&amp;pwti-&gt;<a class="code" href="../../d8/d9/structtagWOWTHREADINFO.html#o4">pIdleEvent</a>);
00560         }
00561 
00562         pwti-&gt;<a class="code" href="../../d8/d9/structtagWOWTHREADINFO.html#o2">idWaitObject</a> = dwData;
00563         <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
00564         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1259">LockThreadByClientId</a>((HANDLE)LongToHandle( idParentThread ), &amp;Thread);
00565         <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
00566         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
00567             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00568 
00569         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00570             RIPMSG2(RIP_WARNING, <span class="stringliteral">"xxxUserNotifyProcessCreate: Failed with Thread ID == %X, Status = %x\n"</span>,
00571                     idParentThread, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00572             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00573         }
00574 
00575         pwti-&gt;<a class="code" href="../../d8/d9/structtagWOWTHREADINFO.html#o3">idParentProcess</a> = HandleToUlong(Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o12">Cid</a>.UniqueProcess);
00576         <a class="code" href="../../d4/d1/userk_8h.html#a518">UnlockThread</a>(Thread);
00577     }
00578 
00579     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00580 }
00581 
00582 
00583 <span class="comment">/***************************************************************************\</span>
00584 <span class="comment">* zzzCalcStartCursorHide</span>
00585 <span class="comment">*</span>
00586 <span class="comment">* Calculates when to hide the startup cursor.</span>
00587 <span class="comment">*</span>
00588 <span class="comment">* 05-14-92 ScottLu      Created.</span>
00589 <span class="comment">\***************************************************************************/</span>
00590 
<a name="l00591"></a><a class="code" href="../../d4/d1/userk_8h.html#a1490">00591</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1490">zzzCalcStartCursorHide</a>(
00592     PW32PROCESS pwp,
00593     DWORD timeAdd)
00594 {
00595     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> timeNow;
00596     PW32PROCESS pwpT;
00597     PW32PROCESS *ppwpT;
00598 
00599 
00600     timeNow = <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>();
00601 
00602     <span class="keywordflow">if</span> (pwp != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00603 
00604         <span class="comment">/*</span>
00605 <span class="comment">         * We were passed in a timeout. Recalculate when we timeout</span>
00606 <span class="comment">         * and add the pwp to the starting list.</span>
00607 <span class="comment">         */</span>
00608         <span class="keywordflow">if</span> (!(pwp-&gt;W32PF_Flags &amp; W32PF_STARTGLASS)) {
00609 
00610             <span class="comment">/*</span>
00611 <span class="comment">             * Add it to the list only if it is not already in the list</span>
00612 <span class="comment">             */</span>
00613             <span class="keywordflow">for</span> (pwpT = <a class="code" href="../../d6/d3/queue_8c.html#a10">gpwpCalcFirst</a>; pwpT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; pwpT = pwpT-&gt;NextStart) {
00614                 <span class="keywordflow">if</span> (pwpT == pwp)
00615                     <span class="keywordflow">break</span>;
00616             }
00617 
00618             <span class="keywordflow">if</span> (pwpT != pwp) {
00619                 pwp-&gt;NextStart = <a class="code" href="../../d6/d3/queue_8c.html#a10">gpwpCalcFirst</a>;
00620                 <a class="code" href="../../d6/d3/queue_8c.html#a10">gpwpCalcFirst</a> = pwp;
00621             }
00622         }
00623         pwp-&gt;StartCursorHideTime = timeAdd + timeNow;
00624         pwp-&gt;W32PF_Flags |= W32PF_STARTGLASS;
00625     }
00626 
00627     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a74">gtimeStartCursorHide</a> = 0;
00628     <span class="keywordflow">for</span> (ppwpT = &amp;<a class="code" href="../../d6/d3/queue_8c.html#a10">gpwpCalcFirst</a>; (pwpT = *ppwpT) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; ) {
00629 
00630         <span class="comment">/*</span>
00631 <span class="comment">         * If the app isn't starting or feedback is forced off, remove</span>
00632 <span class="comment">         * it from the list so we don't look at it again.</span>
00633 <span class="comment">         */</span>
00634         <span class="keywordflow">if</span> (!(pwpT-&gt;W32PF_Flags &amp; W32PF_STARTGLASS) ||
00635                 (pwpT-&gt;W32PF_Flags &amp; W32PF_FORCEOFFFEEDBACK)) {
00636             *ppwpT = pwpT-&gt;NextStart;
00637             <span class="keywordflow">continue</span>;
00638         }
00639 
00640         <span class="comment">/*</span>
00641 <span class="comment">         * Find the greatest hide cursor timeout value.</span>
00642 <span class="comment">         */</span>
00643         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a74">gtimeStartCursorHide</a> &lt; pwpT-&gt;StartCursorHideTime)
00644             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a74">gtimeStartCursorHide</a> = pwpT-&gt;StartCursorHideTime;
00645 
00646         <span class="comment">/*</span>
00647 <span class="comment">         * If this app has timed out, it isn't starting anymore!</span>
00648 <span class="comment">         * Remove it from the list.</span>
00649 <span class="comment">         */</span>
00650         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a2020">ComputeTickDelta</a>(timeNow, pwpT-&gt;StartCursorHideTime) &gt; 0) {
00651             pwpT-&gt;W32PF_Flags &amp;= ~W32PF_STARTGLASS;
00652             *ppwpT = pwpT-&gt;NextStart;
00653             <span class="keywordflow">continue</span>;
00654         }
00655 
00656         <span class="comment">/*</span>
00657 <span class="comment">         * Step to the next pwp in the list.</span>
00658 <span class="comment">         */</span>
00659         ppwpT = &amp;pwpT-&gt;NextStart;
00660     }
00661 
00662     <span class="comment">/*</span>
00663 <span class="comment">     * If the hide time is still less than the current time, then turn off</span>
00664 <span class="comment">     * the app starting cursor.</span>
00665 <span class="comment">     */</span>
00666     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a74">gtimeStartCursorHide</a> &lt;= timeNow)
00667         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a74">gtimeStartCursorHide</a> = 0;
00668 
00669     <span class="comment">/*</span>
00670 <span class="comment">     * Update the cursor image with the new info (doesn't do anything unless</span>
00671 <span class="comment">     * the cursor is really changing).</span>
00672 <span class="comment">     */</span>
00673     <a class="code" href="../../d7/d1/ntuser_2kernel_2cursor_8c.html#a11">zzzUpdateCursorImage</a>();
00674 }
00675 
00676 
<a name="l00677"></a><a class="code" href="../../d6/d3/queue_8c.html#a3">00677</a> <span class="preprocessor">#define QUERY_VALUE_BUFFER 80</span>
00678 <span class="preprocessor"></span>
00679 <span class="comment">/*</span>
00680 <span class="comment"> * Install hack.</span>
00681 <span class="comment"> *</span>
00682 <span class="comment"> * We have a hack inherited from Chicago that allows the shell to</span>
00683 <span class="comment"> * clean up registry information after a setup program runs.  A</span>
00684 <span class="comment"> * setup program is defined as an app with one of a list of names. -- FritzS</span>
00685 <span class="comment"> */</span>
00686 
<a name="l00687"></a><a class="code" href="../../d6/d3/queue_8c.html#a13">00687</a> PUNICODE_STRING <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a8">gpastrSetupExe</a>;    <span class="comment">// These are initialized in the routine</span>
<a name="l00688"></a><a class="code" href="../../d6/d3/queue_8c.html#a14">00688</a> <span class="keywordtype">int</span> <a class="code" href="../../d6/d3/queue_8c.html#a14">giSetupExe</a>;                    <span class="comment">// CreateSetupNameArray in setup.c</span>
00689 
00690 
00691 <span class="comment">/***************************************************************************\</span>
00692 <span class="comment">* SetAppImeCompatFlags - NOTE pstrModName-&gt;Buffer must be zero terminated.</span>
00693 <span class="comment">*</span>
00694 <span class="comment">*</span>
00695 <span class="comment">* History:</span>
00696 <span class="comment">* 07-17-97 DaveHart Split from SetAppCompatFlags -- misleadingly it also</span>
00697 <span class="comment">*                   returns a BOOL indicating whether the filename is</span>
00698 <span class="comment">*                   recognized as a setup program.  Used by SetAppCompatFlags</span>
00699 <span class="comment">*                   for 32-bit apps and zzzInitTask for 16-bit ones.</span>
00700 <span class="comment">\***************************************************************************/</span>
00701 
<a name="l00702"></a><a class="code" href="../../d6/d3/queue_8c.html#a32">00702</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d3/queue_8c.html#a32">SetAppImeCompatFlags</a>(
00703     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti,
00704     PUNICODE_STRING pstrModName,
00705     PUNICODE_STRING pstrBaseFileName)
00706 {
00707     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwImeFlags = 0;
00708     WCHAR szHex[<a class="code" href="../../d6/d3/queue_8c.html#a3">QUERY_VALUE_BUFFER</a>];
00709     WORD wPrimaryLangID;
00710     LCID lcid;
00711     <span class="keywordtype">int</span> iSetup;
00712     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fSetup = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00713     <span class="keywordtype">int</span> iAppName;
00714     <span class="keywordtype">int</span> cAppNames;
00715     PUNICODE_STRING rgpstrAppNames[2];
00716     UNICODE_STRING strHex;
00717 
00718     <span class="comment">/*</span>
00719 <span class="comment">     * Because can't access pClientInfo of another process</span>
00720 <span class="comment">     */</span>
00721     UserAssert(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a> == <a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>());
00722 
00723     <span class="comment">/*</span>
00724 <span class="comment">     * Because it is used as a zero-terminated profile key name.</span>
00725 <span class="comment">     */</span>
00726     UserAssert(0 == pstrModName-&gt;Buffer[ pstrModName-&gt;Length / <span class="keyword">sizeof</span>(WCHAR) ]);
00727 
00728     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a2007">FastGetProfileStringW</a>(
00729                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00730                 <a class="code" href="../../d4/d1/userk_8h.html#a725">PMAP_IMECOMPAT</a>,
00731                 pstrModName-&gt;Buffer,
00732                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00733                 szHex,
00734                 <span class="keyword">sizeof</span>(szHex)
00735                 )) {
00736 
00737         <span class="comment">/*</span>
00738 <span class="comment">         * Found some flags.  Attempt to convert the hex string</span>
00739 <span class="comment">         * into numeric value. Specify base 0, so</span>
00740 <span class="comment">         * RtlUnicodeStringToInteger will handle the 0x format</span>
00741 <span class="comment">         */</span>
00742         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;strHex, szHex);
00743         <a class="code" href="../../d9/d3/cnvint_8c.html#a4">RtlUnicodeStringToInteger</a>(&amp;strHex, 0, (PULONG)&amp;dwImeFlags);
00744     }
00745 
00746     <span class="comment">/*</span>
00747 <span class="comment">     * if current layout is not IME layout, Actually, we don't need to</span>
00748 <span class="comment">     * get compatible flags for IME. But now, we don't have any scheme</span>
00749 <span class="comment">     * to get this flags when the keyboard layout is switched. then</span>
00750 <span class="comment">     * we get it here, even this flags are not nessesary for non-IME</span>
00751 <span class="comment">     * keyboard layouts.</span>
00752 <span class="comment">     */</span>
00753     ZwQueryDefaultLocale(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;lcid);
00754     wPrimaryLangID = PRIMARYLANGID(lcid);
00755 
00756     <span class="keywordflow">if</span> ((wPrimaryLangID == LANG_KOREAN || wPrimaryLangID == LANG_JAPANESE) &amp;&amp;
00757             (LOWORD(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o25">dwExpWinVer</a>) &lt;= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a102">VER31</a>)) {
00758         <span class="comment">/*</span>
00759 <span class="comment">         * IME compatibility flags are needed even it's a 32 bit app</span>
00760 <span class="comment">         */</span>
00761         pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o26">dwImeCompatFlags</a> = dwImeFlags;
00762     } <span class="keywordflow">else</span> {
00763         pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o26">dwImeCompatFlags</a> = dwImeFlags &amp; (IMECOMPAT_NOFINALIZECOMPSTR | IMECOMPAT_HYDRACLIENT);
00764         <span class="keywordflow">if</span> (dwImeFlags &amp; IMECOMPAT_NOFINALIZECOMPSTR) {
00765             RIPMSG1(RIP_WARNING, <span class="stringliteral">"IMECOMPAT_NOFINALIZECOMPSTR is set to ppi=0x%p"</span>, pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>);
00766         }
00767         <span class="keywordflow">if</span> (dwImeFlags &amp; IMECOMPAT_HYDRACLIENT) {
00768             RIPMSG1(RIP_WARNING, <span class="stringliteral">"IMECOMPAT_HYDRACLIENT is set to ppi=0x%p"</span>, pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>);
00769         }
00770     }
00771 
00772 
00773     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a8">gpastrSetupExe</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00774         <span class="keywordflow">return</span> fSetup;
00775     }
00776 
00777     rgpstrAppNames[0] = pstrModName;
00778     cAppNames = 1;
00779     <span class="keywordflow">if</span> (pstrBaseFileName) {
00780         rgpstrAppNames[1] = pstrBaseFileName;
00781         cAppNames = 2;
00782     }
00783 
00784     <span class="keywordflow">for</span> (iAppName = 0;
00785          iAppName &lt; cAppNames &amp;&amp; !fSetup;
00786          iAppName++) {
00787 
00788         iSetup = 0;
00789         <span class="keywordflow">while</span> (iSetup &lt; <a class="code" href="../../d6/d3/queue_8c.html#a14">giSetupExe</a>) {
00790             <span class="keywordtype">int</span> i;
00791             <span class="keywordflow">if</span> ((i = <a class="code" href="../../d6/d6/nls_8c.html#a41">RtlCompareUnicodeString</a>(rgpstrAppNames[iAppName], &amp;(<a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a8">gpastrSetupExe</a>[iSetup]), <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) == 0) {
00792                 fSetup = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00793                 <span class="keywordflow">break</span>;
00794             }
00795             iSetup++;
00796         }
00797     }
00798 
00799     <span class="keywordflow">return</span> fSetup;
00800 }
00801 
00802 <span class="comment">/***************************************************************************\</span>
00803 <span class="comment">* SetAppCompatFlags</span>
00804 <span class="comment">*</span>
00805 <span class="comment">*</span>
00806 <span class="comment">* History:</span>
00807 <span class="comment">* 03-23-92 JimA     Created.</span>
00808 <span class="comment">* 07-17-97 FritzS   add return for fSetup -- returns TRUE if app is a setup app.</span>
00809 <span class="comment">* 09-03-97 DaveHart Split out IME, WOW doesn't use this function anymore.</span>
00810 <span class="comment">* 07-14-98 MCostea  Add Compatibility2 flags</span>
00811 <span class="comment">* 01-21-99 MCostea  Add DesiredOSVersion</span>
00812 <span class="comment">\***************************************************************************/</span>
00813 
<a name="l00814"></a><a class="code" href="../../d6/d3/queue_8c.html#a33">00814</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d3/queue_8c.html#a33">SetAppCompatFlags</a>(
00815     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti)
00816 {
00817     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> = 0;
00818     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwFlags2 = 0;
00819     WCHAR szHex[<a class="code" href="../../d6/d3/queue_8c.html#a3">QUERY_VALUE_BUFFER</a>];
00820     WCHAR szKey[90];
00821     WCHAR *pchStart, *pchEnd;
00822     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> cb;
00823     PUNICODE_STRING pstrAppName;
00824     UNICODE_STRING strKey;
00825     UNICODE_STRING strImageName;
00826     ULONG cbSize;
00827     <span class="keyword">typedef</span> <span class="keyword">struct </span>tagCompat2Key {
00828         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwCompatFlags2;
00829         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwMajorVersion;
00830         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwMinorVersion;
00831         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwBuildNumber;
00832         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwPlatformId;
00833     } COMPAT2KEY, *PCOMPAT2KEY;
00834     COMPAT2KEY Compat2Key;
00835 
00836     <span class="comment">/*</span>
00837 <span class="comment">     * Because can't access pClientInfo of another process</span>
00838 <span class="comment">     */</span>
00839     UserAssert(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a> == <a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>());
00840 
00841     UserAssert(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o1">ptiList</a>);
00842 
00843     UserAssert(!(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>));
00844 
00845     <span class="comment">/*</span>
00846 <span class="comment">     * We assume here that pti was just inserted in at the head of ptiList</span>
00847 <span class="comment">     */</span>
00848     UserAssert(pti == pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o1">ptiList</a>);
00849 
00850     <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o29">ptiSibling</a>) {
00851         pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o3">dwCompatFlags</a> = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o26">dwCompatFlags</a> = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o29">ptiSibling</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o26">dwCompatFlags</a>;
00852         pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o26">dwCompatFlags2</a> = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o27">dwCompatFlags2</a> = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o29">ptiSibling</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o27">dwCompatFlags2</a>;
00853         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00854     }
00855 
00856     <span class="keywordflow">try</span> {
00857         <span class="comment">/*</span>
00858 <span class="comment">         * PEB can be trashed from the client side, so we need to probe pointers in it</span>
00859 <span class="comment">         * MCostea 317180</span>
00860 <span class="comment">         */</span>
00861         <span class="comment">/*</span>
00862 <span class="comment">         * Find end of app name</span>
00863 <span class="comment">         */</span>
00864         <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o10">pstrAppName</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00865             pstrAppName = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o10">pstrAppName</a>;
00866         <span class="keywordflow">else</span> {
00867             <span class="keyword">struct </span>_RTL_USER_PROCESS_PARAMETERS *ProcessParameters = pti-&gt;pEThread-&gt;ThreadsProcess-&gt;Peb-&gt;ProcessParameters;
00868 
00869             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(ProcessParameters, <span class="keyword">sizeof</span>(*ProcessParameters), <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>));
00870             strImageName = <a class="code" href="../../d5/d8/ex_8h.html#a26">ProbeAndReadUnicodeString</a>(&amp;ProcessParameters-&gt;ImagePathName);
00871             <a class="code" href="../../d4/d1/userk_8h.html#a61">ProbeForReadUnicodeStringBuffer</a>(strImageName);
00872             pstrAppName = &amp;strImageName;
00873         }
00874         pchStart = pchEnd = pstrAppName-&gt;Buffer +
00875                 (pstrAppName-&gt;Length / <span class="keyword">sizeof</span>(WCHAR));
00876 
00877         <span class="comment">/*</span>
00878 <span class="comment">         * Locate start of extension</span>
00879 <span class="comment">         */</span>
00880         <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00881             <span class="keywordflow">if</span> (pchEnd == pstrAppName-&gt;Buffer) {
00882                 pchEnd = pchStart;
00883                 <span class="keywordflow">break</span>;
00884             }
00885 
00886             <span class="keywordflow">if</span> (*pchEnd == TEXT(<span class="charliteral">'.'</span>))
00887                 <span class="keywordflow">break</span>;
00888 
00889             pchEnd--;
00890         }
00891 
00892         <span class="comment">/*</span>
00893 <span class="comment">         * Locate start of filename</span>
00894 <span class="comment">         */</span>
00895         pchStart = pchEnd;
00896 
00897         <span class="keywordflow">while</span> (pchStart != pstrAppName-&gt;Buffer) {
00898             <span class="keywordflow">if</span> (*pchStart == TEXT(<span class="charliteral">'\\'</span>) || *pchStart == TEXT(<span class="charliteral">':'</span>)) {
00899                 pchStart++;
00900                 <span class="keywordflow">break</span>;
00901             }
00902 
00903             pchStart--;
00904         }
00905 
00906 <span class="preprocessor">    #define MODULESUFFIXSIZE    (8*sizeof(WCHAR))</span>
00907 <span class="preprocessor"></span><span class="preprocessor">    #define MAXMODULENAMELEN    (sizeof(szKey) - MODULESUFFIXSIZE)</span>
00908 <span class="preprocessor"></span>        <span class="comment">/*</span>
00909 <span class="comment">         * Get a copy of the filename</span>
00910 <span class="comment">         * Allow extra spaces for the 'ImageSubsystemMajorVersionMinorVersion'</span>
00911 <span class="comment">         * i.e. 3.5 that will get appended at the end of the module name</span>
00912 <span class="comment">         */</span>
00913         cb = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(pchEnd - pchStart) * <span class="keyword">sizeof</span>(WCHAR);
00914         <span class="keywordflow">if</span> (cb &gt;= <a class="code" href="../../d6/d3/queue_8c.html#a5">MAXMODULENAMELEN</a>)
00915             cb = <a class="code" href="../../d6/d3/queue_8c.html#a5">MAXMODULENAMELEN</a> - <span class="keyword">sizeof</span>(WCHAR);
00916         RtlCopyMemory(szKey, pchStart, cb);
00917     } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, RIP_ERROR)) {
00918         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00919     }
00920 
00921     szKey[(cb / <span class="keyword">sizeof</span>(WCHAR))] = 0;
00922 <span class="preprocessor">#undef MAXMODULENAMELEN</span>
00923 <span class="preprocessor"></span>
00924     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a2007">FastGetProfileStringW</a>(
00925                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00926                 <a class="code" href="../../d4/d1/userk_8h.html#a728">PMAP_COMPAT32</a>,
00927                 szKey,
00928                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00929                 szHex,
00930                 <span class="keyword">sizeof</span>(szHex)
00931                 )) {
00932 
00933         UNICODE_STRING strHex;
00934 
00935         <span class="comment">/*</span>
00936 <span class="comment">         * Found some flags.  Attempt to convert the hex string</span>
00937 <span class="comment">         * into numeric value. Specify base 0, so</span>
00938 <span class="comment">         * RtlUnicodeStringToInteger will handle the 0x format</span>
00939 <span class="comment">         */</span>
00940         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;strHex, szHex);
00941         <a class="code" href="../../d9/d3/cnvint_8c.html#a4">RtlUnicodeStringToInteger</a>(&amp;strHex, 0, (PULONG)&amp;<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>);
00942     }
00943 
00944     pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o26">dwCompatFlags</a> = <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>;
00945     pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o3">dwCompatFlags</a> = <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>;
00946 
00947     <span class="comment">/*</span>
00948 <span class="comment">     * Retrieve the image version</span>
00949 <span class="comment">     */</span>
00950     {
00951         PIMAGE_NT_HEADERS pnthdr;
00952         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> uMinorImage, uMajorImage;
00953         PWCHAR pWritePtr = szKey + cb/<span class="keyword">sizeof</span>(WCHAR);
00954 
00955         <span class="keywordflow">try</span> {
00956             pnthdr = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(pti-&gt;pEThread-&gt;ThreadsProcess-&gt;SectionBaseAddress);
00957             <span class="keywordflow">if</span> (pnthdr != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00958                 uMinorImage = pnthdr-&gt;OptionalHeader.MinorImageVersion &amp; 0xFF;
00959                 uMajorImage = pnthdr-&gt;OptionalHeader.MajorImageVersion &amp; 0xFF;
00960             } <span class="keywordflow">else</span> {
00961                 uMinorImage = uMajorImage = 0;
00962             }
00963         } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, RIP_ERROR)) {
00964             <span class="keywordflow">goto</span> Compat2Failed;
00965         }
00966         swprintf(pWritePtr, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"%u.%u"</span>, uMajorImage, uMinorImage);
00967     }
00968     cbSize = <a class="code" href="../../d4/d1/userk_8h.html#a2013">FastGetProfileValue</a>(
00969             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00970             <a class="code" href="../../d4/d1/userk_8h.html#a731">PMAP_COMPAT2</a>,
00971             szKey,
00972             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00973             (LPBYTE)&amp;Compat2Key,
00974             <span class="keyword">sizeof</span>(Compat2Key));
00975     <span class="comment">/*</span>
00976 <span class="comment">     * The first DWORD in Compat2 is the CompatFlags.  There might be or not</span>
00977 <span class="comment">     * version information but dwCompatFlags2 is always there if the key exist.</span>
00978 <span class="comment">     * We will be able to include extra data in these keys by setting the</span>
00979 <span class="comment">     * MajorVersion to zero and thus the version information will not be changed</span>
00980 <span class="comment">     */</span>
00981     <span class="keywordflow">if</span> (cbSize &gt;= <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)) {
00982         pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o27">dwCompatFlags2</a> = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o26">dwCompatFlags2</a> = Compat2Key.dwCompatFlags2;
00983 
00984         <span class="keywordflow">if</span> (cbSize &gt;= <span class="keyword">sizeof</span>(COMPAT2KEY) &amp;&amp; Compat2Key.dwMajorVersion != 0) {
00985             PPEB Peb = pti-&gt;pEThread-&gt;ThreadsProcess-&gt;Peb;
00986 
00987             Peb-&gt;OSMajorVersion = Compat2Key.dwMajorVersion;
00988             Peb-&gt;OSMinorVersion = Compat2Key.dwMinorVersion;
00989             Peb-&gt;OSBuildNumber = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(Compat2Key.dwBuildNumber);
00990             Peb-&gt;OSPlatformId = Compat2Key.dwPlatformId;
00991         }
00992     }
00993 
00994 Compat2Failed:
00995     <span class="comment">/*</span>
00996 <span class="comment">     * Restore the string</span>
00997 <span class="comment">     */</span>
00998     szKey[(cb / <span class="keyword">sizeof</span>(WCHAR))] = 0;
00999     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;strKey, szKey);
01000 
01001     <span class="keywordflow">return</span> <a class="code" href="../../d6/d3/queue_8c.html#a32">SetAppImeCompatFlags</a>(pti, &amp;strKey, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01002 }
01003 
01004 <span class="comment">/***************************************************************************\</span>
01005 <span class="comment">* GetAppCompatFlags</span>
01006 <span class="comment">*</span>
01007 <span class="comment">* Compatibility flags for &lt; Win 3.1 apps running on 3.1</span>
01008 <span class="comment">*</span>
01009 <span class="comment">* History:</span>
01010 <span class="comment">* 04-??-92 ScottLu      Created.</span>
01011 <span class="comment">* 05-04-92 DarrinM      Moved to USERRTL.DLL.</span>
01012 <span class="comment">\***************************************************************************/</span>
01013 
<a name="l01014"></a><a class="code" href="../../d6/d3/queue_8c.html#a34">01014</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d6/d3/queue_8c.html#a34">GetAppCompatFlags</a>(
01015     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti)
01016 {
01017     <span class="comment">// From GRE with pti = NULL</span>
01018     <span class="comment">// We got to use PtiCurrentShared()</span>
01019     <span class="keywordflow">if</span> (pti == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01020         pti = <a class="code" href="../../d4/d1/userk_8h.html#a10">PtiCurrentShared</a>();
01021 
01022     <span class="keywordflow">return</span> pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o26">dwCompatFlags</a>;
01023 }
01024 <span class="comment">/***************************************************************************\</span>
01025 <span class="comment">* GetAppCompatFlags2</span>
01026 <span class="comment">*</span>
01027 <span class="comment">* Compatibility flags for &lt; wVer apps</span>
01028 <span class="comment">*</span>
01029 <span class="comment">* History:</span>
01030 <span class="comment">* 07-01-98 MCostea      Created.</span>
01031 <span class="comment">\***************************************************************************/</span>
01032 
<a name="l01033"></a><a class="code" href="../../d6/d3/queue_8c.html#a35">01033</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d6/d3/queue_8c.html#a35">GetAppCompatFlags2</a>(
01034     WORD wVer)
01035 {
01036     <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1823">GetAppCompatFlags2ForPti</a>(<a class="code" href="../../d4/d1/userk_8h.html#a10">PtiCurrentShared</a>(), wVer);
01037 }
01038 
<a name="l01039"></a><a class="code" href="../../d6/d3/queue_8c.html#a36">01039</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d6/d3/queue_8c.html#a36">GetAppImeCompatFlags</a>(
01040     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti)
01041 {
01042     <span class="keywordflow">if</span> (pti == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01043         pti = <a class="code" href="../../d4/d1/userk_8h.html#a10">PtiCurrentShared</a>();
01044     }
01045 
01046     UserAssert(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>);
01047     <span class="keywordflow">return</span> pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o26">dwImeCompatFlags</a>;
01048 }
01049 
01050 <span class="comment">/***************************************************************************\</span>
01051 <span class="comment">* CheckAppStarting</span>
01052 <span class="comment">*</span>
01053 <span class="comment">* This is a timer proc (see SetAppStarting) which removes ppi's from the</span>
01054 <span class="comment">*  starting list once their initialization time has expired.</span>
01055 <span class="comment">*</span>
01056 <span class="comment">* History:</span>
01057 <span class="comment">* 08/26/97 GerardoB     Created</span>
01058 <span class="comment">\***************************************************************************/</span>
<a name="l01059"></a><a class="code" href="../../d6/d3/queue_8c.html#a37">01059</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d6/d3/queue_8c.html#a37">CheckAppStarting</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, UINT message, UINT_PTR nID, LPARAM lParam)
01060 {
01061     LARGE_INTEGER liStartingTimeout;
01062     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> *pppi = &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a109">gppiStarting</a>;
01063 
01064     <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a>(&amp;liStartingTimeout); <span class="comment">/* 1 unit == 100ns */</span>
01065     liStartingTimeout.QuadPart -= (LONGLONG)(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a915">CMSAPPSTARTINGTIMEOUT</a> * 10000);
01066     <span class="keywordflow">while</span> (*pppi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01067         <span class="keywordflow">if</span> (liStartingTimeout.QuadPart  &gt; (*pppi)-&gt;Process-&gt;CreateTime.QuadPart) {
01068             (*pppi)-&gt;W32PF_Flags &amp;= ~(W32PF_APPSTARTING | W32PF_ALLOWFOREGROUNDACTIVATE);
01069             TAGMSG1(DBGTAG_FOREGROUND, <span class="stringliteral">"CheckAppStarting clear W32PF %#p"</span>, *pppi);
01070             *pppi = (*pppi)-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o7">ppiNext</a>;
01071         } <span class="keywordflow">else</span> {
01072             pppi = &amp;(*pppi)-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o7">ppiNext</a>;
01073         }
01074     }
01075 
01076     TAGMSG0(DBGTAG_FOREGROUND, <span class="stringliteral">"Removing all entries from ghCanActivateForegroundPIDs array"</span>);
01077     RtlZeroMemory(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a359">ghCanActivateForegroundPIDs</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a359">ghCanActivateForegroundPIDs</a>));
01078     <span class="keywordflow">return</span>;
01079     UNREFERENCED_PARAMETER(pwnd);
01080     UNREFERENCED_PARAMETER(message);
01081     UNREFERENCED_PARAMETER(nID);
01082     UNREFERENCED_PARAMETER(lParam);
01083 }
01084 <span class="comment">/***************************************************************************\</span>
01085 <span class="comment">* SetAppStarting</span>
01086 <span class="comment">*</span>
01087 <span class="comment">* Add a process to the starting list and mark it as such. The process will</span>
01088 <span class="comment">*  remain in the list until it activates a window, our timer goes off or the</span>
01089 <span class="comment">*  process goes away, whichever happens first.</span>
01090 <span class="comment">*</span>
01091 <span class="comment">* History:</span>
01092 <span class="comment">* 08/26/97 GerardoB     Created</span>
01093 <span class="comment">\***************************************************************************/</span>
<a name="l01094"></a><a class="code" href="../../d6/d3/queue_8c.html#a25">01094</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d3/queue_8c.html#a25">SetAppStarting</a> (<a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppi)
01095 {
01096     <span class="keyword">static</span> UINT_PTR guAppStartingId = 0;
01097 
01098     <span class="comment">// This ppi had better not be in the list already, or we will be creating</span>
01099     <span class="comment">// a loop (as seen in stress)</span>
01100     UserAssert((ppi-&gt;W32PF_Flags &amp; W32PF_APPSTARTING) == 0);
01101 
01102     <span class="comment">/*</span>
01103 <span class="comment">     * if we add this to the gppiStartingList without this bit set, we will</span>
01104 <span class="comment">     * skip removing it from the list in DestroyProcessInfo(), but continue</span>
01105 <span class="comment">     * to free it in FreeW32Process called by W32pProcessCallout</span>
01106 <span class="comment">     */</span>
01107     UserAssert((ppi-&gt;W32PF_Flags &amp; W32PF_PROCESSCONNECTED));
01108 
01109     ppi-&gt;W32PF_Flags |= W32PF_APPSTARTING;
01110     ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o7">ppiNext</a> = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a109">gppiStarting</a>;
01111     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a109">gppiStarting</a> = ppi;
01112     <span class="comment">/*</span>
01113 <span class="comment">     * Some system processes are initialized before the RIT has setup the master</span>
01114 <span class="comment">     *  timer; so check for it</span>
01115 <span class="comment">     */</span>
01116     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a248">gptmrMaster</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01117         guAppStartingId = <a class="code" href="../../d4/d1/userk_8h.html#a1044">InternalSetTimer</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, guAppStartingId,
01118                                            <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a915">CMSAPPSTARTINGTIMEOUT</a> + <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a912">CMSHUNGAPPTIMEOUT</a>,
01119                                            <a class="code" href="../../d6/d3/queue_8c.html#a37">CheckAppStarting</a>, TMRF_RIT | TMRF_ONESHOT);
01120     }
01121 }
01122 <span class="comment">/***************************************************************************\</span>
01123 <span class="comment">* ClearAppStarting</span>
01124 <span class="comment">*</span>
01125 <span class="comment">* Remove a process from the app starting list and clear the W32PF_APPSTARTING</span>
01126 <span class="comment">* flag. No major action here, just a centralized place to take care of this.</span>
01127 <span class="comment">*</span>
01128 <span class="comment">* History:</span>
01129 <span class="comment">* 08/26/97 GerardoB     Created</span>
01130 <span class="comment">\***************************************************************************/</span>
<a name="l01131"></a><a class="code" href="../../d4/d1/userk_8h.html#a1832">01131</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1832">ClearAppStarting</a> (<a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppi)
01132 {
01133     <a class="code" href="../../d4/d1/userk_8h.html#a752">REMOVE_FROM_LIST</a>(<a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PROCESSINFO</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a109">gppiStarting</a>, ppi, ppiNext);
01134     ppi-&gt;W32PF_Flags &amp;= ~W32PF_APPSTARTING;
01135 }
01136 
01137 <span class="comment">/***************************************************************************\</span>
01138 <span class="comment">* zzzInitTask -- called by WOW startup for each app</span>
01139 <span class="comment">*</span>
01140 <span class="comment">*</span>
01141 <span class="comment">* History:</span>
01142 <span class="comment">* 02-21-91 MikeHar  Created.</span>
01143 <span class="comment">* 02-23-92 MattFe   Altered for WOW</span>
01144 <span class="comment">* 09-03-97 DaveHart WOW supplies compat flags, we tell it about setup apps.</span>
01145 <span class="comment">\***************************************************************************/</span>
01146 
<a name="l01147"></a><a class="code" href="../../d4/d1/userk_8h.html#a1193">01147</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d4/d1/userk_8h.html#a1193">zzzInitTask</a>(
01148     UINT dwExpWinVer,
01149     DWORD dwAppCompatFlags,
01150     PUNICODE_STRING pstrModName,
01151     PUNICODE_STRING pstrBaseFileName,
01152     DWORD hTaskWow,
01153     DWORD dwHotkey,
01154     DWORD idTask,
01155     DWORD dwX,
01156     DWORD dwY,
01157     DWORD dwXSize,
01158     DWORD dwYSize)
01159 {
01160     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent;
01161     <a class="code" href="../../d0/d8/structtagTDB.html">PTDB</a> ptdb;
01162     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppi;
01163     <a class="code" href="../../d8/d9/structtagWOWTHREADINFO.html">PWOWTHREADINFO</a> pwti;
01164 
01165     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
01166     ppi = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>;
01167 
01168     <span class="comment">/*</span>
01169 <span class="comment">     * Set the real name of the module.  (Instead of 'NTVDM')</span>
01170 <span class="comment">     * We've already probed pstrModName-&gt;Buffer for Length+sizeof(WCHAR) so</span>
01171 <span class="comment">     * we can copy the UNICODE_NULL terminator as well.</span>
01172 <span class="comment">     */</span>
01173     <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o10">pstrAppName</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01174         UserFreePool(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o10">pstrAppName</a>);
01175     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o10">pstrAppName</a> = UserAllocPoolWithQuota(<span class="keyword">sizeof</span>(UNICODE_STRING) +
01176             pstrModName-&gt;Length + <span class="keyword">sizeof</span>(WCHAR), TAG_TEXT);
01177     <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o10">pstrAppName</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01178         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o10">pstrAppName</a>-&gt;Buffer = (PWCHAR)(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o10">pstrAppName</a> + 1);
01179         <span class="keywordflow">try</span> {
01180             RtlCopyMemory(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o10">pstrAppName</a>-&gt;Buffer, pstrModName-&gt;Buffer,
01181                     pstrModName-&gt;Length);
01182             ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o10">pstrAppName</a>-&gt;Buffer[pstrModName-&gt;Length / <span class="keyword">sizeof</span>(WCHAR)] = 0;
01183         } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, RIP_WARNING)) {
01184             UserFreePool(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o10">pstrAppName</a>);
01185             ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o10">pstrAppName</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01186             <span class="keywordflow">return</span> STATUS_OBJECT_NAME_INVALID;
01187         }
01188         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o10">pstrAppName</a>-&gt;MaximumLength = pstrModName-&gt;Length + <span class="keyword">sizeof</span>(WCHAR);
01189         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o10">pstrAppName</a>-&gt;Length = pstrModName-&gt;Length;
01190     } <span class="keywordflow">else</span>
01191         <span class="keywordflow">return</span> STATUS_OBJECT_NAME_INVALID;
01192 
01193     <span class="comment">/*</span>
01194 <span class="comment">     * An app is starting!</span>
01195 <span class="comment">     */</span>
01196     <span class="keywordflow">if</span> (!(ppi-&gt;W32PF_Flags &amp; W32PF_APPSTARTING)) {
01197         <a class="code" href="../../d6/d3/queue_8c.html#a25">SetAppStarting</a>(ppi);
01198     }
01199 
01200     <span class="comment">/*</span>
01201 <span class="comment">     * We never want to use the ShowWindow defaulting mechanism for WOW</span>
01202 <span class="comment">     * apps.  If STARTF_USESHOWWINDOW was set in the client-side</span>
01203 <span class="comment">     * STARTUPINFO structure, WOW has already picked it up and used</span>
01204 <span class="comment">     * it for the first (command-line) app.</span>
01205 <span class="comment">     */</span>
01206     ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o28">usi</a>.<a class="code" href="../../d0/d9/structtagUSERSTARTUPINFO.html#o5">dwFlags</a> &amp;= ~STARTF_USESHOWWINDOW;
01207 
01208     <span class="comment">/*</span>
01209 <span class="comment">     * If WOW passed us a hotkey for this app, save it for CreateWindow's use.</span>
01210 <span class="comment">     */</span>
01211     <span class="keywordflow">if</span> (dwHotkey != 0) {
01212         ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o17">dwHotkey</a> = dwHotkey;
01213     }
01214 
01215     <span class="comment">/*</span>
01216 <span class="comment">     * If WOW passed us a non-default window position use it, otherwise clear it.</span>
01217 <span class="comment">     */</span>
01218     ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o28">usi</a>.<a class="code" href="../../d0/d9/structtagUSERSTARTUPINFO.html#o0">cb</a> = <span class="keyword">sizeof</span>(ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o28">usi</a>);
01219 
01220     <span class="keywordflow">if</span> (dwX == CW_USEDEFAULT || dwX == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a770">CW2_USEDEFAULT</a>) {
01221         ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o28">usi</a>.<a class="code" href="../../d0/d9/structtagUSERSTARTUPINFO.html#o5">dwFlags</a> &amp;= ~STARTF_USEPOSITION;
01222     } <span class="keywordflow">else</span> {
01223         ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o28">usi</a>.<a class="code" href="../../d0/d9/structtagUSERSTARTUPINFO.html#o5">dwFlags</a> |= STARTF_USEPOSITION;
01224         ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o28">usi</a>.<a class="code" href="../../d0/d9/structtagUSERSTARTUPINFO.html#o1">dwX</a> = dwX;
01225         ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o28">usi</a>.<a class="code" href="../../d0/d9/structtagUSERSTARTUPINFO.html#o2">dwY</a> = dwY;
01226     }
01227 
01228     <span class="comment">/*</span>
01229 <span class="comment">     * If WOW passed us a non-default window size use it, otherwise clear it.</span>
01230 <span class="comment">     */</span>
01231     <span class="keywordflow">if</span> (dwXSize == CW_USEDEFAULT || dwXSize == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a770">CW2_USEDEFAULT</a>) {
01232         ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o28">usi</a>.<a class="code" href="../../d0/d9/structtagUSERSTARTUPINFO.html#o5">dwFlags</a> &amp;= ~STARTF_USESIZE;
01233     } <span class="keywordflow">else</span> {
01234         ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o28">usi</a>.<a class="code" href="../../d0/d9/structtagUSERSTARTUPINFO.html#o5">dwFlags</a> |= STARTF_USESIZE;
01235         ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o28">usi</a>.<a class="code" href="../../d0/d9/structtagUSERSTARTUPINFO.html#o3">dwXSize</a> = dwXSize;
01236         ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o28">usi</a>.<a class="code" href="../../d0/d9/structtagUSERSTARTUPINFO.html#o4">dwYSize</a> = dwYSize;
01237     }
01238 
01239     <span class="comment">/*</span>
01240 <span class="comment">     * Alloc and Link in new task into the task list</span>
01241 <span class="comment">     */</span>
01242     <span class="keywordflow">if</span> ((ptdb = (<a class="code" href="../../d0/d8/structtagTDB.html">PTDB</a>)UserAllocPoolWithQuota(<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d8/structtagTDB.html">TDB</a>), TAG_WOWTDB)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01243         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01244     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o22">ptdb</a> = ptdb;
01245 
01246     <span class="comment">/*</span>
01247 <span class="comment">     * Set the flags to say this is a 16-bit thread - before attaching</span>
01248 <span class="comment">     * queues!</span>
01249 <span class="comment">     */</span>
01250     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a807">TIF_FIRSTIDLE</a>;
01251 
01252     <span class="comment">/*</span>
01253 <span class="comment">     * If this task is running in the shared WOW VDM, we handle</span>
01254 <span class="comment">     * WaitForInputIdle a little differently than separate WOW</span>
01255 <span class="comment">     * VDMs.  This is because CreateProcess returns a real process</span>
01256 <span class="comment">     * handle when you start a separate WOW VDM, so the "normal"</span>
01257 <span class="comment">     * WaitForInputIdle works.  For the shared WOW VDM, CreateProcess</span>
01258 <span class="comment">     * returns an event handle.</span>
01259 <span class="comment">     */</span>
01260     ptdb-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o4">pwti</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01261     <span class="keywordflow">if</span> (idTask) {
01262         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a806">TIF_SHAREDWOW</a>;
01263 
01264         <span class="comment">/*</span>
01265 <span class="comment">         * Look for a matching thread in the WOW thread info list.</span>
01266 <span class="comment">         */</span>
01267         <span class="keywordflow">if</span> (idTask != (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)-1) {
01268             <span class="keywordflow">for</span> (pwti = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a27">gpwtiFirst</a>; pwti != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; pwti = pwti-&gt;<a class="code" href="../../d8/d9/structtagWOWTHREADINFO.html#o0">pwtiNext</a>) {
01269                 <span class="keywordflow">if</span> (pwti-&gt;<a class="code" href="../../d8/d9/structtagWOWTHREADINFO.html#o1">idTask</a> == idTask) {
01270                     ptdb-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o4">pwti</a> = pwti;
01271                     <span class="keywordflow">break</span>;
01272                 }
01273             }
01274 <span class="preprocessor">#if DBG</span>
01275 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (pwti == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01276                 RIPMSG0(RIP_WARNING, <span class="stringliteral">"InitTask couldn't find WOW struct\n"</span>);
01277             }
01278 <span class="preprocessor">#endif</span>
01279 <span class="preprocessor"></span>        }
01280     }
01281     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o4">dwTIFlags</a> |= ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a>;
01282 
01283     <span class="comment">/*</span>
01284 <span class="comment">     * We need this thread to share the queue of other win16 apps.</span>
01285 <span class="comment">     * If we're journalling, all apps are sharing a queue, so we wouldn't</span>
01286 <span class="comment">     * want to interrupt that - so only cause queue recalculation</span>
01287 <span class="comment">     * if we aren't journalling.</span>
01288 <span class="comment">     * ptdb may be freed by DestroyTask during a callback, so defer WinEvent</span>
01289 <span class="comment">     * notifications until we don't need ptdb any more.</span>
01290 <span class="comment">     */</span>
01291     <a class="code" href="../../d4/d1/userk_8h.html#a614">DeferWinEventNotify</a>();
01292     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a418">FJOURNALRECORD</a>() &amp;&amp; !<a class="code" href="../../d4/d1/userk_8h.html#a419">FJOURNALPLAYBACK</a>())
01293         <a class="code" href="../../d4/d1/userk_8h.html#a1203">zzzReattachThreads</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01294 
01295     <span class="comment">/*</span>
01296 <span class="comment">     * Save away the 16 bit task handle: we use this later when calling</span>
01297 <span class="comment">     * wow back to close a WOW task.</span>
01298 <span class="comment">     */</span>
01299     ptdb-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o5">hTaskWow</a> = LOWORD(hTaskWow);
01300 
01301     <span class="comment">/*</span>
01302 <span class="comment">     * Setup the app start cursor for 5 second timeout.</span>
01303 <span class="comment">     */</span>
01304     <a class="code" href="../../d4/d1/userk_8h.html#a1490">zzzCalcStartCursorHide</a>((PW32PROCESS)ppi, 5000);
01305 
01306     <span class="comment">/*</span>
01307 <span class="comment">     * HIWORD: != 0 if wants proportional font</span>
01308 <span class="comment">     * LOWORD: Expected windows version (3.00 [300], 3.10 [30A], etc)</span>
01309 <span class="comment">     */</span>
01310     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o25">dwExpWinVer</a> = dwExpWinVer;
01311     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o2">dwExpWinVer</a> = dwExpWinVer;
01312 
01313     <span class="comment">/*</span>
01314 <span class="comment">     * Mark this guy and add him to the global task list so he can run.</span>
01315 <span class="comment">     */</span>
01316 <span class="preprocessor">#define NORMAL_PRIORITY_TASK 10</span>
01317 <span class="preprocessor"></span>
01318     <span class="comment">/*</span>
01319 <span class="comment">     * To be Compatible it super important that the new task run immediately</span>
01320 <span class="comment">     * Set its priority accordingly.  No other task should ever be set to</span>
01321 <span class="comment">     * CREATION priority</span>
01322 <span class="comment">     */</span>
01323     ptdb-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o2">nPriority</a> = <a class="code" href="../../d6/d3/queue_8c.html#a6">NORMAL_PRIORITY_TASK</a>;
01324     ptdb-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o1">nEvents</a> = 0;
01325     ptdb-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o3">pti</a> = ptiCurrent;
01326     ptdb-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o0">ptdbNext</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01327     ptdb-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o6">TDB_Flags</a> = 0;
01328 
01329     <a class="code" href="../../d4/d1/userk_8h.html#a1555">InsertTask</a>(ppi, ptdb);
01330     <a class="code" href="../../d4/d1/userk_8h.html#a617">zzzEndDeferWinEventNotify</a>();
01331 
01332     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o26">dwCompatFlags</a> = dwAppCompatFlags;
01333     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o3">dwCompatFlags</a> = dwAppCompatFlags;
01334 
01335     UserAssert(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o1">ptiList</a>);
01336     <span class="comment">/*</span>
01337 <span class="comment">     * We haven't captured pstrBaseFileName's buffer, we</span>
01338 <span class="comment">     * may fault touching it in SetAppImeCompatFlags.  If</span>
01339 <span class="comment">     * so the IME flags have been set already and we</span>
01340 <span class="comment">     * can safely assume it's not a setup app.</span>
01341 <span class="comment">     */</span>
01342 
01343     <span class="keywordflow">try</span> {
01344         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d3/queue_8c.html#a32">SetAppImeCompatFlags</a>(ptiCurrent, ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o10">pstrAppName</a>,
01345                              pstrBaseFileName)) {
01346             <span class="comment">/*</span>
01347 <span class="comment">             * Flag task as a setup app.</span>
01348 <span class="comment">             */</span>
01349             ptdb-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o6">TDB_Flags</a> = <a class="code" href="../../d4/d1/userk_8h.html#a374">TDBF_SETUP</a>;
01350             ppi-&gt;W32PF_Flags |= W32PF_SETUPAPP;
01351         }
01352     } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, RIP_WARNING)) {
01353     }
01354 
01355     <span class="comment">/*</span>
01356 <span class="comment">     * Force this new task to be the active task (WOW will ensure the</span>
01357 <span class="comment">     * currently running task does a Yield which will put it into the</span>
01358 <span class="comment">     * non preemptive scheduler.</span>
01359 <span class="comment">     */</span>
01360     ppi-&gt;pwpi-&gt;ptiScheduled = ptiCurrent;
01361     ppi-&gt;pwpi-&gt;CSLockCount = -1;
01362 
01363     <a class="code" href="../../d4/d1/userk_8h.html#a1561">EnterWowCritSect</a>(ptiCurrent, ppi-&gt;pwpi);
01364 
01365     <span class="comment">/*</span>
01366 <span class="comment">     * ensure app gets focus</span>
01367 <span class="comment">     */</span>
01368     <a class="code" href="../../d4/d1/userk_8h.html#a1827">zzzShowStartGlass</a>(10000);
01369 
01370     <span class="keywordflow">return</span> STATUS_SUCCESS;
01371 }
01372 
01373 <span class="comment">/***************************************************************************\</span>
01374 <span class="comment">* zzzShowStartGlass</span>
01375 <span class="comment">*</span>
01376 <span class="comment">* This routine is called by WOW when first starting or when starting an</span>
01377 <span class="comment">* additional WOW app.</span>
01378 <span class="comment">*</span>
01379 <span class="comment">* 12-07-92 ScottLu      Created.</span>
01380 <span class="comment">\***************************************************************************/</span>
01381 
<a name="l01382"></a><a class="code" href="../../d4/d1/userk_8h.html#a1827">01382</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1827">zzzShowStartGlass</a>(
01383     DWORD dwTimeout)
01384 {
01385     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppi;
01386 
01387     <span class="comment">/*</span>
01388 <span class="comment">     * If this is the first call to zzzShowStartGlass(), then the</span>
01389 <span class="comment">     * W32PF_ALLOWFOREGROUNDACTIVATE bit has already been set in the process</span>
01390 <span class="comment">     * info - we don't want to set it again because it may have been</span>
01391 <span class="comment">     * purposefully cleared when the user hit a key or mouse clicked.</span>
01392 <span class="comment">     */</span>
01393     ppi = <a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>();
01394     <span class="keywordflow">if</span> (ppi-&gt;W32PF_Flags &amp; W32PF_SHOWSTARTGLASSCALLED) {
01395         <span class="comment">/*</span>
01396 <span class="comment">         * Allow this wow app to come to the foreground. This'll be cancelled</span>
01397 <span class="comment">         * if the user mouse clicks or hits any keys.</span>
01398 <span class="comment">         */</span>
01399         <a class="code" href="../../d4/d1/userk_8h.html#a659">SET_PUDF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a647">PUDF_ALLOWFOREGROUNDACTIVATE</a>);
01400         TAGMSG0(DBGTAG_FOREGROUND, <span class="stringliteral">"zzzShowStartGlass set PUDF"</span>);
01401         ppi-&gt;W32PF_Flags |= W32PF_ALLOWFOREGROUNDACTIVATE;
01402         TAGMSG1(DBGTAG_FOREGROUND, <span class="stringliteral">"zzzShowStartGlass set W32PF %#p"</span>, ppi);
01403 }
01404     ppi-&gt;W32PF_Flags |= W32PF_SHOWSTARTGLASSCALLED;
01405 
01406     <span class="comment">/*</span>
01407 <span class="comment">     * Show the start glass cursor for this much longer.</span>
01408 <span class="comment">     */</span>
01409     <a class="code" href="../../d4/d1/userk_8h.html#a1490">zzzCalcStartCursorHide</a>((PW32PROCESS)ppi, dwTimeout);
01410 }
01411 <span class="comment">/***************************************************************************\</span>
01412 <span class="comment">* GetJournallingQueue</span>
01413 <span class="comment">*</span>
01414 <span class="comment">* 03/21/97  GerardoB     Created</span>
01415 <span class="comment">\***************************************************************************/</span>
<a name="l01416"></a><a class="code" href="../../d4/d1/userk_8h.html#a1831">01416</a> <a class="code" href="../../d7/d4/structtagQ.html">PQ</a> <a class="code" href="../../d4/d1/userk_8h.html#a1831">GetJournallingQueue</a>(<a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti)
01417 {
01418     <a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a> phook;
01419     <span class="comment">/*</span>
01420 <span class="comment">     * fail if we cannot journal this thread</span>
01421 <span class="comment">     */</span>
01422     <span class="keywordflow">if</span> ((pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a802">TIF_DONTJOURNALATTACH</a>)
01423             || (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01424 
01425         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01426     }
01427     <span class="comment">/*</span>
01428 <span class="comment">     * Get the journalling hook if any.</span>
01429 <span class="comment">     */</span>
01430     phook = <a class="code" href="../../d4/d1/userk_8h.html#a1519">PhkFirstGlobalValid</a>(pti, WH_JOURNALPLAYBACK);
01431     <span class="keywordflow">if</span> (phook == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01432         phook = <a class="code" href="../../d4/d1/userk_8h.html#a1519">PhkFirstGlobalValid</a>(pti, WH_JOURNALRECORD);
01433     }
01434     <span class="comment">/*</span>
01435 <span class="comment">     * Validate fsHooks bits.</span>
01436 <span class="comment">     */</span>
01437     UserAssert((phook == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01438                 ^ <a class="code" href="../../d6/d0/usercli_8h.html#a208">IsHooked</a>(pti, (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a510">WHF_FROM_WH</a>(WH_JOURNALPLAYBACK) | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a510">WHF_FROM_WH</a>(WH_JOURNALRECORD))));
01439 
01440     <span class="comment">/*</span>
01441 <span class="comment">     * return the queue if we found a journalling hook</span>
01442 <span class="comment">     */</span>
01443     <span class="keywordflow">return</span> ((phook == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ? <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> : <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(phook)-&gt;pq);
01444 }
01445 
01446 <span class="comment">/***************************************************************************\</span>
01447 <span class="comment">* ClearQueueServerEvent</span>
01448 <span class="comment">*</span>
01449 <span class="comment">* This function should be called when a thread needs to wait for some kind of</span>
01450 <span class="comment">*  input. This clears pEventQueueServer which means we won't return from the</span>
01451 <span class="comment">*  wait until new input of the required type arrives. Setting the wake mask</span>
01452 <span class="comment">*  controls what input will wake us up.  WOW apps skip this since their</span>
01453 <span class="comment">*  scheduler controls when they wake up.</span>
01454 <span class="comment">*</span>
01455 <span class="comment">* History:</span>
01456 <span class="comment">* 09/12/97 GerardoB     Created</span>
01457 <span class="comment">\***************************************************************************/</span>
<a name="l01458"></a><a class="code" href="../../d6/d3/queue_8c.html#a42">01458</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d3/queue_8c.html#a42">ClearQueueServerEvent</a> (WORD wWakeMask)
01459 {
01460     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
01461     UserAssert(wWakeMask != 0);
01462     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o4">fsWakeMask</a> = wWakeMask;
01463     <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o35">pEventQueueServer</a>);
01464 }
01465 <span class="comment">/***************************************************************************\</span>
01466 <span class="comment">* xxxCreateThreadInfo</span>
01467 <span class="comment">*</span>
01468 <span class="comment">* Allocate the main thread information structure</span>
01469 <span class="comment">*</span>
01470 <span class="comment">* History:</span>
01471 <span class="comment">* 03-18-95 JimA         Created.</span>
01472 <span class="comment">\***************************************************************************/</span>
01473 
<a name="l01474"></a><a class="code" href="../../d6/d3/queue_8c.html#a43">01474</a> ULONG <a class="code" href="../../d6/d3/queue_8c.html#a43">ParseReserved</a>(
01475     WCHAR *pchReserved,
01476     WCHAR *pchFind)
01477 {
01478     ULONG dw;
01479     WCHAR *pch, *pchT, ch;
01480     UNICODE_STRING uString;
01481 
01482     dw = 0;
01483     <span class="keywordflow">if</span> (pchReserved != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; (pch = wcsstr(pchReserved, pchFind)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01484         pch += wcslen(pchFind);
01485 
01486         pchT = pch;
01487         <span class="keywordflow">while</span> (*pchT &gt;= <span class="charliteral">'0'</span> &amp;&amp; *pchT &lt;= <span class="charliteral">'9'</span>)
01488             pchT++;
01489 
01490         ch = *pchT;
01491         *pchT = 0;
01492         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;uString, pch);
01493         *pchT = ch;
01494 
01495         <a class="code" href="../../d9/d3/cnvint_8c.html#a4">RtlUnicodeStringToInteger</a>(&amp;uString, 0, &amp;dw);
01496     }
01497 
01498     <span class="keywordflow">return</span> dw;
01499 }
01500 
<a name="l01501"></a><a class="code" href="../../d4/d1/userk_8h.html#a1189">01501</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d4/d1/userk_8h.html#a1189">xxxCreateThreadInfo</a>(
01502     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> pEThread,
01503     BOOL     IsSystemThread)
01504 {
01505     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>                        dwTIFlags = 0;
01506     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a>                 ppi;
01507     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>                  ptiCurrent;
01508     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>                    pEProcess = pEThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o28">ThreadsProcess</a>;
01509     <a class="code" href="../../d0/d9/structtagUSERSTARTUPINFO.html">PUSERSTARTUPINFO</a>             pusi;
01510     PRTL_USER_PROCESS_PARAMETERS ProcessParams;
01511     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a>                     pdesk = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01512     HDESK                        hdesk = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01513     HWINSTA                      hwinsta;
01514     <a class="code" href="../../d7/d4/structtagQ.html">PQ</a>                           pq;
01515     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01516     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>                         fFirstThread;
01517     PTEB                         pteb = NtCurrentTeb();
01518     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>                           tlpdesk;
01519 
01520     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
01521     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a616">IsWinEventNotifyDeferredOK</a>());
01522 
01523     <a class="code" href="../../d4/d1/userk_8h.html#a519">ValidateProcessSessionId</a>(pEProcess);
01524 
01525     <span class="comment">/*</span>
01526 <span class="comment">     * If CleanupResources was called for the last GUI thread then</span>
01527 <span class="comment">     * we should not allow any more GUI threads</span>
01528 <span class="comment">     */</span>
01529     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a325">gbCleanedUpResources</a>) {
01530         RIPMSG0(RIP_ERROR, <span class="stringliteral">"No more GUI threads should be created"</span>);
01531         <span class="keywordflow">return</span> STATUS_PROCESS_IS_TERMINATING;
01532     }
01533 
01534     <span class="comment">/*</span>
01535 <span class="comment">     * Increment the number of GUI threads in the session</span>
01536 <span class="comment">     */</span>
01537     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a360">gdwGuiThreads</a>++;
01538 
01539     <span class="comment">/*</span>
01540 <span class="comment">     * Although all threads now have a ETHREAD structure, server-side</span>
01541 <span class="comment">     * threads (RIT, Console, etc) don't have a client-server eventpair</span>
01542 <span class="comment">     * handle.  We use this to distinguish the two cases.</span>
01543 <span class="comment">     */</span>
01544 
01545     <span class="keywordflow">if</span> (IsSystemThread) {
01546         dwTIFlags = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a797">TIF_SYSTEMTHREAD</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a801">TIF_DONTATTACHQUEUE</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a817">TIF_DISABLEIME</a>;
01547     }
01548 
01549     <span class="keywordflow">if</span> (!(dwTIFlags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a797">TIF_SYSTEMTHREAD</a>) &amp;&amp; pEProcess == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a299">gpepCSRSS</a>) {
01550         dwTIFlags = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a798">TIF_CSRSSTHREAD</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a801">TIF_DONTATTACHQUEUE</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a817">TIF_DISABLEIME</a>;
01551     }
01552 
01553     ProcessParams = (pEProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o47">Peb</a> ? pEProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o47">Peb</a>-&gt;ProcessParameters : <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01554 
01555     <span class="comment">/*</span>
01556 <span class="comment">     * Locate the processinfo structure for the new thread.</span>
01557 <span class="comment">     */</span>
01558     ppi = <a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>();
01559 
01560 <span class="preprocessor">#if defined(_WIN64)</span>
01561 <span class="preprocessor"></span>    <span class="comment">/*</span>
01562 <span class="comment">     * If the process is marked as an emulated 32bit app thus,</span>
01563 <span class="comment">     * mark the thread as an emulated 32bit thread.</span>
01564 <span class="comment">     * This is to be consistent with the way WOW16 marks threads.</span>
01565 <span class="comment">     */</span>
01566     <span class="keywordflow">if</span> (ppi-&gt;W32PF_Flags &amp; W32PF_WOW64) {
01567         dwTIFlags |= <a class="code" href="../../d1/d0/inc_2user_8h.html#a796">TIF_WOW64</a>;
01568     }
01569 <span class="preprocessor">#endif //defined(_WIN64)</span>
01570 <span class="preprocessor"></span>
01571     <span class="comment">/*</span>
01572 <span class="comment">     * For Winlogon, only the first thread can have IME processing.</span>
01573 <span class="comment">     */</span>
01574     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a298">gpidLogon</a> == pEThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o12">Cid</a>.UniqueProcess) {
01575         <span class="keywordflow">if</span> (ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o1">ptiList</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01576             dwTIFlags |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a817">TIF_DISABLEIME</a>;
01577             RIPMSG1(RIP_VERBOSE, <span class="stringliteral">"WinLogon, second or other thread. pti=%x"</span>, pEThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o47">Win32Thread</a>);
01578         }
01579     }
01580 
01581     <span class="comment">/*</span>
01582 <span class="comment">     * Allocate the thread-info structure.  If it's a SYSTEMTHREAD, then</span>
01583 <span class="comment">     * make sure we have enough space for the (pwinsta) pointer.  This</span>
01584 <span class="comment">     * is referenced in (paint.c: DoPaint) to assure desktop/input can</span>
01585 <span class="comment">     * have a winsta to view.</span>
01586 <span class="comment">     */</span>
01587     ptiCurrent = (<a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>)pEThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o47">Win32Thread</a>;
01588 
01589     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> = dwTIFlags;
01590     <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o4">spklActive</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a62">gspklBaseLayout</a>);
01591     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>      = &amp;(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o52">cti</a>);
01592 
01593     <span class="comment">/*</span>
01594 <span class="comment">     * Check if no IME processing for all threads</span>
01595 <span class="comment">     * in the same process.</span>
01596 <span class="comment">     */</span>
01597     <span class="keywordflow">if</span> (ppi-&gt;W32PF_Flags &amp; W32PF_DISABLEIME)
01598         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a817">TIF_DISABLEIME</a>;
01599 
01600     <span class="comment">/*</span>
01601 <span class="comment">     * Hook up this queue to this process info structure, increment</span>
01602 <span class="comment">     * the count of threads using this process info structure. Set up</span>
01603 <span class="comment">     * the ppi before calling SetForegroundPriority().</span>
01604 <span class="comment">     */</span>
01605     UserAssert(ppi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01606 
01607     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>        = ppi;
01608     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o29">ptiSibling</a> = ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o1">ptiList</a>;
01609     ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o1">ptiList</a>    = ptiCurrent;
01610     ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o9">cThreads</a>++;
01611 
01612 
01613     <span class="keywordflow">if</span> (pteb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01614         pteb-&gt;Win32ThreadInfo = ptiCurrent;
01615 
01616     <span class="comment">/*</span>
01617 <span class="comment">     * Point to the client info.</span>
01618 <span class="comment">     */</span>
01619     <span class="keywordflow">if</span> (dwTIFlags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a797">TIF_SYSTEMTHREAD</a>) {
01620         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a> = UserAllocPoolWithQuota(<span class="keyword">sizeof</span>(<a class="code" href="../../d2/d2/struct__CLIENTINFO.html">CLIENTINFO</a>),
01621                                                   TAG_CLIENTTHREADINFO);
01622         <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01623             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
01624             <span class="keywordflow">goto</span> CreateThreadInfoFailed;
01625         }
01626     } <span class="keywordflow">else</span> {
01627         <span class="comment">/*</span>
01628 <span class="comment">         * If this is not a system thread then grab the user mode client info</span>
01629 <span class="comment">         * elsewhere we use the GetClientInfo macro which looks here</span>
01630 <span class="comment">         */</span>
01631         UserAssert(NtCurrentTeb() != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01632         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a> = ((<a class="code" href="../../d2/d2/struct__CLIENTINFO.html">PCLIENTINFO</a>)((NtCurrentTeb())-&gt;Win32ClientInfo));
01633 
01634         <span class="comment">/*</span>
01635 <span class="comment">         * set the SECURE flag in the thread flags if this is a secure process</span>
01636 <span class="comment">         */</span>
01637         <span class="keywordflow">if</span> (((PW32PROCESS)ppi)-&gt;W32PF_Flags &amp; W32PF_RESTRICTED) {
01638             ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a821">TIF_RESTRICTED</a>;
01639         }
01640     }
01641 
01642 
01643     <span class="comment">/*</span>
01644 <span class="comment">     * Create the input event.</span>
01645 <span class="comment">     */</span>
01646     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwCreateEvent(&amp;ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o34">hEventQueueClient</a>,
01647                            EVENT_ALL_ACCESS,
01648                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01649                            SynchronizationEvent,
01650                            <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01651 
01652     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01653         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o34">hEventQueueClient</a>,
01654                                            EVENT_ALL_ACCESS,
01655                                            *<a class="code" href="../../d7/d7/ntapi_8c.html#a3">ExEventObjectType</a>,
01656                                            <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>,
01657                                            &amp;ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o35">pEventQueueServer</a>,
01658                                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01659         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01660             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/userk_8h.html#a966">ProtectHandle</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o34">hEventQueueClient</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01661         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_INVALID_HANDLE) {
01662             ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o34">hEventQueueClient</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01663         }
01664     }
01665     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01666         <span class="keywordflow">goto</span> CreateThreadInfoFailed;
01667     }
01668 
01669     <span class="comment">/*</span>
01670 <span class="comment">     * Mark the process as having threads that need cleanup.  See</span>
01671 <span class="comment">     * DestroyProcessesObjects().</span>
01672 <span class="comment">     */</span>
01673     fFirstThread = !(ppi-&gt;W32PF_Flags &amp; W32PF_THREADCONNECTED);
01674     ppi-&gt;W32PF_Flags |= W32PF_THREADCONNECTED;
01675 
01676     <span class="comment">/*</span>
01677 <span class="comment">     * If we haven't copied over our startup info yet, do it now.</span>
01678 <span class="comment">     * Don't bother copying the info if we aren't going to use it.</span>
01679 <span class="comment">     */</span>
01680     <span class="keywordflow">if</span> (ProcessParams) {
01681 
01682         pusi = &amp;ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o28">usi</a>;
01683 
01684         <span class="keywordflow">if</span> ((pusi-&gt;<a class="code" href="../../d0/d9/structtagUSERSTARTUPINFO.html#o0">cb</a> == 0) &amp;&amp; (ProcessParams-&gt;WindowFlags != 0)) {
01685             pusi-&gt;<a class="code" href="../../d0/d9/structtagUSERSTARTUPINFO.html#o0">cb</a>          = <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d9/structtagUSERSTARTUPINFO.html">USERSTARTUPINFO</a>);
01686             pusi-&gt;<a class="code" href="../../d0/d9/structtagUSERSTARTUPINFO.html#o1">dwX</a>         = ProcessParams-&gt;StartingX;
01687             pusi-&gt;<a class="code" href="../../d0/d9/structtagUSERSTARTUPINFO.html#o2">dwY</a>         = ProcessParams-&gt;StartingY;
01688             pusi-&gt;<a class="code" href="../../d0/d9/structtagUSERSTARTUPINFO.html#o3">dwXSize</a>     = ProcessParams-&gt;CountX;
01689             pusi-&gt;<a class="code" href="../../d0/d9/structtagUSERSTARTUPINFO.html#o4">dwYSize</a>     = ProcessParams-&gt;CountY;
01690             pusi-&gt;<a class="code" href="../../d0/d9/structtagUSERSTARTUPINFO.html#o5">dwFlags</a>     = ProcessParams-&gt;WindowFlags;
01691             pusi-&gt;<a class="code" href="../../d0/d9/structtagUSERSTARTUPINFO.html#o6">wShowWindow</a> = (WORD)ProcessParams-&gt;ShowWindowFlags;
01692         }
01693 
01694         <span class="keywordflow">if</span> (fFirstThread) {
01695 
01696             <span class="comment">/*</span>
01697 <span class="comment">             * Set up the hot key, if there is one.</span>
01698 <span class="comment">             *</span>
01699 <span class="comment">             * If the STARTF_USEHOTKEY flag is given in the startup info, then</span>
01700 <span class="comment">             * the hStdInput is the hotkey (new from Chicago).  Otherwise, parse</span>
01701 <span class="comment">             * it out in string format from the lpReserved string.</span>
01702 <span class="comment">             */</span>
01703             <span class="keywordflow">if</span> (ProcessParams-&gt;WindowFlags &amp; STARTF_USEHOTKEY) {
01704                 ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o17">dwHotkey</a> = HandleToUlong(ProcessParams-&gt;StandardInput);
01705             } <span class="keywordflow">else</span> {
01706                 ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o17">dwHotkey</a> = <a class="code" href="../../d6/d3/queue_8c.html#a43">ParseReserved</a>(ProcessParams-&gt;ShellInfo.Buffer,
01707                                               <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"hotkey."</span>);
01708             }
01709 
01710             <span class="comment">/*</span>
01711 <span class="comment">             * Copy the monitor handle, if there is one.</span>
01712 <span class="comment">             */</span>
01713             UserAssert(!ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o18">hMonitor</a>);
01714             <span class="keywordflow">if</span> (ProcessParams-&gt;WindowFlags &amp; STARTF_HASSHELLDATA) {
01715                 HMONITOR    hMonitor;
01716 
01717                 hMonitor = (HMONITOR)(ProcessParams-&gt;StandardOutput);
01718                 <span class="keywordflow">if</span> (<a class="code" href="../../d7/d3/validate_8c.html#a10">ValidateHmonitor</a>(hMonitor)) {
01719                     ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o18">hMonitor</a> = hMonitor;
01720                 }
01721             }
01722         }
01723     }
01724 
01725     <span class="comment">/*</span>
01726 <span class="comment">     * Open the windowstation and desktop.  If this is a system</span>
01727 <span class="comment">     * thread only use the desktop that might be stored in the teb.</span>
01728 <span class="comment">     */</span>
01729     UserAssert(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01730     <span class="keywordflow">if</span> (!(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a797">TIF_SYSTEMTHREAD</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a798">TIF_CSRSSTHREAD</a>)) &amp;&amp;
01731         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a241">grpWinStaList</a>) {
01732 
01733         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bShutDown = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01734 
01735         hdesk = <a class="code" href="../../d4/d1/userk_8h.html#a1279">xxxResolveDesktop</a>(
01736                 NtCurrentProcess(),
01737                 &amp;ProcessParams-&gt;DesktopInfo,
01738                 &amp;hwinsta, (ProcessParams-&gt;WindowFlags &amp; STARTF_DESKTOPINHERIT),
01739                 &amp;bShutDown);
01740 
01741         <span class="keywordflow">if</span> (hdesk == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01742 
01743             <span class="keywordflow">if</span> (bShutDown) {
01744                 <span class="comment">/*</span>
01745 <span class="comment">                 * Trying to create a new process during logoff</span>
01746 <span class="comment">                 */</span>
01747                 ULONG_PTR adwParameters[5] = {0, 0, 0, 0, MB_DEFAULT_DESKTOP_ONLY};
01748                 ULONG ErrorResponse;
01749 
01750                 <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
01751 
01752                 <a class="code" href="../../d5/d8/ex_8h.html#a306">ExRaiseHardError</a>((<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)STATUS_DLL_INIT_FAILED_LOGOFF,
01753                                  <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a2">ARRAY_SIZE</a>(adwParameters),
01754                                  0,
01755                                  adwParameters,
01756                                  OptionOkNoWait,
01757                                  &amp;ErrorResponse);
01758 
01759                 ZwTerminateProcess(NtCurrentProcess(), STATUS_DLL_INIT_FAILED);
01760 
01761                 <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
01762             }
01763 
01764             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_DLL_INIT_FAILED;
01765             <span class="keywordflow">goto</span> CreateThreadInfoFailed;
01766 
01767         } <span class="keywordflow">else</span> {
01768 
01769             <a class="code" href="../../d8/d8/winsta_8c.html#a10">xxxSetProcessWindowStation</a>(hwinsta, <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>);
01770 
01771             <span class="comment">/*</span>
01772 <span class="comment">             * Reference the desktop handle</span>
01773 <span class="comment">             */</span>
01774             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
01775                     hdesk,
01776                     0,
01777                     *<a class="code" href="../../d3/d7/win32_8c.html#a1">ExDesktopObjectType</a>,
01778                     <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
01779                     &amp;pdesk,
01780                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01781 
01782             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01783                 UserAssert(pdesk == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01784                 <span class="keywordflow">goto</span> CreateThreadInfoFailed;
01785             }
01786 
01787             <a class="code" href="../../d4/d1/userk_8h.html#a128">ThreadLockDesktop</a>(ptiCurrent, pdesk, &amp;tlpdesk, LDLT_FN_CREATETHREADINFO);
01788 
01789             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pdesk);
01790 
01791             <span class="comment">/*</span>
01792 <span class="comment">             * The first desktop is the default for all succeeding threads.</span>
01793 <span class="comment">             */</span>
01794             <span class="keywordflow">if</span> ((ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o10">hdeskStartup</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01795                 (pEProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o7">UniqueProcessId</a> != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a298">gpidLogon</a>)) {
01796 
01797                 <a class="code" href="../../d4/d1/userk_8h.html#a126">LockDesktop</a>(&amp;ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o3">rpdeskStartup</a>, pdesk, LDL_PPI_DESKSTARTUP2, (ULONG_PTR)ppi);
01798                 ppi-&gt;hdeskStartup = hdesk;
01799             }
01800         }
01801     }
01802 
01803     <span class="comment">/*</span>
01804 <span class="comment">     * Remember dwExpWinVer. This is used to return GetAppVer() (and</span>
01805 <span class="comment">     * GetExpWinVer(NULL).</span>
01806 <span class="comment">     */</span>
01807     <span class="keywordflow">if</span> (pEProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o47">Peb</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01808         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o25">dwExpWinVer</a> = <a class="code" href="../../d1/d5/w32_2ntuser_2rtl_2random_8c.html#a0">RtlGetExpWinVer</a>(pEProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o48">SectionBaseAddress</a>);
01809     <span class="keywordflow">else</span>
01810         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o25">dwExpWinVer</a> = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a101">VER40</a>;
01811 
01812     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o2">dwExpWinVer</a> = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o25">dwExpWinVer</a>;
01813     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o4">dwTIFlags</a>   = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a>;
01814 
01815     <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o4">spklActive</a>) {
01816         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o20">CodePage</a> = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o4">spklActive</a>-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o8">CodePage</a>;
01817         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o21">hKL</a> = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o4">spklActive</a>-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o4">hkl</a>;
01818     } <span class="keywordflow">else</span> {
01819         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o20">CodePage</a> = CP_ACP;
01820         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o21">hKL</a> = 0;
01821     }
01822 
01823     <span class="comment">/*</span>
01824 <span class="comment">     * Set the desktop even if it is NULL to ensure that ptiCurrent-&gt;pDeskInfo</span>
01825 <span class="comment">     * is set.</span>
01826 <span class="comment">     * NOTE: This adds the pti to the desktop's PtiList, but we don't yet have</span>
01827 <span class="comment">     * a pti-&gt;pq. zzzRecalcThreadAttachment loops through this PtiList expects</span>
01828 <span class="comment">     * a pq, so we must not leave the critsect until we have a queue.</span>
01829 <span class="comment">     * zzzSetDesktop only zzz leaves the critsect if there is a pti-&gt;pq, so we</span>
01830 <span class="comment">     * can BEGINATOMICCHECK to ensure this, and make sure we allocate the queue</span>
01831 <span class="comment">     * before we leave the critical section.</span>
01832 <span class="comment">     */</span>
01833     <a class="code" href="../../d4/d1/userk_8h.html#a159">BEGINATOMICCHECK</a>();
01834     <a class="code" href="../../d4/d1/userk_8h.html#a1799">zzzSetDesktop</a>(ptiCurrent, pdesk, hdesk);
01835     <a class="code" href="../../d4/d1/userk_8h.html#a163">ENDATOMICCHECK</a>();
01836 
01837     <span class="comment">/*</span>
01838 <span class="comment">     * If we have a desktop and are journalling on that desktop, use</span>
01839 <span class="comment">     * the journal queue, otherwise create a new queue.</span>
01840 <span class="comment">     */</span>
01841     <span class="keywordflow">if</span> (pdesk == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>) {
01842         <a class="code" href="../../d7/d4/structtagQ.html">PQ</a> pq;
01843         UserAssert((pdesk == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o7">pDeskInfo</a> == pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>));
01844         UserAssert(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> == pdesk);
01845         pq = <a class="code" href="../../d4/d1/userk_8h.html#a1831">GetJournallingQueue</a>(ptiCurrent);
01846         <span class="keywordflow">if</span> (pq != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01847             ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a> = pq;
01848             pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o22">cThreads</a>++;
01849         }
01850     }
01851 
01852     <span class="comment">/*</span>
01853 <span class="comment">     * If not journalling, give this thread its own queue</span>
01854 <span class="comment">     */</span>
01855     <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01856         <span class="keywordflow">if</span> ((pq = <a class="code" href="../../d4/d1/userk_8h.html#a1204">AllocQueue</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01857             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
01858             <span class="keywordflow">goto</span> CreateThreadInfoFailed;
01859         }
01860         <span class="comment">/*</span>
01861 <span class="comment">         * Attach the Q to the THREADINFO.</span>
01862 <span class="comment">         */</span>
01863         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>      = pq;
01864         pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o4">ptiMouse</a> = pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o5">ptiKeyboard</a> = ptiCurrent;
01865         pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o22">cThreads</a>++;
01866     }
01867 
01868     <span class="comment">/*</span>
01869 <span class="comment">     * Remember that this is a screen saver. That way we can set its</span>
01870 <span class="comment">     * priority appropriately when it is idle or when it needs to go</span>
01871 <span class="comment">     * away.  At first we set it to normal priority, then we set the</span>
01872 <span class="comment">     * TIF_IDLESCREENSAVER bit so that when it activates it will get</span>
01873 <span class="comment">     * lowered in priority.</span>
01874 <span class="comment">     */</span>
01875     <span class="keywordflow">if</span> (ProcessParams &amp;&amp; ProcessParams-&gt;WindowFlags &amp; STARTF_SCREENSAVER) {
01876 
01877         <span class="keywordflow">if</span> (fFirstThread) {
01878             UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a158">gppiScreenSaver</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01879 
01880             <span class="comment">/*</span>
01881 <span class="comment">             * Make sure the parent's process is WinLogon, since only WinLogon is allowed to</span>
01882 <span class="comment">             * use the STARTF_SCREENSAVER flag.</span>
01883 <span class="comment">             */</span>
01884             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a298">gpidLogon</a> == 0 || pEProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o53">InheritedFromUniqueProcessId</a> != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a298">gpidLogon</a>) {
01885                 RIPMSG0(RIP_WARNING,<span class="stringliteral">"Only the Logon process can launch a screen saver."</span>);
01886                 ProcessParams-&gt;WindowFlags &amp;= ~STARTF_SCREENSAVER;
01887                 <span class="keywordflow">goto</span> NotAScreenSaver;
01888             }
01889 
01890             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a158">gppiScreenSaver</a> = ppi;
01891             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a159">gptSSCursor</a> = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;ptCursor;
01892             ppi-&gt;W32PF_Flags |= W32PF_SCREENSAVER;
01893         }
01894 <span class="preprocessor">#if DBG</span>
01895 <span class="preprocessor"></span>        <span class="keywordflow">else</span> {
01896             UserAssert(ppi-&gt;W32PF_Flags &amp; W32PF_SCREENSAVER);
01897         }
01898 <span class="preprocessor">#endif</span>
01899 <span class="preprocessor"></span>
01900         <a class="code" href="../../d4/d1/userk_8h.html#a1334">SetForegroundPriority</a>(ptiCurrent, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01901 
01902         <span class="keywordflow">if</span> (fFirstThread) {
01903             ppi-&gt;W32PF_Flags |= W32PF_IDLESCREENSAVER;
01904         }
01905 
01906         <span class="comment">/*</span>
01907 <span class="comment">         * Screen saver doesn't need any IME processing.</span>
01908 <span class="comment">         */</span>
01909         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a817">TIF_DISABLEIME</a>;
01910     }
01911 
01912 NotAScreenSaver:
01913 
01914     <span class="comment">/*</span>
01915 <span class="comment">     * Do special processing for the first thread of a process.</span>
01916 <span class="comment">     */</span>
01917     <span class="keywordflow">if</span> (!(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a797">TIF_SYSTEMTHREAD</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a798">TIF_CSRSSTHREAD</a>))) {
01918 
01919         <span class="comment">/*</span>
01920 <span class="comment">         * I changed the code a while ago to unregister classes when the last</span>
01921 <span class="comment">         * GUI thread is destroyed.  Simply, there was too much stuff getting</span>
01922 <span class="comment">         * unlocked and destroyed to guarantee that it would work on a non-GUI</span>
01923 <span class="comment">         * thread.  So if a process destroys its last GUI thread and then makes</span>
01924 <span class="comment">         * a thread GUI later, we need to re-register the classes.</span>
01925 <span class="comment">         */</span>
01926 
01927         <span class="keywordflow">if</span> (!(ppi-&gt;W32PF_Flags &amp; W32PF_CLASSESREGISTERED)) {
01928             <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1492">LW_RegisterWindows</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
01929                 RIPMSG0(RIP_WARNING, <span class="stringliteral">"xxxCreateThreadInfo: LW_RegisterWindows failed"</span>);
01930                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
01931                 <span class="keywordflow">goto</span> CreateThreadInfoFailed;
01932             }
01933             ppi-&gt;W32PF_Flags |= W32PF_CLASSESREGISTERED;
01934             <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>) {
01935                 ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o0">CI_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a117">CI_REGISTERCLASSES</a>;
01936             }
01937         }
01938 
01939         <span class="keywordflow">if</span> (fFirstThread) {
01940 
01941             <span class="comment">/*</span>
01942 <span class="comment">             * If this is an application starting (ie. not some thread of</span>
01943 <span class="comment">             * the server context), enable the app-starting cursor.</span>
01944 <span class="comment">             */</span>
01945             <a class="code" href="../../d4/d1/userk_8h.html#a614">DeferWinEventNotify</a>();
01946             <a class="code" href="../../d4/d1/userk_8h.html#a1490">zzzCalcStartCursorHide</a>((PW32PROCESS)pEProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o72">Win32Process</a>, 5000);
01947             <a class="code" href="../../d4/d1/userk_8h.html#a618">EndDeferWinEventNotifyWithoutProcessing</a>();
01948 
01949             <span class="comment">/*</span>
01950 <span class="comment">             * Open the windowstation</span>
01951 <span class="comment">             */</span>
01952             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a241">grpWinStaList</a> &amp;&amp; ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o14">rpwinsta</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01953                 RIPERR0(ERROR_CAN_NOT_COMPLETE, RIP_WARNING, <span class="stringliteral">"System is not initialized\n"</span>);
01954                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
01955                 <span class="keywordflow">goto</span> CreateThreadInfoFailed;
01956             }
01957         }
01958     } <span class="keywordflow">else</span> {
01959 
01960         <span class="comment">/*</span>
01961 <span class="comment">         * Don't register system windows until cursors and icons</span>
01962 <span class="comment">         * have been loaded.</span>
01963 <span class="comment">         */</span>
01964         <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d1/userk_8h.html#a321">SYSCUR</a>(ARROW) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01965                 !(ppi-&gt;W32PF_Flags &amp; W32PF_CLASSESREGISTERED)) {
01966 
01967             ppi-&gt;W32PF_Flags |= W32PF_CLASSESREGISTERED;
01968             <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1492">LW_RegisterWindows</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a797">TIF_SYSTEMTHREAD</a>)) {
01969                 RIPMSG0(RIP_WARNING, <span class="stringliteral">"xxxCreateThreadInfo: LW_RegisterWindows failed"</span>);
01970                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
01971                 <span class="keywordflow">goto</span> CreateThreadInfoFailed;
01972             }
01973         }
01974     }
01975 
01976 
01977     <span class="comment">/*</span>
01978 <span class="comment">     * Initialize hung timer value</span>
01979 <span class="comment">     */</span>
01980 
01981     <a class="code" href="../../d4/d1/userk_8h.html#a257">SET_TIME_LAST_READ</a>(ptiCurrent);
01982 
01983     <span class="comment">/*</span>
01984 <span class="comment">     * If someone is waiting on this process propagate that info into</span>
01985 <span class="comment">     * the thread info</span>
01986 <span class="comment">     */</span>
01987     <span class="keywordflow">if</span> (ppi-&gt;W32PF_Flags &amp; W32PF_WAITFORINPUTIDLE)
01988         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a808">TIF_WAITFORINPUTIDLE</a>;
01989 
01990     <span class="comment">/*</span>
01991 <span class="comment">     * Mark the thread as initialized.</span>
01992 <span class="comment">     */</span>
01993     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a816">TIF_GUITHREADINITIALIZED</a>;
01994 
01995     <span class="comment">/*</span>
01996 <span class="comment">     * Allow the thread to come to foreground when it is created</span>
01997 <span class="comment">     * if the current process is the foreground process or the last input owner</span>
01998 <span class="comment">     * This Flag is a hack to fix Bug 28502.  When we click on</span>
01999 <span class="comment">     * "Map Network Drive" button on the toolbar, the explorer (Bobday)</span>
02000 <span class="comment">     * creates another thread to create the dialog box. This will create</span>
02001 <span class="comment">     * the dialog in the background. We are adding this fix at the request</span>
02002 <span class="comment">     * of the Shell team so that this dialog comes up as foreground.</span>
02003 <span class="comment">     *</span>
02004 <span class="comment">     * If the process already has the foreground right, we don't give it</span>
02005 <span class="comment">     *  to this thread (it doesn't need it). We do this to narrow the number</span>
02006 <span class="comment">     *  of ways this process can force the foreground.</span>
02007 <span class="comment">     * Also, if the process is starting, it already has the right unless</span>
02008 <span class="comment">     *  the user has canceled it -- in which case we don't want to give it back.</span>
02009 <span class="comment">     *</span>
02010 <span class="comment">     */</span>
02011      <span class="keywordflow">if</span> (!(ppi-&gt;W32PF_Flags &amp; (W32PF_ALLOWFOREGROUNDACTIVATE | W32PF_APPSTARTING))) {
02012          <span class="keywordflow">if</span> (((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a25">gptiForeground</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (ppi == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a25">gptiForeground</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>))
02013                 || ((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a78">glinp</a>.<a class="code" href="../../d5/d9/structtagLASTINPUT.html#o2">ptiLastWoken</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (ppi == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a78">glinp</a>.<a class="code" href="../../d5/d9/structtagLASTINPUT.html#o2">ptiLastWoken</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>))) {
02014 
02015             ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a800">TIF_ALLOWFOREGROUNDACTIVATE</a>;
02016             TAGMSG1(DBGTAG_FOREGROUND, <span class="stringliteral">"xxxCreateThreadInfo set TIF %#p"</span>, ptiCurrent);
02017          }
02018      }
02019 
02020     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a126">IS_IME_ENABLED</a>()) {
02021         <span class="comment">/*</span>
02022 <span class="comment">         * Create per-thread default input context</span>
02023 <span class="comment">         */</span>
02024         <a class="code" href="../../d4/d1/userk_8h.html#a2030">CreateInputContext</a>(0);
02025     }
02026 
02027     <span class="comment">/*</span>
02028 <span class="comment">     * Call back to the client to finish initialization.</span>
02029 <span class="comment">     */</span>
02030     <span class="keywordflow">if</span> (!(dwTIFlags &amp; (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a797">TIF_SYSTEMTHREAD</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a798">TIF_CSRSSTHREAD</a>))) {
02031 
02032         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d3/queue_8c.html#a33">SetAppCompatFlags</a>(ptiCurrent)) {
02033             <span class="comment">/*</span>
02034 <span class="comment">             * Flag this process as a setup app.</span>
02035 <span class="comment">             */</span>
02036             ppi-&gt;W32PF_Flags |= W32PF_SETUPAPP;
02037         }
02038 
02039         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1927">ClientThreadSetup</a>();
02040         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02041             RIPMSG1(RIP_WARNING, <span class="stringliteral">"ClientThreadSetup failed with NTSTATUS %lx"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02042             <span class="keywordflow">goto</span> CreateThreadInfoFailed;
02043         }
02044     }
02045 
02046     <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) &amp;&amp; fFirstThread) &amp;&amp;
02047         !(ppi-&gt;W32PF_Flags &amp; W32PF_CONSOLEAPPLICATION)) {
02048 
02049         <span class="comment">/*</span>
02050 <span class="comment">         * Don't play the sound for console processes</span>
02051 <span class="comment">         * since we will play it when the console window</span>
02052 <span class="comment">         * will be created</span>
02053 <span class="comment">         */</span>
02054         <a class="code" href="../../d4/d1/userk_8h.html#a1731">PlayEventSound</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a926">USER_SOUND_OPEN</a>);
02055     }
02056 
02057     <span class="comment">/*</span>
02058 <span class="comment">     * Release desktop.</span>
02059 <span class="comment">     * Some other thread might have been waiting to destroy this desktop</span>
02060 <span class="comment">     *  when xxxResolveDestktop got a handle to it. So let's double</span>
02061 <span class="comment">     *  check this now that we have called back several times after getting</span>
02062 <span class="comment">     *  the handle back.</span>
02063 <span class="comment">     */</span>
02064     <span class="keywordflow">if</span> (pdesk != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02065         <span class="keywordflow">if</span> (pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o4">dwDTFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a287">DF_DESTROYED</a>) {
02066             RIPMSG1(RIP_WARNING, <span class="stringliteral">"xxxCreateThreadInfo: pdesk destroyed:%#p"</span>, pdesk);
02067             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
02068             <span class="keywordflow">goto</span> CreateThreadInfoFailed;
02069         }
02070         <a class="code" href="../../d4/d1/userk_8h.html#a130">ThreadUnlockDesktop</a>(ptiCurrent, &amp;tlpdesk, LDUT_FN_CREATETHREADINFO1);
02071     }
02072 
02073     <span class="comment">// We must return a success here. If the failure status is returned</span>
02074     <span class="comment">// W32Thread will be freed without us going thru xxxDestroyProcessInfo.</span>
02075     UserAssert(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
02076 
02077     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02078 
02079 CreateThreadInfoFailed:
02080 
02081     RIPMSG2(RIP_WARNING, <span class="stringliteral">"xxxCreateThreadInfo: failed: pti %#p pdesk %#p"</span>,
02082             ptiCurrent, pdesk);
02083 
02084     <span class="keywordflow">if</span> (pdesk != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02085         <a class="code" href="../../d4/d1/userk_8h.html#a130">ThreadUnlockDesktop</a>(ptiCurrent, &amp;tlpdesk, LDUT_FN_CREATETHREADINFO2);
02086     }
02087     <a class="code" href="../../d4/d1/userk_8h.html#a1885">xxxDestroyThreadInfo</a>();
02088     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02089 }
02090 
02091 <span class="comment">/***************************************************************************\</span>
02092 <span class="comment">* AllocQueue</span>
02093 <span class="comment">*</span>
02094 <span class="comment">* Allocates the memory for a TI structure and initializes its fields.</span>
02095 <span class="comment">* Each Win32 queue has it's own TI while all Win16 threads share the same</span>
02096 <span class="comment">* TI.</span>
02097 <span class="comment">*</span>
02098 <span class="comment">* History:</span>
02099 <span class="comment">* 02-21-91 MikeHar      Created.</span>
02100 <span class="comment">\***************************************************************************/</span>
02101 
<a name="l02102"></a><a class="code" href="../../d4/d1/userk_8h.html#a1204">02102</a> <a class="code" href="../../d7/d4/structtagQ.html">PQ</a> <a class="code" href="../../d4/d1/userk_8h.html#a1204">AllocQueue</a>(
02103     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiKeyState,    <span class="comment">// if non-Null then use this key state</span>
02104                                 <span class="comment">// other wise use global AsyncKeyState</span>
02105     <a class="code" href="../../d7/d4/structtagQ.html">PQ</a> pq)                      <span class="comment">// non-null == preallocated object</span>
02106 {
02107     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> cLockCount;
02108 
02109     <span class="keywordflow">if</span> (pq == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02110         pq = <a class="code" href="../../d5/d8/ex_8h.html#a252">ExAllocateFromPagedLookasideList</a>(<a class="code" href="../../d6/d3/queue_8c.html#a11">QLookaside</a>);
02111         <span class="keywordflow">if</span> (pq == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02112             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02113         }
02114         cLockCount = 0;
02115     } <span class="keywordflow">else</span> {
02116         <a class="code" href="../../d6/d3/queue_8c.html#a1">DebugValidateMLIST</a>(&amp;pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o0">mlInput</a>);
02117         <span class="comment">/*</span>
02118 <span class="comment">         * Preserve lock count.</span>
02119 <span class="comment">         */</span>
02120         cLockCount = pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o23">cLockCount</a>;
02121     }
02122     RtlZeroMemory(pq, <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d4/structtagQ.html">Q</a>));
02123     pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o23">cLockCount</a> = cLockCount;
02124 
02125     <span class="comment">/*</span>
02126 <span class="comment">     * This is a new queue; we need to update its key state table before</span>
02127 <span class="comment">     * the first input event is put in the queue.</span>
02128 <span class="comment">     * We do this by copying the current keystate table and NULLing the recent</span>
02129 <span class="comment">     * down state table.  If a key is really down it will be updated when</span>
02130 <span class="comment">     * we get it repeats.</span>
02131 <span class="comment">     *</span>
02132 <span class="comment">     * He is the old way that did not work because if the first key was say an</span>
02133 <span class="comment">     * alt key the Async table would be updated, then the UpdateKeyState</span>
02134 <span class="comment">     * message and it would look like the alt key was PREVIOUSLY down.</span>
02135 <span class="comment">     *</span>
02136 <span class="comment">     * The queue will get updated when it first reads input: to allow the</span>
02137 <span class="comment">     * app to query the key state before it calls GetMessage, set its initial</span>
02138 <span class="comment">     * key state to the asynchronous key state.</span>
02139 <span class="comment">     */</span>
02140     <span class="keywordflow">if</span> (ptiKeyState) {
02141         RtlCopyMemory(pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o17">afKeyState</a>, ptiKeyState-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o17">afKeyState</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a825">CBKEYSTATE</a>);
02142     } <span class="keywordflow">else</span> {
02143         RtlCopyMemory(pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o17">afKeyState</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a222">gafAsyncKeyState</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a825">CBKEYSTATE</a>);
02144     }
02145 
02146     <span class="comment">/*</span>
02147 <span class="comment">     * If there isn't a mouse set iCursorLevel to -1 so the</span>
02148 <span class="comment">     * mouse cursor won't be visible on the screen.</span>
02149 <span class="comment">     */</span>
02150     <span class="keywordflow">if</span> (
02151         !<a class="code" href="../../d4/d1/userk_8h.html#a193">TEST_GTERMF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a199">GTERMF_MOUSE</a>)) {
02152             pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o20">iCursorLevel</a>--;
02153     }
02154     <span class="comment">/*</span>
02155 <span class="comment">     * While the thread is starting up...  it has the wait cursor.</span>
02156 <span class="comment">     */</span>
02157     <a class="code" href="../../d4/d1/userk_8h.html#a599">LockQCursor</a>(pq, <a class="code" href="../../d4/d1/userk_8h.html#a321">SYSCUR</a>(WAIT));
02158 
02159     <a class="code" href="../../d6/d3/queue_8c.html#a1">DebugValidateMLIST</a>(&amp;pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o0">mlInput</a>);
02160     <span class="keywordflow">return</span> pq;
02161 }
02162 
02163 <span class="comment">/***************************************************************************\</span>
02164 <span class="comment">* FreeQueue</span>
02165 <span class="comment">*</span>
02166 <span class="comment">* 04-04-96 GerardoB    Created.</span>
02167 <span class="comment">\***************************************************************************/</span>
<a name="l02168"></a><a class="code" href="../../d4/d1/userk_8h.html#a1205">02168</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1205">FreeQueue</a>(
02169     <a class="code" href="../../d7/d4/structtagQ.html">PQ</a> pq)
02170 {
02171 <span class="preprocessor">#if DBG</span>
02172 <span class="preprocessor"></span>    <span class="comment">/*</span>
02173 <span class="comment">     * Turn off the flag indicating that this queue is in destruction.</span>
02174 <span class="comment">     * We do this in either case that we are putting this into the free</span>
02175 <span class="comment">     * list, or truly destroying the handle.  We use this to try and</span>
02176 <span class="comment">     * track cases where someone tries to lock elements into the queue</span>
02177 <span class="comment">     * structure while it's going through destuction.</span>
02178 <span class="comment">     */</span>
02179     pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o21">QF_flags</a> &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a864">QF_INDESTROY</a>;
02180 <span class="preprocessor">#endif</span>
02181 <span class="preprocessor"></span>
02182     UserAssertMsg0(pq != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>, <span class="stringliteral">"FreeQueue(gpqForeground) !"</span>);
02183     UserAssertMsg0(pq != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a30">gpqForegroundPrev</a>, <span class="stringliteral">"FreeQueue(gpqForegroundPrev) !"</span>);
02184     UserAssertMsg0(pq != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a31">gpqCursor</a>, <span class="stringliteral">"FreeQueue(gpqCursor) !"</span>);
02185     <a class="code" href="../../d5/d8/ex_8h.html#a253">ExFreeToPagedLookasideList</a>(<a class="code" href="../../d6/d3/queue_8c.html#a11">QLookaside</a>, pq);
02186 }
02187 
02188 <span class="comment">/***************************************************************************\</span>
02189 <span class="comment">* FreeCachedQueues</span>
02190 <span class="comment">*</span>
02191 <span class="comment">* 14-Jan-98 CLupu    Created.</span>
02192 <span class="comment">\***************************************************************************/</span>
<a name="l02193"></a><a class="code" href="../../d4/d1/userk_8h.html#a1206">02193</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1206">FreeCachedQueues</a>(
02194     VOID)
02195 {
02196     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d3/queue_8c.html#a11">QLookaside</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02197         <a class="code" href="../../d5/d8/ex_8h.html#a251">ExDeletePagedLookasideList</a>(<a class="code" href="../../d6/d3/queue_8c.html#a11">QLookaside</a>);
02198         UserFreePool(<a class="code" href="../../d6/d3/queue_8c.html#a11">QLookaside</a>);
02199         <a class="code" href="../../d6/d3/queue_8c.html#a11">QLookaside</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02200     }
02201 }
02202 
02203 <span class="comment">/***************************************************************************\</span>
02204 <span class="comment">* zzzDestroyQueue</span>
02205 <span class="comment">*</span>
02206 <span class="comment">*</span>
02207 <span class="comment">* History:</span>
02208 <span class="comment">* 05-20-91 MikeHar      Created.</span>
02209 <span class="comment">\***************************************************************************/</span>
02210 
<a name="l02211"></a><a class="code" href="../../d4/d1/userk_8h.html#a1209">02211</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1209">zzzDestroyQueue</a>(
02212     <a class="code" href="../../d7/d4/structtagQ.html">PQ</a>          pq,
02213     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti)
02214 {
02215     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiT;
02216     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiAny, ptiBestMouse, ptiBestKey;
02217     PLIST_ENTRY pHead, pEntry;
02218 
02219 <span class="preprocessor">#if DBG</span>
02220 <span class="preprocessor"></span>    <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> cDying = 0;
02221 <span class="preprocessor">#endif</span>
02222 <span class="preprocessor"></span>
02223     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fSetFMouseMoved = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02224 
02225     <a class="code" href="../../d6/d3/queue_8c.html#a1">DebugValidateMLIST</a>(&amp;pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o0">mlInput</a>);
02226 
02227     UserAssert(pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o22">cThreads</a>);
02228     pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o22">cThreads</a>--;
02229 
02230     <span class="keywordflow">if</span> (pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o22">cThreads</a> != 0) {
02231 
02232         <span class="comment">/*</span>
02233 <span class="comment">         * Since we aren't going to destroy this queue, make sure</span>
02234 <span class="comment">         * it isn't pointing to the THREADINFO that's going away.</span>
02235 <span class="comment">         */</span>
02236         <span class="keywordflow">if</span> (pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o1">ptiSysLock</a> == pti) {
02237             <a class="code" href="../../d4/d1/userk_8h.html#a12">CheckSysLock</a>(6, pq, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02238             pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o1">ptiSysLock</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02239         }
02240 
02241         <span class="keywordflow">if</span> ((pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o5">ptiKeyboard</a> == pti) || (pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o4">ptiMouse</a> == pti)) {
02242 
02243             <span class="comment">/*</span>
02244 <span class="comment">             * Run through THREADINFOs looking for one pointing to pq.</span>
02245 <span class="comment">             */</span>
02246             ptiAny = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02247             ptiBestMouse = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02248             ptiBestKey = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02249 
02250             pHead = &amp;pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o20">PtiList</a>;
02251             <span class="keywordflow">for</span> (pEntry = pHead-&gt;Flink; pEntry != pHead; pEntry = pEntry-&gt;Flink) {
02252                 ptiT = CONTAINING_RECORD(pEntry, <a class="code" href="../../d2/d8/structtagTHREADINFO.html">THREADINFO</a>, PtiLink);
02253 
02254                 <span class="comment">/*</span>
02255 <span class="comment">                 * Skip threads that are going away or belong to a</span>
02256 <span class="comment">                 * different queue.</span>
02257 <span class="comment">                 */</span>
02258                 <span class="keywordflow">if</span> ((ptiT-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a795">TIF_INCLEANUP</a>) || (ptiT-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a> != pq)) {
02259 <span class="preprocessor">#if DBG</span>
02260 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (ptiT-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a> == pq &amp;&amp; (ptiT-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a795">TIF_INCLEANUP</a>))
02261                         cDying++;
02262 <span class="preprocessor">#endif</span>
02263 <span class="preprocessor"></span>                    <span class="keywordflow">continue</span>;
02264                 }
02265 
02266                 ptiAny = ptiT;
02267 
02268                 <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o2">fsWakeBits</a> &amp; QS_MOUSE) {
02269                     <span class="keywordflow">if</span> (ptiT-&gt;pcti-&gt;fsWakeMask &amp; QS_MOUSE)
02270                         ptiBestMouse = ptiT;
02271                 }
02272 
02273                 <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o2">fsWakeBits</a> &amp; QS_KEY) {
02274                     <span class="keywordflow">if</span> (ptiT-&gt;pcti-&gt;fsWakeMask &amp; QS_KEY)
02275                         ptiBestKey = ptiT;
02276                 }
02277             }
02278 
02279             <span class="keywordflow">if</span> (ptiBestMouse == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02280                 ptiBestMouse = ptiAny;
02281             <span class="keywordflow">if</span> (ptiBestKey == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02282                 ptiBestKey = ptiAny;
02283 
02284             <span class="comment">/*</span>
02285 <span class="comment">             * Transfer any wake-bits to this new queue.  This</span>
02286 <span class="comment">             * is a common problem for QS_MOUSEMOVE which doesn't</span>
02287 <span class="comment">             * get set on coalesced WM_MOUSEMOVE events, so we</span>
02288 <span class="comment">             * need to make sure the new thread tries to process</span>
02289 <span class="comment">             * any input waiting in the queue.</span>
02290 <span class="comment">             */</span>
02291             <span class="keywordflow">if</span> (ptiBestMouse != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02292                 <a class="code" href="../../d4/d1/userk_8h.html#a1197">SetWakeBit</a>(ptiBestMouse, pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o2">fsWakeBits</a> &amp; QS_MOUSE);
02293             <span class="keywordflow">if</span> (ptiBestKey != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02294                 <a class="code" href="../../d4/d1/userk_8h.html#a1197">SetWakeBit</a>(ptiBestKey, pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o2">fsWakeBits</a> &amp; QS_KEY);
02295 
02296             <span class="keywordflow">if</span> (pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o5">ptiKeyboard</a> == pti)
02297                 pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o5">ptiKeyboard</a> = ptiBestKey;
02298 
02299             <span class="keywordflow">if</span> (pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o4">ptiMouse</a> == pti)
02300                 pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o4">ptiMouse</a> = ptiBestMouse;
02301 
02302 <span class="preprocessor">#if DBG</span>
02303 <span class="preprocessor"></span>            <span class="comment">/*</span>
02304 <span class="comment">             * Bad things happen if ptiKeyboard or ptiMouse are NULL</span>
02305 <span class="comment">             */</span>
02306             <span class="keywordflow">if</span> (pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o22">cThreads</a> != cDying &amp;&amp; (pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o5">ptiKeyboard</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o4">ptiMouse</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
02307                 RIPMSG6(RIP_ERROR,
02308                         <span class="stringliteral">"pq %#p pq-&gt;cThreads %x cDying %x pti %#p ptiK %#p ptiM %#p"</span>,
02309                         pq, pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o22">cThreads</a>, cDying, pti, pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o5">ptiKeyboard</a>, pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o4">ptiMouse</a>);
02310             }
02311 <span class="preprocessor">#endif</span>
02312 <span class="preprocessor"></span>        }
02313 
02314         <span class="keywordflow">return</span>;
02315     }
02316 
02317     <span class="comment">/*</span>
02318 <span class="comment">     * Unlock any potentially locked globals now that we know absolutely</span>
02319 <span class="comment">     * that this queue is going away.</span>
02320 <span class="comment">     */</span>
02321     <a class="code" href="../../d4/d1/userk_8h.html#a2068">UnlockCaptureWindow</a>(pq);
02322     <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o7">spwndFocus</a>);
02323     <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>);
02324     <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o9">spwndActivePrev</a>);
02325     <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o18">caret</a>.<a class="code" href="../../d6/d9/structtagCARET.html#o0">spwnd</a>);
02326     <a class="code" href="../../d4/d1/userk_8h.html#a599">LockQCursor</a>(pq, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02327 
02328 <span class="preprocessor">#if DBG</span>
02329 <span class="preprocessor"></span>    <span class="comment">/*</span>
02330 <span class="comment">     * Mark this queue as being in the destruction process.  This is</span>
02331 <span class="comment">     * cleared in FreeQueue() once we have determined it's safe to</span>
02332 <span class="comment">     * place in the free-list, or destroy the handle.  We use this</span>
02333 <span class="comment">     * to track cases where someone will lock a cursor into the queue</span>
02334 <span class="comment">     * while it's in the middle of being destroyed.</span>
02335 <span class="comment">     */</span>
02336     pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o21">QF_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a864">QF_INDESTROY</a>;
02337 <span class="preprocessor">#endif</span>
02338 <span class="preprocessor"></span>
02339     <span class="comment">/*</span>
02340 <span class="comment">     * Free everything else that was allocated/created by AllocQueue.</span>
02341 <span class="comment">     */</span>
02342     <a class="code" href="../../d4/d1/userk_8h.html#a1548">FreeMessageList</a>(&amp;pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o0">mlInput</a>);
02343 
02344     <span class="comment">/*</span>
02345 <span class="comment">     * If this queue is in the foreground, set gpqForeground</span>
02346 <span class="comment">     * to NULL so no input is routed.  At some point we'll want</span>
02347 <span class="comment">     * to do slightly more clever assignment of gpqForeground here.</span>
02348 <span class="comment">     */</span>
02349     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a> == pq) {
02350         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02351     }
02352 
02353     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a30">gpqForegroundPrev</a> == pq) {
02354         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a30">gpqForegroundPrev</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02355     }
02356 
02357     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a31">gpqCursor</a> == pq) {
02358         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a31">gpqCursor</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02359         fSetFMouseMoved = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02360     }
02361 
02362     <span class="keywordflow">if</span> (pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o23">cLockCount</a> == 0) {
02363         <a class="code" href="../../d4/d1/userk_8h.html#a1205">FreeQueue</a>(pq);
02364     }
02365 
02366     <span class="keywordflow">if</span> (fSetFMouseMoved) {
02367         <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a32">zzzSetFMouseMoved</a>();
02368     }
02369 
02370 }
02371 
02372 <span class="comment">/**************************************************************************\</span>
02373 <span class="comment">* UserDeleteW32Thread</span>
02374 <span class="comment">*</span>
02375 <span class="comment">* This function is called when the W32THREAD reference count goes</span>
02376 <span class="comment">*  down to zero. So everything left around by xxxDestroyThreadInfo</span>
02377 <span class="comment">*  must be cleaned up here.</span>
02378 <span class="comment">*</span>
02379 <span class="comment">* SO VERY IMPORTANT:</span>
02380 <span class="comment">* Note that this call is not in the context of the pti being cleaned up,</span>
02381 <span class="comment">*  in other words, pti != PtiCurrent(). So only kernel calls are allowed here.</span>
02382 <span class="comment">*</span>
02383 <span class="comment">* 04-01-96 GerardoB   Created</span>
02384 <span class="comment">\**************************************************************************/</span>
<a name="l02385"></a><a class="code" href="../../d6/d3/queue_8c.html#a49">02385</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d6/d3/queue_8c.html#a49">UserDeleteW32Thread</a> (PW32THREAD pW32Thread)
02386 {
02387     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti = (<a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>)pW32Thread;
02388 
02389     BEGIN_REENTERCRIT();
02390 
02391     <span class="comment">/*</span>
02392 <span class="comment">     * Make sure the ref count didn't get bumped up while we were waiting.</span>
02393 <span class="comment">     */</span>
02394     <span class="keywordflow">if</span> (pW32Thread-&gt;RefCount == 0) {
02395 
02396         <span class="comment">/*</span>
02397 <span class="comment">         * Events</span>
02398 <span class="comment">         */</span>
02399         <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o35">pEventQueueServer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02400             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o35">pEventQueueServer</a>);
02401         }
02402         <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o47">apEvent</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02403             UserFreePool(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o47">apEvent</a>);
02404         }
02405 
02406         <span class="comment">/*</span>
02407 <span class="comment">         * App name.</span>
02408 <span class="comment">         */</span>
02409         <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o10">pstrAppName</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02410             UserFreePool(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o10">pstrAppName</a>);
02411         }
02412 
02413         <span class="comment">/*</span>
02414 <span class="comment">         * Unlock the queues and free them if no one is using them</span>
02415 <span class="comment">         * (the queues were already destroyed in DestroyThreadInfo)</span>
02416 <span class="comment">         */</span>
02417         <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02418 
02419             UserAssert(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o23">cLockCount</a>);
02420             --(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o23">cLockCount</a>);
02421 
02422             <span class="keywordflow">if</span> ((pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o23">cLockCount</a> == 0)
02423                     &amp;&amp; (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o22">cThreads</a> == 0)) {
02424                 <a class="code" href="../../d4/d1/userk_8h.html#a1205">FreeQueue</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>);
02425             }
02426 
02427         }
02428         <span class="comment">/*</span>
02429 <span class="comment">         * zzzReattachThreads shouldn't call back while using pqAttach</span>
02430 <span class="comment">         */</span>
02431         UserAssert(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o28">pqAttach</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02432 <span class="preprocessor">        #if 0</span>
02433 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o28">pqAttach</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02434 
02435             UserAssert(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o28">pqAttach</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o23">cLockCount</a>);
02436             --(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o28">pqAttach</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o23">cLockCount</a>);
02437 
02438             <span class="keywordflow">if</span> ((pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o28">pqAttach</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o23">cLockCount</a> == 0)
02439                     &amp;&amp; (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o28">pqAttach</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o22">cThreads</a> == 0)) {
02440                 <a class="code" href="../../d4/d1/userk_8h.html#a1205">FreeQueue</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o28">pqAttach</a>);
02441             }
02442 
02443         }
02444 <span class="preprocessor">        #endif</span>
02445 <span class="preprocessor"></span>        <span class="comment">/*</span>
02446 <span class="comment">         * Unlock the desktop (pti already unlinked from ptiList)</span>
02447 <span class="comment">         */</span>
02448         <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02449             <a class="code" href="../../d4/d1/userk_8h.html#a127">UnlockDesktop</a>(&amp;pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>, LDU_PTI_DESK, (ULONG_PTR)pti);
02450         }
02451 
02452         <span class="comment">/*</span>
02453 <span class="comment">         * Remove the pointer to this W32Thread and free the associated memory.</span>
02454 <span class="comment">         */</span>
02455         InterlockedCompareExchangePointer(&amp;pW32Thread-&gt;pEThread-&gt;Tcb.Win32Thread, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, pW32Thread);
02456         Win32FreePool(pW32Thread);
02457     }
02458 
02459     END_REENTERCRIT();
02460 }
02461 
02462 <span class="comment">/**************************************************************************\</span>
02463 <span class="comment">* UserDeleteW32Process</span>
02464 <span class="comment">*</span>
02465 <span class="comment">* This function is called when the W32PROCESS reference count goes</span>
02466 <span class="comment">*  down to zero. So everything left around by DestroyProcessInfo</span>
02467 <span class="comment">*  must be cleaned up here.</span>
02468 <span class="comment">*</span>
02469 <span class="comment">* SO VERY IMPORTANT:</span>
02470 <span class="comment">* Note that this call may not be in the context of the ppi being cleaned up,</span>
02471 <span class="comment">*  in other words, ppi != PpiCurrent(). So only kernel calls are allowed here.</span>
02472 <span class="comment">*</span>
02473 <span class="comment">* 04-01-96 GerardoB   Created</span>
02474 <span class="comment">\**************************************************************************/</span>
<a name="l02475"></a><a class="code" href="../../d6/d3/queue_8c.html#a50">02475</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d6/d3/queue_8c.html#a50">UserDeleteW32Process</a>(PW32PROCESS pW32Process)
02476 {
02477     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppi = (<a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a>)pW32Process;
02478 
02479     BEGIN_REENTERCRIT();
02480 
02481     <span class="comment">/*</span>
02482 <span class="comment">     * Make sure the ref count didn't get bumped up while we were waiting.</span>
02483 <span class="comment">     */</span>
02484     <span class="keywordflow">if</span> (pW32Process-&gt;RefCount == 0) {
02485 
02486         <span class="comment">/*</span>
02487 <span class="comment">         * Grab the handle flags lock. We can't call into the object manager when</span>
02488 <span class="comment">         * we have this or we might deadlock.</span>
02489 <span class="comment">         */</span>
02490         <a class="code" href="../../d4/d1/userk_8h.html#a2074">EnterHandleFlagsCrit</a>();
02491 
02492         <span class="comment">/*</span>
02493 <span class="comment">         * Delete handle flags attribute bitmap</span>
02494 <span class="comment">         */</span>
02495         <span class="keywordflow">if</span> (ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o21">bmHandleFlags</a>.Buffer) {
02496             UserFreePool(ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o21">bmHandleFlags</a>.Buffer);
02497             <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a26">RtlInitializeBitMap</a>(&amp;ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o21">bmHandleFlags</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0);
02498         }
02499 
02500         <span class="comment">/*</span>
02501 <span class="comment">         * Remove the pointer to this W32Process and free the associated memory.</span>
02502 <span class="comment">         */</span>
02503         InterlockedCompareExchangePointer(&amp;pW32Process-&gt;Process-&gt;Win32Process, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, pW32Process);
02504         Win32FreePool(pW32Process);
02505 
02506         <span class="comment">/*</span>
02507 <span class="comment">         * Release the handle flags lock.</span>
02508 <span class="comment">         */</span>
02509         <a class="code" href="../../d4/d1/userk_8h.html#a2075">LeaveHandleFlagsCrit</a>();
02510     }
02511 
02512     END_REENTERCRIT();
02513 }
02514 
02515 <span class="comment">/***************************************************************************\</span>
02516 <span class="comment">* FLastGuiThread</span>
02517 <span class="comment">*</span>
02518 <span class="comment">* Check if this is the last GUI thread in the process.</span>
02519 <span class="comment">\***************************************************************************/</span>
02520 
<a name="l02521"></a><a class="code" href="../../d6/d3/queue_8c.html#a51">02521</a> __inline <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d3/queue_8c.html#a51">FLastGuiThread</a>(<a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti)
02522 {
02523     <span class="keywordflow">return</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a> &amp;&amp;
02524             pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o1">ptiList</a> == pti &amp;&amp;
02525             pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o29">ptiSibling</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02526 }
02527 
02528 <span class="comment">/***************************************************************************\</span>
02529 <span class="comment">* xxxDestroyThreadInfo</span>
02530 <span class="comment">*</span>
02531 <span class="comment">* Destroys a THREADINFO created by xxxCreateThreadInfo().</span>
02532 <span class="comment">*</span>
02533 <span class="comment">*  Note that the current pti can be locked so it might be used after this</span>
02534 <span class="comment">*   function returns, eventhough the thread execution has ended.</span>
02535 <span class="comment">*  We want to stop any activity on this thread so we clean up any USER stuff</span>
02536 <span class="comment">*   like messages, clipboard, queue, etc and specially anything that assumes</span>
02537 <span class="comment">*   to be running on a Win32 thread and client side stuff.</span>
02538 <span class="comment">*  The final cleanup will take place in UserDeleteW32Thread</span>
02539 <span class="comment">*</span>
02540 <span class="comment">*  This function must not go into the user mode because the ntos data</span>
02541 <span class="comment">*  structures may no longer support it and it may bluescreen the system.</span>
02542 <span class="comment">*</span>
02543 <span class="comment">* Make all callbacks before the thread objects are destroyed. If you callback</span>
02544 <span class="comment">*  afterwards, new objects might be created and won't be cleaned up.</span>
02545 <span class="comment">*</span>
02546 <span class="comment">* History:</span>
02547 <span class="comment">* 02-15-91 DarrinM      Created.</span>
02548 <span class="comment">* 02-27-91 mikeke       Made it work</span>
02549 <span class="comment">* 02-27-91 Mikehar      Removed queue from the global list</span>
02550 <span class="comment">\***************************************************************************/</span>
02551 
<a name="l02552"></a><a class="code" href="../../d4/d1/userk_8h.html#a1885">02552</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1885">xxxDestroyThreadInfo</a>(VOID)
02553 {
02554     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent;
02555     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> *ppti;
02556 
02557     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
02558     UserAssert (ptiCurrent != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02559     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a616">IsWinEventNotifyDeferredOK</a>());
02560 
02561     <span class="comment">/*</span>
02562 <span class="comment">     * If this thread is blocking input, stop it</span>
02563 <span class="comment">     */</span>
02564     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a26">gptiBlockInput</a> == ptiCurrent) {
02565         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a26">gptiBlockInput</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02566     }
02567 
02568     <span class="comment">/*</span>
02569 <span class="comment">     * Don't mess with this ptiCurrent anymore.</span>
02570 <span class="comment">     */</span>
02571     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> |= (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a801">TIF_DONTATTACHQUEUE</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a795">TIF_INCLEANUP</a>);
02572 
02573     <span class="comment">/*</span>
02574 <span class="comment">     * First do any preparation work: windows need to be "patched" so that</span>
02575 <span class="comment">     * their window procs point to server only windowprocs, for example.</span>
02576 <span class="comment">     */</span>
02577     <a class="code" href="../../d4/d1/userk_8h.html#a1552">PatchThreadWindows</a>(ptiCurrent);
02578 
02579     <span class="comment">/*</span>
02580 <span class="comment">     * If this thread terminated abnormally and was tracking tell</span>
02581 <span class="comment">     * GDI to hide the trackrect.</span>
02582 <span class="comment">     */</span>
02583     <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o30">pmsd</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02584         <a class="code" href="../../d4/d1/userk_8h.html#a1515">xxxCancelTrackingForThread</a>(ptiCurrent);
02585     }
02586 
02587     <span class="comment">/*</span>
02588 <span class="comment">     * Unlock the pmsd window.</span>
02589 <span class="comment">     */</span>
02590     <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o30">pmsd</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02591         <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o30">pmsd</a>-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o0">spwnd</a>);
02592         UserFreePool(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o30">pmsd</a>);
02593         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o30">pmsd</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02594     }
02595 
02596     <span class="comment">/*</span>
02597 <span class="comment">     * Free the clipboard if owned by this thread</span>
02598 <span class="comment">     */</span>
02599     {
02600         <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta;
02601         pwinsta = <a class="code" href="../../d8/d8/winsta_8c.html#a11">_GetProcessWindowStation</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02602         <span class="keywordflow">if</span> (pwinsta != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02603             <span class="keywordflow">if</span> (pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o5">ptiClipLock</a> == ptiCurrent) {
02604                 <a class="code" href="../../d4/d1/userk_8h.html#a1736">xxxCloseClipboard</a>(pwinsta);
02605             }
02606             <span class="keywordflow">if</span> (pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o6">ptiDrawingClipboard</a> == ptiCurrent) {
02607                 pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o6">ptiDrawingClipboard</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02608             }
02609         }
02610     }
02611 
02612     <span class="comment">/*</span>
02613 <span class="comment">     * Unlock all the objects stored in the menustate structure</span>
02614 <span class="comment">     */</span>
02615     <span class="keywordflow">while</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o21">pMenuState</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02616         <a class="code" href="../../d4/d1/structtagMENUSTATE.html">PMENUSTATE</a> pMenuState;
02617         <a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a> ppopupmenuRoot;
02618 
02619         pMenuState = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o21">pMenuState</a>;
02620         ppopupmenuRoot = pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o0">pGlobalPopupMenu</a>;
02621 
02622         <span class="comment">/*</span>
02623 <span class="comment">         * If menu mode was running on this thread</span>
02624 <span class="comment">         */</span>
02625         <span class="keywordflow">if</span> (ptiCurrent == pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o24">ptiMenuStateOwner</a>) {
02626             <span class="comment">/*</span>
02627 <span class="comment">             * The menu's going away, so anyone who's locked it</span>
02628 <span class="comment">             * is SOL anyway. Bug #375467.</span>
02629 <span class="comment">             */</span>
02630             pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o25">dwLockCount</a> = 0;
02631 
02632             <span class="comment">/*</span>
02633 <span class="comment">             * Close this menu.</span>
02634 <span class="comment">             */</span>
02635             <span class="keywordflow">if</span> (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o9">fModelessMenu</a>) {
02636                 <a class="code" href="../../d4/d1/userk_8h.html#a1400">xxxEndMenuLoop</a>(pMenuState, ppopupmenuRoot);
02637                 <a class="code" href="../../d4/d1/userk_8h.html#a1344">xxxMNEndMenuState</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02638             } <span class="keywordflow">else</span> {
02639                 pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o3">fInsideMenuLoop</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02640                 ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o21">QF_flags</a> &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a869">QF_CAPTURELOCKED</a>;
02641                 <a class="code" href="../../d4/d1/userk_8h.html#a1374">xxxMNCloseHierarchy</a>(ppopupmenuRoot, pMenuState);
02642                 <a class="code" href="../../d4/d1/userk_8h.html#a1344">xxxMNEndMenuState</a>(ppopupmenuRoot-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o0">fIsMenuBar</a> || ppopupmenuRoot-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o15">fDestroyed</a>);
02643             }
02644         } <span class="keywordflow">else</span> {
02645             <span class="comment">/*</span>
02646 <span class="comment">             * Menu mode is running on another thread. This thread</span>
02647 <span class="comment">             *  must own spwndNotify which is going away soon.</span>
02648 <span class="comment">             * When spwndNotify is destroyed, we will clean up pMenuState</span>
02649 <span class="comment">             *  from this pti. So do nothing now as we'll need this</span>
02650 <span class="comment">             *  pMenuState at that time.</span>
02651 <span class="comment">             */</span>
02652             UserAssert((ppopupmenuRoot-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02653                     &amp;&amp; (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(ppopupmenuRoot-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>) == ptiCurrent));
02654 
02655             <span class="comment">/*</span>
02656 <span class="comment">             * Nested menus are not supposed to involve multiple threads</span>
02657 <span class="comment">             */</span>
02658             UserAssert(pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o26">pmnsPrev</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02659             <span class="keywordflow">break</span>;
02660         }
02661 
02662     } <span class="comment">/* while (ptiCurrent-&gt;pMenuState != NULL) */</span>
02663 
02664 <span class="preprocessor">#if DBG</span>
02665 <span class="preprocessor"></span>    <span class="comment">/*</span>
02666 <span class="comment">     * This thread must not be using the desktop menu</span>
02667 <span class="comment">     */</span>
02668     <span class="keywordflow">if</span> ((ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o6">spwndMenu</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
02669         UserAssert(ptiCurrent != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o6">spwndMenu</a>));
02670     }
02671 <span class="preprocessor">#endif</span>
02672 <span class="preprocessor"></span>
02673     <span class="comment">/*</span>
02674 <span class="comment">     * Unlock all the objects stored in the sbstate structure.</span>
02675 <span class="comment">     */</span>
02676     <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o33">pSBTrack</a>) {
02677         <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o33">pSBTrack</a>-&gt;<a class="code" href="../../d6/d5/structtagSBTRACK.html#o5">spwndSB</a>);
02678         <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o33">pSBTrack</a>-&gt;<a class="code" href="../../d6/d5/structtagSBTRACK.html#o6">spwndSBNotify</a>);
02679         <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o33">pSBTrack</a>-&gt;<a class="code" href="../../d6/d5/structtagSBTRACK.html#o4">spwndTrack</a>);
02680         UserFreePool(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o33">pSBTrack</a>);
02681         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o33">pSBTrack</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02682     }
02683 
02684     <span class="comment">/*</span>
02685 <span class="comment">     * If this is the main input thread of this application, zero out</span>
02686 <span class="comment">     * that field.</span>
02687 <span class="comment">     */</span>
02688     <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o2">ptiMainThread</a> == ptiCurrent)
02689         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o2">ptiMainThread</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02690 
02691     <span class="keywordflow">while</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o24">psiiList</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02692         <a class="code" href="../../d2/d4/ddemlsvr_8h.html#a11">xxxDestroyThreadDDEObject</a>(ptiCurrent, ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o24">psiiList</a>);
02693     }
02694 
02695     <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a805">TIF_PALETTEAWARE</a>) {
02696         <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
02697         <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwnd;
02698 
02699         UserAssert(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02700 
02701         pwnd = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>;
02702 
02703         <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pwnd, &amp;tlpwnd);
02704         <a class="code" href="../../d4/d1/userk_8h.html#a1105">xxxFlushPalette</a>(pwnd);
02705         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
02706     }
02707 
02708     <span class="comment">/*</span>
02709 <span class="comment">     * If this is the last GUI thread for the process that made a temporary</span>
02710 <span class="comment">     * (fullscreen) mode change, restore the mode to what's in the registry.</span>
02711 <span class="comment">     */</span>
02712     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d3/queue_8c.html#a51">FLastGuiThread</a>(ptiCurrent) &amp;&amp; (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a160">gppiFullscreen</a> == ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>)) {
02713         <a class="code" href="../../d4/d1/userk_8h.html#a1758">xxxUserChangeDisplaySettings</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>);
02714 
02715         UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a160">gppiFullscreen</a> != ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>);
02716     }
02717 
02718 <span class="comment">/*******************************************************************************************\</span>
02719 <span class="comment"> *                                                                                         *</span>
02720 <span class="comment"> *          CLEANING THREAD OBJECTS. AVOID CALLING BACK AFTER THIS POINT                   *</span>
02721 <span class="comment"> *      New objects might be created while calling back and won't be cleaned up            *</span>
02722 <span class="comment"> *                                                                                         *</span>
02723 <span class="comment">\*******************************************************************************************/</span>
02724 
02725     <span class="comment">/*</span>
02726 <span class="comment">     * This thread might have some outstanding timers.  Destroy them</span>
02727 <span class="comment">     */</span>
02728     <a class="code" href="../../d4/d1/userk_8h.html#a1243">DestroyThreadsTimers</a>(ptiCurrent);
02729 
02730     <span class="comment">/*</span>
02731 <span class="comment">     * Free any windows hooks this thread has created.</span>
02732 <span class="comment">     */</span>
02733     <a class="code" href="../../d4/d1/userk_8h.html#a1527">FreeThreadsWindowHooks</a>();
02734 
02735     <span class="comment">/*</span>
02736 <span class="comment">     * Free any hwnd lists the thread was using</span>
02737 <span class="comment">     */</span>
02738     {
02739        <a class="code" href="../../d4/d9/structtagBWL.html">PBWL</a> pbwl, pbwlNext;
02740        <span class="keywordflow">for</span> (pbwl = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a99">gpbwlList</a>; pbwl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; ) {
02741            pbwlNext = pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o0">pbwlNext</a>;
02742            <span class="keywordflow">if</span> (pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o3">ptiOwner</a> == ptiCurrent) {
02743                <a class="code" href="../../d4/d1/userk_8h.html#a1158">FreeHwndList</a>(pbwl);
02744            }
02745            pbwl = pbwlNext;
02746        }
02747     }
02748 
02749     <span class="comment">/*</span>
02750 <span class="comment">     * Destroy all the public objects created by this thread.</span>
02751 <span class="comment">     */</span>
02752     <a class="code" href="../../d3/d2/hotkeys_8c.html#a1">DestroyThreadsHotKeys</a>();
02753 
02754     <a class="code" href="../../d4/d8/handtabl_8c.html#a27">DestroyThreadsObjects</a>();
02755 
02756     <span class="comment">/*</span>
02757 <span class="comment">     * Free any synchronous Notifies pending for this thread and</span>
02758 <span class="comment">     * free any Win Event Hooks this thread created.</span>
02759 <span class="comment">     */</span>
02760     <a class="code" href="../../d5/d7/kernel_2winable_8c.html#a11">FreeThreadsWinEvents</a>(ptiCurrent);
02761 
02762     <span class="comment">/*</span>
02763 <span class="comment">     * Unlock the keyboard layouts here</span>
02764 <span class="comment">     */</span>
02765     <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o4">spklActive</a>);
02766 
02767     <span class="comment">/*</span>
02768 <span class="comment">     * Cleanup the global resources if this is the last GUI</span>
02769 <span class="comment">     * thread for this session</span>
02770 <span class="comment">     */</span>
02771     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a360">gdwGuiThreads</a> == 1) {
02772         <a class="code" href="../../d4/d1/userk_8h.html#a1208">CleanupResources</a>();
02773     }
02774 
02775 
02776     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d3/queue_8c.html#a51">FLastGuiThread</a>(ptiCurrent)) {
02777 
02778         <span class="comment">/*</span>
02779 <span class="comment">         * Check if this was a setup app.</span>
02780 <span class="comment">         */</span>
02781         <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;W32PF_Flags &amp; W32PF_SETUPAPP) {
02782             <a class="code" href="../../d1/d3/structtagDESKTOPINFO.html">PDESKTOPINFO</a> pdeskinfo = <a class="code" href="../../d4/d1/userk_8h.html#a256">GETDESKINFO</a>(ptiCurrent);
02783             <span class="keywordflow">if</span> (pdeskinfo-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o5">spwndShell</a>) {
02784                 <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(pdeskinfo-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o5">spwndShell</a>, <a class="code" href="../../d4/d1/userk_8h.html#a375">DTM_SETUPAPPRAN</a>, 0, 0);
02785             }
02786         }
02787 
02788         <a class="code" href="../../d4/d1/userk_8h.html#a1554">DestroyProcessesClasses</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>);
02789         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;W32PF_Flags &amp;= ~(W32PF_CLASSESREGISTERED);
02790 
02791 
02792         <a class="code" href="../../d6/d3/queue_8c.html#a16">DestroyProcessesObjects</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>);
02793     }
02794 
02795 <span class="preprocessor">#ifdef FE_IME</span>
02796 <span class="preprocessor"></span>    <span class="comment">/*</span>
02797 <span class="comment">     * Unlock default input context.</span>
02798 <span class="comment">     */</span>
02799     <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o40">spDefaultImc</a>);
02800 <span class="preprocessor">#endif</span>
02801 <span class="preprocessor"></span>
02802     <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02803         <span class="comment">/*</span>
02804 <span class="comment">         * Remove this thread's cursor count from the queue.</span>
02805 <span class="comment">         */</span>
02806         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o20">iCursorLevel</a> -= ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o37">iCursorLevel</a>;
02807 
02808         <span class="comment">/*</span>
02809 <span class="comment">         * Have to recalc queue ownership after this thread</span>
02810 <span class="comment">         * leaves if it is a member of a shared input queue.</span>
02811 <span class="comment">         */</span>
02812         <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o22">cThreads</a> != 1)
02813         {
02814             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a107">gpdeskRecalcQueueAttach</a> = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>;
02815             <span class="comment">/*</span>
02816 <span class="comment">             * Because we are in thread cleanup, we won't callback due</span>
02817 <span class="comment">             * to WinEvents (zzzSetFMouseMoved calls zzzUpdateCursorImage)</span>
02818 <span class="comment">             */</span>
02819             UserAssert(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a795">TIF_INCLEANUP</a>);
02820             UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a340">gbExitInProgress</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02821             <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a32">zzzSetFMouseMoved</a>();
02822         }
02823     }
02824 
02825     <span class="comment">/*</span>
02826 <span class="comment">     * Remove from the process' list, also.</span>
02827 <span class="comment">     */</span>
02828     ppti = &amp;<a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>()-&gt;ptiList;
02829     <span class="keywordflow">if</span> (*ppti != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02830         <span class="keywordflow">while</span> (*ppti != ptiCurrent &amp;&amp; (*ppti)-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o29">ptiSibling</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02831             ppti = &amp;((*ppti)-&gt;ptiSibling);
02832         }
02833         <span class="keywordflow">if</span> (*ppti == ptiCurrent) {
02834             *ppti = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o29">ptiSibling</a>;
02835             ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o29">ptiSibling</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02836         }
02837     }
02838 
02839     {
02840         <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a> rpdesk;
02841         <a class="code" href="../../d6/d8/structtagATTACHINFO.html">PATTACHINFO</a> *ppai;
02842 
02843         <span class="comment">/*</span>
02844 <span class="comment">         * Temporarily lock the desktop until the THREADINFO structure is</span>
02845 <span class="comment">         * freed.  Note that locking a NULL ptiCurrent-&gt;rpdesk is OK.  Use a</span>
02846 <span class="comment">         * normal lock instead of a thread lock because the lock must</span>
02847 <span class="comment">         * exist past the freeing of the ptiCurrent.</span>
02848 <span class="comment">         */</span>
02849         rpdesk = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02850         <a class="code" href="../../d4/d1/userk_8h.html#a126">LockDesktop</a>(&amp;rpdesk, ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>, LDL_FN_DESTROYTHREADINFO, (ULONG_PTR)<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>());
02851 
02852         <span class="comment">/*</span>
02853 <span class="comment">         * Cleanup SMS structures attached to this thread.  Handles both</span>
02854 <span class="comment">         * pending send and receive messages. MUST make sure we do SendMsgCleanup</span>
02855 <span class="comment">         * AFTER window cleanup.</span>
02856 <span class="comment">         */</span>
02857         <a class="code" href="../../d4/d1/userk_8h.html#a1148">SendMsgCleanup</a>(ptiCurrent);
02858 
02859 
02860         <span class="comment">/*</span>
02861 <span class="comment">         * Allow this thread to be swapped</span>
02862 <span class="comment">         */</span>
02863         <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o42">cEnterCount</a>) {
02864             BOOLEAN <span class="keywordtype">bool</span>;
02865 
02866             RIPMSG1(RIP_WARNING, <span class="stringliteral">"Thread exiting with stack locked.  pti:%#p\n"</span>, ptiCurrent);
02867             <span class="keywordtype">bool</span> = <a class="code" href="../../d9/d1/thredobj_8c.html#a23">KeSetKernelStackSwapEnable</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02868             ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o42">cEnterCount</a> = 0;
02869             UserAssert(!<span class="keywordtype">bool</span>);
02870         }
02871 
02872         <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02873             ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o9">cThreads</a>--;
02874             UserAssert(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o9">cThreads</a> &gt;= 0);
02875         }
02876 
02877         <span class="comment">/*</span>
02878 <span class="comment">         * If this thread is a win16 task, remove it from the scheduler.</span>
02879 <span class="comment">         */</span>
02880         <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>) {
02881             <span class="keywordflow">if</span> ((ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o22">ptdb</a>) &amp;&amp; (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o22">ptdb</a>-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o5">hTaskWow</a> != 0)) {
02882                 <a class="code" href="../../d4/d1/userk_8h.html#a1998">_WOWCleanup</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o22">ptdb</a>-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o5">hTaskWow</a>);
02883             }
02884             <a class="code" href="../../d4/d1/userk_8h.html#a1194">DestroyTask</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>, ptiCurrent);
02885         }
02886 
02887         <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o34">hEventQueueClient</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02888             <a class="code" href="../../d4/d1/userk_8h.html#a966">ProtectHandle</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o34">hEventQueueClient</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02889             ZwClose(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o34">hEventQueueClient</a>);
02890             ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o34">hEventQueueClient</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02891         }
02892 
02893 
02894         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a14">gspwndInternalCapture</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02895             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a14">gspwndInternalCapture</a>) == ptiCurrent) {
02896                 <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a14">gspwndInternalCapture</a>);
02897             }
02898         }
02899 
02900         <span class="comment">/*</span>
02901 <span class="comment">         * Set gptiForeground to NULL if equal to this pti before exiting</span>
02902 <span class="comment">         * this routine.</span>
02903 <span class="comment">         */</span>
02904         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a25">gptiForeground</a> == ptiCurrent) {
02905             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a405">FWINABLE</a>()) {
02906                 <span class="comment">/*</span>
02907 <span class="comment">                 * Post these (WEF_ASYNC), since we can't make callbacks from here.</span>
02908 <span class="comment">                 */</span>
02909                 <a class="code" href="../../d5/d7/kernel_2winable_8c.html#a8">xxxWindowEvent</a>(EVENT_OBJECT_FOCUS, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, OBJID_CLIENT, INDEXID_CONTAINER, <a class="code" href="../../d4/d1/userk_8h.html#a612">WEF_ASYNC</a>);
02910                 <a class="code" href="../../d5/d7/kernel_2winable_8c.html#a8">xxxWindowEvent</a>(EVENT_SYSTEM_FOREGROUND, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, OBJID_WINDOW, INDEXID_CONTAINER, <a class="code" href="../../d4/d1/userk_8h.html#a612">WEF_ASYNC</a>);
02911             }
02912 
02913             <span class="comment">/*</span>
02914 <span class="comment">             * Call the Shell to ask it to activate its main window.</span>
02915 <span class="comment">             * This will be accomplished with a PostMessage() to itself,</span>
02916 <span class="comment">             * so the actual activation will take place later.</span>
02917 <span class="comment">             */</span>
02918             UserAssert(rpdesk != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02919 
02920             <span class="keywordflow">if</span> (rpdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o9">spwndProgman</a>)
02921                 <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(rpdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o9">spwndProgman</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a296">guiActivateShellWindow</a>, 0, 0);
02922 
02923             <span class="comment">/*</span>
02924 <span class="comment">             * Set gptiForeground to NULL because we're destroying it.</span>
02925 <span class="comment">             */</span>
02926             <a class="code" href="../../d4/d1/userk_8h.html#a1226">SetForegroundThread</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02927 
02928             <span class="comment">/*</span>
02929 <span class="comment">             * If this thread is attached to gpqForeground AND it's the</span>
02930 <span class="comment">             * last thread in the queue, then zzzDestroyQueue will NULL out</span>
02931 <span class="comment">             * qpqForeground. Due to journalling attaching, gptiForegrouund</span>
02932 <span class="comment">             * is not always attached to gpqForeground. This is one reason</span>
02933 <span class="comment">             * why we no longer NULL out gpqForeground as stated in the old</span>
02934 <span class="comment">             * comment. The other reason is that there might be other threads</span>
02935 <span class="comment">             * in the foreground queue so there is no need to zap it. This was</span>
02936 <span class="comment">             * messing up MsTest (now called VisualTest)</span>
02937 <span class="comment">             * This is the old comment:</span>
02938 <span class="comment">             * "Since gpqForeground is derived from the foreground thread</span>
02939 <span class="comment">             * structure, set it to NULL as well, since there now is no</span>
02940 <span class="comment">             * foreground thread structure"</span>
02941 <span class="comment">             *</span>
02942 <span class="comment">             * qpqForeground = NULL;</span>
02943 <span class="comment">             */</span>
02944         }
02945 
02946 
02947         <span class="comment">/*</span>
02948 <span class="comment">         * If this thread got the last input event, pass ownership to another</span>
02949 <span class="comment">         *  thread in this process or to the foreground thread.</span>
02950 <span class="comment">         */</span>
02951         <span class="keywordflow">if</span> (ptiCurrent == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a78">glinp</a>.<a class="code" href="../../d5/d9/structtagLASTINPUT.html#o2">ptiLastWoken</a>) {
02952             UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>() == ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>);
02953             <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o1">ptiList</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02954                 UserAssert (ptiCurrent != ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o1">ptiList</a>);
02955                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a78">glinp</a>.<a class="code" href="../../d5/d9/structtagLASTINPUT.html#o2">ptiLastWoken</a> = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o1">ptiList</a>;
02956             } <span class="keywordflow">else</span> {
02957                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a78">glinp</a>.<a class="code" href="../../d5/d9/structtagLASTINPUT.html#o2">ptiLastWoken</a> = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a25">gptiForeground</a>;
02958             }
02959         }
02960 
02961         <span class="comment">/*</span>
02962 <span class="comment">         * Make sure none of the other global thread pointers are pointing to us.</span>
02963 <span class="comment">         */</span>
02964         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a23">gptiShutdownNotify</a> == ptiCurrent) {
02965             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a23">gptiShutdownNotify</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02966         }
02967         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a22">gptiTasklist</a> == ptiCurrent) {
02968             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a22">gptiTasklist</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02969         }
02970         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a227">gHardErrorHandler</a>.<a class="code" href="../../d2/d6/structtagHARDERRORHANDLER.html#o0">pti</a> == ptiCurrent) {
02971             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a227">gHardErrorHandler</a>.<a class="code" href="../../d2/d6/structtagHARDERRORHANDLER.html#o0">pti</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02972         }
02973 
02974         <span class="comment">/*</span>
02975 <span class="comment">         * May be called from xxxCreateThreadInfo before the queue is created</span>
02976 <span class="comment">         * so check for NULL queue.</span>
02977 <span class="comment">         * Lock the queues since this pti might be locked. They will be unlocked</span>
02978 <span class="comment">         *  in UserDeleteW32Thread</span>
02979 <span class="comment">         */</span>
02980         <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02981             UserAssert(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a> != ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o28">pqAttach</a>);
02982             <a class="code" href="../../d6/d3/queue_8c.html#a17">DestroyThreadsMessages</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, ptiCurrent);
02983             (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o23">cLockCount</a>)++;
02984             <a class="code" href="../../d4/d1/userk_8h.html#a1209">zzzDestroyQueue</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, ptiCurrent);
02985         }
02986 
02987         <span class="comment">/*</span>
02988 <span class="comment">         * zzzReattachThreads shouldn't call back while using pqAttach</span>
02989 <span class="comment">         */</span>
02990         UserAssert(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o28">pqAttach</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02991 <span class="preprocessor">        #if 0</span>
02992 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o28">pqAttach</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02993             <a class="code" href="../../d6/d3/queue_8c.html#a17">DestroyThreadsMessages</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o28">pqAttach</a>, ptiCurrent);
02994             (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o28">pqAttach</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o23">cLockCount</a>)++;
02995             <a class="code" href="../../d4/d1/userk_8h.html#a1209">zzzDestroyQueue</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o28">pqAttach</a>, ptiCurrent);
02996         }
02997 <span class="preprocessor">        #endif</span>
02998 <span class="preprocessor"></span>
02999         <span class="comment">/*</span>
03000 <span class="comment">         * Remove the pti from its pti list and reset the pointers.</span>
03001 <span class="comment">         */</span>
03002         <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03003             RemoveEntryList(&amp;ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o36">PtiLink</a>);
03004             InitializeListHead(&amp;ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o36">PtiLink</a>);
03005         }
03006 
03007         <a class="code" href="../../d4/d1/userk_8h.html#a1548">FreeMessageList</a>(&amp;ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o43">mlPost</a>);
03008 
03009         <span class="comment">/*</span>
03010 <span class="comment">         * Free any attachinfo structures pointing to this thread</span>
03011 <span class="comment">         */</span>
03012         ppai = &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a106">gpai</a>;
03013         <span class="keywordflow">while</span> ((*ppai) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03014             <span class="keywordflow">if</span> ((*ppai)-&gt;pti1 == ptiCurrent || (*ppai)-&gt;pti2 == ptiCurrent) {
03015                 <a class="code" href="../../d6/d8/structtagATTACHINFO.html">PATTACHINFO</a> paiKill = *ppai;
03016                 *ppai = (*ppai)-&gt;<a class="code" href="../../d6/d8/structtagATTACHINFO.html#o0">paiNext</a>;
03017                 UserFreePool((HLOCAL)paiKill);
03018             } <span class="keywordflow">else</span> {
03019                 ppai = &amp;(*ppai)-&gt;<a class="code" href="../../d6/d8/structtagATTACHINFO.html#o0">paiNext</a>;
03020             }
03021         }
03022 
03023         <span class="comment">/*</span>
03024 <span class="comment">         * Change ownership of any objects that didn't get freed (because they</span>
03025 <span class="comment">         * are locked or we have a bug and the object didn't get destroyed).</span>
03026 <span class="comment">         */</span>
03027         <a class="code" href="../../d4/d1/userk_8h.html#a1547">MarkThreadsObjects</a>(ptiCurrent);
03028 
03029         <span class="comment">/*</span>
03030 <span class="comment">         * Free thread information visible from client</span>
03031 <span class="comment">         */</span>
03032         <span class="keywordflow">if</span> (rpdesk &amp;&amp; ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a> != &amp;(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o52">cti</a>)) {
03033             <a class="code" href="../../d4/d1/userk_8h.html#a313">DesktopFree</a>(rpdesk, ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>);
03034             ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a> = &amp;(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o52">cti</a>);
03035         }
03036 
03037         <span class="comment">/*</span>
03038 <span class="comment">         * Free the client info for system threads</span>
03039 <span class="comment">         */</span>
03040         <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a797">TIF_SYSTEMTHREAD</a> &amp;&amp; ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03041             UserFreePool(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>);
03042             ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03043         }
03044 
03045         <span class="comment">/*</span>
03046 <span class="comment">         * Unlock the temporary desktop lock. ptiCurrent-&gt;rpdesk is still locked</span>
03047 <span class="comment">         *  and will be unlocked in UserDeleteW32Thread.</span>
03048 <span class="comment">         */</span>
03049         <a class="code" href="../../d4/d1/userk_8h.html#a127">UnlockDesktop</a>(&amp;rpdesk, LDU_FN_DESTROYTHREADINFO, (ULONG_PTR)<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>());
03050     }
03051 
03052     <span class="comment">/*</span>
03053 <span class="comment">     * One more thread died.</span>
03054 <span class="comment">     */</span>
03055     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a360">gdwGuiThreads</a>--;
03056 }
03057 
03058 
03059 <span class="comment">/***************************************************************************\</span>
03060 <span class="comment">* CleanEventMessage</span>
03061 <span class="comment">*</span>
03062 <span class="comment">* This routine takes a message and destroys and event message related pieces,</span>
03063 <span class="comment">* which may be allocated.</span>
03064 <span class="comment">*</span>
03065 <span class="comment">* 12-10-92 ScottLu      Created.</span>
03066 <span class="comment">\***************************************************************************/</span>
03067 
<a name="l03068"></a><a class="code" href="../../d6/d3/queue_8c.html#a53">03068</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d3/queue_8c.html#a53">CleanEventMessage</a>(
03069     <a class="code" href="../../d8/d4/structtagQMSG.html">PQMSG</a> pqmsg)
03070 {
03071     <a class="code" href="../../d5/d8/structtagASYNCSENDMSG.html">PASYNCSENDMSG</a> pmsg;
03072 
03073     <span class="comment">/*</span>
03074 <span class="comment">     * Certain special messages on the INPUT queue have associated</span>
03075 <span class="comment">     * bits of memory that need to be freed.</span>
03076 <span class="comment">     */</span>
03077     <span class="keywordflow">switch</span> (pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o4">dwQEvent</a>) {
03078     <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a336">QEVENT_SETWINDOWPOS</a>:
03079         UserFreePool((<a class="code" href="../../d8/d6/structtagSMWP.html">PSMWP</a>)pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam);
03080         <span class="keywordflow">break</span>;
03081 
03082     <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a337">QEVENT_UPDATEKEYSTATE</a>:
03083         UserFreePool((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam);
03084         <span class="keywordflow">break</span>;
03085 
03086     <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a347">QEVENT_NOTIFYWINEVENT</a>:
03087         <a class="code" href="../../d5/d7/kernel_2winable_8c.html#a10">DestroyNotify</a>((<a class="code" href="../../d9/d2/structtagNOTIFY.html">PNOTIFY</a>)pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.lParam);
03088         <span class="keywordflow">break</span>;
03089 
03090     <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a344">QEVENT_ASYNCSENDMSG</a>:
03091         pmsg = (<a class="code" href="../../d5/d8/structtagASYNCSENDMSG.html">PASYNCSENDMSG</a>)pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam;
03092         <a class="code" href="../../d4/d1/userk_8h.html#a1299">UserDeleteAtom</a>((ATOM)pmsg-&gt;<a class="code" href="../../d5/d8/structtagASYNCSENDMSG.html#o1">lParam</a>);
03093         UserFreePool(pmsg);
03094         <span class="keywordflow">break</span>;
03095     }
03096 }
03097 
03098 <span class="comment">/***************************************************************************\</span>
03099 <span class="comment">* FreeMessageList</span>
03100 <span class="comment">*</span>
03101 <span class="comment">* History:</span>
03102 <span class="comment">* 02-27-91  mikeke      Created.</span>
03103 <span class="comment">* 11-03-92  scottlu     Changed to work with MLIST structure.</span>
03104 <span class="comment">\***************************************************************************/</span>
03105 
<a name="l03106"></a><a class="code" href="../../d4/d1/userk_8h.html#a1548">03106</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1548">FreeMessageList</a>(
03107     <a class="code" href="../../d6/d1/structtagMLIST.html">PMLIST</a> pml)
03108 {
03109     <a class="code" href="../../d8/d4/structtagQMSG.html">PQMSG</a> pqmsg;
03110 
03111     <a class="code" href="../../d6/d3/queue_8c.html#a1">DebugValidateMLIST</a>(pml);
03112 
03113     <span class="keywordflow">while</span> ((pqmsg = pml-&gt;<a class="code" href="../../d6/d1/structtagMLIST.html#o0">pqmsgRead</a>) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03114         <a class="code" href="../../d6/d3/queue_8c.html#a53">CleanEventMessage</a>(pqmsg);
03115         <a class="code" href="../../d4/d1/userk_8h.html#a1212">DelQEntry</a>(pml, pqmsg);
03116     }
03117 
03118     <a class="code" href="../../d6/d3/queue_8c.html#a1">DebugValidateMLIST</a>(pml);
03119 }
03120 
03121 <span class="comment">/***************************************************************************\</span>
03122 <span class="comment">* DestroyThreadsMessages</span>
03123 <span class="comment">*</span>
03124 <span class="comment">* History:</span>
03125 <span class="comment">* 02-21-96  jerrysh     Created.</span>
03126 <span class="comment">\***************************************************************************/</span>
03127 
<a name="l03128"></a><a class="code" href="../../d6/d3/queue_8c.html#a17">03128</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d6/d3/queue_8c.html#a17">DestroyThreadsMessages</a>(
03129     <a class="code" href="../../d7/d4/structtagQ.html">PQ</a> pq,
03130     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti)
03131 {
03132     <a class="code" href="../../d8/d4/structtagQMSG.html">PQMSG</a> pqmsg;
03133     <a class="code" href="../../d8/d4/structtagQMSG.html">PQMSG</a> pqmsgNext;
03134 
03135     <a class="code" href="../../d6/d3/queue_8c.html#a1">DebugValidateMLIST</a>(&amp;pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o0">mlInput</a>);
03136 
03137     pqmsg = pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o0">mlInput</a>.<a class="code" href="../../d6/d1/structtagMLIST.html#o0">pqmsgRead</a>;
03138     <span class="keywordflow">while</span> (pqmsg != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03139         pqmsgNext = pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o0">pqmsgNext</a>;
03140         <span class="keywordflow">if</span> (pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o5">pti</a> == pti) {
03141             <span class="comment">/*</span>
03142 <span class="comment">             * Make sure we don't leave any bogus references to this message</span>
03143 <span class="comment">             * lying around.</span>
03144 <span class="comment">             */</span>
03145             <span class="keywordflow">if</span> (pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o3">idSysPeek</a> == (ULONG_PTR)pqmsg) {
03146                 <a class="code" href="../../d4/d1/userk_8h.html#a11">CheckPtiSysPeek</a>(8, pq, 0);
03147                 pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o3">idSysPeek</a> = 0;
03148             }
03149             <a class="code" href="../../d6/d3/queue_8c.html#a53">CleanEventMessage</a>(pqmsg);
03150             <a class="code" href="../../d4/d1/userk_8h.html#a1212">DelQEntry</a>(&amp;pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o0">mlInput</a>, pqmsg);
03151         }
03152         pqmsg = pqmsgNext;
03153     }
03154 
03155     <a class="code" href="../../d6/d3/queue_8c.html#a1">DebugValidateMLIST</a>(&amp;pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o0">mlInput</a>);
03156 }
03157 
03158 <span class="comment">/***************************************************************************\</span>
03159 <span class="comment">* InitQEntryLookaside</span>
03160 <span class="comment">*</span>
03161 <span class="comment">* Initializes the Q entry lookaside list. This improves Q entry locality</span>
03162 <span class="comment">* by keeping Q entries in a single page</span>
03163 <span class="comment">*</span>
03164 <span class="comment">* 09-09-93  Markl   Created.</span>
03165 <span class="comment">\***************************************************************************/</span>
03166 
03167 
03168 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03169"></a><a class="code" href="../../d6/d3/queue_8c.html#a55">03169</a> <a class="code" href="../../d6/d3/queue_8c.html#a55">InitQEntryLookaside</a>()
03170 {
03171     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a20">QEntryLookaside</a> = UserAllocPoolNonPaged(<span class="keyword">sizeof</span>(<a class="code" href="../../d1/d8/struct__PAGED__LOOKASIDE__LIST.html">PAGED_LOOKASIDE_LIST</a>), TAG_LOOKASIDE);
03172     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a20">QEntryLookaside</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03173         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
03174     }
03175 
03176     <a class="code" href="../../d5/d8/ex_8h.html#a250">ExInitializePagedLookasideList</a>(<a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a20">QEntryLookaside</a>,
03177                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03178                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03179                                    <a class="code" href="../../d4/d2/pool_8h.html#a8">SESSION_POOL_MASK</a>,
03180                                    <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d4/structtagQMSG.html">QMSG</a>),
03181                                    TAG_QMSG,
03182                                    16);
03183 
03184     <a class="code" href="../../d6/d3/queue_8c.html#a11">QLookaside</a> = UserAllocPoolNonPaged(<span class="keyword">sizeof</span>(<a class="code" href="../../d5/d8/ex_8h.html#a106">PAGED_LOOKASIDE_LIST</a>), TAG_LOOKASIDE);
03185     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d3/queue_8c.html#a11">QLookaside</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03186         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
03187     }
03188 
03189     <a class="code" href="../../d5/d8/ex_8h.html#a250">ExInitializePagedLookasideList</a>(<a class="code" href="../../d6/d3/queue_8c.html#a11">QLookaside</a>,
03190                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03191                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03192                                    <a class="code" href="../../d4/d2/pool_8h.html#a8">SESSION_POOL_MASK</a>,
03193                                    <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d4/structtagQ.html">Q</a>),
03194                                    TAG_Q,
03195                                    16);
03196     <span class="keywordflow">return</span> STATUS_SUCCESS;
03197 }
03198 
03199 <span class="comment">/***************************************************************************\</span>
03200 <span class="comment">* AllocQEntry</span>
03201 <span class="comment">*</span>
03202 <span class="comment">* Allocates a message on a message list. DelQEntry deletes a message</span>
03203 <span class="comment">* on a message list.</span>
03204 <span class="comment">*</span>
03205 <span class="comment">* 10-22-92 ScottLu      Created.</span>
03206 <span class="comment">\***************************************************************************/</span>
03207 
<a name="l03208"></a><a class="code" href="../../d4/d1/userk_8h.html#a1210">03208</a> <a class="code" href="../../d8/d4/structtagQMSG.html">PQMSG</a> <a class="code" href="../../d4/d1/userk_8h.html#a1210">AllocQEntry</a>(
03209     <a class="code" href="../../d6/d1/structtagMLIST.html">PMLIST</a> pml)
03210 {
03211     <a class="code" href="../../d8/d4/structtagQMSG.html">PQMSG</a> pqmsg;
03212 
03213     <a class="code" href="../../d6/d3/queue_8c.html#a1">DebugValidateMLIST</a>(pml);
03214 
03215     <span class="keywordflow">if</span> (pml-&gt;<a class="code" href="../../d6/d1/structtagMLIST.html#o2">cMsgs</a> &gt;= <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a254">gUserPostMessageLimit</a>) {
03216         RIPMSG3(RIP_WARNING, <span class="stringliteral">"AllocQEntry: # of post messages exceeds the limit(%d) in pti=0x%p, pml=0x%p"</span>,
03217                <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a254">gUserPostMessageLimit</a>, W32GetCurrentThread(), pml);
03218         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03219     }
03220 
03221     <span class="comment">/*</span>
03222 <span class="comment">     * Allocate a Q message structure.</span>
03223 <span class="comment">     */</span>
03224     <span class="keywordflow">if</span> ((pqmsg = <a class="code" href="../../d5/d8/ex_8h.html#a252">ExAllocateFromPagedLookasideList</a>(<a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a20">QEntryLookaside</a>)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03225         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03226     }
03227 
03228     RtlZeroMemory(pqmsg, <span class="keyword">sizeof</span>(*pqmsg));
03229 
03230     <span class="keywordflow">if</span> (pml-&gt;<a class="code" href="../../d6/d1/structtagMLIST.html#o1">pqmsgWriteLast</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03231         pml-&gt;<a class="code" href="../../d6/d1/structtagMLIST.html#o1">pqmsgWriteLast</a>-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o0">pqmsgNext</a> = pqmsg;
03232         pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o1">pqmsgPrev</a> = pml-&gt;<a class="code" href="../../d6/d1/structtagMLIST.html#o1">pqmsgWriteLast</a>;
03233         pml-&gt;<a class="code" href="../../d6/d1/structtagMLIST.html#o1">pqmsgWriteLast</a> = pqmsg;
03234     } <span class="keywordflow">else</span> {
03235         pml-&gt;<a class="code" href="../../d6/d1/structtagMLIST.html#o1">pqmsgWriteLast</a> = pml-&gt;<a class="code" href="../../d6/d1/structtagMLIST.html#o0">pqmsgRead</a> = pqmsg;
03236     }
03237 
03238     pml-&gt;<a class="code" href="../../d6/d1/structtagMLIST.html#o2">cMsgs</a>++;
03239 
03240     <a class="code" href="../../d6/d3/queue_8c.html#a2">DebugValidateMLISTandQMSG</a>(pml, pqmsg);
03241 
03242     <span class="keywordflow">return</span> pqmsg;
03243 }
03244 
03245 <span class="comment">/***************************************************************************\</span>
03246 <span class="comment">* DelQEntry</span>
03247 <span class="comment">*</span>
03248 <span class="comment">* Simply removes a message from a message queue list.</span>
03249 <span class="comment">*</span>
03250 <span class="comment">* 10-20-92 ScottLu      Created.</span>
03251 <span class="comment">\***************************************************************************/</span>
03252 
<a name="l03253"></a><a class="code" href="../../d4/d1/userk_8h.html#a1212">03253</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1212">DelQEntry</a>(
03254     <a class="code" href="../../d6/d1/structtagMLIST.html">PMLIST</a> pml,
03255     <a class="code" href="../../d8/d4/structtagQMSG.html">PQMSG</a> pqmsg)
03256 {
03257     <a class="code" href="../../d6/d3/queue_8c.html#a2">DebugValidateMLISTandQMSG</a>(pml, pqmsg);
03258     UserAssert((<span class="keywordtype">int</span>)pml-&gt;<a class="code" href="../../d6/d1/structtagMLIST.html#o2">cMsgs</a> &gt; 0);
03259     UserAssert(pml-&gt;<a class="code" href="../../d6/d1/structtagMLIST.html#o0">pqmsgRead</a>);
03260     UserAssert(pml-&gt;<a class="code" href="../../d6/d1/structtagMLIST.html#o1">pqmsgWriteLast</a>);
03261 
03262     <span class="comment">/*</span>
03263 <span class="comment">     * Unlink this pqmsg from the message list.</span>
03264 <span class="comment">     */</span>
03265     <span class="keywordflow">if</span> (pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o1">pqmsgPrev</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
03266         pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o1">pqmsgPrev</a>-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o0">pqmsgNext</a> = pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o0">pqmsgNext</a>;
03267 
03268     <span class="keywordflow">if</span> (pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o0">pqmsgNext</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
03269         pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o0">pqmsgNext</a>-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o1">pqmsgPrev</a> = pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o1">pqmsgPrev</a>;
03270 
03271     <span class="comment">/*</span>
03272 <span class="comment">     * Update the read/write pointers if necessary.</span>
03273 <span class="comment">     */</span>
03274     <span class="keywordflow">if</span> (pml-&gt;<a class="code" href="../../d6/d1/structtagMLIST.html#o0">pqmsgRead</a> == pqmsg)
03275         pml-&gt;<a class="code" href="../../d6/d1/structtagMLIST.html#o0">pqmsgRead</a> = pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o0">pqmsgNext</a>;
03276 
03277     <span class="keywordflow">if</span> (pml-&gt;<a class="code" href="../../d6/d1/structtagMLIST.html#o1">pqmsgWriteLast</a> == pqmsg)
03278         pml-&gt;<a class="code" href="../../d6/d1/structtagMLIST.html#o1">pqmsgWriteLast</a> = pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o1">pqmsgPrev</a>;
03279 
03280     <span class="comment">/*</span>
03281 <span class="comment">     * Adjust the message count and free the message structure.</span>
03282 <span class="comment">     */</span>
03283     pml-&gt;<a class="code" href="../../d6/d1/structtagMLIST.html#o2">cMsgs</a>--;
03284 
03285     <a class="code" href="../../d5/d8/ex_8h.html#a253">ExFreeToPagedLookasideList</a>(<a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a20">QEntryLookaside</a>, pqmsg);
03286 
03287     <a class="code" href="../../d6/d3/queue_8c.html#a1">DebugValidateMLIST</a>(pml);
03288 }
03289 
03290 <span class="comment">/***************************************************************************\</span>
03291 <span class="comment">* CheckRemoveHotkeyBit</span>
03292 <span class="comment">*</span>
03293 <span class="comment">* We have a special bit for the WM_HOTKEY message - QS_HOTKEY. When there</span>
03294 <span class="comment">* is a WM_HOTKEY message in the queue, that bit is on. When there isn't,</span>
03295 <span class="comment">* that bit is off. This checks for more than one hot key, because the one</span>
03296 <span class="comment">* is about to be deleted. If there is only one, the hot key bits are cleared.</span>
03297 <span class="comment">*</span>
03298 <span class="comment">* 11-12-92 ScottLu      Created.</span>
03299 <span class="comment">\***************************************************************************/</span>
03300 
<a name="l03301"></a><a class="code" href="../../d6/d3/queue_8c.html#a58">03301</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d3/queue_8c.html#a58">CheckRemoveHotkeyBit</a>(
03302     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti,
03303     <a class="code" href="../../d6/d1/structtagMLIST.html">PMLIST</a> pml)
03304 {
03305     <a class="code" href="../../d8/d4/structtagQMSG.html">PQMSG</a> pqmsg;
03306     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> cHotkeys;
03307 
03308     <span class="comment">/*</span>
03309 <span class="comment">     * Remove the QS_HOTKEY bit if there is only one WM_HOTKEY message</span>
03310 <span class="comment">     * in this message list.</span>
03311 <span class="comment">     */</span>
03312     cHotkeys = 0;
03313     <span class="keywordflow">for</span> (pqmsg = pml-&gt;<a class="code" href="../../d6/d1/structtagMLIST.html#o0">pqmsgRead</a>; pqmsg != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; pqmsg = pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o0">pqmsgNext</a>) {
03314         <span class="keywordflow">if</span> (pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.message == WM_HOTKEY)
03315             cHotkeys++;
03316     }
03317 
03318     <span class="comment">/*</span>
03319 <span class="comment">     * If there is 1 or fewer hot keys, remove the hotkey bits.</span>
03320 <span class="comment">     */</span>
03321     <span class="keywordflow">if</span> (cHotkeys &lt;= 1) {
03322         pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o2">fsWakeBits</a> &amp;= ~QS_HOTKEY;
03323         pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o1">fsChangeBits</a> &amp;= ~QS_HOTKEY;
03324     }
03325 }
03326 
03327 <span class="comment">/***************************************************************************\</span>
03328 <span class="comment">* FindQMsg</span>
03329 <span class="comment">*</span>
03330 <span class="comment">* Finds a qmsg that fits the filters by looping through the message list.</span>
03331 <span class="comment">*</span>
03332 <span class="comment">* 10-20-92 ScottLu      Created.</span>
03333 <span class="comment">* 06-06-97 CLupu        added processing for WM_DDE_ACK messages</span>
03334 <span class="comment">\***************************************************************************/</span>
03335 
<a name="l03336"></a><a class="code" href="../../d4/d1/userk_8h.html#a1826">03336</a> <a class="code" href="../../d8/d4/structtagQMSG.html">PQMSG</a> <a class="code" href="../../d4/d1/userk_8h.html#a1826">FindQMsg</a>(
03337     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti,
03338     <a class="code" href="../../d6/d1/structtagMLIST.html">PMLIST</a> pml,
03339     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndFilter,
03340     UINT msgMin,
03341     UINT msgMax,
03342     BOOL bProcessAck)
03343 {
03344     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
03345     <a class="code" href="../../d8/d4/structtagQMSG.html">PQMSG</a> pqmsgRead;
03346     <a class="code" href="../../d8/d4/structtagQMSG.html">PQMSG</a> pqmsgRet = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03347     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> message;
03348 
03349     <a class="code" href="../../d6/d3/queue_8c.html#a1">DebugValidateMLIST</a>(pml);
03350 
03351     pqmsgRead = pml-&gt;<a class="code" href="../../d6/d1/structtagMLIST.html#o0">pqmsgRead</a>;
03352 
03353     <span class="keywordflow">while</span> (pqmsgRead != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03354 
03355         <span class="comment">/*</span>
03356 <span class="comment">         * Make sure this window is valid and doesn't have the destroy</span>
03357 <span class="comment">         * bit set (don't want to send it to any client side window procs</span>
03358 <span class="comment">         * if destroy window has been called on it).</span>
03359 <span class="comment">         */</span>
03360         pwnd = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(pqmsgRead-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.hwnd);
03361 
03362         <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; pqmsgRead-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.hwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03363             <span class="comment">/*</span>
03364 <span class="comment">             * If we're removing a WM_HOTKEY message, we may need to</span>
03365 <span class="comment">             * clear the QS_HOTKEY bit, since we have a special bit</span>
03366 <span class="comment">             * for that message.</span>
03367 <span class="comment">             */</span>
03368             <span class="keywordflow">if</span> (pqmsgRead-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.message == WM_HOTKEY) {
03369                 <a class="code" href="../../d6/d3/queue_8c.html#a58">CheckRemoveHotkeyBit</a>(pti, pml);
03370             }
03371             <span class="comment">/*</span>
03372 <span class="comment">             * If the current thread's queue is locked waiting for this message,</span>
03373 <span class="comment">             *  we have to unlock it because we're eating the message. If there's</span>
03374 <span class="comment">             *  no more input/messages for this thread, the thread is going to</span>
03375 <span class="comment">             *  sleep; hence there might not be a next Get/PeekMessage call to</span>
03376 <span class="comment">             *  unlock the queue (ie, updating pti-&gt;idLast is not enough);</span>
03377 <span class="comment">             *  so we must unlock it now.</span>
03378 <span class="comment">             * Win95 doesn't have this problem because their FindQMsg doesn't</span>
03379 <span class="comment">             *  eat messages; they call ReadPostMessage from FreeWindow</span>
03380 <span class="comment">             *  to take care of this scenario (== message for a destroyed window).</span>
03381 <span class="comment">             *  We could also do this if we have some problems with this fix.</span>
03382 <span class="comment">             */</span>
03383             <span class="keywordflow">if</span> ((pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o2">idSysLock</a> == (ULONG_PTR)pqmsgRead)
03384                     &amp;&amp; (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o1">ptiSysLock</a> == pti)) {
03385                 <span class="comment">/* CheckSysLock(What number?, pti-&gt;pq, NULL); */</span>
03386                 RIPMSG2(RIP_VERBOSE, <span class="stringliteral">"FindQMsg: Unlocking queue:%#p. Msg:%#lx"</span>,
03387                                         pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, pqmsgRead-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.message);
03388                 pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o1">ptiSysLock</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03389             }
03390 
03391             <a class="code" href="../../d4/d1/userk_8h.html#a1212">DelQEntry</a>(pml, pqmsgRead);
03392             <span class="keywordflow">goto</span> nextMsgFromPml;
03393         }
03394 
03395         <span class="comment">/*</span>
03396 <span class="comment">         * Process the WM_DDE_ACK messages if bProcessAck is set.</span>
03397 <span class="comment">         */</span>
03398         <span class="keywordflow">if</span> (bProcessAck &amp;&amp; (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(pwndFilter) == pqmsgRead-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.hwnd) &amp;&amp;
03399             (pqmsgRead-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.message == (WM_DDE_ACK | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a545">MSGFLAG_DDE_MID_THUNK</a>))) {
03400 
03401             <a class="code" href="../../d1/d0/structtagXSTATE.html">PXSTATE</a> pxs;
03402 
03403             pxs = (<a class="code" href="../../d1/d0/structtagXSTATE.html">PXSTATE</a>)<a class="code" href="../../d6/d9/rtl_2wow_8c.html#a8">HMValidateHandleNoRip</a>((HANDLE)pqmsgRead-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.lParam, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a247">TYPE_DDEXACT</a>);
03404 
03405             <span class="keywordflow">if</span> (pxs != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; (pxs-&gt;<a class="code" href="../../d1/d0/structtagXSTATE.html#o6">flags</a> &amp; <a class="code" href="../../d6/d4/ddetrack_8h.html#a9">XS_FREEPXS</a>)) {
03406                 <a class="code" href="../../d4/d1/userk_8h.html#a1875">FreeDdeXact</a>(pxs);
03407                 <a class="code" href="../../d4/d1/userk_8h.html#a1212">DelQEntry</a>(pml, pqmsgRead);
03408                 <span class="keywordflow">goto</span> nextMsgFromPml;
03409             }
03410         }
03411 
03412         <span class="comment">/*</span>
03413 <span class="comment">         * Make sure this message fits both window handle and message</span>
03414 <span class="comment">         * filters.</span>
03415 <span class="comment">         */</span>
03416         <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1220">CheckPwndFilter</a>(pwnd, pwndFilter))
03417             <span class="keywordflow">goto</span> nextMsg;
03418 
03419         <span class="comment">/*</span>
03420 <span class="comment">         * If this is a fixed up dde message, then turn it into a normal</span>
03421 <span class="comment">         * dde message for the sake of message filtering.</span>
03422 <span class="comment">         */</span>
03423         message = pqmsgRead-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.message;
03424         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a823">CheckMsgFilter</a>(message,
03425                 (WM_DDE_FIRST + 1) | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a545">MSGFLAG_DDE_MID_THUNK</a>,
03426                 WM_DDE_LAST | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a545">MSGFLAG_DDE_MID_THUNK</a>)) {
03427             message = message &amp; ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a545">MSGFLAG_DDE_MID_THUNK</a>;
03428         }
03429 
03430         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a823">CheckMsgFilter</a>(message, msgMin, msgMax))
03431             <span class="keywordflow">goto</span> nextMsg;
03432 
03433         <span class="comment">/*</span>
03434 <span class="comment">         * Found it. If bProcessAck is set, remember this pointer and go on</span>
03435 <span class="comment">         * till we finish walking the list to process all WM_DDE_ACK messages.</span>
03436 <span class="comment">         */</span>
03437         <span class="keywordflow">if</span> (!bProcessAck) {
03438             <a class="code" href="../../d6/d3/queue_8c.html#a1">DebugValidateMLIST</a>(pml);
03439             <span class="keywordflow">return</span> pqmsgRead;
03440         }
03441 
03442         <span class="keywordflow">if</span> (pqmsgRet == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03443             pqmsgRet = pqmsgRead;
03444         }
03445 nextMsg:
03446         pqmsgRead = pqmsgRead-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o0">pqmsgNext</a>;
03447         <span class="keywordflow">continue</span>;
03448 
03449 nextMsgFromPml:
03450         pqmsgRead = pml-&gt;<a class="code" href="../../d6/d1/structtagMLIST.html#o0">pqmsgRead</a>;
03451         <span class="keywordflow">continue</span>;
03452     }
03453 
03454     <a class="code" href="../../d6/d3/queue_8c.html#a1">DebugValidateMLIST</a>(pml);
03455     <span class="keywordflow">return</span> pqmsgRet;
03456 }
03457 
03458 <span class="comment">/***************************************************************************\</span>
03459 <span class="comment">* CheckQuitMessage</span>
03460 <span class="comment">*</span>
03461 <span class="comment">* Checks to see if a WM_QUIT message should be generated.</span>
03462 <span class="comment">*</span>
03463 <span class="comment">* 11-06-92 ScottLu      Created.</span>
03464 <span class="comment">\***************************************************************************/</span>
03465 
<a name="l03466"></a><a class="code" href="../../d6/d3/queue_8c.html#a60">03466</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d3/queue_8c.html#a60">CheckQuitMessage</a>(
03467     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti,
03468     LPMSG lpMsg,
03469     BOOL fRemoveMsg)
03470 {
03471     <span class="comment">/*</span>
03472 <span class="comment">     * If there are no more posted messages in the queue and cQuit is !=</span>
03473 <span class="comment">     * 0, then generate a quit!</span>
03474 <span class="comment">     */</span>
03475     <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o16">cQuit</a> != 0 &amp;&amp; pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o43">mlPost</a>.<a class="code" href="../../d6/d1/structtagMLIST.html#o2">cMsgs</a> == 0) {
03476         <span class="comment">/*</span>
03477 <span class="comment">         * If we're "removing" the quit, set cQuit to 0 so another one isn't</span>
03478 <span class="comment">         * generated.</span>
03479 <span class="comment">         */</span>
03480         <span class="keywordflow">if</span> (fRemoveMsg)
03481             pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o16">cQuit</a> = 0;
03482         <a class="code" href="../../d4/d1/userk_8h.html#a1502">StoreMessage</a>(lpMsg, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, WM_QUIT, (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o17">exitCode</a>, 0, 0);
03483         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03484     }
03485 
03486     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03487 }
03488 
03489 
03490 <span class="comment">/***************************************************************************\</span>
03491 <span class="comment">* ReadPostMessage</span>
03492 <span class="comment">*</span>
03493 <span class="comment">* If queue is not empty, read message satisfying filter conditions from</span>
03494 <span class="comment">* this queue to *lpMsg. This routine is used for the POST MESSAGE list only!!</span>
03495 <span class="comment">*</span>
03496 <span class="comment">* 10-19-92 ScottLu      Created.</span>
03497 <span class="comment">\***************************************************************************/</span>
03498 
<a name="l03499"></a><a class="code" href="../../d6/d3/queue_8c.html#a61">03499</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d3/queue_8c.html#a61">xxxReadPostMessage</a>(
03500     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti,
03501     LPMSG lpMsg,
03502     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndFilter,
03503     UINT msgMin,
03504     UINT msgMax,
03505     BOOL fRemoveMsg)
03506 {
03507     <a class="code" href="../../d8/d4/structtagQMSG.html">PQMSG</a> pqmsg;
03508     <a class="code" href="../../d6/d1/structtagMLIST.html">PMLIST</a> pmlPost;
03509 
03510     <span class="comment">/*</span>
03511 <span class="comment">     * Check to see if it is time to generate a quit message.</span>
03512 <span class="comment">     */</span>
03513     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d3/queue_8c.html#a60">CheckQuitMessage</a>(pti, lpMsg, fRemoveMsg))
03514         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03515 
03516     <span class="comment">/*</span>
03517 <span class="comment">     * Loop through the messages in this list looking for the one that</span>
03518 <span class="comment">     * fits the passed in filters.</span>
03519 <span class="comment">     */</span>
03520     pmlPost = &amp;pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o43">mlPost</a>;
03521     pqmsg = <a class="code" href="../../d4/d1/userk_8h.html#a1826">FindQMsg</a>(pti, pmlPost, pwndFilter, msgMin, msgMax, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03522     <span class="keywordflow">if</span> (pqmsg == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03523         <span class="comment">/*</span>
03524 <span class="comment">         * Check again for quit... FindQMsg deletes some messages</span>
03525 <span class="comment">         * in some instances, so we may match the conditions</span>
03526 <span class="comment">         * for quit generation here.</span>
03527 <span class="comment">         */</span>
03528         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d3/queue_8c.html#a60">CheckQuitMessage</a>(pti, lpMsg, fRemoveMsg))
03529             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03530     } <span class="keywordflow">else</span> {
03531         <span class="comment">/*</span>
03532 <span class="comment">         * Update the thread info fields with the info from this qmsg.</span>
03533 <span class="comment">         */</span>
03534         pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o14">timeLast</a> = pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.time;
03535         <span class="keywordflow">if</span> (!RtlEqualMemory(&amp;pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o38">ptLast</a>, &amp;pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.pt, <span class="keyword">sizeof</span>(POINT))) {
03536             pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> |= <a class="code" href="../../d1/d0/inc_2user_8h.html#a808">TIF_MSGPOSCHANGED</a>;
03537         }
03538         pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o38">ptLast</a> = pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.pt;
03539 
03540         pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o15">idLast</a> = (ULONG_PTR)pqmsg;
03541         pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o25">ExtraInfo</a> = pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o3">ExtraInfo</a>;
03542 
03543         <span class="comment">/*</span>
03544 <span class="comment">         * Are we supposed to yank out the message? If not, stick some</span>
03545 <span class="comment">         * random id into idLast so we don't unlock the input queue until we</span>
03546 <span class="comment">         * pull this message from the queue.</span>
03547 <span class="comment">         */</span>
03548         *lpMsg = pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>;
03549         <span class="keywordflow">if</span> (!fRemoveMsg) {
03550             pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o15">idLast</a> = 1;
03551         } <span class="keywordflow">else</span> {
03552             <span class="comment">/*</span>
03553 <span class="comment">             * If we're removing a WM_HOTKEY message, we may need to</span>
03554 <span class="comment">             * clear the QS_HOTKEY bit, since we have a special bit</span>
03555 <span class="comment">             * for that message.</span>
03556 <span class="comment">             */</span>
03557             <span class="keywordflow">if</span> (pmlPost-&gt;<a class="code" href="../../d6/d1/structtagMLIST.html#o0">pqmsgRead</a>-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.message == WM_HOTKEY) {
03558                 <a class="code" href="../../d6/d3/queue_8c.html#a58">CheckRemoveHotkeyBit</a>(pti, pmlPost);
03559             }
03560 
03561 
03562             <span class="comment">/*</span>
03563 <span class="comment">             * Since we're removing an event from the queue, we</span>
03564 <span class="comment">             * need to check priority.  This resets the TIF_SPINNING</span>
03565 <span class="comment">             * since we're no longer spinning.</span>
03566 <span class="comment">             */</span>
03567 <span class="comment">// We disable all MS badapp code and do it our way</span>
03568             <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a804">TIF_SPINNING</a>)
03569                 <a class="code" href="../../d6/d3/queue_8c.html#a18">CheckProcessForeground</a>(pti);
03570 
03571             <a class="code" href="../../d4/d1/userk_8h.html#a1212">DelQEntry</a>(pmlPost, pqmsg);
03572         }
03573 
03574         <span class="comment">/*</span>
03575 <span class="comment">         * See if this is a dde message that needs to be fixed up.</span>
03576 <span class="comment">         */</span>
03577         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a823">CheckMsgFilter</a>(lpMsg-&gt;message,
03578                 (WM_DDE_FIRST + 1) | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a545">MSGFLAG_DDE_MID_THUNK</a>,
03579                 WM_DDE_LAST | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a545">MSGFLAG_DDE_MID_THUNK</a>)) {
03580             <span class="comment">/*</span>
03581 <span class="comment">             * Fixup the message value.</span>
03582 <span class="comment">             */</span>
03583             lpMsg-&gt;message &amp;= (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a545">MSGFLAG_DDE_MID_THUNK</a>;
03584 
03585             <span class="comment">/*</span>
03586 <span class="comment">             * Call back the client to allocate the dde data for this message.</span>
03587 <span class="comment">             */</span>
03588             <a class="code" href="../../d4/d1/userk_8h.html#a1876">xxxDDETrackGetMessageHook</a>(lpMsg);
03589 
03590             <span class="comment">/*</span>
03591 <span class="comment">             * Copy these values back into the queue if this message hasn't</span>
03592 <span class="comment">             * been removed from the queue. Need to search through the</span>
03593 <span class="comment">             * queue again because the pqmsg may have been removed when</span>
03594 <span class="comment">             * we left the critical section above.</span>
03595 <span class="comment">             */</span>
03596             <span class="keywordflow">if</span> (!fRemoveMsg) {
03597                 <span class="keywordflow">if</span> (pqmsg == <a class="code" href="../../d4/d1/userk_8h.html#a1826">FindQMsg</a>(pti, pmlPost, pwndFilter, msgMin, msgMax, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
03598                     pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a> = *lpMsg;
03599                 }
03600             }
03601         }
03602 <span class="preprocessor">#if DBG</span>
03603 <span class="preprocessor"></span>        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a823">CheckMsgFilter</a>(lpMsg-&gt;message, WM_DDE_FIRST, WM_DDE_LAST)) {
03604             <span class="keywordflow">if</span> (fRemoveMsg) {
03605                 <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a5">TraceDdeMsg</a>(lpMsg-&gt;message, (HWND)lpMsg-&gt;wParam, lpMsg-&gt;hwnd, MSG_RECV);
03606             } <span class="keywordflow">else</span> {
03607                 <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a5">TraceDdeMsg</a>(lpMsg-&gt;message, (HWND)lpMsg-&gt;wParam, lpMsg-&gt;hwnd, MSG_PEEK);
03608             }
03609         }
03610 <span class="preprocessor">#endif</span>
03611 <span class="preprocessor"></span>    }
03612 
03613     <span class="comment">/*</span>
03614 <span class="comment">     * If there are no posted messages available, clear the post message</span>
03615 <span class="comment">     * bit so we don't go looking for them again.</span>
03616 <span class="comment">     */</span>
03617     <span class="keywordflow">if</span> (pmlPost-&gt;<a class="code" href="../../d6/d1/structtagMLIST.html#o2">cMsgs</a> == 0 &amp;&amp; pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o16">cQuit</a> == 0) {
03618         pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o2">fsWakeBits</a> &amp;= ~(QS_POSTMESSAGE | QS_ALLPOSTMESSAGE);
03619         pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o1">fsChangeBits</a> &amp;= ~QS_ALLPOSTMESSAGE;
03620     }
03621 
03622     <span class="keywordflow">return</span> pqmsg != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03623 }
03624 
03625 <span class="preprocessor">#ifdef HUNGAPP_GHOSTING</span>
03626 <span class="preprocessor"></span>
03627 <span class="comment">/***************************************************************************\</span>
03628 <span class="comment">* xxxProcessHungThreadEvent</span>
03629 <span class="comment">*</span>
03630 <span class="comment">* We check when a thread gets unhung when it reads the posted queue message.</span>
03631 <span class="comment">*</span>
03632 <span class="comment">* 6-10-99   vadimg      created</span>
03633 <span class="comment">\***************************************************************************/</span>
03634 
03635 <span class="keywordtype">void</span> <a class="code" href="../../d6/d3/queue_8c.html#a62">xxxProcessHungThreadEvent</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
03636 {
03637     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
03638     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndGhost;
03639     HWND hwnd;
03640     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndT1, tlpwndT2;
03641 
03642     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
03643 
03644     <span class="comment">/*</span>
03645 <span class="comment">     * The app processed this queue message, so update time last read</span>
03646 <span class="comment">     * used for hung app calculations.</span>
03647 <span class="comment">     */</span>
03648     <a class="code" href="../../d4/d1/userk_8h.html#a257">SET_TIME_LAST_READ</a>(ptiCurrent);
03649 
03650     pwndGhost = FindGhost(pwnd);
03651 
03652     <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pwndGhost, &amp;tlpwndT1);
03653     <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pwnd, &amp;tlpwndT2);
03654 
03655     <span class="keywordflow">if</span> (pwndGhost != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03656         <a class="code" href="../../d0/d0/structtagCHECKPOINT.html">PCHECKPOINT</a> pcp, pcpGhost;
03657 
03658         <span class="comment">/*</span>
03659 <span class="comment">         * Try to set the state of the hung window to the current state of</span>
03660 <span class="comment">         * the ghost window.</span>
03661 <span class="comment">         */</span>
03662         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndGhost, WFMAXIMIZED)) {
03663             <a class="code" href="../../d4/d1/userk_8h.html#a1159">xxxMinMaximize</a>(pwnd, SW_MAXIMIZE, MINMAX_KEEPHIDDEN);
03664         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndGhost, WFMINIMIZED)) {
03665             <a class="code" href="../../d4/d1/userk_8h.html#a1159">xxxMinMaximize</a>(pwnd, SW_SHOWMINNOACTIVE, MINMAX_KEEPHIDDEN);
03666         } <span class="keywordflow">else</span> {
03667             <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>;
03668             <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndGhost);
03669 
03670             <span class="comment">/*</span>
03671 <span class="comment">             * If the ghost is the active foreground window, allow this</span>
03672 <span class="comment">             * activation to bring the hung window to the foreground.</span>
03673 <span class="comment">             */</span>
03674             <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a> == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a> &amp;&amp; pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a> == pwndGhost) {
03675                 <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> = 0;
03676                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;TIF_flags |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a800">TIF_ALLOWFOREGROUNDACTIVATE</a>;
03677             } <span class="keywordflow">else</span> {
03678                 <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> = SWP_NOACTIVATE;
03679             }
03680 
03681             <span class="comment">/*</span>
03682 <span class="comment">             * This will appropriately zorder, activate, and position the</span>
03683 <span class="comment">             * hung window.</span>
03684 <span class="comment">             */</span>
03685             <a class="code" href="../../d4/d1/userk_8h.html#a1615">xxxSetWindowPos</a>(pwnd, pwndGhost,
03686                     pwndGhost-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left, pwndGhost-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.top,
03687                     pwndGhost-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.right - pwndGhost-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left,
03688                     pwndGhost-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.bottom - pwndGhost-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.top,
03689                     dwFlags);
03690         }
03691 
03692         <span class="comment">/*</span>
03693 <span class="comment">         * Since the ghost window could've been minimized or maximized during</span>
03694 <span class="comment">         * its lifetime, copy over the positioning checkpoint.</span>
03695 <span class="comment">         */</span>
03696         <span class="keywordflow">if</span> ((pcpGhost = (<a class="code" href="../../d0/d0/structtagCHECKPOINT.html">PCHECKPOINT</a>)<a class="code" href="../../d7/d8/rtl_2winprop_8c.html#a2">_GetProp</a>(pwndGhost,
03697                 PROP_CHECKPOINT, PROPF_INTERNAL)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03698 
03699             <span class="keywordflow">if</span> ((pcp = (<a class="code" href="../../d0/d0/structtagCHECKPOINT.html">PCHECKPOINT</a>)<a class="code" href="../../d7/d8/rtl_2winprop_8c.html#a2">_GetProp</a>(pwnd,
03700                     PROP_CHECKPOINT, PROPF_INTERNAL)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03701                 pcp = <a class="code" href="../../d4/d1/userk_8h.html#a1240">CkptRestore</a>(pwnd, &amp;pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>);
03702             }
03703 
03704             <span class="keywordflow">if</span> (pcp != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03705                 RtlCopyMemory(pcp, pcpGhost, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d0/structtagCHECKPOINT.html">CHECKPOINT</a>));
03706             }
03707         }
03708     }
03709 
03710     <span class="comment">/*</span>
03711 <span class="comment">     * Toggle the visible bit of the hung window and remove the ghost window</span>
03712 <span class="comment">     * corresponding to this previously hung window.</span>
03713 <span class="comment">     */</span>
03714     <a class="code" href="../../d4/d1/userk_8h.html#a1626">SetVisible</a>(pwnd, SV_SET);
03715     RemoveGhost(pwnd);
03716 
03717     <span class="comment">/*</span>
03718 <span class="comment">     * Make the shell aware again of the hung window.</span>
03719 <span class="comment">     */</span>
03720     hwnd = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a449">PtoHq</a>(pwnd);
03721     <a class="code" href="../../d4/d1/userk_8h.html#a1867">PostShellHookMessages</a>(HSHELL_WINDOWCREATED, (LPARAM)hwnd);
03722     <a class="code" href="../../d4/d1/userk_8h.html#a1521">xxxCallHook</a>(HSHELL_WINDOWCREATED, (WPARAM)hwnd, (LPARAM)0, WH_SHELL);
03723 
03724     <span class="comment">/*</span>
03725 <span class="comment">     * Completely invalidate the hung window, since it became visible again.</span>
03726 <span class="comment">     */</span>
03727     <a class="code" href="../../d4/d1/userk_8h.html#a1679">xxxRedrawWindow</a>(pwnd, NULL, NULL, RDW_INVALIDATE | RDW_ERASE |
03728             RDW_ALLCHILDREN | RDW_FRAME);
03729 
03730     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT2);
03731     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT1);
03732 }
03733 
03734 <span class="preprocessor">#else // HUNGAPP_GHOSTING</span>
03735 <span class="preprocessor"></span>
<a name="l03736"></a><a class="code" href="../../d6/d3/queue_8c.html#a62">03736</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d3/queue_8c.html#a62">xxxProcessHungThreadEvent</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
03737 {
03738     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
03739 
03740     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>)) {
03741         RIPMSG0(RIP_WARNING, <span class="stringliteral">"xxxProcessHungThreadEvent: window is already visible"</span>);
03742     } <span class="keywordflow">else</span> {
03743         <a class="code" href="../../d4/d1/userk_8h.html#a1626">SetVisible</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a751">SV_SET</a>);
03744 
03745         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>)) {
03746             RIPMSG0(RIP_WARNING, <span class="stringliteral">"xxxProcessHungThreadEvent: window is already minmized"</span>);
03747         } <span class="keywordflow">else</span> {
03748             <a class="code" href="../../d4/d1/userk_8h.html#a1159">xxxMinMaximize</a>(pwnd, SW_SHOWMINNOACTIVE, <a class="code" href="../../d4/d1/userk_8h.html#a503">MINMAX_KEEPHIDDEN</a>);
03749         }
03750     }
03751 }
03752 
03753 <span class="preprocessor">#endif // HUNGAPP_GHOSTING</span>
03754 <span class="preprocessor"></span>
<a name="l03755"></a><a class="code" href="../../d6/d3/queue_8c.html#a15">03755</a> <a class="code" href="../../d9/d3/access_8h.html#a40">BEEPPROC</a> <a class="code" href="../../d6/d3/queue_8c.html#a15">pfnBP</a>[] = {
03756     <a class="code" href="../../d9/d3/access_8h.html#a54">UpSiren</a>,
03757     <a class="code" href="../../d9/d3/access_8h.html#a55">DownSiren</a>,
03758     <a class="code" href="../../d9/d3/access_8h.html#a52">LowBeep</a>,
03759     <a class="code" href="../../d9/d3/access_8h.html#a51">HighBeep</a>,
03760     <a class="code" href="../../d9/d3/access_8h.html#a53">KeyClick</a>};
03761 
03762 <span class="comment">/***************************************************************************\</span>
03763 <span class="comment">* xxxProcessEventMessage</span>
03764 <span class="comment">*</span>
03765 <span class="comment">* This handles our processing for 'event' messages.  We return a BOOL</span>
03766 <span class="comment">* here telling the system whether or not to continue processing messages.</span>
03767 <span class="comment">*</span>
03768 <span class="comment">* History:</span>
03769 <span class="comment">* 06-17-91 DavidPe      Created.</span>
03770 <span class="comment">\***************************************************************************/</span>
03771 
<a name="l03772"></a><a class="code" href="../../d4/d1/userk_8h.html#a1214">03772</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1214">xxxProcessEventMessage</a>(
03773     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent,
03774     <a class="code" href="../../d8/d4/structtagQMSG.html">PQMSG</a> pqmsg)
03775 {
03776     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
03777     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndT;
03778     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlMsg;
03779     <a class="code" href="../../d7/d4/structtagQ.html">PQ</a> pq;
03780 
03781     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a616">IsWinEventNotifyDeferredOK</a>());
03782     UserAssert(ptiCurrent == <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>());
03783 
03784     <a class="code" href="../../d4/d1/userk_8h.html#a140">ThreadLockPoolCleanup</a>(ptiCurrent, pqmsg, &amp;tlMsg, <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a20">CleanEventMessage</a>);
03785 
03786     pq = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>;
03787     <span class="keywordflow">switch</span> (pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o4">dwQEvent</a>) {
03788     <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a343">QEVENT_DESTROYWINDOW</a>:
03789         <span class="comment">/*</span>
03790 <span class="comment">         * These events are posted from xxxDW_DestroyOwnedWindows</span>
03791 <span class="comment">         * for owned windows that are not owned by the owner</span>
03792 <span class="comment">         * window thread.</span>
03793 <span class="comment">         */</span>
03794         pwnd = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>((HWND)pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam);
03795         <span class="keywordflow">if</span> (pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03796             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a654">WFCHILD</a>))
03797                 <a class="code" href="../../d4/d1/userk_8h.html#a1575">xxxDestroyWindow</a>(pwnd);
03798             <span class="keywordflow">else</span> {
03799                 <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pwnd, &amp;tlpwndT);
03800                 <a class="code" href="../../d4/d1/userk_8h.html#a1461">xxxFreeWindow</a>(pwnd, &amp;tlpwndT);
03801             }
03802         }
03803         <span class="keywordflow">break</span>;
03804 
03805     <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a334">QEVENT_SHOWWINDOW</a>:
03806         <span class="comment">/*</span>
03807 <span class="comment">         * These events are mainly used from within CascadeChildWindows()</span>
03808 <span class="comment">         * and TileChildWindows() so that taskmgr doesn't hang while calling</span>
03809 <span class="comment">         * these apis if it is trying to tile or cascade a hung application.</span>
03810 <span class="comment">         */</span>
03811         <span class="comment">/* The HIWORD of lParam now has the preserved state of gfAnimate at the</span>
03812 <span class="comment">         * time of the call.</span>
03813 <span class="comment">         */</span>
03814         pwnd = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>((HWND)pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam);
03815         <span class="keywordflow">if</span> (pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a591">WFINDESTROY</a>)) {
03816             <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pwnd, &amp;tlpwndT);
03817             <a class="code" href="../../d4/d1/userk_8h.html#a1607">xxxShowWindow</a>(pwnd, (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.lParam);
03818             <span class="comment">/*</span>
03819 <span class="comment">             * If this is coming from an async SetWindowPlacement, update the</span>
03820 <span class="comment">             *  check point settings if the window is minimized.</span>
03821 <span class="comment">             */</span>
03822             <span class="keywordflow">if</span> ((pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.message &amp; WPF_ASYNCWINDOWPLACEMENT)
03823                     &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>)) {
03824 
03825                 <a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a11">WPUpdateCheckPointSettings</a>(pwnd, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.message);
03826             }
03827             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT);
03828         }
03829         <span class="keywordflow">break</span>;
03830 
03831     <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a347">QEVENT_NOTIFYWINEVENT</a>:
03832         UserAssert(((<a class="code" href="../../d9/d2/structtagNOTIFY.html">PNOTIFY</a>)pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.lParam)-&gt;dwWEFlags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a613">WEF_POSTED</a>);
03833         UserAssert(((<a class="code" href="../../d9/d2/structtagNOTIFY.html">PNOTIFY</a>)pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.lParam)-&gt;dwWEFlags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a612">WEF_ASYNC</a>);
03834         <a class="code" href="../../d5/d7/kernel_2winable_8c.html#a6">xxxProcessNotifyWinEvent</a>((<a class="code" href="../../d9/d2/structtagNOTIFY.html">PNOTIFY</a>)pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.lParam);
03835         <span class="keywordflow">break</span>;
03836 
03837     <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a336">QEVENT_SETWINDOWPOS</a>:
03838         <span class="comment">/*</span>
03839 <span class="comment">         * QEVENT_SETWINDOWPOS events are generated when a thread calls</span>
03840 <span class="comment">         * SetWindowPos with a list of windows owned by threads other than</span>
03841 <span class="comment">         * itself.  This way all WINDOWPOSing on a window is done the thread</span>
03842 <span class="comment">         * that owns (created) the window and we don't have any of those</span>
03843 <span class="comment">         * nasty inter-thread synchronization problems.</span>
03844 <span class="comment">         */</span>
03845         <a class="code" href="../../d4/d1/userk_8h.html#a1215">xxxProcessSetWindowPosEvent</a>((<a class="code" href="../../d8/d6/structtagSMWP.html">PSMWP</a>)pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam);
03846         <span class="keywordflow">break</span>;
03847 
03848     <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a337">QEVENT_UPDATEKEYSTATE</a>:
03849         <span class="comment">/*</span>
03850 <span class="comment">         * Update the local key state with the state from those</span>
03851 <span class="comment">         * keys that have changed since the last time key state</span>
03852 <span class="comment">         * was synchronized.</span>
03853 <span class="comment">         */</span>
03854         <a class="code" href="../../d4/d1/userk_8h.html#a1236">ProcessUpdateKeyStateEvent</a>(pq, (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam, (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam + <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a825">CBKEYSTATE</a>);
03855         <span class="keywordflow">break</span>;
03856 
03857     <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a339">QEVENT_ACTIVATE</a>:
03858     {
03859         <span class="keywordflow">if</span> (pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.lParam == 0) {
03860 
03861             <span class="comment">/*</span>
03862 <span class="comment">             * Clear any visible tracking going on in system.  We</span>
03863 <span class="comment">             * only bother to do this if lParam == 0 since</span>
03864 <span class="comment">             * xxxSetForegroundWindow2() deals with this in the</span>
03865 <span class="comment">             * other case.</span>
03866 <span class="comment">             */</span>
03867             <a class="code" href="../../d4/d1/userk_8h.html#a1514">xxxCancelTracking</a>();
03868 
03869             <span class="comment">/*</span>
03870 <span class="comment">             * Remove the clip cursor rectangle - it is a global mode that</span>
03871 <span class="comment">             * gets removed when switching.  Also remove any LockWindowUpdate()</span>
03872 <span class="comment">             * that's still around.</span>
03873 <span class="comment">             */</span>
03874             <a class="code" href="../../d4/d1/userk_8h.html#a1788">zzzClipCursor</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03875             <a class="code" href="../../d4/d1/userk_8h.html#a1772">LockWindowUpdate2</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03876 
03877             <span class="comment">/*</span>
03878 <span class="comment">             * Reload pq because it may have changed.</span>
03879 <span class="comment">             */</span>
03880             pq = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>;
03881 
03882             <span class="comment">/*</span>
03883 <span class="comment">             * If this event didn't originate from an initializing app</span>
03884 <span class="comment">             * coming to the foreground [wParam == 0] then go ahead</span>
03885 <span class="comment">             * and check if there's already an active window and if so make</span>
03886 <span class="comment">             * it visually active.  Also make sure we're still the foreground</span>
03887 <span class="comment">             * queue.</span>
03888 <span class="comment">             */</span>
03889             <span class="keywordflow">if</span> ((pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam != 0) &amp;&amp; (pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
03890                     (pq == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>)) {
03891                 <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndActive;
03892 
03893                 <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pwndActive = pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>, &amp;tlpwndT);
03894                 <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwndActive, WM_NCACTIVATE, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, 0);
03895                 <a class="code" href="../../d4/d1/userk_8h.html#a1335">xxxUpdateTray</a>(pwndActive);
03896                 <a class="code" href="../../d4/d1/userk_8h.html#a1615">xxxSetWindowPos</a>(pwndActive, <a class="code" href="../../d4/d1/userk_8h.html#a452">PWND_TOP</a>, 0, 0, 0, 0, SWP_NOSIZE | SWP_NOMOVE);
03897                 <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT);
03898             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pq != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>) {
03899 
03900                 <span class="comment">/*</span>
03901 <span class="comment">                 * If we're not being activated, make sure we don't become foreground.</span>
03902 <span class="comment">                 */</span>
03903                 ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a800">TIF_ALLOWFOREGROUNDACTIVATE</a>;
03904                 TAGMSG1(DBGTAG_FOREGROUND, <span class="stringliteral">"xxxProcessEventMessage clear TIF %#p"</span>, ptiCurrent);
03905                 ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;W32PF_Flags &amp;= ~W32PF_ALLOWFOREGROUNDACTIVATE;
03906                 TAGMSG1(DBGTAG_FOREGROUND, <span class="stringliteral">"xxxProcessEventMessage clear W32PF %#p"</span>, ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>);
03907             }
03908 
03909         } <span class="keywordflow">else</span> {
03910 
03911             pwnd = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>((HWND)pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.lParam);
03912             <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
03913                 <span class="keywordflow">break</span>;
03914 
03915             <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pwnd, &amp;tlpwndT);
03916 
03917             <span class="comment">/*</span>
03918 <span class="comment">             * If nobody is foreground, allow this app to become foreground.</span>
03919 <span class="comment">             */</span>
03920             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03921                 <a class="code" href="../../d4/d1/userk_8h.html#a1225">xxxSetForegroundWindow2</a>(pwnd, ptiCurrent, 0);
03922             } <span class="keywordflow">else</span> {
03923                 <span class="keywordflow">if</span> (pwnd != pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>) {
03924                     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1229">xxxActivateThisWindow</a>(pwnd, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam,
03925                             (<a class="code" href="../../d4/d1/userk_8h.html#a512">ATW_SETFOCUS</a> | <a class="code" href="../../d4/d1/userk_8h.html#a513">ATW_ASYNC</a>) |
03926                             ((pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.message &amp; <a class="code" href="../../d4/d1/userk_8h.html#a358">PEM_ACTIVATE_NOZORDER</a>) ? <a class="code" href="../../d4/d1/userk_8h.html#a514">ATW_NOZORDER</a> : 0))) {
03927 
03928                         <span class="comment">/*</span>
03929 <span class="comment">                         * This event was posted by SetForegroundWindow2</span>
03930 <span class="comment">                         * (i.e. pqmsg-&gt;msg.lParam != 0) so make sure</span>
03931 <span class="comment">                         * mouse is on this window.</span>
03932 <span class="comment">                         */</span>
03933                         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a563">TestUP</a>(ACTIVEWINDOWTRACKING)) {
03934                             <a class="code" href="../../d4/d1/userk_8h.html#a1653">zzzActiveCursorTracking</a>(pwnd);
03935                         }
03936                     }
03937                 } <span class="keywordflow">else</span> {
03938                     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fActive = (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;pq == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>);
03939 
03940                     <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwnd, WM_NCACTIVATE,
03941                             (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(fActive), 0);
03942                     <span class="keywordflow">if</span> (fActive) {
03943                         <a class="code" href="../../d4/d1/userk_8h.html#a1335">xxxUpdateTray</a>(pwnd);
03944                     }
03945 
03946                     <span class="comment">/*</span>
03947 <span class="comment">                     * Only bring the window to the top if it is becoming active.</span>
03948 <span class="comment">                     */</span>
03949                     <span class="keywordflow">if</span> (fActive &amp;&amp; !(pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.message &amp; <a class="code" href="../../d4/d1/userk_8h.html#a358">PEM_ACTIVATE_NOZORDER</a>))
03950                         <a class="code" href="../../d4/d1/userk_8h.html#a1615">xxxSetWindowPos</a>(pwnd, <a class="code" href="../../d4/d1/userk_8h.html#a452">PWND_TOP</a>, 0, 0, 0, 0,
03951                                 SWP_NOSIZE | SWP_NOMOVE);
03952                 }
03953             }
03954 
03955             <span class="comment">/*</span>
03956 <span class="comment">             * Check here to see if the window needs to be restored. This is a</span>
03957 <span class="comment">             * hack so that we're compatible with what msmail expects out of</span>
03958 <span class="comment">             * win3.1 alt-tab. msmail expects to always be active when it gets</span>
03959 <span class="comment">             * asked to be restored. This will ensure that during alt-tab</span>
03960 <span class="comment">             * activate.</span>
03961 <span class="comment">             */</span>
03962             <span class="keywordflow">if</span> (pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.message &amp; <a class="code" href="../../d4/d1/userk_8h.html#a357">PEM_ACTIVATE_RESTORE</a>) {
03963                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>)) {
03964                     <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(pwnd, WM_SYSCOMMAND, SC_RESTORE, 0);
03965                 }
03966             }
03967 
03968             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT);
03969         }
03970 
03971     }
03972         <span class="keywordflow">break</span>;
03973 
03974     <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a338">QEVENT_DEACTIVATE</a>:
03975         <a class="code" href="../../d4/d1/userk_8h.html#a1224">xxxDeactivate</a>(ptiCurrent, (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam);
03976         <span class="keywordflow">break</span>;
03977 
03978     <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a335">QEVENT_CANCELMODE</a>:
03979         <span class="keywordflow">if</span> (pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o6">spwndCapture</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03980             <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o6">spwndCapture</a>, &amp;tlpwndT);
03981             <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pq-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o6">spwndCapture</a>, WM_CANCELMODE, 0, 0);
03982             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT);
03983 
03984             <span class="comment">/*</span>
03985 <span class="comment">             * Set QS_MOUSEMOVE so any sleeping modal loops,</span>
03986 <span class="comment">             * like the move/size code, will wake up and figure</span>
03987 <span class="comment">             * out that it should abort.</span>
03988 <span class="comment">             */</span>
03989             <a class="code" href="../../d4/d1/userk_8h.html#a1197">SetWakeBit</a>(ptiCurrent, QS_MOUSEMOVE);
03990         }
03991         <span class="keywordflow">break</span>;
03992 
03993 
03994     <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a340">QEVENT_POSTMESSAGE</a>:
03995         <span class="comment">/*</span>
03996 <span class="comment">         * This event is used in situations where we need to ensure that posted</span>
03997 <span class="comment">         * messages are processed after previous QEVENT's.  Normally, posting a</span>
03998 <span class="comment">         * queue event and then calling postmessage will result in the posted</span>
03999 <span class="comment">         * message being seen first by the app (because posted messages are</span>
04000 <span class="comment">         * processed before input.) Instead we will post a QEVENT_POSTMESSAGE</span>
04001 <span class="comment">         * instead of doing a postmessage directly, which will result in the</span>
04002 <span class="comment">         * correct ordering of messages.</span>
04003 <span class="comment">         *</span>
04004 <span class="comment">         */</span>
04005 
04006         <span class="keywordflow">if</span> (pwnd = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>((HWND)pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.hwnd)) {
04007 
04008             <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(pwnd,pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.message,pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam,pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.lParam);
04009         }
04010         <span class="keywordflow">break</span>;
04011 
04012 
04013     <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a344">QEVENT_ASYNCSENDMSG</a>:
04014         <a class="code" href="../../d4/d1/userk_8h.html#a1216">xxxProcessAsyncSendMessage</a>((<a class="code" href="../../d5/d8/structtagASYNCSENDMSG.html">PASYNCSENDMSG</a>)pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam);
04015         <span class="keywordflow">break</span>;
04016 
04017     <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a345">QEVENT_HUNGTHREAD</a>:
04018         pwnd = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>((HWND)pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.hwnd);
04019         <span class="keywordflow">if</span> (pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04020             <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pwnd, &amp;tlpwndT);
04021             <a class="code" href="../../d6/d3/queue_8c.html#a62">xxxProcessHungThreadEvent</a>(pwnd);
04022             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT);
04023         }
04024         <span class="keywordflow">break</span>;
04025 
04026     <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a346">QEVENT_CANCELMOUSEMOVETRK</a>: {
04027         <span class="comment">/*</span>
04028 <span class="comment">         * hwnd: hwndTrack. message: dwDTFlags.</span>
04029 <span class="comment">         * wParam: htEx. lParam: dwDTCancel</span>
04030 <span class="comment">         */</span>
04031         <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a> pdesk = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>;
04032         pwnd = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>((HWND)pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.hwnd);
04033         <span class="comment">/*</span>
04034 <span class="comment">         * Let's check that the app didn't manage to restart mouse leave</span>
04035 <span class="comment">         *  tracking before we had a chance to cancel it.</span>
04036 <span class="comment">         */</span>
04037         UserAssert(!(pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.message &amp; <a class="code" href="../../d4/d1/userk_8h.html#a292">DF_TRACKMOUSELEAVE</a>)
04038                     || !(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o4">dwDTFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a292">DF_TRACKMOUSELEAVE</a>)
04039                     || (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a449">PtoHq</a>(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o21">spwndTrack</a>) != pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.hwnd)
04040                     || !((pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o22">htEx</a> == HTCLIENT) ^ ((<span class="keywordtype">int</span>)pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam == HTCLIENT)));
04041         <span class="comment">/*</span>
04042 <span class="comment">         * If we're back tracking at the same spot, bail</span>
04043 <span class="comment">         */</span>
04044         <span class="keywordflow">if</span> ((pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o4">dwDTFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a295">DF_MOUSEMOVETRK</a>)
04045                 &amp;&amp; (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a449">PtoHq</a>(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o21">spwndTrack</a>) == pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.hwnd)
04046                 &amp;&amp; (pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o22">htEx</a> == (<span class="keywordtype">int</span>)pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam)) {
04047             <span class="comment">/*</span>
04048 <span class="comment">             * If we're tracking mouse leave,</span>
04049 <span class="comment">             */</span>
04050             <span class="keywordflow">break</span>;
04051         }
04052         <span class="comment">/*</span>
04053 <span class="comment">         * Don't nuke the tooltip if it has been reactivated.</span>
04054 <span class="comment">         */</span>
04055         <span class="keywordflow">if</span> (pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o4">dwDTFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a290">DF_TOOLTIPACTIVE</a>) {
04056             pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.lParam &amp;= ~<a class="code" href="../../d4/d1/userk_8h.html#a291">DF_TOOLTIP</a>;
04057         }
04058         <span class="comment">/*</span>
04059 <span class="comment">         * Cancel tracking if the window is still around</span>
04060 <span class="comment">         */</span>
04061         <span class="keywordflow">if</span> (pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04062             <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pwnd, &amp;tlpwndT);
04063             <a class="code" href="../../d4/d1/userk_8h.html#a1974">xxxCancelMouseMoveTracking</a>(pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.message, pwnd,
04064                                    (<span class="keywordtype">int</span>)pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam,
04065                                    (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.lParam);
04066             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT);
04067         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.lParam &amp; <a class="code" href="../../d4/d1/userk_8h.html#a291">DF_TOOLTIP</a>)
04068                 &amp;&amp; (pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.message &amp; <a class="code" href="../../d4/d1/userk_8h.html#a289">DF_TOOLTIPSHOWING</a>)) {
04069             <span class="comment">/*</span>
04070 <span class="comment">             * The window is gone and so must be tracking.</span>
04071 <span class="comment">             * Just take care of the tooltip which is still showing.</span>
04072 <span class="comment">             */</span>
04073             pwnd = pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o14">spwndTooltip</a>;
04074             <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pwnd, &amp;tlpwndT);
04075             <a class="code" href="../../d4/d1/userk_8h.html#a1973">xxxResetTooltip</a>((<a class="code" href="../../d8/d8/structtagTOOLTIPWND.html">PTOOLTIPWND</a>)pwnd);
04076             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT);
04077         }
04078     }
04079     <span class="keywordflow">break</span>;
04080 
04081     <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a348">QEVENT_RITACCESSIBILITY</a>:
04082         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a208">IsHooked</a>(ptiCurrent, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a523">WHF_SHELL</a>)) {
04083             <a class="code" href="../../d4/d1/userk_8h.html#a1521">xxxCallHook</a>((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam,
04084                         (WPARAM)pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.lParam,
04085                         (LPARAM)0,
04086                         WH_SHELL);
04087         }
04088 
04089         <a class="code" href="../../d4/d1/userk_8h.html#a1867">PostShellHookMessages</a>((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam, pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.lParam);
04090         <span class="keywordflow">break</span>;
04091 
04092     <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a349">QEVENT_RITSOUND</a>:
04093         <span class="comment">/*</span>
04094 <span class="comment">         * This should only happen on the desktop thread.</span>
04095 <span class="comment">         */</span>
04096         <span class="keywordflow">switch</span>(pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.message) {
04097         <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a351">RITSOUND_UPSIREN</a>:
04098         <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a352">RITSOUND_DOWNSIREN</a>:
04099         <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a353">RITSOUND_LOWBEEP</a>:
04100         <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a354">RITSOUND_HIGHBEEP</a>:
04101         <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a355">RITSOUND_KEYCLICK</a>:
04102             (<a class="code" href="../../d6/d3/queue_8c.html#a15">pfnBP</a>[pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.message])();
04103             <span class="keywordflow">break</span>;
04104 
04105         <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a356">RITSOUND_DOBEEP</a>:
04106             <span class="keywordflow">switch</span>(pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam) {
04107             <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a351">RITSOUND_UPSIREN</a>:
04108             <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a352">RITSOUND_DOWNSIREN</a>:
04109             <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a353">RITSOUND_LOWBEEP</a>:
04110             <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a354">RITSOUND_HIGHBEEP</a>:
04111             <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a355">RITSOUND_KEYCLICK</a>:
04112                 <a class="code" href="../../d2/d9/sirens_8c.html#a15">DoBeep</a>(<a class="code" href="../../d6/d3/queue_8c.html#a15">pfnBP</a>[pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam], (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.lParam);
04113             }
04114             <span class="keywordflow">break</span>;
04115         }
04116         <span class="keywordflow">break</span>;
04117 
04118     <span class="keywordflow">case</span> <a class="code" href="../../d4/d1/userk_8h.html#a350">QEVENT_APPCOMMAND</a>: {
04119         <span class="comment">/*</span>
04120 <span class="comment">         * qevent app commands so we can post a wm_appcommand to the queue</span>
04121 <span class="comment">         */</span>
04122         <a class="code" href="../../d2/d8/structtagTHREADINFO.html">THREADINFO</a>  *ptiWindowOwner;
04123         <span class="keywordtype">int</span>         cmd;
04124         <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>        keystate;
04125 
04126         <span class="comment">/*</span>
04127 <span class="comment">         * check the appcommand's are within reasonable ranges</span>
04128 <span class="comment">         * if they aren't then we have an internal consistency error since xxxKeyEvent should</span>
04129 <span class="comment">         * have generated correct ones for us</span>
04130 <span class="comment">         */</span>
04131         UserAssert( pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.lParam &gt;= VK_APPCOMMAND_FIRST &amp;&amp;
04132                     pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.lParam &lt;= VK_APPCOMMAND_LAST );
04133 
04134         <span class="comment">/*</span>
04135 <span class="comment">         * We need to work out which window to send to here. Using the same</span>
04136 <span class="comment">         * rules as from xxxScanSysQueue:</span>
04137 <span class="comment">         * Assign the input to the focus window. If there is no focus</span>
04138 <span class="comment">         * window, assign it to the active window as a SYS message.</span>
04139 <span class="comment">         */</span>
04140         pwnd = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o7">spwndFocus</a>;
04141         <span class="keywordflow">if</span> (!pwnd) {
04142             pwnd = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>;
04143             <span class="keywordflow">if</span> (!pwnd ) {
04144                 <span class="comment">/*</span>
04145 <span class="comment">                 * At the moment we will just eat the message since we can't find a foreground q</span>
04146 <span class="comment">                 * This follows the method that any other app (eg hidserv) would mimic to</span>
04147 <span class="comment">                 * find the window to send to.</span>
04148 <span class="comment">                 */</span>
04149                 <span class="keywordflow">break</span>;
04150             }
04151         }
04152 
04153         <span class="comment">/*</span>
04154 <span class="comment">         * We don't want to block on another thread since the xxxSendMessage is a synchronous call</span>
04155 <span class="comment">         * so we post the message to the queue of the window owner thread</span>
04156 <span class="comment">         */</span>
04157         ptiWindowOwner = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd);
04158         <span class="keywordflow">if</span> (ptiCurrent != ptiWindowOwner) {
04159             <span class="comment">/*</span>
04160 <span class="comment">             * Post the event message to the window who should get it</span>
04161 <span class="comment">             */</span>
04162             <a class="code" href="../../d4/d1/userk_8h.html#a1217">PostEventMessage</a>(ptiWindowOwner, ptiWindowOwner-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, <a class="code" href="../../d4/d1/userk_8h.html#a350">QEVENT_APPCOMMAND</a>,
04163                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, (WPARAM)0, pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.lParam);
04164 
04165             <span class="comment">/*</span>
04166 <span class="comment">             * break out of this since we've now posted the message to a different q - we</span>
04167 <span class="comment">             * don't want to deal with it here</span>
04168 <span class="comment">             */</span>
04169             <span class="keywordflow">break</span>;
04170         }
04171 
04172         cmd = APPCOMMAND_FIRST + ((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.lParam - VK_APPCOMMAND_FIRST);
04173         keystate = <a class="code" href="../../d4/d1/userk_8h.html#a1641">GetMouseKeyFlags</a>(ptiWindowOwner-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>);
04174         pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.lParam = MAKELPARAM(keystate, cmd);
04175 
04176 
04177         <span class="comment">/*</span>
04178 <span class="comment">         * Generate a WM_APPCOMMAND message from the keyboard keys</span>
04179 <span class="comment">         */</span>
04180         <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pwnd, &amp;tlpwndT);
04181         <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwnd, WM_APPCOMMAND, (WPARAM)pwnd, pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.lParam);
04182         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT);
04183 
04184         <span class="keywordflow">break</span>;
04185     }
04186     <span class="keywordflow">default</span>:
04187         RIPMSG1(RIP_ERROR, <span class="stringliteral">"xxxProcessEventMessage Bad pqmsg-&gt;dwQEvent:%#lx"</span>, pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o4">dwQEvent</a>);
04188         <span class="keywordflow">break</span>;
04189     }
04190 
04191     <a class="code" href="../../d4/d1/userk_8h.html#a141">ThreadUnlockPoolCleanup</a>(ptiCurrent, &amp;tlMsg);
04192 }
04193 
04194 <span class="comment">/***************************************************************************\</span>
04195 <span class="comment">* _GetInputState (API)</span>
04196 <span class="comment">*</span>
04197 <span class="comment">* Returns the current input state for mouse buttons or keys.</span>
04198 <span class="comment">*</span>
04199 <span class="comment">* History:</span>
04200 <span class="comment">* 11-06-90 DavidPe      Created.</span>
04201 <span class="comment">\***************************************************************************/</span>
04202 
<a name="l04203"></a><a class="code" href="../../d6/d3/queue_8c.html#a7">04203</a> <span class="preprocessor">#define QS_TEST_AND_CLEAR (QS_INPUT | QS_POSTMESSAGE | QS_TIMER | QS_PAINT | QS_SENDMESSAGE)</span>
<a name="l04204"></a><a class="code" href="../../d6/d3/queue_8c.html#a8">04204</a> <span class="preprocessor"></span><span class="preprocessor">#define QS_TEST           (QS_MOUSEBUTTON | QS_KEY)</span>
04205 <span class="preprocessor"></span>
<a name="l04206"></a><a class="code" href="../../d4/d1/userk_8h.html#a1647">04206</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1647">_GetInputState</a>(VOID)
04207 {
04208     <span class="keywordflow">if</span> (LOWORD(<a class="code" href="../../d4/d1/userk_8h.html#a1648">_GetQueueStatus</a>(<a class="code" href="../../d6/d3/queue_8c.html#a7">QS_TEST_AND_CLEAR</a>)) &amp; <a class="code" href="../../d6/d3/queue_8c.html#a8">QS_TEST</a>) {
04209         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04210     } <span class="keywordflow">else</span> {
04211         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04212     }
04213 }
04214 
04215 <span class="preprocessor">#undef QS_TEST_AND_CLEAR</span>
04216 <span class="preprocessor"></span><span class="preprocessor">#undef QS_TEST</span>
04217 <span class="preprocessor"></span>
04218 <span class="comment">/***************************************************************************\</span>
04219 <span class="comment">* _GetQueueStatus (API)</span>
04220 <span class="comment">*</span>
04221 <span class="comment">* Returns the changebits in the lo-word and wakebits in</span>
04222 <span class="comment">* the hi-word for the current queue.</span>
04223 <span class="comment">*</span>
04224 <span class="comment">* History:</span>
04225 <span class="comment">* 12-17-90 DavidPe      Created.</span>
04226 <span class="comment">\***************************************************************************/</span>
04227 
<a name="l04228"></a><a class="code" href="../../d4/d1/userk_8h.html#a1648">04228</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d4/d1/userk_8h.html#a1648">_GetQueueStatus</a>(
04229     UINT flags)
04230 {
04231     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent;
04232     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> fsChangeBits;
04233 
04234     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a10">PtiCurrentShared</a>();
04235 
04236     flags &amp;= (QS_ALLINPUT | QS_ALLPOSTMESSAGE | QS_TRANSFER);
04237 
04238     fsChangeBits = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o1">fsChangeBits</a>;
04239 
04240     <span class="comment">/*</span>
04241 <span class="comment">     * Clear out the change bits the app is looking at</span>
04242 <span class="comment">     * so it'll know what changed since it's last call</span>
04243 <span class="comment">     * to GetQueueStatus().</span>
04244 <span class="comment">     */</span>
04245     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o1">fsChangeBits</a> &amp;= ~flags;
04246 
04247     <span class="comment">/*</span>
04248 <span class="comment">     * Return the current change/wake-bits.</span>
04249 <span class="comment">     */</span>
04250     <span class="keywordflow">return</span> MAKELONG(fsChangeBits &amp; flags,
04251             (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o2">fsWakeBits</a> | ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o3">fsWakeBitsJournal</a>) &amp; flags);
04252 }
04253 
04254 <span class="comment">/***************************************************************************\</span>
04255 <span class="comment">* xxxMsgWaitForMultipleObjects (API)</span>
04256 <span class="comment">*</span>
04257 <span class="comment">* Blocks until an 'event' satisifying dwWakeMask occurs for the</span>
04258 <span class="comment">* current thread as well as all other objects specified by the other</span>
04259 <span class="comment">* parameters which are the same as the base call WaitForMultipleObjects().</span>
04260 <span class="comment">*</span>
04261 <span class="comment">* pfnNonMsg indicates that pHandles is big enough for nCount+1 handles</span>
04262 <span class="comment">*     (empty slot at end, and to call pfnNonMsg for non message events.</span>
04263 <span class="comment">*</span>
04264 <span class="comment">* History:</span>
04265 <span class="comment">* 12-17-90 DavidPe      Created.</span>
04266 <span class="comment">\***************************************************************************/</span>
04267 <span class="preprocessor">#ifdef LOCK_MOUSE_CODE</span>
04268 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(MOUSE, xxxMsgWaitForMultipleObjects)</span>
04269 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
04270 <span class="preprocessor"></span>
<a name="l04271"></a><a class="code" href="../../d4/d1/userk_8h.html#a1649">04271</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d4/d1/userk_8h.html#a1649">xxxMsgWaitForMultipleObjects</a>(
04272     DWORD nCount,
04273     PVOID *apObjects,
04274     <a class="code" href="../../d4/d1/userk_8h.html#a920">MSGWAITCALLBACK</a> pfnNonMsg,
04275     <a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html">PKWAIT_BLOCK</a> WaitBlockArray)
04276 {
04277     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
04278     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04279 
04280     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
04281     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a616">IsWinEventNotifyDeferredOK</a>());
04282 
04283     <span class="comment">/*</span>
04284 <span class="comment">     * Setup the wake mask for this thread. Wait for QS_EVENT or the app won't</span>
04285 <span class="comment">     * get event messages like deactivate.</span>
04286 <span class="comment">     */</span>
04287     <a class="code" href="../../d6/d3/queue_8c.html#a42">ClearQueueServerEvent</a>(QS_ALLINPUT | QS_EVENT);
04288 
04289     <span class="comment">/*</span>
04290 <span class="comment">     * Stuff the event handle for the current queue at the end.</span>
04291 <span class="comment">     */</span>
04292     <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a4">apObjects</a>[nCount] = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o35">pEventQueueServer</a>;
04293 
04294     <span class="comment">/*</span>
04295 <span class="comment">     * Check to see if any input came inbetween when we</span>
04296 <span class="comment">     * last checked and the NtClearEvent() call.</span>
04297 <span class="comment">     */</span>
04298     <span class="keywordflow">if</span> (!(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o1">fsChangeBits</a> &amp; QS_ALLINPUT)) {
04299 
04300         <span class="comment">/*</span>
04301 <span class="comment">         * This app is going idle. Clear the spin count check to see</span>
04302 <span class="comment">         * if we need to make this process foreground again.</span>
04303 <span class="comment">         */</span>
04304         <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a804">TIF_SPINNING</a>) {
04305             <a class="code" href="../../d6/d3/queue_8c.html#a18">CheckProcessForeground</a>(ptiCurrent);
04306         }
04307         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o1">cSpins</a> = 0;
04308 
04309         <span class="keywordflow">if</span> (ptiCurrent == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a25">gptiForeground</a> &amp;&amp;
04310                 <a class="code" href="../../d6/d0/usercli_8h.html#a208">IsHooked</a>(ptiCurrent, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a524">WHF_FOREGROUNDIDLE</a>)) {
04311             <a class="code" href="../../d4/d1/userk_8h.html#a1521">xxxCallHook</a>(HC_ACTION, 0, 0, WH_FOREGROUNDIDLE);
04312         }
04313 
04314         <a class="code" href="../../d4/d1/userk_8h.html#a21">CheckForClientDeath</a>();
04315 
04316         <span class="comment">/*</span>
04317 <span class="comment">         * Set the input idle event to wake up any threads waiting</span>
04318 <span class="comment">         * for this thread to go into idle state.</span>
04319 <span class="comment">         */</span>
04320         <a class="code" href="../../d4/d1/userk_8h.html#a1636">zzzWakeInputIdle</a>(ptiCurrent);
04321 
04322 Again:
04323         <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
04324 
04325         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d7/wait_8c.html#a3">KeWaitForMultipleObjects</a>(nCount + 1, <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a4">apObjects</a>,
04326                 WaitAny, <a class="code" href="../../d4/d9/ke_8h.html#a407a211">WrUserRequest</a>,
04327                 <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
04328                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, WaitBlockArray);
04329 
04330         <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
04331 
04332         <a class="code" href="../../d4/d1/userk_8h.html#a21">CheckForClientDeath</a>();
04333 
04334         UserAssert(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
04335 
04336 
04337         <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_WAIT_0) &amp;&amp; (pfnNonMsg != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
04338             <span class="comment">/*</span>
04339 <span class="comment">             * Call pfnNonMsg for the first event</span>
04340 <span class="comment">             */</span>
04341             pfnNonMsg(<a class="code" href="../../d4/d1/userk_8h.html#a175">DEVICE_TYPE_MOUSE</a>);
04342 
04343             <span class="comment">/*</span>
04344 <span class="comment">             * Setup again the wake mask for this thread.</span>
04345 <span class="comment">             * Wait for QS_EVENT or the app won't</span>
04346 <span class="comment">             * get event messages like deactivate.</span>
04347 <span class="comment">             */</span>
04348             ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o4">fsWakeMask</a> = QS_ALLINPUT | QS_EVENT;
04349             <span class="keywordflow">goto</span> Again;
04350         }
04351 
04352         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)(STATUS_WAIT_0 + nCount)) {
04353 
04354             <span class="comment">/*</span>
04355 <span class="comment">             * Reset the input idle event to block and threads waiting</span>
04356 <span class="comment">             * for this thread to go into idle state.</span>
04357 <span class="comment">             */</span>
04358             <a class="code" href="../../d4/d1/userk_8h.html#a1637">SleepInputIdle</a>(ptiCurrent);
04359         }
04360     } <span class="keywordflow">else</span> {
04361         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = nCount;
04362     }
04363 
04364     <span class="comment">/*</span>
04365 <span class="comment">     * Clear fsWakeMask since we're no longer waiting on the queue.</span>
04366 <span class="comment">     */</span>
04367     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o4">fsWakeMask</a> = 0;
04368 
04369     <span class="keywordflow">return</span> (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04370 }
04371 
04372 <span class="comment">/***************************************************************************\</span>
04373 <span class="comment">* xxxSleepThread</span>
04374 <span class="comment">*</span>
04375 <span class="comment">* Blocks until an 'event' satisifying fsWakeMask occurs for the</span>
04376 <span class="comment">* current thread.</span>
04377 <span class="comment">*</span>
04378 <span class="comment">* History:</span>
04379 <span class="comment">* 10-28-90 DavidPe      Created.</span>
04380 <span class="comment">\***************************************************************************/</span>
04381 
<a name="l04382"></a><a class="code" href="../../d4/d1/userk_8h.html#a1196">04382</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1196">xxxSleepThread</a>(
04383     UINT fsWakeMask,
04384     DWORD Timeout,
04385     BOOL fInputIdle)
04386 {
04387     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent;
04388     LARGE_INTEGER li, *pli;
04389     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
04390     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fExclusive = fsWakeMask &amp; QS_EXCLUSIVE;
04391     WORD fsWakeMaskSaved;
04392 
04393     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a616">IsWinEventNotifyDeferredOK</a>());
04394 
04395     <span class="keywordflow">if</span> (fExclusive) {
04396         <span class="comment">/*</span>
04397 <span class="comment">         * the exclusive bit is a 'dummy' arg, turn it off to</span>
04398 <span class="comment">         * avoid any possible conflictions</span>
04399 <span class="comment">         */</span>
04400         fsWakeMask = fsWakeMask &amp; ~QS_EXCLUSIVE;
04401     }
04402 
04403     <span class="keywordflow">if</span> (Timeout) {
04404         <span class="comment">/*</span>
04405 <span class="comment">         * Convert dwMilliseconds to a relative-time(i.e.  negative)</span>
04406 <span class="comment">         * LARGE_INTEGER.  NT Base calls take time values in 100 nanosecond</span>
04407 <span class="comment">         * units.</span>
04408 <span class="comment">         */</span>
04409         li.QuadPart = Int32x32To64(-10000, Timeout);
04410         pli = &amp;li;
04411     } <span class="keywordflow">else</span>
04412         pli = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04413 
04414     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
04415 
04416     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
04417 
04418     fsWakeMaskSaved = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o4">fsWakeMask</a>;
04419 
04420     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
04421 
04422         <span class="comment">/*</span>
04423 <span class="comment">         * First check if the input has arrived.</span>
04424 <span class="comment">         */</span>
04425         <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o1">fsChangeBits</a> &amp; fsWakeMask) {
04426             <span class="comment">/*</span>
04427 <span class="comment">             * Restore the wake mask to what it was before we went to sleep</span>
04428 <span class="comment">             * to allow possible callbacks before KeWait... but after the mask</span>
04429 <span class="comment">             * has been set and also APCs from KeWait... to still be able to</span>
04430 <span class="comment">             * wake up. Simply clearing the mask here if we're in such a</span>
04431 <span class="comment">             * callback or in an APC means that the thread will never wake up.</span>
04432 <span class="comment">             */</span>
04433             ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o4">fsWakeMask</a> = fsWakeMaskSaved;
04434 
04435             <span class="comment">/*</span>
04436 <span class="comment">             * Update timeLastRead - it is used for hung app calculations.</span>
04437 <span class="comment">             * If the thread is waking up to process input, it isn't hung!</span>
04438 <span class="comment">             */</span>
04439             <a class="code" href="../../d4/d1/userk_8h.html#a257">SET_TIME_LAST_READ</a>(ptiCurrent);
04440             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04441         }
04442 
04443         <span class="comment">/*</span>
04444 <span class="comment">         * Next check for SendMessages</span>
04445 <span class="comment">         */</span>
04446         <span class="keywordflow">if</span> (!fExclusive &amp;&amp; ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o2">fsWakeBits</a> &amp; QS_SENDMESSAGE) {
04447             <a class="code" href="../../d4/d1/userk_8h.html#a502">xxxReceiveMessages</a>(ptiCurrent);
04448 
04449             <span class="comment">/*</span>
04450 <span class="comment">             * Restore the change bits we took out in PeekMessage()</span>
04451 <span class="comment">             */</span>
04452             ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o1">fsChangeBits</a> |= (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o2">fsWakeBits</a> &amp; ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o44">fsChangeBitsRemoved</a>);
04453             ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o44">fsChangeBitsRemoved</a> = 0;
04454         }
04455 
04456         <span class="comment">/*</span>
04457 <span class="comment">         * Check to see if some resources need expunging.</span>
04458 <span class="comment">         * This will unload Hook DLLs, including WinEvent ones</span>
04459 <span class="comment">         */</span>
04460         <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o11">cSysExpunge</a> != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a153">gcSysExpunge</a>) {
04461             ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o11">cSysExpunge</a> = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a153">gcSysExpunge</a>;
04462             <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o12">dwhmodLibLoadedMask</a> &amp; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a152">gdwSysExpungeMask</a>)
04463                 <a class="code" href="../../d4/d1/userk_8h.html#a1545">xxxDoSysExpunge</a>(ptiCurrent);
04464         }
04465 
04466         <span class="comment">/*</span>
04467 <span class="comment">         * OR QS_SENDMESSAGE in since ReceiveMessage() will end up</span>
04468 <span class="comment">         * trashing pq-&gt;fsWakeMask.  Do the same for QS_SYSEXPUNGE.</span>
04469 <span class="comment">         */</span>
04470         <a class="code" href="../../d6/d3/queue_8c.html#a42">ClearQueueServerEvent</a>((WORD)(fsWakeMask | (fExclusive ? 0 : QS_SENDMESSAGE)));
04471 
04472         <span class="comment">/*</span>
04473 <span class="comment">         * If we have timed out then return our error to the caller.</span>
04474 <span class="comment">         */</span>
04475         <span class="keywordflow">if</span> (status == STATUS_TIMEOUT) {
04476             RIPERR1(ERROR_TIMEOUT, RIP_VERBOSE, <span class="stringliteral">"SleepThread: The timeout has expired %lX"</span>, Timeout);
04477             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04478         }
04479 
04480         <span class="comment">/*</span>
04481 <span class="comment">         * Because we do a non-alertable wait, we know that a status</span>
04482 <span class="comment">         * of STATUS_USER_APC means that the thread was terminated.</span>
04483 <span class="comment">         * If we have terminated, get back to user mode.</span>
04484 <span class="comment">         */</span>
04485         <span class="keywordflow">if</span> (status == STATUS_USER_APC) {
04486             <a class="code" href="../../d4/d1/userk_8h.html#a1928">ClientDeliverUserApc</a>();
04487             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04488         }
04489 
04490         <span class="comment">/*</span>
04491 <span class="comment">         * If this is the power state callout thread, we might need to bail</span>
04492 <span class="comment">         * out early.</span>
04493 <span class="comment">         */</span>
04494         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a313">gPowerState</a>.<a class="code" href="../../d6/d3/structtagPOWERSTATE.html#o5">pEvent</a> == ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o35">pEventQueueServer</a>) {
04495             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a313">gPowerState</a>.<a class="code" href="../../d6/d3/structtagPOWERSTATE.html#o1">fCritical</a>) {
04496                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04497             }
04498         }
04499 
04500         UserAssert(status == STATUS_SUCCESS);
04501         <span class="comment">/*</span>
04502 <span class="comment">         * Check to see if any input came inbetween when we</span>
04503 <span class="comment">         * last checked and the NtClearEvent() call.</span>
04504 <span class="comment">         *</span>
04505 <span class="comment">         * We call NtWaitForSingleObject() rather than</span>
04506 <span class="comment">         * WaitForSingleObject() so we can set fAlertable</span>
04507 <span class="comment">         * to TRUE and thus allow timer APCs to be processed.</span>
04508 <span class="comment">         */</span>
04509         <span class="keywordflow">if</span> (!(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o1">fsChangeBits</a> &amp; ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o4">fsWakeMask</a>)) {
04510             <span class="comment">/*</span>
04511 <span class="comment">             * This app is going idle. Clear the spin count check to see</span>
04512 <span class="comment">             * if we need to make this process foreground again.</span>
04513 <span class="comment">             */</span>
04514             <span class="keywordflow">if</span> (fInputIdle) {
04515                 <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a804">TIF_SPINNING</a>) {
04516                     <a class="code" href="../../d6/d3/queue_8c.html#a18">CheckProcessForeground</a>(ptiCurrent);
04517                 }
04518                 ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o1">cSpins</a> = 0;
04519             }
04520 
04521 
04522             <span class="keywordflow">if</span> (!(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>))  {
04523                 <span class="keywordflow">if</span> (fInputIdle &amp;&amp; ptiCurrent == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a25">gptiForeground</a> &amp;&amp;
04524                         <a class="code" href="../../d6/d0/usercli_8h.html#a208">IsHooked</a>(ptiCurrent, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a524">WHF_FOREGROUNDIDLE</a>)) {
04525                     <a class="code" href="../../d4/d1/userk_8h.html#a1521">xxxCallHook</a>(HC_ACTION, 0, 0, WH_FOREGROUNDIDLE);
04526                 }
04527 
04528                 <a class="code" href="../../d4/d1/userk_8h.html#a21">CheckForClientDeath</a>();
04529 
04530                 <span class="comment">/*</span>
04531 <span class="comment">                 * Set the input idle event to wake up any threads waiting</span>
04532 <span class="comment">                 * for this thread to go into idle state.</span>
04533 <span class="comment">                 */</span>
04534                 <span class="keywordflow">if</span> (fInputIdle)
04535                     <a class="code" href="../../d4/d1/userk_8h.html#a1636">zzzWakeInputIdle</a>(ptiCurrent);
04536 
04537                 <a class="code" href="../../d4/d1/userk_8h.html#a1556">xxxSleepTask</a>(fInputIdle, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04538 
04539                 <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
04540                 status = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(ptiCurrent-&gt;pEventQueueServer,
04541                         <a class="code" href="../../d4/d9/ke_8h.html#a407a211">WrUserRequest</a>, <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, pli);
04542                 <a class="code" href="../../d4/d1/userk_8h.html#a21">CheckForClientDeath</a>();
04543                 <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
04544 
04545                 <span class="comment">/*</span>
04546 <span class="comment">                 * Reset the input idle event to block and threads waiting</span>
04547 <span class="comment">                 * for this thread to go into idle state.</span>
04548 <span class="comment">                 */</span>
04549                 <a class="code" href="../../d4/d1/userk_8h.html#a1637">SleepInputIdle</a>(ptiCurrent);
04550 
04551                 <span class="comment">/*</span>
04552 <span class="comment">                 *  ptiCurrent is 16bit!</span>
04553 <span class="comment">                 */</span>
04554             } <span class="keywordflow">else</span> {
04555                 <span class="keywordflow">if</span> (fInputIdle)
04556                     <a class="code" href="../../d4/d1/userk_8h.html#a1636">zzzWakeInputIdle</a>(ptiCurrent);
04557 
04558                 <a class="code" href="../../d4/d1/userk_8h.html#a1556">xxxSleepTask</a>(fInputIdle, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04559             }
04560         }
04561     }
04562 }
04563 
04564 
04565 <span class="comment">/***************************************************************************\</span>
04566 <span class="comment">* SetWakeBit</span>
04567 <span class="comment">*</span>
04568 <span class="comment">* Adds the specified wake bit to specified THREADINFO and wakes its</span>
04569 <span class="comment">* thread up if the bit is in its fsWakeMask.</span>
04570 <span class="comment">*</span>
04571 <span class="comment">* Nothing will happen in the system unless we come to this function.</span>
04572 <span class="comment">*  so be fast and small.</span>
04573 <span class="comment">*</span>
04574 <span class="comment">* History:</span>
04575 <span class="comment">* 10-28-90 DavidPe      Created.</span>
04576 <span class="comment">\***************************************************************************/</span>
04577 
<a name="l04578"></a><a class="code" href="../../d4/d1/userk_8h.html#a1197">04578</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1197">SetWakeBit</a>(
04579     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti,
04580     UINT wWakeBit)
04581 {
04582     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
04583 
04584     UserAssert(pti);
04585 
04586     <span class="comment">/*</span>
04587 <span class="comment">     * Win3.1 changes ptiKeyboard and ptiMouse accordingly if we're setting</span>
04588 <span class="comment">     * those bits.</span>
04589 <span class="comment">     */</span>
04590     <span class="keywordflow">if</span> (wWakeBit &amp; QS_MOUSE)
04591         pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o4">ptiMouse</a> = pti;
04592 
04593     <span class="keywordflow">if</span> (wWakeBit &amp; QS_KEY)
04594         pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o5">ptiKeyboard</a> = pti;
04595 
04596     <span class="comment">/*</span>
04597 <span class="comment">     * OR in these bits - these bits represent what input this app has</span>
04598 <span class="comment">     * (fsWakeBits), or what input has arrived since that last look</span>
04599 <span class="comment">     * (fsChangeBits).</span>
04600 <span class="comment">     */</span>
04601     pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o2">fsWakeBits</a> |= wWakeBit;
04602     pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o1">fsChangeBits</a> |= wWakeBit;
04603 
04604     <span class="comment">/*</span>
04605 <span class="comment">     * Before waking, do screen saver check to see if it should</span>
04606 <span class="comment">     * go away.</span>
04607 <span class="comment">     */</span>
04608     <span class="keywordflow">if</span> ((wWakeBit &amp; QS_INPUT)
04609             &amp;&amp; (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;W32PF_Flags &amp; W32PF_IDLESCREENSAVER)) {
04610         <span class="keywordflow">if</span> ((wWakeBit &amp; QS_MOUSEMOVE)
04611             &amp;&amp; (<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;ptCursor.x == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a159">gptSSCursor</a>.x)
04612             &amp;&amp; (<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;ptCursor.y == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a159">gptSSCursor</a>.y)) {
04613             <span class="keywordflow">goto</span> SkipScreenSaverStuff;
04614         }
04615 
04616         <span class="comment">/*</span>
04617 <span class="comment">         * Our idle screen saver needs to be given a priority boost so that it</span>
04618 <span class="comment">         * can process input.</span>
04619 <span class="comment">         */</span>
04620         pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;W32PF_Flags &amp;= ~W32PF_IDLESCREENSAVER;
04621         <a class="code" href="../../d4/d1/userk_8h.html#a1334">SetForegroundPriority</a>(pti, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
04622     }
04623 
04624 SkipScreenSaverStuff:
04625     <span class="keywordflow">if</span> (wWakeBit &amp; pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o4">fsWakeMask</a>) {
04626         <span class="comment">/*</span>
04627 <span class="comment">         * Wake the Thread</span>
04628 <span class="comment">         */</span>
04629         <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>) {
04630             pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o22">ptdb</a>-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o1">nEvents</a>++;
04631             <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;nEvents++;
04632             <a class="code" href="../../d4/d1/userk_8h.html#a1560">WakeWowTask</a>(pti);
04633         } <span class="keywordflow">else</span> {
04634             <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o35">pEventQueueServer</a>, 2, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04635         }
04636     }
04637 }
04638 
04639 <span class="comment">/***************************************************************************\</span>
04640 <span class="comment">* TransferWakeBit</span>
04641 <span class="comment">*</span>
04642 <span class="comment">* We have a mesasge from the system queue. If out input bit for this</span>
04643 <span class="comment">* message isn't set, set ours and clear the guy whose bit was set</span>
04644 <span class="comment">* because of this message.</span>
04645 <span class="comment">*</span>
04646 <span class="comment">* 10-22-92 ScottLu      Created.</span>
04647 <span class="comment">\***************************************************************************/</span>
04648 
<a name="l04649"></a><a class="code" href="../../d4/d1/userk_8h.html#a1473">04649</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1473">TransferWakeBit</a>(
04650     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti,
04651     UINT message)
04652 {
04653     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiT;
04654     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> fsMask;
04655 
04656     <span class="comment">/*</span>
04657 <span class="comment">     * Calculate the mask from the message range. Only interested</span>
04658 <span class="comment">     * in hardware input here: mouse and keys.</span>
04659 <span class="comment">     */</span>
04660     fsMask = <a class="code" href="../../d7/d3/ntuser_2rtl_2input_8c.html#a1">CalcWakeMask</a>(message, message, 0) &amp; (QS_MOUSE | QS_KEY);
04661 
04662     <span class="comment">/*</span>
04663 <span class="comment">     * If it is set in this thread's wakebits, nothing to do.</span>
04664 <span class="comment">     * Otherwise transfer them from the owner to this thread.</span>
04665 <span class="comment">     */</span>
04666     <span class="keywordflow">if</span> (!(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o2">fsWakeBits</a> &amp; fsMask)) {
04667         <span class="comment">/*</span>
04668 <span class="comment">         * Either mouse or key is set (not both). Remove this bit</span>
04669 <span class="comment">         * from the thread that currently owns it, and change mouse /</span>
04670 <span class="comment">         * key ownership to this thread.</span>
04671 <span class="comment">         */</span>
04672         <span class="keywordflow">if</span> (fsMask &amp; QS_KEY) {
04673             ptiT = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o5">ptiKeyboard</a>;
04674             pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o5">ptiKeyboard</a> = pti;
04675         } <span class="keywordflow">else</span> {
04676             ptiT = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o4">ptiMouse</a>;
04677             pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o4">ptiMouse</a> = pti;
04678         }
04679         ptiT-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o2">fsWakeBits</a> &amp;= ~fsMask;
04680 
04681         <span class="comment">/*</span>
04682 <span class="comment">         * Transfer them to this thread (certainly this may be the</span>
04683 <span class="comment">         * same thread for win32 threads not sharing queues).</span>
04684 <span class="comment">         */</span>
04685         pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o2">fsWakeBits</a> |= fsMask;
04686         pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o1">fsChangeBits</a> |= fsMask;
04687     }
04688 }
04689 
04690 <span class="comment">/***************************************************************************\</span>
04691 <span class="comment">* ClearWakeBit</span>
04692 <span class="comment">*</span>
04693 <span class="comment">* Clears wake bits. If fSysCheck is TRUE, this clears the input bits only</span>
04694 <span class="comment">* if no messages are in the input queue. Otherwise, it clears input bits</span>
04695 <span class="comment">* unconditionally.</span>
04696 <span class="comment">*</span>
04697 <span class="comment">* 11-05-92 ScottLu      Created.</span>
04698 <span class="comment">\***************************************************************************/</span>
04699 
<a name="l04700"></a><a class="code" href="../../d4/d1/userk_8h.html#a1199">04700</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1199">ClearWakeBit</a>(
04701     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti,
04702     UINT wWakeBit,
04703     BOOL fSysCheck)
04704 {
04705 
04706     <span class="comment">/*</span>
04707 <span class="comment">     * If fSysCheck is TRUE, clear bits only if we are not doing journal</span>
04708 <span class="comment">     * playback and there are no more messages in the queue. fSysCheck</span>
04709 <span class="comment">     * is TRUE if clearing because of no more input.  FALSE if just</span>
04710 <span class="comment">     * transfering input ownership from one thread to another.</span>
04711 <span class="comment">     */</span>
04712     <span class="keywordflow">if</span> (fSysCheck) {
04713         <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o0">mlInput</a>.<a class="code" href="../../d6/d1/structtagMLIST.html#o2">cMsgs</a> != 0 || <a class="code" href="../../d4/d1/userk_8h.html#a419">FJOURNALPLAYBACK</a>())
04714             <span class="keywordflow">return</span>;
04715         <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o21">QF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a860">QF_MOUSEMOVED</a>)
04716             wWakeBit &amp;= ~QS_MOUSEMOVE;
04717     }
04718 
04719     <span class="comment">/*</span>
04720 <span class="comment">     * Only clear the wake bits, not the change bits as well!</span>
04721 <span class="comment">     */</span>
04722     pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o2">fsWakeBits</a> &amp;= ~wWakeBit;
04723 }
04724 
04725 
04726 
04727 <span class="comment">/***************************************************************************\</span>
04728 <span class="comment">* PtiFromThreadId</span>
04729 <span class="comment">*</span>
04730 <span class="comment">* Returns the THREADINFO for the specified thread or NULL if thread</span>
04731 <span class="comment">* doesn't exist or doesn't have a THREADINFO.</span>
04732 <span class="comment">*</span>
04733 <span class="comment">* History:</span>
04734 <span class="comment">* 01-30-91  DavidPe     Created.</span>
04735 <span class="comment">\***************************************************************************/</span>
04736 
<a name="l04737"></a><a class="code" href="../../d4/d1/userk_8h.html#a1201">04737</a> <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> <a class="code" href="../../d4/d1/userk_8h.html#a1201">PtiFromThreadId</a>(
04738     DWORD dwThreadId)
04739 {
04740     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> pEThread;
04741     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti;
04742 
04743     <span class="comment">/*</span>
04744 <span class="comment">     * BUG BUG: Pretty much every place else we do call LockThreadByClientId</span>
04745 <span class="comment">     * while outside the user critical section so we don't cause any</span>
04746 <span class="comment">     * potential deadlock in the kernel.</span>
04747 <span class="comment">     * It's too late to change it now. 2/17/99</span>
04748 <span class="comment">     */</span>
04749 
04750     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d4/d1/userk_8h.html#a1259">LockThreadByClientId</a>((HANDLE)LongToHandle( dwThreadId ), &amp;pEThread)))
04751         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04752 
04753     <span class="comment">/*</span>
04754 <span class="comment">     * If the thread is not terminating, look up the pti.  This is</span>
04755 <span class="comment">     * needed because the value returned by PtiFromThread() is</span>
04756 <span class="comment">     * undefined if the thread is terminating.  See PspExitThread in</span>
04757 <span class="comment">     * ntos\ps\psdelete.c.</span>
04758 <span class="comment">     */</span>
04759     <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d9/ps_8h.html#a27">PsIsThreadTerminating</a>(pEThread)) {
04760         pti = <a class="code" href="../../d4/d1/userk_8h.html#a17">PtiFromThread</a>(pEThread);
04761     } <span class="keywordflow">else</span> {
04762         pti = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04763     }
04764 
04765     <span class="comment">/*</span>
04766 <span class="comment">     * Do a sanity check on the pti to make sure it's really valid.</span>
04767 <span class="comment">     */</span>
04768     <span class="keywordflow">if</span> (pti != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04769         <span class="keywordflow">try</span> {
04770             <span class="keywordflow">if</span> (pti-&gt;pEThread-&gt;Cid.UniqueThread != (HANDLE)LongToHandle( dwThreadId )) {
04771                 pti = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04772             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a816">TIF_GUITHREADINITIALIZED</a>)) {
04773                 RIPMSG1(RIP_WARNING, <span class="stringliteral">"PtiFromThreadId: pti %#p not initialized"</span>, pti);
04774                 pti = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04775             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a795">TIF_INCLEANUP</a>) {
04776                 RIPMSG1(RIP_WARNING, <span class="stringliteral">"PtiFromThreadId: pti %#p in cleanup"</span>, pti);
04777                 pti = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04778             }
04779         } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, RIP_WARNING)) {
04780             pti = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04781         }
04782     }
04783 
04784     <a class="code" href="../../d4/d1/userk_8h.html#a518">UnlockThread</a>(pEThread);
04785 
04786     <span class="keywordflow">return</span> pti;
04787 }
04788 
04789 
04790 <span class="comment">/***************************************************************************\</span>
04791 <span class="comment">* StoreMessage</span>
04792 <span class="comment">*</span>
04793 <span class="comment">*</span>
04794 <span class="comment">*</span>
04795 <span class="comment">* History:</span>
04796 <span class="comment">* 10-31-90 DarrinM      Ported from Win 3.0 sources.</span>
04797 <span class="comment">\***************************************************************************/</span>
04798 
<a name="l04799"></a><a class="code" href="../../d4/d1/userk_8h.html#a1502">04799</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1502">StoreMessage</a>(
04800     LPMSG pmsg,
04801     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
04802     UINT message,
04803     WPARAM wParam,
04804     LPARAM lParam,
04805     DWORD time)
04806 {
04807     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
04808 
04809     pmsg-&gt;hwnd = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwnd);
04810     pmsg-&gt;message = message;
04811     pmsg-&gt;wParam = wParam;
04812     pmsg-&gt;lParam = lParam;
04813     pmsg-&gt;time = (time != 0 ? time : <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>());
04814 
04815     pmsg-&gt;pt = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;ptCursor;
04816 }
04817 
04818 
04819 <span class="comment">/***************************************************************************\</span>
04820 <span class="comment">* StoreQMessage</span>
04821 <span class="comment">*</span>
04822 <span class="comment">* If 'time' is 0 grab the current time, if not, it means that this message</span>
04823 <span class="comment">* is for an input event and eventually the mouse/keyboard hooks want to see</span>
04824 <span class="comment">* the right time stamps.</span>
04825 <span class="comment">*</span>
04826 <span class="comment">* History:</span>
04827 <span class="comment">* 02-27-91 DavidPe      Created.</span>
04828 <span class="comment">* 06-15-96 CLupu        Add 'time' parameter</span>
04829 <span class="comment">\***************************************************************************/</span>
04830 
<a name="l04831"></a><a class="code" href="../../d4/d1/userk_8h.html#a1503">04831</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1503">StoreQMessage</a>(
04832     <a class="code" href="../../d8/d4/structtagQMSG.html">PQMSG</a> pqmsg,
04833     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pwnd,
04834     UINT  message,
04835     WPARAM wParam,
04836     LPARAM lParam,
04837     DWORD time,
04838     DWORD dwQEvent,
04839     ULONG_PTR dwExtraInfo)
04840 {
04841     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
04842 
04843     pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.hwnd    = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwnd);
04844     pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.message = message;
04845     pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam  = wParam;
04846     pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.lParam  = lParam;
04847     pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.time    = (time == 0) ? <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>() : time;
04848 
04849 <span class="preprocessor">#ifdef REDIRECTION</span>
04850 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (message &gt;= WM_MOUSEFIRST &amp;&amp; message &lt;= WM_MOUSELAST) {
04851         pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.pt.x = LOWORD(lParam);
04852         pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.pt.y = HIWORD(lParam);
04853     } <span class="keywordflow">else</span> {
04854         pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.pt = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;ptCursor;
04855     }
04856 <span class="preprocessor">#else</span>
04857 <span class="preprocessor"></span>    pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.pt      = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;ptCursor;
04858 <span class="preprocessor">#endif</span>
04859 <span class="preprocessor"></span>    pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o4">dwQEvent</a>    = dwQEvent;
04860     pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o3">ExtraInfo</a>   = dwExtraInfo;
04861 }
04862 
04863 
04864 <span class="comment">/***************************************************************************\</span>
04865 <span class="comment">* xxxInitProcessInfo</span>
04866 <span class="comment">*</span>
04867 <span class="comment">* This initializes the process info. Usually gets created before the</span>
04868 <span class="comment">* CreateProcess() call returns (so we can synchronize with the starting</span>
04869 <span class="comment">* process in several different ways).</span>
04870 <span class="comment">*</span>
04871 <span class="comment">* 09-18-91 ScottLu      Created.</span>
04872 <span class="comment">\***************************************************************************/</span>
04873 
<a name="l04874"></a><a class="code" href="../../d4/d1/userk_8h.html#a1200">04874</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d4/d1/userk_8h.html#a1200">xxxInitProcessInfo</a>(
04875     PW32PROCESS pwp)
04876 {
04877     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppi = (<a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a>)pwp;
04878     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04879 
04880     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
04881 
04882     <span class="comment">/*</span>
04883 <span class="comment">     * Check if we need to initialize the process.</span>
04884 <span class="comment">     */</span>
04885     <span class="keywordflow">if</span> (pwp-&gt;W32PF_Flags &amp; W32PF_PROCESSCONNECTED) {
04886         <span class="keywordflow">return</span> STATUS_ALREADY_WIN32;
04887     }
04888     pwp-&gt;W32PF_Flags |= W32PF_PROCESSCONNECTED;
04889 
04890 <span class="preprocessor">#if defined(_WIN64)</span>
04891 <span class="preprocessor"></span>    <span class="comment">/* Tag as emulated 32bit.  Flag is copied to be consistent with</span>
04892 <span class="comment">     * the way WOW16 apps are tagged for win32k.</span>
04893 <span class="comment">     */</span>
04894     <span class="keywordflow">if</span> (pwp-&gt;Process-&gt;Wow64Process) {
04895         pwp-&gt;W32PF_Flags |= W32PF_WOW64;
04896     }
04897 <span class="preprocessor">#endif</span>
04898 <span class="preprocessor"></span>
04899     <span class="comment">/*</span>
04900 <span class="comment">     * Mark this app as "starting" - it will be starting until its first</span>
04901 <span class="comment">     * window activates.</span>
04902 <span class="comment">     */</span>
04903     UserVerify(<a class="code" href="../../d6/d3/queue_8c.html#a26">xxxSetProcessInitState</a>(pwp-&gt;Process, STARTF_FORCEOFFFEEDBACK));
04904 
04905     <span class="comment">/*</span>
04906 <span class="comment">     * link it into the starting processes list</span>
04907 <span class="comment">     */</span>
04908     <a class="code" href="../../d6/d3/queue_8c.html#a25">SetAppStarting</a>(ppi);
04909     <span class="comment">/*</span>
04910 <span class="comment">     * link it into the global processes list</span>
04911 <span class="comment">     */</span>
04912     ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o8">ppiNextRunning</a> = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a110">gppiList</a>;
04913     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a110">gppiList</a> = ppi;
04914     <span class="comment">/*</span>
04915 <span class="comment">     * If foreground activation has not been canceled and the parent process</span>
04916 <span class="comment">     *  (or an ancestor) can force a foreground change, then allow this process</span>
04917 <span class="comment">     *  to come to the foreground when it does its first activation.</span>
04918 <span class="comment">     *</span>
04919 <span class="comment">     * Bug 273518 - joejo</span>
04920 <span class="comment">     *</span>
04921 <span class="comment">     * This will allow console windows to set foreground correctly on new</span>
04922 <span class="comment">     * process' it launches, as opposed it just forcing foreground.</span>
04923 <span class="comment">     */</span>
04924     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a657">TEST_PUDF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a647">PUDF_ALLOWFOREGROUNDACTIVATE</a>) &amp;&amp; <a class="code" href="../../d6/d3/queue_8c.html#a27">CheckAllowForeground</a>(pwp-&gt;Process)) {
04925         ppi-&gt;W32PF_Flags |= W32PF_ALLOWFOREGROUNDACTIVATE;
04926     }
04927     TAGMSG2(DBGTAG_FOREGROUND, <span class="stringliteral">"xxxInitProcessInfo %s W32PF %#p"</span>,
04928             ((ppi-&gt;W32PF_Flags &amp; W32PF_ALLOWFOREGROUNDACTIVATE) ? <span class="stringliteral">"set"</span> : <span class="stringliteral">"NOT"</span>),
04929             ppi);
04930 
04931     <span class="comment">/*</span>
04932 <span class="comment">     * Get the logon session id.  This is used to determine which</span>
04933 <span class="comment">     * windowstation to connect to and to identify attempts to</span>
04934 <span class="comment">     * call hooks across security contexts.</span>
04935 <span class="comment">     */</span>
04936     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/userk_8h.html#a961">GetProcessLuid</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;ppi-&gt;luidSession);
04937     UserAssert(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
04938 
04939     <span class="comment">/*</span>
04940 <span class="comment">     * Ensure that we're in sync with the expunge count</span>
04941 <span class="comment">     */</span>
04942     ppi-&gt;cSysExpunge = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a153">gcSysExpunge</a>;
04943 
04944     <span class="comment">/*</span>
04945 <span class="comment">     * Don't perform any LPK callbacks until GDI notifies</span>
04946 <span class="comment">     * us that the LPK(s) are loaded and initialized.</span>
04947 <span class="comment">     */</span>
04948     ppi-&gt;dwLpkEntryPoints = 0;
04949 
04950     <span class="keywordflow">return</span> STATUS_SUCCESS;
04951 }
04952 
04953 <span class="comment">/***************************************************************************\</span>
04954 <span class="comment">* DestroyProcessInfo</span>
04955 <span class="comment">*</span>
04956 <span class="comment">* This function is executed when the last thread of a process goes</span>
04957 <span class="comment">*  away.</span>
04958 <span class="comment">*</span>
04959 <span class="comment">* SO VERY IMPORTANT:</span>
04960 <span class="comment">*  Note that the last thread of the process might not be a w32 thread.</span>
04961 <span class="comment">*  So do not make any calls here that assume a w32 pti. Do avoid</span>
04962 <span class="comment">*   any function calling PtiCurrent() as it probably assumes it is</span>
04963 <span class="comment">*   on a nice w32 thread.</span>
04964 <span class="comment">*  Also note that if the process is locked, the ppi is not going away; this</span>
04965 <span class="comment">*   simply means that execution on this process has ended. So make sure to clean</span>
04966 <span class="comment">*   up in a way that the ppi data is still valid (for example, if you free a pointer,</span>
04967 <span class="comment">*   set it to NULL).</span>
04968 <span class="comment">*</span>
04969 <span class="comment">* zzz Note: Not a zzz routine although it calls zzzCalcStartCursorHide() -</span>
04970 <span class="comment">*           Since we can't make callbacks on a non-GUI thread, we use</span>
04971 <span class="comment">*           DeferWinEventNotify() &amp; EndDeferWinEventNotifyWithoutProcessing()</span>
04972 <span class="comment">*           to prevent callbacks.</span>
04973 <span class="comment">*</span>
04974 <span class="comment">* 04/08/96 GerardoB     Added header</span>
04975 <span class="comment">\***************************************************************************/</span>
<a name="l04976"></a><a class="code" href="../../d4/d1/userk_8h.html#a1190">04976</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1190">DestroyProcessInfo</a>(
04977     PW32PROCESS pwp)
04978 {
04979     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppi = (<a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a>)pwp;
04980     <a class="code" href="../../d2/d3/structtagDESKTOPVIEW.html">PDESKTOPVIEW</a> pdv, pdvNext;
04981     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  fHadThreads;
04982     <a class="code" href="../../d6/d4/structtagPUBOBJ.html">PPUBOBJ</a> ppo;
04983 
04984     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
04985 
04986     <span class="comment">/*</span>
04987 <span class="comment">     * Free up input idle event if it exists - wake everyone waiting on it</span>
04988 <span class="comment">     * first.  This object will get created sometimes even for non-windows</span>
04989 <span class="comment">     * processes (usually for WinExec(), which calls WaitForInputIdle()).</span>
04990 <span class="comment">     */</span>
04991     <a class="code" href="../../d4/d1/userk_8h.html#a367">CLOSE_PSEUDO_EVENT</a>(&amp;pwp-&gt;InputIdleEvent);
04992 
04993     <span class="comment">/*</span>
04994 <span class="comment">     * Check to see if the startglass is on, and if so turn it off and update.</span>
04995 <span class="comment">     * DeferWinEventNotify to because we cannot process notifications for this</span>
04996 <span class="comment">     * thread now (we may have no PtiCurrent, see comment above)</span>
04997 <span class="comment">     */</span>
04998     <a class="code" href="../../d4/d1/userk_8h.html#a159">BEGINATOMICCHECK</a>();
04999     <a class="code" href="../../d4/d1/userk_8h.html#a614">DeferWinEventNotify</a>();
05000     <span class="keywordflow">if</span> (pwp-&gt;W32PF_Flags &amp; W32PF_STARTGLASS) {
05001         pwp-&gt;W32PF_Flags &amp;= ~W32PF_STARTGLASS;
05002         <a class="code" href="../../d4/d1/userk_8h.html#a1490">zzzCalcStartCursorHide</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0);
05003     }
05004     <span class="comment">/*</span>
05005 <span class="comment">     * This is bookkeeping - restore original notification deferral but without</span>
05006 <span class="comment">     * attempting to process any deferred notifications because we have no pti.</span>
05007 <span class="comment">     */</span>
05008     <a class="code" href="../../d4/d1/userk_8h.html#a618">EndDeferWinEventNotifyWithoutProcessing</a>();
05009     <a class="code" href="../../d4/d1/userk_8h.html#a163">ENDATOMICCHECK</a>();
05010 
05011     <span class="comment">/*</span>
05012 <span class="comment">     * If the process never called Win32k, we're done.</span>
05013 <span class="comment">     */</span>
05014     <span class="keywordflow">if</span> (!(pwp-&gt;W32PF_Flags &amp; W32PF_PROCESSCONNECTED)) {
05015         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05016     }
05017 
05018     <span class="comment">/*</span>
05019 <span class="comment">     * Play the Process Close sound for non-console processes</span>
05020 <span class="comment">     * running on the I/O windowstation.</span>
05021 <span class="comment">     */</span>
05022 
05023     <span class="keywordflow">if</span> ((ppi-&gt;W32PF_Flags &amp; W32PF_IOWINSTA) &amp;&amp;
05024         !(ppi-&gt;W32PF_Flags &amp; W32PF_CONSOLEAPPLICATION) &amp;&amp;
05025         (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a17">gspwndLogonNotify</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
05026         !(ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o14">rpwinsta</a>-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a315">WSF_OPENLOCK</a>)) {
05027 
05028         <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a17">gspwndLogonNotify</a>);
05029         <a class="code" href="../../d8/d4/structtagQMSG.html">PQMSG</a> pqmsg;
05030 
05031         <span class="keywordflow">if</span> ((pqmsg = <a class="code" href="../../d4/d1/userk_8h.html#a1210">AllocQEntry</a>(&amp;pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o43">mlPost</a>)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05032             <a class="code" href="../../d4/d1/userk_8h.html#a1503">StoreQMessage</a>(pqmsg, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a17">gspwndLogonNotify</a>, WM_LOGONNOTIFY,
05033                     LOGON_PLAYEVENTSOUND, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a927">USER_SOUND_CLOSE</a>, 0, 0, 0);
05034 
05035             <a class="code" href="../../d4/d1/userk_8h.html#a1197">SetWakeBit</a>(pti, QS_POSTMESSAGE | QS_ALLPOSTMESSAGE);
05036         }
05037 
05038     }
05039 
05040     <span class="comment">/*</span>
05041 <span class="comment">     * Be like WIN95.</span>
05042 <span class="comment">     * If this is the shell process, then send a LOGON_RESTARTSHELL</span>
05043 <span class="comment">     *  notification to the winlogon process (only if not logging off)</span>
05044 <span class="comment">     */</span>
05045     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1822">IsShellProcess</a>(ppi)) {
05046 
05047         <span class="comment">/*</span>
05048 <span class="comment">         * The shell process will get killed and it's better to set this</span>
05049 <span class="comment">         * in the desktop info.</span>
05050 <span class="comment">         */</span>
05051         ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o3">rpdeskStartup</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o6">ppiShellProcess</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05052 
05053         <span class="comment">/*</span>
05054 <span class="comment">         * If we're not logging off, notify winlogon</span>
05055 <span class="comment">         */</span>
05056         <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a17">gspwndLogonNotify</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
05057              !(ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o14">rpwinsta</a>-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a315">WSF_OPENLOCK</a>)) {
05058 
05059             <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a17">gspwndLogonNotify</a>);
05060             <a class="code" href="../../d8/d4/structtagQMSG.html">PQMSG</a> pqmsg;
05061 
05062             <span class="keywordflow">if</span> ((pqmsg = <a class="code" href="../../d4/d1/userk_8h.html#a1210">AllocQEntry</a>(&amp;pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o43">mlPost</a>)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05063                 <a class="code" href="../../d4/d1/userk_8h.html#a1503">StoreQMessage</a>(pqmsg, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a17">gspwndLogonNotify</a>, WM_LOGONNOTIFY,
05064                         LOGON_RESTARTSHELL, ppi-&gt;Process-&gt;ExitStatus, 0, 0, 0);
05065                 <a class="code" href="../../d4/d1/userk_8h.html#a1197">SetWakeBit</a>(pti, QS_POSTMESSAGE | QS_ALLPOSTMESSAGE);
05066             }
05067         }
05068     }
05069 
05070     <span class="keywordflow">if</span> (ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o9">cThreads</a>)
05071         RIPMSG1(RIP_ERROR, <span class="stringliteral">"Disconnect with %d threads remaining\n"</span>, ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o9">cThreads</a>);
05072 
05073     <span class="comment">/*</span>
05074 <span class="comment">     * If the app is still starting, remove it from the startup list</span>
05075 <span class="comment">     */</span>
05076     <span class="keywordflow">if</span> (ppi-&gt;W32PF_Flags &amp; W32PF_APPSTARTING) {
05077         <span class="comment">/*</span>
05078 <span class="comment">         * Bug 294193 - joejo</span>
05079 <span class="comment">         *</span>
05080 <span class="comment">         * Handle case when creator process exits before the child</span>
05081 <span class="comment">         * process makes it to CheckAllowForeground code. This is typical with</span>
05082 <span class="comment">         * stub EXEs that do nothing but create other processes.</span>
05083 <span class="comment">         */</span>
05084         <a class="code" href="../../d4/d1/userk_8h.html#a1937">GiveForegroundActivateRight</a>(ppi-&gt;Process-&gt;UniqueProcessId);
05085         <a class="code" href="../../d4/d1/userk_8h.html#a1832">ClearAppStarting</a>(ppi);
05086     }
05087 
05088     <span class="comment">/*</span>
05089 <span class="comment">     * remove it from the global list</span>
05090 <span class="comment">     */</span>
05091     <a class="code" href="../../d4/d1/userk_8h.html#a752">REMOVE_FROM_LIST</a>(<a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PROCESSINFO</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a110">gppiList</a>, ppi, ppiNextRunning);
05092 
05093     <span class="comment">/*</span>
05094 <span class="comment">     * If any threads ever connected, there may be DCs, classes,</span>
05095 <span class="comment">     * cursors, etc. still lying around.  If no threads connected</span>
05096 <span class="comment">     * (which is the case for console apps), skip all of this cleanup.</span>
05097 <span class="comment">     */</span>
05098     fHadThreads = ppi-&gt;W32PF_Flags &amp; W32PF_THREADCONNECTED;
05099     <span class="keywordflow">if</span> (fHadThreads) {
05100 
05101         <span class="comment">/*</span>
05102 <span class="comment">         * When a process dies we need to make sure any DCE's it owns</span>
05103 <span class="comment">         * and have not been deleted are cleanup up.  The clean up</span>
05104 <span class="comment">         * earlier may have failed if the DC was busy in GDI.</span>
05105 <span class="comment">         */</span>
05106         <span class="keywordflow">if</span> (ppi-&gt;W32PF_Flags &amp; W32PF_OWNDCCLEANUP) {
05107             <a class="code" href="../../d4/d1/userk_8h.html#a1705">DelayedDestroyCacheDC</a>();
05108         }
05109 
05110 <span class="preprocessor">#if DBG</span>
05111 <span class="preprocessor"></span>        {
05112             <a class="code" href="../../d2/d4/struct__HANDLEENTRY.html">PHE</a> pheT, pheMax;
05113 
05114             <span class="comment">/*</span>
05115 <span class="comment">             * Loop through the table destroying all objects created by the current</span>
05116 <span class="comment">             * process. All objects will get destroyed in their proper order simply</span>
05117 <span class="comment">             * because of the object locking.</span>
05118 <span class="comment">             */</span>
05119             pheMax = &amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o1">aheList</a>[<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a308">giheLast</a>];
05120             <span class="keywordflow">for</span> (pheT = <a class="code" href="../../d1/d8/clglobal_8c.html#a5">gSharedInfo</a>.<a class="code" href="../../d4/d6/structtagSHAREDINFO.html#o1">aheList</a>; pheT &lt;= pheMax; pheT++) {
05121 
05122                 <span class="comment">/*</span>
05123 <span class="comment">                 * We should have no process objects left for this process.</span>
05124 <span class="comment">                 */</span>
05125                 UserAssertMsg0(
05126                         pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o3">bFlags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a421">HANDLEF_DESTROY</a> ||
05127                         !(<a class="code" href="../../d9/d6/ntuser_2kernel_2globals_8h.html#a241">gahti</a>[pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o2">bType</a>].bObjectCreateFlags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a414">OCF_PROCESSOWNED</a>) ||
05128                         (<a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a>)pheT-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o1">pOwner</a> != ppi,
05129                         <span class="stringliteral">"We should have no process objects left for this process!"</span>);
05130             }
05131         }
05132 <span class="preprocessor">#endif</span>
05133 <span class="preprocessor"></span>    }
05134 
05135     <span class="keywordflow">if</span> (pwp-&gt;UserHandleCount)
05136         RIPMSG1(RIP_ERROR, <span class="stringliteral">"Disconnect with %d User handle objects remaining\n"</span>, pwp-&gt;UserHandleCount);
05137 
05138     <span class="comment">/*</span>
05139 <span class="comment">     * check if we need to zap PID's for DDE objects</span>
05140 <span class="comment">     */</span>
05141     <span class="keywordflow">for</span> (ppo = <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a6">gpPublicObjectList</a>;
05142             ppo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05143                 ppo = ppo-&gt;<a class="code" href="../../d6/d4/structtagPUBOBJ.html#o0">next</a>) {
05144         <span class="keywordflow">if</span> (ppo-&gt;<a class="code" href="../../d6/d4/structtagPUBOBJ.html#o3">pid</a> == pwp-&gt;W32Pid) {
05145             ppo-&gt;<a class="code" href="../../d6/d4/structtagPUBOBJ.html#o3">pid</a> = OBJECT_OWNER_PUBLIC;
05146         }
05147     }
05148 
05149 
05150     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a158">gppiScreenSaver</a> == ppi) {
05151         UserAssert(ppi-&gt;W32PF_Flags &amp; W32PF_SCREENSAVER);
05152 
05153         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a158">gppiScreenSaver</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05154     }
05155 
05156     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a112">gppiForegroundOld</a> == ppi) {
05157         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a112">gppiForegroundOld</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05158     }
05159 
05160     <a class="code" href="../../d4/d1/userk_8h.html#a124">UnlockWinSta</a>(&amp;ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o14">rpwinsta</a>);
05161     <a class="code" href="../../d4/d1/userk_8h.html#a127">UnlockDesktop</a>(&amp;ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o3">rpdeskStartup</a>, LDU_PPI_DESKSTARTUP3, (ULONG_PTR)ppi);
05162 
05163     <span class="comment">/*</span>
05164 <span class="comment">     * Close the startup desktop handle now if it's still around. If we wait</span>
05165 <span class="comment">     * until handle table cleanup time we could potentially deadlock.</span>
05166 <span class="comment">     */</span>
05167     <span class="keywordflow">if</span> (ppi-&gt;hdeskStartup) {
05168         UserVerify(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d4/d1/userk_8h.html#a2073">CloseProtectedHandle</a>(ppi-&gt;hdeskStartup)));
05169         ppi-&gt;hdeskStartup = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05170     }
05171 
05172     <span class="comment">/*</span>
05173 <span class="comment">     * Mark the process as terminated so access checks will work.</span>
05174 <span class="comment">     */</span>
05175     ppi-&gt;W32PF_Flags |= W32PF_TERMINATED;
05176 
05177     <span class="comment">/*</span>
05178 <span class="comment">     * Cleanup wow process info struct, if any</span>
05179 <span class="comment">     */</span>
05180     <span class="keywordflow">if</span> (ppi-&gt;pwpi) {
05181         <a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html">PWOWPROCESSINFO</a> pwpi = ppi-&gt;pwpi;
05182 
05183         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pwpi-&gt;<a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html#o5">pEventWowExec</a>);
05184 
05185         <a class="code" href="../../d4/d1/userk_8h.html#a752">REMOVE_FROM_LIST</a>(<a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html">WOWPROCESSINFO</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a28">gpwpiFirstWow</a>, pwpi, pwpiNext);
05186 
05187         UserFreePool(pwpi);
05188         ppi-&gt;pwpi = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05189     }
05190 
05191     <span class="comment">/*</span>
05192 <span class="comment">     * Delete desktop views.  System will do unmapping.</span>
05193 <span class="comment">     */</span>
05194     pdv = ppi-&gt;pdvList;
05195     <span class="keywordflow">while</span> (pdv) {
05196         pdvNext = pdv-&gt;<a class="code" href="../../d2/d3/structtagDESKTOPVIEW.html#o0">pdvNext</a>;
05197         UserFreePool(pdv);
05198         pdv = pdvNext;
05199     }
05200     ppi-&gt;pdvList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05201 
05202     <span class="comment">/*</span>
05203 <span class="comment">     * Clear the SendInput/Journalling hook caller ppi</span>
05204 <span class="comment">     */</span>
05205     <span class="keywordflow">if</span> (ppi == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a80">gppiInputProvider</a>) {
05206         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a80">gppiInputProvider</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05207     }
05208     <span class="comment">/*</span>
05209 <span class="comment">     * If this ppi locked SetForegroundWindow, clean up</span>
05210 <span class="comment">     */</span>
05211     <span class="keywordflow">if</span> (ppi == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a81">gppiLockSFW</a>) {
05212         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a81">gppiLockSFW</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05213     }
05214 
05215     <span class="keywordflow">return</span> fHadThreads;
05216 }
05217 
05218 <span class="comment">/***************************************************************************\</span>
05219 <span class="comment">* ClearWakeMask</span>
05220 <span class="comment">*</span>
05221 <span class="comment">\***************************************************************************/</span>
05222 
<a name="l05223"></a><a class="code" href="../../d4/d1/userk_8h.html#a1824">05223</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1824">ClearWakeMask</a>(VOID)
05224 {
05225     <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;pcti-&gt;fsWakeMask = 0;
05226 }
05227 
05228 <span class="comment">/***************************************************************************\</span>
05229 <span class="comment">* xxxGetInputEvent</span>
05230 <span class="comment">*</span>
05231 <span class="comment">* Returns a duplicated event-handle that the client process can use to</span>
05232 <span class="comment">* wait on input events.</span>
05233 <span class="comment">*</span>
05234 <span class="comment">* History:</span>
05235 <span class="comment">* 05-02-91  DavidPe     Created.</span>
05236 <span class="comment">\***************************************************************************/</span>
05237 
<a name="l05238"></a><a class="code" href="../../d4/d1/userk_8h.html#a1900">05238</a> HANDLE <a class="code" href="../../d4/d1/userk_8h.html#a1900">xxxGetInputEvent</a>(
05239     DWORD dwWakeMask)
05240 {
05241     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent;
05242     WORD wFlags = HIWORD(dwWakeMask);
05243     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a616">IsWinEventNotifyDeferredOK</a>());
05244 
05245     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
05246 
05247     <span class="comment">/*</span>
05248 <span class="comment">     * If our wait condition is satisfied, signal the event and return.</span>
05249 <span class="comment">     * (Since the wake mask could have been anything at the time the input</span>
05250 <span class="comment">     *  arrived, the event might not be signaled)</span>
05251 <span class="comment">     */</span>
05252     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/inc_2user_8h.html#a1143">GetInputBits</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>, LOWORD(dwWakeMask), (wFlags &amp; MWMO_INPUTAVAILABLE))) {
05253         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o35">pEventQueueServer</a>, 2, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
05254         <span class="keywordflow">return</span> ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o34">hEventQueueClient</a>;
05255     }
05256 
05257     <span class="comment">/*</span>
05258 <span class="comment">     * If an idle hook is set, call it.</span>
05259 <span class="comment">     */</span>
05260     <span class="keywordflow">if</span> (ptiCurrent == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a25">gptiForeground</a> &amp;&amp;
05261             <a class="code" href="../../d6/d0/usercli_8h.html#a208">IsHooked</a>(ptiCurrent, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a524">WHF_FOREGROUNDIDLE</a>)) {
05262         <a class="code" href="../../d4/d1/userk_8h.html#a1521">xxxCallHook</a>(HC_ACTION, 0, 0, WH_FOREGROUNDIDLE);
05263     }
05264 
05265     <a class="code" href="../../d4/d1/userk_8h.html#a21">CheckForClientDeath</a>();
05266 
05267     <span class="comment">/*</span>
05268 <span class="comment">     * What is the criteria for an "idle process"?</span>
05269 <span class="comment">     * Answer: The first thread that calls zzzWakeInputIdle, or SleepInputIdle or...</span>
05270 <span class="comment">     * Any thread that calls xxxGetInputEvent with any of the following</span>
05271 <span class="comment">     * bits set in its wakemask: (sanfords)</span>
05272 <span class="comment">     */</span>
05273     <span class="keywordflow">if</span> (dwWakeMask &amp; (QS_POSTMESSAGE | QS_INPUT)) {
05274         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o2">ptiMainThread</a> = ptiCurrent;
05275     }
05276 
05277     <span class="comment">/*</span>
05278 <span class="comment">     * When we return, this app is going to sleep. Since it is in its</span>
05279 <span class="comment">     * idle mode when it goes to sleep, wake any apps waiting for this</span>
05280 <span class="comment">     * app to go idle.</span>
05281 <span class="comment">     */</span>
05282     <a class="code" href="../../d4/d1/userk_8h.html#a1636">zzzWakeInputIdle</a>(ptiCurrent);
05283     <span class="comment">/*</span>
05284 <span class="comment">     * Setup the wake mask for this thread. Wait for QS_EVENT or the app won't</span>
05285 <span class="comment">     * get event messages like deactivate.</span>
05286 <span class="comment">     */</span>
05287     <a class="code" href="../../d6/d3/queue_8c.html#a42">ClearQueueServerEvent</a>((WORD)(dwWakeMask | QS_EVENT));
05288     <span class="comment">/*</span>
05289 <span class="comment">     * This app is going idle. Clear the spin count check to see</span>
05290 <span class="comment">     * if we need to make this process foreground again.</span>
05291 <span class="comment">     */</span>
05292     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o1">cSpins</a> = 0;
05293     <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a804">TIF_SPINNING</a>) {
05294         <a class="code" href="../../d6/d3/queue_8c.html#a18">CheckProcessForeground</a>(ptiCurrent);
05295     }
05296 
05297     UserAssert(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o4">fsWakeMask</a> != 0);
05298     <span class="keywordflow">return</span> ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o34">hEventQueueClient</a>;
05299 }
05300 
05301 <span class="comment">/***************************************************************************\</span>
05302 <span class="comment">* xxxWaitForInputIdle</span>
05303 <span class="comment">*</span>
05304 <span class="comment">* This routine waits on a particular input queue for "input idle", meaning</span>
05305 <span class="comment">* it waits till that queue has no input to process.</span>
05306 <span class="comment">*</span>
05307 <span class="comment">* 09-13-91 ScottLu      Created.</span>
05308 <span class="comment">\***************************************************************************/</span>
05309 
<a name="l05310"></a><a class="code" href="../../d4/d1/userk_8h.html#a1120">05310</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d4/d1/userk_8h.html#a1120">xxxWaitForInputIdle</a>(
05311     ULONG_PTR idProcess,
05312     DWORD dwMilliseconds,
05313     BOOL fSharedWow)
05314 {
05315     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent;
05316     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti;
05317     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
05318     PW32PROCESS W32Process;
05319     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppi;
05320     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwResult;
05321     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
05322     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlProcess;
05323 
05324     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
05325 
05326     <span class="comment">/*</span>
05327 <span class="comment">     * If fSharedWow is set, the client passed in a fake process</span>
05328 <span class="comment">     * handle which CreateProcess returns for Win16 apps started</span>
05329 <span class="comment">     * in the shared WOW VDM.</span>
05330 <span class="comment">     *</span>
05331 <span class="comment">     * CreateProcess returns a real process handle when you start</span>
05332 <span class="comment">     * a Win16 app in a separate WOW VDM.</span>
05333 <span class="comment">     */</span>
05334 
05335     <span class="keywordflow">if</span> (fSharedWow) {  <span class="comment">// Waiting for a WOW task to go idle.</span>
05336         <a class="code" href="../../d8/d9/structtagWOWTHREADINFO.html">PWOWTHREADINFO</a> pwti;
05337 
05338 
05339         <span class="comment">/*</span>
05340 <span class="comment">         * Look for a matching thread in the WOW thread info list.</span>
05341 <span class="comment">         */</span>
05342         <span class="keywordflow">for</span> (pwti = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a27">gpwtiFirst</a>; pwti != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; pwti = pwti-&gt;<a class="code" href="../../d8/d9/structtagWOWTHREADINFO.html#o0">pwtiNext</a>) {
05343             <span class="keywordflow">if</span> (pwti-&gt;<a class="code" href="../../d8/d9/structtagWOWTHREADINFO.html#o3">idParentProcess</a> == HandleToUlong(ptiCurrent-&gt;pEThread-&gt;Cid.UniqueProcess) &amp;&amp;
05344                 pwti-&gt;<a class="code" href="../../d8/d9/structtagWOWTHREADINFO.html#o2">idWaitObject</a> == idProcess) {
05345                 <span class="keywordflow">break</span>;
05346             }
05347         }
05348 
05349         <span class="comment">/*</span>
05350 <span class="comment">         * If we couldn't find the right thread, bail out.</span>
05351 <span class="comment">         */</span>
05352         <span class="keywordflow">if</span> (pwti == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05353             RIPMSG0(RIP_WARNING, <span class="stringliteral">"WaitForInputIdle couldn't find 16-bit task\n"</span>);
05354             <span class="keywordflow">return</span> (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)-1;
05355         }
05356 
05357         <span class="comment">/*</span>
05358 <span class="comment">         * Now wait for it to go idle and return.</span>
05359 <span class="comment">         */</span>
05360         dwResult = <a class="code" href="../../d4/d1/userk_8h.html#a1021">WaitOnPseudoEvent</a>(&amp;pwti-&gt;<a class="code" href="../../d8/d9/structtagWOWTHREADINFO.html#o4">pIdleEvent</a>, dwMilliseconds);
05361         <span class="keywordflow">if</span> (dwResult == STATUS_ABANDONED) {
05362             dwResult = <a class="code" href="../../d6/d3/queue_8c.html#a20">xxxPollAndWaitForSingleObject</a>(pwti-&gt;<a class="code" href="../../d8/d9/structtagWOWTHREADINFO.html#o4">pIdleEvent</a>,
05363                                                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
05364                                                      dwMilliseconds);
05365         }
05366         <span class="keywordflow">return</span> dwResult;
05367 
05368     }
05369 
05370     <span class="comment">/*</span>
05371 <span class="comment">     * We shouldn't get here for system threads.</span>
05372 <span class="comment">     */</span>
05373     UserAssert(!(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a797">TIF_SYSTEMTHREAD</a>));
05374 
05375     <span class="comment">/*</span>
05376 <span class="comment">     * If the app is waiting for itself to go idle, error.</span>
05377 <span class="comment">     */</span>
05378     <span class="keywordflow">if</span> (ptiCurrent-&gt;pEThread-&gt;Cid.UniqueProcess == (HANDLE)idProcess &amp;&amp;
05379             ptiCurrent == ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o2">ptiMainThread</a>) {
05380         RIPMSG0(RIP_WARNING, <span class="stringliteral">"WaitForInputIdle waiting on self\n"</span>);
05381         <span class="keywordflow">return</span> (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)-1;
05382     }
05383 
05384     <span class="comment">/*</span>
05385 <span class="comment">     * Now find the ppi structure for this process.</span>
05386 <span class="comment">     */</span>
05387     <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
05388     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1258">LockProcessByClientId</a>((HANDLE)idProcess, &amp;Process);
05389     <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
05390 
05391     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
05392         <span class="keywordflow">return</span> (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)-1;
05393 
05394     <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o44">ExitProcessCalled</a>) {
05395         <a class="code" href="../../d4/d1/userk_8h.html#a517">UnlockProcess</a>(Process);
05396         <span class="keywordflow">return</span> (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)-1;
05397     }
05398 
05399     W32Process = (PW32PROCESS)Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o72">Win32Process</a>;
05400 
05401     <span class="comment">/*</span>
05402 <span class="comment">     * Couldn't find that process info structure....  return error.</span>
05403 <span class="comment">     */</span>
05404     <span class="keywordflow">if</span> (W32Process == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05405         RIPMSG0(RIP_WARNING, <span class="stringliteral">"WaitForInputIdle process not GUI process\n"</span>);
05406         <a class="code" href="../../d4/d1/userk_8h.html#a517">UnlockProcess</a>(Process);
05407         <span class="keywordflow">return</span> (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)-1;
05408     }
05409 
05410 
05411     ppi = (<a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a>)W32Process;
05412 
05413     <span class="comment">/*</span>
05414 <span class="comment">     * If this is a console application, don't wait on it.</span>
05415 <span class="comment">     */</span>
05416     <span class="keywordflow">if</span> (W32Process-&gt;W32PF_Flags &amp; W32PF_CONSOLEAPPLICATION) {
05417         RIPMSG0(RIP_WARNING, <span class="stringliteral">"WaitForInputIdle process is console process\n"</span>);
05418         <a class="code" href="../../d4/d1/userk_8h.html#a517">UnlockProcess</a>(Process);
05419         <span class="keywordflow">return</span> (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)-1;
05420     }
05421 
05422     <span class="comment">/*</span>
05423 <span class="comment">     * Wait on this event for the passed in time limit.</span>
05424 <span class="comment">     */</span>
05425     <a class="code" href="../../d4/d1/userk_8h.html#a21">CheckForClientDeath</a>();
05426 
05427     <span class="comment">/*</span>
05428 <span class="comment">     * We have to wait mark the Process as one which others are waiting on</span>
05429 <span class="comment">     */</span>
05430     ppi-&gt;W32PF_Flags |= W32PF_WAITFORINPUTIDLE;
05431     <span class="keywordflow">for</span> (pti = ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o1">ptiList</a>; pti != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; pti = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o29">ptiSibling</a>) {
05432         pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a808">TIF_WAITFORINPUTIDLE</a>;
05433     }
05434 
05435     <span class="comment">/*</span>
05436 <span class="comment">     * Thread lock the process to ensure that it will be dereferenced</span>
05437 <span class="comment">     * if the thread exits.</span>
05438 <span class="comment">     */</span>
05439     LockW32Process(W32Process, &amp;tlProcess);
05440     <a class="code" href="../../d4/d1/userk_8h.html#a517">UnlockProcess</a>(Process);
05441 
05442     dwResult = <a class="code" href="../../d4/d1/userk_8h.html#a1021">WaitOnPseudoEvent</a>(&amp;W32Process-&gt;InputIdleEvent, dwMilliseconds);
05443     <span class="keywordflow">if</span> (dwResult == STATUS_ABANDONED) {
05444         dwResult = <a class="code" href="../../d6/d3/queue_8c.html#a20">xxxPollAndWaitForSingleObject</a>(W32Process-&gt;InputIdleEvent,
05445                                                  Process,
05446                                                  dwMilliseconds);
05447     }
05448 
05449     <span class="comment">/*</span>
05450 <span class="comment">     * Clear all thread TIF_WAIT bits from the process.</span>
05451 <span class="comment">     */</span>
05452     ppi-&gt;W32PF_Flags &amp;= ~W32PF_WAITFORINPUTIDLE;
05453     <span class="keywordflow">for</span> (pti = ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o1">ptiList</a>; pti != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; pti = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o29">ptiSibling</a>) {
05454         pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a808">TIF_WAITFORINPUTIDLE</a>;
05455     }
05456 
05457     UnlockW32Process(&amp;tlProcess);
05458 
05459     <span class="keywordflow">return</span> dwResult;
05460 }
05461 
05462 
<a name="l05463"></a><a class="code" href="../../d6/d3/queue_8c.html#a9">05463</a> <span class="preprocessor">#define INTERMEDIATE_TIMEOUT    (500)       // 1/2 second</span>
05464 <span class="preprocessor"></span>
05465 <span class="comment">/***************************************************************************\</span>
05466 <span class="comment">* xxxPollAndWaitForSingleObject</span>
05467 <span class="comment">*</span>
05468 <span class="comment">* Sometimes we have to wait on an event but still want to periodically</span>
05469 <span class="comment">* wake up and see if the client process has been terminated.</span>
05470 <span class="comment">*</span>
05471 <span class="comment">* dwMilliseconds is initially the total amount of time to wait and after</span>
05472 <span class="comment">* each intermediate wait reflects the amount of time left to wait.</span>
05473 <span class="comment">* -1 means wait indefinitely.</span>
05474 <span class="comment">*</span>
05475 <span class="comment">* 02-Jul-1993 johnc      Created.</span>
05476 <span class="comment">\***************************************************************************/</span>
05477 
05478 <span class="comment">// LATER!!! can we get rid of the Polling idea and wait additionally on</span>
05479 <span class="comment">// LATER!!! the hEventServer and set that when a thread dies</span>
05480 
<a name="l05481"></a><a class="code" href="../../d6/d3/queue_8c.html#a20">05481</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d6/d3/queue_8c.html#a20">xxxPollAndWaitForSingleObject</a>(
05482     <a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> pEvent,
05483     PVOID pExecObject,
05484     DWORD dwMilliseconds)
05485 {
05486     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwIntermediateMilliseconds, dwStartTickCount;
05487     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent;
05488     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> cEvent = 2;
05489     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = -1;
05490     LARGE_INTEGER li;
05491     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlEvent;
05492 
05493     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
05494 
05495     <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o47">apEvent</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05496         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o47">apEvent</a> = UserAllocPoolNonPaged(<a class="code" href="../../d4/d1/userk_8h.html#a368">POLL_EVENT_CNT</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>), TAG_EVENT);
05497         <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o47">apEvent</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
05498             <span class="keywordflow">return</span> (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)-1;
05499     }
05500 
05501     <span class="comment">/*</span>
05502 <span class="comment">     * Refcount the event to ensure that it won't go</span>
05503 <span class="comment">     * away during the wait.  By using a thread lock, the</span>
05504 <span class="comment">     * event will be dereferenced if the thread exits</span>
05505 <span class="comment">     * during a callback.  The process pointer has already been</span>
05506 <span class="comment">     * locked.</span>
05507 <span class="comment">     */</span>
05508     <a class="code" href="../../d4/d1/userk_8h.html#a121">ThreadLockObject</a>(pEvent, &amp;tlEvent);
05509 
05510     <span class="comment">/*</span>
05511 <span class="comment">     * If a process was passed in, wait on it too.  No need</span>
05512 <span class="comment">     * to reference this because the caller has it referenced.</span>
05513 <span class="comment">     */</span>
05514     <span class="keywordflow">if</span> (pExecObject) {
05515         cEvent++;
05516     }
05517 
05518     <span class="comment">/*</span>
05519 <span class="comment">     * We want to wake if there're sent messages pending</span>
05520 <span class="comment">     */</span>
05521     <a class="code" href="../../d6/d3/queue_8c.html#a42">ClearQueueServerEvent</a>(QS_SENDMESSAGE);
05522 
05523     <span class="comment">/*</span>
05524 <span class="comment">     * Wow Tasks MUST be descheduled while in the wait to allow</span>
05525 <span class="comment">     * other tasks in the same wow scheduler to run.</span>
05526 <span class="comment">     *</span>
05527 <span class="comment">     * For example, 16 bit app A calls WaitForInputIdle on 32 bit app B.</span>
05528 <span class="comment">     * App B starts up and tries to send a message to 16 bit app C. App C</span>
05529 <span class="comment">     * will never be able to process the message unless app A yields</span>
05530 <span class="comment">     * control to it, so app B will never go idle.</span>
05531 <span class="comment">     */</span>
05532 
05533     <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>) {
05534         <a class="code" href="../../d4/d1/userk_8h.html#a1556">xxxSleepTask</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a17">HEVENT_REMOVEME</a>);
05535         <span class="comment">// caution: the wow task is no longer scheduled.</span>
05536     }
05537 
05538     dwStartTickCount = <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>();
05539     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
05540         <span class="keywordflow">if</span> (dwMilliseconds &gt; <a class="code" href="../../d6/d3/queue_8c.html#a9">INTERMEDIATE_TIMEOUT</a>) {
05541             dwIntermediateMilliseconds = <a class="code" href="../../d6/d3/queue_8c.html#a9">INTERMEDIATE_TIMEOUT</a>;
05542 
05543             <span class="comment">/*</span>
05544 <span class="comment">             * If we are not waiting an infinite amount of time then subtract</span>
05545 <span class="comment">             * the last loop duration from time left to wait.</span>
05546 <span class="comment">             */</span>
05547             <span class="keywordflow">if</span> (dwMilliseconds != INFINITE) {
05548                 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwNewTickCount = <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>();
05549                 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwDelta = <a class="code" href="../../d4/d1/userk_8h.html#a2021">ComputePastTickDelta</a>(dwNewTickCount, dwStartTickCount);
05550                 dwStartTickCount = dwNewTickCount;
05551                 <span class="keywordflow">if</span> (dwDelta &lt; dwMilliseconds) {
05552                     dwMilliseconds -= dwDelta;
05553                 } <span class="keywordflow">else</span> {
05554                     dwMilliseconds = 0;
05555                 }
05556             }
05557         } <span class="keywordflow">else</span> {
05558             dwIntermediateMilliseconds = dwMilliseconds;
05559             dwMilliseconds = 0;
05560         }
05561 
05562         <span class="comment">/*</span>
05563 <span class="comment">         * Convert dwMilliseconds to a relative-time(i.e.  negative) LARGE_INTEGER.</span>
05564 <span class="comment">         * NT Base calls take time values in 100 nanosecond units.</span>
05565 <span class="comment">         */</span>
05566         <span class="keywordflow">if</span> (dwIntermediateMilliseconds != INFINITE)
05567             li.QuadPart = Int32x32To64(-10000, dwIntermediateMilliseconds);
05568 
05569         <span class="comment">/*</span>
05570 <span class="comment">         * Load events into the wait array.  Do this every time</span>
05571 <span class="comment">         * through the loop in case of recursion.</span>
05572 <span class="comment">         */</span>
05573         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o47">apEvent</a>[<a class="code" href="../../d4/d1/userk_8h.html#a369">IEV_IDLE</a>] = pEvent;
05574         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o47">apEvent</a>[<a class="code" href="../../d4/d1/userk_8h.html#a370">IEV_INPUT</a>] = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o35">pEventQueueServer</a>;
05575         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o47">apEvent</a>[<a class="code" href="../../d4/d1/userk_8h.html#a371">IEV_EXEC</a>] = pExecObject;
05576 
05577         <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
05578 
05579         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d7/wait_8c.html#a3">KeWaitForMultipleObjects</a>(cEvent,
05580                                           &amp;ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o47">apEvent</a>[<a class="code" href="../../d4/d1/userk_8h.html#a369">IEV_IDLE</a>],
05581                                           WaitAny,
05582                                           <a class="code" href="../../d4/d9/ke_8h.html#a407a211">WrUserRequest</a>,
05583                                           <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>,
05584                                           <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
05585                                           (dwIntermediateMilliseconds == INFINITE ?
05586                                                   <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> : &amp;li),
05587                                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
05588 
05589         <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
05590 
05591         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
05592             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = -1;
05593         } <span class="keywordflow">else</span> {
05594 
05595             <span class="comment">/*</span>
05596 <span class="comment">             * Because we do a non-alertable wait, we know that a status</span>
05597 <span class="comment">             * of STATUS_USER_APC means that the thread was terminated.</span>
05598 <span class="comment">             * If we have terminated, get back to user mode</span>
05599 <span class="comment">             */</span>
05600             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_USER_APC) {
05601                 <a class="code" href="../../d4/d1/userk_8h.html#a1928">ClientDeliverUserApc</a>();
05602                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = -1;
05603             }
05604         }
05605 
05606         <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o1">fsChangeBits</a> &amp; QS_SENDMESSAGE) {
05607             <span class="comment">/*</span>
05608 <span class="comment">             *  Wow Tasks MUST wait to be rescheduled in the wow non-premptive</span>
05609 <span class="comment">             *  scheduler before doing anything which might invoke client code.</span>
05610 <span class="comment">             */</span>
05611             <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>) {
05612                 <a class="code" href="../../d4/d1/userk_8h.html#a1558">xxxDirectedYield</a>(DY_OLDYIELD);
05613             }
05614 
05615             <a class="code" href="../../d4/d1/userk_8h.html#a502">xxxReceiveMessages</a>(ptiCurrent);
05616 
05617             <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>) {
05618                 <a class="code" href="../../d4/d1/userk_8h.html#a1556">xxxSleepTask</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a17">HEVENT_REMOVEME</a>);
05619                 <span class="comment">// caution: the wow task is no longer scheduled.</span>
05620             }
05621         }
05622 
05623         <span class="comment">/*</span>
05624 <span class="comment">         * If we returned from the wait for some other reason than a timeout</span>
05625 <span class="comment">         * or to receive messages we are done.  If it is a timeout we are</span>
05626 <span class="comment">         * only done waiting if the overall time is zero.</span>
05627 <span class="comment">         */</span>
05628         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_TIMEOUT &amp;&amp; <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != 1)
05629             <span class="keywordflow">break</span>;
05630 
05631         <span class="keywordflow">if</span> (dwMilliseconds == 0) {
05632             <span class="comment">/*</span>
05633 <span class="comment">             * Fix up the return if the last poll was interupted by a message</span>
05634 <span class="comment">             */</span>
05635             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == 1)
05636                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = WAIT_TIMEOUT;
05637             <span class="keywordflow">break</span>;
05638         }
05639 
05640     }
05641 
05642     <span class="comment">/*</span>
05643 <span class="comment">     * reschedule the 16 bit app</span>
05644 <span class="comment">     */</span>
05645     <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>) {
05646         <a class="code" href="../../d4/d1/userk_8h.html#a1558">xxxDirectedYield</a>(DY_OLDYIELD);
05647     }
05648 
05649     <span class="comment">/*</span>
05650 <span class="comment">     * Unlock the events.</span>
05651 <span class="comment">     */</span>
05652     <a class="code" href="../../d4/d1/userk_8h.html#a123">ThreadUnlockObject</a>(&amp;tlEvent);
05653 
05654     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
05655 }
05656 
05657 
05658 
05659 <span class="comment">/***************************************************************************\</span>
05660 <span class="comment"> * WaitOnPseudoEvent</span>
05661 <span class="comment"> *</span>
05662 <span class="comment"> * Similar semantics to WaitForSingleObject() but works with pseudo events.</span>
05663 <span class="comment"> * Could fail if creation on the fly fails.</span>
05664 <span class="comment"> * Returns STATUS_ABANDONED_WAIT if caller needs to wait on the event and event is</span>
05665 <span class="comment"> * created and ready to be waited on.</span>
05666 <span class="comment"> *</span>
05667 <span class="comment"> * This assumes the event was created with fManualReset=TRUE, fInitState=FALSE</span>
05668 <span class="comment"> *</span>
05669 <span class="comment"> * 10/28/93 SanfordS    Created</span>
05670 <span class="comment">\***************************************************************************/</span>
<a name="l05671"></a><a class="code" href="../../d4/d1/userk_8h.html#a1021">05671</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d4/d1/userk_8h.html#a1021">WaitOnPseudoEvent</a>(
05672     HANDLE *phE,
05673     DWORD dwMilliseconds)
05674 {
05675     HANDLE hEvent;
05676     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
05677 
05678     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
05679     <span class="keywordflow">if</span> (*phE == <a class="code" href="../../d4/d1/userk_8h.html#a363">PSEUDO_EVENT_OFF</a>) {
05680         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ZwCreateEvent(&amp;hEvent, EVENT_ALL_ACCESS, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
05681                 NotificationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>))) {
05682             UserAssert(!<span class="stringliteral">"Could not create event on the fly."</span>);
05683             <span class="keywordflow">if</span> (dwMilliseconds != INFINITE) {
05684                 <span class="keywordflow">return</span> STATUS_TIMEOUT;
05685             } <span class="keywordflow">else</span> {
05686                 <span class="keywordflow">return</span> (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)-1;
05687             }
05688         }
05689         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(hEvent, EVENT_ALL_ACCESS, *<a class="code" href="../../d7/d7/ntapi_8c.html#a3">ExEventObjectType</a>,
05690                 <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>, phE, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
05691         ZwClose(hEvent);
05692         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
05693             <span class="keywordflow">return</span> (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)-1;
05694     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*phE == <a class="code" href="../../d4/d1/userk_8h.html#a362">PSEUDO_EVENT_ON</a>) {
05695         <span class="keywordflow">return</span> STATUS_WAIT_0;
05696     }
05697     <span class="keywordflow">return</span>(STATUS_ABANDONED);
05698 }
05699 
05700 <span class="comment">/***************************************************************************\</span>
05701 <span class="comment">* xxxSetCsrssThreadDesktop</span>
05702 <span class="comment">*</span>
05703 <span class="comment">* Set/clear and lock/unlock a desktop for a csrss thread</span>
05704 <span class="comment">* When setting a desktop, ppdeskRestore must be valid and will receive</span>
05705 <span class="comment">*  the old (previous) desktop, if any; the caller is expected to restore</span>
05706 <span class="comment">*  this pdesk when done.</span>
05707 <span class="comment">* When restoring a desktop, ppdeskRestore must be NULL. pdesk must have been</span>
05708 <span class="comment">*  previously returned by this same function (in *ppdeskRestore).</span>
05709 <span class="comment">*</span>
05710 <span class="comment">* History:</span>
05711 <span class="comment">* 02-18-97 GerardoB     Extracted from SetInformationThread</span>
05712 <span class="comment">\***************************************************************************/</span>
<a name="l05713"></a><a class="code" href="../../d4/d1/userk_8h.html#a1829">05713</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d4/d1/userk_8h.html#a1829">xxxSetCsrssThreadDesktop</a>(<a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a> pdesk, PDESKRESTOREDATA pdrdRestore)
05714 {
05715     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
05716     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
05717     MSG <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>;
05718 
05719     <span class="comment">/*</span>
05720 <span class="comment">     * Only csr should come here</span>
05721 <span class="comment">     */</span>
05722     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a20">ISCSRSS</a>());
05723     UserAssert(pdrdRestore);
05724     UserAssert(pdrdRestore-&gt;pdeskRestore == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
05725 
05726     <span class="keywordflow">if</span> (pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o4">dwDTFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a287">DF_DESTROYED</a>) {
05727         RIPMSG1(RIP_WARNING, <span class="stringliteral">"xxxSetCsrssThreadDesktop: pdesk 0x%x destroyed"</span>,
05728                 pdesk);
05729         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
05730     }
05731 
05732     <span class="comment">/*</span>
05733 <span class="comment">     * Lock the current desktop (set operation).  Also, create and save a</span>
05734 <span class="comment">     * handle to the new desktop.</span>
05735 <span class="comment">     */</span>
05736     pdrdRestore-&gt;pdeskRestore = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>;
05737 
05738     <span class="keywordflow">if</span> (pdrdRestore-&gt;pdeskRestore != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05739         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a6">ObReferenceObjectByPointer</a>(pdrdRestore-&gt;pdeskRestore,
05740                                        MAXIMUM_ALLOWED,
05741                                        *<a class="code" href="../../d3/d7/win32_8c.html#a1">ExDesktopObjectType</a>,
05742                                        <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>);
05743 
05744         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
05745             pdrdRestore-&gt;pdeskRestore = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05746             pdrdRestore-&gt;hdeskNew = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05747             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
05748         }
05749         <a class="code" href="../../d4/d1/userk_8h.html#a120">LogDesktop</a>(pdrdRestore-&gt;pdeskRestore, LD_REF_FN_SETCSRSSTHREADDESKTOP, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, (ULONG_PTR)<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>());
05750     }
05751 
05752     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a3">ObOpenObjectByPointer</a>(
05753              pdesk,
05754              0,
05755              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
05756              EVENT_ALL_ACCESS,
05757              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
05758              <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
05759              &amp;(pdrdRestore-&gt;hdeskNew));
05760 
05761 
05762     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
05763         RIPNTERR2(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>, RIP_WARNING, <span class="stringliteral">"SetCsrssThreadDesktop, can't open handle, pdesk %#p. Status: %#x"</span>, pdesk, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
05764         <span class="keywordflow">if</span> (pdrdRestore-&gt;pdeskRestore) {
05765             <a class="code" href="../../d4/d1/userk_8h.html#a120">LogDesktop</a>(pdrdRestore-&gt;pdeskRestore, LD_DEREF_FN_SETCSRSSTHREADDESKTOP1, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, (ULONG_PTR)<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>());
05766             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pdrdRestore-&gt;pdeskRestore);
05767             pdrdRestore-&gt;pdeskRestore = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05768         }
05769         pdrdRestore-&gt;hdeskNew = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05770         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
05771     }
05772     <span class="comment">/*</span>
05773 <span class="comment">     * Set the new desktop, if switching</span>
05774 <span class="comment">     */</span>
05775     <span class="keywordflow">if</span> (pdesk != ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>) {
05776         <span class="comment">/*</span>
05777 <span class="comment">         * Process any remaining messages before we leave the desktop</span>
05778 <span class="comment">         */</span>
05779         <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>) {
05780             <span class="keywordflow">while</span> (<a class="code" href="../../d4/d1/userk_8h.html#a576">xxxPeekMessage</a>(&amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, 0, PM_REMOVE | PM_NOYIELD))
05781                 <a class="code" href="../../d4/d1/userk_8h.html#a1640">xxxDispatchMessage</a>(&amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>);
05782         }
05783 
05784         <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1801">xxxSetThreadDesktop</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, pdesk)) {
05785             RIPMSG1(RIP_WARNING, <span class="stringliteral">"xxxSetCsrssThreadDesktop: xxxSetThreadDesktop(%#p) failed"</span>, pdesk);
05786             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_HANDLE;
05787             <span class="comment">/*</span>
05788 <span class="comment">             * We're failing so deref if needed.</span>
05789 <span class="comment">             */</span>
05790             <span class="keywordflow">if</span> (pdrdRestore-&gt;pdeskRestore != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05791                 <a class="code" href="../../d4/d1/userk_8h.html#a120">LogDesktop</a>(pdrdRestore-&gt;pdeskRestore, LD_DEREF_FN_SETCSRSSTHREADDESKTOP1, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, (ULONG_PTR)<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>());
05792                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pdrdRestore-&gt;pdeskRestore);
05793                 pdrdRestore-&gt;pdeskRestore = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05794             }
05795             <a class="code" href="../../d4/d1/userk_8h.html#a2073">CloseProtectedHandle</a>(pdrdRestore-&gt;hdeskNew);
05796             pdrdRestore-&gt;hdeskNew = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05797         }
05798     }
05799 
05800     UserAssert(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
05801     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
05802 }
05803 
<a name="l05804"></a><a class="code" href="../../d4/d1/userk_8h.html#a1830">05804</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d4/d1/userk_8h.html#a1830">xxxRestoreCsrssThreadDesktop</a>(PDESKRESTOREDATA pdrdRestore)
05805 {
05806     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
05807     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
05808     MSG <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>;
05809 
05810     <span class="comment">/*</span>
05811 <span class="comment">     * Only csr should come here</span>
05812 <span class="comment">     */</span>
05813     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a20">ISCSRSS</a>());
05814     UserAssert(pdrdRestore);
05815 
05816     <span class="comment">/*</span>
05817 <span class="comment">     * Set the new desktop, if switching</span>
05818 <span class="comment">     */</span>
05819     <span class="keywordflow">if</span> (pdrdRestore-&gt;pdeskRestore != ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>) {
05820         <span class="comment">/*</span>
05821 <span class="comment">         * Process any remaining messages before we leave the desktop</span>
05822 <span class="comment">         */</span>
05823         <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>) {
05824             <span class="keywordflow">while</span> (<a class="code" href="../../d4/d1/userk_8h.html#a576">xxxPeekMessage</a>(&amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, 0, PM_REMOVE | PM_NOYIELD))
05825                 <a class="code" href="../../d4/d1/userk_8h.html#a1640">xxxDispatchMessage</a>(&amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>);
05826         }
05827 
05828         <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1801">xxxSetThreadDesktop</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, pdrdRestore-&gt;pdeskRestore)) {
05829             RIPMSG1(RIP_WARNING, <span class="stringliteral">"xxxRestoreCsrssThreadDesktop: xxxRestoreThreadDesktop(%#p) failed"</span>, pdrdRestore-&gt;pdeskRestore);
05830             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_HANDLE;
05831         }
05832     }
05833 
05834     <span class="comment">/*</span>
05835 <span class="comment">     * Dereference the desktop,</span>
05836 <span class="comment">     *   even if failing the call.</span>
05837 <span class="comment">     */</span>
05838     <span class="keywordflow">if</span> (pdrdRestore-&gt;pdeskRestore != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05839         <a class="code" href="../../d4/d1/userk_8h.html#a120">LogDesktop</a>(pdrdRestore-&gt;pdeskRestore, LD_DEREF_FN_SETCSRSSTHREADDESKTOP2, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, 0);
05840         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pdrdRestore-&gt;pdeskRestore);
05841         pdrdRestore-&gt;pdeskRestore = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05842     }
05843 
05844     <span class="keywordflow">if</span>(pdrdRestore-&gt;hdeskNew) {
05845         <a class="code" href="../../d4/d1/userk_8h.html#a2073">CloseProtectedHandle</a>(pdrdRestore-&gt;hdeskNew);
05846         UserAssert(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
05847         pdrdRestore-&gt;hdeskNew = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05848     }
05849     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
05850 }
05851 
05852 <span class="comment">/***************************************************************************\</span>
05853 <span class="comment">* GetTaskName</span>
05854 <span class="comment">*</span>
05855 <span class="comment">* Gets the application name from a thread.</span>
05856 <span class="comment">\***************************************************************************/</span>
<a name="l05857"></a><a class="code" href="../../d4/d1/userk_8h.html#a1825">05857</a> ULONG <a class="code" href="../../d4/d1/userk_8h.html#a1825">GetTaskName</a>(
05858     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti,
05859     PWSTR Buffer,
05860     ULONG BufferLength)
05861 {
05862     ANSI_STRING strAppName;
05863     UNICODE_STRING strAppNameU;
05864     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
05865     ULONG NameLength = 0;
05866 
05867     <span class="keywordflow">if</span> (pti == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05868         *<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = 0;
05869         <span class="keywordflow">return</span> 0;
05870     }
05871     <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o10">pstrAppName</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05872         NameLength = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o10">pstrAppName</a>-&gt;Length + <span class="keyword">sizeof</span>(WCHAR), BufferLength);
05873         RtlCopyMemory(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o10">pstrAppName</a>-&gt;Buffer, NameLength);
05874     } <span class="keywordflow">else</span> {
05875         <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(&amp;strAppName, pti-&gt;pEThread-&gt;ThreadsProcess-&gt;ImageFileName);
05876         <span class="keywordflow">if</span> (BufferLength &lt; <span class="keyword">sizeof</span>(WCHAR))
05877             NameLength = (strAppName.Length + 1) * <span class="keyword">sizeof</span>(WCHAR);
05878         <span class="keywordflow">else</span> {
05879             strAppNameU.Buffer = <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
05880             strAppNameU.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)BufferLength - <span class="keyword">sizeof</span>(WCHAR);
05881             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;strAppNameU, &amp;strAppName,
05882                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
05883             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
05884                 NameLength = strAppNameU.Length + <span class="keyword">sizeof</span>(WCHAR);
05885         }
05886     }
05887     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[(NameLength / <span class="keyword">sizeof</span>(WCHAR)) - 1] = 0;
05888 
05889     <span class="keywordflow">return</span> NameLength;
05890 }
05891 
05892 <span class="comment">/***************************************************************************\</span>
05893 <span class="comment">* QueryInformationThread</span>
05894 <span class="comment">*</span>
05895 <span class="comment">* Returns information about a thread.</span>
05896 <span class="comment">*</span>
05897 <span class="comment">* History:</span>
05898 <span class="comment">* 03-01-95 JimA         Created.</span>
05899 <span class="comment">\***************************************************************************/</span>
05900 
<a name="l05901"></a><a class="code" href="../../d4/d1/userk_8h.html#a1944">05901</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d4/d1/userk_8h.html#a1944">xxxQueryInformationThread</a>(
05902     IN HANDLE hThread,
05903     IN USERTHREADINFOCLASS ThreadInfoClass,
05904     OUT PVOID ThreadInformation,
05905     IN ULONG ThreadInformationLength,
05906     OUT PULONG ReturnLength OPTIONAL)
05907 {
05908     PUSERTHREAD_SHUTDOWN_INFORMATION pShutdown;
05909     PUSERTHREAD_WOW_INFORMATION pWow;
05910     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
05911     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti;
05912     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
05913     ULONG LocalReturnLength = 0;
05914     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwClientFlags;
05915 
05916     UNREFERENCED_PARAMETER(ThreadInformationLength);
05917     <span class="comment">/*</span>
05918 <span class="comment">     * Only allow CSRSS to make this call</span>
05919 <span class="comment">     */</span>
05920     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a20">ISCSRSS</a>());
05921 
05922     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(hThread,
05923                                         THREAD_QUERY_INFORMATION,
05924                                         *<a class="code" href="../../d9/d8/ntos_8h.html#a3">PsThreadType</a>,
05925                                         <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>,
05926                                         &amp;Thread,
05927                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
05928     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
05929         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
05930 
05931     pti = <a class="code" href="../../d4/d1/userk_8h.html#a17">PtiFromThread</a>(Thread);
05932 
05933     <span class="keywordflow">switch</span> (ThreadInfoClass) {
05934     <span class="keywordflow">case</span> UserThreadShutdownInformation:
05935         LocalReturnLength = <span class="keyword">sizeof</span>(USERTHREAD_SHUTDOWN_INFORMATION);
05936         UserAssert(ThreadInformationLength == <span class="keyword">sizeof</span>(USERTHREAD_SHUTDOWN_INFORMATION));
05937         pShutdown = ThreadInformation;
05938         <span class="comment">/*</span>
05939 <span class="comment">         * Read the client flags and zero out the structure,</span>
05940 <span class="comment">         *  except for pdeskRestore (which is supposed</span>
05941 <span class="comment">         *  to be the last field)</span>
05942 <span class="comment">         */</span>
05943         dwClientFlags = pShutdown-&gt;dwFlags;
05944         UserAssert(FIELD_OFFSET(USERTHREAD_SHUTDOWN_INFORMATION, drdRestore)
05945             == (<span class="keyword">sizeof</span>(USERTHREAD_SHUTDOWN_INFORMATION) - <span class="keyword">sizeof</span>(DESKRESTOREDATA)));
05946         RtlZeroMemory(pShutdown,
05947             <span class="keyword">sizeof</span>(USERTHREAD_SHUTDOWN_INFORMATION) - <span class="keyword">sizeof</span>(DESKRESTOREDATA));
05948 
05949         <span class="comment">/*</span>
05950 <span class="comment">         * Return the desktop window handle if the thread</span>
05951 <span class="comment">         * has a desktop and the desktop is on a visible</span>
05952 <span class="comment">         * windowstation.</span>
05953 <span class="comment">         */</span>
05954         <span class="keywordflow">if</span> (pti != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
05955                 !(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o3">rpwinstaParent</a>-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a316">WSF_NOIO</a>))
05956             pShutdown-&gt;hwndDesktop = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>);
05957 
05958         <span class="comment">/*</span>
05959 <span class="comment">         * Return shutdown status.  Zero indicates that the thread</span>
05960 <span class="comment">         * has windows and can be shut down in the normal manner.</span>
05961 <span class="comment">         */</span>
05962         <span class="keywordflow">if</span> (Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o12">Cid</a>.UniqueProcess == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a298">gpidLogon</a>) {
05963             <span class="comment">/*</span>
05964 <span class="comment">             * Do not shutdown the logon process.</span>
05965 <span class="comment">             */</span>
05966             pShutdown-&gt;StatusShutdown = <a class="code" href="../../d4/d1/userk_8h.html#a13">SHUTDOWN_KNOWN_PROCESS</a>;
05967         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pti == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05968 
05969             <span class="comment">/*</span>
05970 <span class="comment">             * The thread either is not a gui thread or it doesn't</span>
05971 <span class="comment">             * have a desktop.  Make console do the shutdown.</span>
05972 <span class="comment">             */</span>
05973             pShutdown-&gt;StatusShutdown = <a class="code" href="../../d4/d1/userk_8h.html#a14">SHUTDOWN_UNKNOWN_PROCESS</a>;
05974         }
05975 
05976         <span class="comment">/*</span>
05977 <span class="comment">         * Return flags</span>
05978 <span class="comment">         */</span>
05979         <span class="keywordflow">if</span> (pti != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o49">cWindows</a> != 0)
05980             pShutdown-&gt;dwFlags |= USER_THREAD_GUI;
05981 
05982         <span class="comment">/*</span>
05983 <span class="comment">         * If we return the desktop window handle and the</span>
05984 <span class="comment">         * app should be shut down, switch to the desktop</span>
05985 <span class="comment">         *  and assign it to the shutdown worker thread.</span>
05986 <span class="comment">         */</span>
05987         <span class="keywordflow">if</span> ((pShutdown-&gt;dwFlags &amp; USER_THREAD_GUI) &amp;&amp;
05988                 pShutdown-&gt;StatusShutdown == 0) {
05989             <span class="comment">/*</span>
05990 <span class="comment">             * The current csrss thread is going to</span>
05991 <span class="comment">             *  make activation calls, send messages,</span>
05992 <span class="comment">             *  switch video modes, etc  so we need to</span>
05993 <span class="comment">             *  assign it to a dekstop</span>
05994 <span class="comment">             */</span>
05995             <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
05996             UserAssert(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
05997 
05998             <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> != pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>) {
05999                 <span class="comment">/*</span>
06000 <span class="comment">                 * If this thread already has a desktop,</span>
06001 <span class="comment">                 *   restore the old one first.</span>
06002 <span class="comment">                 *  This might happen when threads of the same</span>
06003 <span class="comment">                 *  process are attached to different desktops.</span>
06004 <span class="comment">                 */</span>
06005                 <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06006                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1830">xxxRestoreCsrssThreadDesktop</a>(&amp;pShutdown-&gt;drdRestore);
06007                     UserAssert(pti == <a class="code" href="../../d4/d1/userk_8h.html#a17">PtiFromThread</a>(Thread));
06008                 }
06009                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
06010                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1829">xxxSetCsrssThreadDesktop</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>, &amp;pShutdown-&gt;drdRestore);
06011                     UserAssert(pti == <a class="code" href="../../d4/d1/userk_8h.html#a17">PtiFromThread</a>(Thread));
06012                 }
06013             }
06014             <span class="comment">/*</span>
06015 <span class="comment">             * If we're forcing a shutdown, then there is no need to switch</span>
06016 <span class="comment">             *  since we won't send any messages or bring up the EndTask dialog</span>
06017 <span class="comment">             * (We still want to have a proper rpdesk since BoostHardError might</span>
06018 <span class="comment">             *   call PostThreadMessage)</span>
06019 <span class="comment">             */</span>
06020             <span class="keywordflow">if</span> (!(dwClientFlags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a136">WMCS_NORETRY</a>)) {
06021                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
06022 <span class="preprocessor">                    #if DBG</span>
06023 <span class="preprocessor"></span>                        <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fSwitch =
06024 <span class="preprocessor">                    #endif</span>
06025 <span class="preprocessor"></span>                        <a class="code" href="../../d4/d1/userk_8h.html#a1798">xxxSwitchDesktop</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o3">rpwinstaParent</a>, pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
06026 <span class="preprocessor">                    #if DBG</span>
06027 <span class="preprocessor"></span>                        UserAssert(pti == <a class="code" href="../../d4/d1/userk_8h.html#a17">PtiFromThread</a>(Thread));
06028                         <span class="keywordflow">if</span> (!fSwitch) {
06029                             <span class="keywordflow">if</span> ((pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o3">rpwinstaParent</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
06030                                     || !(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o3">rpwinstaParent</a>-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a316">WSF_NOIO</a>)) {
06031 
06032                                 <span class="keywordflow">if</span> (!(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o3">rpwinstaParent</a>-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a319">WSF_REALSHUTDOWN</a>))
06033                                     RIPMSG1(RIP_ERROR, <span class="stringliteral">"UserThreadShutdownInformation: xxxSwitchDesktop failed. pti:%#p"</span>, pti);
06034 
06035                             }
06036                         }
06037 <span class="preprocessor">                    #endif</span>
06038 <span class="preprocessor"></span>                }
06039             }
06040         }
06041         <span class="keywordflow">break</span>;
06042 
06043     <span class="keywordflow">case</span> UserThreadFlags:
06044         LocalReturnLength = <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>);
06045         <span class="keywordflow">if</span> (pti == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
06046             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_HANDLE;
06047         <span class="keywordflow">else</span> {
06048             UserAssert(ThreadInformationLength == <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>));
06049             *(LPDWORD)ThreadInformation = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a>;
06050         }
06051         <span class="keywordflow">break</span>;
06052 
06053     <span class="keywordflow">case</span> UserThreadTaskName:
06054         LocalReturnLength = <a class="code" href="../../d4/d1/userk_8h.html#a1825">GetTaskName</a>(pti, ThreadInformation, ThreadInformationLength);
06055         <span class="keywordflow">break</span>;
06056 
06057     <span class="keywordflow">case</span> UserThreadWOWInformation:
06058         LocalReturnLength = <span class="keyword">sizeof</span>(USERTHREAD_WOW_INFORMATION);
06059         UserAssert(ThreadInformationLength == <span class="keyword">sizeof</span>(USERTHREAD_WOW_INFORMATION));
06060         pWow = ThreadInformation;
06061         RtlZeroMemory(pWow, <span class="keyword">sizeof</span>(USERTHREAD_WOW_INFORMATION));
06062 
06063         <span class="comment">/*</span>
06064 <span class="comment">         * If the thread is 16-bit, Status = the exit task function</span>
06065 <span class="comment">         * and task id.</span>
06066 <span class="comment">         */</span>
06067         <span class="keywordflow">if</span> (pti &amp;&amp; pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>) {
06068             pWow-&gt;lpfnWowExitTask = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o6">pwpi</a>-&gt;<a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html#o4">lpfnWowExitTask</a>;
06069             <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o22">ptdb</a>)
06070                 pWow-&gt;hTaskWow = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o22">ptdb</a>-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o5">hTaskWow</a>;
06071             <span class="keywordflow">else</span>
06072                 pWow-&gt;hTaskWow = 0;
06073         }
06074         <span class="keywordflow">break</span>;
06075 
06076     <span class="keywordflow">case</span> UserThreadHungStatus:
06077         LocalReturnLength = <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>);
06078         UserAssert(ThreadInformationLength &gt;= <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>));
06079 
06080         <span class="comment">/*</span>
06081 <span class="comment">         * Return hung status.</span>
06082 <span class="comment">         */</span>
06083         <span class="keywordflow">if</span> (pti)
06084             *(PDWORD)ThreadInformation =
06085                     (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>) <a class="code" href="../../d4/d1/userk_8h.html#a1650">FHungApp</a>(pti, (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)*(PDWORD)ThreadInformation);
06086         <span class="keywordflow">else</span>
06087             *(PDWORD)ThreadInformation = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06088         <span class="keywordflow">break</span>;
06089 
06090     <span class="keywordflow">default</span>:
06091         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_INFO_CLASS;
06092         UserAssert(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
06093         <span class="keywordflow">break</span>;
06094     }
06095 
06096     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ReturnLength) ) {
06097         *ReturnLength = LocalReturnLength;
06098         }
06099 
06100     <a class="code" href="../../d4/d1/userk_8h.html#a518">UnlockThread</a>(Thread);
06101 
06102     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
06103 }
06104 
06105 <span class="comment">/***************************************************************************\</span>
06106 <span class="comment">* xxxSetInformationThread</span>
06107 <span class="comment">*</span>
06108 <span class="comment">* Sets information about a thread.</span>
06109 <span class="comment">*</span>
06110 <span class="comment">* History:</span>
06111 <span class="comment">* 03-01-95 JimA         Created.</span>
06112 <span class="comment">\***************************************************************************/</span>
06113 
<a name="l06114"></a><a class="code" href="../../d4/d1/userk_8h.html#a1945">06114</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d4/d1/userk_8h.html#a1945">xxxSetInformationThread</a>(
06115     IN HANDLE hThread,
06116     IN USERTHREADINFOCLASS ThreadInfoClass,
06117     IN PVOID ThreadInformation,
06118     IN ULONG ThreadInformationLength)
06119 {
06120     PUSERTHREAD_FLAGS pFlags;
06121     HANDLE hClientThread;
06122     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwOldFlags;
06123     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiT;
06124     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
06125     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
06126     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> ThreadClient;
06127     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti;
06128     HANDLE <a class="code" href="../../d9/d9/csrdll_8h.html#a15">CsrPortHandle</a>;
06129 
06130     UNREFERENCED_PARAMETER(ThreadInformationLength);
06131 
06132     <span class="comment">/*</span>
06133 <span class="comment">     * Only allow CSRSS to make this call</span>
06134 <span class="comment">     */</span>
06135     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a20">ISCSRSS</a>());
06136 
06137     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(hThread,
06138                                         THREAD_SET_INFORMATION,
06139                                         *<a class="code" href="../../d9/d8/ntos_8h.html#a3">PsThreadType</a>,
06140                                         <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>,
06141                                         &amp;Thread,
06142                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
06143     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
06144         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
06145 
06146     pti = <a class="code" href="../../d4/d1/userk_8h.html#a17">PtiFromThread</a>(Thread);
06147 
06148     <span class="keywordflow">switch</span> (ThreadInfoClass) {
06149     <span class="keywordflow">case</span> UserThreadFlags:
06150         <span class="keywordflow">if</span> (pti == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
06151             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_HANDLE;
06152         <span class="keywordflow">else</span> {
06153             UserAssert(ThreadInformationLength == <span class="keyword">sizeof</span>(USERTHREAD_FLAGS));
06154             pFlags = ThreadInformation;
06155             dwOldFlags = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a>;
06156             pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> ^= ((dwOldFlags ^ pFlags-&gt;dwFlags) &amp; pFlags-&gt;dwMask);
06157         }
06158         <span class="keywordflow">break</span>;
06159 
06160     <span class="keywordflow">case</span> UserThreadHungStatus:
06161         <span class="keywordflow">if</span> (pti == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
06162             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_HANDLE;
06163         <span class="keywordflow">else</span> {
06164 
06165             <span class="comment">/*</span>
06166 <span class="comment">             * No arguments, simple set the last time read.</span>
06167 <span class="comment">             */</span>
06168             <a class="code" href="../../d4/d1/userk_8h.html#a257">SET_TIME_LAST_READ</a>(pti);
06169         }
06170         <span class="keywordflow">break</span>;
06171 
06172     <span class="keywordflow">case</span> UserThreadInitiateShutdown:
06173         UserAssert(ThreadInformationLength == <span class="keyword">sizeof</span>(ULONG));
06174         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d3/queue_8c.html#a21">InitiateShutdown</a>(Thread, (PULONG)ThreadInformation);
06175         <span class="keywordflow">break</span>;
06176 
06177     <span class="keywordflow">case</span> UserThreadEndShutdown:
06178         UserAssert(ThreadInformationLength == <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>));
06179         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d3/queue_8c.html#a22">EndShutdown</a>(Thread, *(<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> *)ThreadInformation);
06180         <span class="keywordflow">break</span>;
06181 
06182     <span class="keywordflow">case</span> UserThreadUseDesktop:
06183         UserAssert(ThreadInformationLength == <span class="keyword">sizeof</span>(USERTHREAD_USEDESKTOPINFO));
06184         <span class="keywordflow">if</span> (pti == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06185             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_HANDLE;
06186             <span class="keywordflow">break</span>;
06187         }
06188 
06189         <span class="comment">/*</span>
06190 <span class="comment">         * If the caller provides a thread handle, then we use that</span>
06191 <span class="comment">         *  thread's pdesk and return the pdesk currently used</span>
06192 <span class="comment">         *  by the caller (set operation). Otherwise,</span>
06193 <span class="comment">         *  we use the pdesk provided by the caller (restore operation).</span>
06194 <span class="comment">         */</span>
06195         hClientThread = ((PUSERTHREAD_USEDESKTOPINFO)ThreadInformation)-&gt;hThread;
06196         <span class="keywordflow">if</span> (hClientThread != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06197             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(hClientThread,
06198                                             THREAD_QUERY_INFORMATION,
06199                                             *<a class="code" href="../../d9/d8/ntos_8h.html#a3">PsThreadType</a>,
06200                                             <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>,
06201                                             &amp;ThreadClient,
06202                                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
06203             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
06204                 <span class="keywordflow">break</span>;
06205 
06206             ptiT = <a class="code" href="../../d4/d1/userk_8h.html#a17">PtiFromThread</a>(ThreadClient);
06207             <span class="keywordflow">if</span> ((ptiT == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (ptiT-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
06208                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_HANDLE;
06209                 <span class="keywordflow">goto</span> DerefClientThread;
06210             }
06211             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1829">xxxSetCsrssThreadDesktop</a>(ptiT-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>, &amp;((PUSERTHREAD_USEDESKTOPINFO)ThreadInformation)-&gt;drdRestore);
06212         } <span class="keywordflow">else</span> {
06213             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1830">xxxRestoreCsrssThreadDesktop</a>(&amp;((PUSERTHREAD_USEDESKTOPINFO)ThreadInformation)-&gt;drdRestore);
06214         }
06215 
06216 
06217         <span class="keywordflow">if</span> (hClientThread != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06218 DerefClientThread:
06219             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(ThreadClient);
06220         }
06221         <span class="keywordflow">break</span>;
06222 
06223     <span class="keywordflow">case</span> UserThreadUseActiveDesktop:
06224     {
06225         UserAssert(ThreadInformationLength == <span class="keyword">sizeof</span>(USERTHREAD_USEDESKTOPINFO));
06226         <span class="keywordflow">if</span> (pti == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06227             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_HANDLE;
06228             <span class="keywordflow">break</span>;
06229         }
06230         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1829">xxxSetCsrssThreadDesktop</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>,
06231                     &amp;((PUSERTHREAD_USEDESKTOPINFO)ThreadInformation)-&gt;drdRestore);
06232         <span class="keywordflow">break</span>;
06233     }
06234     <span class="keywordflow">case</span> UserThreadCsrApiPort:
06235 
06236         <span class="comment">/*</span>
06237 <span class="comment">         * Only CSR can call this</span>
06238 <span class="comment">         */</span>
06239         <span class="keywordflow">if</span> (Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o28">ThreadsProcess</a> != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a299">gpepCSRSS</a>) {
06240             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED;
06241             <span class="keywordflow">break</span>;
06242         }
06243 
06244         UserAssert(ThreadInformationLength == <span class="keyword">sizeof</span>(HANDLE));
06245 
06246         <span class="comment">/*</span>
06247 <span class="comment">         * Only set it once.</span>
06248 <span class="comment">         */</span>
06249         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a243">CsrApiPort</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
06250             <span class="keywordflow">break</span>;
06251 
06252         <a class="code" href="../../d9/d9/csrdll_8h.html#a15">CsrPortHandle</a> = *(PHANDLE)ThreadInformation;
06253         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
06254                 <a class="code" href="../../d9/d9/csrdll_8h.html#a15">CsrPortHandle</a>,
06255                 0,
06256                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <span class="comment">//*LpcPortObjectType,</span>
06257                 <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>,
06258                 &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a243">CsrApiPort</a>,
06259                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
06260         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
06261             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a243">CsrApiPort</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06262             RIPMSG1(RIP_WARNING,
06263                     <span class="stringliteral">"CSR port reference failed, Status=%#lx"</span>,
06264                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
06265         }
06266 
06267         <span class="keywordflow">break</span>;
06268 
06269     <span class="keywordflow">default</span>:
06270         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_INFO_CLASS;
06271         UserAssert(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
06272         <span class="keywordflow">break</span>;
06273     }
06274 
06275     <a class="code" href="../../d4/d1/userk_8h.html#a518">UnlockThread</a>(Thread);
06276 
06277     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
06278 }
06279 
06280 <span class="preprocessor">#ifdef USE_MIRRORING</span>
06281 <span class="preprocessor"></span><span class="comment">/***************************************************************************\</span>
06282 <span class="comment">* _GetProcessDefaultLayout (API)</span>
06283 <span class="comment">*</span>
06284 <span class="comment">* Retreives the default layout information about a process.</span>
06285 <span class="comment">*</span>
06286 <span class="comment">* History:</span>
06287 <span class="comment">* 23-01-98 SamerA         Created.</span>
06288 <span class="comment">\***************************************************************************/</span>
06289 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> _GetProcessDefaultLayout(
06290     OUT DWORD *pdwDefaultLayout)
06291 {
06292     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
06293 
06294     <span class="comment">/*</span>
06295 <span class="comment">     * Do not allow CSRSS to make this call. This call might</span>
06296 <span class="comment">     * happen due to the inheritence code. See xxxCreateWindowEx(...)</span>
06297 <span class="comment">     */</span>
06298     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a299">gpepCSRSS</a>) {
06299         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06300     }
06301 
06302     <span class="keywordflow">try</span> {
06303         *pdwDefaultLayout = <a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>()-&gt;dwLayout;
06304     } except (W32ExceptionHandler(FALSE, RIP_WARNING)) {
06305         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
06306     }
06307 
06308     <span class="keywordflow">return</span> <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status);
06309 }
06310 
06311 <span class="comment">/***************************************************************************\</span>
06312 <span class="comment">* _SetProcessDefaultLayout (API)</span>
06313 <span class="comment">*</span>
06314 <span class="comment">* Sets the default layout information about a process.</span>
06315 <span class="comment">*</span>
06316 <span class="comment">* History:</span>
06317 <span class="comment">* 23-01-98 SamerA         Created.</span>
06318 <span class="comment">\***************************************************************************/</span>
06319 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> _SetProcessDefaultLayout(
06320     IN DWORD dwDefaultLayout)
06321 {
06322     <span class="comment">/*</span>
06323 <span class="comment">     * Do not allow CSRSS to make this call</span>
06324 <span class="comment">     */</span>
06325     UserAssert(<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() != gpepCSRSS);
06326 
06327     <span class="comment">/*</span>
06328 <span class="comment">     * Validate dwDefaultLayout</span>
06329 <span class="comment">     */</span>
06330     <span class="keywordflow">if</span> (dwDefaultLayout &amp; ~LAYOUT_ORIENTATIONMASK)
06331     {
06332         RIPERR1(ERROR_INVALID_PARAMETER,
06333                 RIP_WARNING,
06334                 <span class="stringliteral">"Calling SetProcessDefaultLayout with invalid layout = %lX"</span>,
06335                 dwDefaultLayout);
06336         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06337     }
06338 
06339     <span class="comment">/*</span>
06340 <span class="comment">     * Update the process default layout param</span>
06341 <span class="comment">     */</span>
06342     <a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>()-&gt;dwLayout = dwDefaultLayout;
06343 
06344     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
06345 }
06346 <span class="preprocessor">#endif</span>
06347 <span class="preprocessor"></span>
06348 <span class="comment">/***************************************************************************\</span>
06349 <span class="comment">* SetInformationProcess</span>
06350 <span class="comment">*</span>
06351 <span class="comment">* Sets information about a process.</span>
06352 <span class="comment">*</span>
06353 <span class="comment">* History:</span>
06354 <span class="comment">* 09-27-96 GerardoB         Created.</span>
06355 <span class="comment">\***************************************************************************/</span>
06356 
<a name="l06357"></a><a class="code" href="../../d4/d1/userk_8h.html#a1946">06357</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d4/d1/userk_8h.html#a1946">SetInformationProcess</a>(
06358     IN HANDLE hProcess,
06359     IN USERPROCESSINFOCLASS ProcessInfoClass,
06360     IN PVOID ProcessInformation,
06361     IN ULONG ProcessInformationLength)
06362 {
06363     PUSERPROCESS_FLAGS pFlags;
06364     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwOldFlags;
06365     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
06366     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
06367     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppi;
06368 
06369     UNREFERENCED_PARAMETER(ProcessInformationLength);
06370 
06371     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a20">ISCSRSS</a>());
06372 
06373     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(hProcess,
06374                                         PROCESS_SET_INFORMATION,
06375                                         *<a class="code" href="../../d9/d8/ntos_8h.html#a2">PsProcessType</a>,
06376                                         <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>,
06377                                         &amp;Process,
06378                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
06379     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
06380         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
06381     }
06382 
06383     ppi = <a class="code" href="../../d4/d1/userk_8h.html#a18">PpiFromProcess</a>(Process);
06384 
06385     <span class="keywordflow">switch</span> (ProcessInfoClass) {
06386     <span class="keywordflow">case</span> UserProcessFlags:
06387         <span class="keywordflow">if</span> (ppi == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06388             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_HANDLE;
06389         } <span class="keywordflow">else</span> {
06390             UserAssert(ProcessInformationLength == <span class="keyword">sizeof</span>(USERPROCESS_FLAGS));
06391             pFlags = ProcessInformation;
06392             dwOldFlags = ppi-&gt;W32PF_Flags;
06393             ppi-&gt;W32PF_Flags ^= ((dwOldFlags ^ pFlags-&gt;dwFlags) &amp; pFlags-&gt;dwMask);
06394         }
06395         <span class="keywordflow">break</span>;
06396 
06397     <span class="keywordflow">default</span>:
06398         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_INFO_CLASS;
06399         UserAssert(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
06400         <span class="keywordflow">break</span>;
06401     }
06402 
06403     <a class="code" href="../../d4/d1/userk_8h.html#a517">UnlockProcess</a>(Process);
06404 
06405     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
06406 }
06407 
06408 
06409 <span class="comment">/***************************************************************************\</span>
06410 <span class="comment">* xxxSetConsoleCaretInfo</span>
06411 <span class="comment">*</span>
06412 <span class="comment">* Store information about the console's homegrown caret and notify any</span>
06413 <span class="comment">* interested apps that it changed. We need this for accessibility.</span>
06414 <span class="comment">*</span>
06415 <span class="comment">* History:</span>
06416 <span class="comment">* 26-May-1999 JerrySh   Created.</span>
06417 <span class="comment">\***************************************************************************/</span>
06418 
<a name="l06419"></a><a class="code" href="../../d6/d3/queue_8c.html#a86">06419</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d6/d3/queue_8c.html#a86">xxxSetConsoleCaretInfo</a>(
06420     PCONSOLE_CARET_INFO pcci)
06421 {
06422     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
06423     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwnd;
06424 
06425     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a405">FWINABLE</a>()) {
06426         pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(pcci-&gt;hwnd);
06427         <span class="keywordflow">if</span> (pwnd &amp;&amp; pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.rpdesk) {
06428             pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.rpdesk-&gt;cciConsole = *pcci;
06429             <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pwnd, &amp;tlpwnd);
06430             <a class="code" href="../../d5/d7/kernel_2winable_8c.html#a8">xxxWindowEvent</a>(EVENT_OBJECT_LOCATIONCHANGE, pwnd, OBJID_CARET, INDEXID_CONTAINER, <a class="code" href="../../d4/d1/userk_8h.html#a612">WEF_ASYNC</a>);
06431             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
06432         }
06433     }
06434 }
06435 
06436 <span class="comment">/***************************************************************************\</span>
06437 <span class="comment">* xxxConsoleControl</span>
06438 <span class="comment">*</span>
06439 <span class="comment">* Performs special control operations for console.</span>
06440 <span class="comment">*</span>
06441 <span class="comment">* History:</span>
06442 <span class="comment">* 03-01-95 JimA         Created.</span>
06443 <span class="comment">\***************************************************************************/</span>
06444 
<a name="l06445"></a><a class="code" href="../../d4/d1/userk_8h.html#a1947">06445</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d4/d1/userk_8h.html#a1947">xxxConsoleControl</a>(
06446     IN CONSOLECONTROL ConsoleControl,
06447     IN PVOID ConsoleInformation,
06448     IN ULONG ConsoleInformationLength)
06449 {
06450     PCONSOLEDESKTOPCONSOLETHREAD pDesktopConsole;
06451     PCONSOLEWINDOWSTATIONPROCESS pConsoleWindowStationInfo;
06452     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a> pdesk;
06453     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwThreadIdOld;
06454     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
06455 
06456     UNREFERENCED_PARAMETER(ConsoleInformationLength);
06457     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a20">ISCSRSS</a>());
06458 
06459     <span class="keywordflow">switch</span> (ConsoleControl) {
06460     <span class="keywordflow">case</span> ConsoleDesktopConsoleThread:
06461         UserAssert(ConsoleInformationLength == <span class="keyword">sizeof</span>(CONSOLEDESKTOPCONSOLETHREAD));
06462         pDesktopConsole = (PCONSOLEDESKTOPCONSOLETHREAD)ConsoleInformation;
06463 
06464         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
06465                 pDesktopConsole-&gt;hdesk,
06466                 0,
06467                 *<a class="code" href="../../d3/d7/win32_8c.html#a1">ExDesktopObjectType</a>,
06468                 <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>,
06469                 &amp;pdesk,
06470                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
06471         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
06472             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
06473 
06474         <a class="code" href="../../d4/d1/userk_8h.html#a120">LogDesktop</a>(pdesk, LD_REF_FN_CONSOLECONTROL1, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, (ULONG_PTR)<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>());
06475 
06476         dwThreadIdOld = pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o17">dwConsoleThreadId</a>;
06477 
06478         <span class="keywordflow">if</span> (pDesktopConsole-&gt;dwThreadId != (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)-1) {
06479             pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o17">dwConsoleThreadId</a> =
06480                     pDesktopConsole-&gt;dwThreadId;
06481         }
06482 
06483         pDesktopConsole-&gt;dwThreadId = dwThreadIdOld;
06484         <a class="code" href="../../d4/d1/userk_8h.html#a120">LogDesktop</a>(pdesk, LD_DEREF_FN_CONSOLECONTROL1, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, (ULONG_PTR)<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>());
06485         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pdesk);
06486         <span class="keywordflow">break</span>;
06487 
06488     <span class="keywordflow">case</span> ConsoleClassAtom:
06489         UserAssert(ConsoleInformationLength == <span class="keyword">sizeof</span>(ATOM));
06490         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a281">gatomConsoleClass</a> = *(ATOM *)ConsoleInformation;
06491         <span class="keywordflow">break</span>;
06492 
06493     <span class="keywordflow">case</span> ConsoleNotifyConsoleApplication:
06494         <span class="comment">/*</span>
06495 <span class="comment">         * Bug 273518 - joejo</span>
06496 <span class="comment">         *</span>
06497 <span class="comment">         * Adding optimization to bug fix</span>
06498 <span class="comment">         */</span>
06499         UserAssert(ConsoleInformationLength == <span class="keyword">sizeof</span>(CONSOLE_PROCESS_INFO));
06500         <a class="code" href="../../d6/d3/queue_8c.html#a28">xxxUserNotifyConsoleApplication</a>((PCONSOLE_PROCESS_INFO)ConsoleInformation);
06501         <span class="keywordflow">break</span>;
06502 
06503     <span class="keywordflow">case</span> ConsoleSetVDMCursorBounds:
06504         UserAssert((ConsoleInformation == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
06505             (ConsoleInformationLength == <span class="keyword">sizeof</span>(RECT)));
06506         <a class="code" href="../../d6/d3/queue_8c.html#a23">SetVDMCursorBounds</a>(ConsoleInformation);
06507         <span class="keywordflow">break</span>;
06508 
06509     <span class="keywordflow">case</span> ConsolePublicPalette:
06510         UserAssert(ConsoleInformationLength == <span class="keyword">sizeof</span>(HPALETTE));
06511         GreSetPaletteOwner(*(HPALETTE *)ConsoleInformation, OBJECT_OWNER_PUBLIC);
06512         <span class="keywordflow">break</span>;
06513 
06514     <span class="keywordflow">case</span> ConsoleWindowStationProcess:
06515         UserAssert(ConsoleInformationLength == <span class="keyword">sizeof</span>(CONSOLEWINDOWSTATIONPROCESS));
06516 
06517         pConsoleWindowStationInfo = (PCONSOLEWINDOWSTATIONPROCESS)ConsoleInformation;
06518         <a class="code" href="../../d6/d3/queue_8c.html#a29">UserSetConsoleProcessWindowStation</a>(pConsoleWindowStationInfo-&gt;dwProcessId,
06519                                            pConsoleWindowStationInfo-&gt;hwinsta);
06520         <span class="keywordflow">break</span>;
06521 
06522 <span class="preprocessor">#if defined(FE_IME)</span>
06523 <span class="preprocessor"></span>    <span class="comment">/*</span>
06524 <span class="comment">     * For console IME issue</span>
06525 <span class="comment">     *</span>
06526 <span class="comment">     * Console IME do register thread ID in DESKTOP info.</span>
06527 <span class="comment">     * So should be per desktop.</span>
06528 <span class="comment">     */</span>
06529     <span class="keywordflow">case</span> ConsoleRegisterConsoleIME:
06530         {
06531             PCONSOLE_REGISTER_CONSOLEIME RegConIMEInfo;
06532             <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwConsoleIMEThreadIdOld;
06533 
06534             UserAssert(ConsoleInformationLength == <span class="keyword">sizeof</span>(CONSOLE_REGISTER_CONSOLEIME));
06535 
06536             RegConIMEInfo = (PCONSOLE_REGISTER_CONSOLEIME)ConsoleInformation;
06537             RegConIMEInfo-&gt;dwConsoleInputThreadId = 0;
06538 
06539             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
06540                     RegConIMEInfo-&gt;hdesk,
06541                     0,
06542                     *<a class="code" href="../../d3/d7/win32_8c.html#a1">ExDesktopObjectType</a>,
06543                     <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>,
06544                     &amp;pdesk,
06545                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
06546             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
06547                 <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
06548 
06549             <a class="code" href="../../d4/d1/userk_8h.html#a120">LogDesktop</a>(pdesk, LD_REF_FN_CONSOLECONTROL2, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, (ULONG_PTR)<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>());
06550 
06551             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
06552             <span class="keywordflow">if</span> (pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o17">dwConsoleThreadId</a>)
06553             {
06554                 <span class="comment">/*</span>
06555 <span class="comment">                 * Exists console input thread</span>
06556 <span class="comment">                 */</span>
06557                 RegConIMEInfo-&gt;dwConsoleInputThreadId = pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o17">dwConsoleThreadId</a>;
06558 
06559                 dwConsoleIMEThreadIdOld = pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o18">dwConsoleIMEThreadId</a>;
06560 
06561                 <span class="keywordflow">if</span> (RegConIMEInfo-&gt;dwAction != REGCONIME_QUERY) {
06562                     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiConsoleIME;
06563 
06564                     <span class="keywordflow">if</span> ((ptiConsoleIME = <a class="code" href="../../d4/d1/userk_8h.html#a1201">PtiFromThreadId</a>(RegConIMEInfo-&gt;dwThreadId)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
06565                     {
06566                         <span class="keywordflow">if</span> ( (RegConIMEInfo-&gt;dwAction == REGCONIME_REGISTER) &amp;&amp;
06567                              !(ptiConsoleIME-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a801">TIF_DONTATTACHQUEUE</a>) )
06568                         {
06569                             <span class="comment">/*</span>
06570 <span class="comment">                             * Register</span>
06571 <span class="comment">                             */</span>
06572                             ptiConsoleIME-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a801">TIF_DONTATTACHQUEUE</a>;
06573                             pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o18">dwConsoleIMEThreadId</a> = RegConIMEInfo-&gt;dwThreadId;
06574                         }
06575                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (RegConIMEInfo-&gt;dwAction == REGCONIME_UNREGISTER) &amp;&amp;
06576                                   (ptiConsoleIME-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a801">TIF_DONTATTACHQUEUE</a>) )
06577                         {
06578                             <span class="comment">/*</span>
06579 <span class="comment">                             * Unregister</span>
06580 <span class="comment">                             */</span>
06581                             ptiConsoleIME-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a801">TIF_DONTATTACHQUEUE</a>;
06582                             pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o18">dwConsoleIMEThreadId</a> = 0;
06583                         }
06584                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (RegConIMEInfo-&gt;dwAction == REGCONIME_TERMINATE)
06585                         {
06586                             <span class="comment">/*</span>
06587 <span class="comment">                             * Terminate console IME (Logoff/Shutdown)</span>
06588 <span class="comment">                             */</span>
06589                             pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o18">dwConsoleIMEThreadId</a> = 0;
06590                         }
06591                     }
06592                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (RegConIMEInfo-&gt;dwAction == REGCONIME_TERMINATE)
06593                     {
06594                         <span class="comment">/*</span>
06595 <span class="comment">                         * Abnormal end console IME</span>
06596 <span class="comment">                         */</span>
06597                         pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o18">dwConsoleIMEThreadId</a> = 0;
06598                     }
06599                     <span class="keywordflow">else</span>
06600                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED;
06601                 }
06602                 RegConIMEInfo-&gt;dwThreadId = dwConsoleIMEThreadIdOld;
06603             }
06604             <a class="code" href="../../d4/d1/userk_8h.html#a120">LogDesktop</a>(pdesk, LD_DEREF_FN_CONSOLECONTROL2, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, (ULONG_PTR)<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>());
06605             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(pdesk);
06606             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
06607         }
06608         <span class="keywordflow">break</span>;
06609 <span class="preprocessor">#endif</span>
06610 <span class="preprocessor"></span>
06611     <span class="keywordflow">case</span> ConsoleFullscreenSwitch:
06612         UserAssert(ConsoleInformationLength == <span class="keyword">sizeof</span>(CONSOLE_FULLSCREEN_SWITCH));
06613         <a class="code" href="../../d4/d1/userk_8h.html#a1759">xxxbFullscreenSwitch</a>(((PCONSOLE_FULLSCREEN_SWITCH)ConsoleInformation)-&gt;bFullscreenSwitch,
06614                              ((PCONSOLE_FULLSCREEN_SWITCH)ConsoleInformation)-&gt;hwnd);
06615         <span class="keywordflow">break</span>;
06616 
06617     <span class="keywordflow">case</span> ConsoleSetCaretInfo:
06618         UserAssert(ConsoleInformationLength == <span class="keyword">sizeof</span>(CONSOLE_CARET_INFO));
06619         <a class="code" href="../../d6/d3/queue_8c.html#a86">xxxSetConsoleCaretInfo</a>((PCONSOLE_CARET_INFO)ConsoleInformation);
06620         <span class="keywordflow">break</span>;
06621 
06622     <span class="keywordflow">default</span>:
06623         RIPMSG0(RIP_ERROR, <span class="stringliteral">"xxxConsoleControl - invalid control class\n"</span>);
06624         UserAssert(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
06625         <span class="keywordflow">return</span> STATUS_INVALID_INFO_CLASS;
06626     }
06627     <span class="keywordflow">return</span> STATUS_SUCCESS;
06628 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:35 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
