<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: cmse.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>cmse.c File Reference</h1><code>#include "<a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>"</code><br>

<p>
<a href="../../d8/d1/cmse_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d2/cmse_8c.html#a0">SECURITY_CELL_LENGTH</a>(pDescriptor)</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d2/cmse_8c.html#a1">CmpSetSecurityDescriptorInfo</a> (IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> kcb, IN PSECURITY_INFORMATION SecurityInformation, IN PSECURITY_DESCRIPTOR ModificationDescriptor, IN OUT PSECURITY_DESCRIPTOR *ObjectsSecurityDescriptor, IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a> PoolType, IN PGENERIC_MAPPING GenericMapping)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d2/cmse_8c.html#a2">CmpQuerySecurityDescriptorInfo</a> (IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> kcb, IN PSECURITY_INFORMATION SecurityInformation, OUT PSECURITY_DESCRIPTOR SecurityDescriptor, IN OUT PULONG Length, IN OUT PSECURITY_DESCRIPTOR *ObjectsSecurityDescriptor)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d2/cmse_8c.html#a3">CmpGetKeySecurity</a> (IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, IN <a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> <a class="el" href="../../d3/d0/user32_8def.html#a52">Key</a>, OUT <a class="el" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> SecurityCell OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d2/cmse_8c.html#a4">CmpGetObjectSecurity</a> (IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>, IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, OUT <a class="el" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a> *Security, OUT <a class="el" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> SecurityCell OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d2/cmse_8c.html#a5">CmpFindMatchingDescriptorCell</a> (IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, IN <a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Node, IN PSECURITY_DESCRIPTOR SecurityDescriptor, IN ULONG Type, OUT <a class="el" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> MatchingCell)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d2/cmse_8c.html#a6">CmpInsertSecurityCellList</a> (IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> NodeCell, IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> SecurityCell)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d2/cmse_8c.html#a7">CmpRemoveSecurityCellList</a> (IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> SecurityCell)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d2/cmse_8c.html#a8">CmpSecurityExceptionFilter</a> (IN PEXCEPTION_POINTERS ExceptionPointers)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d2/cmse_8c.html#a9">CmpSecurityMethod</a> (IN PVOID Object, IN <a class="el" href="../../d0/d5/se_8h.html#a19">SECURITY_OPERATION_CODE</a> OperationCode, IN PSECURITY_INFORMATION SecurityInformation, IN OUT PSECURITY_DESCRIPTOR SecurityDescriptor, IN OUT PULONG CapturedLength, IN OUT PSECURITY_DESCRIPTOR *ObjectsSecurityDescriptor, IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a> PoolType, IN PGENERIC_MAPPING GenericMapping)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d2/cmse_8c.html#a10">CmpAssignSecurityDescriptor</a> (IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>, IN <a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Node, IN PSECURITY_DESCRIPTOR SecurityDescriptor)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d2/cmse_8c.html#a11">CmpCheckCreateAccess</a> (IN PUNICODE_STRING <a class="el" href="../../d2/d2/rtload_8c.html#a7">RelativeName</a>, IN PSECURITY_DESCRIPTOR Descriptor, IN <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode, IN ACCESS_MASK AdditionalAccess, OUT PNTSTATUS AccessStatus)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d2/cmse_8c.html#a12">CmpCheckNotifyAccess</a> (IN <a class="el" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html">PCM_NOTIFY_BLOCK</a> NotifyBlock, IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, IN <a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Node)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PSECURITY_DESCRIPTOR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d2/cmse_8c.html#a13">CmpHiveRootSecurityDescriptor</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d2/cmse_8c.html#a14">CmpFreeSecurityDescriptor</a> (IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="cmse.c::SECURITY_CELL_LENGTH" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SECURITY_CELL_LENGTH          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">pDescriptor&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>FIELD_OFFSET(<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">CM_KEY_SECURITY</a>,Descriptor) + \
    <a class="code" href="../../d8/d6/sertl_8c.html#a56">RtlLengthSecurityDescriptor</a>(pDescriptor)
</div></pre>
<p>
Definition at line <a class="el" href="../../d8/d1/cmse_8c-source.html#l00095">95</a> of file <a class="el" href="../../d8/d1/cmse_8c-source.html">cmse.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d1/cmse_8c-source.html#l00697">CmpAssignSecurityDescriptor()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00397">CmpSetSecurityDescriptorInfo()</a>, and <a class="el" href="../../d0/d4/edithive_8c-source.html#l00988">EhpAttachSecurity()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a10" doxytag="cmse.c::CmpAssignSecurityDescriptor" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmpAssignSecurityDescriptor           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Cell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Node</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityDescriptor</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d1/cmse_8c-source.html#l00697">697</a> of file <a class="el" href="../../d8/d1/cmse_8c-source.html">cmse.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00531">ASSERT_NODE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00517">CM_KEY_SECURITY_SIGNATURE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00248">CML_FLOW</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00400">CmpDumpSecurityDescriptor</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01545">CmpFindMatchingDescriptorCell()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01704">CmpInsertSecurityCellList()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00263">CMS_SEC</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00526">_CM_KEY_SECURITY::Descriptor</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00525">_CM_KEY_SECURITY::DescriptorLength</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00386">HvAllocateCell()</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00688">HvFreeCell()</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00135">HvGetCellType</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00117">HvMarkCellDirty()</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00154">Name</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00524">_CM_KEY_SECURITY::ReferenceCount</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l02165">RtlLengthSecurityDescriptor()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00095">SECURITY_CELL_LENGTH</a>, and <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00520">_CM_KEY_SECURITY::Signature</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00686">CmpCopyKeyPartial()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00158">CmpSecurityMethod()</a>, and <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01338">CmpSyncKeyValues()</a>.
<p>
<pre class="fragment"><div>00706                    :
00707 
00708     This routine assigns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given security descriptor to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified
00709     node in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> configuration tree.
00710 
00711 Arguments:
00712 
00713     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> node whose security
00714            descriptor will be assigned.
00715 
00716     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> node whose security descriptor
00717            will be assigned.
00718 
00719     Node - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> node whose security descriptor will
00720            be assigned.
00721 
00722     SecurityDescriptor - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor to
00723            be assigned to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> node.
00724 
00725     PoolType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SecurityDescriptor was a
00726            allocated from.
00727 
00728 Return Value:
00729 
00730     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - STATUS_SUCCESS <span class="keywordflow">if</span> successful and an appropriate error value
00731         otherwise
00732 
00733 --*/
00734 
00735 {
00736     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> SecurityCell;
00737     <a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a> Security;
00738     ULONG DescriptorLength;
00739     ULONG Type;
00740 
00741     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00742     <span class="comment">//</span>
00743     <span class="comment">// Map the node that we need to assign the security descriptor to.</span>
00744     <span class="comment">//</span>
00745     <span class="keywordflow">if</span> (! <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(Hive, Cell)) {
00746         <span class="keywordflow">return</span> STATUS_NO_LOG_SPACE;
00747     }
00748     <a class="code" href="../../d1/d2/cmp_8h.html#a84">ASSERT_NODE</a>(Node);
00749 
00750     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_SEC) {
00751 <span class="preprocessor">#if DBG</span>
00752 <span class="preprocessor"></span>        UNICODE_STRING <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>;
00753 
00754         <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.MaximumLength = <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Length = Node-&gt;NameLength;
00755         <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Buffer = Node-&gt;Name;
00756         KdPrint((<span class="stringliteral">"CmpAssignSecurityDescriptor: '%wZ' (H %lx C %lx)\n"</span>,&amp;Name,Hive,Cell ));
00757         KdPrint((<span class="stringliteral">"\tSecurityCell = %lx\n"</span>,Node-&gt;Security));
00758 <span class="preprocessor">#endif</span>
00759 <span class="preprocessor"></span>    }
00760 
00761     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Node-&gt;Security==HCELL_NIL);
00762 
00763     <span class="comment">//</span>
00764     <span class="comment">// This is a CreateKey, so the registry node has just been created and</span>
00765     <span class="comment">// the security descriptor we have been passed needs to be associated</span>
00766     <span class="comment">// with the new registry node and inserted into the hive.</span>
00767     <span class="comment">//</span>
00768     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_SEC) {
00769         <a class="code" href="../../d1/d2/cmp_8h.html#a66">CmpDumpSecurityDescriptor</a>(SecurityDescriptor, <span class="stringliteral">"ASSIGN DESCRIPTOR\n"</span>);
00770     }
00771 
00772     <span class="comment">//</span>
00773     <span class="comment">// Try to find an existing security descriptor that matches this one.</span>
00774     <span class="comment">// If successful, then we don't need to allocate a new cell, we can</span>
00775     <span class="comment">// just point to the existing one and increment its reference count.</span>
00776     <span class="comment">//</span>
00777     Type = <a class="code" href="../../d0/d1/hivedata_8h.html#a19">HvGetCellType</a>(Cell);
00778     <span class="keywordflow">if</span> (!<a class="code" href="../../d7/d2/cmse_8c.html#a5">CmpFindMatchingDescriptorCell</a>( Hive,
00779                                         Node,
00780                                         SecurityDescriptor,
00781                                         Type,
00782                                         &amp;SecurityCell )) {
00783         <span class="comment">//</span>
00784         <span class="comment">// No matching descriptor found, allocate and initialize a new one.</span>
00785         <span class="comment">//</span>
00786         SecurityCell = <a class="code" href="../../d8/d0/hivecell_8c.html#a16">HvAllocateCell</a>(Hive,
00787                                       <a class="code" href="../../d7/d2/cmse_8c.html#a0">SECURITY_CELL_LENGTH</a>(SecurityDescriptor),
00788                                       Type);
00789         <span class="keywordflow">if</span> (SecurityCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00790             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00791         }
00792 
00793         <span class="comment">//</span>
00794         <span class="comment">// Map the security cell</span>
00795         <span class="comment">//</span>
00796         Security = (<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a>) <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, SecurityCell);
00797 
00798         <span class="comment">//</span>
00799         <span class="comment">// Initialize the security cell</span>
00800         <span class="comment">//</span>
00801         DescriptorLength = <a class="code" href="../../d8/d6/sertl_8c.html#a56">RtlLengthSecurityDescriptor</a>(SecurityDescriptor);
00802 
00803         Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o0">Signature</a> = <a class="code" href="../../d9/d0/cmdata_8h.html#a39">CM_KEY_SECURITY_SIGNATURE</a>;
00804         Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o4">ReferenceCount</a> = 1;
00805         Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o5">DescriptorLength</a> = DescriptorLength;
00806         RtlMoveMemory( &amp;(Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o6">Descriptor</a>),
00807                        SecurityDescriptor,
00808                        DescriptorLength );
00809 
00810         <span class="comment">//</span>
00811         <span class="comment">// Insert the new security descriptor into the list of security</span>
00812         <span class="comment">// cells.</span>
00813         <span class="comment">//</span>
00814         <span class="keywordflow">if</span> (!<a class="code" href="../../d7/d2/cmse_8c.html#a6">CmpInsertSecurityCellList</a>(Hive,Cell,SecurityCell))
00815         {
00816             <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(Hive, SecurityCell);
00817             <span class="keywordflow">return</span> STATUS_NO_LOG_SPACE;
00818         }
00819 
00820     } <span class="keywordflow">else</span> {
00821 
00822         <span class="comment">//</span>
00823         <span class="comment">// Found identical descriptor already existing.  Map it in and</span>
00824         <span class="comment">// increment its reference count.</span>
00825         <span class="comment">//</span>
00826         <span class="keywordflow">if</span> (! <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(Hive, SecurityCell)) {
00827             <span class="keywordflow">return</span> STATUS_NO_LOG_SPACE;
00828         }
00829         Security = (<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a>) <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, SecurityCell);
00830         Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o4">ReferenceCount</a> += 1;
00831     }
00832 
00833     <span class="comment">//</span>
00834     <span class="comment">// Initialize the reference in the node cell</span>
00835     <span class="comment">//</span>
00836     Node-&gt;Security = SecurityCell;
00837 
00838     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_SEC) {
00839         KdPrint((<span class="stringliteral">"\tSecurityCell = %lx\n"</span>,Node-&gt;Security));
00840     }
00841 
00842     <span class="keywordflow">return</span>(STATUS_SUCCESS);
00843 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="cmse.c::CmpCheckCreateAccess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpCheckCreateAccess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>RelativeName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>Descriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessState</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PreviousMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>AdditionalAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PNTSTATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessStatus</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d1/cmse_8c-source.html#l00917">917</a> of file <a class="el" href="../../d8/d1/cmse_8c-source.html">cmse.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00248">CML_FLOW</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00400">CmpDumpSecurityDescriptor</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00289">CmpKeyObjectType</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00263">CMS_SEC</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00168">_OBJECT_TYPE_INITIALIZER::GenericMapping</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l03323">SeAccessCheck()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l03538">SeCreateObjectAuditAlarm()</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00115">SeLockSubjectContext()</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00159">SeUnlockSubjectContext()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d9/ob_8h-source.html#l00196">_OBJECT_TYPE::TypeInfo</a>.
<p>
Referenced by <a class="el" href="../../d4/d1/cmparse2_8c-source.html#l00033">CmpDoCreate()</a>.
<p>
<pre class="fragment"><div>00928                    :
00929 
00930     This routine checks to see <span class="keywordflow">if</span> we are allowed to create a sub-key in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00931     given key, and performs auditing as appropriate.
00932 
00933 Arguments:
00934 
00935     <a class="code" href="../../d2/d2/rtload_8c.html#a7">RelativeName</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> relative name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key being created.
00936 
00937     Descriptor - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key in which
00938         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> sub-key <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be created.
00939 
00940     CreateAccess - The access mask corresponding to create access <span class="keywordflow">for</span>
00941         <span class="keyword">this</span> directory <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>.
00942 
00943     AccessState - Checks <span class="keywordflow">for</span> traverse access will typically be incidental
00944         to some other access attempt.  Information on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current state of
00945         that access attempt <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> required so that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> constituent access
00946         attempts may be associated with each other in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> audit log.
00947 
00948     PreviousMode - The previous processor mode.
00949 
00950     AdditionalAccess - access rights in addition to KEY_CREATE_SUB_KEY
00951             that are required.  (e.g. KEY_CREATE_LINK)
00952 
00953     AccessStatus - Pointer to a variable to <span class="keywordflow">return</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status code of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00954         access attempt.  In <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">case</span> of <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a> <span class="keyword">this</span> status code must be
00955         propagated back to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user.
00956 
00957 Return Value:
00958 
00959     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> access <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allowed and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.  AccessStatus
00960     contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status code to be passed back to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not
00961     correct to simply pass back STATUS_ACCESS_DENIED, since <span class="keyword">this</span> will have
00962     to change with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> advent of mandatory access <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a>.
00963 
00964 --*/
00965 
00966 {
00967     BOOLEAN AccessAllowed;
00968     ACCESS_MASK GrantedAccess = 0;
00969     BOOLEAN AuditPerformed = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00970 
00971     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00972     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_SEC) {
00973         KdPrint((<span class="stringliteral">"CmpCheckCreateAccess:\n"</span>));
00974     }
00975 
00976     <a class="code" href="../../d0/d8/subject_8c.html#a1">SeLockSubjectContext</a>( &amp;AccessState-&gt;SubjectSecurityContext );
00977 
00978     AccessAllowed = <a class="code" href="../../d0/d4/accessck_8c.html#a18">SeAccessCheck</a>(
00979                         Descriptor,
00980                         &amp;AccessState-&gt;SubjectSecurityContext,
00981                         TRUE,                              <span class="comment">// Token is read locked</span>
00982                         (KEY_CREATE_SUB_KEY | AdditionalAccess),
00983                         0,
00984                         NULL,
00985                         &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a>,
00986                         PreviousMode,
00987                         &amp;GrantedAccess,
00988                         AccessStatus
00989                         );
00990 
00991     <span class="comment">//</span>
00992     <span class="comment">// if the security guys ever get around to implementing this,</span>
00993     <span class="comment">// put this call back in.</span>
00994     <span class="comment">//</span>
00995 <span class="preprocessor">#if 0</span>
00996 <span class="preprocessor"></span>    <span class="comment">//</span>
00997     <span class="comment">// WARNNOTE John Vert (jvert) 22-Jan-92</span>
00998     <span class="comment">//  We don't have a Directory Object handy, and the auditing currently</span>
00999     <span class="comment">//  ignores it anyway.</span>
01000     <span class="comment">//</span>
01001 
01002     <a class="code" href="../../d3/d5/seaudit_8c.html#a26">SeCreateObjectAuditAlarm</a>(
01003         &amp;AccessState-&gt;OperationID,
01004         NULL,                       <span class="comment">// &lt;- see WARNNOTE</span>
01005         NULL,                       <span class="comment">// Need component name</span>
01006         Descriptor,
01007         &amp;AccessState-&gt;SubjectSecurityContext,
01008         KEY_CREATE_SUB_KEY,
01009         AccessState-&gt;PrivilegesUsed,
01010         AccessAllowed,
01011         &amp;AuditPerformed,
01012         PreviousMode
01013         );
01014 <span class="preprocessor">#endif</span>
01015 <span class="preprocessor"></span>
01016     <a class="code" href="../../d0/d8/subject_8c.html#a2">SeUnlockSubjectContext</a>( &amp;AccessState-&gt;SubjectSecurityContext );
01017 
01018     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_SEC) {
01019         KdPrint((<span class="stringliteral">"Create access %s\n"</span>,AccessAllowed ? <span class="stringliteral">"granted"</span> : <span class="stringliteral">"denied"</span>));
01020 <span class="preprocessor">#if DBG</span>
01021 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (!AccessAllowed) {
01022             <a class="code" href="../../d1/d2/cmp_8h.html#a66">CmpDumpSecurityDescriptor</a>(Descriptor, <span class="stringliteral">"DENYING DESCRIPTOR"</span>);
01023         }
01024 <span class="preprocessor">#endif</span>
01025 <span class="preprocessor"></span>    }
01026 
01027     <span class="keywordflow">return</span>(AccessAllowed);
01028 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="cmse.c::CmpCheckNotifyAccess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpCheckNotifyAccess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html">PCM_NOTIFY_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>NotifyBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Node</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d1/cmse_8c-source.html#l01032">1032</a> of file <a class="el" href="../../d8/d1/cmse_8c-source.html">cmse.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00345">ASSERT_CM_LOCK_OWNED</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00248">CML_FLOW</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00400">CmpDumpSecurityDescriptor</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01165">CmpGetKeySecurity()</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00289">CmpKeyObjectType</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00263">CMS_SEC</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00526">_CM_KEY_SECURITY::Descriptor</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00168">_OBJECT_TYPE_INITIALIZER::GenericMapping</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l03323">SeAccessCheck()</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00115">SeLockSubjectContext()</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00159">SeUnlockSubjectContext()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00196">_OBJECT_TYPE::TypeInfo</a>, and <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00281">CmpNotifyTriggerCheck()</a>.
<p>
<pre class="fragment"><div>01039                    :
01040 
01041     Check whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subject process/thread/user specified by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01042     security data in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NotifyBlock has required access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01043     key specified by <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>.Cell.
01044 
01045 Arguments:
01046 
01047     NotifyBlock - pointer to structure that describes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify
01048                   operation, including <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> identity of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subject
01049                   that opened <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify.
01050 
01051     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - Supplies pointer to hive containing Node.
01052 
01053     Node - Supplies pointer to key of interest.
01054 
01055 Return Value:
01056 
01057     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> RequiredAccess <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> in fact possessed by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subject,
01058     <span class="keywordflow">else</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>.
01059 
01060 --*/
01061 {
01062     <a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a> Security;
01063     PSECURITY_DESCRIPTOR SecurityDescriptor;
01064     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01065     BOOLEAN AccessAllowed;
01066     ACCESS_MASK GrantedAccess = 0;
01067 
01068     <a class="code" href="../../d1/d2/cmp_8h.html#a61">ASSERT_CM_LOCK_OWNED</a>();
01069     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01070 
01071 
01072     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_SEC) {
01073         KdPrint((<span class="stringliteral">"CmpCheckAccessForNotify:\n"</span>));
01074     }
01075     Security = <a class="code" href="../../d7/d2/cmse_8c.html#a3">CmpGetKeySecurity</a>(Hive,
01076                                  Node,
01077                                  NULL);
01078 
01079     <a class="code" href="../../d0/d8/subject_8c.html#a1">SeLockSubjectContext</a>( &amp;NotifyBlock-&gt;SubjectContext );
01080 
01081     SecurityDescriptor = &amp;Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o6">Descriptor</a>;
01082     AccessAllowed = <a class="code" href="../../d0/d4/accessck_8c.html#a18">SeAccessCheck</a>( SecurityDescriptor,
01083                                    &amp;NotifyBlock-&gt;SubjectContext,
01084                                    TRUE,
01085                                    KEY_NOTIFY,
01086                                    0,
01087                                    NULL,
01088                                    &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a>,
01089                                    UserMode,
01090                                    &amp;GrantedAccess,
01091                                    &amp;Status );
01092 
01093     <a class="code" href="../../d0/d8/subject_8c.html#a2">SeUnlockSubjectContext</a>( &amp;NotifyBlock-&gt;SubjectContext );
01094 
01095     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_SEC) {
01096         KdPrint((<span class="stringliteral">"Notify access %s\n"</span>,AccessAllowed ? <span class="stringliteral">"granted"</span> : <span class="stringliteral">"denied"</span>));
01097 <span class="preprocessor">#if DBG</span>
01098 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (!AccessAllowed) {
01099             <a class="code" href="../../d1/d2/cmp_8h.html#a66">CmpDumpSecurityDescriptor</a>(SecurityDescriptor, <span class="stringliteral">"DENYING DESCRIPTOR"</span>);
01100         }
01101 <span class="preprocessor">#endif</span>
01102 <span class="preprocessor"></span>    }
01103 
01104     <span class="keywordflow">return</span> AccessAllowed;
01105 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="cmse.c::CmpFindMatchingDescriptorCell" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpFindMatchingDescriptorCell           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Node</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Type</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>MatchingCell</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d1/cmse_8c-source.html#l01545">1545</a> of file <a class="el" href="../../d8/d1/cmse_8c-source.html">cmse.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00248">CML_FLOW</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00771">CmpFindSubKeyByNumber()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01165">CmpGetKeySecurity()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00263">CMS_SEC</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00526">_CM_KEY_SECURITY::Descriptor</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00525">_CM_KEY_SECURITY::DescriptorLength</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00135">HvGetCellType</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00434">KEY_HIVE_ENTRY</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l02165">RtlLengthSecurityDescriptor()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d1/cmse_8c-source.html#l00697">CmpAssignSecurityDescriptor()</a>, and <a class="el" href="../../d8/d1/cmse_8c-source.html#l00397">CmpSetSecurityDescriptorInfo()</a>.
<p>
<pre class="fragment"><div>01555                    :
01556 
01557     This routine attempts to find a security descriptor in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive that
01558     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> identical to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> one passed in.  If <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> finds one, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> returns its
01559     cell index.
01560 
01561     Currently, <span class="keyword">this</span> routine checks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptors of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parent
01562     and siblings of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> node to find a match.
01563 
01564 Arguments:
01565 
01566     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> node.
01567 
01568     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cell index of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> node
01569 
01570     SecurityDescriptor - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cooked security descriptor which
01571            should be searched <span class="keywordflow">for</span>.
01572 
01573     Type - Indicates whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Security Descriptor that matches must
01574             be in <a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a> or <a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a> store
01575 
01576     MatchingCell - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cell index of a security cell whose
01577            security descriptor <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> identical to SecurityDescriptor.
01578            Valid <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> <span class="keywordflow">if</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
01579 
01580 Return Value:
01581 
01582     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - Matching security descriptor found.  MatchingCell returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01583            cell index of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a7">matching</a> security descriptor.
01584 
01585     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - No <a class="code" href="../../d7/d1/genuedef_8c.html#a7">matching</a> security descriptor found.  MatchingCell <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invalid.
01586 
01587 --*/
01588 
01589 {
01590     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> ChildCheckNode;
01591     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> SiblingNode;
01592     <a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a> Security;
01593     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> ParentNode;
01594     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> SiblingCell;
01595     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01596     ULONG DescriptorLength;
01597     ULONG index;
01598 
01599     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01600         
01601     DescriptorLength = <a class="code" href="../../d8/d6/sertl_8c.html#a56">RtlLengthSecurityDescriptor</a>(SecurityDescriptor);
01602     
01603         <span class="comment">//</span>
01604     <span class="comment">// Check to see if it's a root node or not.</span>
01605     <span class="comment">//</span>
01606     <span class="keywordflow">if</span> (Node-&gt;Flags &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a29">KEY_HIVE_ENTRY</a>) {
01607 
01608         <span class="comment">//</span>
01609         <span class="comment">// Never share security descriptors across hive boundaries.</span>
01610         <span class="comment">// Go directly to the child key check.</span>
01611         <span class="comment">//</span>
01612         ChildCheckNode = Node;
01613         <span class="keywordflow">goto</span> RetryMyChildren;
01614     }
01615 
01616     ParentNode = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive,Node-&gt;Parent);
01617 
01618     Security = <a class="code" href="../../d7/d2/cmse_8c.html#a3">CmpGetKeySecurity</a>(Hive,
01619                                  ParentNode,
01620                                  MatchingCell);
01621 
01622     <span class="keywordflow">if</span> ((DescriptorLength==Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o5">DescriptorLength</a>) &amp;&amp;
01623         (Type == <a class="code" href="../../d0/d1/hivedata_8h.html#a19">HvGetCellType</a>(*MatchingCell))          &amp;&amp;
01624         (RtlEqualMemory(SecurityDescriptor,
01625                         &amp;(Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o6">Descriptor</a>),
01626                         DescriptorLength))) {
01627         <span class="comment">//</span>
01628         <span class="comment">// We have found a match.</span>
01629         <span class="comment">//</span>
01630         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_SEC) {
01631             KdPrint((<span class="stringliteral">"CmpFindMatchingDescriptor: Cell's descriptor matched parent\n"</span>));
01632         }
01633         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01634     }
01635 
01636     <span class="comment">//</span>
01637     <span class="comment">// Parent didn't match.  Go check all the siblings.</span>
01638     <span class="comment">//</span>
01639     ChildCheckNode = ParentNode;
01640 
01641     <span class="comment">//</span>
01642     <span class="comment">// Below loop gets executed twice. The first time we check the siblings of</span>
01643     <span class="comment">// the target node's parents. The second time, we check the target node's</span>
01644     <span class="comment">// own children.</span>
01645     <span class="comment">//</span>
01646 RetryMyChildren:
01647     index=0;
01648     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01649         SiblingCell = <a class="code" href="../../d1/d2/cmp_8h.html#a304">CmpFindSubKeyByNumber</a>(Hive,ChildCheckNode,index++);
01650         <span class="keywordflow">if</span> (SiblingCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01651             <span class="comment">//</span>
01652             <span class="comment">// out of siblings</span>
01653             <span class="comment">//</span>
01654             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01655         }
01656         SiblingNode = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive,SiblingCell);
01657 
01658         <span class="keywordflow">if</span> (SiblingNode != Node) {
01659 
01660             <span class="comment">//</span>
01661             <span class="comment">// We have a sibling, so get its security descriptor</span>
01662             <span class="comment">//</span>
01663             Security = <a class="code" href="../../d7/d2/cmse_8c.html#a3">CmpGetKeySecurity</a>(Hive,
01664                                          SiblingNode,
01665                                          MatchingCell);
01666 
01667             <span class="comment">//</span>
01668             <span class="comment">// Compare its security descriptor to ours</span>
01669             <span class="comment">//</span>
01670 
01671             <span class="keywordflow">if</span> ((DescriptorLength==Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o5">DescriptorLength</a>) &amp;&amp;
01672                 (Type == <a class="code" href="../../d0/d1/hivedata_8h.html#a19">HvGetCellType</a>(*MatchingCell))          &amp;&amp;
01673                 (RtlEqualMemory(SecurityDescriptor,
01674                                 &amp;(Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o6">Descriptor</a>),
01675                                 DescriptorLength))) {
01676                 <span class="comment">//</span>
01677                 <span class="comment">// We have found a match.</span>
01678                 <span class="comment">//</span>
01679                 <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_SEC) {
01680                     KdPrint((<span class="stringliteral">"CmpFindMatchingDescriptor: Cell's descriptor "</span>));
01681                     KdPrint((<span class="stringliteral">"matched sibling %d\n"</span>,index));
01682                 }
01683                 <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01684             }
01685         }
01686     }
01687 
01688     <span class="keywordflow">if</span> (ChildCheckNode == ParentNode) {
01689         <span class="comment">//</span>
01690         <span class="comment">// Do the second iteration.</span>
01691         <span class="comment">//</span>
01692         ChildCheckNode = Node;
01693         <span class="keywordflow">goto</span> RetryMyChildren;
01694     }
01695 
01696     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_SEC) {
01697         KdPrint((<span class="stringliteral">"CmpFindMatchingDescriptor: no matching descriptor found\n"</span>));
01698     }
01699     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01700 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="cmse.c::CmpFreeSecurityDescriptor" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpFreeSecurityDescriptor           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Cell</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d1/cmse_8c-source.html#l01464">1464</a> of file <a class="el" href="../../d8/d1/cmse_8c-source.html">cmse.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00531">ASSERT_NODE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00532">ASSERT_SECURITY</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00248">CML_FLOW</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01823">CmpRemoveSecurityCellList()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00263">CMS_SEC</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00688">HvFreeCell()</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00537">_CELL_DATA::_u::KeyNode</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00539">_CELL_DATA::_u::KeySecurity</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00524">_CM_KEY_SECURITY::ReferenceCount</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00463">_CM_KEY_NODE::Security</a>, and <a class="el" href="../../d4/d9/struct__CELL__DATA.html#o0">_CELL_DATA::u</a>.
<p>
<pre class="fragment"><div>01471                    :
01472 
01473     Frees <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor associated with a particular node.  This
01474     can <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> happen when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> node <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> actually being deleted from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01475     registry.
01476 
01477     NOTE:   Caller <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> expected to have already marked relevent cells dirty.
01478 
01479 Arguments:
01480 
01481     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - Supplies thepointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> hive of interest
01482 
01483     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> - Supplies index <span class="keywordflow">for</span> cell to free storage <span class="keywordflow">for</span> (<a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target)
01484 
01485 Return Value:
01486 
01487     None.
01488 
01489 --*/
01490 
01491 {
01492     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> Node;
01493     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> Security;
01494     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> SecurityCell;
01495 
01496     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01497     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_SEC) {
01498         KdPrint((<span class="stringliteral">"CmpFreeSecurityDescriptor for cell %ld\n"</span>,Cell));
01499     }
01500 
01501     <span class="comment">//</span>
01502     <span class="comment">// Map in the cell whose security descriptor is being freed</span>
01503     <span class="comment">//</span>
01504     Node = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, Cell);
01505     <a class="code" href="../../d1/d2/cmp_8h.html#a84">ASSERT_NODE</a>(&amp;(Node-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>));
01506 
01507     <span class="comment">//</span>
01508     <span class="comment">// Map in the cell containing the security descriptor.</span>
01509     <span class="comment">//</span>
01510     SecurityCell = Node-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o9">Security</a>;
01511     Security = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, SecurityCell);
01512     <a class="code" href="../../d1/d2/cmp_8h.html#a85">ASSERT_SECURITY</a>(&amp;(Security-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o2">KeySecurity</a>));
01513 
01514 
01515     <span class="keywordflow">if</span> (Security-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o2">KeySecurity</a>.<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o4">ReferenceCount</a> == 1) {
01516 
01517         <span class="comment">//</span>
01518         <span class="comment">// This is the only cell that references this security descriptor,</span>
01519         <span class="comment">// so it is ok to free it now.</span>
01520         <span class="comment">//</span>
01521         <a class="code" href="../../d7/d2/cmse_8c.html#a7">CmpRemoveSecurityCellList</a>(Hive, SecurityCell);
01522         <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(Hive, SecurityCell);
01523         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_SEC) {
01524             KdPrint((<span class="stringliteral">"CmpFreeSecurityDescriptor: freeing security cell\n"</span>));
01525         }
01526     } <span class="keywordflow">else</span> {
01527 
01528         <span class="comment">//</span>
01529         <span class="comment">// More than one node references this security descriptor, so</span>
01530         <span class="comment">// just decrement the reference count.</span>
01531         <span class="comment">//</span>
01532         Security-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o2">KeySecurity</a>.<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o4">ReferenceCount</a> -= 1;
01533         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_SEC) {
01534             KdPrint((<span class="stringliteral">"CmpFreeSecurityDescriptor: decrementing reference count\n"</span>));
01535         }
01536     }
01537 
01538     <span class="comment">//</span>
01539     <span class="comment">// Zero out the pointer to the security descriptdr in the main cell</span>
01540     <span class="comment">//</span>
01541     Node-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o9">Security</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01542 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="cmse.c::CmpGetKeySecurity" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a> CmpGetKeySecurity           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Key</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> SecurityCell&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d1/cmse_8c-source.html#l01165">1165</a> of file <a class="el" href="../../d8/d1/cmse_8c-source.html">cmse.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00531">ASSERT_NODE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00532">ASSERT_SECURITY</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00422">CM_KEY_NODE_SIGNATURE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00248">CML_FLOW</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00263">CMS_SEC</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d3/d9/nt6_2user32_8def-source.html#l00417">Key</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00154">Name</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d8/d1/cmse_8c-source.html#l01032">CmpCheckNotifyAccess()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01545">CmpFindMatchingDescriptorCell()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01109">CmpGetObjectSecurity()</a>, and <a class="el" href="../../d8/d1/cmse_8c-source.html#l00397">CmpSetSecurityDescriptorInfo()</a>.
<p>
<pre class="fragment"><div>01173                    :
01174 
01175     This routine returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security of a registry key.
01176 
01177 Arguments:
01178 
01179     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object's cell <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> in.
01180 
01181     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key node.
01182 
01183     SecurityCell - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> index of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security cell
01184 
01185 Return Value:
01186 
01187     Returns a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security cell of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object
01188 
01189 --*/
01190 
01191 {
01192     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> CellIndex;
01193     <a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a> Security;
01194 
01195     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01196 
01197     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>-&gt;Signature == CM_KEY_NODE_SIGNATURE);
01198     <a class="code" href="../../d1/d2/cmp_8h.html#a84">ASSERT_NODE</a>(Key);
01199 
01200     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_SEC) {
01201 <span class="preprocessor">#if DBG</span>
01202 <span class="preprocessor"></span>        UNICODE_STRING <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>;
01203 
01204         <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.MaximumLength = <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Length = <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>-&gt;NameLength;
01205         <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Buffer = <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>-&gt;Name;
01206         KdPrint((<span class="stringliteral">"CmpGetObjectSecurity for: "</span>));
01207         KdPrint((<span class="stringliteral">"%wZ\n"</span>, &amp;Name));
01208 <span class="preprocessor">#endif</span>
01209 <span class="preprocessor"></span>    }
01210 
01211     CellIndex = <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>-&gt;Security;
01212 
01213     <span class="comment">//</span>
01214     <span class="comment">// Map in the security descriptor cell</span>
01215     <span class="comment">//</span>
01216     Security = (<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a>) <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, CellIndex);
01217     <a class="code" href="../../d1/d2/cmp_8h.html#a85">ASSERT_SECURITY</a>(Security);
01218 
01219     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(SecurityCell)) {
01220         *SecurityCell = CellIndex;
01221     }
01222 
01223     <span class="keywordflow">return</span>(Security);
01224 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="cmse.c::CmpGetObjectSecurity" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpGetObjectSecurity           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Cell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>Security</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> SecurityCell&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d1/cmse_8c-source.html#l01109">1109</a> of file <a class="el" href="../../d8/d1/cmse_8c-source.html">cmse.c</a>.
<p>
References <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00248">CML_FLOW</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01165">CmpGetKeySecurity()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00263">CMS_SEC</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00477">_CM_KEY_NODE::Name</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00154">Name</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00475">_CM_KEY_NODE::NameLength</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00463">_CM_KEY_NODE::Security</a>.
<p>
Referenced by <a class="el" href="../../d0/d4/edithive_8c-source.html#l00854">EhGetKeySecurity()</a>.
<p>
<pre class="fragment"><div>01118                    :
01119 
01120     This routine maps in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security cell of a registry object.
01121 
01122 Arguments:
01123 
01124     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cell index of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.
01125 
01126     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object's cell <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> in.
01127 
01128     Security - Returns a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security cell of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.
01129 
01130     SecurityCell - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> index of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security cell
01131 
01132 Return Value:
01133 
01134     NONE.
01135 
01136 --*/
01137 
01138 {
01139     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> CellIndex;
01140     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Node;
01141 
01142     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01143     <span class="comment">//</span>
01144     <span class="comment">// Map the node we need to get the security descriptor for</span>
01145     <span class="comment">//</span>
01146     Node = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>) <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, Cell);
01147 
01148     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_SEC) {
01149 <span class="preprocessor">#if DBG</span>
01150 <span class="preprocessor"></span>        UNICODE_STRING <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>;
01151 
01152         <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.MaximumLength = <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Length = Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>;
01153         <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Buffer = Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>;
01154         KdPrint((<span class="stringliteral">"CmpGetObjectSecurity for: "</span>));
01155         KdPrint((<span class="stringliteral">"%wZ\n"</span>, &amp;Name));
01156 <span class="preprocessor">#endif</span>
01157 <span class="preprocessor"></span>    }
01158 
01159     *Security = <a class="code" href="../../d7/d2/cmse_8c.html#a3">CmpGetKeySecurity</a>(Hive,Node,SecurityCell);
01160 
01161     <span class="keywordflow">return</span>;
01162 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="cmse.c::CmpHiveRootSecurityDescriptor" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PSECURITY_DESCRIPTOR CmpHiveRootSecurityDescriptor           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d1/cmse_8c-source.html#l01227">1227</a> of file <a class="el" href="../../d8/d1/cmse_8c-source.html">cmse.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00263">CMS_SEC</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l01607">RtlAddAccessAllowedAce()</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l00099">RtlCreateAcl()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01945">RtlCreateSecurityDescriptor()</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l00996">RtlGetAce()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01166">RtlInitializeSid()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01030">RtlLengthRequiredSid()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l02543">RtlSetDaclSecurityDescriptor()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01286">RtlSubAuthoritySid()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00810">RtlValidSid()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00540">SeLengthSid</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d0/rtdmpsec_8c-source.html#l00109">WorldSid</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00293">CmInitSystem1()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01165">CmpCreateRegistryRoot()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00726">CmpInitializeHiveList()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02022">CmpInitializeSystemHive()</a>, and <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01545">CmpSetVersionData()</a>.
<p>
<pre class="fragment"><div>01232                    :
01233 
01234     This routine allocates and initializes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">default</span> security descriptor
01235     <span class="keywordflow">for</span> a system-created registry key.
01236 
01237     The caller <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> responsible <span class="keywordflow">for</span> freeing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocated security descriptor
01238     when he <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> done with <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
01239 
01240 Arguments:
01241 
01242     None
01243 
01244 Return Value:
01245 
01246     Pointer to an initialized security descriptor <span class="keywordflow">if</span> successful.
01247 
01248     Bugcheck otherwise.
01249 
01250 --*/
01251 
01252 {
01253     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01254     PSECURITY_DESCRIPTOR SecurityDescriptor=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01255     PACL Acl=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01256     PACL AclCopy;
01257     PSID <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a8">WorldSid</a>=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01258     PSID RestrictedSid=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01259     PSID SystemSid=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01260     PSID AdminSid=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01261     SID_IDENTIFIER_AUTHORITY WorldAuthority = SECURITY_WORLD_SID_AUTHORITY;
01262     SID_IDENTIFIER_AUTHORITY NtAuthority = SECURITY_NT_AUTHORITY;
01263     ULONG AceLength;
01264     ULONG AclLength;
01265     PACE_HEADER AceHeader;
01266 
01267     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01268 
01269     <span class="comment">//</span>
01270     <span class="comment">// Allocate and initialize the SIDs we will need.</span>
01271     <span class="comment">//</span>
01272     <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a8">WorldSid</a>  = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, <a class="code" href="../../d8/d6/sertl_8c.html#a38">RtlLengthRequiredSid</a>(1));
01273     RestrictedSid  = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, <a class="code" href="../../d8/d6/sertl_8c.html#a38">RtlLengthRequiredSid</a>(1));
01274     SystemSid = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, <a class="code" href="../../d8/d6/sertl_8c.html#a38">RtlLengthRequiredSid</a>(1));
01275     AdminSid  = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, <a class="code" href="../../d8/d6/sertl_8c.html#a38">RtlLengthRequiredSid</a>(2));
01276     <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d1/rtdmpsec_8c.html#a8">WorldSid</a>  == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
01277         (RestrictedSid == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
01278         (SystemSid == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
01279         (AdminSid  == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01280 
01281         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(REGISTRY_ERROR, 10, 0, 0, 0);
01282     }
01283 
01284     <span class="keywordflow">if</span> ((!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d8/d6/sertl_8c.html#a40">RtlInitializeSid</a>(WorldSid, &amp;WorldAuthority, 1))) ||
01285         (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d8/d6/sertl_8c.html#a40">RtlInitializeSid</a>(RestrictedSid, &amp;NtAuthority, 1))) ||
01286         (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d8/d6/sertl_8c.html#a40">RtlInitializeSid</a>(SystemSid, &amp;NtAuthority, 1))) ||
01287         (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d8/d6/sertl_8c.html#a40">RtlInitializeSid</a>(AdminSid, &amp;NtAuthority, 2)))) {
01288         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(REGISTRY_ERROR, 10, 1, 0, 0);
01289     }
01290 
01291     *(<a class="code" href="../../d8/d6/sertl_8c.html#a43">RtlSubAuthoritySid</a>(WorldSid, 0)) = SECURITY_WORLD_RID;
01292 
01293     *(<a class="code" href="../../d8/d6/sertl_8c.html#a43">RtlSubAuthoritySid</a>(RestrictedSid, 0)) = SECURITY_RESTRICTED_CODE_RID;
01294 
01295     *(<a class="code" href="../../d8/d6/sertl_8c.html#a43">RtlSubAuthoritySid</a>(SystemSid, 0)) = SECURITY_LOCAL_SYSTEM_RID;
01296 
01297     *(<a class="code" href="../../d8/d6/sertl_8c.html#a43">RtlSubAuthoritySid</a>(AdminSid, 0)) = SECURITY_BUILTIN_DOMAIN_RID;
01298     *(<a class="code" href="../../d8/d6/sertl_8c.html#a43">RtlSubAuthoritySid</a>(AdminSid, 1)) = DOMAIN_ALIAS_RID_ADMINS;
01299 
01300     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d8/d6/sertl_8c.html#a35">RtlValidSid</a>(WorldSid));
01301     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d8/d6/sertl_8c.html#a35">RtlValidSid</a>(RestrictedSid));
01302     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d8/d6/sertl_8c.html#a35">RtlValidSid</a>(SystemSid));
01303     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d8/d6/sertl_8c.html#a35">RtlValidSid</a>(AdminSid));
01304 
01305     <span class="comment">//</span>
01306     <span class="comment">// Compute the size of the ACE list</span>
01307     <span class="comment">//</span>
01308 
01309     AceLength = (<a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(WorldSid)  -
01310                  <span class="keyword">sizeof</span>(ULONG)          +
01311                  <span class="keyword">sizeof</span>(ACCESS_ALLOWED_ACE))
01312               + (<a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(RestrictedSid)  -
01313                  <span class="keyword">sizeof</span>(ULONG)          +
01314                  <span class="keyword">sizeof</span>(ACCESS_ALLOWED_ACE))
01315               + (<a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(SystemSid) -
01316                  <span class="keyword">sizeof</span>(ULONG)          +
01317                  <span class="keyword">sizeof</span>(ACCESS_ALLOWED_ACE))
01318               + (<a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(AdminSid)  -
01319                  <span class="keyword">sizeof</span>(ULONG)          +
01320                  <span class="keyword">sizeof</span>(ACCESS_ALLOWED_ACE));
01321 
01322     <span class="comment">//</span>
01323     <span class="comment">// Allocate and initialize the ACL</span>
01324     <span class="comment">//</span>
01325 
01326     AclLength = AceLength + <span class="keyword">sizeof</span>(ACL);
01327     Acl = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, AclLength);
01328     <span class="keywordflow">if</span> (Acl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01329         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_SEC) {
01330             KdPrint((<span class="stringliteral">"CmpHiveRootSecurityDescriptor: couldn't allocate ACL\n"</span>));
01331         }
01332 
01333         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(REGISTRY_ERROR, 10, 2, 0, 0);
01334     }
01335 
01336     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a6">RtlCreateAcl</a>(Acl, AclLength, ACL_REVISION);
01337     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01338         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_SEC) {
01339             KdPrint((<span class="stringliteral">"CmpHiveRootSecurityDescriptor: couldn't initialize ACL\n"</span>));
01340         }
01341         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(REGISTRY_ERROR, 10, 3, 0, 0);
01342     }
01343 
01344     <span class="comment">//</span>
01345     <span class="comment">// Now add the ACEs to the ACL</span>
01346     <span class="comment">//</span>
01347     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a16">RtlAddAccessAllowedAce</a>(Acl,
01348                                     ACL_REVISION,
01349                                     KEY_ALL_ACCESS,
01350                                     SystemSid);
01351     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01352         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a16">RtlAddAccessAllowedAce</a>(Acl,
01353                                         ACL_REVISION,
01354                                         KEY_ALL_ACCESS,
01355                                         AdminSid);
01356     }
01357     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01358         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a16">RtlAddAccessAllowedAce</a>(Acl,
01359                                         ACL_REVISION,
01360                                         KEY_READ,
01361                                         WorldSid);
01362     }
01363     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01364         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a16">RtlAddAccessAllowedAce</a>(Acl,
01365                                         ACL_REVISION,
01366                                         KEY_READ,
01367                                         RestrictedSid);
01368     }
01369     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01370         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_SEC) {
01371             KdPrint((<span class="stringliteral">"CmpHiveRootSecurityDescriptor: RtlAddAce failed status %08lx\n"</span>, Status));
01372         }
01373 
01374         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(REGISTRY_ERROR, 10, 4, 0, 0);
01375     }
01376 
01377     <span class="comment">//</span>
01378     <span class="comment">// Make the ACEs inheritable</span>
01379     <span class="comment">//</span>
01380     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a12">RtlGetAce</a>(Acl,0,&amp;AceHeader);
01381     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
01382     AceHeader-&gt;AceFlags |= CONTAINER_INHERIT_ACE;
01383 
01384     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a12">RtlGetAce</a>(Acl,1,&amp;AceHeader);
01385     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
01386     AceHeader-&gt;AceFlags |= CONTAINER_INHERIT_ACE;
01387 
01388     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a12">RtlGetAce</a>(Acl,2,&amp;AceHeader);
01389     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
01390     AceHeader-&gt;AceFlags |= CONTAINER_INHERIT_ACE;
01391 
01392     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a12">RtlGetAce</a>(Acl,3,&amp;AceHeader);
01393     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
01394     AceHeader-&gt;AceFlags |= CONTAINER_INHERIT_ACE;
01395     <span class="comment">//</span>
01396     <span class="comment">// We are finally ready to allocate and initialize the security descriptor</span>
01397     <span class="comment">// Allocate enough space to hold both the security descriptor and the</span>
01398     <span class="comment">// ACL.  This allows us to free the whole thing at once when we are</span>
01399     <span class="comment">// done with it.</span>
01400     <span class="comment">//</span>
01401 
01402     SecurityDescriptor = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(
01403                             PagedPool,
01404                             <span class="keyword">sizeof</span>(SECURITY_DESCRIPTOR) + AclLength
01405                             );
01406 
01407     <span class="keywordflow">if</span> (SecurityDescriptor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01408         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_SEC) {
01409             KdPrint((<span class="stringliteral">"CmpHiveRootSecurityDescriptor: Couldn't allocate Sec. Desc.\n"</span>));
01410         }
01411         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(REGISTRY_ERROR, 10, 5, 0, 0);
01412     }
01413 
01414     AclCopy = (PACL)((PISECURITY_DESCRIPTOR)SecurityDescriptor+1);
01415     RtlMoveMemory(AclCopy, Acl, AclLength);
01416 
01417     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a53">RtlCreateSecurityDescriptor</a>( SecurityDescriptor,
01418                                           SECURITY_DESCRIPTOR_REVISION );
01419     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01420         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_SEC) {
01421             KdPrint((<span class="stringliteral">"CmpHiveRootSecurityDescriptor: CreateSecDesc failed %08lx\n"</span>,Status));
01422         }
01423         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(SecurityDescriptor);
01424         SecurityDescriptor=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01425         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(REGISTRY_ERROR, 10, 6, 0, 0);
01426     }
01427 
01428     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a60">RtlSetDaclSecurityDescriptor</a>( SecurityDescriptor,
01429                                            TRUE,
01430                                            AclCopy,
01431                                            FALSE );
01432     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01433         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_SEC) {
01434             KdPrint((<span class="stringliteral">"CmpHiveRootSecurityDescriptor: SetDacl failed %08lx\n"</span>,Status));
01435         }
01436         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(SecurityDescriptor);
01437         SecurityDescriptor=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01438         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(REGISTRY_ERROR, 10, 7, 0, 0);
01439     }
01440 
01441     <span class="comment">//</span>
01442     <span class="comment">// free any allocations we made</span>
01443     <span class="comment">//</span>
01444     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/rtdmpsec_8c.html#a8">WorldSid</a>!=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01445         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(WorldSid);
01446     }
01447     <span class="keywordflow">if</span> (RestrictedSid!=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01448         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(RestrictedSid);
01449     }
01450     <span class="keywordflow">if</span> (SystemSid!=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01451         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(SystemSid);
01452     }
01453     <span class="keywordflow">if</span> (AdminSid!=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01454         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(AdminSid);
01455     }
01456     <span class="keywordflow">if</span> (Acl!=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01457         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Acl);
01458     }
01459 
01460     <span class="keywordflow">return</span>(SecurityDescriptor);
01461 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="cmse.c::CmpInsertSecurityCellList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpInsertSecurityCellList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>NodeCell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityCell</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d1/cmse_8c-source.html#l01704">1704</a> of file <a class="el" href="../../d8/d1/cmse_8c-source.html">cmse.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00531">ASSERT_NODE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00532">ASSERT_SECURITY</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00523">_CM_KEY_SECURITY::Blink</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00248">CML_FLOW</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00263">CMS_SEC</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00450">_CM_KEY_NODE::Flags</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00522">_CM_KEY_SECURITY::Flink</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00135">HvGetCellType</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00117">HvMarkCellDirty()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00434">KEY_HIVE_ENTRY</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00453">_CM_KEY_NODE::Parent</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00463">_CM_KEY_NODE::Security</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>.
<p>
Referenced by <a class="el" href="../../d8/d1/cmse_8c-source.html#l00697">CmpAssignSecurityDescriptor()</a>.
<p>
<pre class="fragment"><div>01711                    :
01712 
01713     Inserts a newly-created security cell into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> per-hive linked list of
01714     security cells.
01715 
01716     NOTE:   Assumes that NodeCell and SecurityCell have already been
01717             marked dirty.
01718 
01719 Arguments:
01720 
01721     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure.
01722 
01723     NodeCell - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cell index of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> node that owns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security cell
01724 
01725     SecurityCell - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cell index of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security cell.
01726 
01727 Return Value:
01728 
01729     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> worked
01730 
01731     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - some <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a> - generally STATUS_NO_LOG_SPACE
01732 
01733 --*/
01734 
01735 {
01736     <a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a> FlinkCell;
01737     <a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a> BlinkCell;
01738     <a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>;
01739     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Node;
01740     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> ParentNode;
01741 
01742     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01743     <span class="comment">//</span>
01744     <span class="comment">// If the new cell's storage type is Volatile, simply make it the</span>
01745     <span class="comment">//  anchor of it's own list.  (Volatile security entries will disappear</span>
01746     <span class="comment">//  at reboot, restore, etc, so we don't need the list to hunt them</span>
01747     <span class="comment">//  down at those times.)</span>
01748     <span class="comment">//</span>
01749     <span class="comment">// Else, the storage type is Stable.</span>
01750     <span class="comment">//   Map in the node that owns the new security cell.  If it is a root</span>
01751     <span class="comment">//   cell, then we are creating the hive for the first time, so this is</span>
01752     <span class="comment">//   the only security cell in the list.  If it is not a root cell, then</span>
01753     <span class="comment">//   we simply find its parent's security cell and stick the new security</span>
01754     <span class="comment">//   cell into the list immediately after it.</span>
01755     <span class="comment">//</span>
01756     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> = (<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a>) <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, SecurityCell);
01757     <a class="code" href="../../d1/d2/cmp_8h.html#a85">ASSERT_SECURITY</a>(Cell);
01758 
01759     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d1/hivedata_8h.html#a19">HvGetCellType</a>(SecurityCell) == <a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>) {
01760 
01761         <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>-&gt;Flink = <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>-&gt;Blink = SecurityCell;
01762 
01763     } <span class="keywordflow">else</span> {
01764 
01765         Node = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>) <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, NodeCell);
01766         <a class="code" href="../../d1/d2/cmp_8h.html#a84">ASSERT_NODE</a>(Node);
01767 
01768         <span class="keywordflow">if</span> (Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a29">KEY_HIVE_ENTRY</a>) {
01769             <span class="comment">//</span>
01770             <span class="comment">// This must be the hive creation, so this cell becomes the anchor</span>
01771             <span class="comment">// for the list.</span>
01772             <span class="comment">//</span>
01773             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_SEC) {
01774                 KdPrint((<span class="stringliteral">"CmpInsertSecurityCellList: hive creation\n"</span>));
01775             }
01776             <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>-&gt;Flink = <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>-&gt;Blink = SecurityCell;
01777 
01778         } <span class="keywordflow">else</span> {
01779             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_SEC) {
01780                 KdPrint((<span class="stringliteral">"CmpInsertSecurityCellList: insert at parent\n"</span>));
01781             }
01782             <span class="comment">//</span>
01783             <span class="comment">// Map in the node's parent's security cell, so we can hook into</span>
01784             <span class="comment">// the list there.</span>
01785             <span class="comment">//</span>
01786             ParentNode = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>) <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o4">Parent</a>);
01787             <a class="code" href="../../d1/d2/cmp_8h.html#a84">ASSERT_NODE</a>(ParentNode);
01788             BlinkCell = (<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a>) <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(
01789                                             Hive,
01790                                             ParentNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o9">Security</a>
01791                                             );
01792             <a class="code" href="../../d1/d2/cmp_8h.html#a85">ASSERT_SECURITY</a>(BlinkCell);
01793 
01794             <span class="comment">//</span>
01795             <span class="comment">// Map in the Flink of the parent's security cell.</span>
01796             <span class="comment">//</span>
01797             FlinkCell = (<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a>) <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(
01798                                             Hive,
01799                                             BlinkCell-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o2">Flink</a>
01800                                             );
01801             <a class="code" href="../../d1/d2/cmp_8h.html#a85">ASSERT_SECURITY</a>(FlinkCell);
01802 
01803             <span class="keywordflow">if</span> (! (<a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(Hive, ParentNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o9">Security</a>) &amp;&amp;
01804                    <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(Hive, BlinkCell-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o2">Flink</a>)))
01805             {
01806                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01807             }
01808 
01809             <span class="comment">//</span>
01810             <span class="comment">// Insert the new security cell in between the Flink and Blink cells</span>
01811             <span class="comment">//</span>
01812             <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>-&gt;Flink = BlinkCell-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o2">Flink</a>;
01813             <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>-&gt;Blink = FlinkCell-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o3">Blink</a>;
01814             BlinkCell-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o2">Flink</a> = SecurityCell;
01815             FlinkCell-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o3">Blink</a> = SecurityCell;
01816         }
01817     }
01818     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01819 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="cmse.c::CmpQuerySecurityDescriptorInfo" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmpQuerySecurityDescriptorInfo           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>kcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_INFORMATION&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PSECURITY_DESCRIPTOR *&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectsSecurityDescriptor</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d1/cmse_8c-source.html#l00847">847</a> of file <a class="el" href="../../d8/d1/cmse_8c-source.html">cmse.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00248">CML_FLOW</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00263">CMS_SEC</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00526">_CM_KEY_SECURITY::Descriptor</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d5/d5/regext_8c-source.html#l00458">kcb()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d5/semethod_8c-source.html#l00559">SeQuerySecurityDescriptorInfo()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d8/d1/cmse_8c-source.html#l00158">CmpSecurityMethod()</a>.
<p>
<pre class="fragment"><div>00857                    :
00858 
00859     This routine will extract <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired information from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00860     passed security descriptor and <span class="keywordflow">return</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> information in
00861     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> passed buffer as a security descriptor in absolute <a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a>.
00862 
00863 Arguments:
00864 
00865     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d5/d5/struct__CM__KEY__REFERENCE.html">CM_KEY_REFERENCE</a> <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> node whose
00866         security descriptor will be deleted.
00867 
00868     SecurityInformation - Specifies what information <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being queried.
00869 
00870     SecurityDescriptor - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer to output <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested
00871         information into.
00872 
00873         This buffer has been probed <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size indicated by
00874         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Length parameter.  Since <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> still points into user space,
00875         <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> must always be accessed in a <span class="keywordflow">try</span> clause.
00876 
00877     Length - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of a variable containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of
00878         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor buffer.  Upon <span class="keywordflow">return</span> <span class="keyword">this</span> variable will
00879         contain <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length needed to store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested information.
00880 
00881     ObjectsSecurityDescriptor - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of a pointer to
00882         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> objects security descriptor.  The passed security descriptor
00883         must be in <span class="keyword">self</span>-relative <a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a>.
00884 
00885 
00886 Return Value:
00887 
00888     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - STATUS_SUCCESS <span class="keywordflow">if</span> successful and an appropriate error value
00889         otherwise
00890 
00891 --*/
00892 
00893 {
00894     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00895     <a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a> Security;
00896     PSECURITY_DESCRIPTOR CellSecurityDescriptor;
00897 
00898     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00899     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_SEC) {
00900         KdPrint((<span class="stringliteral">"CmpQuerySecurityDescriptorInfo:\n"</span>));
00901     }
00902 
00903     Security =  (<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a>) <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyHive, <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;Security);
00904 
00905     CellSecurityDescriptor = &amp;Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o6">Descriptor</a>;
00906 
00907     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d6/semethod_8c.html#a6">SeQuerySecurityDescriptorInfo</a>( SecurityInformation,
00908                                             SecurityDescriptor,
00909                                             Length,
00910                                             &amp;CellSecurityDescriptor );
00911 
00912     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00913 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="cmse.c::CmpRemoveSecurityCellList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpRemoveSecurityCellList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityCell</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d1/cmse_8c-source.html#l01823">1823</a> of file <a class="el" href="../../d8/d1/cmse_8c-source.html">cmse.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00523">_CM_KEY_SECURITY::Blink</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00248">CML_FLOW</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00263">CMS_SEC</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00522">_CM_KEY_SECURITY::Flink</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d8/d1/cmse_8c-source.html#l01464">CmpFreeSecurityDescriptor()</a>, and <a class="el" href="../../d8/d1/cmse_8c-source.html#l00397">CmpSetSecurityDescriptorInfo()</a>.
<p>
<pre class="fragment"><div>01829                    :
01830 
01831     Removes a security cell from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> per-hive linked list of security cells.
01832     (This means <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cell <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> going to be deleted!)
01833 
01834     NOTE:   Caller <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> expected to have already marked relevent cells dirty
01835 
01836 Arguments:
01837 
01838     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure
01839 
01840     SecurityCell - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cell index of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security cell to be
01841            removed
01842 
01843 Return Value:
01844 
01845     None.
01846 
01847 --*/
01848 
01849 {
01850     <a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a> FlinkCell;
01851     <a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a> BlinkCell;
01852     <a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>;
01853 
01854     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01855     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_SEC) {
01856         KdPrint((<span class="stringliteral">"CmpRemoveSecurityCellList: index %ld\n"</span>,SecurityCell));
01857     }
01858     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> = (<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a>) <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, SecurityCell);
01859     FlinkCell = (<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a>) <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>-&gt;Flink);
01860     BlinkCell = (<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a>) <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>-&gt;Blink);
01861 
01862     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FlinkCell-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o3">Blink</a> == SecurityCell);
01863     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(BlinkCell-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o2">Flink</a> == SecurityCell);
01864 
01865     FlinkCell-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o3">Blink</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>-&gt;Blink;
01866     BlinkCell-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o2">Flink</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>-&gt;Flink;
01867 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="cmse.c::CmpSecurityExceptionFilter" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG CmpSecurityExceptionFilter           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PEXCEPTION_POINTERS&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ExceptionPointers</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d1/cmse_8c-source.html#l00117">117</a> of file <a class="el" href="../../d8/d1/cmse_8c-source.html">cmse.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>.
<p>
Referenced by <a class="el" href="../../d8/d1/cmse_8c-source.html#l00158">CmpSecurityMethod()</a>.
<p>
<pre class="fragment"><div>00123                    :
00124 
00125     <a class="code" href="../../d2/d5/editreg_8c.html#a51">Debug</a> code to find registry security exceptions that are being swallowed
00126 
00127 Return Value:
00128 
00129     <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>
00130 
00131 --*/
00132 
00133 {
00134     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"CM: Registry security exception %lx, ExceptionPointers = %p\n"</span>,
00135             ExceptionPointers-&gt;ExceptionRecord-&gt;ExceptionCode,
00136             ExceptionPointers);
00137     
00138     <span class="comment">//</span>
00139     <span class="comment">// This is a request from the base test team; no dbg should be hit on the free builds </span>
00140     <span class="comment">// at the client; after RC2 is shipped we should enable this on free builds too.</span>
00141     <span class="comment">//</span>
00142 <span class="preprocessor">#if DBG</span>
00143 <span class="preprocessor"></span>    <span class="keywordflow">try</span> {
00144         DbgBreakPoint();
00145     } except (EXCEPTION_EXECUTE_HANDLER) {
00146 
00147         <span class="comment">//</span>
00148         <span class="comment">// no debugger enabled, just keep going</span>
00149         <span class="comment">//</span>
00150 
00151     }
00152 <span class="preprocessor">#endif</span>
00153 <span class="preprocessor"></span>
00154     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>);
00155 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="cmse.c::CmpSecurityMethod" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmpSecurityMethod           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d5/se_8h.html#a19">SECURITY_OPERATION_CODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OperationCode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_INFORMATION&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>CapturedLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PSECURITY_DESCRIPTOR *&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectsSecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PoolType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PGENERIC_MAPPING&nbsp;</td>
          <td class="mdname" nowrap> <em>GenericMapping</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d1/cmse_8c-source.html#l00158">158</a> of file <a class="el" href="../../d8/d1/cmse_8c-source.html">cmse.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00346">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00530">ASSERT_KEY_OBJECT</a>, <a class="el" href="../../d0/d5/se_8h.html#a200a111">AssignSecurityDescriptor</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00248">CML_FLOW</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00697">CmpAssignSecurityDescriptor()</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00124">CmpLockRegistry()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00081">CmpLockRegistryExclusive()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00847">CmpQuerySecurityDescriptorInfo()</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00114">CmpReportNotify()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00117">CmpSecurityExceptionFilter()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00397">CmpSetSecurityDescriptorInfo()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00116">CmpUnlockRegistry()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00263">CMS_SEC</a>, <a class="el" href="../../d0/d5/se_8h.html#a200a110">DeleteSecurityDescriptor</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/regext_8c-source.html#l00458">kcb()</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d3/d9/nt6_2user32_8def-source.html#l00417">Key</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l01183">ObAssignObjectSecurityDescriptor()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d0/d5/se_8h.html#a200a109">QuerySecurityDescriptor</a>, <a class="el" href="../../d0/d5/se_8h.html#a200a108">SetSecurityDescriptor</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01074">CmpCreateObjectTypes()</a>, and <a class="el" href="../../d4/d1/cmparse2_8c-source.html#l00226">CmpDoCreateChild()</a>.
<p>
<pre class="fragment"><div>00171                    :
00172 
00173     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security method <span class="keywordflow">for</span> registry objects.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> responsible <span class="keywordflow">for</span>
00174     retrieving, setting, and deleting <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor of a registry
00175     object.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not used to assign <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> original security descriptor to an
00176     object (use SeAssignSecurity <span class="keywordflow">for</span> that purpose).
00177 
00178 
00179     IT IS ASSUMED THAT THE OBJECT MANAGER HAS ALREADY DONE THE ACCESS
00180     VALIDATIONS NECESSARY TO ALLOW THE REQUESTED OPERATIONS TO BE PERFORMED.
00181 
00182 Arguments:
00183 
00184     Object - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object being used.
00185 
00186     OperationCode - Indicates <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keywordflow">for</span> setting, querying, or
00187         deleting <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object's security descriptor.
00188 
00189     SecurityInformation - Indicates which security information <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being
00190         queried or set.  This argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> ignored <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">delete</span> operation.
00191 
00192     SecurityDescriptor - The meaning of <span class="keyword">this</span> parameter depends on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00193         OperationCode:
00194 
00195         <a class="code" href="../../d0/d5/se_8h.html#a200a109">QuerySecurityDescriptor</a> - For <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> query operation <span class="keyword">this</span> supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00196             buffer to copy <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> descriptor into.  The security descriptor <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00197             assumed to have been probed up to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size passed in in Length.
00198             Since <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> still points into user space, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> must always be
00199             accessed in a <span class="keywordflow">try</span> clause in <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> should suddenly disappear.
00200 
00201         <a class="code" href="../../d0/d5/se_8h.html#a200a108">SetSecurityDescriptor</a> - For a set operation <span class="keyword">this</span> supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00202             security descriptor to copy into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.  The security
00203             descriptor must be captured before <span class="keyword">this</span> routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called.
00204 
00205         <a class="code" href="../../d0/d5/se_8h.html#a200a110">DeleteSecurityDescriptor</a> - It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> ignored when deleting a security
00206             descriptor.
00207 
00208         <a class="code" href="../../d0/d5/se_8h.html#a200a111">AssignSecurityDescriptor</a> - For assign operations <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00209             security descriptor that will be assigned to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.
00210             It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assumed to be in kernel space, and <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> therefore not
00211             probed or captured.
00212 
00213     CapturedLength - For <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> query operation <span class="keyword">this</span> specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length, in
00214         bytes, of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor buffer, and upon <span class="keywordflow">return</span> contains
00215         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes needed to store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> descriptor.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length
00216         needed <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> greater than <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length supplied <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation will fail.
00217         It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> ignored in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> set and <span class="keyword">delete</span> operation.
00218 
00219         This parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assumed to be captured and probed as appropriate.
00220 
00221     ObjectsSecurityDescriptor - For <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Set operation <span class="keyword">this</span> supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address
00222         of a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object's current security descriptor.  This routine
00223         will either modify <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor in place or deallocate/
00224         allocate a <span class="keyword">new</span> security descriptor and use <span class="keyword">this</span> variable to indicate
00225         its <span class="keyword">new</span> location.  For <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> query operation <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> simply supplies
00226         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor being queried.
00227 
00228     PoolType - For <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> set operation <span class="keyword">this</span> specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> to use <span class="keywordflow">if</span>
00229         a <span class="keyword">new</span> security descriptor needs to be allocated.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> ignored
00230         in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> query and <span class="keyword">delete</span> operation.
00231 
00232     GenericMapping - Passed <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> set operation, <span class="keyword">this</span> argument provides
00233         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mapping of generic to specific/standard access types <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object
00234         being accessed.  This mapping structure <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> expected to be safe to
00235         access (i.e., captured <span class="keywordflow">if</span> necessary) prior to be passed to <span class="keyword">this</span> routine.
00236 
00237 Return Value:
00238 
00239     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - STATUS_SUCCESS <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> successful and an
00240         appropriate error status otherwise.
00241 
00242 --*/
00243 
00244 {
00245     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
00246     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00247     <a class="code" href="../../d5/d5/struct__CM__KEY__REFERENCE.html">CM_KEY_REFERENCE</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>;
00248 
00249     <span class="comment">//</span>
00250     <span class="comment">//  Make sure the common parts of our input are proper</span>
00251     <span class="comment">//</span>
00252 
00253     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00254     <a class="code" href="../../d1/d2/cmp_8h.html#a83">ASSERT_KEY_OBJECT</a>(Object);
00255 
00256     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (OperationCode == SetSecurityDescriptor) ||
00257             (OperationCode == QuerySecurityDescriptor) ||
00258             (OperationCode == AssignSecurityDescriptor) ||
00259             (OperationCode == DeleteSecurityDescriptor) );
00260 
00261     <span class="comment">//</span>
00262     <span class="comment">// Lock hive for shared or exclusive, depending on what we need</span>
00263     <span class="comment">// to do.</span>
00264     <span class="comment">//</span>
00265     <span class="keywordflow">if</span> (OperationCode == <a class="code" href="../../d0/d5/se_8h.html#a200a109">QuerySecurityDescriptor</a>) {
00266         <a class="code" href="../../d6/d3/cmwraper_8c.html#a14">CmpLockRegistry</a>();
00267     } <span class="keywordflow">else</span> {
00268         <a class="code" href="../../d0/d3/cmsubs3_8c.html#a4">CmpLockRegistryExclusive</a>();
00269     }
00270 
00271     <span class="keywordflow">if</span> (((<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>)Object)-&gt;KeyControlBlock-&gt;Delete) {
00272         <span class="comment">//</span>
00273         <span class="comment">// Key has been deleted, performing security operations on</span>
00274         <span class="comment">// it is Not Allowed.</span>
00275         <span class="comment">//</span>
00276         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00277         <span class="keywordflow">return</span>(STATUS_KEY_DELETED);
00278     }
00279 
00280     <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> = ((<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>)Object)-&gt;KeyControlBlock;
00281 
00282     <span class="keywordflow">try</span> {
00283         <span class="comment">//</span>
00284         <span class="comment">//  This routine simply cases off of the operation code to decide</span>
00285         <span class="comment">//  which support routine to call</span>
00286         <span class="comment">//</span>
00287 
00288         <span class="keywordflow">switch</span> (OperationCode) {
00289 
00290         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/se_8h.html#a200a108">SetSecurityDescriptor</a>:
00291 
00292             <span class="comment">//</span>
00293             <span class="comment">//  check the rest of our input and call the set security</span>
00294             <span class="comment">//  method</span>
00295             <span class="comment">//</span>
00296             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (PoolType == PagedPool) || (PoolType == NonPagedPool) );
00297 
00298             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d2/cmse_8c.html#a1">CmpSetSecurityDescriptorInfo</a>( kcb,
00299                                                    SecurityInformation,
00300                                                    SecurityDescriptor,
00301                                                    ObjectsSecurityDescriptor,
00302                                                    PoolType,
00303                                                    GenericMapping );
00304 
00305             <span class="comment">//</span>
00306             <span class="comment">// this is the one and only path on which a user could change</span>
00307             <span class="comment">// a security descriptor, therefore, report such changes for</span>
00308             <span class="comment">// notification here.</span>
00309             <span class="comment">//</span>
00310             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00311                 <a class="code" href="../../d6/d3/cmwraper_8c.html#a13">CmpReportNotify</a>(kcb,
00312                                 <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyHive,
00313                                 <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyCell,
00314                                 REG_NOTIFY_CHANGE_ATTRIBUTES | REG_NOTIFY_CHANGE_SECURITY);
00315     
00316             }
00317 
00318             <span class="keywordflow">break</span>;
00319 
00320         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/se_8h.html#a200a109">QuerySecurityDescriptor</a>:
00321 
00322             <span class="comment">//</span>
00323             <span class="comment">//  check the rest of our input and call the default query security</span>
00324             <span class="comment">//  method</span>
00325             <span class="comment">//</span>
00326             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( CapturedLength != NULL );
00327             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d2/cmse_8c.html#a2">CmpQuerySecurityDescriptorInfo</a>( kcb,
00328                                                      SecurityInformation,
00329                                                      SecurityDescriptor,
00330                                                      CapturedLength,
00331                                                      ObjectsSecurityDescriptor );
00332             <span class="keywordflow">break</span>;
00333 
00334         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/se_8h.html#a200a110">DeleteSecurityDescriptor</a>:
00335 
00336             <span class="comment">//</span>
00337             <span class="comment">// Nobody should ever call the delete method.  When the key is</span>
00338             <span class="comment">// freed, the security descriptor associated with it is</span>
00339             <span class="comment">// explicitly freed (CmpFreeSecurityDescriptor)</span>
00340             <span class="comment">//</span>
00341             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FALSE);
00342 
00343             <span class="keywordflow">break</span>;
00344 
00345         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/se_8h.html#a200a111">AssignSecurityDescriptor</a>:
00346 
00347             <span class="comment">//</span>
00348             <span class="comment">// Set the SecurityDescriptor field in the object's header to</span>
00349             <span class="comment">// NULL.  This indicates that our security method needs to be</span>
00350             <span class="comment">// called for any security descriptor operations.</span>
00351             <span class="comment">//</span>
00352 
00353             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/obse_8c.html#a7">ObAssignObjectSecurityDescriptor</a>(Object, NULL, PagedPool);
00354 
00355             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ));
00356 
00357             <span class="comment">//</span>
00358             <span class="comment">// Assign the actual descriptor.</span>
00359             <span class="comment">//</span>
00360             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d2/cmse_8c.html#a10">CmpAssignSecurityDescriptor</a>( <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyHive,
00361                                                   <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyCell,
00362                                                   <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyNode,
00363                                                   SecurityDescriptor );
00364             <span class="comment">//</span>
00365             <span class="comment">// Security has been changed, update the cache.</span>
00366             <span class="comment">//</span>
00367             <a class="code" href="../../d1/d2/cmp_8h.html#a62">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>();
00368             <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;Security = <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyNode-&gt;Security;
00369 
00370             <span class="keywordflow">break</span>;
00371 
00372         <span class="keywordflow">default</span>:
00373 
00374             <span class="comment">//</span>
00375             <span class="comment">//  Bugcheck on any other operation code,  We won't get here if</span>
00376             <span class="comment">//  the earlier asserts are still checked.</span>
00377             <span class="comment">//</span>
00378             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>( REGISTRY_ERROR,3,1,(ULONG_PTR)kcb,0);
00379 
00380         }
00381     
00382     } except (<a class="code" href="../../d7/d2/cmse_8c.html#a8">CmpSecurityExceptionFilter</a>(GetExceptionInformation())) {
00383         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_SEC) {
00384             KdPrint((<span class="stringliteral">"!!CmpSecurityMethod: code:%08lx\n"</span>, GetExceptionCode()));
00385         }
00386         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00387     }
00388 
00389 
00390     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00391     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00392 
00393 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="cmse.c::CmpSetSecurityDescriptorInfo" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmpSetSecurityDescriptorInfo           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>kcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_INFORMATION&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>ModificationDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PSECURITY_DESCRIPTOR *&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectsSecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PoolType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PGENERIC_MAPPING&nbsp;</td>
          <td class="mdname" nowrap> <em>GenericMapping</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d1/cmse_8c-source.html#l00397">397</a> of file <a class="el" href="../../d8/d1/cmse_8c-source.html">cmse.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00346">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00532">ASSERT_SECURITY</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00523">_CM_KEY_SECURITY::Blink</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00517">CM_KEY_SECURITY_SIGNATURE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00248">CML_FLOW</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00400">CmpDumpSecurityDescriptor</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01545">CmpFindMatchingDescriptorCell()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01165">CmpGetKeySecurity()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01823">CmpRemoveSecurityCellList()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00263">CMS_SEC</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00308">DCmCheckRegistry</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00526">_CM_KEY_SECURITY::Descriptor</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00525">_CM_KEY_SECURITY::DescriptorLength</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00522">_CM_KEY_SECURITY::Flink</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00386">HvAllocateCell()</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00688">HvFreeCell()</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00135">HvGetCellType</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00117">HvMarkCellDirty()</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l01295">HvReallocateCell()</a>, <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l00153">KeQuerySystemTime()</a>, <a class="el" href="../../d3/d9/nt6_2user32_8def-source.html#l00417">Key</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00451">_CM_KEY_NODE::LastWriteTime</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00524">_CM_KEY_SECURITY::ReferenceCount</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l02165">RtlLengthSecurityDescriptor()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00463">_CM_KEY_NODE::Security</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00095">SECURITY_CELL_LENGTH</a>, <a class="el" href="../../d1/d5/semethod_8c-source.html#l00365">SeSetSecurityDescriptorInfo()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00520">_CM_KEY_SECURITY::Signature</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d8/d1/cmse_8c-source.html#l00158">CmpSecurityMethod()</a>.
<p>
<pre class="fragment"><div>00407                    :
00408 
00409     This routine will set a node's security descriptor.  The input
00410     security descriptor must be previously captured.
00411 
00412 Arguments:
00413 
00414     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> KEY_CONTROL_BLOCK <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> node whose
00415         security descriptor will be set.
00416 
00417     SecurityInformation - Indicates which security information <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00418         to be applied to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.  The value(s) to be assigned are
00419         passed in the SecurityDescriptor parameter.
00420 
00421     ModificationDescriptor - Supplies the input security descriptor to be
00422         applied to the object.  The caller of this routine is expected
00423         to probe and capture the passed security descriptor before calling
00424         and release it after calling.
00425 
00426     ObjectsSecurityDescriptor - Supplies the address of a pointer to
00427         the objects security descriptor that is going to be altered by
00428         this procedure
00429 
00430     PoolType - Specifies the type of pool to allocate for the objects
00431         security descriptor.
00432 
00433     GenericMapping - This argument provides the mapping of generic to
00434         specific/standard access types for the object being accessed.
00435         This mapping structure is expected to be safe to access
00436         (i.e., captured if necessary) prior to be passed to this routine.
00437 
00438 Return Value:
00439 
00440     NTSTATUS - STATUS_SUCCESS if successful and an appropriate error
00441         value otherwise
00442 
00443 --*/
00444 
00445 {
00446     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00447     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> SecurityCell;
00448     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> MatchSecurityCell;
00449     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> NewCell;
00450     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> OldCell;
00451     <a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a> Security;
00452     <a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a> NewSecurity;
00453     <a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a> FlinkSecurity;
00454     <a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a> BlinkSecurity;
00455     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Node;
00456     ULONG DescriptorLength;
00457     PSECURITY_DESCRIPTOR DescriptorCopy;
00458     PSECURITY_DESCRIPTOR OldDescriptorCopy;
00459     ULONG   Type;
00460     LARGE_INTEGER SystemTime;
00461     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
00462 
00463     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00464     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_SEC) {
00465         KdPrint((<span class="stringliteral">"CmpSetSecurityDescriptorInfo:\n"</span>));
00466     }
00467 
00468     <span class="comment">//</span>
00469     <span class="comment">// Map in the hive cell for the security descriptor before we make</span>
00470     <span class="comment">// the call to SeSetSecurityDescriptorInfo.  This prevents us from</span>
00471     <span class="comment">// changing its security descriptor and then being unable to bring</span>
00472     <span class="comment">// the hive cell into memory for updating.</span>
00473     <span class="comment">//</span>
00474     Security = <a class="code" href="../../d7/d2/cmse_8c.html#a3">CmpGetKeySecurity</a>(<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>-&gt;KeyHive,
00475                                  <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>-&gt;KeyNode,
00476                                  &amp;SecurityCell);
00477 
00478     <span class="comment">//</span>
00479     <span class="comment">// SeSetSecurityDescriptorInfo takes a pointer to the original</span>
00480     <span class="comment">// descriptor. This pointer is not freed, but a new pointer will</span>
00481     <span class="comment">// be returned.</span>
00482     <span class="comment">//</span>
00483     DescriptorCopy = &amp;Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o6">Descriptor</a>;
00484     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d6/semethod_8c.html#a4">SeSetSecurityDescriptorInfo</a>( NULL,
00485                                           SecurityInformation,
00486                                           ModificationDescriptor,
00487                                           &amp;DescriptorCopy,
00488                                           PoolType,
00489                                           GenericMapping );
00490 
00491     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00492         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00493     }
00494 
00495     <span class="comment">//</span>
00496     <span class="comment">// Set Security operation succeeded, so we update the security</span>
00497     <span class="comment">// descriptor in the hive.</span>
00498     <span class="comment">//</span>
00499     DescriptorLength = <a class="code" href="../../d8/d6/sertl_8c.html#a56">RtlLengthSecurityDescriptor</a>(DescriptorCopy);
00500     Type = <a class="code" href="../../d0/d1/hivedata_8h.html#a19">HvGetCellType</a>(<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>-&gt;KeyCell);
00501     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> = <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>-&gt;KeyHive;
00502     Node = <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>-&gt;KeyNode;
00503 
00504     <span class="keywordflow">if</span> (! (<a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(Hive, <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>-&gt;KeyCell) &amp;&amp;
00505            <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(Hive, SecurityCell)))
00506     {
00507         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DescriptorCopy);
00508         <span class="keywordflow">return</span> STATUS_NO_LOG_SPACE;
00509     }
00510 
00511     <span class="comment">//</span>
00512     <span class="comment">// Try to find an existing security descriptor that we can share.</span>
00513     <span class="comment">//</span>
00514     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d2/cmse_8c.html#a5">CmpFindMatchingDescriptorCell</a>(Hive, Node, DescriptorCopy, Type, &amp;MatchSecurityCell)) {
00515         <span class="comment">//</span>
00516         <span class="comment">// A match was found.</span>
00517         <span class="comment">//</span>
00518         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(Hive, MatchSecurityCell)) {
00519             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DescriptorCopy);
00520             <span class="keywordflow">return</span>(STATUS_NO_LOG_SPACE);
00521         }
00522         <span class="keywordflow">if</span> (Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o4">ReferenceCount</a> == 1) {
00523             <span class="comment">//</span>
00524             <span class="comment">// No more references to the old security cell, so we can free it now.</span>
00525             <span class="comment">//</span>
00526             <span class="keywordflow">if</span> (! (<a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(Hive, Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o2">Flink</a>) &amp;&amp;
00527                    <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(Hive, Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o3">Blink</a>))) {
00528                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DescriptorCopy);
00529                 <span class="keywordflow">return</span>(STATUS_NO_LOG_SPACE);
00530             }
00531             <a class="code" href="../../d7/d2/cmse_8c.html#a7">CmpRemoveSecurityCellList</a>(Hive, SecurityCell);
00532             <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(Hive, SecurityCell);
00533         } <span class="keywordflow">else</span> {
00534 
00535             <span class="comment">//</span>
00536             <span class="comment">// Just decrement the count on the old security cell</span>
00537             <span class="comment">//</span>
00538             Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o4">ReferenceCount</a> -= 1;
00539         }
00540 
00541         <span class="comment">//</span>
00542         <span class="comment">// Set the node to point at the matching security cell.</span>
00543         <span class="comment">//</span>
00544         Security = (<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, MatchSecurityCell);
00545         Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o4">ReferenceCount</a> += 1;
00546         Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o9">Security</a> = MatchSecurityCell;
00547     } <span class="keywordflow">else</span> {
00548 
00549         <span class="comment">//</span>
00550         <span class="comment">// No match was found, we need to create a new cell.</span>
00551         <span class="comment">//</span>
00552         <span class="keywordflow">if</span> (Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o4">ReferenceCount</a> &gt; 1) {
00553 
00554             <span class="comment">//</span>
00555             <span class="comment">// We can't change the existing security cell, since it is shared</span>
00556             <span class="comment">// by multiple keys.  Allocate a new cell and decrement the existing</span>
00557             <span class="comment">// one's reference count.</span>
00558             <span class="comment">//</span>
00559             NewCell = <a class="code" href="../../d8/d0/hivecell_8c.html#a16">HvAllocateCell</a>(<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>-&gt;KeyHive,
00560                                      <a class="code" href="../../d7/d2/cmse_8c.html#a0">SECURITY_CELL_LENGTH</a>(DescriptorCopy),
00561                                      Type);
00562             <span class="keywordflow">if</span> (NewCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00563                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DescriptorCopy);
00564                 <span class="keywordflow">return</span>(STATUS_INSUFFICIENT_RESOURCES);
00565             }
00566 
00567             <span class="keywordflow">if</span> (! <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>-&gt;KeyHive, Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o2">Flink</a>)) {
00568                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DescriptorCopy);
00569                 <span class="keywordflow">return</span> STATUS_NO_LOG_SPACE;
00570             }
00571 
00572             Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o4">ReferenceCount</a> -= 1;
00573 
00574             <span class="comment">//</span>
00575             <span class="comment">// Map in the new cell and insert it into the linked list.</span>
00576             <span class="comment">//</span>
00577             NewSecurity = (<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a>) <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>-&gt;KeyHive, NewCell);
00578             NewSecurity-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o3">Blink</a> = SecurityCell;
00579             NewSecurity-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o2">Flink</a> = Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o2">Flink</a>;
00580             FlinkSecurity = (<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a>) <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>-&gt;KeyHive, Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o2">Flink</a>);
00581             Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o2">Flink</a> = FlinkSecurity-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o3">Blink</a> = NewCell;
00582 
00583             <span class="comment">//</span>
00584             <span class="comment">// initialize new cell</span>
00585             <span class="comment">//</span>
00586             NewSecurity-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o0">Signature</a> = <a class="code" href="../../d9/d0/cmdata_8h.html#a39">CM_KEY_SECURITY_SIGNATURE</a>;
00587             NewSecurity-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o4">ReferenceCount</a> = 1;
00588             NewSecurity-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o5">DescriptorLength</a> = DescriptorLength;
00589             Security=NewSecurity;
00590 
00591             <span class="comment">//</span>
00592             <span class="comment">// Update the pointer in the node cell.</span>
00593             <span class="comment">//</span>
00594             Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o9">Security</a> = NewCell;
00595 
00596         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (DescriptorLength != Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o5">DescriptorLength</a>) {
00597 
00598             <span class="comment">//</span>
00599             <span class="comment">// The security descriptor's size has changed, and it is not shared</span>
00600             <span class="comment">// by any other cells, so reallocate the cell.</span>
00601             <span class="comment">//</span>
00602             <span class="keywordflow">if</span> (! (<a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>-&gt;KeyHive, Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o2">Flink</a>) &amp;&amp;
00603                    <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>-&gt;KeyHive, Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o3">Blink</a>))) {
00604                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DescriptorCopy);
00605                 <span class="keywordflow">return</span>(STATUS_INSUFFICIENT_RESOURCES);
00606             }
00607 
00608             <a class="code" href="../../d1/d2/cmp_8h.html#a57">DCmCheckRegistry</a>((<a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>)(<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>-&gt;KeyHive));
00609             OldCell = SecurityCell;
00610             SecurityCell = <a class="code" href="../../d8/d0/hivecell_8c.html#a20">HvReallocateCell</a>( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>-&gt;KeyHive,
00611                                              SecurityCell,
00612                                              <a class="code" href="../../d7/d2/cmse_8c.html#a0">SECURITY_CELL_LENGTH</a>(DescriptorCopy) );
00613             <span class="keywordflow">if</span> (SecurityCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00614                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DescriptorCopy);
00615                 <span class="keywordflow">return</span>(STATUS_INSUFFICIENT_RESOURCES);
00616             }
00617 
00618             <span class="comment">//</span>
00619             <span class="comment">// Update the Node's security data.</span>
00620             <span class="comment">//</span>
00621             Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o9">Security</a> = SecurityCell;
00622 
00623             <span class="comment">//</span>
00624             <span class="comment">// Update Security to point to where the new security object is</span>
00625             <span class="comment">//</span>
00626             Security = (<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a>) <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>-&gt;KeyHive, SecurityCell);
00627             <a class="code" href="../../d1/d2/cmp_8h.html#a85">ASSERT_SECURITY</a>(Security);
00628 
00629             <span class="comment">//</span>
00630             <span class="comment">// Update other list references to the node</span>
00631             <span class="comment">//</span>
00632             <span class="keywordflow">if</span> (Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o2">Flink</a> == OldCell) {
00633                 Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o2">Flink</a> = SecurityCell; <span class="comment">// point to new self</span>
00634             } <span class="keywordflow">else</span> {
00635                 FlinkSecurity = (<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a>) <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(
00636                                                         <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>-&gt;KeyHive,
00637                                                         Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o2">Flink</a>
00638                                                         );
00639                 FlinkSecurity-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o3">Blink</a> = SecurityCell;
00640             }
00641 
00642             <span class="keywordflow">if</span> (Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o3">Blink</a> == OldCell) {
00643                 Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o3">Blink</a> = SecurityCell; <span class="comment">// point to new self</span>
00644             } <span class="keywordflow">else</span> {
00645                 BlinkSecurity = (<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a>) <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(
00646                                                         <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>-&gt;KeyHive,
00647                                                         Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o3">Blink</a>
00648                                                         );
00649                 BlinkSecurity-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o2">Flink</a> = SecurityCell;
00650             }
00651 
00652             <span class="comment">//</span>
00653             <span class="comment">// Finally, update the length field in the cell</span>
00654             <span class="comment">//</span>
00655             Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o5">DescriptorLength</a> = DescriptorLength;
00656             <a class="code" href="../../d1/d2/cmp_8h.html#a57">DCmCheckRegistry</a>((<a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>)(<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>-&gt;KeyHive));
00657 
00658         } <span class="keywordflow">else</span> {
00659 
00660             <span class="comment">//</span>
00661             <span class="comment">// Size hasn't changed, and it's not shared by any other cells, so</span>
00662             <span class="comment">// we can just write the new bits over the old bits.</span>
00663             <span class="comment">//</span>
00664             NOTHING;
00665         }
00666 
00667         RtlMoveMemory( &amp;(Security-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o6">Descriptor</a>),
00668                        DescriptorCopy,
00669                        DescriptorLength );
00670     }
00671 
00672 
00673     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_SEC) {
00674         KdPrint((<span class="stringliteral">"\tObject's SD has been changed\n"</span>));
00675         <a class="code" href="../../d1/d2/cmp_8h.html#a66">CmpDumpSecurityDescriptor</a>(DescriptorCopy, <span class="stringliteral">"NEW DESCRIPTOR\n"</span>);
00676     }
00677 
00678     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DescriptorCopy);
00679 
00680     <span class="comment">//</span>
00681     <span class="comment">// Update the LastWriteTime of the key.</span>
00682     <span class="comment">//</span>
00683     <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a>(&amp;SystemTime);
00684     Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o2">LastWriteTime</a> = SystemTime;
00685 
00686     <span class="comment">//</span>
00687     <span class="comment">// Security has changed, update the cache.</span>
00688     <span class="comment">//</span>
00689     <a class="code" href="../../d1/d2/cmp_8h.html#a62">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>();
00690     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>-&gt;Security = Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o9">Security</a>;
00691 
00692     <span class="keywordflow">return</span>(STATUS_SUCCESS);
00693 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:11 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
