<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: vadtree.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>vadtree.c</h1><a href="../../d6/d3/vadtree_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    vadtree.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains the routine to manipulate the virtual address</span>
00012 <span class="comment">    descriptor tree.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Lou Perazzoli (loup) 19-May-1989</span>
00017 <span class="comment">    Landy Wang (landyw) 02-June-1997</span>
00018 <span class="comment"></span>
00019 <span class="comment">Environment:</span>
00020 <span class="comment"></span>
00021 <span class="comment">    Kernel mode only, working set mutex held, APCs disabled.</span>
00022 <span class="comment"></span>
00023 <span class="comment">Revision History:</span>
00024 <span class="comment"></span>
00025 <span class="comment">--*/</span>
00026 
00027 <span class="preprocessor">#include "<a class="code" href="../../d4/d8/mi_8h.html">mi.h</a>"</span>
00028 
00029 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00030"></a><a class="code" href="../../d6/d3/vadtree_8c.html#a0">00030</a> <a class="code" href="../../d6/d3/vadtree_8c.html#a0">MiInsertVad</a> (
00031     IN <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Vad
00032     )
00033 
00034 <span class="comment">/*++</span>
00035 <span class="comment"></span>
00036 <span class="comment">Routine Description:</span>
00037 <span class="comment"></span>
00038 <span class="comment">    This function inserts a virtual address descriptor into the tree and</span>
00039 <span class="comment">    reorders the splay tree as appropriate.</span>
00040 <span class="comment"></span>
00041 <span class="comment">Arguments:</span>
00042 <span class="comment"></span>
00043 <span class="comment">    Vad - Supplies a pointer to a virtual address descriptor</span>
00044 <span class="comment"></span>
00045 <span class="comment"></span>
00046 <span class="comment">Return Value:</span>
00047 <span class="comment"></span>
00048 <span class="comment">    None - An exception is raised if quota is exceeded.</span>
00049 <span class="comment"></span>
00050 <span class="comment">--*/</span>
00051 
00052 {
00053     <a class="code" href="../../d9/d0/struct__MMADDRESS__NODE.html">PMMADDRESS_NODE</a> *Root;
00054     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess;
00055     SIZE_T RealCharge;
00056     SIZE_T PageCharge;
00057     SIZE_T PagedQuotaCharged;
00058     ULONG FirstPage;
00059     ULONG LastPage;
00060     SIZE_T PagedPoolCharge;
00061     LOGICAL ChargedPageFileQuota;
00062     LOGICAL ChargedJobCommit;
00063 
00064     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Vad-&gt;EndingVpn &gt;= Vad-&gt;StartingVpn);
00065 
00066     CurrentProcess = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
00067 
00068     <span class="comment">//</span>
00069     <span class="comment">// Commit charge of MAX_COMMIT means don't charge quota.</span>
00070     <span class="comment">//</span>
00071 
00072     <span class="keywordflow">if</span> (Vad-&gt;u.VadFlags.CommitCharge != <a class="code" href="../../d4/d8/mi_8h.html#a227">MM_MAX_COMMIT</a>) {
00073 
00074         PageCharge = 0;
00075         PagedQuotaCharged = 0;
00076         ChargedPageFileQuota = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00077         ChargedJobCommit = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00078 
00079         <span class="comment">//</span>
00080         <span class="comment">// Charge quota for the nonpaged pool for the VAD.  This is</span>
00081         <span class="comment">// done here rather than by using ExAllocatePoolWithQuota</span>
00082         <span class="comment">// so the process object is not referenced by the quota charge.</span>
00083         <span class="comment">//</span>
00084 
00085         <a class="code" href="../../d0/d2/psquota_8c.html#a2">PsChargePoolQuota</a> (CurrentProcess, <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d6/struct__MMVAD.html">MMVAD</a>));
00086 
00087         <span class="keywordflow">try</span> {
00088 
00089             <span class="comment">//</span>
00090             <span class="comment">// Charge quota for the prototype PTEs if this is a mapped view.</span>
00091             <span class="comment">//</span>
00092 
00093             <span class="keywordflow">if</span> ((Vad-&gt;u.VadFlags.PrivateMemory == 0) &amp;&amp;
00094                 (Vad-&gt;ControlArea != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00095                 PagedPoolCharge =
00096                   (Vad-&gt;EndingVpn - Vad-&gt;StartingVpn) &lt;&lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a52">PTE_SHIFT</a>;
00097                 <a class="code" href="../../d0/d2/psquota_8c.html#a2">PsChargePoolQuota</a> (CurrentProcess, <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, PagedPoolCharge);
00098                 PagedQuotaCharged = PagedPoolCharge;
00099             }
00100 
00101 <span class="preprocessor">#if !defined (_WIN64)</span>
00102 <span class="preprocessor"></span>            <span class="comment">//</span>
00103             <span class="comment">// Add in the charge for page table pages.</span>
00104             <span class="comment">//</span>
00105 
00106             FirstPage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a157">MiGetPpePdeOffset</a> (<a class="code" href="../../d4/d8/mi_8h.html#a108">MI_VPN_TO_VA</a> (Vad-&gt;StartingVpn));
00107             LastPage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a157">MiGetPpePdeOffset</a> (<a class="code" href="../../d4/d8/mi_8h.html#a108">MI_VPN_TO_VA</a> (Vad-&gt;EndingVpn));
00108 
00109             <span class="keywordflow">while</span> (FirstPage &lt;= LastPage) {
00110 
00111                 <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d8/mi_8h.html#a167">MI_CHECK_BIT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o17">CommittedPageTables</a>,
00112                                    FirstPage)) {
00113                     PageCharge += 1;
00114                 }
00115                 FirstPage += 1;
00116             }
00117 <span class="preprocessor">#endif</span>
00118 <span class="preprocessor"></span>
00119             RealCharge = Vad-&gt;u.VadFlags.CommitCharge + PageCharge;
00120 
00121             <span class="keywordflow">if</span> (RealCharge != 0) {
00122 
00123                 <a class="code" href="../../d6/d1/mmquota_8c.html#a15">MiChargePageFileQuota</a> (RealCharge, CurrentProcess);
00124                 ChargedPageFileQuota = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00125 
00126 <span class="preprocessor">#if 0 //commented out so page file quota is meaningful.</span>
00127 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (Vad-&gt;u.VadFlags.PrivateMemory == 0) {
00128 
00129                     <span class="keywordflow">if</span> ((Vad-&gt;ControlArea-&gt;FilePointer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00130                         (Vad-&gt;u.VadFlags.PhysicalMapping == 0)) {
00131 
00132                         <span class="comment">//</span>
00133                         <span class="comment">// Don't charge commitment for the page file space</span>
00134                         <span class="comment">// occupied by a page file section.  This will be</span>
00135                         <span class="comment">// charged as the shared memory is committed.</span>
00136                         <span class="comment">//</span>
00137 
00138                         RealCharge -= 1 + (Vad-&gt;EndingVpn -
00139                                                      Vad-&gt;StartingVpn);
00140                     }
00141                 }
00142 <span class="preprocessor">#endif //0</span>
00143 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o85">CommitChargeLimit</a>) {
00144                     <span class="keywordflow">if</span> (CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o12">CommitCharge</a> + RealCharge &gt; CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o85">CommitChargeLimit</a>) {
00145                         <span class="keywordflow">if</span> (CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o73">Job</a>) {
00146                             <a class="code" href="../../d1/d1/psjob_8c.html#a21">PsReportProcessMemoryLimitViolation</a> ();
00147                         }
00148                         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_COMMITMENT_LIMIT);
00149                     }
00150                 }
00151                 <span class="keywordflow">if</span> (CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a> &amp; <a class="code" href="../../d1/d9/ps_8h.html#a13">PS_JOB_STATUS_REPORT_COMMIT_CHANGES</a>) {
00152                     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d1/psjob_8c.html#a20">PsChangeJobMemoryUsage</a>(RealCharge) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00153                         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_COMMITMENT_LIMIT);
00154                     }
00155                     ChargedJobCommit = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00156                 }
00157 
00158                 <span class="keywordflow">if</span> (<a class="code" href="../../d6/d1/mmquota_8c.html#a17">MiChargeCommitment</a> (RealCharge, CurrentProcess) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00159                     <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_COMMITMENT_LIMIT);
00160                 }
00161 
00162                 CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o12">CommitCharge</a> += RealCharge;
00163                 <span class="keywordflow">if</span> (CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o12">CommitCharge</a> &gt; CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o86">CommitChargePeak</a>) {
00164                     CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o86">CommitChargePeak</a> = CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o12">CommitCharge</a>;
00165                 }
00166             }
00167         } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00168 
00169             <span class="comment">//</span>
00170             <span class="comment">// Return any quotas charged thus far.</span>
00171             <span class="comment">//</span>
00172 
00173             <a class="code" href="../../d0/d2/psquota_8c.html#a3">PsReturnPoolQuota</a> (CurrentProcess, <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/mi_8h.html#a489">MMVAD</a>));
00174 
00175             <span class="keywordflow">if</span> (PagedQuotaCharged != 0) {
00176                 <a class="code" href="../../d0/d2/psquota_8c.html#a3">PsReturnPoolQuota</a> (CurrentProcess, <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, PagedPoolCharge);
00177             }
00178 
00179             <span class="keywordflow">if</span> (ChargedPageFileQuota == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00180 
00181                 <a class="code" href="../../d0/d2/psquota_8c.html#a5">MiReturnPageFileQuota</a> (RealCharge,
00182                                        CurrentProcess);
00183             }
00184 
00185             <span class="keywordflow">if</span> (ChargedJobCommit == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00186 
00187                 <span class="comment">//</span>
00188                 <span class="comment">// Temporarily up the process commit charge as the</span>
00189                 <span class="comment">// job code will be referencing it as though everything</span>
00190                 <span class="comment">// has succeeded.</span>
00191                 <span class="comment">//</span>
00192 
00193                 CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o12">CommitCharge</a> += RealCharge;
00194                 <a class="code" href="../../d1/d1/psjob_8c.html#a20">PsChangeJobMemoryUsage</a>(-(SSIZE_T)RealCharge);
00195                 CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o12">CommitCharge</a> -= RealCharge;
00196             }
00197 
00198             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (GetExceptionCode());
00199         }
00200 
00201         <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a282">MM_DBG_COMMIT_INSERT_VAD</a>, RealCharge);
00202 
00203 <span class="preprocessor">#if !defined (_WIN64)</span>
00204 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (PageCharge != 0) {
00205 
00206             <span class="comment">//</span>
00207             <span class="comment">// Since the commitment was successful, charge the page</span>
00208             <span class="comment">// table pages.</span>
00209             <span class="comment">//</span>
00210 
00211             FirstPage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a157">MiGetPpePdeOffset</a> (<a class="code" href="../../d4/d8/mi_8h.html#a108">MI_VPN_TO_VA</a> (Vad-&gt;StartingVpn));
00212 
00213             <span class="keywordflow">while</span> (FirstPage &lt;= LastPage) {
00214 
00215                 <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d8/mi_8h.html#a167">MI_CHECK_BIT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o17">CommittedPageTables</a>,
00216                                    FirstPage)) {
00217                     <a class="code" href="../../d4/d8/mi_8h.html#a168">MI_SET_BIT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o17">CommittedPageTables</a>,
00218                                 FirstPage);
00219                     <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o6">NumberOfCommittedPageTables</a> += 1;
00220 <span class="preprocessor">#if defined (_X86PAE_)</span>
00221 <span class="preprocessor"></span>                    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o6">NumberOfCommittedPageTables</a> &lt;
00222                                                  PD_PER_SYSTEM * <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a102">PDE_PER_PAGE</a>);
00223 <span class="preprocessor">#else</span>
00224 <span class="preprocessor"></span>                    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o6">NumberOfCommittedPageTables</a> &lt;
00225                                                                  <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a102">PDE_PER_PAGE</a>);
00226 <span class="preprocessor">#endif</span>
00227 <span class="preprocessor"></span>                }
00228                 FirstPage += 1;
00229             }
00230         }
00231 <span class="preprocessor">#endif</span>
00232 <span class="preprocessor"></span>    }
00233 
00234     Root = (<a class="code" href="../../d9/d0/struct__MMADDRESS__NODE.html">PMMADDRESS_NODE</a> *)&amp;CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o38">VadRoot</a>;
00235 
00236     <span class="comment">//</span>
00237     <span class="comment">// Set the hint field in the process to this Vad.</span>
00238     <span class="comment">//</span>
00239 
00240     CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o39">VadHint</a> = Vad;
00241 
00242     <span class="keywordflow">if</span> (CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o57">VadFreeHint</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00243         <span class="keywordflow">if</span> (((ULONG)((<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o57">VadFreeHint</a>)-&gt;EndingVpn +
00244                 <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (<a class="code" href="../../d4/d8/mi_8h.html#a18">X64K</a>)) &gt;=
00245                 Vad-&gt;StartingVpn) {
00246             CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o57">VadFreeHint</a> = Vad;
00247         }
00248     }
00249 
00250     <a class="code" href="../../d4/d8/mi_8h.html#a842">MiInsertNode</a> ( (<a class="code" href="../../d9/d0/struct__MMADDRESS__NODE.html">PMMADDRESS_NODE</a>)Vad, Root);
00251     <span class="keywordflow">return</span>;
00252 }
00253 
00254 
00255 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00256"></a><a class="code" href="../../d6/d3/vadtree_8c.html#a1">00256</a> <a class="code" href="../../d6/d3/vadtree_8c.html#a1">MiRemoveVad</a> (
00257     IN <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Vad
00258     )
00259 
00260 <span class="comment">/*++</span>
00261 <span class="comment"></span>
00262 <span class="comment">Routine Description:</span>
00263 <span class="comment"></span>
00264 <span class="comment">    This function removes a virtual address descriptor from the tree and</span>
00265 <span class="comment">    reorders the splay tree as appropriate.  If any quota or commitment</span>
00266 <span class="comment">    was charged by the VAD (as indicated by the CommitCharge field) it</span>
00267 <span class="comment">    is released.</span>
00268 <span class="comment"></span>
00269 <span class="comment">Arguments:</span>
00270 <span class="comment"></span>
00271 <span class="comment">    Vad - Supplies a pointer to a virtual address descriptor.</span>
00272 <span class="comment"></span>
00273 <span class="comment">Return Value:</span>
00274 <span class="comment"></span>
00275 <span class="comment">    None.</span>
00276 <span class="comment"></span>
00277 <span class="comment">--*/</span>
00278 
00279 {
00280     <a class="code" href="../../d9/d0/struct__MMADDRESS__NODE.html">PMMADDRESS_NODE</a> *Root;
00281     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess;
00282     SIZE_T RealCharge;
00283     PLIST_ENTRY Next;
00284     <a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html">PMMSECURE_ENTRY</a> Entry;
00285 
00286     CurrentProcess = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
00287 
00288 
00289     <span class="comment">//</span>
00290     <span class="comment">// Commit charge of MAX_COMMIT means don't charge quota.</span>
00291     <span class="comment">//</span>
00292 
00293     <span class="keywordflow">if</span> (Vad-&gt;u.VadFlags.CommitCharge != <a class="code" href="../../d4/d8/mi_8h.html#a227">MM_MAX_COMMIT</a>) {
00294 
00295         <span class="comment">//</span>
00296         <span class="comment">// Return the quota charge to the process.</span>
00297         <span class="comment">//</span>
00298 
00299         <a class="code" href="../../d0/d2/psquota_8c.html#a3">PsReturnPoolQuota</a> (CurrentProcess, <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d6/struct__MMVAD.html">MMVAD</a>));
00300 
00301         <span class="keywordflow">if</span> ((Vad-&gt;u.VadFlags.PrivateMemory == 0) &amp;&amp;
00302             (Vad-&gt;ControlArea != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00303             <a class="code" href="../../d0/d2/psquota_8c.html#a3">PsReturnPoolQuota</a> (CurrentProcess,
00304                                <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00305                                (Vad-&gt;EndingVpn - Vad-&gt;StartingVpn) &lt;&lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a52">PTE_SHIFT</a>);
00306         }
00307 
00308         RealCharge = Vad-&gt;u.VadFlags.CommitCharge;
00309 
00310         <span class="keywordflow">if</span> (RealCharge != 0) {
00311 
00312             <a class="code" href="../../d0/d2/psquota_8c.html#a5">MiReturnPageFileQuota</a> (RealCharge, CurrentProcess);
00313 
00314             <span class="keywordflow">if</span> ((Vad-&gt;u.VadFlags.PrivateMemory == 0) &amp;&amp;
00315                 (Vad-&gt;ControlArea != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00316 
00317 <span class="preprocessor">#if 0 //commented out so page file quota is meaningful.</span>
00318 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (Vad-&gt;ControlArea-&gt;FilePointer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00319 
00320                     <span class="comment">//</span>
00321                     <span class="comment">// Don't release commitment for the page file space</span>
00322                     <span class="comment">// occupied by a page file section.  This will be charged</span>
00323                     <span class="comment">// as the shared memory is committed.</span>
00324                     <span class="comment">//</span>
00325 
00326                     RealCharge -= <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a> ((ULONG)Vad-&gt;EndingVa -
00327                                                    (ULONG)Vad-&gt;StartingVa);
00328                 }
00329 <span class="preprocessor">#endif</span>
00330 <span class="preprocessor"></span>            }
00331 
00332             <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (RealCharge);
00333             <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a309">MM_DBG_COMMIT_RETURN_VAD</a>, RealCharge);
00334             <span class="keywordflow">if</span> (CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o74">JobStatus</a> &amp; <a class="code" href="../../d1/d9/ps_8h.html#a13">PS_JOB_STATUS_REPORT_COMMIT_CHANGES</a>) {
00335                 <a class="code" href="../../d1/d1/psjob_8c.html#a20">PsChangeJobMemoryUsage</a>(-(SSIZE_T)RealCharge);
00336             }
00337             CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o12">CommitCharge</a> -= RealCharge;
00338         }
00339     }
00340 
00341     <span class="keywordflow">if</span> (Vad == CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o57">VadFreeHint</a>) {
00342         CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o57">VadFreeHint</a> = <a class="code" href="../../d4/d8/mi_8h.html#a95">MiGetPreviousVad</a> (Vad);
00343     }
00344 
00345     Root = (<a class="code" href="../../d9/d0/struct__MMADDRESS__NODE.html">PMMADDRESS_NODE</a> *)&amp;CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o38">VadRoot</a>;
00346 
00347     <a class="code" href="../../d4/d8/mi_8h.html#a843">MiRemoveNode</a> ( (<a class="code" href="../../d9/d0/struct__MMADDRESS__NODE.html">PMMADDRESS_NODE</a>)Vad, Root);
00348 
00349     <span class="keywordflow">if</span> (Vad-&gt;u.VadFlags.NoChange) {
00350         <span class="keywordflow">if</span> (Vad-&gt;u2.VadFlags2.MultipleSecured) {
00351 
00352            <span class="comment">//</span>
00353            <span class="comment">// Free the oustanding pool allocations.</span>
00354            <span class="comment">//</span>
00355 
00356             Next = Vad-&gt;u3.List.Flink;
00357             <span class="keywordflow">do</span> {
00358                 Entry = CONTAINING_RECORD( Next,
00359                                            <a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html">MMSECURE_ENTRY</a>,
00360                                            <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>);
00361 
00362                 Next = Entry-&gt;<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o5">List</a>.Flink;
00363                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Entry);
00364             } <span class="keywordflow">while</span> (Next != &amp;Vad-&gt;u3.List);
00365         }
00366     }
00367 
00368     <span class="comment">//</span>
00369     <span class="comment">// If the VadHint was the removed Vad, change the Hint.</span>
00370 
00371     <span class="keywordflow">if</span> (CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o39">VadHint</a> == Vad) {
00372         CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o39">VadHint</a> = CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o38">VadRoot</a>;
00373     }
00374 
00375     <span class="keywordflow">return</span>;
00376 }
00377 
00378 <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>
00379 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l00380"></a><a class="code" href="../../d6/d3/vadtree_8c.html#a2">00380</a> <a class="code" href="../../d6/d3/vadtree_8c.html#a2">MiLocateAddress</a> (
00381     IN PVOID VirtualAddress
00382     )
00383 
00384 <span class="comment">/*++</span>
00385 <span class="comment"></span>
00386 <span class="comment">Routine Description:</span>
00387 <span class="comment"></span>
00388 <span class="comment">    The function locates the virtual address descriptor which describes</span>
00389 <span class="comment">    a given address.</span>
00390 <span class="comment"></span>
00391 <span class="comment">Arguments:</span>
00392 <span class="comment"></span>
00393 <span class="comment">    VirtualAddress - Supplies the virtual address to locate a descriptor</span>
00394 <span class="comment">                     for.</span>
00395 <span class="comment"></span>
00396 <span class="comment">Return Value:</span>
00397 <span class="comment"></span>
00398 <span class="comment">    Returns a pointer to the virtual address descriptor which contains</span>
00399 <span class="comment">    the supplied virtual address or NULL if none was located.</span>
00400 <span class="comment"></span>
00401 <span class="comment">--*/</span>
00402 
00403 {
00404     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> FoundVad;
00405     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess;
00406     ULONG_PTR Vpn;
00407 
00408     CurrentProcess = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
00409 
00410     <span class="keywordflow">if</span> (CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o39">VadHint</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00411         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00412     }
00413 
00414     Vpn = <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (VirtualAddress);
00415     <span class="keywordflow">if</span> ((Vpn &gt;= ((<a class="code" href="../../d9/d0/struct__MMADDRESS__NODE.html">PMMADDRESS_NODE</a>)CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o39">VadHint</a>)-&gt;StartingVpn) &amp;&amp;
00416         (Vpn &lt;= ((<a class="code" href="../../d9/d0/struct__MMADDRESS__NODE.html">PMMADDRESS_NODE</a>)CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o39">VadHint</a>)-&gt;EndingVpn)) {
00417 
00418         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o39">VadHint</a>;
00419     }
00420 
00421     FoundVad = (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)<a class="code" href="../../d4/d8/mi_8h.html#a844">MiLocateAddressInTree</a> ( Vpn,
00422                    (<a class="code" href="../../d9/d0/struct__MMADDRESS__NODE.html">PMMADDRESS_NODE</a> *)&amp;(CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o38">VadRoot</a>));
00423 
00424     <span class="keywordflow">if</span> (FoundVad != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00425         CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o39">VadHint</a> = (PVOID)FoundVad;
00426     }
00427     <span class="keywordflow">return</span> FoundVad;
00428 }
00429 
00430 PVOID
<a name="l00431"></a><a class="code" href="../../d6/d3/vadtree_8c.html#a3">00431</a> <a class="code" href="../../d6/d3/vadtree_8c.html#a3">MiFindEmptyAddressRange</a> (
00432     IN SIZE_T SizeOfRange,
00433     IN ULONG_PTR Alignment,
00434     IN ULONG QuickCheck
00435     )
00436 
00437 <span class="comment">/*++</span>
00438 <span class="comment"></span>
00439 <span class="comment">Routine Description:</span>
00440 <span class="comment"></span>
00441 <span class="comment">    The function examines the virtual address descriptors to locate</span>
00442 <span class="comment">    an unused range of the specified size and returns the starting</span>
00443 <span class="comment">    address of the range.</span>
00444 <span class="comment"></span>
00445 <span class="comment">Arguments:</span>
00446 <span class="comment"></span>
00447 <span class="comment">    SizeOfRange - Supplies the size in bytes of the range to locate.</span>
00448 <span class="comment"></span>
00449 <span class="comment">    Alignment - Supplies the alignment for the address.  Must be</span>
00450 <span class="comment">                 a power of 2 and greater than the page_size.</span>
00451 <span class="comment"></span>
00452 <span class="comment">    QuickCheck - Supplies a zero if a quick check for free memory</span>
00453 <span class="comment">                 after the VadFreeHint exists, non-zero if checking</span>
00454 <span class="comment">                 should start at the lowest address.</span>
00455 <span class="comment"></span>
00456 <span class="comment">Return Value:</span>
00457 <span class="comment"></span>
00458 <span class="comment">    Returns the starting address of a suitable range.</span>
00459 <span class="comment"></span>
00460 <span class="comment">--*/</span>
00461 
00462 {
00463     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> NextVad;
00464     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> FreeHint;
00465     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess;
00466     PVOID StartingVa;
00467     PVOID EndingVa;
00468 
00469     CurrentProcess = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
00470     FreeHint = CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o57">VadFreeHint</a>;
00471 
00472     <span class="keywordflow">if</span> ((QuickCheck == 0) &amp;&amp; (FreeHint != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00473 
00474         EndingVa = <a class="code" href="../../d4/d8/mi_8h.html#a109">MI_VPN_TO_VA_ENDING</a> (FreeHint-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a>);
00475         NextVad = <a class="code" href="../../d4/d8/mi_8h.html#a96">MiGetNextVad</a> (FreeHint);
00476         <span class="keywordflow">if</span> (NextVad == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00477 
00478             <span class="keywordflow">if</span> (SizeOfRange &lt;
00479                 (((ULONG_PTR)MM_HIGHEST_USER_ADDRESS + 1) -
00480                          <a class="code" href="../../d4/d8/mi_8h.html#a90">MI_ROUND_TO_SIZE</a>((ULONG_PTR)EndingVa, Alignment))) {
00481                 <span class="keywordflow">return</span> (<a class="code" href="../../d9/d0/struct__MMADDRESS__NODE.html">PMMADDRESS_NODE</a>)<a class="code" href="../../d4/d8/mi_8h.html#a90">MI_ROUND_TO_SIZE</a>((ULONG_PTR)EndingVa,
00482                                                          Alignment);
00483             }
00484         } <span class="keywordflow">else</span> {
00485             StartingVa = <a class="code" href="../../d4/d8/mi_8h.html#a108">MI_VPN_TO_VA</a> (NextVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a>);
00486 
00487             <span class="keywordflow">if</span> (SizeOfRange &lt;
00488                 ((ULONG_PTR)StartingVa -
00489                          <a class="code" href="../../d4/d8/mi_8h.html#a90">MI_ROUND_TO_SIZE</a>((ULONG_PTR)EndingVa, Alignment))) {
00490 
00491                 <span class="comment">//</span>
00492                 <span class="comment">// Check to ensure that the ending address aligned upwards</span>
00493                 <span class="comment">// is not greater than the starting address.</span>
00494                 <span class="comment">//</span>
00495 
00496                 <span class="keywordflow">if</span> ((ULONG_PTR)StartingVa &gt;
00497                          <a class="code" href="../../d4/d8/mi_8h.html#a90">MI_ROUND_TO_SIZE</a>((ULONG_PTR)EndingVa,Alignment)) {
00498                     <span class="keywordflow">return</span> (<a class="code" href="../../d9/d0/struct__MMADDRESS__NODE.html">PMMADDRESS_NODE</a>)<a class="code" href="../../d4/d8/mi_8h.html#a90">MI_ROUND_TO_SIZE</a>((ULONG_PTR)EndingVa,
00499                                                            Alignment);
00500                 }
00501             }
00502         }
00503     }
00504 
00505     <span class="keywordflow">return</span> (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)<a class="code" href="../../d4/d8/mi_8h.html#a846">MiFindEmptyAddressRangeInTree</a> (
00506                    SizeOfRange,
00507                    Alignment,
00508                    (<a class="code" href="../../d9/d0/struct__MMADDRESS__NODE.html">PMMADDRESS_NODE</a>)(CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o38">VadRoot</a>),
00509                    (<a class="code" href="../../d9/d0/struct__MMADDRESS__NODE.html">PMMADDRESS_NODE</a> *)&amp;CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o57">VadFreeHint</a>);
00510 
00511 }
00512 
00513 <span class="preprocessor">#if DBG</span>
00514 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00515 <a class="code" href="../../d5/d5/sectsup_8c.html#a12">VadTreeWalk</a> (
00516     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Start
00517     )
00518 
00519 {
00520     UNREFERENCED_PARAMETER (Start);
00521 
00522     <a class="code" href="../../d4/d8/mi_8h.html#a848">NodeTreeWalk</a> ( (<a class="code" href="../../d9/d0/struct__MMADDRESS__NODE.html">PMMADDRESS_NODE</a>)(<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;VadRoot));
00523 
00524     <span class="keywordflow">return</span>;
00525 }
00526 <span class="preprocessor">#endif //DBG</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:42:20 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
