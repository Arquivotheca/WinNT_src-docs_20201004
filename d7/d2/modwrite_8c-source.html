<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: modwrite.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>modwrite.c</h1><a href="../../d6/d3/modwrite_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    modwrite.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains the modified page writer for memory management.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Lou Perazzoli (loup) 10-Jun-1989</span>
00016 <span class="comment">    Landy Wang (landyw) 02-Jun-1997</span>
00017 <span class="comment"></span>
00018 <span class="comment">Revision History:</span>
00019 <span class="comment"></span>
00020 <span class="comment">--*/</span>
00021 
00022 <span class="preprocessor">#include "<a class="code" href="../../d4/d8/mi_8h.html">mi.h</a>"</span>
00023 
<a name="l00024"></a><a class="code" href="../../d6/d3/modwrite_8c.html#a60">00024</a> <span class="keyword">typedef</span> <span class="keyword">enum</span> <a class="code" href="../../d6/d3/modwrite_8c.html#a60">_MODIFIED_WRITER_OBJECT</a> {
00025     <a class="code" href="../../d6/d3/modwrite_8c.html#a60a26">NormalCase</a>,
00026     <a class="code" href="../../d6/d3/modwrite_8c.html#a60a27">MappedPagesNeedWriting</a>,
00027     <a class="code" href="../../d6/d3/modwrite_8c.html#a60a28">ModifiedWriterMaximumObject</a>
00028 } <a class="code" href="../../d6/d3/modwrite_8c.html#a4">MODIFIED_WRITER_OBJECT</a>;
00029 
<a name="l00030"></a><a class="code" href="../../d6/d7/struct__MMWORK__CONTEXT.html">00030</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d6/d7/struct__MMWORK__CONTEXT.html">_MMWORK_CONTEXT</a> {
<a name="l00031"></a><a class="code" href="../../d6/d7/struct__MMWORK__CONTEXT.html#o0">00031</a>     LARGE_INTEGER <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
<a name="l00032"></a><a class="code" href="../../d6/d7/struct__MMWORK__CONTEXT.html#o1">00032</a>     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d6/d7/struct__MMWORK__CONTEXT.html#o1">Status</a>;
<a name="l00033"></a><a class="code" href="../../d6/d7/struct__MMWORK__CONTEXT.html#o2">00033</a>     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> <a class="code" href="../../d6/d7/struct__MMWORK__CONTEXT.html#o2">Event</a>;
00034 } <a class="code" href="../../d6/d7/struct__MMWORK__CONTEXT.html">MMWORK_CONTEXT</a>, *<a class="code" href="../../d6/d7/struct__MMWORK__CONTEXT.html">PMMWORK_CONTEXT</a>;
00035 
<a name="l00036"></a><a class="code" href="../../d7/d0/struct__MM__WRITE__CLUSTER.html">00036</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d7/d0/struct__MM__WRITE__CLUSTER.html">_MM_WRITE_CLUSTER</a> {
<a name="l00037"></a><a class="code" href="../../d7/d0/struct__MM__WRITE__CLUSTER.html#o0">00037</a>     ULONG <a class="code" href="../../d7/d0/struct__MM__WRITE__CLUSTER.html#o0">Count</a>;
<a name="l00038"></a><a class="code" href="../../d7/d0/struct__MM__WRITE__CLUSTER.html#o1">00038</a>     ULONG <a class="code" href="../../d7/d0/struct__MM__WRITE__CLUSTER.html#o1">StartIndex</a>;
<a name="l00039"></a><a class="code" href="../../d7/d0/struct__MM__WRITE__CLUSTER.html#o2">00039</a>     ULONG <a class="code" href="../../d7/d0/struct__MM__WRITE__CLUSTER.html#o2">Cluster</a>[2 * (<a class="code" href="../../d2/d1/mm_8h.html#a3">MM_MAXIMUM_DISK_IO_SIZE</a> / <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) + 1];
00040 } <a class="code" href="../../d7/d0/struct__MM__WRITE__CLUSTER.html">MM_WRITE_CLUSTER</a>, *<a class="code" href="../../d7/d0/struct__MM__WRITE__CLUSTER.html">PMM_WRITE_CLUSTER</a>;
00041 
<a name="l00042"></a><a class="code" href="../../d6/d3/modwrite_8c.html#a9">00042</a> ULONG <a class="code" href="../../d6/d3/modwrite_8c.html#a9">MmWriteAllModifiedPages</a>;
<a name="l00043"></a><a class="code" href="../../d6/d3/modwrite_8c.html#a10">00043</a> LOGICAL <a class="code" href="../../d6/d3/modwrite_8c.html#a10">MiFirstPageFileCreatedAndReady</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00044 
<a name="l00045"></a><a class="code" href="../../d6/d3/modwrite_8c.html#a0">00045</a> <span class="preprocessor">#define ONEMB_IN_PAGES  ((1024 * 1024) / PAGE_SIZE)</span>
00046 <span class="preprocessor"></span>
00047 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00048 <a class="code" href="../../d6/d3/modwrite_8c.html#a29">MiCheckForCrashDump</a> (
00049     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> File,
00050     IN ULONG FileNumber
00051     );
00052 
00053 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00054 <a class="code" href="../../d6/d3/modwrite_8c.html#a30">MiCrashDumpWorker</a> (
00055     IN PVOID Context
00056     );
00057 
00058 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00059 <a class="code" href="../../d6/d3/modwrite_8c.html#a31">MiClusterWritePages</a> (
00060     IN <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1,
00061     IN PFN_NUMBER PageFrameIndex,
00062     IN PMM_WRITE_CLUSTER WriteCluster,
00063     IN ULONG Size
00064     );
00065 
00066 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00067 <a class="code" href="../../d6/d3/modwrite_8c.html#a32">MiExtendPagingFileMaximum</a> (
00068     IN ULONG PageFileNumber,
00069     IN PRTL_BITMAP NewBitmap
00070     );
00071 
00072 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00073 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtCreatePagingFile)</span>
00074 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,MmGetPageFileInformation)</span>
00075 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,MiModifiedPageWriter)</span>
00076 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,MiCheckForCrashDump)</span>
00077 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,MmGetCrashDumpInformation)</span>
00078 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,MiCrashDumpWorker)</span>
00079 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGELK,MiFlushAllPages)</span>
00080 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00081 <span class="preprocessor"></span>
00082 
<a name="l00083"></a><a class="code" href="../../d6/d3/modwrite_8c.html#a11">00083</a> <a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a> <a class="code" href="../../d6/d3/modwrite_8c.html#a11">MmCrashDumpSection</a>;
00084 
<a name="l00085"></a><a class="code" href="../../d6/d3/modwrite_8c.html#a12">00085</a> <span class="keyword">extern</span> <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> <a class="code" href="../../d5/d8/fssup_8c.html#a3">IoFileObjectType</a>;
<a name="l00086"></a><a class="code" href="../../d6/d3/modwrite_8c.html#a13">00086</a> <span class="keyword">extern</span> HANDLE <a class="code" href="../../d6/d3/modwrite_8c.html#a13">PspInitialSystemProcessHandle</a>;
00087 
<a name="l00088"></a><a class="code" href="../../d6/d3/modwrite_8c.html#a14">00088</a> LIST_ENTRY <a class="code" href="../../d6/d3/modwrite_8c.html#a14">MmMappedPageWriterList</a>;
00089 
<a name="l00090"></a><a class="code" href="../../d6/d3/modwrite_8c.html#a15">00090</a> <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> <a class="code" href="../../d6/d3/modwrite_8c.html#a15">MmMappedPageWriterEvent</a>;
00091 
<a name="l00092"></a><a class="code" href="../../d6/d3/modwrite_8c.html#a16">00092</a> <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> <a class="code" href="../../d4/d8/mi_8h.html#a614">MmMappedFileIoComplete</a>;
00093 
<a name="l00094"></a><a class="code" href="../../d6/d3/modwrite_8c.html#a17">00094</a> ULONG <a class="code" href="../../d6/d3/modwrite_8c.html#a17">MmSystemShutdown</a>;
00095 
<a name="l00096"></a><a class="code" href="../../d6/d3/modwrite_8c.html#a18">00096</a> SIZE_T <a class="code" href="../../d6/d3/modwrite_8c.html#a18">MmOverCommit2</a>;
00097 
<a name="l00098"></a><a class="code" href="../../d6/d3/modwrite_8c.html#a19">00098</a> SIZE_T <a class="code" href="../../d6/d1/mmquota_8c.html#a9">MmPageFileFullExtendPages</a>;
00099 
<a name="l00100"></a><a class="code" href="../../d6/d3/modwrite_8c.html#a20">00100</a> ULONG <a class="code" href="../../d6/d3/modwrite_8c.html#a20">MmPageFileFullExtendCount</a>;
00101 
<a name="l00102"></a><a class="code" href="../../d6/d3/modwrite_8c.html#a1">00102</a> <span class="preprocessor">#define MI_PAGEFILE_FULL_CHARGE 100</span>
00103 <span class="preprocessor"></span>
<a name="l00104"></a><a class="code" href="../../d6/d3/modwrite_8c.html#a21">00104</a> SIZE_T <a class="code" href="../../d6/d3/modwrite_8c.html#a21">MiPageFileFullCharge</a>;
00105 
<a name="l00106"></a><a class="code" href="../../d6/d3/modwrite_8c.html#a22">00106</a> LOGICAL <a class="code" href="../../d6/d3/modwrite_8c.html#a22">MmPageFileFullPopupShown</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00107 
<a name="l00108"></a><a class="code" href="../../d6/d3/modwrite_8c.html#a23">00108</a> ULONG <a class="code" href="../../d4/d8/mi_8h.html#a608">MmModNoWriteInsert</a>;
00109 
<a name="l00110"></a><a class="code" href="../../d6/d3/modwrite_8c.html#a24">00110</a> BOOLEAN <a class="code" href="../../d6/d3/modwrite_8c.html#a24">MmSystemPageFileLocated</a>;
00111 
00112 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00113 <a class="code" href="../../d6/d3/modwrite_8c.html#a33">MiCheckPageFileMapping</a> (
00114     IN <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> File
00115     );
00116 
00117 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00118 <a class="code" href="../../d6/d3/modwrite_8c.html#a34">MiInsertPageFileInList</a> (
00119     VOID
00120     );
00121 
00122 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00123 <a class="code" href="../../d6/d3/modwrite_8c.html#a35">MiGatherMappedPages</a> (
00124     IN <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1,
00125     IN PFN_NUMBER PageFrameIndex
00126     );
00127 
00128 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00129 <a class="code" href="../../d6/d3/modwrite_8c.html#a36">MiGatherPagefilePages</a> (
00130     IN <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1,
00131     IN PFN_NUMBER PageFrameIndex
00132     );
00133 
00134 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00135 <a class="code" href="../../d6/d3/modwrite_8c.html#a56">MiPageFileFull</a> (
00136     VOID
00137     );
00138 
00139 LOGICAL
00140 <a class="code" href="../../d6/d3/modwrite_8c.html#a38">MiCauseOverCommitPopup</a>(
00141     IN SIZE_T NumberOfPages,
00142     IN ULONG Extension
00143     );
00144 
00145 <span class="preprocessor">#if DBG</span>
00146 <span class="preprocessor"></span>ULONG_PTR <a class="code" href="../../d4/d8/mi_8h.html#a686">MmPagingFileDebug</a>[8192];
00147 <span class="preprocessor">#endif</span>
00148 <span class="preprocessor"></span>
<a name="l00149"></a><a class="code" href="../../d6/d3/modwrite_8c.html#a25">00149</a> <span class="keyword">extern</span> PFN_NUMBER <a class="code" href="../../d4/d8/mi_8h.html#a588">MmMoreThanEnoughFreePages</a>;
00150 
<a name="l00151"></a><a class="code" href="../../d6/d3/modwrite_8c.html#a2">00151</a> <span class="preprocessor">#define MINIMUM_PAGE_FILE_SIZE ((ULONG)(256*PAGE_SIZE))</span>
00152 <span class="preprocessor"></span>
00153 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00154 <a class="code" href="../../d6/d3/modwrite_8c.html#a39">MiModifiedPageWriterWorker</a> (
00155     VOID
00156     );
00157 
00158 SIZE_T
00159 <a class="code" href="../../d6/d3/modwrite_8c.html#a40">MiAttemptPageFileExtension</a> (
00160     IN ULONG PageFileNumber,
00161     IN SIZE_T ExtendSize,
00162     IN SIZE_T Maximum
00163     );
00164 
00165 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00166"></a><a class="code" href="../../d8/d8/sysload_8c.html#a50">00166</a> <a class="code" href="../../d8/d8/sysload_8c.html#a50">MiCheckPageFilePath</a> (
00167     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject
00168     )
00169 {
00170     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
00171     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00172     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
00173     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> event;
00174     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
00175     IO_STATUS_BLOCK localIoStatus;
00176 
00177     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00178 
00179     <span class="comment">//</span>
00180     <span class="comment">// Reference the file object here so that no special checks need be made</span>
00181     <span class="comment">// in I/O completion to determine whether or not to dereference the file</span>
00182     <span class="comment">// object.</span>
00183     <span class="comment">//</span>
00184 
00185     <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>( FileObject );
00186 
00187     <span class="comment">//</span>
00188     <span class="comment">// Initialize the local event.</span>
00189     <span class="comment">//</span>
00190 
00191     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;event, SynchronizationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00192 
00193     <span class="comment">//</span>
00194     <span class="comment">// Get the address of the target device object.</span>
00195     <span class="comment">//</span>
00196 
00197     deviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( FileObject );
00198 
00199     <span class="comment">//</span>
00200     <span class="comment">// Allocate and initialize the I/O Request Packet (IRP) for this operation.</span>
00201     <span class="comment">//</span>
00202 
00203     irp = <a class="code" href="../../d4/d6/iosubs_8c.html#a17">IoAllocateIrp</a>( deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o13">StackSize</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00204     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( irp != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00205 
00206     <span class="keywordflow">if</span> (irp == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00207 
00208         <span class="comment">//</span>
00209         <span class="comment">// Don't dereference the file object, our caller will take care of that.</span>
00210         <span class="comment">//</span>
00211 
00212         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00213     }
00214 
00215     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.OriginalFileObject = FileObject;
00216     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00217     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o10">RequestorMode</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>;
00218 
00219     <span class="comment">//</span>
00220     <span class="comment">// Fill in the service independent parameters in the IRP.</span>
00221     <span class="comment">//</span>
00222 
00223     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a> = &amp;event;
00224     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> = <a class="code" href="../../d0/d5/io_8h.html#a176">IRP_SYNCHRONOUS_API</a>;
00225     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a> = &amp;localIoStatus;
00226     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o24">Overlay</a>.AsynchronousParameters.UserApcRoutine = (PIO_APC_ROUTINE) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00227 
00228     <span class="comment">//</span>
00229     <span class="comment">// Get a pointer to the stack location for the first driver.  This will be</span>
00230     <span class="comment">// used to pass the original function codes and parameters.</span>
00231     <span class="comment">//</span>
00232 
00233     irpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( irp );
00234     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a>;
00235     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a86">IRP_MN_DEVICE_USAGE_NOTIFICATION</a>;
00236     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a> = FileObject;
00237     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = STATUS_NOT_SUPPORTED;
00238     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00239     <span class="comment">// irp-&gt;Flags = 0;</span>
00240 
00241     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.UsageNotification.InPath = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00242     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.UsageNotification.Type = <a class="code" href="../../d0/d5/io_8h.html#a603a418">DeviceUsageTypePaging</a>;
00243 
00244     <span class="comment">//</span>
00245     <span class="comment">// Insert the packet at the head of the IRP list for the thread.</span>
00246     <span class="comment">//</span>
00247 
00248     <a class="code" href="../../d4/d6/iosubs_8c.html#a92">IoQueueThreadIrp</a>( irp );
00249 
00250     <span class="comment">//</span>
00251     <span class="comment">// Now simply invoke the driver at its dispatch entry with the IRP.</span>
00252     <span class="comment">//</span>
00253 
00254     status = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( deviceObject, irp );
00255 
00256     <span class="comment">//</span>
00257     <span class="comment">// Wait for the local event and copy the final status information</span>
00258     <span class="comment">// back to the caller.</span>
00259     <span class="comment">//</span>
00260 
00261     <span class="keywordflow">if</span> (status == STATUS_PENDING) {
00262         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;event,
00263                                       <a class="code" href="../../d6/d7/halmips_8h.html#a455">Executive</a>,
00264                                       <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00265                                       <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00266                                       (PLARGE_INTEGER) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00267         status = localIoStatus.Status;
00268     }
00269 
00270     <span class="keywordflow">return</span> status;
00271 }
00272 
00273 
00274 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00275"></a><a class="code" href="../../d6/d3/modwrite_8c.html#a42">00275</a> <a class="code" href="../../d6/d3/modwrite_8c.html#a42">MiReleaseModifiedWriter</a> (
00276     VOID
00277     )
00278 
00279 <span class="comment">/*++</span>
00280 <span class="comment"></span>
00281 <span class="comment">Routine Description:</span>
00282 <span class="comment"></span>
00283 <span class="comment">    Nonpagable wrapper to signal the modified writer when the first pagefile</span>
00284 <span class="comment">    creation has completely finished.</span>
00285 <span class="comment"></span>
00286 <span class="comment">--*/</span>
00287  
00288 {
00289     KIRQL OldIrql;
00290     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00291     <a class="code" href="../../d6/d3/modwrite_8c.html#a10">MiFirstPageFileCreatedAndReady</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00292     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00293 }
00294 
00295 
00296 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00297"></a><a class="code" href="../../d6/d3/modwrite_8c.html#a43">00297</a> <a class="code" href="../../d6/d3/modwrite_8c.html#a43">NtCreatePagingFile</a> (
00298     IN PUNICODE_STRING PageFileName,
00299     IN PLARGE_INTEGER MinimumSize,
00300     IN PLARGE_INTEGER MaximumSize,
00301     IN ULONG Priority OPTIONAL
00302     )
00303 
00304 <span class="comment">/*++</span>
00305 <span class="comment"></span>
00306 <span class="comment">Routine Description:</span>
00307 <span class="comment"></span>
00308 <span class="comment">    This routine opens the specified file, attempts to write a page</span>
00309 <span class="comment">    to the specified file, and creates the necessary structures to</span>
00310 <span class="comment">    use the file as a paging file.</span>
00311 <span class="comment"></span>
00312 <span class="comment">    If this file is the first paging file, the modified page writer</span>
00313 <span class="comment">    is started.</span>
00314 <span class="comment"></span>
00315 <span class="comment">    This system service requires the caller to have SeCreatePagefilePrivilege.</span>
00316 <span class="comment"></span>
00317 <span class="comment">Arguments:</span>
00318 <span class="comment"></span>
00319 <span class="comment">    PageFileName - Supplies the fully qualified file name.</span>
00320 <span class="comment"></span>
00321 <span class="comment">    MinimumSize - Supplies the starting size of the paging file.</span>
00322 <span class="comment">                  This value is rounded up to the host page size.</span>
00323 <span class="comment"></span>
00324 <span class="comment">    MaximumSize - Supplies the maximum number of bytes to write to the file.</span>
00325 <span class="comment">                  This value is rounded up to the host page size.</span>
00326 <span class="comment"></span>
00327 <span class="comment">    Priority - Supplies the relative priority of this paging file.</span>
00328 <span class="comment"></span>
00329 <span class="comment">Return Value:</span>
00330 <span class="comment"></span>
00331 <span class="comment">    tbs</span>
00332 <span class="comment"></span>
00333 <span class="comment">--*/</span>
00334 
00335 {
00336     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>;
00337     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00338     OBJECT_ATTRIBUTES PagingFileAttributes;
00339     HANDLE FileHandle;
00340     IO_STATUS_BLOCK IoStatus;
00341     UNICODE_STRING CapturedName;
00342     PWSTR CapturedBuffer;
00343     LARGE_INTEGER CapturedMaximumSize;
00344     LARGE_INTEGER CapturedMinimumSize;
00345     LARGE_INTEGER SpecifiedSize;
00346     FILE_END_OF_FILE_INFORMATION EndOfFileInformation;
00347     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00348     BOOLEAN Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00349     BOOLEAN HasPrivilege;
00350     HANDLE SystemProcess;
00351     FILE_FS_DEVICE_INFORMATION FileDeviceInfo;
00352     ULONG ReturnedLength;
00353     ULONG FinalStatus;
00354     ULONG PageFileNumber;
00355     ULONG NewMaxSizeInPages;
00356     ULONG NewMinSizeInPages;
00357     <a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html">PMMPAGING_FILE</a> FoundExisting;
00358     PRTL_BITMAP NewBitmap;
00359     PRTL_BITMAP OldBitmap;
00360     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
00361     <a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html">MMPAGE_FILE_EXPANSION</a> PageExtend;
00362 
00363     DBG_UNREFERENCED_PARAMETER (Priority);
00364 
00365     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00366 
00367     CapturedBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00368 
00369     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a> == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a48">MAX_PAGE_FILES</a>) {
00370 
00371         <span class="comment">//</span>
00372         <span class="comment">// The maximum number of paging files is already in use.</span>
00373         <span class="comment">//</span>
00374 
00375         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_TOO_MANY_PAGING_FILES;
00376         <span class="keywordflow">goto</span> ErrorReturn0;
00377     }
00378 
00379     PreviousMode = KeGetPreviousMode();
00380 
00381     <span class="keywordflow">try</span> {
00382 
00383         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00384 
00385             <span class="comment">//</span>
00386             <span class="comment">// Make sure the caller has the proper privilege to make</span>
00387             <span class="comment">// this call.</span>
00388             <span class="comment">//</span>
00389 
00390             HasPrivilege = <a class="code" href="../../d8/d4/privileg_8c.html#a3">SeSinglePrivilegeCheck</a> (<a class="code" href="../../d0/d5/se_8h.html#a88">SeCreatePagefilePrivilege</a>,
00391                                                    PreviousMode
00392                                                    );
00393 
00394             <span class="keywordflow">if</span> (!HasPrivilege) {
00395 
00396                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_PRIVILEGE_NOT_HELD;
00397                 <span class="keywordflow">goto</span> ErrorReturn0;
00398             }
00399 
00400             <span class="comment">//</span>
00401             <span class="comment">// Probe arguments.</span>
00402             <span class="comment">//</span>
00403 
00404             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( PageFileName, <span class="keyword">sizeof</span>(*PageFileName), <span class="keyword">sizeof</span>(UCHAR));
00405             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( MaximumSize, <span class="keyword">sizeof</span>(LARGE_INTEGER), 4);
00406             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( MinimumSize, <span class="keyword">sizeof</span>(LARGE_INTEGER), 4);
00407         }
00408 
00409         <span class="comment">//</span>
00410         <span class="comment">// Capture arguments.</span>
00411         <span class="comment">//</span>
00412 
00413         CapturedMinimumSize = *MinimumSize;
00414 
00415 <span class="preprocessor">#if defined (_WIN64) || defined (_X86PAE_)</span>
00416 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (CapturedMinimumSize.QuadPart &lt; <a class="code" href="../../d6/d3/modwrite_8c.html#a2">MINIMUM_PAGE_FILE_SIZE</a>) {
00417             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER_2;
00418             <span class="keywordflow">goto</span> ErrorReturn0;
00419         }
00420 
00421         SpecifiedSize.QuadPart = (<a class="code" href="../../d2/d1/mm_8h.html#a4">ROUND_TO_PAGES</a> (CapturedMinimumSize.QuadPart)) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
00422 
00423         <span class="keywordflow">if</span> (SpecifiedSize.HighPart != 0) {
00424             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER_2;
00425             <span class="keywordflow">goto</span> ErrorReturn0;
00426         }
00427 <span class="preprocessor">#else</span>
00428 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ((CapturedMinimumSize.HighPart != 0) ||
00429             (CapturedMinimumSize.LowPart &lt; <a class="code" href="../../d6/d3/modwrite_8c.html#a2">MINIMUM_PAGE_FILE_SIZE</a>)) {
00430             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER_2;
00431             <span class="keywordflow">goto</span> ErrorReturn0;
00432         }
00433 <span class="preprocessor">#endif</span>
00434 <span class="preprocessor"></span>
00435         CapturedMaximumSize = *MaximumSize;
00436 
00437 <span class="preprocessor">#if defined (_WIN64) || defined (_X86PAE_)</span>
00438 <span class="preprocessor"></span>        SpecifiedSize.QuadPart = (<a class="code" href="../../d2/d1/mm_8h.html#a4">ROUND_TO_PAGES</a> (CapturedMaximumSize.QuadPart)) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
00439 
00440         <span class="keywordflow">if</span> (SpecifiedSize.HighPart != 0) {
00441             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER_3;
00442             <span class="keywordflow">goto</span> ErrorReturn0;
00443         }
00444 <span class="preprocessor">#else</span>
00445 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (CapturedMaximumSize.HighPart != 0) {
00446             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER_3;
00447             <span class="keywordflow">goto</span> ErrorReturn0;
00448         }
00449 <span class="preprocessor">#endif</span>
00450 <span class="preprocessor"></span>
00451         <span class="keywordflow">if</span> (CapturedMinimumSize.QuadPart &gt; CapturedMaximumSize.QuadPart) {
00452             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER_3;
00453             <span class="keywordflow">goto</span> ErrorReturn0;
00454         }
00455 
00456         CapturedName = *PageFileName;
00457         CapturedName.MaximumLength = CapturedName.Length;
00458 
00459         <span class="keywordflow">if</span> ((CapturedName.Length == 0) ||
00460             (CapturedName.Length &gt; MAXIMUM_FILENAME_LENGTH )) {
00461             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OBJECT_NAME_INVALID;
00462             <span class="keywordflow">goto</span> ErrorReturn0;
00463         }
00464 
00465         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00466             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a> (CapturedName.Buffer,
00467                           CapturedName.Length,
00468                           <span class="keyword">sizeof</span>( UCHAR ));
00469         }
00470 
00471         CapturedBuffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00472                                                 (ULONG)CapturedName.Length,
00473                                                 '  mM');
00474 
00475         <span class="keywordflow">if</span> (CapturedBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00476             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00477             <span class="keywordflow">goto</span> ErrorReturn0;
00478         }
00479 
00480         <span class="comment">//</span>
00481         <span class="comment">// Copy the string to the allocated buffer.</span>
00482         <span class="comment">//</span>
00483 
00484         RtlMoveMemory (CapturedBuffer,
00485                        CapturedName.Buffer,
00486                        CapturedName.Length);
00487 
00488         <span class="comment">//</span>
00489         <span class="comment">// Point the buffer to the string that was just copied.</span>
00490         <span class="comment">//</span>
00491 
00492         CapturedName.Buffer = CapturedBuffer;
00493 
00494     } except (<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00495 
00496         <span class="comment">//</span>
00497         <span class="comment">// If an exception occurs during the probe or capture</span>
00498         <span class="comment">// of the initial values, then handle the exception and</span>
00499         <span class="comment">// return the exception code as the status value.</span>
00500         <span class="comment">//</span>
00501 
00502         <span class="keywordflow">if</span> (CapturedBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00503             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (CapturedBuffer);
00504         }
00505 
00506         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00507         <span class="keywordflow">goto</span> ErrorReturn0;
00508     }
00509 
00510     <span class="comment">//</span>
00511     <span class="comment">// Open a paging file and get the size.</span>
00512     <span class="comment">//</span>
00513 
00514     InitializeObjectAttributes( &amp;PagingFileAttributes,
00515                                 &amp;CapturedName,
00516                                 OBJ_CASE_INSENSITIVE,
00517                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00518                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00519 
00520 <span class="preprocessor">#if defined (_WIN64) || defined (_X86PAE_)</span>
00521 <span class="preprocessor"></span>    EndOfFileInformation.EndOfFile.QuadPart =
00522                                 <a class="code" href="../../d2/d1/mm_8h.html#a4">ROUND_TO_PAGES</a> (CapturedMinimumSize.QuadPart);
00523 <span class="preprocessor">#else</span>
00524 <span class="preprocessor"></span>    EndOfFileInformation.EndOfFile.HighPart = 0;
00525 <span class="preprocessor">#endif</span>
00526 <span class="preprocessor"></span>    EndOfFileInformation.EndOfFile.LowPart = (ULONG)
00527                                 <a class="code" href="../../d2/d1/mm_8h.html#a4">ROUND_TO_PAGES</a> (CapturedMinimumSize.LowPart);
00528 
00529     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d6/iosubs_8c.html#a46">IoCreateFile</a>( &amp;FileHandle,
00530                            FILE_READ_DATA | FILE_WRITE_DATA | SYNCHRONIZE,
00531                            &amp;PagingFileAttributes,
00532                            &amp;IoStatus,
00533                            &amp;CapturedMinimumSize,
00534                            FILE_ATTRIBUTE_HIDDEN | FILE_ATTRIBUTE_SYSTEM,
00535                            FILE_SHARE_WRITE,
00536                            FILE_SUPERSEDE,
00537                            FILE_NO_INTERMEDIATE_BUFFERING | FILE_NO_COMPRESSION,
00538                            (PVOID) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00539                            0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
00540                            <a class="code" href="../../d0/d5/io_8h.html#a600a406">CreateFileTypeNone</a>,
00541                            (PVOID) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00542                            <a class="code" href="../../d0/d5/io_8h.html#a105">IO_OPEN_PAGING_FILE</a> | <a class="code" href="../../d0/d5/io_8h.html#a107">IO_NO_PARAMETER_CHECKING</a> );
00543 
00544     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00545 
00546         <span class="comment">//</span>
00547         <span class="comment">// Treat this as an extension of an existing pagefile maximum -</span>
00548         <span class="comment">// and try to open rather than create the paging file specified.</span>
00549         <span class="comment">//</span>
00550 
00551         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d6/iosubs_8c.html#a46">IoCreateFile</a>( &amp;FileHandle,
00552                            FILE_WRITE_DATA | SYNCHRONIZE,
00553                            &amp;PagingFileAttributes,
00554                            &amp;IoStatus,
00555                            &amp;CapturedMinimumSize,
00556                            FILE_ATTRIBUTE_HIDDEN | FILE_ATTRIBUTE_SYSTEM,
00557                            FILE_SHARE_READ | FILE_SHARE_WRITE,
00558                            FILE_OPEN,
00559                            FILE_NO_INTERMEDIATE_BUFFERING | FILE_NO_COMPRESSION,
00560                            (PVOID) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00561                            0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
00562                            <a class="code" href="../../d0/d5/io_8h.html#a600a406">CreateFileTypeNone</a>,
00563                            (PVOID) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00564                            <a class="code" href="../../d0/d5/io_8h.html#a105">IO_OPEN_PAGING_FILE</a> | <a class="code" href="../../d0/d5/io_8h.html#a107">IO_NO_PARAMETER_CHECKING</a> );
00565 
00566         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00567 
00568 <span class="preprocessor">#if DBG</span>
00569 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_DISK_FULL) {
00570                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MM MODWRITE: unable to open paging file %wZ - status = %X \n"</span>, &amp;CapturedName, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00571             }
00572 <span class="preprocessor">#endif</span>
00573 <span class="preprocessor"></span>
00574             <span class="keywordflow">goto</span> ErrorReturn1;
00575         }
00576 
00577         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a> ( FileHandle,
00578                                              FILE_READ_DATA | FILE_WRITE_DATA,
00579                                              <a class="code" href="../../d5/d8/fssup_8c.html#a3">IoFileObjectType</a>,
00580                                              <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00581                                              (PVOID *)&amp;<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>,
00582                                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00583 
00584         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00585             <span class="keywordflow">goto</span> ErrorReturn2;
00586         }
00587 
00588         FoundExisting = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00589 
00590         ExAcquireFastMutex (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a684">MmPageFileCreationLock</a>);
00591 
00592         <span class="keywordflow">for</span> (PageFileNumber = 0; PageFileNumber &lt; <a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>; PageFileNumber += 1) {
00593             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[PageFileNumber]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o10">File</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o6">SectionObjectPointer</a> == <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>-&gt;SectionObjectPointer) {
00594                 FoundExisting = <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[PageFileNumber];
00595                 <span class="keywordflow">break</span>;
00596             }
00597         }
00598 
00599         <span class="keywordflow">if</span> (FoundExisting == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00600             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NOT_FOUND;
00601             <span class="keywordflow">goto</span> ErrorReturn4;
00602         }
00603 
00604         <span class="comment">//</span>
00605         <span class="comment">// Check for increases in the minimum or the maximum paging file sizes.</span>
00606         <span class="comment">// Decreasing either paging file size on the fly is not allowed.</span>
00607         <span class="comment">//</span>
00608 
00609         NewMaxSizeInPages = (ULONG)(CapturedMaximumSize.QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
00610         NewMinSizeInPages = (ULONG)(CapturedMinimumSize.QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
00611 
00612         <span class="keywordflow">if</span> (FoundExisting-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o2">MinimumSize</a> &gt; NewMinSizeInPages) {
00613             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER_2;
00614             <span class="keywordflow">goto</span> ErrorReturn4;
00615         }
00616 
00617         <span class="keywordflow">if</span> (FoundExisting-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o1">MaximumSize</a> &gt; NewMaxSizeInPages) {
00618             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER_3;
00619             <span class="keywordflow">goto</span> ErrorReturn4;
00620         }
00621 
00622         <span class="keywordflow">if</span> (NewMaxSizeInPages &gt; FoundExisting-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o1">MaximumSize</a>) {
00623 
00624             <span class="comment">//</span>
00625             <span class="comment">// Make sure that the pagefile increase doesn't cause the commit</span>
00626             <span class="comment">// limit (in pages) to wrap.  Currently this can only happen on</span>
00627             <span class="comment">// PAE systems where 16 pagefiles of 16TB (==256TB) is greater</span>
00628             <span class="comment">// than the 32-bit commit variable (max is 16TB).</span>
00629             <span class="comment">//</span>
00630 
00631             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/4_2kddata_8c.html#a54">MmTotalCommitLimitMaximum</a> + (NewMaxSizeInPages - FoundExisting-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o1">MaximumSize</a>) &lt;= <a class="code" href="../../d9/d5/4_2kddata_8c.html#a54">MmTotalCommitLimitMaximum</a>) {
00632                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER_3;
00633                 <span class="keywordflow">goto</span> ErrorReturn4;
00634             }
00635 
00636             <span class="comment">//</span>
00637             <span class="comment">// Handle the increase to the maximum paging file size.</span>
00638             <span class="comment">//</span>
00639 
00640             <a class="code" href="../../d4/d8/mi_8h.html#a233">MiCreateBitMap</a> (&amp;NewBitmap, NewMaxSizeInPages, <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>);
00641     
00642             <span class="keywordflow">if</span> (NewBitmap == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00643                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00644                 <span class="keywordflow">goto</span> ErrorReturn4;
00645             }
00646     
00647             OldBitmap = FoundExisting-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o9">Bitmap</a>;
00648     
00649             <a class="code" href="../../d6/d3/modwrite_8c.html#a32">MiExtendPagingFileMaximum</a> (PageFileNumber, NewBitmap);
00650     
00651             <a class="code" href="../../d4/d8/mi_8h.html#a234">MiRemoveBitMap</a> (&amp;OldBitmap);
00652     
00653             <span class="comment">//</span>
00654             <span class="comment">// We may be low on commitment and/or may have put a temporary</span>
00655             <span class="comment">// stopgate on things.  Clear up the logjam now by forcing an</span>
00656             <span class="comment">// extension and immediately returning it.</span>
00657             <span class="comment">//</span>
00658 
00659             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a> + 100 &gt; <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a>) {
00660                 <span class="keywordflow">if</span> (<a class="code" href="../../d6/d1/mmquota_8c.html#a17">MiChargeCommitment</a> (200, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00661                     <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (200);
00662                 }
00663             }
00664         }
00665     
00666         <span class="keywordflow">if</span> (NewMinSizeInPages &gt; FoundExisting-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o2">MinimumSize</a>) {
00667 
00668             <span class="comment">//</span>
00669             <span class="comment">// Handle the increase to the minimum paging file size.</span>
00670             <span class="comment">//</span>
00671 
00672             <span class="keywordflow">if</span> (NewMinSizeInPages &gt; FoundExisting-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o0">Size</a>) {
00673 
00674                 <span class="comment">//</span>
00675                 <span class="comment">// Queue a message to the segment dereferencing / pagefile</span>
00676                 <span class="comment">// extending thread to see if the page file can be extended.</span>
00677                 <span class="comment">//</span>
00678         
00679                 PageExtend.<a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html#o2">RequestedExpansionSize</a> = NewMinSizeInPages - FoundExisting-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o0">Size</a>;
00680                 PageExtend.<a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html#o0">Segment</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00681                 PageExtend.<a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html#o6">PageFileNumber</a> = PageFileNumber;
00682                 <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a> (&amp;PageExtend.<a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html#o4">Event</a>, NotificationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00683 
00684                 <a class="code" href="../../d6/d3/modwrite_8c.html#a58">MiIssuePageExtendRequest</a> (&amp;PageExtend);
00685             }
00686 
00687             <span class="comment">//</span>
00688             <span class="comment">// The current size is now greater than the new desired minimum.</span>
00689             <span class="comment">// Ensure subsequent contractions obey this new minimum.</span>
00690             <span class="comment">//</span>
00691 
00692             <span class="keywordflow">if</span> (FoundExisting-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o0">Size</a> &gt;= NewMinSizeInPages) {
00693                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (FoundExisting-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o0">Size</a> &gt;= FoundExisting-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o2">MinimumSize</a>);
00694                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NewMinSizeInPages &gt;= FoundExisting-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o2">MinimumSize</a>);
00695                 FoundExisting-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o2">MinimumSize</a> = NewMinSizeInPages;
00696             }
00697             <span class="keywordflow">else</span> {
00698 
00699                 <span class="comment">//</span>
00700                 <span class="comment">// The pagefile could not be expanded to handle the new minimum.</span>
00701                 <span class="comment">// No easy way to undo any maximum raising that may have been</span>
00702                 <span class="comment">// done as the space may have already been used, so just set</span>
00703                 <span class="comment">// Status so our caller knows it didn't all go perfectly.</span>
00704                 <span class="comment">//</span>
00705 
00706                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00707             }
00708         }
00709 
00710         <span class="keywordflow">goto</span> ErrorReturn4;
00711     }
00712 
00713     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IoStatus.Status)) {
00714         KdPrint((<span class="stringliteral">"MM MODWRITE: unable to open paging file %wZ - iosb %lx\n"</span>, &amp;CapturedName, IoStatus.Status));
00715         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = IoStatus.Status;
00716         <span class="keywordflow">goto</span> ErrorReturn1;
00717     }
00718 
00719     <span class="comment">//</span>
00720     <span class="comment">// Make sure that the pagefile increase doesn't cause the commit</span>
00721     <span class="comment">// limit (in pages) to wrap.  Currently this can only happen on</span>
00722     <span class="comment">// PAE systems where 16 pagefiles of 16TB (==256TB) is greater</span>
00723     <span class="comment">// than the 32-bit commit variable (max is 16TB).</span>
00724     <span class="comment">//</span>
00725 
00726     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/4_2kddata_8c.html#a54">MmTotalCommitLimitMaximum</a> + (CapturedMaximumSize.QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>)
00727         &lt;= <a class="code" href="../../d9/d5/4_2kddata_8c.html#a54">MmTotalCommitLimitMaximum</a>) {
00728         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER_3;
00729         <span class="keywordflow">goto</span> ErrorReturn2;
00730     }
00731 
00732     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a39">ZwSetInformationFile</a> (FileHandle,
00733                                    &amp;IoStatus,
00734                                    &amp;EndOfFileInformation,
00735                                    <span class="keyword">sizeof</span>(EndOfFileInformation),
00736                                    FileEndOfFileInformation);
00737 
00738     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00739         KdPrint((<span class="stringliteral">"MM MODWRITE: unable to set length of paging file %wZ status = %X \n"</span>,
00740                  &amp;CapturedName, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00741         <span class="keywordflow">goto</span> ErrorReturn2;
00742     }
00743 
00744     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IoStatus.Status)) {
00745         KdPrint((<span class="stringliteral">"MM MODWRITE: unable to set length of paging file %wZ - iosb %lx\n"</span>,
00746                 &amp;CapturedName, IoStatus.Status));
00747         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = IoStatus.Status;
00748         <span class="keywordflow">goto</span> ErrorReturn2;
00749     }
00750 
00751     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a> ( FileHandle,
00752                                          FILE_READ_DATA | FILE_WRITE_DATA,
00753                                          <a class="code" href="../../d5/d8/fssup_8c.html#a3">IoFileObjectType</a>,
00754                                          <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00755                                          (PVOID *)&amp;<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>,
00756                                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00757 
00758     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00759         KdPrint((<span class="stringliteral">"MM MODWRITE: Unable to reference paging file - %wZ\n"</span>,
00760                  &amp;CapturedName));
00761         <span class="keywordflow">goto</span> ErrorReturn2;
00762     }
00763 
00764     <span class="comment">//</span>
00765     <span class="comment">// Get the address of the target device object and ensure</span>
00766     <span class="comment">// the specified file is of a suitable type.</span>
00767     <span class="comment">//</span>
00768 
00769     deviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a> (<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>);
00770 
00771     <span class="keywordflow">if</span> ((deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o12">DeviceType</a> != FILE_DEVICE_DISK_FILE_SYSTEM) &amp;&amp;
00772         (deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o12">DeviceType</a> != FILE_DEVICE_NETWORK_FILE_SYSTEM) &amp;&amp;
00773         (deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o12">DeviceType</a> != FILE_DEVICE_DFS_VOLUME) &amp;&amp;
00774         (deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o12">DeviceType</a> != FILE_DEVICE_DFS_FILE_SYSTEM)) {
00775             KdPrint((<span class="stringliteral">"MM MODWRITE: Invalid paging file type - %x\n"</span>,
00776                      deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o12">DeviceType</a>));
00777             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNRECOGNIZED_VOLUME;
00778             <span class="keywordflow">goto</span> ErrorReturn3;
00779     }
00780 
00781     <span class="comment">//</span>
00782     <span class="comment">// Make sure the specified file is not currently being used</span>
00783     <span class="comment">// as a mapped data file.</span>
00784     <span class="comment">//</span>
00785 
00786     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d3/modwrite_8c.html#a33">MiCheckPageFileMapping</a> (<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>);
00787     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00788         <span class="keywordflow">goto</span> ErrorReturn3;
00789     }
00790 
00791     <span class="comment">//</span>
00792     <span class="comment">// Make sure the volume is not a floppy disk.</span>
00793     <span class="comment">//</span>
00794 
00795     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d6/iosubs_8c.html#a91">IoQueryVolumeInformation</a> ( <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>,
00796                                         FileFsDeviceInformation,
00797                                         <span class="keyword">sizeof</span>(FILE_FS_DEVICE_INFORMATION),
00798                                         &amp;FileDeviceInfo,
00799                                         &amp;ReturnedLength
00800                                       );
00801 
00802     <span class="keywordflow">if</span> (FILE_FLOPPY_DISKETTE &amp; FileDeviceInfo.Characteristics) {
00803         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_FLOPPY_VOLUME;
00804         <span class="keywordflow">goto</span> ErrorReturn3;
00805     }
00806 
00807     <span class="comment">//</span>
00808     <span class="comment">// Check with all of the drivers along the path to the file to ensure</span>
00809     <span class="comment">// that they are willing to follow the rules required of them and to</span>
00810     <span class="comment">// give them a chance to lock down code and data that needs to be locked.</span>
00811     <span class="comment">// If any of the drivers along the path refuses to participate, fail the</span>
00812     <span class="comment">// pagefile creation.</span>
00813     <span class="comment">//</span>
00814     <span class="comment">// BUGBUG: Failing the pagefile creation is commented out until the</span>
00815     <span class="comment">// storage drivers have been modified to correctly handle this request.</span>
00816     <span class="comment">//</span>
00817 
00818     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d8/sysload_8c.html#a50">MiCheckPageFilePath</a> (<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>);
00819     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00820         KdPrint(( <span class="stringliteral">"MiCheckPageFilePath(%wZ) FAILED: %x\n"</span>, &amp;CapturedName, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ));
00821         <span class="comment">//goto ErrorReturn3;</span>
00822     }
00823 
00824     <span class="comment">//</span>
00825     <span class="comment">// Acquire the global page file creation mutex.</span>
00826     <span class="comment">//</span>
00827 
00828     ExAcquireFastMutex (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a684">MmPageFileCreationLock</a>);
00829 
00830     <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>] = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
00831                                                         <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html">MMPAGING_FILE</a>),
00832                                                         '  mM');
00833     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>] == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00834 
00835         <span class="comment">//</span>
00836         <span class="comment">// Allocate pool failed.</span>
00837         <span class="comment">//</span>
00838 
00839         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00840         <span class="keywordflow">goto</span> ErrorReturn4;
00841     }
00842 
00843     RtlZeroMemory (<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>], <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/mi_8h.html#a506">MMPAGING_FILE</a>));
00844     <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o10">File</a> = <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>;
00845     <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o0">Size</a> = (ULONG)(
00846                                                 CapturedMinimumSize.QuadPart
00847                                                 &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
00848 
00849     <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o2">MinimumSize</a> =
00850                                       <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o0">Size</a>;
00851     <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o3">FreeSpace</a> =
00852                                       <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o0">Size</a> - 1;
00853 
00854     <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o1">MaximumSize</a> = (PFN_NUMBER)(
00855                                                 CapturedMaximumSize.QuadPart &gt;&gt;
00856                                                 <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
00857 
00858     <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o12">PageFileNumber</a> = <a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>;
00859 
00860     <span class="comment">//</span>
00861     <span class="comment">// Adjust the commit page limit to reflect the new page file space.</span>
00862     <span class="comment">//</span>
00863 
00864     <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o8">Entry</a>[0] = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
00865                                             <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html">MMMOD_WRITER_MDL_ENTRY</a>) +
00866                                             <a class="code" href="../../d4/d8/mi_8h.html#a730">MmModifiedWriteClusterSize</a> *
00867                                             <span class="keyword">sizeof</span>(PFN_NUMBER),
00868                                             '  mM');
00869 
00870     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o8">Entry</a>[0] == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00871 
00872         <span class="comment">//</span>
00873         <span class="comment">// Allocate pool failed.</span>
00874         <span class="comment">//</span>
00875 
00876         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00877         <span class="keywordflow">goto</span> ErrorReturn5;
00878     }
00879 
00880     RtlZeroMemory (<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>]-&gt;Entry[0],
00881                    <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/mi_8h.html#a504">MMMOD_WRITER_MDL_ENTRY</a>));
00882 
00883     <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o8">Entry</a>[0]-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o7">PagingListHead</a> =
00884                                           &amp;<a class="code" href="../../d4/d8/mi_8h.html#a712">MmPagingFileHeader</a>;
00885     <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o8">Entry</a>[0]-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o9">PagingFile</a> =
00886                                           <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>];
00887 
00888     <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o8">Entry</a>[1] = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
00889                                             <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/mi_8h.html#a504">MMMOD_WRITER_MDL_ENTRY</a>) +
00890                                             <a class="code" href="../../d4/d8/mi_8h.html#a730">MmModifiedWriteClusterSize</a> *
00891                                             <span class="keyword">sizeof</span>(PFN_NUMBER),
00892                                             '  mM');
00893 
00894     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o8">Entry</a>[1] == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00895 
00896         <span class="comment">//</span>
00897         <span class="comment">// Allocate pool failed.</span>
00898         <span class="comment">//</span>
00899 
00900         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00901         <span class="keywordflow">goto</span> ErrorReturn6;
00902     }
00903 
00904     RtlZeroMemory (<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>]-&gt;Entry[1],
00905                    <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/mi_8h.html#a504">MMMOD_WRITER_MDL_ENTRY</a>));
00906 
00907     <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o8">Entry</a>[1]-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o7">PagingListHead</a> =
00908                                           &amp;<a class="code" href="../../d4/d8/mi_8h.html#a712">MmPagingFileHeader</a>;
00909     <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o8">Entry</a>[1]-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o9">PagingFile</a> =
00910                                           <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>];
00911 
00912     <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o11">PageFileName</a> = CapturedName;
00913 
00914     <a class="code" href="../../d4/d8/mi_8h.html#a233">MiCreateBitMap</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>]-&gt;Bitmap,
00915                     <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>]-&gt;MaximumSize,
00916                     <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>);
00917 
00918     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o9">Bitmap</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00919 
00920         <span class="comment">//</span>
00921         <span class="comment">// Allocate pool failed.</span>
00922         <span class="comment">//</span>
00923 
00924         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00925         <span class="keywordflow">goto</span> ErrorReturn7;
00926     }
00927 
00928     <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a28">RtlSetAllBits</a> (<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>]-&gt;Bitmap);
00929 
00930     <span class="comment">//</span>
00931     <span class="comment">// Set the first bit as 0 is an invalid page location, clear the</span>
00932     <span class="comment">// following bits.</span>
00933     <span class="comment">//</span>
00934 
00935     <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a33">RtlClearBits</a> (<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>]-&gt;Bitmap,
00936                   1,
00937                   (ULONG)(<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>]-&gt;<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> - 1));
00938 
00939     PageFileNumber = <a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>;
00940     <a class="code" href="../../d6/d3/modwrite_8c.html#a34">MiInsertPageFileInList</a> ();
00941 
00942     FinalStatus = <a class="code" href="../../d6/d3/modwrite_8c.html#a29">MiCheckForCrashDump</a> (<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>, PageFileNumber);
00943 
00944     <span class="keywordflow">if</span> (PageFileNumber == 0) {
00945 
00946         <span class="comment">//</span>
00947         <span class="comment">// The first paging file has been created and reservation of any</span>
00948         <span class="comment">// crashdump pages has completed, signal the modified</span>
00949         <span class="comment">// page writer.</span>
00950         <span class="comment">//</span>
00951 
00952         <a class="code" href="../../d6/d3/modwrite_8c.html#a42">MiReleaseModifiedWriter</a> ();
00953     }
00954 
00955     ExReleaseFastMutex (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a684">MmPageFileCreationLock</a>);
00956 
00957     <span class="comment">//</span>
00958     <span class="comment">// Note that the file handle is not closed to prevent the</span>
00959     <span class="comment">// paging file from being deleted or opened again.  (Actually,</span>
00960     <span class="comment">// the file handle is duped to the system process so process</span>
00961     <span class="comment">// termination will not close the handle).</span>
00962     <span class="comment">//</span>
00963 
00964     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a3">ObOpenObjectByPointer</a>(
00965                 <a class="code" href="../../d1/d9/ps_8h.html#a53">PsInitialSystemProcess</a>,
00966                 0,
00967                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00968                 0,
00969                 <a class="code" href="../../d9/d8/ntos_8h.html#a2">PsProcessType</a>,
00970                 <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00971                 &amp;SystemProcess
00972                 );
00973 
00974     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00975         ZwClose (FileHandle);
00976         <span class="keywordflow">return</span> FinalStatus;
00977     }
00978 
00979     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwDuplicateObject(
00980                 NtCurrentProcess(),
00981                 FileHandle,
00982                 SystemProcess,
00983                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00984                 0,
00985                 0,
00986                 DUPLICATE_SAME_ATTRIBUTES | DUPLICATE_SAME_ACCESS
00987                 );
00988 
00989     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00990 
00991     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d3/modwrite_8c.html#a24">MmSystemPageFileLocated</a>) {
00992         <a class="code" href="../../d6/d3/modwrite_8c.html#a24">MmSystemPageFileLocated</a> = <a class="code" href="../../d4/d6/iosubs_8c.html#a88">IoPageFileCreated</a>(FileHandle);
00993     }
00994 
00995     ZwClose (SystemProcess);
00996     ZwClose (FileHandle);
00997 
00998     <span class="keywordflow">return</span> FinalStatus;
00999 
01000     <span class="comment">//</span>
01001     <span class="comment">// Error returns:</span>
01002     <span class="comment">//</span>
01003 
01004 ErrorReturn7:
01005     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>]-&gt;Entry[0]);
01006 
01007 ErrorReturn6:
01008     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>]-&gt;Entry[1]);
01009 
01010 ErrorReturn5:
01011     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>]);
01012 
01013 ErrorReturn4:
01014     ExReleaseFastMutex (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a684">MmPageFileCreationLock</a>);
01015 
01016 ErrorReturn3:
01017     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>);
01018 
01019 ErrorReturn2:
01020     ZwClose (FileHandle);
01021 
01022 ErrorReturn1:
01023     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (CapturedBuffer);
01024 
01025 ErrorReturn0:
01026     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01027 }
01028 
01029 
01030 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01031"></a><a class="code" href="../../d6/d3/modwrite_8c.html#a32">01031</a> <a class="code" href="../../d6/d3/modwrite_8c.html#a32">MiExtendPagingFileMaximum</a> (
01032     IN ULONG PageFileNumber,
01033     IN PRTL_BITMAP NewBitmap
01034     )
01035 
01036 <span class="comment">/*++</span>
01037 <span class="comment"></span>
01038 <span class="comment">Routine Description:</span>
01039 <span class="comment"></span>
01040 <span class="comment">    This routine switches from the old bitmap to the new (larger) bitmap.</span>
01041 <span class="comment"></span>
01042 <span class="comment">Arguments:</span>
01043 <span class="comment"></span>
01044 <span class="comment">    PageFileNumber - Supplies the paging file number to be extended.</span>
01045 <span class="comment"></span>
01046 <span class="comment">    NewBitmap - Supplies the new bitmap to use.</span>
01047 <span class="comment"></span>
01048 <span class="comment">Return Value:</span>
01049 <span class="comment"></span>
01050 <span class="comment">    None.</span>
01051 <span class="comment"></span>
01052 <span class="comment">Environment:</span>
01053 <span class="comment"></span>
01054 <span class="comment">    Kernel mode, APC_LEVEL, MmPageFileCreationLock held.</span>
01055 <span class="comment"></span>
01056 <span class="comment">--*/</span>
01057 
01058 {
01059     KIRQL OldIrql;
01060     PRTL_BITMAP OldBitmap;
01061 
01062     OldBitmap = <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[PageFileNumber]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o9">Bitmap</a>;
01063 
01064     <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a28">RtlSetAllBits</a> (NewBitmap);
01065 
01066     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01067 
01068     <span class="comment">//</span>
01069     <span class="comment">// Copy the bits from the existing map.</span>
01070     <span class="comment">//</span>
01071 
01072     RtlCopyMemory (NewBitmap-&gt;Buffer,
01073                    OldBitmap-&gt;Buffer,
01074                    ((OldBitmap-&gt;SizeOfBitMap + 31) / 32) * sizeof (ULONG));
01075 
01076     <a class="code" href="../../d9/d5/4_2kddata_8c.html#a54">MmTotalCommitLimitMaximum</a> += (NewBitmap-&gt;SizeOfBitMap - OldBitmap-&gt;SizeOfBitMap);
01077 
01078     <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[PageFileNumber]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o1">MaximumSize</a> = NewBitmap-&gt;SizeOfBitMap;
01079 
01080     <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[PageFileNumber]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o9">Bitmap</a> = NewBitmap;
01081 
01082     <span class="comment">//</span>
01083     <span class="comment">// If any MDLs are waiting for space, get them up now.</span>
01084     <span class="comment">//</span>
01085 
01086     <span class="keywordflow">if</span> (!IsListEmpty (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a716">MmFreePagingSpaceLow</a>)) {
01087         <a class="code" href="../../d4/d8/mi_8h.html#a890">MiUpdateModifiedWriterMdls</a> (PageFileNumber);
01088     }
01089 
01090     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01091 }
01092 
01093 
01094 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01095"></a><a class="code" href="../../d6/d3/modwrite_8c.html#a29">01095</a> <a class="code" href="../../d6/d3/modwrite_8c.html#a29">MiCheckForCrashDump</a> (
01096     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> File,
01097     IN ULONG FileNumber
01098     )
01099 
01100 <span class="comment">/*++</span>
01101 <span class="comment"></span>
01102 <span class="comment">Routine Description:</span>
01103 <span class="comment"></span>
01104 <span class="comment">    This routine checks the first page of the paging file to</span>
01105 <span class="comment">    determine if a crash dump exists.  If a crash dump is found</span>
01106 <span class="comment">    a section is created which maps the crash dump.  A handle</span>
01107 <span class="comment">    to the section is created via NtQuerySystemInformation specifying</span>
01108 <span class="comment">    SystemCrashDumpInformation.</span>
01109 <span class="comment"></span>
01110 <span class="comment">Arguments:</span>
01111 <span class="comment"></span>
01112 <span class="comment">    File - Supplies a pointer to the file object for the paging file.</span>
01113 <span class="comment"></span>
01114 <span class="comment">    FileNumber - Supplies the index into the paging file array.</span>
01115 <span class="comment"></span>
01116 <span class="comment">Return Value:</span>
01117 <span class="comment"></span>
01118 <span class="comment">    Returns STATUS_CRASH_DUMP if a crash dump exists, success otherwise.</span>
01119 <span class="comment"></span>
01120 <span class="comment">--*/</span>
01121 
01122 {
01123     <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> Mdl;
01124     LARGE_INTEGER <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = {0,0};
01125     LARGE_INTEGER DumpSpaceUsed;
01126     PFN_NUMBER DumpSpaceUsedInPages;
01127     PULONG Block;
01128     IO_STATUS_BLOCK IoStatus;
01129     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01130     PFN_NUMBER j;
01131     PPFN_NUMBER Page;
01132     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> FinalStatus;
01133     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
01134     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn;
01135     PFN_NUMBER MdlHack[(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>)/<span class="keyword">sizeof</span>(PFN_NUMBER)) + 1];
01136     <a class="code" href="../../d7/d9/struct__WORK__QUEUE__ITEM.html">WORK_QUEUE_ITEM</a> WorkItem;
01137     <a class="code" href="../../d6/d7/struct__MMWORK__CONTEXT.html">MMWORK_CONTEXT</a> Context;
01138 
01139     FinalStatus = STATUS_SUCCESS;
01140 
01141     Mdl = (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>)&amp;MdlHack[0];
01142     <a class="code" href="../../d5/d6/iosup_8c.html#a73">MmCreateMdl</a>( Mdl, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
01143     Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o2">MdlFlags</a> |= <a class="code" href="../../d0/d9/ntosdef_8h.html#a13">MDL_PAGES_LOCKED</a>;
01144 
01145     Page = (PPFN_NUMBER)(Mdl + 1);
01146     *Page = <a class="code" href="../../d4/d8/mi_8h.html#a809">MiGetPageForHeader</a> ();
01147     Block = <a class="code" href="../../d2/d1/mm_8h.html#a25">MmGetSystemAddressForMdlSafe</a> (Mdl, <a class="code" href="../../d2/d1/mm_8h.html#a347a183">HighPagePriority</a>);
01148 
01149     <span class="keywordflow">if</span> (Block == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01150         <a class="code" href="../../d4/d8/mi_8h.html#a810">MiRemoveImageHeaderPage</a>(*Page);
01151         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01152     }
01153 
01154     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a> (&amp;Context.<a class="code" href="../../d6/d7/struct__MMWORK__CONTEXT.html#o2">Event</a>, NotificationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01155 
01156     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d6/iosubs_8c.html#a89">IoPageRead</a> (<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>,
01157                          Mdl,
01158                          &amp;<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>,
01159                          &amp;Context.<a class="code" href="../../d6/d7/struct__MMWORK__CONTEXT.html#o2">Event</a>,
01160                          &amp;IoStatus);
01161 
01162     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_PENDING) {
01163         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;Context.<a class="code" href="../../d6/d7/struct__MMWORK__CONTEXT.html#o2">Event</a>,
01164                                <a class="code" href="../../d4/d9/ke_8h.html#a407a207">WrPageIn</a>,
01165                                <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
01166                                <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01167                                (PLARGE_INTEGER)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01168     }
01169 
01170     <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a> (&amp;Context.<a class="code" href="../../d6/d7/struct__MMWORK__CONTEXT.html#o2">Event</a>);
01171 
01172     DumpSpaceUsed.LowPart = Block[DH_REQUIRED_DUMP_SPACE];
01173     DumpSpaceUsed.HighPart = Block[DH_REQUIRED_DUMP_SPACE + 1];
01174 
01175     DumpSpaceUsedInPages = (PFN_NUMBER)(DumpSpaceUsed.QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
01176 
01177     <span class="keywordflow">if</span> ((Block[0] == 'EGAP') &amp;&amp;
01178         (Block[1] == 'PMUD') &amp;&amp;
01179         (DumpSpaceUsedInPages &lt;= <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[FileNumber]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o0">Size</a>)) {
01180 
01181         <span class="comment">//</span>
01182         <span class="comment">// A crash dump already exists, don't let pager use</span>
01183         <span class="comment">// it and build named section for it.</span>
01184         <span class="comment">//</span>
01185 
01186         Context.<a class="code" href="../../d6/d7/struct__MMWORK__CONTEXT.html#o0">Size</a>.QuadPart = DumpSpaceUsed.QuadPart;
01187 
01188         <a class="code" href="../../d5/d8/ex_8h.html#a55">ExInitializeWorkItem</a>(&amp;WorkItem,
01189                              <a class="code" href="../../d6/d3/modwrite_8c.html#a30">MiCrashDumpWorker</a>,
01190                              (PVOID)&amp;Context);
01191 
01192         <a class="code" href="../../d5/d8/ex_8h.html#a261">ExQueueWorkItem</a>( &amp;WorkItem, <a class="code" href="../../d5/d8/ex_8h.html#a332a206">DelayedWorkQueue</a> );
01193 
01194         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;Context.Event,
01195                                <a class="code" href="../../d4/d9/ke_8h.html#a407a207">WrPageIn</a>,
01196                                <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
01197                                <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01198                                (PLARGE_INTEGER)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01199 
01200         <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a> (&amp;Context.Event);
01201 
01202         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Context.Status)) {
01203             <span class="keywordflow">goto</span> Failed;
01204         }
01205 
01206         <span class="comment">//</span>
01207         <span class="comment">// Make the section point to the paging file.</span>
01208         <span class="comment">//</span>
01209 
01210         PointerPte = <a class="code" href="../../d6/d3/modwrite_8c.html#a11">MmCrashDumpSection</a>-&gt;Segment-&gt;PrototypePte;
01211         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, <a class="code" href="../../d6/d3/modwrite_8c.html#a11">MmCrashDumpSection</a>-&gt;Segment-&gt;SegmentPteTemplate);
01212 
01213         Pfn = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (*Page);
01214 <span class="preprocessor">#if PFN_CONSISTENCY</span>
01215 <span class="preprocessor"></span>        MiSetModified (Pfn, 1);
01216 <span class="preprocessor">#else</span>
01217 <span class="preprocessor"></span>        Pfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified = 1;
01218 <span class="preprocessor">#endif</span>
01219 <span class="preprocessor"></span>
01220         PointerPte += 1;
01221 
01222         <span class="keywordflow">for</span> (j = 1; j &lt; DumpSpaceUsedInPages; j += 1) {
01223 
01224             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a143">MI_SET_PAGING_FILE_INFO</a> (*PointerPte,
01225                                      <a class="code" href="../../d6/d3/modwrite_8c.html#a11">MmCrashDumpSection</a>-&gt;Segment-&gt;SegmentPteTemplate,
01226                                      FileNumber,
01227                                      j);
01228 
01229 <span class="preprocessor">#if DBG</span>
01230 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ((j &lt; 8192) &amp;&amp; (FileNumber == 0)) {
01231                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((<a class="code" href="../../d4/d8/mi_8h.html#a686">MmPagingFileDebug</a>[j] &amp; 1) == 0);
01232                 <a class="code" href="../../d4/d8/mi_8h.html#a686">MmPagingFileDebug</a>[j] = (((ULONG_PTR)PointerPte &lt;&lt; 3) | 1);
01233             }
01234 <span class="preprocessor">#endif //DBG</span>
01235 <span class="preprocessor"></span>            PointerPte += 1;
01236         }
01237 
01238         <span class="comment">//</span>
01239         <span class="comment">// Change the original PTE contents to refer to</span>
01240         <span class="comment">// the paging file offset where this was written.</span>
01241         <span class="comment">//</span>
01242 
01243         <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a34">RtlSetBits</a> (<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[FileNumber]-&gt;Bitmap,
01244                     1,
01245                     (ULONG)DumpSpaceUsedInPages - 1);
01246 
01247         <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[FileNumber]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o3">FreeSpace</a> -= DumpSpaceUsedInPages;
01248         <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[FileNumber]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o4">CurrentUsage</a> += DumpSpaceUsedInPages;
01249         FinalStatus = STATUS_CRASH_DUMP;
01250 
01251 Failed:
01252 
01253         <span class="comment">//</span>
01254         <span class="comment">// Indicate that no crash dump is in file so if system is</span>
01255         <span class="comment">// rebooted the page file is available.</span>
01256         <span class="comment">//</span>
01257 
01258         Block[1] = 'EGAP';
01259     } <span class="keywordflow">else</span> {
01260 
01261         <span class="comment">//</span>
01262         <span class="comment">// Set new pattern into file.</span>
01263         <span class="comment">//</span>
01264 
01265         RtlFillMemoryUlong (Block,
01266                             <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>,
01267                             'EGAP');
01268 
01269 <span class="preprocessor">#if !defined(_WIN64)</span>
01270 <span class="preprocessor"></span>
01271         <span class="comment">//</span>
01272         <span class="comment">// This bit of code does not work on Win64.  Worse, it generates</span>
01273         <span class="comment">// alignment faults.  So, until it (and the other components that</span>
01274         <span class="comment">// deal with crashdump blocks) is fixed, it is disabled for Win64.</span>
01275         <span class="comment">//</span>
01276 
01277         *(PULONG_PTR)(&amp;Block[4]) = <a class="code" href="../../d1/d9/ps_8h.html#a53">PsInitialSystemProcess</a>-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>.<a class="code" href="../../d5/d7/struct__KPROCESS.html#o2">DirectoryTableBase</a>[0];
01278         *(PULONG *)(&amp;Block[5]) = (PULONG)<a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a>;
01279         *(PLIST_ENTRY *)(&amp;Block[6]) = (PLIST_ENTRY)&amp;<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>;
01280         *(PLIST_ENTRY *)(&amp;Block[7]) = (PLIST_ENTRY)&amp;<a class="code" href="../../d1/d9/ps_8h.html#a49">PsActiveProcessHead</a>;
01281 <span class="preprocessor">#endif</span>
01282 <span class="preprocessor"></span>        Block[8] =
01283 <span class="preprocessor">#ifdef _X86_</span>
01284 <span class="preprocessor"></span>                    IMAGE_FILE_MACHINE_I386;
01285 <span class="preprocessor">#endif //_X86_</span>
01286 <span class="preprocessor"></span>
01287 <span class="preprocessor">#ifdef _ALPHA_</span>
01288 <span class="preprocessor"></span>                    IMAGE_FILE_MACHINE_ALPHA;
01289 <span class="preprocessor">#endif //_ALPHA_</span>
01290 <span class="preprocessor"></span>
01291 <span class="preprocessor">#ifdef _IA64_</span>
01292 <span class="preprocessor"></span>                    IMAGE_FILE_MACHINE_IA64;
01293 <span class="preprocessor">#endif //_IA64_</span>
01294 <span class="preprocessor"></span>
01295         ExAcquireFastMutex (&amp;<a class="code" href="../../d9/d3/dynmem_8c.html#a1">MmDynamicMemoryMutex</a>);
01296 
01297         RtlCopyMemory (&amp;Block[DH_PHYSICAL_MEMORY_BLOCK],
01298                        <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>,
01299                        (<span class="keyword">sizeof</span>(<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html">PHYSICAL_MEMORY_DESCRIPTOR</a>) +
01300                         (<span class="keyword">sizeof</span>(<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html">PHYSICAL_MEMORY_RUN</a>) *
01301                         (<a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a> - 1))));
01302 
01303         ExReleaseFastMutex (&amp;<a class="code" href="../../d9/d3/dynmem_8c.html#a1">MmDynamicMemoryMutex</a>);
01304     }
01305 
01306     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d6/iosubs_8c.html#a116">IoSynchronousPageWrite</a> (
01307                            <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>,
01308                            Mdl,
01309                            &amp;<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>,
01310                            &amp;Context.<a class="code" href="../../d6/d7/struct__MMWORK__CONTEXT.html#o2">Event</a>,
01311                            &amp;IoStatus );
01312 
01313     <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a> (&amp;Context.<a class="code" href="../../d6/d7/struct__MMWORK__CONTEXT.html#o2">Event</a>,
01314                            <a class="code" href="../../d4/d9/ke_8h.html#a407a216">WrVirtualMemory</a>,
01315                            <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
01316                            <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01317                            (PLARGE_INTEGER)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01318 
01319     <a class="code" href="../../d5/d6/iosup_8c.html#a56">MmUnmapLockedPages</a> (Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o4">MappedSystemVa</a>, Mdl);
01320     <span class="keywordflow">if</span> (FinalStatus == STATUS_CRASH_DUMP) {
01321 
01322         <span class="comment">//</span>
01323         <span class="comment">// Set the first page to point to the page that was just operated</span>
01324         <span class="comment">// upon.</span>
01325         <span class="comment">//</span>
01326 
01327         <a class="code" href="../../d4/d8/mi_8h.html#a808">MiUpdateImageHeaderPage</a> (<a class="code" href="../../d6/d3/modwrite_8c.html#a11">MmCrashDumpSection</a>-&gt;Segment-&gt;PrototypePte,
01328                                  *Page,
01329                                  <a class="code" href="../../d6/d3/modwrite_8c.html#a11">MmCrashDumpSection</a>-&gt;Segment-&gt;ControlArea);
01330     } <span class="keywordflow">else</span> {
01331         <a class="code" href="../../d4/d8/mi_8h.html#a810">MiRemoveImageHeaderPage</a>(*Page);
01332     }
01333     <span class="keywordflow">return</span> FinalStatus;
01334 }
01335 
01336 
01337 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01338"></a><a class="code" href="../../d6/d3/modwrite_8c.html#a30">01338</a> <a class="code" href="../../d6/d3/modwrite_8c.html#a30">MiCrashDumpWorker</a> (
01339     IN PVOID Context
01340     )
01341 
01342 <span class="comment">/*++</span>
01343 <span class="comment"></span>
01344 <span class="comment">Routine Description:</span>
01345 <span class="comment"></span>
01346 <span class="comment">    This function is called in the context of a delayed worker thread.</span>
01347 <span class="comment">    Its function is to create a section which will be used to map the</span>
01348 <span class="comment">    crash dump in the paging file.</span>
01349 <span class="comment"></span>
01350 <span class="comment">Arguments:</span>
01351 <span class="comment"></span>
01352 <span class="comment">    Context - Supplies the context record which contains the section's</span>
01353 <span class="comment">              size, an event to set at completion and a status value</span>
01354 <span class="comment">              to be returned.</span>
01355 <span class="comment"></span>
01356 <span class="comment">Return Value:</span>
01357 <span class="comment"></span>
01358 <span class="comment">    None.</span>
01359 <span class="comment"></span>
01360 <span class="comment">--*/</span>
01361 
01362 {
01363     <a class="code" href="../../d6/d3/modwrite_8c.html#a6">PMMWORK_CONTEXT</a> Work;
01364     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
01365 
01366     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01367 
01368     Work = (<a class="code" href="../../d6/d3/modwrite_8c.html#a6">PMMWORK_CONTEXT</a>)Context;
01369 
01370     InitializeObjectAttributes( &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
01371                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01372                                 0,
01373                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01374                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
01375 
01376 
01377     Work-&gt;<a class="code" href="../../d6/d7/struct__MMWORK__CONTEXT.html#o1">Status</a> = <a class="code" href="../../d0/d8/creasect_8c.html#a20">MmCreateSection</a> ( &amp;<a class="code" href="../../d6/d3/modwrite_8c.html#a11">MmCrashDumpSection</a>,
01378                                SECTION_MAP_READ,
01379                                &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
01380                                &amp;Work-&gt;<a class="code" href="../../d6/d7/struct__MMWORK__CONTEXT.html#o0">Size</a>,
01381                                PAGE_READONLY,
01382                                SEC_COMMIT,
01383                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01384                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
01385 
01386     <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;Work-&gt;<a class="code" href="../../d6/d7/struct__MMWORK__CONTEXT.html#o2">Event</a>, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01387     <span class="keywordflow">return</span>;
01388 }
01389 
01390 
01391 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01392"></a><a class="code" href="../../d6/d3/modwrite_8c.html#a44">01392</a> <a class="code" href="../../d6/d3/modwrite_8c.html#a44">MmGetCrashDumpInformation</a> (
01393     IN PSYSTEM_CRASH_DUMP_INFORMATION CrashInfo
01394     )
01395 
01396 <span class="comment">/*++</span>
01397 <span class="comment"></span>
01398 <span class="comment">Routine Description:</span>
01399 <span class="comment"></span>
01400 <span class="comment">    This function checks to see if a crash dump section exists and</span>
01401 <span class="comment">    if so creates a handle to the section and returns that value</span>
01402 <span class="comment">    in the CrashDumpInformation structure.  Once the handle to the</span>
01403 <span class="comment">    section has been created, no other references can be made</span>
01404 <span class="comment">    to the crash dump section, and when that handle is closed, the</span>
01405 <span class="comment">    crash dump section is deleted and the paging file space is</span>
01406 <span class="comment">    available for reuse.</span>
01407 <span class="comment"></span>
01408 <span class="comment">Arguments:</span>
01409 <span class="comment"></span>
01410 <span class="comment">    CrashInfo - Supplies a pointer to the crash dump information</span>
01411 <span class="comment">                structure.</span>
01412 <span class="comment"></span>
01413 <span class="comment">Return Value:</span>
01414 <span class="comment"></span>
01415 <span class="comment">    Status of the operation.  A handle value of zero indicates no</span>
01416 <span class="comment">    crash dump was located.</span>
01417 <span class="comment"></span>
01418 <span class="comment">--*/</span>
01419 
01420 {
01421     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01422     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
01423 
01424     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01425 
01426     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d3/modwrite_8c.html#a11">MmCrashDumpSection</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01427         <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = 0;
01428         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01429     } <span class="keywordflow">else</span> {
01430         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d1/obinsert_8c.html#a0">ObInsertObject</a> (<a class="code" href="../../d6/d3/modwrite_8c.html#a11">MmCrashDumpSection</a>,
01431                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01432                                  SECTION_MAP_READ,
01433                                  0,
01434                                  (PVOID *)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01435                                  &amp;<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>);
01436         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01437 
01438             <span class="comment">//</span>
01439             <span class="comment">// One shot operation.</span>
01440             <span class="comment">//</span>
01441 
01442             <a class="code" href="../../d6/d3/modwrite_8c.html#a11">MmCrashDumpSection</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01443         }
01444     }
01445 
01446     CrashInfo-&gt;CrashDumpSection = <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
01447     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01448 }
01449 
01450 
01451 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01452"></a><a class="code" href="../../d6/d3/modwrite_8c.html#a45">01452</a> <a class="code" href="../../d6/d3/modwrite_8c.html#a45">MmGetCrashDumpStateInformation</a> (
01453     IN PSYSTEM_CRASH_STATE_INFORMATION CrashInfo
01454     )
01455 
01456 <span class="comment">/*++</span>
01457 <span class="comment"></span>
01458 <span class="comment">Routine Description:</span>
01459 <span class="comment"></span>
01460 <span class="comment">    This function checks to see if a crash dump section exists and</span>
01461 <span class="comment">    returns a BOOLEAN value in the CrashStateInformation structure</span>
01462 <span class="comment">    based on the outcome.</span>
01463 <span class="comment"></span>
01464 <span class="comment">Arguments:</span>
01465 <span class="comment"></span>
01466 <span class="comment">    CrashInfo - Supplies a pointer to the crash dump state information</span>
01467 <span class="comment">                structure.</span>
01468 <span class="comment"></span>
01469 <span class="comment">Return Value:</span>
01470 <span class="comment"></span>
01471 <span class="comment">    Status of the operation.  A BOOLEAN value of FALSE indicates no</span>
01472 <span class="comment">    crash dump was located.</span>
01473 <span class="comment"></span>
01474 <span class="comment">--*/</span>
01475 
01476 {
01477     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01478 
01479     CrashInfo-&gt;ValidCrashDump = (<a class="code" href="../../d6/d3/modwrite_8c.html#a11">MmCrashDumpSection</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01480     <span class="keywordflow">return</span> STATUS_SUCCESS;
01481 }
01482 
01483 
01484 SIZE_T
<a name="l01485"></a><a class="code" href="../../d6/d3/modwrite_8c.html#a40">01485</a> <a class="code" href="../../d6/d3/modwrite_8c.html#a40">MiAttemptPageFileExtension</a> (
01486     IN ULONG PageFileNumber,
01487     IN SIZE_T ExtendSize,
01488     IN SIZE_T Maximum
01489     )
01490 
01491 <span class="comment">/*++</span>
01492 <span class="comment"></span>
01493 <span class="comment">Routine Description:</span>
01494 <span class="comment"></span>
01495 <span class="comment">    This routine attempts to extend the specified page file by</span>
01496 <span class="comment">    ExtendSize.</span>
01497 <span class="comment"></span>
01498 <span class="comment">Arguments:</span>
01499 <span class="comment"></span>
01500 <span class="comment">    PageFileNumber - Supplies the page file number to attempt to extend.</span>
01501 <span class="comment"></span>
01502 <span class="comment">    ExtendSize - Supplies the number of pages to extend the file by.</span>
01503 <span class="comment"></span>
01504 <span class="comment">    Maximum - Supplies TRUE if the page file should be extended</span>
01505 <span class="comment">              by the maximum size possible, but not to exceed</span>
01506 <span class="comment">              ExtendSize.</span>
01507 <span class="comment"></span>
01508 <span class="comment">Return Value:</span>
01509 <span class="comment"></span>
01510 <span class="comment">    Returns the size of the extension.  Zero if the page file cannot</span>
01511 <span class="comment">    be extended.</span>
01512 <span class="comment"></span>
01513 <span class="comment">--*/</span>
01514 
01515 {
01516 
01517     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01518     FILE_FS_SIZE_INFORMATION FileInfo;
01519     FILE_END_OF_FILE_INFORMATION EndOfFileInformation;
01520     KIRQL OldIrql;
01521     ULONG AllocSize;
01522     PFN_NUMBER AdditionalAllocation;
01523     ULONG ReturnedLength;
01524     PFN_NUMBER PagesAvailable;
01525     SIZE_T SizeToExtend;
01526     LARGE_INTEGER BytesAvailable;
01527 
01528     <span class="comment">//</span>
01529     <span class="comment">// Check to see if this page file is at the maximum.</span>
01530     <span class="comment">//</span>
01531 
01532     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[PageFileNumber]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o0">Size</a> ==
01533                                     <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[PageFileNumber]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o1">MaximumSize</a>) {
01534         <span class="keywordflow">return</span> 0;
01535     }
01536 
01537     <span class="comment">//</span>
01538     <span class="comment">// Find out how much free space is on this volume.</span>
01539     <span class="comment">//</span>
01540 
01541     status = <a class="code" href="../../d4/d6/iosubs_8c.html#a91">IoQueryVolumeInformation</a> ( <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[PageFileNumber]-&gt;<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>,
01542                                         FileFsSizeInformation,
01543                                         <span class="keyword">sizeof</span>(FileInfo),
01544                                         &amp;FileInfo,
01545                                         &amp;ReturnedLength
01546                                       );
01547 
01548     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
01549 
01550         <span class="comment">//</span>
01551         <span class="comment">// The volume query did not succeed - return 0 indicating</span>
01552         <span class="comment">// the paging file was not extended.</span>
01553         <span class="comment">//</span>
01554 
01555         <span class="keywordflow">return</span> 0;
01556     }
01557 
01558     <span class="comment">//</span>
01559     <span class="comment">// Always attempt to extend by at least megabyte.</span>
01560     <span class="comment">//</span>
01561 
01562     SizeToExtend = ExtendSize;
01563     <span class="keywordflow">if</span> (ExtendSize &lt; <a class="code" href="../../d4/d8/mi_8h.html#a732">MmPageFileExtension</a>) {
01564         SizeToExtend = <a class="code" href="../../d4/d8/mi_8h.html#a732">MmPageFileExtension</a>;
01565     }
01566 
01567     <span class="comment">//</span>
01568     <span class="comment">// Don't go over the maximum size for the paging file.</span>
01569     <span class="comment">//</span>
01570 
01571     <span class="keywordflow">if</span> ((SizeToExtend + <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[PageFileNumber]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o0">Size</a>) &gt;
01572                                        <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[PageFileNumber]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o1">MaximumSize</a>) {
01573         SizeToExtend = (<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[PageFileNumber]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o1">MaximumSize</a> -
01574                                 <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[PageFileNumber]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o0">Size</a>);
01575     }
01576 
01577     <span class="keywordflow">if</span> ((Maximum == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp; (SizeToExtend &lt; ExtendSize)) {
01578 
01579         <span class="comment">//</span>
01580         <span class="comment">// Can't meet the requirement.</span>
01581         <span class="comment">//</span>
01582 
01583         <span class="keywordflow">return</span> 0;
01584     }
01585     <span class="comment">//</span>
01586     <span class="comment">// See if there is enough space on the volume for the extension.</span>
01587     <span class="comment">//</span>
01588 
01589     AllocSize = FileInfo.SectorsPerAllocationUnit * FileInfo.BytesPerSector;
01590 
01591     BytesAvailable = <a class="code" href="../../d0/d1/largeic_8c.html#a2">RtlExtendedIntegerMultiply</a> (
01592                         FileInfo.AvailableAllocationUnits,
01593                         AllocSize);
01594 
01595     <span class="keywordflow">if</span> ((UINT64)BytesAvailable.QuadPart &gt; (UINT64)<a class="code" href="../../d4/d8/mi_8h.html#a731">MmMinimumFreeDiskSpace</a>) {
01596 
01597         BytesAvailable.QuadPart = BytesAvailable.QuadPart -
01598                                     (LONGLONG)<a class="code" href="../../d4/d8/mi_8h.html#a731">MmMinimumFreeDiskSpace</a>;
01599 
01600         <span class="keywordflow">if</span> ((UINT64)BytesAvailable.QuadPart &gt; (UINT64)(SizeToExtend &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>)) {
01601             BytesAvailable.QuadPart = (LONGLONG)(SizeToExtend &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
01602         }
01603 
01604         PagesAvailable = (PFN_NUMBER)(BytesAvailable.QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
01605 
01606         <span class="keywordflow">if</span> ((Maximum == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp; (PagesAvailable &lt; ExtendSize)) {
01607 
01608             <span class="comment">//</span>
01609             <span class="comment">// Can't satisfy this requirement.</span>
01610             <span class="comment">//</span>
01611 
01612             <span class="keywordflow">return</span> 0;
01613         }
01614 
01615     } <span class="keywordflow">else</span> {
01616 
01617         <span class="comment">//</span>
01618         <span class="comment">// Not enough space is available.</span>
01619         <span class="comment">//</span>
01620 
01621         <span class="keywordflow">return</span> 0;
01622     }
01623 
01624 <span class="preprocessor">#if defined (_WIN64) || defined (_X86PAE_)</span>
01625 <span class="preprocessor"></span>    EndOfFileInformation.EndOfFile.QuadPart =
01626               ((ULONG64)<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[PageFileNumber]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o0">Size</a> + PagesAvailable) * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
01627 <span class="preprocessor">#else</span>
01628 <span class="preprocessor"></span>    EndOfFileInformation.EndOfFile.LowPart =
01629               (<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[PageFileNumber]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o0">Size</a> + PagesAvailable) * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
01630 
01631     <span class="comment">//</span>
01632     <span class="comment">// Set high part to zero as paging files are limited to 4GB.</span>
01633     <span class="comment">//</span>
01634 
01635     EndOfFileInformation.EndOfFile.HighPart = 0;
01636 <span class="preprocessor">#endif</span>
01637 <span class="preprocessor"></span>
01638     <span class="comment">//</span>
01639     <span class="comment">// Attempt to extend the file by setting the end-of-file position.</span>
01640     <span class="comment">//</span>
01641 
01642     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() &lt; <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
01643     status = <a class="code" href="../../d4/d6/iosubs_8c.html#a106">IoSetInformation</a> (<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[PageFileNumber]-&gt;<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>,
01644                                FileEndOfFileInformation,
01645                                <span class="keyword">sizeof</span>(FILE_END_OF_FILE_INFORMATION),
01646                                &amp;EndOfFileInformation
01647                               );
01648 
01649     <span class="keywordflow">if</span> (status != STATUS_SUCCESS) {
01650         KdPrint((<span class="stringliteral">"MM MODWRITE: page file extension failed %lx %lx\n"</span>,status));
01651         <span class="keywordflow">return</span> 0;
01652     }
01653 
01654     <span class="comment">//</span>
01655     <span class="comment">// Clear bits within the paging file bitmap to allow the extension</span>
01656     <span class="comment">// to take effect.</span>
01657     <span class="comment">//</span>
01658 
01659     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01660 
01661     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (RtlCheckBit (<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[PageFileNumber]-&gt;Bitmap,
01662                          <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[PageFileNumber]-&gt;<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>) == 1);
01663 
01664     AdditionalAllocation = PagesAvailable;
01665 
01666     <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a33">RtlClearBits</a> (<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[PageFileNumber]-&gt;Bitmap,
01667                   (ULONG)<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[PageFileNumber]-&gt;<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>,
01668                   (ULONG)AdditionalAllocation );
01669 
01670     <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[PageFileNumber]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o0">Size</a> += AdditionalAllocation;
01671     <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[PageFileNumber]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o3">FreeSpace</a> += AdditionalAllocation;
01672 
01673     <a class="code" href="../../d4/d8/mi_8h.html#a890">MiUpdateModifiedWriterMdls</a> (PageFileNumber);
01674 
01675     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01676 
01677     <span class="keywordflow">return</span> AdditionalAllocation;
01678 }
01679 
01680 SIZE_T
<a name="l01681"></a><a class="code" href="../../d6/d3/modwrite_8c.html#a46">01681</a> <a class="code" href="../../d6/d3/modwrite_8c.html#a46">MiExtendPagingFiles</a> (
01682     IN <a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html">PMMPAGE_FILE_EXPANSION</a> PageExpand
01683     )
01684 
01685 <span class="comment">/*++</span>
01686 <span class="comment"></span>
01687 <span class="comment">Routine Description:</span>
01688 <span class="comment"></span>
01689 <span class="comment">    This routine attempts to extend the paging files to provide</span>
01690 <span class="comment">    ExtendSize bytes.</span>
01691 <span class="comment"></span>
01692 <span class="comment">    Note - Page file expansion and page file reduction are synchronized</span>
01693 <span class="comment">           because a single thread is responsible for performing the</span>
01694 <span class="comment">           operation.  Hence, while expansion is occurring, a reduction</span>
01695 <span class="comment">           request will be queued to the thread.</span>
01696 <span class="comment"></span>
01697 <span class="comment">Arguments:</span>
01698 <span class="comment"></span>
01699 <span class="comment">    DesiredQuota - Supplies the quota in pages desired.</span>
01700 <span class="comment"></span>
01701 <span class="comment">    PageFileNumber - Supplies the page file number to extend.</span>
01702 <span class="comment">                     MI_EXTEND_ANY_PAGFILE indicates to extend any page file.</span>
01703 <span class="comment"></span>
01704 <span class="comment">Return Value:</span>
01705 <span class="comment"></span>
01706 <span class="comment">    Returns the size of the extension.  Zero if the page file(s) cannot</span>
01707 <span class="comment">    be extended.</span>
01708 <span class="comment"></span>
01709 <span class="comment">--*/</span>
01710 
01711 {
01712     SIZE_T DesiredQuota;
01713     ULONG PageFileNumber;
01714     SIZE_T ExtendedSize;
01715     SIZE_T ExtendSize;
01716     ULONG i;
01717     KIRQL OldIrql;
01718     LOGICAL LockHeld;
01719     LOGICAL RealExpansion;
01720 
01721     RealExpansion = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01722     LockHeld = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01723     ExtendedSize = 0;
01724     DesiredQuota = PageExpand-&gt;RequestedExpansionSize;
01725     PageFileNumber = PageExpand-&gt;PageFileNumber;
01726 
01727     PageExpand-&gt;ActualExpansion = 0;
01728 
01729     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PageFileNumber &lt; <a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a> || PageFileNumber == <a class="code" href="../../d4/d8/mi_8h.html#a221">MI_EXTEND_ANY_PAGEFILE</a>);
01730 
01731     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a> == 0) {
01732         <span class="keywordflow">goto</span> alldone;
01733     }
01734 
01735     <span class="keywordflow">if</span> (PageFileNumber &lt; <a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>) {
01736         i = PageFileNumber;
01737         ExtendedSize = <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o1">MaximumSize</a> - <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o0">Size</a>;
01738         <span class="keywordflow">if</span> (ExtendedSize &lt; DesiredQuota) {
01739             ExtendedSize = 0;
01740         }
01741         <span class="keywordflow">else</span> {
01742             ExtendedSize = <a class="code" href="../../d6/d3/modwrite_8c.html#a40">MiAttemptPageFileExtension</a> (i, DesiredQuota, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01743         }
01744         <span class="keywordflow">goto</span> alldone;
01745     }
01746 
01747     LockHeld = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01748     ExAcquireSpinLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a690">MmChargeCommitmentLock</a>, &amp;OldIrql);
01749 
01750     <span class="comment">//</span>
01751     <span class="comment">// Check to see if ample space already exists now that we have</span>
01752     <span class="comment">// the spinlock.</span>
01753     <span class="comment">//</span>
01754 
01755     ExtendSize = DesiredQuota + <a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a>;
01756 
01757     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a> &gt;= ExtendSize) {
01758         ExtendedSize = 1;
01759         RealExpansion = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01760         <span class="keywordflow">goto</span> alldone;
01761     }
01762 
01763     <span class="comment">//</span>
01764     <span class="comment">// Calculate the additional pages needed.</span>
01765     <span class="comment">//</span>
01766 
01767     ExtendSize -= <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a>;
01768 
01769     ExReleaseSpinLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a690">MmChargeCommitmentLock</a>, OldIrql);
01770     LockHeld = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01771 
01772     <span class="comment">//</span>
01773     <span class="comment">// Make sure ample space exists within the paging files.</span>
01774     <span class="comment">//</span>
01775 
01776     i = 0;
01777 
01778     <span class="keywordflow">do</span> {
01779         ExtendedSize += <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o1">MaximumSize</a> - <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o0">Size</a>;
01780         i += 1;
01781     } <span class="keywordflow">while</span> (i &lt; <a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>);
01782 
01783     <span class="keywordflow">if</span> (ExtendedSize &lt; ExtendSize) {
01784         ExtendedSize = 0;
01785         <span class="keywordflow">goto</span> alldone;
01786     }
01787 
01788     <span class="comment">//</span>
01789     <span class="comment">// Attempt to extend only one of the paging files.</span>
01790     <span class="comment">//</span>
01791 
01792     i = 0;
01793     <span class="keywordflow">do</span> {
01794         ExtendedSize = <a class="code" href="../../d6/d3/modwrite_8c.html#a40">MiAttemptPageFileExtension</a> (i, ExtendSize, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01795         <span class="keywordflow">if</span> (ExtendedSize != 0) {
01796             <span class="keywordflow">goto</span> alldone;
01797         }
01798         i += 1;
01799     } <span class="keywordflow">while</span> (i &lt; <a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>);
01800 
01801     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ExtendedSize == 0);
01802 
01803     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a> == 1) {
01804 
01805         <span class="comment">//</span>
01806         <span class="comment">// If the attempt didn't succeed for one (not enough disk space free) -</span>
01807         <span class="comment">// don't try to set it to the maximum size.</span>
01808         <span class="comment">//</span>
01809 
01810         <span class="keywordflow">goto</span> alldone;
01811     }
01812 
01813     <span class="comment">//</span>
01814     <span class="comment">// Attempt to extend all paging files.</span>
01815     <span class="comment">//</span>
01816 
01817     i = 0;
01818     <span class="keywordflow">do</span> {
01819         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ExtendSize &gt; ExtendedSize);
01820         ExtendedSize += <a class="code" href="../../d6/d3/modwrite_8c.html#a40">MiAttemptPageFileExtension</a> (i,
01821                                                     ExtendSize - ExtendedSize,
01822                                                     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01823         <span class="keywordflow">if</span> (ExtendedSize &gt;= ExtendSize) {
01824             <span class="keywordflow">goto</span> alldone;
01825         }
01826         i += 1;
01827     } <span class="keywordflow">while</span> (i &lt; <a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>);
01828 
01829     <span class="comment">//</span>
01830     <span class="comment">// Not enough space is available.</span>
01831     <span class="comment">//</span>
01832 
01833     ExtendedSize = 0;
01834 
01835 alldone:
01836 
01837     <span class="keywordflow">if</span> (LockHeld == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01838         ExAcquireSpinLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a690">MmChargeCommitmentLock</a>, &amp;OldIrql);
01839     }
01840 
01841     <span class="keywordflow">if</span> ((ExtendedSize != 0) &amp;&amp; (RealExpansion == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
01842         <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a> += ExtendedSize;
01843     }
01844     
01845     <span class="comment">//</span>
01846     <span class="comment">// If commit allotments have been temporarily blocked then unblock now.</span>
01847     <span class="comment">//</span>
01848 
01849     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d1/mmquota_8c.html#a9">MmPageFileFullExtendPages</a>) {
01850         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a> &gt;= <a class="code" href="../../d6/d1/mmquota_8c.html#a9">MmPageFileFullExtendPages</a>);
01851         <a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a> -= <a class="code" href="../../d6/d1/mmquota_8c.html#a9">MmPageFileFullExtendPages</a>;
01852         <a class="code" href="../../d6/d1/mmquota_8c.html#a9">MmPageFileFullExtendPages</a> = 0;
01853     }
01854 
01855     PageExpand-&gt;InProgress = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01856     PageExpand-&gt;ActualExpansion = ExtendedSize;
01857 
01858     ExReleaseSpinLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a690">MmChargeCommitmentLock</a>, OldIrql);
01859 
01860     <span class="keywordflow">return</span> ExtendedSize;
01861 }
01862 
01863 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01864"></a><a class="code" href="../../d6/d3/modwrite_8c.html#a47">01864</a> <a class="code" href="../../d6/d3/modwrite_8c.html#a47">MiContractPagingFiles</a> (
01865     VOID
01866     )
01867 
01868 <span class="comment">/*++</span>
01869 <span class="comment"></span>
01870 <span class="comment">Routine Description:</span>
01871 <span class="comment"></span>
01872 <span class="comment">    This routine checks to see if ample space is no longer committed</span>
01873 <span class="comment">    and if so, does enough free space exist in any paging file.  IF</span>
01874 <span class="comment">    the answer to both these is affirmative, a reduction in the</span>
01875 <span class="comment">    paging file size(s) is attempted.</span>
01876 <span class="comment"></span>
01877 <span class="comment">Arguments:</span>
01878 <span class="comment"></span>
01879 <span class="comment">    None.</span>
01880 <span class="comment"></span>
01881 <span class="comment">Return Value:</span>
01882 <span class="comment"></span>
01883 <span class="comment">    None.</span>
01884 <span class="comment"></span>
01885 <span class="comment">--*/</span>
01886 
01887 {
01888     BOOLEAN Reduce;
01889     <a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html">PMMPAGE_FILE_EXPANSION</a> PageReduce;
01890     KIRQL OldIrql;
01891     ULONG i;
01892 
01893     Reduce = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01894 
01895     ExAcquireSpinLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a690">MmChargeCommitmentLock</a>, &amp;OldIrql);
01896 
01897     <span class="keywordflow">if</span> ((<a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a> - <a class="code" href="../../d4/d8/mi_8h.html#a733">MmMinimumPageFileReduction</a>) &gt;
01898                                                        <a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a>) {
01899 
01900         <span class="keywordflow">for</span> (i = 0;i &lt; <a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>; i += 1) {
01901             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o0">Size</a> != <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o2">MinimumSize</a>) {
01902                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o3">FreeSpace</a> &gt; <a class="code" href="../../d4/d8/mi_8h.html#a733">MmMinimumPageFileReduction</a>) {
01903                     Reduce = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01904                     <span class="keywordflow">break</span>;
01905                 }
01906             }
01907         }
01908 
01909         ExReleaseSpinLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a690">MmChargeCommitmentLock</a>, OldIrql);
01910 
01911         <span class="keywordflow">if</span> (!Reduce) {
01912             <span class="keywordflow">return</span>;
01913         }
01914 
01915         PageReduce = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
01916                                             <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html">MMPAGE_FILE_EXPANSION</a>),
01917                                             '  mM');
01918 
01919         <span class="keywordflow">if</span> (PageReduce == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01920             <span class="keywordflow">return</span>;
01921         }
01922 
01923         PageReduce-&gt;<a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html#o0">Segment</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01924         PageReduce-&gt;<a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html#o2">RequestedExpansionSize</a> = 0xFFFFFFFF;
01925 
01926         ExAcquireSpinLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a697">MmDereferenceSegmentHeader</a>.<a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html#o0">Lock</a>, &amp;OldIrql);
01927         InsertTailList ( &amp;<a class="code" href="../../d4/d8/mi_8h.html#a697">MmDereferenceSegmentHeader</a>.<a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html#o2">ListHead</a>,
01928                          &amp;PageReduce-&gt;<a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html#o1">DereferenceList</a>);
01929         ExReleaseSpinLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a697">MmDereferenceSegmentHeader</a>.<a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html#o0">Lock</a>, OldIrql);
01930 
01931         <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a697">MmDereferenceSegmentHeader</a>.<a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html#o1">Semaphore</a>, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>, 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01932         <span class="keywordflow">return</span>;
01933     }
01934 
01935     ExReleaseSpinLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a690">MmChargeCommitmentLock</a>, OldIrql);
01936     <span class="keywordflow">return</span>;
01937 }
01938 
01939 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01940"></a><a class="code" href="../../d6/d3/modwrite_8c.html#a48">01940</a> <a class="code" href="../../d6/d3/modwrite_8c.html#a48">MiAttemptPageFileReduction</a> (
01941     VOID
01942     )
01943 
01944 <span class="comment">/*++</span>
01945 <span class="comment"></span>
01946 <span class="comment">Routine Description:</span>
01947 <span class="comment"></span>
01948 <span class="comment">    This routine attempts to reduce the size of the paging files to</span>
01949 <span class="comment">    their minimum levels.</span>
01950 <span class="comment"></span>
01951 <span class="comment">    Note - Page file expansion and page file reduction are synchronized</span>
01952 <span class="comment">           because a single thread is responsible for performing the</span>
01953 <span class="comment">           operation.  Hence, while expansion is occurring, a reduction</span>
01954 <span class="comment">           request will be queued to the thread.</span>
01955 <span class="comment"></span>
01956 <span class="comment">Arguments:</span>
01957 <span class="comment"></span>
01958 <span class="comment">    None.</span>
01959 <span class="comment"></span>
01960 <span class="comment">Return Value:</span>
01961 <span class="comment"></span>
01962 <span class="comment">    None.</span>
01963 <span class="comment"></span>
01964 <span class="comment">--*/</span>
01965 
01966 {
01967     BOOLEAN Reduce;
01968     KIRQL OldIrql;
01969     ULONG i;
01970     PFN_NUMBER StartReduction;
01971     PFN_NUMBER ReductionSize;
01972     PFN_NUMBER TryBit;
01973     PFN_NUMBER TryReduction;
01974     SIZE_T MaxReduce;
01975     FILE_ALLOCATION_INFORMATION FileAllocationInfo;
01976     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01977 
01978     Reduce = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01979 
01980     ExAcquireSpinLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a690">MmChargeCommitmentLock</a>, &amp;OldIrql);
01981 
01982     <span class="comment">//</span>
01983     <span class="comment">// Make sure the commit limit is greater than the number of committed</span>
01984     <span class="comment">// pages by twice the minimum page file reduction.  Keep the</span>
01985     <span class="comment">// difference between the two at least minimum page file reduction.</span>
01986     <span class="comment">//</span>
01987 
01988     <span class="keywordflow">if</span> ((<a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a> + (2 * <a class="code" href="../../d4/d8/mi_8h.html#a733">MmMinimumPageFileReduction</a>)) &lt;
01989                                                      <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a>) {
01990 
01991         MaxReduce = <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a> -
01992                         (<a class="code" href="../../d4/d8/mi_8h.html#a733">MmMinimumPageFileReduction</a> + <a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a>);
01993         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((LONG)MaxReduce &gt;= 0);
01994 
01995         i = 0;
01996         <span class="keywordflow">do</span> {
01997 
01998             <span class="keywordflow">if</span> (MaxReduce &lt; <a class="code" href="../../d4/d8/mi_8h.html#a733">MmMinimumPageFileReduction</a>) {
01999 
02000                 <span class="comment">//</span>
02001                 <span class="comment">// Don't reduce any more paging files.</span>
02002                 <span class="comment">//</span>
02003 
02004                 <span class="keywordflow">break</span>;
02005             }
02006 
02007             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o2">MinimumSize</a> != <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o0">Size</a>) {
02008 
02009                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o3">FreeSpace</a> &gt; <a class="code" href="../../d4/d8/mi_8h.html#a733">MmMinimumPageFileReduction</a>) {
02010 
02011                     <span class="comment">//</span>
02012                     <span class="comment">// Attempt to reduce this paging file.</span>
02013                     <span class="comment">//</span>
02014 
02015                     ExReleaseSpinLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a690">MmChargeCommitmentLock</a>, OldIrql);
02016 
02017                     <span class="comment">//</span>
02018                     <span class="comment">// Lock the PFN database and check to see if ample pages</span>
02019                     <span class="comment">// are free at the end of the paging file.</span>
02020                     <span class="comment">//</span>
02021 
02022                     TryBit = <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o0">Size</a> - <a class="code" href="../../d4/d8/mi_8h.html#a733">MmMinimumPageFileReduction</a>;
02023                     TryReduction = <a class="code" href="../../d4/d8/mi_8h.html#a733">MmMinimumPageFileReduction</a>;
02024 
02025                     <span class="keywordflow">if</span> (TryBit &lt;= <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o2">MinimumSize</a>) {
02026                         TryBit = <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o2">MinimumSize</a>;
02027                         TryReduction = <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o0">Size</a> -
02028                                                    <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o2">MinimumSize</a>;
02029                     }
02030 
02031                     StartReduction = 0;
02032                     ReductionSize = 0;
02033 
02034                     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02035 
02036                     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02037 
02038                         <span class="comment">//</span>
02039                         <span class="comment">// Try to reduce.</span>
02040                         <span class="comment">//</span>
02041 
02042                         <span class="keywordflow">if</span> ((ReductionSize + TryReduction) &gt; MaxReduce) {
02043 
02044                             <span class="comment">//</span>
02045                             <span class="comment">// The reduction attempt would remove more</span>
02046                             <span class="comment">// than MaxReduce pages.</span>
02047                             <span class="comment">//</span>
02048 
02049                             <span class="keywordflow">break</span>;
02050                         }
02051 
02052                         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a40">RtlAreBitsClear</a> (<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;Bitmap,
02053                                              (ULONG)TryBit,
02054                                              (ULONG)TryReduction)) {
02055 
02056                             <span class="comment">//</span>
02057                             <span class="comment">// Can reduce it by TryReduction, see if it can</span>
02058                             <span class="comment">// be made smaller.</span>
02059                             <span class="comment">//</span>
02060 
02061                             StartReduction = TryBit;
02062                             ReductionSize += TryReduction;
02063 
02064                             <span class="keywordflow">if</span> (StartReduction == <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o2">MinimumSize</a>) {
02065                                 <span class="keywordflow">break</span>;
02066                             }
02067 
02068                             TryBit = StartReduction - <a class="code" href="../../d4/d8/mi_8h.html#a733">MmMinimumPageFileReduction</a>;
02069 
02070                             <span class="keywordflow">if</span> (TryBit &lt;= <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o2">MinimumSize</a>) {
02071                                 TryReduction -=
02072                                         <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o2">MinimumSize</a> - TryBit;
02073                                 TryBit = <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o2">MinimumSize</a>;
02074                             } <span class="keywordflow">else</span> {
02075                                 TryReduction = <a class="code" href="../../d4/d8/mi_8h.html#a733">MmMinimumPageFileReduction</a>;
02076                             }
02077                         } <span class="keywordflow">else</span> {
02078 
02079                             <span class="comment">//</span>
02080                             <span class="comment">// Reduction has failed.</span>
02081                             <span class="comment">//</span>
02082 
02083                             <span class="keywordflow">break</span>;
02084                         }
02085                     } <span class="comment">//end while</span>
02086 
02087                     <span class="comment">//</span>
02088                     <span class="comment">// Make sure there are no outstanding writes to</span>
02089                     <span class="comment">// pages within the start reduction range.</span>
02090                     <span class="comment">//</span>
02091 
02092                     <span class="keywordflow">if</span> (StartReduction != 0) {
02093 
02094                         <span class="comment">//</span>
02095                         <span class="comment">// There is an outstanding write past where the</span>
02096                         <span class="comment">// new end of the paging file should be.  This</span>
02097                         <span class="comment">// is a very rare condition, so just punt shrinking</span>
02098                         <span class="comment">// the file.</span>
02099                         <span class="comment">//</span>
02100 
02101                         <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o8">Entry</a>[0]-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o6">LastPageToWrite</a> &gt;
02102                                                               StartReduction) ||
02103                             (<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o8">Entry</a>[1]-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o6">LastPageToWrite</a> &gt;
02104                                                               StartReduction)) {
02105                             StartReduction = 0;
02106                         }
02107                     }
02108 
02109                     <span class="comment">//</span>
02110                     <span class="comment">// Are there any pages to remove?</span>
02111                     <span class="comment">//</span>
02112 
02113                     <span class="keywordflow">if</span> (StartReduction != 0) {
02114 
02115                         <span class="comment">//</span>
02116                         <span class="comment">// Reduce the paging file's size and free space.</span>
02117                         <span class="comment">//</span>
02118 
02119                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ReductionSize == (<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> - StartReduction));
02120 
02121                         <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o0">Size</a> = StartReduction;
02122                         <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o3">FreeSpace</a> -= ReductionSize;
02123                         MaxReduce -= ReductionSize;
02124                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((LONG)MaxReduce &gt;= 0);
02125 
02126                         <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a34">RtlSetBits</a> (<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;Bitmap,
02127                                     (ULONG)StartReduction,
02128                                     (ULONG)ReductionSize );
02129 
02130                         <span class="comment">//</span>
02131                         <span class="comment">// Release the PFN lock now that the size info</span>
02132                         <span class="comment">// has been updated.</span>
02133                         <span class="comment">//</span>
02134 
02135                         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02136 
02137                         <span class="comment">//</span>
02138                         <span class="comment">// Change the commit limit to reflect the returned</span>
02139                         <span class="comment">// page file space.</span>
02140                         <span class="comment">//</span>
02141 
02142                         ExAcquireSpinLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a690">MmChargeCommitmentLock</a>, &amp;OldIrql);
02143 
02144                         <span class="comment">//</span>
02145                         <span class="comment">// Now that the commit lock is again held, recheck</span>
02146                         <span class="comment">// the commit to ensure it is still safe to contract</span>
02147                         <span class="comment">// the paging files.</span>
02148                         <span class="comment">//</span>
02149 
02150                         <span class="keywordflow">if</span> ((<a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a> + (2 * <a class="code" href="../../d4/d8/mi_8h.html#a733">MmMinimumPageFileReduction</a>)) &gt;=
02151                                                                          <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a>) {
02152 
02153                             ExReleaseSpinLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a690">MmChargeCommitmentLock</a>, OldIrql);
02154                             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02155 
02156                             <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o0">Size</a> = StartReduction + ReductionSize;
02157                             <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o3">FreeSpace</a> += ReductionSize;
02158                             MaxReduce += ReductionSize;
02159                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((LONG)MaxReduce &gt;= 0);
02160     
02161                             <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a33">RtlClearBits</a> (<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;Bitmap,
02162                                           (ULONG)StartReduction,
02163                                           (ULONG)ReductionSize );
02164 
02165                             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02166 
02167                             ExAcquireSpinLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a690">MmChargeCommitmentLock</a>, &amp;OldIrql);
02168                             <span class="keywordflow">break</span>;
02169                         }
02170 
02171                         <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a> -= ReductionSize;
02172 
02173                         ExReleaseSpinLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a690">MmChargeCommitmentLock</a>, OldIrql);
02174 
02175 <span class="preprocessor">#if defined (_WIN64) || defined (_X86PAE_)</span>
02176 <span class="preprocessor"></span>                        FileAllocationInfo.AllocationSize.QuadPart =
02177                                                    ((ULONG64)StartReduction &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
02178 
02179 <span class="preprocessor">#else</span>
02180 <span class="preprocessor"></span>                        FileAllocationInfo.AllocationSize.LowPart =
02181                                                    StartReduction * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
02182 
02183                         <span class="comment">//</span>
02184                         <span class="comment">// Set high part to zero, paging files are</span>
02185                         <span class="comment">// limited to 4gb.</span>
02186                         <span class="comment">//</span>
02187 
02188                         FileAllocationInfo.AllocationSize.HighPart = 0;
02189 <span class="preprocessor">#endif</span>
02190 <span class="preprocessor"></span>
02191                         <span class="comment">//</span>
02192                         <span class="comment">// Reduce the allocated size of the paging file</span>
02193                         <span class="comment">// thereby actually freeing the space and</span>
02194                         <span class="comment">// setting a new end of file.</span>
02195                         <span class="comment">//</span>
02196 
02197 
02198                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() &lt; <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
02199                         status = <a class="code" href="../../d4/d6/iosubs_8c.html#a106">IoSetInformation</a> (
02200                                         <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>,
02201                                         FileAllocationInformation,
02202                                         <span class="keyword">sizeof</span>(FILE_ALLOCATION_INFORMATION),
02203                                         &amp;FileAllocationInfo
02204                                        );
02205 <span class="preprocessor">#if DBG</span>
02206 <span class="preprocessor"></span>
02207                         <span class="comment">//</span>
02208                         <span class="comment">// Ignore errors on truncating the paging file</span>
02209                         <span class="comment">// as we can always have less space in the bitmap</span>
02210                         <span class="comment">// than the pagefile holds.</span>
02211                         <span class="comment">//</span>
02212 
02213                         <span class="keywordflow">if</span> (status != STATUS_SUCCESS) {
02214                             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MM: pagefile truncate status %lx\n"</span>,
02215                                     status);
02216                         }
02217 <span class="preprocessor">#endif</span>
02218 <span class="preprocessor"></span>                    } <span class="keywordflow">else</span> {
02219                         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02220                     }
02221 
02222                     ExAcquireSpinLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a690">MmChargeCommitmentLock</a>, &amp;OldIrql);
02223                 }
02224             }
02225             i += 1;
02226         } <span class="keywordflow">while</span> (i &lt; <a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>);
02227     }
02228 
02229     ExReleaseSpinLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a690">MmChargeCommitmentLock</a>, OldIrql);
02230     <span class="keywordflow">return</span>;
02231 }
02232 
02233 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02234"></a><a class="code" href="../../d6/d3/modwrite_8c.html#a49">02234</a> <a class="code" href="../../d6/d3/modwrite_8c.html#a49">MiWriteComplete</a> (
02235     IN PVOID Context,
02236     IN PIO_STATUS_BLOCK IoStatus,
02237     IN ULONG Reserved
02238     )
02239 
02240 <span class="comment">/*++</span>
02241 <span class="comment"></span>
02242 <span class="comment">Routine Description:</span>
02243 <span class="comment"></span>
02244 <span class="comment">    This routine is the APC write completion procedure.  It is invoked</span>
02245 <span class="comment">    at APC_LEVEL when a page write operation is completed.</span>
02246 <span class="comment"></span>
02247 <span class="comment">Arguments:</span>
02248 <span class="comment"></span>
02249 <span class="comment">    Context - Supplies a pointer to the MOD_WRITER_MDL_ENTRY which was</span>
02250 <span class="comment">              used for this I/O.</span>
02251 <span class="comment"></span>
02252 <span class="comment">    IoStatus - Supplies a pointer to the IO_STATUS_BLOCK which was used</span>
02253 <span class="comment">               for this I/O.</span>
02254 <span class="comment"></span>
02255 <span class="comment">Return Value:</span>
02256 <span class="comment"></span>
02257 <span class="comment">    None.</span>
02258 <span class="comment"></span>
02259 <span class="comment">Environment:</span>
02260 <span class="comment"></span>
02261 <span class="comment">    Kernel mode, APC_LEVEL.</span>
02262 <span class="comment"></span>
02263 <span class="comment">--*/</span>
02264 
02265 {
02266 
02267     <a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html">PMMMOD_WRITER_MDL_ENTRY</a> WriterEntry;
02268     <a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html">PMMMOD_WRITER_MDL_ENTRY</a> NextWriterEntry;
02269     PPFN_NUMBER Page;
02270     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
02271     KIRQL OldIrql;
02272     LONG ByteCount;
02273     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02274     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
02275     ULONG FailAllIo;
02276     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject;
02277     <a class="code" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> FileResource;
02278 
02279     UNREFERENCED_PARAMETER (Reserved);
02280 
02281     FailAllIo = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02282 
02283 <span class="preprocessor">#if DBG</span>
02284 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a61">MM_DBG_MOD_WRITE</a>) {
02285         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MM MODWRITE: modified page write completed\n"</span>);
02286     }
02287 <span class="preprocessor">#endif</span>
02288 <span class="preprocessor"></span>
02289     <span class="comment">//</span>
02290     <span class="comment">// A page write has completed, at this time the pages are not</span>
02291     <span class="comment">// on any lists, write-in-progress is set in the PFN database,</span>
02292     <span class="comment">// and the reference count was incremented.</span>
02293     <span class="comment">//</span>
02294 
02295     WriterEntry = (<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html">PMMMOD_WRITER_MDL_ENTRY</a>)Context;
02296     ByteCount = (LONG)WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o13">Mdl</a>.<a class="code" href="../../d6/d7/struct__MDL.html#o6">ByteCount</a>;
02297     Page = &amp;WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o14">Page</a>[0];
02298 
02299     <span class="keywordflow">if</span> (WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o13">Mdl</a>.<a class="code" href="../../d6/d7/struct__MDL.html#o2">MdlFlags</a> &amp; <a class="code" href="../../d0/d9/ntosdef_8h.html#a12">MDL_MAPPED_TO_SYSTEM_VA</a>) {
02300         <a class="code" href="../../d5/d6/iosup_8c.html#a56">MmUnmapLockedPages</a> (WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o13">Mdl</a>.<a class="code" href="../../d6/d7/struct__MDL.html#o4">MappedSystemVa</a>,
02301                             &amp;WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o13">Mdl</a>);
02302     }
02303 
02304     <span class="comment">//</span>
02305     <span class="comment">// Get the PFN lock so the PFN database can be manipulated.</span>
02306     <span class="comment">//</span>
02307 
02308     status = IoStatus-&gt;Status;
02309     ControlArea = WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o11">ControlArea</a>;
02310 
02311     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02312 
02313     <span class="comment">//</span>
02314     <span class="comment">// Indicate that the write is complete.</span>
02315     <span class="comment">//</span>
02316 
02317     WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o6">LastPageToWrite</a> = 0;
02318 
02319 
02320     <span class="keywordflow">while</span> (ByteCount &gt; 0) {
02321 
02322         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (*Page);
02323         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.WriteInProgress == 1);
02324 <span class="preprocessor">#if DBG</span>
02325 <span class="preprocessor"></span>
02326         <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0) {
02327 
02328             ULONG <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
02329             <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a170">GET_PAGING_FILE_OFFSET</a>(Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>);
02330             <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> &lt; 8192) &amp;&amp;
02331                     (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a169">GET_PAGING_FILE_NUMBER</a>(Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>) == 0)) {
02332                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((<a class="code" href="../../d4/d8/mi_8h.html#a686">MmPagingFileDebug</a>[<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>] &amp; 1) != 0);
02333                 <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a121">MI_IS_PFN_DELETED</a>(Pfn1)) {
02334                     <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a169">GET_PAGING_FILE_NUMBER</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>)) == 0) {
02335                         <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d8/mi_8h.html#a686">MmPagingFileDebug</a>[<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>] &amp; ~0x1f) !=
02336                                    ((ULONG_PTR)Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> &lt;&lt; 3)) {
02337                             <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> != <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(PDE_BASE)) {
02338 
02339                                 <span class="comment">//</span>
02340                                 <span class="comment">// Make sure this isn't a PTE that was forked</span>
02341                                 <span class="comment">// during the I/O.</span>
02342                                 <span class="comment">//</span>
02343 
02344                                 <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> &lt; (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a5">PDE_TOP</a>) ||
02345                                     ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection &amp;
02346                                             <a class="code" href="../../d4/d8/mi_8h.html#a84">MM_COPY_ON_WRITE_MASK</a>) ==
02347                                                 <a class="code" href="../../d4/d8/mi_8h.html#a51">MM_PROTECTION_WRITE_MASK</a>)) {
02348                                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MMWRITE: Mismatch Pfn1 %p Offset %lx info %p\n"</span>,
02349                                              Pfn1,
02350                                              <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>,
02351                                              <a class="code" href="../../d4/d8/mi_8h.html#a686">MmPagingFileDebug</a>[<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>]);
02352 
02353                                     DbgBreakPoint();
02354 
02355                                 } <span class="keywordflow">else</span> {
02356                                     <a class="code" href="../../d4/d8/mi_8h.html#a686">MmPagingFileDebug</a>[<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>] &amp;= 0x1f;
02357                                     <a class="code" href="../../d4/d8/mi_8h.html#a686">MmPagingFileDebug</a>[<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>] |=
02358                                         ((ULONG_PTR)Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> &lt;&lt; 3);
02359                                 }
02360                             }
02361 
02362                         }
02363                     }
02364                 }
02365             }
02366         }
02367 <span class="preprocessor">#endif //DBG</span>
02368 <span class="preprocessor"></span>
02369         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.WriteInProgress = 0;
02370 
02371         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a3">NT_ERROR</a>(status)) {
02372 
02373             <span class="comment">//</span>
02374             <span class="comment">// If the file object is over the network, assume that this</span>
02375             <span class="comment">// I/O operation can never complete and mark the pages as</span>
02376             <span class="comment">// clean and indicate in the control area all I/O should fail.</span>
02377             <span class="comment">// Note that the modified bit in the PFN database is not set.</span>
02378             <span class="comment">//</span>
02379 
02380             <span class="keywordflow">if</span> (((status != STATUS_FILE_LOCK_CONFLICT) &amp;&amp;
02381                 (ControlArea != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
02382                 (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.Networked == 1))
02383                             ||
02384                 (status == STATUS_FILE_INVALID)) {
02385 
02386                 <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.FailAllIo == 0) {
02387                     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.FailAllIo = 1;
02388                     FailAllIo = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02389 
02390                     KdPrint((<span class="stringliteral">"MM MODWRITE: failing all io, controlarea %lx status %lx\n"</span>,
02391                           ControlArea, status));
02392                 }
02393             } <span class="keywordflow">else</span> {
02394 
02395                 <span class="comment">//</span>
02396                 <span class="comment">// The modified write operation failed, SET the modified bit</span>
02397                 <span class="comment">// for each page which was written and free the page file</span>
02398                 <span class="comment">// space.</span>
02399                 <span class="comment">//</span>
02400 
02401 <span class="preprocessor">#if DBG</span>
02402 <span class="preprocessor"></span>                <span class="keywordflow">if</span> ((status != STATUS_FILE_LOCK_CONFLICT) &amp;&amp;
02403                    ((MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a72">MM_DBG_PRINTS_MODWRITES</a>) == 0)) {
02404                     KdPrint((<span class="stringliteral">"MM MODWRITE: modified page write iosb failed - status 0x%lx\n"</span>,
02405                             status));
02406                 }
02407 <span class="preprocessor">#endif</span>
02408 <span class="preprocessor"></span>
02409                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified = 1;
02410             }
02411         }
02412 
02413         <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified == 1) &amp;&amp;
02414             (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0)) {
02415 
02416             <span class="comment">//</span>
02417             <span class="comment">// This page was modified since the write was done,</span>
02418             <span class="comment">// release the page file space.</span>
02419             <span class="comment">//</span>
02420 
02421             <a class="code" href="../../d4/d8/mi_8h.html#a889">MiReleasePageFileSpace</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>);
02422             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.PageFileHigh = 0;
02423         }
02424 
02425         <a class="code" href="../../d4/d8/mi_8h.html#a189">MI_REMOVE_LOCKED_PAGE_CHARGE</a> (Pfn1, 15);
02426         <a class="code" href="../../d6/d5/pfndec_8c.html#a2">MiDecrementReferenceCount</a> (*Page);
02427 <span class="preprocessor">#if DBG</span>
02428 <span class="preprocessor"></span>        *Page = 0xF0FFFFFF;
02429 <span class="preprocessor">#endif //DBG</span>
02430 <span class="preprocessor"></span>
02431         Page += 1;
02432         ByteCount -= (LONG)<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
02433     }
02434 
02435     <span class="comment">//</span>
02436     <span class="comment">// Check to which list to insert this entry into depending on</span>
02437     <span class="comment">// the amount of free space left in the paging file.</span>
02438     <span class="comment">//</span>
02439 
02440     FileObject = WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o10">File</a>;
02441     FileResource = WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o12">FileResource</a>;
02442 
02443     <span class="keywordflow">if</span> ((WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o9">PagingFile</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
02444         (WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o9">PagingFile</a>-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o3">FreeSpace</a> &lt; <a class="code" href="../../d4/d8/mi_8h.html#a17">MM_USABLE_PAGES_FREE</a>)) {
02445 
02446         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a717">MmNumberOfActiveMdlEntries</a> == 1) {
02447 
02448             <span class="comment">//</span>
02449             <span class="comment">// If we put this entry on the list, there will be</span>
02450             <span class="comment">// no more paging.  Locate all entries which are non</span>
02451             <span class="comment">// zero and pull them from the list.</span>
02452             <span class="comment">//</span>
02453 
02454             InsertTailList (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a716">MmFreePagingSpaceLow</a>, &amp;WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o0">Links</a>);
02455             WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o8">CurrentList</a> = &amp;<a class="code" href="../../d4/d8/mi_8h.html#a716">MmFreePagingSpaceLow</a>;
02456 
02457             <a class="code" href="../../d4/d8/mi_8h.html#a717">MmNumberOfActiveMdlEntries</a> -= 1;
02458 
02459             <span class="comment">//</span>
02460             <span class="comment">// Try to pull entries off the list.</span>
02461             <span class="comment">//</span>
02462 
02463             WriterEntry = (<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html">PMMMOD_WRITER_MDL_ENTRY</a>)<a class="code" href="../../d4/d8/mi_8h.html#a716">MmFreePagingSpaceLow</a>.Flink;
02464 
02465             <span class="keywordflow">while</span> ((PLIST_ENTRY)WriterEntry != &amp;<a class="code" href="../../d4/d8/mi_8h.html#a716">MmFreePagingSpaceLow</a>) {
02466 
02467                 NextWriterEntry =
02468                             (<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html">PMMMOD_WRITER_MDL_ENTRY</a>)WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o0">Links</a>.Flink;
02469 
02470                 <span class="keywordflow">if</span> (WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o9">PagingFile</a>-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o3">FreeSpace</a> != 0) {
02471 
02472                     RemoveEntryList (&amp;WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o0">Links</a>);
02473 
02474                     <span class="comment">//</span>
02475                     <span class="comment">// Insert this into the active list.</span>
02476                     <span class="comment">//</span>
02477 
02478                     <span class="keywordflow">if</span> (IsListEmpty (&amp;WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o7">PagingListHead</a>-&gt;<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o0">ListHead</a>)) {
02479                         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o7">PagingListHead</a>-&gt;<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o1">Event</a>,
02480                                     0,
02481                                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02482                     }
02483 
02484                     InsertTailList (&amp;WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o7">PagingListHead</a>-&gt;<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o0">ListHead</a>,
02485                                     &amp;WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o0">Links</a>);
02486                     WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o8">CurrentList</a> = &amp;<a class="code" href="../../d4/d8/mi_8h.html#a712">MmPagingFileHeader</a>.<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o0">ListHead</a>;
02487                     <a class="code" href="../../d4/d8/mi_8h.html#a717">MmNumberOfActiveMdlEntries</a> += 1;
02488                 }
02489 
02490                 WriterEntry = NextWriterEntry;
02491             }
02492 
02493         } <span class="keywordflow">else</span> {
02494 
02495             InsertTailList (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a716">MmFreePagingSpaceLow</a>, &amp;WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o0">Links</a>);
02496             WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o8">CurrentList</a> = &amp;<a class="code" href="../../d4/d8/mi_8h.html#a716">MmFreePagingSpaceLow</a>;
02497             <a class="code" href="../../d4/d8/mi_8h.html#a717">MmNumberOfActiveMdlEntries</a> -= 1;
02498         }
02499     } <span class="keywordflow">else</span> {
02500 
02501         <span class="comment">//</span>
02502         <span class="comment">// Ample space exists, put this on the active list.</span>
02503         <span class="comment">//</span>
02504 
02505         <span class="keywordflow">if</span> (IsListEmpty (&amp;WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o7">PagingListHead</a>-&gt;<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o0">ListHead</a>)) {
02506             <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o7">PagingListHead</a>-&gt;<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o1">Event</a>, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02507         }
02508 
02509         InsertTailList (&amp;WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o7">PagingListHead</a>-&gt;<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o0">ListHead</a>,
02510                         &amp;WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o0">Links</a>);
02511     }
02512 
02513     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (((ULONG_PTR)WriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o0">Links</a>.Flink &amp; 1) == 0);
02514 
02515     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02516 
02517     <span class="keywordflow">if</span> (FileResource != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02518         <a class="code" href="../../d1/d8/fsrtl_8h.html#a104">FsRtlReleaseFileForModWrite</a> (FileObject, FileResource);
02519     }
02520 
02521     <span class="keywordflow">if</span> (FailAllIo) {
02522 
02523         <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o19">FileName</a>.Length &amp;&amp;
02524             ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o19">FileName</a>.MaximumLength &amp;&amp;
02525             ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o19">FileName</a>.Buffer) {
02526 
02527             <a class="code" href="../../d4/d6/iosubs_8c.html#a94">IoRaiseInformationalHardError</a>(
02528                 STATUS_LOST_WRITEBEHIND_DATA,
02529                 &amp;ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o19">FileName</a>,
02530                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02531                 );
02532         }
02533     }
02534 
02535     <span class="keywordflow">if</span> (ControlArea != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02536 
02537         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02538 
02539         <span class="comment">//</span>
02540         <span class="comment">// A write to a mapped file just completed, check to see if</span>
02541         <span class="comment">// there are any waiters on the completion of this i/o.</span>
02542         <span class="comment">//</span>
02543 
02544         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o13">ModifiedWriteCount</a> -= 1;
02545         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o13">ModifiedWriteCount</a> &gt;= 0);
02546         <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.SetMappedFileIoComplete != 0) {
02547             <a class="code" href="../../d2/d8/eventobj_8c.html#a5">KePulseEvent</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a614">MmMappedFileIoComplete</a>,
02548                           0,
02549                           <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02550         }
02551 
02552         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o3">NumberOfPfnReferences</a> -= 1;
02553 
02554         <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o3">NumberOfPfnReferences</a> == 0) {
02555 
02556             <span class="comment">//</span>
02557             <span class="comment">// This routine return with the PFN lock released!.</span>
02558             <span class="comment">//</span>
02559 
02560             <a class="code" href="../../d5/d5/sectsup_8c.html#a24">MiCheckControlArea</a> (ControlArea, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, OldIrql);
02561         } <span class="keywordflow">else</span> {
02562             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02563         }
02564     }
02565 
02566     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a3">NT_ERROR</a>(status)) {
02567 
02568         <span class="comment">//</span>
02569         <span class="comment">// Wait for a short time so other processing can continue.</span>
02570         <span class="comment">//</span>
02571 
02572         <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;<a class="code" href="../../d4/d8/mi_8h.html#a422">Mm30Milliseconds</a>);
02573     }
02574 
02575     <span class="keywordflow">return</span>;
02576 }
02577 
02578 LOGICAL
<a name="l02579"></a><a class="code" href="../../d6/d3/modwrite_8c.html#a50">02579</a> <a class="code" href="../../d6/d3/modwrite_8c.html#a50">MiCancelWriteOfMappedPfn</a> (
02580     IN PFN_NUMBER PageToStop
02581     )
02582 
02583 <span class="comment">/*++</span>
02584 <span class="comment"></span>
02585 <span class="comment">Routine Description:</span>
02586 <span class="comment"></span>
02587 <span class="comment">    This routine attempts to stop a pending mapped page writer write for the</span>
02588 <span class="comment">    specified PFN.  Note that if the write can be stopped, any other pages</span>
02589 <span class="comment">    that may be clustered with the write are also stopped.</span>
02590 <span class="comment"></span>
02591 <span class="comment">Arguments:</span>
02592 <span class="comment"></span>
02593 <span class="comment">    PageToStop - Supplies the frame number that the caller wants to stop.</span>
02594 <span class="comment"></span>
02595 <span class="comment">Return Value:</span>
02596 <span class="comment"></span>
02597 <span class="comment">    TRUE if the write was stopped, FALSE if not.</span>
02598 <span class="comment"></span>
02599 <span class="comment">Environment:</span>
02600 <span class="comment"></span>
02601 <span class="comment">    Kernel mode, PFN lock held.  The PFN lock is released and reacquired if</span>
02602 <span class="comment">    the write was stopped.</span>
02603 <span class="comment"></span>
02604 <span class="comment">    N.B.  No other locks may be held as IRQL is lowered to APC_LEVEL here.</span>
02605 <span class="comment"></span>
02606 <span class="comment">--*/</span>
02607 
02608 {
02609     ULONG i;
02610     ULONG PageCount;
02611     KIRQL OldIrql;
02612     PPFN_NUMBER Page;
02613     PLIST_ENTRY NextEntry;
02614     <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> MemoryDescriptorList;
02615     <a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html">PMMMOD_WRITER_MDL_ENTRY</a> ModWriterEntry;
02616 
02617     <span class="comment">//</span>
02618     <span class="comment">// Walk the MmMappedPageWriterList looking for an MDL which contains</span>
02619     <span class="comment">// the argument page.  If found, remove it and cancel the write.</span>
02620     <span class="comment">//</span>
02621 
02622     NextEntry = <a class="code" href="../../d6/d3/modwrite_8c.html#a14">MmMappedPageWriterList</a>.Flink;
02623     <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d6/d3/modwrite_8c.html#a14">MmMappedPageWriterList</a>) {
02624 
02625         ModWriterEntry = CONTAINING_RECORD(NextEntry,
02626                                            <a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html">MMMOD_WRITER_MDL_ENTRY</a>,
02627                                            Links);
02628 
02629         MemoryDescriptorList = &amp;ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o13">Mdl</a>;
02630         PageCount = (MemoryDescriptorList-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o6">ByteCount</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
02631         Page = (PPFN_NUMBER)(MemoryDescriptorList + 1);
02632 
02633         <span class="keywordflow">for</span> (i = 0; i &lt; PageCount; i += 1) {
02634             <span class="keywordflow">if</span> (*Page == PageToStop) {
02635                 RemoveEntryList (NextEntry);
02636                 <span class="keywordflow">goto</span> CancelWrite;
02637             }
02638             Page += 1;
02639         }
02640 
02641         NextEntry = NextEntry-&gt;Flink;
02642     }
02643 
02644     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02645     
02646 CancelWrite:
02647 
02648     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>);
02649 
02650     <span class="comment">//</span>
02651     <span class="comment">// File lock conflict to indicate an error has occurred,</span>
02652     <span class="comment">// but that future I/Os should be allowed.  Keep APCs disabled and</span>
02653     <span class="comment">// call the write completion routine.</span>
02654     <span class="comment">//</span>
02655 
02656     ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o4">u</a>.IoStatus.Status = STATUS_FILE_LOCK_CONFLICT;
02657     ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o4">u</a>.IoStatus.Information = 0;
02658 
02659     <a class="code" href="../../d6/d3/modwrite_8c.html#a49">MiWriteComplete</a> ((PVOID)ModWriterEntry,
02660                      &amp;ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o4">u</a>.IoStatus,
02661                      0 );
02662 
02663     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02664 
02665     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02666 }
02667 
02668 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02669"></a><a class="code" href="../../d6/d3/modwrite_8c.html#a51">02669</a> <a class="code" href="../../d6/d3/modwrite_8c.html#a51">MiModifiedPageWriter</a> (
02670     IN PVOID StartContext
02671     )
02672 
02673 <span class="comment">/*++</span>
02674 <span class="comment"></span>
02675 <span class="comment">Routine Description:</span>
02676 <span class="comment"></span>
02677 <span class="comment">    Implements the NT modified page writer thread.  When the modified</span>
02678 <span class="comment">    page threshold is reached, or memory becomes overcommitted the</span>
02679 <span class="comment">    modified page writer event is set, and this thread becomes active.</span>
02680 <span class="comment"></span>
02681 <span class="comment">Arguments:</span>
02682 <span class="comment"></span>
02683 <span class="comment">    StartContext - not used.</span>
02684 <span class="comment"></span>
02685 <span class="comment">Return Value:</span>
02686 <span class="comment"></span>
02687 <span class="comment">    None.</span>
02688 <span class="comment"></span>
02689 <span class="comment">Environment:</span>
02690 <span class="comment"></span>
02691 <span class="comment">    Kernel mode.</span>
02692 <span class="comment"></span>
02693 <span class="comment">--*/</span>
02694 
02695 {
02696     HANDLE <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>;
02697     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
02698     ULONG i;
02699 
02700     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02701 
02702     StartContext;  <span class="comment">//avoid compiler warning.</span>
02703 
02704     <span class="comment">//</span>
02705     <span class="comment">// Initialize listheads as empty.</span>
02706     <span class="comment">//</span>
02707 
02708     <a class="code" href="../../d6/d3/modwrite_8c.html#a17">MmSystemShutdown</a> = 0;
02709     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a712">MmPagingFileHeader</a>.<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o1">Event</a>, NotificationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02710     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a713">MmMappedFileHeader</a>.<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o1">Event</a>, NotificationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02711 
02712     InitializeListHead(&amp;<a class="code" href="../../d4/d8/mi_8h.html#a712">MmPagingFileHeader</a>.<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o0">ListHead</a>);
02713     InitializeListHead(&amp;<a class="code" href="../../d4/d8/mi_8h.html#a713">MmMappedFileHeader</a>.<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o0">ListHead</a>);
02714     InitializeListHead(&amp;<a class="code" href="../../d4/d8/mi_8h.html#a716">MmFreePagingSpaceLow</a>);
02715 
02716     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d4/d8/mi_8h.html#a331">MM_MAPPED_FILE_MDLS</a>; i += 1) {
02717         <a class="code" href="../../d4/d8/mi_8h.html#a715">MmMappedFileMdl</a>[i] = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a175">NonPagedPoolMustSucceed</a>,
02718                                              <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html">MMMOD_WRITER_MDL_ENTRY</a>) +
02719                                                 <a class="code" href="../../d4/d8/mi_8h.html#a730">MmModifiedWriteClusterSize</a> *
02720                                                     <span class="keyword">sizeof</span>(PFN_NUMBER),
02721                                                 '  mM');
02722 
02723         <a class="code" href="../../d4/d8/mi_8h.html#a715">MmMappedFileMdl</a>[i]-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o9">PagingFile</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02724         <a class="code" href="../../d4/d8/mi_8h.html#a715">MmMappedFileMdl</a>[i]-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o7">PagingListHead</a> = &amp;<a class="code" href="../../d4/d8/mi_8h.html#a713">MmMappedFileHeader</a>;
02725 
02726         InsertTailList (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a713">MmMappedFileHeader</a>.<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o0">ListHead</a>,
02727                         &amp;<a class="code" href="../../d4/d8/mi_8h.html#a715">MmMappedFileMdl</a>[i]-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o0">Links</a>);
02728     }
02729 
02730     <span class="comment">//</span>
02731     <span class="comment">// Make this a real time thread.</span>
02732     <span class="comment">//</span>
02733 
02734     (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d9/d1/thredobj_8c.html#a24">KeSetPriorityThread</a> (&amp;<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;Tcb,
02735                                 LOW_REALTIME_PRIORITY + 1);
02736 
02737     <span class="comment">//</span>
02738     <span class="comment">// Start a secondary thread for writing mapped file pages.  This</span>
02739     <span class="comment">// is required as the writing of mapped file pages could cause</span>
02740     <span class="comment">// page faults resulting in requests for free pages.  But there</span>
02741     <span class="comment">// could be no free pages - hence a dead lock.  Rather than deadlock</span>
02742     <span class="comment">// the whole system waiting on the modified page writer, creating</span>
02743     <span class="comment">// a secondary thread allows that thread to block without affecting</span>
02744     <span class="comment">// on going page file writes.</span>
02745     <span class="comment">//</span>
02746 
02747     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a> (&amp;<a class="code" href="../../d6/d3/modwrite_8c.html#a15">MmMappedPageWriterEvent</a>, NotificationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02748     InitializeListHead(&amp;<a class="code" href="../../d6/d3/modwrite_8c.html#a14">MmMappedPageWriterList</a>);
02749     InitializeObjectAttributes( &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
02750 
02751     <a class="code" href="../../d2/d8/ps_2create_8c.html#a11">PsCreateSystemThread</a> (&amp;<a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>,
02752                           THREAD_ALL_ACCESS,
02753                           &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
02754                           0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
02755                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02756                           <a class="code" href="../../d4/d8/mi_8h.html#a878">MiMappedPageWriter</a>,
02757                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
02758     ZwClose (<a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>);
02759     <a class="code" href="../../d6/d3/modwrite_8c.html#a39">MiModifiedPageWriterWorker</a>();
02760 
02761     <span class="comment">//</span>
02762     <span class="comment">// Shutdown in progress, wait forever.</span>
02763     <span class="comment">//</span>
02764 
02765     {
02766         LARGE_INTEGER Forever;
02767 
02768         <span class="comment">//</span>
02769         <span class="comment">// System has shutdown, go into LONG wait.</span>
02770         <span class="comment">//</span>
02771 
02772         Forever.LowPart = 0;
02773         Forever.HighPart = 0xF000000;
02774         <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;Forever);
02775     }
02776 
02777     <span class="keywordflow">return</span>;
02778 }
02779 
02780 
02781 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02782"></a><a class="code" href="../../d6/d3/modwrite_8c.html#a52">02782</a> <a class="code" href="../../d6/d3/modwrite_8c.html#a52">MiModifiedPageWriterTimerDispatch</a> (
02783     IN <a class="code" href="../../d1/d6/struct__KDPC.html">PKDPC</a> Dpc,
02784     IN PVOID DeferredContext,
02785     IN PVOID SystemArgument1,
02786     IN PVOID SystemArgument2
02787     )
02788 
02789 <span class="comment">/*++</span>
02790 <span class="comment"></span>
02791 <span class="comment">Routine Description:</span>
02792 <span class="comment"></span>
02793 <span class="comment">    This routine is executed whenever modified mapped pages are waiting to</span>
02794 <span class="comment">    be written.  Its job is to signal the Modified Page Writer to write</span>
02795 <span class="comment">    these out.</span>
02796 <span class="comment"></span>
02797 <span class="comment">Arguments:</span>
02798 <span class="comment"></span>
02799 <span class="comment">    Dpc - Supplies a pointer to a control object of type DPC.</span>
02800 <span class="comment"></span>
02801 <span class="comment">    DeferredContext - Optional deferred context;  not used.</span>
02802 <span class="comment"></span>
02803 <span class="comment">    SystemArgument1 - Optional argument 1;  not used.</span>
02804 <span class="comment"></span>
02805 <span class="comment">    SystemArgument2 - Optional argument 2;  not used.</span>
02806 <span class="comment"></span>
02807 <span class="comment">Return Value:</span>
02808 <span class="comment"></span>
02809 <span class="comment">    None.</span>
02810 <span class="comment"></span>
02811 <span class="comment">--*/</span>
02812 
02813 {
02814     KIRQL OldIrql;
02815 
02816     UNREFERENCED_PARAMETER (Dpc);
02817     UNREFERENCED_PARAMETER (DeferredContext);
02818     UNREFERENCED_PARAMETER (SystemArgument1);
02819     UNREFERENCED_PARAMETER (SystemArgument2);
02820 
02821     <a class="code" href="../../d4/d8/mi_8h.html#a130">LOCK_PFN2</a> (OldIrql);
02822 
02823     <a class="code" href="../../d4/d8/mi_8h.html#a735">MiTimerPending</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02824     <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a736">MiMappedPagesTooOldEvent</a>, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02825 
02826     <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql);
02827 }
02828 
02829 
02830 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02831"></a><a class="code" href="../../d6/d3/modwrite_8c.html#a39">02831</a> <a class="code" href="../../d6/d3/modwrite_8c.html#a39">MiModifiedPageWriterWorker</a> (
02832     VOID
02833     )
02834 
02835 <span class="comment">/*++</span>
02836 <span class="comment"></span>
02837 <span class="comment">Routine Description:</span>
02838 <span class="comment"></span>
02839 <span class="comment">    Implements the NT modified page writer thread.  When the modified</span>
02840 <span class="comment">    page threshold is reached, or memory becomes overcommitted the</span>
02841 <span class="comment">    modified page writer event is set, and this thread becomes active.</span>
02842 <span class="comment"></span>
02843 <span class="comment">Arguments:</span>
02844 <span class="comment"></span>
02845 <span class="comment">    None.</span>
02846 <span class="comment"></span>
02847 <span class="comment">Return Value:</span>
02848 <span class="comment"></span>
02849 <span class="comment">    None.</span>
02850 <span class="comment"></span>
02851 <span class="comment">Environment:</span>
02852 <span class="comment"></span>
02853 <span class="comment">    Kernel mode.</span>
02854 <span class="comment"></span>
02855 <span class="comment">--*/</span>
02856 
02857 {
02858     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
02859     PFN_NUMBER PageFrameIndex;
02860     KIRQL OldIrql;
02861     ULONG NextColor;
02862     ULONG i;
02863     <span class="keyword">static</span> <a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html">KWAIT_BLOCK</a> WaitBlockArray[<a class="code" href="../../d6/d3/modwrite_8c.html#a60a28">ModifiedWriterMaximumObject</a>];
02864     PVOID WaitObjects[<a class="code" href="../../d6/d3/modwrite_8c.html#a60a28">ModifiedWriterMaximumObject</a>];
02865     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> WakeupStatus;
02866 
02867     <span class="comment">//</span>
02868     <span class="comment">// Wait for the modified page writer event or the mapped pages event.</span>
02869     <span class="comment">//</span>
02870 
02871     WaitObjects[<a class="code" href="../../d6/d3/modwrite_8c.html#a60a26">NormalCase</a>] = (PVOID)&amp;<a class="code" href="../../d4/d8/mi_8h.html#a719">MmModifiedPageWriterEvent</a>;
02872     WaitObjects[<a class="code" href="../../d6/d3/modwrite_8c.html#a60a27">MappedPagesNeedWriting</a>] = (PVOID)&amp;<a class="code" href="../../d4/d8/mi_8h.html#a736">MiMappedPagesTooOldEvent</a>;
02873 
02874     <span class="keywordflow">for</span> (;;) {
02875 
02876         WakeupStatus = <a class="code" href="../../d1/d7/wait_8c.html#a3">KeWaitForMultipleObjects</a>(<a class="code" href="../../d6/d3/modwrite_8c.html#a60a28">ModifiedWriterMaximumObject</a>,
02877                                           &amp;WaitObjects[0],
02878                                           WaitAny,
02879                                           <a class="code" href="../../d4/d9/ke_8h.html#a407a206">WrFreePage</a>,
02880                                           <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
02881                                           <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
02882                                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02883                                           &amp;WaitBlockArray[0]);
02884 
02885         <span class="comment">//</span>
02886         <span class="comment">// Switch on the wait status.</span>
02887         <span class="comment">//</span>
02888 
02889         <span class="keywordflow">switch</span> (WakeupStatus) {
02890 
02891         <span class="keywordflow">case</span> <a class="code" href="../../d6/d3/modwrite_8c.html#a60a26">NormalCase</a>:
02892                 <span class="keywordflow">break</span>;
02893 
02894         <span class="keywordflow">case</span> <a class="code" href="../../d6/d3/modwrite_8c.html#a60a27">MappedPagesNeedWriting</a>:
02895 
02896                 <span class="comment">//</span>
02897                 <span class="comment">// Our mapped pages DPC went off, only deal with those pages.</span>
02898                 <span class="comment">// Write all the mapped pages (ONLY), then clear the flag</span>
02899                 <span class="comment">// and come back to the top.</span>
02900                 <span class="comment">//</span>
02901 
02902                 <span class="keywordflow">break</span>;
02903 
02904         <span class="keywordflow">default</span>:
02905                 <span class="keywordflow">break</span>;
02906 
02907         }
02908 
02909         <span class="comment">//</span>
02910         <span class="comment">// Indicate that the hint values have not been reset in</span>
02911         <span class="comment">// the paging files.</span>
02912         <span class="comment">//</span>
02913 
02914         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a> != 0) {
02915             i = 0;
02916             <span class="keywordflow">do</span> {
02917                 <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o14">HintSetToZero</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02918                 i += 1;
02919             } <span class="keywordflow">while</span> (i &lt; <a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>);
02920         }
02921 
02922         NextColor = 0;
02923 
02924         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02925 
02926         <span class="keywordflow">for</span> (;;) {
02927 
02928             <span class="comment">//</span>
02929             <span class="comment">// Modified page writer was signalled.</span>
02930             <span class="comment">//</span>
02931 
02932             <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &lt; <a class="code" href="../../d4/d8/mi_8h.html#a727">MmFreeGoal</a>) &amp;&amp;
02933                 (<a class="code" href="../../d4/d8/mi_8h.html#a608">MmModNoWriteInsert</a>)) {
02934 
02935                 <span class="comment">//</span>
02936                 <span class="comment">// Remove pages from the modified no write list</span>
02937                 <span class="comment">// that are waiting for the cache manager to flush them.</span>
02938                 <span class="comment">//</span>
02939 
02940                 i = 0;
02941                 <span class="keywordflow">while</span> ((<a class="code" href="../../d8/d5/kddata_8c.html#a40">MmModifiedNoWritePageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> != 0) &amp;&amp;
02942                       (i &lt; 32)) {
02943                     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> Subsection;
02944                     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
02945 
02946                     PageFrameIndex = <a class="code" href="../../d8/d5/kddata_8c.html#a40">MmModifiedNoWritePageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o2">Flink</a>;
02947                     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
02948                     Subsection = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a148">MiGetSubsectionAddress</a> (&amp;Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>);
02949                     ControlArea = Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o0">ControlArea</a>;
02950                     <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.NoModifiedWriting) {
02951                         <a class="code" href="../../d4/d8/mi_8h.html#a608">MmModNoWriteInsert</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02952                         <span class="keywordflow">break</span>;
02953                     }
02954                     <a class="code" href="../../d7/d5/pfnlist_8c.html#a11">MiUnlinkPageFromList</a> (Pfn1);
02955                     <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (&amp;<a class="code" href="../../d2/d1/mm_8h.html#a150">MmModifiedPageListHead</a>,
02956                                         PageFrameIndex);
02957                     i += 1;
02958                 }
02959             }
02960 
02961             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a150">MmModifiedPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> == 0) {
02962 
02963                 <span class="comment">//</span>
02964                 <span class="comment">// No more pages, clear the event(s) and wait again...</span>
02965                 <span class="comment">// Note we can clear both events regardless of why we woke up</span>
02966                 <span class="comment">// since no modified pages of any type exist.</span>
02967                 <span class="comment">//</span>
02968 
02969                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a735">MiTimerPending</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02970                     <a class="code" href="../../d4/d8/mi_8h.html#a735">MiTimerPending</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02971                     <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a736">MiMappedPagesTooOldEvent</a>);
02972                 }
02973 
02974                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02975 
02976                 <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a719">MmModifiedPageWriterEvent</a>);
02977 
02978                 <span class="keywordflow">break</span>;
02979             }
02980 
02981             <span class="comment">//</span>
02982             <span class="comment">// If we didn't wake up explicitly to deal with mapped pages,</span>
02983             <span class="comment">// then determine which type of pages are the most popular:</span>
02984             <span class="comment">// page file backed pages, or mapped file backed pages.</span>
02985             <span class="comment">//</span>
02986 
02987             <span class="keywordflow">if</span> (WakeupStatus == <a class="code" href="../../d6/d3/modwrite_8c.html#a60a27">MappedPagesNeedWriting</a>) {
02988                 PageFrameIndex = <a class="code" href="../../d2/d1/mm_8h.html#a150">MmModifiedPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o2">Flink</a>;
02989                 <span class="keywordflow">if</span> (PageFrameIndex == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
02990 
02991                     <span class="comment">//</span>
02992                     <span class="comment">// No more modified mapped pages (there may still be</span>
02993                     <span class="comment">// modified pagefile-destined pages), so clear only the</span>
02994                     <span class="comment">// mapped pages event and check for directions at the top</span>
02995                     <span class="comment">// again.</span>
02996                     <span class="comment">//</span>
02997 
02998                     <a class="code" href="../../d4/d8/mi_8h.html#a735">MiTimerPending</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02999                     <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a736">MiMappedPagesTooOldEvent</a>);
03000 
03001                     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03002 
03003                     <span class="keywordflow">break</span>;
03004                 }
03005             }
03006             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d4/d2/datalpha_8c.html#a23">MmTotalPagesForPagingFile</a> &gt;=
03007                 (<a class="code" href="../../d2/d1/mm_8h.html#a150">MmModifiedPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> - <a class="code" href="../../d4/d2/datalpha_8c.html#a23">MmTotalPagesForPagingFile</a>)) {
03008 
03009                 <span class="comment">//</span>
03010                 <span class="comment">// More pages are destined for the paging file.</span>
03011                 <span class="comment">//</span>
03012 
03013                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a134">MI_GET_MODIFIED_PAGE_ANY_COLOR</a> (PageFrameIndex, NextColor);
03014 
03015             } <span class="keywordflow">else</span> {
03016 
03017                 <span class="comment">//</span>
03018                 <span class="comment">// More pages are destined for mapped files.</span>
03019                 <span class="comment">//</span>
03020 
03021                 PageFrameIndex = <a class="code" href="../../d2/d1/mm_8h.html#a150">MmModifiedPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o2">Flink</a>;
03022             }
03023 
03024             <span class="comment">//</span>
03025             <span class="comment">// Check to see what type of page (section file backed or page</span>
03026             <span class="comment">// file backed) and write out that page and more if possible.</span>
03027             <span class="comment">//</span>
03028 
03029             <span class="comment">//</span>
03030             <span class="comment">// Check to see if this page is destined for a paging file or</span>
03031             <span class="comment">// a mapped file.</span>
03032             <span class="comment">//</span>
03033 
03034             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
03035 
03036             <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 1) {
03037                 <span class="keywordflow">if</span> (IsListEmpty (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a713">MmMappedFileHeader</a>.<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o0">ListHead</a>)) {
03038 
03039                     <span class="comment">//</span>
03040                     <span class="comment">// Make sure page is destined for paging file as there</span>
03041                     <span class="comment">// are no MDLs for mapped writes free.</span>
03042                     <span class="comment">//</span>
03043 
03044                     <span class="keywordflow">if</span> (WakeupStatus != <a class="code" href="../../d6/d3/modwrite_8c.html#a60a27">MappedPagesNeedWriting</a>) {
03045 
03046                         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a134">MI_GET_MODIFIED_PAGE_ANY_COLOR</a> (PageFrameIndex, NextColor);
03047 
03048                         <span class="comment">//</span>
03049                         <span class="comment">// No pages are destined for the paging file, get the</span>
03050                         <span class="comment">// first page destined for a mapped file.</span>
03051                         <span class="comment">//</span>
03052 
03053                         <span class="keywordflow">if</span> (PageFrameIndex == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
03054 
03055                             <span class="comment">//</span>
03056                             <span class="comment">// Select the first page from the list anyway.</span>
03057                             <span class="comment">//</span>
03058 
03059                             PageFrameIndex = <a class="code" href="../../d2/d1/mm_8h.html#a150">MmModifiedPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o2">Flink</a>;
03060                         }
03061 
03062                         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
03063                     }
03064                 }
03065             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((IsListEmpty(&amp;<a class="code" href="../../d4/d8/mi_8h.html#a712">MmPagingFileHeader</a>.<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o0">ListHead</a>)) ||
03066                        (<a class="code" href="../../d6/d3/modwrite_8c.html#a10">MiFirstPageFileCreatedAndReady</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
03067 
03068                 <span class="comment">//</span>
03069                 <span class="comment">// Try for a dirty section-backed page as no paging file MDLs</span>
03070                 <span class="comment">// are available.</span>
03071                 <span class="comment">//</span>
03072 
03073                 <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a150">MmModifiedPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o2">Flink</a> != <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
03074                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d2/datalpha_8c.html#a23">MmTotalPagesForPagingFile</a> != <a class="code" href="../../d2/d1/mm_8h.html#a150">MmModifiedPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a>);
03075                     PageFrameIndex = <a class="code" href="../../d2/d1/mm_8h.html#a150">MmModifiedPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o2">Flink</a>;
03076                     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
03077                 }
03078                 <span class="keywordflow">else</span> {
03079                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d2/datalpha_8c.html#a23">MmTotalPagesForPagingFile</a> == <a class="code" href="../../d2/d1/mm_8h.html#a150">MmModifiedPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a>);
03080                     <span class="keywordflow">if</span> ((<a class="code" href="../../d6/d3/modwrite_8c.html#a10">MiFirstPageFileCreatedAndReady</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp;
03081                         (<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a> != 0)) {
03082 
03083                         <span class="comment">//</span>
03084                         <span class="comment">// The first paging has been created but the reservation</span>
03085                         <span class="comment">// checking for crashdumps has not finished yet.  Delay</span>
03086                         <span class="comment">// a bit as this will finish shortly and then restart.</span>
03087                         <span class="comment">//</span>
03088 
03089                         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03090                         <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;<a class="code" href="../../d4/d8/mi_8h.html#a420">MmShortTime</a>);
03091                         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
03092                         <span class="keywordflow">continue</span>;
03093                     }
03094                 }
03095             }
03096 
03097             <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 1) {
03098 
03099                 <span class="keywordflow">if</span> (IsListEmpty(&amp;<a class="code" href="../../d4/d8/mi_8h.html#a713">MmMappedFileHeader</a>.<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o0">ListHead</a>)) {
03100 
03101                     <span class="keywordflow">if</span> (WakeupStatus == <a class="code" href="../../d6/d3/modwrite_8c.html#a60a27">MappedPagesNeedWriting</a>) {
03102 
03103                         <span class="comment">//</span>
03104                         <span class="comment">// Since we woke up only to take care of mapped pages,</span>
03105                         <span class="comment">// don't wait for an MDL below because drivers may take</span>
03106                         <span class="comment">// an inordinate amount of time processing the</span>
03107                         <span class="comment">// outstanding ones.  We might have to wait too long,</span>
03108                         <span class="comment">// resulting in the system running out of pages.</span>
03109                         <span class="comment">//</span>
03110 
03111                         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a735">MiTimerPending</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
03112 
03113                             <span class="comment">//</span>
03114                             <span class="comment">// This should be normal case - the reason we must</span>
03115                             <span class="comment">// first check timer pending above is for the rare</span>
03116                             <span class="comment">// case - when this thread first ran for normal</span>
03117                             <span class="comment">// modified page processing and took</span>
03118                             <span class="comment">// care of all the pages including the mapped ones.</span>
03119                             <span class="comment">// Then this thread woke up again for the mapped</span>
03120                             <span class="comment">// reason and here we are.</span>
03121                             <span class="comment">//</span>
03122 
03123                             <a class="code" href="../../d4/d8/mi_8h.html#a735">MiTimerPending</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03124                             <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a736">MiMappedPagesTooOldEvent</a>);
03125                         }
03126 
03127                         <a class="code" href="../../d4/d8/mi_8h.html#a735">MiTimerPending</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03128 
03129                         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d3/d2/timerobj_8c.html#a7">KeSetTimerEx</a>( &amp;<a class="code" href="../../d4/d8/mi_8h.html#a738">MiModifiedPageWriterTimer</a>, <a class="code" href="../../d4/d8/mi_8h.html#a734">MiModifiedPageLife</a>, 0, &amp;<a class="code" href="../../d4/d8/mi_8h.html#a737">MiModifiedPageWriterTimerDpc</a> );
03130                         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03131                         <span class="keywordflow">break</span>;
03132                     }
03133 
03134                     <span class="comment">//</span>
03135                     <span class="comment">// Reset the event indicating no mapped files in</span>
03136                     <span class="comment">// the list, drop the PFN lock and wait for an</span>
03137                     <span class="comment">// I/O operation to complete with a one second</span>
03138                     <span class="comment">// timeout.</span>
03139                     <span class="comment">//</span>
03140 
03141                     <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a713">MmMappedFileHeader</a>.<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o1">Event</a>);
03142 
03143                     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03144                     <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;<a class="code" href="../../d4/d8/mi_8h.html#a713">MmMappedFileHeader</a>.<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o1">Event</a>,
03145                                            <a class="code" href="../../d4/d9/ke_8h.html#a407a217">WrPageOut</a>,
03146                                            <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
03147                                            <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
03148                                            &amp;<a class="code" href="../../d4/d8/mi_8h.html#a422">Mm30Milliseconds</a>);
03149                     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
03150 
03151                     <span class="comment">//</span>
03152                     <span class="comment">// Don't go on as the old PageFrameIndex at the</span>
03153                     <span class="comment">// top of the ModifiedList may have changed states.</span>
03154                     <span class="comment">//</span>
03155 
03156                     <span class="keywordflow">continue</span>;
03157                 }
03158 
03159                 <a class="code" href="../../d6/d3/modwrite_8c.html#a35">MiGatherMappedPages</a> (Pfn1, PageFrameIndex);
03160 
03161             } <span class="keywordflow">else</span> {
03162 
03163                 <a class="code" href="../../d6/d3/modwrite_8c.html#a36">MiGatherPagefilePages</a> (Pfn1, PageFrameIndex);
03164             }
03165 
03166             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d3/modwrite_8c.html#a17">MmSystemShutdown</a>) {
03167 
03168                 <span class="comment">//</span>
03169                 <span class="comment">// Shutdown has returned.  Stop the modified page writer.</span>
03170                 <span class="comment">//</span>
03171 
03172                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03173                 <span class="keywordflow">return</span>;
03174             }
03175 
03176             <span class="keywordflow">if</span> (WakeupStatus != <a class="code" href="../../d6/d3/modwrite_8c.html#a60a27">MappedPagesNeedWriting</a> &amp;&amp; !<a class="code" href="../../d6/d3/modwrite_8c.html#a9">MmWriteAllModifiedPages</a>) {
03177                 <span class="keywordflow">if</span> (((<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &gt; <a class="code" href="../../d4/d8/mi_8h.html#a727">MmFreeGoal</a>) &amp;&amp;
03178                         (<a class="code" href="../../d2/d1/mm_8h.html#a150">MmModifiedPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> &lt; <a class="code" href="../../d4/d8/mi_8h.html#a727">MmFreeGoal</a>))
03179                          ||
03180                     (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &gt; <a class="code" href="../../d4/d8/mi_8h.html#a588">MmMoreThanEnoughFreePages</a>)) {
03181 
03182                     <span class="comment">//</span>
03183                     <span class="comment">// There are ample pages, clear the event and wait again...</span>
03184                     <span class="comment">//</span>
03185 
03186                     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03187 
03188                     <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a719">MmModifiedPageWriterEvent</a>);
03189                     <span class="keywordflow">break</span>;
03190                 }
03191             }
03192         } <span class="comment">// end for</span>
03193 
03194     } <span class="comment">// end for</span>
03195 }
03196 
03197 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03198"></a><a class="code" href="../../d6/d3/modwrite_8c.html#a35">03198</a> <a class="code" href="../../d6/d3/modwrite_8c.html#a35">MiGatherMappedPages</a> (
03199     IN <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1,
03200     IN PFN_NUMBER PageFrameIndex
03201     )
03202 
03203 <span class="comment">/*++</span>
03204 <span class="comment"></span>
03205 <span class="comment">Routine Description:</span>
03206 <span class="comment"></span>
03207 <span class="comment">    This routine processes the specified modified page by examining</span>
03208 <span class="comment">    the prototype PTE for that page and the adjacent prototype PTEs</span>
03209 <span class="comment">    building a cluster of modified pages destined for a mapped file.</span>
03210 <span class="comment">    Once the cluster is built, it is sent to the mapped writer thread</span>
03211 <span class="comment">    to be processed.</span>
03212 <span class="comment"></span>
03213 <span class="comment">Arguments:</span>
03214 <span class="comment"></span>
03215 <span class="comment">    Pfn1 - Supplies a pointer to the PFN element for the corresponding</span>
03216 <span class="comment">           page.</span>
03217 <span class="comment"></span>
03218 <span class="comment">    PageFrameIndex - Supplies the physical page frame to write.</span>
03219 <span class="comment"></span>
03220 <span class="comment">Return Value:</span>
03221 <span class="comment"></span>
03222 <span class="comment">    None.</span>
03223 <span class="comment"></span>
03224 <span class="comment">Environment:</span>
03225 <span class="comment"></span>
03226 <span class="comment">    PFN lock held.</span>
03227 <span class="comment"></span>
03228 <span class="comment">--*/</span>
03229 
03230 {
03231     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn2;
03232     <a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html">PMMMOD_WRITER_MDL_ENTRY</a> ModWriterEntry;
03233     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> Subsection;
03234     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
03235     PPFN_NUMBER Page;
03236     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
03237     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> BasePte;
03238     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> NextPte;
03239     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
03240     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartingPte;
03241     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
03242     KIRQL OldIrql = 0;
03243     KIRQL OldIrql2;
03244 
03245     <span class="comment">//</span>
03246     <span class="comment">// This page is destined for a mapped file, check to see if</span>
03247     <span class="comment">// there are any physically adjacent pages are also in the</span>
03248     <span class="comment">// modified page list and write them out at the same time.</span>
03249     <span class="comment">//</span>
03250 
03251     Subsection = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a148">MiGetSubsectionAddress</a> (&amp;Pfn1-&gt;OriginalPte);
03252     ControlArea = Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o0">ControlArea</a>;
03253 
03254     <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.NoModifiedWriting) {
03255 
03256         <span class="comment">//</span>
03257         <span class="comment">// This page should not be written out, add it to the</span>
03258         <span class="comment">// tail of the modified NO WRITE list and get the next page.</span>
03259         <span class="comment">//</span>
03260 
03261         <a class="code" href="../../d7/d5/pfnlist_8c.html#a11">MiUnlinkPageFromList</a> (Pfn1);
03262         <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (<a class="code" href="../../d4/d8/mi_8h.html#a606">MmPageLocationList</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a175">ModifiedNoWritePageList</a>],
03263                             PageFrameIndex);
03264         <span class="keywordflow">return</span>;
03265     }
03266 
03267     <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.Image) {
03268 
03269 <span class="preprocessor">#if 0</span>
03270 <span class="preprocessor"></span>        <span class="comment">//</span>
03271         <span class="comment">// Assert that there are no dangling shared global pages</span>
03272         <span class="comment">// for an image section that is not being used.</span>
03273         <span class="comment">//</span>
03274         <span class="comment">// This assert can be re-enabled when the segment dereference</span>
03275         <span class="comment">// thread list re-insertion is fixed.  Note the recovery code is</span>
03276         <span class="comment">// fine, so disabling the assert is benign.</span>
03277         <span class="comment">//</span>
03278 
03279         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o4">NumberOfMappedViews</a> != 0) ||
03280                 (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o2">NumberOfSectionReferences</a> != 0) ||
03281                 (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.FloppyMedia != 0));
03282 <span class="preprocessor">#endif</span>
03283 <span class="preprocessor"></span>
03284         <span class="comment">//</span>
03285         <span class="comment">// This is an image section, writes are not</span>
03286         <span class="comment">// allowed to an image section.</span>
03287         <span class="comment">//</span>
03288 
03289         <span class="comment">//</span>
03290         <span class="comment">// Change page contents to look like it's a demand zero</span>
03291         <span class="comment">// page and put it back into the modified list.</span>
03292         <span class="comment">//</span>
03293 
03294         <span class="comment">//</span>
03295         <span class="comment">// Decrement the count for PfnReferences to the</span>
03296         <span class="comment">// segment as paging file pages are not counted as</span>
03297         <span class="comment">// "image" references.</span>
03298         <span class="comment">//</span>
03299 
03300         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o3">NumberOfPfnReferences</a> -= 1;
03301         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((LONG)ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o3">NumberOfPfnReferences</a> &gt;= 0);
03302         <a class="code" href="../../d7/d5/pfnlist_8c.html#a11">MiUnlinkPageFromList</a> (Pfn1);
03303 
03304         Pfn1-&gt;OriginalPte.u.Soft.PageFileHigh = 0;
03305         Pfn1-&gt;OriginalPte.u.Soft.Prototype = 0;
03306         Pfn1-&gt;OriginalPte.u.Soft.Transition = 0;
03307 
03308         <span class="comment">//</span>
03309         <span class="comment">// Insert the page at the tail of the list and get</span>
03310         <span class="comment">// color update performed.</span>
03311         <span class="comment">//</span>
03312 
03313         <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (<a class="code" href="../../d4/d8/mi_8h.html#a606">MmPageLocationList</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a174">ModifiedPageList</a>],
03314                             PageFrameIndex);
03315         <span class="keywordflow">return</span>;
03316     }
03317 
03318     <span class="keywordflow">if</span> ((ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.HadUserReference == 0) &amp;&amp;
03319         (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &gt; (<a class="code" href="../../d4/d8/mi_8h.html#a727">MmFreeGoal</a> + 40)) &amp;&amp;
03320         (<a class="code" href="../../d2/d1/mm_8h.html#a23">MmEnoughMemoryForWrite</a>())) {
03321 
03322         <span class="comment">//</span>
03323         <span class="comment">// This page was modified via the cache manager.  Don't</span>
03324         <span class="comment">// write it out at this time as there are ample pages.</span>
03325         <span class="comment">//</span>
03326 
03327         <a class="code" href="../../d7/d5/pfnlist_8c.html#a11">MiUnlinkPageFromList</a> (Pfn1);
03328         <a class="code" href="../../d7/d5/pfnlist_8c.html#a16">MiInsertFrontModifiedNoWrite</a> (PageFrameIndex);
03329         <a class="code" href="../../d4/d8/mi_8h.html#a608">MmModNoWriteInsert</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03330         <span class="keywordflow">return</span>;
03331     }
03332 
03333     <span class="comment">//</span>
03334     <span class="comment">// Look at backwards at previous prototype PTEs to see if</span>
03335     <span class="comment">// this can be clustered into a larger write operation.</span>
03336     <span class="comment">//</span>
03337 
03338     PointerPte = Pfn1-&gt;PteAddress;
03339     NextPte = PointerPte - (<a class="code" href="../../d4/d8/mi_8h.html#a730">MmModifiedWriteClusterSize</a> - 1);
03340 
03341     <span class="comment">//</span>
03342     <span class="comment">// Make sure NextPte is in the same page.</span>
03343     <span class="comment">//</span>
03344 
03345     <span class="keywordflow">if</span> (NextPte &lt; (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> (PointerPte)) {
03346         NextPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> (PointerPte);
03347     }
03348 
03349     <span class="comment">//</span>
03350     <span class="comment">// Make sure NextPte is within the subsection.</span>
03351     <span class="comment">//</span>
03352 
03353     <span class="keywordflow">if</span> (NextPte &lt; Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>) {
03354         NextPte = Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>;
03355     }
03356 
03357     <span class="comment">//</span>
03358     <span class="comment">// If the prototype PTEs are not currently mapped,</span>
03359     <span class="comment">// map them via hyperspace.  BasePte refers to the</span>
03360     <span class="comment">// prototype PTEs for nonfaulting references.</span>
03361     <span class="comment">//</span>
03362 
03363     OldIrql2 = 99;
03364     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a> (PointerPte)) {
03365         BasePte = PointerPte;
03366     } <span class="keywordflow">else</span> {
03367         BasePte = <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (Pfn1-&gt;PteFrame, &amp;OldIrql2);
03368         BasePte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)((PCHAR)BasePte +
03369                             <a class="code" href="../../d2/d1/mm_8h.html#a6">BYTE_OFFSET</a> (PointerPte));
03370     }
03371 
03372     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a183">MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE</a> (BasePte) == PageFrameIndex);
03373 
03374     PointerPte -= 1;
03375     BasePte -= 1;
03376 
03377     <span class="comment">//</span>
03378     <span class="comment">// Don't go before the start of the subsection nor cross</span>
03379     <span class="comment">// a page boundary.</span>
03380     <span class="comment">//</span>
03381 
03382     <span class="keywordflow">while</span> (PointerPte &gt;= NextPte) {
03383 
03384         PteContents = *BasePte;
03385 
03386         <span class="comment">//</span>
03387         <span class="comment">// If the page is not in transition, exit loop.</span>
03388         <span class="comment">//</span>
03389 
03390         <span class="keywordflow">if</span> ((PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) ||
03391             (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 0) ||
03392             (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 1)) {
03393 
03394             <span class="keywordflow">break</span>;
03395         }
03396 
03397         Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Trans.PageFrameNumber);
03398 
03399         <span class="comment">//</span>
03400         <span class="comment">// Make sure page is modified and on the modified list.</span>
03401         <span class="comment">//</span>
03402 
03403         <span class="keywordflow">if</span> ((Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified == 0 ) ||
03404             (Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount != 0)) {
03405             <span class="keywordflow">break</span>;
03406         }
03407         PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a183">MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE</a> (&amp;PteContents);
03408         PointerPte -= 1;
03409         BasePte -= 1;
03410     }
03411 
03412     StartingPte = PointerPte + 1;
03413     BasePte = BasePte + 1;
03414 
03415     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
03416     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (StartingPte == Pfn1-&gt;PteAddress);
03417     <a class="code" href="../../d7/d5/pfnlist_8c.html#a11">MiUnlinkPageFromList</a> (Pfn1);
03418 
03419     <span class="comment">//</span>
03420     <span class="comment">// Get an entry from the list and fill it in.</span>
03421     <span class="comment">//</span>
03422 
03423     ModWriterEntry = (<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html">PMMMOD_WRITER_MDL_ENTRY</a>)RemoveHeadList (
03424                                     &amp;<a class="code" href="../../d4/d8/mi_8h.html#a713">MmMappedFileHeader</a>.<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o0">ListHead</a>);
03425 
03426     ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o10">File</a> = ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a>;
03427     ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o11">ControlArea</a> = ControlArea;
03428 
03429     <span class="comment">//</span>
03430     <span class="comment">// Calculate the offset to read into the file.</span>
03431     <span class="comment">//  offset = base + ((thispte - basepte) &lt;&lt; PAGE_SHIFT)</span>
03432     <span class="comment">//</span>
03433 
03434     ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o1">WriteOffset</a>.QuadPart = <a class="code" href="../../d4/d8/mi_8h.html#a952">MiStartingOffset</a> (Subsection,
03435                                                               Pfn1-&gt;PteAddress);
03436 
03437     <a class="code" href="../../d2/d1/mm_8h.html#a24">MmInitializeMdl</a>(&amp;ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o13">Mdl</a>,
03438                     (PVOID)ULongToPtr(Pfn1-&gt;u3.e1.PageColor &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>),
03439                     <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
03440 
03441     ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o13">Mdl</a>.<a class="code" href="../../d6/d7/struct__MDL.html#o2">MdlFlags</a> |= <a class="code" href="../../d0/d9/ntosdef_8h.html#a13">MDL_PAGES_LOCKED</a>;
03442 
03443     ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o13">Mdl</a>.<a class="code" href="../../d6/d7/struct__MDL.html#o1">Size</a> = (CSHORT)(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>) +
03444                       (<span class="keyword">sizeof</span>(PFN_NUMBER) * <a class="code" href="../../d4/d8/mi_8h.html#a730">MmModifiedWriteClusterSize</a>));
03445 
03446     Page = &amp;ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o14">Page</a>[0];
03447 
03448     <span class="comment">//</span>
03449     <span class="comment">// Up the reference count for the physical page as there</span>
03450     <span class="comment">// is I/O in progress.</span>
03451     <span class="comment">//</span>
03452 
03453     <a class="code" href="../../d4/d8/mi_8h.html#a187">MI_ADD_LOCKED_PAGE_CHARGE_FOR_MODIFIED_PAGE</a> (Pfn1, 14);
03454     Pfn1-&gt;u3.e2.ReferenceCount += 1;
03455 
03456     <span class="comment">//</span>
03457     <span class="comment">// Clear the modified bit for the page and set the write</span>
03458     <span class="comment">// in progress bit.</span>
03459     <span class="comment">//</span>
03460 
03461     Pfn1-&gt;u3.e1.Modified = 0;
03462     Pfn1-&gt;u3.e1.WriteInProgress = 1;
03463 
03464     <span class="comment">//</span>
03465     <span class="comment">// Put this physical page into the MDL.</span>
03466     <span class="comment">//</span>
03467 
03468     *Page = PageFrameIndex;
03469 
03470     <span class="comment">//</span>
03471     <span class="comment">// See if any adjacent pages are also modified and in</span>
03472     <span class="comment">// the transition state and if so, write them out at</span>
03473     <span class="comment">// the same time.</span>
03474     <span class="comment">//</span>
03475 
03476 
03477     <span class="comment">//</span>
03478     <span class="comment">// Look at the previous PTE, ensuring a page boundary is</span>
03479     <span class="comment">// not crossed.</span>
03480     <span class="comment">//</span>
03481 
03482     LastPte = StartingPte + <a class="code" href="../../d4/d8/mi_8h.html#a730">MmModifiedWriteClusterSize</a>;
03483 
03484     <span class="comment">//</span>
03485     <span class="comment">// If BasePte is not in the same page as LastPte,</span>
03486     <span class="comment">// set last pte to be the last PTE in this page.</span>
03487     <span class="comment">//</span>
03488 
03489     <span class="keywordflow">if</span> (StartingPte &lt; (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(LastPte)) {
03490         LastPte = ((<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(LastPte)) - 1;
03491     }
03492 
03493     <span class="comment">//</span>
03494     <span class="comment">// Make sure LastPte is within the subsection.</span>
03495     <span class="comment">//</span>
03496 
03497     <span class="keywordflow">if</span> (LastPte &gt; &amp;Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>[
03498                                 Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a>]) {
03499         LastPte = &amp;Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>[
03500                                 Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a>];
03501     }
03502 
03503     <span class="comment">//</span>
03504     <span class="comment">// Look forwards.</span>
03505     <span class="comment">//</span>
03506 
03507     NextPte = BasePte + 1;
03508     PointerPte = StartingPte + 1;
03509 
03510     <span class="comment">//</span>
03511     <span class="comment">// Loop until an MDL is filled, the end of a subsection</span>
03512     <span class="comment">// is reached, or a page boundary is reached.</span>
03513     <span class="comment">// Note, PointerPte points to the PTE. NextPte points</span>
03514     <span class="comment">// to where it is mapped in hyperspace (if required).</span>
03515     <span class="comment">//</span>
03516 
03517     <span class="keywordflow">while</span> (PointerPte &lt; LastPte) {
03518 
03519         PteContents = *NextPte;
03520 
03521         <span class="comment">//</span>
03522         <span class="comment">// If the page is not in transition, exit loop.</span>
03523         <span class="comment">//</span>
03524 
03525         <span class="keywordflow">if</span> ((PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) ||
03526             (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 0) ||
03527             (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 1)) {
03528 
03529             <span class="keywordflow">break</span>;
03530         }
03531 
03532         Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Trans.PageFrameNumber);
03533 
03534         <span class="keywordflow">if</span> ((Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified == 0 ) ||
03535             (Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount != 0)) {
03536 
03537             <span class="comment">//</span>
03538             <span class="comment">// Page is not dirty or not on the modified list,</span>
03539             <span class="comment">// end clustering operation.</span>
03540             <span class="comment">//</span>
03541 
03542             <span class="keywordflow">break</span>;
03543         }
03544         Page += 1;
03545 
03546         <span class="comment">//</span>
03547         <span class="comment">// Add physical page to MDL.</span>
03548         <span class="comment">//</span>
03549 
03550         *Page = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a183">MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE</a> (&amp;PteContents);
03551         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte == Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>);
03552         <a class="code" href="../../d7/d5/pfnlist_8c.html#a11">MiUnlinkPageFromList</a> (Pfn2);
03553 
03554         <span class="comment">//</span>
03555         <span class="comment">// Up the reference count for the physical page as there</span>
03556         <span class="comment">// is I/O in progress.</span>
03557         <span class="comment">//</span>
03558 
03559         <a class="code" href="../../d4/d8/mi_8h.html#a187">MI_ADD_LOCKED_PAGE_CHARGE_FOR_MODIFIED_PAGE</a> (Pfn2, 14);
03560         Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount += 1;
03561 
03562         <span class="comment">//</span>
03563         <span class="comment">// Clear the modified bit for the page and set the</span>
03564         <span class="comment">// write in progress bit.</span>
03565         <span class="comment">//</span>
03566 
03567         Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified = 0;
03568         Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.WriteInProgress = 1;
03569 
03570         ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o13">Mdl</a>.<a class="code" href="../../d6/d7/struct__MDL.html#o6">ByteCount</a> += <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
03571 
03572         NextPte += 1;
03573         PointerPte += 1;
03574 
03575     } <span class="comment">//end while</span>
03576 
03577     <span class="keywordflow">if</span> (OldIrql2 != 99) {
03578         <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql2);
03579     }
03580 
03581     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a> (ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o13">Mdl</a>.<a class="code" href="../../d6/d7/struct__MDL.html#o6">ByteCount</a>) &lt;= <a class="code" href="../../d4/d8/mi_8h.html#a730">MmModifiedWriteClusterSize</a>);
03582 
03583     ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o4">u</a>.LastByte.QuadPart = ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o1">WriteOffset</a>.QuadPart +
03584                         ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o13">Mdl</a>.<a class="code" href="../../d6/d7/struct__MDL.html#o6">ByteCount</a>;
03585 
03586     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o0">ControlArea</a>-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.Image == 0);
03587 
03588 <span class="preprocessor">#if DBG</span>
03589 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ((ULONG)ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o13">Mdl</a>.<a class="code" href="../../d6/d7/struct__MDL.html#o6">ByteCount</a> &gt;
03590                                 ((1+<a class="code" href="../../d4/d8/mi_8h.html#a730">MmModifiedWriteClusterSize</a>)*<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>)) {
03591         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Mdl %p, MDL End Offset %lx %lx Subsection %p\n"</span>,
03592             ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o13">Mdl</a>,
03593             ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o4">u</a>.LastByte.LowPart,
03594             ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o4">u</a>.LastByte.HighPart,
03595             Subsection);
03596         DbgBreakPoint();
03597     }
03598 <span class="preprocessor">#endif //DBG</span>
03599 <span class="preprocessor"></span>
03600     <a class="code" href="../../d2/d1/mm_8h.html#a145">MmInfoCounters</a>.<a class="code" href="../../d3/d2/struct__MMINFO__COUNTERS.html#o12">MappedWriteIoCount</a> += 1;
03601     <a class="code" href="../../d2/d1/mm_8h.html#a145">MmInfoCounters</a>.<a class="code" href="../../d3/d2/struct__MMINFO__COUNTERS.html#o11">MappedPagesWriteCount</a> +=
03602                                 (ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o13">Mdl</a>.<a class="code" href="../../d6/d7/struct__MDL.html#o6">ByteCount</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
03603 
03604     <span class="comment">//</span>
03605     <span class="comment">// Increment the count of modified page writes outstanding</span>
03606     <span class="comment">// in the control area.</span>
03607     <span class="comment">//</span>
03608 
03609     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o13">ModifiedWriteCount</a> += 1;
03610 
03611     <span class="comment">//</span>
03612     <span class="comment">// Increment the number of PFN references.  This allows the file</span>
03613     <span class="comment">// system to purge (i.e. call MmPurgeSection) modified writes.</span>
03614     <span class="comment">//</span>
03615 
03616     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o3">NumberOfPfnReferences</a> += 1;
03617 
03618     ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o12">FileResource</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03619 
03620     <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.BeingPurged == 1) {
03621         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03622         ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o4">u</a>.IoStatus.Status = STATUS_FILE_LOCK_CONFLICT;
03623         ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o4">u</a>.IoStatus.Information = 0;
03624         <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>, &amp;OldIrql);
03625         <a class="code" href="../../d6/d3/modwrite_8c.html#a49">MiWriteComplete</a> ((PVOID)ModWriterEntry,
03626                          &amp;ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o4">u</a>.IoStatus,
03627                          0 );
03628         <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a> (OldIrql);
03629         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
03630         <span class="keywordflow">return</span>;
03631     }
03632 
03633     <span class="comment">//</span>
03634     <span class="comment">// Send the entry for the MappedPageWriter.</span>
03635     <span class="comment">//</span>
03636 
03637     InsertTailList (&amp;<a class="code" href="../../d6/d3/modwrite_8c.html#a14">MmMappedPageWriterList</a>,
03638                     &amp;ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o0">Links</a>);
03639 
03640     <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;<a class="code" href="../../d6/d3/modwrite_8c.html#a15">MmMappedPageWriterEvent</a>, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03641 
03642 
03643 <span class="preprocessor">#if 0</span>
03644 <span class="preprocessor"></span>
03645     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03646 
03647     ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o12">FileResource</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03648 
03649     <span class="keywordflow">if</span> (ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o11">ControlArea</a>-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.FailAllIo == 1) {
03650         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
03651 
03652     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/fsrtl_8h.html#a103">FsRtlAcquireFileForModWrite</a> (ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o10">File</a>,
03653                                             &amp;ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o4">u</a>.LastByte,
03654                                             &amp;ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o12">FileResource</a>)) {
03655 
03656         <span class="comment">//</span>
03657         <span class="comment">// Issue the write request.</span>
03658         <span class="comment">//</span>
03659 
03660         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d6/iosubs_8c.html#a20">IoAsynchronousPageWrite</a> (
03661                                ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o10">File</a>,
03662                                &amp;ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o13">Mdl</a>,
03663                                &amp;ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o1">WriteOffset</a>,
03664                                <a class="code" href="../../d6/d3/modwrite_8c.html#a49">MiWriteComplete</a>,
03665                                (PVOID)ModWriterEntry,
03666                                &amp;ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o2">IoStatus</a>,
03667                                &amp;ModWriterEntry-&gt;Irp );
03668     } <span class="keywordflow">else</span> {
03669 
03670         <span class="comment">//</span>
03671         <span class="comment">// Unable to get the file system resources, set error status</span>
03672         <span class="comment">// to lock conflict (ignored by MiWriteComplete) so the APC</span>
03673         <span class="comment">// routine is explicitly called.</span>
03674         <span class="comment">//</span>
03675 
03676         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_FILE_LOCK_CONFLICT;
03677     }
03678 
03679     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a3">NT_ERROR</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03680 
03681         <span class="comment">//</span>
03682         <span class="comment">// An error has occurred, disable APCs and</span>
03683         <span class="comment">// call the write completion routine.</span>
03684         <span class="comment">//</span>
03685 
03686         ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o2">IoStatus</a>.Status = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03687         ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o2">IoStatus</a>.Information = 0;
03688         <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>, &amp;OldIrql);
03689         <a class="code" href="../../d6/d3/modwrite_8c.html#a49">MiWriteComplete</a> ((PVOID)ModWriterEntry,
03690                          &amp;ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o2">IoStatus</a>,
03691                          0 );
03692         <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a> (OldIrql);
03693     }
03694 
03695     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
03696 <span class="preprocessor">#endif //0</span>
03697 <span class="preprocessor"></span>    <span class="keywordflow">return</span>;
03698 }
03699 
03700 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03701"></a><a class="code" href="../../d6/d3/modwrite_8c.html#a36">03701</a> <a class="code" href="../../d6/d3/modwrite_8c.html#a36">MiGatherPagefilePages</a> (
03702     IN <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1,
03703     IN PFN_NUMBER PageFrameIndex
03704     )
03705 
03706 <span class="comment">/*++</span>
03707 <span class="comment"></span>
03708 <span class="comment">Routine Description:</span>
03709 <span class="comment"></span>
03710 <span class="comment">    This routine processes the specified modified page by getting</span>
03711 <span class="comment">    that page and gather any other pages on the modified list destined</span>
03712 <span class="comment">    for the paging file in a large write cluster.  This cluster is</span>
03713 <span class="comment">    then written to the paging file.</span>
03714 <span class="comment"></span>
03715 <span class="comment">Arguments:</span>
03716 <span class="comment"></span>
03717 <span class="comment">    Pfn1 - Supplies a pointer to the PFN element for the corresponding page.</span>
03718 <span class="comment"></span>
03719 <span class="comment">    PageFrameIndex - Supplies the physical page frame to write.</span>
03720 <span class="comment"></span>
03721 <span class="comment">Return Value:</span>
03722 <span class="comment"></span>
03723 <span class="comment">    None.</span>
03724 <span class="comment"></span>
03725 <span class="comment">Environment:</span>
03726 <span class="comment"></span>
03727 <span class="comment">    PFN lock held.</span>
03728 <span class="comment"></span>
03729 <span class="comment">--*/</span>
03730 
03731 {
03732     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>;
03733     <a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html">PMMMOD_WRITER_MDL_ENTRY</a> ModWriterEntry;
03734     <a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html">PMMPAGING_FILE</a> CurrentPagingFile;
03735     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03736     PPFN_NUMBER Page;
03737     ULONG StartBit;
03738     LARGE_INTEGER StartingOffset;
03739     PFN_NUMBER ClusterSize;
03740     PFN_NUMBER ThisCluster;
03741     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> LongPte;
03742     KIRQL OldIrql;
03743     ULONG NextColor;
03744     LOGICAL PageFileFull;
03745     <span class="comment">//MM_WRITE_CLUSTER WriteCluster;</span>
03746 
03747     OldIrql = 0;
03748 
03749     <span class="keywordflow">if</span> (IsListEmpty(&amp;<a class="code" href="../../d4/d8/mi_8h.html#a712">MmPagingFileHeader</a>.<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o0">ListHead</a>)) {
03750 
03751         <span class="comment">//</span>
03752         <span class="comment">// Reset the event indicating no paging files MDLs in</span>
03753         <span class="comment">// the list, drop the PFN lock and wait for an</span>
03754         <span class="comment">// I/O operation to complete.</span>
03755         <span class="comment">//</span>
03756 
03757         <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a712">MmPagingFileHeader</a>.<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o1">Event</a>);
03758         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03759         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;<a class="code" href="../../d4/d8/mi_8h.html#a712">MmPagingFileHeader</a>.<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o1">Event</a>,
03760                                <a class="code" href="../../d4/d9/ke_8h.html#a407a217">WrPageOut</a>,
03761                                <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
03762                                <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
03763                                &amp;<a class="code" href="../../d4/d8/mi_8h.html#a422">Mm30Milliseconds</a>);
03764         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
03765 
03766         <span class="comment">//</span>
03767         <span class="comment">// Don't go on as the old PageFrameIndex at the</span>
03768         <span class="comment">// top of the ModifiedList may have changed states.</span>
03769         <span class="comment">//</span>
03770 
03771         <span class="keywordflow">return</span>;
03772     }
03773 
03774     <span class="comment">//</span>
03775     <span class="comment">// Page is destined for the paging file.</span>
03776     <span class="comment">// Find the paging file with the most free space and get a cluster.</span>
03777     <span class="comment">//</span>
03778 
03779     NextColor = Pfn1-&gt;u3.e1.PageColor;
03780 
03781     ModWriterEntry = (<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html">PMMMOD_WRITER_MDL_ENTRY</a>)RemoveHeadList (
03782                                     &amp;<a class="code" href="../../d4/d8/mi_8h.html#a712">MmPagingFileHeader</a>.<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o0">ListHead</a>);
03783 <span class="preprocessor">#if DBG</span>
03784 <span class="preprocessor"></span>    ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o0">Links</a>.Flink = <a class="code" href="../../d4/d8/mi_8h.html#a23">MM_IO_IN_PROGRESS</a>;
03785 <span class="preprocessor">#endif</span>
03786 <span class="preprocessor"></span>    CurrentPagingFile = ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o9">PagingFile</a>;
03787 
03788     <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a> = ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o9">PagingFile</a>-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o10">File</a>;
03789     ThisCluster = <a class="code" href="../../d4/d8/mi_8h.html#a730">MmModifiedWriteClusterSize</a>;
03790 
03791     PageFileFull = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03792 
03793     <span class="keywordflow">do</span> {
03794         <span class="comment">//</span>
03795         <span class="comment">// Attempt to cluster MmModifiedWriteClusterSize pages</span>
03796         <span class="comment">// together.  Reduce by one half until we succeed or</span>
03797         <span class="comment">// can't find a single page free in the paging file.</span>
03798         <span class="comment">//</span>
03799 
03800         <span class="keywordflow">if</span> (((CurrentPagingFile-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o6">Hint</a> + <a class="code" href="../../d4/d8/mi_8h.html#a730">MmModifiedWriteClusterSize</a>) &gt;
03801                                 CurrentPagingFile-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o2">MinimumSize</a>)
03802              &amp;&amp;
03803             (CurrentPagingFile-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o14">HintSetToZero</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
03804 
03805             CurrentPagingFile-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o14">HintSetToZero</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03806             CurrentPagingFile-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o6">Hint</a> = 0;
03807         }
03808 
03809         StartBit = <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a31">RtlFindClearBitsAndSet</a> (CurrentPagingFile-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o9">Bitmap</a>,
03810                                            (ULONG)ThisCluster,
03811                                            (ULONG)CurrentPagingFile-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o6">Hint</a>);
03812 
03813         <span class="keywordflow">if</span> (StartBit != 0xFFFFFFFF) {
03814             <span class="keywordflow">break</span>;
03815         }
03816         <span class="keywordflow">if</span> (CurrentPagingFile-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o6">Hint</a> != 0) {
03817 
03818             <span class="comment">//</span>
03819             <span class="comment">// Start looking from front of the file.</span>
03820             <span class="comment">//</span>
03821 
03822             CurrentPagingFile-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o6">Hint</a> = 0;
03823         } <span class="keywordflow">else</span> {
03824             ThisCluster = ThisCluster &gt;&gt; 1;
03825             PageFileFull = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03826         }
03827 
03828     } <span class="keywordflow">while</span> (ThisCluster != 0);
03829 
03830     <span class="keywordflow">if</span> (StartBit == 0xFFFFFFFF) {
03831 
03832         <span class="comment">//</span>
03833         <span class="comment">// Paging file must be full.</span>
03834         <span class="comment">//</span>
03835 
03836         KdPrint((<span class="stringliteral">"MM MODWRITE: page file full\n"</span>));
03837         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(CurrentPagingFile-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o3">FreeSpace</a> == 0);
03838 
03839         <span class="comment">//</span>
03840         <span class="comment">// Move this entry to the not enough space list,</span>
03841         <span class="comment">// and try again.</span>
03842         <span class="comment">//</span>
03843 
03844         InsertTailList (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a716">MmFreePagingSpaceLow</a>,
03845                         &amp;ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o0">Links</a>);
03846         ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o8">CurrentList</a> = &amp;<a class="code" href="../../d4/d8/mi_8h.html#a716">MmFreePagingSpaceLow</a>;
03847         <a class="code" href="../../d4/d8/mi_8h.html#a717">MmNumberOfActiveMdlEntries</a> -= 1;
03848         <a class="code" href="../../d6/d3/modwrite_8c.html#a56">MiPageFileFull</a> ();
03849         <span class="keywordflow">return</span>;
03850     }
03851 
03852     CurrentPagingFile-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o3">FreeSpace</a> -= ThisCluster;
03853     CurrentPagingFile-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o4">CurrentUsage</a> += ThisCluster;
03854     <span class="keywordflow">if</span> (CurrentPagingFile-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o3">FreeSpace</a> &lt; 32) {
03855         PageFileFull = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03856     }
03857 
03858     StartingOffset.QuadPart = (UINT64)StartBit &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
03859 
03860     <a class="code" href="../../d2/d1/mm_8h.html#a24">MmInitializeMdl</a>(&amp;ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o13">Mdl</a>,
03861                     (PVOID)ULongToPtr(Pfn1-&gt;u3.e1.PageColor &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>),
03862                     <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
03863 
03864     ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o13">Mdl</a>.<a class="code" href="../../d6/d7/struct__MDL.html#o2">MdlFlags</a> |= <a class="code" href="../../d0/d9/ntosdef_8h.html#a13">MDL_PAGES_LOCKED</a>;
03865 
03866     ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o13">Mdl</a>.<a class="code" href="../../d6/d7/struct__MDL.html#o1">Size</a> = (CSHORT)(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>) +
03867                     <span class="keyword">sizeof</span>(PFN_NUMBER) * <a class="code" href="../../d4/d8/mi_8h.html#a730">MmModifiedWriteClusterSize</a>);
03868 
03869     Page = &amp;ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o14">Page</a>[0];
03870 
03871     ClusterSize = 0;
03872 
03873     <span class="comment">//</span>
03874     <span class="comment">// Search through the modified page list looking for other</span>
03875     <span class="comment">// pages destined for the paging file and build a cluster.</span>
03876     <span class="comment">//</span>
03877 
03878     <span class="keywordflow">while</span> (ClusterSize != ThisCluster) {
03879 
03880         <span class="comment">//</span>
03881         <span class="comment">// Is this page destined for a paging file?</span>
03882         <span class="comment">//</span>
03883 
03884         <span class="keywordflow">if</span> (Pfn1-&gt;OriginalPte.u.Soft.Prototype == 0) {
03885 
03886 <span class="preprocessor">#if 0  //********* commented out</span>
03887 <span class="preprocessor"></span>
03888             <a class="code" href="../../d6/d3/modwrite_8c.html#a31">MiClusterWritePages</a> (Pfn1,
03889                                  PageFrameIndex,
03890                                  &amp;WriteCluster,
03891                                  ThisCluster - ClusterSize);
03892             <span class="keywordflow">do</span> {
03893 
03894                 PageFrameIndex = WriteCluster.Cluster[WriteCluster.StartIndex];
03895                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
03896 <span class="preprocessor">#endif //0</span>
03897 <span class="preprocessor"></span>                *Page = PageFrameIndex;
03898 
03899                 <span class="comment">//</span>
03900                 <span class="comment">// Remove the page from the modified list. Note that</span>
03901                 <span class="comment">// write-in-progress marks the state.</span>
03902                 <span class="comment">//</span>
03903 
03904                 <span class="comment">//</span>
03905                 <span class="comment">// Unlink the page so the same page won't be found</span>
03906                 <span class="comment">// on the modified page list by color.</span>
03907                 <span class="comment">//</span>
03908 
03909                 <a class="code" href="../../d7/d5/pfnlist_8c.html#a11">MiUnlinkPageFromList</a> (Pfn1);
03910                 NextColor = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a129">MI_GET_NEXT_COLOR</a>(NextColor);
03911 
03912                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a133">MI_GET_MODIFIED_PAGE_BY_COLOR</a> (PageFrameIndex,
03913                                                NextColor);
03914 
03915                 <span class="comment">//</span>
03916                 <span class="comment">// Up the reference count for the physical page as there</span>
03917                 <span class="comment">// is I/O in progress.</span>
03918                 <span class="comment">//</span>
03919 
03920                 <a class="code" href="../../d4/d8/mi_8h.html#a187">MI_ADD_LOCKED_PAGE_CHARGE_FOR_MODIFIED_PAGE</a> (Pfn1, 16);
03921                 Pfn1-&gt;u3.e2.ReferenceCount += 1;
03922 
03923                 <span class="comment">//</span>
03924                 <span class="comment">// Clear the modified bit for the page and set the</span>
03925                 <span class="comment">// write in progress bit.</span>
03926                 <span class="comment">//</span>
03927 
03928                 Pfn1-&gt;u3.e1.Modified = 0;
03929                 Pfn1-&gt;u3.e1.WriteInProgress = 1;
03930                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;OriginalPte.u.Soft.PageFileHigh == 0);
03931 
03932                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a143">MI_SET_PAGING_FILE_INFO</a> (LongPte,
03933                                          Pfn1-&gt;OriginalPte,
03934                                          CurrentPagingFile-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o12">PageFileNumber</a>,
03935                                          StartBit);
03936 
03937 <span class="preprocessor">#if DBG</span>
03938 <span class="preprocessor"></span>                <span class="keywordflow">if</span> ((StartBit &lt; 8192) &amp;&amp;
03939                     (CurrentPagingFile-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o12">PageFileNumber</a> == 0)) {
03940                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((<a class="code" href="../../d4/d8/mi_8h.html#a686">MmPagingFileDebug</a>[StartBit] &amp; 1) == 0);
03941                     <a class="code" href="../../d4/d8/mi_8h.html#a686">MmPagingFileDebug</a>[StartBit] =
03942                         (((ULONG_PTR)Pfn1-&gt;PteAddress &lt;&lt; 3) |
03943                             ((ClusterSize &amp; 0xf) &lt;&lt; 1) | 1);
03944                 }
03945 <span class="preprocessor">#endif //DBG</span>
03946 <span class="preprocessor"></span>
03947                 <span class="comment">//</span>
03948                 <span class="comment">// Change the original PTE contents to refer to</span>
03949                 <span class="comment">// the paging file offset where this was written.</span>
03950                 <span class="comment">//</span>
03951 
03952                 Pfn1-&gt;OriginalPte = LongPte;
03953 
03954                 ClusterSize += 1;
03955                 Page += 1;
03956                 StartBit += 1;
03957 <span class="preprocessor">#if 0 // COMMENTED OUT</span>
03958 <span class="preprocessor"></span>                WriteCluster.Count -= 1;
03959                 WriteCluster.StartIndex += 1;
03960 
03961             } <span class="keywordflow">while</span> (WriteCluster.Count != 0);
03962 <span class="preprocessor">#endif //0</span>
03963 <span class="preprocessor"></span>        } <span class="keywordflow">else</span> {
03964 
03965             <span class="comment">//</span>
03966             <span class="comment">// This page was not destined for a paging file,</span>
03967             <span class="comment">// get another page.</span>
03968             <span class="comment">//</span>
03969             <span class="comment">// Get a page of the same color as the one which</span>
03970             <span class="comment">// was not usable.</span>
03971             <span class="comment">//</span>
03972 
03973             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a133">MI_GET_MODIFIED_PAGE_BY_COLOR</a> (PageFrameIndex,
03974                                            NextColor);
03975         }
03976 
03977         <span class="keywordflow">if</span> (PageFrameIndex == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
03978             <span class="keywordflow">break</span>;
03979         }
03980 
03981         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
03982 
03983     } <span class="comment">//end while</span>
03984 
03985     <span class="keywordflow">if</span> (ClusterSize != ThisCluster) {
03986 
03987         <span class="comment">//</span>
03988         <span class="comment">// A complete cluster could not be located, free the</span>
03989         <span class="comment">// excess page file space that was reserved and adjust</span>
03990         <span class="comment">// the size of the packet.</span>
03991         <span class="comment">//</span>
03992 
03993         <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a33">RtlClearBits</a> (CurrentPagingFile-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o9">Bitmap</a>,
03994                       StartBit,
03995                       (ULONG)(ThisCluster - ClusterSize));
03996 
03997         CurrentPagingFile-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o3">FreeSpace</a> += ThisCluster - ClusterSize;
03998         CurrentPagingFile-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o4">CurrentUsage</a> -= ThisCluster - ClusterSize;
03999 
04000         <span class="comment">//</span>
04001         <span class="comment">// If their are no pages to write, don't issue a write</span>
04002         <span class="comment">// request and restart the scan loop.</span>
04003         <span class="comment">//</span>
04004 
04005         <span class="keywordflow">if</span> (ClusterSize == 0) {
04006 
04007             <span class="comment">//</span>
04008             <span class="comment">// No pages to write.  Inset the entry back in the</span>
04009             <span class="comment">// list.</span>
04010             <span class="comment">//</span>
04011 
04012             <span class="keywordflow">if</span> (IsListEmpty (&amp;ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o7">PagingListHead</a>-&gt;<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o0">ListHead</a>)) {
04013                 <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o7">PagingListHead</a>-&gt;<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o1">Event</a>,
04014                             0,
04015                             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04016             }
04017 
04018             InsertTailList (&amp;ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o7">PagingListHead</a>-&gt;<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o0">ListHead</a>,
04019                             &amp;ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o0">Links</a>);
04020 
04021             <span class="keywordflow">return</span>;
04022         }
04023     }
04024 
04025     <span class="keywordflow">if</span> (CurrentPagingFile-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o5">PeakUsage</a> &lt;
04026                                 CurrentPagingFile-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o4">CurrentUsage</a>) {
04027         CurrentPagingFile-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o5">PeakUsage</a> =
04028                                 CurrentPagingFile-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o4">CurrentUsage</a>;
04029     }
04030 
04031     ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o13">Mdl</a>.<a class="code" href="../../d6/d7/struct__MDL.html#o6">ByteCount</a> = (ULONG)(ClusterSize * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
04032     ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o6">LastPageToWrite</a> = StartBit - 1;
04033 
04034     <a class="code" href="../../d2/d1/mm_8h.html#a145">MmInfoCounters</a>.<a class="code" href="../../d3/d2/struct__MMINFO__COUNTERS.html#o10">DirtyWriteIoCount</a> += 1;
04035     <a class="code" href="../../d2/d1/mm_8h.html#a145">MmInfoCounters</a>.<a class="code" href="../../d3/d2/struct__MMINFO__COUNTERS.html#o9">DirtyPagesWriteCount</a> += (ULONG)ClusterSize;
04036 
04037     <span class="comment">//</span>
04038     <span class="comment">// For now release the PFN lock and wait for the write to complete.</span>
04039     <span class="comment">//</span>
04040 
04041     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
04042 
04043 <span class="preprocessor">#if DBG</span>
04044 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a61">MM_DBG_MOD_WRITE</a>) {
04045         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MM MODWRITE: modified page write begun @ %08lx by %08lx\n"</span>,
04046                 StartingOffset.LowPart, ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o13">Mdl</a>.<a class="code" href="../../d6/d7/struct__MDL.html#o6">ByteCount</a>);
04047     }
04048 <span class="preprocessor">#endif</span>
04049 <span class="preprocessor"></span>
04050     <span class="comment">//</span>
04051     <span class="comment">// Issue the write request.</span>
04052     <span class="comment">//</span>
04053 
04054     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d6/iosubs_8c.html#a20">IoAsynchronousPageWrite</a> ( <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>,
04055                            &amp;ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o13">Mdl</a>,
04056                            &amp;StartingOffset,
04057                            <a class="code" href="../../d6/d3/modwrite_8c.html#a49">MiWriteComplete</a>,
04058                            (PVOID)ModWriterEntry,
04059                            &amp;ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o4">u</a>.IoStatus,
04060                            &amp;ModWriterEntry-&gt;Irp );
04061 
04062     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a3">NT_ERROR</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
04063         KdPrint((<span class="stringliteral">"MM MODWRITE: modified page write failed %lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
04064 
04065         <span class="comment">//</span>
04066         <span class="comment">// An error has occurred, disable APCs and</span>
04067         <span class="comment">// call the write completion routine.</span>
04068         <span class="comment">//</span>
04069 
04070         ModWriterEntry-&gt;u.IoStatus.Status = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04071         ModWriterEntry-&gt;u.IoStatus.Information = 0;
04072         <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>, &amp;OldIrql);
04073         <a class="code" href="../../d6/d3/modwrite_8c.html#a49">MiWriteComplete</a> ((PVOID)ModWriterEntry,
04074                          &amp;ModWriterEntry-&gt;u.IoStatus,
04075                          0 );
04076         <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a> (OldIrql);
04077     }
04078 
04079     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
04080 
04081     <span class="keywordflow">if</span> (PageFileFull == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
04082         <a class="code" href="../../d6/d3/modwrite_8c.html#a56">MiPageFileFull</a> ();
04083     }
04084 
04085     <span class="keywordflow">return</span>;
04086 }
04087 
04088 
04089 <span class="preprocessor">#if 0 // COMMENTED OUT **************************************************</span>
04090 <span class="preprocessor"></span>ULONG ClusterCounts[20];
04091 ULONG ClusterSizes[20];
04092 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
04093 <a class="code" href="../../d6/d3/modwrite_8c.html#a31">MiClusterWritePages</a> (
04094     IN <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1,
04095     IN PFN_NUMBER PageFrameIndex,
04096     IN PMM_WRITE_CLUSTER WriteCluster,
04097     IN ULONG Size
04098     )
04099 
04100 {
04101     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerClusterPte;
04102     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> OriginalPte;
04103     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StopPte;
04104     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> ThisPage;
04105     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> BasePage;
04106     ULONG <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>;
04107     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn2;
04108     KIRQL OldIrql = 99;
04109 
04110     <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> = <a class="code" href="../../d2/d1/mm_8h.html#a3">MM_MAXIMUM_DISK_IO_SIZE</a> / <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
04111     WriteCluster-&gt;Cluster[<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>] = PageFrameIndex;
04112     WriteCluster-&gt;Count = 1;
04113     ClusterSizes[<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>] += 1;
04114     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> == 1) {
04115         WriteCluster-&gt;StartIndex = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>;
04116         <span class="keywordflow">return</span>;
04117     }
04118 
04119     <span class="comment">//</span>
04120     <span class="comment">// The page points to a page table page which may not be</span>
04121     <span class="comment">// for the current process.  Map the page into hyperspace</span>
04122     <span class="comment">// reference it through hyperspace.</span>
04123     <span class="comment">//</span>
04124 
04125     PointerClusterPte = Pfn1-&gt;PteAddress;
04126     BasePage = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)((ULONG_PTR)PointerClusterPte &amp; ~(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1));
04127     ThisPage = BasePage;
04128 
04129     <span class="keywordflow">if</span> ((PointerClusterPte &lt; (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a5">PDE_TOP</a>) ||
04130         (!<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a> (PointerClusterPte))) {
04131 
04132         <span class="comment">//</span>
04133         <span class="comment">// Map page into hyperspace as it is either a page table</span>
04134         <span class="comment">// page or nonresident paged pool.</span>
04135         <span class="comment">//</span>
04136 
04137         PointerClusterPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)((PCHAR)<a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (
04138                                         Pfn1-&gt;PteFrame, &amp;OldIrql)
04139                                         +
04140                                 <a class="code" href="../../d2/d1/mm_8h.html#a6">BYTE_OFFSET</a> (PointerClusterPte));
04141         ThisPage = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)((ULONG_PTR)PointerClusterPte &amp; ~(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1));
04142     }
04143 
04144     OriginalPte = PointerClusterPte;
04145     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE (PointerClusterPte) == PageFrameIndex);
04146 
04147     <span class="comment">//</span>
04148     <span class="comment">// Check backwards and forwards for other pages from this process</span>
04149     <span class="comment">// destined for the paging file.</span>
04150     <span class="comment">//</span>
04151 
04152     StopPte = PointerClusterPte - (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> - 1);
04153     <span class="keywordflow">if</span> (StopPte &lt; ThisPage) {
04154         StopPte = ThisPage;
04155     }
04156 
04157     <span class="keywordflow">while</span> (PointerClusterPte &gt; StopPte) {
04158         PointerClusterPte -= 1;
04159 
04160         <span class="comment">//</span>
04161         <span class="comment">// Look for the pointer at start of segment, quit as this is NOT</span>
04162         <span class="comment">// a prototype PTE.  Normal PTEs will not match this.</span>
04163         <span class="comment">//</span>
04164 
04165         <span class="keywordflow">if</span> (BasePage != (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)
04166                         (ULONG_PTR)(PointerClusterPte-&gt;u.Long &amp; ~(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1))) {
04167 
04168             <span class="keywordflow">if</span> ((PointerClusterPte-&gt;u.Hard.Valid == 0) &amp;&amp;
04169                 (PointerClusterPte-&gt;u.Soft.Prototype == 0) &amp;&amp;
04170                 (PointerClusterPte-&gt;u.Soft.Transition == 1))  {
04171 
04172                 <span class="comment">//</span>
04173                 <span class="comment">// PTE is in transition state, see if it is modified.</span>
04174                 <span class="comment">//</span>
04175 
04176                 PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a183">MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE</a> (PointerClusterPte);
04177                 Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PageFrameIndex);
04178                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0);
04179                 <span class="keywordflow">if</span> ((Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified != 0 ) &amp;&amp;
04180                     (Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0)) {
04181 
04182                     <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> -= 1;
04183                     WriteCluster-&gt;Count += 1;
04184                     WriteCluster-&gt;Cluster[<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>] = PageFrameIndex;
04185                 }
04186             }
04187         }
04188         <span class="keywordflow">break</span>;
04189     }
04190 
04191     WriteCluster-&gt;StartIndex = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>;
04192     PointerClusterPte = OriginalPte + 1;
04193     <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> = <a class="code" href="../../d2/d1/mm_8h.html#a3">MM_MAXIMUM_DISK_IO_SIZE</a> / <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
04194 
04195     <span class="comment">//</span>
04196     <span class="comment">// Remove pages looking forward from PointerClusterPte until</span>
04197     <span class="comment">// a cluster is filled or a PTE is not on the modified list.</span>
04198     <span class="comment">//</span>
04199 
04200     ThisPage = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)((PCHAR)ThisPage + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
04201 
04202     <span class="keywordflow">while</span> ((WriteCluster-&gt;Count &lt; <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>) &amp;&amp;
04203            (PointerClusterPte &lt; ThisPage)) {
04204 
04205         <span class="keywordflow">if</span> ((PointerClusterPte-&gt;u.Hard.Valid == 0) &amp;&amp;
04206             (PointerClusterPte-&gt;u.Soft.Prototype == 0) &amp;&amp;
04207             (PointerClusterPte-&gt;u.Soft.Transition == 1))  {
04208 
04209             <span class="comment">//</span>
04210             <span class="comment">// PTE is in transition state, see if it is modified.</span>
04211             <span class="comment">//</span>
04212 
04213             PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a183">MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE</a> (PointerClusterPte);
04214             Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PageFrameIndex);
04215             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0);
04216             <span class="keywordflow">if</span> ((Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified != 0 ) &amp;&amp;
04217                 (Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0)) {
04218 
04219                 <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> += 1;
04220                 WriteCluster-&gt;Count += 1;
04221                 WriteCluster-&gt;Cluster[<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>] = PageFrameIndex;
04222                 PointerClusterPte += 1;
04223                 <span class="keywordflow">continue</span>;
04224             }
04225         }
04226         <span class="keywordflow">break</span>;
04227     }
04228 
04229     <span class="keywordflow">if</span> (OldIrql != 99) {
04230         <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql);
04231     }
04232     ClusterCounts[WriteCluster-&gt;Count] += 1;
04233     <span class="keywordflow">return</span>;
04234 }
04235 <span class="preprocessor">#endif // COMMENTED OUT **************************************************</span>
04236 <span class="preprocessor"></span>
04237 
04238 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04239"></a><a class="code" href="../../d6/d3/modwrite_8c.html#a53">04239</a> <a class="code" href="../../d6/d3/modwrite_8c.html#a53">MiMappedPageWriter</a> (
04240     IN PVOID StartContext
04241     )
04242 
04243 <span class="comment">/*++</span>
04244 <span class="comment"></span>
04245 <span class="comment">Routine Description:</span>
04246 <span class="comment"></span>
04247 <span class="comment">    Implements the NT secondary modified page writer thread.</span>
04248 <span class="comment">    Requests for writes to mapped files are sent to this thread.</span>
04249 <span class="comment">    This is required as the writing of mapped file pages could cause</span>
04250 <span class="comment">    page faults resulting in requests for free pages.  But there</span>
04251 <span class="comment">    could be no free pages - hence a dead lock.  Rather than deadlock</span>
04252 <span class="comment">    the whole system waiting on the modified page writer, creating</span>
04253 <span class="comment">    a secondary thread allows that thread to block without affecting</span>
04254 <span class="comment">    on going page file writes.</span>
04255 <span class="comment"></span>
04256 <span class="comment">Arguments:</span>
04257 <span class="comment"></span>
04258 <span class="comment">    StartContext - not used.</span>
04259 <span class="comment"></span>
04260 <span class="comment">Return Value:</span>
04261 <span class="comment"></span>
04262 <span class="comment">    None.</span>
04263 <span class="comment"></span>
04264 <span class="comment">Environment:</span>
04265 <span class="comment"></span>
04266 <span class="comment">    Kernel mode.</span>
04267 <span class="comment"></span>
04268 <span class="comment">--*/</span>
04269 
04270 {
04271     <a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html">PMMMOD_WRITER_MDL_ENTRY</a> ModWriterEntry;
04272     KIRQL OldIrql = 0;
04273     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04274     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> TempEvent;
04275 
04276     UNREFERENCED_PARAMETER (StartContext);
04277 
04278     <span class="comment">//</span>
04279     <span class="comment">// Make this a real time thread.</span>
04280     <span class="comment">//</span>
04281 
04282     (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d9/d1/thredobj_8c.html#a24">KeSetPriorityThread</a> (&amp;<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;Tcb,
04283                                 LOW_REALTIME_PRIORITY + 1);
04284 
04285     <span class="comment">//</span>
04286     <span class="comment">// Let the file system know that we are getting resources.</span>
04287     <span class="comment">//</span>
04288 
04289     <a class="code" href="../../d1/d8/fsrtl_8h.html#a17">FsRtlSetTopLevelIrpForModWriter</a>();
04290 
04291     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a> (&amp;TempEvent, NotificationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04292 
04293     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
04294         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a> (&amp;<a class="code" href="../../d6/d3/modwrite_8c.html#a15">MmMappedPageWriterEvent</a>,
04295                                <a class="code" href="../../d4/d9/ke_8h.html#a407a216">WrVirtualMemory</a>,
04296                                <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
04297                                <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
04298                                (PLARGE_INTEGER)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04299 
04300         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
04301         <span class="keywordflow">if</span> (IsListEmpty (&amp;<a class="code" href="../../d6/d3/modwrite_8c.html#a14">MmMappedPageWriterList</a>)) {
04302             <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a> (&amp;<a class="code" href="../../d6/d3/modwrite_8c.html#a15">MmMappedPageWriterEvent</a>);
04303             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
04304         } <span class="keywordflow">else</span> {
04305 
04306             ModWriterEntry = (<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html">PMMMOD_WRITER_MDL_ENTRY</a>)RemoveHeadList (
04307                                                 &amp;<a class="code" href="../../d6/d3/modwrite_8c.html#a14">MmMappedPageWriterList</a>);
04308 
04309             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
04310 
04311 
04312             <span class="keywordflow">if</span> (ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o11">ControlArea</a>-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.FailAllIo == 1) {
04313                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
04314 
04315             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/fsrtl_8h.html#a103">FsRtlAcquireFileForModWrite</a> (ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o10">File</a>,
04316                                                     &amp;ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o4">u</a>.LastByte,
04317                                                     &amp;ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o12">FileResource</a>)) {
04318 
04319                 <span class="comment">//</span>
04320                 <span class="comment">// Issue the write request.</span>
04321                 <span class="comment">//</span>
04322 
04323                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d6/iosubs_8c.html#a20">IoAsynchronousPageWrite</a> (
04324                                        ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o10">File</a>,
04325                                        &amp;ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o13">Mdl</a>,
04326                                        &amp;ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o1">WriteOffset</a>,
04327                                        <a class="code" href="../../d6/d3/modwrite_8c.html#a49">MiWriteComplete</a>,
04328                                        (PVOID)ModWriterEntry,
04329                                        &amp;ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o4">u</a>.IoStatus,
04330                                        &amp;ModWriterEntry-&gt;Irp );
04331             } <span class="keywordflow">else</span> {
04332 
04333                 <span class="comment">//</span>
04334                 <span class="comment">// Unable to get the file system resources, set error status</span>
04335                 <span class="comment">// to lock conflict (ignored by MiWriteComplete) so the APC</span>
04336                 <span class="comment">// routine is explicitly called.</span>
04337                 <span class="comment">//</span>
04338 
04339                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_FILE_LOCK_CONFLICT;
04340             }
04341 
04342             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a3">NT_ERROR</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
04343 
04344                 <span class="comment">//</span>
04345                 <span class="comment">// An error has occurred, disable APC's and</span>
04346                 <span class="comment">// call the write completion routine.</span>
04347                 <span class="comment">//</span>
04348 
04349                 ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o4">u</a>.IoStatus.Status = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04350                 ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o4">u</a>.IoStatus.Information = 0;
04351                 <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>, &amp;OldIrql);
04352                 <a class="code" href="../../d6/d3/modwrite_8c.html#a49">MiWriteComplete</a> ((PVOID)ModWriterEntry,
04353                                  &amp;ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o4">u</a>.IoStatus,
04354                                  0 );
04355                 <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a> (OldIrql);
04356             }
04357 <span class="preprocessor">#if 0</span>
04358 <span class="preprocessor"></span>    <span class="comment">//TEMPORARY code to use synchronous I/O here.</span>
04359 
04360             <span class="comment">//</span>
04361             <span class="comment">// Issue the write request.</span>
04362             <span class="comment">//</span>
04363 
04364             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d6/iosubs_8c.html#a116">IoSynchronousPageWrite</a> (
04365                                    ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o10">File</a>,
04366                                    &amp;ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o13">Mdl</a>,
04367                                    &amp;ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o1">WriteOffset</a>,
04368                                    &amp;TempEvent,
04369                                    &amp;ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o4">u</a>.IoStatus );
04370 
04371             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a3">NT_ERROR</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
04372                 ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o4">u</a>.IoStatus.Status = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04373                 ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o4">u</a>.IoStatus.Information = 0;
04374             }
04375 
04376             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a3">NT_ERROR</a>(ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o4">u</a>.IoStatus.Status)) {
04377                 KdPrint((<span class="stringliteral">"MM MODWRITE: modified page write failed %lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
04378             }
04379 
04380             <span class="comment">//</span>
04381             <span class="comment">// Call the write completion routine.</span>
04382             <span class="comment">//</span>
04383 
04384             <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>, &amp;OldIrql);
04385             <a class="code" href="../../d6/d3/modwrite_8c.html#a49">MiWriteComplete</a> ((PVOID)ModWriterEntry,
04386                              &amp;ModWriterEntry-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o2">IoStatus</a>,
04387                              0 );
04388             <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a> (OldIrql);
04389 <span class="preprocessor">#endif //0</span>
04390 <span class="preprocessor"></span>
04391         }
04392 
04393     }
04394 }
04395 
04396 BOOLEAN
<a name="l04397"></a><a class="code" href="../../d6/d3/modwrite_8c.html#a54">04397</a> <a class="code" href="../../d6/d3/modwrite_8c.html#a54">MmDisableModifiedWriteOfSection</a> (
04398     IN <a class="code" href="../../d7/d0/struct__SECTION__OBJECT__POINTERS.html">PSECTION_OBJECT_POINTERS</a> SectionObjectPointer
04399     )
04400 
04401 <span class="comment">/*++</span>
04402 <span class="comment"></span>
04403 <span class="comment">Routine Description:</span>
04404 <span class="comment"></span>
04405 <span class="comment">    This function disables page writing by the modified page writer for</span>
04406 <span class="comment">    the section which is mapped by the specified file object pointer.</span>
04407 <span class="comment"></span>
04408 <span class="comment">    This should only be used for files which CANNOT be mapped by user</span>
04409 <span class="comment">    programs, e.g., volume files, directory files, etc.</span>
04410 <span class="comment"></span>
04411 <span class="comment">Arguments:</span>
04412 <span class="comment"></span>
04413 <span class="comment">    SectionObjectPointer - Supplies a pointer to the section objects</span>
04414 <span class="comment"></span>
04415 <span class="comment"></span>
04416 <span class="comment">Return Value:</span>
04417 <span class="comment"></span>
04418 <span class="comment">    Returns TRUE if the operation was a success, FALSE if either</span>
04419 <span class="comment">    the there is no section or the section already has a view.</span>
04420 <span class="comment"></span>
04421 <span class="comment">--*/</span>
04422 
04423 {
04424     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
04425     KIRQL OldIrql;
04426     BOOLEAN state = 1;
04427 
04428     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
04429 
04430     ControlArea = ((<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>)(SectionObjectPointer-&gt;DataSectionObject));
04431 
04432     <span class="keywordflow">if</span> (ControlArea != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04433         <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o4">NumberOfMappedViews</a> == 0) {
04434 
04435             <span class="comment">//</span>
04436             <span class="comment">// There are no views to this section, indicate no modified</span>
04437             <span class="comment">// page writing is allowed.</span>
04438             <span class="comment">//</span>
04439 
04440             ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.NoModifiedWriting = 1;
04441         } <span class="keywordflow">else</span> {
04442 
04443             <span class="comment">//</span>
04444             <span class="comment">// Return the current modified page writing state.</span>
04445             <span class="comment">//</span>
04446 
04447             state = (BOOLEAN)ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.NoModifiedWriting;
04448         }
04449     } <span class="keywordflow">else</span> {
04450 
04451         <span class="comment">//</span>
04452         <span class="comment">// This file no longer has an associated segment.</span>
04453         <span class="comment">//</span>
04454 
04455         state = 0;
04456     }
04457 
04458     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
04459     <span class="keywordflow">return</span> state;
04460 }
04461 
04462 
<a name="l04463"></a><a class="code" href="../../d6/d3/modwrite_8c.html#a3">04463</a> <span class="preprocessor">#define ROUND_UP(VALUE,ROUND) ((ULONG)(((ULONG)VALUE + \</span>
04464 <span class="preprocessor">                               ((ULONG)ROUND - 1L)) &amp; (~((ULONG)ROUND - 1L))))</span>
04465 <span class="preprocessor"></span><a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l04466"></a><a class="code" href="../../d6/d3/modwrite_8c.html#a55">04466</a> <a class="code" href="../../d6/d3/modwrite_8c.html#a55">MmGetPageFileInformation</a> (
04467     OUT PVOID SystemInformation,
04468     IN ULONG SystemInformationLength,
04469     OUT PULONG Length
04470     )
04471 
04472 <span class="comment">/*++</span>
04473 <span class="comment"></span>
04474 <span class="comment">Routine Description:</span>
04475 <span class="comment"></span>
04476 <span class="comment">    This routine returns information about the currently active paging</span>
04477 <span class="comment">    files.</span>
04478 <span class="comment"></span>
04479 <span class="comment">Arguments:</span>
04480 <span class="comment"></span>
04481 <span class="comment">    SystemInformation - Returns the paging file information.</span>
04482 <span class="comment"></span>
04483 <span class="comment">    SystemInformationLength - Supplies the length of the SystemInformation</span>
04484 <span class="comment">                              buffer.</span>
04485 <span class="comment"></span>
04486 <span class="comment">    Length - Returns the length of the paging file information placed in the</span>
04487 <span class="comment">             buffer.</span>
04488 <span class="comment"></span>
04489 <span class="comment">Return Value:</span>
04490 <span class="comment"></span>
04491 <span class="comment">    Returns the status of the operation.</span>
04492 <span class="comment"></span>
04493 <span class="comment">--*/</span>
04494 
04495 {
04496     PSYSTEM_PAGEFILE_INFORMATION PageFileInfo;
04497     ULONG NextEntryOffset = 0;
04498     ULONG TotalSize = 0;
04499     ULONG i;
04500     UNICODE_STRING UserBufferPageFileName;
04501 
04502     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04503 
04504     *Length = 0;
04505     PageFileInfo = (PSYSTEM_PAGEFILE_INFORMATION)SystemInformation;
04506 
04507     PageFileInfo-&gt;TotalSize = 0;
04508 
04509     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>; i += 1) {
04510         PageFileInfo = (PSYSTEM_PAGEFILE_INFORMATION)(
04511                                 (PUCHAR)PageFileInfo + NextEntryOffset);
04512         NextEntryOffset = <span class="keyword">sizeof</span>(SYSTEM_PAGEFILE_INFORMATION);
04513         TotalSize += <span class="keyword">sizeof</span>(SYSTEM_PAGEFILE_INFORMATION);
04514 
04515         <span class="keywordflow">if</span> (TotalSize &gt; SystemInformationLength) {
04516             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
04517         }
04518 
04519         PageFileInfo-&gt;TotalSize = (ULONG)<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o0">Size</a>;
04520         PageFileInfo-&gt;TotalInUse = (ULONG)<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o4">CurrentUsage</a>;
04521         PageFileInfo-&gt;PeakUsage = (ULONG)<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o5">PeakUsage</a>;
04522 
04523         <span class="comment">//</span>
04524         <span class="comment">// The PageFileName portion of the UserBuffer must be saved locally</span>
04525         <span class="comment">// to protect against a malicious thread changing the contents.  This</span>
04526         <span class="comment">// is because we will reference the contents ourselves when the actual</span>
04527         <span class="comment">// string is copied out carefully below.</span>
04528         <span class="comment">//</span>
04529 
04530         UserBufferPageFileName.Length = <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o11">PageFileName</a>.Length;
04531         UserBufferPageFileName.MaximumLength = <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o11">PageFileName</a>.Length + <span class="keyword">sizeof</span>(WCHAR);
04532         UserBufferPageFileName.Buffer = (PWCHAR)(PageFileInfo + 1);
04533 
04534         PageFileInfo-&gt;PageFileName = UserBufferPageFileName;
04535 
04536         TotalSize += <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a> (UserBufferPageFileName.MaximumLength,
04537                                <span class="keyword">sizeof</span>(ULONG));
04538         NextEntryOffset += <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a> (UserBufferPageFileName.MaximumLength,
04539                                      <span class="keyword">sizeof</span>(ULONG));
04540 
04541         <span class="keywordflow">if</span> (TotalSize &gt; SystemInformationLength) {
04542             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
04543         }
04544 
04545         <span class="comment">//</span>
04546         <span class="comment">// Carefully reference the user buffer here.</span>
04547         <span class="comment">//</span>
04548 
04549         RtlMoveMemory(UserBufferPageFileName.Buffer,
04550                       <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o11">PageFileName</a>.Buffer,
04551                       <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o11">PageFileName</a>.Length);
04552         UserBufferPageFileName.Buffer[
04553                     <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o11">PageFileName</a>.Length/<span class="keyword">sizeof</span>(WCHAR)] = UNICODE_NULL;
04554         PageFileInfo-&gt;NextEntryOffset = NextEntryOffset;
04555     }
04556     PageFileInfo-&gt;NextEntryOffset = 0;
04557     *Length = TotalSize;
04558     <span class="keywordflow">return</span> STATUS_SUCCESS;
04559 }
04560 
04561 
04562 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l04563"></a><a class="code" href="../../d6/d3/modwrite_8c.html#a33">04563</a> <a class="code" href="../../d6/d3/modwrite_8c.html#a33">MiCheckPageFileMapping</a> (
04564     IN <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> File
04565     )
04566 
04567 <span class="comment">/*++</span>
04568 <span class="comment"></span>
04569 <span class="comment">Routine Description:</span>
04570 <span class="comment"></span>
04571 <span class="comment">    Non-pagable routine to check to see if a given file has</span>
04572 <span class="comment">    no sections and therefore is eligible to become a paging file.</span>
04573 <span class="comment"></span>
04574 <span class="comment">Arguments:</span>
04575 <span class="comment"></span>
04576 <span class="comment">    File - Supplies a pointer to the file object.</span>
04577 <span class="comment"></span>
04578 <span class="comment">Return Value:</span>
04579 <span class="comment"></span>
04580 <span class="comment">    Returns STATUS_SUCCESS if the file can be used as a paging file.</span>
04581 <span class="comment"></span>
04582 <span class="comment">--*/</span>
04583 
04584 {
04585     KIRQL OldIrql;
04586 
04587     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
04588 
04589     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>-&gt;SectionObjectPointer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04590         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
04591         <span class="keywordflow">return</span> STATUS_SUCCESS;
04592     }
04593 
04594     <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>-&gt;SectionObjectPointer-&gt;DataSectionObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
04595         (<a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>-&gt;SectionObjectPointer-&gt;ImageSectionObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
04596 
04597         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
04598         <span class="keywordflow">return</span> STATUS_INCOMPATIBLE_FILE_MAP;
04599     }
04600     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
04601     <span class="keywordflow">return</span> STATUS_SUCCESS;
04602 
04603 }
04604 
04605 
04606 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04607"></a><a class="code" href="../../d6/d3/modwrite_8c.html#a34">04607</a> <a class="code" href="../../d6/d3/modwrite_8c.html#a34">MiInsertPageFileInList</a> (
04608     VOID
04609     )
04610 
04611 <span class="comment">/*++</span>
04612 <span class="comment"></span>
04613 <span class="comment">Routine Description:</span>
04614 <span class="comment"></span>
04615 <span class="comment">    Non-pagable routine to add a page file into the list</span>
04616 <span class="comment">    of system wide page files.</span>
04617 <span class="comment"></span>
04618 <span class="comment">Arguments:</span>
04619 <span class="comment"></span>
04620 <span class="comment">    None, implicitly found through page file structures.</span>
04621 <span class="comment"></span>
04622 <span class="comment">Return Value:</span>
04623 <span class="comment"></span>
04624 <span class="comment">    None.  Operation cannot fail.</span>
04625 <span class="comment"></span>
04626 <span class="comment">--*/</span>
04627 
04628 {
04629     KIRQL OldIrql;
04630     ULONG <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
04631 
04632     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
04633 
04634     <a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a> += 1;
04635     <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = <a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>;
04636 
04637     <span class="keywordflow">if</span> (IsListEmpty (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a712">MmPagingFileHeader</a>.<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o0">ListHead</a>)) {
04638         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a712">MmPagingFileHeader</a>.<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o1">Event</a>, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04639     }
04640 
04641     InsertTailList (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a712">MmPagingFileHeader</a>.<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o0">ListHead</a>,
04642                     &amp;<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a> - 1]-&gt;Entry[0]-&gt;Links);
04643 
04644     <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a> - 1]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o8">Entry</a>[0]-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o8">CurrentList</a> =
04645                                                 &amp;<a class="code" href="../../d4/d8/mi_8h.html#a712">MmPagingFileHeader</a>.<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o0">ListHead</a>;
04646 
04647     InsertTailList (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a712">MmPagingFileHeader</a>.<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o0">ListHead</a>,
04648                     &amp;<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a> - 1]-&gt;Entry[1]-&gt;Links);
04649 
04650     <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a> - 1]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o8">Entry</a>[1]-&gt;<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o8">CurrentList</a> =
04651                                                 &amp;<a class="code" href="../../d4/d8/mi_8h.html#a712">MmPagingFileHeader</a>.<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o0">ListHead</a>;
04652 
04653     <a class="code" href="../../d4/d8/mi_8h.html#a717">MmNumberOfActiveMdlEntries</a> += 2;
04654 
04655     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
04656 
04657 
04658     ExAcquireSpinLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a690">MmChargeCommitmentLock</a>, &amp;OldIrql);
04659 
04660     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> == 1) {
04661 
04662         <span class="comment">//</span>
04663         <span class="comment">// We have just created the first paging file.  Start the</span>
04664         <span class="comment">// modified page writer.</span>
04665         <span class="comment">//</span>
04666 
04667         <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a> =
04668                     <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a> - 1]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o3">FreeSpace</a> + <a class="code" href="../../d8/d0/cmdat3_8c.html#a20">MmOverCommit</a>;
04669 
04670         <a class="code" href="../../d9/d5/4_2kddata_8c.html#a54">MmTotalCommitLimitMaximum</a> =
04671                     <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a> - 1]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o1">MaximumSize</a> + <a class="code" href="../../d8/d0/cmdat3_8c.html#a20">MmOverCommit</a>;
04672 
04673         <span class="comment">//</span>
04674         <span class="comment">// Keep commit limit above 20mb so we can boot with a small paging</span>
04675         <span class="comment">// file and clean things up.</span>
04676         <span class="comment">//</span>
04677 
04678         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a> &lt; 5500) {
04679             <a class="code" href="../../d6/d3/modwrite_8c.html#a18">MmOverCommit2</a> = 5500 - <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a>;
04680             <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a> = 5500;
04681         }
04682 
04683         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/4_2kddata_8c.html#a54">MmTotalCommitLimitMaximum</a> &lt; 5500) {
04684             <a class="code" href="../../d9/d5/4_2kddata_8c.html#a54">MmTotalCommitLimitMaximum</a> = <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a>;
04685         }
04686 
04687     } <span class="keywordflow">else</span> {
04688 
04689         <span class="comment">//</span>
04690         <span class="comment">// Balance overcommitment in the case an extension was granted.</span>
04691         <span class="comment">//</span>
04692 
04693         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d3/modwrite_8c.html#a18">MmOverCommit2</a> &gt; <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a> - 1]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o3">FreeSpace</a>) {
04694             <a class="code" href="../../d6/d3/modwrite_8c.html#a18">MmOverCommit2</a> -= <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a> - 1]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o3">FreeSpace</a>;
04695         } <span class="keywordflow">else</span> {
04696             <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a> +=
04697               <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a> - 1]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o3">FreeSpace</a> - <a class="code" href="../../d6/d3/modwrite_8c.html#a18">MmOverCommit2</a>;
04698             <a class="code" href="../../d9/d5/4_2kddata_8c.html#a54">MmTotalCommitLimitMaximum</a> +=
04699               <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a> - 1]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o1">MaximumSize</a> - <a class="code" href="../../d6/d3/modwrite_8c.html#a18">MmOverCommit2</a>;
04700             <a class="code" href="../../d6/d3/modwrite_8c.html#a18">MmOverCommit2</a> = 0;
04701         }
04702     }
04703 
04704     ExReleaseSpinLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a690">MmChargeCommitmentLock</a>, OldIrql);
04705     <span class="keywordflow">return</span>;
04706 }
04707 
04708 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04709"></a><a class="code" href="../../d6/d3/modwrite_8c.html#a56">04709</a> <a class="code" href="../../d6/d3/modwrite_8c.html#a56">MiPageFileFull</a> (
04710     )
04711 
04712 <span class="comment">/*++</span>
04713 <span class="comment"></span>
04714 <span class="comment">Routine Description:</span>
04715 <span class="comment"></span>
04716 <span class="comment">    This routine is called when no space can be found in a paging file.</span>
04717 <span class="comment">    It looks through all the paging files to see if ample space is</span>
04718 <span class="comment">    available and if not, tries to expand the paging files.</span>
04719 <span class="comment"></span>
04720 <span class="comment">    If more than 90% of all paging files is used, the commitment limit</span>
04721 <span class="comment">    is set to the total and then 100 pages are added.</span>
04722 <span class="comment"></span>
04723 <span class="comment">Arguments:</span>
04724 <span class="comment"></span>
04725 <span class="comment">    None.</span>
04726 <span class="comment"></span>
04727 <span class="comment">Return Value:</span>
04728 <span class="comment"></span>
04729 <span class="comment">    None.</span>
04730 <span class="comment"></span>
04731 <span class="comment">--*/</span>
04732 
04733 {
04734     ULONG i;
04735     PFN_NUMBER Total;
04736     PFN_NUMBER Free;
04737     KIRQL OldIrql;
04738     SIZE_T SizeToExpand;
04739 
04740     <a class="code" href="../../d4/d8/mi_8h.html#a136">MM_PFN_LOCK_ASSERT</a>();
04741 
04742     Total = 0;
04743     Free = 0;
04744     OldIrql = 0;
04745 
04746     i = 0;
04747     <span class="keywordflow">do</span> {
04748         Total += <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o0">Size</a>;
04749         Free += <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o3">FreeSpace</a>;
04750         i += 1;
04751     } <span class="keywordflow">while</span> (i &lt; <a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>);
04752 
04753     <span class="comment">//</span>
04754     <span class="comment">// Check to see if more than 90% of the total space has been used.</span>
04755     <span class="comment">//</span>
04756 
04757     <span class="keywordflow">if</span> (((Total &gt;&gt; 5) + (Total &gt;&gt; 4)) &gt;= Free) {
04758 
04759         <span class="comment">//</span>
04760         <span class="comment">// Try to expand the paging files.</span>
04761         <span class="comment">//</span>
04762 
04763         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
04764 
04765         <span class="comment">//</span>
04766         <span class="comment">// Check commit limits and set the limit to what is now used.</span>
04767         <span class="comment">// If all the pagefiles are already at their maximums, then don't</span>
04768         <span class="comment">// make things worse by setting commit to the maximum - this gives</span>
04769         <span class="comment">// systems with lots of memory a longer lease on life when they have</span>
04770         <span class="comment">// small pagefiles.</span>
04771         <span class="comment">//</span>
04772 
04773         SizeToExpand = 0;
04774         i = 0;
04775 
04776         ExAcquireSpinLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a690">MmChargeCommitmentLock</a>, &amp;OldIrql);
04777 
04778         <span class="keywordflow">do</span> {
04779             SizeToExpand += <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o1">MaximumSize</a> - <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o0">Size</a>;
04780             i += 1;
04781         } <span class="keywordflow">while</span> (i &lt; <a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>);
04782     
04783         <span class="keywordflow">if</span> (SizeToExpand == 0) {
04784             ExReleaseSpinLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a690">MmChargeCommitmentLock</a>, OldIrql);
04785 
04786             <span class="comment">//</span>
04787             <span class="comment">// Display a popup once.</span>
04788             <span class="comment">//</span>
04789 
04790             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d3/modwrite_8c.html#a22">MmPageFileFullPopupShown</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
04791                 <a class="code" href="../../d6/d3/modwrite_8c.html#a22">MmPageFileFullPopupShown</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04792                 <a class="code" href="../../d6/d3/modwrite_8c.html#a38">MiCauseOverCommitPopup</a> (1, 0);
04793             }
04794 
04795             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
04796             <span class="keywordflow">return</span>;
04797         }
04798 
04799         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a> &lt;= <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a> + 50) {
04800 
04801             <span class="comment">//</span>
04802             <span class="comment">// The total commit limit is less than the number of committed</span>
04803             <span class="comment">// pages + 50. Reset commit limit.</span>
04804             <span class="comment">//</span>
04805 
04806             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a> &lt; <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a>) {
04807 
04808                 <span class="keywordflow">if</span> (<a class="code" href="../../d6/d1/mmquota_8c.html#a9">MmPageFileFullExtendPages</a>) {
04809                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a> &gt;= <a class="code" href="../../d6/d1/mmquota_8c.html#a9">MmPageFileFullExtendPages</a>);
04810                     <a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a> -= <a class="code" href="../../d6/d1/mmquota_8c.html#a9">MmPageFileFullExtendPages</a>;
04811                     <a class="code" href="../../d6/d1/mmquota_8c.html#a9">MmPageFileFullExtendPages</a> = 0;
04812                 }
04813 
04814                 <a class="code" href="../../d6/d1/mmquota_8c.html#a9">MmPageFileFullExtendPages</a> = <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a> - <a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a>;
04815                 <a class="code" href="../../d6/d3/modwrite_8c.html#a20">MmPageFileFullExtendCount</a> += 1;
04816 
04817                 <a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a> = <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a>;
04818             }
04819 
04820             <span class="comment">//</span>
04821             <span class="comment">// Charge 100 pages against the commitment.</span>
04822             <span class="comment">//</span>
04823 
04824             <a class="code" href="../../d6/d3/modwrite_8c.html#a21">MiPageFileFullCharge</a> += <a class="code" href="../../d6/d3/modwrite_8c.html#a1">MI_PAGEFILE_FULL_CHARGE</a>;
04825 
04826             ExReleaseSpinLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a690">MmChargeCommitmentLock</a>, OldIrql);
04827 
04828             <a class="code" href="../../d6/d1/mmquota_8c.html#a18">MiChargeCommitmentCantExpand</a> (<a class="code" href="../../d6/d3/modwrite_8c.html#a1">MI_PAGEFILE_FULL_CHARGE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
04829 
04830             <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a273">MM_DBG_COMMIT_PAGEFILE_FULL</a>, 100);
04831 
04832             <span class="comment">//</span>
04833             <span class="comment">// Display a popup once.</span>
04834             <span class="comment">//</span>
04835 
04836             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d3/modwrite_8c.html#a22">MmPageFileFullPopupShown</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
04837                 <a class="code" href="../../d6/d3/modwrite_8c.html#a22">MmPageFileFullPopupShown</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04838                 <a class="code" href="../../d6/d3/modwrite_8c.html#a38">MiCauseOverCommitPopup</a> (1, 0);
04839             }
04840 
04841             <span class="comment">//</span>
04842             <span class="comment">// Delay a bit before returning the commitment so the segment</span>
04843             <span class="comment">// dereference thread gets a chance to actually grow the pagefile.</span>
04844             <span class="comment">//</span>
04845 
04846             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d3/modwrite_8c.html#a21">MiPageFileFullCharge</a> &gt;= 5 * <a class="code" href="../../d6/d3/modwrite_8c.html#a1">MI_PAGEFILE_FULL_CHARGE</a>) {
04847                 ExAcquireSpinLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a690">MmChargeCommitmentLock</a>, &amp;OldIrql);
04848                 SizeToExpand = <a class="code" href="../../d6/d3/modwrite_8c.html#a21">MiPageFileFullCharge</a>;
04849                 <a class="code" href="../../d6/d3/modwrite_8c.html#a21">MiPageFileFullCharge</a> = 0;
04850                 ExReleaseSpinLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a690">MmChargeCommitmentLock</a>, OldIrql);
04851                 <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (SizeToExpand);
04852             }
04853 
04854         }
04855         <span class="keywordflow">else</span> {
04856 
04857             <span class="comment">//</span>
04858             <span class="comment">// Commit limit is lower than the number of committed pages.</span>
04859             <span class="comment">//</span>
04860 
04861             ExReleaseSpinLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a690">MmChargeCommitmentLock</a>, OldIrql);
04862         }
04863 
04864         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
04865     }
04866     <span class="keywordflow">return</span>;
04867 }
04868 
04869 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04870"></a><a class="code" href="../../d6/d3/modwrite_8c.html#a57">04870</a> <a class="code" href="../../d6/d3/modwrite_8c.html#a57">MiFlushAllPages</a> (
04871     VOID
04872     )
04873 
04874 <span class="comment">/*++</span>
04875 <span class="comment"></span>
04876 <span class="comment">Routine Description:</span>
04877 <span class="comment"></span>
04878 <span class="comment">    Forces a write of all modified pages.</span>
04879 <span class="comment"></span>
04880 <span class="comment">Arguments:</span>
04881 <span class="comment"></span>
04882 <span class="comment">    None.</span>
04883 <span class="comment"></span>
04884 <span class="comment">Return Value:</span>
04885 <span class="comment"></span>
04886 <span class="comment">    None.</span>
04887 <span class="comment"></span>
04888 <span class="comment">Environment:</span>
04889 <span class="comment"></span>
04890 <span class="comment">    Kernel mode.  No locks held.  APC_LEVEL or less.</span>
04891 <span class="comment"></span>
04892 <span class="comment">--*/</span>
04893 
04894 {
04895     ULONG j = 0xff;
04896 
04897     <a class="code" href="../../d6/d3/modwrite_8c.html#a9">MmWriteAllModifiedPages</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04898     <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a719">MmModifiedPageWriterEvent</a>, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04899 
04900     <span class="keywordflow">do</span> {
04901         <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;<a class="code" href="../../d4/d8/mi_8h.html#a422">Mm30Milliseconds</a>);
04902         j -= 1;
04903     } <span class="keywordflow">while</span> ((<a class="code" href="../../d2/d1/mm_8h.html#a150">MmModifiedPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> &gt; 50) &amp;&amp; (j &gt; 0));
04904 
04905     <a class="code" href="../../d6/d3/modwrite_8c.html#a9">MmWriteAllModifiedPages</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04906     <span class="keywordflow">return</span>;
04907 }
04908 
04909 
04910 LOGICAL
<a name="l04911"></a><a class="code" href="../../d6/d3/modwrite_8c.html#a58">04911</a> <a class="code" href="../../d6/d3/modwrite_8c.html#a58">MiIssuePageExtendRequest</a> (
04912     IN <a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html">PMMPAGE_FILE_EXPANSION</a> PageExtend
04913     )
04914 
04915 <span class="comment">/*++</span>
04916 <span class="comment"></span>
04917 <span class="comment">Routine Description:</span>
04918 <span class="comment"></span>
04919 <span class="comment">    Queue a message to the segment dereferencing / pagefile extending</span>
04920 <span class="comment">    thread to see if the page file can be extended.  Extension is done</span>
04921 <span class="comment">    in the context of a system thread due to mutexes which the current</span>
04922 <span class="comment">    thread may be holding.</span>
04923 <span class="comment">    </span>
04924 <span class="comment">Arguments:</span>
04925 <span class="comment"></span>
04926 <span class="comment">    PageExtend - Supplies a pointer to the page file extension request.</span>
04927 <span class="comment"></span>
04928 <span class="comment">Return Value:</span>
04929 <span class="comment"></span>
04930 <span class="comment">    TRUE indicates the request completed.  FALSE indicates the request timed</span>
04931 <span class="comment">    out and was removed.</span>
04932 <span class="comment"></span>
04933 <span class="comment">Environment:</span>
04934 <span class="comment"></span>
04935 <span class="comment">    Kernel mode.  No locks held.  APC level or less.</span>
04936 <span class="comment"></span>
04937 <span class="comment">--*/</span>
04938 
04939 {
04940     KIRQL OldIrql;
04941     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
04942     PLIST_ENTRY NextEntry;
04943 
04944     ExAcquireFastLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a697">MmDereferenceSegmentHeader</a>.<a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html#o0">Lock</a>, &amp;OldIrql);
04945     InsertTailList ( &amp;<a class="code" href="../../d4/d8/mi_8h.html#a697">MmDereferenceSegmentHeader</a>.<a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html#o2">ListHead</a>,
04946                      &amp;PageExtend-&gt;DereferenceList);
04947     ExReleaseFastLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a697">MmDereferenceSegmentHeader</a>.<a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html#o0">Lock</a>, OldIrql);
04948 
04949     <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a697">MmDereferenceSegmentHeader</a>.<a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html#o1">Semaphore</a>,
04950                         0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
04951                         1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
04952                         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
04953 
04954     <span class="comment">//</span>
04955     <span class="comment">// Wait for the thread to extend the paging file.</span>
04956     <span class="comment">//</span>
04957 
04958     status = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a> (&amp;PageExtend-&gt;Event,
04959                                     <a class="code" href="../../d6/d7/halmips_8h.html#a455">Executive</a>,
04960                                     <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
04961                                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
04962                                     (PageExtend-&gt;RequestedExpansionSize &lt; 10) ?
04963                                         &amp;<a class="code" href="../../d4/d8/mi_8h.html#a418">MmOneSecond</a> : &amp;<a class="code" href="../../d4/d8/mi_8h.html#a419">MmTwentySeconds</a>);
04964 
04965     <span class="keywordflow">if</span> (status == STATUS_TIMEOUT) {
04966 
04967         <span class="comment">//</span>
04968         <span class="comment">// The wait has timed out, if this request has not</span>
04969         <span class="comment">// been processed, remove it from the list and check</span>
04970         <span class="comment">// to see if we should allow this request to succeed.</span>
04971         <span class="comment">// This prevents a deadlock between the file system</span>
04972         <span class="comment">// trying to allocate memory in the FSP and the</span>
04973         <span class="comment">// segment dereferencing thread trying to close a</span>
04974         <span class="comment">// file object, and waiting in the file system.</span>
04975         <span class="comment">//</span>
04976 
04977         KdPrint((<span class="stringliteral">"MiIssuePageExtendRequest: wait timed out, page-extend= %lx, quota = %lx\n"</span>,
04978                    PageExtend, PageExtend-&gt;RequestedExpansionSize));
04979 
04980         ExAcquireFastLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a697">MmDereferenceSegmentHeader</a>.<a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html#o0">Lock</a>, &amp;OldIrql);
04981 
04982         NextEntry = <a class="code" href="../../d4/d8/mi_8h.html#a697">MmDereferenceSegmentHeader</a>.<a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html#o2">ListHead</a>.Flink;
04983 
04984         <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d4/d8/mi_8h.html#a697">MmDereferenceSegmentHeader</a>.<a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html#o2">ListHead</a>) {
04985 
04986             <span class="comment">//</span>
04987             <span class="comment">// Check to see if this is the entry we are waiting for.</span>
04988             <span class="comment">//</span>
04989 
04990             <span class="keywordflow">if</span> (NextEntry == &amp;PageExtend-&gt;DereferenceList) {
04991 
04992                 <span class="comment">//</span>
04993                 <span class="comment">// Remove this entry.</span>
04994                 <span class="comment">//</span>
04995 
04996                 RemoveEntryList (&amp;PageExtend-&gt;DereferenceList);
04997                 ExReleaseFastLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a697">MmDereferenceSegmentHeader</a>.<a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html#o0">Lock</a>, OldIrql);
04998                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04999             }
05000             NextEntry = NextEntry-&gt;Flink;
05001         }
05002 
05003         ExReleaseFastLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a697">MmDereferenceSegmentHeader</a>.<a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html#o0">Lock</a>, OldIrql);
05004 
05005         <span class="comment">//</span>
05006         <span class="comment">// Entry is being processed, wait for completion.</span>
05007         <span class="comment">//</span>
05008 
05009         KdPrint ((<span class="stringliteral">"MiIssuePageExtendRequest: rewaiting...\n"</span>));
05010 
05011         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a> (&amp;PageExtend-&gt;Event,
05012                                <a class="code" href="../../d6/d7/halmips_8h.html#a455">Executive</a>,
05013                                <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
05014                                <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
05015                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
05016     }
05017 
05018     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05019 }
05020 
05021 
05022 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l05023"></a><a class="code" href="../../d6/d3/modwrite_8c.html#a59">05023</a> <a class="code" href="../../d6/d3/modwrite_8c.html#a59">MiIssuePageExtendRequestNoWait</a> (
05024     IN PFN_NUMBER SizeInPages
05025     )
05026 
05027 <span class="comment">/*++</span>
05028 <span class="comment"></span>
05029 <span class="comment">Routine Description:</span>
05030 <span class="comment"></span>
05031 <span class="comment">    Queue a message to the segment dereferencing / pagefile extending</span>
05032 <span class="comment">    thread to see if the page file can be extended.  Extension is done</span>
05033 <span class="comment">    in the context of a system thread due to mutexes which the current</span>
05034 <span class="comment">    thread may be holding.</span>
05035 <span class="comment">    </span>
05036 <span class="comment">Arguments:</span>
05037 <span class="comment"></span>
05038 <span class="comment">    SizeInPages - Supplies the size in pages to increase the page file(s) by.</span>
05039 <span class="comment">                  This is rounded up to a 1MB multiple by this routine.</span>
05040 <span class="comment"></span>
05041 <span class="comment">Return Value:</span>
05042 <span class="comment"></span>
05043 <span class="comment">    TRUE indicates the request completed.  FALSE indicates the request timed</span>
05044 <span class="comment">    out and was removed.</span>
05045 <span class="comment"></span>
05046 <span class="comment">Environment:</span>
05047 <span class="comment"></span>
05048 <span class="comment">    Kernel mode.  No locks held.  APC level or less.</span>
05049 <span class="comment"></span>
05050 <span class="comment">    Note this routine must be very careful to not use any paged</span>
05051 <span class="comment">    pool as the only reason it is being called is because pool is depleted.</span>
05052 <span class="comment"></span>
05053 <span class="comment">--*/</span>
05054 
05055 {
05056     KIRQL OldIrql;
05057     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
05058     PLIST_ENTRY NextEntry;
05059 
05060     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() &lt; <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
05061 
05062     ExAcquireFastLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a690">MmChargeCommitmentLock</a>, &amp;OldIrql);
05063 
05064     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a711">MmAttemptForCantExtend</a>.<a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html#o5">InProgress</a> != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
05065 
05066         <span class="comment">//</span>
05067         <span class="comment">// An expansion request is already in progress, assume</span>
05068         <span class="comment">// it will help enough (another can always be issued later) and</span>
05069         <span class="comment">// that it will succeed.</span>
05070         <span class="comment">//</span>
05071 
05072         ExReleaseFastLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a690">MmChargeCommitmentLock</a>, OldIrql);
05073         <span class="keywordflow">return</span>;
05074     }
05075 
05076     <a class="code" href="../../d4/d8/mi_8h.html#a711">MmAttemptForCantExtend</a>.<a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html#o5">InProgress</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05077     ExReleaseFastLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a690">MmChargeCommitmentLock</a>, OldIrql);
05078 
05079     SizeInPages = (SizeInPages + <a class="code" href="../../d6/d3/modwrite_8c.html#a0">ONEMB_IN_PAGES</a> - 1) &amp; ~(<a class="code" href="../../d6/d3/modwrite_8c.html#a0">ONEMB_IN_PAGES</a> - 1);
05080 
05081     <a class="code" href="../../d4/d8/mi_8h.html#a711">MmAttemptForCantExtend</a>.<a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html#o2">RequestedExpansionSize</a> = SizeInPages;
05082 
05083     ExAcquireFastLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a697">MmDereferenceSegmentHeader</a>.<a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html#o0">Lock</a>, &amp;OldIrql);
05084 
05085     InsertTailList ( &amp;<a class="code" href="../../d4/d8/mi_8h.html#a697">MmDereferenceSegmentHeader</a>.<a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html#o2">ListHead</a>,
05086                      &amp;<a class="code" href="../../d4/d8/mi_8h.html#a711">MmAttemptForCantExtend</a>.<a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html#o1">DereferenceList</a>);
05087 
05088     ExReleaseFastLock (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a697">MmDereferenceSegmentHeader</a>.<a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html#o0">Lock</a>, OldIrql);
05089 
05090     <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a697">MmDereferenceSegmentHeader</a>.<a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html#o1">Semaphore</a>,
05091                         0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
05092                         1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
05093                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
05094 
05095     <span class="keywordflow">return</span>;
05096 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:52 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
