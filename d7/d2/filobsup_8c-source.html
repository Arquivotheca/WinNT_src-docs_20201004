<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: filobsup.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>filobsup.c</h1><a href="../../d6/d3/filobsup_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    FilObSup.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements the Udfs File object support routines.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Dan Lovinger    [DanLo]     23-Sep-1996</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:</span>
00018 <span class="comment"></span>
00019 <span class="comment">--*/</span>
00020 
00021 <span class="preprocessor">#include "UdfProcs.h"</span>
00022 
00023 <span class="comment">//</span>
00024 <span class="comment">//  The Bug check file id for this module</span>
00025 <span class="comment">//</span>
00026 
<a name="l00027"></a><a class="code" href="../../d6/d3/filobsup_8c.html#a0">00027</a> <span class="preprocessor">#define BugCheckFileId                   (UDFS_BUG_CHECK_FILOBSUP)</span>
00028 <span class="preprocessor"></span>
00029 <span class="comment">//</span>
00030 <span class="comment">//  The local debug trace level</span>
00031 <span class="comment">//</span>
00032 
<a name="l00033"></a><a class="code" href="../../d6/d3/filobsup_8c.html#a1">00033</a> <span class="preprocessor">#define Dbg                              (UDFS_DEBUG_LEVEL_FILOBSUP)</span>
00034 <span class="preprocessor"></span>
00035 <span class="comment">//</span>
00036 <span class="comment">//  Local constants.</span>
00037 <span class="comment">//</span>
00038 
<a name="l00039"></a><a class="code" href="../../d6/d3/filobsup_8c.html#a2">00039</a> <span class="preprocessor">#define TYPE_OF_OPEN_MASK               (0x00000007)</span>
00040 <span class="preprocessor"></span>
00041 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00042 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, UdfDecodeFileObject)</span>
00043 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, UdfFastDecodeFileObject)</span>
00044 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, UdfSetFileObject)</span>
00045 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00046 <span class="preprocessor"></span>
00047 
00048 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00049"></a><a class="code" href="../../d3/d8/udfprocs_8h.html#a173">00049</a> <a class="code" href="../../d3/d8/udfprocs_8h.html#a173">UdfSetFileObject</a> (
00050     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00051     IN <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject,
00052     IN TYPE_OF_OPEN TypeOfOpen,
00053     IN <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb OPTIONAL,
00054     IN <a class="code" href="../../d2/d9/struct__CCB.html">PCCB</a> Ccb OPTIONAL
00055     )
00056 
00057 <span class="comment">/*++</span>
00058 <span class="comment"></span>
00059 <span class="comment">Routine Description:</span>
00060 <span class="comment"></span>
00061 <span class="comment">    This routine will initialize the FileObject context fields based on the</span>
00062 <span class="comment">    input type and data structures.</span>
00063 <span class="comment"></span>
00064 <span class="comment">Arguments:</span>
00065 <span class="comment"></span>
00066 <span class="comment">    FileObject - Supplies the file object pointer being initialized.</span>
00067 <span class="comment"></span>
00068 <span class="comment">    TypeOfOpen - Sets the type of open.</span>
00069 <span class="comment"></span>
00070 <span class="comment">    Fcb - Fcb for this file object.  Ignored for UnopenedFileObject.</span>
00071 <span class="comment"></span>
00072 <span class="comment">    Ccb - Ccb for the handle corresponding to this file object.  Will not</span>
00073 <span class="comment">        be present for stream file objects.</span>
00074 <span class="comment"></span>
00075 <span class="comment">Return Value:</span>
00076 <span class="comment"></span>
00077 <span class="comment">    None.</span>
00078 <span class="comment"></span>
00079 <span class="comment">--*/</span>
00080 
00081 {
00082     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00083 
00084     <span class="comment">//</span>
00085     <span class="comment">//  We only have values 0 to 7 available so make sure we didn't</span>
00086     <span class="comment">//  inadvertantly add a new type.</span>
00087     <span class="comment">//</span>
00088 
00089     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a8">ASSERTMSG</a>( <span class="stringliteral">"FileObject types exceed available bits\n"</span>, <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a118">BeyondValidType</a> &lt;= 8 );
00090 
00091     <span class="comment">//</span>
00092     <span class="comment">//  Setting a file object to type UnopenedFileObject means just</span>
00093     <span class="comment">//  clearing all of the context fields.  All the other input</span>
00094     <span class="comment">//</span>
00095 
00096     <span class="keywordflow">if</span> (TypeOfOpen == <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a113">UnopenedFileObject</a>) {
00097 
00098         FileObject-&gt;FsContext =
00099         FileObject-&gt;FsContext2 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00100 
00101         <span class="keywordflow">return</span>;
00102     }
00103 
00104     <span class="comment">//</span>
00105     <span class="comment">//  Check that the 3 low-order bits of the Ccb are clear.</span>
00106     <span class="comment">//</span>
00107 
00108     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a8">ASSERTMSG</a>( <span class="stringliteral">"Ccb is not quad-aligned\n"</span>, !<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( ((ULONG_PTR) Ccb), <a class="code" href="../../d6/d3/filobsup_8c.html#a2">TYPE_OF_OPEN_MASK</a> ));
00109 
00110     <span class="comment">//</span>
00111     <span class="comment">//  We will or the type of open into the low order bits of FsContext2</span>
00112     <span class="comment">//  along with the Ccb value.</span>
00113     <span class="comment">//  The Fcb is stored into the FsContext field.</span>
00114     <span class="comment">//</span>
00115 
00116     FileObject-&gt;FsContext = Fcb;
00117     FileObject-&gt;FsContext2 = Ccb;
00118 
00119     <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( ((ULONG_PTR) FileObject-&gt;FsContext2), TypeOfOpen );
00120 
00121     <span class="comment">//</span>
00122     <span class="comment">//  Set the Vpb field in the file object.</span>
00123     <span class="comment">//</span>
00124 
00125     FileObject-&gt;Vpb = Fcb-&gt;Vcb-&gt;Vpb;
00126 
00127     <span class="keywordflow">return</span>;
00128 }
00129 
00130 
00131 
00132 <a class="code" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a>
<a name="l00133"></a><a class="code" href="../../d3/d8/udfprocs_8h.html#a174">00133</a> <a class="code" href="../../d3/d8/udfprocs_8h.html#a174">UdfDecodeFileObject</a> (
00134     IN <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject,
00135     OUT <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> *Fcb,
00136     OUT <a class="code" href="../../d2/d9/struct__CCB.html">PCCB</a> *Ccb
00137     )
00138 
00139 <span class="comment">/*++</span>
00140 <span class="comment"></span>
00141 <span class="comment">Routine Description:</span>
00142 <span class="comment"></span>
00143 <span class="comment">    This routine takes a file object and extracts the Fcb and Ccb (possibly NULL)</span>
00144 <span class="comment">    and returns the type of open.</span>
00145 <span class="comment"></span>
00146 <span class="comment">Arguments:</span>
00147 <span class="comment"></span>
00148 <span class="comment">    FileObject - Supplies the file object pointer being initialized.</span>
00149 <span class="comment"></span>
00150 <span class="comment">    Fcb - Address to store the Fcb contained in the file object.</span>
00151 <span class="comment"></span>
00152 <span class="comment">    Ccb - Address to store the Ccb contained in the file object.</span>
00153 <span class="comment"></span>
00154 <span class="comment">Return Value:</span>
00155 <span class="comment"></span>
00156 <span class="comment">    TYPE_OF_OPEN - Indicates the type of file object.</span>
00157 <span class="comment"></span>
00158 <span class="comment">--*/</span>
00159 
00160 {
00161     <a class="code" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a> TypeOfOpen;
00162 
00163     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00164 
00165     <span class="comment">//</span>
00166     <span class="comment">//  If this is an unopened file object then return NULL for the</span>
00167     <span class="comment">//  Fcb/Ccb.  Don't trust any other values in the file object.</span>
00168     <span class="comment">//</span>
00169 
00170     TypeOfOpen = (<a class="code" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a>) <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( (ULONG_PTR) FileObject-&gt;FsContext2,
00171                                         <a class="code" href="../../d6/d3/filobsup_8c.html#a2">TYPE_OF_OPEN_MASK</a> );
00172 
00173     <span class="keywordflow">if</span> (TypeOfOpen == <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a113">UnopenedFileObject</a>) {
00174 
00175         *Fcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00176         *Ccb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00177 
00178     } <span class="keywordflow">else</span> {
00179 
00180         <span class="comment">//</span>
00181         <span class="comment">//  The Fcb is pointed to by the FsContext field.  The Ccb is in</span>
00182         <span class="comment">//  FsContext2 (after clearing the low three bits).  The low three</span>
00183         <span class="comment">//  bits are the file object type.</span>
00184         <span class="comment">//</span>
00185 
00186         *Fcb = FileObject-&gt;FsContext;
00187         *Ccb = FileObject-&gt;FsContext2;
00188 
00189         <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( (ULONG_PTR) *Ccb, <a class="code" href="../../d6/d3/filobsup_8c.html#a2">TYPE_OF_OPEN_MASK</a> );
00190     }
00191 
00192     <span class="comment">//</span>
00193     <span class="comment">//  Now return the type of open.</span>
00194     <span class="comment">//</span>
00195 
00196     <span class="keywordflow">return</span> TypeOfOpen;
00197 }
00198 
00199 
00200 <a class="code" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a>
<a name="l00201"></a><a class="code" href="../../d3/d8/udfprocs_8h.html#a175">00201</a> <a class="code" href="../../d3/d8/udfprocs_8h.html#a175">UdfFastDecodeFileObject</a> (
00202     IN <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject,
00203     OUT <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> *Fcb
00204     )
00205 
00206 <span class="comment">/*++</span>
00207 <span class="comment"></span>
00208 <span class="comment">Routine Description:</span>
00209 <span class="comment"></span>
00210 <span class="comment">    This procedure takes a pointer to a file object, that has already been</span>
00211 <span class="comment">    opened by Udfs and does a quick decode operation.  It will only return</span>
00212 <span class="comment">    a non null value if the file object is a user file open</span>
00213 <span class="comment"></span>
00214 <span class="comment">Arguments:</span>
00215 <span class="comment"></span>
00216 <span class="comment">    FileObject - Supplies the file object pointer being interrogated</span>
00217 <span class="comment"></span>
00218 <span class="comment">    Fcb - Address to store Fcb if this is a user file object.  NULL</span>
00219 <span class="comment">        otherwise.</span>
00220 <span class="comment"></span>
00221 <span class="comment">Return Value:</span>
00222 <span class="comment"></span>
00223 <span class="comment">    TYPE_OF_OPEN - type of open of this file object.</span>
00224 <span class="comment"></span>
00225 <span class="comment">--*/</span>
00226 
00227 {
00228     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00229 
00230     <a class="code" href="../../d1/d8/udfdata_8h.html#a34">ASSERT_FILE_OBJECT</a>( FileObject );
00231 
00232     <span class="comment">//</span>
00233     <span class="comment">//  The Fcb is in the FsContext field.  The type of open is in the low</span>
00234     <span class="comment">//  bits of the Ccb.</span>
00235     <span class="comment">//</span>
00236 
00237     *Fcb = FileObject-&gt;FsContext;
00238 
00239     <span class="keywordflow">return</span> (<a class="code" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a>) <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( (ULONG_PTR) FileObject-&gt;FsContext2, <a class="code" href="../../d6/d3/filobsup_8c.html#a2">TYPE_OF_OPEN_MASK</a> );
00240 }
00241 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:00 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
