<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: cmwraper.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>cmwraper.c</h1><a href="../../d6/d3/cmwraper_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1991  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    cmwraper.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    Provides wrapper routines to support ntos\config routines called from</span>
00012 <span class="comment">    user-mode.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    John Vert (jvert) 26-Mar-1992</span>
00017 <span class="comment"></span>
00018 <span class="comment">Revision History:</span>
00019 <span class="comment"></span>
00020 <span class="comment">--*/</span>
00021 <span class="preprocessor">#include "<a class="code" href="../../d0/d5/edithive_8h.html">edithive.h</a>"</span>
00022 <span class="preprocessor">#include "nturtl.h"</span>
00023 <span class="preprocessor">#include "stdlib.h"</span>
00024 <span class="preprocessor">#include "stdio.h"</span>
00025 
<a name="l00026"></a><a class="code" href="../../d6/d3/cmwraper_8c.html#a0">00026</a> <span class="keyword">extern</span>  ULONG   <a class="code" href="../../d6/d3/cmwraper_8c.html#a0">UsedStorage</a>;
00027 
<a name="l00028"></a><a class="code" href="../../d6/d3/cmwraper_8c.html#a1">00028</a> CCHAR <a class="code" href="../../d8/d0/hivecell_8c.html#a5">KiFindFirstSetRight</a>[256] = {
00029         0, 0, 1, 0, 2, 0, 1, 0, 3, 0, 1, 0, 2, 0, 1, 0,
00030         4, 0, 1, 0, 2, 0, 1, 0, 3, 0, 1, 0, 2, 0, 1, 0,
00031         5, 0, 1, 0, 2, 0, 1, 0, 3, 0, 1, 0, 2, 0, 1, 0,
00032         4, 0, 1, 0, 2, 0, 1, 0, 3, 0, 1, 0, 2, 0, 1, 0,
00033         6, 0, 1, 0, 2, 0, 1, 0, 3, 0, 1, 0, 2, 0, 1, 0,
00034         4, 0, 1, 0, 2, 0, 1, 0, 3, 0, 1, 0, 2, 0, 1, 0,
00035         5, 0, 1, 0, 2, 0, 1, 0, 3, 0, 1, 0, 2, 0, 1, 0,
00036         4, 0, 1, 0, 2, 0, 1, 0, 3, 0, 1, 0, 2, 0, 1, 0,
00037         7, 0, 1, 0, 2, 0, 1, 0, 3, 0, 1, 0, 2, 0, 1, 0,
00038         4, 0, 1, 0, 2, 0, 1, 0, 3, 0, 1, 0, 2, 0, 1, 0,
00039         5, 0, 1, 0, 2, 0, 1, 0, 3, 0, 1, 0, 2, 0, 1, 0,
00040         4, 0, 1, 0, 2, 0, 1, 0, 3, 0, 1, 0, 2, 0, 1, 0,
00041         6, 0, 1, 0, 2, 0, 1, 0, 3, 0, 1, 0, 2, 0, 1, 0,
00042         4, 0, 1, 0, 2, 0, 1, 0, 3, 0, 1, 0, 2, 0, 1, 0,
00043         5, 0, 1, 0, 2, 0, 1, 0, 3, 0, 1, 0, 2, 0, 1, 0,
00044         4, 0, 1, 0, 2, 0, 1, 0, 3, 0, 1, 0, 2, 0, 1, 0};
00045 
00046 
<a name="l00047"></a><a class="code" href="../../d6/d3/cmwraper_8c.html#a2">00047</a> ULONG   <a class="code" href="../../d8/d0/cmdat3_8c.html#a18">MmSizeOfPagedPoolInBytes</a> = 0xffffffff;  <span class="comment">// stub out</span>
00048 
00049 ULONG
<a name="l00050"></a><a class="code" href="../../d6/d3/cmwraper_8c.html#a9">00050</a> <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (
00051     IN PCH Format,
00052     ...
00053     )
00054 {
00055     va_list arglist;
00056     UCHAR <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[512];
00057     STRING Output;
00058 
00059     <span class="comment">//</span>
00060     <span class="comment">// Format the output into a buffer and then print it.</span>
00061     <span class="comment">//</span>
00062 
00063     va_start(arglist, Format);
00064     Output.Length = _vsnprintf(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>), Format, arglist);
00065     Output.Buffer = <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00066     printf(<span class="stringliteral">"%s"</span>, <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>);
00067     <span class="keywordflow">return</span> 0;
00068 }
00069 
00070 
00071 <span class="comment">//</span>
00072 <span class="comment">// Structure that describes the mapping of generic access rights to object</span>
00073 <span class="comment">// specific access rights for registry key and keyroot objects.</span>
00074 <span class="comment">//</span>
00075 
<a name="l00076"></a><a class="code" href="../../d6/d3/cmwraper_8c.html#a3">00076</a> GENERIC_MAPPING <a class="code" href="../../d6/d3/cmwraper_8c.html#a3">CmpKeyMapping</a> = {
00077     KEY_READ,
00078     KEY_WRITE,
00079     KEY_EXECUTE,
00080     KEY_ALL_ACCESS
00081 };
<a name="l00082"></a><a class="code" href="../../d6/d3/cmwraper_8c.html#a4">00082</a> BOOLEAN <a class="code" href="../../d8/d9/cmapi_8c.html#a0">CmpNoWrite</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
<a name="l00083"></a><a class="code" href="../../d6/d3/cmwraper_8c.html#a5">00083</a> ULONG <a class="code" href="../../d6/d3/cmwraper_8c.html#a5">CmLogLevel</a>=0;
<a name="l00084"></a><a class="code" href="../../d6/d3/cmwraper_8c.html#a6">00084</a> ULONG <a class="code" href="../../d6/d3/cmwraper_8c.html#a6">CmLogSelect</a>=0;
<a name="l00085"></a><a class="code" href="../../d6/d3/cmwraper_8c.html#a7">00085</a> <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a2">CmpMasterHive</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
<a name="l00086"></a><a class="code" href="../../d6/d3/cmwraper_8c.html#a8">00086</a> LIST_ENTRY <a class="code" href="../../d8/d9/cmapi_8c.html#a1">CmpHiveListHead</a>;            <span class="comment">// List of CMHIVEs</span>
00087 
00088 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00089 <a class="code" href="../../d6/d3/cmwraper_8c.html#a10">MyCmpInitHiveFromFile</a>(
00090     IN PUNICODE_STRING FileName,
00091     OUT <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> *CmHive,
00092     OUT PBOOLEAN Allocate
00093     );
00094 
00095 
00096 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00097"></a><a class="code" href="../../d6/d3/cmwraper_8c.html#a11">00097</a> <a class="code" href="../../d6/d3/cmwraper_8c.html#a11">CmpLazyFlush</a>(
00098     VOID
00099     )
00100 {
00101 }
00102 
00103 
00104 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00105"></a><a class="code" href="../../d6/d3/cmwraper_8c.html#a12">00105</a> <a class="code" href="../../d6/d3/cmwraper_8c.html#a12">CmpFreeSecurityDescriptor</a>(
00106     IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> Hive,
00107     IN HCELL_INDEX Cell
00108     )
00109 {
00110     <span class="keywordflow">return</span>;
00111 }
00112 
00113 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00114"></a><a class="code" href="../../d6/d3/cmwraper_8c.html#a13">00114</a> <a class="code" href="../../d6/d3/cmwraper_8c.html#a13">CmpReportNotify</a>(
00115     UNICODE_STRING          Name,
00116     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>                  Hive,
00117     HCELL_INDEX             Cell,
00118     ULONG                   Filter
00119     )
00120 {
00121 }
00122 
00123 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00124"></a><a class="code" href="../../d6/d3/cmwraper_8c.html#a14">00124</a> <a class="code" href="../../d6/d3/cmwraper_8c.html#a14">CmpLockRegistry</a>(VOID)
00125 {
00126     <span class="keywordflow">return</span>;
00127 }
00128 
00129 BOOLEAN
<a name="l00130"></a><a class="code" href="../../d6/d3/cmwraper_8c.html#a15">00130</a> <a class="code" href="../../d6/d3/cmwraper_8c.html#a15">CmpTryLockRegistryExclusive</a>(
00131     IN BOOLEAN CanWait
00132     )
00133 {
00134     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00135 }
00136 
00137 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00138"></a><a class="code" href="../../d6/d3/cmwraper_8c.html#a16">00138</a> <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>(
00139     )
00140 {
00141 }
00142 
00143 BOOLEAN
<a name="l00144"></a><a class="code" href="../../d6/d3/cmwraper_8c.html#a17">00144</a> <a class="code" href="../../d6/d3/cmwraper_8c.html#a17">CmpTestRegistryLock</a>()
00145 {
00146     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00147 }
00148 
00149 BOOLEAN
<a name="l00150"></a><a class="code" href="../../d6/d3/cmwraper_8c.html#a18">00150</a> <a class="code" href="../../d6/d3/cmwraper_8c.html#a18">CmpTestRegistryLockExclusive</a>()
00151 {
00152     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00153 }
00154 LONG
<a name="l00155"></a><a class="code" href="../../d6/d3/cmwraper_8c.html#a19">00155</a> <a class="code" href="../../d3/d5/mutntobj_8c.html#a5">KeReleaseMutex</a> (
00156     IN <a class="code" href="../../d3/d7/struct__KMUTANT.html">PKMUTEX</a> Mutex,
00157     IN BOOLEAN Wait
00158     )
00159 {
00160     <span class="keywordflow">return</span>(0);
00161 }
00162 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00163"></a><a class="code" href="../../d4/d9/ke_8h.html#a352">00163</a> <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a> (
00164     IN PVOID Object,
00165     IN <a class="code" href="../../d4/d9/ke_8h.html#a53">KWAIT_REASON</a> WaitReason,
00166     IN KPROCESSOR_MODE WaitMode,
00167     IN BOOLEAN Alertable,
00168     IN PLARGE_INTEGER Timeout OPTIONAL
00169     )
00170 {
00171     <span class="keywordflow">return</span>(STATUS_SUCCESS);
00172 }
00173 
00174 BOOLEAN
<a name="l00175"></a><a class="code" href="../../d6/d3/cmwraper_8c.html#a21">00175</a> <a class="code" href="../../d6/d3/cmwraper_8c.html#a21">CmpValidateHiveSecurityDescriptors</a>(
00176     IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> Hive
00177     )
00178 {
00179     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> RootNode;
00180     <a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a> SecurityCell;
00181     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ListAnchor;
00182     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> NextCell;
00183     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> LastCell;
00184     BOOLEAN ValidHive = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00185 
00186     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a24">CML_FLOW</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a34">CMS_SEC</a>) {
00187         KdPrint((<span class="stringliteral">"CmpValidateHiveSecurityDescriptor: Hive = %lx\n"</span>,(ULONG)<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>));
00188     }
00189     RootNode = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>) <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o8">RootCell</a>);
00190     ListAnchor = NextCell = RootNode-&gt;u1.s1.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o9">Security</a>;
00191 
00192     <span class="keywordflow">do</span> {
00193         SecurityCell = (<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html">PCM_KEY_SECURITY</a>) <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, NextCell);
00194         <span class="keywordflow">if</span> (NextCell != ListAnchor) {
00195             <span class="comment">//</span>
00196             <span class="comment">// Check to make sure that our Blink points to where we just</span>
00197             <span class="comment">// came from.</span>
00198             <span class="comment">//</span>
00199             <span class="keywordflow">if</span> (SecurityCell-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o3">Blink</a> != LastCell) {
00200                 <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a34">CMS_SEC</a>) {
00201                     KdPrint((<span class="stringliteral">"  Invalid Blink (%ld) on security cell %ld\n"</span>,SecurityCell-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o3">Blink</a>, NextCell));
00202                     KdPrint((<span class="stringliteral">"  should point to %ld\n"</span>, LastCell));
00203                 }
00204                 ValidHive = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00205             }
00206         }
00207         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a23">CML_MINOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a34">CMS_SEC</a>) {
00208             KdPrint((<span class="stringliteral">"CmpValidSD:  SD shared by %d nodes\n"</span>,SecurityCell-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o4">ReferenceCount</a>));
00209         }
00210 <span class="comment">//        SetUsed(Hive, NextCell);</span>
00211         LastCell = NextCell;
00212         NextCell = SecurityCell-&gt;<a class="code" href="../../d6/d5/struct__CM__KEY__SECURITY.html#o2">Flink</a>;
00213     } <span class="keywordflow">while</span> ( NextCell != ListAnchor );
00214     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00215 }
00216 
00217 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00218"></a><a class="code" href="../../d4/d9/ke_8h.html#a363">00218</a> <a class="code" href="../../d9/d1/bugcheck_8c.html#a13">KeBugCheck</a>(
00219     IN ULONG BugCheckCode
00220     )
00221 {
00222     printf(<span class="stringliteral">"BugCheck: code = %08lx\n"</span>, BugCheckCode);
00223     <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>(1);
00224 }
00225 
00226 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00227"></a><a class="code" href="../../d6/d3/cmwraper_8c.html#a23">00227</a> <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(
00228     IN ULONG BugCheckCode,
00229     IN ULONG Arg1,
00230     IN ULONG Arg2,
00231     IN ULONG Arg3,
00232     IN ULONG Arg4
00233     )
00234 {
00235     printf(<span class="stringliteral">"BugCheck: code = %08lx\n"</span>, BugCheckCode);
00236     printf(<span class="stringliteral">"Args =%08lx %08lx %08lx %08lx\n"</span>, Arg1, Arg2, Arg3, Arg4);
00237     <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>(1);
00238 }
00239 
00240 
00241 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00242"></a><a class="code" href="../../d4/d9/ke_8h.html#a385">00242</a> <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a>(
00243     OUT PLARGE_INTEGER SystemTime
00244     )
00245 {
00246     NtQuerySystemTime(SystemTime);
00247 }
00248 
00249 <span class="preprocessor">#ifdef POOL_TAGGING</span>
00250 <span class="preprocessor"></span>PVOID
00251 <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
00252     IN POOL_TYPE PoolType,
00253     IN ULONG NumberOfBytes,
00254     IN ULONG Tag
00255     )
00256 {
00257     PVOID   Address = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00258     ULONG   <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00259     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
00260 
00261     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>(NumberOfBytes, HBLOCK_SIZE);
00262     status = <a class="code" href="../../d3/d6/allocvm_8c.html#a7">NtAllocateVirtualMemory</a>(
00263                 NtCurrentProcess(),
00264                 &amp;Address,
00265                 0,
00266                 &amp;Size,
00267                 MEM_COMMIT,
00268                 PAGE_READWRITE
00269                 );
00270     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00271         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00272     }
00273     <span class="keywordflow">return</span> Address;
00274 }
00275 <span class="preprocessor">#else</span>
00276 <span class="preprocessor"></span>
00277 PVOID
<a name="l00278"></a><a class="code" href="../../d6/d3/cmwraper_8c.html#a25">00278</a> <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(
00279     IN POOL_TYPE PoolType,
00280     IN ULONG NumberOfBytes
00281     )
00282 {
00283     PVOID   Address = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00284     ULONG   <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00285     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
00286 
00287     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>(NumberOfBytes, <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>);
00288     status = <a class="code" href="../../d3/d6/allocvm_8c.html#a7">NtAllocateVirtualMemory</a>(
00289                 NtCurrentProcess(),
00290                 &amp;Address,
00291                 0,
00292                 &amp;<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>,
00293                 MEM_COMMIT,
00294                 PAGE_READWRITE
00295                 );
00296     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00297         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00298     }
00299     <span class="keywordflow">return</span> Address;
00300 }
00301 <span class="preprocessor">#endif</span>
00302 <span class="preprocessor"></span>
00303 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00304"></a><a class="code" href="../../d5/d8/ex_8h.html#a224">00304</a> <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(
00305     IN PVOID P
00306     )
00307 {
00308     ULONG   size;
00309     size = <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
00310 
00311     <span class="comment">// if it was really more than 1 page, well, too bad</span>
00312     <a class="code" href="../../d3/d7/freevm_8c.html#a6">NtFreeVirtualMemory</a>(
00313         NtCurrentProcess(),
00314         &amp;P,
00315         &amp;size,
00316         MEM_DECOMMIT
00317         );
00318     <span class="keywordflow">return</span>;
00319 }
00320 
00321 
00322 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00323"></a><a class="code" href="../../d6/d3/cmwraper_8c.html#a27">00323</a> <a class="code" href="../../d6/d3/cmwraper_8c.html#a27">CmpWorkerCommand</a>(
00324     IN OUT <a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html">PREGISTRY_COMMAND</a> Command
00325     )
00326 
00327 <span class="comment">/*++</span>
00328 <span class="comment"></span>
00329 <span class="comment">Routine Description:</span>
00330 <span class="comment"></span>
00331 <span class="comment">    This routine just encapsulates all the necessary synchronization for</span>
00332 <span class="comment">    sending a command to the worker thread.</span>
00333 <span class="comment"></span>
00334 <span class="comment">Arguments:</span>
00335 <span class="comment"></span>
00336 <span class="comment">    Command - Supplies a pointer to an initialized REGISTRY_COMMAND structure</span>
00337 <span class="comment">            which will be copied into the global communication structure.</span>
00338 <span class="comment"></span>
00339 <span class="comment">Return Value:</span>
00340 <span class="comment"></span>
00341 <span class="comment">    NTSTATUS = Command.Status</span>
00342 <span class="comment"></span>
00343 <span class="comment">--*/</span>
00344 
00345 {
00346     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> CmHive;
00347     PUNICODE_STRING <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>;
00348     ULONG i;
00349 
00350     <span class="keywordflow">switch</span> (Command-&gt;Command) {
00351 
00352         <span class="keywordflow">case</span> <a class="code" href="../../d1/d2/cmp_8h.html#a102">REG_CMD_FLUSH_KEY</a>:
00353             <span class="keywordflow">return</span> <a class="code" href="../../d1/d2/cmp_8h.html#a228">CmFlushKey</a>(Command-&gt;Hive, Command-&gt;Cell);
00354             <span class="keywordflow">break</span>;
00355 
00356         <span class="keywordflow">case</span> <a class="code" href="../../d1/d2/cmp_8h.html#a103">REG_CMD_FILE_SET_SIZE</a>:
00357             <span class="keywordflow">return</span> <a class="code" href="../../d7/d3/cmwrapr_8c.html#a13">CmpDoFileSetSize</a>(
00358                       Command-&gt;Hive,
00359                       Command-&gt;FileType,
00360                       Command-&gt;FileSize
00361                       );
00362             <span class="keywordflow">break</span>;
00363 
00364         <span class="keywordflow">case</span> <a class="code" href="../../d1/d2/cmp_8h.html#a104">REG_CMD_HIVE_OPEN</a>:
00365 
00366             <span class="comment">//</span>
00367             <span class="comment">// Open the file.</span>
00368             <span class="comment">//</span>
00369             <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a> = Command-&gt;FileAttributes-&gt;ObjectName;
00370 
00371             <span class="keywordflow">return</span> <a class="code" href="../../d6/d3/cmwraper_8c.html#a10">MyCmpInitHiveFromFile</a>(<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>,
00372                                          &amp;Command-&gt;CmHive,
00373                                          &amp;Command-&gt;Allocate);
00374 
00375             <span class="keywordflow">break</span>;
00376 
00377         <span class="keywordflow">case</span> <a class="code" href="../../d1/d2/cmp_8h.html#a105">REG_CMD_HIVE_CLOSE</a>:
00378 
00379             <span class="comment">//</span>
00380             <span class="comment">// Close the files associated with this hive.</span>
00381             <span class="comment">//</span>
00382             CmHive = Command-&gt;CmHive;
00383 
00384             <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="../../d0/d1/hivedata_8h.html#a42">HFILE_TYPE_MAX</a>; i++) {
00385                 <span class="keywordflow">if</span> (CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o1">FileHandles</a>[i] != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00386                     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o1">FileHandles</a>[i]);
00387                 }
00388             }
00389             <span class="keywordflow">return</span> STATUS_SUCCESS;
00390             <span class="keywordflow">break</span>;
00391 
00392         <span class="keywordflow">case</span> <a class="code" href="../../d1/d2/cmp_8h.html#a106">REG_CMD_SHUTDOWN</a>:
00393 
00394             <span class="comment">//</span>
00395             <span class="comment">// shut down the registry</span>
00396             <span class="comment">//</span>
00397             <span class="keywordflow">break</span>;
00398 
00399         <span class="keywordflow">default</span>:
00400             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00401     }
00402 }
00403 
00404 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00405"></a><a class="code" href="../../d6/d3/cmwraper_8c.html#a10">00405</a> <a class="code" href="../../d6/d3/cmwraper_8c.html#a10">MyCmpInitHiveFromFile</a>(
00406     IN PUNICODE_STRING FileName,
00407     OUT <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> *CmHive,
00408     OUT PBOOLEAN Allocate
00409     )
00410 
00411 <span class="comment">/*++</span>
00412 <span class="comment"></span>
00413 <span class="comment">Routine Description:</span>
00414 <span class="comment"></span>
00415 <span class="comment">    This routine opens a file and log, allocates a CMHIVE, and initializes</span>
00416 <span class="comment">    it.</span>
00417 <span class="comment"></span>
00418 <span class="comment">Arguments:</span>
00419 <span class="comment"></span>
00420 <span class="comment">    FileName - Supplies name of file to be loaded.</span>
00421 <span class="comment"></span>
00422 <span class="comment">    CmHive   - Returns pointer to initialized hive (if successful)</span>
00423 <span class="comment"></span>
00424 <span class="comment">    Allocate - Returns whether the hive was allocated or existing.</span>
00425 <span class="comment"></span>
00426 <span class="comment">Return Value:</span>
00427 <span class="comment"></span>
00428 <span class="comment">    NTSTATUS</span>
00429 <span class="comment"></span>
00430 <span class="comment">--*/</span>
00431 
00432 {
00433     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> NewHive;
00434     ULONG Disposition;
00435     ULONG SecondaryDisposition;
00436     HANDLE PrimaryHandle;
00437     HANDLE LogHandle;
00438     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00439     ULONG FileType;
00440     ULONG Operation;
00441 
00442     BOOLEAN Success;
00443 
00444     *CmHive = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00445 
00446     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a290">CmpOpenHiveFiles</a>(<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>,
00447                               <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">".log"</span>,
00448                               &amp;PrimaryHandle,
00449                               &amp;LogHandle,
00450                               &amp;Disposition,
00451                               &amp;SecondaryDisposition,
00452                               <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00453                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00454                               );
00455     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00456         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00457     }
00458 
00459     <span class="keywordflow">if</span> (LogHandle == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00460         FileType = <a class="code" href="../../d0/d1/hivedata_8h.html#a38">HFILE_TYPE_PRIMARY</a>;
00461     } <span class="keywordflow">else</span> {
00462         FileType = <a class="code" href="../../d0/d1/hivedata_8h.html#a40">HFILE_TYPE_LOG</a>;
00463     }
00464 
00465     <span class="keywordflow">if</span> (Disposition == FILE_CREATED) {
00466         Operation = <a class="code" href="../../d6/d0/hive_8h.html#a4">HINIT_CREATE</a>;
00467         *Allocate = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00468     } <span class="keywordflow">else</span> {
00469         Operation = <a class="code" href="../../d6/d0/hive_8h.html#a6">HINIT_FILE</a>;
00470         *Allocate = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00471     }
00472 
00473     Success = <a class="code" href="../../d1/d2/cmp_8h.html#a275">CmpInitializeHive</a>(&amp;NewHive,
00474                                 Operation,
00475                                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00476                                 FileType,
00477                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00478                                 PrimaryHandle,
00479                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00480                                 LogHandle,
00481                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00482                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00483     <span class="keywordflow">if</span> (!Success) {
00484         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(PrimaryHandle);
00485         <span class="keywordflow">if</span> (LogHandle != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00486             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(LogHandle);
00487         }
00488         <span class="keywordflow">return</span>(STATUS_REGISTRY_CORRUPT);
00489     } <span class="keywordflow">else</span> {
00490         *CmHive = NewHive;
00491         <span class="keywordflow">return</span>(STATUS_SUCCESS);
00492     }
00493 }
00494 
00495 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00496"></a><a class="code" href="../../d6/d3/cmwraper_8c.html#a28">00496</a> <a class="code" href="../../d6/d3/cmwraper_8c.html#a28">CmpLinkHiveToMaster</a>(
00497     PUNICODE_STRING LinkName,
00498     HANDLE RootDirectory,
00499     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> CmHive,
00500     BOOLEAN Allocate,
00501     PSECURITY_DESCRIPTOR SecurityDescriptor
00502     )
00503 {
00504     <span class="keywordflow">return</span>( STATUS_SUCCESS );
00505 }
00506 
00507 
00508 BOOLEAN
<a name="l00509"></a><a class="code" href="../../d6/d3/cmwraper_8c.html#a29">00509</a> <a class="code" href="../../d6/d3/cmwraper_8c.html#a29">CmpFileSetSize</a>(
00510     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>      Hive,
00511     ULONG       FileType,
00512     ULONG       FileSize
00513     )
00514 <span class="comment">/*++</span>
00515 <span class="comment"></span>
00516 <span class="comment">Routine Description:</span>
00517 <span class="comment"></span>
00518 <span class="comment">    This routine sets the size of a file.  It must not return until</span>
00519 <span class="comment">    the size is guaranteed, therefore, it does a flush.</span>
00520 <span class="comment"></span>
00521 <span class="comment">    It is environment specific.</span>
00522 <span class="comment"></span>
00523 <span class="comment">    This routine will force execution to the correct thread context.</span>
00524 <span class="comment"></span>
00525 <span class="comment">Arguments:</span>
00526 <span class="comment"></span>
00527 <span class="comment">    Hive - Hive we are doing I/O for</span>
00528 <span class="comment"></span>
00529 <span class="comment">    FileType - which supporting file to use</span>
00530 <span class="comment"></span>
00531 <span class="comment">    FileSize - 32 bit value to set the file's size to</span>
00532 <span class="comment"></span>
00533 <span class="comment">Return Value:</span>
00534 <span class="comment"></span>
00535 <span class="comment">    FALSE if failure</span>
00536 <span class="comment">    TRUE if success</span>
00537 <span class="comment"></span>
00538 <span class="comment">--*/</span>
00539 {
00540     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
00541 
00542     status = <a class="code" href="../../d7/d3/cmwrapr_8c.html#a13">CmpDoFileSetSize</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, FileType, FileSize);
00543     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00544         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a45">CMS_IO_ERROR</a>) {
00545             KdPrint((<span class="stringliteral">"CmpFileSetSize:\n\t"</span>));
00546             KdPrint((<span class="stringliteral">"Failure: status = %08lx "</span>, status));
00547         }
00548         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00549     }
00550 
00551     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00552 }
00553 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:29 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
