<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: dbgkport.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>dbgkport.c</h1><a href="../../d6/d3/dbgkport_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    dbgkport.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements the dbg primitives to access a processes</span>
00012 <span class="comment">    DebugPort and ExceptionPort.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Mark Lucovsky (markl) 19-Jan-1990</span>
00017 <span class="comment"></span>
00018 <span class="comment">Revision History:</span>
00019 <span class="comment"></span>
00020 <span class="comment">--*/</span>
00021 
00022 <span class="preprocessor">#include "<a class="code" href="../../d5/d3/dbgkp_8h.html">dbgkp.h</a>"</span>
00023 
00024 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00025 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, DbgkpSendApiMessage)</span>
00026 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, DbgkForwardException)</span>
00027 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00028 <span class="preprocessor"></span>
00029 
00030 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00031"></a><a class="code" href="../../d6/d3/dbgkport_8c.html#a1">00031</a> <a class="code" href="../../d6/d3/dbgkport_8c.html#a1">DbgkpSendApiMessage</a>(
00032     IN OUT PDBGKM_APIMSG ApiMsg,
00033     IN PVOID Port,
00034     IN BOOLEAN SuspendProcess
00035     )
00036 
00037 <span class="comment">/*++</span>
00038 <span class="comment"></span>
00039 <span class="comment">Routine Description:</span>
00040 <span class="comment"></span>
00041 <span class="comment">    This function sends the specified API message over the specified</span>
00042 <span class="comment">    port. It is the callers responsibility to format the API message</span>
00043 <span class="comment">    prior to calling this function.</span>
00044 <span class="comment"></span>
00045 <span class="comment">    If the SuspendProcess flag is supplied, then all threads in the</span>
00046 <span class="comment">    calling process are first suspended. Upon receipt of the reply</span>
00047 <span class="comment">    message, the threads are resumed.</span>
00048 <span class="comment"></span>
00049 <span class="comment">Arguments:</span>
00050 <span class="comment"></span>
00051 <span class="comment">    ApiMsg - Supplies the API message to send.</span>
00052 <span class="comment"></span>
00053 <span class="comment">    Port - Supplies the address of a port to send the api message.</span>
00054 <span class="comment"></span>
00055 <span class="comment">    SuspendProcess - A flag that if set to true, causes all of the</span>
00056 <span class="comment">        threads in the process to be suspended prior to the call,</span>
00057 <span class="comment">        and resumed upon receipt of a reply.</span>
00058 <span class="comment"></span>
00059 <span class="comment">Return Value:</span>
00060 <span class="comment"></span>
00061 <span class="comment">    TBD</span>
00062 <span class="comment"></span>
00063 <span class="comment">--*/</span>
00064 
00065 {
00066     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
00067     ULONG_PTR MessageBuffer[PORT_MAXIMUM_MESSAGE_LENGTH/<span class="keyword">sizeof</span>(ULONG_PTR)];
00068 
00069     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00070 
00071     <span class="keywordflow">if</span> ( SuspendProcess ) {
00072         <a class="code" href="../../d7/d3/dbgkproc_8c.html#a0">DbgkpSuspendProcess</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00073     }
00074 
00075     ApiMsg-&gt;ReturnedStatus = STATUS_PENDING;
00076 
00077     <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;CreateProcessReported = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00078 
00079     st = <a class="code" href="../../d6/d7/lpcsend_8c.html#a3">LpcRequestWaitReplyPort</a>(
00080             Port,
00081             (PPORT_MESSAGE) ApiMsg,
00082             (PPORT_MESSAGE) &amp;MessageBuffer[0]
00083             );
00084 
00085     ZwFlushInstructionCache(NtCurrentProcess(), <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0);
00086     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
00087         RtlMoveMemory(ApiMsg,MessageBuffer,<span class="keyword">sizeof</span>(*ApiMsg));
00088         }
00089     <span class="keywordflow">if</span> ( SuspendProcess ) {
00090         <a class="code" href="../../d7/d3/dbgkproc_8c.html#a1">DbgkpResumeProcess</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00091     }
00092 
00093     <span class="keywordflow">return</span> st;
00094 }
00095 
<a name="l00096"></a><a class="code" href="../../d6/d3/dbgkport_8c.html#a0">00096</a> LARGE_INTEGER <a class="code" href="../../d6/d3/dbgkport_8c.html#a0">DbgkpCalibrationTime</a>;
00097 
00098 BOOLEAN
<a name="l00099"></a><a class="code" href="../../d4/d3/dbgk_8h.html#a5">00099</a> <a class="code" href="../../d4/d3/dbgk_8h.html#a5">DbgkForwardException</a>(
00100     IN PEXCEPTION_RECORD ExceptionRecord,
00101     IN BOOLEAN DebugException,
00102     IN BOOLEAN SecondChance
00103     )
00104 
00105 <span class="comment">/*++</span>
00106 <span class="comment"></span>
00107 <span class="comment">Routine Description:</span>
00108 <span class="comment"></span>
00109 <span class="comment">    This function is called forward an exception to the calling process's</span>
00110 <span class="comment">    debug or subsystem exception port.</span>
00111 <span class="comment"></span>
00112 <span class="comment">Arguments:</span>
00113 <span class="comment"></span>
00114 <span class="comment">    ExceptionRecord - Supplies a pointer to an exception record.</span>
00115 <span class="comment"></span>
00116 <span class="comment">    DebugException - Supplies a boolean variable that specifies whether</span>
00117 <span class="comment">        this exception is to be forwarded to the process's</span>
00118 <span class="comment">        DebugPort(TRUE), or to its ExceptionPort(FALSE).</span>
00119 <span class="comment"></span>
00120 <span class="comment">Return Value:</span>
00121 <span class="comment"></span>
00122 <span class="comment">    TRUE - The process has a DebugPort or an ExceptionPort, and the reply</span>
00123 <span class="comment">        received from the port indicated that the exception was handled.</span>
00124 <span class="comment"></span>
00125 <span class="comment">    FALSE - The process either does not have a DebugPort or</span>
00126 <span class="comment">        ExceptionPort, or the process has a port, but the reply received</span>
00127 <span class="comment">        from the port indicated that the exception was not handled.</span>
00128 <span class="comment"></span>
00129 <span class="comment">--*/</span>
00130 
00131 {
00132     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
00133     PVOID Port;
00134     DBGKM_APIMSG m;
00135     PDBGKM_EXCEPTION args;
00136     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
00137 
00138     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00139 
00140     args = &amp;m.u.Exception;
00141 
00142     <span class="comment">//</span>
00143     <span class="comment">// Initialize the debug LPC message with default infomaation.</span>
00144     <span class="comment">//</span>
00145 
00146     DBGKM_FORMAT_API_MSG(m,DbgKmExceptionApi,<span class="keyword">sizeof</span>(*args));
00147 
00148     <span class="comment">//</span>
00149     <span class="comment">// Get the address of the destination LPC port.</span>
00150     <span class="comment">//</span>
00151 
00152     Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
00153     <span class="keywordflow">if</span> (DebugException) {
00154         Port = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;HideFromDebugger ? <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> : Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o18">DebugPort</a>;
00155 
00156     } <span class="keywordflow">else</span> {
00157         Port = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o19">ExceptionPort</a>;
00158         m.h.u2.ZeroInit = LPC_EXCEPTION;
00159     }
00160 
00161     <span class="comment">//</span>
00162     <span class="comment">// If the destination LPC port address is NULL, then return FALSE.</span>
00163     <span class="comment">//</span>
00164 
00165     <span class="keywordflow">if</span> (Port == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00166         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00167     }
00168 
00169     <span class="comment">//</span>
00170     <span class="comment">// Fill in the remainder of the debug LPC message.</span>
00171     <span class="comment">//</span>
00172 
00173     args-&gt;ExceptionRecord = *ExceptionRecord;
00174     args-&gt;FirstChance = !SecondChance;
00175 
00176     <span class="comment">//</span>
00177     <span class="comment">// Send the debug message to the destination LPC port.</span>
00178     <span class="comment">//</span>
00179 
00180     st = <a class="code" href="../../d6/d3/dbgkport_8c.html#a1">DbgkpSendApiMessage</a>(&amp;m,Port,DebugException);
00181 
00182     <span class="comment">//</span>
00183     <span class="comment">// If the send was not successful, then return a FALSE indicating that</span>
00184     <span class="comment">// the port did not handle the exception. Otherwise, if the debug port</span>
00185     <span class="comment">// is specified, then look at the return status in the message.</span>
00186     <span class="comment">//</span>
00187 
00188     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ||
00189         ((DebugException) &amp;&amp;
00190         (m.ReturnedStatus == DBG_EXCEPTION_NOT_HANDLED || !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(m.ReturnedStatus)))) {
00191         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00192 
00193     } <span class="keywordflow">else</span> {
00194         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00195     }
00196 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:39 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
