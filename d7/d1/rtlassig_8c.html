<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: rtlassig.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>rtlassig.c File Reference</h1><code>#include "<a class="el" href="../../d6/d8/ntrtlp_8h-source.html">ntrtlp.h</a>"</code><br>
<code>#include "seopaque.h"</code><br>
<code>#include "sertlp.h"</code><br>

<p>
<a href="../../d8/d0/rtlassig_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d1/rtlassig_8c.html#a0">ULONG_PTR_SDEND</a>(_Adr)&nbsp;&nbsp;&nbsp;( (ULONG_PTR)(_Adr) + (ULONG_PTR)(_Adr##<a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>) )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d1/rtlassig_8c.html#a1">ULONG_ROUND_UP</a>(x, y)&nbsp;&nbsp;&nbsp;((ULONG)(x) + ((y)-1) &amp; ~((y)-1))</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d1/rtlassig_8c.html#a2">RtlSelfRelativeToAbsoluteSD</a> (IN OUT PSECURITY_DESCRIPTOR SelfRelativeSecurityDescriptor, OUT PSECURITY_DESCRIPTOR AbsoluteSecurityDescriptor, IN OUT PULONG AbsoluteSecurityDescriptorSize, IN OUT PACL <a class="el" href="../../d2/d1/cttoken_8c.html#a55">Dacl</a>, IN OUT PULONG DaclSize, IN OUT PACL Sacl, IN OUT PULONG SaclSize, IN OUT PSID <a class="el" href="../../d2/d1/cttoken_8c.html#a53">Owner</a>, IN OUT PULONG OwnerSize, IN OUT PSID PrimaryGroup, IN OUT PULONG PrimaryGroupSize)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d1/rtlassig_8c.html#a3">RtlMakeSelfRelativeSD</a> (IN PSECURITY_DESCRIPTOR SecurityDescriptor, IN OUT PSECURITY_DESCRIPTOR SelfRelativeSecurityDescriptor, IN OUT PULONG BufferLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d1/rtlassig_8c.html#a4">RtlAbsoluteToSelfRelativeSD</a> (IN PSECURITY_DESCRIPTOR AbsoluteSecurityDescriptor, IN OUT PSECURITY_DESCRIPTOR SelfRelativeSecurityDescriptor, IN OUT PULONG BufferLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d1/rtlassig_8c.html#a5">RtlpQuerySecurityDescriptor</a> (IN PISECURITY_DESCRIPTOR SecurityDescriptor, OUT PSID *<a class="el" href="../../d2/d1/cttoken_8c.html#a53">Owner</a>, OUT PULONG OwnerSize, OUT PSID *PrimaryGroup, OUT PULONG PrimaryGroupSize, OUT PACL *<a class="el" href="../../d2/d1/cttoken_8c.html#a55">Dacl</a>, OUT PULONG DaclSize, OUT PACL *Sacl, OUT PULONG SaclSize)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d1/rtlassig_8c.html#a6">RtlSelfRelativeToAbsoluteSD2</a> (IN OUT PSECURITY_DESCRIPTOR pSelfRelativeSecurityDescriptor, IN OUT PULONG pBufferSize)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="rtlassig.c::ULONG_PTR_SDEND" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ULONG_PTR_SDEND          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">_Adr&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;( (ULONG_PTR)(_Adr) + (ULONG_PTR)(_Adr##<a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>) )</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d8/d0/rtlassig_8c-source.html#l00510">RtlSelfRelativeToAbsoluteSD2()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="rtlassig.c::ULONG_ROUND_UP" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ULONG_ROUND_UP          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">x,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>y&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;((ULONG)(x) + ((y)-1) &amp; ~((y)-1))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d8/d0/rtlassig_8c-source.html#l00510">RtlSelfRelativeToAbsoluteSD2()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a4" doxytag="rtlassig.c::RtlAbsoluteToSelfRelativeSD" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlAbsoluteToSelfRelativeSD           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>AbsoluteSecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>SelfRelativeSecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BufferLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/rtlassig_8c-source.html#l00360">360</a> of file <a class="el" href="../../d8/d0/rtlassig_8c-source.html">rtlassig.c</a>.
<p>
References <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, and <a class="el" href="../../d8/d0/rtlassig_8c-source.html#l00219">RtlMakeSelfRelativeSD()</a>.
<p>
Referenced by <a class="el" href="../../d5/d2/token_8c-source.html#l01010">SeMakeAnonymousLogonToken()</a>, and <a class="el" href="../../d5/d2/token_8c-source.html#l00536">SeMakeSystemToken()</a>.
<p>
<pre class="fragment"><div>00368                    :
00369 
00370     Converts a security descriptor in absolute form to one in <span class="keyword">self</span>-relative
00371     form.
00372 
00373 Arguments:
00374 
00375     AbsoluteSecurityDescriptor - Pointer to an absolute <a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a> security
00376         descriptor.  This descriptor will not be modified.
00377 
00378     SelfRelativeSecurityDescriptor - Pointer to a buffer that will contain
00379         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> returned <span class="keyword">self</span>-relative security descriptor.
00380 
00381     BufferLength - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> supplied
00382         buffer <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not large enough to hold <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">self</span>-relative security
00383         descriptor, an error will be returned, and <span class="keyword">this</span> field will <span class="keywordflow">return</span>
00384         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d4/mrcf_8c.html#a3">minimum</a> size required.
00385 
00386 
00387 Return Value:
00388 
00389     STATUS_BUFFER_TOO_SMALL - The supplied buffer was too small to contain
00390         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resultant security descriptor.
00391 
00392     STATUS_BAD_DESCRIPTOR_FORMAT - The supplied security descriptor was not
00393         in absolute form.
00394 
00395 --*/
00396 
00397 {
00398     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> NtStatus;
00399 
00400     PISECURITY_DESCRIPTOR IAbsoluteSecurityDescriptor =
00401             (PISECURITY_DESCRIPTOR)AbsoluteSecurityDescriptor;
00402 
00403 
00404     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
00405 
00406     <span class="comment">//</span>
00407     <span class="comment">// Make sure the passed SD is absolute format, and then call</span>
00408     <span class="comment">// RtlMakeSelfRelativeSD() to do all the work.</span>
00409     <span class="comment">//</span>
00410 
00411     <span class="keywordflow">if</span> ( RtlpAreControlBitsSet( IAbsoluteSecurityDescriptor, SE_SELF_RELATIVE) ) {
00412         <span class="keywordflow">return</span>( STATUS_BAD_DESCRIPTOR_FORMAT );
00413     }
00414 
00415     NtStatus = <a class="code" href="../../d7/d1/rtlassig_8c.html#a3">RtlMakeSelfRelativeSD</a>(
00416                    AbsoluteSecurityDescriptor,
00417                    SelfRelativeSecurityDescriptor,
00418                    BufferLength
00419                    );
00420 
00421     <span class="keywordflow">return</span>( NtStatus );
00422 
00423 }
<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="rtlassig.c::RtlMakeSelfRelativeSD" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlMakeSelfRelativeSD           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>SelfRelativeSecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BufferLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/rtlassig_8c-source.html#l00219">219</a> of file <a class="el" href="../../d8/d0/rtlassig_8c-source.html">rtlassig.c</a>.
<p>
References <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00159">Owner</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, and <a class="el" href="../../d8/d0/rtlassig_8c-source.html#l00425">RtlpQuerySecurityDescriptor()</a>.
<p>
Referenced by <a class="el" href="../../d8/d0/rtlassig_8c-source.html#l00360">RtlAbsoluteToSelfRelativeSD()</a>.
<p>
<pre class="fragment"><div>00227                    :
00228 
00229     Makes a copy of a security descriptor.  The produced copy will be in <span class="keyword">self</span>-relative
00230     form.
00231 
00232     The security descriptor to be copied may be in either absolute or <span class="keyword">self</span>-relative
00233     form.
00234 
00235 Arguments:
00236 
00237     SecurityDescriptor - Pointer to a security descriptor.  This descriptor will not
00238         be modified.
00239 
00240     SelfRelativeSecurityDescriptor - Pointer to a buffer that will contain
00241         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> returned <span class="keyword">self</span>-relative security descriptor.
00242 
00243     BufferLength - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> supplied
00244         buffer <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not large enough to hold <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">self</span>-relative security
00245         descriptor, an error will be returned, and <span class="keyword">this</span> field will <span class="keywordflow">return</span>
00246         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d4/mrcf_8c.html#a3">minimum</a> size required.
00247 
00248 
00249 Return Value:
00250 
00251     STATUS_BUFFER_TOO_SMALL - The supplied buffer was too small to contain
00252         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resultant security descriptor.
00253 
00254 
00255 --*/
00256 
00257 {
00258     ULONG NewDaclSize;
00259     ULONG NewSaclSize;
00260     ULONG NewOwnerSize;
00261     ULONG NewGroupSize;
00262 
00263     ULONG AllocationSize;
00264 
00265     PSID NewOwner;
00266     PSID NewGroup;
00267     PACL NewDacl;
00268     PACL NewSacl;
00269 
00270     PCHAR Field;
00271     PCHAR Base;
00272 
00273 
00274     <span class="comment">//</span>
00275     <span class="comment">// Convert security descriptors to new data type so we don't</span>
00276     <span class="comment">// have to cast all over the place.</span>
00277     <span class="comment">//</span>
00278 
00279     PISECURITY_DESCRIPTOR_RELATIVE IResultantDescriptor =
00280             (PISECURITY_DESCRIPTOR_RELATIVE)SelfRelativeSecurityDescriptor;
00281 
00282     PISECURITY_DESCRIPTOR IPassedSecurityDescriptor =
00283             (PISECURITY_DESCRIPTOR)SecurityDescriptor;
00284 
00285 
00286     <a class="code" href="../../d7/d1/rtlassig_8c.html#a5">RtlpQuerySecurityDescriptor</a>(
00287         IPassedSecurityDescriptor,
00288         &amp;NewOwner,
00289         &amp;NewOwnerSize,
00290         &amp;NewGroup,
00291         &amp;NewGroupSize,
00292         &amp;NewDacl,
00293         &amp;NewDaclSize,
00294         &amp;NewSacl,
00295         &amp;NewSaclSize
00296         );
00297 
00298     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
00299 
00300     AllocationSize = <span class="keyword">sizeof</span>(SECURITY_DESCRIPTOR_RELATIVE) +
00301                      NewOwnerSize +
00302                      NewGroupSize +
00303                      NewDaclSize  +
00304                      NewSaclSize  ;
00305 
00306     <span class="keywordflow">if</span> (AllocationSize &gt; *BufferLength) {
00307         *BufferLength = AllocationSize;
00308         <span class="keywordflow">return</span>( STATUS_BUFFER_TOO_SMALL );
00309     }
00310 
00311     RtlZeroMemory( IResultantDescriptor, AllocationSize );
00312 
00313     RtlCopyMemory( IResultantDescriptor,
00314                    IPassedSecurityDescriptor,
00315                    FIELD_OFFSET( SECURITY_DESCRIPTOR_RELATIVE, Owner ));
00316 
00317 
00318     Base = (PCHAR)(IResultantDescriptor);
00319     Field =  Base + (ULONG)<span class="keyword">sizeof</span>(SECURITY_DESCRIPTOR_RELATIVE);
00320 
00321     <span class="keywordflow">if</span> (NewSaclSize &gt; 0) {
00322         RtlCopyMemory( Field, NewSacl, NewSaclSize );
00323         IResultantDescriptor-&gt;Sacl = RtlPointerToOffset(Base,Field);
00324         Field += NewSaclSize;
00325     } <span class="keywordflow">else</span> {
00326         IResultantDescriptor-&gt;Sacl = 0;
00327     }
00328 
00329 
00330     <span class="keywordflow">if</span> (NewDaclSize &gt; 0) {
00331         RtlCopyMemory( Field, NewDacl, NewDaclSize );
00332         IResultantDescriptor-&gt;Dacl = RtlPointerToOffset(Base,Field);
00333         Field += NewDaclSize;
00334     } <span class="keywordflow">else</span> {
00335         IResultantDescriptor-&gt;Dacl = 0;
00336     }
00337 
00338 
00339 
00340     <span class="keywordflow">if</span> (NewOwnerSize &gt; 0) {
00341         RtlCopyMemory( Field, NewOwner, NewOwnerSize );
00342         IResultantDescriptor-&gt;Owner = RtlPointerToOffset(Base,Field);
00343         Field += NewOwnerSize;
00344     }
00345 
00346 
00347     <span class="keywordflow">if</span> (NewGroupSize &gt; 0) {
00348         RtlCopyMemory( Field, NewGroup, NewGroupSize );
00349         IResultantDescriptor-&gt;Group = RtlPointerToOffset(Base,Field);
00350     }
00351 
00352     RtlpSetControlBits( IResultantDescriptor, SE_SELF_RELATIVE );
00353 
00354     <span class="keywordflow">return</span>( STATUS_SUCCESS );
00355 
00356 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="rtlassig.c::RtlpQuerySecurityDescriptor" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlpQuerySecurityDescriptor           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PISECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PSID *&nbsp;</td>
          <td class="mdname" nowrap> <em>Owner</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>OwnerSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PSID *&nbsp;</td>
          <td class="mdname" nowrap> <em>PrimaryGroup</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>PrimaryGroupSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PACL *&nbsp;</td>
          <td class="mdname" nowrap> <em>Dacl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>DaclSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PACL *&nbsp;</td>
          <td class="mdname" nowrap> <em>Sacl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SaclSize</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/rtlassig_8c-source.html#l00425">425</a> of file <a class="el" href="../../d8/d0/rtlassig_8c-source.html">rtlassig.c</a>.
<p>
References <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00161">Dacl</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00159">Owner</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, and <a class="el" href="../../d1/d4/se_8h-source.html#l00540">SeLengthSid</a>.
<p>
Referenced by <a class="el" href="../../d5/d7/seurtl_8c-source.html#l01021">RtlCopySecurityDescriptor()</a>, <a class="el" href="../../d8/d0/rtlassig_8c-source.html#l00219">RtlMakeSelfRelativeSD()</a>, <a class="el" href="../../d8/d0/rtlassig_8c-source.html#l00049">RtlSelfRelativeToAbsoluteSD()</a>, and <a class="el" href="../../d8/d0/rtlassig_8c-source.html#l00510">RtlSelfRelativeToAbsoluteSD2()</a>.
<p>
<pre class="fragment"><div>00438                    :
00439 
00440     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pieces of a security descriptor structure.
00441 
00442 Arguments:
00443 
00444 
00445     SecurityDescriptor - Provides <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor of interest.
00446 
00447     <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a> - Returns a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> owner information contained in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00448         security descriptor.
00449 
00450     OwnerSize - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> owner information.
00451 
00452     PrimaryGroup -  Returns a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> primary group information.
00453 
00454     PrimaryGroupSize - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> primary group information.
00455 
00456     <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a> - Returns a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>.
00457 
00458     DaclSize - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>.
00459 
00460     Sacl - Returns a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Sacl.
00461 
00462     SaclSize - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Sacl.
00463 
00464 Return Value:
00465 
00466     None.
00467 
00468 --*/
00469 {
00470 
00471     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
00472 
00473     *<a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a> = RtlpOwnerAddrSecurityDescriptor( SecurityDescriptor );
00474 
00475     <span class="keywordflow">if</span> (*<a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00476         *OwnerSize = LongAlignSize(<a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(*Owner));
00477     } <span class="keywordflow">else</span> {
00478         *OwnerSize = 0;
00479     }
00480 
00481     *<a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a> = RtlpDaclAddrSecurityDescriptor ( SecurityDescriptor );
00482 
00483     <span class="keywordflow">if</span> (*<a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a> !=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00484         *DaclSize = LongAlignSize((*Dacl)-&gt;AclSize);
00485     } <span class="keywordflow">else</span> {
00486         *DaclSize = 0;
00487     }
00488 
00489     *PrimaryGroup = RtlpGroupAddrSecurityDescriptor( SecurityDescriptor );
00490 
00491     <span class="keywordflow">if</span> (*PrimaryGroup != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00492         *PrimaryGroupSize = LongAlignSize(<a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(*PrimaryGroup));
00493     } <span class="keywordflow">else</span> {
00494          *PrimaryGroupSize = 0;
00495     }
00496 
00497     *Sacl = RtlpSaclAddrSecurityDescriptor( SecurityDescriptor );
00498 
00499     <span class="keywordflow">if</span> (*Sacl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00500         *SaclSize = LongAlignSize((*Sacl)-&gt;AclSize);
00501     } <span class="keywordflow">else</span> {
00502         *SaclSize = 0;
00503     }
00504 
00505 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="rtlassig.c::RtlSelfRelativeToAbsoluteSD" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlSelfRelativeToAbsoluteSD           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>SelfRelativeSecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>AbsoluteSecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AbsoluteSecurityDescriptorSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PACL&nbsp;</td>
          <td class="mdname" nowrap> <em>Dacl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>DaclSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PACL&nbsp;</td>
          <td class="mdname" nowrap> <em>Sacl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SaclSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>Owner</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>OwnerSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>PrimaryGroup</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>PrimaryGroupSize</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/rtlassig_8c-source.html#l00049">49</a> of file <a class="el" href="../../d8/d0/rtlassig_8c-source.html">rtlassig.c</a>.
<p>
References <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00161">Dacl</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00159">Owner</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, <a class="el" href="../../d8/d0/rtlassig_8c-source.html#l00425">RtlpQuerySecurityDescriptor()</a>, and <a class="el" href="../../d1/d4/se_8h-source.html#l00540">SeLengthSid</a>.
<p>
<pre class="fragment"><div>00065                    :
00066 
00067     Converts a security descriptor from <span class="keyword">self</span>-relative <a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a> to absolute
00068     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a>
00069 
00070 Arguments:
00071 
00072     SecurityDescriptor - Supplies a pointer to a security descriptor in
00073         Self-Relative <a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a>
00074 
00075     AbsoluteSecurityDescriptor - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to a buffer in which will be
00076         placed <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d9/arcinst_8c.html#a19">main</a> body of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Absolute <a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a> security descriptor.
00077 
00078     <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a> - Supplies a pointer to a buffer that will contain <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00079         output descriptor.  This pointer will be referenced by, not copied
00080         into, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> output descriptor.
00081 
00082     DaclSize - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer pointed to by <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>.  In <span class="keywordflow">case</span>
00083         of error, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> will <span class="keywordflow">return</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d4/mrcf_8c.html#a3">minimum</a> size necessary to contain <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00084         <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>.
00085 
00086     Sacl - Supplies a pointer to a buffer that will contain <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Sacl of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00087         output descriptor.  This pointer will be referenced by, not copied
00088         into, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> output descriptor.
00089 
00090     SaclSize - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer pointed to by Sacl.  In <span class="keywordflow">case</span>
00091         of error, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> will <span class="keywordflow">return</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d4/mrcf_8c.html#a3">minimum</a> size necessary to contain <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00092         Sacl.
00093 
00094     <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a> - Supplies a pointer to a buffer that will contain <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a> of
00095         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> output descriptor.  This pointer will be referenced by, not
00096         copied into, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> output descriptor.
00097 
00098     OwnerSize - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer pointed to by <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>.  In
00099         <span class="keywordflow">case</span> of error, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> will <span class="keywordflow">return</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d4/mrcf_8c.html#a3">minimum</a> size necessary to contain
00100         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>.
00101 
00102     PrimaryGroup - Supplies a pointer to a buffer that will contain <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00103         PrimaryGroup of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> output descriptor.  This pointer will be
00104         referenced by, not copied into, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> output descriptor.
00105 
00106     PrimaryGroupSize - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer pointed to by
00107         PrimaryGroup.  In <span class="keywordflow">case</span> of error, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> will <span class="keywordflow">return</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d4/mrcf_8c.html#a3">minimum</a> size
00108         necessary to contain <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PrimaryGroup.
00109 
00110 
00111 Return Value:
00112 
00113     STATUS_SUCCESS - Success
00114 
00115     STATUS_BUFFER_TOO_SMALL - One of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffers passed was too small.
00116 
00117     STATUS_INVALID_OWNER - There was not a valid owner in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> passed
00118         security descriptor.
00119 
00120 --*/
00121 
00122 {
00123     ULONG NewDaclSize;
00124     ULONG NewSaclSize;
00125     ULONG NewBodySize;
00126     ULONG NewOwnerSize;
00127     ULONG NewGroupSize;
00128 
00129     PSID NewOwner;
00130     PSID NewGroup;
00131     PACL NewDacl;
00132     PACL NewSacl;
00133 
00134     <span class="comment">//</span>
00135     <span class="comment">// typecast security descriptors so we don't have to cast all over the place.</span>
00136     <span class="comment">//</span>
00137 
00138     PISECURITY_DESCRIPTOR OutSD =
00139         AbsoluteSecurityDescriptor;
00140 
00141     PISECURITY_DESCRIPTOR InSD =
00142             (PISECURITY_DESCRIPTOR)SelfRelativeSecurityDescriptor;
00143 
00144 
00145     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
00146 
00147     <span class="keywordflow">if</span> ( !RtlpAreControlBitsSet( InSD, SE_SELF_RELATIVE) ) {
00148         <span class="keywordflow">return</span>( STATUS_BAD_DESCRIPTOR_FORMAT );
00149     }
00150 
00151     NewBodySize = <span class="keyword">sizeof</span>(SECURITY_DESCRIPTOR);
00152 
00153     <a class="code" href="../../d7/d1/rtlassig_8c.html#a5">RtlpQuerySecurityDescriptor</a>(
00154         InSD,
00155         &amp;NewOwner,
00156         &amp;NewOwnerSize,
00157         &amp;NewGroup,
00158         &amp;NewGroupSize,
00159         &amp;NewDacl,
00160         &amp;NewDaclSize,
00161         &amp;NewSacl,
00162         &amp;NewSaclSize
00163         );
00164 
00165     <span class="keywordflow">if</span> ( (NewBodySize  &gt; *AbsoluteSecurityDescriptorSize) ||
00166          (NewOwnerSize &gt; *OwnerSize )                     ||
00167          (NewDaclSize  &gt; *DaclSize )                      ||
00168          (NewSaclSize  &gt; *SaclSize )                      ||
00169          (NewGroupSize &gt; *PrimaryGroupSize ) ) {
00170 
00171          *AbsoluteSecurityDescriptorSize = <span class="keyword">sizeof</span>(SECURITY_DESCRIPTOR);
00172          *PrimaryGroupSize               = NewGroupSize;
00173          *OwnerSize                      = NewOwnerSize;
00174          *SaclSize                       = NewSaclSize;
00175          *DaclSize                       = NewDaclSize;
00176 
00177          <span class="keywordflow">return</span>( STATUS_BUFFER_TOO_SMALL );
00178     }
00179 
00180 
00181     RtlMoveMemory( OutSD,
00182                    InSD,
00183                    <span class="keyword">sizeof</span>(SECURITY_DESCRIPTOR_RELATIVE) );
00184 
00185     OutSD-&gt;Owner = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00186     OutSD-&gt;Group = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00187     OutSD-&gt;Sacl  = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00188     OutSD-&gt;Dacl  = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00189 
00190     RtlpClearControlBits( OutSD, SE_SELF_RELATIVE );
00191 
00192     <span class="keywordflow">if</span> (NewOwner != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00193         RtlMoveMemory( Owner, NewOwner, <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( NewOwner ));
00194         OutSD-&gt;Owner = <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>;
00195     }
00196 
00197     <span class="keywordflow">if</span> (NewGroup != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00198         RtlMoveMemory( PrimaryGroup, NewGroup, <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( NewGroup ));
00199         OutSD-&gt;Group = PrimaryGroup;
00200     }
00201 
00202     <span class="keywordflow">if</span> (NewSacl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00203         RtlMoveMemory( Sacl, NewSacl, NewSacl-&gt;AclSize );
00204         OutSD-&gt;Sacl  = Sacl;
00205     }
00206 
00207     <span class="keywordflow">if</span> (NewDacl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00208         RtlMoveMemory( Dacl, NewDacl, NewDacl-&gt;AclSize );
00209         OutSD-&gt;Dacl  = <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>;
00210     }
00211 
00212     <span class="keywordflow">return</span>( STATUS_SUCCESS );
00213 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="rtlassig.c::RtlSelfRelativeToAbsoluteSD2" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlSelfRelativeToAbsoluteSD2           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>pSelfRelativeSecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>pBufferSize</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/rtlassig_8c-source.html#l00510">510</a> of file <a class="el" href="../../d8/d0/rtlassig_8c-source.html">rtlassig.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d9/worker_8c.html#a21">C_ASSERT()</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, <a class="el" href="../../d8/d0/rtlassig_8c-source.html#l00425">RtlpQuerySecurityDescriptor()</a>, <a class="el" href="../../d7/d1/rtlassig_8c.html#a0">ULONG_PTR_SDEND</a>, and <a class="el" href="../../d7/d1/rtlassig_8c.html#a1">ULONG_ROUND_UP</a>.
<p>
<pre class="fragment"><div>00517                    :
00518 
00519     Converts a security descriptor from <span class="keyword">self</span>-relative <a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a> to absolute
00520     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a> <span class="keyword">using</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> memory allocated <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SelfRelativeSecurityDescriptor
00521 
00522 Arguments:
00523 
00524     pSecurityDescriptor - Supplies a pointer to a security descriptor in
00525         Self-Relative <a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a>. If success, we <span class="keywordflow">return</span> a absolute security
00526         descriptor where <span class="keyword">this</span> pointer pointings.
00527 
00528     pBufferSize - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00529         buffer.
00530 
00531 Return Value:
00532 
00533     STATUS_SUCCESS - Success
00534 
00535     STATUS_BAD_DESCRIPTOR_FORMAT - The passed descriptor <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not a <span class="keyword">self</span>-relative
00536        security descriptor.
00537 
00538     STATUS_BUFFER_TOO_SMALL - The passed buffer <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> too small.
00539 
00540     STATUS_INVALID_OWNER - There was not a valid owner in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> passed
00541         security descriptor.
00542 
00543 Notes: Despite some attempts to make <span class="keyword">this</span> code as portable as possible and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> 
00544        utilization of <a class="code" href="../../d1/d9/worker_8c.html#a21">C_ASSERT</a> or <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> to detect <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> respect of these assumptions, 
00545        <span class="keyword">this</span> code <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> still making several assumptions about <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> absolute 
00546        and <span class="keyword">self</span>-relative descriptors and their relationships: in terms of packing, 
00547        fields definitions and locations in their respective structures. 
00548        In particular, <span class="keyword">this</span> code assumes that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> differences are due to differences 
00549        in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> types of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> structure members and in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> behaviour of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor
00550        query API.
00551        At <span class="keyword">this</span> time, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> structure members that get read/updated are <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>, <a class="code" href="../../d6/d0/ctaccess_8c.html#a54">Group</a>,
00552        <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a> and Sacl. If more members are added or displaced in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> definitions of these
00553        structures, <span class="keyword">this</span> code may have to be modified.
00554 
00555 --*/
00556 
00557 {
00558     ULONG_PTR   ptr;
00559     PSID        owner;
00560     PSID        group;
00561     PACL        dacl;
00562     PACL        sacl;
00563     ULONG       daclSize;
00564     ULONG       saclSize;
00565     ULONG       newBodySize;
00566     ULONG       ownerSize;
00567     ULONG       groupSize;
00568     ULONG       newBufferSize;
00569     LONG        deltaSize;
00570 
00571 <span class="comment">//</span>
00572 <span class="comment">// Typecast security descriptors so we don't have to cast all over the place.</span>
00573 <span class="comment">//</span>
00574 
00575     PISECURITY_DESCRIPTOR          psd  = (PISECURITY_DESCRIPTOR)         pSelfRelativeSecurityDescriptor;
00576     PISECURITY_DESCRIPTOR_RELATIVE psdr = (PISECURITY_DESCRIPTOR_RELATIVE)pSelfRelativeSecurityDescriptor;
00577 
00578 <span class="comment">//</span>
00579 <span class="comment">// This code uses several assumptions about the absolute and self-relative formats of </span>
00580 <span class="comment">// security descriptors and the way they are packing in memory. </span>
00581 <span class="comment">// See Routine Description Notes.</span>
00582 <span class="comment">//</span>
00583 
00584     <a class="code" href="../../d1/d9/worker_8c.html#a21">C_ASSERT</a>( <span class="keyword">sizeof</span>( SECURITY_DESCRIPTOR ) &gt;= <span class="keyword">sizeof</span>( SECURITY_DESCRIPTOR_RELATIVE ) ); 
00585     <a class="code" href="../../d1/d9/worker_8c.html#a21">C_ASSERT</a>( <span class="keyword">sizeof</span>( psd-&gt;Control ) == <span class="keyword">sizeof</span>( psdr-&gt;Control ) );
00586     <a class="code" href="../../d1/d9/worker_8c.html#a21">C_ASSERT</a>( FIELD_OFFSET( SECURITY_DESCRIPTOR, Control ) == FIELD_OFFSET( SECURITY_DESCRIPTOR_RELATIVE, Control ) );
00587     
00588     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
00589 
00590 <span class="comment">//</span>
00591 <span class="comment">// Parameters check point</span>
00592 <span class="comment">//</span>
00593 
00594     <span class="keywordflow">if</span> ( psd == (PISECURITY_DESCRIPTOR)0 ) {
00595         <span class="keywordflow">return</span>( STATUS_INVALID_PARAMETER_1 );        
00596     }
00597     <span class="keywordflow">if</span> ( pBufferSize == (PULONG)0 )   {
00598         <span class="keywordflow">return</span>( STATUS_INVALID_PARAMETER_2 );       
00599     }
00600 
00601     <span class="comment">//</span>
00602     <span class="comment">// If the passed security descriptor is not self-relative, we return</span>
00603     <span class="comment">// an format error.</span>
00604     <span class="comment">//</span>
00605 
00606     <span class="keywordflow">if</span> ( !RtlpAreControlBitsSet( psd, SE_SELF_RELATIVE) ) {
00607         <span class="keywordflow">return</span>( STATUS_BAD_DESCRIPTOR_FORMAT );
00608     }
00609 
00610 <span class="comment">//</span>
00611 <span class="comment">// Update local variables by querying the self-relative descriptor.</span>
00612 <span class="comment">//</span>
00613 <span class="comment">// Note that the returned size values are long-aligned.</span>
00614 <span class="comment">//</span>
00615 
00616     <a class="code" href="../../d7/d1/rtlassig_8c.html#a5">RtlpQuerySecurityDescriptor</a>(
00617         psd,
00618         &amp;owner,
00619         &amp;ownerSize,
00620         &amp;group,
00621         &amp;groupSize,
00622         &amp;dacl,
00623         &amp;daclSize,
00624         &amp;sacl,
00625         &amp;saclSize
00626         );
00627 
00628 <span class="comment">//</span>
00629 <span class="comment">// Identical formats check:</span>
00630 <span class="comment">//</span>
00631 
00632     <span class="comment">//</span>
00633     <span class="comment">// Determine the delta in size between the two formats of security descriptors</span>
00634     <span class="comment">//</span>
00635 
00636     deltaSize = <span class="keyword">sizeof</span>( SECURITY_DESCRIPTOR ) - <span class="keyword">sizeof</span>( SECURITY_DESCRIPTOR_RELATIVE ); 
00637 
00638     <span class="comment">//</span>
00639     <span class="comment">// If identical format: </span>
00640     <span class="comment">//      - clear the SELF_RELATIVE flag</span>
00641     <span class="comment">//      - update absolute descriptor members</span>
00642     <span class="comment">//      - return SUCCESS.</span>
00643     <span class="comment">//</span>
00644 
00645     <span class="keywordflow">if</span> ( deltaSize == 0 )   {
00646        
00647         RtlpClearControlBits( psd, SE_SELF_RELATIVE );
00648 
00649         <span class="comment">//</span>
00650         <span class="comment">// Only the following fields are updated.</span>
00651         <span class="comment">//</span>
00652 
00653         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <span class="keyword">sizeof</span>( psd-&gt;Owner ) == <span class="keyword">sizeof</span>( psdr-&gt;Owner ) );
00654         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <span class="keyword">sizeof</span>( psd-&gt;Group ) == <span class="keyword">sizeof</span>( psdr-&gt;Group ) );
00655         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <span class="keyword">sizeof</span>( psd-&gt;Sacl  ) == <span class="keyword">sizeof</span>( psdr-&gt;Sacl  ) );
00656         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <span class="keyword">sizeof</span>( psd-&gt;Dacl  ) == <span class="keyword">sizeof</span>( psdr-&gt;Dacl  ) );
00657 
00658         psd-&gt;Owner = owner;
00659         psd-&gt;Group = group;
00660         psd-&gt;Sacl  = sacl;
00661         psd-&gt;Dacl  = dacl;
00662     
00663         <span class="keywordflow">return</span>( STATUS_SUCCESS );
00664 
00665     }
00666 
00667 <span class="comment">//</span>
00668 <span class="comment">// Determine the required size for the absolute format:</span>
00669 <span class="comment">//</span>
00670 
00671 <span class="preprocessor">#define ULONG_PTR_SDEND( _Adr ) ( (ULONG_PTR)(_Adr) + (ULONG_PTR)(_Adr##Size) )</span>
00672 <span class="preprocessor"></span>
00673     ptr = owner &gt; group ? <a class="code" href="../../d7/d1/rtlassig_8c.html#a0">ULONG_PTR_SDEND</a>( owner ) : <a class="code" href="../../d7/d1/rtlassig_8c.html#a0">ULONG_PTR_SDEND</a>( group );
00674     ptr = ptr &gt; (ULONG_PTR)dacl ? ptr : <a class="code" href="../../d7/d1/rtlassig_8c.html#a0">ULONG_PTR_SDEND</a>( dacl );
00675     ptr = ptr &gt; (ULONG_PTR)sacl ? ptr : <a class="code" href="../../d7/d1/rtlassig_8c.html#a0">ULONG_PTR_SDEND</a>( sacl );
00676    
00677     newBufferSize = <span class="keyword">sizeof</span>( SECURITY_DESCRIPTOR );
00678     <span class="keywordflow">if</span> ( ptr )   {
00679 
00680 <span class="preprocessor">#define ULONG_ROUND_UP( x, y )   ((ULONG)(x) + ((y)-1) &amp; ~((y)-1))</span>
00681 <span class="preprocessor"></span>
00682         newBufferSize += <a class="code" href="../../d7/d1/rtlassig_8c.html#a1">ULONG_ROUND_UP</a>( (ULONG_PTR)ptr - (ULONG_PTR)(psdr + 1), <span class="keyword">sizeof</span>(PVOID) );
00683     }
00684 
00685     <span class="comment">//</span>
00686     <span class="comment">// If the specified buffer size is not big enough, let the caller know abour </span>
00687     <span class="comment">// the minimum size and return STATUS_BUFFER_TOO_SMALL.</span>
00688     <span class="comment">//</span>
00689 
00690     <span class="keywordflow">if</span> ( newBufferSize &gt; *pBufferSize )  {
00691         *pBufferSize = newBufferSize;
00692         <span class="keywordflow">return</span>( STATUS_BUFFER_TOO_SMALL );
00693     }
00694 
00695 <span class="comment">//</span>
00696 <span class="comment">// Update absolute security descriptor:</span>
00697 <span class="comment">//</span>
00698 
00699     <span class="comment">//</span>
00700     <span class="comment">// Move the members of self-relative security descriptor in their </span>
00701     <span class="comment">// absolute format locations.</span>
00702     <span class="comment">//</span>
00703 
00704     <span class="keywordflow">if</span> ( ptr )   {
00705        RtlMoveMemory( (PVOID)(psd + 1), (PVOID)(psdr + 1), newBufferSize - <span class="keyword">sizeof</span>( SECURITY_DESCRIPTOR) );      
00706     }
00707 
00708     <span class="comment">//</span>
00709     <span class="comment">// Clear the self-relative flag</span>
00710     <span class="comment">//</span>
00711 
00712     RtlpClearControlBits( psd, SE_SELF_RELATIVE );
00713 
00714     <span class="comment">//</span>
00715     <span class="comment">// Only the following fields are updated.</span>
00716     <span class="comment">//</span>
00717 
00718     psd-&gt;Owner = (PSID)( owner ? (ULONG_PTR)owner + deltaSize : 0 );
00719     psd-&gt;Group = (PSID)( group ? (ULONG_PTR)group + deltaSize : 0 );
00720     psd-&gt;Sacl  = (PACL)( sacl  ? (ULONG_PTR)sacl  + deltaSize : 0 );
00721     psd-&gt;Dacl  = (PACL)( dacl  ? (ULONG_PTR)dacl  + deltaSize : 0 );
00722     
00723     <span class="keywordflow">return</span>( STATUS_SUCCESS );
00724 
00725 } <span class="comment">// RtlSelfRelativeToAbsoluteSD2()</span>

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:30 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
