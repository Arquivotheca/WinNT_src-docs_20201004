<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: cmsavres.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>cmsavres.c</h1><a href="../../d6/d2/cmsavres_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1992  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    cmsavres.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This file contains code for SaveKey and RestoreKey.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Bryan M. Willman (bryanwi) 15-Jan-92</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:</span>
00018 <span class="comment"></span>
00019 <span class="comment">--*/</span>
00020 
00021 <span class="preprocessor">#include    "<a class="code" href="../../d1/d2/cmp_8h.html">cmp.h</a>"</span>
00022 
00023 <span class="comment">//</span>
00024 <span class="comment">// defines how big the buffer we use for doing a savekey by copying the</span>
00025 <span class="comment">// hive file should be.</span>
00026 <span class="comment">//</span>
<a name="l00027"></a><a class="code" href="../../d6/d2/cmsavres_8c.html#a0">00027</a> <span class="preprocessor">#define CM_SAVEKEYBUFSIZE 0x10000</span>
00028 <span class="preprocessor"></span>
<a name="l00029"></a><a class="code" href="../../d6/d2/cmsavres_8c.html#a1">00029</a> <span class="keyword">extern</span> <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a2">CmpMasterHive</a>;
00030 
<a name="l00031"></a><a class="code" href="../../d6/d2/cmsavres_8c.html#a2">00031</a> <span class="keyword">extern</span>  BOOLEAN <a class="code" href="../../d8/d9/cmapi_8c.html#a2">CmpProfileLoaded</a>;
00032 
<a name="l00033"></a><a class="code" href="../../d6/d2/cmsavres_8c.html#a3">00033</a> <span class="keyword">extern</span> PUCHAR  <a class="code" href="../../d8/d9/cmapi_8c.html#a4">CmpStashBuffer</a>;
<a name="l00034"></a><a class="code" href="../../d6/d2/cmsavres_8c.html#a4">00034</a> <span class="keyword">extern</span> ULONG   <a class="code" href="../../d8/d9/cmapi_8c.html#a7">CmpGlobalQuotaAllowed</a>;
<a name="l00035"></a><a class="code" href="../../d6/d2/cmsavres_8c.html#a5">00035</a> <span class="keyword">extern</span> ULONG   <a class="code" href="../../d8/d9/cmapi_8c.html#a8">CmpGlobalQuotaWarning</a>;
<a name="l00036"></a><a class="code" href="../../d6/d2/cmsavres_8c.html#a6">00036</a> <span class="keyword">extern</span> ULONG   <a class="code" href="../../d7/d0/cmdat2_8c.html#a9">CmpGlobalQuotaUsed</a>;
00037 
00038 <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>
00039 <a class="code" href="../../d6/d2/cmsavres_8c.html#a7">CmpCreateTemporaryHive</a>(
00040     IN HANDLE FileHandle
00041     );
00042 
00043 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00044 <a class="code" href="../../d6/d2/cmsavres_8c.html#a8">CmpDestroyTemporaryHive</a>(
00045     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> CmHive
00046     );
00047 
00048 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00049 <a class="code" href="../../d6/d2/cmsavres_8c.html#a9">CmpLoadHiveVolatile</a>(
00050     IN <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> KeyControlBlock,
00051     IN HANDLE FileHandle
00052     );
00053 
00054 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00055 <a class="code" href="../../d6/d2/cmsavres_8c.html#a10">CmpRefreshHive</a>(
00056     IN <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> KeyControlBlock
00057     );
00058 
00059 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00060 <a class="code" href="../../d6/d2/cmsavres_8c.html#a11">CmpSaveKeyByFileCopy</a>(
00061     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> Hive,
00062     HANDLE  FileHandle
00063     );
00064 
00065 ULONG
00066 <a class="code" href="../../d6/d2/cmsavres_8c.html#a12">CmpRefreshWorkerRoutine</a>(
00067     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> Current,
00068     PVOID                 Context1,
00069     PVOID                 Context2
00070     );
00071 
00072 BOOLEAN
00073 <a class="code" href="../../d2/d3/cmtrecpy_8c.html#a6">CmpMergeKeyValues</a>(
00074     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>  SourceHive,
00075     HCELL_INDEX SourceKeyCell,
00076     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> SourceKeyNode,
00077     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>  TargetHive,
00078     HCELL_INDEX TargetKeyCell,
00079     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> TargetKeyNode
00080     );
00081 
00082 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00083 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmRestoreKey)</span>
00084 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpLoadHiveVolatile)</span>
00085 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpRefreshHive)</span>
00086 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmSaveKey)</span>
00087 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmSaveMergedKeys)</span>
00088 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpCreateTemporaryHive)</span>
00089 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpDestroyTemporaryHive)</span>
00090 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpRefreshWorkerRoutine)</span>
00091 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpSaveKeyByFileCopy)</span>
00092 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00093 <span class="preprocessor"></span>
00094 
00095 
00096 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00097"></a><a class="code" href="../../d6/d2/cmsavres_8c.html#a14">00097</a> <a class="code" href="../../d6/d2/cmsavres_8c.html#a14">CmRestoreKey</a>(
00098     IN <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> KeyControlBlock,
00099     IN HANDLE  FileHandle,
00100     IN ULONG Flags
00101     )
00102 <span class="comment">/*++</span>
00103 <span class="comment"></span>
00104 <span class="comment">Routine Description:</span>
00105 <span class="comment"></span>
00106 <span class="comment">    This copies the data from an on-disk hive into the registry.  The file</span>
00107 <span class="comment">    is not loaded into the registry, and the system will NOT be using</span>
00108 <span class="comment">    the source file after the call returns.</span>
00109 <span class="comment"></span>
00110 <span class="comment">    If the flag REG_WHOLE_HIVE_VOLATILE is not set, the given key is replaced</span>
00111 <span class="comment">    by the root of the hive file.  The root's name is changed to the name</span>
00112 <span class="comment">    of the given key.</span>
00113 <span class="comment"></span>
00114 <span class="comment">    If the flag REG_WHOLE_HIVE_VOLATILE is set, a volatile hive is created,</span>
00115 <span class="comment">    the hive file is copied into it, and the resulting hive is linked to</span>
00116 <span class="comment">    the master hive.  The given key must be in the master hive.  (Usually</span>
00117 <span class="comment">    will be \Registry\User)</span>
00118 <span class="comment"></span>
00119 <span class="comment">    If the flag REG_REFRESH_HIVE is set (must be only flag) then the</span>
00120 <span class="comment">    the Hive will be restored to its state as of the last flush.</span>
00121 <span class="comment">    (The hive must be marked NOLAZY_FLUSH, and the caller must have</span>
00122 <span class="comment">     TCB privilege, and the handle must point to the root of the hive.</span>
00123 <span class="comment">     If the refresh fails, the hive will be corrupt, and the system</span>
00124 <span class="comment">     will bugcheck.)</span>
00125 <span class="comment"></span>
00126 <span class="comment">    If the flag REG_FORCE_RESTORE is set, the restore operation is done even</span>
00127 <span class="comment">    if there areopen handles underneath the key we are restoring to.</span>
00128 <span class="comment"></span>
00129 <span class="comment">Arguments:</span>
00130 <span class="comment"></span>
00131 <span class="comment">    Hive - supplies a pointer to the hive control structure for the hive</span>
00132 <span class="comment"></span>
00133 <span class="comment">    Cell - supplies index of node at root of tree to restore into</span>
00134 <span class="comment"></span>
00135 <span class="comment">    FileHandle - handle of the file to read from.</span>
00136 <span class="comment"></span>
00137 <span class="comment">Return Value:</span>
00138 <span class="comment"></span>
00139 <span class="comment">    NTSTATUS - Result code from call, among the following:</span>
00140 <span class="comment"></span>
00141 <span class="comment">        &lt;TBS&gt;</span>
00142 <span class="comment"></span>
00143 <span class="comment">--*/</span>
00144 {
00145     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
00146     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a>  ptar;
00147     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a>  psrc;
00148     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>     TmpCmHive;
00149     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> newroot;
00150     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> newcell;
00151     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> parent;
00152     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> list;
00153     ULONG       count;
00154     ULONG       i;
00155     ULONG       j;
00156     LONG        size;
00157     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>      <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
00158     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>;
00159     <a class="code" href="../../d0/d1/hivedata_8h.html#a77">HSTORAGE_TYPE</a> Type;
00160     ULONG       NumberLeaves;
00161     <a class="code" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> LeafArray;
00162     <a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a> Leaf;
00163     <a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html">PCM_KEY_FAST_INDEX</a> FastLeaf;
00164 
00165     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00166     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a32">CMS_SAVRES</a>) {
00167         KdPrint((<span class="stringliteral">"CmRestoreKey:\n"</span>));
00168         KdPrint((<span class="stringliteral">"\tKCB=%08lx\n"</span>,KeyControlBlock));
00169         KdPrint((<span class="stringliteral">"\tFileHandle=%08lx\n"</span>,FileHandle));
00170     }
00171 
00172     <span class="keywordflow">if</span> (Flags &amp; REG_REFRESH_HIVE) {
00173         <span class="keywordflow">if</span> ((Flags &amp; ~REG_REFRESH_HIVE) != 0) {
00174             <span class="comment">//</span>
00175             <span class="comment">// Refresh must be alone</span>
00176             <span class="comment">//</span>
00177             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00178         }
00179     }
00180 
00181     <span class="comment">//</span>
00182     <span class="comment">// If they want to do WHOLE_HIVE_VOLATILE, it's a completely different API.</span>
00183     <span class="comment">//</span>
00184     <span class="keywordflow">if</span> (Flags &amp; REG_WHOLE_HIVE_VOLATILE) {
00185         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d2/cmsavres_8c.html#a9">CmpLoadHiveVolatile</a>(KeyControlBlock, FileHandle));
00186     }
00187 
00188     <span class="comment">//</span>
00189     <span class="comment">// If they want to do REFRESH_HIVE, that's a completely different api too.</span>
00190     <span class="comment">//</span>
00191     <span class="keywordflow">if</span> (Flags &amp; REG_REFRESH_HIVE) {
00192         <a class="code" href="../../d0/d3/cmsubs3_8c.html#a4">CmpLockRegistryExclusive</a>();
00193         status = <a class="code" href="../../d6/d2/cmsavres_8c.html#a10">CmpRefreshHive</a>(KeyControlBlock);
00194         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00195         <span class="keywordflow">return</span> status;
00196     }
00197 
00198     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> = KeyControlBlock-&gt;KeyHive;
00199     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> = KeyControlBlock-&gt;KeyCell;
00200 
00201     <span class="comment">//</span>
00202     <span class="comment">// Disallow attempts to "restore" the master hive</span>
00203     <span class="comment">//</span>
00204     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> == &amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a2">CmpMasterHive</a>-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>) {
00205         <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
00206     }
00207 
00208     <a class="code" href="../../d0/d3/cmsubs3_8c.html#a4">CmpLockRegistryExclusive</a>();
00209 
00210     <span class="comment">//</span>
00211     <span class="comment">// Make sure this key has not been deleted</span>
00212     <span class="comment">//</span>
00213     <span class="keywordflow">if</span> (KeyControlBlock-&gt;Delete) {
00214         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00215         <span class="keywordflow">return</span>(STATUS_CANNOT_DELETE);
00216     }
00217 
00218     <a class="code" href="../../d1/d2/cmp_8h.html#a57">DCmCheckRegistry</a>(CONTAINING_RECORD(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>));
00219 
00220     <span class="comment">//</span>
00221     <span class="comment">// Check for any open handles underneath the key we are restoring to.</span>
00222     <span class="comment">//</span>
00223     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d2/cmsubs_8c.html#a12">CmpSearchForOpenSubKeys</a>(KeyControlBlock,(Flags&amp;REG_FORCE_RESTORE)?SearchAndDeref:SearchIfExist) != 0) {
00224 
00225         <span class="comment">//</span>
00226         <span class="comment">// Cannot restore over a subtree with open handles in it, or the open handles to subkeys </span>
00227         <span class="comment">// successfully marked as closed.</span>
00228         <span class="comment">//</span>
00229 
00230         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00231         <span class="keywordflow">return</span>(STATUS_CANNOT_DELETE);
00232     }
00233 
00234     <span class="comment">//</span>
00235     <span class="comment">// Make sure this is the only handle open for this key</span>
00236     <span class="comment">//</span>
00237     <span class="keywordflow">if</span> (KeyControlBlock-&gt;RefCount != 1 &amp;&amp; !(Flags&amp;REG_FORCE_RESTORE)) {
00238         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00239         <span class="keywordflow">return</span>(STATUS_CANNOT_DELETE);
00240     }
00241 
00242     ptar = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>);
00243 
00244     <span class="comment">//</span>
00245     <span class="comment">// The subtree the caller wants does not exactly match a</span>
00246     <span class="comment">// subtree.  Make a temporary hive, load the file into it,</span>
00247     <span class="comment">// tree copy the temporary to the active, and free the temporary.</span>
00248     <span class="comment">//</span>
00249 
00250     <span class="comment">//</span>
00251     <span class="comment">// Create the temporary hive</span>
00252     <span class="comment">//</span>
00253     status = <a class="code" href="../../d1/d2/cmp_8h.html#a275">CmpInitializeHive</a>(&amp;TmpCmHive,
00254                            <a class="code" href="../../d6/d0/hive_8h.html#a6">HINIT_FILE</a>,
00255                            0,
00256                            <a class="code" href="../../d0/d1/hivedata_8h.html#a38">HFILE_TYPE_PRIMARY</a>,
00257                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00258                            FileHandle,
00259                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00260                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00261                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00262                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00263 
00264     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00265         <span class="keywordflow">goto</span> ErrorExit1;
00266     }                         
00267 
00268     <span class="comment">//</span>
00269     <span class="comment">// Create a new target root, under which we will copy the new tree</span>
00270     <span class="comment">//</span>
00271     <span class="keywordflow">if</span> (ptar-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a29">KEY_HIVE_ENTRY</a>) {
00272         parent = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;                         <span class="comment">// root of hive, so parent is NIL</span>
00273     } <span class="keywordflow">else</span> {
00274         parent = ptar-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o4">Parent</a>;
00275     }
00276 
00277     newroot = <a class="code" href="../../d2/d3/cmtrecpy_8c.html#a11">CmpCopyKeyPartial</a>(&amp;(TmpCmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>),
00278                                 TmpCmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>.<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o8">RootCell</a>,
00279                                 <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00280                                 parent,
00281                                 <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00282     <span class="keywordflow">if</span> (newroot == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00283         status = STATUS_INSUFFICIENT_RESOURCES;
00284         <span class="keywordflow">goto</span> ErrorExit2;
00285     }
00286 
00287     <span class="comment">//</span>
00288     <span class="comment">// newroot has all the correct stuff, except that it has the</span>
00289     <span class="comment">// source root's name, when it needs to have the target root's.</span>
00290     <span class="comment">// So edit its name.</span>
00291     <span class="comment">//</span>
00292     psrc = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>);
00293     ptar = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, newroot);
00294     size = FIELD_OFFSET(<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">CM_KEY_NODE</a>, <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>) + psrc-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>;
00295 
00296     <span class="comment">//</span>
00297     <span class="comment">// make sure that new root has correct amount of space</span>
00298     <span class="comment">// to hold name from old root</span>
00299     <span class="comment">//</span>
00300     newcell = <a class="code" href="../../d8/d0/hivecell_8c.html#a20">HvReallocateCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, newroot, size);
00301     <span class="keywordflow">if</span> (newcell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00302         status = STATUS_INSUFFICIENT_RESOURCES;
00303         <span class="keywordflow">goto</span> ErrorExit2;
00304     }
00305     newroot = newcell;
00306     ptar = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, newroot);
00307 
00308     status = STATUS_SUCCESS;
00309 
00310     RtlMoveMemory((PVOID)&amp;(ptar-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>[0]),
00311                   (PVOID)&amp;(psrc-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>[0]),
00312                   psrc-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>);
00313 
00314     ptar-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a> = psrc-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>;
00315     <span class="keywordflow">if</span> (psrc-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a32">KEY_COMP_NAME</a>) {
00316         ptar-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> |= <a class="code" href="../../d9/d0/cmdata_8h.html#a32">KEY_COMP_NAME</a>;
00317     } <span class="keywordflow">else</span> {
00318         ptar-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/cmdata_8h.html#a32">KEY_COMP_NAME</a>;
00319     }
00320 
00321     <span class="comment">//</span>
00322     <span class="comment">// newroot is now ready to have subtree copied under it, do tree copy</span>
00323     <span class="comment">//</span>
00324     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d2/cmp_8h.html#a118">CmpCopyTree</a>(&amp;(TmpCmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>),
00325                     TmpCmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>.<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o8">RootCell</a>,
00326                     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00327                     newroot) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)
00328     {
00329         status = STATUS_INSUFFICIENT_RESOURCES;
00330         <span class="keywordflow">goto</span> ErrorExit2;
00331     }
00332 
00333     <span class="comment">//</span>
00334     <span class="comment">// The new root and the tree under it now look the way we want.</span>
00335     <span class="comment">//</span>
00336 
00337     <span class="comment">//</span>
00338     <span class="comment">// Swap the new tree in for the old one.</span>
00339     <span class="comment">//</span>
00340     ptar = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>);
00341     parent = ptar-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o4">Parent</a>;
00342 
00343     <span class="keywordflow">if</span> (ptar-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a29">KEY_HIVE_ENTRY</a>) {
00344 
00345         <span class="comment">//</span>
00346         <span class="comment">// root is actually the root of the hive.  parent doesn't</span>
00347         <span class="comment">// refer to it via a child list, but rather with an inter hive</span>
00348         <span class="comment">// pointer.  also, must update base block</span>
00349         <span class="comment">//</span>
00350         ptar = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>( (&amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a2">CmpMasterHive</a>-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>)), parent);
00351         ptar-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o8">ChildHiveReference</a>.<a class="code" href="../../d5/d5/struct__CM__KEY__REFERENCE.html#o0">KeyCell</a> = newroot;
00352         ptar = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, newroot);
00353         ptar-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o4">Parent</a> = parent;
00354         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o8">RootCell</a> = newroot;
00355 
00356 
00357     } <span class="keywordflow">else</span> {
00358 
00359         <span class="comment">//</span>
00360         <span class="comment">//  Notice that new root is *always* name of existing target,</span>
00361         <span class="comment">//      therefore, even in b-tree, old and new cell can share</span>
00362         <span class="comment">//      the same reference slot in the parent.  So simply edit</span>
00363         <span class="comment">//      the new cell_index on the top of the old.</span>
00364         <span class="comment">//</span>
00365         ptar = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, parent);
00366         Type = <a class="code" href="../../d0/d1/hivedata_8h.html#a19">HvGetCellType</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>);
00367         list = ptar-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[Type];
00368         count = ptar-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[Type];
00369 
00370         ptar = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, list);
00371         <span class="keywordflow">if</span> (ptar-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o3">KeyIndex</a>.<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o0">Signature</a> == <a class="code" href="../../d9/d0/cmdata_8h.html#a18">CM_KEY_INDEX_ROOT</a>) {
00372             NumberLeaves = ptar-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o3">KeyIndex</a>.<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a>;
00373             LeafArray = &amp;ptar-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o3">KeyIndex</a>.<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o2">List</a>[0];
00374         } <span class="keywordflow">else</span> {
00375             NumberLeaves = 1;
00376             LeafArray = &amp;list;
00377         }
00378 
00379         <span class="comment">//</span>
00380         <span class="comment">// Look in each leaf for the HCELL_INDEX we need to replace</span>
00381         <span class="comment">//</span>
00382         <span class="keywordflow">for</span> (i = 0; i &lt; NumberLeaves; i++) {
00383             Leaf = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, LeafArray[i]);
00384             <span class="keywordflow">if</span> (Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o0">Signature</a> == <a class="code" href="../../d9/d0/cmdata_8h.html#a20">CM_KEY_FAST_LEAF</a>) {
00385                 FastLeaf = (<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html">PCM_KEY_FAST_INDEX</a>)Leaf;
00386                 <span class="keywordflow">for</span> (j=0; j &lt; FastLeaf-&gt;<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html#o1">Count</a>; j++) {
00387                     <span class="keywordflow">if</span> (FastLeaf-&gt;<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html#o2">List</a>[j].<a class="code" href="../../d2/d4/struct__CM__INDEX.html#o0">Cell</a> == <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>) {
00388                         FastLeaf-&gt;<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html#o2">List</a>[j].<a class="code" href="../../d2/d4/struct__CM__INDEX.html#o0">Cell</a> = newroot;
00389                         <span class="keywordflow">goto</span> FoundCell;
00390                     }
00391                 }
00392             } <span class="keywordflow">else</span> {
00393                 <span class="keywordflow">for</span> (j=0; j &lt; Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a>; j++) {
00394                     <span class="keywordflow">if</span> (Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o2">List</a>[j] == <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>) {
00395 
00396                         Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o2">List</a>[j] = newroot;
00397                         <span class="keywordflow">goto</span> FoundCell;
00398                     }
00399                 }
00400             }
00401         }
00402         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);      <span class="comment">//  implies we didn't find it</span>
00403                         <span class="comment">//  we should never get here</span>
00404     }
00405 
00406 FoundCell:
00407 
00408 
00409     <span class="comment">//</span>
00410     <span class="comment">// Fix up the key control block to point to the new root</span>
00411     <span class="comment">//</span>
00412     KeyControlBlock-&gt;KeyCell = newroot;
00413     KeyControlBlock-&gt;KeyNode = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, newroot);
00414 
00415     <span class="comment">//</span>
00416     <span class="comment">// Kcb has changed, update the cache information.</span>
00417     <span class="comment">// Registry locked exclusively, no need for KCB lock.</span>
00418     <span class="comment">//</span>
00419     <a class="code" href="../../d1/d2/cmp_8h.html#a62">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>();
00420 
00421     <a class="code" href="../../d8/d2/cmsubs_8c.html#a16">CmpCleanUpKcbValueCache</a>(KeyControlBlock);
00422 
00423     <span class="keywordflow">if</span> (KeyControlBlock-&gt;ExtFlags &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a11">CM_KCB_SUBKEY_HINT</a>) {
00424         <span class="comment">//</span>
00425         <span class="comment">// Now free the HintIndex allocation</span>
00426         <span class="comment">//</span>
00427         <a class="code" href="../../d5/d8/ex_8h.html#a7">ExFreePoolWithTag</a>(KeyControlBlock-&gt;IndexHint, CM_CACHE_INDEX_TAG | <a class="code" href="../../d5/d8/ex_8h.html#a6">PROTECTED_POOL</a>);
00428     }
00429 
00430     KeyControlBlock-&gt;ValueCache.Count = KeyControlBlock-&gt;KeyNode-&gt;ValueList.Count;
00431     KeyControlBlock-&gt;ValueCache.ValueList = (ULONG_PTR) (KeyControlBlock-&gt;KeyNode-&gt;ValueList.List);
00432     KeyControlBlock-&gt;Flags = KeyControlBlock-&gt;KeyNode-&gt;Flags;
00433     KeyControlBlock-&gt;Security = KeyControlBlock-&gt;KeyNode-&gt;Security;
00434 
00435     KeyControlBlock-&gt;ExtFlags = 0;
00436 
00437     <span class="comment">//</span>
00438     <span class="comment">// Delete the old subtree and it's root cell</span>
00439     <span class="comment">//</span>
00440     <a class="code" href="../../d3/d3/cmtredel_8c.html#a0">CmpDeleteTree</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>);
00441     <a class="code" href="../../d3/d3/cmtredel_8c.html#a1">CmpFreeKeyByCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00442 
00443     <span class="comment">//</span>
00444     <span class="comment">// Report the notify event</span>
00445     <span class="comment">//</span>
00446     <a class="code" href="../../d6/d3/cmwraper_8c.html#a13">CmpReportNotify</a>(KeyControlBlock,
00447                     KeyControlBlock-&gt;KeyHive,
00448                     KeyControlBlock-&gt;KeyCell,
00449                     REG_NOTIFY_CHANGE_NAME);
00450     
00451 
00452     <span class="comment">//</span>
00453     <span class="comment">// Free the temporary hive</span>
00454     <span class="comment">//</span>
00455     <a class="code" href="../../d6/d2/cmsavres_8c.html#a8">CmpDestroyTemporaryHive</a>(TmpCmHive);
00456 
00457     <span class="comment">//</span>
00458     <span class="comment">// We've given user chance to log on, so turn on quota</span>
00459     <span class="comment">//</span>
00460     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d9/cmapi_8c.html#a2">CmpProfileLoaded</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00461         <a class="code" href="../../d8/d9/cmapi_8c.html#a2">CmpProfileLoaded</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00462         <a class="code" href="../../d1/d2/cmp_8h.html#a249">CmpSetGlobalQuotaAllowed</a>();
00463     }
00464 
00465     <a class="code" href="../../d1/d2/cmp_8h.html#a57">DCmCheckRegistry</a>(CONTAINING_RECORD(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>));
00466     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00467     <span class="keywordflow">return</span> status;
00468 
00469 
00470     <span class="comment">//</span>
00471     <span class="comment">// Error exits</span>
00472     <span class="comment">//</span>
00473 ErrorExit2:
00474     <a class="code" href="../../d6/d2/cmsavres_8c.html#a8">CmpDestroyTemporaryHive</a>(TmpCmHive);
00475 ErrorExit1:
00476     <a class="code" href="../../d1/d2/cmp_8h.html#a57">DCmCheckRegistry</a>(CONTAINING_RECORD(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>));
00477     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00478 
00479     <span class="keywordflow">return</span> status;
00480 }
00481 
00482 
00483 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00484"></a><a class="code" href="../../d6/d2/cmsavres_8c.html#a9">00484</a> <a class="code" href="../../d6/d2/cmsavres_8c.html#a9">CmpLoadHiveVolatile</a>(
00485     IN <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> KeyControlBlock,
00486     IN HANDLE FileHandle
00487     )
00488 
00489 <span class="comment">/*++</span>
00490 <span class="comment"></span>
00491 <span class="comment">Routine Description:</span>
00492 <span class="comment"></span>
00493 <span class="comment">    Creates a VOLATILE hive and loads it underneath the given Hive and Cell.</span>
00494 <span class="comment">    The data for the volatile hive is copied out of the given file.  The</span>
00495 <span class="comment">    file is *NOT* in use by the registry when this returns.</span>
00496 <span class="comment"></span>
00497 <span class="comment">Arguments:</span>
00498 <span class="comment"></span>
00499 <span class="comment">    Hive - Supplies the hive that the new hive is to be created under.</span>
00500 <span class="comment">           Currently this must be the Master Hive.</span>
00501 <span class="comment"></span>
00502 <span class="comment">    Cell - Supplies the HCELL_INDEX of the new hive's parent.  (Usually</span>
00503 <span class="comment">           will by \Registry\User)</span>
00504 <span class="comment"></span>
00505 <span class="comment">    FileHandle - Supplies a handle to the hive file that will be copied</span>
00506 <span class="comment">           into the volatile hive.</span>
00507 <span class="comment"></span>
00508 <span class="comment">Return Value:</span>
00509 <span class="comment"></span>
00510 <span class="comment">    NTSTATUS</span>
00511 <span class="comment"></span>
00512 <span class="comment">--*/</span>
00513 
00514 {
00515     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00516     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
00517     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> RootData;
00518     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> NewHive;
00519     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> TempHive;
00520     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>;
00521     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> Root;
00522     <a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html">REGISTRY_COMMAND</a> Command;
00523     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00524     UNICODE_STRING RootName;
00525     UNICODE_STRING <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>;
00526     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> NewNameLength;
00527     PUNICODE_STRING ConstructedName;
00528 
00529     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00530     <a class="code" href="../../d0/d3/cmsubs3_8c.html#a4">CmpLockRegistryExclusive</a>();
00531 
00532     <span class="keywordflow">if</span> (KeyControlBlock-&gt;Delete) {
00533         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00534         <span class="keywordflow">return</span>(STATUS_KEY_DELETED);
00535     }
00536     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> = KeyControlBlock-&gt;KeyHive;
00537     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> = KeyControlBlock-&gt;KeyCell;
00538 
00539     <span class="comment">//</span>
00540     <span class="comment">// New hives can be created only under the master hive.</span>
00541     <span class="comment">//</span>
00542 
00543     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> != &amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a2">CmpMasterHive</a>-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>) {
00544         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00545         <span class="keywordflow">return</span>(STATUS_INVALID_PARAMETER);
00546     }
00547 
00548     <span class="comment">//</span>
00549     <span class="comment">// Create a temporary hive and load the file into it</span>
00550     <span class="comment">//</span>
00551     status = <a class="code" href="../../d1/d2/cmp_8h.html#a275">CmpInitializeHive</a>(&amp;TempHive,
00552                            <a class="code" href="../../d6/d0/hive_8h.html#a6">HINIT_FILE</a>,
00553                            0,
00554                            <a class="code" href="../../d0/d1/hivedata_8h.html#a38">HFILE_TYPE_PRIMARY</a>,
00555                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00556                            FileHandle,
00557                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00558                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00559                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00560                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>); 
00561     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00562         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00563         <span class="keywordflow">return</span>(status);
00564     }                           
00565 
00566     <span class="comment">//</span>
00567     <span class="comment">// Create the volatile hive.</span>
00568     <span class="comment">//</span>
00569     status = <a class="code" href="../../d1/d2/cmp_8h.html#a275">CmpInitializeHive</a>(&amp;NewHive,
00570                            <a class="code" href="../../d6/d0/hive_8h.html#a4">HINIT_CREATE</a>,
00571                            <a class="code" href="../../d6/d0/hive_8h.html#a9">HIVE_VOLATILE</a>,
00572                            0,
00573                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00574                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00575                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00576                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00577                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00578                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00579     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00580         <a class="code" href="../../d6/d2/cmsavres_8c.html#a8">CmpDestroyTemporaryHive</a>(TempHive);
00581         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00582         <span class="keywordflow">return</span>(status);
00583     }                           
00584 
00585     <span class="comment">//</span>
00586     <span class="comment">// Create the target root</span>
00587     <span class="comment">//</span>
00588     Root = <a class="code" href="../../d2/d3/cmtrecpy_8c.html#a11">CmpCopyKeyPartial</a>(&amp;TempHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>,
00589                              TempHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>.<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o8">RootCell</a>,
00590                              &amp;NewHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>,
00591                              <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>,
00592                              <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00593     <span class="keywordflow">if</span> (Root == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00594         <a class="code" href="../../d6/d2/cmsavres_8c.html#a8">CmpDestroyTemporaryHive</a>(TempHive);
00595         <a class="code" href="../../d6/d2/cmsavres_8c.html#a8">CmpDestroyTemporaryHive</a>(NewHive);
00596         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00597         <span class="keywordflow">return</span>(STATUS_INSUFFICIENT_RESOURCES);
00598     }
00599     NewHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>.<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o8">RootCell</a> = Root;
00600 
00601     <span class="comment">//</span>
00602     <span class="comment">// Copy the temporary hive into the volatile hive</span>
00603     <span class="comment">//</span>
00604     <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d2/cmp_8h.html#a118">CmpCopyTree</a>(&amp;TempHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>,
00605                     TempHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>.<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o8">RootCell</a>,
00606                     &amp;NewHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>,
00607                     Root))
00608     {
00609         <a class="code" href="../../d6/d2/cmsavres_8c.html#a8">CmpDestroyTemporaryHive</a>(TempHive);
00610         <a class="code" href="../../d6/d2/cmsavres_8c.html#a8">CmpDestroyTemporaryHive</a>(NewHive);
00611         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00612         <span class="keywordflow">return</span>(STATUS_INSUFFICIENT_RESOURCES);
00613     }
00614 
00615     <span class="comment">//</span>
00616     <span class="comment">// The volatile hive now has all the right stuff in all the right places,</span>
00617     <span class="comment">// we just need to link it into the master hive.</span>
00618     <span class="comment">//</span>
00619     RootData = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(&amp;NewHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>,Root);
00620     ConstructedName = <a class="code" href="../../d8/d2/cmsubs_8c.html#a18">CmpConstructName</a>(KeyControlBlock);
00621     
00622     NewNameLength = ConstructedName-&gt;Length +
00623                 <a class="code" href="../../d1/d2/cmp_8h.html#a96">CmpHKeyNameLen</a>(&amp;RootData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>) +
00624                 <span class="keyword">sizeof</span>(WCHAR);
00625     <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.Buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, NewNameLength);
00626     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00627         <a class="code" href="../../d6/d2/cmsavres_8c.html#a8">CmpDestroyTemporaryHive</a>(TempHive);
00628         <a class="code" href="../../d6/d2/cmsavres_8c.html#a8">CmpDestroyTemporaryHive</a>(NewHive);
00629         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00630         <a class="code" href="../../d5/d8/ex_8h.html#a7">ExFreePoolWithTag</a>(ConstructedName, CM_NAME_TAG | <a class="code" href="../../d5/d8/ex_8h.html#a6">PROTECTED_POOL</a>);
00631         <span class="keywordflow">return</span>(STATUS_INSUFFICIENT_RESOURCES);
00632     }
00633     <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.Length = <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.MaximumLength = NewNameLength;
00634     <a class="code" href="../../d6/d6/nls_8c.html#a44">RtlCopyUnicodeString</a>(&amp;<a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>, ConstructedName);
00635     <a class="code" href="../../d5/d8/ex_8h.html#a7">ExFreePoolWithTag</a>(ConstructedName, CM_NAME_TAG | <a class="code" href="../../d5/d8/ex_8h.html#a6">PROTECTED_POOL</a>);
00636     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;<a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\"</span>);
00637 
00638     <span class="keywordflow">if</span> (RootData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a32">KEY_COMP_NAME</a>) {
00639         <a class="code" href="../../d1/d2/cmp_8h.html#a318">CmpCopyCompressedName</a>(<a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.Buffer + (<a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.Length / <span class="keyword">sizeof</span>(WCHAR)),
00640                               <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.MaximumLength - <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.Length,
00641                               RootData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>,
00642                               <a class="code" href="../../d1/d2/cmp_8h.html#a96">CmpHKeyNameLen</a>(&amp;RootData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>));
00643         <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.Length += <a class="code" href="../../d1/d2/cmp_8h.html#a96">CmpHKeyNameLen</a>(&amp;RootData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>);
00644     } <span class="keywordflow">else</span> {
00645         RootName.Buffer = RootData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>;
00646         RootName.Length = RootName.MaximumLength = RootData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>;
00647 
00648         <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>(&amp;<a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>,&amp;RootName);
00649     }
00650 
00651     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d3/cmwraper_8c.html#a28">CmpLinkHiveToMaster</a>(&amp;<a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>,
00652                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00653                                  NewHive,
00654                                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00655                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00656     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00657         Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o7">CmHive</a> = NewHive;
00658         Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o0">Command</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a108">REG_CMD_ADD_HIVE_LIST</a>;
00659         <a class="code" href="../../d5/d3/cmworker_8c.html#a20">CmpWorker</a>(&amp;Command);
00660     } <span class="keywordflow">else</span> {
00661         <a class="code" href="../../d6/d2/cmsavres_8c.html#a8">CmpDestroyTemporaryHive</a>(NewHive);
00662     }
00663     <a class="code" href="../../d6/d2/cmsavres_8c.html#a8">CmpDestroyTemporaryHive</a>(TempHive);
00664 
00665     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.Buffer);
00666 
00667     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00668         <span class="comment">//</span>
00669         <span class="comment">// We've given user chance to log on, so turn on quota</span>
00670         <span class="comment">//</span>
00671         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d9/cmapi_8c.html#a2">CmpProfileLoaded</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00672             <a class="code" href="../../d8/d9/cmapi_8c.html#a2">CmpProfileLoaded</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00673             <a class="code" href="../../d1/d2/cmp_8h.html#a249">CmpSetGlobalQuotaAllowed</a>();
00674         }
00675     }
00676 
00677     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00678     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00679 }
00680 
00681 
00682 
00683 ULONG
<a name="l00684"></a><a class="code" href="../../d6/d2/cmsavres_8c.html#a12">00684</a> <a class="code" href="../../d6/d2/cmsavres_8c.html#a12">CmpRefreshWorkerRoutine</a>(
00685     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> Current,
00686     PVOID                 Context1,
00687     PVOID                 Context2
00688     )
00689 <span class="comment">/*++</span>
00690 <span class="comment"></span>
00691 <span class="comment">Routine Description:</span>
00692 <span class="comment"></span>
00693 <span class="comment">    Helper used by CmpRefreshHive when calling</span>
00694 <span class="comment">    CmpSearchKeyControlBlockTree.</span>
00695 <span class="comment"></span>
00696 <span class="comment">    If a match is found, the KCB is deleted and restart is returned.</span>
00697 <span class="comment">    Else, continue is returned.</span>
00698 <span class="comment"></span>
00699 <span class="comment">Arguments:</span>
00700 <span class="comment"></span>
00701 <span class="comment">    Current - the kcb to examine</span>
00702 <span class="comment"></span>
00703 <span class="comment">    Context1 - the hive to match against</span>
00704 <span class="comment"></span>
00705 <span class="comment">    Context2 - nothing</span>
00706 <span class="comment"></span>
00707 <span class="comment">Return Value:</span>
00708 <span class="comment"></span>
00709 <span class="comment">    if no match, return continue.</span>
00710 <span class="comment"></span>
00711 <span class="comment">    if match, return restart.</span>
00712 <span class="comment"></span>
00713 <span class="comment">--*/</span>
00714 {
00715     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00716     <span class="keywordflow">if</span> (Current-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o5">KeyHive</a> == (<a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>)<a class="code" href="../../d3/d1/threads_8h.html#a107">Context1</a>) {
00717 
00718         <span class="comment">//</span>
00719         <span class="comment">// match.  set deleted flag.  continue search.</span>
00720         <span class="comment">//</span>
00721         Current-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o0">Delete</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00722         Current-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o5">KeyHive</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00723         Current-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o6">KeyCell</a> = 0;
00724         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d2/cmp_8h.html#a116">KCB_WORKER_DELETE</a>);
00725     }
00726     <span class="keywordflow">return</span> <a class="code" href="../../d1/d2/cmp_8h.html#a114">KCB_WORKER_CONTINUE</a>;
00727 }
00728 
00729 
00730 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00731"></a><a class="code" href="../../d6/d2/cmsavres_8c.html#a10">00731</a> <a class="code" href="../../d6/d2/cmsavres_8c.html#a10">CmpRefreshHive</a>(
00732     IN <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> KeyControlBlock
00733     )
00734 <span class="comment">/*++</span>
00735 <span class="comment"></span>
00736 <span class="comment">Routine Description:</span>
00737 <span class="comment"></span>
00738 <span class="comment">    Backs out all changes to a hives since it was last flushed.</span>
00739 <span class="comment">    Used as a transaction abort by the security system.</span>
00740 <span class="comment"></span>
00741 <span class="comment">    Caller must have SeTcbPrivilege.</span>
00742 <span class="comment"></span>
00743 <span class="comment">    The target hive must have HIVE_NOLAZYFLUSH set.</span>
00744 <span class="comment"></span>
00745 <span class="comment">    KeyControlBlock must refer to the root of the hive (HIVE_ENTRY must</span>
00746 <span class="comment">    be set in the key.)</span>
00747 <span class="comment"></span>
00748 <span class="comment">    Any kcbs that point into this hive (and thus any handles open</span>
00749 <span class="comment">    against it) will be force to DELETED state.  (If we do any work.)</span>
00750 <span class="comment"></span>
00751 <span class="comment">    All notifies pending against the hive will be flushed.</span>
00752 <span class="comment"></span>
00753 <span class="comment">    When we're done, only the tombstone kcbs, handles, and attached</span>
00754 <span class="comment">    notify blocks will be left.</span>
00755 <span class="comment"></span>
00756 <span class="comment">    WARNNOTE:   Once reads have begun, if the operation fails, the hive</span>
00757 <span class="comment">                will be corrupt, so we will bugcheck.</span>
00758 <span class="comment"></span>
00759 <span class="comment">Arguments:</span>
00760 <span class="comment"></span>
00761 <span class="comment">    KeyControlBlock - provides a reference to the root of the hive</span>
00762 <span class="comment">                      we wish to refresh.</span>
00763 <span class="comment"></span>
00764 <span class="comment">Return Value:</span>
00765 <span class="comment"></span>
00766 <span class="comment">    NTSTATUS</span>
00767 <span class="comment"></span>
00768 <span class="comment">--*/</span>
00769 {
00770     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>              <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
00771     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>         <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>;
00772     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a>          pcell;
00773     <a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html">REGISTRY_COMMAND</a>    <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>;
00774     PLIST_ENTRY         ptr;
00775     <a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html">PCM_NOTIFY_BLOCK</a>    node;
00776 
00777     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00778     <span class="comment">//</span>
00779     <span class="comment">// Check to see if the caller has the privilege to make this call.</span>
00780     <span class="comment">//</span>
00781     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d4/privileg_8c.html#a3">SeSinglePrivilegeCheck</a>(<a class="code" href="../../d0/d5/se_8h.html#a84">SeTcbPrivilege</a>, KeGetPreviousMode())) {
00782         <span class="keywordflow">return</span> STATUS_PRIVILEGE_NOT_HELD;
00783     }
00784 
00785     <span class="keywordflow">if</span> (KeyControlBlock-&gt;Delete) {
00786         <span class="keywordflow">return</span>(STATUS_KEY_DELETED);
00787     }
00788     <a class="code" href="../../d0/d3/cmsubs3_8c.html#a4">CmpLockRegistryExclusive</a>();
00789     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> = KeyControlBlock-&gt;KeyHive;
00790     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> = KeyControlBlock-&gt;KeyCell;
00791 
00792     <span class="comment">//</span>
00793     <span class="comment">// check to see if hive is of proper type</span>
00794     <span class="comment">//</span>
00795     <span class="keywordflow">if</span> ( ! (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o17">HiveFlags</a> &amp; <a class="code" href="../../d6/d0/hive_8h.html#a10">HIVE_NOLAZYFLUSH</a>)) {
00796         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00797         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00798     }
00799 
00800     <span class="comment">//</span>
00801     <span class="comment">// punt if any volatile storage has been allocated</span>
00802     <span class="comment">//</span>
00803     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>].Length != 0) {
00804         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00805         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
00806     }
00807 
00808     <span class="comment">//</span>
00809     <span class="comment">// check to see if call was applied to the root of the hive</span>
00810     <span class="comment">//</span>
00811     pcell = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>);
00812     <span class="keywordflow">if</span> ( ! (pcell-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a29">KEY_HIVE_ENTRY</a>)) {
00813         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00814         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00815     }
00816 
00817     <span class="comment">//</span>
00818     <span class="comment">// Flush all NotifyBlocks attached to this hive</span>
00819     <span class="comment">//</span>
00820     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00821 
00822         <span class="comment">//</span>
00823         <span class="comment">// flush below will edit list, so restart at beginning each time</span>
00824         <span class="comment">//</span>
00825         ptr = &amp;(((<a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>)<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>)-&gt;NotifyList);
00826         <span class="keywordflow">if</span> (ptr-&gt;Flink == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00827             <span class="keywordflow">break</span>;
00828         }
00829 
00830         ptr = ptr-&gt;Flink;
00831         node = CONTAINING_RECORD(ptr, <a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html">CM_NOTIFY_BLOCK</a>, <a class="code" href="../../d4/d6/regext_8c.html#a0">HiveList</a>);
00832         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((node-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o2">KeyBody</a>)-&gt;NotifyBlock == node);
00833         <a class="code" href="../../d1/d2/cmp_8h.html#a288">CmpFlushNotify</a>(node-&gt;<a class="code" href="../../d2/d6/struct__CM__NOTIFY__BLOCK.html#o2">KeyBody</a>);
00834     }
00835 
00836     <span class="comment">//</span>
00837     <span class="comment">// Force all kcbs that refer to this hive to the deleted state.</span>
00838     <span class="comment">//</span>
00839     <a class="code" href="../../d8/d2/cmsubs_8c.html#a21">CmpSearchKeyControlBlockTree</a>(
00840         <a class="code" href="../../d6/d2/cmsavres_8c.html#a12">CmpRefreshWorkerRoutine</a>,
00841         (PVOID)<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00842         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00843         );
00844 
00845     <span class="comment">//</span>
00846     <span class="comment">// We cannot do the relevent I/O from this context, so send a</span>
00847     <span class="comment">// command to the worker code.</span>
00848     <span class="comment">//</span>
00849     <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o0">Command</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a110">REG_CMD_REFRESH_HIVE</a>;
00850     <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o1">Hive</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
00851     <a class="code" href="../../d5/d3/cmworker_8c.html#a20">CmpWorker</a>(&amp;<a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>);
00852     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00853     <span class="comment">//</span>
00854     <span class="comment">// we're back (rather than bugchecked) so it worked</span>
00855     <span class="comment">//</span>
00856     <span class="keywordflow">return</span> STATUS_SUCCESS;
00857 }
00858 
00859 
00860 
00861 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00862"></a><a class="code" href="../../d6/d2/cmsavres_8c.html#a15">00862</a> <a class="code" href="../../d6/d2/cmsavres_8c.html#a15">CmSaveKey</a>(
00863     IN <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>    KeyControlBlock,
00864     IN HANDLE   FileHandle
00865     )
00866 <span class="comment">/*++</span>
00867 <span class="comment"></span>
00868 <span class="comment">Routine Description:</span>
00869 <span class="comment"></span>
00870 <span class="comment">Arguments:</span>
00871 <span class="comment"></span>
00872 <span class="comment">    KeyControlBlock - pointer to the KCB that describes the key</span>
00873 <span class="comment"></span>
00874 <span class="comment">    FileHandle - handle of the file to dump to.</span>
00875 <span class="comment"></span>
00876 <span class="comment">Return Value:</span>
00877 <span class="comment"></span>
00878 <span class="comment">    NTSTATUS - Result code from call, among the following:</span>
00879 <span class="comment"></span>
00880 <span class="comment">        &lt;TBS&gt;</span>
00881 <span class="comment"></span>
00882 <span class="comment">--*/</span>
00883 {
00884     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
00885     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a>  proot;
00886     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>      flags;
00887     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>     TmpCmHive;
00888     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>     CmHive;
00889     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> newroot;
00890     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
00891     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>;
00892     ULONG OldQuotaAllowed;
00893     ULONG OldQuotaWarning;
00894 <span class="preprocessor">#if DBG</span>
00895 <span class="preprocessor"></span>    ULONG OldQuotaUsed;
00896 <span class="preprocessor">#endif</span>
00897 <span class="preprocessor"></span>
00898     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00899     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a32">CMS_SAVRES</a>) {
00900         KdPrint((<span class="stringliteral">"CmSaveKey:\n"</span>));
00901         KdPrint((<span class="stringliteral">"\tKCB=%08lx"</span>,KeyControlBlock));
00902         KdPrint((<span class="stringliteral">"\tFileHandle=%08lx\n"</span>,FileHandle));
00903     }
00904 
00905     <span class="comment">//</span>
00906     <span class="comment">// Disallow attempts to "save" the master hive</span>
00907     <span class="comment">//</span>
00908     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> = KeyControlBlock-&gt;KeyHive;
00909     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> = KeyControlBlock-&gt;KeyCell;
00910 
00911     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> == &amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a2">CmpMasterHive</a>-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>) {
00912         <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
00913     }
00914 
00915     <a class="code" href="../../d0/d3/cmsubs3_8c.html#a4">CmpLockRegistryExclusive</a>();
00916 
00917     <span class="keywordflow">if</span> (KeyControlBlock-&gt;Delete) {
00918         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00919         <span class="keywordflow">return</span> STATUS_KEY_DELETED;
00920     }
00921 
00922     <a class="code" href="../../d1/d2/cmp_8h.html#a57">DCmCheckRegistry</a>(CONTAINING_RECORD(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>));
00923 
00924     <span class="keywordflow">if</span> ( (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o17">HiveFlags</a> &amp; <a class="code" href="../../d6/d0/hive_8h.html#a10">HIVE_NOLAZYFLUSH</a>) &amp;&amp;
00925          (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> != 0))
00926     {
00927         <span class="comment">//</span>
00928         <span class="comment">// It's a NOLAZY hive, and there's some dirty data, so writing</span>
00929         <span class="comment">// out a snapshot of what's in memory will not give the caller</span>
00930         <span class="comment">// consistent user data.  Therefore, copy the on disk image</span>
00931         <span class="comment">// instead of the memory image</span>
00932         <span class="comment">//</span>
00933 
00934         <span class="comment">//</span>
00935         <span class="comment">// Note that this will generate weird results if the key</span>
00936         <span class="comment">// being saved is not the root of the hive, since the</span>
00937         <span class="comment">// resulting file will always be a copy of the entire hive, not</span>
00938         <span class="comment">// just the subtree they asked for.</span>
00939         <span class="comment">//</span>
00940         status = <a class="code" href="../../d6/d2/cmsavres_8c.html#a11">CmpSaveKeyByFileCopy</a>((<a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>)<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, FileHandle);
00941         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00942         <span class="keywordflow">return</span> status;
00943     }
00944 
00945     proot = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>);
00946     flags = proot-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a>;
00947 
00948 
00949     <span class="comment">//</span>
00950     <span class="comment">// Always try to copy the hive and write it out.  This has the</span>
00951     <span class="comment">// effect of compressing out unused free storage.</span>
00952     <span class="comment">// If there isn't space, and the savekey is of the root of the</span>
00953     <span class="comment">// hive, then just write it out directly.  (i.e. don't fail on</span>
00954     <span class="comment">// a whole hive restore just because we're out of memory.)</span>
00955     <span class="comment">//</span>
00956     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a24">CML_FLOW</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a32">CMS_SAVRES</a>) KdPrint((<span class="stringliteral">"\tSave of partial hive\n"</span>));
00957 
00958     <span class="comment">//</span>
00959     <span class="comment">// The subtree the caller wants does not exactly match a</span>
00960     <span class="comment">// subtree.  Make a temporary hive, tree copy the source</span>
00961     <span class="comment">// to temp, write out the temporary, free the temporary.</span>
00962     <span class="comment">//</span>
00963 
00964     <span class="comment">//</span>
00965     <span class="comment">// temporarily disable registry quota as we will be giving this memory back immediately!</span>
00966     <span class="comment">//</span>
00967     OldQuotaAllowed = <a class="code" href="../../d8/d9/cmapi_8c.html#a7">CmpGlobalQuotaAllowed</a>;
00968     OldQuotaWarning = <a class="code" href="../../d8/d9/cmapi_8c.html#a8">CmpGlobalQuotaWarning</a>;
00969     <a class="code" href="../../d8/d9/cmapi_8c.html#a7">CmpGlobalQuotaAllowed</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a69">CM_WRAP_LIMIT</a>;
00970     <a class="code" href="../../d8/d9/cmapi_8c.html#a8">CmpGlobalQuotaWarning</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a69">CM_WRAP_LIMIT</a>;
00971 
00972 <span class="preprocessor">#if DBG</span>
00973 <span class="preprocessor"></span>    OldQuotaUsed = <a class="code" href="../../d7/d0/cmdat2_8c.html#a9">CmpGlobalQuotaUsed</a>;
00974 <span class="preprocessor">#endif</span>
00975 <span class="preprocessor"></span>
00976     <span class="comment">//</span>
00977     <span class="comment">// Create the temporary hive</span>
00978     <span class="comment">//</span>
00979 
00980     TmpCmHive = <a class="code" href="../../d6/d2/cmsavres_8c.html#a7">CmpCreateTemporaryHive</a>(FileHandle);
00981     <span class="keywordflow">if</span> (TmpCmHive == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00982         status =  STATUS_INSUFFICIENT_RESOURCES;
00983         <span class="keywordflow">goto</span> ErrorInsufficientResources;
00984     }
00985 
00986     <span class="comment">//</span>
00987     <span class="comment">// Create a root cell, mark it as such</span>
00988     <span class="comment">//</span>
00989 
00990     newroot = <a class="code" href="../../d2/d3/cmtrecpy_8c.html#a11">CmpCopyKeyPartial</a>(
00991                 <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00992                 <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>,
00993                 &amp;(TmpCmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>),
00994                 <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>,          <span class="comment">// will force KEY_HIVE_ENTRY set</span>
00995                 <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00996     <span class="keywordflow">if</span> (newroot == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00997         status = STATUS_INSUFFICIENT_RESOURCES;
00998         <span class="keywordflow">goto</span> ErrorInsufficientResources;
00999     }
01000     TmpCmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>.<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o8">RootCell</a> = newroot;
01001 
01002     <span class="comment">//</span>
01003     <span class="comment">// Do a tree copy</span>
01004     <span class="comment">//</span>
01005     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d2/cmp_8h.html#a118">CmpCopyTree</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>, &amp;(TmpCmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>), newroot) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01006         status = STATUS_INSUFFICIENT_RESOURCES;
01007         <span class="keywordflow">goto</span> ErrorInsufficientResources;
01008     }
01009 
01010     <span class="comment">//</span>
01011     <span class="comment">// Write the file</span>
01012     <span class="comment">//</span>
01013     TmpCmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o1">FileHandles</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a41">HFILE_TYPE_EXTERNAL</a>] = FileHandle;
01014     status = <a class="code" href="../../d0/d2/hivesync_8c.html#a15">HvWriteHive</a>(&amp;(TmpCmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>));
01015     TmpCmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o1">FileHandles</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a41">HFILE_TYPE_EXTERNAL</a>] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01016 
01017     <span class="comment">//</span>
01018     <span class="comment">// Error exits</span>
01019     <span class="comment">//</span>
01020 ErrorInsufficientResources:
01021 
01022     <span class="comment">//</span>
01023     <span class="comment">// Free the temporary hive</span>
01024     <span class="comment">//</span>
01025     <span class="keywordflow">if</span> (TmpCmHive != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01026         <a class="code" href="../../d6/d2/cmsavres_8c.html#a8">CmpDestroyTemporaryHive</a>(TmpCmHive);
01027     }
01028 
01029 <span class="preprocessor">#if DBG</span>
01030 <span class="preprocessor"></span>    <span class="comment">//</span>
01031     <span class="comment">// Sanity check: when this assert fires, we have leaks in the copy routine.</span>
01032     <span class="comment">//</span>
01033     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( OldQuotaUsed == <a class="code" href="../../d7/d0/cmdat2_8c.html#a9">CmpGlobalQuotaUsed</a> );
01034 <span class="preprocessor">#endif</span>
01035 <span class="preprocessor"></span>
01036     <span class="comment">//</span>
01037     <span class="comment">// Set global quota back to what it was.</span>
01038     <span class="comment">//</span>
01039     <a class="code" href="../../d8/d9/cmapi_8c.html#a7">CmpGlobalQuotaAllowed</a> = OldQuotaAllowed;
01040     <a class="code" href="../../d8/d9/cmapi_8c.html#a8">CmpGlobalQuotaWarning</a> = OldQuotaWarning;
01041     <a class="code" href="../../d1/d2/cmp_8h.html#a57">DCmCheckRegistry</a>(CONTAINING_RECORD(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>));
01042     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
01043     <span class="keywordflow">return</span> status;
01044 }
01045 
01046 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01047"></a><a class="code" href="../../d6/d2/cmsavres_8c.html#a16">01047</a> <a class="code" href="../../d6/d2/cmsavres_8c.html#a16">CmSaveMergedKeys</a>(
01048     IN <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>    HighPrecedenceKcb,
01049     IN <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>    LowPrecedenceKcb,
01050     IN HANDLE   FileHandle
01051     )
01052 <span class="comment">/*++</span>
01053 <span class="comment"></span>
01054 <span class="comment">Routine Description:</span>
01055 <span class="comment"></span>
01056 <span class="comment">Arguments:</span>
01057 <span class="comment"></span>
01058 <span class="comment">    HighPrecedenceKcb - pointer to the KCB that describes the High precedence key </span>
01059 <span class="comment">                        (the one that wins in a duplicate key case)</span>
01060 <span class="comment"></span>
01061 <span class="comment">    LowPrecedenceKcb - pointer to the KCB that describes the Low precedence key </span>
01062 <span class="comment">                        (the one that gets overwritten in a duplicate key case)</span>
01063 <span class="comment"></span>
01064 <span class="comment">    FileHandle - handle of the file to dump to.</span>
01065 <span class="comment"></span>
01066 <span class="comment">Return Value:</span>
01067 <span class="comment"></span>
01068 <span class="comment">    NTSTATUS - Result code from call, among the following:</span>
01069 <span class="comment"></span>
01070 <span class="comment">        &lt;TBS&gt;</span>
01071 <span class="comment"></span>
01072 <span class="comment">--*/</span>
01073 {
01074     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
01075     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a>  proot;
01076     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>      flags;
01077     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>     TmpCmHive;
01078     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> newroot;
01079     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> HighHive;
01080     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> LowHive;
01081     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> HighCell;
01082     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> LowCell;
01083     ULONG OldQuotaAllowed;
01084     ULONG OldQuotaWarning;
01085     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> HighNode,LowNode;
01086 <span class="preprocessor">#if DBG</span>
01087 <span class="preprocessor"></span>    ULONG OldQuotaUsed;
01088 <span class="preprocessor">#endif</span>
01089 <span class="preprocessor"></span>
01090     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01091     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a32">CMS_SAVRES</a>) {
01092         KdPrint((<span class="stringliteral">"CmSaveMergedKeys:\n"</span>));
01093         KdPrint((<span class="stringliteral">"\tHighKCB=%08lx"</span>,HighPrecedenceKcb));
01094         KdPrint((<span class="stringliteral">"\tLowKCB=%08lx"</span>,LowPrecedenceKcb));
01095         KdPrint((<span class="stringliteral">"\tFileHandle=%08lx\n"</span>,FileHandle));
01096     }
01097 
01098     <span class="comment">//</span>
01099     <span class="comment">// Disallow attempts to "merge" keys located in the same hive</span>
01100     <span class="comment">// A brutal way to avoid recursivity</span>
01101     <span class="comment">//</span>
01102     HighHive = HighPrecedenceKcb-&gt;KeyHive;
01103     HighCell = HighPrecedenceKcb-&gt;KeyCell;
01104     LowHive = LowPrecedenceKcb-&gt;KeyHive;
01105     LowCell = LowPrecedenceKcb-&gt;KeyCell;
01106 
01107     <span class="keywordflow">if</span> (LowHive  == HighHive ) {
01108         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01109     }
01110 
01111     <a class="code" href="../../d0/d3/cmsubs3_8c.html#a4">CmpLockRegistryExclusive</a>();
01112 
01113     <span class="keywordflow">if</span> (HighPrecedenceKcb-&gt;Delete || LowPrecedenceKcb-&gt;Delete) {
01114         <span class="comment">//</span>
01115         <span class="comment">// Unlock the registry and fail if one of the keys are marked as deleted</span>
01116         <span class="comment">//</span>
01117         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
01118         <span class="keywordflow">return</span> STATUS_KEY_DELETED;
01119     }
01120 
01121     <a class="code" href="../../d1/d2/cmp_8h.html#a57">DCmCheckRegistry</a>(CONTAINING_RECORD(HighHive, <a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>));
01122     <a class="code" href="../../d1/d2/cmp_8h.html#a57">DCmCheckRegistry</a>(CONTAINING_RECORD(LowHive, <a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>));
01123 
01124 
01125     <span class="keywordflow">if</span>( ((HighHive-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o17">HiveFlags</a> &amp; <a class="code" href="../../d6/d0/hive_8h.html#a10">HIVE_NOLAZYFLUSH</a>) &amp;&amp; (HighHive-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> != 0)) ||
01126         ((LowHive-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o17">HiveFlags</a> &amp; <a class="code" href="../../d6/d0/hive_8h.html#a10">HIVE_NOLAZYFLUSH</a>) &amp;&amp; (LowHive-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> != 0)) ) {
01127         <span class="comment">//</span>
01128         <span class="comment">// Reject the call when one of the hives is a NOLAZY hive and there's</span>
01129         <span class="comment">// some dirty data. Another alternative will be to save only one of the </span>
01130         <span class="comment">// trees (if a valid one exists) or an entire hive (see CmSaveKey)</span>
01131         <span class="comment">//</span>
01132         status =  STATUS_INVALID_PARAMETER;
01133         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
01134         <span class="keywordflow">return</span> status;
01135     }
01136 
01137     proot = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(LowHive, LowCell);
01138     flags = proot-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a>;
01139 
01140 
01141     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a24">CML_FLOW</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a32">CMS_SAVRES</a>) KdPrint((<span class="stringliteral">"\tCopy of partial HighHive\n"</span>));
01142 
01143     <span class="comment">//</span>
01144     <span class="comment">// Make a temporary hive, tree copy the key subtree from</span>
01145     <span class="comment">// HighHive hive to temp, tree-merge with the key subtree from</span>
01146     <span class="comment">// LowHive hive, write out the temporary, free the temporary.</span>
01147     <span class="comment">// Always write the HighHive subtree first, so its afterwise</span>
01148     <span class="comment">// only add new keys/values</span>
01149     <span class="comment">// </span>
01150 
01151     <span class="comment">//</span>
01152     <span class="comment">// temporarily disable registry quota as we will be giving this memory back immediately!</span>
01153     <span class="comment">//</span>
01154     OldQuotaAllowed = <a class="code" href="../../d8/d9/cmapi_8c.html#a7">CmpGlobalQuotaAllowed</a>;
01155     OldQuotaWarning = <a class="code" href="../../d8/d9/cmapi_8c.html#a8">CmpGlobalQuotaWarning</a>;
01156     <a class="code" href="../../d8/d9/cmapi_8c.html#a7">CmpGlobalQuotaAllowed</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a69">CM_WRAP_LIMIT</a>;
01157     <a class="code" href="../../d8/d9/cmapi_8c.html#a8">CmpGlobalQuotaWarning</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a69">CM_WRAP_LIMIT</a>;
01158 
01159 <span class="preprocessor">#if DBG</span>
01160 <span class="preprocessor"></span>    OldQuotaUsed = <a class="code" href="../../d7/d0/cmdat2_8c.html#a9">CmpGlobalQuotaUsed</a>;
01161 <span class="preprocessor">#endif</span>
01162 <span class="preprocessor"></span>
01163     <span class="comment">//</span>
01164     <span class="comment">// Create the temporary hive</span>
01165     <span class="comment">//</span>
01166 
01167     TmpCmHive = <a class="code" href="../../d6/d2/cmsavres_8c.html#a7">CmpCreateTemporaryHive</a>(FileHandle);
01168     <span class="keywordflow">if</span> (TmpCmHive == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01169         status =  STATUS_INSUFFICIENT_RESOURCES;
01170         <span class="keywordflow">goto</span> ErrorInsufficientResources;
01171     }
01172 
01173     <span class="comment">//</span>
01174     <span class="comment">// Create a root cell, mark it as such</span>
01175     <span class="comment">//</span>
01176 
01177     newroot = <a class="code" href="../../d2/d3/cmtrecpy_8c.html#a11">CmpCopyKeyPartial</a>(
01178                 HighHive,
01179                 HighCell,
01180                 &amp;(TmpCmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>),
01181                 <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>,          <span class="comment">// will force KEY_HIVE_ENTRY set</span>
01182                 <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01183     <span class="keywordflow">if</span> (newroot == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01184         status = STATUS_INSUFFICIENT_RESOURCES;
01185         <span class="keywordflow">goto</span> ErrorInsufficientResources;
01186     }
01187     TmpCmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>.<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o8">RootCell</a> = newroot;
01188 
01189     <span class="comment">//</span>
01190     <span class="comment">// Do a tree copy. Copy the HighCell tree from HighHive first.</span>
01191     <span class="comment">//</span>
01192     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d2/cmp_8h.html#a118">CmpCopyTree</a>(HighHive, HighCell, &amp;(TmpCmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>), newroot) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01193         status = STATUS_INSUFFICIENT_RESOURCES;
01194         <span class="keywordflow">goto</span> ErrorInsufficientResources;
01195     }
01196 
01197     <span class="comment">//</span>
01198     <span class="comment">// Merge the values in the root node of the merged subtrees</span>
01199     <span class="comment">//</span>
01200     LowNode = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(LowHive, LowCell);                                         
01201     HighNode = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(&amp;(TmpCmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>),newroot);
01202 
01203     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d3/cmtrecpy_8c.html#a6">CmpMergeKeyValues</a>(LowHive, LowCell, LowNode, &amp;(TmpCmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>), newroot, HighNode) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ){
01204         status = STATUS_INSUFFICIENT_RESOURCES;
01205         <span class="keywordflow">goto</span> ErrorInsufficientResources;
01206     }
01207 
01208     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a24">CML_FLOW</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a32">CMS_SAVRES</a>) KdPrint((<span class="stringliteral">"\tMerge partial LowHive over the HighHive\n"</span>));
01209 
01210     <span class="comment">//</span>
01211     <span class="comment">// Merge the two trees. A Merge operation is a sync that obeys</span>
01212     <span class="comment">// the following aditional rules:</span>
01213     <span class="comment">//      1. keys the exist in the taget tree and does not exist</span>
01214     <span class="comment">//      in the source tree remain as they are (don't get deleted)</span>
01215     <span class="comment">//      2. keys the doesn't exist both in the target tree are added</span>
01216     <span class="comment">//      "as they are" from the source tree (always the target tree</span>
01217     <span class="comment">//      has a higher precedence)</span>
01218     <span class="comment">// </span>
01219     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d2/cmp_8h.html#a121">CmpMergeTrees</a>(LowHive, LowCell, &amp;(TmpCmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>), newroot) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01220         status = STATUS_INSUFFICIENT_RESOURCES;
01221         <span class="keywordflow">goto</span> ErrorInsufficientResources;
01222     }
01223     
01224     <span class="comment">//</span>
01225     <span class="comment">// Write the file</span>
01226     <span class="comment">//</span>
01227     TmpCmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o1">FileHandles</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a41">HFILE_TYPE_EXTERNAL</a>] = FileHandle;
01228     status = <a class="code" href="../../d0/d2/hivesync_8c.html#a15">HvWriteHive</a>(&amp;(TmpCmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>));
01229     TmpCmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o1">FileHandles</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a41">HFILE_TYPE_EXTERNAL</a>] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01230 
01231     <span class="comment">//</span>
01232     <span class="comment">// Error exits</span>
01233     <span class="comment">//</span>
01234 ErrorInsufficientResources:
01235     <span class="comment">//</span>
01236     <span class="comment">// Free the temporary hive</span>
01237     <span class="comment">//</span>
01238     <span class="keywordflow">if</span> (TmpCmHive != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01239         <a class="code" href="../../d6/d2/cmsavres_8c.html#a8">CmpDestroyTemporaryHive</a>(TmpCmHive);
01240     }
01241 
01242 <span class="preprocessor">#if DBG</span>
01243 <span class="preprocessor"></span>    <span class="comment">//</span>
01244     <span class="comment">// Sanity check: when this assert fires, we have leaks in the merge routine.</span>
01245     <span class="comment">//</span>
01246     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( OldQuotaUsed == <a class="code" href="../../d7/d0/cmdat2_8c.html#a9">CmpGlobalQuotaUsed</a> );
01247 <span class="preprocessor">#endif</span>
01248 <span class="preprocessor"></span>    <span class="comment">//</span>
01249     <span class="comment">// Set global quota back to what it was.</span>
01250     <span class="comment">//</span>
01251     <a class="code" href="../../d8/d9/cmapi_8c.html#a7">CmpGlobalQuotaAllowed</a> = OldQuotaAllowed;
01252     <a class="code" href="../../d8/d9/cmapi_8c.html#a8">CmpGlobalQuotaWarning</a> = OldQuotaWarning;
01253     <a class="code" href="../../d1/d2/cmp_8h.html#a57">DCmCheckRegistry</a>(CONTAINING_RECORD(HighHive, <a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>));
01254     <a class="code" href="../../d1/d2/cmp_8h.html#a57">DCmCheckRegistry</a>(CONTAINING_RECORD(LowHive, <a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>));
01255     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
01256     <span class="keywordflow">return</span> status;
01257 }
01258 
01259 
01260 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01261"></a><a class="code" href="../../d6/d2/cmsavres_8c.html#a11">01261</a> <a class="code" href="../../d6/d2/cmsavres_8c.html#a11">CmpSaveKeyByFileCopy</a>(
01262     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>  CmHive,
01263     HANDLE  FileHandle
01264     )
01265 <span class="comment">/*++</span>
01266 <span class="comment"></span>
01267 <span class="comment">Routine Description:</span>
01268 <span class="comment"></span>
01269 <span class="comment">    Do special case of SaveKey by copying the hive file</span>
01270 <span class="comment"></span>
01271 <span class="comment">Arguments:</span>
01272 <span class="comment"></span>
01273 <span class="comment">    CmHive - supplies a pointer to an HHive</span>
01274 <span class="comment"></span>
01275 <span class="comment">    FileHandle - open handle to target file</span>
01276 <span class="comment"></span>
01277 <span class="comment">Return Value:</span>
01278 <span class="comment"></span>
01279 <span class="comment">    NTSTATUS - Result code from call, among the following:</span>
01280 <span class="comment"></span>
01281 <span class="comment">--*/</span>
01282 {
01283     <a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>    BaseBlock;
01284     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>        status;
01285     ULONG           <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
01286     ULONG           Length;
01287     ULONG           Position;
01288     <a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html">REGISTRY_COMMAND</a>   <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>;
01289     PUCHAR          CopyBuffer;
01290     ULONG           BufferLength;
01291     ULONG           BytesToCopy;
01292     <a class="code" href="../../d5/d4/structCMP__OFFSET__ARRAY.html">CMP_OFFSET_ARRAY</a> offsetElement;
01293 
01294     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01295 
01296     <span class="comment">//</span>
01297     <span class="comment">// Attempt to allocate large buffer for copying stuff around.  If</span>
01298     <span class="comment">// we can't get one, just use the stash buffer.</span>
01299     <span class="comment">//</span>
01300     BufferLength = <a class="code" href="../../d6/d2/cmsavres_8c.html#a0">CM_SAVEKEYBUFSIZE</a>;
01301     <span class="keywordflow">try</span> {
01302         CopyBuffer = <a class="code" href="../../d5/d5/cc_8h.html#a11">ExAllocatePoolWithQuota</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a178">PagedPoolCacheAligned</a>,
01303                                              BufferLength);
01304     } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
01305         CopyBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01306     }
01307     <a class="code" href="../../d0/d3/cmsubs3_8c.html#a4">CmpLockRegistryExclusive</a>();
01308     <span class="keywordflow">if</span> (CopyBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01309         CopyBuffer = <a class="code" href="../../d8/d9/cmapi_8c.html#a4">CmpStashBuffer</a>;
01310         BufferLength = <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
01311     }
01312     <span class="comment">//</span>
01313     <span class="comment">// Read the base block, step the sequence number, and write it out</span>
01314     <span class="comment">//</span>
01315     status = STATUS_REGISTRY_IO_FAILED;
01316 
01317     CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o1">FileHandles</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a41">HFILE_TYPE_EXTERNAL</a>] = FileHandle;
01318 
01319     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = 0;
01320     <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o0">Command</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a111">REG_CMD_HIVE_READ</a>;
01321     <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o7">CmHive</a> = CmHive;
01322     <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o3">FileType</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a38">HFILE_TYPE_PRIMARY</a>;
01323     <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o9">Offset</a> = &amp;<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
01324     <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o8">Buffer</a> = CopyBuffer;
01325     <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o4">FileSize</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
01326     <a class="code" href="../../d5/d3/cmworker_8c.html#a20">CmpWorker</a>(&amp;<a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>);
01327     <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o5">Status</a>)) {
01328         <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
01329     }
01330 
01331     BaseBlock = (<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>)CopyBuffer;
01332     Length = BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o9">Length</a>;
01333 
01334     BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o1">Sequence1</a>++;
01335 
01336     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = 0;
01337     offsetElement.<a class="code" href="../../d5/d4/structCMP__OFFSET__ARRAY.html#o0">FileOffset</a> = <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
01338     offsetElement.<a class="code" href="../../d5/d4/structCMP__OFFSET__ARRAY.html#o1">DataBuffer</a> = CopyBuffer;
01339     offsetElement.<a class="code" href="../../d5/d4/structCMP__OFFSET__ARRAY.html#o2">DataLength</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
01340     <span class="keywordflow">if</span> ( ! <a class="code" href="../../d7/d3/cmwrapr_8c.html#a16">CmpFileWrite</a>((<a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>)CmHive, <a class="code" href="../../d0/d1/hivedata_8h.html#a41">HFILE_TYPE_EXTERNAL</a>, &amp;offsetElement,
01341                         1, &amp;<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>))
01342     {
01343         <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
01344     }
01345 
01346     <span class="comment">//</span>
01347     <span class="comment">// Flush the external, so header will show corrupt until we're done</span>
01348     <span class="comment">//</span>
01349     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d3/cmwrapr_8c.html#a17">CmpFileFlush</a>((<a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>)CmHive, <a class="code" href="../../d0/d1/hivedata_8h.html#a41">HFILE_TYPE_EXTERNAL</a>)) {
01350         status = STATUS_SUCCESS;
01351     }
01352 
01353     <span class="comment">//</span>
01354     <span class="comment">// For span of data, read from master and write to external</span>
01355     <span class="comment">//</span>
01356     <span class="keywordflow">for</span> (Position = 0; Position &lt; Length; Position += BytesToCopy) {
01357 
01358         <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = Position + <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
01359         BytesToCopy = Length-Position;
01360         <span class="keywordflow">if</span> (BytesToCopy &gt; BufferLength) {
01361             BytesToCopy = BufferLength;
01362         }
01363 
01364         <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o0">Command</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a111">REG_CMD_HIVE_READ</a>;
01365         <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o7">CmHive</a> = CmHive;
01366         <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o3">FileType</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a38">HFILE_TYPE_PRIMARY</a>;
01367         <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o9">Offset</a> = &amp;<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
01368         <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o8">Buffer</a> = CopyBuffer;
01369         <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o4">FileSize</a> = BytesToCopy;
01370         <a class="code" href="../../d5/d3/cmworker_8c.html#a20">CmpWorker</a>(&amp;<a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>);
01371         <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o5">Status</a>)) {
01372             <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
01373         }
01374 
01375         <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = Position + <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
01376         offsetElement.<a class="code" href="../../d5/d4/structCMP__OFFSET__ARRAY.html#o0">FileOffset</a> = <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
01377         offsetElement.<a class="code" href="../../d5/d4/structCMP__OFFSET__ARRAY.html#o1">DataBuffer</a> = CopyBuffer;
01378         offsetElement.<a class="code" href="../../d5/d4/structCMP__OFFSET__ARRAY.html#o2">DataLength</a> = BytesToCopy;
01379         <span class="keywordflow">if</span> ( ! <a class="code" href="../../d7/d3/cmwrapr_8c.html#a16">CmpFileWrite</a>((<a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>)CmHive, <a class="code" href="../../d0/d1/hivedata_8h.html#a41">HFILE_TYPE_EXTERNAL</a>, &amp;offsetElement,
01380                             1, &amp;<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>))
01381         {
01382             <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
01383         }
01384     }
01385 
01386     <span class="comment">//</span>
01387     <span class="comment">// Flush the external, so data is there before we update the header</span>
01388     <span class="comment">//</span>
01389     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d3/cmwrapr_8c.html#a17">CmpFileFlush</a>((<a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>)CmHive, <a class="code" href="../../d0/d1/hivedata_8h.html#a41">HFILE_TYPE_EXTERNAL</a>)) {
01390         status = STATUS_SUCCESS;
01391     }
01392 
01393     <span class="comment">//</span>
01394     <span class="comment">// Reread the base block, sync the seq #, rewrite it.</span>
01395     <span class="comment">// (Brute force, but means no memory alloc - always works)</span>
01396     <span class="comment">//</span>
01397     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = 0;
01398     <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o0">Command</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a111">REG_CMD_HIVE_READ</a>;
01399     <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o7">CmHive</a> = CmHive;
01400     <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o3">FileType</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a38">HFILE_TYPE_PRIMARY</a>;
01401     <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o9">Offset</a> = &amp;<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
01402     <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o8">Buffer</a> = CopyBuffer;
01403     <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o4">FileSize</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
01404     <a class="code" href="../../d5/d3/cmworker_8c.html#a20">CmpWorker</a>(&amp;<a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>);
01405     <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o5">Status</a>)) {
01406         <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
01407     }
01408     BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o1">Sequence1</a>++;     <span class="comment">// it got trampled when we reread it</span>
01409     BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o2">Sequence2</a>++;
01410 
01411     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = 0;
01412     offsetElement.<a class="code" href="../../d5/d4/structCMP__OFFSET__ARRAY.html#o0">FileOffset</a> = <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
01413     offsetElement.<a class="code" href="../../d5/d4/structCMP__OFFSET__ARRAY.html#o1">DataBuffer</a> = CopyBuffer;
01414     offsetElement.<a class="code" href="../../d5/d4/structCMP__OFFSET__ARRAY.html#o2">DataLength</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
01415     <span class="keywordflow">if</span> ( ! <a class="code" href="../../d7/d3/cmwrapr_8c.html#a16">CmpFileWrite</a>((<a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>)CmHive, <a class="code" href="../../d0/d1/hivedata_8h.html#a41">HFILE_TYPE_EXTERNAL</a>, &amp;offsetElement,
01416                         1, &amp;<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>))
01417     {
01418         <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
01419     }
01420 
01421     <span class="comment">//</span>
01422     <span class="comment">// Flush the external, and we are done</span>
01423     <span class="comment">//</span>
01424     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d3/cmwrapr_8c.html#a17">CmpFileFlush</a>((<a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>)CmHive, <a class="code" href="../../d0/d1/hivedata_8h.html#a41">HFILE_TYPE_EXTERNAL</a>)) {
01425         status = STATUS_SUCCESS;
01426     }
01427 
01428 <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>:
01429     <span class="keywordflow">if</span> (CopyBuffer != <a class="code" href="../../d8/d9/cmapi_8c.html#a4">CmpStashBuffer</a>) {
01430         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(CopyBuffer);
01431     }
01432     CmHive-&gt;FileHandles[<a class="code" href="../../d0/d1/hivedata_8h.html#a41">HFILE_TYPE_EXTERNAL</a>] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01433     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
01434     <span class="keywordflow">return</span> status;
01435 }
01436 
01437 
01438 <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>
<a name="l01439"></a><a class="code" href="../../d6/d2/cmsavres_8c.html#a7">01439</a> <a class="code" href="../../d6/d2/cmsavres_8c.html#a7">CmpCreateTemporaryHive</a>(
01440     IN HANDLE FileHandle
01441     )
01442 <span class="comment">/*++</span>
01443 <span class="comment"></span>
01444 <span class="comment">Routine Description:</span>
01445 <span class="comment"></span>
01446 <span class="comment">    Allocates and inits a temporary hive.</span>
01447 <span class="comment"></span>
01448 <span class="comment">Arguments:</span>
01449 <span class="comment"></span>
01450 <span class="comment">    FileHandle - Supplies the handle of the file to back the hive.</span>
01451 <span class="comment"></span>
01452 <span class="comment">Return Value:</span>
01453 <span class="comment"></span>
01454 <span class="comment">    Pointer to CmHive.</span>
01455 <span class="comment"></span>
01456 <span class="comment">    If NULL the operation failed.</span>
01457 <span class="comment"></span>
01458 <span class="comment">--*/</span>
01459 {
01460     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> TempHive;
01461     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01462 
01463     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01464 
01465     <span class="comment">//</span>
01466     <span class="comment">// NOTE: Hive will get put on CmpHiveListHead list.</span>
01467     <span class="comment">//       Make sure CmpDestroyTemporaryHive gets called to remove it.</span>
01468     <span class="comment">//</span>
01469 
01470     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a275">CmpInitializeHive</a>(&amp;TempHive,
01471                           <a class="code" href="../../d6/d0/hive_8h.html#a4">HINIT_CREATE</a>,
01472                           <a class="code" href="../../d6/d0/hive_8h.html#a9">HIVE_VOLATILE</a>,
01473                           0,
01474                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01475                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01476                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01477                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01478                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01479                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01480     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01481         <span class="keywordflow">return</span>(TempHive);
01482     } <span class="keywordflow">else</span> {
01483         <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01484     }
01485 
01486 }
01487 
01488 
01489 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01490"></a><a class="code" href="../../d6/d2/cmsavres_8c.html#a8">01490</a> <a class="code" href="../../d6/d2/cmsavres_8c.html#a8">CmpDestroyTemporaryHive</a>(
01491     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> CmHive
01492     )
01493 <span class="comment">/*++</span>
01494 <span class="comment"></span>
01495 <span class="comment">Routine Description:</span>
01496 <span class="comment"></span>
01497 <span class="comment">    Frees all the pieces of a hive.</span>
01498 <span class="comment"></span>
01499 <span class="comment">Arguments:</span>
01500 <span class="comment"></span>
01501 <span class="comment">    CmHive - CM level hive structure to free</span>
01502 <span class="comment"></span>
01503 <span class="comment">Return Value:</span>
01504 <span class="comment"></span>
01505 <span class="comment">    None.</span>
01506 <span class="comment"></span>
01507 <span class="comment">--*/</span>
01508 {
01509     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01510     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a23">CML_MINOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a32">CMS_SAVRES</a>) {
01511         KdPrint((<span class="stringliteral">"CmpDestroyTemporaryHive:\n"</span>));
01512         KdPrint((<span class="stringliteral">"\tCmHive=%08lx\n"</span>, CmHive));
01513     }
01514 
01515     <span class="keywordflow">if</span> (CmHive == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01516         <span class="keywordflow">return</span>;
01517     }
01518 
01519     <span class="comment">//</span>
01520     <span class="comment">// NOTE: Hive is on CmpHiveListHead list.</span>
01521     <span class="comment">//       Remove it.</span>
01522     <span class="comment">//</span>
01523     RemoveEntryList(&amp;CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o3">HiveList</a>);
01524 
01525     <a class="code" href="../../d2/d1/hivefree_8c.html#a0">HvFreeHive</a>(&amp;(CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>));
01526     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o4">HiveLock</a> );
01527     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o4">HiveLock</a>);
01528     <a class="code" href="../../d7/d3/cmwrapr_8c.html#a12">CmpFree</a>(CmHive, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>));
01529 
01530     <span class="keywordflow">return</span>;
01531 }
01532 
01533 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:28 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
