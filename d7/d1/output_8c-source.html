<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: output.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>output.c</h1><a href="../../d6/d2/output_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    output.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">        This file implements the video buffer management.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Therese Stowell (thereses) 6-Nov-1990</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:</span>
00018 <span class="comment"></span>
00019 <span class="comment">Notes:</span>
00020 <span class="comment"></span>
00021 <span class="comment"> ScreenBuffer data structure overview:</span>
00022 <span class="comment"></span>
00023 <span class="comment"> each screen buffer has an array of ROW structures.  each ROW structure</span>
00024 <span class="comment"> contains the data for one row of text.  the data stored for one row of</span>
00025 <span class="comment"> text is a character array and an attribute array.  the character array</span>
00026 <span class="comment"> is allocated the full length of the row from the heap, regardless of the</span>
00027 <span class="comment"> non-space length. we also maintain the non-space length.  the character</span>
00028 <span class="comment"> array is initialized to spaces.  the attribute</span>
00029 <span class="comment"> array is run length encoded (i.e 5 BLUE, 3 RED). if there is only one</span>
00030 <span class="comment"> attribute for the whole row (the normal case), it is stored in the ATTR_ROW</span>
00031 <span class="comment"> structure.  otherwise the attr string is allocated from the heap.</span>
00032 <span class="comment"></span>
00033 <span class="comment"> ROW - CHAR_ROW - CHAR string</span>
00034 <span class="comment">     \          \ length of char string</span>
00035 <span class="comment">      \</span>
00036 <span class="comment">       ATTR_ROW - ATTR_PAIR string</span>
00037 <span class="comment">                \ length of attr pair string</span>
00038 <span class="comment"> ROW</span>
00039 <span class="comment"> ROW</span>
00040 <span class="comment"> ROW</span>
00041 <span class="comment"></span>
00042 <span class="comment"> ScreenInfo-&gt;Rows points to the ROW array. ScreenInfo-&gt;Rows[0] is not</span>
00043 <span class="comment"> necessarily the top row. ScreenInfo-&gt;BufferInfo.TextInfo.FirstRow contains the index of</span>
00044 <span class="comment"> the top row.  That means scrolling (if scrolling entire screen)</span>
00045 <span class="comment"> merely involves changing the FirstRow index,</span>
00046 <span class="comment"> filling in the last row, and updating the screen.</span>
00047 <span class="comment"></span>
00048 <span class="comment">--*/</span>
00049 
00050 <span class="preprocessor">#include "<a class="code" href="../../d6/d3/w32_2ntcon_2server_2precomp_8h.html">precomp.h</a>"</span>
00051 <span class="preprocessor">#pragma hdrstop</span>
00052 <span class="preprocessor"></span>
00053 
00054 <span class="comment">//#define THERESES_DEBUG 1</span>
00055 
00056 <span class="comment">//#define PROFILE_GDI</span>
00057 <span class="preprocessor">#ifdef PROFILE_GDI</span>
00058 <span class="preprocessor"></span>LONG ScrollDCCount;
00059 LONG ExtTextOutCount;
00060 LONG TextColor=1;
00061 
00062 <span class="preprocessor">#define SCROLLDC_CALL ScrollDCCount++</span>
00063 <span class="preprocessor"></span><span class="preprocessor">#define TEXTOUT_CALL ExtTextOutCount++</span>
00064 <span class="preprocessor"></span><span class="preprocessor">#define TEXTCOLOR_CALL TextColor++</span>
00065 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00066"></a><a class="code" href="../../d6/d2/output_8c.html#a0">00066</a> <span class="preprocessor"></span><span class="preprocessor">#define SCROLLDC_CALL</span>
<a name="l00067"></a><a class="code" href="../../d6/d2/output_8c.html#a1">00067</a> <span class="preprocessor"></span><span class="preprocessor">#define TEXTOUT_CALL</span>
<a name="l00068"></a><a class="code" href="../../d6/d2/output_8c.html#a2">00068</a> <span class="preprocessor"></span><span class="preprocessor">#define TEXTCOLOR_CALL</span>
00069 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00070 <span class="preprocessor"></span>
<a name="l00071"></a><a class="code" href="../../d6/d2/output_8c.html#a3">00071</a> <span class="preprocessor">#define ITEM_MAX_SIZE 256</span>
00072 <span class="preprocessor"></span>
00073 <span class="comment">// BUGBUG get the real include file from progman</span>
<a name="l00074"></a><a class="code" href="../../d3/d6/struct__PMIconData.html">00074</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d3/d6/struct__PMIconData.html">_PMIconData</a> {
<a name="l00075"></a><a class="code" href="../../d3/d6/struct__PMIconData.html#o0">00075</a>        <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d3/d6/struct__PMIconData.html#o0">dwResSize</a>;
<a name="l00076"></a><a class="code" href="../../d3/d6/struct__PMIconData.html#o1">00076</a>        <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d3/d6/struct__PMIconData.html#o1">dwVer</a>;
<a name="l00077"></a><a class="code" href="../../d3/d6/struct__PMIconData.html#o2">00077</a>        <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> <a class="code" href="../../d3/d6/struct__PMIconData.html#o2">iResource</a>;  <span class="comment">// icon resource</span>
00078 } <a class="code" href="../../d3/d6/struct__PMIconData.html">PMICONDATA</a>, *<a class="code" href="../../d3/d6/struct__PMIconData.html">LPPMICONDATA</a>;
00079 
00080 <span class="comment">//</span>
00081 <span class="comment">// Screen dimensions</span>
00082 <span class="comment">//</span>
00083 
<a name="l00084"></a><a class="code" href="../../d6/d2/output_8c.html#a11">00084</a> <span class="keywordtype">int</span> <a class="code" href="../../d6/d2/output_8c.html#a11">ConsoleFullScreenX</a>;
<a name="l00085"></a><a class="code" href="../../d6/d2/output_8c.html#a12">00085</a> <span class="keywordtype">int</span> <a class="code" href="../../d6/d2/output_8c.html#a12">ConsoleFullScreenY</a>;
<a name="l00086"></a><a class="code" href="../../d6/d2/output_8c.html#a13">00086</a> <span class="keywordtype">int</span> <a class="code" href="../../d6/d2/output_8c.html#a13">ConsoleCaptionY</a>;
<a name="l00087"></a><a class="code" href="../../d6/d2/output_8c.html#a14">00087</a> <span class="keywordtype">int</span> <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a16">MinimumWidthX</a>;
<a name="l00088"></a><a class="code" href="../../d6/d2/output_8c.html#a15">00088</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a17">VerticalScrollSize</a>;
<a name="l00089"></a><a class="code" href="../../d6/d2/output_8c.html#a16">00089</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a18">HorizontalScrollSize</a>;
00090 
<a name="l00091"></a><a class="code" href="../../d6/d2/output_8c.html#a17">00091</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a19">VerticalClientToWindow</a>;
<a name="l00092"></a><a class="code" href="../../d6/d2/output_8c.html#a18">00092</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a20">HorizontalClientToWindow</a>;
00093 
<a name="l00094"></a><a class="code" href="../../d6/d2/output_8c.html#a19">00094</a> PCHAR_INFO <a class="code" href="../../d6/d2/output_8c.html#a19">ScrollBuffer</a>;
<a name="l00095"></a><a class="code" href="../../d6/d2/output_8c.html#a20">00095</a> ULONG <a class="code" href="../../d6/d2/output_8c.html#a20">ScrollBufferSize</a>;
<a name="l00096"></a><a class="code" href="../../d6/d2/output_8c.html#a21">00096</a> CRITICAL_SECTION <a class="code" href="../../d6/d2/output_8c.html#a21">ScrollBufferLock</a>;
00097 
00098 <span class="comment">// this value keeps track of the number of existing console windows.</span>
00099 <span class="comment">// if a window is created when this value is zero, the Face Names</span>
00100 <span class="comment">// must be reenumerated because no WM_FONTCHANGE message was processed</span>
00101 <span class="comment">// if there's no window.</span>
<a name="l00102"></a><a class="code" href="../../d6/d2/output_8c.html#a22">00102</a> LONG <a class="code" href="../../d6/d2/output_8c.html#a22">gnConsoleWindows</a>;
00103 
<a name="l00104"></a><a class="code" href="../../d6/d2/output_8c.html#a23">00104</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d2/output_8c.html#a23">gfInitSystemMetrics</a>;
00105 
<a name="l00106"></a><a class="code" href="../../d6/d2/output_8c.html#a24">00106</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d2/output_8c.html#a24">UsePolyTextOut</a>;
00107 
<a name="l00108"></a><a class="code" href="../../d6/d2/output_8c.html#a25">00108</a> HRGN <a class="code" href="../../d6/d2/output_8c.html#a25">ghrgnScroll</a>;
<a name="l00109"></a><a class="code" href="../../d6/d2/output_8c.html#a26">00109</a> LPRGNDATA <a class="code" href="../../d6/d2/output_8c.html#a26">gprgnData</a>;
00110 
<a name="l00111"></a><a class="code" href="../../d6/d2/output_8c.html#a27">00111</a> ULONG <a class="code" href="../../d6/d2/output_8c.html#a27">gucWheelScrollLines</a>;
00112 
<a name="l00113"></a><a class="code" href="../../d6/d2/output_8c.html#a28">00113</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d6/d2/output_8c.html#a28">guCaretBlinkTime</a>;
00114 
<a name="l00115"></a><a class="code" href="../../d6/d2/output_8c.html#a4">00115</a> <span class="preprocessor">#define GRGNDATASIZE  (sizeof(RGNDATAHEADER) + (6 * sizeof(RECTL)))</span>
00116 <span class="preprocessor"></span>
00117 
<a name="l00118"></a><a class="code" href="../../d6/d2/output_8c.html#a5">00118</a> <span class="preprocessor">#define CharSizeOf(x)   (sizeof(x) / sizeof(*x))</span>
<a name="l00119"></a><a class="code" href="../../d6/d2/output_8c.html#a6">00119</a> <span class="preprocessor"></span><span class="preprocessor">#define LockScrollBuffer() RtlEnterCriticalSection(&amp;ScrollBufferLock)</span>
<a name="l00120"></a><a class="code" href="../../d6/d2/output_8c.html#a7">00120</a> <span class="preprocessor"></span><span class="preprocessor">#define UnlockScrollBuffer() RtlLeaveCriticalSection(&amp;ScrollBufferLock)</span>
00121 <span class="preprocessor"></span>
<a name="l00122"></a><a class="code" href="../../d6/d2/output_8c.html#a8">00122</a> <span class="preprocessor">#define SetWindowConsole(hWnd, Console) SetWindowLongPtr((hWnd), GWLP_USERDATA, (LONG_PTR)(Console))</span>
00123 <span class="preprocessor"></span>
00124 <span class="preprocessor">#ifdef LATER</span>
00125 <span class="preprocessor"></span><span class="preprocessor">#ifndef IS_IME_KBDLAYOUT</span>
00126 <span class="preprocessor"></span><span class="preprocessor">#define IS_IME_KBDLAYOUT(hkl) ((((ULONG_PTR)(hkl)) &amp; 0xf0000000) == 0xe0000000)</span>
00127 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00128 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00129 <span class="preprocessor"></span>
00130 
00131 <span class="keywordtype">void</span> <a class="code" href="../../d6/d2/output_8c.html#a31">GetNonBiDiKeyboardLayout</a>(HKL * phklActive);
00132 
00133 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d6/d2/output_8c.html#a32">FreeConsoleBitmap</a>(IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo);
00134 
00135 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00136 <a class="code" href="../../d6/d2/output_8c.html#a33">ScrollIfNecessary</a>(
00137     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
00138     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo
00139     );
00140 
00141 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00142 <a class="code" href="../../d4/d8/resize_8c.html#a1">ProcessResizeWindow</a>(
00143     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
00144     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
00145     IN LPWINDOWPOS WindowPos
00146     );
00147 
00148 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00149 <a class="code" href="../../d6/d2/output_8c.html#a35">AllocateScrollBuffer</a>(
00150     DWORD Size
00151     );
00152 
00153 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d6/d2/output_8c.html#a36">FreeScrollBuffer</a> ( VOID );
00154 
00155 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00156 <a class="code" href="../../d6/d2/output_8c.html#a37">InternalUpdateScrollBars</a>(
00157     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo
00158     );
00159 
00160 <span class="preprocessor">#if defined(FE_SB)</span>
00161 <span class="preprocessor"></span><a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
00162 SB_PolyTextOutCandidate(
00163     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
00164     IN PSMALL_RECT Region
00165     );
00166 
00167 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00168 SB_ConsolePolyTextOut(
00169     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
00170     IN PSMALL_RECT Region
00171     );
00172 <span class="preprocessor">#endif</span>
00173 <span class="preprocessor"></span>
00174 
00175 
00176 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00177"></a><a class="code" href="../../d6/d2/output_8c.html#a38">00177</a> <a class="code" href="../../d6/d2/output_8c.html#a38">InitializeSystemMetrics</a>( VOID )
00178 {
00179     RECT WindowSize;
00180 
00181     <a class="code" href="../../d6/d2/output_8c.html#a23">gfInitSystemMetrics</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00182     <a class="code" href="../../d5/d9/cltxt_8h.html#a26">SystemParametersInfo</a>(SPI_GETWHEELSCROLLLINES, 0, &amp;<a class="code" href="../../d6/d2/output_8c.html#a27">gucWheelScrollLines</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00183     <a class="code" href="../../d6/d2/output_8c.html#a11">ConsoleFullScreenX</a> = <a class="code" href="../../d3/d9/client_2wow_8c.html#a16">GetSystemMetrics</a>(SM_CXFULLSCREEN);
00184     <a class="code" href="../../d6/d2/output_8c.html#a12">ConsoleFullScreenY</a> = <a class="code" href="../../d3/d9/client_2wow_8c.html#a16">GetSystemMetrics</a>(SM_CYFULLSCREEN);
00185     <a class="code" href="../../d6/d2/output_8c.html#a13">ConsoleCaptionY</a> = <a class="code" href="../../d3/d9/client_2wow_8c.html#a16">GetSystemMetrics</a>(SM_CYCAPTION);
00186     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a17">VerticalScrollSize</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)<a class="code" href="../../d3/d9/client_2wow_8c.html#a16">GetSystemMetrics</a>(SM_CXVSCROLL);
00187     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a18">HorizontalScrollSize</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)<a class="code" href="../../d3/d9/client_2wow_8c.html#a16">GetSystemMetrics</a>(SM_CYHSCROLL);
00188     WindowSize.left = WindowSize.top = 0;
00189     WindowSize.right = WindowSize.bottom = 50;
00190     <a class="code" href="../../d3/d8/winmgrc_8c.html#a9">AdjustWindowRectEx</a>(&amp;WindowSize,
00191                         <a class="code" href="../../d7/d2/output_8h.html#a13">CONSOLE_WINDOW_FLAGS</a>,
00192                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00193                         <a class="code" href="../../d7/d2/output_8h.html#a14">CONSOLE_WINDOW_EX_FLAGS</a>
00194                        );
00195     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a19">VerticalClientToWindow</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(WindowSize.right-WindowSize.left-50);
00196     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a20">HorizontalClientToWindow</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(WindowSize.bottom-WindowSize.top-50);
00197 
00198 <span class="preprocessor">#ifdef LATER</span>
00199 <span class="preprocessor"></span>    gfIsIMEEnabled = !!<a class="code" href="../../d3/d9/client_2wow_8c.html#a16">GetSystemMetrics</a>(SM_IMMENABLED);
00200     RIPMSG1(RIP_VERBOSE, <span class="stringliteral">"InitializeSystemMetrics: gfIsIMEEnabled=%d"</span>, gfIsIMEEnabled);
00201 <span class="preprocessor">#endif</span>
00202 <span class="preprocessor"></span>
00203     <a class="code" href="../../d6/d2/output_8c.html#a28">guCaretBlinkTime</a> = GetCaretBlinkTime();
00204 }
00205 
00206 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00207"></a><a class="code" href="../../d6/d2/output_8c.html#a39">00207</a> <a class="code" href="../../d6/d2/output_8c.html#a39">GetWindowLimits</a>(
00208     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
00209     OUT <a class="code" href="../../d0/d9/struct__WINDOW__LIMITS.html">PWINDOW_LIMITS</a> WindowLimits
00210     )
00211 {
00212     HMONITOR hMonitor;
00213     MONITORINFO MonitorInfo = {<span class="keyword">sizeof</span>(MonitorInfo)};
00214     COORD FontSize;
00215 
00216     <span class="comment">//</span>
00217     <span class="comment">// If the system metrics have changed or there aren't any console</span>
00218     <span class="comment">// windows around, reinitialize the global valeus.</span>
00219     <span class="comment">//</span>
00220 
00221     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/output_8c.html#a23">gfInitSystemMetrics</a> || <a class="code" href="../../d6/d2/output_8c.html#a22">gnConsoleWindows</a> == 0) {
00222         <a class="code" href="../../d6/d2/output_8c.html#a38">InitializeSystemMetrics</a>();
00223     }
00224 
00225     <span class="keywordflow">if</span> (ScreenInfo-&gt;Console &amp;&amp;
00226             (ScreenInfo-&gt;Console-&gt;hWnd || !(ScreenInfo-&gt;Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a16">CONSOLE_AUTO_POSITION</a>)) &amp;&amp;
00227             ((hMonitor = <a class="code" href="../../d3/d1/mmcl_8c.html#a1">MonitorFromRect</a>(&amp;ScreenInfo-&gt;Console-&gt;WindowRect, MONITOR_DEFAULTTOPRIMARY)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00228             <a class="code" href="../../d5/d9/cltxt_8h.html#a38">GetMonitorInfo</a>(hMonitor, &amp;MonitorInfo)) {
00229         WindowLimits-&gt;FullScreenSize.X = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(MonitorInfo.rcWork.right - MonitorInfo.rcWork.left);
00230         WindowLimits-&gt;FullScreenSize.Y = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(MonitorInfo.rcWork.bottom - MonitorInfo.rcWork.top - <a class="code" href="../../d6/d2/output_8c.html#a13">ConsoleCaptionY</a>);
00231     } <span class="keywordflow">else</span> {
00232         WindowLimits-&gt;FullScreenSize.X = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)<a class="code" href="../../d6/d2/output_8c.html#a11">ConsoleFullScreenX</a>;
00233         WindowLimits-&gt;FullScreenSize.Y = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)<a class="code" href="../../d6/d2/output_8c.html#a12">ConsoleFullScreenY</a>;
00234     }
00235 
00236     <span class="keywordflow">if</span> (ScreenInfo-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>) {
00237         FontSize = <a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(ScreenInfo);
00238     } <span class="keywordflow">else</span> {
00239         FontSize.X = 1;
00240         FontSize.Y = 1;
00241     }
00242 
00243     WindowLimits-&gt;MinimumWindowSize.X = ((<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a16">MinimumWidthX</a> - <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a19">VerticalClientToWindow</a> + FontSize.X - 1) / FontSize.X);
00244     WindowLimits-&gt;MinimumWindowSize.Y = 1;
00245     WindowLimits-&gt;MaximumWindowSize.X = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(WindowLimits-&gt;FullScreenSize.X/FontSize.X, ScreenInfo-&gt;ScreenBufferSize.X);
00246     WindowLimits-&gt;MaximumWindowSize.X = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(WindowLimits-&gt;MaximumWindowSize.X, WindowLimits-&gt;MinimumWindowSize.X);
00247     WindowLimits-&gt;MaximumWindowSize.Y = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(WindowLimits-&gt;FullScreenSize.Y/FontSize.Y, ScreenInfo-&gt;ScreenBufferSize.Y);
00248     WindowLimits-&gt;MaxWindow.X = WindowLimits-&gt;MaximumWindowSize.X*FontSize.X + <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a19">VerticalClientToWindow</a>;
00249     WindowLimits-&gt;MaxWindow.Y = WindowLimits-&gt;MaximumWindowSize.Y*FontSize.Y + <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a20">HorizontalClientToWindow</a>;
00250 }
00251 
00252 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00253"></a><a class="code" href="../../d6/d2/output_8c.html#a40">00253</a> <a class="code" href="../../d6/d2/output_8c.html#a40">InitializeScreenInfo</a>( VOID )
00254 {
00255     HDC hDC;
00256 
00257     <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a19">InitializeMouseButtons</a>();
00258     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a16">MinimumWidthX</a> = <a class="code" href="../../d3/d9/client_2wow_8c.html#a16">GetSystemMetrics</a>(SM_CXMIN);
00259 
00260     <a class="code" href="../../d6/d2/output_8c.html#a38">InitializeSystemMetrics</a>();
00261 
00262     hDC = CreateDCW(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"DISPLAY"</span>,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00263     <span class="keywordflow">if</span> (hDC != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00264         <a class="code" href="../../d6/d2/output_8c.html#a24">UsePolyTextOut</a> = GetDeviceCaps(hDC,TEXTCAPS) &amp; TC_SCROLLBLT;
00265         DeleteDC(hDC);
00266     }
00267 }
00268 
00269 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00270"></a><a class="code" href="../../d6/d2/output_8c.html#a41">00270</a> <a class="code" href="../../d6/d2/output_8c.html#a41">DoCreateScreenBuffer</a>(
00271     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
00272     IN <a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html">PCONSOLE_INFO</a> ConsoleInfo
00273     )
00274 
00275 <span class="comment">/*++</span>
00276 <span class="comment"></span>
00277 <span class="comment">    this routine figures out what parameters to pass to CreateScreenBuffer,</span>
00278 <span class="comment">    based on the data from STARTUPINFO and the defaults in win.ini,</span>
00279 <span class="comment">    then calls CreateScreenBuffer.</span>
00280 <span class="comment"></span>
00281 <span class="comment">--*/</span>
00282 
00283 {
00284     CHAR_INFO Fill,PopupFill;
00285     COORD dwScreenBufferSize, dwWindowSize;
00286     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00287     <span class="keywordtype">int</span> FontIndexWant;
00288 
00289     <span class="keywordflow">if</span> (ConsoleInfo-&gt;dwStartupFlags &amp; STARTF_USESHOWWINDOW) {
00290         Console-&gt;wShowWindow = ConsoleInfo-&gt;wShowWindow;
00291     } <span class="keywordflow">else</span> {
00292         Console-&gt;wShowWindow = SW_SHOWNORMAL;
00293     }
00294 
00295 <span class="preprocessor">#if 0</span>
00296 <span class="preprocessor"></span>    {
00297 
00298             <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> i;
00299 
00300             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"[Link Server Properties for %ws]\n"</span>, ConsoleTitle );
00301             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    wFillAttribute      = 0x%04X\n"</span>, ConsoleInfo-&gt;wFillAttribute );
00302             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    wPopupFillAttribute = 0x%04X\n"</span>, ConsoleInfo-&gt;wPopupFillAttribute );
00303             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    dwScreenBufferSize  = (%d , %d)\n"</span>, ConsoleInfo-&gt;dwScreenBufferSize.X, ConsoleInfo-&gt;dwScreenBufferSize.Y );
00304             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    dwWindowSize        = (%d , %d)\n"</span>, ConsoleInfo-&gt;dwWindowSize.X, ConsoleInfo-&gt;dwWindowSize.Y );
00305             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    dwWindowOrigin      = (%d , %d)\n"</span>, ConsoleInfo-&gt;dwWindowOrigin.X, ConsoleInfo-&gt;dwWindowOrigin.Y );
00306             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    nFont               = %d\n"</span>, ConsoleInfo-&gt;nFont );
00307             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    nInputBufferSize    = %d\n"</span>, ConsoleInfo-&gt;nInputBufferSize );
00308             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    dwFontSize          = (%d , %d)\n"</span>, ConsoleInfo-&gt;dwFontSize.X, ConsoleInfo-&gt;dwFontSize.Y );
00309             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    uFontFamily         = 0x%08X\n"</span>, ConsoleInfo-&gt;uFontFamily );
00310             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    uFontWeight         = 0x%08X\n"</span>, ConsoleInfo-&gt;uFontWeight );
00311             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    FaceName            = %ws\n"</span>, ConsoleInfo-&gt;FaceName );
00312             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    uCursorSize         = %d\n"</span>, ConsoleInfo-&gt;uCursorSize );
00313             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    bFullScreen         = %s\n"</span>, ConsoleInfo-&gt;bFullScreen ? <span class="stringliteral">"TRUE"</span> : <span class="stringliteral">"FALSE"</span> );
00314             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    bQuickEdit          = %s\n"</span>, ConsoleInfo-&gt;bQuickEdit  ? <span class="stringliteral">"TRUE"</span> : <span class="stringliteral">"FALSE"</span> );
00315             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    bInsertMode         = %s\n"</span>, ConsoleInfo-&gt;bInsertMode ? <span class="stringliteral">"TRUE"</span> : <span class="stringliteral">"FALSE"</span> );
00316             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    bAutoPosition       = %s\n"</span>, ConsoleInfo-&gt;bAutoPosition ? <span class="stringliteral">"TRUE"</span> : <span class="stringliteral">"FALSE"</span> );
00317             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    uHistoryBufferSize  = %d\n"</span>, ConsoleInfo-&gt;uHistoryBufferSize );
00318             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    uNumHistoryBuffers  = %d\n"</span>, ConsoleInfo-&gt;uNumberOfHistoryBuffers );
00319             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    bHistoryNoDup       = %s\n"</span>, ConsoleInfo-&gt;bHistoryNoDup ? <span class="stringliteral">"TRUE"</span> : <span class="stringliteral">"FALSE"</span> );
00320             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"    ColorTable = ["</span> );
00321             i=0;
00322             <span class="keywordflow">while</span>( i &lt; 16 )
00323             {
00324                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n         "</span>);
00325                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"0x%08X "</span>, ConsoleInfo-&gt;ColorTable[i++]);
00326                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"0x%08X "</span>, ConsoleInfo-&gt;ColorTable[i++]);
00327                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"0x%08X "</span>, ConsoleInfo-&gt;ColorTable[i++]);
00328                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"0x%08X "</span>, ConsoleInfo-&gt;ColorTable[i++]);
00329             }
00330             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"]\n\n"</span> );
00331         }
00332 <span class="preprocessor">#endif</span>
00333 <span class="preprocessor"></span>
00334     <span class="comment">//</span>
00335     <span class="comment">// Get values from consoleinfo (which was initialized through link)</span>
00336     <span class="comment">//</span>
00337 
00338     Fill.Attributes = ConsoleInfo-&gt;wFillAttribute;
00339     Fill.Char.UnicodeChar = (WCHAR)<span class="charliteral">' '</span>;
00340     PopupFill.Attributes = ConsoleInfo-&gt;wPopupFillAttribute;
00341     PopupFill.Char.UnicodeChar = (WCHAR)<span class="charliteral">' '</span>;
00342 
00343     dwScreenBufferSize = ConsoleInfo-&gt;dwScreenBufferSize;
00344     <span class="keywordflow">if</span> (!(ConsoleInfo-&gt;dwStartupFlags &amp; STARTF_USECOUNTCHARS)) {
00345         <span class="keywordflow">if</span> (Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a8">CONSOLE_NO_WINDOW</a>) {
00346             dwScreenBufferSize.X = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(dwScreenBufferSize.X, 80);
00347             dwScreenBufferSize.Y = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(dwScreenBufferSize.Y, 25);
00348         }
00349     }
00350     <span class="keywordflow">if</span> (dwScreenBufferSize.X == 0)
00351         dwScreenBufferSize.X = 1;
00352     <span class="keywordflow">if</span> (dwScreenBufferSize.Y == 0)
00353         dwScreenBufferSize.Y = 1;
00354 
00355     <span class="comment">//</span>
00356     <span class="comment">// Grab font</span>
00357     <span class="comment">//</span>
00358 <span class="preprocessor">#if defined(FE_SB)</span>
00359 <span class="preprocessor"></span>    FontIndexWant = <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a25">FindCreateFont</a>(ConsoleInfo-&gt;uFontFamily,
00360                                    ConsoleInfo-&gt;FaceName,
00361                                    ConsoleInfo-&gt;dwFontSize,
00362                                    ConsoleInfo-&gt;uFontWeight,
00363                                    ConsoleInfo-&gt;uCodePage
00364                                   );
00365 <span class="preprocessor">#else</span>
00366 <span class="preprocessor"></span>    FontIndexWant = <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a25">FindCreateFont</a>(ConsoleInfo-&gt;uFontFamily,
00367                                    ConsoleInfo-&gt;FaceName,
00368                                    ConsoleInfo-&gt;dwFontSize,
00369                                    ConsoleInfo-&gt;uFontWeight);
00370 <span class="preprocessor">#endif</span>
00371 <span class="preprocessor"></span>
00372     <span class="comment">//</span>
00373     <span class="comment">// grab window size information</span>
00374     <span class="comment">//</span>
00375 
00376     dwWindowSize = ConsoleInfo-&gt;dwWindowSize;
00377     <span class="keywordflow">if</span> (ConsoleInfo-&gt;dwStartupFlags &amp; STARTF_USESIZE) {
00378         dwWindowSize.X /= <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[FontIndexWant].<a class="code" href="../../d5/d9/struct__FONT__INFO.html#o1">Size</a>.X;
00379         dwWindowSize.Y /= <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[FontIndexWant].<a class="code" href="../../d5/d9/struct__FONT__INFO.html#o1">Size</a>.Y;
00380     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a8">CONSOLE_NO_WINDOW</a>) {
00381         dwWindowSize.X = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(dwWindowSize.X, 80);
00382         dwWindowSize.Y = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(dwWindowSize.Y, 25);
00383     }
00384     <span class="keywordflow">if</span> (dwWindowSize.X == 0)
00385         dwWindowSize.X = 1;
00386     <span class="keywordflow">if</span> (dwWindowSize.Y == 0)
00387         dwWindowSize.Y = 1;
00388 
00389     <span class="keywordflow">if</span> (dwScreenBufferSize.X &lt; dwWindowSize.X)
00390         dwScreenBufferSize.X = dwWindowSize.X;
00391     <span class="keywordflow">if</span> (dwScreenBufferSize.Y &lt; dwWindowSize.Y)
00392         dwScreenBufferSize.Y = dwWindowSize.Y;
00393 
00394     Console-&gt;dwWindowOriginX = ConsoleInfo-&gt;dwWindowOrigin.X;
00395     Console-&gt;dwWindowOriginY = ConsoleInfo-&gt;dwWindowOrigin.Y;
00396 
00397     <span class="keywordflow">if</span> (ConsoleInfo-&gt;bAutoPosition) {
00398         Console-&gt;Flags |= <a class="code" href="../../d1/d7/server_8h.html#a16">CONSOLE_AUTO_POSITION</a>;
00399         Console-&gt;dwWindowOriginX = CW_USEDEFAULT;
00400     } <span class="keywordflow">else</span> {
00401         Console-&gt;WindowRect.left = Console-&gt;dwWindowOriginX;
00402         Console-&gt;WindowRect.top = Console-&gt;dwWindowOriginY;
00403         Console-&gt;WindowRect.right = Console-&gt;dwWindowOriginX + dwWindowSize.X * <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[FontIndexWant].<a class="code" href="../../d5/d9/struct__FONT__INFO.html#o1">Size</a>.X;
00404         Console-&gt;WindowRect.bottom = Console-&gt;dwWindowOriginY + dwWindowSize.Y * <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[FontIndexWant].<a class="code" href="../../d5/d9/struct__FONT__INFO.html#o1">Size</a>.Y;
00405     }
00406 
00407 <span class="preprocessor">#ifdef i386</span>
00408 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a12">FullScreenInitialized</a>) {
00409         <span class="keywordflow">if</span> (ConsoleInfo-&gt;bFullScreen) {
00410             Console-&gt;FullScreenFlags = CONSOLE_FULLSCREEN;
00411         }
00412     }
00413 <span class="preprocessor">#endif</span>
00414 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (ConsoleInfo-&gt;bQuickEdit) {
00415         Console-&gt;Flags |= <a class="code" href="../../d1/d7/server_8h.html#a11">CONSOLE_QUICK_EDIT_MODE</a>;
00416     }
00417     Console-&gt;Flags |= <a class="code" href="../../d1/d7/server_8h.html#a19">CONSOLE_USE_PRIVATE_FLAGS</a>;
00418 
00419     Console-&gt;InsertMode = (ConsoleInfo-&gt;bInsertMode != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00420     Console-&gt;CommandHistorySize = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)ConsoleInfo-&gt;uHistoryBufferSize;
00421     Console-&gt;MaxCommandHistories = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)ConsoleInfo-&gt;uNumberOfHistoryBuffers;
00422     <span class="keywordflow">if</span> (ConsoleInfo-&gt;bHistoryNoDup) {
00423         Console-&gt;Flags |= <a class="code" href="../../d1/d7/server_8h.html#a20">CONSOLE_HISTORY_NODUP</a>;
00424     } <span class="keywordflow">else</span> {
00425         Console-&gt;Flags &amp;= ~<a class="code" href="../../d1/d7/server_8h.html#a20">CONSOLE_HISTORY_NODUP</a>;
00426     }
00427     RtlCopyMemory(Console-&gt;ColorTable, ConsoleInfo-&gt;ColorTable, <span class="keyword">sizeof</span>( Console-&gt;ColorTable ));
00428 
00429 <span class="preprocessor">#if defined(FE_SB)</span>
00430 <span class="preprocessor"></span>    <span class="comment">// for FarEast version, we want get the code page from registry or shell32,</span>
00431     <span class="comment">// so we can specify console codepage by console.cpl or shell32</span>
00432     <span class="comment">// default codepage is OEMCP. scotthsu</span>
00433     Console-&gt;CP = ConsoleInfo-&gt;uCodePage;
00434     Console-&gt;OutputCP = ConsoleInfo-&gt;uCodePage;
00435 <span class="preprocessor">#if 0</span>
00436 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/consrv_8h.html#a32">CONSOLE_IS_DBCS_ENABLED</a>()){
00437         Console-&gt;fIsDBCSCP = !!<a class="code" href="../../d0/d3/dbcs_8h.html#a46">IsAvailableFarEastCodePage</a>(Console-&gt;CP);
00438         Console-&gt;fIsDBCSOutputCP = !!<a class="code" href="../../d0/d3/dbcs_8h.html#a46">IsAvailableFarEastCodePage</a>(Console-&gt;OutputCP);
00439     }
00440     <span class="keywordflow">else</span> {
00441         Console-&gt;fIsDBCSCP = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00442         Console-&gt;fIsDBCSOutputCP = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00443     }
00444 <span class="preprocessor">#else</span>
00445 <span class="preprocessor"></span>    Console-&gt;fIsDBCSCP = <a class="code" href="../../d8/d5/consrv_8h.html#a32">CONSOLE_IS_DBCS_ENABLED</a>() &amp;&amp; <a class="code" href="../../d0/d3/dbcs_8h.html#a46">IsAvailableFarEastCodePage</a>(Console-&gt;CP);
00446     Console-&gt;fIsDBCSOutputCP = <a class="code" href="../../d8/d5/consrv_8h.html#a32">CONSOLE_IS_DBCS_ENABLED</a>() &amp;&amp; <a class="code" href="../../d0/d3/dbcs_8h.html#a46">IsAvailableFarEastCodePage</a>(Console-&gt;OutputCP);
00447 <span class="preprocessor">#endif</span>
00448 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00449 <span class="preprocessor"></span><span class="preprocessor">#if defined(FE_IME)</span>
00450 <span class="preprocessor"></span>    Console-&gt;ConsoleIme.ScrollWaitTimeout = <a class="code" href="../../d6/d2/output_8c.html#a28">guCaretBlinkTime</a> * 2;
00451 <span class="preprocessor">#endif</span>
00452 <span class="preprocessor"></span>TryNewSize:
00453     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d2/output_8c.html#a42">CreateScreenBuffer</a>(&amp;Console-&gt;ScreenBuffers,
00454                                 dwWindowSize,
00455                                 FontIndexWant,
00456                                 dwScreenBufferSize,
00457                                 Fill,
00458                                 PopupFill,
00459                                 Console,
00460                                 <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>,
00461                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00462                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00463                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00464                                 ConsoleInfo-&gt;uCursorSize,
00465                                 ConsoleInfo-&gt;FaceName
00466                                );
00467     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_NO_MEMORY) {
00468         <span class="comment">//</span>
00469         <span class="comment">// If we failed to create a large buffer, try again with a small one.</span>
00470         <span class="comment">//</span>
00471         <span class="keywordflow">if</span> (dwScreenBufferSize.X &gt; 80 || dwScreenBufferSize.Y &gt; 50) {
00472             dwScreenBufferSize.X = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(dwScreenBufferSize.X, 80);
00473             dwScreenBufferSize.Y = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(dwScreenBufferSize.Y, 50);
00474             dwWindowSize.X = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(dwWindowSize.X, dwScreenBufferSize.X);
00475             dwWindowSize.Y = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(dwWindowSize.Y, dwScreenBufferSize.Y);
00476             Console-&gt;Flags |= <a class="code" href="../../d1/d7/server_8h.html#a24">CONSOLE_DEFAULT_BUFFER_SIZE</a>;
00477             <span class="keywordflow">goto</span> TryNewSize;
00478         }
00479     }
00480 
00481     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00482 }
00483 
00484 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00485"></a><a class="code" href="../../d6/d2/output_8c.html#a42">00485</a> <a class="code" href="../../d6/d2/output_8c.html#a42">CreateScreenBuffer</a>(
00486     OUT <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> *ScreenInformation,
00487     IN COORD dwWindowSize,
00488     IN DWORD nFont,
00489     IN COORD dwScreenBufferSize,
00490     IN CHAR_INFO Fill,
00491     IN CHAR_INFO PopupFill,
00492     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
00493     IN DWORD Flags,
00494     IN PCONSOLE_GRAPHICS_BUFFER_INFO GraphicsBufferInfo OPTIONAL,
00495     OUT PVOID *lpBitmap OPTIONAL,
00496     OUT HANDLE *hMutex OPTIONAL,
00497     IN UINT CursorSize,
00498     IN LPWSTR FaceName
00499     )
00500 
00501 <span class="comment">/*++</span>
00502 <span class="comment"></span>
00503 <span class="comment">Routine Description:</span>
00504 <span class="comment"></span>
00505 <span class="comment">    This routine allocates and initializes the data associated with a screen</span>
00506 <span class="comment">    buffer.  It also creates a window.</span>
00507 <span class="comment"></span>
00508 <span class="comment">Arguments:</span>
00509 <span class="comment"></span>
00510 <span class="comment">    ScreenInformation - the new screen buffer.</span>
00511 <span class="comment"></span>
00512 <span class="comment">    dwWindowSize - the initial size of screen buffer's window (in rows/columns)</span>
00513 <span class="comment"></span>
00514 <span class="comment">    nFont - the initial font to generate text with.</span>
00515 <span class="comment"></span>
00516 <span class="comment">    dwScreenBufferSize - the initial size of the screen buffer (in rows/columns).</span>
00517 <span class="comment"></span>
00518 <span class="comment">Return Value:</span>
00519 <span class="comment"></span>
00520 <span class="comment"></span>
00521 <span class="comment">--*/</span>
00522 
00523 {
00524     LONG i,j;
00525     <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo;
00526     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00527     PWCHAR TextRowPtr;
00528 <span class="preprocessor">#if defined(FE_SB)</span>
00529 <span class="preprocessor"></span>    <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a> AttrRowPtr;
00530 <span class="preprocessor">#endif</span>
00531 <span class="preprocessor"></span>    <a class="code" href="../../d0/d9/struct__WINDOW__LIMITS.html">WINDOW_LIMITS</a> WindowLimits;
00532 
00533     <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"CreateScreenBuffer(\n"</span>
00534               <span class="stringliteral">"    OUT PSCREEN_INFORMATION = %lx\n"</span>
00535               <span class="stringliteral">"    dwWindowSize = (%d,%d)\n"</span>
00536               <span class="stringliteral">"    nFont = %x\n"</span>
00537               <span class="stringliteral">"    dwScreenBufferSize = (%d,%d)\n"</span>
00538               <span class="stringliteral">"    Fill\n"</span>
00539               <span class="stringliteral">"    PopupFill\n"</span>,
00540               ScreenInformation,
00541               dwWindowSize.X, dwWindowSize.Y,
00542               nFont,
00543               dwScreenBufferSize.X, dwScreenBufferSize.Y
00544               <span class="comment">// Fill,</span>
00545               <span class="comment">// PopupFill</span>
00546               ));
00547     <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"    PCONSOLE_INFORMATION = %lx\n"</span>
00548               <span class="stringliteral">"    Flags = %lx\n"</span>
00549               <span class="stringliteral">"    GraphicsBufferInfo\n"</span>
00550               <span class="stringliteral">"    lpBitmap\n"</span>
00551               <span class="stringliteral">"    *hMutex\n"</span>
00552               <span class="stringliteral">"    ConsoleTitle \"%ls\"\n"</span>,
00553               Console,
00554               Flags,
00555               <span class="comment">// GraphicsBufferInfo,</span>
00556               <span class="comment">// lpBitmap,</span>
00557               <span class="comment">// hMutex,</span>
00558               Console-&gt;Title));
00559 
00560     <span class="comment">/*</span>
00561 <span class="comment">     * Make sure we have a valid font. Bail if no fonts are available.</span>
00562 <span class="comment">     */</span>
00563     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(nFont &lt; <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a27">NumberOfFonts</a>);
00564     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a27">NumberOfFonts</a> == 0) {
00565         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
00566     }
00567 
00568     <span class="comment">/*</span>
00569 <span class="comment">     * CONSIDER (adams): Allocate and zero memory, so</span>
00570 <span class="comment">     * initialization is only of non-zero members.</span>
00571 <span class="comment">     */</span>
00572     ScreenInfo = (<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a>)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a20">SCREEN_TAG</a> ),<span class="keyword">sizeof</span>(<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">SCREEN_INFORMATION</a>));
00573     <span class="keywordflow">if</span> (ScreenInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00574         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00575     }
00576     ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o0">Console</a> = Console;
00577     <span class="keywordflow">if</span> ((ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o1">Flags</a> = Flags) &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>) {
00578 
00579         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[nFont].FaceName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00580 
00581         ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.ListOfTextBufferFont = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00582 
00583         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a27">StoreTextBufferFontInfo</a>(ScreenInfo,
00584                                          nFont,
00585                                          <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[nFont].<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>,
00586                                          <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[nFont].Family,
00587                                          <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[nFont].Weight,
00588                                          FaceName ? FaceName : <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[nFont].FaceName,
00589                                          Console-&gt;OutputCP);
00590         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00591             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(ScreenInfo);
00592             <span class="keywordflow">return</span>((ULONG) <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00593         }
00594 
00595         <a class="code" href="../../d8/d5/consrv_8h.html#a0">DBGFONTS</a>((<span class="stringliteral">"DoCreateScreenBuffer sets FontSize(%d,%d), FontNumber=%x, Family=%x\n"</span>,
00596                 <a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(ScreenInfo).X,
00597                 <a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(ScreenInfo).Y,
00598                 <a class="code" href="../../d8/d5/consrv_8h.html#a64">SCR_FONTNUMBER</a>(ScreenInfo),
00599                 <a class="code" href="../../d8/d5/consrv_8h.html#a63">SCR_FAMILY</a>(ScreenInfo)));
00600 
00601         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d6/font_8h.html#a2">TM_IS_TT_FONT</a>(<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[nFont].Family)) {
00602             ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o1">Flags</a> &amp;= ~<a class="code" href="../../d7/d2/output_8h.html#a2">CONSOLE_OEMFONT_DISPLAY</a>;
00603         } <span class="keywordflow">else</span> {
00604             ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o1">Flags</a> |= <a class="code" href="../../d7/d2/output_8h.html#a2">CONSOLE_OEMFONT_DISPLAY</a>;
00605         }
00606 
00607         ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a> = dwScreenBufferSize;
00608         <a class="code" href="../../d6/d2/output_8c.html#a39">GetWindowLimits</a>(ScreenInfo, &amp;WindowLimits);
00609         dwScreenBufferSize.X = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(dwScreenBufferSize.X, WindowLimits.<a class="code" href="../../d0/d9/struct__WINDOW__LIMITS.html#o0">MinimumWindowSize</a>.X);
00610         dwWindowSize.X = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(dwWindowSize.X, WindowLimits.<a class="code" href="../../d0/d9/struct__WINDOW__LIMITS.html#o0">MinimumWindowSize</a>.X);
00611 
00612         ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.ModeIndex = (ULONG)-1;
00613 <span class="preprocessor">#ifdef i386</span>
00614 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (Console-&gt;FullScreenFlags &amp; CONSOLE_FULLSCREEN) {
00615             COORD WindowSize;
00616             ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.WindowedWindowSize = dwWindowSize;
00617             ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.WindowedScreenSize = dwScreenBufferSize;
00618             ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.ModeIndex = MatchWindowSize(Console-&gt;OutputCP,dwWindowSize,&amp;WindowSize);
00619         }
00620 <span class="preprocessor">#endif</span>
00621 <span class="preprocessor"></span>        ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.FirstRow = 0;
00622         ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.Rows = (<a class="code" href="../../d9/d4/struct__ROW.html">PROW</a>)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a20">SCREEN_TAG</a> ),dwScreenBufferSize.Y * <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d4/struct__ROW.html">ROW</a>));
00623         <span class="keywordflow">if</span> (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.Rows == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00624             <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a28">RemoveTextBufferFontInfo</a>(ScreenInfo);
00625             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(ScreenInfo);
00626             <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00627         }
00628         ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.TextRows = (PWCHAR)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a20">SCREEN_TAG</a> ),dwScreenBufferSize.X*dwScreenBufferSize.Y*<span class="keyword">sizeof</span>(WCHAR));
00629         <span class="keywordflow">if</span> (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.TextRows == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00630             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.Rows);
00631             <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a28">RemoveTextBufferFontInfo</a>(ScreenInfo);
00632             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(ScreenInfo);
00633             <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00634         }
00635 <span class="preprocessor">#if defined(FE_SB)</span>
00636 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (! <a class="code" href="../../d6/d2/output_8c.html#a86">CreateDbcsScreenBuffer</a>(Console, dwScreenBufferSize,&amp;ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.DbcsScreenBuffer))
00637         {
00638             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.TextRows);
00639             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.Rows);
00640             <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a28">RemoveTextBufferFontInfo</a>(ScreenInfo);
00641             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(ScreenInfo);
00642             <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00643         }
00644 
00645         AttrRowPtr=ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.DbcsScreenBuffer.KAttrRows;
00646 <span class="preprocessor">#endif</span>
00647 <span class="preprocessor"></span>        <span class="keywordflow">for</span> (i=0,TextRowPtr=ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.TextRows;
00648              i&lt;dwScreenBufferSize.Y;
00649              i++,TextRowPtr+=dwScreenBufferSize.X)
00650         {
00651             ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.Rows[i].CharRow.Left = dwScreenBufferSize.X;
00652             ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.Rows[i].CharRow.OldLeft = <a class="code" href="../../d7/d2/output_8h.html#a5">INVALID_OLD_LENGTH</a>;
00653             ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.Rows[i].CharRow.Right = 0;
00654             ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.Rows[i].CharRow.OldRight = <a class="code" href="../../d7/d2/output_8h.html#a5">INVALID_OLD_LENGTH</a>;
00655             ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.Rows[i].CharRow.Chars = TextRowPtr;
00656 <span class="preprocessor">#if defined(FE_SB)</span>
00657 <span class="preprocessor"></span>            ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.Rows[i].CharRow.KAttrs = AttrRowPtr;
00658 <span class="preprocessor">#endif</span>
00659 <span class="preprocessor"></span>            <span class="keywordflow">for</span> (j=0;j&lt;dwScreenBufferSize.X;j++) {
00660                 TextRowPtr[j] = (WCHAR)<span class="charliteral">' '</span>;
00661             }
00662 <span class="preprocessor">#if defined(FE_SB)</span>
00663 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (AttrRowPtr) {
00664                 RtlZeroMemory(AttrRowPtr, dwScreenBufferSize.X);
00665                 AttrRowPtr+=dwScreenBufferSize.X;
00666             }
00667 <span class="preprocessor">#endif</span>
00668 <span class="preprocessor"></span>            ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.Rows[i].AttrRow.Length = 1;
00669             ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.Rows[i].AttrRow.AttrPair.Length = dwScreenBufferSize.X;
00670             ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.Rows[i].AttrRow.AttrPair.Attr = Fill.Attributes;
00671             ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.Rows[i].AttrRow.Attrs = &amp;ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.Rows[i].AttrRow.AttrPair;
00672 
00673         }
00674         ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorSize = CursorSize;
00675         ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.X = 0;
00676         ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorPosition.Y = 0;
00677         ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorMoved = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00678         ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorVisible = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00679         ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorOn = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00680         ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorYSize = (WORD)<a class="code" href="../../d7/d2/output_8h.html#a7">CURSOR_SIZE_IN_PIXELS</a>(<a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(ScreenInfo).Y,ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorSize);
00681         ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.UpdatingScreen = 0;
00682         ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.DoubleCursor = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00683         ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.DelayCursor = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00684         ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.Flags = <a class="code" href="../../d7/d2/output_8h.html#a4">SINGLE_ATTRIBUTES_PER_LINE</a>;
00685         ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a> = dwScreenBufferSize;
00686         ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Left = 0;
00687         ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Top = 0;
00688         ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Right = dwWindowSize.X - 1;
00689         ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Bottom = dwWindowSize.Y - 1;
00690         <span class="keywordflow">if</span> (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Right &gt;= WindowLimits.<a class="code" href="../../d0/d9/struct__WINDOW__LIMITS.html#o1">MaximumWindowSize</a>.X) {
00691             ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Right = WindowLimits.<a class="code" href="../../d0/d9/struct__WINDOW__LIMITS.html#o1">MaximumWindowSize</a>.X-1;
00692             dwWindowSize.X = <a class="code" href="../../d7/d2/output_8h.html#a17">CONSOLE_WINDOW_SIZE_X</a>(ScreenInfo);
00693         }
00694         <span class="keywordflow">if</span> (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Bottom &gt;= WindowLimits.<a class="code" href="../../d0/d9/struct__WINDOW__LIMITS.html#o1">MaximumWindowSize</a>.Y) {
00695             ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Bottom = WindowLimits.<a class="code" href="../../d0/d9/struct__WINDOW__LIMITS.html#o1">MaximumWindowSize</a>.Y-1;
00696             dwWindowSize.Y = <a class="code" href="../../d7/d2/output_8h.html#a18">CONSOLE_WINDOW_SIZE_Y</a>(ScreenInfo);
00697         }
00698         ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o10">WindowMaximizedX</a> = (dwWindowSize.X == dwScreenBufferSize.X);
00699         ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o11">WindowMaximizedY</a> = (dwWindowSize.Y == dwScreenBufferSize.Y);
00700 <span class="preprocessor">#if defined(FE_SB)</span>
00701 <span class="preprocessor"></span><span class="preprocessor">#if defined(_X86_)</span>
00702 <span class="preprocessor"></span>        ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.MousePosition.X = 0;
00703         ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.MousePosition.Y = 0;
00704 <span class="preprocessor">#endif // i386</span>
00705 <span class="preprocessor"></span>
00706         ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorBlink = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00707         ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorDBEnable = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00708 <span class="preprocessor">#endif</span>
00709 <span class="preprocessor"></span>
00710     }
00711     <span class="keywordflow">else</span> {
00712         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d5/consrv_8h.html#a273">CreateConsoleBitmap</a>(GraphicsBufferInfo,
00713                               ScreenInfo,
00714                               lpBitmap,
00715                               hMutex
00716                              );
00717         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00718             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(ScreenInfo);
00719             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00720         }
00721         ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o10">WindowMaximizedX</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00722         ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o11">WindowMaximizedY</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00723     }
00724 
00725     ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o12">WindowMaximized</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00726     ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o3">RefCount</a> = 0;
00727     ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o4">ShareAccess</a>.<a class="code" href="../../d8/d6/struct__CONSOLE__SHARE__ACCESS.html#o0">OpenCount</a> = 0;
00728     ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o4">ShareAccess</a>.<a class="code" href="../../d8/d6/struct__CONSOLE__SHARE__ACCESS.html#o1">Readers</a> = 0;
00729     ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o4">ShareAccess</a>.<a class="code" href="../../d8/d6/struct__CONSOLE__SHARE__ACCESS.html#o2">Writers</a> = 0;
00730     ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o4">ShareAccess</a>.<a class="code" href="../../d8/d6/struct__CONSOLE__SHARE__ACCESS.html#o3">SharedRead</a> = 0;
00731     ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o4">ShareAccess</a>.<a class="code" href="../../d8/d6/struct__CONSOLE__SHARE__ACCESS.html#o4">SharedWrite</a> = 0;
00732     ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o15">CursorHandle</a> = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a7">ghNormalCursor</a>;
00733     ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o18">CursorDisplayCount</a> = 0;
00734     ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o13">CommandIdLow</a> = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)-1;
00735     ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o14">CommandIdHigh</a> = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)-1;
00736     ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o17">dwUsage</a> = SYSPAL_STATIC;
00737     ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o16">hPalette</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00738 
00739     ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o2">OutputMode</a> = ENABLE_PROCESSED_OUTPUT | ENABLE_WRAP_AT_EOL_OUTPUT;
00740 
00741 
00742     ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o7">ResizingWindow</a> = 0;
00743     ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o23">Next</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00744     ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o8">Attributes</a> = Fill.Attributes;
00745     ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o9">PopupAttributes</a> = PopupFill.Attributes;
00746 
00747     ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o19">WheelDelta</a> = 0;
00748 
00749 <span class="preprocessor">#if defined(FE_SB)</span>
00750 <span class="preprocessor"></span>    ScreenInfo-&gt;WriteConsoleDbcsLeadByte[0] = 0;
00751     ScreenInfo-&gt;BisectFlag = 0;
00752     <span class="keywordflow">if</span> (Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>) {
00753         <a class="code" href="../../d0/d3/dbcs_8h.html#a29">SetLineChar</a>(ScreenInfo);
00754     }
00755     ScreenInfo-&gt;FillOutDbcsLeadChar = 0;
00756     ScreenInfo-&gt;ConvScreenInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00757 <span class="preprocessor">#endif</span>
00758 <span class="preprocessor"></span>
00759     *ScreenInformation = ScreenInfo;
00760     <a class="code" href="../../d8/d5/consrv_8h.html#a3">DBGOUTPUT</a>((<span class="stringliteral">"SCREEN at %lx\n"</span>, ScreenInfo));
00761     <span class="keywordflow">return</span> STATUS_SUCCESS;
00762 }
00763 
00764 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00765"></a><a class="code" href="../../d6/d2/output_8c.html#a43">00765</a> <a class="code" href="../../d6/d2/output_8c.html#a43">PositionConsoleWindow</a>(
00766     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
00767     IN BOOL Initialize
00768     )
00769 {
00770     <a class="code" href="../../d3/d9/client_2wow_8c.html#a26">GetWindowRect</a>(Console-&gt;hWnd, &amp;Console-&gt;WindowRect);
00771 
00772     <span class="comment">//</span>
00773     <span class="comment">// If this is an autoposition window being initialized, make sure it's</span>
00774     <span class="comment">// client area doesn't descend below the tray</span>
00775     <span class="comment">//</span>
00776 
00777     <span class="keywordflow">if</span> (Initialize &amp;&amp; (Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a16">CONSOLE_AUTO_POSITION</a>)) {
00778         RECT ClientRect;
00779         LONG dx = 0;
00780         LONG dy = 0;
00781         HMONITOR hMonitor;
00782         MONITORINFO MonitorInfo = {<span class="keyword">sizeof</span>(MonitorInfo)};
00783 
00784         hMonitor = <a class="code" href="../../d3/d1/mmcl_8c.html#a1">MonitorFromRect</a>(&amp;Console-&gt;WindowRect, MONITOR_DEFAULTTONULL);
00785         <span class="keywordflow">if</span> (hMonitor &amp;&amp; <a class="code" href="../../d5/d9/cltxt_8h.html#a38">GetMonitorInfo</a>(hMonitor, &amp;MonitorInfo)) {
00786             <a class="code" href="../../d3/d9/client_2wow_8c.html#a24">GetClientRect</a>(Console-&gt;hWnd, &amp;ClientRect);
00787             <a class="code" href="../../d3/d9/client_2wow_8c.html#a23">ClientToScreen</a>(Console-&gt;hWnd, (LPPOINT)&amp;ClientRect.left);
00788             <a class="code" href="../../d3/d9/client_2wow_8c.html#a23">ClientToScreen</a>(Console-&gt;hWnd, (LPPOINT)&amp;ClientRect.right);
00789             <span class="keywordflow">if</span> (Console-&gt;WindowRect.right &gt; MonitorInfo.rcWork.right) {
00790                 dx = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(<a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>((Console-&gt;WindowRect.right - MonitorInfo.rcWork.right),
00791                              (Console-&gt;WindowRect.left - MonitorInfo.rcWork.left)),
00792                          <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>((ClientRect.right - MonitorInfo.rcWork.right),
00793                              (ClientRect.left - MonitorInfo.rcWork.left)));
00794             }
00795             <span class="keywordflow">if</span> (Console-&gt;WindowRect.bottom &gt; MonitorInfo.rcWork.bottom) {
00796                 dy = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(<a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>((Console-&gt;WindowRect.bottom - MonitorInfo.rcWork.bottom),
00797                              (Console-&gt;WindowRect.top - MonitorInfo.rcWork.top)),
00798                          <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>((ClientRect.bottom - MonitorInfo.rcWork.bottom),
00799                              (ClientRect.top - MonitorInfo.rcWork.top)));
00800             }
00801             <span class="keywordflow">if</span> (dx || dy) {
00802                 <a class="code" href="../../d3/d4/w32_2ntuser_2client_2nt6_2pch_8h.html#a0">SetWindowPos</a>(Console-&gt;hWnd,
00803                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00804                              Console-&gt;WindowRect.left - dx,
00805                              Console-&gt;WindowRect.top - dy,
00806                              0,
00807                              0,
00808                              SWP_NOACTIVATE | SWP_NOSIZE | SWP_NOZORDER);
00809             }
00810         }
00811     }
00812 }
00813 
00814 <span class="comment">/*</span>
00815 <span class="comment"> * Bug 273518 - joejo</span>
00816 <span class="comment"> *</span>
00817 <span class="comment"> * This will allow console windows to set foreground correctly on new</span>
00818 <span class="comment"> * process' it launches, as opposed it just forcing foreground.</span>
00819 <span class="comment"> */</span>
00820 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00821"></a><a class="code" href="../../d6/d2/output_8c.html#a44">00821</a> <a class="code" href="../../d6/d2/output_8c.html#a44">ConsoleSetActiveWindow</a>(
00822     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console
00823     )
00824 {
00825     HWND <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a> = Console-&gt;hWnd;
00826     HANDLE ConsoleHandle = Console-&gt;ConsoleHandle;
00827 
00828     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
00829     SetActiveWindow(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>);
00830     <span class="keywordflow">return</span> <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a34">RevalidateConsole</a>(ConsoleHandle, &amp;Console);
00831 }
00832 
00833 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00834"></a><a class="code" href="../../d6/d2/output_8c.html#a45">00834</a> <a class="code" href="../../d6/d2/output_8c.html#a45">CreateWindowsWindow</a>(
00835     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console
00836     )
00837 {
00838     <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo;
00839     SIZE WindowSize;
00840     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> Style;
00841     THREAD_BASIC_INFORMATION ThreadInfo;
00842     HWND <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>;
00843 
00844     ScreenInfo = Console-&gt;ScreenBuffers;
00845 
00846     <span class="comment">//</span>
00847     <span class="comment">// figure out how big to make the window, given the desired client area</span>
00848     <span class="comment">// size.  window is always created in textmode.</span>
00849     <span class="comment">//</span>
00850 
00851     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o1">Flags</a> &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>);
00852     WindowSize.cx = <a class="code" href="../../d7/d2/output_8h.html#a17">CONSOLE_WINDOW_SIZE_X</a>(ScreenInfo)*<a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(ScreenInfo).X + <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a19">VerticalClientToWindow</a>;
00853     WindowSize.cy = <a class="code" href="../../d7/d2/output_8h.html#a18">CONSOLE_WINDOW_SIZE_Y</a>(ScreenInfo)*<a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(ScreenInfo).Y + <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a20">HorizontalClientToWindow</a>;
00854     Style = <a class="code" href="../../d7/d2/output_8h.html#a13">CONSOLE_WINDOW_FLAGS</a> &amp; ~WS_VISIBLE;
00855     <span class="keywordflow">if</span> (!ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o10">WindowMaximizedX</a>) {
00856         WindowSize.cy += <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a18">HorizontalScrollSize</a>;
00857     } <span class="keywordflow">else</span> {
00858         Style &amp;= ~WS_HSCROLL;
00859     }
00860     <span class="keywordflow">if</span> (!ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o11">WindowMaximizedY</a>) {
00861         WindowSize.cx += <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a17">VerticalScrollSize</a>;
00862     } <span class="keywordflow">else</span> {
00863         Style &amp;= ~WS_VSCROLL;
00864     }
00865 <span class="preprocessor">#ifdef THERESES_DEBUG</span>
00866 <span class="preprocessor"></span>    <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"creating window with char size %d %d\n"</span>,<a class="code" href="../../d7/d2/output_8h.html#a17">CONSOLE_WINDOW_SIZE_X</a>(ScreenInfo),<a class="code" href="../../d7/d2/output_8h.html#a18">CONSOLE_WINDOW_SIZE_Y</a>(ScreenInfo));
00867     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"                     pixel size %d %d\n"</span>,WindowSize.cx,WindowSize.cy);
00868 <span class="preprocessor">#endif</span>
00869 <span class="preprocessor"></span>
00870     <span class="comment">//</span>
00871     <span class="comment">// create the window.</span>
00872     <span class="comment">//</span>
00873 
00874     Console-&gt;WindowRect.left = Console-&gt;dwWindowOriginX;
00875     Console-&gt;WindowRect.top = Console-&gt;dwWindowOriginY;
00876     Console-&gt;WindowRect.right = WindowSize.cx + Console-&gt;dwWindowOriginX;
00877     Console-&gt;WindowRect.bottom = WindowSize.cy + Console-&gt;dwWindowOriginY;
00878     <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a> = <a class="code" href="../../d5/d9/cltxt_8h.html#a10">CreateWindowEx</a>(<a class="code" href="../../d7/d2/output_8h.html#a14">CONSOLE_WINDOW_EX_FLAGS</a>,
00879                           <a class="code" href="../../d1/d7/server_8h.html#a93">CONSOLE_WINDOW_CLASS</a>,
00880                           Console-&gt;Title,
00881                           Style,
00882                           Console-&gt;dwWindowOriginX,
00883                           Console-&gt;dwWindowOriginY,
00884                           WindowSize.cx,
00885                           WindowSize.cy,
00886                           (Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a8">CONSOLE_NO_WINDOW</a>) ? HWND_MESSAGE : HWND_DESKTOP,
00887                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00888                           <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a4">ghInstance</a>,
00889                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00890     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00891         <a class="code" href="../../d0/d8/ex_2event_8c.html#a10">NtSetEvent</a>(Console-&gt;InitEvents[<a class="code" href="../../d5/d5/conmsg_8h.html#a5">INITIALIZATION_FAILED</a>],<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00892         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00893     }
00894     Console-&gt;hWnd = <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>;
00895 
00896     <a class="code" href="../../d6/d2/output_8c.html#a8">SetWindowConsole</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, Console);
00897 
00898     <span class="comment">//</span>
00899     <span class="comment">// Stuff the client id into the window so USER can find it.</span>
00900     <span class="comment">//</span>
00901 
00902     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d9/d1/psquery_8c.html#a20">NtQueryInformationThread</a>(Console-&gt;ClientThreadHandle,
00903             ThreadBasicInformation, &amp;ThreadInfo,
00904             <span class="keyword">sizeof</span>(ThreadInfo), <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>))) {
00905 
00906         <a class="code" href="../../d8/d5/consrv_8h.html#a23">SetConsolePid</a>(Console-&gt;hWnd, HandleToUlong(ThreadInfo.ClientId.UniqueProcess));
00907         <a class="code" href="../../d8/d5/consrv_8h.html#a24">SetConsoleTid</a>(Console-&gt;hWnd, HandleToUlong(ThreadInfo.ClientId.UniqueThread));
00908     }
00909 
00910     <span class="comment">//</span>
00911     <span class="comment">// Get the dc.</span>
00912     <span class="comment">//</span>
00913 
00914     Console-&gt;hDC = <a class="code" href="../../d3/d4/w32_2ntuser_2client_2nt6_2pch_8h.html#a1">GetDC</a>(Console-&gt;hWnd);
00915 
00916     <span class="keywordflow">if</span> (Console-&gt;hDC == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00917         <a class="code" href="../../d0/d8/ex_2event_8c.html#a10">NtSetEvent</a>(Console-&gt;InitEvents[<a class="code" href="../../d5/d5/conmsg_8h.html#a5">INITIALIZATION_FAILED</a>],<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00918         <a class="code" href="../../d3/d4/w32_2ntuser_2client_2nt6_2pch_8h.html#a3">DestroyWindow</a>(Console-&gt;hWnd);
00919         Console-&gt;hWnd = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00920         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00921     }
00922     Console-&gt;hMenu = GetSystemMenu(Console-&gt;hWnd,<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00923 
00924     <span class="comment">//</span>
00925     <span class="comment">// modify system menu to our liking.</span>
00926     <span class="comment">//</span>
00927 
00928     <a class="code" href="../../d1/d7/ntcon_2server_2menu_8c.html#a1">InitSystemMenu</a>(Console);
00929 
00930     <a class="code" href="../../d6/d2/output_8c.html#a22">gnConsoleWindows</a>++;
00931     Console-&gt;InputThreadInfo-&gt;WindowCount++;
00932 
00933 <span class="preprocessor">#if defined(FE_IME)</span>
00934 <span class="preprocessor"></span>    SetUndetermineAttribute(Console);
00935 <span class="preprocessor">#endif</span>
00936 <span class="preprocessor"></span><span class="preprocessor">#if defined(FE_SB)</span>
00937 <span class="preprocessor"></span>    <a class="code" href="../../d0/d3/dbcs_8h.html#a52">RegisterKeisenOfTTFont</a>(ScreenInfo);
00938 <span class="preprocessor">#endif</span>
00939 <span class="preprocessor"></span>
00940     <span class="comment">//</span>
00941     <span class="comment">// Set up the hot key for this window</span>
00942     <span class="comment">//</span>
00943     <span class="keywordflow">if</span> ((Console-&gt;dwHotKey != 0) &amp;&amp; !(Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a8">CONSOLE_NO_WINDOW</a>)) {
00944         <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(Console-&gt;hWnd, WM_SETHOTKEY, Console-&gt;dwHotKey, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
00945     }
00946 
00947     <span class="comment">//</span>
00948     <span class="comment">// create icon</span>
00949     <span class="comment">//</span>
00950 
00951     <span class="keywordflow">if</span> (Console-&gt;iIconId) {
00952 
00953         <span class="comment">// We have no icon, try and get one from progman.</span>
00954 
00955         <a class="code" href="../../d0/d8/ntcftxt_8h.html#a20">PostMessage</a>(HWND_BROADCAST,
00956                     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a23">ProgmanHandleMessage</a>,
00957                     (WPARAM)Console-&gt;hWnd,
00958                     1);
00959     }
00960     <span class="keywordflow">if</span> (Console-&gt;hIcon == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00961         Console-&gt;hIcon = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a5">ghDefaultIcon</a>;
00962         Console-&gt;hSmIcon = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a6">ghDefaultSmIcon</a>;
00963     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Console-&gt;hIcon != <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a5">ghDefaultIcon</a>) {
00964         <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(Console-&gt;hWnd, WM_SETICON, ICON_BIG, (LPARAM)Console-&gt;hIcon);
00965         <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(Console-&gt;hWnd, WM_SETICON, ICON_SMALL, (LPARAM)Console-&gt;hSmIcon);
00966     }
00967 
00968     SetBkMode(Console-&gt;hDC,OPAQUE);
00969     <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a34">SetFont</a>(ScreenInfo);
00970     SelectObject(Console-&gt;hDC, GetStockObject(DC_BRUSH));
00971     <a class="code" href="../../d9/d4/ntcon_2server_2getset_8c.html#a20">SetScreenColors</a>(ScreenInfo, ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o8">Attributes</a>,
00972                     ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o9">PopupAttributes</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00973     <span class="keywordflow">if</span> (Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a8">CONSOLE_NO_WINDOW</a>) {
00974         ShowWindowAsync(Console-&gt;hWnd, SW_HIDE);
00975 <span class="preprocessor">#ifdef i386</span>
00976 <span class="preprocessor"></span>    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Console-&gt;FullScreenFlags != 0) {
00977         <span class="keywordflow">if</span> (Console-&gt;wShowWindow == SW_SHOWMINNOACTIVE) {
00978             ShowWindowAsync(Console-&gt;hWnd, Console-&gt;wShowWindow);
00979             Console-&gt;FullScreenFlags = 0;
00980             Console-&gt;Flags |= <a class="code" href="../../d1/d7/server_8h.html#a0">CONSOLE_IS_ICONIC</a>;
00981         } <span class="keywordflow">else</span> {
00982             <a class="code" href="../../d7/d4/server_2private_8c.html#a48">ConvertToFullScreen</a>(Console);
00983             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d6/d2/output_8c.html#a44">ConsoleSetActiveWindow</a>(Console))) {
00984                 <span class="keywordflow">return</span> STATUS_INVALID_HANDLE;
00985             }
00986 
00987             <a class="code" href="../../d8/d5/consrv_8h.html#a293">ChangeDispSettings</a>(Console, Console-&gt;hWnd,CDS_FULLSCREEN);
00988         }
00989 <span class="preprocessor">#endif</span>
00990 <span class="preprocessor"></span>    } <span class="keywordflow">else</span> {
00991         <span class="keywordflow">if</span> (Console-&gt;wShowWindow != SW_SHOWNOACTIVATE &amp;&amp;
00992             Console-&gt;wShowWindow != SW_SHOWMINNOACTIVE &amp;&amp;
00993             Console-&gt;wShowWindow != SW_HIDE) {
00994             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d6/d2/output_8c.html#a44">ConsoleSetActiveWindow</a>(Console))) {
00995                 <span class="keywordflow">return</span> STATUS_INVALID_HANDLE;
00996             }
00997         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Console-&gt;wShowWindow == SW_SHOWMINNOACTIVE) {
00998             Console-&gt;Flags |= <a class="code" href="../../d1/d7/server_8h.html#a0">CONSOLE_IS_ICONIC</a>;
00999         }
01000         ShowWindowAsync(Console-&gt;hWnd, Console-&gt;wShowWindow);
01001     }
01002 
01003     <span class="comment">//UpdateWindow(Console-&gt;hWnd);</span>
01004     <a class="code" href="../../d6/d2/output_8c.html#a37">InternalUpdateScrollBars</a>(ScreenInfo);
01005     <span class="keywordflow">if</span> (!(Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a0">CONSOLE_IS_ICONIC</a>) &amp;&amp;
01006          (Console-&gt;FullScreenFlags == 0) ) {
01007 
01008         <a class="code" href="../../d6/d2/output_8c.html#a43">PositionConsoleWindow</a>(Console, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01009     }
01010 
01011 <span class="preprocessor">#if defined(FE_IME)</span>
01012 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/consrv_8h.html#a33">CONSOLE_IS_IME_ENABLED</a>() &amp;&amp; !(Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a8">CONSOLE_NO_WINDOW</a>)) {
01013         <a class="code" href="../../d3/d0/user32_8def.html#a56">SetTimer</a>(Console-&gt;hWnd, SCROLL_WAIT_TIMER, <a class="code" href="../../d6/d2/output_8c.html#a28">guCaretBlinkTime</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01014     }
01015 <span class="preprocessor">#endif</span>
01016 <span class="preprocessor"></span>    <a class="code" href="../../d0/d8/ex_2event_8c.html#a10">NtSetEvent</a>(Console-&gt;InitEvents[<a class="code" href="../../d5/d5/conmsg_8h.html#a4">INITIALIZATION_SUCCEEDED</a>],<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01017     <span class="keywordflow">return</span> STATUS_SUCCESS;
01018 }
01019 
01020 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01021"></a><a class="code" href="../../d6/d2/output_8c.html#a46">01021</a> <a class="code" href="../../d6/d2/output_8c.html#a46">FreeScreenBuffer</a>(
01022     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo
01023     )
01024 
01025 <span class="comment">/*++</span>
01026 <span class="comment"></span>
01027 <span class="comment">Routine Description:</span>
01028 <span class="comment"></span>
01029 <span class="comment">    This routine frees the memory associated with a screen buffer.</span>
01030 <span class="comment"></span>
01031 <span class="comment">Arguments:</span>
01032 <span class="comment"></span>
01033 <span class="comment">    ScreenInfo - screen buffer data to free.</span>
01034 <span class="comment"></span>
01035 <span class="comment">Return Value:</span>
01036 <span class="comment"></span>
01037 <span class="comment">Note: console handle table lock must be held when calling this routine</span>
01038 <span class="comment"></span>
01039 <span class="comment">--*/</span>
01040 
01041 {
01042     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> i;
01043     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console = ScreenInfo-&gt;Console;
01044 
01045     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ScreenInfo-&gt;RefCount == 0);
01046     <span class="keywordflow">if</span> (ScreenInfo-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>) {
01047         <span class="keywordflow">for</span> (i=0;i&lt;ScreenInfo-&gt;ScreenBufferSize.Y;i++) {
01048             <span class="keywordflow">if</span> (ScreenInfo-&gt;BufferInfo.TextInfo.Rows[i].AttrRow.Length &gt; 1) {
01049                 <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(ScreenInfo-&gt;BufferInfo.TextInfo.Rows[i].AttrRow.Attrs);
01050             }
01051         }
01052         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(ScreenInfo-&gt;BufferInfo.TextInfo.TextRows);
01053         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(ScreenInfo-&gt;BufferInfo.TextInfo.Rows);
01054 <span class="preprocessor">#if defined(FE_SB)</span>
01055 <span class="preprocessor"></span>        <a class="code" href="../../d6/d2/output_8c.html#a87">DeleteDbcsScreenBuffer</a>(&amp;ScreenInfo-&gt;BufferInfo.TextInfo.DbcsScreenBuffer);
01056 <span class="preprocessor">#endif</span>
01057 <span class="preprocessor"></span>        <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a28">RemoveTextBufferFontInfo</a>(ScreenInfo);
01058     } <span class="keywordflow">else</span> {
01059         <span class="keywordflow">if</span> (ScreenInfo-&gt;hPalette != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01060             <span class="keywordflow">if</span> (GetCurrentObject(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o10">hDC</a>, OBJ_PAL) == ScreenInfo-&gt;hPalette) {
01061                 <a class="code" href="../../d3/d0/user32_8def.html#a83">SelectPalette</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o10">hDC</a>, Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o13">hSysPalette</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01062             }
01063             DeleteObject(ScreenInfo-&gt;hPalette);
01064         }
01065         <a class="code" href="../../d6/d2/output_8c.html#a32">FreeConsoleBitmap</a>(ScreenInfo);
01066     }
01067     <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(ScreenInfo);
01068     <span class="keywordflow">return</span> STATUS_SUCCESS;
01069 }
01070 
01071 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01072"></a><a class="code" href="../../d6/d2/output_8c.html#a47">01072</a> <a class="code" href="../../d6/d2/output_8c.html#a47">FindAttrIndex</a>(
01073     IN <a class="code" href="../../d3/d2/struct__ATTR__PAIR.html">PATTR_PAIR</a> String,
01074     IN SHORT Index,
01075     OUT <a class="code" href="../../d3/d2/struct__ATTR__PAIR.html">PATTR_PAIR</a> *IndexedAttr,
01076     OUT PSHORT CountOfAttr
01077     )
01078 
01079 <span class="comment">/*++</span>
01080 <span class="comment"></span>
01081 <span class="comment">Routine Description:</span>
01082 <span class="comment"></span>
01083 <span class="comment">    This routine finds the nth attribute in a string.</span>
01084 <span class="comment"></span>
01085 <span class="comment">Arguments:</span>
01086 <span class="comment"></span>
01087 <span class="comment">    String - attribute string</span>
01088 <span class="comment"></span>
01089 <span class="comment">    Index - which attribute to find</span>
01090 <span class="comment"></span>
01091 <span class="comment">    IndexedAttr - pointer to attribute within string</span>
01092 <span class="comment"></span>
01093 <span class="comment">    CountOfAttr - on output, contains corrected length of indexed attr.</span>
01094 <span class="comment">    for example, if the attribute string was { 5, BLUE } and the requested</span>
01095 <span class="comment">    index was 3, CountOfAttr would be 2.</span>
01096 <span class="comment"></span>
01097 <span class="comment">Return Value:</span>
01098 <span class="comment"></span>
01099 <span class="comment">    none.</span>
01100 <span class="comment"></span>
01101 <span class="comment">--*/</span>
01102 
01103 {
01104     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> i;
01105 
01106     <span class="keywordflow">for</span> (i=0;i&lt;<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;) {
01107         i += <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Length;
01108         <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>++;
01109     }
01110 
01111     <span class="keywordflow">if</span> (i&gt;<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>) {
01112         <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>--;
01113         *CountOfAttr = i-<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01114     }
01115     <span class="keywordflow">else</span> {
01116         *CountOfAttr = <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Length;
01117     }
01118     *IndexedAttr = <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>;
01119 }
01120 
01121 
01122 
01123 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01124"></a><a class="code" href="../../d6/d2/output_8c.html#a48">01124</a> <a class="code" href="../../d6/d2/output_8c.html#a48">MergeAttrStrings</a>(
01125     IN <a class="code" href="../../d3/d2/struct__ATTR__PAIR.html">PATTR_PAIR</a> Source,
01126     IN WORD SourceLength,
01127     IN <a class="code" href="../../d3/d2/struct__ATTR__PAIR.html">PATTR_PAIR</a> Merge,
01128     IN WORD MergeLength,
01129     OUT <a class="code" href="../../d3/d2/struct__ATTR__PAIR.html">PATTR_PAIR</a> *Target,
01130     OUT LPWORD TargetLength,
01131     IN SHORT StartIndex,
01132     IN SHORT EndIndex,
01133     IN <a class="code" href="../../d9/d4/struct__ROW.html">PROW</a> Row,
01134     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo
01135     )
01136 
01137 <span class="comment">/*++</span>
01138 <span class="comment"></span>
01139 <span class="comment">Routine Description:</span>
01140 <span class="comment"></span>
01141 <span class="comment">    This routine merges two run-length encoded attribute strings into</span>
01142 <span class="comment">    a third.</span>
01143 <span class="comment"></span>
01144 <span class="comment">    for example, if the source string was { 4, BLUE }, the merge string</span>
01145 <span class="comment">    was { 2, RED }, and the StartIndex and EndIndex were 1 and 2,</span>
01146 <span class="comment">    respectively, the target string would be { 1, BLUE, 2, RED, 1, BLUE }</span>
01147 <span class="comment">    and the target length would be 3.</span>
01148 <span class="comment"></span>
01149 <span class="comment">Arguments:</span>
01150 <span class="comment"></span>
01151 <span class="comment">    Source - pointer to source attribute string</span>
01152 <span class="comment"></span>
01153 <span class="comment">    SourceLength - length of source.  for example, the length of</span>
01154 <span class="comment">    { 4, BLUE } is 1.</span>
01155 <span class="comment"></span>
01156 <span class="comment">    Merge - pointer to attribute string to insert into source</span>
01157 <span class="comment"></span>
01158 <span class="comment">    MergeLength - length of merge</span>
01159 <span class="comment"></span>
01160 <span class="comment">    Target - where to store pointer to resulting attribute string</span>
01161 <span class="comment"></span>
01162 <span class="comment">    TargetLength - where to store length of resulting attribute string</span>
01163 <span class="comment"></span>
01164 <span class="comment">    StartIndex - index into Source at which to insert Merge String.</span>
01165 <span class="comment"></span>
01166 <span class="comment">    EndIndex - index into Source at which to stop insertion of Merge String</span>
01167 <span class="comment"></span>
01168 <span class="comment">Return Value:</span>
01169 <span class="comment"></span>
01170 <span class="comment">    none.</span>
01171 <span class="comment"></span>
01172 <span class="comment">--*/</span>
01173 {
01174     <a class="code" href="../../d3/d2/struct__ATTR__PAIR.html">PATTR_PAIR</a> SrcAttr,TargetAttr,SrcEnd;
01175     <a class="code" href="../../d3/d2/struct__ATTR__PAIR.html">PATTR_PAIR</a> NewString;
01176     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> i;
01177 <span class="preprocessor">#if THERESES_DEBUG2</span>
01178 <span class="preprocessor"></span><span class="preprocessor">#if DBG</span>
01179 <span class="preprocessor"></span>    WORD AllocLength;
01180 
01181     AllocLength = MergeLength + SourceLength + 1;
01182 <span class="preprocessor">#endif</span>
01183 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
01184 <span class="preprocessor"></span>
01185     <span class="comment">//</span>
01186     <span class="comment">// if just changing the attr for the whole row</span>
01187     <span class="comment">//</span>
01188 
01189     <span class="keywordflow">if</span> (MergeLength == 1 &amp;&amp; Row-&gt;AttrRow.Length == 1) {
01190         <span class="keywordflow">if</span> (Row-&gt;AttrRow.Attrs-&gt;Attr == <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a91">Merge</a>-&gt;Attr) {
01191             *TargetLength = 1;
01192             *Target = &amp;Row-&gt;AttrRow.AttrPair;
01193             <span class="keywordflow">return</span> STATUS_SUCCESS;
01194         }
01195         <span class="keywordflow">if</span> (StartIndex == 0 &amp;&amp; EndIndex == (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ScreenInfo-&gt;ScreenBufferSize.X-1)) {
01196             NewString = &amp;Row-&gt;AttrRow.AttrPair;
01197             NewString-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a> = <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a91">Merge</a>-&gt;Attr;
01198             *TargetLength = 1;
01199             *Target = NewString;
01200             <span class="keywordflow">return</span> STATUS_SUCCESS;
01201         }
01202     }
01203 
01204     NewString = (<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html">PATTR_PAIR</a>) <a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a20">SCREEN_TAG</a> ),(SourceLength+MergeLength+1)*<span class="keyword">sizeof</span>(<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html">ATTR_PAIR</a>));
01205     <span class="keywordflow">if</span> (NewString == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01206         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01207     }
01208 
01209     <span class="comment">//</span>
01210     <span class="comment">// copy the source string, up to the start index.</span>
01211     <span class="comment">//</span>
01212 
01213     SrcAttr = Source;
01214     SrcEnd = Source + SourceLength;
01215     TargetAttr = NewString;
01216     i=0;
01217     <span class="keywordflow">if</span> (StartIndex != 0) {
01218         <span class="keywordflow">while</span> (i&lt;StartIndex) {
01219             i += SrcAttr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o0">Length</a>;
01220             *TargetAttr++ = *SrcAttr++;
01221         }
01222 
01223         <span class="comment">//</span>
01224         <span class="comment">// back up to the last pair copied, in case the attribute in the first</span>
01225         <span class="comment">// pair in the merge string matches.  also, adjust TargetAttr-&gt;Length</span>
01226         <span class="comment">// based on i, the attribute</span>
01227         <span class="comment">// counter, back to the StartIndex.  i will be larger than the</span>
01228         <span class="comment">// StartIndex in the case where the last attribute pair copied had</span>
01229         <span class="comment">// a length greater than the number needed to reach StartIndex.</span>
01230         <span class="comment">//</span>
01231 
01232         TargetAttr--;
01233         <span class="keywordflow">if</span> (i&gt;StartIndex) {
01234             TargetAttr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o0">Length</a> -= i-StartIndex;
01235         }
01236         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a91">Merge</a>-&gt;Attr == TargetAttr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a>) {
01237             TargetAttr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o0">Length</a> += <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a91">Merge</a>-&gt;Length;
01238             MergeLength-=1;
01239             <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a91">Merge</a>++;
01240         }
01241         TargetAttr++;
01242     }
01243 
01244     <span class="comment">//</span>
01245     <span class="comment">// copy the merge string.</span>
01246     <span class="comment">//</span>
01247 
01248     RtlCopyMemory(TargetAttr,<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a91">Merge</a>,MergeLength*<span class="keyword">sizeof</span>(<a class="code" href="../../d8/d2/tmerge_8c.html#a50">ATTR_PAIR</a>));
01249     TargetAttr += MergeLength;
01250 
01251     <span class="comment">//</span>
01252     <span class="comment">// figure out where to resume copying the source string.</span>
01253     <span class="comment">//</span>
01254 
01255     <span class="keywordflow">while</span> (i&lt;=EndIndex) {
01256         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(SrcAttr != SrcEnd);
01257         i += SrcAttr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o0">Length</a>;
01258         SrcAttr++;
01259     }
01260 
01261     <span class="comment">//</span>
01262     <span class="comment">// if not done, copy the rest of the source</span>
01263     <span class="comment">//</span>
01264 
01265     <span class="keywordflow">if</span> (SrcAttr != SrcEnd || i!=(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(EndIndex+1)) {
01266 
01267         <span class="comment">//</span>
01268         <span class="comment">// see if we've gone past the right attribute.  if so, back up and</span>
01269         <span class="comment">// copy the attribute and the correct length.</span>
01270         <span class="comment">//</span>
01271 
01272         TargetAttr--;
01273         <span class="keywordflow">if</span> (i&gt;(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(EndIndex+1)) {
01274             SrcAttr--;
01275             <span class="keywordflow">if</span> (TargetAttr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a> == SrcAttr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a>) {
01276                 TargetAttr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o0">Length</a> += i-(EndIndex+1);
01277             } <span class="keywordflow">else</span> {
01278                 TargetAttr++;
01279                 TargetAttr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a> = SrcAttr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a>;
01280                 TargetAttr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o0">Length</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(i-(EndIndex+1));
01281             }
01282             SrcAttr++;
01283         }
01284 
01285         <span class="comment">//</span>
01286         <span class="comment">// see if we can merge the source and target.</span>
01287         <span class="comment">//</span>
01288 
01289         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (TargetAttr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a> == SrcAttr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a>) {
01290             TargetAttr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o0">Length</a> += SrcAttr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o0">Length</a>;
01291             i += SrcAttr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o0">Length</a>;
01292             SrcAttr++;
01293         }
01294         TargetAttr++;
01295 
01296         <span class="comment">//</span>
01297         <span class="comment">// copy the rest of the source</span>
01298         <span class="comment">//</span>
01299 
01300         <span class="keywordflow">if</span> (SrcAttr &lt; SrcEnd) {
01301             RtlCopyMemory(TargetAttr,SrcAttr,(SrcEnd-SrcAttr)*<span class="keyword">sizeof</span>(<a class="code" href="../../d8/d2/tmerge_8c.html#a50">ATTR_PAIR</a>));
01302             TargetAttr += SrcEnd - SrcAttr;
01303         }
01304     }
01305 
01306     *TargetLength = (WORD)(TargetAttr - NewString);
01307 <span class="preprocessor">#if THERESES_DEBUG2</span>
01308 <span class="preprocessor"></span><span class="preprocessor">#if DBG</span>
01309 <span class="preprocessor"></span>    { <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> j;
01310       WORD i;
01311       <a class="code" href="../../d3/d2/struct__ATTR__PAIR.html">PATTR_PAIR</a> NewAttr;
01312       PULONG Foo;
01313       j=0;
01314       NewAttr = NewString;
01315       <span class="keywordflow">for</span> (i=0;i&lt;*TargetLength;i++) {
01316           j+=NewAttr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o0">Length</a>;
01317           NewAttr++;
01318       }
01319       <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (j == ScreenInfo-&gt;ScreenBufferSize.X);
01320       <span class="keywordflow">if</span> (j != ScreenInfo-&gt;ScreenBufferSize.X) {
01321         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"new length is %d\n"</span>,*TargetLength);
01322         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"address of new attr string is %lx\n"</span>,NewString);
01323       }
01324       <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (*TargetLength &lt;= AllocLength);
01325       Foo = (PULONG)(NewString-4);
01326       <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (*Foo &amp; 1);
01327       Foo = (PULONG)(NewString-3);
01328       <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (*Foo &gt;= (*TargetLength * <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d2/tmerge_8c.html#a50">ATTR_PAIR</a>)) + 16);
01329     }
01330 <span class="preprocessor">#endif</span>
01331 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
01332 <span class="preprocessor"></span>    *Target = NewString;
01333     <span class="keywordflow">if</span> (*TargetLength == 1) {
01334         *Target = &amp;Row-&gt;AttrRow.AttrPair;
01335         **Target = *NewString;
01336         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(NewString);
01337     }
01338     <span class="keywordflow">return</span> STATUS_SUCCESS;
01339 }
01340 
01341 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01342"></a><a class="code" href="../../d6/d2/output_8c.html#a49">01342</a> <a class="code" href="../../d6/d2/output_8c.html#a49">ResetTextFlags</a>(
01343     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
01344     IN SHORT StartY,
01345     IN SHORT EndY
01346     )
01347 
01348 <span class="comment">/*</span>
01349 <span class="comment">    this routine updates the text flags</span>
01350 <span class="comment"></span>
01351 <span class="comment">#define SINGLE_ATTRIBUTES_PER_LINE 2    // only one attribute per line</span>
01352 <span class="comment"></span>
01353 <span class="comment">*/</span>
01354 
01355 {
01356     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> RowIndex;
01357     <a class="code" href="../../d9/d4/struct__ROW.html">PROW</a> Row;
01358     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> i;
01359 
01360     <span class="comment">//</span>
01361     <span class="comment">// first see whether we wrote any lines with multiple attributes.  if</span>
01362     <span class="comment">// we did, set the flags and bail out.  also, remember if any of the</span>
01363     <span class="comment">// lines we wrote had attributes different from other lines.</span>
01364     <span class="comment">//</span>
01365 
01366     RowIndex = (ScreenInfo-&gt;BufferInfo.TextInfo.FirstRow+StartY) % ScreenInfo-&gt;ScreenBufferSize.Y;
01367     <span class="keywordflow">for</span> (i=StartY;i&lt;=EndY;i++) {
01368         Row = &amp;ScreenInfo-&gt;BufferInfo.TextInfo.Rows[RowIndex];
01369         <span class="keywordflow">if</span> (Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o0">Length</a> != 1) {
01370             ScreenInfo-&gt;BufferInfo.TextInfo.Flags &amp;= ~<a class="code" href="../../d7/d2/output_8h.html#a4">SINGLE_ATTRIBUTES_PER_LINE</a>;
01371             <span class="keywordflow">return</span>;
01372         }
01373         <span class="keywordflow">if</span> (++RowIndex == ScreenInfo-&gt;ScreenBufferSize.Y) {
01374             RowIndex = 0;
01375         }
01376     }
01377 
01378     <span class="comment">// all of the written lines have the same attribute.</span>
01379 
01380     <span class="keywordflow">if</span> (ScreenInfo-&gt;BufferInfo.TextInfo.Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a4">SINGLE_ATTRIBUTES_PER_LINE</a>) {
01381         <span class="keywordflow">return</span>;
01382     }
01383 
01384     <span class="keywordflow">if</span> (StartY == 0 &amp;&amp; EndY == (ScreenInfo-&gt;ScreenBufferSize.Y-1)) {
01385         ScreenInfo-&gt;BufferInfo.TextInfo.Flags |= <a class="code" href="../../d7/d2/output_8h.html#a4">SINGLE_ATTRIBUTES_PER_LINE</a>;
01386         <span class="keywordflow">return</span>;
01387     }
01388 
01389     RowIndex = ScreenInfo-&gt;BufferInfo.TextInfo.FirstRow;
01390     <span class="keywordflow">for</span> (i=0;i&lt;StartY;i++) {
01391         Row = &amp;ScreenInfo-&gt;BufferInfo.TextInfo.Rows[RowIndex];
01392         <span class="keywordflow">if</span> (Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o0">Length</a> != 1) {
01393             <span class="keywordflow">return</span>;
01394         }
01395         <span class="keywordflow">if</span> (++RowIndex == ScreenInfo-&gt;ScreenBufferSize.Y) {
01396             RowIndex = 0;
01397         }
01398         Row = &amp;ScreenInfo-&gt;BufferInfo.TextInfo.Rows[RowIndex];
01399     }
01400     RowIndex = (ScreenInfo-&gt;BufferInfo.TextInfo.FirstRow+EndY+1) % ScreenInfo-&gt;ScreenBufferSize.Y;
01401     <span class="keywordflow">for</span> (i=EndY+1;i&lt;ScreenInfo-&gt;ScreenBufferSize.Y;i++) {
01402         Row = &amp;ScreenInfo-&gt;BufferInfo.TextInfo.Rows[RowIndex];
01403         <span class="keywordflow">if</span> (Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o0">Length</a> != 1) {
01404             <span class="keywordflow">return</span>;
01405         }
01406         <span class="keywordflow">if</span> (++RowIndex == ScreenInfo-&gt;ScreenBufferSize.Y) {
01407             RowIndex = 0;
01408         }
01409     }
01410     ScreenInfo-&gt;BufferInfo.TextInfo.Flags |= <a class="code" href="../../d7/d2/output_8h.html#a4">SINGLE_ATTRIBUTES_PER_LINE</a>;
01411 }
01412 
01413 
01414 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01415"></a><a class="code" href="../../d6/d2/output_8c.html#a50">01415</a> <a class="code" href="../../d6/d2/output_8c.html#a50">ReadRectFromScreenBuffer</a>(
01416     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
01417     IN COORD SourcePoint,
01418     IN PCHAR_INFO Target,
01419     IN COORD TargetSize,
01420     IN PSMALL_RECT TargetRect
01421     )
01422 
01423 <span class="comment">/*++</span>
01424 <span class="comment"></span>
01425 <span class="comment">Routine Description:</span>
01426 <span class="comment"></span>
01427 <span class="comment">    This routine copies a rectangular region from the screen buffer.</span>
01428 <span class="comment">    no clipping is done.</span>
01429 <span class="comment"></span>
01430 <span class="comment">Arguments:</span>
01431 <span class="comment"></span>
01432 <span class="comment">    ScreenInfo - pointer to screen info</span>
01433 <span class="comment"></span>
01434 <span class="comment">    SourcePoint - upper left coordinates of source rectangle</span>
01435 <span class="comment"></span>
01436 <span class="comment">    Target - pointer to target buffer</span>
01437 <span class="comment"></span>
01438 <span class="comment">    TargetSize - dimensions of target buffer</span>
01439 <span class="comment"></span>
01440 <span class="comment">    TargetRect - rectangle in source buffer to copy</span>
01441 <span class="comment"></span>
01442 <span class="comment">Return Value:</span>
01443 <span class="comment"></span>
01444 <span class="comment">    none.</span>
01445 <span class="comment"></span>
01446 <span class="comment">--*/</span>
01447 
01448 {
01449 
01450     PCHAR_INFO TargetPtr;
01451     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> i,j,k;
01452     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> XSize,YSize;
01453     BOOLEAN WholeTarget;
01454     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> RowIndex;
01455     <a class="code" href="../../d9/d4/struct__ROW.html">PROW</a> Row;
01456     PWCHAR Char;
01457     <a class="code" href="../../d3/d2/struct__ATTR__PAIR.html">PATTR_PAIR</a> Attr;
01458     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> CountOfAttr;
01459 
01460     <a class="code" href="../../d8/d5/consrv_8h.html#a3">DBGOUTPUT</a>((<span class="stringliteral">"ReadRectFromScreenBuffer\n"</span>));
01461 
01462     XSize = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(TargetRect-&gt;Right - TargetRect-&gt;Left + 1);
01463     YSize = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(TargetRect-&gt;Bottom - TargetRect-&gt;Top + 1);
01464 
01465     TargetPtr = Target;
01466     WholeTarget = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01467     <span class="keywordflow">if</span> (XSize == TargetSize.X) {
01468         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (TargetRect-&gt;Left == 0);
01469         <span class="keywordflow">if</span> (TargetRect-&gt;Top != 0) {
01470             TargetPtr = (PCHAR_INFO)
01471                 ((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)Target + <a class="code" href="../../d3/d6/iostubs_8c.html#a0">SCREEN_BUFFER_POINTER</a>(TargetRect-&gt;Left,
01472                                                        TargetRect-&gt;Top,
01473                                                        TargetSize.X,
01474                                                        <span class="keyword">sizeof</span>(CHAR_INFO)));
01475         }
01476         WholeTarget = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01477     }
01478     RowIndex = (ScreenInfo-&gt;BufferInfo.TextInfo.FirstRow+SourcePoint.Y) % ScreenInfo-&gt;ScreenBufferSize.Y;
01479     <span class="keywordflow">for</span> (i=0;i&lt;YSize;i++) {
01480         <span class="keywordflow">if</span> (!WholeTarget) {
01481             TargetPtr = (PCHAR_INFO)
01482                 ((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)Target + <a class="code" href="../../d3/d6/iostubs_8c.html#a0">SCREEN_BUFFER_POINTER</a>(TargetRect-&gt;Left,
01483                                                        TargetRect-&gt;Top+i,
01484                                                        TargetSize.X,
01485                                                        <span class="keyword">sizeof</span>(CHAR_INFO)));
01486         }
01487 
01488         <span class="comment">//</span>
01489         <span class="comment">// copy the chars and attrs from their respective arrays</span>
01490         <span class="comment">//</span>
01491 
01492         Row = &amp;ScreenInfo-&gt;BufferInfo.TextInfo.Rows[RowIndex];
01493         Char = &amp;Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o4">Chars</a>[SourcePoint.X];
01494         <a class="code" href="../../d6/d2/output_8c.html#a47">FindAttrIndex</a>(Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o2">Attrs</a>,
01495                       SourcePoint.X,
01496                       &amp;Attr,
01497                       &amp;CountOfAttr
01498                      );
01499         k=0;
01500 <span class="preprocessor">#if defined(FE_SB)</span>
01501 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (CONSOLE_IS_DBCS_OUTPUTCP(ScreenInfo-&gt;Console)) {
01502             <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a> AttrP = &amp;Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.KAttrs[SourcePoint.X];
01503             <span class="keywordflow">for</span> (j=0;j&lt;XSize;TargetPtr++) {
01504                 <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> AttrR;
01505                 AttrR = *AttrP++;
01506                 <span class="keywordflow">if</span> (j==0 &amp;&amp; AttrR &amp; ATTR_TRAILING_BYTE)
01507                 {
01508                     TargetPtr-&gt;Char.UnicodeChar = <a class="code" href="../../d9/d5/verifier_8c.html#a6">UNICODE_SPACE</a>;
01509                     AttrR = 0;
01510                 }
01511                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (j+1 &gt;= XSize &amp;&amp; AttrR &amp; ATTR_LEADING_BYTE)
01512                 {
01513                     TargetPtr-&gt;Char.UnicodeChar = <a class="code" href="../../d9/d5/verifier_8c.html#a6">UNICODE_SPACE</a>;
01514                     AttrR = 0;
01515                 }
01516                 <span class="keywordflow">else</span>
01517                     TargetPtr-&gt;Char.UnicodeChar = *Char;
01518                 Char++;
01519                 TargetPtr-&gt;Attributes = Attr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a> | (WCHAR)(AttrR &amp; ATTR_DBCSSBCS_BYTE) &lt;&lt; 8;
01520                 j+=1;
01521                 <span class="keywordflow">if</span> (++k==CountOfAttr &amp;&amp; j&lt;XSize) {
01522                     Attr++;
01523                     k=0;
01524                     CountOfAttr = Attr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o0">Length</a>;
01525                 }
01526             }
01527         }
01528         <span class="keywordflow">else</span>{
01529 <span class="preprocessor">#endif</span>
01530 <span class="preprocessor"></span>        <span class="keywordflow">for</span> (j=0;j&lt;XSize;TargetPtr++) {
01531             TargetPtr-&gt;Char.UnicodeChar = *Char++;
01532             TargetPtr-&gt;Attributes = Attr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a>;
01533             j+=1;
01534             <span class="keywordflow">if</span> (++k==CountOfAttr &amp;&amp; j&lt;XSize) {
01535                 Attr++;
01536                 k=0;
01537                 CountOfAttr = Attr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o0">Length</a>;
01538             }
01539         }
01540 <span class="preprocessor">#if defined(FE_SB)</span>
01541 <span class="preprocessor"></span>        }
01542 <span class="preprocessor">#endif</span>
01543 <span class="preprocessor"></span>
01544         <span class="keywordflow">if</span> (++RowIndex == ScreenInfo-&gt;ScreenBufferSize.Y) {
01545             RowIndex = 0;
01546         }
01547     }
01548 }
01549 
01550 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01551"></a><a class="code" href="../../d6/d2/output_8c.html#a51">01551</a> <a class="code" href="../../d6/d2/output_8c.html#a51">CopyRectangle</a>(
01552     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
01553     IN PSMALL_RECT SourceRect,
01554     IN COORD TargetPoint
01555     )
01556 
01557 <span class="comment">/*++</span>
01558 <span class="comment"></span>
01559 <span class="comment">Routine Description:</span>
01560 <span class="comment"></span>
01561 <span class="comment">    This routine copies a rectangular region from the screen buffer to</span>
01562 <span class="comment">    the screen buffer.  no clipping is done.</span>
01563 <span class="comment"></span>
01564 <span class="comment">Arguments:</span>
01565 <span class="comment"></span>
01566 <span class="comment">    ScreenInfo - pointer to screen info</span>
01567 <span class="comment"></span>
01568 <span class="comment">    SourceRect - rectangle in source buffer to copy</span>
01569 <span class="comment"></span>
01570 <span class="comment">    TargetPoint - upper left coordinates of new location rectangle</span>
01571 <span class="comment"></span>
01572 <span class="comment">Return Value:</span>
01573 <span class="comment"></span>
01574 <span class="comment">    none.</span>
01575 <span class="comment"></span>
01576 <span class="comment">--*/</span>
01577 
01578 {
01579     SMALL_RECT Target;
01580     COORD SourcePoint;
01581     COORD <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
01582     <a class="code" href="../../d8/d5/consrv_8h.html#a3">DBGOUTPUT</a>((<span class="stringliteral">"CopyRectangle\n"</span>));
01583 
01584 
01585     <a class="code" href="../../d6/d2/output_8c.html#a6">LockScrollBuffer</a>();
01586 
01587     SourcePoint.X = SourceRect-&gt;Left;
01588     SourcePoint.Y = SourceRect-&gt;Top;
01589     Target.Left = 0;
01590     Target.Top = 0;
01591     Target.Right = <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.X = SourceRect-&gt;Right - SourceRect-&gt;Left;
01592     Target.Bottom = <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.Y = SourceRect-&gt;Bottom - SourceRect-&gt;Top;
01593     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.X++;
01594     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.Y++;
01595 
01596     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/output_8c.html#a20">ScrollBufferSize</a> &lt; (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.X * <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.Y * <span class="keyword">sizeof</span>(CHAR_INFO))) {
01597         <a class="code" href="../../d6/d2/output_8c.html#a36">FreeScrollBuffer</a>();
01598         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d6/d2/output_8c.html#a35">AllocateScrollBuffer</a>(<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.X * <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.Y * <span class="keyword">sizeof</span>(CHAR_INFO)))) {
01599             <a class="code" href="../../d6/d2/output_8c.html#a7">UnlockScrollBuffer</a>();
01600             <span class="keywordflow">return</span>;
01601         }
01602     }
01603 
01604     <a class="code" href="../../d6/d2/output_8c.html#a50">ReadRectFromScreenBuffer</a>(ScreenInfo,
01605                              SourcePoint,
01606                              <a class="code" href="../../d6/d2/output_8c.html#a19">ScrollBuffer</a>,
01607                              <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>,
01608                              &amp;Target
01609                             );
01610 
01611     <a class="code" href="../../d6/d8/dispatch_8h.html#a3">WriteRectToScreenBuffer</a>((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)<a class="code" href="../../d6/d2/output_8c.html#a19">ScrollBuffer</a>,
01612                             <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>,
01613                             &amp;Target,
01614                             ScreenInfo,
01615                             TargetPoint,
01616                             0xFFFFFFFF  <span class="comment">// ScrollBuffer won't need conversion</span>
01617                            );
01618     <a class="code" href="../../d6/d2/output_8c.html#a7">UnlockScrollBuffer</a>();
01619 }
01620 
01621 
01622 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01623"></a><a class="code" href="../../d6/d2/output_8c.html#a52">01623</a> <a class="code" href="../../d6/d2/output_8c.html#a52">ReadScreenBuffer</a>(
01624     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInformation,
01625     OUT PCHAR_INFO Buffer,
01626     IN OUT PSMALL_RECT ReadRegion
01627     )
01628 
01629 <span class="comment">/*++</span>
01630 <span class="comment"></span>
01631 <span class="comment">Routine Description:</span>
01632 <span class="comment"></span>
01633 <span class="comment">    This routine reads a rectangular region from the screen buffer.</span>
01634 <span class="comment">    The region is first clipped.</span>
01635 <span class="comment"></span>
01636 <span class="comment">Arguments:</span>
01637 <span class="comment"></span>
01638 <span class="comment">    ScreenInformation - Screen buffer to read from.</span>
01639 <span class="comment"></span>
01640 <span class="comment">    Buffer - Buffer to read into.</span>
01641 <span class="comment"></span>
01642 <span class="comment">    ReadRegion - Region to read.</span>
01643 <span class="comment"></span>
01644 <span class="comment">Return Value:</span>
01645 <span class="comment"></span>
01646 <span class="comment"></span>
01647 <span class="comment">--*/</span>
01648 
01649 {
01650     COORD TargetSize;
01651     COORD TargetPoint,SourcePoint;
01652     SMALL_RECT Target;
01653 
01654     <a class="code" href="../../d8/d5/consrv_8h.html#a3">DBGOUTPUT</a>((<span class="stringliteral">"ReadScreenBuffer\n"</span>));
01655     <span class="comment">//</span>
01656     <span class="comment">// calculate dimensions of caller's buffer.  have to do this calculation</span>
01657     <span class="comment">// before clipping.</span>
01658     <span class="comment">//</span>
01659 
01660     TargetSize.X = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ReadRegion-&gt;Right - ReadRegion-&gt;Left + 1);
01661     TargetSize.Y = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ReadRegion-&gt;Bottom - ReadRegion-&gt;Top + 1);
01662 
01663     <span class="keywordflow">if</span> (TargetSize.X &lt;= 0 || TargetSize.Y &lt;= 0) {
01664         <span class="keywordflow">return</span> STATUS_SUCCESS;
01665     }
01666 
01667     <span class="comment">// do clipping.</span>
01668 
01669     <span class="keywordflow">if</span> (ReadRegion-&gt;Right &gt; (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ScreenInformation-&gt;ScreenBufferSize.X-1)) {
01670         ReadRegion-&gt;Right = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ScreenInformation-&gt;ScreenBufferSize.X-1);
01671     }
01672     <span class="keywordflow">if</span> (ReadRegion-&gt;Bottom &gt; (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ScreenInformation-&gt;ScreenBufferSize.Y-1)) {
01673         ReadRegion-&gt;Bottom = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ScreenInformation-&gt;ScreenBufferSize.Y-1);
01674     }
01675     <span class="keywordflow">if</span> (ReadRegion-&gt;Left &lt; 0) {
01676         TargetPoint.X = -ReadRegion-&gt;Left;
01677         ReadRegion-&gt;Left = 0;
01678     }
01679     <span class="keywordflow">else</span> {
01680         TargetPoint.X = 0;
01681     }
01682     <span class="keywordflow">if</span> (ReadRegion-&gt;Top &lt; 0) {
01683         TargetPoint.Y = -ReadRegion-&gt;Top;
01684         ReadRegion-&gt;Top = 0;
01685     }
01686     <span class="keywordflow">else</span> {
01687         TargetPoint.Y = 0;
01688     }
01689 
01690     SourcePoint.X = ReadRegion-&gt;Left;
01691     SourcePoint.Y = ReadRegion-&gt;Top;
01692     Target.Left = TargetPoint.X;
01693     Target.Top = TargetPoint.Y;
01694     Target.Right = TargetPoint.X + (ReadRegion-&gt;Right - ReadRegion-&gt;Left);
01695     Target.Bottom = TargetPoint.Y + (ReadRegion-&gt;Bottom - ReadRegion-&gt;Top);
01696     <a class="code" href="../../d6/d2/output_8c.html#a50">ReadRectFromScreenBuffer</a>(ScreenInformation,
01697                              SourcePoint,
01698                              <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
01699                              TargetSize,
01700                              &amp;Target
01701                             );
01702     <span class="keywordflow">return</span> STATUS_SUCCESS;
01703 }
01704 
01705 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01706"></a><a class="code" href="../../d6/d2/output_8c.html#a53">01706</a> <a class="code" href="../../d6/d2/output_8c.html#a53">WriteScreenBuffer</a>(
01707     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInformation,
01708     IN PCHAR_INFO Buffer,
01709     IN OUT PSMALL_RECT WriteRegion
01710     )
01711 
01712 <span class="comment">/*++</span>
01713 <span class="comment"></span>
01714 <span class="comment">Routine Description:</span>
01715 <span class="comment"></span>
01716 <span class="comment">    This routine write a rectangular region to the screen buffer.</span>
01717 <span class="comment">    The region is first clipped.</span>
01718 <span class="comment"></span>
01719 <span class="comment">    The region should contain Unicode or UnicodeOem chars.</span>
01720 <span class="comment"></span>
01721 <span class="comment">Arguments:</span>
01722 <span class="comment"></span>
01723 <span class="comment">    ScreenInformation - Screen buffer to write to.</span>
01724 <span class="comment"></span>
01725 <span class="comment">    Buffer - Buffer to write from.</span>
01726 <span class="comment"></span>
01727 <span class="comment">    ReadRegion - Region to write.</span>
01728 <span class="comment"></span>
01729 <span class="comment">Return Value:</span>
01730 <span class="comment"></span>
01731 <span class="comment"></span>
01732 <span class="comment">--*/</span>
01733 
01734 {
01735     COORD SourceSize;
01736     COORD TargetPoint;
01737     SMALL_RECT SourceRect;
01738 
01739     <a class="code" href="../../d8/d5/consrv_8h.html#a3">DBGOUTPUT</a>((<span class="stringliteral">"WriteScreenBuffer\n"</span>));
01740     <span class="comment">//</span>
01741     <span class="comment">// calculate dimensions of caller's buffer.  have to do this calculation</span>
01742     <span class="comment">// before clipping.</span>
01743     <span class="comment">//</span>
01744 
01745     SourceSize.X = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(WriteRegion-&gt;Right - WriteRegion-&gt;Left + 1);
01746     SourceSize.Y = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(WriteRegion-&gt;Bottom - WriteRegion-&gt;Top + 1);
01747     <span class="keywordflow">if</span> (SourceSize.X &lt;= 0 || SourceSize.Y &lt;= 0) {
01748         <span class="keywordflow">return</span> STATUS_SUCCESS;
01749     }
01750 
01751     <span class="comment">// do clipping.</span>
01752 
01753     <span class="keywordflow">if</span> (WriteRegion-&gt;Left &gt;= ScreenInformation-&gt;ScreenBufferSize.X ||
01754         WriteRegion-&gt;Top  &gt;= ScreenInformation-&gt;ScreenBufferSize.Y) {
01755         <span class="keywordflow">return</span> STATUS_SUCCESS;
01756     }
01757 
01758     <span class="keywordflow">if</span> (WriteRegion-&gt;Right &gt; (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ScreenInformation-&gt;ScreenBufferSize.X-1))
01759         WriteRegion-&gt;Right = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ScreenInformation-&gt;ScreenBufferSize.X-1);
01760     SourceRect.Right = WriteRegion-&gt;Right - WriteRegion-&gt;Left;
01761     <span class="keywordflow">if</span> (WriteRegion-&gt;Bottom &gt; (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ScreenInformation-&gt;ScreenBufferSize.Y-1))
01762         WriteRegion-&gt;Bottom = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ScreenInformation-&gt;ScreenBufferSize.Y-1);
01763     SourceRect.Bottom = WriteRegion-&gt;Bottom - WriteRegion-&gt;Top;
01764     <span class="keywordflow">if</span> (WriteRegion-&gt;Left &lt; 0) {
01765         SourceRect.Left = -WriteRegion-&gt;Left;
01766         WriteRegion-&gt;Left = 0;
01767     }
01768     <span class="keywordflow">else</span> {
01769         SourceRect.Left = 0;
01770     }
01771     <span class="keywordflow">if</span> (WriteRegion-&gt;Top &lt; 0) {
01772         SourceRect.Top = -WriteRegion-&gt;Top;
01773         WriteRegion-&gt;Top = 0;
01774     }
01775     <span class="keywordflow">else</span> {
01776         SourceRect.Top = 0;
01777     }
01778 
01779     TargetPoint.X = WriteRegion-&gt;Left;
01780     TargetPoint.Y = WriteRegion-&gt;Top;
01781     <a class="code" href="../../d6/d8/dispatch_8h.html#a3">WriteRectToScreenBuffer</a>((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
01782                             SourceSize,
01783                             &amp;SourceRect,
01784                             ScreenInformation,
01785                             TargetPoint,
01786                             0xFFFFFFFF
01787                            );
01788     <span class="keywordflow">return</span> STATUS_SUCCESS;
01789 }
01790 
01791 
01792 
01793 
01794 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01795"></a><a class="code" href="../../d6/d2/output_8c.html#a54">01795</a> <a class="code" href="../../d6/d2/output_8c.html#a54">ReadOutputString</a>(
01796     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
01797     OUT PVOID Buffer,
01798     IN COORD ReadCoord,
01799     IN ULONG StringType,
01800     IN OUT PULONG NumRecords <span class="comment">// this value is valid even for error cases</span>
01801     )
01802 
01803 <span class="comment">/*++</span>
01804 <span class="comment"></span>
01805 <span class="comment">Routine Description:</span>
01806 <span class="comment"></span>
01807 <span class="comment">    This routine reads a string of characters or attributes from the</span>
01808 <span class="comment">    screen buffer.</span>
01809 <span class="comment"></span>
01810 <span class="comment">Arguments:</span>
01811 <span class="comment"></span>
01812 <span class="comment">    ScreenInfo - Pointer to screen buffer information.</span>
01813 <span class="comment"></span>
01814 <span class="comment">    Buffer - Buffer to read into.</span>
01815 <span class="comment"></span>
01816 <span class="comment">    ReadCoord - Screen buffer coordinate to begin reading from.</span>
01817 <span class="comment"></span>
01818 <span class="comment">    StringType</span>
01819 <span class="comment"></span>
01820 <span class="comment">        CONSOLE_ASCII         - read a string of ASCII characters.</span>
01821 <span class="comment">        CONSOLE_REAL_UNICODE  - read a string of Real Unicode characters.</span>
01822 <span class="comment">        CONSOLE_FALSE_UNICODE - read a string of False Unicode characters.</span>
01823 <span class="comment">        CONSOLE_ATTRIBUTE     - read a string of attributes.</span>
01824 <span class="comment"></span>
01825 <span class="comment">    NumRecords - On input, the size of the buffer in elements.  On output,</span>
01826 <span class="comment">    the number of elements read.</span>
01827 <span class="comment"></span>
01828 <span class="comment">Return Value:</span>
01829 <span class="comment"></span>
01830 <span class="comment"></span>
01831 <span class="comment">--*/</span>
01832 
01833 {
01834     ULONG NumRead;
01835     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> X,Y;
01836     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> RowIndex;
01837     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> CountOfAttr;
01838     <a class="code" href="../../d3/d2/struct__ATTR__PAIR.html">PATTR_PAIR</a> Attr;
01839     <a class="code" href="../../d9/d4/struct__ROW.html">PROW</a> Row;
01840     PWCHAR Char;
01841     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> j,k;
01842     PWCHAR TransBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01843     PWCHAR BufPtr;
01844 <span class="preprocessor">#if defined(FE_SB)</span>
01845 <span class="preprocessor"></span>    <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a> AttrP;
01846     <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a> TransBufferA,BufPtrA;
01847     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console = ScreenInfo-&gt;Console;
01848 <span class="preprocessor">#endif</span>
01849 <span class="preprocessor"></span>
01850     <a class="code" href="../../d8/d5/consrv_8h.html#a3">DBGOUTPUT</a>((<span class="stringliteral">"ReadOutputString\n"</span>));
01851     <span class="keywordflow">if</span> (*NumRecords == 0)
01852         <span class="keywordflow">return</span> STATUS_SUCCESS;
01853     NumRead = 0;
01854     X=ReadCoord.X;
01855     Y=ReadCoord.Y;
01856     <span class="keywordflow">if</span> (X&gt;=ScreenInfo-&gt;ScreenBufferSize.X ||
01857         X&lt;0 ||
01858         Y&gt;=ScreenInfo-&gt;ScreenBufferSize.Y ||
01859         Y&lt;0) {
01860         *NumRecords = 0;
01861         <span class="keywordflow">return</span> STATUS_SUCCESS;
01862     }
01863 
01864     RowIndex = (ScreenInfo-&gt;BufferInfo.TextInfo.FirstRow+ReadCoord.Y) % ScreenInfo-&gt;ScreenBufferSize.Y;
01865 
01866     <span class="keywordflow">if</span> (StringType == <a class="code" href="../../d5/d5/conmsg_8h.html#a9">CONSOLE_ASCII</a>) {
01867         TransBuffer = (PWCHAR)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a9">TMP_TAG</a> ),*NumRecords * <span class="keyword">sizeof</span>(WCHAR));
01868         <span class="keywordflow">if</span> (TransBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01869             <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01870         }
01871         BufPtr = TransBuffer;
01872     } <span class="keywordflow">else</span> {
01873         BufPtr = <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
01874     }
01875 
01876 <span class="preprocessor">#if defined(FE_SB)</span>
01877 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (CONSOLE_IS_DBCS_OUTPUTCP(Console))
01878     {
01879         TransBufferA = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( TMP_DBCS_TAG ),*NumRecords * <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>));
01880         <span class="keywordflow">if</span> (TransBufferA == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01881             <span class="keywordflow">if</span> (TransBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01882                 <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(TransBuffer);
01883             <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01884         }
01885         BufPtrA = TransBufferA;
01886     }
01887 <span class="preprocessor">#endif</span>
01888 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ((StringType == <a class="code" href="../../d5/d5/conmsg_8h.html#a9">CONSOLE_ASCII</a>) ||
01889             (StringType == <a class="code" href="../../d5/d5/conmsg_8h.html#a10">CONSOLE_REAL_UNICODE</a>) ||
01890             (StringType == <a class="code" href="../../d5/d5/conmsg_8h.html#a12">CONSOLE_FALSE_UNICODE</a>)) {
01891         <span class="keywordflow">while</span> (NumRead &lt; *NumRecords) {
01892 
01893             <span class="comment">//</span>
01894             <span class="comment">// copy the chars from its array</span>
01895             <span class="comment">//</span>
01896 
01897             Row = &amp;ScreenInfo-&gt;BufferInfo.TextInfo.Rows[RowIndex];
01898             Char = &amp;Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o4">Chars</a>[X];
01899 <span class="preprocessor">#if defined(FE_SB)</span>
01900 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (CONSOLE_IS_DBCS_OUTPUTCP(Console))
01901                 AttrP = &amp;Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.KAttrs[X];
01902 <span class="preprocessor">#endif</span>
01903 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ((ULONG)(ScreenInfo-&gt;ScreenBufferSize.X - X) &gt; (*NumRecords - NumRead)) {
01904                 RtlCopyMemory(BufPtr,Char,(*NumRecords - NumRead) * <span class="keyword">sizeof</span>(WCHAR));
01905 <span class="preprocessor">#if defined(FE_SB)</span>
01906 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (CONSOLE_IS_DBCS_OUTPUTCP(Console))
01907                     RtlCopyMemory(BufPtrA,AttrP,(*NumRecords - NumRead) * <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>));
01908 <span class="preprocessor">#endif</span>
01909 <span class="preprocessor"></span>                NumRead += *NumRecords - NumRead;
01910                 <span class="keywordflow">break</span>;
01911             }
01912             RtlCopyMemory(BufPtr,Char,(ScreenInfo-&gt;ScreenBufferSize.X - X) * <span class="keyword">sizeof</span>(WCHAR));
01913             BufPtr = (PVOID)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)BufPtr + ((ScreenInfo-&gt;ScreenBufferSize.X - X) * <span class="keyword">sizeof</span>(WCHAR)));
01914 <span class="preprocessor">#if defined(FE_SB)</span>
01915 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (CONSOLE_IS_DBCS_OUTPUTCP(Console)) {
01916                 RtlCopyMemory(BufPtrA,AttrP,(ScreenInfo-&gt;ScreenBufferSize.X - X) * <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>));
01917                 BufPtrA = (PVOID)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)BufPtrA + ((ScreenInfo-&gt;ScreenBufferSize.X - X) * <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>)));
01918             }
01919 <span class="preprocessor">#endif</span>
01920 <span class="preprocessor"></span>            NumRead += ScreenInfo-&gt;ScreenBufferSize.X - X;
01921             <span class="keywordflow">if</span> (++RowIndex == ScreenInfo-&gt;ScreenBufferSize.Y) {
01922                 RowIndex = 0;
01923             }
01924             X = 0;
01925             Y++;
01926             <span class="keywordflow">if</span> (Y&gt;=ScreenInfo-&gt;ScreenBufferSize.Y) {
01927                 <span class="keywordflow">break</span>;
01928             }
01929         }
01930 <span class="preprocessor">#if defined(FE_SB)</span>
01931 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (CONSOLE_IS_DBCS_OUTPUTCP(Console) &amp;&amp; (NumRead)) {
01932             <span class="keywordflow">if</span> (StringType == <a class="code" href="../../d5/d5/conmsg_8h.html#a9">CONSOLE_ASCII</a>) {
01933                 Char = BufPtr = TransBuffer;
01934             } <span class="keywordflow">else</span> {
01935                 Char = BufPtr = <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
01936             }
01937             AttrP = BufPtrA = TransBufferA;
01938 
01939             <span class="keywordflow">if</span> (*BufPtrA &amp; ATTR_TRAILING_BYTE)
01940             {
01941                 j = k = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(NumRead - 1);
01942                 BufPtr++;
01943                 *Char++ = <a class="code" href="../../d9/d5/verifier_8c.html#a6">UNICODE_SPACE</a>;
01944                 BufPtrA++;
01945                 NumRead = 1;
01946             }
01947             <span class="keywordflow">else</span> {
01948                 j = k = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)NumRead;
01949                 NumRead = 0;
01950             }
01951             <span class="keywordflow">while</span> (j--) {
01952                 <span class="keywordflow">if</span> (!(*BufPtrA &amp; ATTR_TRAILING_BYTE)) {
01953                     *Char++ = *BufPtr;
01954                     NumRead++;
01955                 }
01956                 BufPtr++;
01957                 BufPtrA++;
01958             }
01959             <span class="keywordflow">if</span> (k &amp;&amp; *(BufPtrA-1) &amp; ATTR_LEADING_BYTE)
01960             {
01961                 *(Char-1) = <a class="code" href="../../d9/d5/verifier_8c.html#a6">UNICODE_SPACE</a>;
01962             }
01963         }
01964 <span class="preprocessor">#endif</span>
01965 <span class="preprocessor"></span>    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (StringType == <a class="code" href="../../d5/d5/conmsg_8h.html#a11">CONSOLE_ATTRIBUTE</a>) {
01966         PWORD TargetPtr=BufPtr;
01967         <span class="keywordflow">while</span> (NumRead &lt; *NumRecords) {
01968 
01969             <span class="comment">//</span>
01970             <span class="comment">// copy the attrs from its array</span>
01971             <span class="comment">//</span>
01972 
01973             Row = &amp;ScreenInfo-&gt;BufferInfo.TextInfo.Rows[RowIndex];
01974 <span class="preprocessor">#if defined(FE_SB)</span>
01975 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (CONSOLE_IS_DBCS_OUTPUTCP(Console))
01976                 AttrP = &amp;Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.KAttrs[X];
01977 <span class="preprocessor">#endif</span>
01978 <span class="preprocessor"></span>            <a class="code" href="../../d6/d2/output_8c.html#a47">FindAttrIndex</a>(Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o2">Attrs</a>,
01979                           X,
01980                           &amp;Attr,
01981                           &amp;CountOfAttr
01982                          );
01983             k=0;
01984             <span class="keywordflow">for</span> (j=X;j&lt;ScreenInfo-&gt;ScreenBufferSize.X;TargetPtr++) {
01985 <span class="preprocessor">#if defined(FE_SB)</span>
01986 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (!CONSOLE_IS_DBCS_OUTPUTCP(Console) )
01987                     *TargetPtr = Attr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a>;
01988                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((j == X) &amp;&amp; (*AttrP &amp; ATTR_TRAILING_BYTE))
01989                     *TargetPtr = Attr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a>;
01990                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*AttrP &amp; ATTR_LEADING_BYTE){
01991                     <span class="keywordflow">if</span> ((NumRead == *NumRecords-1)||(j == ScreenInfo-&gt;ScreenBufferSize.X-1))
01992                         *TargetPtr = Attr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a>;
01993                     <span class="keywordflow">else</span>
01994                         *TargetPtr = Attr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a> | (WCHAR)(*AttrP &amp; ATTR_DBCSSBCS_BYTE) &lt;&lt; 8;
01995                 }
01996                 <span class="keywordflow">else</span>
01997                     *TargetPtr = Attr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a> | (WCHAR)(*AttrP &amp; ATTR_DBCSSBCS_BYTE) &lt;&lt; 8;
01998 <span class="preprocessor">#else</span>
01999 <span class="preprocessor"></span>                *TargetPtr = Attr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a>;
02000 <span class="preprocessor">#endif</span>
02001 <span class="preprocessor"></span>                NumRead++;
02002                 j+=1;
02003                 <span class="keywordflow">if</span> (++k==CountOfAttr &amp;&amp; j&lt;ScreenInfo-&gt;ScreenBufferSize.X) {
02004                     Attr++;
02005                     k=0;
02006                     CountOfAttr = Attr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o0">Length</a>;
02007                 }
02008                 <span class="keywordflow">if</span> (NumRead == *NumRecords) {
02009 <span class="preprocessor">#if defined(FE_SB)</span>
02010 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (CONSOLE_IS_DBCS_OUTPUTCP(Console))
02011                         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(TransBufferA);
02012 <span class="preprocessor">#endif</span>
02013 <span class="preprocessor"></span>                    <span class="keywordflow">return</span> STATUS_SUCCESS;
02014                 }
02015 <span class="preprocessor">#if defined(FE_SB)</span>
02016 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (CONSOLE_IS_DBCS_OUTPUTCP(Console))
02017                     AttrP++;
02018 <span class="preprocessor">#endif</span>
02019 <span class="preprocessor"></span>            }
02020             <span class="keywordflow">if</span> (++RowIndex == ScreenInfo-&gt;ScreenBufferSize.Y) {
02021                 RowIndex = 0;
02022             }
02023             X = 0;
02024             Y++;
02025             <span class="keywordflow">if</span> (Y&gt;=ScreenInfo-&gt;ScreenBufferSize.Y) {
02026                 <span class="keywordflow">break</span>;
02027             }
02028         }
02029     } <span class="keywordflow">else</span> {
02030         *NumRecords = 0;
02031 <span class="preprocessor">#if defined(FE_SB)</span>
02032 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (CONSOLE_IS_DBCS_OUTPUTCP(Console))
02033             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(TransBufferA);
02034 <span class="preprocessor">#endif</span>
02035 <span class="preprocessor"></span>        <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
02036     }
02037 
02038     <span class="keywordflow">if</span> (StringType == <a class="code" href="../../d5/d5/conmsg_8h.html#a9">CONSOLE_ASCII</a>) {
02039         <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> Codepage;
02040 <span class="preprocessor">#if defined(FE_SB)</span>
02041 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ((ScreenInfo-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a2">CONSOLE_OEMFONT_DISPLAY</a>) &amp;&amp;
02042                 !(ScreenInfo-&gt;Console-&gt;FullScreenFlags &amp; CONSOLE_FULLSCREEN)) {
02043             <span class="keywordflow">if</span> (ScreenInfo-&gt;Console-&gt;OutputCP != <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a3">WINDOWSCP</a>)
02044                 Codepage = <a class="code" href="../../d0/d3/dbcs_8h.html#a5">USACP</a>;
02045             <span class="keywordflow">else</span>
02046                 Codepage = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a3">WINDOWSCP</a>;
02047         } <span class="keywordflow">else</span> {
02048             Codepage = ScreenInfo-&gt;Console-&gt;OutputCP;
02049         }
02050 <span class="preprocessor">#else</span>
02051 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ((ScreenInfo-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a2">CONSOLE_OEMFONT_DISPLAY</a>) &amp;&amp;
02052                 !(ScreenInfo-&gt;Console-&gt;FullScreenFlags &amp; CONSOLE_FULLSCREEN)) {
02053             Codepage = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a3">WINDOWSCP</a>;
02054         } <span class="keywordflow">else</span> {
02055             Codepage = ScreenInfo-&gt;Console-&gt;OutputCP;
02056         }
02057 <span class="preprocessor">#endif</span>
02058 <span class="preprocessor"></span><span class="preprocessor">#if defined(FE_SB)</span>
02059 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ((NumRead == 1) &amp;&amp; !CONSOLE_IS_DBCS_OUTPUTCP(Console))
02060 <span class="preprocessor">#else</span>
02061 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (NumRead == 1)
02062 <span class="preprocessor">#endif</span>
02063 <span class="preprocessor"></span>        {
02064             *((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>) = <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a40">WcharToChar</a>(Codepage, *TransBuffer);
02065         } <span class="keywordflow">else</span> {
02066             NumRead = <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a41">ConvertOutputToOem</a>(Codepage, TransBuffer, NumRead, <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, *NumRecords);
02067         }
02068         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(TransBuffer);
02069     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (StringType == <a class="code" href="../../d5/d5/conmsg_8h.html#a10">CONSOLE_REAL_UNICODE</a> &amp;&amp;
02070             (ScreenInfo-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a2">CONSOLE_OEMFONT_DISPLAY</a>) &amp;&amp;
02071             !(ScreenInfo-&gt;Console-&gt;FullScreenFlags &amp; CONSOLE_FULLSCREEN)) {
02072         <span class="comment">/*</span>
02073 <span class="comment">         * Buffer contains false Unicode (UnicodeOem) only in Windowed</span>
02074 <span class="comment">         * RasterFont mode, so in this case, convert it to real Unicode.</span>
02075 <span class="comment">         */</span>
02076         <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a43">FalseUnicodeToRealUnicode</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
02077                                 NumRead,
02078                                 ScreenInfo-&gt;Console-&gt;OutputCP
02079                                 );
02080     }
02081 
02082 <span class="preprocessor">#if defined(FE_SB)</span>
02083 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (CONSOLE_IS_DBCS_OUTPUTCP(Console))
02084         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(TransBufferA);
02085 <span class="preprocessor">#endif</span>
02086 <span class="preprocessor"></span>    *NumRecords = NumRead;
02087     <span class="keywordflow">return</span> STATUS_SUCCESS;
02088 }
02089 
02090 
02091 
02092 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02093"></a><a class="code" href="../../d6/d2/output_8c.html#a55">02093</a> <a class="code" href="../../d6/d2/output_8c.html#a55">GetScreenBufferInformation</a>(
02094     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
02095     OUT PCOORD Size,
02096     OUT PCOORD CursorPosition,
02097     OUT PCOORD ScrollPosition,
02098     OUT PWORD  Attributes,
02099     OUT PCOORD CurrentWindowSize,
02100     OUT PCOORD MaximumWindowSize
02101     )
02102 
02103 <span class="comment">/*++</span>
02104 <span class="comment"></span>
02105 <span class="comment">Routine Description:</span>
02106 <span class="comment"></span>
02107 <span class="comment">    This routine returns data about the screen buffer.</span>
02108 <span class="comment"></span>
02109 <span class="comment">Arguments:</span>
02110 <span class="comment"></span>
02111 <span class="comment">    ScreenInfo - Pointer to screen buffer information.</span>
02112 <span class="comment"></span>
02113 <span class="comment">    Size - Pointer to location in which to store screen buffer size.</span>
02114 <span class="comment"></span>
02115 <span class="comment">    CursorPosition - Pointer to location in which to store the cursor position.</span>
02116 <span class="comment"></span>
02117 <span class="comment">    ScrollPosition - Pointer to location in which to store the scroll position.</span>
02118 <span class="comment"></span>
02119 <span class="comment">    Attributes - Pointer to location in which to store the default attributes.</span>
02120 <span class="comment"></span>
02121 <span class="comment">    CurrentWindowSize - Pointer to location in which to store current window size.</span>
02122 <span class="comment"></span>
02123 <span class="comment">    MaximumWindowSize - Pointer to location in which to store maximum window size.</span>
02124 <span class="comment"></span>
02125 <span class="comment">Return Value:</span>
02126 <span class="comment"></span>
02127 <span class="comment">--*/</span>
02128 
02129 {
02130     <a class="code" href="../../d0/d9/struct__WINDOW__LIMITS.html">WINDOW_LIMITS</a> WindowLimits;
02131 
02132     *<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = ScreenInfo-&gt;ScreenBufferSize;
02133     *CursorPosition = ScreenInfo-&gt;BufferInfo.TextInfo.CursorPosition;
02134     ScrollPosition-&gt;X = ScreenInfo-&gt;Window.Left;
02135     ScrollPosition-&gt;Y = ScreenInfo-&gt;Window.Top;
02136     *Attributes = ScreenInfo-&gt;Attributes;
02137     CurrentWindowSize-&gt;X = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)<a class="code" href="../../d7/d2/output_8h.html#a17">CONSOLE_WINDOW_SIZE_X</a>(ScreenInfo);
02138     CurrentWindowSize-&gt;Y = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)<a class="code" href="../../d7/d2/output_8h.html#a18">CONSOLE_WINDOW_SIZE_Y</a>(ScreenInfo);
02139     <span class="keywordflow">if</span> (ScreenInfo-&gt;Console-&gt;FullScreenFlags &amp; CONSOLE_FULLSCREEN_HARDWARE) {
02140         MaximumWindowSize-&gt;X = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(80,ScreenInfo-&gt;ScreenBufferSize.X);
02141 <span class="preprocessor">#if defined(FE_SB)</span>
02142 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (CONSOLE_IS_DBCS_OUTPUTCP(ScreenInfo-&gt;Console))
02143         {
02144             MaximumWindowSize-&gt;Y = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(25,ScreenInfo-&gt;ScreenBufferSize.Y);
02145         }
02146         <span class="keywordflow">else</span>
02147         {
02148             MaximumWindowSize-&gt;Y = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(50,ScreenInfo-&gt;ScreenBufferSize.Y);
02149         }
02150 <span class="preprocessor">#else</span>
02151 <span class="preprocessor"></span>        MaximumWindowSize-&gt;Y = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(50,ScreenInfo-&gt;ScreenBufferSize.Y);
02152 <span class="preprocessor">#endif</span>
02153 <span class="preprocessor"></span>    } <span class="keywordflow">else</span> {
02154         <a class="code" href="../../d6/d2/output_8c.html#a39">GetWindowLimits</a>(ScreenInfo, &amp;WindowLimits);
02155         *MaximumWindowSize = WindowLimits.<a class="code" href="../../d0/d9/struct__WINDOW__LIMITS.html#o1">MaximumWindowSize</a>;
02156     }
02157     <span class="keywordflow">return</span> STATUS_SUCCESS;
02158 }
02159 
02160 
02161 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02162"></a><a class="code" href="../../d6/d2/output_8c.html#a56">02162</a> <a class="code" href="../../d6/d2/output_8c.html#a56">UpdateScrollBars</a>(
02163     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo
02164     )
02165 {
02166     <span class="keywordflow">if</span> (!<a class="code" href="../../d7/d2/output_8h.html#a12">ACTIVE_SCREEN_BUFFER</a>(ScreenInfo)) {
02167         <span class="keywordflow">return</span>;
02168     }
02169 
02170     <span class="keywordflow">if</span> (ScreenInfo-&gt;Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a10">CONSOLE_UPDATING_SCROLL_BARS</a>)
02171         <span class="keywordflow">return</span>;
02172     ScreenInfo-&gt;Console-&gt;Flags |= <a class="code" href="../../d1/d7/server_8h.html#a10">CONSOLE_UPDATING_SCROLL_BARS</a>;
02173     <a class="code" href="../../d0/d8/ntcftxt_8h.html#a20">PostMessage</a>(ScreenInfo-&gt;Console-&gt;hWnd,
02174                  <a class="code" href="../../d1/d7/server_8h.html#a71">CM_UPDATE_SCROLL_BARS</a>,
02175                  (WPARAM)ScreenInfo,
02176                  0
02177                 );
02178 }
02179 
02180 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02181"></a><a class="code" href="../../d6/d2/output_8c.html#a37">02181</a> <a class="code" href="../../d6/d2/output_8c.html#a37">InternalUpdateScrollBars</a>(
02182     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo
02183     )
02184 {
02185     SCROLLINFO si;
02186 
02187     ScreenInfo-&gt;Console-&gt;Flags &amp;= ~<a class="code" href="../../d1/d7/server_8h.html#a10">CONSOLE_UPDATING_SCROLL_BARS</a>;
02188     <span class="keywordflow">if</span> (!<a class="code" href="../../d7/d2/output_8h.html#a12">ACTIVE_SCREEN_BUFFER</a>(ScreenInfo)) {
02189         <span class="keywordflow">return</span>;
02190     }
02191 
02192     ScreenInfo-&gt;ResizingWindow++;
02193 
02194     si.cbSize = <span class="keyword">sizeof</span>(si);
02195     si.fMask = SIF_ALL;
02196     si.nPage = <a class="code" href="../../d7/d2/output_8h.html#a18">CONSOLE_WINDOW_SIZE_Y</a>(ScreenInfo);
02197     si.nMin = 0;
02198     si.nMax = ScreenInfo-&gt;ScreenBufferSize.Y - 1;
02199     si.nPos = ScreenInfo-&gt;Window.Top;
02200     SetScrollInfo(ScreenInfo-&gt;Console-&gt;hWnd, SB_VERT, &amp;si, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02201 
02202     si.cbSize = <span class="keyword">sizeof</span>(si);
02203     si.fMask = SIF_ALL;
02204     si.nPage = <a class="code" href="../../d7/d2/output_8h.html#a17">CONSOLE_WINDOW_SIZE_X</a>(ScreenInfo);
02205     si.nMin = 0;
02206     si.nMax = ScreenInfo-&gt;ScreenBufferSize.X - 1;
02207     si.nPos = ScreenInfo-&gt;Window.Left;
02208     SetScrollInfo(ScreenInfo-&gt;Console-&gt;hWnd, SB_HORZ, &amp;si, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02209 
02210     ScreenInfo-&gt;ResizingWindow--;
02211 }
02212 
02213 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02214"></a><a class="code" href="../../d6/d2/output_8c.html#a57">02214</a> <a class="code" href="../../d6/d2/output_8c.html#a57">ScreenBufferSizeChange</a>(
02215     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
02216     IN COORD NewSize
02217     )
02218 {
02219     INPUT_RECORD InputEvent;
02220 
02221     InputEvent.EventType = WINDOW_BUFFER_SIZE_EVENT;
02222     InputEvent.Event.WindowBufferSizeEvent.dwSize = NewSize;
02223     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a30">WriteInputBuffer</a>(ScreenInfo-&gt;Console,
02224                      &amp;ScreenInfo-&gt;Console-&gt;InputBuffer,
02225                      &amp;InputEvent,
02226                      1
02227                      );
02228 }
02229 
02230 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02231"></a><a class="code" href="../../d6/d2/output_8c.html#a58">02231</a> <a class="code" href="../../d6/d2/output_8c.html#a58">ResizeScreenBuffer</a>(
02232     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
02233     IN COORD NewScreenSize,
02234     IN BOOL DoScrollBarUpdate
02235     )
02236 
02237 <span class="comment">/*++</span>
02238 <span class="comment"></span>
02239 <span class="comment">Routine Description:</span>
02240 <span class="comment"></span>
02241 <span class="comment">    This routine resizes the screen buffer.</span>
02242 <span class="comment"></span>
02243 <span class="comment">Arguments:</span>
02244 <span class="comment"></span>
02245 <span class="comment">    ScreenInfo - pointer to screen buffer info.</span>
02246 <span class="comment"></span>
02247 <span class="comment">    NewScreenSize - new size of screen.</span>
02248 <span class="comment"></span>
02249 <span class="comment">Return Value:</span>
02250 <span class="comment"></span>
02251 <span class="comment">--*/</span>
02252 
02253 {
02254     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> i,j;
02255     BOOLEAN WindowMaximizedX,WindowMaximizedY;
02256     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> LimitX,LimitY;
02257     PWCHAR TextRows,TextRowPtr;
02258     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d3/d8/client_8c.html#a140">UpdateWindow</a>;
02259     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> TopRow,TopRowIndex; <span class="comment">// new top row of screen buffer</span>
02260     COORD CursorPosition;
02261 <span class="preprocessor">#if defined(FE_SB)</span>
02262 <span class="preprocessor"></span>    DBCS_SCREEN_BUFFER NewDbcsScreenBuffer;
02263     <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a> TextRowPtrA;
02264 <span class="preprocessor">#endif</span>
02265 <span class="preprocessor"></span>
02266     <span class="comment">//</span>
02267     <span class="comment">// Don't allow resize of graphics apps</span>
02268     <span class="comment">//</span>
02269 
02270     <span class="keywordflow">if</span> (!(ScreenInfo-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>)) {
02271         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
02272     }
02273 
02274     TextRows = (PWCHAR)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a20">SCREEN_TAG</a> ),NewScreenSize.X*NewScreenSize.Y*<span class="keyword">sizeof</span>(WCHAR));
02275     <span class="keywordflow">if</span> (TextRows == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02276         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
02277     }
02278 <span class="preprocessor">#if defined(FE_SB)</span>
02279 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (! <a class="code" href="../../d6/d2/output_8c.html#a86">CreateDbcsScreenBuffer</a>(ScreenInfo-&gt;Console,NewScreenSize,&amp;NewDbcsScreenBuffer))
02280     {
02281         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(TextRows);
02282         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
02283     }
02284 <span class="preprocessor">#endif</span>
02285 <span class="preprocessor"></span>    LimitX = (NewScreenSize.X &lt; ScreenInfo-&gt;ScreenBufferSize.X) ?
02286               NewScreenSize.X : ScreenInfo-&gt;ScreenBufferSize.X;
02287     LimitY = (NewScreenSize.Y &lt; ScreenInfo-&gt;ScreenBufferSize.Y) ?
02288               NewScreenSize.Y : ScreenInfo-&gt;ScreenBufferSize.Y;
02289     TopRow = 0;
02290     <span class="keywordflow">if</span> (NewScreenSize.Y &lt;= ScreenInfo-&gt;BufferInfo.TextInfo.CursorPosition.Y) {
02291         TopRow += ScreenInfo-&gt;BufferInfo.TextInfo.CursorPosition.Y - NewScreenSize.Y + 1;
02292     }
02293     TopRowIndex = (ScreenInfo-&gt;BufferInfo.TextInfo.FirstRow+TopRow) % ScreenInfo-&gt;ScreenBufferSize.Y;
02294     <span class="keywordflow">if</span> (NewScreenSize.Y != ScreenInfo-&gt;ScreenBufferSize.Y) {
02295         <a class="code" href="../../d9/d4/struct__ROW.html">PROW</a> Temp;
02296         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> NumToCopy,NumToCopy2;
02297 
02298         <span class="comment">//</span>
02299         <span class="comment">// resize ROWs array.  first alloc a new ROWs array. then copy the old</span>
02300         <span class="comment">// one over, resetting the FirstRow.</span>
02301         <span class="comment">//</span>
02302         <span class="comment">//</span>
02303 
02304         Temp = (<a class="code" href="../../d9/d4/struct__ROW.html">PROW</a>)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a20">SCREEN_TAG</a> ),NewScreenSize.Y*<span class="keyword">sizeof</span>(<a class="code" href="../../d9/d4/struct__ROW.html">ROW</a>));
02305         <span class="keywordflow">if</span> (Temp == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02306             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(TextRows);
02307 <span class="preprocessor">#if defined(FE_SB)</span>
02308 <span class="preprocessor"></span>            <a class="code" href="../../d6/d2/output_8c.html#a87">DeleteDbcsScreenBuffer</a>(&amp;NewDbcsScreenBuffer);
02309 <span class="preprocessor">#endif</span>
02310 <span class="preprocessor"></span>            <span class="keywordflow">return</span> STATUS_NO_MEMORY;
02311         }
02312         NumToCopy = ScreenInfo-&gt;ScreenBufferSize.Y-TopRowIndex;
02313         <span class="keywordflow">if</span> (NumToCopy &gt; NewScreenSize.Y)
02314             NumToCopy = NewScreenSize.Y;
02315         RtlCopyMemory(Temp,&amp;ScreenInfo-&gt;BufferInfo.TextInfo.Rows[TopRowIndex],NumToCopy*<span class="keyword">sizeof</span>(<a class="code" href="../../d7/d2/output_8h.html#a27">ROW</a>));
02316         <span class="keywordflow">if</span> (TopRowIndex!=0 &amp;&amp; NumToCopy != NewScreenSize.Y) {
02317             NumToCopy2 = TopRowIndex;
02318             <span class="keywordflow">if</span> (NumToCopy2 &gt; (NewScreenSize.Y-NumToCopy))
02319                 NumToCopy2 = NewScreenSize.Y-NumToCopy;
02320             RtlCopyMemory(&amp;Temp[NumToCopy],
02321                    ScreenInfo-&gt;BufferInfo.TextInfo.Rows,
02322                    NumToCopy2*<span class="keyword">sizeof</span>(<a class="code" href="../../d7/d2/output_8h.html#a27">ROW</a>)
02323                   );
02324         }
02325         <span class="keywordflow">for</span> (i=0;i&lt;LimitY;i++) {
02326             <span class="keywordflow">if</span> (Temp[i].<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o0">Length</a> == 1) {
02327                 Temp[i].<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o2">Attrs</a> = &amp;Temp[i].<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o1">AttrPair</a>;
02328             }
02329         }
02330 
02331         <span class="comment">//</span>
02332         <span class="comment">// if the new screen buffer has fewer rows than the existing one,</span>
02333         <span class="comment">// free the extra rows.  if the new screen buffer has more rows</span>
02334         <span class="comment">// than the existing one, allocate new rows.</span>
02335         <span class="comment">//</span>
02336 
02337         <span class="keywordflow">if</span> (NewScreenSize.Y &lt; ScreenInfo-&gt;ScreenBufferSize.Y) {
02338             i = (TopRowIndex+NewScreenSize.Y) % ScreenInfo-&gt;ScreenBufferSize.Y;
02339             <span class="keywordflow">for</span> (j=NewScreenSize.Y;j&lt;ScreenInfo-&gt;ScreenBufferSize.Y;j++) {
02340                 <span class="keywordflow">if</span> (ScreenInfo-&gt;BufferInfo.TextInfo.Rows[i].AttrRow.Length &gt; 1) {
02341                     <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(ScreenInfo-&gt;BufferInfo.TextInfo.Rows[i].AttrRow.Attrs);
02342                 }
02343                 <span class="keywordflow">if</span> (++i == ScreenInfo-&gt;ScreenBufferSize.Y) {
02344                     i = 0;
02345                 }
02346             }
02347         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NewScreenSize.Y &gt; ScreenInfo-&gt;ScreenBufferSize.Y) {
02348             <span class="keywordflow">for</span> (i=ScreenInfo-&gt;ScreenBufferSize.Y;i&lt;NewScreenSize.Y;i++) {
02349                 Temp[i].<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o0">Length</a> = 1;
02350                 Temp[i].<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o1">AttrPair</a>.<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o0">Length</a> = NewScreenSize.X;
02351                 Temp[i].<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o1">AttrPair</a>.<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a> = ScreenInfo-&gt;Attributes;
02352                 Temp[i].<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o2">Attrs</a> = &amp;Temp[i].<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o1">AttrPair</a>;
02353             }
02354         }
02355         ScreenInfo-&gt;BufferInfo.TextInfo.FirstRow = 0;
02356         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(ScreenInfo-&gt;BufferInfo.TextInfo.Rows);
02357         ScreenInfo-&gt;BufferInfo.TextInfo.Rows = Temp;
02358     }
02359 
02360     <span class="comment">//</span>
02361     <span class="comment">// Realloc each row.  any horizontal growth results in the last</span>
02362     <span class="comment">// attribute in a row getting extended.</span>
02363     <span class="comment">//</span>
02364 <span class="preprocessor">#if defined(FE_SB)</span>
02365 <span class="preprocessor"></span>    TextRowPtrA=NewDbcsScreenBuffer.KAttrRows;
02366 <span class="preprocessor">#endif</span>
02367 <span class="preprocessor"></span>    <span class="keywordflow">for</span> (i=0,TextRowPtr=TextRows;i&lt;LimitY;i++,TextRowPtr+=NewScreenSize.X)
02368     {
02369         RtlCopyMemory(TextRowPtr,
02370                ScreenInfo-&gt;BufferInfo.TextInfo.Rows[i].CharRow.Chars,
02371                LimitX*<span class="keyword">sizeof</span>(WCHAR));
02372 <span class="preprocessor">#if defined(FE_SB)</span>
02373 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (TextRowPtrA) {
02374             RtlCopyMemory(TextRowPtrA,
02375                           ScreenInfo-&gt;BufferInfo.TextInfo.Rows[i].CharRow.KAttrs,
02376                           LimitX*<span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>));
02377         }
02378 <span class="preprocessor">#endif</span>
02379 <span class="preprocessor"></span>        <span class="keywordflow">for</span> (j=ScreenInfo-&gt;ScreenBufferSize.X;j&lt;NewScreenSize.X;j++) {
02380             TextRowPtr[j] = (WCHAR)<span class="charliteral">' '</span>;
02381         }
02382 
02383         <span class="keywordflow">if</span> (ScreenInfo-&gt;BufferInfo.TextInfo.Rows[i].CharRow.Right &gt; NewScreenSize.X) {
02384             ScreenInfo-&gt;BufferInfo.TextInfo.Rows[i].CharRow.OldRight = <a class="code" href="../../d7/d2/output_8h.html#a5">INVALID_OLD_LENGTH</a>;
02385             ScreenInfo-&gt;BufferInfo.TextInfo.Rows[i].CharRow.Right = NewScreenSize.X;
02386         }
02387         ScreenInfo-&gt;BufferInfo.TextInfo.Rows[i].CharRow.Chars = TextRowPtr;
02388 <span class="preprocessor">#if defined(FE_SB)</span>
02389 <span class="preprocessor"></span>        ScreenInfo-&gt;BufferInfo.TextInfo.Rows[i].CharRow.KAttrs = TextRowPtrA;
02390         <span class="keywordflow">if</span> (TextRowPtrA) {
02391             <span class="keywordflow">if</span> (NewScreenSize.X &gt; ScreenInfo-&gt;ScreenBufferSize.X)
02392                 RtlZeroMemory(TextRowPtrA+ScreenInfo-&gt;ScreenBufferSize.X,
02393                               NewScreenSize.X-ScreenInfo-&gt;ScreenBufferSize.X);
02394             TextRowPtrA+=NewScreenSize.X;
02395         }
02396 <span class="preprocessor">#endif</span>
02397 <span class="preprocessor"></span>    }
02398     <span class="keywordflow">for</span> (;i&lt;NewScreenSize.Y;i++,TextRowPtr+=NewScreenSize.X)
02399     {
02400         <span class="keywordflow">for</span> (j=0;j&lt;NewScreenSize.X;j++) {
02401             TextRowPtr[j] = (WCHAR)<span class="charliteral">' '</span>;
02402         }
02403 <span class="preprocessor">#if defined(FE_SB)</span>
02404 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (TextRowPtrA) {
02405            RtlZeroMemory(TextRowPtrA, NewScreenSize.X);
02406         }
02407 <span class="preprocessor">#endif</span>
02408 <span class="preprocessor"></span>        ScreenInfo-&gt;BufferInfo.TextInfo.Rows[i].CharRow.Chars = TextRowPtr;
02409         ScreenInfo-&gt;BufferInfo.TextInfo.Rows[i].CharRow.OldLeft = <a class="code" href="../../d7/d2/output_8h.html#a5">INVALID_OLD_LENGTH</a>;
02410         ScreenInfo-&gt;BufferInfo.TextInfo.Rows[i].CharRow.OldRight = <a class="code" href="../../d7/d2/output_8h.html#a5">INVALID_OLD_LENGTH</a>;
02411         ScreenInfo-&gt;BufferInfo.TextInfo.Rows[i].CharRow.Left = NewScreenSize.X;
02412         ScreenInfo-&gt;BufferInfo.TextInfo.Rows[i].CharRow.Right = 0;
02413 <span class="preprocessor">#if defined(FE_SB)</span>
02414 <span class="preprocessor"></span>        ScreenInfo-&gt;BufferInfo.TextInfo.Rows[i].CharRow.KAttrs = TextRowPtrA;
02415         <span class="keywordflow">if</span> (TextRowPtrA) {
02416             TextRowPtrA+=NewScreenSize.X;
02417         }
02418 <span class="preprocessor">#endif</span>
02419 <span class="preprocessor"></span>    }
02420     <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(ScreenInfo-&gt;BufferInfo.TextInfo.TextRows);
02421     ScreenInfo-&gt;BufferInfo.TextInfo.TextRows = TextRows;
02422 <span class="preprocessor">#if defined(FE_SB)</span>
02423 <span class="preprocessor"></span>    <a class="code" href="../../d6/d2/output_8c.html#a87">DeleteDbcsScreenBuffer</a>(&amp;ScreenInfo-&gt;BufferInfo.TextInfo.DbcsScreenBuffer);
02424     ScreenInfo-&gt;BufferInfo.TextInfo.DbcsScreenBuffer = NewDbcsScreenBuffer;
02425 <span class="preprocessor">#endif</span>
02426 <span class="preprocessor"></span>
02427     <span class="keywordflow">if</span> (NewScreenSize.X != ScreenInfo-&gt;ScreenBufferSize.X) {
02428         <span class="keywordflow">for</span> (i=0;i&lt;LimitY;i++) {
02429             <a class="code" href="../../d3/d2/struct__ATTR__PAIR.html">PATTR_PAIR</a> IndexedAttr;
02430             <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> CountOfAttr;
02431 
02432             <span class="keywordflow">if</span> (NewScreenSize.X &gt; ScreenInfo-&gt;ScreenBufferSize.X) {
02433                 <a class="code" href="../../d6/d2/output_8c.html#a47">FindAttrIndex</a>(ScreenInfo-&gt;BufferInfo.TextInfo.Rows[i].AttrRow.Attrs,
02434                               (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ScreenInfo-&gt;ScreenBufferSize.X-1),
02435                               &amp;IndexedAttr,
02436                               &amp;CountOfAttr
02437                              );
02438   <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (IndexedAttr &lt;=
02439     &amp;ScreenInfo-&gt;BufferInfo.TextInfo.Rows[i].AttrRow.Attrs[ScreenInfo-&gt;BufferInfo.TextInfo.Rows[i].AttrRow.<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o0">Length</a>-1]);
02440                 IndexedAttr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o0">Length</a> += NewScreenSize.X - ScreenInfo-&gt;ScreenBufferSize.X;
02441             }
02442             <span class="keywordflow">else</span> {
02443 
02444                 <a class="code" href="../../d6/d2/output_8c.html#a47">FindAttrIndex</a>(ScreenInfo-&gt;BufferInfo.TextInfo.Rows[i].AttrRow.Attrs,
02445                               (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(NewScreenSize.X-1),
02446                               &amp;IndexedAttr,
02447                               &amp;CountOfAttr
02448                              );
02449                 IndexedAttr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o0">Length</a> -= CountOfAttr-1;
02450                 <span class="keywordflow">if</span> (ScreenInfo-&gt;BufferInfo.TextInfo.Rows[i].AttrRow.Length != 1)  {
02451                     ScreenInfo-&gt;BufferInfo.TextInfo.Rows[i].AttrRow.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(IndexedAttr - ScreenInfo-&gt;BufferInfo.TextInfo.Rows[i].AttrRow.Attrs + 1);
02452                     <span class="keywordflow">if</span> (ScreenInfo-&gt;BufferInfo.TextInfo.Rows[i].AttrRow.Length != 1) {
02453                         ScreenInfo-&gt;BufferInfo.TextInfo.Rows[i].AttrRow.Attrs = (<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html">PATTR_PAIR</a>)<a class="code" href="../../d8/d5/consrv_8h.html#a37">ConsoleHeapReAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a20">SCREEN_TAG</a> ),ScreenInfo-&gt;BufferInfo.TextInfo.Rows[i].AttrRow.Attrs,
02454                                                                          ScreenInfo-&gt;BufferInfo.TextInfo.Rows[i].AttrRow.Length * <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html">ATTR_PAIR</a>));
02455                     }
02456                     <span class="keywordflow">else</span> {
02457                         ScreenInfo-&gt;BufferInfo.TextInfo.Rows[i].AttrRow.AttrPair = *IndexedAttr;
02458                         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(ScreenInfo-&gt;BufferInfo.TextInfo.Rows[i].AttrRow.Attrs);
02459                         ScreenInfo-&gt;BufferInfo.TextInfo.Rows[i].AttrRow.Attrs = &amp;ScreenInfo-&gt;BufferInfo.TextInfo.Rows[i].AttrRow.AttrPair;
02460                     }
02461                 }
02462             }
02463         }
02464     }
02465 
02466     <span class="comment">//</span>
02467     <span class="comment">// if the screen buffer is resized smaller than the saved</span>
02468     <span class="comment">// window size, shrink the saved window size.</span>
02469     <span class="comment">//</span>
02470 <span class="preprocessor">#ifdef i386</span>
02471 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (ScreenInfo-&gt;Console-&gt;FullScreenFlags &amp; CONSOLE_FULLSCREEN) {
02472         <span class="keywordflow">if</span> (NewScreenSize.X &lt; ScreenInfo-&gt;BufferInfo.TextInfo.WindowedWindowSize.X) {
02473             ScreenInfo-&gt;BufferInfo.TextInfo.WindowedWindowSize.X = NewScreenSize.X;
02474         }
02475         <span class="keywordflow">if</span> (NewScreenSize.Y &lt; ScreenInfo-&gt;BufferInfo.TextInfo.WindowedWindowSize.Y) {
02476             ScreenInfo-&gt;BufferInfo.TextInfo.WindowedWindowSize.Y = NewScreenSize.Y;
02477         }
02478         ScreenInfo-&gt;BufferInfo.TextInfo.WindowedScreenSize = NewScreenSize;
02479     }
02480 <span class="preprocessor">#endif</span>
02481 <span class="preprocessor"></span>
02482     <a class="code" href="../../d3/d8/client_8c.html#a140">UpdateWindow</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02483 
02484     <span class="comment">//</span>
02485     <span class="comment">// if the screen buffer shrunk beyond the boundaries of the window,</span>
02486     <span class="comment">// adjust the window origin.</span>
02487     <span class="comment">//</span>
02488 
02489     <span class="keywordflow">if</span> (NewScreenSize.X &gt; <a class="code" href="../../d7/d2/output_8h.html#a17">CONSOLE_WINDOW_SIZE_X</a>(ScreenInfo)) {
02490         <span class="keywordflow">if</span> (ScreenInfo-&gt;Window.Right &gt;= NewScreenSize.X) {
02491             ScreenInfo-&gt;Window.Left -= ScreenInfo-&gt;Window.Right - NewScreenSize.X + 1;
02492             ScreenInfo-&gt;Window.Right -= ScreenInfo-&gt;Window.Right - NewScreenSize.X + 1;
02493             <a class="code" href="../../d3/d8/client_8c.html#a140">UpdateWindow</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02494         }
02495     } <span class="keywordflow">else</span> {
02496         ScreenInfo-&gt;Window.Left = 0;
02497         ScreenInfo-&gt;Window.Right = NewScreenSize.X - 1;
02498         <a class="code" href="../../d3/d8/client_8c.html#a140">UpdateWindow</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02499     }
02500     <span class="keywordflow">if</span> (NewScreenSize.Y &gt; <a class="code" href="../../d7/d2/output_8h.html#a18">CONSOLE_WINDOW_SIZE_Y</a>(ScreenInfo)) {
02501         <span class="keywordflow">if</span> (ScreenInfo-&gt;Window.Bottom &gt;= NewScreenSize.Y) {
02502             ScreenInfo-&gt;Window.Top -= ScreenInfo-&gt;Window.Bottom - NewScreenSize.Y + 1;
02503             ScreenInfo-&gt;Window.Bottom -= ScreenInfo-&gt;Window.Bottom - NewScreenSize.Y + 1;
02504             <a class="code" href="../../d3/d8/client_8c.html#a140">UpdateWindow</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02505         }
02506     } <span class="keywordflow">else</span> {
02507         ScreenInfo-&gt;Window.Top = 0;
02508         ScreenInfo-&gt;Window.Bottom = NewScreenSize.Y - 1;
02509         <a class="code" href="../../d3/d8/client_8c.html#a140">UpdateWindow</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02510     }
02511 
02512 <span class="preprocessor">#if defined(FE_SB)</span>
02513 <span class="preprocessor"></span>    <span class="comment">// Should be sets ScreenBufferSize before calls SetCursorPosition</span>
02514     <span class="comment">// because SetCursorPosition refer ScreenBufferSize.</span>
02515     <span class="comment">// Also, FE version refer in InvertPixels.</span>
02516     <span class="comment">//</span>
02517     <span class="comment">// kkntbug:11311</span>
02518     ScreenInfo-&gt;ScreenBufferSize = NewScreenSize;
02519 <span class="preprocessor">#endif</span>
02520 <span class="preprocessor"></span>
02521     <span class="comment">//</span>
02522     <span class="comment">// adjust cursor position if it's no longer with screen buffer</span>
02523     <span class="comment">//</span>
02524 
02525     CursorPosition=ScreenInfo-&gt;BufferInfo.TextInfo.CursorPosition;
02526     <span class="keywordflow">if</span> (CursorPosition.X &gt;= NewScreenSize.X) {
02527         <span class="keywordflow">if</span> (ScreenInfo-&gt;OutputMode &amp; ENABLE_WRAP_AT_EOL_OUTPUT) {
02528             CursorPosition.X = 0;
02529             CursorPosition.Y += 1;
02530         } <span class="keywordflow">else</span> {
02531             CursorPosition.X = NewScreenSize.X-1;
02532         }
02533     }
02534     <span class="keywordflow">if</span> (CursorPosition.Y &gt;= NewScreenSize.Y) {
02535         CursorPosition.Y = NewScreenSize.Y-1;
02536     }
02537 <span class="preprocessor">#if defined(FE_SB)</span>
02538 <span class="preprocessor"></span>    <span class="comment">// set cursor position Y is ZERO when expand screen buffer with IME open mode</span>
02539     <span class="comment">// from screen buffer is one line mode.</span>
02540     <span class="comment">// Because, One line screen buffer mode and IME open mode is set -1 as cursor position Y.</span>
02541     <span class="keywordflow">if</span> (ScreenInfo-&gt;Console-&gt;InputBuffer.ImeMode.Open &amp;&amp; CursorPosition.Y &lt; 0) {
02542         CursorPosition.Y = 0;
02543     }
02544 <span class="preprocessor">#endif</span>
02545 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (CursorPosition.X != ScreenInfo-&gt;BufferInfo.TextInfo.CursorPosition.X ||
02546         CursorPosition.Y != ScreenInfo-&gt;BufferInfo.TextInfo.CursorPosition.Y) {
02547         <a class="code" href="../../d6/d1/ntcon_2server_2cursor_8c.html#a7">SetCursorPosition</a>(ScreenInfo,
02548                           CursorPosition,
02549                           <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
02550                           );
02551     }
02552 
02553     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ScreenInfo-&gt;Window.Left &gt;= 0);
02554     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ScreenInfo-&gt;Window.Right &lt; NewScreenSize.X);
02555     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ScreenInfo-&gt;Window.Top &gt;= 0);
02556     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ScreenInfo-&gt;Window.Bottom &lt; NewScreenSize.Y);
02557 
02558     ScreenInfo-&gt;ScreenBufferSize = NewScreenSize;
02559     <a class="code" href="../../d6/d2/output_8c.html#a49">ResetTextFlags</a>(ScreenInfo,0,(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ScreenInfo-&gt;ScreenBufferSize.Y-1));
02560     WindowMaximizedX = (<a class="code" href="../../d7/d2/output_8h.html#a17">CONSOLE_WINDOW_SIZE_X</a>(ScreenInfo) ==
02561                           ScreenInfo-&gt;ScreenBufferSize.X);
02562     WindowMaximizedY = (<a class="code" href="../../d7/d2/output_8h.html#a18">CONSOLE_WINDOW_SIZE_Y</a>(ScreenInfo) ==
02563                           ScreenInfo-&gt;ScreenBufferSize.Y);
02564 
02565 <span class="preprocessor">#if defined(FE_IME)</span>
02566 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/consrv_8h.html#a33">CONSOLE_IS_IME_ENABLED</a>()) {
02567         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ConsoleImeMessagePump(ScreenInfo-&gt;Console,
02568                               <a class="code" href="../../d3/d5/conime_8h.html#a16">CONIME_NOTIFY_SCREENBUFFERSIZE</a>,
02569                               (WPARAM)ScreenInfo-&gt;Console-&gt;ConsoleHandle,
02570                               (LPARAM)MAKELPARAM(NewScreenSize.X, NewScreenSize.Y)
02571                              ))) {
02572             <span class="keywordflow">return</span> STATUS_INVALID_HANDLE;
02573         }
02574     }
02575 
02576     <span class="keywordflow">if</span> ( (! ScreenInfo-&gt;ConvScreenInfo) &amp;&amp;
02577          (CONSOLE_IS_DBCS_OUTPUTCP(ScreenInfo-&gt;Console)))
02578     {
02579         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ConsoleImeResizeModeSystemScreenBuffer(ScreenInfo-&gt;Console,NewScreenSize)) ||
02580                 !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ConsoleImeResizeCompStrScreenBuffer(ScreenInfo-&gt;Console,NewScreenSize))) {
02581             <span class="comment">/*</span>
02582 <span class="comment">             * If something went wrong, just bail out.</span>
02583 <span class="comment">             */</span>
02584             <span class="keywordflow">return</span> STATUS_INVALID_HANDLE;
02585         }
02586     }
02587 <span class="preprocessor">#endif // FE_IME</span>
02588 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (ScreenInfo-&gt;WindowMaximizedX != WindowMaximizedX ||
02589         ScreenInfo-&gt;WindowMaximizedY != WindowMaximizedY) {
02590         ScreenInfo-&gt;WindowMaximizedX = WindowMaximizedX;
02591         ScreenInfo-&gt;WindowMaximizedY = WindowMaximizedY;
02592         <a class="code" href="../../d3/d8/client_8c.html#a140">UpdateWindow</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02593     }
02594     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/client_8c.html#a140">UpdateWindow</a>) {
02595         <a class="code" href="../../d6/d2/output_8c.html#a68">SetWindowSize</a>(ScreenInfo);
02596     }
02597 
02598     <span class="keywordflow">if</span> (DoScrollBarUpdate) {
02599          <a class="code" href="../../d6/d2/output_8c.html#a56">UpdateScrollBars</a>(ScreenInfo);
02600     }
02601     <span class="keywordflow">if</span> (ScreenInfo-&gt;Console-&gt;InputBuffer.InputMode &amp; ENABLE_WINDOW_INPUT) {
02602         <a class="code" href="../../d6/d2/output_8c.html#a57">ScreenBufferSizeChange</a>(ScreenInfo,ScreenInfo-&gt;ScreenBufferSize);
02603     }
02604 
02605     <span class="keywordflow">return</span> STATUS_SUCCESS;
02606 }
02607 
02608 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02609"></a><a class="code" href="../../d6/d2/output_8c.html#a35">02609</a> <a class="code" href="../../d6/d2/output_8c.html#a35">AllocateScrollBuffer</a>(
02610     DWORD Size
02611     )
02612 {
02613     <a class="code" href="../../d6/d2/output_8c.html#a19">ScrollBuffer</a> = (PCHAR_INFO)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a20">SCREEN_TAG</a> ),<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>);
02614     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/output_8c.html#a19">ScrollBuffer</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02615         <a class="code" href="../../d6/d2/output_8c.html#a20">ScrollBufferSize</a> = 0;
02616         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
02617     }
02618     <a class="code" href="../../d6/d2/output_8c.html#a20">ScrollBufferSize</a> = <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
02619     <span class="keywordflow">return</span> STATUS_SUCCESS;
02620 }
02621 
02622 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02623"></a><a class="code" href="../../d6/d2/output_8c.html#a36">02623</a> <a class="code" href="../../d6/d2/output_8c.html#a36">FreeScrollBuffer</a>( VOID )
02624 {
02625     <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(<a class="code" href="../../d6/d2/output_8c.html#a19">ScrollBuffer</a>);
02626     <a class="code" href="../../d6/d2/output_8c.html#a19">ScrollBuffer</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02627     <a class="code" href="../../d6/d2/output_8c.html#a20">ScrollBufferSize</a> = 0;
02628 }
02629 
02630 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02631"></a><a class="code" href="../../d6/d2/output_8c.html#a59">02631</a> <a class="code" href="../../d6/d2/output_8c.html#a59">InitializeScrollBuffer</a>( VOID )
02632 {
02633     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02634 
02635     <a class="code" href="../../d6/d2/output_8c.html#a25">ghrgnScroll</a> = CreateRectRgn(0,0,1,1);
02636     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/output_8c.html#a25">ghrgnScroll</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02637         RIPMSG0(RIP_WARNING, <span class="stringliteral">"InitializeScrollBuffer: cannot allocate ghrgnScroll."</span>);
02638         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
02639     }
02640     <a class="code" href="../../d6/d2/output_8c.html#a26">gprgnData</a> = (LPRGNDATA)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a20">SCREEN_TAG</a> ),<a class="code" href="../../d6/d2/output_8c.html#a4">GRGNDATASIZE</a>);
02641     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/output_8c.html#a26">gprgnData</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02642         RIPMSG0(RIP_WARNING, <span class="stringliteral">"InitializeScrollBuffer: allocate gprgnData."</span>);
02643         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
02644         <span class="keywordflow">goto</span> error;
02645     }
02646 
02647     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d2/output_8c.html#a35">AllocateScrollBuffer</a>(<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o0">ScreenBufferSize</a>.X *
02648                                   <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a0">DefaultRegInfo</a>.<a class="code" href="../../d7/d4/struct__CONSOLE__REGISTRY__INFO.html#o0">ScreenBufferSize</a>.Y *
02649                                   <span class="keyword">sizeof</span>(CHAR_INFO));
02650     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02651         <span class="keywordflow">goto</span> error;
02652     }
02653 
02654     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d8/dll_2resource_8c.html#a26">RtlInitializeCriticalSectionAndSpinCount</a>(&amp;<a class="code" href="../../d6/d2/output_8c.html#a21">ScrollBufferLock</a>,
02655                                                       0x80000000);
02656 
02657 error:
02658     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02659         RIPMSG0(RIP_WARNING, <span class="stringliteral">"InitializeScrollBuffer failed, cleaning up"</span>);
02660         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/output_8c.html#a25">ghrgnScroll</a>) {
02661             DeleteObject(<a class="code" href="../../d6/d2/output_8c.html#a25">ghrgnScroll</a>);
02662             <a class="code" href="../../d6/d2/output_8c.html#a25">ghrgnScroll</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02663         }
02664         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/output_8c.html#a26">gprgnData</a>) {
02665             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(<a class="code" href="../../d6/d2/output_8c.html#a26">gprgnData</a>);
02666             <a class="code" href="../../d6/d2/output_8c.html#a26">gprgnData</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02667         }
02668     }
02669 
02670     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02671 }
02672 
02673 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02674"></a><a class="code" href="../../d6/d2/output_8c.html#a60">02674</a> <a class="code" href="../../d6/d2/output_8c.html#a60">UpdateComplexRegion</a>(
02675     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
02676     IN COORD FontSize
02677     )
02678 {
02679     <span class="keywordtype">int</span> iSize,i;
02680     LPRECT pRect;
02681     SMALL_RECT UpdateRegion;
02682     LPRGNDATA pRgnData;
02683 
02684     <span class="keywordflow">if</span> (ScreenInfo-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>) {
02685         ScreenInfo-&gt;BufferInfo.TextInfo.Flags &amp;= ~<a class="code" href="../../d7/d2/output_8h.html#a3">TEXT_VALID_HINT</a>;
02686     }
02687     pRgnData = <a class="code" href="../../d6/d2/output_8c.html#a26">gprgnData</a>;
02688 
02689     <span class="comment">/*</span>
02690 <span class="comment">     * the dreaded complex region.</span>
02691 <span class="comment">     */</span>
02692     iSize = GetRegionData(<a class="code" href="../../d6/d2/output_8c.html#a25">ghrgnScroll</a>, 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02693     <span class="keywordflow">if</span> (iSize &gt; <a class="code" href="../../d6/d2/output_8c.html#a4">GRGNDATASIZE</a>) {
02694         pRgnData = (LPRGNDATA)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a9">TMP_TAG</a> ),iSize);
02695         <span class="keywordflow">if</span> (pRgnData == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02696             <span class="keywordflow">return</span>;
02697     }
02698 
02699     <span class="keywordflow">if</span> (!GetRegionData(<a class="code" href="../../d6/d2/output_8c.html#a25">ghrgnScroll</a>, iSize, pRgnData)) {
02700         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02701         <span class="keywordflow">if</span> (pRgnData != <a class="code" href="../../d6/d2/output_8c.html#a26">gprgnData</a>) {
02702             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(pRgnData);
02703         }
02704         <span class="keywordflow">return</span>;
02705     }
02706 
02707     pRect = (PRECT)&amp;pRgnData-&gt;Buffer;
02708 
02709     <span class="comment">/*</span>
02710 <span class="comment">     * Redraw each rectangle</span>
02711 <span class="comment">     */</span>
02712     <span class="keywordflow">for</span>(i=0;i&lt;(<span class="keywordtype">int</span>)pRgnData-&gt;rdh.nCount;i++,pRect++) {
02713         <span class="comment">/*</span>
02714 <span class="comment">         * ICK!!!!!! Convert to chars. This sucks. We know</span>
02715 <span class="comment">         * this is only get to get converted back during</span>
02716 <span class="comment">         * the textout call.</span>
02717 <span class="comment">         */</span>
02718         UpdateRegion.Left = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)((pRect-&gt;left/FontSize.X)+ \
02719                             ScreenInfo-&gt;Window.Left);
02720         UpdateRegion.Right = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(((pRect-&gt;right-1)/FontSize.X)+ \
02721                             ScreenInfo-&gt;Window.Left);
02722         UpdateRegion.Top = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)((pRect-&gt;top/FontSize.Y)+ \
02723                             ScreenInfo-&gt;Window.Top);
02724         UpdateRegion.Bottom = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(((pRect-&gt;bottom-1)/FontSize.Y)+ \
02725                             ScreenInfo-&gt;Window.Top);
02726         <span class="comment">/*</span>
02727 <span class="comment">         * Fill the rectangle with goodies.</span>
02728 <span class="comment">         */</span>
02729         <a class="code" href="../../d6/d8/dispatch_8h.html#a4">WriteToScreen</a>(ScreenInfo, &amp;UpdateRegion);
02730     }
02731     <span class="keywordflow">if</span> (pRgnData != <a class="code" href="../../d6/d2/output_8c.html#a26">gprgnData</a>) {
02732         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(pRgnData);
02733     }
02734 }
02735 
02736 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02737"></a><a class="code" href="../../d6/d2/output_8c.html#a61">02737</a> <a class="code" href="../../d6/d2/output_8c.html#a61">ScrollScreen</a>(
02738     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
02739     IN PSMALL_RECT ScrollRect,
02740     IN PSMALL_RECT MergeRect,
02741     IN COORD TargetPoint
02742     )
02743 {
02744     RECT ScrollRectGdi;
02745     SMALL_RECT UpdateRegion;
02746     COORD FontSize;
02747     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> Success;
02748     RECT BoundingBox;
02749 <span class="preprocessor">#if defined(FE_SB)</span>
02750 <span class="preprocessor"></span>    <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> fBisect = 0;
02751     SMALL_RECT UpdateRect;
02752     SMALL_RECT TmpBisect;
02753 <span class="preprocessor">#endif</span>
02754 <span class="preprocessor"></span>
02755     <a class="code" href="../../d8/d5/consrv_8h.html#a3">DBGOUTPUT</a>((<span class="stringliteral">"ScrollScreen\n"</span>));
02756     <span class="keywordflow">if</span> (!<a class="code" href="../../d7/d2/output_8h.html#a12">ACTIVE_SCREEN_BUFFER</a>(ScreenInfo)) {
02757         <span class="keywordflow">return</span>;
02758     }
02759     <span class="keywordflow">if</span> (ScreenInfo-&gt;Console-&gt;FullScreenFlags == 0 &amp;&amp;
02760         !(ScreenInfo-&gt;Console-&gt;Flags &amp; (<a class="code" href="../../d1/d7/server_8h.html#a0">CONSOLE_IS_ICONIC</a> | <a class="code" href="../../d1/d7/server_8h.html#a8">CONSOLE_NO_WINDOW</a>))) {
02761 <span class="preprocessor">#if defined(FE_SB)</span>
02762 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (ScreenInfo-&gt;BisectFlag){
02763             SMALL_RECT RedrawRect;
02764             <span class="keywordflow">if</span> (ScrollRect-&gt;Top &lt; TargetPoint.Y){
02765                 RedrawRect.Top = ScrollRect-&gt;Top;
02766                 RedrawRect.Bottom = TargetPoint.Y+(ScrollRect-&gt;Bottom-ScrollRect-&gt;Top);
02767             }
02768             <span class="keywordflow">else</span>{
02769                 RedrawRect.Top = TargetPoint.Y;
02770                 RedrawRect.Bottom = ScrollRect-&gt;Bottom;
02771             }
02772             <span class="keywordflow">if</span> (ScrollRect-&gt;Left &lt; TargetPoint.X){
02773                 RedrawRect.Left = ScrollRect-&gt;Left;
02774                 RedrawRect.Right = TargetPoint.X+(ScrollRect-&gt;Right-ScrollRect-&gt;Left);
02775             }
02776             <span class="keywordflow">else</span>{
02777                 RedrawRect.Left = TargetPoint.X;
02778                 RedrawRect.Right = ScrollRect-&gt;Right;
02779             }
02780             <a class="code" href="../../d6/d8/dispatch_8h.html#a4">WriteToScreen</a>(ScreenInfo,&amp;RedrawRect);
02781         }
02782         <span class="keywordflow">else</span>{
02783 <span class="preprocessor">#endif</span>
02784 <span class="preprocessor"></span>        ScrollRectGdi.left = ScrollRect-&gt;Left-ScreenInfo-&gt;Window.Left;
02785         ScrollRectGdi.right = (ScrollRect-&gt;Right-ScreenInfo-&gt;Window.Left+1);
02786         ScrollRectGdi.top = ScrollRect-&gt;Top-ScreenInfo-&gt;Window.Top;
02787         ScrollRectGdi.bottom = (ScrollRect-&gt;Bottom-ScreenInfo-&gt;Window.Top+1);
02788         <span class="keywordflow">if</span> (ScreenInfo-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>) {
02789             FontSize = <a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(ScreenInfo);
02790             ScrollRectGdi.left *= FontSize.X;
02791             ScrollRectGdi.right *= FontSize.X;
02792             ScrollRectGdi.top *= FontSize.Y;
02793             ScrollRectGdi.bottom *= FontSize.Y;
02794             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ScreenInfo-&gt;BufferInfo.TextInfo.UpdatingScreen&gt;0);
02795         } <span class="keywordflow">else</span> {
02796             FontSize.X = 1;
02797             FontSize.Y = 1;
02798         }
02799         <a class="code" href="../../d6/d2/output_8c.html#a0">SCROLLDC_CALL</a>;
02800         <a class="code" href="../../d6/d2/output_8c.html#a6">LockScrollBuffer</a>();
02801         Success = (<span class="keywordtype">int</span>)<a class="code" href="../../d3/d8/client_8c.html#a48">ScrollDC</a>(ScreenInfo-&gt;Console-&gt;hDC,
02802                              (TargetPoint.X-ScrollRect-&gt;Left)*FontSize.X,
02803                              (TargetPoint.Y-ScrollRect-&gt;Top)*FontSize.Y,
02804                              &amp;ScrollRectGdi,
02805                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02806                              <a class="code" href="../../d6/d2/output_8c.html#a25">ghrgnScroll</a>,
02807                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02808         <span class="keywordflow">if</span> (Success) {
02809             <span class="comment">/*</span>
02810 <span class="comment">             * Fetch our rectangles. If this is a simple rect then</span>
02811 <span class="comment">             * we have already retrieved the rectangle. Otherwise</span>
02812 <span class="comment">             * we need to call gdi to get the rectangles. We are</span>
02813 <span class="comment">             * optimzied for speed rather than size.</span>
02814 <span class="comment">             */</span>
02815             <span class="keywordflow">switch</span> (GetRgnBox(<a class="code" href="../../d6/d2/output_8c.html#a25">ghrgnScroll</a>, &amp;BoundingBox)) {
02816             <span class="keywordflow">case</span> SIMPLEREGION:
02817                 UpdateRegion.Left = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)((BoundingBox.left / FontSize.X) + \
02818                                     ScreenInfo-&gt;Window.Left);
02819                 UpdateRegion.Right = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(((BoundingBox.right-1) / FontSize.X) + \
02820                                     ScreenInfo-&gt;Window.Left);
02821                 UpdateRegion.Top = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)((BoundingBox.top / FontSize.Y) + \
02822                                     ScreenInfo-&gt;Window.Top);
02823                 UpdateRegion.Bottom = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(((BoundingBox.bottom-1) / FontSize.Y) + \
02824                                     ScreenInfo-&gt;Window.Top);
02825 <span class="preprocessor">#if defined(FE_SB)</span>
02826 <span class="preprocessor"></span>                fBisect = ScreenInfo-&gt;BisectFlag;
02827 <span class="preprocessor">#endif</span>
02828 <span class="preprocessor"></span>                <a class="code" href="../../d6/d8/dispatch_8h.html#a4">WriteToScreen</a>(ScreenInfo, &amp;UpdateRegion);
02829                 <span class="keywordflow">break</span>;
02830             <span class="keywordflow">case</span> COMPLEXREGION:
02831                 <a class="code" href="../../d6/d2/output_8c.html#a60">UpdateComplexRegion</a>(ScreenInfo, FontSize);
02832                 <span class="keywordflow">break</span>;
02833             }
02834 
02835             <span class="keywordflow">if</span> (MergeRect) {
02836 <span class="preprocessor">#if defined(FE_SB)</span>
02837 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (fBisect)
02838                     ScreenInfo-&gt;BisectFlag = fBisect;
02839                 <span class="keywordflow">else</span>
02840                     fBisect = ScreenInfo-&gt;BisectFlag;
02841 <span class="preprocessor">#endif</span>
02842 <span class="preprocessor"></span>                <a class="code" href="../../d6/d8/dispatch_8h.html#a4">WriteToScreen</a>(ScreenInfo, MergeRect);
02843             }
02844 <span class="preprocessor">#if defined(FE_SB)</span>
02845 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (CONSOLE_IS_DBCS_OUTPUTCP(ScreenInfo-&gt;Console)) {
02846                 UpdateRect.Left = TargetPoint.X;
02847                 UpdateRect.Right = ScrollRect-&gt;Right + (TargetPoint.X-ScrollRect-&gt;Left);
02848                 UpdateRect.Top = TargetPoint.Y;
02849                 UpdateRect.Bottom = ScrollRect-&gt;Bottom + (TargetPoint.Y-ScrollRect-&gt;Top);
02850                 <span class="keywordflow">if</span> (UpdateRect.Left &amp;&amp;
02851                     UpdateRect.Right+1 &lt; ScreenInfo-&gt;ScreenBufferSize.X &amp;&amp;
02852                     UpdateRect.Right-UpdateRect.Left &lt;= 2) {
02853                     TmpBisect.Left = UpdateRect.Left-1;
02854                     TmpBisect.Right = UpdateRect.Right+1;
02855                     TmpBisect.Top = UpdateRect.Top;
02856                     TmpBisect.Bottom = UpdateRect.Bottom;
02857                     <a class="code" href="../../d6/d8/dispatch_8h.html#a4">WriteToScreen</a>(ScreenInfo, &amp;TmpBisect);
02858                 }
02859                 <span class="keywordflow">else</span> {
02860                     <span class="keywordflow">if</span> (UpdateRect.Left) {
02861                         TmpBisect.Left = UpdateRect.Left-1;
02862                         TmpBisect.Right = UpdateRect.Left;
02863                         TmpBisect.Top = UpdateRect.Top;
02864                         TmpBisect.Bottom = UpdateRect.Bottom;
02865                         <a class="code" href="../../d6/d8/dispatch_8h.html#a4">WriteToScreen</a>(ScreenInfo, &amp;TmpBisect);
02866                     }
02867                     <span class="keywordflow">if</span> (UpdateRect.Right+1 &lt; ScreenInfo-&gt;ScreenBufferSize.X) {
02868                         TmpBisect.Left = UpdateRect.Right;
02869                         TmpBisect.Right = UpdateRect.Right+1;
02870                         TmpBisect.Top = UpdateRect.Top;
02871                         TmpBisect.Bottom = UpdateRect.Bottom;
02872                         <a class="code" href="../../d6/d8/dispatch_8h.html#a4">WriteToScreen</a>(ScreenInfo, &amp;TmpBisect);
02873                     }
02874                 }
02875             }
02876 <span class="preprocessor">#endif</span>
02877 <span class="preprocessor"></span>        } <span class="keywordflow">else</span> {
02878 <span class="preprocessor">#if defined(FE_SB)</span>
02879 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (fBisect)
02880                 ScreenInfo-&gt;BisectFlag = fBisect;
02881             <span class="keywordflow">else</span>
02882                 fBisect = ScreenInfo-&gt;BisectFlag;
02883 <span class="preprocessor">#endif</span>
02884 <span class="preprocessor"></span>            <a class="code" href="../../d6/d8/dispatch_8h.html#a4">WriteToScreen</a>(ScreenInfo, &amp;ScreenInfo-&gt;Window);
02885         }
02886         <a class="code" href="../../d6/d2/output_8c.html#a7">UnlockScrollBuffer</a>();
02887 <span class="preprocessor">#if defined(FE_SB)</span>
02888 <span class="preprocessor"></span>        }
02889 <span class="preprocessor">#endif</span>
02890 <span class="preprocessor"></span>    }
02891 <span class="preprocessor">#ifdef i386</span>
02892 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ScreenInfo-&gt;Console-&gt;FullScreenFlags &amp; CONSOLE_FULLSCREEN_HARDWARE) {
02893 <span class="preprocessor">#if defined(FE_SB)</span>
02894 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (CONSOLE_IS_DBCS_OUTPUTCP(ScreenInfo-&gt;Console)) {
02895             <span class="keywordflow">if</span> (! ScreenInfo-&gt;ConvScreenInfo) {
02896                 <span class="keywordflow">if</span> (ScreenInfo-&gt;Console-&gt;CurrentScreenBuffer == ScreenInfo) {
02897                     ScrollHW(ScreenInfo,
02898                              ScrollRect,
02899                              MergeRect,
02900                              TargetPoint
02901                             );
02902                 }
02903             }
02904             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ScreenInfo-&gt;Console-&gt;CurrentScreenBuffer-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>) {
02905                 ScrollHW(ScreenInfo,
02906                          ScrollRect,
02907                          MergeRect,
02908                          TargetPoint
02909                         );
02910             }
02911         }
02912         <span class="keywordflow">else</span>
02913 <span class="preprocessor">#endif</span>
02914 <span class="preprocessor"></span>        ScrollHW(ScreenInfo,
02915                  ScrollRect,
02916                  MergeRect,
02917                  TargetPoint
02918                 );
02919     }
02920 <span class="preprocessor">#endif</span>
02921 <span class="preprocessor"></span>}
02922 
02923 
<a name="l02924"></a><a class="code" href="../../d6/d2/output_8c.html#a62">02924</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d2/output_8c.html#a62">CopyRow</a>(
02925     <a class="code" href="../../d9/d4/struct__ROW.html">PROW</a> Row,
02926     <a class="code" href="../../d9/d4/struct__ROW.html">PROW</a> PrevRow)
02927 {
02928     <span class="keywordflow">if</span> (PrevRow-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o0">Length</a> != 1 ||
02929         Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o0">Length</a> != 1 ||
02930         PrevRow-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o2">Attrs</a>-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a> != Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o2">Attrs</a>-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a>) {
02931         Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o1">OldRight</a> = <a class="code" href="../../d7/d2/output_8h.html#a5">INVALID_OLD_LENGTH</a>;
02932         Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o3">OldLeft</a> = <a class="code" href="../../d7/d2/output_8h.html#a5">INVALID_OLD_LENGTH</a>;
02933     } <span class="keywordflow">else</span> {
02934         Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o1">OldRight</a> = PrevRow-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o0">Right</a>;
02935         Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o3">OldLeft</a> = PrevRow-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o2">Left</a>;
02936     }
02937 }
02938 
02939 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>
<a name="l02940"></a><a class="code" href="../../d6/d2/output_8c.html#a63">02940</a> <a class="code" href="../../d6/d2/output_8c.html#a63">ScrollEntireScreen</a>(
02941     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
02942     IN SHORT ScrollValue,
02943     IN BOOL UpdateRowIndex
02944     )
02945 
02946 
02953 {
02954     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> RowIndex;
02955     <span class="keywordtype">int</span> i;
02956     <span class="keywordtype">int</span> <span class="keyword">new</span>;
02957     <span class="keywordtype">int</span> old;
02958 
02959     ScreenInfo-&gt;BufferInfo.TextInfo.Flags |= <a class="code" href="../../d7/d2/output_8h.html#a3">TEXT_VALID_HINT</a>;
02960 
02961     <span class="comment">//</span>
02962     <span class="comment">// store index of first row</span>
02963     <span class="comment">//</span>
02964 
02965     RowIndex = ScreenInfo-&gt;BufferInfo.TextInfo.FirstRow;
02966 
02967     <span class="comment">//</span>
02968     <span class="comment">// update the oldright and oldleft values</span>
02969     <span class="comment">//</span>
02970 
02971     <span class="keyword">new</span> = (RowIndex + ScreenInfo-&gt;Window.Bottom + ScrollValue) %
02972                ScreenInfo-&gt;ScreenBufferSize.Y;
02973     old = (RowIndex + ScreenInfo-&gt;Window.Bottom) %
02974                ScreenInfo-&gt;ScreenBufferSize.Y;
02975     <span class="keywordflow">for</span> (i = <a class="code" href="../../d7/d2/output_8h.html#a16">WINDOW_SIZE_Y</a>(&amp;ScreenInfo-&gt;Window) - 1; i &gt;= 0; i--) {
02976         <a class="code" href="../../d6/d2/output_8c.html#a62">CopyRow</a>(
02977             &amp;ScreenInfo-&gt;BufferInfo.TextInfo.Rows[<span class="keyword">new</span>],
02978             &amp;ScreenInfo-&gt;BufferInfo.TextInfo.Rows[old]);
02979         <span class="keywordflow">if</span> (--<span class="keyword">new</span> &lt; 0)
02980             <span class="keyword">new</span> = ScreenInfo-&gt;ScreenBufferSize.Y - 1;
02981         <span class="keywordflow">if</span> (--old &lt; 0)
02982             old = ScreenInfo-&gt;ScreenBufferSize.Y - 1;
02983     }
02984 
02985     <span class="comment">//</span>
02986     <span class="comment">// update screen buffer</span>
02987     <span class="comment">//</span>
02988 
02989     <span class="keywordflow">if</span> (UpdateRowIndex) {
02990         ScreenInfo-&gt;BufferInfo.TextInfo.FirstRow =
02991             (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)((RowIndex + ScrollValue) % ScreenInfo-&gt;ScreenBufferSize.Y);
02992     }
02993 
02994     <span class="keywordflow">return</span> RowIndex;
02995 }
02996 
02997 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02998"></a><a class="code" href="../../d6/d2/output_8c.html#a64">02998</a> <a class="code" href="../../d6/d2/output_8c.html#a64">StreamScrollRegion</a>(
02999     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo
03000     )
03001 
03002 <span class="comment">/*++</span>
03003 <span class="comment"></span>
03004 <span class="comment">Routine Description:</span>
03005 <span class="comment"></span>
03006 <span class="comment">    This routine is a special-purpose scroll for use by</span>
03007 <span class="comment">    AdjustCursorPosition.</span>
03008 <span class="comment"></span>
03009 <span class="comment">Arguments:</span>
03010 <span class="comment"></span>
03011 <span class="comment">    ScreenInfo - pointer to screen buffer info.</span>
03012 <span class="comment"></span>
03013 <span class="comment">Return Value:</span>
03014 <span class="comment"></span>
03015 <span class="comment">--*/</span>
03016 
03017 {
03018     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> RowIndex;
03019     <a class="code" href="../../d9/d4/struct__ROW.html">PROW</a> Row;
03020     PWCHAR Char;
03021     RECT <a class="code" href="../../d5/d6/structRect.html">Rect</a>;
03022     RECT BoundingBox;
03023     <span class="keywordtype">int</span> ScreenWidth,ScrollHeight,ScreenHeight;
03024     COORD FontSize;
03025     SMALL_RECT UpdateRegion;
03026     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> Success;
03027     <span class="keywordtype">int</span> i;
03028 <span class="preprocessor">#if defined(FE_SB)</span>
03029 <span class="preprocessor"></span>    <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a> AttrP;
03030 <span class="preprocessor">#endif</span>
03031 <span class="preprocessor"></span>    <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console = ScreenInfo-&gt;Console;
03032 
03033     RowIndex = <a class="code" href="../../d6/d2/output_8c.html#a63">ScrollEntireScreen</a>(ScreenInfo,1,<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03034 
03035     Row = &amp;ScreenInfo-&gt;BufferInfo.TextInfo.Rows[RowIndex];
03036 
03037     <span class="comment">//</span>
03038     <span class="comment">// fill line with blanks</span>
03039     <span class="comment">//</span>
03040 
03041     Char = &amp;Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o4">Chars</a>[Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o2">Left</a>];
03042     <span class="keywordflow">for</span> (i=Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o2">Left</a>;i&lt;Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o0">Right</a>;i++) {
03043         *Char = (WCHAR)<span class="charliteral">' '</span>;
03044         Char++;
03045     }
03046 <span class="preprocessor">#if defined(FE_SB)</span>
03047 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (CONSOLE_IS_DBCS_OUTPUTCP(Console)){
03048         <span class="keywordtype">int</span> LineWidth = Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o0">Right</a> - Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o2">Left</a>;
03049         AttrP = &amp;Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.KAttrs[Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o2">Left</a>];
03050         <span class="keywordflow">if</span> ( LineWidth &gt; 0 )
03051             RtlZeroMemory(AttrP, LineWidth);
03052         AttrP += LineWidth;
03053         Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o1">OldRight</a> = <a class="code" href="../../d7/d2/output_8h.html#a5">INVALID_OLD_LENGTH</a>;
03054         Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o3">OldLeft</a> = <a class="code" href="../../d7/d2/output_8h.html#a5">INVALID_OLD_LENGTH</a>;
03055         Console-&gt;ConsoleIme.ScrollWaitCountDown = Console-&gt;ConsoleIme.ScrollWaitTimeout;
03056     }
03057 <span class="preprocessor">#endif</span>
03058 <span class="preprocessor"></span>    Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o0">Right</a> = 0;
03059     Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o2">Left</a> = ScreenInfo-&gt;ScreenBufferSize.X;
03060 
03061     <span class="comment">//</span>
03062     <span class="comment">// set up attributes</span>
03063     <span class="comment">//</span>
03064 
03065     <span class="keywordflow">if</span> (Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o0">Length</a> != 1) {
03066         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o2">Attrs</a>);
03067         Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o2">Attrs</a> = &amp;Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o1">AttrPair</a>;
03068         Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o1">AttrPair</a>.<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o0">Length</a> = ScreenInfo-&gt;ScreenBufferSize.X;
03069         Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o0">Length</a> = 1;
03070     }
03071     Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o1">AttrPair</a>.<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a> = ScreenInfo-&gt;Attributes;
03072 
03073     <span class="comment">//</span>
03074     <span class="comment">// update screen</span>
03075     <span class="comment">//</span>
03076 
03077     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d2/output_8h.html#a12">ACTIVE_SCREEN_BUFFER</a>(ScreenInfo) &amp;&amp;
03078         Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o47">FullScreenFlags</a> == 0 &amp;&amp;
03079         !(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; (<a class="code" href="../../d1/d7/server_8h.html#a0">CONSOLE_IS_ICONIC</a> | <a class="code" href="../../d1/d7/server_8h.html#a8">CONSOLE_NO_WINDOW</a>))) {
03080 
03081         <a class="code" href="../../d6/d1/ntcon_2server_2cursor_8c.html#a3">ConsoleHideCursor</a>(ScreenInfo);
03082         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/output_8c.html#a24">UsePolyTextOut</a>) {
03083             <a class="code" href="../../d6/d8/dispatch_8h.html#a5">WriteRegionToScreen</a>(ScreenInfo, &amp;ScreenInfo-&gt;Window);
03084         } <span class="keywordflow">else</span> {
03085             FontSize = <a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(ScreenInfo);
03086             ScreenWidth = <a class="code" href="../../d7/d2/output_8h.html#a15">WINDOW_SIZE_X</a>(&amp;ScreenInfo-&gt;Window) * FontSize.X;
03087             ScreenHeight = <a class="code" href="../../d7/d2/output_8h.html#a16">WINDOW_SIZE_Y</a>(&amp;ScreenInfo-&gt;Window) * FontSize.Y;
03088             ScrollHeight = ScreenHeight - FontSize.Y;
03089 
03090             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a32">Rect</a>.<a class="code" href="../../d5/d6/structRect.html#o1">left</a> = 0;
03091             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a32">Rect</a>.<a class="code" href="../../d5/d6/structRect.html#o3">right</a> = ScreenWidth;
03092             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a32">Rect</a>.<a class="code" href="../../d5/d6/structRect.html#o0">top</a> = FontSize.Y;
03093             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a32">Rect</a>.<a class="code" href="../../d5/d6/structRect.html#o2">bottom</a> = ScreenHeight;
03094 
03095             <span class="comment">//</span>
03096             <span class="comment">// find smallest bounding rectangle</span>
03097             <span class="comment">//</span>
03098 
03099             <span class="keywordflow">if</span> (ScreenInfo-&gt;BufferInfo.TextInfo.Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a3">TEXT_VALID_HINT</a>) {
03100                 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> MinLeft,MaxRight;
03101                 MinLeft = ScreenInfo-&gt;ScreenBufferSize.X;
03102                 MaxRight = 0;
03103                 RowIndex = (ScreenInfo-&gt;BufferInfo.TextInfo.FirstRow+ScreenInfo-&gt;Window.Top) % ScreenInfo-&gt;ScreenBufferSize.Y;
03104                 <span class="keywordflow">for</span> (i=ScreenInfo-&gt;Window.Top+1;i&lt;=ScreenInfo-&gt;Window.Bottom;i++) {
03105                     Row = &amp;ScreenInfo-&gt;BufferInfo.TextInfo.Rows[RowIndex];
03106                     <span class="keywordflow">if</span> (Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o3">OldLeft</a> == <a class="code" href="../../d7/d2/output_8h.html#a5">INVALID_OLD_LENGTH</a>) {
03107                         MinLeft = 0;
03108                     } <span class="keywordflow">else</span> {
03109                         <span class="keywordflow">if</span> (MinLeft &gt; <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o2">Left</a>,Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o3">OldLeft</a>)) {
03110                             MinLeft = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o2">Left</a>,Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o3">OldLeft</a>);
03111                         }
03112                     }
03113                     <span class="keywordflow">if</span> (Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o1">OldRight</a> == <a class="code" href="../../d7/d2/output_8h.html#a5">INVALID_OLD_LENGTH</a>) {
03114                         MaxRight = ScreenInfo-&gt;ScreenBufferSize.X-1;
03115                     } <span class="keywordflow">else</span> {
03116                         <span class="keywordflow">if</span> (MaxRight &lt; <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o0">Right</a>,Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o1">OldRight</a>)) {
03117                             MaxRight = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o0">Right</a>,Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o1">OldRight</a>);
03118                         }
03119                     }
03120                     <span class="keywordflow">if</span> (++RowIndex == ScreenInfo-&gt;ScreenBufferSize.Y) {
03121                         RowIndex = 0;
03122                     }
03123                 }
03124                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a32">Rect</a>.<a class="code" href="../../d5/d6/structRect.html#o1">left</a> = MinLeft*FontSize.X;
03125                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a32">Rect</a>.<a class="code" href="../../d5/d6/structRect.html#o3">right</a> = (MaxRight+1)*FontSize.X;
03126             }
03127 
03128             <a class="code" href="../../d6/d2/output_8c.html#a6">LockScrollBuffer</a>();
03129             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ScreenInfo-&gt;BufferInfo.TextInfo.UpdatingScreen&gt;0);
03130             Success = (<span class="keywordtype">int</span>)<a class="code" href="../../d3/d8/client_8c.html#a48">ScrollDC</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o10">hDC</a>,
03131                                 0,
03132                                 -FontSize.Y,
03133                                 &amp;<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a32">Rect</a>,
03134                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03135                                 <a class="code" href="../../d6/d2/output_8c.html#a25">ghrgnScroll</a>,
03136                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
03137                                );
03138             <span class="keywordflow">if</span> (Success &amp;&amp; ScreenInfo-&gt;Window.Top!=ScreenInfo-&gt;Window.Bottom) {
03139 <span class="preprocessor">#if defined(FE_SB)</span>
03140 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (CONSOLE_IS_DBCS_OUTPUTCP(Console) &amp;&amp;
03141                     ScreenInfo-&gt;Attributes &amp; (COMMON_LVB_GRID_HORIZONTAL +
03142                                                COMMON_LVB_GRID_LVERTICAL +
03143                                                COMMON_LVB_GRID_RVERTICAL +
03144                                                COMMON_LVB_REVERSE_VIDEO  +
03145                                                COMMON_LVB_UNDERSCORE     )){
03146                     UpdateRegion = ScreenInfo-&gt;Window;
03147                     UpdateRegion.Top = UpdateRegion.Bottom;
03148                     ScreenInfo-&gt;BufferInfo.TextInfo.Flags &amp;= ~<a class="code" href="../../d7/d2/output_8h.html#a3">TEXT_VALID_HINT</a>;
03149                     <a class="code" href="../../d6/d8/dispatch_8h.html#a4">WriteToScreen</a>(ScreenInfo,&amp;UpdateRegion);
03150                 }
03151                 <span class="keywordflow">else</span>{
03152 <span class="preprocessor">#endif</span>
03153 <span class="preprocessor"></span>                <span class="keywordflow">switch</span> (GetRgnBox(<a class="code" href="../../d6/d2/output_8c.html#a25">ghrgnScroll</a>, &amp;BoundingBox)) {
03154                 <span class="keywordflow">case</span> SIMPLEREGION:
03155                     <span class="keywordflow">if</span> (BoundingBox.left == 0 &amp;&amp;
03156                         BoundingBox.right == ScreenWidth &amp;&amp;
03157                         BoundingBox.top == ScrollHeight &amp;&amp;
03158                         BoundingBox.bottom == ScreenHeight) {
03159 
03160                         PatBlt(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o10">hDC</a>,0,ScrollHeight,ScreenWidth,FontSize.Y,PATCOPY);
03161                         GdiFlush();
03162                     } <span class="keywordflow">else</span> {
03163                         UpdateRegion.Left = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)((BoundingBox.left/FontSize.X)+ScreenInfo-&gt;Window.Left);
03164                         UpdateRegion.Right = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(((BoundingBox.right-1)/FontSize.X)+ScreenInfo-&gt;Window.Left);
03165                         UpdateRegion.Top = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)((BoundingBox.top/FontSize.Y)+ScreenInfo-&gt;Window.Top);
03166                         UpdateRegion.Bottom = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(((BoundingBox.bottom-1)/FontSize.Y)+ScreenInfo-&gt;Window.Top);
03167                         <a class="code" href="../../d6/d8/dispatch_8h.html#a4">WriteToScreen</a>(ScreenInfo,&amp;UpdateRegion);
03168                     }
03169                     <span class="keywordflow">break</span>;
03170                 <span class="keywordflow">case</span> COMPLEXREGION:
03171                     <a class="code" href="../../d6/d2/output_8c.html#a60">UpdateComplexRegion</a>(ScreenInfo,FontSize);
03172                     <span class="keywordflow">break</span>;
03173                 }
03174 <span class="preprocessor">#if defined(FE_SB)</span>
03175 <span class="preprocessor"></span>                }
03176 <span class="preprocessor">#endif</span>
03177 <span class="preprocessor"></span>            } <span class="keywordflow">else</span>  {
03178                 <a class="code" href="../../d6/d8/dispatch_8h.html#a4">WriteToScreen</a>(ScreenInfo,&amp;ScreenInfo-&gt;Window);
03179             }
03180             <a class="code" href="../../d6/d2/output_8c.html#a7">UnlockScrollBuffer</a>();
03181         }
03182         <a class="code" href="../../d6/d1/ntcon_2server_2cursor_8c.html#a2">ConsoleShowCursor</a>(ScreenInfo);
03183     }
03184 <span class="preprocessor">#ifdef i386</span>
03185 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o47">FullScreenFlags</a> &amp; CONSOLE_FULLSCREEN_HARDWARE) {
03186         SMALL_RECT ScrollRect;
03187         COORD TargetPoint;
03188 
03189         ScrollRect = ScreenInfo-&gt;Window;
03190         TargetPoint.Y = ScrollRect.Top;
03191         ScrollRect.Top += 1;
03192         TargetPoint.X = 0;
03193 <span class="preprocessor">#if defined(FE_SB)</span>
03194 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (CONSOLE_IS_DBCS_OUTPUTCP(Console) ) {
03195             <span class="keywordflow">if</span> (! ScreenInfo-&gt;ConvScreenInfo)  {
03196                 <span class="keywordflow">if</span> (ScreenInfo-&gt;Console-&gt;CurrentScreenBuffer == ScreenInfo) {
03197                     ScrollHW(ScreenInfo,
03198                              &amp;ScrollRect,
03199                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03200                              TargetPoint
03201                             );
03202                 }
03203             }
03204             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ScreenInfo-&gt;Console-&gt;CurrentScreenBuffer-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>) {
03205                 ScrollHW(ScreenInfo,
03206                          &amp;ScrollRect,
03207                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03208                          TargetPoint
03209                         );
03210             }
03211         }
03212         <span class="keywordflow">else</span>
03213 <span class="preprocessor">#endif</span>
03214 <span class="preprocessor"></span>        ScrollHW(ScreenInfo,
03215                  &amp;ScrollRect,
03216                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03217                  TargetPoint
03218                 );
03219         ScrollRect.Top = ScrollRect.Bottom - 1;
03220         WriteRegionToScreenHW(ScreenInfo,&amp;ScrollRect);
03221     }
03222 <span class="preprocessor">#endif</span>
03223 <span class="preprocessor"></span>}
03224 
03225 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03226"></a><a class="code" href="../../d6/d2/output_8c.html#a65">03226</a> <a class="code" href="../../d6/d2/output_8c.html#a65">ScrollRegion</a>(
03227     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
03228     IN OUT PSMALL_RECT ScrollRectangle,
03229     IN PSMALL_RECT ClipRectangle OPTIONAL,
03230     IN COORD  DestinationOrigin,
03231     IN CHAR_INFO Fill
03232     )
03233 
03234 <span class="comment">/*++</span>
03235 <span class="comment"></span>
03236 <span class="comment">Routine Description:</span>
03237 <span class="comment"></span>
03238 <span class="comment">    This routine copies ScrollRectangle to DestinationOrigin then</span>
03239 <span class="comment">    fills in ScrollRectangle with Fill.  The scroll region is</span>
03240 <span class="comment">    copied to a third buffer, the scroll region is filled, then the</span>
03241 <span class="comment">    original contents of the scroll region are copied to the destination.</span>
03242 <span class="comment"></span>
03243 <span class="comment">Arguments:</span>
03244 <span class="comment"></span>
03245 <span class="comment">    ScreenInfo - pointer to screen buffer info.</span>
03246 <span class="comment"></span>
03247 <span class="comment">    ScrollRectangle - Region to copy</span>
03248 <span class="comment"></span>
03249 <span class="comment">    ClipRectangle - Optional pointer to clip region.</span>
03250 <span class="comment"></span>
03251 <span class="comment">    DestinationOrigin - Upper left corner of target region.</span>
03252 <span class="comment"></span>
03253 <span class="comment">    Fill - Character and attribute to fill source region with.</span>
03254 <span class="comment"></span>
03255 <span class="comment">Return Value:</span>
03256 <span class="comment"></span>
03257 <span class="comment">--*/</span>
03258 
03259 {
03260     SMALL_RECT TargetRectangle, SourceRectangle;
03261     COORD TargetPoint;
03262     COORD <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
03263     SMALL_RECT OurClipRectangle;
03264     SMALL_RECT ScrollRectangle2,ScrollRectangle3;
03265     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03266     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console = ScreenInfo-&gt;Console;
03267 
03268     <span class="comment">// here's how we clip:</span>
03269     <span class="comment">//</span>
03270     <span class="comment">// Clip source rectangle to screen buffer =&gt; S</span>
03271     <span class="comment">// Create target rectangle based on S =&gt; T</span>
03272     <span class="comment">// Clip T to ClipRegion =&gt; T</span>
03273     <span class="comment">// Create S2 based on clipped T =&gt; S2</span>
03274     <span class="comment">// Clip S to ClipRegion =&gt; S3</span>
03275     <span class="comment">//</span>
03276     <span class="comment">// S2 is the region we copy to T</span>
03277     <span class="comment">// S3 is the region to fill</span>
03278 
03279     <span class="keywordflow">if</span> (Fill.Char.UnicodeChar == <span class="charliteral">'\0'</span> &amp;&amp; Fill.Attributes == 0) {
03280         Fill.Char.UnicodeChar = (WCHAR)<span class="charliteral">' '</span>;
03281         Fill.Attributes = ScreenInfo-&gt;Attributes;
03282     }
03283 
03284     <span class="comment">//</span>
03285     <span class="comment">// clip the source rectangle to the screen buffer</span>
03286     <span class="comment">//</span>
03287 
03288     <span class="keywordflow">if</span> (ScrollRectangle-&gt;Left &lt; 0) {
03289         DestinationOrigin.X += -ScrollRectangle-&gt;Left;
03290         ScrollRectangle-&gt;Left = 0;
03291     }
03292     <span class="keywordflow">if</span> (ScrollRectangle-&gt;Top &lt; 0) {
03293         DestinationOrigin.Y += -ScrollRectangle-&gt;Top;
03294         ScrollRectangle-&gt;Top = 0;
03295     }
03296     <span class="keywordflow">if</span> (ScrollRectangle-&gt;Right &gt;= ScreenInfo-&gt;ScreenBufferSize.X) {
03297         ScrollRectangle-&gt;Right = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ScreenInfo-&gt;ScreenBufferSize.X-1);
03298     }
03299     <span class="keywordflow">if</span> (ScrollRectangle-&gt;Bottom &gt;= ScreenInfo-&gt;ScreenBufferSize.Y) {
03300         ScrollRectangle-&gt;Bottom = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ScreenInfo-&gt;ScreenBufferSize.Y-1);
03301     }
03302 
03303     <span class="comment">//</span>
03304     <span class="comment">// if source rectangle doesn't intersect screen buffer, return.</span>
03305     <span class="comment">//</span>
03306 
03307     <span class="keywordflow">if</span> (ScrollRectangle-&gt;Bottom &lt; ScrollRectangle-&gt;Top ||
03308         ScrollRectangle-&gt;Right &lt; ScrollRectangle-&gt;Left) {
03309         <span class="keywordflow">return</span> STATUS_SUCCESS;
03310     }
03311 
03312     <span class="comment">//</span>
03313     <span class="comment">// clip the target rectangle</span>
03314     <span class="comment">// if a cliprectangle was provided, clip it to the screen buffer.</span>
03315     <span class="comment">// if not, set the cliprectangle to the screen buffer region.</span>
03316     <span class="comment">//</span>
03317 
03318     <span class="keywordflow">if</span> (ClipRectangle) {
03319 
03320         <span class="comment">//</span>
03321         <span class="comment">// clip the cliprectangle.</span>
03322         <span class="comment">//</span>
03323 
03324         <span class="keywordflow">if</span> (ClipRectangle-&gt;Left &lt; 0) {
03325             ClipRectangle-&gt;Left = 0;
03326         }
03327         <span class="keywordflow">if</span> (ClipRectangle-&gt;Top &lt; 0) {
03328             ClipRectangle-&gt;Top = 0;
03329         }
03330         <span class="keywordflow">if</span> (ClipRectangle-&gt;Right &gt;= ScreenInfo-&gt;ScreenBufferSize.X) {
03331             ClipRectangle-&gt;Right = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ScreenInfo-&gt;ScreenBufferSize.X-1);
03332         }
03333         <span class="keywordflow">if</span> (ClipRectangle-&gt;Bottom &gt;= ScreenInfo-&gt;ScreenBufferSize.Y) {
03334             ClipRectangle-&gt;Bottom = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ScreenInfo-&gt;ScreenBufferSize.Y-1);
03335         }
03336     }
03337     <span class="keywordflow">else</span> {
03338         OurClipRectangle.Left = 0;
03339         OurClipRectangle.Top = 0;
03340         OurClipRectangle.Right = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ScreenInfo-&gt;ScreenBufferSize.X-1);
03341         OurClipRectangle.Bottom = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ScreenInfo-&gt;ScreenBufferSize.Y-1);
03342         ClipRectangle = &amp;OurClipRectangle;
03343     }
03344 
03345     <span class="comment">//</span>
03346     <span class="comment">// Create target rectangle based on S =&gt; T</span>
03347     <span class="comment">// Clip T to ClipRegion =&gt; T</span>
03348     <span class="comment">// Create S2 based on clipped T =&gt; S2</span>
03349     <span class="comment">//</span>
03350 
03351     ScrollRectangle2 = *ScrollRectangle;
03352     TargetRectangle.Left = DestinationOrigin.X;
03353     TargetRectangle.Top = DestinationOrigin.Y;
03354     TargetRectangle.Right = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(DestinationOrigin.X + (ScrollRectangle2.Right -  ScrollRectangle2.Left + 1) - 1);
03355     TargetRectangle.Bottom = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(DestinationOrigin.Y + (ScrollRectangle2.Bottom - ScrollRectangle2.Top + 1) - 1);
03356 
03357     <span class="keywordflow">if</span> (TargetRectangle.Left &lt; ClipRectangle-&gt;Left) {
03358         ScrollRectangle2.Left += ClipRectangle-&gt;Left - TargetRectangle.Left;
03359         TargetRectangle.Left = ClipRectangle-&gt;Left;
03360     }
03361     <span class="keywordflow">if</span> (TargetRectangle.Top &lt; ClipRectangle-&gt;Top) {
03362         ScrollRectangle2.Top += ClipRectangle-&gt;Top - TargetRectangle.Top;
03363         TargetRectangle.Top = ClipRectangle-&gt;Top;
03364     }
03365     <span class="keywordflow">if</span> (TargetRectangle.Right &gt; ClipRectangle-&gt;Right) {
03366         ScrollRectangle2.Right -= TargetRectangle.Right - ClipRectangle-&gt;Right;
03367         TargetRectangle.Right = ClipRectangle-&gt;Right;
03368     }
03369     <span class="keywordflow">if</span> (TargetRectangle.Bottom &gt; ClipRectangle-&gt;Bottom) {
03370         ScrollRectangle2.Bottom -= TargetRectangle.Bottom - ClipRectangle-&gt;Bottom;
03371         TargetRectangle.Bottom = ClipRectangle-&gt;Bottom;
03372     }
03373 
03374     <span class="comment">//</span>
03375     <span class="comment">// clip scroll rect to clipregion =&gt; S3</span>
03376     <span class="comment">//</span>
03377 
03378     ScrollRectangle3 = *ScrollRectangle;
03379     <span class="keywordflow">if</span> (ScrollRectangle3.Left &lt; ClipRectangle-&gt;Left) {
03380         ScrollRectangle3.Left = ClipRectangle-&gt;Left;
03381     }
03382     <span class="keywordflow">if</span> (ScrollRectangle3.Top &lt; ClipRectangle-&gt;Top) {
03383         ScrollRectangle3.Top = ClipRectangle-&gt;Top;
03384     }
03385     <span class="keywordflow">if</span> (ScrollRectangle3.Right &gt; ClipRectangle-&gt;Right) {
03386         ScrollRectangle3.Right = ClipRectangle-&gt;Right;
03387     }
03388     <span class="keywordflow">if</span> (ScrollRectangle3.Bottom &gt; ClipRectangle-&gt;Bottom) {
03389         ScrollRectangle3.Bottom = ClipRectangle-&gt;Bottom;
03390     }
03391 
03392     <span class="comment">//</span>
03393     <span class="comment">// if scroll rect doesn't intersect clip region, return.</span>
03394     <span class="comment">//</span>
03395 
03396     <span class="keywordflow">if</span> (ScrollRectangle3.Bottom &lt; ScrollRectangle3.Top ||
03397         ScrollRectangle3.Right &lt; ScrollRectangle3.Left) {
03398         <span class="keywordflow">return</span> STATUS_SUCCESS;
03399     }
03400 
03401     <a class="code" href="../../d6/d1/ntcon_2server_2cursor_8c.html#a3">ConsoleHideCursor</a>(ScreenInfo);
03402 
03403 <span class="preprocessor">#if defined(FE_IME)</span>
03404 <span class="preprocessor"></span>    Console-&gt;ConsoleIme.ScrollWaitCountDown = Console-&gt;ConsoleIme.ScrollWaitTimeout;
03405 <span class="preprocessor">#endif // FE_IME</span>
03406 <span class="preprocessor"></span>    <span class="comment">//</span>
03407     <span class="comment">// if target rectangle doesn't intersect screen buffer, skip scrolling</span>
03408     <span class="comment">// part.</span>
03409     <span class="comment">//</span>
03410 
03411     <span class="keywordflow">if</span> (!(TargetRectangle.Bottom &lt; TargetRectangle.Top ||
03412           TargetRectangle.Right &lt; TargetRectangle.Left)) {
03413 
03414         <span class="comment">//</span>
03415         <span class="comment">// if we can, don't use intermediate scroll region buffer.  do this</span>
03416         <span class="comment">// by figuring out fill rectangle.  NOTE: this code will only work</span>
03417         <span class="comment">// if CopyRectangle copies from low memory to high memory (otherwise</span>
03418         <span class="comment">// we would overwrite the scroll region before reading it).</span>
03419         <span class="comment">//</span>
03420 
03421         <span class="keywordflow">if</span> (ScrollRectangle2.Right == TargetRectangle.Right &amp;&amp;
03422             ScrollRectangle2.Left == TargetRectangle.Left &amp;&amp;
03423             ScrollRectangle2.Top &gt; TargetRectangle.Top &amp;&amp;
03424             ScrollRectangle2.Top &lt; TargetRectangle.Bottom) {
03425 
03426             SMALL_RECT <a class="code" href="../../d9/d1/rtl_2draw_8c.html#a3">FillRect</a>;
03427             <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> LastRowIndex,OldRight,OldLeft;
03428             <a class="code" href="../../d9/d4/struct__ROW.html">PROW</a> Row;
03429 
03430             TargetPoint.X = TargetRectangle.Left;
03431             TargetPoint.Y = TargetRectangle.Top;
03432             <span class="keywordflow">if</span> (ScrollRectangle2.Right == (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ScreenInfo-&gt;ScreenBufferSize.X-1) &amp;&amp;
03433                 ScrollRectangle2.Left == 0 &amp;&amp;
03434                 ScrollRectangle2.Bottom == (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ScreenInfo-&gt;ScreenBufferSize.Y-1) &amp;&amp;
03435                 ScrollRectangle2.Top == 1 ) {
03436                 LastRowIndex = <a class="code" href="../../d6/d2/output_8c.html#a63">ScrollEntireScreen</a>(ScreenInfo,(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ScrollRectangle2.Top-TargetRectangle.Top),<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03437                 Row = &amp;ScreenInfo-&gt;BufferInfo.TextInfo.Rows[LastRowIndex];
03438                 OldRight = Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o1">OldRight</a>;
03439                 OldLeft = Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o3">OldLeft</a>;
03440             } <span class="keywordflow">else</span> {
03441                 LastRowIndex = -1;
03442                 <a class="code" href="../../d6/d2/output_8c.html#a51">CopyRectangle</a>(ScreenInfo,
03443                               &amp;ScrollRectangle2,
03444                               TargetPoint
03445                              );
03446             }
03447             <a class="code" href="../../d9/d1/rtl_2draw_8c.html#a3">FillRect</a>.Left = TargetRectangle.Left;
03448             <a class="code" href="../../d9/d1/rtl_2draw_8c.html#a3">FillRect</a>.Right = TargetRectangle.Right;
03449             <a class="code" href="../../d9/d1/rtl_2draw_8c.html#a3">FillRect</a>.Top = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(TargetRectangle.Bottom+1);
03450             <a class="code" href="../../d9/d1/rtl_2draw_8c.html#a3">FillRect</a>.Bottom = ScrollRectangle-&gt;Bottom;
03451             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d1/rtl_2draw_8c.html#a3">FillRect</a>.Top &lt; ClipRectangle-&gt;Top) {
03452                 <a class="code" href="../../d9/d1/rtl_2draw_8c.html#a3">FillRect</a>.Top = ClipRectangle-&gt;Top;
03453             }
03454             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d1/rtl_2draw_8c.html#a3">FillRect</a>.Bottom &gt; ClipRectangle-&gt;Bottom) {
03455                 <a class="code" href="../../d9/d1/rtl_2draw_8c.html#a3">FillRect</a>.Bottom = ClipRectangle-&gt;Bottom;
03456             }
03457             <a class="code" href="../../d6/d8/dispatch_8h.html#a7">FillRectangle</a>(Fill,
03458                           ScreenInfo,
03459                           &amp;<a class="code" href="../../d9/d1/rtl_2draw_8c.html#a3">FillRect</a>
03460                          );
03461 
03462             <span class="comment">//</span>
03463             <span class="comment">// After ScrollEntireScreen, the OldRight and OldLeft values</span>
03464             <span class="comment">// for the last row are set correctly.  however, FillRectangle</span>
03465             <span class="comment">// resets them with the previous first row of the screen.</span>
03466             <span class="comment">// reset them here.</span>
03467             <span class="comment">//</span>
03468 
03469             <span class="keywordflow">if</span> (LastRowIndex != -1) {
03470                 Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o1">OldRight</a> = OldRight;
03471                 Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o3">OldLeft</a> = OldLeft;
03472             }
03473 
03474             <span class="comment">//</span>
03475             <span class="comment">// update to screen, if we're not iconic.  we're marked as</span>
03476             <span class="comment">// iconic if we're fullscreen, so check for fullscreen.</span>
03477             <span class="comment">//</span>
03478 
03479             <span class="keywordflow">if</span> (!(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a0">CONSOLE_IS_ICONIC</a>) ||
03480                  Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o47">FullScreenFlags</a> &amp; CONSOLE_FULLSCREEN_HARDWARE) {
03481                 <a class="code" href="../../d6/d2/output_8c.html#a61">ScrollScreen</a>(ScreenInfo,
03482                        &amp;ScrollRectangle2,
03483                        &amp;<a class="code" href="../../d9/d1/rtl_2draw_8c.html#a3">FillRect</a>,
03484                        TargetPoint
03485                       );
03486             }
03487         }
03488 
03489         <span class="comment">//</span>
03490         <span class="comment">// if no overlap, don't need intermediate copy</span>
03491         <span class="comment">//</span>
03492 
03493         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ScrollRectangle3.Right &lt; TargetRectangle.Left ||
03494                  ScrollRectangle3.Left &gt; TargetRectangle.Right ||
03495                  ScrollRectangle3.Top &gt; TargetRectangle.Bottom ||
03496                  ScrollRectangle3.Bottom &lt; TargetRectangle.Top) {
03497             TargetPoint.X = TargetRectangle.Left;
03498             TargetPoint.Y = TargetRectangle.Top;
03499             <a class="code" href="../../d6/d2/output_8c.html#a51">CopyRectangle</a>(ScreenInfo,
03500                           &amp;ScrollRectangle2,
03501                           TargetPoint
03502                          );
03503             <a class="code" href="../../d6/d8/dispatch_8h.html#a7">FillRectangle</a>(Fill,
03504                           ScreenInfo,
03505                           &amp;ScrollRectangle3
03506                          );
03507 
03508             <span class="comment">//</span>
03509             <span class="comment">// update to screen, if we're not iconic.  we're marked as</span>
03510             <span class="comment">// iconic if we're fullscreen, so check for fullscreen.</span>
03511             <span class="comment">//</span>
03512 
03513             <span class="keywordflow">if</span> (!(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a0">CONSOLE_IS_ICONIC</a>) ||
03514                 Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o47">FullScreenFlags</a> &amp; CONSOLE_FULLSCREEN_HARDWARE) {
03515                 <a class="code" href="../../d6/d2/output_8c.html#a61">ScrollScreen</a>(ScreenInfo,
03516                        &amp;ScrollRectangle2,
03517                        &amp;ScrollRectangle3,
03518                        TargetPoint
03519                       );
03520             }
03521         }
03522 
03523         <span class="comment">//</span>
03524         <span class="comment">// for the case where the source and target rectangles overlap, we</span>
03525         <span class="comment">// copy the source rectangle, fill it, then copy it to the target.</span>
03526         <span class="comment">//</span>
03527 
03528         <span class="keywordflow">else</span> {
03529             SMALL_RECT TargetRect;
03530             COORD SourcePoint;
03531 
03532             <a class="code" href="../../d6/d2/output_8c.html#a6">LockScrollBuffer</a>();
03533             <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.X = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ScrollRectangle2.Right - ScrollRectangle2.Left + 1);
03534             <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.Y = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ScrollRectangle2.Bottom - ScrollRectangle2.Top + 1);
03535             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/output_8c.html#a20">ScrollBufferSize</a> &lt; (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.X * <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.Y * <span class="keyword">sizeof</span>(CHAR_INFO))) {
03536                 <a class="code" href="../../d6/d2/output_8c.html#a36">FreeScrollBuffer</a>();
03537                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d2/output_8c.html#a35">AllocateScrollBuffer</a>(<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.X * <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.Y * <span class="keyword">sizeof</span>(CHAR_INFO));
03538                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03539                     <a class="code" href="../../d6/d2/output_8c.html#a7">UnlockScrollBuffer</a>();
03540                     <a class="code" href="../../d6/d1/ntcon_2server_2cursor_8c.html#a2">ConsoleShowCursor</a>(ScreenInfo);
03541                     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03542                 }
03543             }
03544 
03545             TargetRect.Left = 0;
03546             TargetRect.Top = 0;
03547             TargetRect.Right = ScrollRectangle2.Right - ScrollRectangle2.Left;
03548             TargetRect.Bottom = ScrollRectangle2.Bottom - ScrollRectangle2.Top;
03549             SourcePoint.X = ScrollRectangle2.Left;
03550             SourcePoint.Y = ScrollRectangle2.Top;
03551             <a class="code" href="../../d6/d2/output_8c.html#a50">ReadRectFromScreenBuffer</a>(ScreenInfo,
03552                                      SourcePoint,
03553                                      <a class="code" href="../../d6/d2/output_8c.html#a19">ScrollBuffer</a>,
03554                                      <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>,
03555                                      &amp;TargetRect
03556                                     );
03557 
03558             <a class="code" href="../../d6/d8/dispatch_8h.html#a7">FillRectangle</a>(Fill,
03559                           ScreenInfo,
03560                           &amp;ScrollRectangle3
03561                          );
03562 
03563             SourceRectangle.Top = 0;
03564             SourceRectangle.Left = 0;
03565             SourceRectangle.Right = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.X-1);
03566             SourceRectangle.Bottom = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.Y-1);
03567             TargetPoint.X = TargetRectangle.Left;
03568             TargetPoint.Y = TargetRectangle.Top;
03569             <a class="code" href="../../d6/d8/dispatch_8h.html#a3">WriteRectToScreenBuffer</a>((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)<a class="code" href="../../d6/d2/output_8c.html#a19">ScrollBuffer</a>,
03570                                     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>,
03571                                     &amp;SourceRectangle,
03572                                     ScreenInfo,
03573                                     TargetPoint,
03574                                     0xFFFFFFFF
03575                                    );
03576             <a class="code" href="../../d6/d2/output_8c.html#a7">UnlockScrollBuffer</a>();
03577 
03578             <span class="comment">//</span>
03579             <span class="comment">// update to screen, if we're not iconic.  we're marked as</span>
03580             <span class="comment">// iconic if we're fullscreen, so check for fullscreen.</span>
03581             <span class="comment">//</span>
03582 
03583             <span class="keywordflow">if</span> (!(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a0">CONSOLE_IS_ICONIC</a>) ||
03584                 Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o47">FullScreenFlags</a> &amp; CONSOLE_FULLSCREEN_HARDWARE) {
03585 
03586                 <span class="comment">//</span>
03587                 <span class="comment">// update regions on screen.</span>
03588                 <span class="comment">//</span>
03589 
03590                 <a class="code" href="../../d6/d2/output_8c.html#a61">ScrollScreen</a>(ScreenInfo,
03591                        &amp;ScrollRectangle2,
03592                        &amp;ScrollRectangle3,
03593                        TargetPoint
03594                       );
03595             }
03596         }
03597     }
03598     <span class="keywordflow">else</span> {
03599 
03600         <span class="comment">//</span>
03601         <span class="comment">// do fill</span>
03602         <span class="comment">//</span>
03603 
03604         <a class="code" href="../../d6/d8/dispatch_8h.html#a7">FillRectangle</a>(Fill,
03605                       ScreenInfo,
03606                       &amp;ScrollRectangle3
03607                      );
03608 
03609         <span class="comment">//</span>
03610         <span class="comment">// update to screen, if we're not iconic.  we're marked as</span>
03611         <span class="comment">// iconic if we're fullscreen, so check for fullscreen.</span>
03612         <span class="comment">//</span>
03613 
03614         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d2/output_8h.html#a12">ACTIVE_SCREEN_BUFFER</a>(ScreenInfo) &amp;&amp;
03615             !(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a0">CONSOLE_IS_ICONIC</a>) ||
03616             Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o47">FullScreenFlags</a> &amp; CONSOLE_FULLSCREEN_HARDWARE) {
03617             <a class="code" href="../../d6/d8/dispatch_8h.html#a4">WriteToScreen</a>(ScreenInfo,&amp;ScrollRectangle3);
03618         }
03619     }
03620     <a class="code" href="../../d6/d1/ntcon_2server_2cursor_8c.html#a2">ConsoleShowCursor</a>(ScreenInfo);
03621     <span class="keywordflow">return</span> STATUS_SUCCESS;
03622 }
03623 
03624 
03625 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03626"></a><a class="code" href="../../d6/d2/output_8c.html#a66">03626</a> <a class="code" href="../../d6/d2/output_8c.html#a66">SetWindowOrigin</a>(
03627     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
03628     IN BOOLEAN Absolute,
03629     IN COORD WindowOrigin
03630     )
03631 
03632 <span class="comment">/*++</span>
03633 <span class="comment"></span>
03634 <span class="comment">Routine Description:</span>
03635 <span class="comment"></span>
03636 <span class="comment">    This routine sets the window origin.</span>
03637 <span class="comment"></span>
03638 <span class="comment">Arguments:</span>
03639 <span class="comment"></span>
03640 <span class="comment">    ScreenInfo - pointer to screen buffer info.</span>
03641 <span class="comment"></span>
03642 <span class="comment">    Absolute - if TRUE, WindowOrigin is specified in absolute screen</span>
03643 <span class="comment">    buffer coordinates.  if FALSE, WindowOrigin is specified in coordinates</span>
03644 <span class="comment">    relative to the current window origin.</span>
03645 <span class="comment"></span>
03646 <span class="comment">    WindowOrigin - New window origin.</span>
03647 <span class="comment"></span>
03648 <span class="comment">Return Value:</span>
03649 <span class="comment"></span>
03650 <span class="comment">--*/</span>
03651 
03652 {
03653     SMALL_RECT NewWindow;
03654     COORD WindowSize;
03655     RECT BoundingBox;
03656     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> Success;
03657     RECT ScrollRect;
03658     SMALL_RECT UpdateRegion;
03659     COORD FontSize;
03660     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console = ScreenInfo-&gt;Console;
03661 
03662     <span class="comment">//</span>
03663     <span class="comment">// calculate window size</span>
03664     <span class="comment">//</span>
03665 
03666     WindowSize.X = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)<a class="code" href="../../d7/d2/output_8h.html#a17">CONSOLE_WINDOW_SIZE_X</a>(ScreenInfo);
03667     WindowSize.Y = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)<a class="code" href="../../d7/d2/output_8h.html#a18">CONSOLE_WINDOW_SIZE_Y</a>(ScreenInfo);
03668 
03669     <span class="comment">//</span>
03670     <span class="comment">// if relative coordinates, figure out absolute coords.</span>
03671     <span class="comment">//</span>
03672 
03673     <span class="keywordflow">if</span> (!Absolute) {
03674         <span class="keywordflow">if</span> (WindowOrigin.X == 0 &amp;&amp; WindowOrigin.Y == 0) {
03675             <span class="keywordflow">return</span> STATUS_SUCCESS;
03676         }
03677         NewWindow.Left = ScreenInfo-&gt;Window.Left + WindowOrigin.X;
03678         NewWindow.Top = ScreenInfo-&gt;Window.Top + WindowOrigin.Y;
03679     }
03680     <span class="keywordflow">else</span> {
03681         <span class="keywordflow">if</span> (WindowOrigin.X == ScreenInfo-&gt;Window.Left &amp;&amp;
03682             WindowOrigin.Y == ScreenInfo-&gt;Window.Top) {
03683             <span class="keywordflow">return</span> STATUS_SUCCESS;
03684         }
03685         NewWindow.Left = WindowOrigin.X;
03686         NewWindow.Top = WindowOrigin.Y;
03687     }
03688     NewWindow.Right = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(NewWindow.Left + WindowSize.X - 1);
03689     NewWindow.Bottom = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(NewWindow.Top + WindowSize.Y - 1);
03690 
03691     <span class="comment">//</span>
03692     <span class="comment">// see if new window origin would extend window beyond extent of screen</span>
03693     <span class="comment">// buffer</span>
03694     <span class="comment">//</span>
03695 
03696     <span class="keywordflow">if</span> (NewWindow.Left &lt; 0 || NewWindow.Top &lt; 0 ||
03697         NewWindow.Right &lt; 0 || NewWindow.Bottom &lt; 0 ||
03698         NewWindow.Right &gt;= ScreenInfo-&gt;ScreenBufferSize.X ||
03699         NewWindow.Bottom &gt;= ScreenInfo-&gt;ScreenBufferSize.Y) {
03700         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
03701     }
03702 
03703     <span class="keywordflow">if</span> (ScreenInfo-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>) {
03704         FontSize = <a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(ScreenInfo);
03705         ScreenInfo-&gt;BufferInfo.TextInfo.Flags &amp;= ~<a class="code" href="../../d7/d2/output_8h.html#a3">TEXT_VALID_HINT</a>;
03706     } <span class="keywordflow">else</span> {
03707         FontSize.X = 1;
03708         FontSize.Y = 1;
03709     }
03710     <a class="code" href="../../d6/d1/ntcon_2server_2cursor_8c.html#a3">ConsoleHideCursor</a>(ScreenInfo);
03711     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d2/output_8h.html#a12">ACTIVE_SCREEN_BUFFER</a>(ScreenInfo) &amp;&amp;
03712         Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o47">FullScreenFlags</a> == 0 &amp;&amp;
03713         !(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; (<a class="code" href="../../d1/d7/server_8h.html#a0">CONSOLE_IS_ICONIC</a> | <a class="code" href="../../d1/d7/server_8h.html#a8">CONSOLE_NO_WINDOW</a>))) {
03714 
03715         <a class="code" href="../../d8/d5/consrv_8h.html#a308">InvertSelection</a>(Console, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03716 <span class="preprocessor">#if defined(FE_SB)</span>
03717 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (CONSOLE_IS_DBCS_OUTPUTCP(Console) &amp;&amp;
03718             !(Console-&gt;ConsoleIme.ScrollFlag &amp; HIDE_FOR_SCROLL)) {
03719             ConsoleImeBottomLineUse(ScreenInfo,0);
03720         }
03721 <span class="preprocessor">#endif</span>
03722 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (   ScreenInfo-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>
03723             &amp;&amp; <a class="code" href="../../d6/d2/output_8c.html#a24">UsePolyTextOut</a>
03724             &amp;&amp; NewWindow.Left == ScreenInfo-&gt;Window.Left
03725            ) {
03726             <a class="code" href="../../d6/d2/output_8c.html#a63">ScrollEntireScreen</a>(ScreenInfo,
03727                 (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(NewWindow.Top - ScreenInfo-&gt;Window.Top),
03728                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03729             ScreenInfo-&gt;Window = NewWindow;
03730             <a class="code" href="../../d6/d8/dispatch_8h.html#a5">WriteRegionToScreen</a>(ScreenInfo, &amp;NewWindow);
03731         } <span class="keywordflow">else</span> {
03732 <span class="preprocessor">#if defined(FE_SB)</span>
03733 <span class="preprocessor"></span>            RECT ClipRect;
03734 <span class="preprocessor">#endif</span>
03735 <span class="preprocessor"></span>            ScrollRect.left = 0;
03736             ScrollRect.right = <a class="code" href="../../d7/d2/output_8h.html#a17">CONSOLE_WINDOW_SIZE_X</a>(ScreenInfo)*FontSize.X;
03737             ScrollRect.top = 0;
03738 <span class="preprocessor">#if defined(FE_SB)</span>
03739 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (CONSOLE_IS_DBCS_OUTPUTCP(Console) &amp;&amp;
03740                 Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o3">InputBuffer</a>.ImeMode.Open )
03741             {
03742                 <span class="keywordflow">if</span> (ScreenInfo-&gt;Window.Top &lt;= NewWindow.Top)
03743                     ScrollRect.bottom = (<a class="code" href="../../d7/d2/output_8h.html#a18">CONSOLE_WINDOW_SIZE_Y</a>(ScreenInfo)-1)*FontSize.Y;
03744                 <span class="keywordflow">else</span>
03745                     ScrollRect.bottom = (<a class="code" href="../../d7/d2/output_8h.html#a18">CONSOLE_WINDOW_SIZE_Y</a>(ScreenInfo)-2)*FontSize.Y;
03746                 ClipRect = ScrollRect;
03747                 ClipRect.bottom = (<a class="code" href="../../d7/d2/output_8h.html#a18">CONSOLE_WINDOW_SIZE_Y</a>(ScreenInfo)-1)*FontSize.Y;
03748             }
03749             <span class="keywordflow">else</span>
03750 <span class="preprocessor">#endif</span>
03751 <span class="preprocessor"></span>            ScrollRect.bottom = <a class="code" href="../../d7/d2/output_8h.html#a18">CONSOLE_WINDOW_SIZE_Y</a>(ScreenInfo)*FontSize.Y;
03752 
03753 <span class="preprocessor">#if defined(FE_SB)</span>
03754 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (CONSOLE_IS_DBCS_OUTPUTCP(Console) &amp;&amp;
03755                 ScrollRect.bottom == 0) {
03756                 UpdateRegion.Left   = 0;
03757                 UpdateRegion.Top    = 0;
03758                 UpdateRegion.Right  = <a class="code" href="../../d7/d2/output_8h.html#a17">CONSOLE_WINDOW_SIZE_X</a>(ScreenInfo);
03759                 UpdateRegion.Bottom = 0;
03760                 <a class="code" href="../../d6/d8/dispatch_8h.html#a4">WriteToScreen</a>(ScreenInfo,&amp;UpdateRegion);
03761             }
03762             <span class="keywordflow">else</span> {
03763 <span class="preprocessor">#endif</span>
03764 <span class="preprocessor"></span>            <a class="code" href="../../d6/d2/output_8c.html#a0">SCROLLDC_CALL</a>;
03765 <span class="preprocessor">#if defined(FE_SB)</span>
03766 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (CONSOLE_IS_DBCS_OUTPUTCP(Console) &amp;&amp;
03767                      Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o3">InputBuffer</a>.ImeMode.Open )
03768                 {
03769                     Success = <a class="code" href="../../d3/d8/client_8c.html#a48">ScrollDC</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o10">hDC</a>,
03770                                          (ScreenInfo-&gt;Window.Left-NewWindow.Left)*FontSize.X,
03771                                          (ScreenInfo-&gt;Window.Top-NewWindow.Top)*FontSize.Y,
03772                                          &amp;ScrollRect,
03773                                          &amp;ClipRect,
03774                                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03775                                          &amp;BoundingBox
03776                                          );
03777                 }
03778                 <span class="keywordflow">else</span>
03779 <span class="preprocessor">#endif</span>
03780 <span class="preprocessor"></span>            Success = <a class="code" href="../../d3/d8/client_8c.html#a48">ScrollDC</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o10">hDC</a>,
03781                                  (ScreenInfo-&gt;Window.Left-NewWindow.Left)*FontSize.X,
03782                                  (ScreenInfo-&gt;Window.Top-NewWindow.Top)*FontSize.Y,
03783                                  &amp;ScrollRect,
03784                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03785                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03786                                  &amp;BoundingBox
03787                                  );
03788 
03789             <span class="keywordflow">if</span> (Success) {
03790                 UpdateRegion.Left = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)((BoundingBox.left/FontSize.X)+NewWindow.Left);
03791                 UpdateRegion.Right = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(((BoundingBox.right-1)/FontSize.X)+NewWindow.Left);
03792                 UpdateRegion.Top = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)((BoundingBox.top/FontSize.Y)+NewWindow.Top);
03793                 UpdateRegion.Bottom = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(((BoundingBox.bottom-1)/FontSize.Y)+NewWindow.Top);
03794             }
03795             <span class="keywordflow">else</span>  {
03796                 UpdateRegion = NewWindow;
03797             }
03798 
03799             <span class="comment">//</span>
03800             <span class="comment">// new window is ok.  store it in screeninfo and refresh screen.</span>
03801             <span class="comment">//</span>
03802 
03803             ScreenInfo-&gt;Window = NewWindow;
03804 
03805             <a class="code" href="../../d6/d8/dispatch_8h.html#a4">WriteToScreen</a>(ScreenInfo,&amp;UpdateRegion);
03806 <span class="preprocessor">#if defined(FE_SB)</span>
03807 <span class="preprocessor"></span>            }
03808 <span class="preprocessor">#endif</span>
03809 <span class="preprocessor"></span>        }
03810         <a class="code" href="../../d8/d5/consrv_8h.html#a308">InvertSelection</a>(Console, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03811     }
03812 <span class="preprocessor">#ifdef i386</span>
03813 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o47">FullScreenFlags</a> &amp; CONSOLE_FULLSCREEN_HARDWARE &amp;&amp;
03814              ScreenInfo-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>) {
03815 
03816 
03817         <span class="comment">//</span>
03818         <span class="comment">// keep mouse pointer on screen</span>
03819         <span class="comment">//</span>
03820 
03821         <span class="keywordflow">if</span> (ScreenInfo-&gt;BufferInfo.TextInfo.MousePosition.X &lt; NewWindow.Left) {
03822             ScreenInfo-&gt;BufferInfo.TextInfo.MousePosition.X = NewWindow.Left;
03823         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ScreenInfo-&gt;BufferInfo.TextInfo.MousePosition.X &gt; NewWindow.Right) {
03824             ScreenInfo-&gt;BufferInfo.TextInfo.MousePosition.X = NewWindow.Right;
03825         }
03826 
03827         <span class="keywordflow">if</span> (ScreenInfo-&gt;BufferInfo.TextInfo.MousePosition.Y &lt; NewWindow.Top) {
03828             ScreenInfo-&gt;BufferInfo.TextInfo.MousePosition.Y = NewWindow.Top;
03829         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ScreenInfo-&gt;BufferInfo.TextInfo.MousePosition.Y &gt; NewWindow.Bottom) {
03830             ScreenInfo-&gt;BufferInfo.TextInfo.MousePosition.Y = NewWindow.Bottom;
03831         }
03832         ScreenInfo-&gt;Window = NewWindow;
03833         <a class="code" href="../../d6/d8/dispatch_8h.html#a4">WriteToScreen</a>(ScreenInfo,&amp;ScreenInfo-&gt;Window);
03834     }
03835 <span class="preprocessor">#endif</span>
03836 <span class="preprocessor"></span>    <span class="keywordflow">else</span> {
03837         <span class="comment">// we're iconic</span>
03838         ScreenInfo-&gt;Window = NewWindow;
03839     }
03840 
03841 <span class="preprocessor">#if defined(FE_SB)</span>
03842 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (CONSOLE_IS_DBCS_OUTPUTCP(Console) ) {
03843         ConsoleImeResizeModeSystemView(Console,ScreenInfo-&gt;Window);
03844         ConsoleImeResizeCompStrView(Console,ScreenInfo-&gt;Window);
03845     }
03846 <span class="preprocessor">#endif</span>
03847 <span class="preprocessor"></span>    <a class="code" href="../../d6/d1/ntcon_2server_2cursor_8c.html#a2">ConsoleShowCursor</a>(ScreenInfo);
03848 
03849     <span class="keywordflow">if</span> (ScreenInfo-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>) {
03850          ScreenInfo-&gt;BufferInfo.TextInfo.Flags |= <a class="code" href="../../d7/d2/output_8h.html#a3">TEXT_VALID_HINT</a>;
03851     }
03852 
03853     <a class="code" href="../../d6/d2/output_8c.html#a56">UpdateScrollBars</a>(ScreenInfo);
03854     <span class="keywordflow">return</span> STATUS_SUCCESS;
03855 }
03856 
03857 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03858"></a><a class="code" href="../../d6/d2/output_8c.html#a67">03858</a> <a class="code" href="../../d6/d2/output_8c.html#a67">ResizeWindow</a>(
03859     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
03860     IN PSMALL_RECT WindowDimensions,
03861     IN BOOL DoScrollBarUpdate
03862     )
03863 
03864 <span class="comment">/*++</span>
03865 <span class="comment"></span>
03866 <span class="comment">Routine Description:</span>
03867 <span class="comment"></span>
03868 <span class="comment">    This routine changes the console data structures to reflect the specified</span>
03869 <span class="comment">    window size change.  it does not call the user component to update</span>
03870 <span class="comment">    the screen.</span>
03871 <span class="comment"></span>
03872 <span class="comment">Arguments:</span>
03873 <span class="comment"></span>
03874 <span class="comment">    ScreenInformation - the new screen buffer.</span>
03875 <span class="comment"></span>
03876 <span class="comment">    dwWindowSize - the initial size of screen buffer's window.</span>
03877 <span class="comment"></span>
03878 <span class="comment">    nFont - the initial font to generate text with.</span>
03879 <span class="comment"></span>
03880 <span class="comment">    dwScreenBufferSize - the initial size of the screen buffer.</span>
03881 <span class="comment"></span>
03882 <span class="comment">Return Value:</span>
03883 <span class="comment"></span>
03884 <span class="comment"></span>
03885 <span class="comment">--*/</span>
03886 
03887 {
03888     <span class="comment">//</span>
03889     <span class="comment">// make sure there's something to do</span>
03890     <span class="comment">//</span>
03891 
03892     <span class="keywordflow">if</span> (RtlEqualMemory(&amp;ScreenInfo-&gt;Window, WindowDimensions, <span class="keyword">sizeof</span>(SMALL_RECT))) {
03893         <span class="keywordflow">return</span> STATUS_SUCCESS;
03894     }
03895 
03896     <span class="keywordflow">if</span> (WindowDimensions-&gt;Left &lt; 0) {
03897         WindowDimensions-&gt;Right -= WindowDimensions-&gt;Left;
03898         WindowDimensions-&gt;Left = 0;
03899     }
03900     <span class="keywordflow">if</span> (WindowDimensions-&gt;Top &lt; 0) {
03901         WindowDimensions-&gt;Bottom -= WindowDimensions-&gt;Top;
03902         WindowDimensions-&gt;Top = 0;
03903     }
03904 
03905     <span class="keywordflow">if</span> (WindowDimensions-&gt;Right &gt;= ScreenInfo-&gt;ScreenBufferSize.X) {
03906         WindowDimensions-&gt;Right = ScreenInfo-&gt;ScreenBufferSize.X;
03907     }
03908     <span class="keywordflow">if</span> (WindowDimensions-&gt;Bottom &gt;= ScreenInfo-&gt;ScreenBufferSize.Y) {
03909         WindowDimensions-&gt;Bottom = ScreenInfo-&gt;ScreenBufferSize.Y;
03910     }
03911 
03912     ScreenInfo-&gt;Window = *WindowDimensions;
03913     ScreenInfo-&gt;WindowMaximizedX = (<a class="code" href="../../d7/d2/output_8h.html#a17">CONSOLE_WINDOW_SIZE_X</a>(ScreenInfo) == ScreenInfo-&gt;ScreenBufferSize.X);
03914     ScreenInfo-&gt;WindowMaximizedY = (<a class="code" href="../../d7/d2/output_8h.html#a18">CONSOLE_WINDOW_SIZE_Y</a>(ScreenInfo) == ScreenInfo-&gt;ScreenBufferSize.Y);
03915 
03916     <span class="keywordflow">if</span> (DoScrollBarUpdate) {
03917         <a class="code" href="../../d6/d2/output_8c.html#a56">UpdateScrollBars</a>(ScreenInfo);
03918     }
03919 
03920     <span class="keywordflow">if</span> (!(ScreenInfo-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>)) {
03921         <span class="keywordflow">return</span> STATUS_SUCCESS;
03922     }
03923 
03924     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d2/output_8h.html#a12">ACTIVE_SCREEN_BUFFER</a>(ScreenInfo)) {
03925         ScreenInfo-&gt;BufferInfo.TextInfo.Flags &amp;= ~<a class="code" href="../../d7/d2/output_8h.html#a3">TEXT_VALID_HINT</a>;
03926     }
03927 
03928 <span class="preprocessor">#ifdef i386</span>
03929 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (ScreenInfo-&gt;Console-&gt;FullScreenFlags &amp; CONSOLE_FULLSCREEN_HARDWARE) {
03930 
03931         <span class="comment">//</span>
03932         <span class="comment">// keep mouse pointer on screen</span>
03933         <span class="comment">//</span>
03934 
03935         <span class="keywordflow">if</span> (ScreenInfo-&gt;BufferInfo.TextInfo.MousePosition.X &lt; WindowDimensions-&gt;Left) {
03936             ScreenInfo-&gt;BufferInfo.TextInfo.MousePosition.X = WindowDimensions-&gt;Left;
03937         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ScreenInfo-&gt;BufferInfo.TextInfo.MousePosition.X &gt; WindowDimensions-&gt;Right) {
03938             ScreenInfo-&gt;BufferInfo.TextInfo.MousePosition.X = WindowDimensions-&gt;Right;
03939         }
03940 
03941         <span class="keywordflow">if</span> (ScreenInfo-&gt;BufferInfo.TextInfo.MousePosition.Y &lt; WindowDimensions-&gt;Top) {
03942             ScreenInfo-&gt;BufferInfo.TextInfo.MousePosition.Y = WindowDimensions-&gt;Top;
03943         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ScreenInfo-&gt;BufferInfo.TextInfo.MousePosition.Y &gt; WindowDimensions-&gt;Bottom) {
03944             ScreenInfo-&gt;BufferInfo.TextInfo.MousePosition.Y = WindowDimensions-&gt;Bottom;
03945         }
03946     }
03947 <span class="preprocessor">#endif</span>
03948 <span class="preprocessor"></span>
03949     <span class="keywordflow">return</span>(STATUS_SUCCESS);
03950 }
03951 
03952 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03953"></a><a class="code" href="../../d6/d2/output_8c.html#a68">03953</a> <a class="code" href="../../d6/d2/output_8c.html#a68">SetWindowSize</a>(
03954     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo
03955     )
03956 {
03957 <span class="preprocessor">#if defined(FE_IME)</span>
03958 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (ScreenInfo-&gt;ConvScreenInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
03959         <span class="keywordflow">return</span>;
03960 <span class="preprocessor">#endif</span>
03961 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (ScreenInfo-&gt;Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a23">CONSOLE_SETTING_WINDOW_SIZE</a>)
03962         <span class="keywordflow">return</span>;
03963     ScreenInfo-&gt;Console-&gt;Flags |= <a class="code" href="../../d1/d7/server_8h.html#a23">CONSOLE_SETTING_WINDOW_SIZE</a>;
03964     <a class="code" href="../../d0/d8/ntcftxt_8h.html#a20">PostMessage</a>(ScreenInfo-&gt;Console-&gt;hWnd,
03965                  <a class="code" href="../../d1/d7/server_8h.html#a69">CM_SET_WINDOW_SIZE</a>,
03966                  (WPARAM)ScreenInfo,
03967                  0x47474747
03968                 );
03969 }
03970 
03971 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03972"></a><a class="code" href="../../d6/d2/output_8c.html#a69">03972</a> <a class="code" href="../../d6/d2/output_8c.html#a69">UpdateWindowSize</a>(
03973     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
03974     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo
03975     )
03976 {
03977     LONG WindowStyle;
03978 
03979     <span class="keywordflow">if</span> (!(Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a0">CONSOLE_IS_ICONIC</a>)) {
03980         <a class="code" href="../../d6/d2/output_8c.html#a37">InternalUpdateScrollBars</a>(ScreenInfo);
03981 
03982         WindowStyle = GetWindowLong(Console-&gt;hWnd, GWL_STYLE);
03983         <span class="keywordflow">if</span> (ScreenInfo-&gt;WindowMaximized) {
03984             WindowStyle |= WS_MAXIMIZE;
03985         } <span class="keywordflow">else</span> {
03986             WindowStyle &amp;= ~WS_MAXIMIZE;
03987         }
03988         SetWindowLong(Console-&gt;hWnd, GWL_STYLE, WindowStyle);
03989 
03990         <a class="code" href="../../d3/d4/w32_2ntuser_2client_2nt6_2pch_8h.html#a0">SetWindowPos</a>(Console-&gt;hWnd, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03991                      0,
03992                      0,
03993                      Console-&gt;WindowRect.right-Console-&gt;WindowRect.left,
03994                      Console-&gt;WindowRect.bottom-Console-&gt;WindowRect.top,
03995                      SWP_NOMOVE | SWP_NOZORDER | SWP_NOACTIVATE | SWP_DRAWFRAME
03996                     );
03997         Console-&gt;ResizeFlags &amp;= ~<a class="code" href="../../d1/d7/server_8h.html#a44">SCREEN_BUFFER_CHANGE</a>;
03998     } <span class="keywordflow">else</span> {
03999         Console-&gt;ResizeFlags |= <a class="code" href="../../d1/d7/server_8h.html#a44">SCREEN_BUFFER_CHANGE</a>;
04000     }
04001 }
04002 
04003 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l04004"></a><a class="code" href="../../d6/d2/output_8c.html#a70">04004</a> <a class="code" href="../../d6/d2/output_8c.html#a70">InternalSetWindowSize</a>(
04005     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
04006     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
04007     IN PSMALL_RECT Window
04008     )
04009 {
04010     SIZE WindowSize;
04011     WORD WindowSizeX, WindowSizeY;
04012 
04013     Console-&gt;Flags &amp;= ~<a class="code" href="../../d1/d7/server_8h.html#a23">CONSOLE_SETTING_WINDOW_SIZE</a>;
04014     <span class="keywordflow">if</span> (Console-&gt;CurrentScreenBuffer == ScreenInfo) {
04015         <span class="keywordflow">if</span> (Console-&gt;FullScreenFlags == 0) {
04016             <span class="comment">//</span>
04017             <span class="comment">// Make sure our max screen sizes reflect reality</span>
04018             <span class="comment">//</span>
04019 
04020             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/output_8c.html#a23">gfInitSystemMetrics</a>) {
04021                 <a class="code" href="../../d6/d2/output_8c.html#a38">InitializeSystemMetrics</a>();
04022             }
04023 
04024             <span class="comment">//</span>
04025             <span class="comment">// figure out how big to make the window, given the desired client area</span>
04026             <span class="comment">// size.</span>
04027             <span class="comment">//</span>
04028 
04029             ScreenInfo-&gt;ResizingWindow++;
04030             WindowSizeX = <a class="code" href="../../d7/d2/output_8h.html#a15">WINDOW_SIZE_X</a>(Window);
04031             WindowSizeY = <a class="code" href="../../d7/d2/output_8h.html#a16">WINDOW_SIZE_Y</a>(Window);
04032             <span class="keywordflow">if</span> (ScreenInfo-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>) {
04033                 WindowSize.cx = WindowSizeX*<a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(ScreenInfo).X;
04034                 WindowSize.cy = WindowSizeY*<a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(ScreenInfo).Y;
04035             } <span class="keywordflow">else</span> {
04036                 WindowSize.cx = WindowSizeX;
04037                 WindowSize.cy = WindowSizeY;
04038             }
04039             WindowSize.cx += <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a19">VerticalClientToWindow</a>;
04040             WindowSize.cy += <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a20">HorizontalClientToWindow</a>;
04041 
04042             <span class="keywordflow">if</span> (WindowSizeY != 0) {
04043                 <span class="keywordflow">if</span> (!ScreenInfo-&gt;WindowMaximizedX) {
04044                     WindowSize.cy += <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a18">HorizontalScrollSize</a>;
04045                 }
04046                 <span class="keywordflow">if</span> (!ScreenInfo-&gt;WindowMaximizedY) {
04047                     WindowSize.cx += <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a17">VerticalScrollSize</a>;
04048                 }
04049             }
04050 
04051             Console-&gt;WindowRect.right = Console-&gt;WindowRect.left + WindowSize.cx;
04052             Console-&gt;WindowRect.bottom = Console-&gt;WindowRect.top + WindowSize.cy;
04053 
04054             <a class="code" href="../../d6/d2/output_8c.html#a69">UpdateWindowSize</a>(Console,ScreenInfo);
04055             ScreenInfo-&gt;ResizingWindow--;
04056         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Console-&gt;FullScreenFlags &amp; CONSOLE_FULLSCREEN_HARDWARE) {
04057             <a class="code" href="../../d6/d8/dispatch_8h.html#a4">WriteToScreen</a>(ScreenInfo,&amp;ScreenInfo-&gt;Window);
04058         }
04059 <span class="preprocessor">#if defined(FE_IME)</span>
04060 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ( (ScreenInfo-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>) &amp;&amp;
04061              (CONSOLE_IS_DBCS_OUTPUTCP(Console)))
04062         {
04063             ConsoleImeResizeModeSystemView(Console,Console-&gt;CurrentScreenBuffer-&gt;Window);
04064             ConsoleImeResizeCompStrView(Console,Console-&gt;CurrentScreenBuffer-&gt;Window);
04065         }
04066 <span class="preprocessor">#endif // FE_IME</span>
04067 <span class="preprocessor"></span>    }
04068     <span class="keywordflow">return</span> STATUS_SUCCESS;
04069 }
04070 
04071 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l04072"></a><a class="code" href="../../d6/d2/output_8c.html#a71">04072</a> <a class="code" href="../../d6/d2/output_8c.html#a71">SetActiveScreenBuffer</a>(
04073     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo
04074     )
04075 {
04076     <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> OldScreenInfo;
04077     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console = ScreenInfo-&gt;Console;
04078 
04079     OldScreenInfo = Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o4">CurrentScreenBuffer</a>;
04080     <span class="keywordflow">if</span> (ScreenInfo-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>) {
04081 
04082 <span class="preprocessor">#if !defined(_X86_)</span>
04083 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o47">FullScreenFlags</a> &amp; CONSOLE_FULLSCREEN) {
04084             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
04085         }
04086 <span class="preprocessor">#endif</span>
04087 <span class="preprocessor"></span>        Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o4">CurrentScreenBuffer</a> = ScreenInfo;
04088 
04089         <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o47">FullScreenFlags</a> == 0) {
04090 
04091             <span class="comment">//</span>
04092             <span class="comment">// initialize cursor</span>
04093             <span class="comment">//</span>
04094 
04095             ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.CursorOn = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04096 
04097             <span class="comment">//</span>
04098             <span class="comment">// set font</span>
04099             <span class="comment">//</span>
04100 
04101             <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a34">SetFont</a>(ScreenInfo);
04102         }
04103 <span class="preprocessor">#if defined(_X86_)</span>
04104 <span class="preprocessor"></span>        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o47">FullScreenFlags</a> &amp; CONSOLE_FULLSCREEN_HARDWARE) {
04105 
04106             <span class="keywordflow">if</span> (!(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a9">CONSOLE_VDM_REGISTERED</a>)) {
04107 
04108                 <span class="keywordflow">if</span> ( (!(OldScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o1">Flags</a> &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>)) ||
04109                      (OldScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.ModeIndex!=ScreenInfo-&gt;BufferInfo.TextInfo.ModeIndex)) {
04110 
04111                     <span class="comment">// set video mode and font</span>
04112                     SetVideoMode(ScreenInfo);
04113                 }
04114 
04115                 <span class="comment">//set up cursor</span>
04116 
04117                 SetCursorInformationHW(ScreenInfo,
04118                                        ScreenInfo-&gt;BufferInfo.TextInfo.CursorSize,
04119                                        ScreenInfo-&gt;BufferInfo.TextInfo.CursorVisible);
04120                 SetCursorPositionHW(ScreenInfo,
04121                                     ScreenInfo-&gt;BufferInfo.TextInfo.CursorPosition);
04122             }
04123 
04124         }
04125 <span class="preprocessor">#endif</span>
04126 <span class="preprocessor"></span>    }
04127     <span class="keywordflow">else</span> {
04128         Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o4">CurrentScreenBuffer</a> = ScreenInfo;
04129     }
04130 
04131     <span class="comment">//</span>
04132     <span class="comment">// empty input buffer</span>
04133     <span class="comment">//</span>
04134 
04135     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a22">FlushAllButKeys</a>(&amp;Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o3">InputBuffer</a>);
04136 
04137     <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o47">FullScreenFlags</a> == 0) {
04138 
04139         <a class="code" href="../../d9/d4/ntcon_2server_2getset_8c.html#a20">SetScreenColors</a>(ScreenInfo, ScreenInfo-&gt;Attributes,
04140                         ScreenInfo-&gt;PopupAttributes, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04141 
04142         <span class="comment">//</span>
04143         <span class="comment">// set window size</span>
04144         <span class="comment">//</span>
04145 
04146         <a class="code" href="../../d6/d2/output_8c.html#a68">SetWindowSize</a>(ScreenInfo);
04147 
04148         <span class="comment">//</span>
04149         <span class="comment">// initialize the palette, if we have the focus and we're not fullscreen</span>
04150         <span class="comment">//</span>
04151 
04152         <span class="keywordflow">if</span> (!(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a0">CONSOLE_IS_ICONIC</a>) &amp;&amp;
04153             Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o47">FullScreenFlags</a> == 0) {
04154             <span class="keywordflow">if</span> (ScreenInfo-&gt;hPalette != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || OldScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o16">hPalette</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04155                 HPALETTE hPalette;
04156                 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bReset = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04157                 USERTHREAD_USEDESKTOPINFO utudi;
04158 
04159                 <span class="keywordflow">if</span> (GetCurrentThreadId() != Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o75">InputThreadInfo</a>-&gt;<a class="code" href="../../d9/d2/struct__INPUT__THREAD__INFO.html#o1">ThreadId</a>) {
04160                     bReset = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04161                     utudi.hThread = Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o75">InputThreadInfo</a>-&gt;<a class="code" href="../../d9/d2/struct__INPUT__THREAD__INFO.html#o0">ThreadHandle</a>;
04162                     utudi.drdRestore.pdeskRestore = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04163                     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a277">NtUserSetInformationThread</a>(NtCurrentThread(),
04164                             UserThreadUseDesktop,
04165                             &amp;utudi, <span class="keyword">sizeof</span>(utudi));
04166                 }
04167 
04168                 <span class="keywordflow">if</span> (ScreenInfo-&gt;hPalette == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04169                     hPalette = Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o13">hSysPalette</a>;
04170                 } <span class="keywordflow">else</span> {
04171                     hPalette = ScreenInfo-&gt;hPalette;
04172                 }
04173                 <a class="code" href="../../d3/d0/user32_8def.html#a83">SelectPalette</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o10">hDC</a>,
04174                                  hPalette,
04175                                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04176                 <a class="code" href="../../d7/d4/server_2private_8c.html#a46">SetActivePalette</a>(ScreenInfo);
04177 
04178                 <span class="keywordflow">if</span> (bReset == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
04179                     utudi.hThread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04180                     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a277">NtUserSetInformationThread</a>(NtCurrentThread(),
04181                             UserThreadUseDesktop, &amp;utudi, <span class="keyword">sizeof</span>(utudi));
04182                 }
04183             }
04184         }
04185     }
04186 
04187 <span class="preprocessor">#if defined(FE_IME)</span>
04188 <span class="preprocessor"></span>    SetUndetermineAttribute(Console);
04189 <span class="preprocessor">#endif</span>
04190 <span class="preprocessor"></span>    <span class="comment">//</span>
04191     <span class="comment">// write data to screen</span>
04192     <span class="comment">//</span>
04193 
04194     ScreenInfo-&gt;BufferInfo.TextInfo.Flags &amp;= ~<a class="code" href="../../d7/d2/output_8h.html#a3">TEXT_VALID_HINT</a>;
04195     <a class="code" href="../../d6/d8/dispatch_8h.html#a4">WriteToScreen</a>(ScreenInfo,&amp;ScreenInfo-&gt;Window);
04196     <span class="keywordflow">return</span> STATUS_SUCCESS;
04197 }
04198 
04199 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04200"></a><a class="code" href="../../d6/d2/output_8c.html#a72">04200</a> <a class="code" href="../../d6/d2/output_8c.html#a72">SetProcessFocus</a>(
04201     IN PCSR_PROCESS Process,
04202     IN BOOL Foreground
04203     )
04204 {
04205     <span class="keywordflow">if</span> (Foreground) {
04206         CsrSetForegroundPriority(Process);
04207     } <span class="keywordflow">else</span> {
04208         CsrSetBackgroundPriority(Process);
04209     }
04210 }
04211 
04212 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04213"></a><a class="code" href="../../d6/d2/output_8c.html#a73">04213</a> <a class="code" href="../../d6/d2/output_8c.html#a73">SetProcessForegroundRights</a>(
04214     IN PCSR_PROCESS Process,
04215     IN BOOL Foreground
04216     )
04217 {
04218     USERTHREAD_FLAGS Flags;
04219 
04220     Flags.dwMask  = (<a class="code" href="../../d8/d5/consrv_8h.html#a57">W32PF_ALLOWSETFOREGROUND</a> | <a class="code" href="../../d8/d5/consrv_8h.html#a58">W32PF_CONSOLEHASFOCUS</a>);
04221     Flags.dwFlags = (Foreground ? (<a class="code" href="../../d8/d5/consrv_8h.html#a57">W32PF_ALLOWSETFOREGROUND</a> | <a class="code" href="../../d8/d5/consrv_8h.html#a58">W32PF_CONSOLEHASFOCUS</a>) : 0);
04222 
04223     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a278">NtUserSetInformationProcess</a>(Process-&gt;ProcessHandle, UserProcessFlags, &amp;Flags, <span class="keyword">sizeof</span>(Flags));
04224 }
04225 
04226 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04227"></a><a class="code" href="../../d6/d2/output_8c.html#a74">04227</a> <a class="code" href="../../d6/d2/output_8c.html#a74">ModifyConsoleProcessFocus</a>(
04228     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
04229     IN BOOL Foreground
04230     )
04231 {
04232     <a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html">PCONSOLE_PROCESS_HANDLE</a> ProcessHandleRecord;
04233     PLIST_ENTRY ListHead, ListNext;
04234 
04235     ListHead = &amp;Console-&gt;ProcessHandleList;
04236     ListNext = ListHead-&gt;Flink;
04237     <span class="keywordflow">while</span> (ListNext != ListHead) {
04238         ProcessHandleRecord = CONTAINING_RECORD( ListNext, <a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html">CONSOLE_PROCESS_HANDLE</a>, ListLink );
04239         ListNext = ListNext-&gt;Flink;
04240         {
04241             <a class="code" href="../../d6/d2/output_8c.html#a72">SetProcessFocus</a>(ProcessHandleRecord-&gt;<a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html#o2">Process</a>, Foreground);
04242             <a class="code" href="../../d6/d2/output_8c.html#a73">SetProcessForegroundRights</a>(ProcessHandleRecord-&gt;<a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html#o2">Process</a>, Foreground);
04243         }
04244     }
04245 }
04246 
04247 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04248"></a><a class="code" href="../../d6/d2/output_8c.html#a75">04248</a> <a class="code" href="../../d6/d2/output_8c.html#a75">TrimConsoleWorkingSet</a>(
04249     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console
04250     )
04251 {
04252     <a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html">PCONSOLE_PROCESS_HANDLE</a> ProcessHandleRecord;
04253     PLIST_ENTRY ListHead, ListNext;
04254 
04255     ListHead = &amp;Console-&gt;ProcessHandleList;
04256     ListNext = ListHead-&gt;Flink;
04257     <span class="keywordflow">while</span> (ListNext != ListHead) {
04258         ProcessHandleRecord = CONTAINING_RECORD( ListNext, <a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html">CONSOLE_PROCESS_HANDLE</a>, ListLink );
04259         ListNext = ListNext-&gt;Flink;
04260         {
04261             SetProcessWorkingSetSize(ProcessHandleRecord-&gt;<a class="code" href="../../d1/d4/struct__CONSOLE__PROCESS__HANDLE.html#o2">Process</a>-&gt;ProcessHandle,(SIZE_T)-1,(SIZE_T)-1);
04262         }
04263     }
04264 }
04265 
04266 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l04267"></a><a class="code" href="../../d6/d2/output_8c.html#a76">04267</a> <a class="code" href="../../d6/d2/output_8c.html#a76">QueueConsoleMessage</a>(
04268     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
04269     UINT Message,
04270     WPARAM wParam,
04271     LPARAM lParam
04272     )
04273 
04274 <span class="comment">/*++</span>
04275 <span class="comment"></span>
04276 <span class="comment">Routine Description:</span>
04277 <span class="comment"></span>
04278 <span class="comment">    This inserts a message into the console's message queue and wakes up</span>
04279 <span class="comment">    the console input thread to process it.</span>
04280 <span class="comment"></span>
04281 <span class="comment">Arguments:</span>
04282 <span class="comment"></span>
04283 <span class="comment">    Console - Pointer to console information structure.</span>
04284 <span class="comment"></span>
04285 <span class="comment">    Message - Message to store in queue.</span>
04286 <span class="comment"></span>
04287 <span class="comment">    wParam - wParam to store in queue.</span>
04288 <span class="comment"></span>
04289 <span class="comment">    lParam - lParam to store in queue.</span>
04290 <span class="comment"></span>
04291 <span class="comment">Return Value:</span>
04292 <span class="comment"></span>
04293 <span class="comment">    NTSTATUS - STATUS_SUCCESS if everything is OK.</span>
04294 <span class="comment"></span>
04295 <span class="comment">--*/</span>
04296 
04297 {
04298     <a class="code" href="../../d7/d3/struct__CONSOLE__MSG.html">PCONSOLE_MSG</a> pConMsg;
04299 
04300     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d7/server_8h.html#a63">ConsoleLocked</a>(Console));
04301 
04302     pConMsg = (<a class="code" href="../../d7/d3/struct__CONSOLE__MSG.html">PCONSOLE_MSG</a>)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a9">TMP_TAG</a> ), <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d3/struct__CONSOLE__MSG.html">CONSOLE_MSG</a>));
04303     <span class="keywordflow">if</span> (pConMsg == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04304         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
04305     }
04306 
04307     pConMsg-&gt;<a class="code" href="../../d7/d3/struct__CONSOLE__MSG.html#o1">Message</a> = Message;
04308     pConMsg-&gt;<a class="code" href="../../d7/d3/struct__CONSOLE__MSG.html#o2">wParam</a> = wParam;
04309     pConMsg-&gt;<a class="code" href="../../d7/d3/struct__CONSOLE__MSG.html#o3">lParam</a> = lParam;
04310 
04311     InsertHeadList(&amp;Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o76">MessageQueue</a>, &amp;pConMsg-&gt;<a class="code" href="../../d7/d3/struct__CONSOLE__MSG.html#o0">ListLink</a>);
04312 
04313     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d8/ntcftxt_8h.html#a20">PostMessage</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o8">hWnd</a>, <a class="code" href="../../d1/d7/server_8h.html#a76">CM_CONSOLE_MSG</a>, 0, 0)) {
04314         RemoveEntryList(&amp;pConMsg-&gt;<a class="code" href="../../d7/d3/struct__CONSOLE__MSG.html#o0">ListLink</a>);
04315         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(pConMsg);
04316         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
04317     }
04318 
04319     <span class="keywordflow">return</span> STATUS_SUCCESS;
04320 }
04321 
04322 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l04323"></a><a class="code" href="../../d6/d2/output_8c.html#a77">04323</a> <a class="code" href="../../d6/d2/output_8c.html#a77">UnqueueConsoleMessage</a>(
04324     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
04325     UINT *pMessage,
04326     WPARAM *pwParam,
04327     LPARAM *plParam
04328     )
04329 
04330 <span class="comment">/*++</span>
04331 <span class="comment"></span>
04332 <span class="comment">Routine Description:</span>
04333 <span class="comment"></span>
04334 <span class="comment">    This routine removes a message from the console's message queue.</span>
04335 <span class="comment"></span>
04336 <span class="comment">Arguments:</span>
04337 <span class="comment"></span>
04338 <span class="comment">    Console - Pointer to console information structure.</span>
04339 <span class="comment"></span>
04340 <span class="comment">    pMessage - Pointer in which to return Message.</span>
04341 <span class="comment"></span>
04342 <span class="comment">    pwParam - Pointer in which to return wParam.</span>
04343 <span class="comment"></span>
04344 <span class="comment">    plParam - Pointer in which to return lParam.</span>
04345 <span class="comment"></span>
04346 <span class="comment">Return Value:</span>
04347 <span class="comment"></span>
04348 <span class="comment">    BOOL - TRUE if message was found and FALSE otherwise.</span>
04349 <span class="comment"></span>
04350 <span class="comment">--*/</span>
04351 
04352 {
04353     PLIST_ENTRY pEntry;
04354     <a class="code" href="../../d7/d3/struct__CONSOLE__MSG.html">PCONSOLE_MSG</a> pConMsg = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04355 
04356     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d7/server_8h.html#a63">ConsoleLocked</a>(Console));
04357 
04358     <span class="keywordflow">if</span> (IsListEmpty(&amp;Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o76">MessageQueue</a>)) {
04359         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04360     }
04361 
04362     pEntry = RemoveTailList(&amp;Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o76">MessageQueue</a>);
04363     pConMsg = CONTAINING_RECORD(pEntry, <a class="code" href="../../d7/d3/struct__CONSOLE__MSG.html">CONSOLE_MSG</a>, ListLink);
04364 
04365     *pMessage = pConMsg-&gt;<a class="code" href="../../d7/d3/struct__CONSOLE__MSG.html#o1">Message</a>;
04366     *pwParam = pConMsg-&gt;<a class="code" href="../../d7/d3/struct__CONSOLE__MSG.html#o2">wParam</a>;
04367     *plParam = pConMsg-&gt;<a class="code" href="../../d7/d3/struct__CONSOLE__MSG.html#o3">lParam</a>;
04368 
04369     <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(pConMsg);
04370 
04371     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04372 }
04373 
04374 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04375"></a><a class="code" href="../../d6/d2/output_8c.html#a78">04375</a> <a class="code" href="../../d6/d2/output_8c.html#a78">CleanupConsoleMessages</a>(
04376     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console
04377     )
04378 
04379 <span class="comment">/*++</span>
04380 <span class="comment"></span>
04381 <span class="comment">Routine Description:</span>
04382 <span class="comment"></span>
04383 <span class="comment">    This routine cleans up any console messages still in the queue.</span>
04384 <span class="comment"></span>
04385 <span class="comment">Arguments:</span>
04386 <span class="comment"></span>
04387 <span class="comment">    Console - Pointer to console information structure.</span>
04388 <span class="comment"></span>
04389 <span class="comment">Return Value:</span>
04390 <span class="comment"></span>
04391 <span class="comment">    none.</span>
04392 <span class="comment"></span>
04393 <span class="comment">--*/</span>
04394 
04395 {
04396     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> Message;
04397     WPARAM wParam;
04398     LPARAM lParam;
04399 
04400     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d2/output_8c.html#a77">UnqueueConsoleMessage</a>(Console, &amp;Message, &amp;wParam, &amp;lParam)) {
04401         <span class="keywordflow">switch</span> (Message) {
04402         <span class="keywordflow">case</span> <a class="code" href="../../d1/d7/server_8h.html#a73">CM_MODE_TRANSITION</a>:
04403             <a class="code" href="../../d0/d8/ex_2event_8c.html#a10">NtSetEvent</a>((HANDLE)lParam, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04404             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>((HANDLE)lParam);
04405             <span class="keywordflow">break</span>;
04406         <span class="keywordflow">case</span> CM_SET_IME_CODEPAGE:
04407         <span class="keywordflow">case</span> CM_SET_NLSMODE:
04408         <span class="keywordflow">case</span> CM_GET_NLSMODE:
04409             <span class="keywordflow">if</span> (wParam) {
04410                 <a class="code" href="../../d0/d8/ex_2event_8c.html#a10">NtSetEvent</a>((HANDLE)wParam, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04411                 <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>((HANDLE)wParam);
04412             }
04413             <span class="keywordflow">break</span>;
04414         <span class="keywordflow">default</span>:
04415             KdPrint((<span class="stringliteral">"CONSRV: CleanupConsoleMessages - unknown message %x\n"</span>, Message));
04416             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04417             <span class="keywordflow">break</span>;
04418         }
04419     }
04420 }
04421 
04422 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04423"></a><a class="code" href="../../d6/d2/output_8c.html#a79">04423</a> <a class="code" href="../../d6/d2/output_8c.html#a79">AbortCreateConsole</a>(
04424     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console
04425     )
04426 {
04427     <span class="comment">//</span>
04428     <span class="comment">// Signal any process waiting for us that initialization failed</span>
04429     <span class="comment">//</span>
04430 
04431     <a class="code" href="../../d0/d8/ex_2event_8c.html#a10">NtSetEvent</a>(Console-&gt;InitEvents[<a class="code" href="../../d5/d5/conmsg_8h.html#a5">INITIALIZATION_FAILED</a>],<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04432 
04433     <span class="comment">//</span>
04434     <span class="comment">// Now clean up the console structure</span>
04435     <span class="comment">//</span>
04436 
04437     CloseHandle(Console-&gt;ClientThreadHandle);
04438     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a18">FreeInputBuffer</a>(&amp;Console-&gt;InputBuffer);
04439     <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(Console-&gt;Title);
04440     <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(Console-&gt;OriginalTitle);
04441     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(Console-&gt;InitEvents[<a class="code" href="../../d5/d5/conmsg_8h.html#a4">INITIALIZATION_SUCCEEDED</a>]);
04442     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(Console-&gt;InitEvents[<a class="code" href="../../d5/d5/conmsg_8h.html#a5">INITIALIZATION_FAILED</a>]);
04443     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(Console-&gt;TerminationEvent);
04444     <a class="code" href="../../d8/d5/consrv_8h.html#a258">FreeAliasBuffers</a>(Console);
04445     <a class="code" href="../../d8/d5/consrv_8h.html#a260">FreeCommandHistoryBuffers</a>(Console);
04446 <span class="preprocessor">#if defined(FE_SB)</span>
04447 <span class="preprocessor"></span>    <a class="code" href="../../d9/d7/eudc_8h.html#a6">FreeLocalEUDC</a>(Console);
04448     <a class="code" href="../../d6/d6/foncache_8h.html#a24">DestroyFontCache</a>(Console-&gt;FontCacheInformation);
04449 <span class="preprocessor">#endif</span>
04450 <span class="preprocessor"></span>    <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a20">DestroyConsole</a>(Console);
04451 }
04452 
04453 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04454"></a><a class="code" href="../../d6/d2/output_8c.html#a80">04454</a> <a class="code" href="../../d6/d2/output_8c.html#a80">DestroyWindowsWindow</a>(
04455     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console
04456     )
04457 {
04458     <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> Cur,Next;
04459     HWND <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a> = Console-&gt;hWnd;
04460 
04461     <a class="code" href="../../d6/d2/output_8c.html#a22">gnConsoleWindows</a>--;
04462     Console-&gt;InputThreadInfo-&gt;WindowCount--;
04463 
04464     <a class="code" href="../../d6/d2/output_8c.html#a8">SetWindowConsole</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04465 
04466     KillTimer(Console-&gt;hWnd,<a class="code" href="../../d7/d2/output_8h.html#a9">CURSOR_TIMER</a>);
04467 
04468     <span class="keywordflow">if</span> (Console-&gt;hWndProperties) {
04469         <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(Console-&gt;hWndProperties, WM_CLOSE, 0, 0);
04470     }
04471 
04472     <span class="comment">// FE_SB</span>
04473     <span class="keywordflow">if</span> (Console-&gt;FonthDC) {
04474         <a class="code" href="../../d3/d8/client_8c.html#a45">ReleaseDC</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, Console-&gt;FonthDC);
04475         DeleteObject(Console-&gt;hBitmap);
04476     }
04477     <a class="code" href="../../d9/d7/eudc_8h.html#a4">DeleteEUDC</a>(Console);
04478 
04479     <span class="comment">// FE_IME</span>
04480     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/consrv_8h.html#a33">CONSOLE_IS_IME_ENABLED</a>()) {
04481         <span class="keywordflow">if</span> (!(Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a8">CONSOLE_NO_WINDOW</a>)) {
04482             <span class="comment">// v-HirShi Jul.4.1995 For console IME</span>
04483             KillTimer(Console-&gt;hWnd, SCROLL_WAIT_TIMER);
04484         }
04485         ConsoleImeMessagePump(Console,
04486                               <a class="code" href="../../d3/d5/conime_8h.html#a10">CONIME_DESTROY</a>,
04487                               (WPARAM)Console-&gt;ConsoleHandle,
04488                               (LPARAM)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
04489                              );
04490     }
04491     <span class="comment">// end FE_IME</span>
04492     <span class="comment">// end FE_SB</span>
04493 
04494     <a class="code" href="../../d6/d2/output_8c.html#a78">CleanupConsoleMessages</a>(Console);
04495 
04496     <a class="code" href="../../d3/d8/client_8c.html#a45">ReleaseDC</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, Console-&gt;hDC);
04497     Console-&gt;hDC = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04498 
04499     <a class="code" href="../../d3/d4/w32_2ntuser_2client_2nt6_2pch_8h.html#a3">DestroyWindow</a>(Console-&gt;hWnd);
04500     Console-&gt;hWnd = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04501 
04502     <span class="comment">//</span>
04503     <span class="comment">// Tell the worker thread that the window is destroyed.</span>
04504     <span class="comment">//</span>
04505 
04506     <a class="code" href="../../d3/d8/client_8c.html#a125">ReplyMessage</a>(0);
04507 
04508     <span class="comment">//</span>
04509     <span class="comment">// Clear out any keyboard messages we have stored away.</span>
04510     <span class="comment">//</span>
04511 
04512     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a33">ClearKeyInfo</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>);
04513 
04514     <span class="keywordflow">if</span> (Console-&gt;hIcon != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; Console-&gt;hIcon != <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a5">ghDefaultIcon</a>) {
04515         <a class="code" href="../../d3/d0/user32_8def.html#a64">DestroyIcon</a>(Console-&gt;hIcon);
04516     }
04517     <span class="keywordflow">if</span> (Console-&gt;hSmIcon != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; Console-&gt;hSmIcon != <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a6">ghDefaultSmIcon</a>) {
04518         <a class="code" href="../../d3/d0/user32_8def.html#a64">DestroyIcon</a>(Console-&gt;hSmIcon);
04519     }
04520 
04521     <span class="comment">//</span>
04522     <span class="comment">// must keep this thread handle around until after the destroywindow</span>
04523     <span class="comment">// call so that impersonation will work.</span>
04524     <span class="comment">//</span>
04525 
04526     CloseHandle(Console-&gt;ClientThreadHandle);
04527 
04528     <span class="comment">//</span>
04529     <span class="comment">// once the sendmessage returns, there will be no more input to</span>
04530     <span class="comment">// the console so we don't need to lock it.</span>
04531     <span class="comment">// also, we've freed the console handle, so no apis may access the console.</span>
04532     <span class="comment">//</span>
04533 
04534     <span class="comment">//</span>
04535     <span class="comment">// free screen buffers</span>
04536     <span class="comment">//</span>
04537 
04538     <span class="keywordflow">for</span> (Cur=Console-&gt;ScreenBuffers;Cur!=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;Cur=Next) {
04539         Next = Cur-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o23">Next</a>;
04540         <a class="code" href="../../d6/d2/output_8c.html#a46">FreeScreenBuffer</a>(Cur);
04541     }
04542 
04543     <a class="code" href="../../d8/d5/consrv_8h.html#a258">FreeAliasBuffers</a>(Console);
04544     <a class="code" href="../../d8/d5/consrv_8h.html#a260">FreeCommandHistoryBuffers</a>(Console);
04545 
04546     <span class="comment">//</span>
04547     <span class="comment">// free input buffer</span>
04548     <span class="comment">//</span>
04549 
04550     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a18">FreeInputBuffer</a>(&amp;Console-&gt;InputBuffer);
04551     <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(Console-&gt;Title);
04552     <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(Console-&gt;OriginalTitle);
04553     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(Console-&gt;InitEvents[<a class="code" href="../../d5/d5/conmsg_8h.html#a4">INITIALIZATION_SUCCEEDED</a>]);
04554     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(Console-&gt;InitEvents[<a class="code" href="../../d5/d5/conmsg_8h.html#a5">INITIALIZATION_FAILED</a>]);
04555     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(Console-&gt;TerminationEvent);
04556     <span class="keywordflow">if</span> (Console-&gt;hWinSta != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04557         CloseDesktop(Console-&gt;hDesk);
04558         <a class="code" href="../../d3/d0/user32_8def.html#a72">CloseWindowStation</a>(Console-&gt;hWinSta);
04559     }
04560     <span class="keywordflow">if</span> (Console-&gt;VDMProcessHandle)
04561         CloseHandle(Console-&gt;VDMProcessHandle);
04562     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!(Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a9">CONSOLE_VDM_REGISTERED</a>));
04563     <span class="comment">/*if (Console-&gt;VDMBuffer != NULL) {</span>
04564 <span class="comment">        NtUnmapViewOfSection(NtCurrentProcess(),Console-&gt;VDMBuffer);</span>
04565 <span class="comment">        NtClose(Console-&gt;VDMBufferSectionHandle);</span>
04566 <span class="comment">    }*/</span>
04567 <span class="preprocessor">#if defined(FE_SB)</span>
04568 <span class="preprocessor"></span>    <a class="code" href="../../d9/d7/eudc_8h.html#a6">FreeLocalEUDC</a>(Console);
04569     <a class="code" href="../../d6/d6/foncache_8h.html#a24">DestroyFontCache</a>(Console-&gt;FontCacheInformation);
04570 <span class="preprocessor">#endif</span>
04571 <span class="preprocessor"></span>    <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a20">DestroyConsole</a>(Console);
04572 }
04573 
04574 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04575"></a><a class="code" href="../../d6/d2/output_8c.html#a81">04575</a> <a class="code" href="../../d6/d2/output_8c.html#a81">VerticalScroll</a>(
04576     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
04577     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
04578     IN WORD ScrollCommand,
04579     IN WORD AbsoluteChange
04580     )
04581 {
04582     COORD NewOrigin;
04583 
04584     NewOrigin.X = ScreenInfo-&gt;Window.Left;
04585     NewOrigin.Y = ScreenInfo-&gt;Window.Top;
04586     <span class="keywordflow">switch</span> (ScrollCommand) {
04587         <span class="keywordflow">case</span> SB_LINEUP:
04588             NewOrigin.Y--;
04589             <span class="keywordflow">break</span>;
04590         <span class="keywordflow">case</span> SB_LINEDOWN:
04591             NewOrigin.Y++;
04592             <span class="keywordflow">break</span>;
04593         <span class="keywordflow">case</span> SB_PAGEUP:
04594 <span class="preprocessor">#if defined(FE_IME)</span>
04595 <span class="preprocessor"></span><span class="comment">// MSKK July.22.1993 KazuM</span>
04596 <span class="comment">// Plan of bottom line reservation for console IME.</span>
04597             <span class="keywordflow">if</span> ( ScreenInfo-&gt;Console-&gt;InputBuffer.ImeMode.Open )
04598             {
04599                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ScreenInfo-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>);
04600                 <span class="keywordflow">if</span> (!(ScreenInfo-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>)) {
04601                     <span class="keywordflow">return</span>;
04602                 }
04603                 NewOrigin.Y-=<a class="code" href="../../d7/d2/output_8h.html#a18">CONSOLE_WINDOW_SIZE_Y</a>(ScreenInfo)-2;
04604                 ScreenInfo-&gt;BufferInfo.TextInfo.Flags &amp;= ~<a class="code" href="../../d7/d2/output_8h.html#a3">TEXT_VALID_HINT</a>;
04605                 ScreenInfo-&gt;BufferInfo.TextInfo.Flags |= CONSOLE_CONVERSION_AREA_REDRAW;
04606             }
04607             <span class="keywordflow">else</span>
04608 <span class="preprocessor">#endif // FE_IME</span>
04609 <span class="preprocessor"></span>            NewOrigin.Y-=<a class="code" href="../../d7/d2/output_8h.html#a18">CONSOLE_WINDOW_SIZE_Y</a>(ScreenInfo)-1;
04610             <span class="keywordflow">break</span>;
04611         <span class="keywordflow">case</span> SB_PAGEDOWN:
04612 <span class="preprocessor">#if defined(FE_IME)</span>
04613 <span class="preprocessor"></span><span class="comment">// MSKK July.22.1993 KazuM</span>
04614 <span class="comment">// Plan of bottom line reservation for console IME.</span>
04615             <span class="keywordflow">if</span> ( ScreenInfo-&gt;Console-&gt;InputBuffer.ImeMode.Open )
04616             {
04617                 NewOrigin.Y+=<a class="code" href="../../d7/d2/output_8h.html#a18">CONSOLE_WINDOW_SIZE_Y</a>(ScreenInfo)-2;
04618                 ScreenInfo-&gt;BufferInfo.TextInfo.Flags &amp;= ~<a class="code" href="../../d7/d2/output_8h.html#a3">TEXT_VALID_HINT</a>;
04619                 ScreenInfo-&gt;BufferInfo.TextInfo.Flags |= CONSOLE_CONVERSION_AREA_REDRAW;
04620             }
04621             <span class="keywordflow">else</span>
04622 <span class="preprocessor">#endif // FE_IME</span>
04623 <span class="preprocessor"></span>            NewOrigin.Y+=<a class="code" href="../../d7/d2/output_8h.html#a18">CONSOLE_WINDOW_SIZE_Y</a>(ScreenInfo)-1;
04624             <span class="keywordflow">break</span>;
04625         <span class="keywordflow">case</span> SB_THUMBTRACK:
04626             Console-&gt;Flags |= <a class="code" href="../../d1/d7/server_8h.html#a21">CONSOLE_SCROLLBAR_TRACKING</a>;
04627             NewOrigin.Y= AbsoluteChange;
04628             <span class="keywordflow">break</span>;
04629         <span class="keywordflow">case</span> SB_THUMBPOSITION:
04630             <a class="code" href="../../d0/d7/server_2stream_8c.html#a30">UnblockWriteConsole</a>(Console, <a class="code" href="../../d1/d7/server_8h.html#a21">CONSOLE_SCROLLBAR_TRACKING</a>);
04631             NewOrigin.Y= AbsoluteChange;
04632             <span class="keywordflow">break</span>;
04633         <span class="keywordflow">case</span> SB_TOP:
04634             NewOrigin.Y=0;
04635             <span class="keywordflow">break</span>;
04636         <span class="keywordflow">case</span> SB_BOTTOM:
04637             NewOrigin.Y=(WORD)(ScreenInfo-&gt;ScreenBufferSize.Y-<a class="code" href="../../d7/d2/output_8h.html#a18">CONSOLE_WINDOW_SIZE_Y</a>(ScreenInfo));
04638             <span class="keywordflow">break</span>;
04639 
04640         <span class="keywordflow">default</span>:
04641             <span class="keywordflow">return</span>;
04642     }
04643 
04644     NewOrigin.Y = (WORD)(<a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(0,<a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)NewOrigin.Y,
04645                             (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)ScreenInfo-&gt;ScreenBufferSize.Y-(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)<a class="code" href="../../d7/d2/output_8h.html#a18">CONSOLE_WINDOW_SIZE_Y</a>(ScreenInfo))));
04646     <a class="code" href="../../d6/d2/output_8c.html#a66">SetWindowOrigin</a>(ScreenInfo,
04647                     (BOOLEAN)<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
04648                     NewOrigin
04649                    );
04650 }
04651 
04652 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04653"></a><a class="code" href="../../d6/d2/output_8c.html#a82">04653</a> <a class="code" href="../../d6/d2/output_8c.html#a82">HorizontalScroll</a>(
04654     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
04655     IN WORD ScrollCommand,
04656     IN WORD AbsoluteChange
04657     )
04658 {
04659     COORD NewOrigin;
04660 
04661     NewOrigin.X = ScreenInfo-&gt;Window.Left;
04662     NewOrigin.Y = ScreenInfo-&gt;Window.Top;
04663     <span class="keywordflow">switch</span> (ScrollCommand) {
04664         <span class="keywordflow">case</span> SB_LINEUP:
04665             NewOrigin.X--;
04666             <span class="keywordflow">break</span>;
04667         <span class="keywordflow">case</span> SB_LINEDOWN:
04668             NewOrigin.X++;
04669             <span class="keywordflow">break</span>;
04670         <span class="keywordflow">case</span> SB_PAGEUP:
04671             NewOrigin.X-=<a class="code" href="../../d7/d2/output_8h.html#a17">CONSOLE_WINDOW_SIZE_X</a>(ScreenInfo)-1;
04672             <span class="keywordflow">break</span>;
04673         <span class="keywordflow">case</span> SB_PAGEDOWN:
04674             NewOrigin.X+=<a class="code" href="../../d7/d2/output_8h.html#a17">CONSOLE_WINDOW_SIZE_X</a>(ScreenInfo)-1;
04675             <span class="keywordflow">break</span>;
04676         <span class="keywordflow">case</span> SB_THUMBTRACK:
04677         <span class="keywordflow">case</span> SB_THUMBPOSITION:
04678             NewOrigin.X= AbsoluteChange;
04679             <span class="keywordflow">break</span>;
04680         <span class="keywordflow">case</span> SB_TOP:
04681             NewOrigin.X=0;
04682             <span class="keywordflow">break</span>;
04683         <span class="keywordflow">case</span> SB_BOTTOM:
04684             NewOrigin.X=(WORD)(ScreenInfo-&gt;ScreenBufferSize.X-<a class="code" href="../../d7/d2/output_8h.html#a17">CONSOLE_WINDOW_SIZE_X</a>(ScreenInfo));
04685             <span class="keywordflow">break</span>;
04686 
04687         <span class="keywordflow">default</span>:
04688             <span class="keywordflow">return</span>;
04689     }
04690 
04691     NewOrigin.X = (WORD)(<a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(0,<a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)NewOrigin.X,
04692                             (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)ScreenInfo-&gt;ScreenBufferSize.X-(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)<a class="code" href="../../d7/d2/output_8h.html#a17">CONSOLE_WINDOW_SIZE_X</a>(ScreenInfo))));
04693     <a class="code" href="../../d6/d2/output_8c.html#a66">SetWindowOrigin</a>(ScreenInfo,
04694                     (BOOLEAN)<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
04695                     NewOrigin
04696                    );
04697 }
04698 
04699 LRESULT <a class="code" href="../../d1/d1/bench_8c.html#a0">APIENTRY</a>
<a name="l04700"></a><a class="code" href="../../d6/d2/output_8c.html#a83">04700</a> <a class="code" href="../../d6/d2/output_8c.html#a83">ConsoleWindowProc</a>(
04701     HWND hWnd,
04702     UINT Message,
04703     WPARAM wParam,
04704     LPARAM lParam
04705     )
04706 {
04707     HDC hDC;
04708     PAINTSTRUCT ps;
04709     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
04710     <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo;
04711     SMALL_RECT <a class="code" href="../../d7/d1/client_2draw_8c.html#a0">PaintRect</a>;
04712     LRESULT <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04713 
04714     Console = <a class="code" href="../../d8/d5/consrv_8h.html#a21">GetWindowConsole</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>);
04715     <span class="keywordflow">if</span> (Console != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04716 
04717         <span class="comment">//</span>
04718         <span class="comment">// Set up our thread so we can impersonate the client</span>
04719         <span class="comment">// while processing the message.</span>
04720         <span class="comment">//</span>
04721 
04722         CSR_SERVER_QUERYCLIENTTHREAD()-&gt;ThreadHandle =
04723                 Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o18">ClientThreadHandle</a>;
04724 
04725         <span class="comment">//</span>
04726         <span class="comment">// If the console is terminating, don't bother processing messages</span>
04727         <span class="comment">// other than CM_DESTROY_WINDOW.</span>
04728         <span class="comment">//</span>
04729         <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a12">CONSOLE_TERMINATING</a>) {
04730             <a class="code" href="../../d8/d5/consrv_8h.html#a42">LockConsole</a>(Console);
04731             <a class="code" href="../../d6/d2/output_8c.html#a80">DestroyWindowsWindow</a>(Console);
04732             <span class="keywordflow">return</span> 0;
04733         }
04734 
04735         <span class="comment">//</span>
04736         <span class="comment">// Make sure the console pointer is still valid</span>
04737         <span class="comment">//</span>
04738         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a15">ValidateConsole</a>(Console)));
04739 
04740         <a class="code" href="../../d8/d5/consrv_8h.html#a42">LockConsole</a>(Console);
04741 
04742         ScreenInfo = Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o4">CurrentScreenBuffer</a>;
04743     }
04744     <span class="keywordflow">try</span> {
04745         <span class="keywordflow">if</span> (Console == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || ScreenInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04746             <span class="keywordflow">switch</span> (Message) {
04747             <span class="keywordflow">case</span> WM_GETMINMAXINFO:
04748                 {
04749                 <span class="comment">//</span>
04750                 <span class="comment">// createwindow issues a WM_GETMINMAXINFO</span>
04751                 <span class="comment">// message before we have the windowlong set up</span>
04752                 <span class="comment">// with the console pointer.  we need to allow</span>
04753                 <span class="comment">// the created window to be bigger than the</span>
04754                 <span class="comment">// default size by the scroll size.</span>
04755                 <span class="comment">//</span>
04756 
04757                 LPMINMAXINFO lpmmi = (LPMINMAXINFO)lParam;
04758                 lpmmi-&gt;ptMaxTrackSize.y += <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a18">HorizontalScrollSize</a>;
04759                 lpmmi-&gt;ptMaxTrackSize.x += <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a17">VerticalScrollSize</a>;
04760                 }
04761                 <span class="keywordflow">break</span>;
04762 
04763             <span class="keywordflow">default</span>:
04764                 <span class="keywordflow">goto</span> CallDefWin;
04765             }
04766         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Message == <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a23">ProgmanHandleMessage</a> &amp;&amp; lParam==0) {
04767             <span class="comment">// NOTE: lParam will be 0 if progman is sending it and</span>
04768             <span class="comment">// 1 if console is sending it.</span>
04769             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = 0;
04770             <span class="comment">// this is a workaround for a progman bug.  progman</span>
04771             <span class="comment">// sends a progmanhandlemessage twice for each window</span>
04772             <span class="comment">// in the system each time one is requested (for one window).</span>
04773             <span class="keywordflow">if</span> ((HWND)wParam != <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a> &amp;&amp; Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o64">bIconInit</a>) {
04774                 ATOM App,Topic;
04775                 <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> szItem[<a class="code" href="../../d6/d2/output_8c.html#a3">ITEM_MAX_SIZE</a>+1];
04776                 PCHAR lpItem;
04777                 ATOM aItem;
04778                 HANDLE ConsoleHandle;
04779 
04780                 <span class="keywordflow">if</span> (!(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a12">CONSOLE_TERMINATING</a>)) {
04781                     ConsoleHandle = Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o65">ConsoleHandle</a>;
04782                     Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o63">hWndProgMan</a> = (HWND)wParam;
04783                     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
04784                     App = GlobalAddAtomA(<span class="stringliteral">"Shell"</span>);
04785                     Topic = GlobalAddAtomA(<span class="stringliteral">"AppIcon"</span>);
04786                     <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o63">hWndProgMan</a>,
04787                                 WM_DDE_INITIATE,
04788                                 (WPARAM)<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>,
04789                                 MAKELONG(App,Topic)
04790                                );
04791 
04792                     <span class="comment">// if console is still valid, continue getting icon.</span>
04793                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a34">RevalidateConsole</a>(ConsoleHandle, &amp;Console);
04794                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
04795                         Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o64">bIconInit</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04796                         lpItem = _itoa((<span class="keywordtype">int</span>)Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o32">iIconId</a>,szItem,10);
04797                         aItem = GlobalAddAtomA(lpItem);
04798                         <a class="code" href="../../d0/d8/ntcftxt_8h.html#a20">PostMessage</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o63">hWndProgMan</a>,
04799                           WM_DDE_REQUEST,
04800                           (WPARAM)<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>,
04801                           MAKELONG(CF_TEXT,aItem)
04802                          );
04803                     }
04804                 }
04805             }
04806         } <span class="keywordflow">else</span> {
04807             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = 0;
04808             <span class="keywordflow">switch</span> (Message) {
04809             <span class="keywordflow">case</span> WM_DROPFILES:
04810                 <a class="code" href="../../d6/d2/output_8c.html#a85">DoDrop</a> (wParam,Console);
04811                 <span class="keywordflow">break</span>;
04812             <span class="keywordflow">case</span> WM_MOVE:
04813                 <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d9/client_2wow_8c.html#a19">IsIconic</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>)) {
04814                     <a class="code" href="../../d6/d2/output_8c.html#a43">PositionConsoleWindow</a>(Console, (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o14">WindowRect</a>.left == CW_USEDEFAULT));
04815 <span class="preprocessor">#if defined(FE_IME)</span>
04816 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (CONSOLE_IS_DBCS_OUTPUTCP(Console))
04817                     {
04818                         ConsoleImeResizeModeSystemView(Console,ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>);
04819                         ConsoleImeResizeCompStrView(Console,ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>);
04820                     }
04821 <span class="preprocessor">#endif // FE_IME</span>
04822 <span class="preprocessor"></span>                }
04823                 <span class="keywordflow">break</span>;
04824             <span class="keywordflow">case</span> WM_SIZE:
04825 
04826                 <span class="keywordflow">if</span> (wParam != SIZE_MINIMIZED) {
04827 
04828                     <span class="comment">//</span>
04829                     <span class="comment">// both SetWindowPos and SetScrollRange cause WM_SIZE</span>
04830                     <span class="comment">// messages to be issued.  ignore them if we have already</span>
04831                     <span class="comment">// figured out what size the window should be.</span>
04832                     <span class="comment">//</span>
04833 
04834                     <span class="keywordflow">if</span> (!ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o7">ResizingWindow</a>) {
04835 <span class="preprocessor">#ifdef THERESES_DEBUG</span>
04836 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"WM_SIZE message "</span>);
04837 <span class="keywordflow">if</span> (wParam == SIZEFULLSCREEN)
04838    <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"SIZEFULLSCREEN\n"</span>);
04839 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (wParam == SIZENORMAL)
04840    <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"SIZENORMAL\n"</span>);
04841 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"  WindowSize is %d %d\n"</span>,<a class="code" href="../../d7/d2/output_8h.html#a17">CONSOLE_WINDOW_SIZE_X</a>(ScreenInfo),<a class="code" href="../../d7/d2/output_8h.html#a18">CONSOLE_WINDOW_SIZE_Y</a>(ScreenInfo));
04842 <span class="preprocessor">#endif</span>
04843 <span class="preprocessor"></span>                        ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o12">WindowMaximized</a> = (wParam == SIZE_MAXIMIZED);
04844 
04845                         <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o15">ResizeFlags</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a44">SCREEN_BUFFER_CHANGE</a>) {
04846                             <a class="code" href="../../d6/d2/output_8c.html#a69">UpdateWindowSize</a>(Console,ScreenInfo);
04847                         }
04848                         <a class="code" href="../../d6/d2/output_8c.html#a43">PositionConsoleWindow</a>(Console, (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o14">WindowRect</a>.left == CW_USEDEFAULT));
04849 <span class="preprocessor">#if defined(FE_IME)</span>
04850 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> (CONSOLE_IS_DBCS_OUTPUTCP(Console))
04851                         {
04852                             ConsoleImeResizeModeSystemView(Console,ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>);
04853                             ConsoleImeResizeCompStrView(Console,ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>);
04854                         }
04855 <span class="preprocessor">#endif // FE_IME</span>
04856 <span class="preprocessor"></span><span class="preprocessor">#ifdef THERESES_DEBUG</span>
04857 <span class="preprocessor"></span><a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"  WindowRect is now %d %d %d %d\n"</span>,Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o14">WindowRect</a>.left,
04858                                          Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o14">WindowRect</a>.top,
04859                                          Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o14">WindowRect</a>.right,
04860                                          Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o14">WindowRect</a>.bottom);
04861 <span class="preprocessor">#endif</span>
04862 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o15">ResizeFlags</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a42">SCROLL_BAR_CHANGE</a>) {
04863                             <a class="code" href="../../d6/d2/output_8c.html#a37">InternalUpdateScrollBars</a>(ScreenInfo);
04864                             Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o15">ResizeFlags</a> &amp;= ~<a class="code" href="../../d1/d7/server_8h.html#a42">SCROLL_BAR_CHANGE</a>;
04865                         }
04866                     }
04867                 } <span class="keywordflow">else</span> {
04868 
04869                     <span class="comment">//</span>
04870                     <span class="comment">// Console is going iconic. Trim working set of all</span>
04871                     <span class="comment">// processes in the console</span>
04872                     <span class="comment">//</span>
04873 
04874                     <a class="code" href="../../d6/d2/output_8c.html#a75">TrimConsoleWorkingSet</a>(Console);
04875 
04876                 }
04877 
04878                 <span class="keywordflow">break</span>;
04879             <span class="keywordflow">case</span> WM_DDE_ACK:
04880                 <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o64">bIconInit</a>) {
04881                     Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o63">hWndProgMan</a> = (HWND)wParam;
04882                 }
04883                 <span class="keywordflow">break</span>;
04884             <span class="keywordflow">case</span> WM_DDE_DATA:
04885                 {
04886                 DDEDATA *lpDDEData;
04887                 <a class="code" href="../../d6/d2/output_8c.html#a10">LPPMICONDATA</a> lpIconData;
04888                 HICON hIcon;
04889                 HANDLE hDdeData;
04890                 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bRelease;
04891                 WPARAM atomTemp;
04892 
04893                 <a class="code" href="../../d4/d4/client_2ddetrack_8c.html#a8">UnpackDDElParam</a>(WM_DDE_DATA, lParam, (WPARAM *)&amp;hDdeData, &amp;atomTemp);
04894 
04895                 <span class="keywordflow">if</span> (hDdeData == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04896                     <span class="keywordflow">break</span>;
04897                 }
04898                 lpDDEData = (DDEDATA *)GlobalLock(hDdeData);
04899                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(lpDDEData-&gt;cfFormat == CF_TEXT);
04900                 lpIconData = (<a class="code" href="../../d6/d2/output_8c.html#a10">LPPMICONDATA</a>)lpDDEData-&gt;Value;
04901                 hIcon = <a class="code" href="../../d4/d9/clres_8c.html#a70">CreateIconFromResourceEx</a>(&amp;lpIconData-&gt;<a class="code" href="../../d3/d6/struct__PMIconData.html#o2">iResource</a>,
04902                         0, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, 0x30000, 0, 0, LR_DEFAULTSIZE);
04903                 <span class="keywordflow">if</span> (hIcon) {
04904                     <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o30">hIcon</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o30">hIcon</a> != <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a5">ghDefaultIcon</a>) {
04905                         <a class="code" href="../../d3/d0/user32_8def.html#a64">DestroyIcon</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o30">hIcon</a>);
04906                     }
04907                     Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o30">hIcon</a> = hIcon;
04908                     <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, WM_SETICON, ICON_BIG, (LPARAM)hIcon);
04909 
04910                     <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o31">hSmIcon</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04911                         <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o31">hSmIcon</a> != <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a6">ghDefaultSmIcon</a>) {
04912                             <a class="code" href="../../d3/d0/user32_8def.html#a64">DestroyIcon</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o31">hSmIcon</a>);
04913                         }
04914                         Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o31">hSmIcon</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04915                         <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, WM_SETICON, ICON_SMALL, (LPARAM)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04916                     }
04917                 }
04918 
04919                 <span class="keywordflow">if</span> (lpDDEData-&gt;fAckReq) {
04920 
04921                     <a class="code" href="../../d0/d8/ntcftxt_8h.html#a20">PostMessage</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o63">hWndProgMan</a>,
04922                                 WM_DDE_ACK,
04923                                 (WPARAM)<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>,
04924                                 <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a89">ReuseDDElParam</a>(lParam, WM_DDE_DATA, WM_DDE_ACK, 0x8000, atomTemp));
04925                 }
04926 
04927                 bRelease = lpDDEData-&gt;fRelease;
04928                 GlobalUnlock(hDdeData);
04929                 <span class="keywordflow">if</span> (bRelease){
04930                     GlobalFree(hDdeData);
04931                 }
04932                 <a class="code" href="../../d0/d8/ntcftxt_8h.html#a20">PostMessage</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o63">hWndProgMan</a>,
04933                             WM_DDE_TERMINATE,
04934                             (WPARAM)<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>,
04935                             0
04936                            );
04937                 <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a0">CONSOLE_IS_ICONIC</a>) {
04938                     <span class="comment">// force repaint of icon</span>
04939                     InvalidateRect(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
04940                 }
04941                 }
04942                 <span class="keywordflow">break</span>;
04943             <span class="keywordflow">case</span> WM_ACTIVATE:
04944 
04945                 <span class="comment">//</span>
04946                 <span class="comment">// if we're activated by a mouse click, remember it so</span>
04947                 <span class="comment">// we don't pass the click on to the app.</span>
04948                 <span class="comment">//</span>
04949 
04950                 <span class="keywordflow">if</span> (LOWORD(wParam) == WA_CLICKACTIVE) {
04951                     Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> |= <a class="code" href="../../d1/d7/server_8h.html#a3">CONSOLE_IGNORE_NEXT_MOUSE_INPUT</a>;
04952                 }
04953                 <span class="keywordflow">goto</span> CallDefWin;
04954                 <span class="keywordflow">break</span>;
04955             <span class="keywordflow">case</span> WM_DDE_TERMINATE:
04956                 <span class="keywordflow">break</span>;
04957                 <span class="comment">// FE_IME</span>
04958             <span class="keywordflow">case</span> <a class="code" href="../../d3/d5/conime_8h.html#a27">CM_CONIME_KL_ACTIVATE</a>:
04959                 <a class="code" href="../../d3/d0/user32_8def.html#a45">ActivateKeyboardLayout</a>((HKL)wParam, KLF_SETFORPROCESS);
04960                 <span class="keywordflow">break</span>;
04961             <span class="keywordflow">case</span> WM_INPUTLANGCHANGEREQUEST:
04962                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/consrv_8h.html#a33">CONSOLE_IS_IME_ENABLED</a>()) {
04963                     ULONG ConimeMessage;
04964                     LRESULT lResult;
04965 
04966                     <span class="keywordflow">if</span> (wParam &amp; INPUTLANGCHANGE_BACKWARD) {
04967                         ConimeMessage = <a class="code" href="../../d3/d5/conime_8h.html#a22">CONIME_INPUTLANGCHANGEREQUESTBACKWARD</a>;
04968                     }
04969                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (wParam &amp; INPUTLANGCHANGE_FORWARD) {
04970                         ConimeMessage = <a class="code" href="../../d3/d5/conime_8h.html#a21">CONIME_INPUTLANGCHANGEREQUESTFORWARD</a>;
04971                     }
04972                     <span class="keywordflow">else</span> {
04973                         ConimeMessage = <a class="code" href="../../d3/d5/conime_8h.html#a20">CONIME_INPUTLANGCHANGEREQUEST</a>;
04974                     }
04975 
04976                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ConsoleImeMessagePumpWorker(Console,
04977                                               ConimeMessage,
04978                                               (WPARAM)Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o65">ConsoleHandle</a>,
04979                                               (LPARAM)lParam,
04980                                               &amp;lResult)) ||
04981                             !lResult) {
04982 
04983                         <span class="keywordflow">break</span>;
04984                     }
04985                 }
04986 <span class="preprocessor">#ifdef LATER</span>
04987 <span class="preprocessor"></span>                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d4/d5/conimep_8h.html#a49">IS_IME_KBDLAYOUT</a>(lParam)) {
04988                     <span class="comment">// IME keyboard layout should be avoided</span>
04989                     <span class="comment">// if the console is not IME enabled.</span>
04990                     <span class="keywordflow">break</span>;
04991                 }
04992                 <span class="comment">// Call the default window proc and let it handle</span>
04993                 <span class="comment">// the keyboard layout activation.</span>
04994 <span class="preprocessor">#endif</span>
04995 <span class="preprocessor"></span>                <span class="keywordflow">goto</span> CallDefWin;
04996 
04997                 <span class="keywordflow">break</span>;
04998                 <span class="comment">// end FE_IME</span>
04999 
05000             <span class="keywordflow">case</span> WM_INPUTLANGCHANGE:
05001                 Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o9">hklActive</a> = (HKL)lParam;
05002                 <span class="comment">// FE_IME</span>
05003                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/consrv_8h.html#a33">CONSOLE_IS_IME_ENABLED</a>()) {
05004                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ConsoleImeMessagePump(Console,
05005                                           <a class="code" href="../../d3/d5/conime_8h.html#a18">CONIME_INPUTLANGCHANGE</a>,
05006                                           (WPARAM)Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o65">ConsoleHandle</a>,
05007                                           (LPARAM)Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o9">hklActive</a>
05008                                          ))) {
05009                         <span class="keywordflow">break</span>;
05010                     }
05011                     <span class="keywordflow">else</span>{
05012                         GetImeKeyState(Console, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ;
05013                     }
05014                 }
05015                 <span class="comment">// end FE_IME</span>
05016                 <span class="keywordflow">goto</span> CallDefWin;
05017 
05018                 <span class="keywordflow">break</span>;
05019 
05020             <span class="keywordflow">case</span> WM_SETFOCUS:
05021                 <a class="code" href="../../d6/d2/output_8c.html#a74">ModifyConsoleProcessFocus</a>(Console, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
05022                 <a class="code" href="../../d8/d5/consrv_8h.html#a313">SetConsoleReserveKeys</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o34">ReserveKeys</a>);
05023                 Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> |= <a class="code" href="../../d1/d7/server_8h.html#a2">CONSOLE_HAS_FOCUS</a>;
05024 
05025                 <a class="code" href="../../d3/d0/user32_8def.html#a56">SetTimer</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, <a class="code" href="../../d7/d2/output_8h.html#a9">CURSOR_TIMER</a>, <a class="code" href="../../d6/d2/output_8c.html#a28">guCaretBlinkTime</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
05026                 <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a48">HandleFocusEvent</a>(Console,<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
05027                 <span class="keywordflow">if</span> (!Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o9">hklActive</a>) {
05028                     <a class="code" href="../../d5/d9/cltxt_8h.html#a26">SystemParametersInfo</a>(SPI_GETDEFAULTINPUTLANG, 0, &amp;Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o9">hklActive</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
05029                     <a class="code" href="../../d6/d2/output_8c.html#a31">GetNonBiDiKeyboardLayout</a>(&amp;Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o9">hklActive</a>);
05030                 }
05031                 <a class="code" href="../../d3/d0/user32_8def.html#a45">ActivateKeyboardLayout</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o9">hklActive</a>, 0);
05032                 <span class="comment">// FE_IME</span>
05033                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/consrv_8h.html#a33">CONSOLE_IS_IME_ENABLED</a>()) {
05034                     <span class="comment">// v-HirShi Sep.15.1995 Support Console IME</span>
05035                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ConsoleImeMessagePump(Console,
05036                                           <a class="code" href="../../d3/d5/conime_8h.html#a11">CONIME_SETFOCUS</a>,
05037                                           (WPARAM)Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o65">ConsoleHandle</a>,
05038                                           (LPARAM)Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o9">hklActive</a>
05039                                          ))) {
05040                         <span class="keywordflow">break</span>;
05041                     }
05042 
05043                     <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o3">InputBuffer</a>.hWndConsoleIME)
05044                     {
05045                         <span class="comment">/*</span>
05046 <span class="comment">                         * open property window by ImmConfigureIME</span>
05047 <span class="comment">                         * never set focus on console window</span>
05048 <span class="comment">                         * so, set focus to property window</span>
05049 <span class="comment">                         */</span>
05050                         HWND hwnd = <a class="code" href="../../d3/d8/winmgrc_8c.html#a16">GetLastActivePopup</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o3">InputBuffer</a>.hWndConsoleIME);
05051                         <span class="keywordflow">if</span> (hwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
05052                             <a class="code" href="../../d3/d8/client_8c.html#a131">SetForegroundWindow</a>(hwnd);
05053                     }
05054                 }
05055                 <span class="comment">// FE_IME</span>
05056                 <span class="keywordflow">break</span>;
05057             <span class="keywordflow">case</span> WM_KILLFOCUS:
05058                 <a class="code" href="../../d6/d2/output_8c.html#a74">ModifyConsoleProcessFocus</a>(Console, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
05059                 <a class="code" href="../../d8/d5/consrv_8h.html#a313">SetConsoleReserveKeys</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, CONSOLE_NOSHORTCUTKEY);
05060                 Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp;= ~<a class="code" href="../../d1/d7/server_8h.html#a2">CONSOLE_HAS_FOCUS</a>;
05061 
05062                 <span class="keywordflow">if</span> (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o1">Flags</a> &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>) {
05063                     <a class="code" href="../../d6/d1/ntcon_2server_2cursor_8c.html#a3">ConsoleHideCursor</a>(ScreenInfo);
05064                     ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.UpdatingScreen -= 1; <span class="comment">// counteract HideCursor</span>
05065                 }
05066                 KillTimer(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, <a class="code" href="../../d7/d2/output_8h.html#a9">CURSOR_TIMER</a>);
05067                 <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a48">HandleFocusEvent</a>(Console,<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
05068 
05069                 <span class="comment">// FE_IME</span>
05070                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/consrv_8h.html#a33">CONSOLE_IS_IME_ENABLED</a>()) {
05071                     <span class="comment">// v-HirShi Sep.16.1995 Support Console IME</span>
05072                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ConsoleImeMessagePump(Console,
05073                                           <a class="code" href="../../d3/d5/conime_8h.html#a12">CONIME_KILLFOCUS</a>,
05074                                           (WPARAM)Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o65">ConsoleHandle</a>,
05075                                           (LPARAM)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
05076                                          ))) {
05077                         <span class="keywordflow">break</span>;
05078                     }
05079                 }
05080                 <span class="comment">// end FE_IME</span>
05081                 <span class="keywordflow">break</span>;
05082             <span class="keywordflow">case</span> WM_PAINT:
05083 
05084                 <span class="comment">// ICONIC bit is not set if we're fullscreen and don't</span>
05085                 <span class="comment">// have the hardware</span>
05086 
05087                 <a class="code" href="../../d6/d1/ntcon_2server_2cursor_8c.html#a3">ConsoleHideCursor</a>(ScreenInfo);
05088                 hDC = <a class="code" href="../../d3/d0/user32_8def.html#a41">BeginPaint</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, &amp;ps);
05089                 <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a0">CONSOLE_IS_ICONIC</a> ||
05090                     Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o47">FullScreenFlags</a> == CONSOLE_FULLSCREEN) {
05091                     RECT rc;
05092                     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> cxIcon, cyIcon;
05093                     <a class="code" href="../../d3/d9/client_2wow_8c.html#a24">GetClientRect</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, &amp;rc);
05094                     cxIcon = <a class="code" href="../../d3/d9/client_2wow_8c.html#a16">GetSystemMetrics</a>(SM_CXICON);
05095                     cyIcon = <a class="code" href="../../d3/d9/client_2wow_8c.html#a16">GetSystemMetrics</a>(SM_CYICON);
05096 
05097                     rc.left = (rc.right - cxIcon) &gt;&gt; 1;
05098                     rc.top = (rc.bottom - cyIcon) &gt;&gt; 1;
05099 
05100                     <a class="code" href="../../d3/d8/client_8c.html#a49">DrawIcon</a>(hDC, rc.left, rc.top, Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o30">hIcon</a>);
05101                 } <span class="keywordflow">else</span> {
05102                     <span class="keywordflow">if</span> (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o1">Flags</a> &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>) {
05103                         <a class="code" href="../../d7/d1/client_2draw_8c.html#a0">PaintRect</a>.Left = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)((ps.rcPaint.left/<a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(ScreenInfo).X)+ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Left);
05104                         <a class="code" href="../../d7/d1/client_2draw_8c.html#a0">PaintRect</a>.Right = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)((ps.rcPaint.right/<a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(ScreenInfo).X)+ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Left);
05105                         <a class="code" href="../../d7/d1/client_2draw_8c.html#a0">PaintRect</a>.Top = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)((ps.rcPaint.top/<a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(ScreenInfo).Y)+ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Top);
05106                         <a class="code" href="../../d7/d1/client_2draw_8c.html#a0">PaintRect</a>.Bottom = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)((ps.rcPaint.bottom/<a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(ScreenInfo).Y)+ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Top);
05107                     } <span class="keywordflow">else</span> {
05108                         <a class="code" href="../../d7/d1/client_2draw_8c.html#a0">PaintRect</a>.Left = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ps.rcPaint.left+ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Left);
05109                         <a class="code" href="../../d7/d1/client_2draw_8c.html#a0">PaintRect</a>.Right = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ps.rcPaint.right+ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Left);
05110                         <a class="code" href="../../d7/d1/client_2draw_8c.html#a0">PaintRect</a>.Top = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ps.rcPaint.top+ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Top);
05111                         <a class="code" href="../../d7/d1/client_2draw_8c.html#a0">PaintRect</a>.Bottom = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ps.rcPaint.bottom+ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Top);
05112                     }
05113                     ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.Flags &amp;= ~<a class="code" href="../../d7/d2/output_8h.html#a3">TEXT_VALID_HINT</a>;
05114                     <a class="code" href="../../d6/d8/dispatch_8h.html#a4">WriteToScreen</a>(ScreenInfo,&amp;<a class="code" href="../../d7/d1/client_2draw_8c.html#a0">PaintRect</a>);
05115                 }
05116                 EndPaint(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>,&amp;ps);
05117                 <a class="code" href="../../d6/d1/ntcon_2server_2cursor_8c.html#a2">ConsoleShowCursor</a>(ScreenInfo);
05118                 <span class="keywordflow">break</span>;
05119             <span class="keywordflow">case</span> WM_CLOSE:
05120                 <span class="keywordflow">if</span> (!(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a8">CONSOLE_NO_WINDOW</a>) ||
05121                     !(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a18">CONSOLE_WOW_REGISTERED</a>)) {
05122                     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a50">HandleCtrlEvent</a>(Console,CTRL_CLOSE_EVENT);
05123                 }
05124                 <span class="keywordflow">break</span>;
05125             <span class="keywordflow">case</span> WM_ERASEBKGND:
05126 
05127                 <span class="comment">// ICONIC bit is not set if we're fullscreen and don't</span>
05128                 <span class="comment">// have the hardware</span>
05129 
05130                 <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a0">CONSOLE_IS_ICONIC</a> ||
05131                     Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o47">FullScreenFlags</a> == CONSOLE_FULLSCREEN) {
05132                     Message = WM_ICONERASEBKGND;
05133                     <span class="keywordflow">goto</span> CallDefWin;
05134                 }
05135                 <span class="keywordflow">break</span>;
05136             <span class="keywordflow">case</span> WM_SETTINGCHANGE:
05137                 <span class="comment">/*</span>
05138 <span class="comment">                 * See if the caret blink time was changed. If so, reset the</span>
05139 <span class="comment">                 * timer.</span>
05140 <span class="comment">                 */</span>
05141                 <span class="keywordflow">if</span> (wParam == SPI_SETKEYBOARDDELAY) {
05142                     <a class="code" href="../../d6/d2/output_8c.html#a28">guCaretBlinkTime</a> = GetCaretBlinkTime();
05143                     <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a2">CONSOLE_HAS_FOCUS</a>) {
05144                         KillTimer(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, <a class="code" href="../../d7/d2/output_8h.html#a9">CURSOR_TIMER</a>);
05145                         <a class="code" href="../../d3/d0/user32_8def.html#a56">SetTimer</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, <a class="code" href="../../d7/d2/output_8h.html#a9">CURSOR_TIMER</a>, <a class="code" href="../../d6/d2/output_8c.html#a28">guCaretBlinkTime</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
05146                     }
05147                 } <span class="keywordflow">else</span> {
05148                     <a class="code" href="../../d6/d2/output_8c.html#a23">gfInitSystemMetrics</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05149                 }
05150                 <span class="keywordflow">break</span>;
05151             <span class="keywordflow">case</span> WM_DISPLAYCHANGE:
05152                 <a class="code" href="../../d6/d2/output_8c.html#a23">gfInitSystemMetrics</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05153                 <span class="keywordflow">break</span>;
05154             <span class="keywordflow">case</span> WM_SETCURSOR:
05155                 <span class="keywordflow">if</span> (lParam == -1) {
05156 
05157                     <span class="comment">//</span>
05158                     <span class="comment">// the app changed the cursor visibility or shape.</span>
05159                     <span class="comment">// see if the cursor is in the client area.</span>
05160                     <span class="comment">//</span>
05161 
05162                     POINT <a class="code" href="../../d7/d5/structPoint.html">Point</a>;
05163                     HWND hWndTmp;
05164                     <a class="code" href="../../d3/d9/client_2wow_8c.html#a25">GetCursorPos</a>(&amp;<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a30">Point</a>);
05165                     hWndTmp = <a class="code" href="../../d3/d0/user32_8def.html#a68">WindowFromPoint</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a30">Point</a>);
05166                     <span class="keywordflow">if</span> (hWndTmp == <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>) {
05167                         lParam = <a class="code" href="../../d5/d9/cltxt_8h.html#a15">DefWindowProc</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>,WM_NCHITTEST,0,MAKELONG((WORD)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a30">Point</a>.x, (WORD)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a30">Point</a>.y));
05168                     }
05169                 }
05170                 <span class="keywordflow">if</span> ((WORD)lParam == HTCLIENT) {
05171                     <span class="keywordflow">if</span> (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o18">CursorDisplayCount</a> &lt; 0) {
05172                         <a class="code" href="../../d3/d0/user32_8def.html#a65">SetCursor</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
05173                     } <span class="keywordflow">else</span> {
05174                         <a class="code" href="../../d3/d0/user32_8def.html#a65">SetCursor</a>(ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o15">CursorHandle</a>);
05175                     }
05176                 } <span class="keywordflow">else</span> {
05177                     <span class="keywordflow">goto</span> CallDefWin;
05178                 }
05179                 <span class="keywordflow">break</span>;
05180             <span class="keywordflow">case</span> WM_GETMINMAXINFO:
05181                 {
05182                 LPMINMAXINFO lpmmi = (LPMINMAXINFO)lParam;
05183                 COORD FontSize;
05184                 <a class="code" href="../../d0/d9/struct__WINDOW__LIMITS.html">WINDOW_LIMITS</a> WindowLimits;
05185 
05186                 <a class="code" href="../../d6/d2/output_8c.html#a39">GetWindowLimits</a>(ScreenInfo, &amp;WindowLimits);
05187                 <span class="keywordflow">if</span> (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o1">Flags</a> &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>) {
05188                     FontSize = <a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(ScreenInfo);
05189                 } <span class="keywordflow">else</span> {
05190                     FontSize.X = 1;
05191                     FontSize.Y = 1;
05192                 }
05193                 lpmmi-&gt;ptMaxSize.x = lpmmi-&gt;ptMaxTrackSize.x = WindowLimits.<a class="code" href="../../d0/d9/struct__WINDOW__LIMITS.html#o2">MaxWindow</a>.X;
05194                 <span class="keywordflow">if</span> (!ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o11">WindowMaximizedY</a>) {
05195                     lpmmi-&gt;ptMaxTrackSize.x += <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a17">VerticalScrollSize</a>;
05196                     lpmmi-&gt;ptMaxSize.x += <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a17">VerticalScrollSize</a>;
05197                 }
05198                 <span class="keywordflow">while</span> (lpmmi-&gt;ptMaxSize.x &gt; WindowLimits.<a class="code" href="../../d0/d9/struct__WINDOW__LIMITS.html#o3">FullScreenSize</a>.X + <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a19">VerticalClientToWindow</a>) {
05199                     lpmmi-&gt;ptMaxSize.x -= FontSize.X;
05200                 }
05201                 lpmmi-&gt;ptMaxSize.y = lpmmi-&gt;ptMaxTrackSize.y = WindowLimits.<a class="code" href="../../d0/d9/struct__WINDOW__LIMITS.html#o2">MaxWindow</a>.Y;
05202                 <span class="keywordflow">if</span> (!ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o10">WindowMaximizedX</a>) {
05203                     lpmmi-&gt;ptMaxTrackSize.y += <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a18">HorizontalScrollSize</a>;
05204                     lpmmi-&gt;ptMaxSize.y += <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a18">HorizontalScrollSize</a>;
05205                 }
05206                 <span class="keywordflow">while</span> (lpmmi-&gt;ptMaxSize.y &gt; WindowLimits.<a class="code" href="../../d0/d9/struct__WINDOW__LIMITS.html#o3">FullScreenSize</a>.Y + <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a20">HorizontalClientToWindow</a>) {
05207                     lpmmi-&gt;ptMaxSize.y -= FontSize.Y;
05208                 }
05209                 lpmmi-&gt;ptMinTrackSize.x = WindowLimits.<a class="code" href="../../d0/d9/struct__WINDOW__LIMITS.html#o0">MinimumWindowSize</a>.X * FontSize.X + <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a19">VerticalClientToWindow</a>;
05210                 lpmmi-&gt;ptMinTrackSize.y = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a20">HorizontalClientToWindow</a>;
05211                 }
05212                 <span class="keywordflow">break</span>;
05213             <span class="keywordflow">case</span> WM_QUERYDRAGICON:
05214                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = (LRESULT)Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o30">hIcon</a>;
05215                 <span class="keywordflow">break</span>;
05216             <span class="keywordflow">case</span> WM_WINDOWPOSCHANGING:
05217                 <span class="comment">// ignore window pos changes if going fullscreen</span>
05218                 <span class="keywordflow">if</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> || (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o47">FullScreenFlags</a> == 0)) {
05219                     LPWINDOWPOS WindowPos = (LPWINDOWPOS)lParam;
05220                     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> fMinimized;
05221 
05222                     <span class="comment">/*</span>
05223 <span class="comment">                     * This message is sent before a SetWindowPos() operation</span>
05224 <span class="comment">                     * occurs. We use it here to set/clear the CONSOLE_IS_ICONIC</span>
05225 <span class="comment">                     * bit appropriately... doing so in the WM_SIZE handler</span>
05226 <span class="comment">                     * is incorrect because the WM_SIZE comes after the</span>
05227 <span class="comment">                     * WM_ERASEBKGND during SetWindowPos() processing, and the</span>
05228 <span class="comment">                     * WM_ERASEBKGND needs to know if the console window is</span>
05229 <span class="comment">                     * iconic or not.</span>
05230 <span class="comment">                     */</span>
05231                     fMinimized = <a class="code" href="../../d3/d9/client_2wow_8c.html#a19">IsIconic</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>);
05232 
05233                     <span class="keywordflow">if</span> (fMinimized) {
05234                         <span class="keywordflow">if</span> (!(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a0">CONSOLE_IS_ICONIC</a>)) {
05235                             Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> |= <a class="code" href="../../d1/d7/server_8h.html#a0">CONSOLE_IS_ICONIC</a>;
05236 
05237                             <span class="comment">//</span>
05238                             <span class="comment">// if the palette is something other than default,</span>
05239                             <span class="comment">// select the default palette in.  otherwise, the</span>
05240                             <span class="comment">// screen will repaint twice each time the icon</span>
05241                             <span class="comment">// is painted.</span>
05242                             <span class="comment">//</span>
05243 
05244                             <span class="keywordflow">if</span> (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o16">hPalette</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
05245                                 Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o47">FullScreenFlags</a> == 0) {
05246                                 <a class="code" href="../../d3/d0/user32_8def.html#a83">SelectPalette</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o10">hDC</a>,
05247                                               Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o13">hSysPalette</a>,
05248                                               <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
05249                                 <a class="code" href="../../d7/d4/server_2private_8c.html#a47">UnsetActivePalette</a>(ScreenInfo);
05250                             }
05251                         }
05252                     } <span class="keywordflow">else</span> {
05253                         <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a0">CONSOLE_IS_ICONIC</a>) {
05254                             Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp;= ~<a class="code" href="../../d1/d7/server_8h.html#a0">CONSOLE_IS_ICONIC</a>;
05255 
05256                             <span class="comment">//</span>
05257                             <span class="comment">// if the palette is something other than default,</span>
05258                             <span class="comment">// select the default palette in.  otherwise, the</span>
05259                             <span class="comment">// screen will repaint twice each time the icon</span>
05260                             <span class="comment">// is painted.</span>
05261                             <span class="comment">//</span>
05262 
05263                             <span class="keywordflow">if</span> (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o16">hPalette</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
05264                                 Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o47">FullScreenFlags</a> == 0) {
05265                                 <a class="code" href="../../d3/d0/user32_8def.html#a83">SelectPalette</a>(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o10">hDC</a>,
05266                                               ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o16">hPalette</a>,
05267                                               <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
05268                                 <a class="code" href="../../d7/d4/server_2private_8c.html#a46">SetActivePalette</a>(ScreenInfo);
05269                             }
05270                         }
05271                     }
05272                     <span class="keywordflow">if</span> (!ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o7">ResizingWindow</a> &amp;&amp;
05273                         (WindowPos-&gt;cx || WindowPos-&gt;cy) &amp;&amp;
05274                         !fMinimized) {
05275                         <a class="code" href="../../d4/d8/resize_8c.html#a1">ProcessResizeWindow</a>(ScreenInfo,Console,WindowPos);
05276                     }
05277                 }
05278                 <span class="keywordflow">break</span>;
05279             <span class="keywordflow">case</span> WM_CONTEXTMENU:
05280                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d9/cltxt_8h.html#a15">DefWindowProc</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, WM_NCHITTEST, 0, lParam) == HTCLIENT) {
05281                     TrackPopupMenuEx(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o12">hHeirMenu</a>,
05282                                      TPM_RIGHTBUTTON,
05283                                      <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a7">GET_X_LPARAM</a>(lParam),
05284                                      <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a8">GET_Y_LPARAM</a>(lParam),
05285                                      <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>,
05286                                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
05287                 } <span class="keywordflow">else</span> {
05288                     <span class="keywordflow">goto</span> CallDefWin;
05289                 }
05290                 <span class="keywordflow">break</span>;
05291             <span class="keywordflow">case</span> WM_NCLBUTTONDOWN:
05292                 <span class="comment">// allow user to move window even when bigger than the screen</span>
05293                 <span class="keywordflow">switch</span> (wParam &amp; 0x00FF) {
05294                     <span class="keywordflow">case</span> HTCAPTION:
05295                         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
05296                         Console = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05297                         SetActiveWindow(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>);
05298                         <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, WM_SYSCOMMAND,
05299                                        SC_MOVE | wParam, lParam);
05300                         <span class="keywordflow">break</span>;
05301                     <span class="keywordflow">default</span>:
05302                         <span class="keywordflow">goto</span> CallDefWin;
05303                 }
05304                 <span class="keywordflow">break</span>;
05305 <span class="preprocessor">#if defined (FE_IME)</span>
05306 <span class="preprocessor"></span><span class="comment">// Sep.16.1995 Support Console IME</span>
05307             <span class="keywordflow">case</span> WM_KEYDOWN    +<a class="code" href="../../d3/d5/conime_8h.html#a23">CONIME_KEYDATA</a>:
05308             <span class="keywordflow">case</span> WM_KEYUP      +<a class="code" href="../../d3/d5/conime_8h.html#a23">CONIME_KEYDATA</a>:
05309             <span class="keywordflow">case</span> WM_CHAR       +<a class="code" href="../../d3/d5/conime_8h.html#a23">CONIME_KEYDATA</a>:
05310             <span class="keywordflow">case</span> WM_DEADCHAR   +<a class="code" href="../../d3/d5/conime_8h.html#a23">CONIME_KEYDATA</a>:
05311 
05312             <span class="keywordflow">case</span> WM_SYSKEYDOWN +<a class="code" href="../../d3/d5/conime_8h.html#a23">CONIME_KEYDATA</a>:
05313             <span class="keywordflow">case</span> WM_SYSKEYUP   +<a class="code" href="../../d3/d5/conime_8h.html#a23">CONIME_KEYDATA</a>:
05314             <span class="keywordflow">case</span> WM_SYSCHAR    +<a class="code" href="../../d3/d5/conime_8h.html#a23">CONIME_KEYDATA</a>:
05315             <span class="keywordflow">case</span> WM_SYSDEADCHAR+<a class="code" href="../../d3/d5/conime_8h.html#a23">CONIME_KEYDATA</a>:
05316 <span class="preprocessor">#endif</span>
05317 <span class="preprocessor"></span>            <span class="keywordflow">case</span> WM_KEYDOWN:
05318             <span class="keywordflow">case</span> WM_KEYUP:
05319             <span class="keywordflow">case</span> WM_CHAR:
05320             <span class="keywordflow">case</span> WM_DEADCHAR:
05321                 <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a46">HandleKeyEvent</a>(Console,<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>,Message,wParam,lParam);
05322                 <span class="keywordflow">break</span>;
05323             <span class="keywordflow">case</span> WM_SYSKEYDOWN:
05324             <span class="keywordflow">case</span> WM_SYSKEYUP:
05325             <span class="keywordflow">case</span> WM_SYSCHAR:
05326             <span class="keywordflow">case</span> WM_SYSDEADCHAR:
05327                 <span class="keywordflow">if</span> (<a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a45">HandleSysKeyEvent</a>(Console,<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>,Message,wParam,lParam) &amp;&amp; Console != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05328                     <span class="keywordflow">goto</span> CallDefWin;
05329                 }
05330                 <span class="keywordflow">break</span>;
05331             <span class="keywordflow">case</span> WM_COMMAND:
05332                 <span class="comment">//</span>
05333                 <span class="comment">// If this is an edit command from the context menu, treat</span>
05334                 <span class="comment">// it like a sys command.</span>
05335                 <span class="comment">//</span>
05336                 <span class="keywordflow">if</span> ((wParam &lt; cmCopy) || (wParam &gt; <a class="code" href="../../d6/d7/menu_8h.html#a13">cmSelectAll</a>)) {
05337                     <span class="keywordflow">break</span>;
05338                 }
05339                 <span class="comment">// FALL THRU</span>
05340             <span class="keywordflow">case</span> WM_SYSCOMMAND:
05341                 <span class="keywordflow">if</span> (wParam &gt;= ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o13">CommandIdLow</a> &amp;&amp;
05342                     wParam &lt;= ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o14">CommandIdHigh</a>) {
05343                     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a49">HandleMenuEvent</a>(Console,(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)wParam);
05344                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (wParam == <a class="code" href="../../d6/d7/menu_8h.html#a10">cmMark</a>) {
05345                     <a class="code" href="../../d8/d5/consrv_8h.html#a301">DoMark</a>(Console);
05346                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (wParam == <a class="code" href="../../d6/d7/menu_8h.html#a8">cmCopy</a>) {
05347                     <a class="code" href="../../d8/d5/consrv_8h.html#a300">DoCopy</a>(Console);
05348                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (wParam == <a class="code" href="../../d6/d7/menu_8h.html#a9">cmPaste</a>) {
05349                     <a class="code" href="../../d8/d5/consrv_8h.html#a304">DoPaste</a>(Console);
05350                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (wParam == <a class="code" href="../../d6/d7/menu_8h.html#a11">cmScroll</a>) {
05351                     <a class="code" href="../../d8/d5/consrv_8h.html#a311">DoScroll</a>(Console);
05352                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (wParam == <a class="code" href="../../d6/d7/menu_8h.html#a12">cmFind</a>) {
05353                     <a class="code" href="../../d0/d4/find_8c.html#a3">DoFind</a>(Console);
05354                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (wParam == <a class="code" href="../../d6/d7/menu_8h.html#a13">cmSelectAll</a>) {
05355                     <a class="code" href="../../d8/d5/consrv_8h.html#a302">DoSelectAll</a>(Console);
05356                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (wParam == <a class="code" href="../../d6/d7/menu_8h.html#a15">cmControl</a>) {
05357                     <a class="code" href="../../d1/d7/ntcon_2server_2menu_8c.html#a4">PropertiesDlgShow</a>(Console, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
05358                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (wParam == <a class="code" href="../../d6/d7/menu_8h.html#a16">cmDefaults</a>) {
05359                     <a class="code" href="../../d1/d7/ntcon_2server_2menu_8c.html#a4">PropertiesDlgShow</a>(Console, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
05360                 } <span class="keywordflow">else</span> {
05361 
05362                     <span class="comment">// if we're restoring, remove any</span>
05363                     <span class="comment">// mouse events so app doesn't get them.</span>
05364 
05365                     <span class="keywordflow">if</span> (wParam == SC_RESTORE) {
05366                         MSG RestoreMsg;
05367                         <a class="code" href="../../d3/d0/user32_8def.html#a44">SetCapture</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>);
05368                         <span class="keywordflow">while</span> (<a class="code" href="../../d3/d8/winmgrc_8c.html#a12">GetCapture</a>() != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
05369                                (<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a16">GetKeyState</a>(VK_LBUTTON) &amp; <a class="code" href="../../d9/d3/input_8h.html#a17">KEY_PRESSED</a>)) {
05370                             <a class="code" href="../../d5/d9/cltxt_8h.html#a14">PeekMessage</a>(&amp;RestoreMsg,
05371                                         <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>,
05372                                         WM_MOUSEFIRST,
05373                                         WM_MOUSELAST,
05374                                         PM_REMOVE
05375                                        );
05376                         }
05377                         <a class="code" href="../../d3/d8/client_8c.html#a124">ReleaseCapture</a>();
05378                     }
05379 
05380                     <span class="keywordflow">goto</span> CallDefWin;
05381                 }
05382                 <span class="keywordflow">break</span>;
05383             <span class="keywordflow">case</span> WM_TIMER:
05384 <span class="preprocessor">#if defined(FE_IME)</span>
05385 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (wParam == SCROLL_WAIT_TIMER)
05386                 {
05387                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d8/d5/consrv_8h.html#a33">CONSOLE_IS_IME_ENABLED</a>());
05388                     <span class="keywordflow">if</span> ((ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o0">Console</a>-&gt;ConsoleIme.ScrollFlag &amp; (HIDE_FOR_SCROLL)) &amp;&amp;
05389                         (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o0">Console</a>-&gt;ConsoleIme.ScrollWaitCountDown &gt; 0)
05390                        ) {
05391                         <span class="keywordflow">if</span> ((ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o0">Console</a>-&gt;ConsoleIme.ScrollWaitCountDown -= <a class="code" href="../../d6/d2/output_8c.html#a28">guCaretBlinkTime</a>) &lt;= 0) {
05392                             ConsoleImeBottomLineInUse(ScreenInfo);
05393                         }
05394                     }
05395                     <span class="keywordflow">break</span>;
05396                 }
05397 <span class="preprocessor">#endif // FE_IME</span>
05398 <span class="preprocessor"></span>                <a class="code" href="../../d6/d1/ntcon_2server_2cursor_8c.html#a6">CursorTimerRoutine</a>(ScreenInfo);
05399                 <a class="code" href="../../d6/d2/output_8c.html#a33">ScrollIfNecessary</a>(Console,ScreenInfo);
05400                 <span class="keywordflow">break</span>;
05401             <span class="keywordflow">case</span> WM_HSCROLL:
05402                 <a class="code" href="../../d6/d2/output_8c.html#a82">HorizontalScroll</a>(ScreenInfo, LOWORD(wParam), HIWORD(wParam));
05403                 <span class="keywordflow">break</span>;
05404             <span class="keywordflow">case</span> WM_VSCROLL:
05405                 <a class="code" href="../../d6/d2/output_8c.html#a81">VerticalScroll</a>(Console, ScreenInfo,LOWORD(wParam),HIWORD(wParam));
05406                 <span class="keywordflow">break</span>;
05407             <span class="keywordflow">case</span> WM_INITMENU:
05408                 <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a49">HandleMenuEvent</a>(Console,WM_INITMENU);
05409                 <a class="code" href="../../d1/d7/ntcon_2server_2menu_8c.html#a2">InitializeMenu</a>(Console);
05410                 <span class="keywordflow">break</span>;
05411             <span class="keywordflow">case</span> WM_MENUSELECT:
05412                 <span class="keywordflow">if</span> (HIWORD(wParam) == 0xffff) {
05413                     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a49">HandleMenuEvent</a>(Console,WM_MENUSELECT);
05414                 }
05415                 <span class="keywordflow">break</span>;
05416             <span class="keywordflow">case</span> WM_MOUSEMOVE:
05417             <span class="keywordflow">case</span> WM_LBUTTONDOWN:
05418             <span class="keywordflow">case</span> WM_LBUTTONUP:
05419             <span class="keywordflow">case</span> WM_LBUTTONDBLCLK:
05420             <span class="keywordflow">case</span> WM_RBUTTONDOWN:
05421             <span class="keywordflow">case</span> WM_RBUTTONUP:
05422             <span class="keywordflow">case</span> WM_RBUTTONDBLCLK:
05423             <span class="keywordflow">case</span> WM_MBUTTONDOWN:
05424             <span class="keywordflow">case</span> WM_MBUTTONUP:
05425             <span class="keywordflow">case</span> WM_MBUTTONDBLCLK:
05426             <span class="keywordflow">case</span> WM_MOUSEWHEEL:
05427                 <span class="keywordflow">if</span> (<a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a47">HandleMouseEvent</a>(Console,ScreenInfo,Message,wParam,lParam)) {
05428                     <span class="keywordflow">if</span> (Message != WM_MOUSEWHEEL) {
05429                         <span class="keywordflow">goto</span> CallDefWin;
05430                     }
05431                 } <span class="keywordflow">else</span> {
05432                     <span class="keywordflow">break</span>;
05433                 }
05434 
05435                 <span class="comment">/*</span>
05436 <span class="comment">                 * Don't handle zoom</span>
05437 <span class="comment">                 */</span>
05438                 <span class="keywordflow">if</span> (wParam &amp; (MK_CONTROL)) {
05439                     <span class="keywordflow">goto</span> CallDefWin;
05440                 }
05441 
05442                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = 1;
05443                 <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/output_8c.html#a23">gfInitSystemMetrics</a>) {
05444                     <a class="code" href="../../d6/d2/output_8c.html#a38">InitializeSystemMetrics</a>();
05445                 }
05446 
05447                 ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o19">WheelDelta</a> -= (<span class="keywordtype">short</span>)HIWORD(wParam);
05448                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a259">abs</a>(ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o19">WheelDelta</a>) &gt;= WHEEL_DELTA &amp;&amp;
05449                         <a class="code" href="../../d6/d2/output_8c.html#a27">gucWheelScrollLines</a> &gt; 0) {
05450 
05451                     COORD   NewOrigin;
05452                     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>   dy;
05453 
05454                     NewOrigin.X = ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Left;
05455                     NewOrigin.Y = ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Top;
05456 
05457                     <span class="comment">/*</span>
05458 <span class="comment">                     * Limit a roll of one (1) WHEEL_DELTA to scroll one (1) page.</span>
05459 <span class="comment">                     * If in shift scroll mode then scroll one page at a time regardless.</span>
05460 <span class="comment">                     */</span>
05461 
05462                     <span class="keywordflow">if</span> (!(wParam &amp; MK_SHIFT))
05463                         dy = (<span class="keywordtype">int</span>) <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(
05464                                 (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>) <a class="code" href="../../d7/d2/output_8h.html#a18">CONSOLE_WINDOW_SIZE_Y</a>(ScreenInfo) - 1,
05465                                 <a class="code" href="../../d6/d2/output_8c.html#a27">gucWheelScrollLines</a>);
05466                     <span class="keywordflow">else</span>
05467                         dy = <a class="code" href="../../d7/d2/output_8h.html#a18">CONSOLE_WINDOW_SIZE_Y</a>(ScreenInfo) - 1;
05468 
05469                     <span class="keywordflow">if</span> (dy == 0) {
05470                         dy++;
05471                     }
05472 
05473                     dy *= (ScreenInfo-&gt;WheelDelta / WHEEL_DELTA);
05474                     ScreenInfo-&gt;WheelDelta %= WHEEL_DELTA;
05475 
05476                     NewOrigin.Y += dy;
05477                     <span class="keywordflow">if</span> (NewOrigin.Y &lt; 0) {
05478                         NewOrigin.Y = 0;
05479                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NewOrigin.Y + <a class="code" href="../../d7/d2/output_8h.html#a18">CONSOLE_WINDOW_SIZE_Y</a>(ScreenInfo) &gt;
05480                             ScreenInfo-&gt;ScreenBufferSize.Y) {
05481                         NewOrigin.Y = ScreenInfo-&gt;ScreenBufferSize.Y -
05482                                 <a class="code" href="../../d7/d2/output_8h.html#a18">CONSOLE_WINDOW_SIZE_Y</a>(ScreenInfo);
05483                     }
05484 
05485                     <a class="code" href="../../d6/d2/output_8c.html#a66">SetWindowOrigin</a>(ScreenInfo, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, NewOrigin);
05486                 }
05487                 <span class="keywordflow">break</span>;
05488 
05489             <span class="keywordflow">case</span> WM_PALETTECHANGED:
05490                 <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o47">FullScreenFlags</a> == 0) {
05491                     <span class="keywordflow">if</span> (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o16">hPalette</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05492                         <a class="code" href="../../d7/d4/server_2private_8c.html#a46">SetActivePalette</a>(ScreenInfo);
05493                         <span class="keywordflow">if</span> (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o1">Flags</a> &amp; <a class="code" href="../../d7/d2/output_8h.html#a1">CONSOLE_GRAPHICS_BUFFER</a>) {
05494                             <a class="code" href="../../d8/d5/consrv_8h.html#a274">WriteRegionToScreenBitMap</a>(ScreenInfo,
05495                                                       &amp;ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>);
05496                         }
05497                     } <span class="keywordflow">else</span> {
05498                         <a class="code" href="../../d9/d4/ntcon_2server_2getset_8c.html#a20">SetScreenColors</a>(ScreenInfo, ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o8">Attributes</a>,
05499                                         ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o9">PopupAttributes</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
05500                     }
05501                 }
05502                 <span class="keywordflow">break</span>;
05503 <span class="preprocessor">#if defined(_X86_)</span>
05504 <span class="preprocessor"></span>            <span class="keywordflow">case</span> WM_FULLSCREEN:
05505 
05506                 <span class="comment">//</span>
05507                 <span class="comment">// This message is sent by the system to tell console that</span>
05508                 <span class="comment">// the fullscreen state of a window has changed.</span>
05509                 <span class="comment">// In some cases, this message will be sent in response to</span>
05510                 <span class="comment">// a call from console to change to fullscreen (Atl-Enter)</span>
05511                 <span class="comment">// or may also come directly from the system (switch of</span>
05512                 <span class="comment">// focus from a windowed app to a fullscreen app).</span>
05513                 <span class="comment">//</span>
05514 
05515                 KdPrint((<span class="stringliteral">"CONSRV: WindowProc - WM_FULLSCREEN\n"</span>));
05516 
05517                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d4/server_2private_8c.html#a54">DisplayModeTransition</a>(wParam,Console,ScreenInfo);
05518 <span class="preprocessor">#if defined(FE_IME)</span>
05519 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
05520                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ImeWmFullScreen(wParam,Console,ScreenInfo);
05521                 }
05522 <span class="preprocessor">#endif // FE_IME</span>
05523 <span class="preprocessor"></span>                <span class="keywordflow">break</span>;
05524 <span class="preprocessor">#endif</span>
05525 <span class="preprocessor"></span>            <span class="keywordflow">case</span> <a class="code" href="../../d1/d7/server_8h.html#a69">CM_SET_WINDOW_SIZE</a>:
05526                 <span class="keywordflow">if</span> (lParam == 0x47474747) {
05527                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d2/output_8c.html#a70">InternalSetWindowSize</a>(Console,
05528                                                    (<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a>)wParam,
05529                                                    &amp;ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>
05530                                                    );
05531                 }
05532                 <span class="keywordflow">break</span>;
05533             <span class="keywordflow">case</span> <a class="code" href="../../d1/d7/server_8h.html#a70">CM_BEEP</a>:
05534                 <span class="keywordflow">if</span> (lParam == 0x47474747) {
05535                     Beep(800, 200);
05536                 }
05537                 <span class="keywordflow">break</span>;
05538             <span class="keywordflow">case</span> <a class="code" href="../../d1/d7/server_8h.html#a71">CM_UPDATE_SCROLL_BARS</a>:
05539                 <a class="code" href="../../d6/d2/output_8c.html#a37">InternalUpdateScrollBars</a>(ScreenInfo);
05540                 <span class="keywordflow">break</span>;
05541             <span class="keywordflow">case</span> <a class="code" href="../../d1/d7/server_8h.html#a72">CM_UPDATE_TITLE</a>:
05542                 <a class="code" href="../../d5/d9/cltxt_8h.html#a23">SetWindowText</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>,Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o28">Title</a>);
05543                 <span class="keywordflow">break</span>;
05544             <span class="keywordflow">case</span> <a class="code" href="../../d1/d7/server_8h.html#a76">CM_CONSOLE_MSG</a>:
05545                 <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d2/output_8c.html#a77">UnqueueConsoleMessage</a>(Console, &amp;Message, &amp;wParam, &amp;lParam)) {
05546                     <span class="keywordflow">break</span>;
05547                 }
05548                 <span class="keywordflow">switch</span> (Message) {
05549 <span class="preprocessor">#if defined(_X86_)</span>
05550 <span class="preprocessor"></span>                <span class="keywordflow">case</span> <a class="code" href="../../d1/d7/server_8h.html#a73">CM_MODE_TRANSITION</a>:
05551 
05552                     KdPrint((<span class="stringliteral">"CONSRV: WindowProc - CM_MODE_TRANSITION\n"</span>));
05553 
05554                     <span class="keywordflow">if</span> (wParam == FULLSCREEN) {
05555                         <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o47">FullScreenFlags</a> == 0) {
05556                             <a class="code" href="../../d7/d4/server_2private_8c.html#a48">ConvertToFullScreen</a>(Console);
05557                             Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o47">FullScreenFlags</a> |= CONSOLE_FULLSCREEN;
05558                             <a class="code" href="../../d8/d5/consrv_8h.html#a293">ChangeDispSettings</a>(Console, <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, CDS_FULLSCREEN);
05559                         }
05560                     } <span class="keywordflow">else</span> {
05561                         <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o47">FullScreenFlags</a> &amp; CONSOLE_FULLSCREEN) {
05562                             <a class="code" href="../../d7/d4/server_2private_8c.html#a49">ConvertToWindowed</a>(Console);
05563                             Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o47">FullScreenFlags</a> &amp;= ~CONSOLE_FULLSCREEN;
05564                             <a class="code" href="../../d8/d5/consrv_8h.html#a293">ChangeDispSettings</a>(Console, <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, 0);
05565 
05566                             <a class="code" href="../../d3/d0/user32_8def.html#a32">ShowWindow</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, SW_RESTORE);
05567                         }
05568                     }
05569 
05570                     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
05571                     Console = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05572 
05573                     <a class="code" href="../../d0/d8/ex_2event_8c.html#a10">NtSetEvent</a>((HANDLE)lParam, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
05574                     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>((HANDLE)lParam);
05575                     <span class="keywordflow">break</span>;
05576 <span class="preprocessor">#endif</span>
05577 <span class="preprocessor"></span><span class="preprocessor">#if defined (FE_IME)</span>
05578 <span class="preprocessor"></span>                <span class="keywordflow">case</span> CM_SET_IME_CODEPAGE: {
05579                     <span class="keywordflow">if</span> (! LOWORD(lParam))
05580                     {
05581                         <span class="comment">// Input code page</span>
05582                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = SetImeCodePage(Console);
05583                     }
05584                     <span class="keywordflow">else</span>
05585                     {
05586                         <span class="comment">// Output code page</span>
05587                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = SetImeOutputCodePage(Console, ScreenInfo, HIWORD(lParam));
05588                     }
05589 
05590                     <span class="keywordflow">if</span> (wParam) {
05591                         <a class="code" href="../../d0/d8/ex_2event_8c.html#a10">NtSetEvent</a>((HANDLE)wParam, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
05592                         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>((HANDLE)wParam);
05593                     }
05594                     <span class="keywordflow">break</span>;
05595                 }
05596                 <span class="keywordflow">case</span> CM_SET_NLSMODE:
05597                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = SetImeKeyState(Console, <a class="code" href="../../d0/d3/dbcs_8h.html#a55">ImmConversionFromConsole</a>((<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)lParam));
05598                     <span class="keywordflow">if</span> (wParam) {
05599                         <a class="code" href="../../d0/d8/ex_2event_8c.html#a10">NtSetEvent</a>((HANDLE)wParam, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
05600                         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>((HANDLE)wParam);
05601                     }
05602                     <span class="keywordflow">break</span>;
05603                 <span class="keywordflow">case</span> CM_GET_NLSMODE:
05604                     <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o75">InputThreadInfo</a>-&gt;hWndConsoleIME)
05605                     {
05606                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d8/d5/consrv_8h.html#a33">CONSOLE_IS_IME_ENABLED</a>());
05607 
05608                         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(GetImeKeyState(Console, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>))) {
05609                             <span class="keywordflow">if</span> (wParam) {
05610                                 <a class="code" href="../../d0/d8/ex_2event_8c.html#a10">NtSetEvent</a>((HANDLE)wParam, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
05611                                 <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>((HANDLE)wParam);
05612                             }
05613                             <span class="keywordflow">break</span>;
05614                         }
05615                         <span class="keywordflow">if</span> (wParam) {
05616                             <a class="code" href="../../d0/d8/ex_2event_8c.html#a10">NtSetEvent</a>((HANDLE)wParam, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
05617                             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>((HANDLE)wParam);
05618                         }
05619                     }
05620                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lParam &lt; 10)
05621                     {
05622                         <span class="comment">/*</span>
05623 <span class="comment">                         * try get conversion mode until ready ConIME.</span>
05624 <span class="comment">                         */</span>
05625                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d2/output_8c.html#a76">QueueConsoleMessage</a>(Console,
05626                                     CM_GET_NLSMODE,
05627                                     wParam,
05628                                     lParam+1
05629                                    );
05630                         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
05631                             <span class="keywordflow">if</span> (wParam) {
05632                                 <a class="code" href="../../d0/d8/ex_2event_8c.html#a10">NtSetEvent</a>((HANDLE)wParam, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
05633                                 <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>((HANDLE)wParam);
05634                             }
05635                         }
05636                     }
05637                     <span class="keywordflow">else</span>
05638                     {
05639                         <span class="keywordflow">if</span> (wParam) {
05640                             <a class="code" href="../../d0/d8/ex_2event_8c.html#a10">NtSetEvent</a>((HANDLE)wParam, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
05641                             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>((HANDLE)wParam);
05642                         }
05643                     }
05644                     <span class="keywordflow">break</span>;
05645 <span class="preprocessor">#endif // FE_IME</span>
05646 <span class="preprocessor"></span>                }
05647                 <span class="keywordflow">break</span>;
05648 
05649             <span class="keywordflow">case</span> <a class="code" href="../../d1/d7/server_8h.html#a75">CM_HIDE_WINDOW</a>:
05650                 ShowWindowAsync(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, SW_MINIMIZE);
05651                 <span class="keywordflow">break</span>;
05652             <span class="keywordflow">case</span> CM_PROPERTIES_START:
05653                 Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o74">hWndProperties</a> = (HWND)wParam;
05654                 <span class="keywordflow">break</span>;
05655             <span class="keywordflow">case</span> CM_PROPERTIES_UPDATE:
05656                 <a class="code" href="../../d1/d7/ntcon_2server_2menu_8c.html#a5">PropertiesUpdate</a>(Console, (HANDLE)wParam);
05657                 <span class="keywordflow">break</span>;
05658             <span class="keywordflow">case</span> CM_PROPERTIES_END:
05659                 Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o74">hWndProperties</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05660                 <span class="keywordflow">break</span>;
05661 <span class="preprocessor">#if defined(FE_IME)</span>
05662 <span class="preprocessor"></span>            <span class="keywordflow">case</span> WM_COPYDATA:
05663                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/consrv_8h.html#a33">CONSOLE_IS_IME_ENABLED</a>() &amp;&amp; CONSOLE_IS_DBCS_OUTPUTCP(Console)) {
05664                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ImeControl(Console,(HWND)wParam,(PCOPYDATASTRUCT)lParam);
05665                 }
05666                 <span class="keywordflow">break</span>;
05667 <span class="comment">// v-HirShi Sep.18.1995 Support Console IME</span>
05668             <span class="keywordflow">case</span> WM_ENTERMENULOOP:
05669                 <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a2">CONSOLE_HAS_FOCUS</a>) {
05670                     Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o3">InputBuffer</a>.ImeMode.Unavailable = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05671                     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/consrv_8h.html#a33">CONSOLE_IS_IME_ENABLED</a>()) {
05672                         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ConsoleImeMessagePump(Console,
05673                                               <a class="code" href="../../d3/d5/conime_8h.html#a12">CONIME_KILLFOCUS</a>,
05674                                               (WPARAM)Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o65">ConsoleHandle</a>,
05675                                               (LPARAM)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
05676                                              ))) {
05677                             <span class="keywordflow">break</span>;
05678                         }
05679                     }
05680                 }
05681                 <span class="keywordflow">break</span>;
05682 
05683             <span class="keywordflow">case</span> WM_EXITMENULOOP:
05684                 <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a2">CONSOLE_HAS_FOCUS</a>) {
05685                     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/consrv_8h.html#a33">CONSOLE_IS_IME_ENABLED</a>()) {
05686                         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ConsoleImeMessagePump(Console,
05687                                               <a class="code" href="../../d3/d5/conime_8h.html#a11">CONIME_SETFOCUS</a>,
05688                                               (WPARAM)Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o65">ConsoleHandle</a>,
05689                                               (LPARAM)Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o9">hklActive</a>
05690                                              ))) {
05691                             <span class="keywordflow">break</span>;
05692                         }
05693                     }
05694                     Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o3">InputBuffer</a>.ImeMode.Unavailable = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05695                 }
05696                 <span class="keywordflow">break</span>;
05697 
05698             <span class="keywordflow">case</span> WM_ENTERSIZEMOVE:
05699                 <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a2">CONSOLE_HAS_FOCUS</a>) {
05700                     Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o3">InputBuffer</a>.ImeMode.Unavailable = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05701                 }
05702                 <span class="keywordflow">break</span>;
05703 
05704             <span class="keywordflow">case</span> WM_EXITSIZEMOVE:
05705                 <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o35">Flags</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a2">CONSOLE_HAS_FOCUS</a>) {
05706                     Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o3">InputBuffer</a>.ImeMode.Unavailable = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05707                 }
05708                 <span class="keywordflow">break</span>;
05709 <span class="preprocessor">#endif // FE_IME</span>
05710 <span class="preprocessor"></span>CallDefWin:
05711             <span class="keywordflow">default</span>:
05712                 <span class="keywordflow">if</span> (Console != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05713                     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
05714                     Console = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05715                 }
05716                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = (<a class="code" href="../../d5/d9/cltxt_8h.html#a15">DefWindowProc</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>,Message,wParam,lParam));
05717                 <span class="keywordflow">break</span>;
05718             }
05719         }
05720     } finally {
05721         <span class="keywordflow">if</span> (Console != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05722             <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
05723             Console = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05724         }
05725     }
05726 
05727     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
05728 }
05729 
05730 
05731 <span class="comment">/*</span>
05732 <span class="comment">* Drag and Drop support functions for console window</span>
05733 <span class="comment">*/</span>
05734 
05735 <span class="comment">/*++</span>
05736 <span class="comment"></span>
05737 <span class="comment">Routine Description:</span>
05738 <span class="comment"></span>
05739 <span class="comment">    This routine retrieves the filenames of dropped files. It was copied from</span>
05740 <span class="comment">    shelldll API DragQueryFile. We didn't use DragQueryFile () because we don't</span>
05741 <span class="comment">    want to load Shell32.dll in CSR</span>
05742 <span class="comment"></span>
05743 <span class="comment">Arguments:</span>
05744 <span class="comment">    Same as DragQueryFile</span>
05745 <span class="comment"></span>
05746 <span class="comment">Return Value:</span>
05747 <span class="comment"></span>
05748 <span class="comment"></span>
05749 <span class="comment">--*/</span>
<a name="l05750"></a><a class="code" href="../../d6/d2/output_8c.html#a84">05750</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d6/d2/output_8c.html#a84">ConsoleDragQueryFile</a>(
05751     IN HANDLE hDrop,
05752     IN PVOID lpFile,
05753     IN UINT cb
05754     )
05755 {
05756     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> i = 0;
05757     LPDROPFILESTRUCT lpdfs;
05758     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fWide;
05759 
05760     lpdfs = (LPDROPFILESTRUCT)GlobalLock(hDrop);
05761 
05762     <span class="keywordflow">if</span> (lpdfs &amp;&amp; lpdfs != hDrop)
05763     {
05764         <span class="keywordflow">try</span> {
05765             fWide = (LOWORD(lpdfs-&gt;pFiles) == <span class="keyword">sizeof</span>(DROPFILES));
05766             <span class="keywordflow">if</span> (fWide)
05767             {
05768                 <span class="comment">//</span>
05769                 <span class="comment">// This is a new (NT-compatible) HDROP</span>
05770                 <span class="comment">//</span>
05771                 fWide = lpdfs-&gt;fWide;       <span class="comment">// Redetermine fWide from struct</span>
05772                                             <span class="comment">// since it is present.</span>
05773             }
05774 
05775             <span class="keywordflow">if</span> (fWide)
05776             {
05777                 LPWSTR lpList;
05778 
05779                 <span class="comment">//</span>
05780                 <span class="comment">// UNICODE HDROP</span>
05781                 <span class="comment">//</span>
05782 
05783                 lpList = (LPWSTR)((LPBYTE)lpdfs + lpdfs-&gt;pFiles);
05784 
05785                 i = lstrlenW(lpList);
05786 
05787                 <span class="keywordflow">if</span> (!i)
05788                     <span class="keywordflow">goto</span> Exit;
05789 
05790                 cb--;
05791                 <span class="keywordflow">if</span> (cb &lt; i)
05792                     i = cb;
05793 
05794                 lstrcpynW((LPWSTR)lpFile, lpList, i + 1);
05795             }
05796             <span class="keywordflow">else</span>
05797             {
05798                 LPSTR lpList;
05799 
05800                 <span class="comment">//</span>
05801                 <span class="comment">// This is Win31-style HDROP or an ANSI NT Style HDROP</span>
05802                 <span class="comment">//</span>
05803                 lpList = (LPSTR)((LPBYTE)lpdfs + lpdfs-&gt;pFiles);
05804 
05805                 i = lstrlenA(lpList);
05806 
05807                 <span class="keywordflow">if</span> (!i)
05808                     <span class="keywordflow">goto</span> Exit;
05809 
05810                 cb--;
05811                 <span class="keywordflow">if</span> (cb &lt; i)
05812                     i = cb;
05813 
05814                 MultiByteToWideChar(CP_ACP, 0, lpList, -1, (LPWSTR)lpFile, cb);
05815 
05816             }
05817         } except( <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
05818            KdPrint((<span class="stringliteral">"CONSRV: WM_DROPFILES raised exception\n"</span>));
05819            i = 0;
05820         }
05821 Exit:
05822         GlobalUnlock(hDrop);
05823         GlobalFree(hDrop);
05824     }
05825 
05826     <span class="keywordflow">return</span>(i);
05827 }
05828 
05829 
05830 
05831 
05832 <span class="comment">/*++</span>
05833 <span class="comment"></span>
05834 <span class="comment">Routine Description:</span>
05835 <span class="comment"></span>
05836 <span class="comment">    This routine is called when ConsoleWindowProc receives a WM_DROPFILES</span>
05837 <span class="comment">    message. It initially calls ConsoleDragQueryFile() to calculate the number</span>
05838 <span class="comment">    of files dropped and then ConsoleDragQueryFile() is called</span>
05839 <span class="comment">    to retrieve the filename. DoStringPaste() pastes the filename to the console</span>
05840 <span class="comment">    window</span>
05841 <span class="comment"></span>
05842 <span class="comment">Arguments:</span>
05843 <span class="comment">    wParam  -   Identifies the structure containing the filenames of the</span>
05844 <span class="comment">                dropped files.</span>
05845 <span class="comment">    Console -   Pointer to CONSOLE_INFORMATION structure</span>
05846 <span class="comment"></span>
05847 <span class="comment"></span>
05848 <span class="comment">Return Value:</span>
05849 <span class="comment">    None</span>
05850 <span class="comment"></span>
05851 <span class="comment"></span>
05852 <span class="comment">--*/</span>
<a name="l05853"></a><a class="code" href="../../d6/d2/output_8c.html#a85">05853</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d2/output_8c.html#a85">DoDrop</a> (WPARAM wParam,
05854              <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console)
05855 {
05856     WCHAR  szPath[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
05857     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fAddQuotes;
05858 
05859     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/output_8c.html#a84">ConsoleDragQueryFile</a>((HANDLE)wParam, szPath, <a class="code" href="../../d6/d2/output_8c.html#a5">CharSizeOf</a>(szPath))) {
05860         fAddQuotes = (wcschr(szPath, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">' '</span>) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
05861         <span class="keywordflow">if</span> (fAddQuotes)
05862             <a class="code" href="../../d8/d5/consrv_8h.html#a303">DoStringPaste</a>(Console, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\""</span>, 1);
05863         <a class="code" href="../../d8/d5/consrv_8h.html#a303">DoStringPaste</a>(Console, szPath, wcslen(szPath));
05864         <span class="keywordflow">if</span> (fAddQuotes)
05865             <a class="code" href="../../d8/d5/consrv_8h.html#a303">DoStringPaste</a>(Console, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\""</span>, 1);
05866     }
05867 }
05868 
05869 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l05870"></a><a class="code" href="../../d6/d2/output_8c.html#a86">05870</a> <a class="code" href="../../d6/d2/output_8c.html#a86">CreateDbcsScreenBuffer</a>(
05871     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
05872     IN COORD dwScreenBufferSize,
05873     OUT PDBCS_SCREEN_BUFFER DbcsScreenBuffer
05874     )
05875 {
05876     <span class="keywordflow">if</span> (CONSOLE_IS_DBCS_OUTPUTCP(Console)) {
05877         DbcsScreenBuffer-&gt;TransBufferCharacter =
05878             (PWCHAR)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(
05879                               <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( SCREEN_DBCS_TAG ),
05880                               (dwScreenBufferSize.X*dwScreenBufferSize.Y*<span class="keyword">sizeof</span>(WCHAR))+<span class="keyword">sizeof</span>(WCHAR));
05881         <span class="keywordflow">if</span> (DbcsScreenBuffer-&gt;TransBufferCharacter == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05882             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05883         }
05884 
05885         DbcsScreenBuffer-&gt;TransBufferAttribute =
05886             (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(
05887                              <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( SCREEN_DBCS_TAG ),
05888                              (dwScreenBufferSize.X*dwScreenBufferSize.Y*<span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>))+<span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>));
05889         <span class="keywordflow">if</span> (DbcsScreenBuffer-&gt;TransBufferAttribute == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05890             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(DbcsScreenBuffer-&gt;TransBufferCharacter);
05891             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05892         }
05893 
05894         DbcsScreenBuffer-&gt;TransWriteConsole =
05895             (PWCHAR)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(
05896                               <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( SCREEN_DBCS_TAG ),
05897                               (dwScreenBufferSize.X*dwScreenBufferSize.Y*<span class="keyword">sizeof</span>(WCHAR))+<span class="keyword">sizeof</span>(WCHAR));
05898         <span class="keywordflow">if</span> (DbcsScreenBuffer-&gt;TransWriteConsole == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05899             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(DbcsScreenBuffer-&gt;TransBufferAttribute);
05900             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(DbcsScreenBuffer-&gt;TransBufferCharacter);
05901             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05902         }
05903 
05904         DbcsScreenBuffer-&gt;KAttrRows =
05905             (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(
05906                              <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( SCREEN_DBCS_TAG ),
05907                              dwScreenBufferSize.X*dwScreenBufferSize.Y*<span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>));
05908         <span class="keywordflow">if</span> (DbcsScreenBuffer-&gt;KAttrRows == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05909             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(DbcsScreenBuffer-&gt;TransWriteConsole);
05910             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(DbcsScreenBuffer-&gt;TransBufferAttribute);
05911             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(DbcsScreenBuffer-&gt;TransBufferCharacter);
05912             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05913         }
05914     }
05915     <span class="keywordflow">else</span> {
05916         DbcsScreenBuffer-&gt;TransBufferCharacter = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05917         DbcsScreenBuffer-&gt;TransBufferAttribute = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05918         DbcsScreenBuffer-&gt;TransWriteConsole = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05919         DbcsScreenBuffer-&gt;KAttrRows = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05920     }
05921 
05922     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05923 }
05924 
05925 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l05926"></a><a class="code" href="../../d6/d2/output_8c.html#a87">05926</a> <a class="code" href="../../d6/d2/output_8c.html#a87">DeleteDbcsScreenBuffer</a>(
05927     IN PDBCS_SCREEN_BUFFER DbcsScreenBuffer
05928     )
05929 {
05930     <span class="keywordflow">if</span> (DbcsScreenBuffer-&gt;KAttrRows) {
05931         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(DbcsScreenBuffer-&gt;TransBufferCharacter);
05932         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(DbcsScreenBuffer-&gt;TransBufferAttribute);
05933         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(DbcsScreenBuffer-&gt;TransWriteConsole);
05934         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(DbcsScreenBuffer-&gt;KAttrRows);
05935     }
05936     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05937 }
05938 
05939 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l05940"></a><a class="code" href="../../d6/d2/output_8c.html#a88">05940</a> <a class="code" href="../../d6/d2/output_8c.html#a88">ReCreateDbcsScreenBufferWorker</a>(
05941     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
05942     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo
05943     )
05944 {
05945     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> i;
05946     <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a> KAttrRowPtr;
05947     COORD dwScreenBufferSize;
05948     DBCS_SCREEN_BUFFER NewDbcsScreenBuffer;
05949 
05950     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ScreenInfo-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>);
05951     <span class="keywordflow">if</span> (!(ScreenInfo-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>)) {
05952         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05953     }
05954 
05955     dwScreenBufferSize = ScreenInfo-&gt;ScreenBufferSize;
05956 
05957     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d2/output_8c.html#a86">CreateDbcsScreenBuffer</a>(Console,
05958             dwScreenBufferSize,
05959             &amp;NewDbcsScreenBuffer)) {
05960         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05961     }
05962 
05963     KAttrRowPtr = NewDbcsScreenBuffer.KAttrRows;
05964     <span class="keywordflow">for</span> (i = 0; i &lt; dwScreenBufferSize.Y; i++) {
05965         ScreenInfo-&gt;BufferInfo.TextInfo.Rows[i].CharRow.KAttrs = KAttrRowPtr;
05966         <span class="keywordflow">if</span> (KAttrRowPtr) {
05967             RtlZeroMemory(KAttrRowPtr, dwScreenBufferSize.X);
05968             KAttrRowPtr += dwScreenBufferSize.X;
05969         }
05970     }
05971     ScreenInfo-&gt;BufferInfo.TextInfo.DbcsScreenBuffer = NewDbcsScreenBuffer;
05972 
05973     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05974 }
05975 
05976 
<a name="l05977"></a><a class="code" href="../../d1/d0/struct__DBCS__SCREEN__BUFFER__TRACKER.html">05977</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d1/d0/struct__DBCS__SCREEN__BUFFER__TRACKER.html">_DBCS_SCREEN_BUFFER_TRACKER</a> {
<a name="l05978"></a><a class="code" href="../../d1/d0/struct__DBCS__SCREEN__BUFFER__TRACKER.html#o0">05978</a>     DBCS_SCREEN_BUFFER <a class="code" href="../../d1/d0/struct__DBCS__SCREEN__BUFFER__TRACKER.html#o0">data</a>;
05979 <span class="preprocessor">#if DBG</span>
05980 <span class="preprocessor"></span>    <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> pScreenInfo;
05981 <span class="preprocessor">#endif</span>
05982 <span class="preprocessor"></span>} <a class="code" href="../../d1/d0/struct__DBCS__SCREEN__BUFFER__TRACKER.html">DBCS_SCREEN_BUFFER_TRACKER</a>, *<a class="code" href="../../d1/d0/struct__DBCS__SCREEN__BUFFER__TRACKER.html">PDBCS_SCREEN_BUFFER_TRACKER</a>;
05983 
05984 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l05985"></a><a class="code" href="../../d6/d2/output_8c.html#a89">05985</a> <a class="code" href="../../d6/d2/output_8c.html#a89">ReCreateDbcsScreenBuffer</a>(
05986     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> pConsole,
05987     IN UINT OldCodePage)
05988 {
05989     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fResult = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05990     <a class="code" href="../../d6/d2/output_8c.html#a30">PDBCS_SCREEN_BUFFER_TRACKER</a> pDbcsScreenBuffer;
05991     <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> pScreenInfo;
05992     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> nScreen;
05993     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> i;
05994 <span class="preprocessor">#if DBG</span>
05995 <span class="preprocessor"></span>    <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> nScreenSave;
05996 <span class="preprocessor">#endif</span>
05997 <span class="preprocessor"></span>
05998     <span class="comment">//</span>
05999     <span class="comment">// If DbcsBuffers don't need to be modified, just bail out.</span>
06000     <span class="comment">//</span>
06001     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d3/dbcs_8h.html#a46">IsAvailableFarEastCodePage</a>(OldCodePage) == !CONSOLE_IS_DBCS_OUTPUTCP(pConsole) )
06002         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
06003 
06004     <span class="comment">//</span>
06005     <span class="comment">// Count the number of screens allocated.</span>
06006     <span class="comment">//</span>
06007     <span class="keywordflow">for</span> (nScreen = 0, pScreenInfo = pConsole-&gt;ScreenBuffers; pScreenInfo; pScreenInfo = pScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o23">Next</a>) {
06008         <span class="comment">//</span>
06009         <span class="comment">// Ignore graphic mode buffer.</span>
06010         <span class="comment">//</span>
06011         <span class="keywordflow">if</span> (pScreenInfo-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>) {
06012             ++nScreen;
06013         }
06014     }
06015 <span class="preprocessor">#if DBG</span>
06016 <span class="preprocessor"></span>    nScreenSave = nScreen;
06017 <span class="preprocessor">#endif</span>
06018 <span class="preprocessor"></span>
06019     <span class="comment">//</span>
06020     <span class="comment">// Allocate the temporary buffer to store the old values</span>
06021     <span class="comment">//</span>
06022     pDbcsScreenBuffer = <a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>(TMP_DBCS_TAG), <span class="keyword">sizeof</span> *pDbcsScreenBuffer * nScreen);
06023     <span class="keywordflow">if</span> (pDbcsScreenBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06024         RIPMSG0(RIP_WARNING, <span class="stringliteral">"ReCreateDbcsScreenBuffer: not enough memory."</span>);
06025         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06026     }
06027 
06028     <span class="comment">//</span>
06029     <span class="comment">// Try to allocate or de-allocate the necessary DBCS buffers</span>
06030     <span class="comment">//</span>
06031     <span class="keywordflow">for</span> (nScreen = 0, pScreenInfo = pConsole-&gt;ScreenBuffers; pScreenInfo; pScreenInfo = pScreenInfo-&gt;Next) {
06032         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(nScreen &lt; nScreenSave);  <span class="comment">// make sure ScreenBuffers are not changed</span>
06033 
06034         <span class="comment">//</span>
06035         <span class="comment">// We only handle the text mode screen buffer.</span>
06036         <span class="comment">//</span>
06037         <span class="keywordflow">if</span> (pScreenInfo-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>) {
06038             <span class="comment">//</span>
06039             <span class="comment">// Save the previous value just in case something goes bad.</span>
06040             <span class="comment">//</span>
06041 <span class="preprocessor">#if DBG</span>
06042 <span class="preprocessor"></span>            pDbcsScreenBuffer[nScreen].pScreenInfo = pScreenInfo;
06043 <span class="preprocessor">#endif</span>
06044 <span class="preprocessor"></span>            pDbcsScreenBuffer[nScreen++].<a class="code" href="../../d1/d0/struct__DBCS__SCREEN__BUFFER__TRACKER.html#o0">data</a> = pScreenInfo-&gt;BufferInfo.TextInfo.DbcsScreenBuffer;
06045 
06046             <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d2/output_8c.html#a88">ReCreateDbcsScreenBufferWorker</a>(pConsole, pScreenInfo)) {
06047                 <span class="comment">//</span>
06048                 <span class="comment">// If we fail to ReCreate the DbcsScreenBuffer,</span>
06049                 <span class="comment">// free all allocation to this point, and restore the orginal.</span>
06050                 <span class="comment">//</span>
06051                 RIPMSG0(RIP_WARNING, <span class="stringliteral">"ReCreateDbcsScreenBuffer: failed to recreate dbcs screen buffer."</span>);
06052 
06053                 <span class="keywordflow">for</span> (i = 0, pScreenInfo = pConsole-&gt;ScreenBuffers; i &lt; nScreen;  pScreenInfo = pScreenInfo-&gt;Next) {
06054                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pScreenInfo);
06055 
06056                     <span class="keywordflow">if</span> (pScreenInfo-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>) {
06057                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pDbcsScreenBuffer[i].pScreenInfo == pScreenInfo);
06058                         <span class="keywordflow">if</span> (i &lt; nScreen - 1) {
06059                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pScreenInfo-&gt;BufferInfo.TextInfo.DbcsScreenBuffer.KAttrRows != pDbcsScreenBuffer[i].<a class="code" href="../../d1/d0/struct__DBCS__SCREEN__BUFFER__TRACKER.html#o0">data</a>.KAttrRows);
06060                             <a class="code" href="../../d6/d2/output_8c.html#a87">DeleteDbcsScreenBuffer</a>(&amp;pScreenInfo-&gt;BufferInfo.TextInfo.DbcsScreenBuffer);
06061                         }
06062 
06063                         pScreenInfo-&gt;BufferInfo.TextInfo.DbcsScreenBuffer = pDbcsScreenBuffer[i++].<a class="code" href="../../d1/d0/struct__DBCS__SCREEN__BUFFER__TRACKER.html#o0">data</a>;
06064                     }
06065                 }
06066                 <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
06067             }
06068         }
06069     }
06070 
06071     <span class="comment">//</span>
06072     <span class="comment">// All allocation succeeded. Now we can delete the old allocation.</span>
06073     <span class="comment">//</span>
06074     <span class="keywordflow">for</span> (i = 0; i &lt; nScreen; ++i) {
06075         <a class="code" href="../../d6/d2/output_8c.html#a87">DeleteDbcsScreenBuffer</a>(&amp;pDbcsScreenBuffer[i].data);
06076     }
06077 
06078     fResult = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
06079 
06080 <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>:
06081     <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(pDbcsScreenBuffer);
06082 
06083     <span class="keywordflow">return</span> fResult;
06084 }
06085 
06086 <span class="comment">// Checks if the primary language of this keyborad layout is BiDi or not.</span>
<a name="l06087"></a><a class="code" href="../../d6/d2/output_8c.html#a90">06087</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d2/output_8c.html#a90">IsNotBiDILayout</a>(HKL hkl)
06088 {
06089     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bRet = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
06090     LANGID LangID = PRIMARYLANGID(HandleToUlong(hkl));
06091 
06092     <span class="keywordflow">if</span> ( (LangID == LANG_ARABIC) || (LangID == LANG_HEBREW)) {
06093         bRet = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06094     }
06095     <span class="keywordflow">return</span> bRet;
06096 
06097 }
06098 
<a name="l06099"></a><a class="code" href="../../d6/d2/output_8c.html#a31">06099</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d2/output_8c.html#a31">GetNonBiDiKeyboardLayout</a>(HKL *phklActive)
06100 {
06101     HKL hkl = *phklActive;
06102 
06103     <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d2/output_8c.html#a90">IsNotBiDILayout</a>(hkl) )
06104         <span class="keywordflow">return</span>;
06105 
06106     <span class="comment">// Start with the default one.</span>
06107     <a class="code" href="../../d3/d0/user32_8def.html#a45">ActivateKeyboardLayout</a>(hkl, 0);
06108     <span class="comment">// We know that the default is not good, Activate the next.</span>
06109     <a class="code" href="../../d3/d0/user32_8def.html#a45">ActivateKeyboardLayout</a>((HKL)HKL_NEXT, 0);
06110 
06111     <span class="comment">// Loop until you find a none BiDi one or endof list.</span>
06112     <span class="keywordflow">while</span> (hkl = <a class="code" href="../../d3/d8/client_8c.html#a154">GetKeyboardLayout</a>(0))
06113     {
06114         <span class="keywordflow">if</span> ((hkl == *phklActive) || <a class="code" href="../../d6/d2/output_8c.html#a90">IsNotBiDILayout</a>(hkl)) {
06115             *phklActive = hkl;
06116             <span class="keywordflow">break</span>;
06117         }
06118         <a class="code" href="../../d3/d0/user32_8def.html#a45">ActivateKeyboardLayout</a>((HKL)HKL_NEXT, 0);
06119     }
06120 }
06121 
06122 <span class="preprocessor">#if defined(FE_SB)</span>
06123 <span class="preprocessor"></span>
06124 <span class="preprocessor">#define WWSB_NOFE</span>
06125 <span class="preprocessor"></span><span class="preprocessor">#include "<a class="code" href="../../d8/d2/__output_8h.html">_output.h</a>"</span>
06126 <span class="preprocessor">#undef  WWSB_NOFE</span>
06127 <span class="preprocessor"></span><span class="preprocessor">#define WWSB_FE</span>
06128 <span class="preprocessor"></span><span class="preprocessor">#include "<a class="code" href="../../d8/d2/__output_8h.html">_output.h</a>"</span>
06129 <span class="preprocessor">#undef  WWSB_FE</span>
06130 <span class="preprocessor"></span>
06131 <span class="preprocessor">#endif  // FE_SB</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:07 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
