<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: obref.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>obref.c File Reference</h1><code>#include "<a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>"</code><br>
<code>#include "<a class="el" href="../../d1/d6/lpcp_8h-source.html">..\lpc\lpcp.h</a>"</code><br>

<p>
<a href="../../d8/d0/obref_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d1/obref_8c.html#a1">ObGetObjectPointerCount</a> (IN PVOID Object)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d1/obref_8c.html#a2">ObOpenObjectByName</a> (IN POBJECT_ATTRIBUTES <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a1">ObjectAttributes</a>, IN <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType OPTIONAL, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> AccessMode, IN OUT <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState OPTIONAL, IN ACCESS_MASK DesiredAccess OPTIONAL, IN OUT PVOID ParseContext OPTIONAL, OUT PHANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d1/obref_8c.html#a3">ObOpenObjectByPointer</a> (IN PVOID Object, IN ULONG HandleAttributes, IN <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> PassedAccessState OPTIONAL, IN ACCESS_MASK DesiredAccess, IN <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> AccessMode, OUT PHANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a> (IN HANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>, IN ACCESS_MASK DesiredAccess, IN <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType OPTIONAL, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> AccessMode, OUT PVOID *Object, OUT <a class="el" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html">POBJECT_HANDLE_INFORMATION</a> HandleInformation OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d1/obref_8c.html#a5">ObReferenceObjectByName</a> (IN PUNICODE_STRING ObjectName, IN ULONG Attributes, IN <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState OPTIONAL, IN ACCESS_MASK DesiredAccess OPTIONAL, IN <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> AccessMode, IN OUT PVOID ParseContext OPTIONAL, OUT PVOID *Object)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d1/obref_8c.html#a6">ObReferenceObjectByPointer</a> (IN PVOID Object, IN ACCESS_MASK DesiredAccess, IN <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> AccessMode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d1/obref_8c.html#a7">ObfReferenceObject</a> (IN PVOID Object)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d1/obref_8c.html#a8">ObfDereferenceObject</a> (IN PVOID Object)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d1/obref_8c.html#a9">ObpProcessRemoveObjectQueue</a> (PVOID Parameter)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d1/obref_8c.html#a10">ObpRemoveObjectRoutine</a> (PVOID Object)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d1/obref_8c.html#a11">ObpDeleteNameCheck</a> (IN PVOID Object, IN BOOLEAN TypeMutexHeld)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d1/obref_8c.html#a12">ObDereferenceObject</a> (IN PVOID Object)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d1/obref_8c.html#a0">ObpRemoveQueueActive</a></td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a12" doxytag="obref.c::ObDereferenceObject" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ObDereferenceObject           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Object</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/obref_8c-source.html#l01679">1679</a> of file <a class="el" href="../../d8/d0/obref_8c-source.html">obref.c</a>.
<p>
References <a class="el" href="../../d8/d0/obref_8c-source.html#l01124">ObfDereferenceObject()</a>.
<p>
<pre class="fragment"><div>01685                    :
01686 
01687     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> really just a thunk <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Obf version of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dereference
01688     routine
01689 
01690 Arguments:
01691 
01692     Object - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> body of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object being dereferenced
01693 
01694 Return Value:
01695 
01696     None.
01697 
01698 --*/
01699 
01700 {
01701     <a class="code" href="../../d7/d1/obref_8c.html#a8">ObfDereferenceObject</a> (Object) ;
01702 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="obref.c::ObfDereferenceObject" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL ObfDereferenceObject           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Object</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/obref_8c-source.html#l01124">1124</a> of file <a class="el" href="../../d8/d0/obref_8c-source.html">obref.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d8/ex_8h.html#a332a205">CriticalWorkQueue</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01961">ExInitializeWorkItem</a>, <a class="el" href="../../d2/d8/worker_8c-source.html#l00375">ExQueueWorkItem()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00106">_LPCP_PORT_OBJECT::Flags</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00299">_OBJECT_HEADER::HandleCount</a>, <a class="el" href="../../d1/d6/lpcp_8h-source.html#l00093">LpcpAcquireLpcpLock</a>, <a class="el" href="../../d0/d8/ntos_8h-source.html#l00091">LpcPortObjectType</a>, <a class="el" href="../../d1/d6/lpcp_8h-source.html#l00108">LpcpReleaseLpcpLock</a>, <a class="el" href="../../d0/d8/ntos_8h-source.html#l00092">LpcWaitablePortObjectType</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00368">OBJECT_HEADER_TO_NAME_INFO</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00355">OBJECT_TO_OBJECT_HEADER</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00145">ObpDecrPointerCountWithResult</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00087">ObpLock</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l01299">ObpProcessRemoveObjectQueue()</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00090">ObpRemoveObjectQueue</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l01370">ObpRemoveObjectRoutine()</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00089">ObpRemoveObjectWorkItem</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00027">ObpRemoveQueueActive</a>, <a class="el" href="../../d2/d2/ppcdef_8h-source.html#l00079">PASSIVE_LEVEL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00173">_OBJECT_TYPE_INITIALIZER::PoolType</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00138">PORT_DELETED</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00300">_OBJECT_HEADER::SEntry</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00302">_OBJECT_HEADER::Type</a>, and <a class="el" href="../../d5/d9/ob_8h-source.html#l00196">_OBJECT_TYPE::TypeInfo</a>.
<p>
Referenced by <a class="el" href="../../d8/d0/obref_8c-source.html#l01679">ObDereferenceObject()</a>.
<p>
<pre class="fragment"><div>01130                    :
01131 
01132     This routine decrments <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> refernce count of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified object and
01133     does whatever cleanup there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> count goes to zero.
01134 
01135 Arguments:
01136 
01137     Object - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> body of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object being dereferenced
01138 
01139 Return Value:
01140 
01141     None.
01142 
01143 --*/
01144 
01145 {
01146     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
01147     <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType;
01148     KIRQL OldIrql;
01149     BOOLEAN StartWorkerThread;
01150 
01151     <a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html">PLPCP_PORT_OBJECT</a> Port = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01152 
01153 <span class="preprocessor">#if DBG</span>
01154 <span class="preprocessor"></span>
01155     <a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html">POBJECT_HEADER_NAME_INFO</a> NameInfo;
01156 
01157 <span class="preprocessor">#endif</span>
01158 <span class="preprocessor"></span>
01159     <span class="comment">//</span>
01160     <span class="comment">//  Translate a pointer to the object body to a pointer to the object</span>
01161     <span class="comment">//  header.</span>
01162     <span class="comment">//</span>
01163 
01164     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object );
01165 
01166 <span class="preprocessor">#if DBG</span>
01167 <span class="preprocessor"></span>
01168     NameInfo = <a class="code" href="../../d4/d0/ob_8h.html#a12">OBJECT_HEADER_TO_NAME_INFO</a>( ObjectHeader );
01169 
01170     <span class="keywordflow">if</span> (NameInfo) {
01171 
01172        InterlockedDecrement(&amp;NameInfo-&gt;DbgDereferenceCount) ;
01173     }
01174 
01175 <span class="preprocessor">#endif</span>
01176 <span class="preprocessor"></span>
01177 
01178     <span class="comment">//</span>
01179     <span class="comment">//  Decrement the point count and if the result is now then</span>
01180     <span class="comment">//  there is extra work to do</span>
01181     <span class="comment">//</span>
01182 
01183     ObjectType = ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>;
01184 
01185     <span class="keywordflow">if</span> ( (ObjectType == <a class="code" href="../../d9/d8/ntos_8h.html#a5">LpcPortObjectType</a>) ||
01186          (ObjectType == <a class="code" href="../../d9/d8/ntos_8h.html#a6">LpcWaitablePortObjectType</a>) ) {
01187 
01188         Port = Object;
01189         <a class="code" href="../../d0/d7/lpcp_8h.html#a3">LpcpAcquireLpcpLock</a>();
01190     }
01191 
01192     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/obp_8h.html#a5">ObpDecrPointerCountWithResult</a>( ObjectHeader )) {
01193 
01194         <span class="comment">//</span>
01195         <span class="comment">//  Find out the level we're at and the object type</span>
01196         <span class="comment">//</span>
01197 
01198         OldIrql = KeGetCurrentIrql();
01199 
01200         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o1">HandleCount</a> == 0);
01201 
01202 
01203         <span class="keywordflow">if</span> (Port != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01204 
01205             Port-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o1">Flags</a> |= <a class="code" href="../../d2/d6/lpc_8h.html#a11">PORT_DELETED</a>;
01206             Port = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01207 
01208             <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
01209         }
01210 
01211 
01212         <span class="comment">//</span>
01213         <span class="comment">//  If we're at the passive level then go ahead and delete the</span>
01214         <span class="comment">//  object now.  Or if we're at APC level and object say's we're</span>
01215         <span class="comment">//  allocated out of paged pool then also go ahead and delete</span>
01216         <span class="comment">//  the object right now.</span>
01217         <span class="comment">//</span>
01218 
01219         <span class="keywordflow">if</span> ((OldIrql == <a class="code" href="../../d1/d3/ppcdef_8h.html#a21">PASSIVE_LEVEL</a>) ||
01220             ((OldIrql == <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>) &amp;&amp;
01221              ((ObjectType != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o9">PoolType</a> != <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>)))) {
01222 
01223 
01224                 <a class="code" href="../../d7/d1/obref_8c.html#a10">ObpRemoveObjectRoutine</a>( Object );
01225 
01226                 <span class="keywordflow">return</span>;    
01227 
01228         } <span class="keywordflow">else</span> {
01229 
01230             <span class="comment">//</span>
01231             <span class="comment">//  Objects can't be deleted from an IRQL above APC_LEVEL.</span>
01232             <span class="comment">//  Nonpaged objects can't be deleted from APC_LEVEL.</span>
01233             <span class="comment">//  So queue the delete operation.</span>
01234             <span class="comment">//</span>
01235 
01236             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a> == NULL) || (ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o9">PoolType</a> == NonPagedPool));
01237 
01238             <span class="comment">//</span>
01239             <span class="comment">//  Lock the work queue, enqueue the new work item, and if the</span>
01240             <span class="comment">//  work queue is not active then make it active, indicate that</span>
01241             <span class="comment">//  we need to start the worker thread, and unlock the work</span>
01242             <span class="comment">//  queue.</span>
01243             <span class="comment">//</span>
01244 
01245             ExAcquireSpinLock( &amp;ObpLock, &amp;OldIrql );
01246 
01247             PushEntryList((PSINGLE_LIST_ENTRY)&amp;ObpRemoveObjectQueue, (PSINGLE_LIST_ENTRY)&amp;ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o2">SEntry</a> );
01248 
01249             <span class="keywordflow">if</span> (!<a class="code" href="../../d7/d1/obref_8c.html#a0">ObpRemoveQueueActive</a>) {
01250 
01251                 <a class="code" href="../../d7/d1/obref_8c.html#a0">ObpRemoveQueueActive</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01252                 StartWorkerThread = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01253 
01254             } <span class="keywordflow">else</span> {
01255 
01256                 StartWorkerThread = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01257             }
01258 
01259 <span class="preprocessor">#if 0</span>
01260 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (StartWorkerThread) {
01261 
01262                 KdPrint(( <span class="stringliteral">"OB: %08x Starting ObpProcessRemoveObjectQueue thread.\n"</span>, Object ));
01263 
01264             } <span class="keywordflow">else</span> {
01265 
01266                 KdPrint(( <span class="stringliteral">"OB: %08x Queued to ObpProcessRemoveObjectQueue thread.\n"</span>, Object ));
01267             }
01268 
01269 <span class="preprocessor">#endif  // 1</span>
01270 <span class="preprocessor"></span>
01271             ExReleaseSpinLock( &amp;ObpLock, OldIrql );
01272 
01273             <span class="comment">//</span>
01274             <span class="comment">//  If we have to start the worker thread then go ahead</span>
01275             <span class="comment">//  and enqueue the work item</span>
01276             <span class="comment">//</span>
01277 
01278             <span class="keywordflow">if</span> (StartWorkerThread) {
01279 
01280                 <a class="code" href="../../d5/d8/ex_8h.html#a55">ExInitializeWorkItem</a>( &amp;ObpRemoveObjectWorkItem,
01281                                       ObpProcessRemoveObjectQueue,
01282                                       NULL );
01283 
01284                 <a class="code" href="../../d5/d8/ex_8h.html#a261">ExQueueWorkItem</a>( &amp;ObpRemoveObjectWorkItem, CriticalWorkQueue );
01285             }
01286         }
01287     }
01288 
01289     <span class="keywordflow">if</span> ( Port != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01290 
01291         <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
01292     }
01293 
01294     <span class="keywordflow">return</span>;
01295 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="obref.c::ObfReferenceObject" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL ObfReferenceObject           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Object</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/obref_8c-source.html#l01087">1087</a> of file <a class="el" href="../../d8/d0/obref_8c-source.html">obref.c</a>.
<p>
References <a class="el" href="../../d5/d9/ob_8h-source.html#l00355">OBJECT_TO_OBJECT_HEADER</a>, and <a class="el" href="../../d6/d0/obp_8h-source.html#l00143">ObpIncrPointerCount</a>.
<p>
<pre class="fragment"><div>01093                    :
01094 
01095     This function increments <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> reference count <span class="keywordflow">for</span> an object.
01096 
01097     N.B. This function should be used to increment <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> reference count
01098         when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> accessing mode <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> kernel or <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> objct <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> known.
01099 
01100 Arguments:
01101 
01102     Object - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object whose reference count <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
01103         incremented.
01104 
01105 Return Value:
01106 
01107     None.
01108 
01109 --*/
01110 
01111 {
01112     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
01113 
01114     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object );
01115 
01116     <a class="code" href="../../d5/d1/obp_8h.html#a3">ObpIncrPointerCount</a>( ObjectHeader );
01117 
01118     <span class="keywordflow">return</span>;
01119 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="obref.c::ObGetObjectPointerCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG ObGetObjectPointerCount           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Object</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/obref_8c-source.html#l00058">58</a> of file <a class="el" href="../../d8/d0/obref_8c-source.html">obref.c</a>.
<p>
References <a class="el" href="../../d5/d9/ob_8h-source.html#l00355">OBJECT_TO_OBJECT_HEADER</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d2/d0/psjob_8c-source.html#l02396">PsEnforceExecutionTimeLimits()</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l02210">PspApplyJobLimitsToProcessSet()</a>, and <a class="el" href="../../d2/d0/psjob_8c-source.html#l02570">PspTerminateAllProcessesInJob()</a>.
<p>
<pre class="fragment"><div>00064                    :
00065 
00066     This routine returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current pointer count <span class="keywordflow">for</span> a specified object.
00067 
00068 Arguments:
00069 
00070     Object - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object whose pointer count <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be returned.
00071 
00072 Return Value:
00073 
00074     The current pointer count <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00075 
00076 Note:
00077 
00078     This function cannot be <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> a macro, since fields in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread object
00079     <a class="code" href="../../d7/d4/conexts_8c.html#a1">move</a> from release to release, so <span class="keyword">this</span> must remain a full function.
00080 
00081 --*/
00082 
00083 {
00084     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00085 
00086     <span class="comment">//</span>
00087     <span class="comment">//  Simply return the current pointer count for the object.</span>
00088     <span class="comment">//</span>
00089 
00090     <span class="keywordflow">return</span> <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object )-&gt;PointerCount;
00091 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="obref.c::ObOpenObjectByName" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ObOpenObjectByName           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN POBJECT_ATTRIBUTES&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectAttributes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK DesiredAccess&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PVOID ParseContext&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Handle</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/obref_8c-source.html#l00095">95</a> of file <a class="el" href="../../d8/d0/obref_8c-source.html">obref.c</a>.
<p>
References <a class="el" href="../../d5/d9/ob_8h-source.html#l00284">_OBJECT_CREATE_INFORMATION::Attributes</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00306">_OBJECT_HEADER::Flags</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00167">_OBJECT_TYPE_INITIALIZER::InvalidAttributes</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00347">OB_FLAG_NEW_OBJECT</a>, <a class="el" href="../../d4/d0/ob_8h.html#a21">OB_OPEN_REASON</a>, <a class="el" href="../../d4/d0/ob_8h.html#a100a58">ObCreateHandle</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00355">OBJECT_TO_OBJECT_HEADER</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00308">_OBJECT_HEADER::ObjectCreateInfo</a>, <a class="el" href="../../d4/d0/ob_8h.html#a100a59">ObOpenHandle</a>, <a class="el" href="../../d5/d1/obp_8h.html#a58">ObpCaptureObjectCreateInformation()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l02160">ObpCreateHandle()</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00431">ObpFreeObjectCreateInformation</a>, <a class="el" href="../../d5/d1/obp_8h.html#a61">ObpFreeObjectNameBuffer()</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00202">ObpLeaveRootDirectoryMutex</a>, <a class="el" href="../../d9/d9/obdir_8c-source.html#l01081">ObpLookupObjectName()</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00436">ObpReleaseObjectCreateInformation</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l01886">ObpValidateAccessMask()</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00071">ObpValidateIrql</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00285">_OBJECT_CREATE_INFORMATION::RootDirectory</a>, <a class="el" href="../../d3/d4/seastate_8c-source.html#l00180">SeCreateAccessState()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00291">_OBJECT_CREATE_INFORMATION::SecurityDescriptor</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00292">_OBJECT_CREATE_INFORMATION::SecurityQos</a>, <a class="el" href="../../d3/d4/seastate_8c-source.html#l00348">SeDeleteAccessState()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00302">_OBJECT_HEADER::Type</a>, and <a class="el" href="../../d5/d9/ob_8h-source.html#l00196">_OBJECT_TYPE::TypeInfo</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/winsta_8c-source.html#l01019">_OpenWindowStation()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l04234">CmpCreatePredefined()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01421">CmpLinkHiveToMaster()</a>, <a class="el" href="../../d3/d3/ex_2callback_8c-source.html#l00222">ExCreateCallback()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l04502">IoCreateFile()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06463">IoFastQueryNetworkAttributes()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l03200">IopLoadDriver()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03686">IopReferenceDriverObjectByName()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00166">NtCreateKey()</a>, <a class="el" href="../../d2/d9/io_2misc_8c-source.html#l00298">NtDeleteFile()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01319">NtNotifyChangeMultipleKeys()</a>, <a class="el" href="../../d9/d9/obdir_8c-source.html#l00144">NtOpenDirectoryObject()</a>, <a class="el" href="../../d1/d7/ex_2event_8c-source.html#l00313">NtOpenEvent()</a>, <a class="el" href="../../d4/d7/eventpr_8c-source.html#l00251">NtOpenEventPair()</a>, <a class="el" href="../../d6/d3/complete_8c-source.html#l00178">NtOpenIoCompletion()</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l00188">NtOpenJobObject()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01870">NtOpenKey()</a>, <a class="el" href="../../d3/d4/mutant_8c-source.html#l00280">NtOpenMutant()</a>, <a class="el" href="../../d8/d0/psopen_8c-source.html#l00030">NtOpenProcess()</a>, <a class="el" href="../../d1/d7/creasect_8c-source.html#l04250">NtOpenSection()</a>, <a class="el" href="../../d3/d5/semphore_8c-source.html#l00260">NtOpenSemaphore()</a>, <a class="el" href="../../d2/d7/super_8c-source.html#l00237">NtOpenSuperSection()</a>, <a class="el" href="../../d5/d0/oblink_8c-source.html#l00247">NtOpenSymbolicLinkObject()</a>, <a class="el" href="../../d8/d0/psopen_8c-source.html#l00280">NtOpenThread()</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00581">NtOpenTimer()</a>, <a class="el" href="../../d2/d9/io_2misc_8c-source.html#l00629">NtQueryAttributesFile()</a>, <a class="el" href="../../d2/d9/io_2misc_8c-source.html#l00745">NtQueryFullAttributesFile()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l04090">NtQueryOpenSubKeys()</a>, <a class="el" href="../../d9/d3/loadunld_8c-source.html#l00244">NtUnloadDriver()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03093">NtUnloadKey()</a>, <a class="el" href="../../d4/d2/tob_8c-source.html#l00187">obtest()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l01797">xxxCreateDesktop()</a>, and <a class="el" href="../../d0/d6/desktop_8c-source.html#l03265">xxxOpenDesktop()</a>.
<p>
<pre class="fragment"><div>00107                    :
00108 
00109 
00110     This function opens an object with full access validation and auditing.
00111     Soon after entering we capture <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SubjectContext <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller. This
00112     context must remain captured until auditing <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> complete, and passed to
00113     any routine that may have to <span class="keywordflow">do</span> access checking or auditing.
00114 
00115 Arguments:
00116 
00117     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object attributes.
00118 
00119     ObjectType - Supplies an optional pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> descriptor.
00120 
00121     AccessMode - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> processor mode of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access.
00122 
00123     AccessState - Supplies an optional pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current access status
00124         describing already granted access types, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> privileges used to get
00125         them, and any access types yet to be granted.
00126 
00127     DesiredAcess - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.
00128 
00129     ParseContext - Supplies an optional pointer to parse context.
00130 
00131     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> - Supplies a pointer to a variable that receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle value.
00132 
00133 Return Value:
00134 
00135     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> successfully opened, then a handle <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00136     created and a success status <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned. Otherwise, an error status <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00137     returned.
00138 
00139 --*/
00140 
00141 {
00142     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00143     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> HandleStatus;
00144     PVOID ExistingObject;
00145     HANDLE NewHandle;
00146     BOOLEAN DirectoryLocked;
00147     <a class="code" href="../../d4/d0/ob_8h.html#a21">OB_OPEN_REASON</a> OpenReason;
00148     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
00149     <a class="code" href="../../d7/d4/struct__OBJECT__CREATE__INFORMATION.html">OBJECT_CREATE_INFORMATION</a> ObjectCreateInfo;
00150     UNICODE_STRING CapturedObjectName;
00151     <a class="code" href="../../d2/d5/struct__ACCESS__STATE.html">ACCESS_STATE</a> LocalAccessState;
00152     <a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html">AUX_ACCESS_DATA</a> AuxData;
00153     PGENERIC_MAPPING GenericMapping;
00154 
00155     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00156 
00157     <a class="code" href="../../d5/d1/obp_8h.html#a2">ObpValidateIrql</a>(<span class="stringliteral">"ObOpenObjectByName"</span>);
00158 
00159     <span class="comment">//</span>
00160     <span class="comment">//  If the object attributes are not specified, then return an error.</span>
00161     <span class="comment">//</span>
00162 
00163     *<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00164 
00165     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT(ObjectAttributes)) {
00166 
00167         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00168 
00169     } <span class="keywordflow">else</span> {
00170 
00171         <span class="comment">//</span>
00172         <span class="comment">//  Capture the object creation information.</span>
00173         <span class="comment">//</span>
00174 
00175         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d1/obp_8h.html#a58">ObpCaptureObjectCreateInformation</a>( ObjectType,
00176                                                     AccessMode,
00177                                                     ObjectAttributes,
00178                                                     &amp;CapturedObjectName,
00179                                                     &amp;ObjectCreateInfo,
00180                                                     TRUE );
00181 
00182         <span class="comment">//</span>
00183         <span class="comment">//  If the object creation information is successfully captured,</span>
00184         <span class="comment">//  then generate the access state.</span>
00185         <span class="comment">//</span>
00186 
00187         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00188 
00189             <span class="keywordflow">if</span> (!ARGUMENT_PRESENT(AccessState)) {
00190 
00191                 <span class="comment">//</span>
00192                 <span class="comment">//  If an object type descriptor is specified, then use</span>
00193                 <span class="comment">//  associated generic mapping. Otherwise, use no generic</span>
00194                 <span class="comment">//  mapping.</span>
00195                 <span class="comment">//</span>
00196 
00197                 GenericMapping = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00198 
00199                 <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ObjectType)) {
00200 
00201                     GenericMapping = &amp;ObjectType-&gt;TypeInfo.GenericMapping;
00202                 }
00203 
00204                 AccessState = &amp;LocalAccessState;
00205 
00206                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/seastate_8c.html#a2">SeCreateAccessState</a>( &amp;LocalAccessState,
00207                                               &amp;AuxData,
00208                                               DesiredAccess,
00209                                               GenericMapping );
00210 
00211                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00212 
00213                     <span class="keywordflow">goto</span> FreeCreateInfo;
00214                 }
00215             }
00216 
00217             <span class="comment">//</span>
00218             <span class="comment">//  If there is a security descriptor specified in the object</span>
00219             <span class="comment">//  attributes, then capture it in the access state.</span>
00220             <span class="comment">//</span>
00221 
00222             <span class="keywordflow">if</span> (ObjectCreateInfo.<a class="code" href="../../d7/d4/struct__OBJECT__CREATE__INFORMATION.html#o7">SecurityDescriptor</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00223 
00224                 AccessState-&gt;SecurityDescriptor = ObjectCreateInfo.<a class="code" href="../../d7/d4/struct__OBJECT__CREATE__INFORMATION.html#o7">SecurityDescriptor</a>;
00225             }
00226 
00227             <span class="comment">//</span>
00228             <span class="comment">//  Validate the access state.</span>
00229             <span class="comment">//</span>
00230 
00231             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/obse_8c.html#a14">ObpValidateAccessMask</a>(AccessState);
00232 
00233             <span class="comment">//</span>
00234             <span class="comment">//  If the access state is valid, then lookup the object by</span>
00235             <span class="comment">//  name.</span>
00236             <span class="comment">//</span>
00237 
00238             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00239 
00240                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d1/obp_8h.html#a71">ObpLookupObjectName</a>( ObjectCreateInfo.<a class="code" href="../../d7/d4/struct__OBJECT__CREATE__INFORMATION.html#o1">RootDirectory</a>,
00241                                               &amp;CapturedObjectName,
00242                                               ObjectCreateInfo.<a class="code" href="../../d7/d4/struct__OBJECT__CREATE__INFORMATION.html#o0">Attributes</a>,
00243                                               ObjectType,
00244                                               AccessMode,
00245                                               ParseContext,
00246                                               ObjectCreateInfo.<a class="code" href="../../d7/d4/struct__OBJECT__CREATE__INFORMATION.html#o8">SecurityQos</a>,
00247                                               NULL,
00248                                               AccessState,
00249                                               &amp;DirectoryLocked,
00250                                               &amp;ExistingObject );
00251 
00252                 <span class="comment">//</span>
00253                 <span class="comment">//  If the object was successfully looked up, then attempt</span>
00254                 <span class="comment">//  to create or open a handle.</span>
00255                 <span class="comment">//</span>
00256 
00257                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00258 
00259                     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>(ExistingObject);
00260 
00261                     <span class="comment">//</span>
00262                     <span class="comment">//  If the object is being created, then the operation</span>
00263                     <span class="comment">//  must be a open-if operation. Otherwise, a handle to</span>
00264                     <span class="comment">//  an object is being opened.</span>
00265                     <span class="comment">//</span>
00266 
00267                     <span class="keywordflow">if</span> (ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o7">Flags</a> &amp; <a class="code" href="../../d4/d0/ob_8h.html#a1">OB_FLAG_NEW_OBJECT</a>) {
00268 
00269                         OpenReason = <a class="code" href="../../d4/d0/ob_8h.html#a100a58">ObCreateHandle</a>;
00270 
00271                         <span class="keywordflow">if</span> (ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o8">ObjectCreateInfo</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00272 
00273                             <a class="code" href="../../d5/d1/obp_8h.html#a29">ObpFreeObjectCreateInformation</a>(ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o8">ObjectCreateInfo</a>);
00274                             ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o8">ObjectCreateInfo</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00275                         }
00276 
00277                     } <span class="keywordflow">else</span> {
00278 
00279                         OpenReason = <a class="code" href="../../d4/d0/ob_8h.html#a100a59">ObOpenHandle</a>;
00280                     }
00281 
00282                     <span class="comment">//</span>
00283                     <span class="comment">//  If any of the object attributes are invalid, then</span>
00284                     <span class="comment">//  return an error status.</span>
00285                     <span class="comment">//</span>
00286 
00287                     <span class="keywordflow">if</span> (ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o3">InvalidAttributes</a> &amp; ObjectCreateInfo.<a class="code" href="../../d7/d4/struct__OBJECT__CREATE__INFORMATION.html#o0">Attributes</a>) {
00288 
00289                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00290 
00291                         <span class="keywordflow">if</span> (DirectoryLocked) {
00292 
00293                             <a class="code" href="../../d5/d1/obp_8h.html#a11">ObpLeaveRootDirectoryMutex</a>();
00294                         }
00295 
00296                     } <span class="keywordflow">else</span> {
00297 
00298                         <span class="comment">//</span>
00299                         <span class="comment">//  The status returned by the object lookup routine</span>
00300                         <span class="comment">//  must be returned if the creation of a handle is</span>
00301                         <span class="comment">//  successful. Otherwise, the handle creation status</span>
00302                         <span class="comment">//  is returned.</span>
00303                         <span class="comment">//</span>
00304 
00305                         HandleStatus = <a class="code" href="../../d5/d1/obp_8h.html#a79">ObpCreateHandle</a>( OpenReason,
00306                                                         ExistingObject,
00307                                                         ObjectType,
00308                                                         AccessState,
00309                                                         0,
00310                                                         ObjectCreateInfo.<a class="code" href="../../d7/d4/struct__OBJECT__CREATE__INFORMATION.html#o0">Attributes</a>,
00311                                                         DirectoryLocked,
00312                                                         AccessMode,
00313                                                         (PVOID *)NULL,
00314                                                         &amp;NewHandle );
00315 
00316                         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(HandleStatus)) {
00317 
00318                             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(ExistingObject);
00319 
00320                             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = HandleStatus;
00321 
00322                         } <span class="keywordflow">else</span> {
00323 
00324                             *<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = NewHandle;
00325                         }
00326                     }
00327 
00328                 } <span class="keywordflow">else</span> {
00329 
00330                     <span class="keywordflow">if</span> (DirectoryLocked) {
00331 
00332                         <a class="code" href="../../d5/d1/obp_8h.html#a11">ObpLeaveRootDirectoryMutex</a>();
00333                     }
00334                 }
00335             }
00336 
00337             <span class="comment">//</span>
00338             <span class="comment">//  If the access state was generated, then delete the access</span>
00339             <span class="comment">//  state.</span>
00340             <span class="comment">//</span>
00341 
00342             <span class="keywordflow">if</span> (AccessState == &amp;LocalAccessState) {
00343 
00344                 <a class="code" href="../../d2/d5/seastate_8c.html#a3">SeDeleteAccessState</a>(AccessState);
00345             }
00346 
00347             <span class="comment">//</span>
00348             <span class="comment">//  Free the create information.</span>
00349             <span class="comment">//</span>
00350 
00351         FreeCreateInfo:
00352 
00353             <a class="code" href="../../d5/d1/obp_8h.html#a30">ObpReleaseObjectCreateInformation</a>(&amp;ObjectCreateInfo);
00354 
00355             <span class="keywordflow">if</span> (CapturedObjectName.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00356 
00357                 <a class="code" href="../../d5/d1/obp_8h.html#a61">ObpFreeObjectNameBuffer</a>(&amp;CapturedObjectName);
00358             }
00359         }
00360     }
00361 
00362     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00363 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="obref.c::ObOpenObjectByPointer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ObOpenObjectByPointer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>HandleAttributes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> PassedAccessState&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Handle</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/obref_8c-source.html#l00367">367</a> of file <a class="el" href="../../d8/d0/obref_8c-source.html">obref.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00168">_OBJECT_TYPE_INITIALIZER::GenericMapping</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00167">_OBJECT_TYPE_INITIALIZER::InvalidAttributes</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00355">OBJECT_TO_OBJECT_HEADER</a>, <a class="el" href="../../d4/d0/ob_8h.html#a100a59">ObOpenHandle</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l02160">ObpCreateHandle()</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00071">ObpValidateIrql</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l01022">ObReferenceObjectByPointer()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d4/seastate_8c-source.html#l00180">SeCreateAccessState()</a>, <a class="el" href="../../d3/d4/seastate_8c-source.html#l00348">SeDeleteAccessState()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00302">_OBJECT_HEADER::Type</a>, and <a class="el" href="../../d5/d9/ob_8h-source.html#l00196">_OBJECT_TYPE::TypeInfo</a>.
<p>
Referenced by <a class="el" href="../../d5/d7/ex_8c-source.html#l00131">CreateSystemThread()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l04710">IopInvalidateVolumesForDevice()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00297">NtCreatePagingFile()</a>, <a class="el" href="../../d8/d0/psopen_8c-source.html#l00030">NtOpenProcess()</a>, <a class="el" href="../../d8/d2/tokenopn_8c-source.html#l00178">NtOpenProcessToken()</a>, <a class="el" href="../../d8/d0/psopen_8c-source.html#l00280">NtOpenThread()</a>, <a class="el" href="../../d8/d2/tokenopn_8c-source.html#l00458">NtOpenThreadToken()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l01235">NtUserOpenInputDesktop()</a>, <a class="el" href="../../d4/d2/tob_8c-source.html#l00187">obtest()</a>, <a class="el" href="../../d1/d0/base_8c-source.html#l00102">UserBeep()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l01654">xxxCreateDisconnectDesktop()</a>, <a class="el" href="../../d9/d7/winsta_8c-source.html#l00243">xxxCreateWindowStation()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l04821">xxxResolveDesktop()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l05713">xxxSetCsrssThreadDesktop()</a>, and <a class="el" href="../../d0/d6/desktop_8c-source.html#l03358">xxxSwitchDesktop()</a>.
<p>
<pre class="fragment"><div>00379                    :
00380 
00381     This routine opens an object referenced by a pointer.
00382 
00383 Arguments:
00384 
00385     Object - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object being opened.
00386 
00387     HandleAttributes - The desired attributes <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle, such
00388         as OBJ_INHERIT, OBJ_PERMANENT, OBJ_EXCLUSIVE, OBJ_CASE_INSENSITIVE,
00389         OBJ_OPENIF, and OBJ_OPENLINK
00390 
00391     PassedAccessState - Supplies an optional pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current access
00392         status describing already granted access types, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> privileges used
00393         to get them, and any access types yet to be granted.
00394 
00395     DesiredAcess - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.
00396 
00397     ObjectType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object being opened
00398 
00399     AccessMode - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> processor mode of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access.
00400 
00401     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> - Supplies a pointer to a variable that receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle value.
00402 
00403 Return Value:
00404 
00405     An appropriate <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> value
00406 
00407 --*/
00408 
00409 {
00410     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00411     HANDLE NewHandle;
00412     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
00413     <a class="code" href="../../d2/d5/struct__ACCESS__STATE.html">ACCESS_STATE</a> LocalAccessState;
00414     <a class="code" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00415     <a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html">AUX_ACCESS_DATA</a> AuxData;
00416 
00417     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00418 
00419     <a class="code" href="../../d5/d1/obp_8h.html#a2">ObpValidateIrql</a>( <span class="stringliteral">"ObOpenObjectByPointer"</span> );
00420 
00421     <span class="comment">//</span>
00422     <span class="comment">//  First increment the pointer count for the object.  This routine</span>
00423     <span class="comment">//  also checks the object types</span>
00424     <span class="comment">//</span>
00425 
00426     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a6">ObReferenceObjectByPointer</a>( Object,
00427                                          0,
00428                                          ObjectType,
00429                                          AccessMode );
00430 
00431     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00432 
00433         <span class="comment">//</span>
00434         <span class="comment">//  Get the object header for the input object body</span>
00435         <span class="comment">//</span>
00436 
00437         ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object );
00438 
00439         <span class="comment">//</span>
00440         <span class="comment">//  If the caller did not pass in an access state then</span>
00441         <span class="comment">//  we will create a new one based on the desired access</span>
00442         <span class="comment">//  and the object types generic mapping</span>
00443         <span class="comment">//</span>
00444 
00445         <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( PassedAccessState )) {
00446 
00447             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/seastate_8c.html#a2">SeCreateAccessState</a>( &amp;LocalAccessState,
00448                                           &amp;AuxData,
00449                                           DesiredAccess,
00450                                           &amp;ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a> );
00451 
00452             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00453 
00454                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Object );
00455 
00456                 <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00457             }
00458 
00459             AccessState = &amp;LocalAccessState;
00460 
00461         <span class="comment">//</span>
00462         <span class="comment">//  Otherwise the caller did specify an access state so</span>
00463         <span class="comment">//  we use the one passed in.</span>
00464         <span class="comment">//</span>
00465 
00466         } <span class="keywordflow">else</span> {
00467 
00468             AccessState = PassedAccessState;
00469         }
00470 
00471         <span class="comment">//</span>
00472         <span class="comment">//  Make sure the caller is asking for handle attributes that are</span>
00473         <span class="comment">//  valid for the given object type</span>
00474         <span class="comment">//</span>
00475 
00476         <span class="keywordflow">if</span> (ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o3">InvalidAttributes</a> &amp; HandleAttributes) {
00477 
00478             <span class="keywordflow">if</span> (AccessState == &amp;LocalAccessState) {
00479 
00480                 <a class="code" href="../../d2/d5/seastate_8c.html#a3">SeDeleteAccessState</a>( AccessState );
00481             }
00482 
00483             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Object );
00484 
00485             <span class="keywordflow">return</span>( STATUS_INVALID_PARAMETER );
00486         }
00487 
00488         <span class="comment">//</span>
00489         <span class="comment">//  We've referenced the object and have an access state to give</span>
00490         <span class="comment">//  the new handle so now create a new handle for the object.</span>
00491         <span class="comment">//</span>
00492 
00493         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d1/obp_8h.html#a79">ObpCreateHandle</a>( ObOpenHandle,
00494                                   Object,
00495                                   ObjectType,
00496                                   AccessState,
00497                                   0,
00498                                   HandleAttributes,
00499                                   FALSE,
00500                                   AccessMode,
00501                                   (PVOID *)NULL,
00502                                   &amp;NewHandle );
00503 
00504         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00505 
00506             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Object );
00507         }
00508     }
00509 
00510     <span class="comment">//</span>
00511     <span class="comment">//  If we successfully opened by object and created a new handle</span>
00512     <span class="comment">//  then set the output variable correctly</span>
00513     <span class="comment">//</span>
00514 
00515     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00516 
00517         *<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = NewHandle;
00518 
00519     } <span class="keywordflow">else</span> {
00520 
00521         *<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00522     }
00523 
00524     <span class="comment">//</span>
00525     <span class="comment">//  Check if we used our own access state and now need to cleanup</span>
00526     <span class="comment">//</span>
00527 
00528     <span class="keywordflow">if</span> (AccessState == &amp;LocalAccessState) {
00529 
00530         <a class="code" href="../../d2/d5/seastate_8c.html#a3">SeDeleteAccessState</a>( AccessState );
00531     }
00532 
00533     <span class="comment">//</span>
00534     <span class="comment">//  And return to our caller</span>
00535     <span class="comment">//</span>
00536 
00537     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00538 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="obref.c::ObpDeleteNameCheck" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ObpDeleteNameCheck           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>TypeMutexHeld</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/obref_8c-source.html#l01497">1497</a> of file <a class="el" href="../../d8/d0/obref_8c-source.html">obref.c</a>.
<p>
References <a class="el" href="../../d0/d5/se_8h.html#a200a110">DeleteSecurityDescriptor</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00331">_OBJECT_HEADER_NAME_INFO::Directory</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00306">_OBJECT_HEADER::Flags</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00299">_OBJECT_HEADER::HandleCount</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00332">_OBJECT_HEADER_NAME_INFO::Name</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00351">OB_FLAG_PERMANENT_OBJECT</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00368">OBJECT_HEADER_TO_NAME_INFO</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00355">OBJECT_TO_OBJECT_HEADER</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00056">ObpBeginTypeSpecificCallOut</a>, <a class="el" href="../../d9/d9/obdir_8c-source.html#l01009">ObpDeleteDirectoryEntry()</a>, <a class="el" href="../../d5/d0/oblink_8c-source.html#l00951">ObpDeleteSymbolicLinkName()</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00057">ObpEndTypeSpecificCallOut</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00163">ObpEnterObjectTypeMutex</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00189">ObpEnterRootDirectoryMutex</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00176">ObpLeaveObjectTypeMutex</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00202">ObpLeaveRootDirectoryMutex</a>, <a class="el" href="../../d9/d9/obdir_8c-source.html#l00705">ObpLookupDirectoryEntry()</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00368">ObpSymbolicLinkObjectType</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00071">ObpValidateIrql</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00173">_OBJECT_TYPE_INITIALIZER::PoolType</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00312">_OBJECT_HEADER::SecurityDescriptor</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00181">_OBJECT_TYPE_INITIALIZER::SecurityProcedure</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00170">_OBJECT_TYPE_INITIALIZER::SecurityRequired</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00302">_OBJECT_HEADER::Type</a>, and <a class="el" href="../../d5/d9/ob_8h-source.html#l00196">_OBJECT_TYPE::TypeInfo</a>.
<p>
Referenced by <a class="el" href="../../d2/d0/obinsert_8c-source.html#l00029">ObInsertObject()</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00484">ObMakeTemporaryObject()</a>, and <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01967">ObpDecrementHandleCount()</a>.
<p>
<pre class="fragment"><div>01504                    :
01505 
01506     This routine removes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of an object from its parent directory
01507 
01508 Arguments:
01509 
01510     Object - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object body whose name <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being checked
01511 
01512     TypeMutexHeld - Indicates <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lock on object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being held by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01513         caller
01514 
01515 Return Value:
01516 
01517     None.
01518 
01519 --*/
01520 
01521 {
01522     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
01523     <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType;
01524     <a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html">POBJECT_HEADER_NAME_INFO</a> NameInfo;
01525     PVOID DirObject;
01526 
01527     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01528 
01529     <a class="code" href="../../d5/d1/obp_8h.html#a2">ObpValidateIrql</a>( <span class="stringliteral">"ObpDeleteNameCheck"</span> );
01530 
01531     <span class="comment">//</span>
01532     <span class="comment">//  Translate the object body to an object header also get</span>
01533     <span class="comment">//  the object type and name info if present</span>
01534     <span class="comment">//</span>
01535 
01536     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object );
01537     NameInfo = <a class="code" href="../../d4/d0/ob_8h.html#a12">OBJECT_HEADER_TO_NAME_INFO</a>( ObjectHeader );
01538     ObjectType = ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>;
01539 
01540     <span class="comment">//</span>
01541     <span class="comment">//  If the lock is not held then get the lock now</span>
01542     <span class="comment">//</span>
01543 
01544     <span class="keywordflow">if</span> (!TypeMutexHeld) {
01545 
01546         <a class="code" href="../../d5/d1/obp_8h.html#a8">ObpEnterObjectTypeMutex</a>( ObjectType );
01547     }
01548 
01549     <span class="comment">//</span>
01550     <span class="comment">//  Make sure that the object has a zero handle count, has a non</span>
01551     <span class="comment">//  empty name buffer, and is not a permanent object</span>
01552     <span class="comment">//</span>
01553 
01554     <span class="keywordflow">if</span> ((ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o1">HandleCount</a> == 0) &amp;&amp;
01555         (NameInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01556         (NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.Length != 0) &amp;&amp;
01557         (!(ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o7">Flags</a> &amp; <a class="code" href="../../d4/d0/ob_8h.html#a5">OB_FLAG_PERMANENT_OBJECT</a>))) {
01558 
01559         <span class="comment">//</span>
01560         <span class="comment">//  Give up the lock on the object type and instead</span>
01561         <span class="comment">//  get the lock on the object directories</span>
01562         <span class="comment">//</span>
01563 
01564         <a class="code" href="../../d5/d1/obp_8h.html#a9">ObpLeaveObjectTypeMutex</a>( ObjectType );
01565         <a class="code" href="../../d5/d1/obp_8h.html#a10">ObpEnterRootDirectoryMutex</a>();
01566         DirObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01567 
01568         <span class="comment">//</span>
01569         <span class="comment">//  Check that the object we is still in the directory otherwise</span>
01570         <span class="comment">//  then is nothing for us to remove</span>
01571         <span class="comment">//</span>
01572 
01573         <span class="keywordflow">if</span> (Object == <a class="code" href="../../d5/d1/obp_8h.html#a68">ObpLookupDirectoryEntry</a>( NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o0">Directory</a>,
01574                                                &amp;NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>,
01575                                                0 )) {
01576 
01577             <span class="comment">//</span>
01578             <span class="comment">//  Now reacquire the lock on the object type and</span>
01579             <span class="comment">//  check check the handle count again.  If it is still</span>
01580             <span class="comment">//  zero then we can do the actual delete name operation</span>
01581             <span class="comment">//</span>
01582 
01583             <a class="code" href="../../d5/d1/obp_8h.html#a8">ObpEnterObjectTypeMutex</a>( ObjectType );
01584 
01585             <span class="keywordflow">if</span> (ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o1">HandleCount</a> == 0) {
01586 
01587                 KIRQL SaveIrql;
01588 
01589                 <span class="comment">//</span>
01590                 <span class="comment">//  Delete the directory entry </span>
01591                 <span class="comment">//</span>
01592                 
01593                 <a class="code" href="../../d5/d1/obp_8h.html#a70">ObpDeleteDirectoryEntry</a>( NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o0">Directory</a> );
01594                 
01595                 <span class="comment">//</span>
01596                 <span class="comment">//  If security is not required invoke the </span>
01597                 <span class="comment">//  security callback to delete the security descriptor</span>
01598                 <span class="comment">//</span>
01599                 
01600                 <span class="keywordflow">if</span> ( !ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o6">SecurityRequired</a> ) {
01601                     
01602                     <a class="code" href="../../d5/d1/obp_8h.html#a0">ObpBeginTypeSpecificCallOut</a>( SaveIrql );
01603 
01604                     (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o17">SecurityProcedure</a>)( Object,
01605                                                               <a class="code" href="../../d0/d5/se_8h.html#a200a110">DeleteSecurityDescriptor</a>,
01606                                                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01607                                                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01608                                                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01609                                                               &amp;ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o10">SecurityDescriptor</a>,
01610                                                               ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o9">PoolType</a>,
01611                                                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
01612 
01613                     <a class="code" href="../../d5/d1/obp_8h.html#a1">ObpEndTypeSpecificCallOut</a>( SaveIrql, <span class="stringliteral">"Security"</span>, ObjectType, Object );
01614                 }
01615                 
01616                 <span class="comment">//</span>
01617                 <span class="comment">//  If this is a symbolic link object then we also need to</span>
01618                 <span class="comment">//  delete the symbolic link</span>
01619                 <span class="comment">//</span>
01620 
01621                 <span class="keywordflow">if</span> (ObjectType == <a class="code" href="../../d5/d1/obp_8h.html#a43">ObpSymbolicLinkObjectType</a>) {
01622 
01623                     <a class="code" href="../../d5/d1/obp_8h.html#a67">ObpDeleteSymbolicLinkName</a>( (<a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html">POBJECT_SYMBOLIC_LINK</a>)Object );
01624                 }
01625 
01626                 <span class="comment">//</span>
01627                 <span class="comment">//  Free the name buffer and zero out the name data fields</span>
01628                 <span class="comment">//</span>
01629 
01630                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.Buffer );
01631 
01632                 NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01633                 NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.Length = 0;
01634                 NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.MaximumLength = 0;
01635 
01636                 DirObject = NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o0">Directory</a>;
01637                 NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o0">Directory</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01638             }
01639 
01640             <a class="code" href="../../d5/d1/obp_8h.html#a9">ObpLeaveObjectTypeMutex</a>( ObjectType );
01641         }
01642 
01643         <a class="code" href="../../d5/d1/obp_8h.html#a11">ObpLeaveRootDirectoryMutex</a>();
01644 
01645         <span class="comment">//</span>
01646         <span class="comment">//  If there is a directory object for the name then decrement</span>
01647         <span class="comment">//  its reference count for it and for the object</span>
01648         <span class="comment">//</span>
01649 
01650         <span class="keywordflow">if</span> (DirObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01651 
01652             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( DirObject );
01653             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Object );
01654         }
01655 
01656     } <span class="keywordflow">else</span> {
01657 
01658         <span class="comment">//</span>
01659         <span class="comment">//  Otherwise don't do any work but simply release the object type</span>
01660         <span class="comment">//  lock and return to our caller</span>
01661         <span class="comment">//</span>
01662 
01663         <a class="code" href="../../d5/d1/obp_8h.html#a9">ObpLeaveObjectTypeMutex</a>( ObjectType );
01664     }
01665 
01666     <span class="keywordflow">return</span>;
01667 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="obref.c::ObpProcessRemoveObjectQueue" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ObpProcessRemoveObjectQueue           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Parameter</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/obref_8c-source.html#l01299">1299</a> of file <a class="el" href="../../d8/d0/obref_8c-source.html">obref.c</a>.
<p>
References <a class="el" href="../../d5/d9/ob_8h-source.html#l00313">_OBJECT_HEADER::Body</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00087">ObpLock</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00090">ObpRemoveObjectQueue</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l01370">ObpRemoveObjectRoutine()</a>, and <a class="el" href="../../d8/d0/obref_8c-source.html#l00027">ObpRemoveQueueActive</a>.
<p>
Referenced by <a class="el" href="../../d8/d0/obref_8c-source.html#l01124">ObfDereferenceObject()</a>.
<p>
<pre class="fragment"><div>01305                    :
01306 
01307     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> work routine <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> remove object work queue.  Its
01308     job <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to remove and process items from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> remove object queue.
01309 
01310 Arguments:
01311 
01312     Parameter - Ignored
01313 
01314 Return Value:
01315 
01316     None.
01317 
01318 --*/
01319 
01320 {
01321     PSINGLE_LIST_ENTRY Entry;
01322     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
01323     KIRQL OldIrql;
01324 
01325     <span class="comment">//</span>
01326     <span class="comment">//  Lock the work queue this will keep the preceding routine</span>
01327     <span class="comment">//  from monkeying with the queue</span>
01328     <span class="comment">//</span>
01329 
01330     ExAcquireSpinLock( &amp;ObpLock, &amp;OldIrql );
01331 
01332     <span class="comment">//</span>
01333     <span class="comment">//  While there are items in our private remove object work queue</span>
01334     <span class="comment">//  then we remove each item, get back up to the object header,</span>
01335     <span class="comment">//  and delete the object.  The latter part done outside of the</span>
01336     <span class="comment">//  work queue lock</span>
01337     <span class="comment">//</span>
01338 
01339     Entry = PopEntryList( (PSINGLE_LIST_ENTRY)&amp;ObpRemoveObjectQueue );
01340 
01341     <span class="keywordflow">while</span> ( Entry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01342 
01343         ExReleaseSpinLock( &amp;ObpLock, OldIrql );
01344 
01345         ObjectHeader = CONTAINING_RECORD( Entry,
01346                                           <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">OBJECT_HEADER</a>,
01347                                           SEntry );
01348 
01349         <a class="code" href="../../d7/d1/obref_8c.html#a10">ObpRemoveObjectRoutine</a>( &amp;ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o11">Body</a> );
01350 
01351         ExAcquireSpinLock( &amp;ObpLock, &amp;OldIrql );
01352 
01353         Entry = PopEntryList((PSINGLE_LIST_ENTRY)&amp;ObpRemoveObjectQueue );
01354     }
01355 
01356     <span class="comment">//</span>
01357     <span class="comment">//  Indicate that we are now going inactive and then unlock</span>
01358     <span class="comment">//  the work queue</span>
01359     <span class="comment">//</span>
01360 
01361     <a class="code" href="../../d7/d1/obref_8c.html#a0">ObpRemoveQueueActive</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01362 
01363     ExReleaseSpinLock( &amp;ObpLock, OldIrql );
01364 
01365     <span class="keywordflow">return</span>;
01366 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="obref.c::ObpRemoveObjectRoutine" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ObpRemoveObjectRoutine           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Object</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/obref_8c-source.html#l01370">1370</a> of file <a class="el" href="../../d8/d0/obref_8c-source.html">obref.c</a>.
<p>
References <a class="el" href="../../d5/d9/ob_8h-source.html#l00179">_OBJECT_TYPE_INITIALIZER::DeleteProcedure</a>, <a class="el" href="../../d0/d5/se_8h.html#a200a110">DeleteSecurityDescriptor</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00332">_OBJECT_HEADER_NAME_INFO::Name</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00371">OBJECT_HEADER_TO_CREATOR_INFO</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00368">OBJECT_HEADER_TO_NAME_INFO</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00355">OBJECT_TO_OBJECT_HEADER</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00056">ObpBeginTypeSpecificCallOut</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00057">ObpEndTypeSpecificCallOut</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00163">ObpEnterObjectTypeMutex</a>, <a class="el" href="../../d7/d9/obcreate_8c-source.html#l01098">ObpFreeObject()</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00176">ObpLeaveObjectTypeMutex</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00071">ObpValidateIrql</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00312">_OBJECT_HEADER::SecurityDescriptor</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00181">_OBJECT_TYPE_INITIALIZER::SecurityProcedure</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00302">_OBJECT_HEADER::Type</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00196">_OBJECT_TYPE::TypeInfo</a>, and <a class="el" href="../../d5/d9/ob_8h-source.html#l00341">_OBJECT_HEADER_CREATOR_INFO::TypeList</a>.
<p>
Referenced by <a class="el" href="../../d8/d0/obref_8c-source.html#l01124">ObfDereferenceObject()</a>, and <a class="el" href="../../d8/d0/obref_8c-source.html#l01299">ObpProcessRemoveObjectQueue()</a>.
<p>
<pre class="fragment"><div>01376                    :
01377 
01378     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to <span class="keyword">delete</span> an object whose reference count has
01379     gone to zero.
01380 
01381 Arguments:
01382 
01383     Object - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> body of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object being deleted
01384 
01385 Return Value:
01386 
01387     None.
01388 
01389 --*/
01390 
01391 {
01392     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01393     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
01394     <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType;
01395     <a class="code" href="../../d7/d5/struct__OBJECT__HEADER__CREATOR__INFO.html">POBJECT_HEADER_CREATOR_INFO</a> CreatorInfo;
01396     <a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html">POBJECT_HEADER_NAME_INFO</a> NameInfo;
01397 
01398     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01399 
01400     <a class="code" href="../../d5/d1/obp_8h.html#a2">ObpValidateIrql</a>( <span class="stringliteral">"ObpRemoveObjectRoutine"</span> );
01401 
01402     <span class="comment">//</span>
01403     <span class="comment">//  Retrieve an object header from the object body, and also get</span>
01404     <span class="comment">//  the object type, creator and name info if available</span>
01405     <span class="comment">//</span>
01406 
01407     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object );
01408     ObjectType = ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>;
01409     CreatorInfo = <a class="code" href="../../d4/d0/ob_8h.html#a13">OBJECT_HEADER_TO_CREATOR_INFO</a>( ObjectHeader );
01410     NameInfo = <a class="code" href="../../d4/d0/ob_8h.html#a12">OBJECT_HEADER_TO_NAME_INFO</a>( ObjectHeader );
01411 
01412     <span class="comment">//</span>
01413     <span class="comment">//  Get exclusive access to the object type object</span>
01414     <span class="comment">//</span>
01415 
01416     <a class="code" href="../../d5/d1/obp_8h.html#a8">ObpEnterObjectTypeMutex</a>( ObjectType );
01417 
01418     <span class="comment">//</span>
01419     <span class="comment">//  If there is a creator info record and we are on the list</span>
01420     <span class="comment">//  for the object type then remove this object from the list</span>
01421     <span class="comment">//</span>
01422 
01423     <span class="keywordflow">if</span> (CreatorInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; !IsListEmpty( &amp;CreatorInfo-&gt;<a class="code" href="../../d7/d5/struct__OBJECT__HEADER__CREATOR__INFO.html#o0">TypeList</a> )) {
01424 
01425         RemoveEntryList( &amp;CreatorInfo-&gt;<a class="code" href="../../d7/d5/struct__OBJECT__HEADER__CREATOR__INFO.html#o0">TypeList</a> );
01426     }
01427 
01428     <span class="comment">//</span>
01429     <span class="comment">//  If there is a name info record and the name buffer is not null</span>
01430     <span class="comment">//  then free the buffer and zero out the name record</span>
01431     <span class="comment">//</span>
01432 
01433     <span class="keywordflow">if</span> (NameInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01434 
01435         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.Buffer );
01436 
01437         NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01438         NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.Length = 0;
01439         NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.MaximumLength = 0;
01440     }
01441 
01442     <span class="comment">//</span>
01443     <span class="comment">//  We are done with the object type object so we can now release it</span>
01444     <span class="comment">//</span>
01445 
01446     <a class="code" href="../../d5/d1/obp_8h.html#a9">ObpLeaveObjectTypeMutex</a>( ObjectType );
01447 
01448     <span class="comment">//</span>
01449     <span class="comment">//  Security descriptor deletion must precede the</span>
01450     <span class="comment">//  call to the object's DeleteProcedure.  Check if we have</span>
01451     <span class="comment">//  a security descriptor and if so then call the routine</span>
01452     <span class="comment">//  to delete the security descritpor.</span>
01453     <span class="comment">//</span>
01454 
01455     <span class="keywordflow">if</span> (ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o10">SecurityDescriptor</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01456 
01457         KIRQL SaveIrql;
01458 
01459         <a class="code" href="../../d5/d1/obp_8h.html#a0">ObpBeginTypeSpecificCallOut</a>( SaveIrql );
01460 
01461         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o17">SecurityProcedure</a>)( Object,
01462                                                            <a class="code" href="../../d0/d5/se_8h.html#a200a110">DeleteSecurityDescriptor</a>,
01463                                                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01464                                                            &amp;ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o10">SecurityDescriptor</a>,
01465                                                            0,
01466                                                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
01467 
01468         <a class="code" href="../../d5/d1/obp_8h.html#a1">ObpEndTypeSpecificCallOut</a>( SaveIrql, <span class="stringliteral">"Security"</span>, ObjectType, Object );
01469     }
01470 
01471     <span class="comment">//</span>
01472     <span class="comment">//  Now if there is a delete callback for the object type invoke</span>
01473     <span class="comment">//  the routine</span>
01474     <span class="comment">//</span>
01475 
01476     <span class="keywordflow">if</span> (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o15">DeleteProcedure</a>) {
01477 
01478         KIRQL SaveIrql;
01479 
01480         <a class="code" href="../../d5/d1/obp_8h.html#a0">ObpBeginTypeSpecificCallOut</a>( SaveIrql );
01481 
01482         (*(ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o15">DeleteProcedure</a>))( Object );
01483 
01484         <a class="code" href="../../d5/d1/obp_8h.html#a1">ObpEndTypeSpecificCallOut</a>( SaveIrql, <span class="stringliteral">"Delete"</span>, ObjectType, Object );
01485     }
01486 
01487     <span class="comment">//</span>
01488     <span class="comment">//  Finally return the object back to pool including releasing any quota</span>
01489     <span class="comment">//  charges</span>
01490     <span class="comment">//</span>
01491 
01492     <a class="code" href="../../d5/d1/obp_8h.html#a63">ObpFreeObject</a>( Object );
01493 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="obref.c::ObReferenceObjectByHandle" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ObReferenceObjectByHandle           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Handle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html">POBJECT_HANDLE_INFORMATION</a> HandleInformation&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">542</a> of file <a class="el" href="../../d8/d0/obref_8c-source.html">obref.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00313">_OBJECT_HEADER::Body</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00418">DecodeKernelHandle</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l01403">ExMapHandleToPointer()</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00336">ExUnlockHandleTableEntry()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02690">_HANDLE_TABLE_ENTRY::GrantedAccess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00440">_ETHREAD::GrantedAccess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00254">_EPROCESS::GrantedAccess</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02694">_HANDLE_TABLE_ENTRY::GrantedAccessIndex</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00057">IsKernelHandle</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00405">KeDetachProcess()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00370">NtGlobalFlag</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02674">_HANDLE_TABLE_ENTRY::ObAttributes</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00289">OBJ_HANDLE_ATTRIBUTES</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02672">_HANDLE_TABLE_ENTRY::Object</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00355">OBJECT_TO_OBJECT_HEADER</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00213">ObpGetObjectTable</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00143">ObpIncrPointerCount</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00399">ObpKernelHandleTable</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00071">ObpValidateIrql</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d0/d8/ntos_8h-source.html#l00088">PsProcessType</a>, <a class="el" href="../../d0/d8/ntos_8h-source.html#l00089">PsThreadType</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00480">SeComputeDeniedAccesses</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d9/ob_8h-source.html#l00302">_OBJECT_HEADER::Type</a>.
<p>
Referenced by <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html#l00626">_GetUserObjectInformation()</a>, <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html#l00764">_SetUserObjectInformation()</a>, <a class="el" href="../../d1/d7/dir_8c-source.html#l00057">BuildQueryDirectoryIrp()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02169">CmGetSystemDriverList()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03262">CmpCloneControlSet()</a>, <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l01869">CmpCloneHwProfile()</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00313">CmpCreateEvent()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01165">CmpCreateRegistryRoot()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01421">CmpLinkHiveToMaster()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03458">CmpSaveBootControlSet()</a>, <a class="el" href="../../d3/d3/ex_2callback_8c-source.html#l00222">ExCreateCallback()</a>, <a class="el" href="../../d2/d8/worker_8c-source.html#l00971">ExpCreateWorkerThread()</a>, <a class="el" href="../../d6/d8/w32_2ntuser_2kernel_2pnp_8c-source.html#l00119">InitializeMediaChange()</a>, <a class="el" href="../../d8/d1/power_8c-source.html#l00180">InitializePowerRequestList()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l01067">IoAttachDevice()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01071">IoCreateDriver()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l05299">IoCreateNotificationEvent()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l05733">IoCreateSynchronizationEvent()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06998">IoGetDeviceObjectPointer()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04061">IopCompleteDumpInitialization()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04746">IopConfigureCrashDump()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l01506">IopConnectLinkTrackingPort()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00384">IopGetDumpStack()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02812">IopInitializeBuiltinDriver()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l03200">IopLoadDriver()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l03479">IopMarkBootPartition()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05126">IopOpenLinkOrRenameTarget()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03686">IopReferenceDriverObjectByName()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l06326">IopSetEaOrQuotaInformationFile()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l07272">IopTrackLink()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l08084">IopXxxControlFile()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l00443">MiLoadSystemImage()</a>, <a class="el" href="../../d1/d7/creasect_8c-source.html#l00390">MmCreateSection()</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l01721">MmGetFileNameForSection()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07311">MmSetBankedSection()</a>, <a class="el" href="../../d5/d5/lpccompl_8c-source.html#l00040">NtAcceptConnectPort()</a>, <a class="el" href="../../d6/d2/tokenadj_8c-source.html#l00432">NtAdjustGroupsToken()</a>, <a class="el" href="../../d6/d2/tokenadj_8c-source.html#l00046">NtAdjustPrivilegesToken()</a>, <a class="el" href="../../d2/d1/psspnd_8c-source.html#l00267">NtAlertResumeThread()</a>, <a class="el" href="../../d2/d1/psspnd_8c-source.html#l00214">NtAlertThread()</a>, <a class="el" href="../../d9/d4/physical_8c-source.html#l00970">NtAllocateUserPhysicalPages()</a>, <a class="el" href="../../d4/d5/allocvm_8c-source.html#l00075">NtAllocateVirtualMemory()</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l00266">NtAssignProcessToJobObject()</a>, <a class="el" href="../../d2/d9/io_2misc_8c-source.html#l00049">NtCancelIoFile()</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00679">NtCancelTimer()</a>, <a class="el" href="../../d1/d7/ex_2event_8c-source.html#l00126">NtClearEvent()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00166">NtCreateKey()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00297">NtCreatePagingFile()</a>, <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00199">NtCreateProfile()</a>, <a class="el" href="../../d2/d7/super_8c-source.html#l00056">NtCreateSuperSection()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00411">NtDeleteKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00504">NtDeleteValueKey()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l00163">NtDuplicateObject()</a>, <a class="el" href="../../d7/d2/tokendup_8c-source.html#l00046">NtDuplicateToken()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00610">NtEnumerateKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00756">NtEnumerateValueKey()</a>, <a class="el" href="../../d9/d9/extsect_8c-source.html#l00085">NtExtendSection()</a>, <a class="el" href="../../d7/d2/tokendup_8c-source.html#l01306">NtFilterToken()</a>, <a class="el" href="../../d2/d9/io_2misc_8c-source.html#l00386">NtFlushBuffersFile()</a>, <a class="el" href="../../d6/d4/flushbuf_8c-source.html#l00142">NtFlushInstructionCache()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00904">NtFlushKey()</a>, <a class="el" href="../../d7/d4/flushsec_8c-source.html#l00055">NtFlushVirtualMemory()</a>, <a class="el" href="../../d9/d4/physical_8c-source.html#l01624">NtFreeUserPhysicalPages()</a>, <a class="el" href="../../d4/d6/freevm_8c-source.html#l00066">NtFreeVirtualMemory()</a>, <a class="el" href="../../d3/d9/psctx_8c-source.html#l00151">NtGetContextThread()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l03038">NtImpersonateAnonymousToken()</a>, <a class="el" href="../../d0/d0/psimpers_8c-source.html#l00026">NtImpersonateThread()</a>, <a class="el" href="../../d5/d5/channel_8c-source.html#l00236">NtListenChannel()</a>, <a class="el" href="../../d2/d4/lock_8c-source.html#l00035">NtLockFile()</a>, <a class="el" href="../../d4/d4/lockvm_8c-source.html#l00033">NtLockVirtualMemory()</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00414">NtMakeTemporaryObject()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l00199">NtMapViewOfSection()</a>, <a class="el" href="../../d2/d7/super_8c-source.html#l00311">NtMapViewOfSuperSection()</a>, <a class="el" href="../../d1/d7/dir_8c-source.html#l00821">NtNotifyChangeDirectoryFile()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01319">NtNotifyChangeMultipleKeys()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01870">NtOpenKey()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l02072">NtOpenObjectAuditAlarm()</a>, <a class="el" href="../../d8/d2/tokenopn_8c-source.html#l00458">NtOpenThreadToken()</a>, <a class="el" href="../../d9/d3/privileg_8c-source.html#l00231">NtPrivilegeCheck()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l00731">NtPrivilegedServiceAuditAlarm()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l00406">NtPrivilegeObjectAuditAlarm()</a>, <a class="el" href="../../d1/d8/protect_8c-source.html#l00069">NtProtectVirtualMemory()</a>, <a class="el" href="../../d1/d7/ex_2event_8c-source.html#l00412">NtPulseEvent()</a>, <a class="el" href="../../d9/d9/obdir_8c-source.html#l00229">NtQueryDirectoryObject()</a>, <a class="el" href="../../d8/d1/qsea_8c-source.html#l00035">NtQueryEaFile()</a>, <a class="el" href="../../d1/d7/ex_2event_8c-source.html#l00514">NtQueryEvent()</a>, <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00101">NtQueryInformationFile()</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l00814">NtQueryInformationJobObject()</a>, <a class="el" href="../../d3/d6/lpcquery_8c-source.html#l00030">NtQueryInformationPort()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l00531">NtQueryInformationProcess()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l02706">NtQueryInformationThread()</a>, <a class="el" href="../../d0/d3/tokenqry_8c-source.html#l00034">NtQueryInformationToken()</a>, <a class="el" href="../../d6/d3/complete_8c-source.html#l00282">NtQueryIoCompletion()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02018">NtQueryKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03461">NtQueryMultipleValueKey()</a>, <a class="el" href="../../d3/d4/mutant_8c-source.html#l00380">NtQueryMutant()</a>, <a class="el" href="../../d7/d0/obquery_8c-source.html#l00058">NtQueryObject()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l04090">NtQueryOpenSubKeys()</a>, <a class="el" href="../../d1/d2/qsquota_8c-source.html#l00035">NtQueryQuotaInformationFile()</a>, <a class="el" href="../../d5/d2/querysec_8c-source.html#l00031">NtQuerySection()</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l00255">NtQuerySecurityObject()</a>, <a class="el" href="../../d3/d5/semphore_8c-source.html#l00360">NtQuerySemaphore()</a>, <a class="el" href="../../d5/d0/oblink_8c-source.html#l00333">NtQuerySymbolicLinkObject()</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00822">NtQueryTimer()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02187">NtQueryValueKey()</a>, <a class="el" href="../../d6/d2/queryvm_8c-source.html#l00061">NtQueryVirtualMemory()</a>, <a class="el" href="../../d9/d1/qsfs_8c-source.html#l00037">NtQueryVolumeInformationFile()</a>, <a class="el" href="../../d3/d9/psctx_8c-source.html#l00056">NtQueueApcThread()</a>, <a class="el" href="../../d7/d4/io_2read_8c-source.html#l00036">NtReadFile()</a>, <a class="el" href="../../d7/d4/io_2read_8c-source.html#l00730">NtReadFileScatter()</a>, <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00102">NtReadVirtualMemory()</a>, <a class="el" href="../../d9/d9/psdelete_8c-source.html#l01472">NtRegisterThreadTerminatePort()</a>, <a class="el" href="../../d3/d4/mutant_8c-source.html#l00521">NtReleaseMutant()</a>, <a class="el" href="../../d3/d5/semphore_8c-source.html#l00494">NtReleaseSemaphore()</a>, <a class="el" href="../../d6/d3/complete_8c-source.html#l00485">NtRemoveIoCompletion()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03336">NtReplaceKey()</a>, <a class="el" href="../../d5/d6/lpcrecv_8c-source.html#l00029">NtReplyWaitReceivePort()</a>, <a class="el" href="../../d5/d6/lpcrecv_8c-source.html#l00635">NtReplyWaitReceivePortEx()</a>, <a class="el" href="../../d1/d7/ex_2event_8c-source.html#l00648">NtResetEvent()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02348">NtRestoreKey()</a>, <a class="el" href="../../d2/d1/psspnd_8c-source.html#l00138">NtResumeThread()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02471">NtSaveKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02559">NtSaveMergedKeys()</a>, <a class="el" href="../../d6/d5/lpcconn_8c-source.html#l00084">NtSecureConnectPort()</a>, <a class="el" href="../../d5/d5/channel_8c-source.html#l00807">NtSendWaitReplyChannel()</a>, <a class="el" href="../../d3/d9/psctx_8c-source.html#l00352">NtSetContextThread()</a>, <a class="el" href="../../d7/d7/ex_2harderr_8c-source.html#l00886">NtSetDefaultHardErrorPort()</a>, <a class="el" href="../../d8/d1/qsea_8c-source.html#l00652">NtSetEaFile()</a>, <a class="el" href="../../d1/d7/ex_2event_8c-source.html#l00748">NtSetEvent()</a>, <a class="el" href="../../d4/d7/eventpr_8c-source.html#l00651">NtSetHighEventPair()</a>, <a class="el" href="../../d4/d7/eventpr_8c-source.html#l00532">NtSetHighWaitLowEventPair()</a>, <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00849">NtSetInformationFile()</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l01323">NtSetInformationJobObject()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03235">NtSetInformationKey()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l01510">NtSetInformationProcess()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l03103">NtSetInformationThread()</a>, <a class="el" href="../../d1/d3/tokenset_8c-source.html#l00037">NtSetInformationToken()</a>, <a class="el" href="../../d6/d3/complete_8c-source.html#l00417">NtSetIoCompletion()</a>, <a class="el" href="../../d4/d7/eventpr_8c-source.html#l00592">NtSetLowEventPair()</a>, <a class="el" href="../../d4/d7/eventpr_8c-source.html#l00472">NtSetLowWaitHighEventPair()</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l00046">NtSetSecurityObject()</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l02264">NtSetSystemInformation()</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00960">NtSetTimer()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02672">NtSetValueKey()</a>, <a class="el" href="../../d9/d1/qsfs_8c-source.html#l00492">NtSetVolumeInformationFile()</a>, <a class="el" href="../../d2/d1/obwait_8c-source.html#l00038">NtSignalAndWaitForSingleObject()</a>, <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00517">NtStartProfile()</a>, <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00680">NtStopProfile()</a>, <a class="el" href="../../d2/d1/psspnd_8c-source.html#l00033">NtSuspendThread()</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l02358">NtTerminateJobObject()</a>, <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00227">NtTerminateProcess()</a>, <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00461">NtTerminateThread()</a>, <a class="el" href="../../d9/d3/loadunld_8c-source.html#l00244">NtUnloadDriver()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03093">NtUnloadKey()</a>, <a class="el" href="../../d2/d4/lock_8c-source.html#l00458">NtUnlockFile()</a>, <a class="el" href="../../d4/d4/lockvm_8c-source.html#l00605">NtUnlockVirtualMemory()</a>, <a class="el" href="../../d5/d8/umapview_8c-source.html#l00033">NtUnmapViewOfSection()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l02329">NtUserGetGuiResources()</a>, <a class="el" href="../../d0/d6/kernel_2server_8c-source.html#l02788">NtUserProcessConnect()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l07905">NtUserUserHandleGrantAccess()</a>, <a class="el" href="../../d2/d1/obwait_8c-source.html#l00282">NtWaitForSingleObject()</a>, <a class="el" href="../../d4/d7/eventpr_8c-source.html#l00412">NtWaitHighEventPair()</a>, <a class="el" href="../../d4/d7/eventpr_8c-source.html#l00352">NtWaitLowEventPair()</a>, <a class="el" href="../../d1/d9/io_2write_8c-source.html#l00035">NtWriteFile()</a>, <a class="el" href="../../d1/d9/io_2write_8c-source.html#l00801">NtWriteFileGather()</a>, <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00231">NtWriteVirtualMemory()</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l00117">ObInitSystem()</a>, <a class="el" href="../../d9/d9/obdir_8c-source.html#l01081">ObpLookupObjectName()</a>, <a class="el" href="../../d8/d9/obdevmap_8c-source.html#l00030">ObSetDeviceMap()</a>, <a class="el" href="../../d4/d2/tob_8c-source.html#l00187">obtest()</a>, <a class="el" href="../../d2/d1/obwait_8c-source.html#l00837">ObWaitForSingleObject()</a>, <a class="el" href="../../d2/d6/w32_2ntuser_2kernel_2profile_8c-source.html#l00263">OpenCacheKeyEx()</a>, <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l01483">PsAssignImpersonationToken()</a>, <a class="el" href="../../d1/d0/psinit_8c-source.html#l00525">PsLocateSystemDll()</a>, <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l00586">PsOpenTokenOfJobObject()</a>, <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l00492">PsOpenTokenOfProcess()</a>, <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l00326">PsOpenTokenOfThread()</a>, <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l01256">PspAssignPrimaryToken()</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00969">PspCreateProcess()</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00262">PspCreateThread()</a>, <a class="el" href="../../d1/d0/psinit_8c-source.html#l00181">PspInitPhase0()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l00291">PspQueryPooledQuotaLimits()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l00209">PspQueryQuotaLimits()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l00113">PspQueryWorkingSetWatch()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l00366">PspSetPrimaryToken()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l01211">PspSetQuotaLimits()</a>, <a class="el" href="../../d7/d7/ntinput_8c-source.html#l03858">RawInputThread()</a>, <a class="el" href="../../d9/d7/winsta_8c-source.html#l01366">ReferenceWindowStation()</a>, <a class="el" href="../../d6/d8/w32_2ntuser_2kernel_2pnp_8c-source.html#l00929">RegisterForDeviceChangeNotifications()</a>, <a class="el" href="../../d7/d9/w32_2ntuser_2kernel_2misc_8c-source.html#l00020">RemoteConnect()</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l02704">SeAccessCheckByType()</a>, <a class="el" href="../../d7/d2/tokendup_8c-source.html#l01634">SeFilterToken()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l02867">SeIsChildToken()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l01050">SepAccessCheckAndAuditAlarm()</a>, <a class="el" href="../../d8/d2/tokenopn_8c-source.html#l00294">SepOpenTokenOfThread()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l06357">SetInformationProcess()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l02425">SmbTraceToClient()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l01271">UdfInvalidateVolumes()</a>, <a class="el" href="../../d8/d2/validate_8c-source.html#l00092">ValidateHdesk()</a>, <a class="el" href="../../d8/d2/validate_8c-source.html#l00046">ValidateHwinsta()</a>, <a class="el" href="../../d0/d4/vdmints_8c-source.html#l01235">VdmpDelayInterrupt()</a>, <a class="el" href="../../d0/d4/vdmints_8c-source.html#l00146">VdmpQueueInterrupt()</a>, <a class="el" href="../../d0/d4/vdmints_8c-source.html#l00408">VdmpQueueIntNormalRoutine()</a>, <a class="el" href="../../d4/d3/vdm_2vdm_8c-source.html#l00087">VdmQueryDirectoryFile()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l05671">WaitOnPseudoEvent()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l04332">xxxCloseDesktop()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l06445">xxxConsoleControl()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l01797">xxxCreateDesktop()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l01654">xxxCreateDisconnectDesktop()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l01501">xxxCreateThreadInfo()</a>, <a class="el" href="../../d9/d7/winsta_8c-source.html#l00243">xxxCreateWindowStation()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l04211">xxxGetThreadDesktop()</a>, <a class="el" href="../../d9/d3/w32_2ntuser_2kernel_2random_8c-source.html#l00276">xxxHardErrorControl()</a>, <a class="el" href="../../d9/d7/winsta_8c-source.html#l00026">xxxInitTerminal()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l03265">xxxOpenDesktop()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l05901">xxxQueryInformationThread()</a>, <a class="el" href="../../d2/d9/kernel_2exitwin_8c-source.html#l00565">xxxRegisterUserHungAppHandlers()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l04821">xxxResolveDesktop()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l06114">xxxSetInformationThread()</a>, <a class="el" href="../../d9/d7/winsta_8c-source.html#l01077">xxxSetProcessWindowStation()</a>, and <a class="el" href="../../d0/d6/desktop_8c-source.html#l03823">zzzSetDesktop()</a>.
<p>
<pre class="fragment"><div>00553                    :
00554 
00555     Given a handle to an object <span class="keyword">this</span> routine returns a pointer
00556     to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> body of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object with proper ref counts
00557 
00558 Arguments:
00559 
00560     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> - Supplies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object being referenced.  It can
00561         also be <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> result of NtCurrentProcess or NtCurrentThread
00562 
00563     DesiredAccess - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access being requested by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller
00564 
00565     ObjectType - Optionally supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object we
00566         are expecting
00567 
00568     AccessMode - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> processor mode of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access
00569 
00570     Object - Receives a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object body <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation
00571         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> successful
00572 
00573     HandleInformation - Optionally receives information regarding <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00574         input handle.
00575 
00576 Return Value:
00577 
00578     An appropriate <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> value
00579 
00580 --*/
00581 
00582 {
00583     ACCESS_MASK GrantedAccess;
00584     <a class="code" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a> HandleTable;
00585     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
00586     <a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">PHANDLE_TABLE_ENTRY</a> ObjectTableEntry;
00587     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
00588     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00589     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
00590     BOOLEAN AttachedToProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00591 
00592     <a class="code" href="../../d5/d1/obp_8h.html#a2">ObpValidateIrql</a>(<span class="stringliteral">"ObReferenceObjectByHandle"</span>);
00593 
00594     <span class="comment">//</span>
00595     <span class="comment">//  Protect ourselves from being interrupted while we hold a handle table</span>
00596     <span class="comment">//  entry lock</span>
00597     <span class="comment">//</span>
00598 
00599     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00600 
00601     <span class="keywordflow">try</span> {
00602 
00603         <span class="comment">//</span>
00604         <span class="comment">//  If the handle is equal to the current process handle and the object</span>
00605         <span class="comment">//  type is NULL or type process, then attempt to translate a handle to</span>
00606         <span class="comment">//  the current process. Otherwise, check if the handle is the current</span>
00607         <span class="comment">//  thread handle.</span>
00608         <span class="comment">//</span>
00609 
00610         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> == NtCurrentProcess()) {
00611 
00612             <span class="keywordflow">if</span> ((ObjectType == <a class="code" href="../../d9/d8/ntos_8h.html#a2">PsProcessType</a>) || (ObjectType == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00613 
00614                 Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
00615                 GrantedAccess = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o54">GrantedAccess</a>;
00616 
00617                 <span class="keywordflow">if</span> ((<a class="code" href="../../d0/d5/se_8h.html#a8">SeComputeDeniedAccesses</a>(GrantedAccess, DesiredAccess) == 0) ||
00618                     (AccessMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>)) {
00619 
00620                     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>(Process);
00621 
00622                     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(HandleInformation)) {
00623 
00624                         HandleInformation-&gt;GrantedAccess = GrantedAccess;
00625                         HandleInformation-&gt;HandleAttributes = 0;
00626                     }
00627 
00628                     <a class="code" href="../../d5/d1/obp_8h.html#a3">ObpIncrPointerCount</a>(ObjectHeader);
00629                     *Object = Process;
00630 
00631                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( *Object != NULL );
00632 
00633                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00634                     leave;
00635 
00636                 } <span class="keywordflow">else</span> {
00637 
00638                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED;
00639                 }
00640 
00641             } <span class="keywordflow">else</span> {
00642 
00643                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OBJECT_TYPE_MISMATCH;
00644             }
00645 
00646         <span class="comment">//</span>
00647         <span class="comment">//  If the handle is equal to the current thread handle and the object</span>
00648         <span class="comment">//  type is NULL or type thread, then attempt to translate a handle to</span>
00649         <span class="comment">//  the current thread. Otherwise, the we'll try and translate the</span>
00650         <span class="comment">//  handle</span>
00651         <span class="comment">//</span>
00652 
00653         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> == NtCurrentThread()) {
00654 
00655             <span class="keywordflow">if</span> ((ObjectType == <a class="code" href="../../d9/d8/ntos_8h.html#a3">PsThreadType</a>) || (ObjectType == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00656 
00657                 Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00658                 GrantedAccess = Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o27">GrantedAccess</a>;
00659 
00660                 <span class="keywordflow">if</span> ((<a class="code" href="../../d0/d5/se_8h.html#a8">SeComputeDeniedAccesses</a>(GrantedAccess, DesiredAccess) == 0) ||
00661                     (AccessMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>)) {
00662 
00663                     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>(Thread);
00664 
00665                     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(HandleInformation)) {
00666 
00667                         HandleInformation-&gt;GrantedAccess = GrantedAccess;
00668                         HandleInformation-&gt;HandleAttributes = 0;
00669                     }
00670 
00671                     <a class="code" href="../../d5/d1/obp_8h.html#a3">ObpIncrPointerCount</a>(ObjectHeader);
00672                     *Object = Thread;
00673 
00674                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( *Object != NULL );
00675 
00676                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00677                     leave;
00678 
00679                 } <span class="keywordflow">else</span> {
00680 
00681                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED;
00682                 }
00683 
00684             } <span class="keywordflow">else</span> {
00685 
00686                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OBJECT_TYPE_MISMATCH;
00687             }
00688 
00689         <span class="comment">//</span>
00690         <span class="comment">//  Otherwise the handle is not a built in value.  It must be an index</span>
00691         <span class="comment">//  into a handle table.</span>
00692         <span class="comment">//</span>
00693 
00694         } <span class="keywordflow">else</span> {
00695 
00696 <span class="preprocessor">    #if DBG</span>
00697 <span class="preprocessor"></span>            <span class="comment">//</span>
00698             <span class="comment">//  On checked builds, check that if the Kernel handle bit is set,</span>
00699             <span class="comment">//  then we're coming from Kernel mode. We should probably fail the</span>
00700             <span class="comment">//  call if bit set &amp;&amp; !Kmode</span>
00701             <span class="comment">//</span>
00702             <span class="comment">//  We know we're NOT a builtin handle at this point</span>
00703             <span class="comment">//</span>
00704 
00705             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((Handle &lt; 0) ? (AccessMode == KernelMode) : TRUE);
00706 <span class="preprocessor">    #endif</span>
00707 <span class="preprocessor"></span>
00708             <span class="comment">//</span>
00709             <span class="comment">//  First get a pointer to either the processes handle table or the</span>
00710             <span class="comment">//  global kernel handle table.  If it is the kernel handle then we</span>
00711             <span class="comment">//  need to clear the handle bit and attach to the system process</span>
00712             <span class="comment">//</span>
00713 
00714             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/ioverifier_8c.html#a14">IsKernelHandle</a>( Handle, AccessMode )) {
00715 
00716                 <span class="comment">//</span>
00717                 <span class="comment">//  Make the handle look like a regular handle</span>
00718                 <span class="comment">//</span>
00719 
00720                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = <a class="code" href="../../d5/d1/obp_8h.html#a27">DecodeKernelHandle</a>( Handle );
00721 
00722                 <span class="comment">//</span>
00723                 <span class="comment">//  The global kernel handle table</span>
00724                 <span class="comment">//</span>
00725 
00726                 HandleTable = <a class="code" href="../../d5/d1/obp_8h.html#a54">ObpKernelHandleTable</a>;
00727 
00728             } <span class="keywordflow">else</span> {
00729 
00730                 HandleTable = <a class="code" href="../../d5/d1/obp_8h.html#a12">ObpGetObjectTable</a>();
00731             }
00732 
00733             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(HandleTable != NULL);
00734 
00735             <span class="comment">//</span>
00736             <span class="comment">//  Translate the specified handle to an object table index.</span>
00737             <span class="comment">//</span>
00738 
00739             ObjectTableEntry = <a class="code" href="../../d5/d8/ex_8h.html#a299">ExMapHandleToPointer</a>( HandleTable, Handle );
00740 
00741             <span class="comment">//</span>
00742             <span class="comment">//  Make sure the object table entry really does exist</span>
00743             <span class="comment">//</span>
00744 
00745             <span class="keywordflow">if</span> (ObjectTableEntry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00746 
00747                 ObjectHeader = (<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a>)(((ULONG_PTR)(ObjectTableEntry-&gt;<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o0">Object</a>)) &amp; ~<a class="code" href="../../d5/d1/obp_8h.html#a17">OBJ_HANDLE_ATTRIBUTES</a>);
00748 
00749                 <span class="keywordflow">if</span> ((ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a> == ObjectType) || (ObjectType == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00750 
00751 <span class="preprocessor">    #if i386 &amp;&amp; !FPO</span>
00752 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_KERNEL_STACK_TRACE_DB) {
00753 
00754                         <span class="keywordflow">if</span> ((AccessMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) || ARGUMENT_PRESENT(HandleInformation)) {
00755 
00756                             GrantedAccess = ObpTranslateGrantedAccessIndex( ObjectTableEntry-&gt;<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o3">GrantedAccessIndex</a> );
00757                         }
00758 
00759                     } <span class="keywordflow">else</span> {
00760 
00761                         GrantedAccess = ObjectTableEntry-&gt;<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o2">GrantedAccess</a>;
00762                     }
00763 <span class="preprocessor">    #else</span>
00764 <span class="preprocessor"></span>                    GrantedAccess = ObjectTableEntry-&gt;<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o2">GrantedAccess</a>;
00765 
00766 <span class="preprocessor">    #endif // i386 &amp;&amp; !FPO</span>
00767 <span class="preprocessor"></span>
00768                     <span class="keywordflow">if</span> ((<a class="code" href="../../d0/d5/se_8h.html#a8">SeComputeDeniedAccesses</a>(GrantedAccess, DesiredAccess) == 0) ||
00769                         (AccessMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>)) {
00770 
00771                         <span class="comment">//</span>
00772                         <span class="comment">//  Access to the object is allowed. Return the handle</span>
00773                         <span class="comment">//  information is requested, increment the object</span>
00774                         <span class="comment">//  pointer count, unlock the handle table and return</span>
00775                         <span class="comment">//  a success status.</span>
00776                         <span class="comment">//</span>
00777                         <span class="comment">//  Note that this is the only successful return path</span>
00778                         <span class="comment">//  out of this routine if the user did not specify</span>
00779                         <span class="comment">//  the current process or current thread in the input</span>
00780                         <span class="comment">//  handle.</span>
00781                         <span class="comment">//</span>
00782 
00783                         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(HandleInformation)) {
00784 
00785                             HandleInformation-&gt;GrantedAccess = GrantedAccess;
00786                             HandleInformation-&gt;HandleAttributes = ObjectTableEntry-&gt;<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o1">ObAttributes</a> &amp; <a class="code" href="../../d5/d1/obp_8h.html#a17">OBJ_HANDLE_ATTRIBUTES</a>;
00787                         }
00788 
00789                         <a class="code" href="../../d5/d1/obp_8h.html#a3">ObpIncrPointerCount</a>(ObjectHeader);
00790                         *Object = &amp;ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o11">Body</a>;
00791 
00792                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( *Object != NULL );
00793 
00794                         <a class="code" href="../../d5/d8/ex_8h.html#a288">ExUnlockHandleTableEntry</a>( HandleTable, ObjectTableEntry );
00795 
00796                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00797                         leave;
00798 
00799                     } <span class="keywordflow">else</span> {
00800 
00801                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED;
00802                     }
00803 
00804                 } <span class="keywordflow">else</span> {
00805 
00806                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OBJECT_TYPE_MISMATCH;
00807                 }
00808 
00809                 <a class="code" href="../../d5/d8/ex_8h.html#a288">ExUnlockHandleTableEntry</a>( HandleTable, ObjectTableEntry );
00810 
00811             } <span class="keywordflow">else</span> {
00812 
00813                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_HANDLE;
00814             }
00815         }
00816 
00817         <span class="comment">//</span>
00818         <span class="comment">//  If we are attached to the system process then return</span>
00819         <span class="comment">//  back to our caller</span>
00820         <span class="comment">//</span>
00821 
00822         <span class="keywordflow">if</span> (AttachedToProcess) {
00823 
00824             <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00825         }
00826 
00827         <span class="comment">//</span>
00828         <span class="comment">//  No handle translation is possible. Set the object address to NULL</span>
00829         <span class="comment">//  and return an error status.</span>
00830         <span class="comment">//</span>
00831 
00832         *Object = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00833 
00834     } finally {
00835 
00836         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00837     }
00838 
00839     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00840 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="obref.c::ObReferenceObjectByName" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ObReferenceObjectByName           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Attributes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK DesiredAccess&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PVOID ParseContext&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/obref_8c-source.html#l00844">844</a> of file <a class="el" href="../../d8/d0/obref_8c-source.html">obref.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00259">_AUX_ACCESS_DATA::GenericMapping</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d9/obcreate_8c-source.html#l00438">ObpCaptureObjectName()</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l00602">ObpCheckObjectReference()</a>, <a class="el" href="../../d5/d1/obp_8h.html#a61">ObpFreeObjectNameBuffer()</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00202">ObpLeaveRootDirectoryMutex</a>, <a class="el" href="../../d9/d9/obdir_8c-source.html#l01081">ObpLookupObjectName()</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00071">ObpValidateIrql</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d4/seastate_8c-source.html#l00180">SeCreateAccessState()</a>, <a class="el" href="../../d3/d4/seastate_8c-source.html#l00348">SeDeleteAccessState()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l09565">IopGetLegacyVetoListDrivers()</a>, <a class="el" href="../../d5/d5/channel_8c-source.html#l00348">NtOpenChannel()</a>, <a class="el" href="../../d6/d5/lpcconn_8c-source.html#l00084">NtSecureConnectPort()</a>, and <a class="el" href="../../d4/d2/tob_8c-source.html#l00187">obtest()</a>.
<p>
<pre class="fragment"><div>00857                    :
00858 
00859     Given a name of an object <span class="keyword">this</span> routine returns a pointer
00860     to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> body of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object with proper ref counts
00861 
00862 Arguments:
00863 
00864     ObjectName - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object being referenced
00865 
00866     Attributes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired handle attributes
00867 
00868     AccessState - Supplies an optional pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current access
00869         status describing already granted access types, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> privileges used
00870         to get them, and any access types yet to be granted.
00871 
00872     DesiredAccess - Optionally supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00873         <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object
00874 
00875     ObjectType - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> according to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller
00876 
00877     AccessMode - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> processor mode of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access
00878 
00879     ParseContext - Optionally supplies a context to pass down to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00880         parse routine
00881 
00882     Object - Receives a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> referenced object body
00883 
00884 Return Value:
00885 
00886     An appropriate <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> value
00887 
00888 --*/
00889 
00890 {
00891     UNICODE_STRING CapturedObjectName;
00892     BOOLEAN DirectoryLocked;
00893     PVOID ExistingObject;
00894     <a class="code" href="../../d2/d5/struct__ACCESS__STATE.html">ACCESS_STATE</a> LocalAccessState;
00895     <a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html">AUX_ACCESS_DATA</a> AuxData;
00896     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00897 
00898     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00899 
00900     <a class="code" href="../../d5/d1/obp_8h.html#a2">ObpValidateIrql</a>(<span class="stringliteral">"ObReferenceObjectByName"</span>);
00901 
00902     <span class="comment">//</span>
00903     <span class="comment">//  If the object name descriptor is not specified, or the object name</span>
00904     <span class="comment">//  length is zero (tested after capture), then the object name is</span>
00905     <span class="comment">//  invalid.</span>
00906     <span class="comment">//</span>
00907 
00908     <span class="keywordflow">if</span> (ObjectName == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00909 
00910         <span class="keywordflow">return</span> STATUS_OBJECT_NAME_INVALID;
00911     }
00912 
00913     <span class="comment">//</span>
00914     <span class="comment">//  Capture the object name.</span>
00915     <span class="comment">//</span>
00916 
00917     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d1/obp_8h.html#a59">ObpCaptureObjectName</a>( AccessMode,
00918                                    ObjectName,
00919                                    &amp;CapturedObjectName,
00920                                    TRUE );
00921 
00922     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00923 
00924         <span class="comment">//</span>
00925         <span class="comment">//  No buffer has been allocated for a zero length name so no free</span>
00926         <span class="comment">//  needed</span>
00927         <span class="comment">//</span>
00928 
00929         <span class="keywordflow">if</span> (CapturedObjectName.Length == 0) {
00930 
00931            <span class="keywordflow">return</span> STATUS_OBJECT_NAME_INVALID;
00932         }
00933 
00934         <span class="comment">//</span>
00935         <span class="comment">//  If the access state is not specified, then create the access</span>
00936         <span class="comment">//  state.</span>
00937         <span class="comment">//</span>
00938 
00939         <span class="keywordflow">if</span> (!ARGUMENT_PRESENT(AccessState)) {
00940 
00941             AccessState = &amp;LocalAccessState;
00942 
00943             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/seastate_8c.html#a2">SeCreateAccessState</a>( &amp;LocalAccessState,
00944                                           &amp;AuxData,
00945                                           DesiredAccess,
00946                                           &amp;ObjectType-&gt;TypeInfo.GenericMapping );
00947 
00948             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00949 
00950                 <span class="keywordflow">goto</span> FreeBuffer;
00951             }
00952         }
00953 
00954         <span class="comment">//</span>
00955         <span class="comment">//  Lookup object by name.</span>
00956         <span class="comment">//</span>
00957 
00958         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d1/obp_8h.html#a71">ObpLookupObjectName</a>( NULL,
00959                                       &amp;CapturedObjectName,
00960                                       Attributes,
00961                                       ObjectType,
00962                                       AccessMode,
00963                                       ParseContext,
00964                                       NULL,
00965                                       NULL,
00966                                       AccessState,
00967                                       &amp;DirectoryLocked,
00968                                       &amp;ExistingObject );
00969 
00970         <span class="comment">//</span>
00971         <span class="comment">//  If the directory is returned locked, then unlock it.</span>
00972         <span class="comment">//</span>
00973 
00974         <span class="keywordflow">if</span> (DirectoryLocked) {
00975 
00976             <a class="code" href="../../d5/d1/obp_8h.html#a11">ObpLeaveRootDirectoryMutex</a>();
00977         }
00978 
00979         <span class="comment">//</span>
00980         <span class="comment">//  If the lookup was successful, then return the existing</span>
00981         <span class="comment">//  object if access is allowed. Otherwise, return NULL.</span>
00982         <span class="comment">//</span>
00983 
00984         *Object = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00985 
00986         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00987 
00988             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d1/obse_8c.html#a4">ObpCheckObjectReference</a>( ExistingObject,
00989                                          AccessState,
00990                                          FALSE,
00991                                          AccessMode,
00992                                          &amp;Status )) {
00993 
00994                 *Object = ExistingObject;
00995             }
00996         }
00997 
00998         <span class="comment">//</span>
00999         <span class="comment">//  If the access state was generated, then delete the access</span>
01000         <span class="comment">//  state.</span>
01001         <span class="comment">//</span>
01002 
01003         <span class="keywordflow">if</span> (AccessState == &amp;LocalAccessState) {
01004 
01005             <a class="code" href="../../d2/d5/seastate_8c.html#a3">SeDeleteAccessState</a>(AccessState);
01006         }
01007 
01008         <span class="comment">//</span>
01009         <span class="comment">//  Free the object name buffer.</span>
01010         <span class="comment">//</span>
01011 
01012 FreeBuffer:
01013 
01014         <a class="code" href="../../d5/d1/obp_8h.html#a61">ObpFreeObjectNameBuffer</a>(&amp;CapturedObjectName);
01015     }
01016 
01017     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01018 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="obref.c::ObReferenceObjectByPointer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ObReferenceObjectByPointer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMode</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/obref_8c-source.html#l01022">1022</a> of file <a class="el" href="../../d8/d0/obref_8c-source.html">obref.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00355">OBJECT_TO_OBJECT_HEADER</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00143">ObpIncrPointerCount</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00368">ObpSymbolicLinkObjectType</a>, and <a class="el" href="../../d5/d9/ob_8h-source.html#l00302">_OBJECT_HEADER::Type</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l07495">IoRegisterPlugPlayNotification()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l03038">NtImpersonateAnonymousToken()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00367">ObOpenObjectByPointer()</a>, <a class="el" href="../../d9/d9/obdir_8c-source.html#l01081">ObpLookupObjectName()</a>, <a class="el" href="../../d5/d0/oblink_8c-source.html#l00501">ObpParseSymbolicLink()</a>, <a class="el" href="../../d4/d2/tob_8c-source.html#l00187">obtest()</a>, <a class="el" href="../../d4/d2/tob_8c-source.html#l00133">ParseAProc()</a>, <a class="el" href="../../d7/d7/ntinput_8c-source.html#l03858">RawInputThread()</a>, <a class="el" href="../../d0/d4/vdmints_8c-source.html#l01235">VdmpDelayInterrupt()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l00114">xxxDesktopThread()</a>, and <a class="el" href="../../d7/d2/queue_8c-source.html#l05713">xxxSetCsrssThreadDesktop()</a>.
<p>
<pre class="fragment"><div>01031                    :
01032 
01033     This routine adds another reference count to an object denoted by
01034     a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object body
01035 
01036 Arguments:
01037 
01038     Object - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object being referenced
01039 
01040     DesiredAccess - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired access <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> reference
01041 
01042     ObjectType - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> according to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller
01043 
01044     AccessMode - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> processor mode of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access
01045 
01046 Return Value:
01047 
01048     STATUS_SUCCESS <span class="keywordflow">if</span> successful and STATUS_OBJECT_TYPE_MISMATCH otherwise
01049 
01050 --*/
01051 
01052 {
01053     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
01054 
01055     <span class="comment">//</span>
01056     <span class="comment">//  Translate the pointer to the object body to a pointer to the</span>
01057     <span class="comment">//  object header</span>
01058     <span class="comment">//</span>
01059 
01060     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object );
01061 
01062     <span class="comment">//</span>
01063     <span class="comment">//  If the specified object type does not match and either the caller is</span>
01064     <span class="comment">//  not kernel mode or it is not a symbolic link object then it is an</span>
01065     <span class="comment">//  error</span>
01066     <span class="comment">//</span>
01067 
01068     <span class="keywordflow">if</span> ((ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a> != ObjectType) &amp;&amp; (AccessMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a> ||
01069                                                ObjectType == <a class="code" href="../../d5/d1/obp_8h.html#a43">ObpSymbolicLinkObjectType</a>)) {
01070 
01071         <span class="keywordflow">return</span>( STATUS_OBJECT_TYPE_MISMATCH );
01072     }
01073 
01074     <span class="comment">//</span>
01075     <span class="comment">//  Otherwise increment the pointer count and return success to</span>
01076     <span class="comment">//  our caller</span>
01077     <span class="comment">//</span>
01078 
01079     <a class="code" href="../../d5/d1/obp_8h.html#a3">ObpIncrPointerCount</a>( ObjectHeader );
01080 
01081     <span class="keywordflow">return</span>( STATUS_SUCCESS );
01082 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a0" doxytag="obref.c::ObpRemoveQueueActive" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d7/d1/obref_8c.html#a0">ObpRemoveQueueActive</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/obref_8c-source.html#l00027">27</a> of file <a class="el" href="../../d8/d0/obref_8c-source.html">obref.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d0/obref_8c-source.html#l01124">ObfDereferenceObject()</a>, and <a class="el" href="../../d8/d0/obref_8c-source.html#l01299">ObpProcessRemoveObjectQueue()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:59 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
