<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: initia64.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>initia64.c</h1><a href="../../d6/d2/mm_2ia64_2initia64_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1990  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    initia64.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains the machine dependent initialization for the</span>
00012 <span class="comment">    memory management component.  It is specifically tailored to the</span>
00013 <span class="comment">    INTEL IA64 machine.</span>
00014 <span class="comment"></span>
00015 <span class="comment">Author:</span>
00016 <span class="comment"></span>
00017 <span class="comment">    Lou Perazzoli (loup) 6-Jan-1990</span>
00018 <span class="comment"></span>
00019 <span class="comment">Revision History:</span>
00020 <span class="comment"></span>
00021 <span class="comment">--*/</span>
00022 
00023 <span class="preprocessor">#include "<a class="code" href="../../d4/d8/mi_8h.html">mi.h</a>"</span>
00024 
00025 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00026 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,MiInitMachineDependent)</span>
00027 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00028 <span class="preprocessor"></span>
00029 <span class="keyword">extern</span> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> 
00030 <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a41">KeInitializeVhpt</a> (
00031     IN PVOID Virtual,
00032     IN ULONG Size
00033     );
00034 
00035 <span class="keyword">extern</span> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00036 <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a42">KeFillLargePdePinned</a> (
00037     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> Pte,
00038     IN PVOID Virtual
00039     );
00040 
00041 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00042 <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a54">MiConvertToSuperPages</a>(
00043     PVOID StartVirtual,
00044     PVOID EndVirtual,
00045     SIZE_T PageSize,
00046     ULONG PageShift
00047     );
00048 
00049 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00050 <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a44">MiConvertBackToStandardPages</a>(
00051     IN PVOID StartVirtual,
00052     IN PVOID EndVirtual
00053     );
00054 
00055 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00056 <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a45">MiBuildPageTableForDrivers</a>(
00057     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock
00058     );
00059 
00060 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00061 <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a46">MiBuildPageTableForLoaderMemory</a>(
00062     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock
00063     );
00064 
00065 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00066 <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a47">MiRemoveLoaderSuperPages</a>(
00067     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock
00068     );
00069 
00070 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00071 <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a48">MiMakeKernelPagesPermanent</a>(
00072     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock
00073     );
00074 
00075 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00076 <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a49">MiCheckMemoryDescriptorList</a>(
00077     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock
00078     );
00079 
<a name="l00080"></a><a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a18">00080</a> ULONG_PTR <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a18">MmKseg3VhptBase</a>;
<a name="l00081"></a><a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a19">00081</a> ULONG <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a19">MmKseg3VhptPs</a>;
00082 
<a name="l00083"></a><a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a20">00083</a> PFN_NUMBER <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a20">MmSystemParentTablePage</a>;
<a name="l00084"></a><a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a21">00084</a> <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a21">MiSystemSelfMappedPte</a>;
<a name="l00085"></a><a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a22">00085</a> <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a22">MiUserSelfMappedPte</a>;
<a name="l00086"></a><a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a23">00086</a> PVOID <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a23">MiKseg0Start</a> = 0;
<a name="l00087"></a><a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a24">00087</a> PVOID <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a24">MiKseg0End</a> = 0;
<a name="l00088"></a><a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a25">00088</a> BOOLEAN <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a25">MiKseg0Mapping</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
<a name="l00089"></a><a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a26">00089</a> BOOLEAN <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a26">MiPrintMemoryDescriptors</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
<a name="l00090"></a><a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a27">00090</a> PFN_NUMBER <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a27">MiNtoskrnlPhysicalBase</a>;
<a name="l00091"></a><a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a28">00091</a> ULONG_PTR <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a28">MiNtoskrnlVirtualBase</a>;
<a name="l00092"></a><a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a29">00092</a> ULONG <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a29">MiNtoskrnlPageShift</a>;
<a name="l00093"></a><a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a30">00093</a> PFN_NUMBER <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a30">MiWasteStart</a> = 0;
<a name="l00094"></a><a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a31">00094</a> PFN_NUMBER <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a31">MiWasteEnd</a> = 0;
00095 
<a name="l00096"></a><a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a0">00096</a> <span class="preprocessor">#define MiGetKSegPteAddress(Va) ((PMMPTE)__thash((ULONG_PTR)(Va)))</span>
00097 <span class="preprocessor"></span>
<a name="l00098"></a><a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a1">00098</a> <span class="preprocessor">#define _x1mb (1024*1024)</span>
<a name="l00099"></a><a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a2">00099</a> <span class="preprocessor"></span><span class="preprocessor">#define _x1mbnp ((1024*1024) &gt;&gt; PAGE_SHIFT)</span>
<a name="l00100"></a><a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a3">00100</a> <span class="preprocessor"></span><span class="preprocessor">#define _x4mb (1024*1024*4)</span>
<a name="l00101"></a><a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a4">00101</a> <span class="preprocessor"></span><span class="preprocessor">#define _x4mbnp ((1024*1024*4) &gt;&gt; PAGE_SHIFT)</span>
<a name="l00102"></a><a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a5">00102</a> <span class="preprocessor"></span><span class="preprocessor">#define _x16mb (1024*1024*16)</span>
<a name="l00103"></a><a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a6">00103</a> <span class="preprocessor"></span><span class="preprocessor">#define _x16mbnp ((1024*1024*16) &gt;&gt; PAGE_SHIFT)</span>
<a name="l00104"></a><a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a7">00104</a> <span class="preprocessor"></span><span class="preprocessor">#define _x32mb (1024*1024*32)</span>
<a name="l00105"></a><a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a8">00105</a> <span class="preprocessor"></span><span class="preprocessor">#define _x32mbnp ((1024*1024*32) &gt;&gt; PAGE_SHIFT)</span>
<a name="l00106"></a><a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a9">00106</a> <span class="preprocessor"></span><span class="preprocessor">#define _x64mb (1024*1024*64)</span>
<a name="l00107"></a><a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a10">00107</a> <span class="preprocessor"></span><span class="preprocessor">#define _x64mbnp ((1024*1024*64) &gt;&gt; PAGE_SHIFT)</span>
<a name="l00108"></a><a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a11">00108</a> <span class="preprocessor"></span><span class="preprocessor">#define _x256mb (1024*1024*256)</span>
<a name="l00109"></a><a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a12">00109</a> <span class="preprocessor"></span><span class="preprocessor">#define _x256mbnp ((1024*1024*256) &gt;&gt; PAGE_SHIFT)</span>
<a name="l00110"></a><a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a13">00110</a> <span class="preprocessor"></span><span class="preprocessor">#define _x512mb (1024*1024*512)</span>
<a name="l00111"></a><a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a14">00111</a> <span class="preprocessor"></span><span class="preprocessor">#define _x512mbnp ((1024*1024*512) &gt;&gt; PAGE_SHIFT)</span>
<a name="l00112"></a><a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a15">00112</a> <span class="preprocessor"></span><span class="preprocessor">#define _x4gb (0x100000000UI64)</span>
<a name="l00113"></a><a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a16">00113</a> <span class="preprocessor"></span><span class="preprocessor">#define _x4gbnp (0x100000000UI64 &gt;&gt; PAGE_SHIFT)</span>
00114 <span class="preprocessor"></span>
<a name="l00115"></a><a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a17">00115</a> <span class="preprocessor">#define ADD_HIGH_MEMORY 0</span>
00116 <span class="preprocessor"></span>
00117 <span class="preprocessor">#if ADD_HIGH_MEMORY</span>
00118 <span class="preprocessor"></span><a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html">MEMORY_ALLOCATION_DESCRIPTOR</a> MiHighMemoryDescriptor;
00119 <span class="preprocessor">#endif</span>
00120 <span class="preprocessor"></span>
<a name="l00121"></a><a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a32">00121</a> <a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html">PMEMORY_ALLOCATION_DESCRIPTOR</a> <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a32">MiFreeDescriptor</a>;
<a name="l00122"></a><a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a33">00122</a> <a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html">PMEMORY_ALLOCATION_DESCRIPTOR</a> <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a33">MiFreeDescriptorLargest</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
<a name="l00123"></a><a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a34">00123</a> <a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html">PMEMORY_ALLOCATION_DESCRIPTOR</a> <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a34">MiFreeDescriptorLowMem</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
<a name="l00124"></a><a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a35">00124</a> <a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html">PMEMORY_ALLOCATION_DESCRIPTOR</a> <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a35">MiFreeDescriptorNonPaged</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00125 
<a name="l00126"></a><a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a36">00126</a> PFN_NUMBER <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a36">MiNextPhysicalPage</a>;
<a name="l00127"></a><a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a37">00127</a> PFN_NUMBER <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a37">MiNumberOfPages</a>;
<a name="l00128"></a><a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a38">00128</a> PFN_NUMBER <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a38">MiOldFreeDescriptorBase</a>;
<a name="l00129"></a><a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a39">00129</a> PFN_NUMBER <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a39">MiOldFreeDescriptorCount</a>;
00130 
00131 <span class="comment">//</span>
00132 <span class="comment">// Processor Specific VM information</span>
00133 <span class="comment">//</span>
00134 
<a name="l00135"></a><a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a40">00135</a> ULONG <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a40">MiImplVirtualMsb</a> = 50;
00136 
00137 
00138 PFN_NUMBER
<a name="l00139"></a><a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a50">00139</a> <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a50">MiGetNextPhysicalPage</a> (
00140     VOID
00141     )
00142 
00143 <span class="comment">/*++</span>
00144 <span class="comment"></span>
00145 <span class="comment">Routine Description:</span>
00146 <span class="comment"></span>
00147 <span class="comment">    This function returns the next physical page number from either the</span>
00148 <span class="comment">    largest low memory descritor or the largest free descriptor. If there</span>
00149 <span class="comment">    are no physical pages left, then a bugcheck is executed since the</span>
00150 <span class="comment">    system cannot be initialized.</span>
00151 <span class="comment"></span>
00152 <span class="comment">Arguments:</span>
00153 <span class="comment"></span>
00154 <span class="comment">    LoaderBlock - Supplies the address of the loader block.</span>
00155 <span class="comment"></span>
00156 <span class="comment">Return Value:</span>
00157 <span class="comment"></span>
00158 <span class="comment">    None.</span>
00159 <span class="comment"></span>
00160 <span class="comment">Environment:</span>
00161 <span class="comment"></span>
00162 <span class="comment">    Kernel mode.</span>
00163 <span class="comment"></span>
00164 <span class="comment">--*/</span>
00165 
00166 {
00167 
00168     <span class="comment">//</span>
00169     <span class="comment">// If there are free pages left in the current descriptor, then</span>
00170     <span class="comment">// return the next physical page. Otherwise, attempt to switch</span>
00171     <span class="comment">// descriptors.</span>
00172     <span class="comment">//</span>
00173 
00174     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a37">MiNumberOfPages</a> != 0) {
00175         <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a37">MiNumberOfPages</a> -= 1;
00176         <span class="keywordflow">return</span> <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a36">MiNextPhysicalPage</a>++;
00177 
00178     } <span class="keywordflow">else</span> {
00179 
00180         <span class="comment">//</span>
00181         <span class="comment">// If the current descriptor is not the largest free descriptor,</span>
00182         <span class="comment">// then switch to the largest free descriptor. Otherwise, bugcheck.</span>
00183         <span class="comment">//</span>
00184 
00185         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a32">MiFreeDescriptor</a> == <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a33">MiFreeDescriptorLargest</a>) {
00186 
00187             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(INSTALL_MORE_MEMORY,
00188                          <a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a>,
00189                          <a class="code" href="../../d6/d8/sysinfo_8c.html#a6">MmLowestPhysicalPage</a>,
00190                          <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>,
00191                          0);
00192 
00193             <span class="keywordflow">return</span> 0;
00194 
00195         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a32">MiFreeDescriptor</a> == <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a34">MiFreeDescriptorLowMem</a>) {
00196             
00197             <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a39">MiOldFreeDescriptorCount</a> = <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a33">MiFreeDescriptorLargest</a>-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
00198             <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a38">MiOldFreeDescriptorBase</a> = <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a33">MiFreeDescriptorLargest</a>-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>;
00199         
00200             <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a32">MiFreeDescriptor</a> = <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a33">MiFreeDescriptorLargest</a>;
00201             <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a37">MiNumberOfPages</a> = <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a33">MiFreeDescriptorLargest</a>-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> - 1;
00202             <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a36">MiNextPhysicalPage</a> = <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a33">MiFreeDescriptorLargest</a>-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>;
00203 
00204             <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a34">MiFreeDescriptorLowMem</a>-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> = 0;
00205 
00206             <span class="keywordflow">return</span> <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a36">MiNextPhysicalPage</a>++;
00207 
00208         } <span class="keywordflow">else</span> {
00209 
00210             <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a39">MiOldFreeDescriptorCount</a> = <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a34">MiFreeDescriptorLowMem</a>-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
00211             <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a38">MiOldFreeDescriptorBase</a> = <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a34">MiFreeDescriptorLowMem</a>-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>;
00212         
00213             <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a32">MiFreeDescriptor</a> = <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a34">MiFreeDescriptorLowMem</a>;
00214             <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a37">MiNumberOfPages</a> = <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a34">MiFreeDescriptorLowMem</a>-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> - 1;
00215             <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a36">MiNextPhysicalPage</a> = <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a34">MiFreeDescriptorLowMem</a>-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>;
00216 
00217             <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a35">MiFreeDescriptorNonPaged</a>-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> = 0;
00218 
00219             <span class="keywordflow">return</span> <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a36">MiNextPhysicalPage</a>++;
00220         }
00221     }
00222 }
00223 
00224 BOOLEAN
<a name="l00225"></a><a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a51">00225</a> <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a51">MiEnsureAvailablePagesInFreeDescriptor</a>(
00226     IN PFN_NUMBER Pages,
00227     IN PFN_NUMBER MaxPage
00228     )
00229 {
00230     <span class="keywordflow">if</span> ((<a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a37">MiNumberOfPages</a> &lt; Pages) &amp;&amp;
00231         (<a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a32">MiFreeDescriptor</a> == <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a35">MiFreeDescriptorNonPaged</a>)) {
00232 
00233         <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a32">MiFreeDescriptor</a>-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> = (ULONG)<a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a36">MiNextPhysicalPage</a>;
00234         <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a32">MiFreeDescriptor</a>-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> = (PFN_COUNT)<a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a37">MiNumberOfPages</a>;
00235 
00236         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a32">MiFreeDescriptor</a> != <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a34">MiFreeDescriptorLowMem</a>) {
00237 
00238             <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a39">MiOldFreeDescriptorCount</a> = <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a34">MiFreeDescriptorLowMem</a>-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
00239             <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a38">MiOldFreeDescriptorBase</a> = <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a34">MiFreeDescriptorLowMem</a>-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>;
00240         
00241             <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a32">MiFreeDescriptor</a> = <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a34">MiFreeDescriptorLowMem</a>;
00242             <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a37">MiNumberOfPages</a> = <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a34">MiFreeDescriptorLowMem</a>-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
00243             <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a36">MiNextPhysicalPage</a> = <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a34">MiFreeDescriptorLowMem</a>-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>;
00244 
00245         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a32">MiFreeDescriptor</a> != <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a33">MiFreeDescriptorLargest</a>) {
00246 
00247             <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a39">MiOldFreeDescriptorCount</a> = <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a33">MiFreeDescriptorLargest</a>-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
00248             <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a38">MiOldFreeDescriptorBase</a> = <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a33">MiFreeDescriptorLargest</a>-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>;
00249         
00250             <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a32">MiFreeDescriptor</a> = <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a33">MiFreeDescriptorLargest</a>;
00251             <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a37">MiNumberOfPages</a> = <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a33">MiFreeDescriptorLargest</a>-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
00252             <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a36">MiNextPhysicalPage</a> = <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a33">MiFreeDescriptorLargest</a>-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>;
00253 
00254         } <span class="keywordflow">else</span> {
00255 
00256             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(INSTALL_MORE_MEMORY,
00257                          <a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a>,
00258                          <a class="code" href="../../d6/d8/sysinfo_8c.html#a6">MmLowestPhysicalPage</a>,
00259                          <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>,
00260                          1);
00261         }
00262     }
00263 
00264     <span class="keywordflow">if</span> (MaxPage &lt; (<a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a32">MiFreeDescriptor</a>-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> + Pages)) {
00265 
00266         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00267 
00268     } <span class="keywordflow">else</span> {
00269 
00270         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00271 
00272     }
00273 }
00274 
00275 
00276 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00277"></a><a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a52">00277</a> <a class="code" href="../../d2/d3/initppc_8c.html#a1">MiInitMachineDependent</a> (
00278     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock
00279     )
00280 
00281 <span class="comment">/*++</span>
00282 <span class="comment"></span>
00283 <span class="comment">Routine Description:</span>
00284 <span class="comment"></span>
00285 <span class="comment">    This routine performs the necessary operations to enable virtual</span>
00286 <span class="comment">    memory.  This includes building the page directory page, building</span>
00287 <span class="comment">    page table pages to map the code section, the data section, the'</span>
00288 <span class="comment">    stack section and the trap handler.</span>
00289 <span class="comment"></span>
00290 <span class="comment">    It also initializes the PFN database and populates the free list.</span>
00291 <span class="comment"></span>
00292 <span class="comment"></span>
00293 <span class="comment">Arguments:</span>
00294 <span class="comment"></span>
00295 <span class="comment">    LoaderBlock  - Supplies a pointer to the firmware setup loader block.</span>
00296 <span class="comment"></span>
00297 <span class="comment">Return Value:</span>
00298 <span class="comment"></span>
00299 <span class="comment">    None.</span>
00300 <span class="comment"></span>
00301 <span class="comment">Environment:</span>
00302 <span class="comment"></span>
00303 <span class="comment">    Kernel mode.</span>
00304 <span class="comment"></span>
00305 <span class="comment">--*/</span>
00306 
00307 {
00308     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> BasePfn;
00309     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> BottomPfn;
00310     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> TopPfn;
00311     SIZE_T Range;
00312     PFN_NUMBER i;
00313     ULONG j;
00314     PFN_NUMBER PdePageNumber;
00315     PFN_NUMBER PdePage;
00316     PFN_NUMBER PageFrameIndex;
00317     PFN_NUMBER NextPhysicalPage;
00318     SPFN_NUMBER PfnAllocation;
00319     SPFN_NUMBER NumberOfPages;
00320     SIZE_T MaxPool;
00321     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess;
00322     PFN_NUMBER MostFreePage = 0;
00323     PFN_NUMBER MostFreeLowMem = 0;
00324     PFN_NUMBER MostFreeNonPaged = 0;
00325     PLIST_ENTRY NextMd;
00326     <a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html">PMEMORY_ALLOCATION_DESCRIPTOR</a> MemoryDescriptor;
00327     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
00328     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
00329     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00330     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartPte;
00331     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
00332     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> EndPte;
00333     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> Pde;
00334     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartPde;
00335     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartPpe;
00336     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> EndPde;
00337     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> FirstPpe;
00338     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
00339     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn2;
00340     ULONG First;
00341     KIRQL OldIrql;
00342     ULONG_PTR va;
00343     SIZE_T Kseg0Size = 0;
00344     PVOID NonPagedPoolStartVirtual;
00345     ULONG i1;
00346     ULONG i2;
00347     PFN_NUMBER PhysicalPages;
00348     ULONG_PTR HighestPageAddress;
00349     ULONG_PTR Kseg3VhptSize;
00350     PFN_NUMBER Kseg3VhptPn;
00351     ULONG_PTR size;
00352     ULONG_PTR PageSize;
00353     PFN_NUMBER KernelStart;
00354     PFN_NUMBER KernelEnd;
00355 
00356     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d1/init_8h.html#a21">InitializationPhase</a> == 1) {
00357 
00358         <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a48">MiMakeKernelPagesPermanent</a>(LoaderBlock);
00359 
00360         <span class="keywordflow">return</span>;
00361 
00362     }
00363 
00364     <span class="comment">//</span>
00365     <span class="comment">// Initialize the kernel mapping info</span>
00366     <span class="comment">//</span>
00367 
00368     <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a27">MiNtoskrnlPhysicalBase</a> = LoaderBlock-&gt;u.Ia64.ItrInfo[ITR_KERNEL_INDEX].PhysicalAddress;
00369     <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a28">MiNtoskrnlVirtualBase</a> = LoaderBlock-&gt;u.Ia64.ItrInfo[ITR_KERNEL_INDEX].VirtualAddress;
00370     <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a29">MiNtoskrnlPageShift</a> = LoaderBlock-&gt;u.Ia64.ItrInfo[ITR_KERNEL_INDEX].PageSize;
00371 
00372     KernelStart = <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a27">MiNtoskrnlPhysicalBase</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
00373     PageSize = (ULONG_PTR)1 &lt;&lt; <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a29">MiNtoskrnlPageShift</a>;
00374     KernelEnd = KernelStart + (PageSize &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
00375 
00376     <span class="comment">//</span>
00377     <span class="comment">// Initialize MmDebugPte and MmCrashDumpPte</span>
00378     <span class="comment">//</span>
00379 
00380     <a class="code" href="../../d4/d2/datalpha_8c.html#a18">MmDebugPte</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(<a class="code" href="../../d6/d8/mi386_8h.html#a40">MM_DEBUG_VA</a>);
00381 
00382     <a class="code" href="../../d4/d2/datalpha_8c.html#a19">MmCrashDumpPte</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(<a class="code" href="../../d6/d8/mi386_8h.html#a39">MM_CRASH_DUMP_VA</a>);
00383 
00384     <span class="comment">//</span>
00385     <span class="comment">// Set TempPte to ValidKernelPte for the future use</span>
00386     <span class="comment">//</span>
00387 
00388     TempPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a2">ValidKernelPte</a>;
00389 
00390     <span class="comment">//</span>
00391     <span class="comment">// Check the memory descriptor list from NT loader</span>
00392     <span class="comment">//</span>
00393 
00394     <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a49">MiCheckMemoryDescriptorList</a>(LoaderBlock);
00395 
00396 
00397     <span class="comment">//</span>
00398     <span class="comment">// Get the lower bound of the free physical memory and the</span>
00399     <span class="comment">// number of physical pages by walking the memory descriptor lists.</span>
00400     <span class="comment">//</span>
00401 
00402     NextMd = LoaderBlock-&gt;MemoryDescriptorListHead.Flink;
00403 
00404 <span class="preprocessor">#if ADD_HIGH_MEMORY</span>
00405 <span class="preprocessor"></span>    LoaderBlock-&gt;MemoryDescriptorListHead.Flink = &amp;MiHighMemoryDescriptor.<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o0">ListEntry</a>;
00406     MiHighMemoryDescriptor.<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o0">ListEntry</a>.Flink = NextMd;
00407     MiHighMemoryDescriptor.<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a> = 5;
00408     MiHighMemoryDescriptor.<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> = 0x80000;
00409     MiHighMemoryDescriptor.<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> = 0x20000;
00410     NextMd = &amp;MiHighMemoryDescriptor.<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o0">ListEntry</a>;
00411 <span class="preprocessor">#endif </span>
00412 <span class="preprocessor"></span>
00413     <span class="keywordflow">while</span> (NextMd != &amp;LoaderBlock-&gt;MemoryDescriptorListHead) {
00414 
00415         MemoryDescriptor = CONTAINING_RECORD(NextMd,
00416                                              <a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html">MEMORY_ALLOCATION_DESCRIPTOR</a>,
00417                                              ListEntry);
00418 
00419         <span class="comment">//</span>
00420         <span class="comment">// This check results in /BURNMEMORY chunks not being counted.</span>
00421         <span class="comment">//</span>
00422         
00423         <span class="keywordflow">if</span> (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a> != <a class="code" href="../../d1/d9/arc_8h.html#a320a257">LoaderBad</a>) {
00424             <a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> += MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
00425         }
00426 
00427         <span class="keywordflow">if</span> (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> &lt; <a class="code" href="../../d6/d8/sysinfo_8c.html#a6">MmLowestPhysicalPage</a>) {
00428             <a class="code" href="../../d6/d8/sysinfo_8c.html#a6">MmLowestPhysicalPage</a> = MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>;
00429         }
00430         <span class="keywordflow">if</span> ((MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> + MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>) &gt;
00431                                                          <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>) {
00432             <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a> =
00433                     MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> + MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> -1;
00434         }
00435 
00436         <span class="comment">//</span>
00437         <span class="comment">// We assume at this stage (Gambit Port) that the minimum memory requirement </span>
00438         <span class="comment">// for the iA EM is 32mb. There will be no memory hole right below the 16m </span>
00439         <span class="comment">// boundary on EM machines unlike some x86 of PC platforms. </span>
00440         <span class="comment">//</span>
00441 
00442         <span class="keywordflow">if</span> ((MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a> == <a class="code" href="../../d1/d9/arc_8h.html#a320a256">LoaderFree</a>) ||
00443             (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a> == <a class="code" href="../../d1/d9/arc_8h.html#a320a258">LoaderLoadedProgram</a>) ||
00444             (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a> == <a class="code" href="../../d1/d9/arc_8h.html#a320a259">LoaderFirmwareTemporary</a>) ||
00445             (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a> == <a class="code" href="../../d1/d9/arc_8h.html#a320a262">LoaderOsloaderStack</a>)) {
00446 
00447             <span class="keywordflow">if</span> (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> &gt; MostFreePage) {
00448                 MostFreePage = MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
00449                 <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a33">MiFreeDescriptorLargest</a> = MemoryDescriptor;
00450              }
00451 
00452             <span class="keywordflow">if</span> (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> &lt; <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a12">_x256mbnp</a>) {
00453                 
00454                 <span class="comment">//</span>
00455                 <span class="comment">// This memory descriptor is below 16mb.</span>
00456                 <span class="comment">//</span>
00457 
00458                 <span class="keywordflow">if</span> ((MostFreeLowMem &lt; MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>) &amp;&amp;
00459                     (MostFreeLowMem &lt; <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a12">_x256mbnp</a> - MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>)) {
00460                     
00461                     MostFreeLowMem = <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a12">_x256mbnp</a> - MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>;
00462                     <span class="keywordflow">if</span> (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> &lt; MostFreeLowMem) {
00463                         MostFreeLowMem = MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
00464                     }
00465 
00466                     <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a34">MiFreeDescriptorLowMem</a> = MemoryDescriptor;
00467                 }
00468             }
00469 
00470             <span class="keywordflow">if</span> ((MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> &gt;= KernelStart) &amp;&amp; 
00471                 (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> &gt; MostFreeNonPaged)) {
00472                 
00473                 MostFreeNonPaged = MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
00474                 <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a35">MiFreeDescriptorNonPaged</a> = MemoryDescriptor;
00475 
00476             }
00477 
00478         }
00479 
00480 <span class="preprocessor">#if DBG</span>
00481 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a26">MiPrintMemoryDescriptors</a>) {
00482             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MemoryType = %x\n"</span>, MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a>);
00483             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"BasePage = %p\n"</span>, (PFN_NUMBER)MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
00484             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"PageCount = %x\n\n"</span>, MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
00485         }
00486 <span class="preprocessor">#endif</span>
00487 <span class="preprocessor"></span>
00488         NextMd = MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o0">ListEntry</a>.Flink;
00489     }
00490 
00491     <a class="code" href="../../d2/d3/dumpctl_8c.html#a16">MmHighestPossiblePhysicalPage</a> = <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>;
00492 
00493     <span class="comment">//</span>
00494     <span class="comment">// If the number of physical pages is less than  16mb, then</span>
00495     <span class="comment">// bugcheck. There is not enough memory to run the system.</span>
00496     <span class="comment">//</span>
00497 
00498     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> &lt; <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a6">_x16mbnp</a>) {
00499         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (INSTALL_MORE_MEMORY,
00500                       <a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a>,
00501                       <a class="code" href="../../d6/d8/sysinfo_8c.html#a6">MmLowestPhysicalPage</a>,
00502                       <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>,
00503                       2);
00504     }
00505 
00506     <span class="comment">//</span>
00507     <span class="comment">// initialize the next page allocation variable &amp; structures</span>
00508     <span class="comment">//</span>
00509 
00510 
00511     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a35">MiFreeDescriptorNonPaged</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00512 
00513         <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a32">MiFreeDescriptor</a> = <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a35">MiFreeDescriptorNonPaged</a>;
00514 
00515     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a34">MiFreeDescriptorLowMem</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00516 
00517         <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a32">MiFreeDescriptor</a> = <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a34">MiFreeDescriptorLowMem</a>;
00518 
00519     } <span class="keywordflow">else</span> {
00520 
00521         <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a32">MiFreeDescriptor</a> = <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a33">MiFreeDescriptorLargest</a>;
00522     }
00523 
00524     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a34">MiFreeDescriptorLowMem</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00525 
00526         <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a25">MiKseg0Mapping</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00527 
00528     }
00529 
00530     <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a36">MiNextPhysicalPage</a> = <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a32">MiFreeDescriptor</a>-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>;
00531     <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a37">MiNumberOfPages</a> = <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a32">MiFreeDescriptor</a>-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
00532     <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a39">MiOldFreeDescriptorCount</a> = <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a32">MiFreeDescriptor</a>-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
00533     <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a38">MiOldFreeDescriptorBase</a> = <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a32">MiFreeDescriptor</a>-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>;
00534 
00535     <span class="comment">//</span>
00536     <span class="comment">// Produce the size of the Kseg 0 space</span>
00537     <span class="comment">// </span>
00538 
00539     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a25">MiKseg0Mapping</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00540 
00541 
00542         <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a23">MiKseg0Start</a> = <a class="code" href="../../d4/d6/alpha_2allproc_8c.html#a5">KSEG0_ADDRESS</a>(<a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a36">MiNextPhysicalPage</a>);
00543 
00544         Kseg0Size = <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a36">MiNextPhysicalPage</a> + <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a37">MiNumberOfPages</a>;
00545     
00546         <span class="keywordflow">if</span> (Kseg0Size &gt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a8">MM_PAGES_IN_KSEG0</a>) {
00547             Kseg0Size = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a8">MM_PAGES_IN_KSEG0</a> - (<a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a6">_x16mbnp</a> * 3); 
00548         }
00549 
00550         Kseg0Size = Kseg0Size &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
00551 
00552     } <span class="keywordflow">else</span> {
00553         
00554         <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a25">MiKseg0Mapping</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00555         Kseg0Size = 0;
00556 
00557     }
00558 
00559     <span class="comment">//</span>
00560     <span class="comment">// Initialize VHPT registers</span>
00561     <span class="comment">//</span>
00562 
00563     <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a41">KeInitializeVhpt</a> ((PVOID)PTA_BASE, <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a40">MiImplVirtualMsb</a> - <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a> + <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a52">PTE_SHIFT</a>);
00564 
00565     <span class="comment">//</span>
00566     <span class="comment">// Build 1 to 1 virtual to physical mapping space</span>
00567     <span class="comment">//</span>
00568 
00569 <span class="preprocessor">#if defined(KSEG_VHPT)</span>
00570 <span class="preprocessor"></span>    HighestPageAddress = ((ULONG_PTR)<a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a> &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
00571     
00572     HighestPageAddress = (HighestPageAddress + (ULONG_PTR)<a class="code" href="../../d4/d8/mi_8h.html#a18">X64K</a> - 1) &amp; ~((ULONG_PTR)<a class="code" href="../../d4/d8/mi_8h.html#a18">X64K</a> - 1);
00573         
00574     Kseg3VhptSize = HighestPageAddress &gt;&gt; 16 &lt;&lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a52">PTE_SHIFT</a>;
00575 
00576     size = (Kseg3VhptSize-1) &gt;&gt; 12;  <span class="comment">// make the base page size 4KB</span>
00577     PageSize = 12;
00578 
00579     <span class="keywordflow">while</span> (size != 0) {
00580         size = size &gt;&gt; 2;
00581         PageSize += 2;
00582     }
00583 
00584     Kseg3VhptSize = (ULONG_PTR)1 &lt;&lt; PageSize;
00585 
00586     Kseg3VhptPages = (PFN_NUMBER)(Kseg3VhptSize &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
00587 
00588     <span class="keywordflow">if</span> ((<a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a32">MiFreeDescriptor</a>-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> &amp; (<a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a6">_x16mbnp</a> - 1)) != 0) {
00589         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (INSTALL_MORE_MEMORY,
00590                       <a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a>,
00591                       <a class="code" href="../../d6/d8/sysinfo_8c.html#a6">MmLowestPhysicalPage</a>,
00592                       <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>,
00593                       3);
00594     }
00595 
00596     <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a18">MmKseg3VhptBase</a> = <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a36">MiNextPhysicalPage</a>;
00597     <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a36">MiNextPhysicalPage</a> += Kseg3VhptPages;
00598     <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a37">MiNumberOfPages</a> -= Kseg3VhptPages;
00599 
00600     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a37">MiNumberOfPages</a> &lt; 0) {
00601 
00602         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(INSTALL_MORE_MEMORY,
00603                      <a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a>,
00604                      <a class="code" href="../../d6/d8/sysinfo_8c.html#a6">MmLowestPhysicalPage</a>,
00605                      <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>,
00606                      4);
00607     }
00608 
00609 <span class="preprocessor">#endif</span>
00610 <span class="preprocessor"></span>
00611     <span class="comment">//</span>
00612     <span class="comment">// Build a parent directory page table for the kernel space</span>
00613     <span class="comment">//</span>
00614 
00615     PdePageNumber = (PFN_NUMBER)LoaderBlock-&gt;u.Ia64.PdrPage;
00616     
00617     <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a20">MmSystemParentTablePage</a> = <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a50">MiGetNextPhysicalPage</a>();
00618 
00619     RtlZeroMemory(KSEG_ADDRESS(<a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a20">MmSystemParentTablePage</a>), <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
00620 
00621     TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a20">MmSystemParentTablePage</a>;
00622     
00623     <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a21">MiSystemSelfMappedPte</a> = TempPte;
00624 
00625     KeFillFixedEntryTb((PHARDWARE_PTE)&amp;TempPte, (PVOID)<a class="code" href="../../d9/d8/axp64_2mialpha_8h.html#a5">PDE_KTBASE</a>, DTR_KTBASE_INDEX_TMP);
00626 
00627     <span class="comment">//</span>
00628     <span class="comment">// Install the self-mapped Ppe entry into the kernel parent directory table</span>
00629     <span class="comment">//</span>
00630 
00631     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(<a class="code" href="../../d9/d8/axp64_2mialpha_8h.html#a5">PDE_KTBASE</a>);
00632 
00633     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a>(PointerPte, TempPte);
00634 
00635     <span class="comment">//</span>
00636     <span class="comment">// Install the kernel image Ppe entry into the parent directory table</span>
00637     <span class="comment">//</span>
00638 
00639     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(PDE_KBASE);
00640 
00641     TempPte.u.Hard.PageFrameNumber = PdePageNumber;
00642 
00643     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a>(PointerPte, TempPte);
00644 
00645     <span class="comment">//</span>
00646     <span class="comment">// Build a parent directory page table for the user space</span>
00647     <span class="comment">//</span>
00648 
00649     NextPhysicalPage = <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a50">MiGetNextPhysicalPage</a>();
00650 
00651     RtlZeroMemory (KSEG_ADDRESS(NextPhysicalPage), <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
00652     
00653     TempPte.u.Hard.PageFrameNumber = NextPhysicalPage;
00654 
00655     <a class="code" href="../../d6/d9/mippc_8h.html#a84">INITIALIZE_DIRECTORY_TABLE_BASE</a> 
00656       (&amp;(<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Pcb.DirectoryTableBase[0]), NextPhysicalPage);
00657 
00658     <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a22">MiUserSelfMappedPte</a> = TempPte;
00659 
00660     KeFillFixedEntryTb((PHARDWARE_PTE)&amp;TempPte, (PVOID)PDE_UTBASE, DTR_UTBASE_INDEX_TMP);
00661 
00662     <span class="comment">//</span>
00663     <span class="comment">// Install the self-mapped entry into the user parent directory table</span>
00664     <span class="comment">//</span>
00665 
00666     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(PDE_UTBASE);
00667 
00668     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a>(PointerPte, TempPte);
00669 
00670     <span class="comment">//</span>
00671     <span class="comment">// Build a parent directory page table for the hydra space</span>
00672     <span class="comment">//</span>
00673 
00674     NextPhysicalPage = <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a50">MiGetNextPhysicalPage</a>();
00675 
00676     RtlZeroMemory (KSEG_ADDRESS(NextPhysicalPage), <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
00677     
00678     TempPte.u.Hard.PageFrameNumber = NextPhysicalPage;
00679 
00680     <a class="code" href="../../d6/d9/mippc_8h.html#a84">INITIALIZE_DIRECTORY_TABLE_BASE</a> 
00681       (&amp;(<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Pcb.SessionParentBase), NextPhysicalPage);
00682 
00683     KeFillFixedEntryTb((PHARDWARE_PTE)&amp;TempPte, (PVOID)PDE_STBASE, DTR_STBASE_INDEX);
00684 
00685     <span class="comment">//</span>
00686     <span class="comment">// Install the self-mapped entry into the hydra parent directory table</span>
00687     <span class="comment">//</span>
00688 
00689     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(PDE_STBASE);
00690 
00691     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a>(PointerPte, TempPte);
00692 
00693     <span class="comment">//</span>
00694     <span class="comment">// Build Vhpt table for KSEG3 </span>
00695     <span class="comment">//</span>
00696 
00697 <span class="preprocessor">#if defined(KSEG_VHPT)</span>
00698 <span class="preprocessor"></span>    va = <a class="code" href="../../d4/d6/alpha_2allproc_8c.html#a5">KSEG0_ADDRESS</a>(<a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a18">MmKseg3VhptBase</a>);
00699     
00700     RtlZeroMemory((PVOID)va, Kseg3VhptSize);
00701 
00702     TempPte.u.Hard.PageFrameNumber = <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a18">MmKseg3VhptBase</a>;
00703 
00704     PointerPte = <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a0">MiGetKSegPteAddress</a>(KSEG3_BASE);
00705 
00706     KeFillFixedLargeEntryTb((PHARDWARE_PTE)&amp;TempPte, 
00707                             (PVOID)PointerPte,
00708                             PageSize,
00709                             DTR_KSEG3_INDEX);
00710 
00711     <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a19">MmKseg3VhptPs</a> = PageSize;
00712 <span class="preprocessor">#endif </span>
00713 <span class="preprocessor"></span>
00714     <span class="comment">//</span>
00715     <span class="comment">// Build non-paged pool using the physical pages following the</span>
00716     <span class="comment">// data page in which to build the pool from.  Non-page pool grows</span>
00717     <span class="comment">// from the high range of the virtual address space and expands</span>
00718     <span class="comment">// downward.</span>
00719     <span class="comment">//</span>
00720     <span class="comment">// At this time non-paged pool is constructed so virtual addresses</span>
00721     <span class="comment">// are also physically contiguous.</span>
00722     <span class="comment">//</span>
00723 
00724     <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>) &gt;
00725                         (7 * (<a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> &lt;&lt; 3))) {
00726 
00727         <span class="comment">//</span>
00728         <span class="comment">// More than 7/8 of memory allocated to nonpagedpool, reset to 0.</span>
00729         <span class="comment">//</span>
00730 
00731         <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> = 0;
00732     }
00733 
00734     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> &lt; <a class="code" href="../../d4/d8/mi_8h.html#a620">MmMinimumNonPagedPoolSize</a>) {
00735 
00736         <span class="comment">//</span>
00737         <span class="comment">// Calculate the size of nonpaged pool.</span>
00738         <span class="comment">// Use the minimum size, then for every MB about 4mb add extra</span>
00739         <span class="comment">// pages.</span>
00740         <span class="comment">//</span>
00741 
00742         <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> = <a class="code" href="../../d4/d8/mi_8h.html#a620">MmMinimumNonPagedPoolSize</a>;
00743 
00744         <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> +=
00745             ((<a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> - <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a6">_x16mbnp</a>)/<a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a2">_x1mbnp</a>) *
00746             <a class="code" href="../../d4/d8/mi_8h.html#a622">MmMinAdditionNonPagedPoolPerMb</a>;
00747     }
00748 
00749     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> &gt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a30">MM_MAX_INITIAL_NONPAGED_POOL</a>) {
00750         <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a30">MM_MAX_INITIAL_NONPAGED_POOL</a>;
00751     }
00752 
00753     <span class="comment">//</span>
00754     <span class="comment">// Align to page size boundary.</span>
00755     <span class="comment">//</span>
00756 
00757     <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> &amp;= ~(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1);
00758 
00759     <span class="comment">//</span>
00760     <span class="comment">// Calculate the maximum size of pool.</span>
00761     <span class="comment">//</span>
00762 
00763     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a> == 0) {
00764 
00765         <span class="comment">//</span>
00766         <span class="comment">// Calculate the size of nonpaged pool.  If 4mb of less use</span>
00767         <span class="comment">// the minimum size, then for every MB about 4mb add extra</span>
00768         <span class="comment">// pages.</span>
00769         <span class="comment">//</span>
00770 
00771         <a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a> = <a class="code" href="../../d4/d8/mi_8h.html#a621">MmDefaultMaximumNonPagedPool</a>;
00772 
00773         <span class="comment">//</span>
00774         <span class="comment">// Make sure enough expansion for pfn database exists.</span>
00775         <span class="comment">//</span>
00776 
00777         <a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a> += (<a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d3/struct__MMPFN.html">MMPFN</a>)) &amp; ~(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>-1);
00778 
00779         <a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a> +=
00780             ((<a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> - <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a6">_x16mbnp</a>)/<a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a2">_x1mbnp</a>) *
00781             <a class="code" href="../../d4/d8/mi_8h.html#a623">MmMaxAdditionNonPagedPoolPerMb</a>;
00782 
00783     }
00784 
00785     MaxPool = <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> * 16 +
00786                 ((<a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d3/struct__MMPFN.html">MMPFN</a>)) &amp; ~(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> -1));
00787 
00788     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a> &lt; MaxPool) {
00789         <a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a> = MaxPool;
00790     }
00791 
00792     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a> &gt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a31">MM_MAX_ADDITIONAL_NONPAGED_POOL</a>) {
00793         <a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a31">MM_MAX_ADDITIONAL_NONPAGED_POOL</a>;
00794     }
00795 
00796     <a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a> = (PVOID)((ULONG_PTR)<a class="code" href="../../d8/d5/kddata_8c.html#a24">MmNonPagedPoolEnd</a>
00797                                       - <a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a>);
00798 
00799     <a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a> = (PVOID)<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(<a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a>);
00800 
00801     <a class="code" href="../../d4/d8/mi_8h.html#a653">MmPageAlignedPoolBase</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>] = <a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a>;
00802 
00803     <span class="comment">//</span>
00804     <span class="comment">// Calculate the starting PDE for the system PTE pool which is</span>
00805     <span class="comment">// right below the nonpaged pool.</span>
00806     <span class="comment">//</span>
00807 
00808     <a class="code" href="../../d8/d5/kddata_8c.html#a22">MmNonPagedSystemStart</a> = (PVOID)(((ULONG_PTR)<a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a> -
00809                                 ((<a class="code" href="../../d8/d0/cmdat3_8c.html#a23">MmNumberOfSystemPtes</a> + 1) * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>)) &amp;
00810                                  (~<a class="code" href="../../d9/d8/axp64_2mialpha_8h.html#a48">PAGE_DIRECTORY2_MASK</a>));
00811 
00812     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a22">MmNonPagedSystemStart</a> &lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a22">MM_LOWEST_NONPAGED_SYSTEM_START</a>) {
00813         <a class="code" href="../../d8/d5/kddata_8c.html#a22">MmNonPagedSystemStart</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a22">MM_LOWEST_NONPAGED_SYSTEM_START</a>;
00814         <a class="code" href="../../d8/d0/cmdat3_8c.html#a23">MmNumberOfSystemPtes</a> = (ULONG)(((ULONG_PTR)<a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a> -
00815                                 (ULONG_PTR)<a class="code" href="../../d8/d5/kddata_8c.html#a22">MmNonPagedSystemStart</a>) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>)-1;
00816         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a23">MmNumberOfSystemPtes</a> &gt; 1000);
00817     }
00818 
00819 
00820     <span class="comment">//</span>
00821     <span class="comment">// Allocate a page directory and a pair of page table pages.</span>
00822     <span class="comment">// Map the hyper space page directory page into the top level parent</span>
00823     <span class="comment">// directory &amp; the hyper space page table page into the page directory</span>
00824     <span class="comment">// and map an additional page that will eventually be used for the</span>
00825     <span class="comment">// working set list.  Page tables after the first two are set up later</span>
00826     <span class="comment">// on during individual process working set initialization.</span>
00827     <span class="comment">//</span>
00828     <span class="comment">// The working set list page will eventually be a part of hyper space.</span>
00829     <span class="comment">// It is mapped into the second level page directory page so it can be</span>
00830     <span class="comment">// zeroed and so it will be accounted for in the PFN database. Later</span>
00831     <span class="comment">// the page will be unmapped, and its page frame number captured in the</span>
00832     <span class="comment">// system process object.</span>
00833     <span class="comment">//</span>
00834 
00835     TempPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a6">ValidPdePde</a>;
00836     StartPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a63">HYPER_SPACE</a>);
00837     StartPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a>(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a63">HYPER_SPACE</a>); 
00838     EndPde = StartPde;
00839     First = (StartPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00840 
00841     <span class="keywordflow">while</span> (StartPde &lt;= EndPde) {
00842 
00843         <span class="keywordflow">if</span> (First == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> || <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a>(StartPde)) {
00844             First = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00845             StartPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(StartPde);
00846             <span class="keywordflow">if</span> (StartPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
00847                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (StartPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0);
00848                 NextPhysicalPage = <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a50">MiGetNextPhysicalPage</a>();
00849                 RtlZeroMemory(KSEG_ADDRESS(NextPhysicalPage), <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
00850                 TempPte.u.Hard.PageFrameNumber = NextPhysicalPage;
00851                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a>(StartPpe, TempPte);
00852             }
00853         }
00854         NextPhysicalPage = <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a50">MiGetNextPhysicalPage</a>();
00855         RtlZeroMemory(KSEG_ADDRESS(NextPhysicalPage), <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
00856         TempPte.u.Hard.PageFrameNumber = NextPhysicalPage;
00857         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a>(StartPde, TempPte);
00858         StartPde += 1;
00859     }
00860 
00861     <span class="comment">//</span>
00862     <span class="comment">// Allocate page directory and page table pages for</span>
00863     <span class="comment">// system PTEs and nonpaged pool.</span>
00864     <span class="comment">//</span>
00865 
00866     TempPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a2">ValidKernelPte</a>;
00867     StartPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(<a class="code" href="../../d8/d5/kddata_8c.html#a22">MmNonPagedSystemStart</a>);
00868     StartPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a>(<a class="code" href="../../d8/d5/kddata_8c.html#a22">MmNonPagedSystemStart</a>);
00869     EndPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>((ULONG_PTR)<a class="code" href="../../d8/d5/kddata_8c.html#a24">MmNonPagedPoolEnd</a> - 1);
00870     First = (StartPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00871 
00872     <span class="keywordflow">while</span> (StartPde &lt;= EndPde) {
00873 
00874         <span class="keywordflow">if</span> (First == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> || <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a>(StartPde)) {
00875             First = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00876             StartPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(StartPde);
00877             <span class="keywordflow">if</span> (StartPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
00878                 NextPhysicalPage = <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a50">MiGetNextPhysicalPage</a>();
00879                 RtlZeroMemory(KSEG_ADDRESS(NextPhysicalPage), <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
00880                 TempPte.u.Hard.PageFrameNumber = NextPhysicalPage;
00881                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a>(StartPpe, TempPte);
00882             }
00883         }
00884 
00885         <span class="keywordflow">if</span> (StartPde-&gt;u.Hard.Valid == 0) {
00886             NextPhysicalPage = <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a50">MiGetNextPhysicalPage</a>();
00887             RtlZeroMemory(KSEG_ADDRESS(NextPhysicalPage), <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
00888             TempPte.u.Hard.PageFrameNumber = NextPhysicalPage;
00889             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a>(StartPde, TempPte);
00890         }
00891         StartPde += 1;
00892     }
00893 
00894     NonPagedPoolStartVirtual = <a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a>;
00895 
00896 <span class="comment">//    MiBuildPageTableForDrivers(LoaderBlock);</span>
00897 
00898 
00899     <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a46">MiBuildPageTableForLoaderMemory</a>(LoaderBlock);
00900 
00901     <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a47">MiRemoveLoaderSuperPages</a>(LoaderBlock);
00902 
00903     <span class="comment">//</span>
00904     <span class="comment">// remove the temporary super pages for the root page table pages,</span>
00905     <span class="comment">// and remap again with DTR_KTBASE_INDEX and DTR_UTBASE_INDEX. </span>
00906     <span class="comment">//</span>
00907 
00908     KiFlushFixedDataTb(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, (PVOID)<a class="code" href="../../d9/d8/axp64_2mialpha_8h.html#a5">PDE_KTBASE</a>);
00909     KiFlushFixedDataTb(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, (PVOID)PDE_UTBASE);
00910     KeFillFixedEntryTb((PHARDWARE_PTE)&amp;<a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a21">MiSystemSelfMappedPte</a>, (PVOID)<a class="code" href="../../d9/d8/axp64_2mialpha_8h.html#a5">PDE_KTBASE</a>, DTR_KTBASE_INDEX);
00911     KeFillFixedEntryTb((PHARDWARE_PTE)&amp;<a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a22">MiUserSelfMappedPte</a>, (PVOID)PDE_UTBASE, DTR_UTBASE_INDEX);
00912 
00913     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a25">MiKseg0Mapping</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00914 
00915         <span class="comment">//</span>
00916         <span class="comment">// Fill the PDEs for KSEG0 space</span>
00917         <span class="comment">//</span>
00918 
00919         StartPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(<a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a23">MiKseg0Start</a>);
00920         EndPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>((PCHAR)<a class="code" href="../../d6/d7/halmips_8h.html#a443">KSEG0_BASE</a> + Kseg0Size);
00921 
00922         <span class="keywordflow">while</span> (StartPde &lt;= EndPde) {
00923 
00924             <span class="keywordflow">if</span> (StartPde-&gt;u.Hard.Valid == 0) {
00925                 NextPhysicalPage = <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a50">MiGetNextPhysicalPage</a>();
00926                 RtlZeroMemory(KSEG_ADDRESS(NextPhysicalPage), <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
00927                 TempPte.u.Hard.PageFrameNumber = NextPhysicalPage;
00928                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a>(StartPde, TempPte);
00929             }
00930             StartPde++;
00931         }
00932     }
00933 
00934     <span class="comment">//</span>
00935     <span class="comment">// Initial NonPagedPool allocation priorities</span>
00936     <span class="comment">//</span>
00937     <span class="comment">// 1. allocate pages from 16mb kernel image maping space and use the 16mb super page </span>
00938     <span class="comment">//    addresses</span>
00939     <span class="comment">// 2. allocate pages from low memory space ( &lt; 256mb) and use the KSEG0 addresses</span>
00940     <span class="comment">// 3. allocate pages from the largest free memory descriptor list and use</span>
00941     <span class="comment">//    MM_NON_PAGED_POOL addresses.</span>
00942     <span class="comment">//   </span>
00943 
00944     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a25">MiKseg0Mapping</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00945 
00946         <span class="comment">//</span>
00947         <span class="comment">// When KiKseg0Mapping is enabled, check to see if </span>
00948         <span class="comment">//</span>
00949 
00950         <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a25">MiKseg0Mapping</a> = 
00951             <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a51">MiEnsureAvailablePagesInFreeDescriptor</a>(<a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a>(<a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a>),
00952                                                    <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a8">MM_PAGES_IN_KSEG0</a>);
00953 
00954     }
00955 
00956     <span class="comment">//</span>
00957     <span class="comment">// Fill in the PTEs to cover the initial nonpaged pool. The physical</span>
00958     <span class="comment">// page frames to cover this range were reserved earlier from the</span>
00959     <span class="comment">// largest low memory free descriptor. The initial allocation is both</span>
00960     <span class="comment">// physically and virtually contiguous.</span>
00961     <span class="comment">//</span>
00962 
00963     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(<a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a>);
00964     LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>((PCHAR)<a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a> +
00965                                                 <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> - 1);
00966 
00967     <span class="keywordflow">while</span> (PointerPte &lt;= LastPte) {
00968         NextPhysicalPage = <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a50">MiGetNextPhysicalPage</a>();
00969         TempPte.u.Hard.PageFrameNumber = NextPhysicalPage;
00970         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a>(PointerPte, TempPte);
00971         PointerPte++;
00972     }
00973 
00974     <span class="comment">//</span>
00975     <span class="comment">// Zero the remaining PTEs (if any) for the initial nonpaged pool up to</span>
00976     <span class="comment">// the end of the current page table page.</span>
00977     <span class="comment">//</span>
00978 
00979     <span class="keywordflow">while</span> (!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a> (PointerPte)) {
00980         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a>(PointerPte, <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>);
00981         PointerPte += 1;
00982     }
00983 
00984     <span class="comment">//</span>
00985     <span class="comment">// Convert the starting nonpaged pool address to KSEG0 space</span>
00986     <span class="comment">// address and set the address of the initial nonpaged pool allocation.</span>
00987     <span class="comment">//</span>
00988 
00989     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a25">MiKseg0Mapping</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00990 
00991 
00992         <span class="comment">//</span>
00993         <span class="comment">// No need to get page table pages for these as we can reference</span>
00994         <span class="comment">// them via large pages.</span>
00995         <span class="comment">//</span>
00996 
00997         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a>);
00998         <a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a> = <a class="code" href="../../d4/d6/alpha_2allproc_8c.html#a5">KSEG0_ADDRESS</a>(PointerPte-&gt;u.Hard.PageFrameNumber);
00999         <a class="code" href="../../d8/d5/kddata_8c.html#a16">MmSubsectionBase</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a443">KSEG0_BASE</a>;
01000 
01001         StartPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(<a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a>); 
01002         LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>((PCHAR)<a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a> +
01003                                   <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> - 1);
01004 
01005         <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a23">MiKseg0Start</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(StartPte);
01006 
01007         <span class="keywordflow">while</span> (StartPte &lt;= LastPte) {
01008 
01009             <span class="comment">//</span>
01010             <span class="comment">// duplicating PTEs to map non initial non paged pool </span>
01011             <span class="comment">// in the KSEG0 space.</span>
01012             <span class="comment">//</span>
01013 
01014             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a>(StartPte, *PointerPte);
01015             StartPte++;
01016             PointerPte++;
01017         }
01018 
01019         <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a24">MiKseg0End</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(LastPte);
01020 
01021     } <span class="keywordflow">else</span> {
01022         
01023         <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a25">MiKseg0Mapping</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01024         <a class="code" href="../../d8/d5/kddata_8c.html#a16">MmSubsectionBase</a> = 0;
01025 
01026     }
01027 
01028     <span class="comment">//</span>
01029     <span class="comment">// As only the initial non paged pool is mapped through superpages, </span>
01030     <span class="comment">// MmSubsectionToPage is always set to zero.  </span>
01031     <span class="comment">//</span>
01032 
01033     <a class="code" href="../../d4/d8/mi_8h.html#a580">MmSubsectionTopPage</a> = 0;
01034 
01035 
01036     <a class="code" href="../../d1/d6/allocpag_8c.html#a7">MmNonPagedPoolExpansionStart</a> = (PVOID)((PCHAR)NonPagedPoolStartVirtual +
01037                                            <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a>);
01038 
01039     <a class="code" href="../../d4/d8/mi_8h.html#a653">MmPageAlignedPoolBase</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>] = <a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a>;
01040 
01041 
01042     <span class="comment">//</span>
01043     <span class="comment">// Non-paged pages now exist, build the pool structures.</span>
01044     <span class="comment">//</span>
01045 
01046     <a class="code" href="../../d4/d8/mi_8h.html#a778">MiInitializeNonPagedPool</a> ();
01047 
01048     <span class="comment">//</span>
01049     <span class="comment">// Before Non-paged pool can be used, the PFN database must</span>
01050     <span class="comment">// be built.  This is due to the fact that the start and end of</span>
01051     <span class="comment">// allocation bits for nonpaged pool are maintained in the</span>
01052     <span class="comment">// PFN elements for the corresponding pages.</span>
01053     <span class="comment">//</span>
01054 
01055     <span class="comment">//</span>
01056     <span class="comment">// Calculate the number of pages required from page zero to</span>
01057     <span class="comment">// the highest page.</span>
01058     <span class="comment">//</span>
01059     <span class="comment">// Get secondary color value from registry.</span>
01060     <span class="comment">//</span>
01061 
01062     <a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a> = <a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
01063 
01064     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a> == 0) {
01065         <a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a60">MM_SECONDARY_COLORS_DEFAULT</a>;
01066     } <span class="keywordflow">else</span> {
01067 
01068         <span class="comment">//</span>
01069         <span class="comment">// Make sure value is power of two and within limits.</span>
01070         <span class="comment">//</span>
01071 
01072         <span class="keywordflow">if</span> (((<a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a> &amp; (<a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a> -1)) != 0) ||
01073             (<a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a> &lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a61">MM_SECONDARY_COLORS_MIN</a>) ||
01074             (<a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a> &gt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a62">MM_SECONDARY_COLORS_MAX</a>)) {
01075             <a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a60">MM_SECONDARY_COLORS_DEFAULT</a>;
01076         }
01077     }
01078 
01079     <a class="code" href="../../d4/d2/datalpha_8c.html#a22">MmSecondaryColorMask</a> = <a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a> - 1;
01080 
01081     <span class="comment">//</span>
01082     <span class="comment">// Get the number of secondary colors and add the arrary for tracking</span>
01083     <span class="comment">// secondary colors to the end of the PFN database.</span>
01084     <span class="comment">//</span>
01085 
01086 
01087     PfnAllocation = 1 + ((((<a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a> + 1) * <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d3/struct__MMPFN.html">MMPFN</a>)) +
01088                         (<a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html">MMCOLOR_TABLES</a>)*2))
01089                             &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
01090 
01091 
01092     <span class="keywordflow">if</span> ((<a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a> &lt; <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a16">_x4gbnp</a>) &amp;&amp; 
01093         (<a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a25">MiKseg0Mapping</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) &amp;&amp;
01094         (<a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a51">MiEnsureAvailablePagesInFreeDescriptor</a>(PfnAllocation,
01095                                                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a8">MM_PAGES_IN_KSEG0</a>))) {
01096         <span class="comment">//</span>
01097         <span class="comment">// Allocate the PFN database in the superpage space</span>
01098         <span class="comment">//</span>
01099         <span class="comment">// Compute the address of the PFN by allocating the appropriate</span>
01100         <span class="comment">// number of pages from the end of the free descriptor.</span>
01101         <span class="comment">//</span>
01102 
01103         <a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a> = (<a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a>)<a class="code" href="../../d4/d6/alpha_2allproc_8c.html#a5">KSEG0_ADDRESS</a>(<a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a36">MiNextPhysicalPage</a>);
01104 
01105         StartPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(<a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a>); 
01106         LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>((PCHAR)<a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a> + (PfnAllocation &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>) - 1);
01107 
01108         <span class="keywordflow">while</span> (StartPte &lt;= LastPte) {
01109             TempPte.u.Hard.PageFrameNumber = <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a50">MiGetNextPhysicalPage</a>();
01110             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a>(StartPte, TempPte);
01111             StartPte++;
01112         }
01113 
01114         RtlZeroMemory(<a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a>, PfnAllocation * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
01115         <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a24">MiKseg0End</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(LastPte);
01116 
01117     } <span class="keywordflow">else</span> {
01118 
01119         <span class="comment">//</span>
01120         <span class="comment">// Calculate the start of the Pfn Database (it starts a physical</span>
01121         <span class="comment">// page zero, even if the Lowest physical page is not zero).</span>
01122         <span class="comment">//</span>
01123 
01124         <a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a> = (<a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a>)<a class="code" href="../../d2/d9/miia64_8h.html#a37">MM_PFN_DATABASE_START</a>;
01125 
01126         <span class="comment">//</span>
01127         <span class="comment">// Go through the memory descriptors and for each physical page</span>
01128         <span class="comment">// make the PFN database has a valid PTE to map it.  This allows</span>
01129         <span class="comment">// machines with sparse physical memory to have a minimal PFN</span>
01130         <span class="comment">// database.</span>
01131         <span class="comment">//</span>
01132 
01133         NextMd = LoaderBlock-&gt;MemoryDescriptorListHead.Flink;
01134 
01135         <span class="keywordflow">while</span> (NextMd != &amp;LoaderBlock-&gt;MemoryDescriptorListHead) {
01136 
01137             MemoryDescriptor = CONTAINING_RECORD(NextMd,
01138                                                  <a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html">MEMORY_ALLOCATION_DESCRIPTOR</a>,
01139                                                  ListEntry);
01140 
01141             PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(
01142                                             MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>));
01143 
01144             LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (((PCHAR)(<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(
01145                                         MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> +
01146                                         MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>))) - 1);
01147             
01148             First = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01149 
01150             <span class="keywordflow">while</span> (PointerPte &lt;= LastPte) {
01151 
01152                 <span class="keywordflow">if</span> (First == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> || <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a166">MiIsPteOnPpeBoundary</a>(PointerPte)) {
01153                     StartPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(PointerPte);
01154                     <span class="keywordflow">if</span> (StartPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
01155                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (StartPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0);
01156                         NextPhysicalPage = <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a50">MiGetNextPhysicalPage</a>();
01157                         RtlZeroMemory(KSEG_ADDRESS(NextPhysicalPage), <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
01158                         TempPte.u.Hard.PageFrameNumber = NextPhysicalPage;
01159                         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a>(StartPpe, TempPte);
01160                     }
01161                 }
01162 
01163                 <span class="keywordflow">if</span> ((First == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) || <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a>(PointerPte)) {
01164                     First = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01165                     StartPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(PointerPte);
01166                     <span class="keywordflow">if</span> (StartPde-&gt;u.Hard.Valid == 0) {
01167                         NextPhysicalPage = <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a50">MiGetNextPhysicalPage</a>();
01168                         RtlZeroMemory(KSEG_ADDRESS(NextPhysicalPage), <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
01169                         TempPte.u.Hard.PageFrameNumber = NextPhysicalPage;
01170                         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a>(StartPde, TempPte);
01171                     }
01172                 }
01173 
01174                 <span class="keywordflow">if</span> (PointerPte-&gt;u.Hard.Valid == 0) {
01175                     NextPhysicalPage = <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a50">MiGetNextPhysicalPage</a>();
01176                     RtlZeroMemory(KSEG_ADDRESS(NextPhysicalPage), <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
01177                     TempPte.u.Hard.PageFrameNumber = NextPhysicalPage;
01178                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a>(PointerPte, TempPte);
01179                 }
01180 
01181                 PointerPte++;
01182             }
01183             NextMd = MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o0">ListEntry</a>.Flink;
01184         }
01185     }
01186 
01187     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a25">MiKseg0Mapping</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01188 
01189         <span class="comment">//</span>
01190         <span class="comment">// Try to convert to superpages</span>
01191         <span class="comment">//</span>
01192 
01193         <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a54">MiConvertToSuperPages</a>(<a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a23">MiKseg0Start</a>, 
01194                               <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a24">MiKseg0End</a>,
01195                               <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a1">_x1mb</a>,
01196                               <a class="code" href="../../d2/d9/miia64_8h.html#a108">MM_PTE_1MB_PAGE</a>);
01197 
01198         <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a54">MiConvertToSuperPages</a>(<a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a23">MiKseg0Start</a>,
01199                               <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a24">MiKseg0End</a>,
01200                               <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a3">_x4mb</a>,
01201                               <a class="code" href="../../d2/d9/miia64_8h.html#a110">MM_PTE_4MB_PAGE</a>);
01202 
01203         <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a54">MiConvertToSuperPages</a>(<a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a23">MiKseg0Start</a>, 
01204                               <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a24">MiKseg0End</a>,
01205                               <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a5">_x16mb</a>,
01206                               <a class="code" href="../../d2/d9/miia64_8h.html#a111">MM_PTE_16MB_PAGE</a>);
01207 
01208         <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a54">MiConvertToSuperPages</a>(<a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a23">MiKseg0Start</a>, 
01209                               <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a24">MiKseg0End</a>,
01210                               <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a9">_x64mb</a>,
01211                               <a class="code" href="../../d2/d9/miia64_8h.html#a112">MM_PTE_64MB_PAGE</a>);
01212 
01213         <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a54">MiConvertToSuperPages</a>(<a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a23">MiKseg0Start</a>, 
01214                               <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a24">MiKseg0End</a>,
01215                               <a class="code" href="../../d9/d5/ia64_2flushtb_8c.html#a0">_x256mb</a>,
01216                               <a class="code" href="../../d2/d9/miia64_8h.html#a113">MM_PTE_256MB_PAGE</a>);
01217 
01218     }
01219 
01220 
01221     <span class="comment">//</span>
01222     <span class="comment">// Initialize support for colored pages.</span>
01223     <span class="comment">//</span>
01224 
01225     <a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[0] = (<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html">PMMCOLOR_TABLES</a>)
01226                                 &amp;<a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a>[<a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a> + 1];
01227 
01228     <a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[1] = &amp;<a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[0][<a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a>];
01229 
01230     <span class="comment">//</span>
01231     <span class="comment">// Make sure the PTEs are mapped.</span>
01232     <span class="comment">//</span>
01233 
01234     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(<a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[0])) {
01235         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (&amp;<a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[0][0]);
01236 
01237         LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (
01238               (PVOID)((PCHAR)&amp;<a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[1][<a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a>] - 1));
01239 
01240         <span class="keywordflow">while</span> (PointerPte &lt;= LastPte) {
01241             <span class="keywordflow">if</span> (PointerPte-&gt;u.Hard.Valid == 0) {
01242                 NextPhysicalPage = <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a50">MiGetNextPhysicalPage</a>();
01243                 RtlZeroMemory(KSEG_ADDRESS(NextPhysicalPage), <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
01244                 TempPte.u.Hard.PageFrameNumber = NextPhysicalPage;
01245                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a>(PointerPte, TempPte);
01246             }
01247             PointerPte++;
01248         }
01249     }
01250 
01251     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a>; i++) {
01252         <a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a171">ZeroedPageList</a>][i].<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o0">Flink</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>;
01253         <a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>][i].<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o0">Flink</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>;
01254     }
01255 
01256 <span class="preprocessor">#if MM_MAXIMUM_NUMBER_OF_COLORS &gt; 1</span>
01257 <span class="preprocessor"></span>    <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a55">MM_MAXIMUM_NUMBER_OF_COLORS</a>; i++) {
01258         <a class="code" href="../../d5/d2/datamips_8c.html#a9">MmFreePagesByPrimaryColor</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a171">ZeroedPageList</a>][i].<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o1">ListName</a> = <a class="code" href="../../d2/d1/mm_8h.html#a345a171">ZeroedPageList</a>;
01259         <a class="code" href="../../d5/d2/datamips_8c.html#a9">MmFreePagesByPrimaryColor</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>][i].<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o1">ListName</a> = <a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>;
01260         <a class="code" href="../../d5/d2/datamips_8c.html#a9">MmFreePagesByPrimaryColor</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a171">ZeroedPageList</a>][i].<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o2">Flink</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>;
01261         <a class="code" href="../../d5/d2/datamips_8c.html#a9">MmFreePagesByPrimaryColor</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>][i].<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o2">Flink</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>;
01262         <a class="code" href="../../d5/d2/datamips_8c.html#a9">MmFreePagesByPrimaryColor</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a171">ZeroedPageList</a>][i].<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o3">Blink</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>;
01263         <a class="code" href="../../d5/d2/datamips_8c.html#a9">MmFreePagesByPrimaryColor</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>][i].<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o3">Blink</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>;
01264     }
01265 <span class="preprocessor">#endif</span>
01266 <span class="preprocessor"></span>
01267     <span class="comment">//</span>
01268     <span class="comment">// Go through the page table entries and for any page which is</span>
01269     <span class="comment">// valid, update the corresponding PFN database element.</span>
01270     <span class="comment">//</span>
01271 
01272     StartPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a63">HYPER_SPACE</a>);
01273     StartPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a63">HYPER_SPACE</a>);
01274     EndPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a26">HYPER_SPACE_END</a>);
01275     First = (StartPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01276 
01277     <span class="keywordflow">while</span> (StartPde &lt;= EndPde) {
01278 
01279         <span class="keywordflow">if</span> (First == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> || <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a>(StartPde)) {
01280             First = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01281             StartPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(StartPde);
01282             <span class="keywordflow">if</span> (StartPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
01283                 StartPpe += 1;
01284                 StartPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (StartPpe);
01285                 <span class="keywordflow">continue</span>;
01286             }
01287 
01288             PdePage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a>(StartPpe);
01289 
01290             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PdePage);
01291             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a20">MmSystemParentTablePage</a>;
01292             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = StartPde;
01293             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
01294             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 1;
01295             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>;
01296             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor =
01297                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a132">MI_GET_COLOR_FROM_SECONDARY</a>(GET_PAGE_COLOR_FROM_PTE(StartPpe));
01298         }
01299 
01300 
01301         <span class="keywordflow">if</span> (StartPde-&gt;u.Hard.Valid == 1) {
01302             PdePage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a>(StartPde);
01303             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PdePage);
01304             PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(StartPde);
01305             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a>(PointerPde);
01306             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = StartPde;
01307             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
01308             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 1;
01309             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>;
01310             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor =
01311                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a132">MI_GET_COLOR_FROM_SECONDARY</a>(GET_PAGE_COLOR_FROM_PTE (StartPde));
01312 
01313             PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(StartPde);
01314             <span class="keywordflow">for</span> (j = 0 ; j &lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a103">PTE_PER_PAGE</a>; j++) {
01315                 <span class="keywordflow">if</span> (PointerPte-&gt;u.Hard.Valid == 1) {
01316 
01317                     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
01318 
01319                     <span class="keywordflow">if</span> (PointerPte-&gt;u.Hard.PageFrameNumber &lt;=
01320                                             <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>) {
01321                         Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PointerPte-&gt;u.Hard.PageFrameNumber);
01322                         Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = PdePage;
01323                         Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = PointerPte;
01324                         Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
01325                         Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 1;
01326                         Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>;
01327                         Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor =
01328                             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a132">MI_GET_COLOR_FROM_SECONDARY</a>(
01329                                                   <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a124">MI_GET_PAGE_COLOR_FROM_PTE</a> (
01330                                                         PointerPte));
01331                     }
01332                 }
01333                 PointerPte += 1;
01334             }
01335         }
01336 
01337         StartPde++;
01338     }
01339 
01340     <span class="comment">//</span>
01341     <span class="comment">// do it for the kernel space</span>
01342     <span class="comment">//</span>
01343 
01344     StartPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (KADDRESS_BASE);
01345     StartPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a> (KADDRESS_BASE);
01346     EndPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a25">MM_SYSTEM_SPACE_END</a>);
01347     First = (StartPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01348 
01349     <span class="keywordflow">while</span> (StartPde &lt;= EndPde) {
01350 
01351         <span class="keywordflow">if</span> (First == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> || <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a>(StartPde)) {
01352             First = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01353             StartPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(StartPde);
01354             <span class="keywordflow">if</span> (StartPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
01355                 StartPpe += 1;
01356                 StartPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (StartPpe);
01357                 <span class="keywordflow">continue</span>;
01358             }
01359 
01360             PdePage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a>(StartPpe);
01361 
01362             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PdePage);
01363             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a20">MmSystemParentTablePage</a>;
01364             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = StartPde;
01365             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
01366             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 1;
01367             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>;
01368             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor =
01369                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a132">MI_GET_COLOR_FROM_SECONDARY</a>(GET_PAGE_COLOR_FROM_PTE(StartPpe));
01370         }
01371 
01372         <span class="keywordflow">if</span> (StartPde-&gt;u.Hard.Valid == 1) {
01373             PdePage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a>(StartPde);
01374             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PdePage);
01375             PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(StartPde);
01376             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a>(PointerPde);
01377             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = StartPde;
01378             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
01379             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 1;
01380             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>;
01381             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor =
01382                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a132">MI_GET_COLOR_FROM_SECONDARY</a>(GET_PAGE_COLOR_FROM_PTE (StartPde));
01383 
01384             PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(StartPde);
01385             <span class="keywordflow">for</span> (j = 0 ; j &lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a103">PTE_PER_PAGE</a>; j++) {
01386                 <span class="keywordflow">if</span> (PointerPte-&gt;u.Hard.Valid == 1) {
01387 
01388                     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
01389 
01390                     <span class="keywordflow">if</span> (PointerPte-&gt;u.Hard.PageFrameNumber &lt;=
01391                                             <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>) {
01392                         Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PointerPte-&gt;u.Hard.PageFrameNumber);
01393                         Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = PdePage;
01394                         Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = PointerPte;
01395                         Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
01396                         Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 1;
01397                         Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>;
01398                         Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor =
01399                             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a132">MI_GET_COLOR_FROM_SECONDARY</a>(
01400                                                   <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a124">MI_GET_PAGE_COLOR_FROM_PTE</a> (
01401                                                         PointerPte));
01402                     }
01403                 }
01404                 PointerPte += 1;
01405             }
01406         }
01407 
01408         StartPde++;
01409     }
01410 
01411     <span class="comment">//</span>
01412     <span class="comment">// If page zero is still unused, mark it as in use. This is</span>
01413     <span class="comment">// temporary as we want to find bugs where a physical page</span>
01414     <span class="comment">// is specified as zero.</span>
01415     <span class="comment">//</span>
01416 
01417     Pfn1 = &amp;<a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a>[<a class="code" href="../../d6/d8/sysinfo_8c.html#a6">MmLowestPhysicalPage</a>];
01418     <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0) {
01419 
01420         <span class="comment">//</span>
01421         <span class="comment">// Make the reference count non-zero and point it into a</span>
01422         <span class="comment">// page directory.</span>
01423         <span class="comment">//</span>
01424 
01425         Pde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (KADDRESS_BASE + 0xb0000000);
01426         PdePage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a>(Pde);
01427         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = PdePageNumber;
01428         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = Pde;
01429         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
01430         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 1;
01431         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>;
01432         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a132">MI_GET_COLOR_FROM_SECONDARY</a>(
01433                                             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a124">MI_GET_PAGE_COLOR_FROM_PTE</a> (Pde));
01434     }
01435 
01436     <span class="comment">// end of temporary set to physical page zero.</span>
01437 
01438     <span class="comment">//</span>
01439     <span class="comment">//</span>
01440     <span class="comment">// Walk through the memory descriptors and add pages to the</span>
01441     <span class="comment">// free list in the PFN database.</span>
01442     <span class="comment">//</span>
01443 
01444     <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a32">MiFreeDescriptor</a>-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> -= 
01445         (PFN_COUNT)(<a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a36">MiNextPhysicalPage</a> - <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a38">MiOldFreeDescriptorBase</a>);
01446 
01447     <span class="comment">//</span>
01448     <span class="comment">// Until BasePage (arc.h) is changed to PFN_NUMBER, NextPhysicalPage</span>
01449     <span class="comment">// needs (ULONG) cast.   </span>
01450     <span class="comment">//</span>
01451 
01452     <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a32">MiFreeDescriptor</a>-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> = (ULONG)<a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a36">MiNextPhysicalPage</a>;
01453 
01454     <span class="comment">//</span>
01455     <span class="comment">// making unused pages inside the kernel super page mapping unusable</span>
01456     <span class="comment">// so that no one is going to reclaim it for uncached pages.</span>
01457     <span class="comment">//</span>
01458 
01459     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a35">MiFreeDescriptorNonPaged</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01460 
01461         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a35">MiFreeDescriptorNonPaged</a>-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> &gt; KernelEnd) {
01462             
01463             <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a30">MiWasteStart</a> = KernelEnd;
01464             <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a31">MiWasteEnd</a> = KernelEnd;
01465 
01466             
01467         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a35">MiFreeDescriptorNonPaged</a>-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> + 
01468                     <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a35">MiFreeDescriptorNonPaged</a>-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>) &gt; KernelEnd) {
01469         
01470             <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a30">MiWasteStart</a> = <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a35">MiFreeDescriptorNonPaged</a>-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>;
01471             <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a31">MiWasteEnd</a> = KernelEnd;
01472 
01473             <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a35">MiFreeDescriptorNonPaged</a>-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> -=  
01474                 (PFN_COUNT) (KernelEnd - <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a35">MiFreeDescriptorNonPaged</a>-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>);
01475 
01476             <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a35">MiFreeDescriptorNonPaged</a>-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> = (ULONG) KernelEnd;
01477 
01478         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a35">MiFreeDescriptorNonPaged</a>-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> != 0) {
01479 
01480             <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a30">MiWasteStart</a> = <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a35">MiFreeDescriptorNonPaged</a>-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>;
01481             <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a31">MiWasteEnd</a> = <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a30">MiWasteStart</a> + <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a35">MiFreeDescriptorNonPaged</a>-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
01482             <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a35">MiFreeDescriptorNonPaged</a>-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> = 0;
01483             
01484         }
01485     }
01486 
01487     NextMd = LoaderBlock-&gt;MemoryDescriptorListHead.Flink;
01488 
01489     <span class="keywordflow">while</span> (NextMd != &amp;LoaderBlock-&gt;MemoryDescriptorListHead) {
01490 
01491         MemoryDescriptor = CONTAINING_RECORD(NextMd,
01492                                              <a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html">MEMORY_ALLOCATION_DESCRIPTOR</a>,
01493                                              ListEntry);
01494 
01495         i = MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
01496         NextPhysicalPage = MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>;
01497 
01498         <span class="keywordflow">switch</span> (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a>) {
01499             <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/arc_8h.html#a320a257">LoaderBad</a>:
01500                 <span class="keywordflow">while</span> (i != 0) {
01501                     <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (<a class="code" href="../../d4/d8/mi_8h.html#a606">MmPageLocationList</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a176">BadPageList</a>],
01502                                         NextPhysicalPage);
01503                     i -= 1;
01504                     NextPhysicalPage += 1;
01505                 }
01506                 <span class="keywordflow">break</span>;
01507 
01508             <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/arc_8h.html#a320a256">LoaderFree</a>:
01509             <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/arc_8h.html#a320a258">LoaderLoadedProgram</a>:
01510             <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/arc_8h.html#a320a259">LoaderFirmwareTemporary</a>:
01511             <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/arc_8h.html#a320a262">LoaderOsloaderStack</a>:
01512 
01513                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (NextPhysicalPage);
01514                 <span class="keywordflow">while</span> (i != 0) {
01515                     <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0) {
01516 
01517                         <span class="comment">//</span>
01518                         <span class="comment">// Set the PTE address to the physical page for</span>
01519                         <span class="comment">// virtual address alignment checking.</span>
01520                         <span class="comment">//</span>
01521 
01522                         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = KSEG_ADDRESS (NextPhysicalPage);
01523                         <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (<a class="code" href="../../d4/d8/mi_8h.html#a606">MmPageLocationList</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>],
01524                                             NextPhysicalPage);
01525                     }
01526                     Pfn1++;
01527                     i -= 1;
01528                     NextPhysicalPage += 1;
01529                 }
01530                 <span class="keywordflow">break</span>;
01531 
01532             <span class="keywordflow">default</span>:
01533 
01534                 PointerPte = KSEG_ADDRESS(NextPhysicalPage);
01535                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (NextPhysicalPage);
01536                 <span class="keywordflow">while</span> (i != 0) {
01537 
01538                     <span class="comment">//</span>
01539                     <span class="comment">// Set page as in use.</span>
01540                     <span class="comment">//</span>
01541 
01542                     <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0) {
01543                         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = PdePageNumber;
01544                         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = PointerPte;
01545                         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
01546                         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 1;
01547                         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>;
01548                         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a132">MI_GET_COLOR_FROM_SECONDARY</a>(
01549                                         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a124">MI_GET_PAGE_COLOR_FROM_PTE</a> (
01550                                                         PointerPte));
01551                     }
01552                     Pfn1++;
01553                     i -= 1;
01554                     NextPhysicalPage += 1;
01555                     PointerPte += 1;
01556                 }
01557                 <span class="keywordflow">break</span>;
01558         }
01559 
01560         NextMd = MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o0">ListEntry</a>.Flink;
01561     }
01562 
01563     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(<a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01564 
01565         <span class="comment">//</span>
01566         <span class="comment">// Indicate that the PFN database is allocated in NonPaged pool.</span>
01567         <span class="comment">//</span>
01568 
01569         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (&amp;<a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a>[<a class="code" href="../../d6/d8/sysinfo_8c.html#a6">MmLowestPhysicalPage</a>]);
01570         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PointerPte-&gt;u.Hard.PageFrameNumber);
01571         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.StartOfAllocation = 1;
01572 
01573         <span class="comment">//</span>
01574         <span class="comment">// Set the end of the allocation.</span>
01575         <span class="comment">//</span>
01576 
01577         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (&amp;<a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a>[<a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>]);
01578         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PointerPte-&gt;u.Hard.PageFrameNumber);
01579         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.EndOfAllocation = 1;
01580 
01581     } <span class="keywordflow">else</span> {
01582         <span class="comment">//</span>
01583         <span class="comment">// The PFN database is allocated in the superpage space</span>
01584         <span class="comment">//</span>
01585         <span class="comment">// Mark all pfn entries for the pfn pages in use.</span>
01586         <span class="comment">//</span>
01587 
01588         PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a179">MI_CONVERT_PHYSICAL_TO_PFN</a> (<a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a>);
01589         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PageFrameIndex);
01590         <span class="keywordflow">do</span> {
01591             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = KSEG_ADDRESS(PageFrameIndex);
01592             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor = 0;
01593             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount += 1;
01594             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>;
01595             PageFrameIndex += 1;
01596             Pfn1 += 1;
01597             PfnAllocation -= 1;
01598         } <span class="keywordflow">while</span> (PfnAllocation != 0);
01599 
01600         <span class="comment">//</span>
01601         <span class="comment">// To avoid creating WB/UC/WC aliasing problem, we should not scan </span>
01602         <span class="comment">// and add free pages to the free list. </span>
01603         <span class="comment">//</span>
01604 <span class="preprocessor">#if 0</span>
01605 <span class="preprocessor"></span>        <span class="comment">// Scan the PFN database backward for pages that are completely zero.</span>
01606         <span class="comment">// These pages are unused and can be added to the free list</span>
01607         <span class="comment">//</span>
01608 
01609         BottomPfn = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(<a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>);
01610         <span class="keywordflow">do</span> {
01611 
01612             <span class="comment">//</span>
01613             <span class="comment">// Compute the address of the start of the page that is next</span>
01614             <span class="comment">// lower in memory and scan backwards until that page address</span>
01615             <span class="comment">// is reached or just crossed.</span>
01616             <span class="comment">//</span>
01617 
01618             <span class="keywordflow">if</span> (((ULONG_PTR)BottomPfn &amp; (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1)) != 0) {
01619                 BasePfn = (<a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a>)((ULONG_PTR)BottomPfn &amp; ~(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1));
01620                 TopPfn = BottomPfn + 1;
01621 
01622             } <span class="keywordflow">else</span> {
01623                 BasePfn = (<a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a>)((ULONG_PTR)BottomPfn - <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
01624                 TopPfn = BottomPfn;
01625             }
01626 
01627             <span class="keywordflow">while</span> (BottomPfn &gt; BasePfn) {
01628                 BottomPfn -= 1;
01629             }
01630 
01631             <span class="comment">//</span>
01632             <span class="comment">// If the entire range over which the PFN entries span is</span>
01633             <span class="comment">// completely zero and the PFN entry that maps the page is</span>
01634             <span class="comment">// not in the range, then add the page to the appropriate</span>
01635             <span class="comment">// free list.</span>
01636             <span class="comment">//</span>
01637 
01638             Range = (ULONG_PTR)TopPfn - (ULONG_PTR)BottomPfn;
01639             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7/string_8c.html#a17">RtlCompareMemoryUlong</a>((PVOID)BottomPfn, Range, 0) == Range) {
01640 
01641                 <span class="comment">//</span>
01642                 <span class="comment">// Set the PTE address to the physical page for virtual</span>
01643                 <span class="comment">// address alignment checking.</span>
01644                 <span class="comment">//</span>
01645 
01646                 PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a179">MI_CONVERT_PHYSICAL_TO_PFN</a> (BasePfn);
01647                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PageFrameIndex);
01648 
01649                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 1);
01650                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> == KSEG_ADDRESS(PageFrameIndex));
01651                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 0;
01652                 PfnAllocation += 1;
01653                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)((ULONG_PTR)PageFrameIndex &lt;&lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a52">PTE_SHIFT</a>);
01654                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor = 0;
01655                 <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a>(<a class="code" href="../../d4/d8/mi_8h.html#a606">MmPageLocationList</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>],
01656                                    PageFrameIndex);
01657             }
01658 
01659         } <span class="keywordflow">while</span> (BottomPfn &gt; <a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a>);
01660 <span class="preprocessor">#endif</span>
01661 <span class="preprocessor"></span>
01662     }
01663 
01664 
01665     <span class="comment">//</span>
01666     <span class="comment">// Indicate that nonpaged pool must succeed is allocated in</span>
01667     <span class="comment">// nonpaged pool.</span>
01668     <span class="comment">//</span>
01669 
01670     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(<a class="code" href="../../d4/d8/mi_8h.html#a649">MmNonPagedMustSucceed</a>)) {
01671         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a179">MI_CONVERT_PHYSICAL_TO_PFN</a> (<a class="code" href="../../d4/d8/mi_8h.html#a649">MmNonPagedMustSucceed</a>));
01672     } <span class="keywordflow">else</span> {
01673         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(<a class="code" href="../../d4/d8/mi_8h.html#a649">MmNonPagedMustSucceed</a>);
01674         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PointerPte-&gt;u.Hard.PageFrameNumber);
01675     }
01676 
01677     i = <a class="code" href="../../d4/d8/mi_8h.html#a627">MmSizeOfNonPagedMustSucceed</a>;
01678     <span class="keywordflow">while</span> ((LONG)i &gt; 0) {
01679         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.StartOfAllocation = 1;
01680         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.EndOfAllocation = 1;
01681         i -= <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
01682         Pfn1 += 1;
01683     }
01684 
01685 <span class="preprocessor">#if 0</span>
01686 <span class="preprocessor"></span>    <span class="comment">//</span>
01687     <span class="comment">// Adjust the memory descriptors to indicate that free pool has</span>
01688     <span class="comment">// been used for nonpaged pool creation.</span>
01689     <span class="comment">//</span>
01690 
01691     <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a32">MiFreeDescriptor</a>-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> = (ULONG)<a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a39">MiOldFreeDescriptorCount</a>;
01692 
01693     <span class="comment">//</span>
01694     <span class="comment">// Until PagePage is defined to PFN_NUMBER, we need (ULONG) cast to </span>
01695     <span class="comment">// remove warning. </span>
01696     <span class="comment">//</span>
01697 
01698     <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a32">MiFreeDescriptor</a>-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> = (ULONG)<a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a38">MiOldFreeDescriptorBase</a>;
01699 
01700 <span class="preprocessor">#endif</span>
01701 <span class="preprocessor"></span>
01702 <span class="comment">// moved from above for pool hack routines...</span>
01703     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a> (&amp;<a class="code" href="../../d4/d4/alpha_2splocks_8c.html#a15">MmSystemSpaceLock</a>);
01704 
01705     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a> (&amp;<a class="code" href="../../d7/d2/alpha_2initkr_8c.html#a2">MmPfnLock</a>);
01706 
01707     <span class="comment">//</span>
01708     <span class="comment">// Initialize the nonpaged available PTEs for mapping I/O space</span>
01709     <span class="comment">// and kernel stacks.</span>
01710     <span class="comment">//</span>
01711 
01712     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d8/d5/kddata_8c.html#a22">MmNonPagedSystemStart</a>);
01713     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (((ULONG_PTR)PointerPte &amp; (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1)) == 0);
01714 
01715     <a class="code" href="../../d8/d0/cmdat3_8c.html#a23">MmNumberOfSystemPtes</a> = (ULONG)(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(NonPagedPoolStartVirtual) - PointerPte - 1);
01716 
01717     <a class="code" href="../../d0/d9/sysptes_8c.html#a27">MiInitializeSystemPtes</a> (PointerPte, <a class="code" href="../../d8/d0/cmdat3_8c.html#a23">MmNumberOfSystemPtes</a>, <a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>);
01718 
01719     <span class="comment">//</span>
01720     <span class="comment">// Initialize the nonpaged pool.</span>
01721     <span class="comment">//</span>
01722 
01723     <a class="code" href="../../d5/d8/ex_8h.html#a215">InitializePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,0);
01724 
01725     <span class="comment">//</span>
01726     <span class="comment">// Initialize memory management structures for the system process.</span>
01727     <span class="comment">//</span>
01728     <span class="comment">// Set the address of the first and last reserved PTE in hyper space.</span>
01729     <span class="comment">//</span>
01730 
01731     <a class="code" href="../../d4/d8/mi_8h.html#a615">MmFirstReservedMappingPte</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a64">FIRST_MAPPING_PTE</a>);
01732     <a class="code" href="../../d4/d8/mi_8h.html#a616">MmLastReservedMappingPte</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a66">LAST_MAPPING_PTE</a>);
01733 
01734     <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a69">WORKING_SET_LIST</a>;
01735     <a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a> = (<a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a>)((PUCHAR)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a69">WORKING_SET_LIST</a> + <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d8/struct__MMWSL.html">MMWSL</a>));
01736 
01737     <span class="comment">//</span>
01738     <span class="comment">// The PFN element for the page directory parent will be initialized</span>
01739     <span class="comment">// a second time when the process address space is initialized. Therefore,</span>
01740     <span class="comment">// the share count and the reference count must be set to zero.</span>
01741     <span class="comment">//</span>
01742 
01743     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a>((<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)PDE_SELFMAP));
01744     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount = 0;
01745     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 0;
01746 
01747     <span class="comment">//</span>
01748     <span class="comment">// The PFN element for the hyper space page directory page will be</span>
01749     <span class="comment">// initialized a second time when the process address space is initialized.</span>
01750     <span class="comment">// Therefore, the share count and the reference count must be set to zero.</span>
01751     <span class="comment">//</span>
01752 
01753     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a>(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a63">HYPER_SPACE</a>);
01754     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a>(PointerPte));
01755     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount = 0;
01756     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 0;
01757 
01758     <span class="comment">//</span>
01759     <span class="comment">// The PFN elements for the hyper space page table page and working set list</span>
01760     <span class="comment">// page will be initialized a second time when the process address space</span>
01761     <span class="comment">// is initialized. Therefore, the share count and the reference must be</span>
01762     <span class="comment">// set to zero.</span>
01763     <span class="comment">//</span>
01764 
01765     StartPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a63">HYPER_SPACE</a>);
01766 
01767     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a>(StartPde));
01768     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount = 0;
01769     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 0;
01770 
01771     <span class="comment">//</span>
01772     <span class="comment">// Initialize this process's memory management structures including</span>
01773     <span class="comment">// the working set list.</span>
01774     <span class="comment">//</span>
01775 
01776     <span class="comment">//</span>
01777     <span class="comment">// The pfn element for the page directory has already been initialized,</span>
01778     <span class="comment">// zero the reference count and the share count so they won't be</span>
01779     <span class="comment">// wrong.</span>
01780     <span class="comment">//</span>
01781 
01782     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PdePageNumber);
01783     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount = 0;
01784     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 0;
01785 
01786     CurrentProcess = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a> ();
01787 
01788     <span class="comment">//</span>
01789     <span class="comment">// Get a page for the working set list and map it into the Page</span>
01790     <span class="comment">// directory at the page after hyperspace.</span>
01791     <span class="comment">//</span>
01792 
01793     PageFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (0);
01794 
01795     CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o23">WorkingSetPage</a> = PageFrameIndex;
01796     TempPte.u.Hard.PageFrameNumber = PageFrameIndex;
01797 
01798     RtlZeroMemory (KSEG_ADDRESS(PageFrameIndex), <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
01799 
01800     CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o6">MaximumWorkingSetSize</a> = (ULONG)<a class="code" href="../../d4/d8/mi_8h.html#a740">MmSystemProcessWorkingSetMax</a>;
01801     CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o5">MinimumWorkingSetSize</a> = (ULONG)<a class="code" href="../../d4/d8/mi_8h.html#a739">MmSystemProcessWorkingSetMin</a>;
01802 
01803     <a class="code" href="../../d4/d5/procsup_8c.html#a30">MmInitializeProcessAddressSpace</a> (CurrentProcess,
01804                                 (<a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01805                                 (PVOID)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01806                                 (PVOID)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01807 
01808     
01809     <span class="comment">//    *PointerPde = ZeroPte;</span>
01810 
01811     <span class="comment">//</span>
01812     <span class="comment">// page after hyperspace should be reclaimed for system cache structure</span>
01813     <span class="comment">//</span>
01814 
01815     <a class="code" href="../../d4/d9/ke_8h.html#a374">KeFlushCurrentTb</a>();
01816 
01817     <span class="comment">//</span>
01818     <span class="comment">// Check to see if moving the secondary page structures to the end</span>
01819     <span class="comment">// of the PFN database is a waste of memory.  And if so, copy it</span>
01820     <span class="comment">// to paged pool.</span>
01821     <span class="comment">//</span>
01822     <span class="comment">// If the PFN datbase ends on a page aligned boundary and the</span>
01823     <span class="comment">// size of the two arrays is less than a page, free the page</span>
01824     <span class="comment">// and allocate nonpagedpool for this.</span>
01825     <span class="comment">//</span>
01826 
01827     <span class="keywordflow">if</span> ((((ULONG_PTR)<a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[0] &amp; (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1)) == 0) &amp;&amp;
01828        ((<a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a> * 2 * <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html">MMCOLOR_TABLES</a>)) &lt; <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>)) {
01829 
01830         <a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html">PMMCOLOR_TABLES</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>;
01831 
01832         <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> = <a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[0];
01833 
01834         <a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[0] = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a175">NonPagedPoolMustSucceed</a>,
01835                                <a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a> * 2 * <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html">MMCOLOR_TABLES</a>),
01836                                '  mM');
01837 
01838         <a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[1] = &amp;<a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[0][<a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a>];
01839 
01840         RtlMoveMemory (<a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[0],
01841                        <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>,
01842                        <a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a> * 2 * <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a202">MMCOLOR_TABLES</a>));
01843 
01844         <span class="comment">//</span>
01845         <span class="comment">// Free the page.</span>
01846         <span class="comment">//</span>
01847 
01848         <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>)) {
01849             PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>);
01850             PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a>(PointerPte);
01851             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a>(PointerPte, <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>);
01852         } <span class="keywordflow">else</span> {
01853             PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a179">MI_CONVERT_PHYSICAL_TO_PFN</a> (<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>);
01854         }
01855 
01856         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
01857         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount &lt;= 1) &amp;&amp; (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount &lt;= 1));
01858         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount = 0;
01859         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 1;
01860         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
01861 <span class="preprocessor">#if DBG</span>
01862 <span class="preprocessor"></span>        Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>;
01863 <span class="preprocessor">#endif //DBG</span>
01864 <span class="preprocessor"></span>        <a class="code" href="../../d6/d5/pfndec_8c.html#a2">MiDecrementReferenceCount</a> (PageFrameIndex);
01865     }
01866 
01867     <span class="keywordflow">return</span>;
01868 }
01869 
01870 PVOID
<a name="l01871"></a><a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a53">01871</a> <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a53">MiGetKSegAddress</a> (
01872     PFN_NUMBER FrameNumber
01873     )
01874 <span class="comment">/*++</span>
01875 <span class="comment"></span>
01876 <span class="comment">Routine Description:</span>
01877 <span class="comment"></span>
01878 <span class="comment">    This function returns the KSEG3 address which maps the given physical page.</span>
01879 <span class="comment"></span>
01880 <span class="comment">Arguments:</span>
01881 <span class="comment"></span>
01882 <span class="comment">   FrameNumber - Supplies the physical page number to get the KSEG3 address for </span>
01883 <span class="comment"></span>
01884 <span class="comment">Return Value:</span>
01885 <span class="comment"></span>
01886 <span class="comment">    Virtual address mapped in KSEG3 space</span>
01887 <span class="comment"></span>
01888 <span class="comment">    TBS</span>
01889 <span class="comment"></span>
01890 <span class="comment">--*/</span>
01891 {
01892     PVOID <a class="code" href="../../d5/d9/alpha_2exdsptch_8c.html#a2">Virtual</a>;
01893     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
01894     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
01895 
01896     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (FrameNumber &lt;= <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>);
01897  
01898     <a class="code" href="../../d5/d9/alpha_2exdsptch_8c.html#a2">Virtual</a> = ((PVOID)(KSEG3_BASE | ((ULONG_PTR)(FrameNumber) &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>)));
01899     
01900 <span class="preprocessor">#if defined(KSEG_VHPT)</span>
01901 <span class="preprocessor"></span>    PointerPte = <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a0">MiGetKSegPteAddress</a> (<a class="code" href="../../d5/d9/alpha_2exdsptch_8c.html#a2">Virtual</a>);
01902 
01903     <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0) {
01904 
01905         <span class="comment">//</span>
01906         <span class="comment">// if the VHPT entry for the KSEG3 address is still zero, build it here.</span>
01907         <span class="comment">//</span>
01908 
01909         TempPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a2">ValidKernelPte</a>;
01910         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = FrameNumber;
01911         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a>(PointerPte, TempPte);
01912 
01913         __mf();
01914     }
01915 <span class="preprocessor">#endif</span>
01916 <span class="preprocessor"></span>
01917     <span class="keywordflow">return</span> (<a class="code" href="../../d5/d9/alpha_2exdsptch_8c.html#a2">Virtual</a>);
01918 }
01919 
01920 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01921"></a><a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a54">01921</a> <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a54">MiConvertToSuperPages</a>(
01922     IN PVOID StartVirtual,
01923     IN PVOID EndVirtual,
01924     IN SIZE_T PageSize,
01925     IN ULONG PageShift
01926     )
01927 <span class="comment">/*++</span>
01928 <span class="comment"></span>
01929 <span class="comment">Routine Description:</span>
01930 <span class="comment"></span>
01931 <span class="comment">    This function makes contiguous non-paged memory use super pages rather than </span>
01932 <span class="comment">    using page tables. </span>
01933 <span class="comment"></span>
01934 <span class="comment">Arguments:</span>
01935 <span class="comment"></span>
01936 <span class="comment">    StartVirtual - the start address of the region of pages to be mapped by </span>
01937 <span class="comment">          super pages.</span>
01938 <span class="comment"> </span>
01939 <span class="comment">    EndVirtual - the end address of the region of pages to be mapped by super</span>
01940 <span class="comment">          pages.</span>
01941 <span class="comment"></span>
01942 <span class="comment">    Page Size - the page size to be used by the super page.</span>
01943 <span class="comment"></span>
01944 <span class="comment">    Page Shift - the page shift count to be used by the super page.</span>
01945 <span class="comment"></span>
01946 <span class="comment">Return Value:</span>
01947 <span class="comment"></span>
01948 <span class="comment">    None.</span>
01949 <span class="comment"></span>
01950 <span class="comment">--*/</span>
01951 {
01952     ULONG_PTR VirtualAddress;
01953     ULONG_PTR i;
01954     ULONG_PTR NumberOfPte;
01955     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartPte;
01956     
01957     VirtualAddress = (ULONG_PTR) <a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(StartVirtual);
01958     i = VirtualAddress &amp; (PageSize - 1);
01959 
01960     <span class="keywordflow">if</span> (i != 0) {
01961 
01962         VirtualAddress = (VirtualAddress + PageSize - 1) &amp; ~(PageSize - 1); 
01963 
01964     }
01965 
01966     StartPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(VirtualAddress);
01967     NumberOfPte = PageSize &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
01968 
01969     i = 0;
01970 
01971     <span class="keywordflow">while</span> (VirtualAddress &lt;= (ULONG_PTR)EndVirtual) {
01972 
01973         <span class="keywordflow">if</span> (i == NumberOfPte) {
01974             
01975             StartPte -= NumberOfPte;
01976 
01977             <span class="keywordflow">for</span> (i = 0; i &lt; NumberOfPte; i++) {
01978                 
01979                 StartPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid = 0;
01980                 StartPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Large.LargePage = 1;
01981                 StartPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Large.PageSize = PageShift;
01982                 StartPte += 1;
01983             }
01984 
01985             i = 0;
01986         }
01987 
01988         i += 1;
01989         StartPte += 1;
01990         VirtualAddress += <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
01991     }
01992 }
01993 
01994 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01995"></a><a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a44">01995</a> <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a44">MiConvertBackToStandardPages</a>(
01996     IN PVOID StartVirtual,
01997     IN PVOID EndVirtual
01998     )
01999 <span class="comment">/*++</span>
02000 <span class="comment"></span>
02001 <span class="comment">Routine Description:</span>
02002 <span class="comment"></span>
02003 <span class="comment">    This function disables the use of the super pages.</span>
02004 <span class="comment"></span>
02005 <span class="comment">Arguments:</span>
02006 <span class="comment"></span>
02007 <span class="comment">    StartVirtual - the start address of the region of pages to disable super pages.</span>
02008 <span class="comment">          super pages.</span>
02009 <span class="comment"> </span>
02010 <span class="comment">    EndVirtual - the end address of the region of pages to disable super pages.</span>
02011 <span class="comment"></span>
02012 <span class="comment">Return Value:</span>
02013 <span class="comment"></span>
02014 <span class="comment">    None.</span>
02015 <span class="comment"></span>
02016 <span class="comment">--*/</span>
02017 {
02018     ULONG_PTR VirtualAddress;
02019     ULONG_PTR i;
02020     ULONG_PTR NumberOfPte;
02021     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartPte;
02022     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
02023     
02024     VirtualAddress = (ULONG_PTR) <a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(StartVirtual);
02025 
02026     StartPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(VirtualAddress);
02027 
02028     <span class="keywordflow">while</span> (VirtualAddress &lt;= (ULONG_PTR)EndVirtual) {
02029 
02030         TempPte = *StartPte;
02031         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Large.PageSize = 0;
02032         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Large.PageSize = 0;
02033         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid = 1;
02034         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (StartPte, TempPte);
02035 
02036         StartPte += 1;
02037         VirtualAddress += <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
02038     }
02039 }
02040 
02041 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02042"></a><a class="code" href="../../d2/d9/miia64_8h.html#a318">02042</a> <a class="code" href="../../d2/d9/miia64_8h.html#a318">MiSweepCacheMachineDependent</a>(
02043     IN PVOID VirtualAddress,
02044     IN SIZE_T Size,
02045     IN <a class="code" href="../../d4/d9/ke_8h.html#a156">MEMORY_CACHING_TYPE</a> CacheType
02046     ) 
02047 <span class="comment">/*++</span>
02048 <span class="comment"></span>
02049 <span class="comment">Routine Description:</span>
02050 <span class="comment"></span>
02051 <span class="comment">    This function checks and perform appropriate cache flushing operations.</span>
02052 <span class="comment"></span>
02053 <span class="comment">Arguments:</span>
02054 <span class="comment"></span>
02055 <span class="comment">    StartVirtual - the start address of the region of pages to be examined.</span>
02056 <span class="comment"> </span>
02057 <span class="comment">    Size - the size of the region of pages</span>
02058 <span class="comment"></span>
02059 <span class="comment">    Cache - the new cache type </span>
02060 <span class="comment"></span>
02061 <span class="comment">Return Value:</span>
02062 <span class="comment"></span>
02063 <span class="comment">    None.</span>
02064 <span class="comment"></span>
02065 <span class="comment">--*/</span>
02066 {
02067     PFN_NUMBER j;
02068     PFN_NUMBER NumberOfPages;
02069     KIRQL OldIrql;
02070     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
02071     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
02072             
02073     NumberOfPages = <a class="code" href="../../d2/d1/mm_8h.html#a9">COMPUTE_PAGES_SPANNED</a> (VirtualAddress, <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>);
02074     VirtualAddress = <a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(VirtualAddress);
02075     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = NumberOfPages * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
02076 
02077     <a class="code" href="../../d1/d5/ia64_2flush_8c.html#a16">KeSweepCacheRangeWithDrain</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, VirtualAddress, (ULONG)<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>);
02078 
02079     <span class="keywordflow">if</span> (CacheType == <a class="code" href="../../d4/d9/ke_8h.html#a413a250">MmWriteCombined</a>) {
02080         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(VirtualAddress);
02081         <span class="keywordflow">for</span> (j = 0; j &lt; NumberOfPages; j += 1) {
02082             TempPte = *PointerPte;
02083             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a111">MI_SET_PTE_WRITE_COMBINE</a> (TempPte);
02084             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPte, TempPte);
02085             PointerPte += 1;
02086         }
02087     }
02088 }
02089 
02090 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02091"></a><a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a45">02091</a> <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a45">MiBuildPageTableForDrivers</a>(
02092     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock
02093     )
02094 <span class="comment">/*++</span>
02095 <span class="comment"></span>
02096 <span class="comment">Routine Description:</span>
02097 <span class="comment"></span>
02098 <span class="comment">    This function builds page ables for loader loaded drivers.</span>
02099 <span class="comment"></span>
02100 <span class="comment">Arguments:</span>
02101 <span class="comment"></span>
02102 <span class="comment">    LoaderBlock - Supplies the address of the loader block.</span>
02103 <span class="comment"> </span>
02104 <span class="comment">Return Value:</span>
02105 <span class="comment"></span>
02106 <span class="comment">    None.</span>
02107 <span class="comment"></span>
02108 <span class="comment">--*/</span>
02109 {
02110     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartPte;
02111     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> EndPte;
02112     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartPde;
02113     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartPpe;
02114     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
02115     ULONG First;
02116     ULONG_PTR i;
02117     PLIST_ENTRY NextEntry;
02118     ULONG NumberOfLoaderPtes;
02119     PFN_NUMBER NextPhysicalPage;
02120     PVOID Va;
02121     PLDR_DATA_TABLE_ENTRY DataTableEntry;
02122 
02123     TempPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a2">ValidKernelPte</a>;
02124     TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long |= <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a84">MM_PTE_EXECUTE</a>;
02125 
02126     i = 0;
02127     NextEntry = LoaderBlock-&gt;LoadOrderListHead.Flink;
02128 
02129     <span class="keywordflow">for</span> ( ; NextEntry != &amp;LoaderBlock-&gt;LoadOrderListHead; NextEntry = NextEntry-&gt;Flink) {
02130 
02131         <span class="comment">//</span>
02132         <span class="comment">// As it is mapped through the translation registers, skip the kernel.</span>
02133         <span class="comment">//</span>
02134 
02135         i += 1;
02136         <span class="keywordflow">if</span> (i &lt;= 1) {
02137             <span class="keywordflow">continue</span>;
02138         }
02139 
02140         DataTableEntry = CONTAINING_RECORD(NextEntry,
02141                                            LDR_DATA_TABLE_ENTRY,
02142                                            InLoadOrderLinks);
02143 
02144         NumberOfLoaderPtes = (ULONG)((<a class="code" href="../../d2/d1/mm_8h.html#a4">ROUND_TO_PAGES</a>(DataTableEntry-&gt;SizeOfImage)) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
02145 
02146         Va = DataTableEntry-&gt;DllBase;
02147         StartPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(Va);
02148         EndPte = StartPte + NumberOfLoaderPtes;
02149 
02150         First = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02151 
02152         <span class="keywordflow">while</span> (StartPte &lt;= EndPte) {
02153 
02154             <span class="keywordflow">if</span> (First == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> || <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a166">MiIsPteOnPpeBoundary</a>(StartPte)) {
02155                 StartPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(StartPte);
02156                 <span class="keywordflow">if</span> (StartPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
02157                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (StartPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0);
02158                     NextPhysicalPage = <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a50">MiGetNextPhysicalPage</a>();
02159                     RtlZeroMemory(KSEG_ADDRESS(NextPhysicalPage), <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
02160                     TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = NextPhysicalPage;
02161                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a>(StartPpe, TempPte);
02162                 }
02163             }
02164 
02165             <span class="keywordflow">if</span> ((First == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) || <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a>(StartPte)) {
02166                 First = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02167                 StartPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(StartPte);
02168                 <span class="keywordflow">if</span> (StartPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
02169                     NextPhysicalPage = <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a50">MiGetNextPhysicalPage</a>();
02170                     RtlZeroMemory(KSEG_ADDRESS(NextPhysicalPage), <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
02171                     TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = NextPhysicalPage;
02172                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a>(StartPde, TempPte);
02173                 }
02174             }
02175 
02176             TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a179">MI_CONVERT_PHYSICAL_TO_PFN</a>(Va); 
02177             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (StartPte, TempPte);
02178             StartPte += 1;
02179             Va = (PVOID)((ULONG_PTR)Va + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
02180         }
02181     }
02182 }
02183 
02184 PVOID
<a name="l02185"></a><a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a56">02185</a> <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a56">MiConvertToLoaderVirtual</a>(
02186     IN PFN_NUMBER Page,
02187     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock
02188     )
02189 {
02190     ULONG_PTR PageAddress = Page &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
02191     PTR_INFO ItrInfo = &amp;LoaderBlock-&gt;u.Ia64.ItrInfo[0];
02192     
02193 
02194     <span class="keywordflow">if</span> ((PageAddress &gt;= ItrInfo[ITR_KERNEL_INDEX].PhysicalAddress) &amp;&amp;
02195         (PageAddress &lt;= ItrInfo[ITR_KERNEL_INDEX].PhysicalAddress + 
02196          ((ULONG_PTR)1 &lt;&lt; ItrInfo[ITR_KERNEL_INDEX].PageSize))) {
02197 
02198         <span class="keywordflow">return</span> (PVOID)(ItrInfo[ITR_KERNEL_INDEX].VirtualAddress + 
02199                        (PageAddress - ItrInfo[ITR_KERNEL_INDEX].PhysicalAddress));
02200 
02201     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((PageAddress &gt;= ItrInfo[ITR_DRIVER0_INDEX].PhysicalAddress) &amp;&amp;
02202         (PageAddress &lt;= ItrInfo[ITR_DRIVER0_INDEX].PhysicalAddress + 
02203          ((ULONG_PTR)1 &lt;&lt; ItrInfo[ITR_DRIVER0_INDEX].PageSize))) {
02204 
02205         <span class="keywordflow">return</span> (PVOID)(ItrInfo[ITR_DRIVER0_INDEX].VirtualAddress + 
02206                        (PageAddress - ItrInfo[ITR_DRIVER0_INDEX].PhysicalAddress));
02207 
02208     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((PageAddress &gt;= ItrInfo[ITR_DRIVER1_INDEX].PhysicalAddress) &amp;&amp;
02209         (PageAddress &lt;= ItrInfo[ITR_DRIVER1_INDEX].PhysicalAddress + 
02210          ((ULONG_PTR)1 &lt;&lt; ItrInfo[ITR_DRIVER1_INDEX].PageSize))) {
02211 
02212         <span class="keywordflow">return</span> (PVOID)(ItrInfo[ITR_DRIVER1_INDEX].VirtualAddress + 
02213                        (PageAddress - ItrInfo[ITR_DRIVER1_INDEX].PhysicalAddress));
02214 
02215     } <span class="keywordflow">else</span> {
02216 
02217         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (MEMORY_MANAGEMENT,
02218                       0x01010101,
02219                       PageAddress,
02220                       (ULONG_PTR)&amp;ItrInfo[0],
02221                       (ULONG_PTR)LoaderBlock);
02222 
02223         <span class="keywordflow">return</span> 0;
02224     }
02225 }
02226 
02227 
02228 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02229"></a><a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a46">02229</a> <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a46">MiBuildPageTableForLoaderMemory</a>(
02230     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock
02231     )
02232 <span class="comment">/*++</span>
02233 <span class="comment"></span>
02234 <span class="comment">Routine Description:</span>
02235 <span class="comment"></span>
02236 <span class="comment">    This function builds page ables for loader loaded drivers and loader </span>
02237 <span class="comment">    allocated memory.</span>
02238 <span class="comment"></span>
02239 <span class="comment">Arguments:</span>
02240 <span class="comment"></span>
02241 <span class="comment">    LoaderBlock - Supplies the address of the loader block.</span>
02242 <span class="comment"> </span>
02243 <span class="comment">Return Value:</span>
02244 <span class="comment"></span>
02245 <span class="comment">    None.</span>
02246 <span class="comment"></span>
02247 <span class="comment">--*/</span>
02248 {
02249     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartPte;
02250     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> EndPte;
02251     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartPde;
02252     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartPpe;
02253     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
02254     ULONG First;
02255     PLIST_ENTRY NextEntry;
02256     PFN_NUMBER NextPhysicalPage;
02257     PVOID Va;
02258     PFN_NUMBER PfnNumber;
02259     <a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html">PMEMORY_ALLOCATION_DESCRIPTOR</a> MemoryDescriptor;
02260 
02261     TempPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a2">ValidKernelPte</a>;
02262     NextEntry = LoaderBlock-&gt;MemoryDescriptorListHead.Flink;
02263 
02264     <span class="keywordflow">for</span> ( ; NextEntry != &amp;LoaderBlock-&gt;MemoryDescriptorListHead; NextEntry = NextEntry-&gt;Flink) {
02265 
02266         MemoryDescriptor = CONTAINING_RECORD(NextEntry,
02267                                              <a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html">MEMORY_ALLOCATION_DESCRIPTOR</a>,
02268                                              ListEntry);
02269 
02270         <span class="keywordflow">if</span> ((MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a> == <a class="code" href="../../d1/d9/arc_8h.html#a320a261">LoaderOsloaderHeap</a>) ||
02271             (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a> == <a class="code" href="../../d1/d9/arc_8h.html#a320a273">LoaderRegistryData</a>) ||
02272             (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a> == <a class="code" href="../../d1/d9/arc_8h.html#a320a275">LoaderNlsData</a>) ||
02273             (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a> == <a class="code" href="../../d1/d9/arc_8h.html#a320a268">LoaderStartupDpcStack</a>) || 
02274             (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a> == <a class="code" href="../../d1/d9/arc_8h.html#a320a269">LoaderStartupKernelStack</a>) ||
02275             (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a> == <a class="code" href="../../d1/d9/arc_8h.html#a320a270">LoaderStartupPanicStack</a>) ||
02276             (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a> == <a class="code" href="../../d1/d9/arc_8h.html#a320a272">LoaderStartupPdrPage</a>) ||
02277             (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a> == <a class="code" href="../../d1/d9/arc_8h.html#a320a274">LoaderMemoryData</a>)) {
02278             
02279             TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Execute = 0;
02280 
02281         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a> == <a class="code" href="../../d1/d9/arc_8h.html#a320a263">LoaderSystemCode</a>) ||
02282                    (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a> == <a class="code" href="../../d1/d9/arc_8h.html#a320a264">LoaderHalCode</a>) ||
02283                    (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a> == <a class="code" href="../../d1/d9/arc_8h.html#a320a265">LoaderBootDriver</a>) ||
02284                    (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a> == <a class="code" href="../../d1/d9/arc_8h.html#a320a268">LoaderStartupDpcStack</a>)) {
02285             
02286             TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Execute = 1;
02287 
02288         } <span class="keywordflow">else</span> {
02289 
02290             <span class="keywordflow">continue</span>;
02291 
02292         }
02293 
02294         PfnNumber = MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>;
02295         Va = <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a56">MiConvertToLoaderVirtual</a>(MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>, LoaderBlock);
02296 
02297         StartPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(Va);
02298         EndPte = StartPte + MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
02299 
02300         First = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02301 
02302         <span class="keywordflow">while</span> (StartPte &lt;= EndPte) {
02303 
02304             <span class="keywordflow">if</span> (First == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> || <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a166">MiIsPteOnPpeBoundary</a>(StartPte)) {
02305                 StartPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(StartPte);
02306                 <span class="keywordflow">if</span> (StartPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
02307                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (StartPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0);
02308                     NextPhysicalPage = <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a50">MiGetNextPhysicalPage</a>();
02309                     RtlZeroMemory(KSEG_ADDRESS(NextPhysicalPage), <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
02310                     TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = NextPhysicalPage;
02311                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a>(StartPpe, TempPte);
02312                 }
02313             }
02314 
02315             <span class="keywordflow">if</span> ((First == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) || <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a>(StartPte)) {
02316                 First = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02317                 StartPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(StartPte);
02318                 <span class="keywordflow">if</span> (StartPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
02319                     NextPhysicalPage = <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a50">MiGetNextPhysicalPage</a>();
02320                     RtlZeroMemory(KSEG_ADDRESS(NextPhysicalPage), <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
02321                     TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = NextPhysicalPage;
02322                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a>(StartPde, TempPte);
02323                 }
02324             }
02325 
02326             TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = PfnNumber;
02327             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (StartPte, TempPte);
02328             StartPte += 1;
02329             PfnNumber += 1;
02330             Va = (PVOID)((ULONG_PTR)Va + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
02331         }
02332     }
02333 }
02334 
02335 
02336 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02337"></a><a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a47">02337</a> <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a47">MiRemoveLoaderSuperPages</a>(
02338     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock
02339     )
02340 {
02341 
02342     <span class="comment">//</span>
02343     <span class="comment">//  remove the super pages for the boot drivers</span>
02344     <span class="comment">//</span>
02345 
02346     KiFlushFixedInstTb(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, LoaderBlock-&gt;u.Ia64.ItrInfo[ITR_DRIVER0_INDEX].VirtualAddress);
02347     KiFlushFixedInstTb(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, LoaderBlock-&gt;u.Ia64.ItrInfo[ITR_DRIVER1_INDEX].VirtualAddress);
02348     KiFlushFixedDataTb(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, LoaderBlock-&gt;u.Ia64.DtrInfo[DTR_DRIVER0_INDEX].VirtualAddress);
02349     KiFlushFixedDataTb(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, LoaderBlock-&gt;u.Ia64.DtrInfo[DTR_DRIVER1_INDEX].VirtualAddress);
02350 
02351 }
02352 
02353 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02354"></a><a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a48">02354</a> <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a48">MiMakeKernelPagesPermanent</a>(
02355     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock
02356     )
02357 {
02358     PFN_NUMBER KernelStart;
02359     PFN_NUMBER KernelEnd;
02360     ULONG_PTR PageSize;
02361     PLIST_ENTRY NextEntry;
02362     <a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html">PMEMORY_ALLOCATION_DESCRIPTOR</a> MemoryDescriptor;
02363 
02364     KernelStart = <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a27">MiNtoskrnlPhysicalBase</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
02365     PageSize = (ULONG_PTR)1 &lt;&lt; <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a29">MiNtoskrnlPageShift</a>;
02366     KernelEnd = KernelStart + (PageSize &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
02367 
02368     NextEntry = LoaderBlock-&gt;MemoryDescriptorListHead.Flink;
02369 
02370     <span class="keywordflow">for</span> ( ; NextEntry != &amp;LoaderBlock-&gt;MemoryDescriptorListHead; NextEntry = NextEntry-&gt;Flink) {
02371 
02372         MemoryDescriptor = CONTAINING_RECORD(NextEntry,
02373                                              <a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html">MEMORY_ALLOCATION_DESCRIPTOR</a>,
02374                                              ListEntry);
02375 
02376         <span class="keywordflow">if</span> (((MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> &gt;= KernelStart) &amp;&amp; 
02377              (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> &lt; KernelEnd)) &amp;&amp; 
02378             ((MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a> == <a class="code" href="../../d1/d9/arc_8h.html#a320a261">LoaderOsloaderHeap</a>) ||
02379              (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a> == <a class="code" href="../../d1/d9/arc_8h.html#a320a273">LoaderRegistryData</a>) ||
02380              (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a> == <a class="code" href="../../d1/d9/arc_8h.html#a320a275">LoaderNlsData</a>))) {
02381 
02382             <span class="comment">//</span>
02383             <span class="comment">// prevent these pages from being reclaimed later</span>
02384             <span class="comment">//</span>
02385 
02386             MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a> = <a class="code" href="../../d1/d9/arc_8h.html#a320a276">LoaderSpecialMemory</a>;
02387 
02388         }
02389 
02390     }
02391 }
02392 
02393 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02394"></a><a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a49">02394</a> <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a49">MiCheckMemoryDescriptorList</a>(
02395     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock
02396     )
02397 {
02398     PFN_NUMBER KernelStart;
02399     PFN_NUMBER KernelEnd;
02400     ULONG_PTR PageSize;
02401     PLIST_ENTRY NextEntry;
02402     PLIST_ENTRY PreviousEntry;
02403     <a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html">PMEMORY_ALLOCATION_DESCRIPTOR</a> MemoryDescriptor;
02404     <a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html">PMEMORY_ALLOCATION_DESCRIPTOR</a> PreviousMemoryDescriptor;
02405     
02406 
02407     KernelStart = <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a27">MiNtoskrnlPhysicalBase</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
02408     PageSize = (ULONG_PTR)1 &lt;&lt; <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a29">MiNtoskrnlPageShift</a>;
02409     KernelEnd = KernelStart + (PageSize &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
02410 
02411     PreviousMemoryDescriptor = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02412     PreviousEntry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02413 
02414     NextEntry = LoaderBlock-&gt;MemoryDescriptorListHead.Flink;
02415 
02416     <span class="keywordflow">for</span> ( ; NextEntry != &amp;LoaderBlock-&gt;MemoryDescriptorListHead; NextEntry = NextEntry-&gt;Flink) {
02417 
02418         MemoryDescriptor = CONTAINING_RECORD(NextEntry,
02419                                              <a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html">MEMORY_ALLOCATION_DESCRIPTOR</a>,
02420                                              ListEntry);
02421 
02422 <span class="preprocessor">#if DBG</span>
02423 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a26">MiPrintMemoryDescriptors</a>) {
02424             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MemoryType = %x\n"</span>, MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a>);
02425             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"BasePage = %p\n"</span>, (PFN_NUMBER)MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
02426             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"PageCount = %x\n\n"</span>, MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
02427         }
02428 <span class="preprocessor">#endif</span>
02429 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ((MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> &gt;= KernelStart) &amp;&amp; 
02430             (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> + MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> &lt;= KernelEnd)) {
02431 
02432             <span class="keywordflow">if</span> (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a> == <a class="code" href="../../d1/d9/arc_8h.html#a320a255">LoaderSystemBlock</a>) {
02433 
02434                 MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a> = <a class="code" href="../../d1/d9/arc_8h.html#a320a259">LoaderFirmwareTemporary</a>;
02435 
02436             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a> == <a class="code" href="../../d1/d9/arc_8h.html#a320a276">LoaderSpecialMemory</a>) {
02437             
02438                 MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a> = <a class="code" href="../../d1/d9/arc_8h.html#a320a259">LoaderFirmwareTemporary</a>;
02439 
02440             }
02441         }
02442 
02443 
02444         <span class="keywordflow">if</span> ((PreviousMemoryDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
02445             (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a> == PreviousMemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a>) &amp;&amp;
02446             (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> == 
02447              (PreviousMemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> + PreviousMemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>))) {
02448 
02449             PreviousMemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> += MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
02450             PreviousEntry-&gt;Flink = NextEntry-&gt;Flink;
02451 
02452         } <span class="keywordflow">else</span> { 
02453 
02454             PreviousMemoryDescriptor = MemoryDescriptor;    
02455             PreviousEntry = NextEntry;
02456 
02457         }
02458 
02459     }
02460 
02461 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:22 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
