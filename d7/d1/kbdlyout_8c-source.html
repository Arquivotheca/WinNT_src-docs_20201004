<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: kbdlyout.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>kbdlyout.c</h1><a href="../../d6/d2/kbdlyout_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/**************************** Module Header ********************************\</span>
00002 <span class="comment">* Module Name: kbdlyout.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* Keyboard Layout API</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 04-14-92 IanJa      Created</span>
00010 <span class="comment">\***************************************************************************/</span>
00011 
00012 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00013 <span class="preprocessor">#pragma hdrstop</span>
00014 <span class="preprocessor"></span>
00015 <span class="comment">/*</span>
00016 <span class="comment"> * Workers (forward declarations)</span>
00017 <span class="comment"> */</span>
00018 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d2/kbdlyout_8c.html#a1">xxxInternalUnloadKeyboardLayout</a>(<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a>, <a class="code" href="../../d4/d9/structtagKL.html">PKL</a>, UINT);
00019 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d6/d2/kbdlyout_8c.html#a2">ReorderKeyboardLayouts</a>(<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a>, <a class="code" href="../../d4/d9/structtagKL.html">PKL</a>);
00020 
00021 <span class="comment">/*</span>
00022 <span class="comment"> * Note that this only works for sections &lt; 64K</span>
00023 <span class="comment"> */</span>
<a name="l00024"></a><a class="code" href="../../d6/d2/kbdlyout_8c.html#a0">00024</a> <span class="preprocessor">#define FIXUP_PTR(p, pBase) ((p) ? (p) = (PVOID)((PBYTE)pBase + (WORD)(ULONG_PTR)(p)) : 0)</span>
00025 <span class="preprocessor"></span>
00026 
00027 <span class="comment">/****************************************************************************\</span>
00028 <span class="comment">* HKLtoPKL</span>
00029 <span class="comment">*</span>
00030 <span class="comment">* pti   - thread to look in</span>
00031 <span class="comment">* hkl   - HKL_NEXT or HKL_PREV</span>
00032 <span class="comment">*         Finds the the next/prev LOADED layout, NULL if none.</span>
00033 <span class="comment">*         (Starts from the pti's active layout, may return pklActive itself)</span>
00034 <span class="comment">*       - a real HKL (Keyboard Layout handle):</span>
00035 <span class="comment">*         Finds the kbd layout struct (loaded or not), NULL if no match found.</span>
00036 <span class="comment">*</span>
00037 <span class="comment">* History:</span>
00038 <span class="comment">* 1997-02-05 IanJa     added pti parameter</span>
00039 <span class="comment">\****************************************************************************/</span>
<a name="l00040"></a><a class="code" href="../../d4/d1/userk_8h.html#a1019">00040</a> <a class="code" href="../../d4/d9/structtagKL.html">PKL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1019">HKLtoPKL</a>(
00041     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti,
00042     HKL hkl)
00043 {
00044     <a class="code" href="../../d4/d9/structtagKL.html">PKL</a> pklActive;
00045     <a class="code" href="../../d4/d9/structtagKL.html">PKL</a> pkl;
00046 
00047     UserAssert(pti != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00048     <span class="keywordflow">if</span> ((pklActive = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o4">spklActive</a>) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00049         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00050     }
00051 
00052     pkl = pklActive;
00053 
00054     <span class="keywordflow">if</span> (hkl == (HKL)HKL_PREV) {
00055         <span class="keywordflow">do</span> {
00056             pkl = pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o2">pklPrev</a>;
00057             <span class="keywordflow">if</span> (!(pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o3">dwKL_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a276">KL_UNLOADED</a>)) {
00058                 <span class="keywordflow">return</span> pkl;
00059             }
00060         } <span class="keywordflow">while</span> (pkl != pklActive);
00061         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00062     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (hkl == (HKL)HKL_NEXT) {
00063         <span class="keywordflow">do</span> {
00064             pkl = pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o1">pklNext</a>;
00065             <span class="keywordflow">if</span> (!(pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o3">dwKL_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a276">KL_UNLOADED</a>)) {
00066                 <span class="keywordflow">return</span> pkl;
00067             }
00068         } <span class="keywordflow">while</span> (pkl != pklActive);
00069         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00070     }
00071 
00072     <span class="comment">/*</span>
00073 <span class="comment">     * Find the pkl for this hkl.</span>
00074 <span class="comment">     * If the kbd layout isn't specified (in the HIWORD), ignore it and look</span>
00075 <span class="comment">     * for a Locale match only.  (Mohamed Hamid's fix for Word bug)</span>
00076 <span class="comment">     */</span>
00077     <span class="keywordflow">if</span> (HandleToUlong(hkl) &amp; 0xffff0000) {
00078         <span class="keywordflow">do</span> {
00079             <span class="keywordflow">if</span> (pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o4">hkl</a> == hkl) {
00080                 <span class="keywordflow">return</span> pkl;
00081             }
00082             pkl = pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o1">pklNext</a>;
00083         } <span class="keywordflow">while</span> (pkl != pklActive);
00084     } <span class="keywordflow">else</span> {
00085         <span class="keywordflow">do</span> {
00086             <span class="keywordflow">if</span> (LOWORD(HandleToUlong(pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o4">hkl</a>)) == LOWORD(HandleToUlong(hkl))) {
00087                 <span class="keywordflow">return</span> pkl;
00088             }
00089             pkl = pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o1">pklNext</a>;
00090         } <span class="keywordflow">while</span> (pkl != pklActive);
00091     }
00092 
00093     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00094 }
00095 
00096 
00097 <span class="comment">/***************************************************************************\</span>
00098 <span class="comment">* ReadLayoutFile</span>
00099 <span class="comment">*</span>
00100 <span class="comment">* Maps layout file into memory and initializes layout table.</span>
00101 <span class="comment">*</span>
00102 <span class="comment">* History:</span>
00103 <span class="comment">* 01-10-95 JimA         Created.</span>
00104 <span class="comment">\***************************************************************************/</span>
00105 
<a name="l00106"></a><a class="code" href="../../d6/d2/kbdlyout_8c.html#a4">00106</a> PKBDTABLES <a class="code" href="../../d6/d2/kbdlyout_8c.html#a4">ReadLayoutFile</a>(
00107     <a class="code" href="../../d1/d9/structtagKBDFILE.html">PKBDFILE</a> pkf,
00108     HANDLE hFile,
00109     UINT offTable,
00110     PKBDNLSTABLES *ppNlsTables)
00111 {
00112     HANDLE hmap;
00113     SIZE_T ulViewSize = 0;
00114     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00115     PIMAGE_DOS_HEADER DosHdr;
00116     PIMAGE_NT_HEADERS NtHeader;
00117     PIMAGE_SECTION_HEADER SectionTableEntry;
00118     ULONG NumberOfSubsections;
00119     ULONG OffsetToSectionTable;
00120     <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a> pBaseDst, pBaseVirt;
00121     PKBDTABLES pktNew = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00122     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwDataSize;
00123     PKBDNLSTABLES pknlstNew = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00124     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>  offNlsTable = HIWORD(offTable);
00125     <span class="comment">/*</span>
00126 <span class="comment">     * Mask off hiword.</span>
00127 <span class="comment">     */</span>
00128     offTable &amp;= 0x0000FFFF;
00129 
00130     <span class="comment">/*</span>
00131 <span class="comment">     * Initialize KbdNlsTables with NULL.</span>
00132 <span class="comment">     */</span>
00133     *ppNlsTables = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00134 
00135     <span class="comment">/*</span>
00136 <span class="comment">     * Map the layout file into memory</span>
00137 <span class="comment">     */</span>
00138     DosHdr = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00139     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwCreateSection(&amp;hmap, SECTION_ALL_ACCESS, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00140                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, PAGE_READONLY, SEC_COMMIT, hFile);
00141     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
00142         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00143 
00144     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwMapViewOfSection(hmap, NtCurrentProcess(), &amp;DosHdr, 0, 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00145                                 &amp;ulViewSize, ViewShare, 0, PAGE_READONLY);
00146     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00147         <span class="keywordflow">goto</span> exitread;
00148     }
00149 
00150     <span class="comment">/*</span>
00151 <span class="comment">     * HACK Part 2!  We find the .data section in the file header</span>
00152 <span class="comment">     * and by subtracting the virtual address from offTable find</span>
00153 <span class="comment">     * the offset in the section of the layout table.</span>
00154 <span class="comment">     */</span>
00155     NtHeader = (PIMAGE_NT_HEADERS)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)DosHdr + (ULONG)DosHdr-&gt;e_lfanew);
00156 
00157     <span class="comment">/*</span>
00158 <span class="comment">     * Build the next subsections.</span>
00159 <span class="comment">     */</span>
00160     NumberOfSubsections = NtHeader-&gt;FileHeader.NumberOfSections;
00161 
00162     <span class="comment">/*</span>
00163 <span class="comment">     * At this point the object table is read in (if it was not</span>
00164 <span class="comment">     * already read in) and may displace the image header.</span>
00165 <span class="comment">     */</span>
00166     OffsetToSectionTable = <span class="keyword">sizeof</span>(ULONG) +
00167                               <span class="keyword">sizeof</span>(IMAGE_FILE_HEADER) +
00168                               NtHeader-&gt;FileHeader.SizeOfOptionalHeader;
00169     SectionTableEntry = (PIMAGE_SECTION_HEADER)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)NtHeader +
00170                                 OffsetToSectionTable);
00171 
00172     <span class="keywordflow">while</span> (NumberOfSubsections &gt; 0) {
00173         <span class="keywordflow">if</span> (strcmp(SectionTableEntry-&gt;Name, <span class="stringliteral">".data"</span>) == 0)
00174             <span class="keywordflow">break</span>;
00175 
00176         SectionTableEntry++;
00177         NumberOfSubsections--;
00178     }
00179     <span class="keywordflow">if</span> (NumberOfSubsections == 0) {
00180         <span class="keywordflow">goto</span> exitread;
00181     }
00182 
00183     <span class="comment">/*</span>
00184 <span class="comment">     * We found the section, now compute starting offset and the table size.</span>
00185 <span class="comment">     */</span>
00186     offTable -= SectionTableEntry-&gt;VirtualAddress;
00187     dwDataSize = SectionTableEntry-&gt;Misc.VirtualSize;
00188 
00189     <span class="comment">/*</span>
00190 <span class="comment">     * Allocate layout table and copy from file.</span>
00191 <span class="comment">     */</span>
00192     pBaseDst = UserAllocPool(dwDataSize, TAG_KBDTABLE);
00193     <span class="keywordflow">if</span> (pBaseDst != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00194         VK_TO_WCHAR_TABLE *pVkToWcharTable;
00195         VSC_LPWSTR *pKeyName;
00196         LPWSTR *lpDeadKey;
00197 
00198         pkf-&gt;<a class="code" href="../../d1/d9/structtagKBDFILE.html#o3">hBase</a> = (HANDLE)pBaseDst;
00199         RtlMoveMemory(pBaseDst, (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)DosHdr +
00200                 SectionTableEntry-&gt;PointerToRawData, dwDataSize);
00201 
00202         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/inc_2user_8h.html#a882">ISTS</a>()) {
00203             pkf-&gt;<a class="code" href="../../d1/d9/structtagKBDFILE.html#o5">Size</a> = dwDataSize; <span class="comment">// For shadow hotkey processing</span>
00204         }
00205 
00206         <span class="comment">/*</span>
00207 <span class="comment">         * Compute table address and fixup pointers in table.</span>
00208 <span class="comment">         */</span>
00209         pktNew = (PKBDTABLES)(pBaseDst + offTable);
00210 
00211         <span class="comment">/*</span>
00212 <span class="comment">         * The address in the data section has the virtual address</span>
00213 <span class="comment">         * added in, so we need to adjust the fixup pointer to</span>
00214 <span class="comment">         * compensate.</span>
00215 <span class="comment">         */</span>
00216         pBaseVirt = pBaseDst - SectionTableEntry-&gt;VirtualAddress;
00217 
00218         <a class="code" href="../../d6/d2/kbdlyout_8c.html#a0">FIXUP_PTR</a>(pktNew-&gt;pCharModifiers, pBaseVirt);
00219         <a class="code" href="../../d6/d2/kbdlyout_8c.html#a0">FIXUP_PTR</a>(pktNew-&gt;pCharModifiers-&gt;pVkToBit, pBaseVirt);
00220         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/kbdlyout_8c.html#a0">FIXUP_PTR</a>(pktNew-&gt;pVkToWcharTable, pBaseVirt)) {
00221             <span class="keywordflow">for</span> (pVkToWcharTable = pktNew-&gt;pVkToWcharTable;
00222                     pVkToWcharTable-&gt;pVkToWchars != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; pVkToWcharTable++)
00223                 <a class="code" href="../../d6/d2/kbdlyout_8c.html#a0">FIXUP_PTR</a>(pVkToWcharTable-&gt;pVkToWchars, pBaseVirt);
00224         }
00225         <a class="code" href="../../d6/d2/kbdlyout_8c.html#a0">FIXUP_PTR</a>(pktNew-&gt;pDeadKey, pBaseVirt);
00226         <span class="comment">/*</span>
00227 <span class="comment">         * Version 1 layouts support ligatures.</span>
00228 <span class="comment">         */</span>
00229         <span class="keywordflow">if</span> (GET_KBD_VERSION(pktNew)) {
00230             <a class="code" href="../../d6/d2/kbdlyout_8c.html#a0">FIXUP_PTR</a>(pktNew-&gt;pLigature, pBaseVirt);
00231         }
00232         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/kbdlyout_8c.html#a0">FIXUP_PTR</a>(pktNew-&gt;pKeyNames, pBaseVirt)) {
00233             <span class="keywordflow">for</span> (pKeyName = pktNew-&gt;pKeyNames; pKeyName-&gt;vsc != 0; pKeyName++)
00234                 <a class="code" href="../../d6/d2/kbdlyout_8c.html#a0">FIXUP_PTR</a>(pKeyName-&gt;pwsz, pBaseVirt);
00235         }
00236         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/kbdlyout_8c.html#a0">FIXUP_PTR</a>(pktNew-&gt;pKeyNamesExt, pBaseVirt)) {
00237             <span class="keywordflow">for</span> (pKeyName = pktNew-&gt;pKeyNamesExt; pKeyName-&gt;vsc != 0; pKeyName++)
00238                 <a class="code" href="../../d6/d2/kbdlyout_8c.html#a0">FIXUP_PTR</a>(pKeyName-&gt;pwsz, pBaseVirt);
00239         }
00240         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/kbdlyout_8c.html#a0">FIXUP_PTR</a>(pktNew-&gt;pKeyNamesDead, pBaseVirt)) {
00241             <span class="keywordflow">for</span> (lpDeadKey = pktNew-&gt;pKeyNamesDead; *lpDeadKey != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00242                     lpDeadKey++)
00243                 <a class="code" href="../../d6/d2/kbdlyout_8c.html#a0">FIXUP_PTR</a>(*lpDeadKey, pBaseVirt);
00244         }
00245         <a class="code" href="../../d6/d2/kbdlyout_8c.html#a0">FIXUP_PTR</a>(pktNew-&gt;pusVSCtoVK, pBaseVirt);
00246         <a class="code" href="../../d6/d2/kbdlyout_8c.html#a0">FIXUP_PTR</a>(pktNew-&gt;pVSCtoVK_E0, pBaseVirt);
00247         <a class="code" href="../../d6/d2/kbdlyout_8c.html#a0">FIXUP_PTR</a>(pktNew-&gt;pVSCtoVK_E1, pBaseVirt);
00248 
00249         <span class="keywordflow">if</span> (offNlsTable) {
00250             <span class="comment">/*</span>
00251 <span class="comment">             * Compute table address and fixup pointers in table.</span>
00252 <span class="comment">             */</span>
00253             offNlsTable -= SectionTableEntry-&gt;VirtualAddress;
00254             pknlstNew = (PKBDNLSTABLES)(pBaseDst + offNlsTable);
00255 
00256             <span class="comment">/*</span>
00257 <span class="comment">             * Fixup the address.</span>
00258 <span class="comment">             */</span>
00259             <a class="code" href="../../d6/d2/kbdlyout_8c.html#a0">FIXUP_PTR</a>(pknlstNew-&gt;pVkToF, pBaseVirt);
00260             <a class="code" href="../../d6/d2/kbdlyout_8c.html#a0">FIXUP_PTR</a>(pknlstNew-&gt;pusMouseVKey, pBaseVirt);
00261 
00262             <span class="comment">/*</span>
00263 <span class="comment">             * Save the pointer.</span>
00264 <span class="comment">             */</span>
00265             *ppNlsTables = pknlstNew;
00266 
00267 <span class="preprocessor">        #if DBG_FE</span>
00268 <span class="preprocessor"></span>            {
00269                 <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> NumOfVkToF = pknlstNew-&gt;NumOfVkToF;
00270 
00271                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"NumOfVkToF - %d\n"</span>,NumOfVkToF);
00272 
00273                 <span class="keywordflow">while</span>(NumOfVkToF) {
00274                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"VK = %x\n"</span>,pknlstNew-&gt;pVkToF[NumOfVkToF-1].Vk);
00275                     NumOfVkToF--;
00276                 }
00277             }
00278 <span class="preprocessor">        #endif  // DBG_FE</span>
00279 <span class="preprocessor"></span>        }
00280     }
00281 
00282 exitread:
00283 
00284     <span class="comment">/*</span>
00285 <span class="comment">     * Unmap and release the mapped section.</span>
00286 <span class="comment">     */</span>
00287     ZwUnmapViewOfSection(NtCurrentProcess(), DosHdr);
00288     ZwClose(hmap);
00289 
00290     <span class="keywordflow">return</span> pktNew;
00291 }
00292 
<a name="l00293"></a><a class="code" href="../../d6/d2/kbdlyout_8c.html#a5">00293</a> PKBDTABLES <a class="code" href="../../d6/d2/kbdlyout_8c.html#a5">PrepareFallbackKeyboardFile</a>(<a class="code" href="../../d1/d9/structtagKBDFILE.html">PKBDFILE</a> pkf)
00294 {
00295     <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a> pBaseDst;
00296 
00297     pBaseDst = UserAllocPool(<span class="keyword">sizeof</span>(KBDTABLES), TAG_KBDTABLE);
00298     <span class="keywordflow">if</span> (pBaseDst != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00299         RtlCopyMemory(pBaseDst, &amp;<a class="code" href="../../d9/d6/ntuser_2kernel_2globals_8h.html#a240">KbdTablesFallback</a>, <span class="keyword">sizeof</span> <a class="code" href="../../d9/d6/ntuser_2kernel_2globals_8h.html#a240">KbdTablesFallback</a>);
00300         <span class="comment">// Note: Unlike ReadLayoutFile(),</span>
00301         <span class="comment">// we don't need to fix up pointers in struct KBDFILE.</span>
00302     }
00303     pkf-&gt;<a class="code" href="../../d1/d9/structtagKBDFILE.html#o3">hBase</a> = (HANDLE)pBaseDst;
00304     pkf-&gt;<a class="code" href="../../d1/d9/structtagKBDFILE.html#o6">pKbdNlsTbl</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00305     <span class="keywordflow">return</span> (PKBDTABLES)pBaseDst;
00306 }
00307 
00308 
00309 <span class="comment">/***************************************************************************\</span>
00310 <span class="comment">* LoadKeyboardLayoutFile</span>
00311 <span class="comment">*</span>
00312 <span class="comment">* History:</span>
00313 <span class="comment">* 10-29-95 GregoryW         Created.</span>
00314 <span class="comment">\***************************************************************************/</span>
00315 
<a name="l00316"></a><a class="code" href="../../d6/d2/kbdlyout_8c.html#a6">00316</a> <a class="code" href="../../d1/d9/structtagKBDFILE.html">PKBDFILE</a> <a class="code" href="../../d6/d2/kbdlyout_8c.html#a6">LoadKeyboardLayoutFile</a>(
00317     HANDLE hFile,
00318     UINT offTable,
00319     LPCWSTR pwszKLID)
00320 {
00321     <a class="code" href="../../d1/d9/structtagKBDFILE.html">PKBDFILE</a> pkf = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a245">gpkfList</a>;
00322 
00323     <span class="keywordflow">if</span> (pkf) {
00324         <span class="keywordtype">int</span> iCmp;
00325 
00326         <span class="keywordflow">do</span> {
00327             iCmp = wcscmp(pkf-&gt;<a class="code" href="../../d1/d9/structtagKBDFILE.html#o2">awchKF</a>, pwszKLID);
00328             <span class="keywordflow">if</span> (iCmp == 0) {
00329 
00330                 <span class="comment">/*</span>
00331 <span class="comment">                 * The layout is already loaded.</span>
00332 <span class="comment">                 */</span>
00333                 <span class="keywordflow">return</span> pkf;
00334             }
00335             pkf = pkf-&gt;<a class="code" href="../../d1/d9/structtagKBDFILE.html#o1">pkfNext</a>;
00336         } <span class="keywordflow">while</span> (pkf);
00337     }
00338 
00339     <span class="comment">/*</span>
00340 <span class="comment">     * Allocate a new Keyboard File structure.</span>
00341 <span class="comment">     */</span>
00342     pkf = (<a class="code" href="../../d1/d9/structtagKBDFILE.html">PKBDFILE</a>)<a class="code" href="../../d4/d1/userk_8h.html#a969">HMAllocObject</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a250">TYPE_KBDFILE</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d9/structtagKBDFILE.html">KBDFILE</a>));
00343     <span class="keywordflow">if</span> (!pkf) {
00344         RIPMSG0(RIP_WARNING, <span class="stringliteral">"Keyboard Layout File: out of memory"</span>);
00345         <span class="keywordflow">return</span> (<a class="code" href="../../d1/d9/structtagKBDFILE.html">PKBDFILE</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00346     }
00347 
00348     <span class="comment">/*</span>
00349 <span class="comment">     * Load layout table.</span>
00350 <span class="comment">     */</span>
00351     <span class="keywordflow">if</span> (hFile != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00352         <span class="comment">/*</span>
00353 <span class="comment">         * Load NLS layout table also...</span>
00354 <span class="comment">         */</span>
00355         pkf-&gt;<a class="code" href="../../d1/d9/structtagKBDFILE.html#o4">pKbdTbl</a> = <a class="code" href="../../d6/d2/kbdlyout_8c.html#a4">ReadLayoutFile</a>(pkf, hFile, offTable, &amp;(pkf-&gt;<a class="code" href="../../d1/d9/structtagKBDFILE.html#o6">pKbdNlsTbl</a>));
00356     } <span class="keywordflow">else</span> {
00357         <span class="comment">/*</span>
00358 <span class="comment">         * We failed to open the keyboard layout file in client side</span>
00359 <span class="comment">         * because the dll was missing.</span>
00360 <span class="comment">         * If this ever happens, we used to fail creating</span>
00361 <span class="comment">         * a window station, but we should allow a user</span>
00362 <span class="comment">         * at least to boot the system.</span>
00363 <span class="comment">         */</span>
00364         pkf-&gt;<a class="code" href="../../d1/d9/structtagKBDFILE.html#o4">pKbdTbl</a> = <a class="code" href="../../d6/d2/kbdlyout_8c.html#a5">PrepareFallbackKeyboardFile</a>(pkf);
00365         <span class="comment">// Note: pkf-&gt;pKbdNlsTbl has been NULL'ed in PrepareFallbackKeyboardFile()</span>
00366     }
00367 
00368     <span class="keywordflow">if</span> (pkf-&gt;<a class="code" href="../../d1/d9/structtagKBDFILE.html#o4">pKbdTbl</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00369         <a class="code" href="../../d4/d1/userk_8h.html#a970">HMFreeObject</a>(pkf);
00370         <span class="keywordflow">return</span> (<a class="code" href="../../d1/d9/structtagKBDFILE.html">PKBDFILE</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00371     }
00372 
00373     <a class="code" href="../../d1/d5/w32_2ntuser_2rtl_2random_8c.html#a3">wcsncpycch</a>(pkf-&gt;<a class="code" href="../../d1/d9/structtagKBDFILE.html#o2">awchKF</a>, pwszKLID, <span class="keyword">sizeof</span>(pkf-&gt;<a class="code" href="../../d1/d9/structtagKBDFILE.html#o2">awchKF</a>) / <span class="keyword">sizeof</span>(WCHAR));
00374 
00375     <span class="comment">/*</span>
00376 <span class="comment">     * Put keyboard layout file at front of list.</span>
00377 <span class="comment">     */</span>
00378     pkf-&gt;<a class="code" href="../../d1/d9/structtagKBDFILE.html#o1">pkfNext</a> = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a245">gpkfList</a>;
00379     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a245">gpkfList</a> = pkf;
00380 
00381     <span class="keywordflow">return</span> pkf;
00382 }
00383 
00384 <span class="comment">/***************************************************************************\</span>
00385 <span class="comment">* RemoveKeyboardLayoutFile</span>
00386 <span class="comment">*</span>
00387 <span class="comment">* History:</span>
00388 <span class="comment">* 10-29-95 GregoryW         Created.</span>
00389 <span class="comment">\***************************************************************************/</span>
<a name="l00390"></a><a class="code" href="../../d4/d1/userk_8h.html#a1307">00390</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1307">RemoveKeyboardLayoutFile</a>(
00391     <a class="code" href="../../d1/d9/structtagKBDFILE.html">PKBDFILE</a> pkf)
00392 {
00393     <a class="code" href="../../d1/d9/structtagKBDFILE.html">PKBDFILE</a> pkfPrev, pkfCur;
00394 
00395     <span class="comment">// FE: NT4 SP4 #107809</span>
00396     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a70">gpKbdTbl</a> == pkf-&gt;<a class="code" href="../../d1/d9/structtagKBDFILE.html#o4">pKbdTbl</a>) {
00397         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a70">gpKbdTbl</a> = &amp;<a class="code" href="../../d9/d6/ntuser_2kernel_2globals_8h.html#a240">KbdTablesFallback</a>;
00398     }
00399     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a72">gpKbdNlsTbl</a> == pkf-&gt;<a class="code" href="../../d1/d9/structtagKBDFILE.html#o6">pKbdNlsTbl</a>) {
00400         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a72">gpKbdNlsTbl</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00401     }
00402 
00403     <span class="comment">/*</span>
00404 <span class="comment">     * Good old linked list management 101</span>
00405 <span class="comment">     */</span>
00406     <span class="keywordflow">if</span> (pkf == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a245">gpkfList</a>) {
00407         <span class="comment">/*</span>
00408 <span class="comment">         * Head of the list.</span>
00409 <span class="comment">         */</span>
00410         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a245">gpkfList</a> = pkf-&gt;<a class="code" href="../../d1/d9/structtagKBDFILE.html#o1">pkfNext</a>;
00411         <span class="keywordflow">return</span>;
00412     }
00413     pkfPrev = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a245">gpkfList</a>;
00414     pkfCur = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a245">gpkfList</a>-&gt;<a class="code" href="../../d1/d9/structtagKBDFILE.html#o1">pkfNext</a>;
00415     <span class="keywordflow">while</span> (pkf != pkfCur) {
00416         pkfPrev = pkfCur;
00417         pkfCur = pkfCur-&gt;<a class="code" href="../../d1/d9/structtagKBDFILE.html#o1">pkfNext</a>;
00418     }
00419     <span class="comment">/*</span>
00420 <span class="comment">     * Found it!</span>
00421 <span class="comment">     */</span>
00422     pkfPrev-&gt;<a class="code" href="../../d1/d9/structtagKBDFILE.html#o1">pkfNext</a> = pkfCur-&gt;<a class="code" href="../../d1/d9/structtagKBDFILE.html#o1">pkfNext</a>;
00423 }
00424 
00425 <span class="comment">/***************************************************************************\</span>
00426 <span class="comment">* DestroyKF</span>
00427 <span class="comment">*</span>
00428 <span class="comment">* Called when a keyboard layout file is destroyed due to an unlock.</span>
00429 <span class="comment">*</span>
00430 <span class="comment">* History:</span>
00431 <span class="comment">* 24-Feb-1997 adams     Created.</span>
00432 <span class="comment">\***************************************************************************/</span>
00433 
00434 <span class="keywordtype">void</span>
<a name="l00435"></a><a class="code" href="../../d4/d1/userk_8h.html#a1183">00435</a> <a class="code" href="../../d4/d1/userk_8h.html#a1183">DestroyKF</a>(<a class="code" href="../../d1/d9/structtagKBDFILE.html">PKBDFILE</a> pkf)
00436 {
00437     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a971">HMMarkObjectDestroy</a>(pkf))
00438         <span class="keywordflow">return</span>;
00439 
00440     <a class="code" href="../../d4/d1/userk_8h.html#a1307">RemoveKeyboardLayoutFile</a>(pkf);
00441     UserFreePool(pkf-&gt;<a class="code" href="../../d1/d9/structtagKBDFILE.html#o3">hBase</a>);
00442     <a class="code" href="../../d4/d1/userk_8h.html#a970">HMFreeObject</a>(pkf);
00443 }
00444 
<a name="l00445"></a><a class="code" href="../../d6/d2/kbdlyout_8c.html#a9">00445</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> <a class="code" href="../../d6/d2/kbdlyout_8c.html#a9">GetThreadsWithPKL</a>(
00446     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> **ppptiList,
00447     <a class="code" href="../../d4/d9/structtagKL.html">PKL</a> pkl)
00448 {
00449     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>     ptiT, *pptiT, *pptiListAllocated;
00450     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>             cThreads, cThreadsAllocated;
00451     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a>  pwinsta;
00452     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a>        pdesk;
00453     PLIST_ENTRY     pHead, pEntry;
00454 
00455     <span class="keywordflow">if</span> (ppptiList != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00456         *ppptiList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00457 
00458     cThreads = 0;
00459 
00460     <span class="comment">/*</span>
00461 <span class="comment">     * allocate a first list for 128 entries</span>
00462 <span class="comment">     */</span>
00463     cThreadsAllocated = 128;
00464     pptiListAllocated = UserAllocPool(cThreadsAllocated * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>),
00465                             TAG_SYSTEM);
00466 
00467     <span class="keywordflow">if</span> (pptiListAllocated == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00468         RIPMSG0(RIP_WARNING, <span class="stringliteral">"GetPKLinThreads: out of memory"</span>);
00469         <span class="keywordflow">return</span> 0;
00470     }
00471 
00472     <span class="comment">// for all the winstations</span>
00473     <span class="keywordflow">for</span> (pwinsta = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a241">grpWinStaList</a>; pwinsta != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ; pwinsta = pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o0">rpwinstaNext</a>) {
00474 
00475         <span class="comment">// for all the desktops in that winstation</span>
00476         <span class="keywordflow">for</span> (pdesk = pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o1">rpdeskList</a>; pdesk != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ; pdesk = pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o2">rpdeskNext</a>) {
00477 
00478             pHead = &amp;pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o20">PtiList</a>;
00479 
00480             <span class="comment">// for all the threads in that desktop</span>
00481             <span class="keywordflow">for</span> (pEntry = pHead-&gt;Flink; pEntry != pHead; pEntry = pEntry-&gt;Flink) {
00482 
00483                 ptiT = CONTAINING_RECORD(pEntry, <a class="code" href="../../d2/d8/structtagTHREADINFO.html">THREADINFO</a>, PtiLink);
00484 
00485                 <span class="keywordflow">if</span> (ptiT == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00486                     <span class="keywordflow">continue</span>;
00487                 }
00488 
00489                 <span class="keywordflow">if</span> (pkl &amp;&amp; (pkl != ptiT-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o4">spklActive</a>)) { <span class="comment">// #99321 cmp pkls, not hkls?</span>
00490                     <span class="keywordflow">continue</span>;
00491                 }
00492 
00493                 <span class="keywordflow">if</span> (cThreads == cThreadsAllocated) {
00494 
00495                     cThreadsAllocated += 128;
00496 
00497                     pptiT = UserReAllocPool(pptiListAllocated,
00498                                     cThreads * <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a951">PTHREADINFO</a>),
00499                                     cThreadsAllocated * <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a951">PTHREADINFO</a>),
00500                                     TAG_SYSTEM);
00501 
00502                     <span class="keywordflow">if</span> (pptiT == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00503                         RIPMSG0(RIP_ERROR, <span class="stringliteral">"GetPKLinThreads: Out of memory"</span>);
00504                         UserFreePool(pptiListAllocated);
00505                         <span class="keywordflow">return</span> 0;
00506                     }
00507 
00508                     pptiListAllocated = pptiT;
00509 
00510                 }
00511 
00512                 pptiListAllocated[cThreads++] = ptiT;
00513             }
00514         }
00515     }
00516 
00517     <span class="comment">/*</span>
00518 <span class="comment">     * add CSRSS threads</span>
00519 <span class="comment">     */</span>
00520     <span class="keywordflow">for</span> (ptiT = <a class="code" href="../../d4/d1/userk_8h.html#a18">PpiFromProcess</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a299">gpepCSRSS</a>)-&gt;ptiList; ptiT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; ptiT = ptiT-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o29">ptiSibling</a>) {
00521 
00522         <span class="keywordflow">if</span> (pkl &amp;&amp; (pkl != ptiT-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o4">spklActive</a>)) { <span class="comment">// #99321 cmp pkls, not hkls?</span>
00523             <span class="keywordflow">continue</span>;
00524         }
00525 
00526         <span class="keywordflow">if</span> (cThreads == cThreadsAllocated) {
00527 
00528             cThreadsAllocated += 128;
00529 
00530             pptiT = UserReAllocPool(pptiListAllocated,
00531                             cThreads * <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a951">PTHREADINFO</a>),
00532                             cThreadsAllocated * <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a951">PTHREADINFO</a>),
00533                             TAG_SYSTEM);
00534 
00535             <span class="keywordflow">if</span> (pptiT == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00536                 RIPMSG0(RIP_ERROR, <span class="stringliteral">"GetPKLinThreads: Out of memory"</span>);
00537                 UserFreePool(pptiListAllocated);
00538                 <span class="keywordflow">return</span> 0;
00539             }
00540 
00541             pptiListAllocated = pptiT;
00542 
00543         }
00544 
00545         pptiListAllocated[cThreads++] = ptiT;
00546     }
00547 
00548     <span class="keywordflow">if</span> (cThreads == 0) {
00549         UserFreePool(pptiListAllocated);
00550     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ppptiList != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00551         *ppptiList = pptiListAllocated;
00552     } <span class="keywordflow">else</span> {
00553         UserFreePool(pptiListAllocated);
00554     }
00555 
00556     <span class="keywordflow">return</span> cThreads;
00557 }
00558 
00559 
<a name="l00560"></a><a class="code" href="../../d6/d2/kbdlyout_8c.html#a10">00560</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d6/d2/kbdlyout_8c.html#a10">xxxSetPKLinThreads</a>(
00561     <a class="code" href="../../d4/d9/structtagKL.html">PKL</a> pklNew,
00562     <a class="code" href="../../d4/d9/structtagKL.html">PKL</a> pklToBeReplaced)
00563 {
00564     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> *pptiList;
00565     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> cThreads, i;
00566 
00567     UserAssert(pklNew != pklToBeReplaced);
00568 
00569     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pklNew);
00570     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pklToBeReplaced);
00571 
00572     cThreads = <a class="code" href="../../d6/d2/kbdlyout_8c.html#a9">GetThreadsWithPKL</a>(&amp;pptiList, pklToBeReplaced);
00573 
00574     <span class="comment">/*</span>
00575 <span class="comment">     * Will the foreground thread's keyboard layout change?</span>
00576 <span class="comment">     */</span>
00577     <span class="keywordflow">if</span> (pklNew &amp;&amp; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a25">gptiForeground</a> &amp;&amp; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a25">gptiForeground</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o4">spklActive</a> == pklToBeReplaced) {
00578         <a class="code" href="../../d4/d1/userk_8h.html#a1301">ChangeForegroundKeyboardTable</a>(pklToBeReplaced, pklNew);
00579     }
00580 
00581     <span class="keywordflow">if</span> (pptiList != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00582         <span class="keywordflow">if</span> (pklToBeReplaced == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00583             <span class="keywordflow">for</span> (i = 0; i &lt; cThreads; i++) {
00584                 <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;pptiList[i]-&gt;spklActive, pklNew);
00585             }
00586         } <span class="keywordflow">else</span> {
00587             <span class="comment">/*</span>
00588 <span class="comment">             * This is a replace. First, deactivate the *replaced* IME by</span>
00589 <span class="comment">             * activating the pklNew. Second, unload the *replaced* IME.</span>
00590 <span class="comment">             */</span>
00591             <a class="code" href="../../d4/d1/userk_8h.html#a2040">xxxImmActivateAndUnloadThreadsLayout</a>(pptiList, cThreads, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00592                                                  pklNew, HandleToUlong(pklToBeReplaced-&gt;hkl));
00593         }
00594         UserFreePool(pptiList);
00595     }
00596 
00597     <span class="comment">/*</span>
00598 <span class="comment">     * If this is a replace, link the new layout immediately after the</span>
00599 <span class="comment">     * layout being replaced.  This maintains ordering of layouts when</span>
00600 <span class="comment">     * the *replaced* layout is unloaded.  The input locale panel in the</span>
00601 <span class="comment">     * regional settings applet depends on this.</span>
00602 <span class="comment">     */</span>
00603     <span class="keywordflow">if</span> (pklToBeReplaced) {
00604         <span class="keywordflow">if</span> (pklToBeReplaced-&gt;pklNext == pklNew) {
00605             <span class="comment">/*</span>
00606 <span class="comment">             * Ordering already correct.  Nothing to do.</span>
00607 <span class="comment">             */</span>
00608             <span class="keywordflow">return</span>;
00609         }
00610         <span class="comment">/*</span>
00611 <span class="comment">         * Move new layout immediately after layout being replaced.</span>
00612 <span class="comment">         *   1. Remove new layout from current position.</span>
00613 <span class="comment">         *   2. Update links in new layout.</span>
00614 <span class="comment">         *   3. Link new layout into desired position.</span>
00615 <span class="comment">         */</span>
00616         pklNew-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o2">pklPrev</a>-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o1">pklNext</a> = pklNew-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o1">pklNext</a>;
00617         pklNew-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o1">pklNext</a>-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o2">pklPrev</a> = pklNew-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o2">pklPrev</a>;
00618 
00619         pklNew-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o1">pklNext</a> = pklToBeReplaced-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o1">pklNext</a>;
00620         pklNew-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o2">pklPrev</a> = pklToBeReplaced;
00621 
00622         pklToBeReplaced-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o1">pklNext</a>-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o2">pklPrev</a> = pklNew;
00623         pklToBeReplaced-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o1">pklNext</a> = pklNew;
00624     }
00625 }
00626 
<a name="l00627"></a><a class="code" href="../../d6/d2/kbdlyout_8c.html#a11">00627</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d6/d2/kbdlyout_8c.html#a11">xxxFreeImeKeyboardLayouts</a>(
00628     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta)
00629 {
00630     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> *pptiList;
00631     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> cThreads;
00632 
00633     <span class="keywordflow">if</span> (pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a316">WSF_NOIO</a>)
00634         <span class="keywordflow">return</span>;
00635 
00636     <span class="comment">/*</span>
00637 <span class="comment">     * should make GetThreadsWithPKL aware of pwinsta?</span>
00638 <span class="comment">     */</span>
00639     cThreads = <a class="code" href="../../d6/d2/kbdlyout_8c.html#a9">GetThreadsWithPKL</a>(&amp;pptiList, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00640     <span class="keywordflow">if</span> (pptiList != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00641         <a class="code" href="../../d4/d1/userk_8h.html#a2042">xxxImmUnloadThreadsLayout</a>(pptiList, cThreads, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d8/d0/immstruc_8h.html#a16">IFL_UNLOADIME</a>);
00642         UserFreePool(pptiList);
00643     }
00644 
00645     <span class="keywordflow">return</span>;
00646 }
00647 
00648 <span class="comment">/***************************************************************************\</span>
00649 <span class="comment">* xxxLoadKeyboardLayoutEx</span>
00650 <span class="comment">*</span>
00651 <span class="comment">* History:</span>
00652 <span class="comment">\***************************************************************************/</span>
00653 
<a name="l00654"></a><a class="code" href="../../d4/d1/userk_8h.html#a1302">00654</a> HKL <a class="code" href="../../d4/d1/userk_8h.html#a1302">xxxLoadKeyboardLayoutEx</a>(
00655     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta,
00656     HANDLE hFile,
00657     HKL hklToBeReplaced,
00658     UINT offTable,
00659     LPCWSTR pwszKLID,
00660     UINT KbdInputLocale,
00661     UINT Flags)
00662 {
00663     <a class="code" href="../../d4/d9/structtagKL.html">PKL</a> pkl, pklFirst, pklToBeReplaced;
00664     <a class="code" href="../../d1/d9/structtagKBDFILE.html">PKBDFILE</a> pkf;
00665     CHARSETINFO cs;
00666     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpkl;
00667     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent;
00668     UNICODE_STRING strLcidKF;
00669     LCID lcidKF;
00670     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bCharSet;
00671     <a class="code" href="../../d0/d8/structtagIMEINFOEX.html">PIMEINFOEX</a> piiex;
00672 
00673     <span class="comment">/*</span>
00674 <span class="comment">     * If the windowstation does not do I/O, don't load the</span>
00675 <span class="comment">     * layout.  Also check KdbInputLocale for #307132</span>
00676 <span class="comment">     */</span>
00677     <span class="keywordflow">if</span> ((KbdInputLocale == 0) || (pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a316">WSF_NOIO</a>)) {
00678         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00679     }
00680 
00681     <span class="comment">/*</span>
00682 <span class="comment">     * If hklToBeReplaced is non-NULL make sure it's valid.</span>
00683 <span class="comment">     *    NOTE: may want to verify they're not passing HKL_NEXT or HKL_PREV.</span>
00684 <span class="comment">     */</span>
00685     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00686     <span class="keywordflow">if</span> (hklToBeReplaced &amp;&amp; !(pklToBeReplaced = <a class="code" href="../../d4/d1/userk_8h.html#a1019">HKLtoPKL</a>(ptiCurrent, hklToBeReplaced))) {
00687         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00688     }
00689     <span class="keywordflow">if</span> (KbdInputLocale == HandleToUlong(hklToBeReplaced)) {
00690         <span class="comment">/*</span>
00691 <span class="comment">         * Replacing a layout/lang pair with itself.  Nothing to do.</span>
00692 <span class="comment">         */</span>
00693         <span class="keywordflow">return</span> pklToBeReplaced-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o4">hkl</a>;
00694     }
00695 
00696     <span class="keywordflow">if</span> (Flags &amp; KLF_RESET) {
00697         <span class="comment">/*</span>
00698 <span class="comment">         * Only WinLogon can use this flag</span>
00699 <span class="comment">         */</span>
00700         <span class="keywordflow">if</span> (ptiCurrent-&gt;pEThread-&gt;Cid.UniqueProcess != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a298">gpidLogon</a>) {
00701              RIPERR0(ERROR_INVALID_FLAGS, RIP_WARNING,
00702                      <span class="stringliteral">"Invalid flag passed to LoadKeyboardLayout"</span> );
00703              <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00704         }
00705         <a class="code" href="../../d6/d2/kbdlyout_8c.html#a11">xxxFreeImeKeyboardLayouts</a>(pwinsta);
00706         <span class="comment">/*</span>
00707 <span class="comment">         * Make sure we don't lose track of the left-over layouts</span>
00708 <span class="comment">         * They have been unloaded, but are still in use by some threads).</span>
00709 <span class="comment">         * The FALSE will prevent xxxFreeKeyboardLayouts from unlocking the</span>
00710 <span class="comment">         * unloaded layouts.</span>
00711 <span class="comment">         */</span>
00712         <a class="code" href="../../d4/d1/userk_8h.html#a1310">xxxFreeKeyboardLayouts</a>(pwinsta, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00713     }
00714 
00715     <span class="comment">/*</span>
00716 <span class="comment">     * Does this hkl already exist?</span>
00717 <span class="comment">     */</span>
00718     pkl = pklFirst = pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o4">spklList</a>;
00719 
00720     <span class="keywordflow">if</span> (pkl) {
00721         <span class="keywordflow">do</span> {
00722             <span class="keywordflow">if</span> (pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o4">hkl</a> == (HKL)IntToPtr( KbdInputLocale )) {
00723                <span class="comment">/*</span>
00724 <span class="comment">                * The hkl already exists.</span>
00725 <span class="comment">                */</span>
00726 
00727                <span class="comment">/*</span>
00728 <span class="comment">                * If it is unloaded (but not yet destroyed because it is</span>
00729 <span class="comment">                * still is use), recover it.</span>
00730 <span class="comment">                */</span>
00731                <span class="keywordflow">if</span> (pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o3">dwKL_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a276">KL_UNLOADED</a>) {
00732                    <span class="comment">// stop it from being destroyed if not is use.</span>
00733                    <a class="code" href="../../d2/d4/struct__HANDLEENTRY.html">PHE</a> phe = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a446">HMPheFromObject</a>(pkl);
00734                    <span class="comment">// An unloaded layout must be marked for destroy.</span>
00735                    UserAssert(phe-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o3">bFlags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a421">HANDLEF_DESTROY</a>);
00736                    phe-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o3">bFlags</a> &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a421">HANDLEF_DESTROY</a>;
00737 <span class="preprocessor">#if DBG</span>
00738 <span class="preprocessor"></span>                   phe-&gt;<a class="code" href="../../d2/d4/struct__HANDLEENTRY.html#o3">bFlags</a> &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a425">HANDLEF_MARKED_OK</a>;
00739 <span class="preprocessor">#endif</span>
00740 <span class="preprocessor"></span>                   pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o3">dwKL_Flags</a> &amp;= ~<a class="code" href="../../d4/d1/userk_8h.html#a276">KL_UNLOADED</a>;
00741                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(Flags &amp; KLF_RESET)) {
00742                    <span class="comment">/*</span>
00743 <span class="comment">                    * If it was already loaded and we didn't change all layouts</span>
00744 <span class="comment">                    * with KLF_RESET, there is nothing to tell the shell about</span>
00745 <span class="comment">                    */</span>
00746                    Flags &amp;= ~KLF_NOTELLSHELL;
00747                }
00748 
00749                <span class="keywordflow">goto</span> AllPresentAndCorrectSir;
00750             }
00751             pkl = pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o1">pklNext</a>;
00752         } <span class="keywordflow">while</span> (pkl != pklFirst);
00753     }
00754 
00755     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d5/conimep_8h.html#a49">IS_IME_KBDLAYOUT</a>((HKL)IntToPtr( KbdInputLocale ))) {
00756         <span class="comment">/*</span>
00757 <span class="comment">         * This is an IME keyboard layout, do a callback</span>
00758 <span class="comment">         * to read the extended IME information structure.</span>
00759 <span class="comment">         * Note: We can't fail the call so easily if</span>
00760 <span class="comment">         *       KLF_RESET is specified.</span>
00761 <span class="comment">         */</span>
00762         piiex = <a class="code" href="../../d4/d1/userk_8h.html#a2044">xxxImmLoadLayout</a>((HKL)IntToPtr( KbdInputLocale ));
00763         <span class="keywordflow">if</span> (piiex == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; !(Flags &amp; KLF_RESET)) {
00764             RIPMSG1(RIP_WARNING,
00765                   <span class="stringliteral">"Keyboard Layout: xxxImmLoadLayout(%lx) failed"</span>, KbdInputLocale);
00766             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00767         }
00768     } <span class="keywordflow">else</span> {
00769         piiex = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00770     }
00771 
00772     <span class="comment">/*</span>
00773 <span class="comment">     * Get the system font's font signature.  These are 64-bit FS_xxx values,</span>
00774 <span class="comment">     * but we are only asking for an  ANSI ones, so gSystemFS is just a DWORD.</span>
00775 <span class="comment">     * gSystemFS is consulted when posting WM_INPUTLANGCHANGEREQUEST (input.c)</span>
00776 <span class="comment">     */</span>
00777     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a64">gSystemFS</a> == 0) {
00778         LCID lcid;
00779 
00780         ZwQueryDefaultLocale(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;lcid);
00781         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1921">xxxClientGetCharsetInfo</a>(lcid, &amp;cs)) {
00782             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a64">gSystemFS</a> = cs.fs.fsCsb[0];
00783             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a71">gSystemCPCharSet</a> = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)cs.ciCharset;
00784         } <span class="keywordflow">else</span> {
00785             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a64">gSystemFS</a> = 0xFFFF;
00786             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a71">gSystemCPCharSet</a> = ANSI_CHARSET;
00787         }
00788     }
00789 
00790     <span class="comment">/*</span>
00791 <span class="comment">     * Use the Keyboard Layout's LCID to calculate the charset, codepage etc,</span>
00792 <span class="comment">     * so that characters from that layout don't just becomes ?s if the input</span>
00793 <span class="comment">     * locale doesn't match.  This allows "dumb" applications to display the</span>
00794 <span class="comment">     * text if the user chooses the right font.</span>
00795 <span class="comment">     * We can't just use the HIWORD of KbdInputLocale because if a variant</span>
00796 <span class="comment">     * keyboard layout was chosen, this will be something like F008 - have to</span>
00797 <span class="comment">     * look inside the KF to get the real LCID of the kbdfile: this will be</span>
00798 <span class="comment">     * something like L"00010419", and we want the last 4 digits.</span>
00799 <span class="comment">     */</span>
00800     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;strLcidKF, pwszKLID + 4);
00801     <a class="code" href="../../d9/d3/cnvint_8c.html#a4">RtlUnicodeStringToInteger</a>(&amp;strLcidKF, 16, (PULONG)&amp;lcidKF);
00802     bCharSet = <a class="code" href="../../d4/d1/userk_8h.html#a1921">xxxClientGetCharsetInfo</a>(lcidKF, &amp;cs);
00803 
00804     <span class="comment">/*</span>
00805 <span class="comment">     * Keyboard Layout Handle object does not exist.  Load keyboard layout file,</span>
00806 <span class="comment">     * if not already loaded.</span>
00807 <span class="comment">     */</span>
00808     <span class="keywordflow">if</span> (!(pkf = <a class="code" href="../../d6/d2/kbdlyout_8c.html#a6">LoadKeyboardLayoutFile</a>(hFile, offTable, pwszKLID))) {
00809         <span class="keywordflow">goto</span> freePiiex;
00810     }
00811     <span class="comment">/*</span>
00812 <span class="comment">     * Allocate a new Keyboard Layout structure (hkl)</span>
00813 <span class="comment">     */</span>
00814     pkl = (<a class="code" href="../../d4/d9/structtagKL.html">PKL</a>)<a class="code" href="../../d4/d1/userk_8h.html#a969">HMAllocObject</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a249">TYPE_KBDLAYOUT</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d9/structtagKL.html">KL</a>));
00815     <span class="keywordflow">if</span> (!pkl) {
00816         RIPMSG0(RIP_WARNING, <span class="stringliteral">"Keyboard Layout: out of memory"</span>);
00817         UserFreePool(pkf-&gt;<a class="code" href="../../d1/d9/structtagKBDFILE.html#o3">hBase</a>);
00818         <a class="code" href="../../d4/d1/userk_8h.html#a971">HMMarkObjectDestroy</a>(pkf);
00819         <a class="code" href="../../d4/d1/userk_8h.html#a110">HMUnlockObject</a>(pkf);
00820 freePiiex:
00821         <span class="keywordflow">if</span> (piiex) {
00822             UserFreePool(piiex);
00823         }
00824         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00825     }
00826 
00827     <span class="comment">/*</span>
00828 <span class="comment">     * Link to itself in case we have to DestroyKL</span>
00829 <span class="comment">     */</span>
00830     pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o1">pklNext</a> = pkl;
00831     pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o2">pklPrev</a> = pkl;
00832 
00833     <span class="comment">/*</span>
00834 <span class="comment">     * Init KL</span>
00835 <span class="comment">     */</span>
00836     pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o3">dwKL_Flags</a> = 0;
00837     pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o9">wchDiacritic</a> = 0;
00838     pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o4">hkl</a> = (HKL)IntToPtr( KbdInputLocale );
00839     <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o5">spkf</a>, pkf);
00840 
00841     pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o5">spkf</a>-&gt;<a class="code" href="../../d1/d9/structtagKBDFILE.html#o4">pKbdTbl</a>-&gt;fLocaleFlags |= KLL_LAYOUT_ATTR_FROM_KLF(Flags);
00842 
00843     pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o10">piiex</a> = piiex;
00844 
00845     <span class="keywordflow">if</span> (bCharSet) {
00846         pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o8">CodePage</a> = (WORD)cs.ciACP;
00847         pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o6">dwFontSigs</a> = cs.fs.fsCsb[1];   <span class="comment">// font signature mask (FS_xxx values)</span>
00848         pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o7">iBaseCharset</a> = cs.ciCharset;   <span class="comment">// charset value</span>
00849     } <span class="keywordflow">else</span> {
00850         pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o8">CodePage</a> = CP_ACP;
00851         pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o6">dwFontSigs</a> = FS_LATIN1;
00852         pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o7">iBaseCharset</a> = ANSI_CHARSET;
00853     }
00854 
00855     <span class="comment">/*</span>
00856 <span class="comment">     * Insert KL in the double-linked circular list, at the end.</span>
00857 <span class="comment">     */</span>
00858     pklFirst = pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o4">spklList</a>;
00859     <span class="keywordflow">if</span> (pklFirst == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00860         <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o4">spklList</a>, pkl);
00861     } <span class="keywordflow">else</span> {
00862         pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o1">pklNext</a> = pklFirst;
00863         pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o2">pklPrev</a> = pklFirst-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o2">pklPrev</a>;
00864         pklFirst-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o2">pklPrev</a>-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o1">pklNext</a> = pkl;
00865         pklFirst-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o2">pklPrev</a> = pkl;
00866     }
00867 
00868 AllPresentAndCorrectSir:
00869 
00870     <span class="comment">// FE_IME</span>
00871     <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pkl, &amp;tlpkl);
00872 
00873     <span class="keywordflow">if</span> (hklToBeReplaced) {
00874         <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlPKLToBeReplaced;
00875         <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pklToBeReplaced, &amp;tlPKLToBeReplaced);
00876         <a class="code" href="../../d6/d2/kbdlyout_8c.html#a10">xxxSetPKLinThreads</a>(pkl, pklToBeReplaced);
00877         <a class="code" href="../../d6/d2/kbdlyout_8c.html#a1">xxxInternalUnloadKeyboardLayout</a>(pwinsta, pklToBeReplaced, KLF_INITTIME);
00878         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlPKLToBeReplaced);
00879     }
00880 
00881     <span class="keywordflow">if</span> (Flags &amp; KLF_REORDER) {
00882         <a class="code" href="../../d6/d2/kbdlyout_8c.html#a2">ReorderKeyboardLayouts</a>(pwinsta, pkl);
00883     }
00884 
00885     <span class="keywordflow">if</span> (!(Flags &amp; KLF_NOTELLSHELL) &amp;&amp; <a class="code" href="../../d6/d0/usercli_8h.html#a208">IsHooked</a>(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>(), <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a523">WHF_SHELL</a>)) {
00886         <a class="code" href="../../d4/d1/userk_8h.html#a1521">xxxCallHook</a>(HSHELL_LANGUAGE, (WPARAM)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, (LPARAM)0, WH_SHELL);
00887         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a63">gLCIDSentToShell</a> = 0;
00888     }
00889 
00890     <span class="keywordflow">if</span> (Flags &amp; KLF_ACTIVATE) {
00891         <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlPKL;
00892         <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pkl, &amp;tlPKL);
00893         <a class="code" href="../../d4/d1/userk_8h.html#a1304">xxxInternalActivateKeyboardLayout</a>(pkl, Flags, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00894         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlPKL);
00895     }
00896 
00897     <span class="keywordflow">if</span> (Flags &amp; KLF_RESET) {
00898         RIPMSG2(RIP_VERBOSE, <span class="stringliteral">"Flag &amp; KLF_RESET, locking gspklBaseLayout(%08x) with new kl(%08x)"</span>,
00899                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a62">gspklBaseLayout</a> ? <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a62">gspklBaseLayout</a>-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o4">hkl</a> : 0,
00900                 pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o4">hkl</a>);
00901         <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a62">gspklBaseLayout</a>, pkl);
00902         <a class="code" href="../../d6/d2/kbdlyout_8c.html#a10">xxxSetPKLinThreads</a>(pkl, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00903     }
00904 
00905     <span class="comment">/*</span>
00906 <span class="comment">     * Use the hkl as the layout handle</span>
00907 <span class="comment">     * If the KL is freed somehow, return NULL for safety. -- ianja --</span>
00908 <span class="comment">     */</span>
00909     pkl = <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpkl);
00910     <span class="keywordflow">if</span> (pkl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00911         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00912     }
00913     <span class="keywordflow">return</span> pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o4">hkl</a>;
00914 }
00915 
<a name="l00916"></a><a class="code" href="../../d4/d1/userk_8h.html#a1303">00916</a> HKL <a class="code" href="../../d4/d1/userk_8h.html#a1303">xxxActivateKeyboardLayout</a>(
00917     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta,
00918     HKL hkl,
00919     UINT Flags,
00920     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
00921 {
00922     <a class="code" href="../../d4/d9/structtagKL.html">PKL</a> pkl;
00923     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlPKL;
00924     HKL hklRet;
00925     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00926 
00927     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00928 
00929     pkl = <a class="code" href="../../d4/d1/userk_8h.html#a1019">HKLtoPKL</a>(ptiCurrent, hkl);
00930     <span class="keywordflow">if</span> (pkl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00931         <span class="keywordflow">return</span> 0;
00932     }
00933 
00934     <span class="keywordflow">if</span> (Flags &amp; KLF_REORDER) {
00935         <a class="code" href="../../d6/d2/kbdlyout_8c.html#a2">ReorderKeyboardLayouts</a>(pwinsta, pkl);
00936     }
00937 
00938     <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pkl, &amp;tlPKL);
00939     hklRet = <a class="code" href="../../d4/d1/userk_8h.html#a1304">xxxInternalActivateKeyboardLayout</a>(pkl, Flags, pwnd);
00940     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlPKL);
00941     <span class="keywordflow">return</span> hklRet;
00942 }
00943 
<a name="l00944"></a><a class="code" href="../../d6/d2/kbdlyout_8c.html#a2">00944</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d6/d2/kbdlyout_8c.html#a2">ReorderKeyboardLayouts</a>(
00945     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta,
00946     <a class="code" href="../../d4/d9/structtagKL.html">PKL</a> pkl)
00947 {
00948     <a class="code" href="../../d4/d9/structtagKL.html">PKL</a> pklFirst = pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o4">spklList</a>;
00949 
00950     <span class="keywordflow">if</span> (pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a316">WSF_NOIO</a>) {
00951         RIPMSG1(RIP_ERROR, <span class="stringliteral">"ReorderKeyboardLayouts called for non-interactive windowstation %#p"</span>,
00952                 pwinsta);
00953         <span class="keywordflow">return</span>;
00954     }
00955 
00956     UserAssert(pklFirst != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00957 
00958     <span class="comment">/*</span>
00959 <span class="comment">     * If the layout is already at the front of the list there's nothing to do.</span>
00960 <span class="comment">     */</span>
00961     <span class="keywordflow">if</span> (pkl == pklFirst) {
00962         <span class="keywordflow">return</span>;
00963     }
00964     <span class="comment">/*</span>
00965 <span class="comment">     * Cut pkl from circular list:</span>
00966 <span class="comment">     */</span>
00967     pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o2">pklPrev</a>-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o1">pklNext</a> = pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o1">pklNext</a>;
00968     pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o1">pklNext</a>-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o2">pklPrev</a> = pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o2">pklPrev</a>;
00969 
00970     <span class="comment">/*</span>
00971 <span class="comment">     * Insert pkl at front of list</span>
00972 <span class="comment">     */</span>
00973     pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o1">pklNext</a> = pklFirst;
00974     pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o2">pklPrev</a> = pklFirst-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o2">pklPrev</a>;
00975 
00976     pklFirst-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o2">pklPrev</a>-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o1">pklNext</a> = pkl;
00977     pklFirst-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o2">pklPrev</a> = pkl;
00978 
00979     <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o4">spklList</a>, pkl);
00980 }
00981 
<a name="l00982"></a><a class="code" href="../../d4/d1/userk_8h.html#a1301">00982</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1301">ChangeForegroundKeyboardTable</a>(<a class="code" href="../../d4/d9/structtagKL.html">PKL</a> pklOld, <a class="code" href="../../d4/d9/structtagKL.html">PKL</a> pklNew)
00983 {
00984     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00985     UserAssert(pklNew != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00986 
00987     <span class="keywordflow">if</span> (pklOld == pklNew || (pklOld != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; pklOld-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o5">spkf</a> == pklNew-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o5">spkf</a>)) {
00988         <span class="keywordflow">return</span>;
00989     }
00990 
00991     <span class="comment">// Manage the VK_KANA toggle key for Japanese KL.</span>
00992     <span class="comment">// Since VK_HANGUL and VK_KANA share the same VK value and</span>
00993     <span class="comment">// VK_KANA is a toggle key, when keyboard layouts are switched,</span>
00994     <span class="comment">// VK_KANA toggle status should be restored.</span>
00995 
00996     <span class="comment">//</span>
00997     <span class="comment">// If:</span>
00998     <span class="comment">// 1) Old and New keyboard layouts are both Japanese, do nothing.</span>
00999     <span class="comment">// 2) Old and New keyboard layouts are not Japanese, do nothing.</span>
01000     <span class="comment">// 3) Old keyboard is Japanese and new one is not, clear the KANA toggle.</span>
01001     <span class="comment">// 4) New keyboard is Japanese and old one is not, restore the KANA toggle.</span>
01002     <span class="comment">//</span>
01003 
01004     <span class="keywordflow">if</span> (pklOld &amp;&amp; JAPANESE_KBD_LAYOUT(pklOld-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o4">hkl</a>)) {
01005         <span class="keywordflow">if</span> (!JAPANESE_KBD_LAYOUT(pklNew-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o4">hkl</a>)) {
01006             <span class="comment">// Old keyboard layout is Japanese and the new one is not Japanese,</span>
01007             <span class="comment">// so we save the current KANA toggle status and clear it.</span>
01008             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a225">gfKanaToggle</a> = (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a846">TestAsyncKeyStateToggle</a>(VK_KANA) != 0);
01009             RIPMSG0(RIP_VERBOSE, <span class="stringliteral">"Old kbd is JPN. VK_KANA toggle is being cleared.\n"</span>);
01010             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a848">ClearAsyncKeyStateToggle</a>(VK_KANA);
01011             <a class="code" href="../../d4/d1/userk_8h.html#a584">ClearRawKeyToggle</a>(VK_KANA);
01012             <a class="code" href="../../d4/d1/userk_8h.html#a1180">UpdateKeyLights</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01013         }
01014     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (JAPANESE_KBD_LAYOUT(pklNew-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o4">hkl</a>)) {
01015         <span class="comment">// Previous keyboard layout does not exist or is not Japanese,</span>
01016         <span class="comment">// and the new one is Japanese.</span>
01017         <span class="comment">// Have to restore the KANA toggle status.</span>
01018         RIPMSG0(RIP_VERBOSE, <span class="stringliteral">"New kbd is JPN. "</span>);
01019         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a225">gfKanaToggle</a>) {
01020             RIPMSG0(RIP_VERBOSE, <span class="stringliteral">"VK_KANA is being set.\n"</span>);
01021             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a847">SetAsyncKeyStateToggle</a>(VK_KANA);
01022             <a class="code" href="../../d4/d1/userk_8h.html#a583">SetRawKeyToggle</a>(VK_KANA);
01023             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a25">gptiForeground</a> &amp;&amp; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a25">gptiForeground</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>) {
01024                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a841">SetKeyStateToggle</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a25">gptiForeground</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, VK_KANA);
01025             }
01026         } <span class="keywordflow">else</span> {
01027             RIPMSG0(RIP_VERBOSE, <span class="stringliteral">"VK_KANA is beging cleared.\n"</span>);
01028             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a848">ClearAsyncKeyStateToggle</a>(VK_KANA);
01029             <a class="code" href="../../d4/d1/userk_8h.html#a584">ClearRawKeyToggle</a>(VK_KANA);
01030             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a25">gptiForeground</a> &amp;&amp; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a25">gptiForeground</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>) {
01031                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a842">ClearKeyStateToggle</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a25">gptiForeground</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, VK_KANA);
01032             }
01033         }
01034         <a class="code" href="../../d4/d1/userk_8h.html#a1180">UpdateKeyLights</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01035     }
01036 
01037     <span class="comment">/*</span>
01038 <span class="comment">     * Set gpKbdTbl so foreground thread processes AltGr appropriately</span>
01039 <span class="comment">     */</span>
01040     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a70">gpKbdTbl</a> = pklNew-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o5">spkf</a>-&gt;<a class="code" href="../../d1/d9/structtagKBDFILE.html#o4">pKbdTbl</a>;
01041     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/inc_2user_8h.html#a882">ISTS</a>()) {
01042         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a355">ghKbdTblBase</a> = pklNew-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o5">spkf</a>-&gt;<a class="code" href="../../d1/d9/structtagKBDFILE.html#o3">hBase</a>;
01043         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a356">guKbdTblSize</a> = pklNew-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o5">spkf</a>-&gt;<a class="code" href="../../d1/d9/structtagKBDFILE.html#o5">Size</a>;
01044     }
01045 
01046     UserAssert(pklNew);
01047     TAGMSG2(DBGTAG_IMM, <span class="stringliteral">"ChangeForegroundKeyboardTable:Changing KL NLS Table: prev HKL=%x to new HKL=%x\n"</span>, pklOld ? pklOld-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o4">hkl</a> : 0, pklNew-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o4">hkl</a>);
01048     TAGMSG1(DBGTAG_IMM, <span class="stringliteral">"ChangeForegroundKeyboardTable: new gpKbdNlsTbl=%x\n"</span>, pklNew-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o5">spkf</a>-&gt;<a class="code" href="../../d1/d9/structtagKBDFILE.html#o6">pKbdNlsTbl</a>);
01049     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a72">gpKbdNlsTbl</a> = pklNew-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o5">spkf</a>-&gt;<a class="code" href="../../d1/d9/structtagKBDFILE.html#o6">pKbdNlsTbl</a>;
01050 }
01051 
01052 
01053 <span class="comment">//</span>
01054 <span class="comment">// Toggle and push state adjusters:</span>
01055 <span class="comment">//</span>
01056 <span class="comment">// ResetPushState, AdjustPushState, AdjustPushStateForKL</span>
01057 <span class="comment">//</span>
01058 
<a name="l01059"></a><a class="code" href="../../d6/d2/kbdlyout_8c.html#a15">01059</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d2/kbdlyout_8c.html#a15">ResetPushState</a>(<a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti, UINT uVk)
01060 {
01061     TAGMSG1(DBGTAG_IMM, <span class="stringliteral">"ResetPushState: has to reset the push state of vk=%x\n"</span>, uVk);
01062     <span class="keywordflow">if</span> (uVk != 0) {
01063         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a845">ClearAsyncKeyStateDown</a>(uVk);
01064         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a845">ClearAsyncKeyStateDown</a>(uVk);
01065         <a class="code" href="../../d4/d1/userk_8h.html#a581">ClearRawKeyDown</a>(uVk);
01066         <a class="code" href="../../d4/d1/userk_8h.html#a584">ClearRawKeyToggle</a>(uVk);
01067         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a839">ClearKeyStateDown</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, uVk);
01068         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a842">ClearKeyStateToggle</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, uVk);
01069     }
01070 }
01071 
01072 <span class="comment">//</span>
01073 <span class="comment">// AdjustPushState:</span>
01074 <span class="comment">//</span>
01075 <span class="comment">//  Left            Right           Clear?</span>
01076 <span class="comment">// Down    Vanish  Down    Vanish</span>
01077 <span class="comment">// (x)     (y)     (z)     (w)     (f)</span>
01078 <span class="comment">//  0       0       0       0       0</span>
01079 <span class="comment">//  0       0       0       1       0</span>
01080 <span class="comment">//  0       0       1       0       0</span>
01081 <span class="comment">//  0       0       1       1       1*</span>
01082 <span class="comment">//</span>
01083 <span class="comment">//  0       1       0       0       0</span>
01084 <span class="comment">//  0       1       0       1       0</span>
01085 <span class="comment">//  0       1       1       0       0</span>
01086 <span class="comment">//  0       1       1       1       1*</span>
01087 <span class="comment">//</span>
01088 <span class="comment">//  1       0       0       0       0</span>
01089 <span class="comment">//  1       0       0       1       0</span>
01090 <span class="comment">//  1       0       1       0       0</span>
01091 <span class="comment">//  1       0       1       1       0</span>
01092 <span class="comment">//</span>
01093 <span class="comment">//  1       1       0       0       1*</span>
01094 <span class="comment">//  1       1       0       1       1*</span>
01095 <span class="comment">//  1       1       1       0       0</span>
01096 <span class="comment">//  1       1       1       1       1*</span>
01097 <span class="comment">//</span>
01098 <span class="comment">// f = ~x~yzw + ~xyzw + xy~z~w + xy~zw + xyzw</span>
01099 <span class="comment">//   = zw~x(y + ~y) + xy~z(~w +w) + xyzw</span>
01100 <span class="comment">//   = zw~x + xy~z + xyzw</span>
01101 <span class="comment">//   = xy~z + ~xzw + xyzw.</span>
01102 <span class="comment">//   = xy(~z + zw) + ~xzw</span>
01103 <span class="comment">//</span>
<a name="l01104"></a><a class="code" href="../../d6/d2/kbdlyout_8c.html#a16">01104</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d2/kbdlyout_8c.html#a16">AdjustPushState</a>(<a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent, BYTE bBaseVk, BYTE bVkL, BYTE bVkR, <a class="code" href="../../d4/d9/structtagKL.html">PKL</a> pklPrev, <a class="code" href="../../d4/d9/structtagKL.html">PKL</a> pklNew)
01105 {
01106     BOOLEAN fDownL = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, fDownR = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01107     BOOLEAN fVanishL = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, fVanishR = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01108 
01109     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uScanCode1, uScanCode2;
01110 
01111     <span class="keywordflow">if</span> (bVkL) {
01112         fDownL = <a class="code" href="../../d4/d1/userk_8h.html#a579">TestRawKeyDown</a>(bVkL) || <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a843">TestAsyncKeyStateDown</a>(bVkL) || <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a837">TestKeyStateDown</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, bVkL);
01113         uScanCode1 = <a class="code" href="../../d3/d1/xlate_8c.html#a4">InternalMapVirtualKeyEx</a>(bVkL, 0, pklPrev-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o5">spkf</a>-&gt;<a class="code" href="../../d1/d9/structtagKBDFILE.html#o4">pKbdTbl</a>);
01114         uScanCode2 = <a class="code" href="../../d3/d1/xlate_8c.html#a4">InternalMapVirtualKeyEx</a>(bVkL, 0, pklNew-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o5">spkf</a>-&gt;<a class="code" href="../../d1/d9/structtagKBDFILE.html#o4">pKbdTbl</a>);
01115         fVanishL = (uScanCode1 &amp;&amp; uScanCode2 == 0);
01116         <span class="keywordflow">if</span> (fVanishL) {
01117             <a class="code" href="../../d6/d2/kbdlyout_8c.html#a15">ResetPushState</a>(ptiCurrent, bVkL);
01118         }
01119     }
01120 
01121     <span class="keywordflow">if</span> (bVkR) {
01122         fDownR = <a class="code" href="../../d4/d1/userk_8h.html#a579">TestRawKeyDown</a>(bVkR) || <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a843">TestAsyncKeyStateDown</a>(bVkR) || <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a837">TestKeyStateDown</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, bVkR);
01123         uScanCode1 = <a class="code" href="../../d3/d1/xlate_8c.html#a4">InternalMapVirtualKeyEx</a>(bVkR, 0, pklPrev-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o5">spkf</a>-&gt;<a class="code" href="../../d1/d9/structtagKBDFILE.html#o4">pKbdTbl</a>);
01124         uScanCode2 = <a class="code" href="../../d3/d1/xlate_8c.html#a4">InternalMapVirtualKeyEx</a>(bVkR, 0, pklNew-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o5">spkf</a>-&gt;<a class="code" href="../../d1/d9/structtagKBDFILE.html#o4">pKbdTbl</a>);
01125         fVanishR = (uScanCode1 &amp;&amp; uScanCode2 == 0);
01126         <span class="keywordflow">if</span> (fVanishR) {
01127             <a class="code" href="../../d6/d2/kbdlyout_8c.html#a15">ResetPushState</a>(ptiCurrent, bVkR);
01128         }
01129     }
01130 
01131     <span class="keywordflow">if</span> (bBaseVk) {
01132         TAGMSG4(DBGTAG_IMM, <span class="stringliteral">"fDL(%d) fVL(%d) fDR(%d) fVR(%d)\n"</span>, fDownL, fVanishL, fDownR, fVanishR);
01133         <span class="keywordflow">if</span> (((fDownL &amp; fVanishL &amp; ((BOOLEAN)~fDownR | (fDownR &amp; fVanishR))) | ((BOOLEAN)~fDownL &amp; fDownR &amp; fVanishR)) &amp; 1) {
01134             TAGMSG1(DBGTAG_IMM, <span class="stringliteral">"AdjustPushState(): Going to reset %x\n"</span>, bBaseVk);
01135             <a class="code" href="../../d6/d2/kbdlyout_8c.html#a15">ResetPushState</a>(ptiCurrent, bBaseVk);
01136         }
01137     }
01138 }
01139 
<a name="l01140"></a><a class="code" href="../../d6/d2/kbdlyout_8c.html#a17">01140</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d6/d2/kbdlyout_8c.html#a17">AdjustPushStateForKL</a>(<a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent, PBYTE pbDone, <a class="code" href="../../d4/d9/structtagKL.html">PKL</a> pklTarget, <a class="code" href="../../d4/d9/structtagKL.html">PKL</a> pklPrev, <a class="code" href="../../d4/d9/structtagKL.html">PKL</a> pklNew)
01141 {
01142     CONST VK_TO_BIT* pVkToBits;
01143 
01144     UserAssert(pklPrev);
01145     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pklPrev);
01146     UserAssert(pklNew);
01147     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pklNew);
01148 
01149     <span class="keywordflow">if</span> (pklTarget-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o5">spkf</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || pklPrev-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o5">spkf</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01150         <span class="keywordflow">return</span>;
01151     }
01152 
01153     pVkToBits = pklTarget-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o5">spkf</a>-&gt;<a class="code" href="../../d1/d9/structtagKBDFILE.html#o4">pKbdTbl</a>-&gt;pCharModifiers-&gt;pVkToBit;
01154 
01155     <span class="keywordflow">for</span> (; pVkToBits-&gt;Vk; ++pVkToBits) {
01156         <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> bVkVar1 = 0, bVkVar2 = 0;
01157 
01158         <span class="comment">//</span>
01159         <span class="comment">// Is it already processed ?</span>
01160         <span class="comment">//</span>
01161         UserAssert(pVkToBits-&gt;Vk &lt; 0x100);
01162         <span class="keywordflow">if</span> (pbDone[pVkToBits-&gt;Vk &gt;&gt; 3] &amp; (1 &lt;&lt; (pVkToBits-&gt;Vk &amp; 7))) {
01163             <span class="keywordflow">continue</span>;
01164         }
01165 
01166         <span class="keywordflow">switch</span> (pVkToBits-&gt;Vk) {
01167         <span class="keywordflow">case</span> VK_SHIFT:
01168             bVkVar1 = VK_LSHIFT;
01169             bVkVar2 = VK_RSHIFT;
01170             <span class="keywordflow">break</span>;
01171         <span class="keywordflow">case</span> VK_CONTROL:
01172             bVkVar1 = VK_LCONTROL;
01173             bVkVar2 = VK_RCONTROL;
01174             <span class="keywordflow">break</span>;
01175         <span class="keywordflow">case</span> VK_MENU:
01176             bVkVar1 = VK_LMENU;
01177             bVkVar2 = VK_RMENU;
01178             <span class="keywordflow">break</span>;
01179         }
01180 
01181         TAGMSG3(DBGTAG_IMM, <span class="stringliteral">"Adjusting VK=%x var1=%x var2=%x\n"</span>, pVkToBits-&gt;Vk, bVkVar1, bVkVar2);
01182 
01183         <a class="code" href="../../d6/d2/kbdlyout_8c.html#a16">AdjustPushState</a>(ptiCurrent, pVkToBits-&gt;Vk, bVkVar1, bVkVar2, pklPrev, pklNew);
01184 
01185         pbDone[pVkToBits-&gt;Vk &gt;&gt; 3] |= (1 &lt;&lt; (pVkToBits-&gt;Vk &amp; 7));
01186     }
01187 }
01188 
01189 <span class="comment">/*****************************************************************************\</span>
01190 <span class="comment">* xxxInternalActivateKeyboardLayout</span>
01191 <span class="comment">*</span>
01192 <span class="comment">* pkl   - pointer to keyboard layout to switch the current thread to</span>
01193 <span class="comment">* Flags - KLF_RESET</span>
01194 <span class="comment">*         KLF_SETFORPROCESS</span>
01195 <span class="comment">*         KLLF_SHIFTLOCK (any of KLLF_GLOBAL_ATTRS)</span>
01196 <span class="comment">*         others are ignored</span>
01197 <span class="comment">* pwnd  - If the current thread has no focus or active window, send the</span>
01198 <span class="comment">*         WM_INPUTLANGCHANGE message to this window (unless it is NULL too)</span>
01199 <span class="comment">*</span>
01200 <span class="comment">* History:</span>
01201 <span class="comment">* 1998-10-14 IanJa    Added pwnd parameter</span>
01202 <span class="comment">\*****************************************************************************/</span>
<a name="l01203"></a><a class="code" href="../../d4/d1/userk_8h.html#a1304">01203</a> HKL <a class="code" href="../../d4/d1/userk_8h.html#a1304">xxxInternalActivateKeyboardLayout</a>(
01204     <a class="code" href="../../d4/d9/structtagKL.html">PKL</a> pkl,
01205     UINT Flags,
01206     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
01207 {
01208     HKL hklPrev;
01209     <a class="code" href="../../d4/d9/structtagKL.html">PKL</a> pklPrev;
01210     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>  tlpklPrev;
01211     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
01212 
01213     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pkl);
01214     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
01215 
01216     <span class="comment">/*</span>
01217 <span class="comment">     * Remember what is about to become the "previously" active hkl</span>
01218 <span class="comment">     * for the return value.</span>
01219 <span class="comment">     */</span>
01220     <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o4">spklActive</a> != (<a class="code" href="../../d4/d9/structtagKL.html">PKL</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01221         pklPrev = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o4">spklActive</a>;
01222         hklPrev = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o4">spklActive</a>-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o4">hkl</a>;
01223     } <span class="keywordflow">else</span> {
01224         pklPrev = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01225         hklPrev = (HKL)0;
01226     }
01227 
01228     <span class="comment">/*</span>
01229 <span class="comment">     * ShiftLock/CapsLock is a global feature applying to all layouts</span>
01230 <span class="comment">     * Only Winlogon and the Input Locales cpanel applet set KLF_RESET.</span>
01231 <span class="comment">     */</span>
01232     <span class="keywordflow">if</span> (Flags &amp; KLF_RESET) {
01233         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a73">gdwKeyboardAttributes</a> = KLL_GLOBAL_ATTR_FROM_KLF(Flags);
01234     }
01235 
01236     <span class="comment">/*</span>
01237 <span class="comment">     * Early out</span>
01238 <span class="comment">     */</span>
01239     <span class="keywordflow">if</span> (!(Flags &amp; KLF_SETFORPROCESS) &amp;&amp; (pkl == ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o4">spklActive</a>)) {
01240         <span class="keywordflow">return</span> hklPrev;
01241     }
01242 
01243     <span class="comment">/*</span>
01244 <span class="comment">     * Clear out diacritics when switching kbd layouts #102838</span>
01245 <span class="comment">     */</span>
01246     pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o9">wchDiacritic</a> = 0;
01247 
01248     <span class="comment">/*</span>
01249 <span class="comment">     * Update the active layout in the pti.  KLF_SETFORPROCESS will always be set</span>
01250 <span class="comment">     * when the keyboard layout switch is initiated by the keyboard hotkey.</span>
01251 <span class="comment">     */</span>
01252 
01253     <span class="comment">/*</span>
01254 <span class="comment">     * Lock the previous keyboard layout for it's used later.</span>
01255 <span class="comment">     */</span>
01256     <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(ptiCurrent, pklPrev, &amp;tlpklPrev);
01257 
01258     <span class="comment">/*</span>
01259 <span class="comment">     * Is this is a console thread, apply this change to any process in it's</span>
01260 <span class="comment">     * window.  This can really help character-mode apps!  (#58025)</span>
01261 <span class="comment">     */</span>
01262     <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a798">TIF_CSRSSTHREAD</a>) {
01263         <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o4">spklActive</a>, pkl);
01264         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o20">CodePage</a> = pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o8">CodePage</a>;
01265 <span class="preprocessor">#if 0   // see Raid #58025 and #78586</span>
01266 <span class="preprocessor"></span>        ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o21">hKL</a> = pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o4">hkl</a>;
01267         PLIST_ENTRY pHead;
01268         PLIST_ENTRY pEntry;
01269         <a class="code" href="../../d7/d4/structtagQ.html">PQ</a> pqCurrent = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>;
01270         <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiT;
01271 
01272         pHead = &amp;(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o20">PtiList</a>);
01273         <span class="keywordflow">for</span> (pEntry = pHead-&gt;Flink; pEntry != pHead; pEntry = pEntry-&gt;Flink) {
01274             ptiT = CONTAINING_RECORD(pEntry, <a class="code" href="../../d2/d8/structtagTHREADINFO.html">THREADINFO</a>, PtiLink);
01275             <span class="keywordflow">if</span> (ptiT-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a> == pqCurrent) {
01276                 <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;ptiT-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o4">spklActive</a>, pkl);
01277                 UserAssert(ptiT-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01278                 ptiT-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o20">CodePage</a> = pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o8">CodePage</a>;
01279                 ptiT-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o21">hKL</a> = pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o4">hkl</a>;
01280             }
01281         }
01282 <span class="preprocessor">#endif</span>
01283 <span class="preprocessor"></span>    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((Flags &amp; KLF_SETFORPROCESS) &amp;&amp; !(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>)) {
01284         <span class="comment">/*</span>
01285 <span class="comment">         * For 16 bit app., only the calling thread will have its active layout updated.</span>
01286 <span class="comment">         */</span>
01287        <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiT;
01288 
01289        <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a126">IS_IME_ENABLED</a>()) {
01290            <span class="comment">/*</span>
01291 <span class="comment">            * Only allow *NOT* CSRSS to make this call</span>
01292 <span class="comment">            */</span>
01293            UserAssert(<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a299">gpepCSRSS</a>);
01294            <span class="comment">// pti-&gt;pClientInfo is updated in xxxImmActivateThreadsLayout()</span>
01295            <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a2039">xxxImmActivateThreadsLayout</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o1">ptiList</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, pkl)) {
01296                RIPMSG1(RIP_WARNING, <span class="stringliteral">"no layout change necessary via xxxImmActivateThreadLayout() for process %lx"</span>, ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>);
01297                <span class="keywordflow">goto</span> UnlockAndGo;
01298            }
01299        } <span class="keywordflow">else</span> {
01300            <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fKLChanged = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01301 
01302            <span class="keywordflow">for</span> (ptiT = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o1">ptiList</a>; ptiT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; ptiT = ptiT-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o29">ptiSibling</a>) {
01303                <span class="keywordflow">if</span> (ptiT-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o4">spklActive</a> != pkl &amp;&amp; (ptiT-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a795">TIF_INCLEANUP</a>) == 0) {
01304                    <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;ptiT-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o4">spklActive</a>, pkl);
01305                    UserAssert(ptiT-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01306                    ptiT-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o20">CodePage</a> = pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o8">CodePage</a>;
01307                    ptiT-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o21">hKL</a> = pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o4">hkl</a>;
01308                    fKLChanged = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01309                }
01310            }
01311            <span class="keywordflow">if</span> (!fKLChanged) {
01312               RIPMSG1(RIP_WARNING, <span class="stringliteral">"no layout change necessary for process %lx ?"</span>, ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>);
01313               <span class="keywordflow">goto</span> UnlockAndGo;
01314            }
01315        }
01316 
01317     } <span class="keywordflow">else</span> {
01318         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a126">IS_IME_ENABLED</a>()) {
01319             <a class="code" href="../../d4/d1/userk_8h.html#a2041">xxxImmActivateLayout</a>(ptiCurrent, pkl);
01320         } <span class="keywordflow">else</span> {
01321             <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o4">spklActive</a>, pkl);
01322         }
01323         UserAssert(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01324         <span class="keywordflow">if</span> ((ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a795">TIF_INCLEANUP</a>) == 0) {
01325             ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o20">CodePage</a> = pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o8">CodePage</a>;
01326             ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o21">hKL</a> = pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o4">hkl</a>;
01327         }
01328     }
01329 
01330     <span class="comment">/*</span>
01331 <span class="comment">     * Some keys (pressed to switch layout) may still be down.  When these come</span>
01332 <span class="comment">     * back up, they may have different VK values due to the new layout, so the</span>
01333 <span class="comment">     * original key will be left stuck down. (eg: an ISV layout from Attachmate</span>
01334 <span class="comment">     * and the CAN/CSA layout, both of which redefine the right-hand Ctrl key's</span>
01335 <span class="comment">     * VK so switching to that layout with right Ctrl+Shift will leave the Ctrl</span>
01336 <span class="comment">     * stuck down).</span>
01337 <span class="comment">     * The solution is to clear all the keydown bits whenever we switch layouts</span>
01338 <span class="comment">     * (leaving the toggle bits alone to preserve CapsLock, NumLock etc.). This</span>
01339 <span class="comment">     * also solves the AltGr problem, where the simulated Ctrl key doesn't come</span>
01340 <span class="comment">     * back up if we switch to a non-AltGr layout before releasing AltGr - IanJa</span>
01341 <span class="comment">     *</span>
01342 <span class="comment">     * Clear down bits only if necessary --- i.e. if the VK value differs between</span>
01343 <span class="comment">     * old and new keyboard layout. We have to take complex path for some of the</span>
01344 <span class="comment">     * keys, like Ctrl or Alt, may have left and right equivalents. - HiroYama</span>
01345 <span class="comment">     */</span>
01346     <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>) {
01347         <span class="keywordflow">if</span> (pklPrev) {
01348             <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> baDone[256 / 8];
01349 
01350             RtlZeroMemory(baDone, <span class="keyword">sizeof</span> baDone);
01351 
01352             <span class="comment">/*</span>
01353 <span class="comment">             * Clear the toggle state if needed. First check the modifier keys</span>
01354 <span class="comment">             * of pklPrev. Next check the modifier keys of pklNew.</span>
01355 <span class="comment">             */</span>
01356             TAGMSG2(DBGTAG_IMM, <span class="stringliteral">"Changing KL from %08lx to %08lx"</span>, pklPrev-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o4">hkl</a>, pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o4">hkl</a>);
01357             <a class="code" href="../../d6/d2/kbdlyout_8c.html#a17">AdjustPushStateForKL</a>(ptiCurrent, baDone, pklPrev, pklPrev, pkl);
01358             <a class="code" href="../../d6/d2/kbdlyout_8c.html#a17">AdjustPushStateForKL</a>(ptiCurrent, baDone, pkl, pklPrev, pkl);
01359 
01360             <span class="keywordflow">if</span> (pklPrev-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o5">spkf</a> &amp;&amp; (pklPrev-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o5">spkf</a>-&gt;<a class="code" href="../../d1/d9/structtagKBDFILE.html#o4">pKbdTbl</a>-&gt;fLocaleFlags &amp; KLLF_ALTGR)) {
01361                 <span class="comment">/*</span>
01362 <span class="comment">                 * If the previous keyboard has AltGr, clear the left control anyway.</span>
01363 <span class="comment">                 * See xxxAltGr().</span>
01364 <span class="comment">                 */</span>
01365                 TAGMSG0(DBGTAG_IMM, <span class="stringliteral">"Clearing VK_LCONTROL for AltGr\n"</span>);
01366                 <a class="code" href="../../d6/d2/kbdlyout_8c.html#a15">ResetPushState</a>(ptiCurrent, VK_LCONTROL);
01367             }
01368         }
01369         <span class="keywordflow">else</span> {
01370             <span class="comment">/*</span>
01371 <span class="comment">             * If the current keyboard is unkown, clear all the push state.</span>
01372 <span class="comment">             */</span>
01373             <span class="keywordtype">int</span> i;
01374             <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a825">CBKEYSTATE</a>; i++) {
01375                 ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o17">afKeyState</a>[i] &amp;= KEYSTATE_TOGGLE_BYTEMASK;
01376                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a222">gafAsyncKeyState</a>[i] &amp;= KEYSTATE_TOGGLE_BYTEMASK;
01377                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a224">gafRawKeyState</a>[i] &amp;= KEYSTATE_TOGGLE_BYTEMASK;
01378             }
01379         }
01380     }
01381 
01382     <span class="comment">/*</span>
01383 <span class="comment">     * Call the Shell hook with the new language.</span>
01384 <span class="comment">     */</span>
01385     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a25">gptiForeground</a> &amp;&amp; (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a25">gptiForeground</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a> == ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>)) {
01386         <a class="code" href="../../d4/d1/userk_8h.html#a1301">ChangeForegroundKeyboardTable</a>(pklPrev, pkl);
01387 
01388         <span class="comment">/*</span>
01389 <span class="comment">         * Only call the hook if we are the foreground process, to prevent</span>
01390 <span class="comment">         * background apps from changing the indicator.  (All console apps</span>
01391 <span class="comment">         * are part of the same process, but I have never seen a cmd window</span>
01392 <span class="comment">         * app change the layout, let alone in the background)</span>
01393 <span class="comment">         */</span>
01394         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a63">gLCIDSentToShell</a> != pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o4">hkl</a> &amp;&amp; (ptiCurrent != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a175">gptiRit</a>)) {
01395            <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a208">IsHooked</a>(ptiCurrent, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a523">WHF_SHELL</a>)) {
01396                <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a63">gLCIDSentToShell</a> = pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o4">hkl</a>;
01397                <a class="code" href="../../d4/d1/userk_8h.html#a1521">xxxCallHook</a>(HSHELL_LANGUAGE, (WPARAM)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, (LPARAM)pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o4">hkl</a>, WH_SHELL);
01398            }
01399         }
01400     }
01401 
01402     <span class="comment">/*</span>
01403 <span class="comment">     * Tell the app what happened</span>
01404 <span class="comment">     */</span>
01405     <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>) {
01406         <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndT;
01407         <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndT;
01408 
01409         <span class="comment">/*</span>
01410 <span class="comment">         * If we have no Focus window, use the Active window.</span>
01411 <span class="comment">         * eg: Console full-screen has NULL focus window.</span>
01412 <span class="comment">         */</span>
01413         pwndT = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o7">spwndFocus</a>;
01414         <span class="keywordflow">if</span> (pwndT == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01415             pwndT = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>;
01416             <span class="keywordflow">if</span> (pwndT == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01417                 pwndT = pwnd;
01418             }
01419         }
01420 
01421         <span class="keywordflow">if</span> (pwndT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01422             <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>( ptiCurrent, pwndT, &amp;tlpwndT);
01423             <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwndT, WM_INPUTLANGCHANGE, (WPARAM)pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o7">iBaseCharset</a>, (LPARAM)pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o4">hkl</a>);
01424             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT);
01425         }
01426     }
01427 
01428     <span class="comment">/*</span>
01429 <span class="comment">     * Tell IME to send mode update notification</span>
01430 <span class="comment">     */</span>
01431     <span class="keywordflow">if</span> (ptiCurrent &amp;&amp; ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o39">spwndDefaultIme</a> &amp;&amp;
01432             (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a798">TIF_CSRSSTHREAD</a>) == 0) {
01433         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d5/conimep_8h.html#a49">IS_IME_KBDLAYOUT</a>(pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o4">hkl</a>)) {
01434             <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fForProcess = (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; KLF_SETFORPROCESS) &amp;&amp; !(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>);
01435             <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndIme;
01436 
01437             TAGMSG1(DBGTAG_IMM, <span class="stringliteral">"Sending IMS_SENDNOTIFICATION to pwnd=%p"</span>, ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o39">spwndDefaultIme</a>);
01438 
01439             <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o39">spwndDefaultIme</a>, &amp;tlpwndIme);
01440             <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o39">spwndDefaultIme</a>, WM_IME_SYSTEM, IMS_SENDNOTIFICATION, fForProcess);
01441             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndIme);
01442         }
01443     }
01444 
01445 UnlockAndGo:
01446     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpklPrev);
01447 
01448     <span class="keywordflow">return</span> hklPrev;
01449 }
01450 
<a name="l01451"></a><a class="code" href="../../d4/d1/userk_8h.html#a1306">01451</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1306">xxxUnloadKeyboardLayout</a>(
01452     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta,
01453     HKL hkl)
01454 {
01455     <a class="code" href="../../d4/d9/structtagKL.html">PKL</a> pkl;
01456 
01457     <span class="comment">/*</span>
01458 <span class="comment">     * Validate HKL and check to make sure an app isn't attempting to unload a system</span>
01459 <span class="comment">     * preloaded layout.</span>
01460 <span class="comment">     */</span>
01461     pkl = <a class="code" href="../../d4/d1/userk_8h.html#a1019">HKLtoPKL</a>(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>(), hkl);
01462     <span class="keywordflow">if</span> (pkl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01463         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01464     }
01465 
01466     <span class="keywordflow">return</span> <a class="code" href="../../d6/d2/kbdlyout_8c.html#a1">xxxInternalUnloadKeyboardLayout</a>(pwinsta, pkl, 0);
01467 }
01468 
<a name="l01469"></a><a class="code" href="../../d4/d1/userk_8h.html#a1308">01469</a> HKL <a class="code" href="../../d4/d1/userk_8h.html#a1308">_GetKeyboardLayout</a>(
01470     DWORD idThread)
01471 {
01472     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiT;
01473     PLIST_ENTRY pHead, pEntry;
01474 
01475     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
01476 
01477     <span class="comment">/*</span>
01478 <span class="comment">     * If idThread is NULL return hkl of the current thread</span>
01479 <span class="comment">     */</span>
01480     <span class="keywordflow">if</span> (idThread == 0) {
01481         <a class="code" href="../../d4/d9/structtagKL.html">PKL</a> pklActive = <a class="code" href="../../d4/d1/userk_8h.html#a10">PtiCurrentShared</a>()-&gt;spklActive;
01482 
01483         <span class="keywordflow">if</span> (pklActive == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01484             <span class="keywordflow">return</span> (HKL)0;
01485         }
01486         <span class="keywordflow">return</span> pklActive-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o4">hkl</a>;
01487     }
01488     <span class="comment">/*</span>
01489 <span class="comment">     * Look for idThread</span>
01490 <span class="comment">     */</span>
01491     pHead = &amp;<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;rpdesk-&gt;PtiList;
01492     <span class="keywordflow">for</span> (pEntry = pHead-&gt;Flink; pEntry != pHead; pEntry = pEntry-&gt;Flink) {
01493         ptiT = CONTAINING_RECORD(pEntry, <a class="code" href="../../d2/d8/structtagTHREADINFO.html">THREADINFO</a>, PtiLink);
01494         <span class="keywordflow">if</span> (ptiT-&gt;pEThread-&gt;Cid.UniqueThread == (HANDLE)LongToHandle( idThread )) {
01495             <span class="keywordflow">if</span> (ptiT-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o4">spklActive</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01496                 <span class="keywordflow">return</span> (HKL)0;
01497             }
01498             <span class="keywordflow">return</span> ptiT-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o4">spklActive</a>-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o4">hkl</a>;
01499         }
01500     }
01501     <span class="comment">/*</span>
01502 <span class="comment">     * idThread doesn't exist</span>
01503 <span class="comment">     */</span>
01504     <span class="keywordflow">return</span> (HKL)0;
01505 }
01506 
<a name="l01507"></a><a class="code" href="../../d4/d1/userk_8h.html#a1309">01507</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d4/d1/userk_8h.html#a1309">_GetKeyboardLayoutList</a>(
01508     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta,
01509     UINT nItems,
01510     HKL *ccxlpBuff)
01511 {
01512     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> nHKL = 0;
01513     <a class="code" href="../../d4/d9/structtagKL.html">PKL</a> pkl, pklFirst;
01514 
01515     <span class="keywordflow">if</span> (!pwinsta) {
01516         <span class="keywordflow">return</span> 0;
01517     }
01518 
01519     pkl = pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o4">spklList</a>;
01520 
01521     <span class="comment">/*</span>
01522 <span class="comment">     * Windowstations that do not take input could have no layouts</span>
01523 <span class="comment">     */</span>
01524     <span class="keywordflow">if</span> (pkl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01525         <span class="comment">// SetLastError() ????</span>
01526         <span class="keywordflow">return</span> 0;
01527     }
01528 
01529     <span class="comment">/*</span>
01530 <span class="comment">     * The client/server thunk sets nItems to 0 if ccxlpBuff == NULL</span>
01531 <span class="comment">     */</span>
01532     UserAssert(ccxlpBuff || (nItems == 0));
01533 
01534     pklFirst = pkl;
01535     <span class="keywordflow">if</span> (nItems) {
01536         <span class="keywordflow">try</span> {
01537             <span class="keywordflow">do</span> {
01538                <span class="keywordflow">if</span> (!(pkl-&gt;dwKL_Flags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a276">KL_UNLOADED</a>)) {
01539                    <span class="keywordflow">if</span> (nItems-- == 0) {
01540                        <span class="keywordflow">break</span>;
01541                    }
01542                    nHKL++;
01543                    *ccxlpBuff++ = pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o4">hkl</a>;
01544                }
01545                pkl = pkl-&gt;pklNext;
01546             } <span class="keywordflow">while</span> (pkl != pklFirst);
01547         } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
01548             RIPERR1(ERROR_INVALID_PARAMETER, RIP_ERROR,
01549                     <span class="stringliteral">"_GetKeyBoardLayoutList: exception writing ccxlpBuff %lx"</span>, ccxlpBuff);
01550             <span class="keywordflow">return</span> 0;
01551         }
01552     } <span class="keywordflow">else</span> <span class="keywordflow">do</span> {
01553         <span class="keywordflow">if</span> (!(pkl-&gt;dwKL_Flags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a276">KL_UNLOADED</a>)) {
01554             nHKL++;
01555         }
01556         pkl = pkl-&gt;pklNext;
01557     } <span class="keywordflow">while</span> (pkl != pklFirst);
01558 
01559     <span class="keywordflow">return</span> nHKL;
01560 }
01561 
01562 <span class="comment">/*</span>
01563 <span class="comment"> * Layouts are locked by each thread using them and possibly by:</span>
01564 <span class="comment"> *    - pwinsta-&gt;spklList (head of windowstation's list)</span>
01565 <span class="comment"> *    - gspklBaseLayout   (default layout for new threads)</span>
01566 <span class="comment"> * The layout is marked for destruction when gets unloaded, so that it will be</span>
01567 <span class="comment"> * unlinked and freed as soon as an Unlock causes the lock count to go to 0.</span>
01568 <span class="comment"> * If it is reloaded before that time, it is unmarked for destruction. This</span>
01569 <span class="comment"> * ensures that laoded layouts stay around even when they go out of use.</span>
01570 <span class="comment"> */</span>
<a name="l01571"></a><a class="code" href="../../d6/d2/kbdlyout_8c.html#a1">01571</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d2/kbdlyout_8c.html#a1">xxxInternalUnloadKeyboardLayout</a>(
01572     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta,
01573     <a class="code" href="../../d4/d9/structtagKL.html">PKL</a> pkl,
01574     UINT Flags)
01575 {
01576     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
01577     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpkl;
01578 
01579     UserAssert(pkl);
01580 
01581     <span class="comment">/*</span>
01582 <span class="comment">     * Never unload the default layout, unless we are destroying the current</span>
01583 <span class="comment">     * windowstation or replacing one user's layouts with another's.</span>
01584 <span class="comment">     */</span>
01585     <span class="keywordflow">if</span> ((pkl == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a62">gspklBaseLayout</a>) &amp;&amp; !(Flags &amp; KLF_INITTIME)) {
01586         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01587     }
01588 
01589     <span class="comment">/*</span>
01590 <span class="comment">     * Keeps pkl good, but also allows destruction when unlocked later</span>
01591 <span class="comment">     */</span>
01592     <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pkl, &amp;tlpkl);
01593 
01594     <span class="comment">/*</span>
01595 <span class="comment">     * Mark it for destruction so it gets removed when the lock count reaches 0</span>
01596 <span class="comment">     * Mark it KL_UNLOADED so that it appears to be gone from the toggle list</span>
01597 <span class="comment">     */</span>
01598     <a class="code" href="../../d4/d1/userk_8h.html#a971">HMMarkObjectDestroy</a>(pkl);
01599     pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o3">dwKL_Flags</a> |= <a class="code" href="../../d4/d1/userk_8h.html#a276">KL_UNLOADED</a>;
01600 
01601     <span class="comment">/*</span>
01602 <span class="comment">     * If unloading this thread's active layout, helpfully activate the next one</span>
01603 <span class="comment">     * (Don't bother if KLF_INITTIME - unloading all previous user's layouts)</span>
01604 <span class="comment">     */</span>
01605     <span class="keywordflow">if</span> (!(Flags &amp; KLF_INITTIME)) {
01606         UserAssert(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o4">spklActive</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01607         <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o4">spklActive</a> == pkl) {
01608             <a class="code" href="../../d4/d9/structtagKL.html">PKL</a> pklNext;
01609             pklNext = <a class="code" href="../../d4/d1/userk_8h.html#a1019">HKLtoPKL</a>(ptiCurrent, (HKL)HKL_NEXT);
01610             <span class="keywordflow">if</span> (pklNext != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01611                 <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlPKL;
01612                 <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pklNext, &amp;tlPKL);
01613                 <a class="code" href="../../d4/d1/userk_8h.html#a1304">xxxInternalActivateKeyboardLayout</a>(pklNext, Flags, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01614                 <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlPKL);
01615             }
01616         }
01617     }
01618 
01619     <span class="comment">/*</span>
01620 <span class="comment">     * If this pkl == pwinsta-&gt;spklList, give it a chance to be destroyed by</span>
01621 <span class="comment">     * unlocking it from pwinsta-&gt;spklList.</span>
01622 <span class="comment">     */</span>
01623     <span class="keywordflow">if</span> (pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o4">spklList</a> == pkl) {
01624         UserAssert(pkl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01625         <span class="keywordflow">if</span> (pkl != pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o1">pklNext</a>) {
01626             pkl = <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o4">spklList</a>, pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o1">pklNext</a>);
01627             UserAssert(pkl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>); <span class="comment">// gspklBaseLayout and ThreadLocked pkl</span>
01628         }
01629     }
01630 
01631     <span class="comment">/*</span>
01632 <span class="comment">     * This finally destroys the unloaded layout if it is not in use anywhere</span>
01633 <span class="comment">     */</span>
01634     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpkl);
01635 
01636     <span class="comment">/*</span>
01637 <span class="comment">     * Update keyboard list.</span>
01638 <span class="comment">     */</span>
01639     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a208">IsHooked</a>(ptiCurrent, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a523">WHF_SHELL</a>)) {
01640         <a class="code" href="../../d4/d1/userk_8h.html#a1521">xxxCallHook</a>(HSHELL_LANGUAGE, (WPARAM)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, (LPARAM)0, WH_SHELL);
01641         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a63">gLCIDSentToShell</a> = 0;
01642     }
01643 
01644     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01645 }
01646 
<a name="l01647"></a><a class="code" href="../../d4/d1/userk_8h.html#a1310">01647</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1310">xxxFreeKeyboardLayouts</a>(
01648     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a> pwinsta, BOOL bUnlock)
01649 {
01650     <a class="code" href="../../d4/d9/structtagKL.html">PKL</a> pkl;
01651 
01652     <span class="comment">/*</span>
01653 <span class="comment">     * Unload all of the windowstation's layouts.</span>
01654 <span class="comment">     * They may still be locked by some threads (eg: console), so this</span>
01655 <span class="comment">     * may not destroy them all, but it will mark them all KL_UNLOADED.</span>
01656 <span class="comment">     * Set KLF_INITTIME to ensure that the default layout (gspklBaseLayout)</span>
01657 <span class="comment">     * gets unloaded too.</span>
01658 <span class="comment">     * Note: it's much faster to unload non-active layouts, so start with</span>
01659 <span class="comment">     * the next loaded layout, leaving the active layout till last.</span>
01660 <span class="comment">     */</span>
01661     <span class="keywordflow">while</span> ((pkl = <a class="code" href="../../d4/d1/userk_8h.html#a1019">HKLtoPKL</a>(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>(), (HKL)HKL_NEXT)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01662         <a class="code" href="../../d6/d2/kbdlyout_8c.html#a1">xxxInternalUnloadKeyboardLayout</a>(pwinsta, pkl, KLF_INITTIME);
01663     }
01664 
01665     <span class="comment">/*</span>
01666 <span class="comment">     * The WindowStation is being destroyed, or one user's layouts are being</span>
01667 <span class="comment">     * replaced by another user's, so it's OK to Unlock spklList.</span>
01668 <span class="comment">     * Any layout still in the double-linked circular KL list will still be</span>
01669 <span class="comment">     * pointed to by gspklBaseLayout: this is important, since we don't want</span>
01670 <span class="comment">     * to leak any KL or KBDFILE objects by losing pointers to them.</span>
01671 <span class="comment">     * There are no layouts when we first come here (during bootup).</span>
01672 <span class="comment">     */</span>
01673     <span class="keywordflow">if</span> (bUnlock) {
01674         <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o4">spklList</a>);
01675     }
01676 }
01677 
01678 <span class="comment">/***************************************************************************\</span>
01679 <span class="comment">* DestroyKL</span>
01680 <span class="comment">*</span>
01681 <span class="comment">* Destroys a keyboard layout. Note that this function does not</span>
01682 <span class="comment">* follow normal destroy function semantics. See IanJa.</span>
01683 <span class="comment">*</span>
01684 <span class="comment">* History:</span>
01685 <span class="comment">* 25-Feb-1997 adams     Created.</span>
01686 <span class="comment">\***************************************************************************/</span>
01687 
<a name="l01688"></a><a class="code" href="../../d4/d1/userk_8h.html#a1184">01688</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1184">DestroyKL</a>(
01689     <a class="code" href="../../d4/d9/structtagKL.html">PKL</a> pkl)
01690 {
01691     <a class="code" href="../../d1/d9/structtagKBDFILE.html">PKBDFILE</a> pkf;
01692 
01693     <span class="comment">/*</span>
01694 <span class="comment">     * Cut it out of the pwinsta-&gt;spklList circular bidirectional list.</span>
01695 <span class="comment">     * We know pwinsta-&gt;spklList != pkl, since pkl is unlocked.</span>
01696 <span class="comment">     */</span>
01697     pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o2">pklPrev</a>-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o1">pklNext</a> = pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o1">pklNext</a>;
01698     pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o1">pklNext</a>-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o2">pklPrev</a> = pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o2">pklPrev</a>;
01699 
01700     <span class="comment">/*</span>
01701 <span class="comment">     * Unlock its pkf</span>
01702 <span class="comment">     */</span>
01703     pkf = <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o5">spkf</a>);
01704     <span class="keywordflow">if</span> (pkf) {
01705         <a class="code" href="../../d4/d1/userk_8h.html#a1183">DestroyKF</a>(pkf);
01706     }
01707 
01708     <span class="keywordflow">if</span> (pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o10">piiex</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01709         UserFreePool(pkl-&gt;<a class="code" href="../../d4/d9/structtagKL.html#o10">piiex</a>);
01710     }
01711 
01712     <span class="comment">/*</span>
01713 <span class="comment">     * Free the pkl itself.</span>
01714 <span class="comment">     */</span>
01715     <a class="code" href="../../d4/d1/userk_8h.html#a970">HMFreeObject</a>(pkl);
01716 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:33 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
