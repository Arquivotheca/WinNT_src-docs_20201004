<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: hwprofil.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>hwprofil.c</h1><a href="../../d6/d2/hwprofil_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1998  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    hwprofil.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains support for changing the Hardware profile</span>
00012 <span class="comment">    based on the current docking state, either at boot time or by</span>
00013 <span class="comment">    ACPI dock.</span>
00014 <span class="comment"></span>
00015 <span class="comment">Author:</span>
00016 <span class="comment"></span>
00017 <span class="comment">    Kenneth D. Ray (kenray) Jan 1998</span>
00018 <span class="comment"></span>
00019 <span class="comment">Revision History:</span>
00020 <span class="comment"></span>
00021 <span class="comment">--*/</span>
00022 
00023 <span class="preprocessor">#include "<a class="code" href="../../d1/d2/cmp_8h.html">cmp.h</a>"</span>
00024 
00025 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00026 <a class="code" href="../../d6/d2/hwprofil_8c.html#a1">CmDeleteKeyRecursive</a>(
00027     HANDLE  hKeyRoot,
00028     PWSTR   Key,
00029     PVOID   TemporaryBuffer,
00030     ULONG   LengthTemporaryBuffer,
00031     BOOLEAN ThisKeyToo
00032     );
00033 
00034 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00035 <a class="code" href="../../d6/d2/hwprofil_8c.html#a2">CmpGetAcpiProfileInformation</a> (
00036     IN  HANDLE  IDConfigDB,
00037     OUT <a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html">PCM_HARDWARE_PROFILE_LIST</a> * ProfileList,
00038     OUT <a class="code" href="../../d7/d3/struct__CM__HARDWARE__PROFILE__ACPI__ALIAS__LIST.html">PCM_HARDWARE_PROFILE_ACPI_ALIAS_LIST</a> * AliasList,
00039     IN  PWCHAR  NameBuffer,
00040     IN  PUCHAR  ValueBuffer,
00041     IN  ULONG   Len
00042     );
00043 
00044 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00045 <a class="code" href="../../d6/d2/hwprofil_8c.html#a3">CmpFilterAcpiDockingState</a> (
00046     IN     <a class="code" href="../../d9/d0/struct__PROFILE__ACPI__DOCKING__STATE.html">PPROFILE_ACPI_DOCKING_STATE</a>  NewDockState,
00047     IN     ULONG                        CurrentDockingState,
00048     IN     PWCHAR                       CurrentAcpiSN,
00049     IN     ULONG                        CurrentProfileNumber,
00050     IN OUT <a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html">PCM_HARDWARE_PROFILE_LIST</a>    ProfileList,
00051     IN OUT <a class="code" href="../../d7/d3/struct__CM__HARDWARE__PROFILE__ACPI__ALIAS__LIST.html">PCM_HARDWARE_PROFILE_ACPI_ALIAS_LIST</a> AliasList
00052     );
00053 
00054 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00055 <a class="code" href="../../d6/d2/hwprofil_8c.html#a4">CmpMoveBiosAliasTable</a> (
00056     IN HANDLE   IDConfigDB,
00057     IN HANDLE   CurrentInfo,
00058     IN ULONG    CurrentProfileNumber,
00059     IN ULONG    NewProfileNumber,
00060     IN PWCHAR   nameBuffer,
00061     IN PCHAR    valueBuffer,
00062     IN ULONG    bufferLen
00063     );
00064 
00065 <span class="preprocessor">#pragma alloc_text(PAGE,CmpCloneHwProfile)</span>
00066 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmSetAcpiHwProfile)</span>
00067 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpFilterAcpiDockingState)</span>
00068 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpGetAcpiProfileInformation)</span>
00069 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpAddAcpiAliasEntry)</span>
00070 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpMoveBiosAliasTable)</span>
00071 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpCreateHwProfileFriendlyName)</span>
00072 <span class="preprocessor"></span>
<a name="l00073"></a><a class="code" href="../../d6/d2/hwprofil_8c.html#a0">00073</a> <span class="keyword">extern</span> UNICODE_STRING  <a class="code" href="../../d8/d9/cmapi_8c.html#a6">CmSymbolicLinkValueName</a>;
00074 
00075 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00076"></a><a class="code" href="../../d6/d2/hwprofil_8c.html#a2">00076</a> <a class="code" href="../../d6/d2/hwprofil_8c.html#a2">CmpGetAcpiProfileInformation</a> (
00077     IN  HANDLE  IDConfigDB,
00078     OUT <a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html">PCM_HARDWARE_PROFILE_LIST</a> * ProfileList,
00079     OUT <a class="code" href="../../d7/d3/struct__CM__HARDWARE__PROFILE__ACPI__ALIAS__LIST.html">PCM_HARDWARE_PROFILE_ACPI_ALIAS_LIST</a> * AliasList,
00080     IN  PWCHAR  nameBuffer,
00081     IN  PUCHAR  valueBuffer,
00082     IN  ULONG   bufferLen
00083     )
00084 <span class="comment">/*++</span>
00085 <span class="comment">Routine Description:</span>
00086 <span class="comment"></span>
00087 <span class="comment">    Obtain the alias and hardware profile information from the registry.</span>
00088 <span class="comment"></span>
00089 <span class="comment">--*/</span>
00090 {
00091     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status = STATUS_SUCCESS;
00092     HANDLE      acpiAlias = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00093     HANDLE      profiles = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00094     HANDLE      entry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00095     ULONG       len = 0;
00096     ULONG       i, j;
00097     OBJECT_ATTRIBUTES   attributes;
00098     UNICODE_STRING      name;
00099     KEY_FULL_INFORMATION        keyInfo;
00100     PKEY_VALUE_FULL_INFORMATION value;
00101     PKEY_BASIC_INFORMATION      basicInfo;
00102 
00103     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a> ();
00104 
00105     *ProfileList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00106     *AliasList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00107 
00108     value = (PKEY_VALUE_FULL_INFORMATION) valueBuffer;
00109     basicInfo = (PKEY_BASIC_INFORMATION) valueBuffer;
00110 
00111     <span class="comment">//</span>
00112     <span class="comment">// Open a handle to the Profile information</span>
00113     <span class="comment">//</span>
00114     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, <a class="code" href="../../d1/d2/cmp_8h.html#a130">CM_HARDWARE_PROFILE_STR_HARDWARE_PROFILES</a>);
00115     InitializeObjectAttributes (&amp;attributes,
00116                                 &amp;name,
00117                                 OBJ_CASE_INSENSITIVE,
00118                                 IDConfigDB,
00119                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00120     status = ZwOpenKey (&amp;profiles,
00121                         KEY_READ,
00122                         &amp;attributes);
00123 
00124     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
00125         profiles = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00126         <span class="keywordflow">goto</span> Clean;
00127     }
00128 
00129     <span class="comment">//</span>
00130     <span class="comment">// Find the number of profile Sub Keys</span>
00131     <span class="comment">//</span>
00132     status = ZwQueryKey (profiles,
00133                          KeyFullInformation,
00134                          &amp;keyInfo,
00135                          <span class="keyword">sizeof</span> (keyInfo),
00136                          &amp;len);
00137 
00138     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
00139         <span class="keywordflow">goto</span> Clean;
00140     }
00141 
00142     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (0 &lt; keyInfo.SubKeys);
00143 
00144     len = <span class="keyword">sizeof</span> (<a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html">CM_HARDWARE_PROFILE_LIST</a>)
00145         + (<span class="keyword">sizeof</span> (<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html">CM_HARDWARE_PROFILE</a>) * (keyInfo.SubKeys - 1));
00146 
00147     * ProfileList = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, len);
00148     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> == *ProfileList) {
00149         status = STATUS_INSUFFICIENT_RESOURCES;
00150         <span class="keywordflow">goto</span> Clean;
00151     }
00152     RtlZeroMemory (*ProfileList, len);
00153 
00154     (*ProfileList)-&gt;MaxProfileCount = keyInfo.SubKeys;
00155     (*ProfileList)-&gt;CurrentProfileCount = 0;
00156 
00157     <span class="comment">//</span>
00158     <span class="comment">// Iterrate the profiles</span>
00159     <span class="comment">//</span>
00160     <span class="keywordflow">for</span> (i = 0; i &lt; keyInfo.SubKeys; i++) {
00161         <a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html">CM_HARDWARE_PROFILE</a> TempProfile;
00162         UNICODE_STRING      <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>;
00163         ULONG               realsize;
00164 
00165         <span class="comment">//</span>
00166         <span class="comment">// Get the first key in the list.</span>
00167         <span class="comment">//</span>
00168         status = ZwEnumerateKey (profiles,
00169                                  i,
00170                                  KeyBasicInformation,
00171                                  basicInfo,
00172                                  bufferLen - <span class="keyword">sizeof</span> (UNICODE_NULL), <span class="comment">// term 0</span>
00173                                  &amp;len);
00174 
00175         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
00176             <span class="comment">//</span>
00177             <span class="comment">// This should never happen.</span>
00178             <span class="comment">//</span>
00179             <span class="keywordflow">break</span>;
00180         }
00181 
00182         basicInfo-&gt;Name [basicInfo-&gt;NameLength/<span class="keyword">sizeof</span>(WCHAR)] = 0;
00183         name.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) basicInfo-&gt;NameLength;
00184         name.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) basicInfo-&gt;NameLength + <span class="keyword">sizeof</span> (UNICODE_NULL);
00185         name.Buffer = basicInfo-&gt;Name;
00186 
00187         InitializeObjectAttributes (&amp;attributes,
00188                                     &amp;name,
00189                                     OBJ_CASE_INSENSITIVE,
00190                                     profiles,
00191                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00192         status = ZwOpenKey (&amp;entry,
00193                             KEY_READ,
00194                             &amp;attributes);
00195         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
00196             <span class="keywordflow">break</span>;
00197         }
00198 
00199         <span class="comment">//</span>
00200         <span class="comment">// Fill in the temporary profile structure with this</span>
00201         <span class="comment">// profile's data.</span>
00202         <span class="comment">//</span>
00203         <a class="code" href="../../d9/d3/cnvint_8c.html#a4">RtlUnicodeStringToInteger</a>(&amp;name, 0, &amp;TempProfile.<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html#o3">Id</a>);
00204 
00205         <span class="comment">//</span>
00206         <span class="comment">// Find the pref order of this entry.</span>
00207         <span class="comment">//</span>
00208         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, <a class="code" href="../../d1/d2/cmp_8h.html#a140">CM_HARDWARE_PROFILE_STR_PREFERENCE_ORDER</a>);
00209         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(entry,
00210                                  &amp;name,
00211                                  KeyValueFullInformation,
00212                                  valueBuffer,
00213                                  bufferLen,
00214                                  &amp;len);
00215 
00216         <span class="keywordflow">if</span> ((!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) || (value-&gt;Type != REG_DWORD)) {
00217             TempProfile.<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html#o2">PreferenceOrder</a> = -1;
00218 
00219         } <span class="keywordflow">else</span> {
00220             TempProfile.<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html#o2">PreferenceOrder</a>
00221                 = * (PULONG) ((PUCHAR) value + value-&gt;DataOffset);
00222         }
00223 
00224         <span class="comment">//</span>
00225         <span class="comment">// Extract the friendly name</span>
00226         <span class="comment">//</span>
00227         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, <a class="code" href="../../d1/d2/cmp_8h.html#a141">CM_HARDWARE_PROFILE_STR_FRIENDLY_NAME</a>);
00228         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(entry,
00229                                  &amp;name,
00230                                  KeyValueFullInformation,
00231                                  valueBuffer,
00232                                  bufferLen,
00233                                  &amp;len);
00234 
00235         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status) || (value-&gt;Type != REG_SZ)) {
00236             WCHAR tmpname[] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"------"</span>; <span class="comment">// as taken from cmboot.c</span>
00237             ULONG len;
00238             PVOID buffer;
00239 
00240             len = <span class="keyword">sizeof</span> (tmpname);
00241             buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, len);
00242 
00243             TempProfile.<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html#o0">NameLength</a> = len;
00244             TempProfile.<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html#o1">FriendlyName</a> = buffer;
00245             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> == buffer) {
00246                 status = STATUS_INSUFFICIENT_RESOURCES;
00247                 ZwClose (entry);
00248                 <span class="keywordflow">goto</span> Clean;
00249             }
00250             RtlCopyMemory (buffer, tmpname, value-&gt;DataLength);
00251 
00252         } <span class="keywordflow">else</span> {
00253             PVOID buffer;
00254 
00255             buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, value-&gt;DataLength);
00256             TempProfile.<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html#o0">NameLength</a> = value-&gt;DataLength;
00257             TempProfile.<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html#o1">FriendlyName</a> = buffer;
00258             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> == buffer) {
00259                 status = STATUS_INSUFFICIENT_RESOURCES;
00260                 ZwClose (entry);
00261                 <span class="keywordflow">goto</span> Clean;
00262             }
00263             RtlCopyMemory (buffer,
00264                            (PUCHAR) value + value-&gt;DataOffset,
00265                            value-&gt;DataLength);
00266         }
00267 
00268         TempProfile.<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html#o4">Flags</a> = 0;
00269         <span class="comment">//</span>
00270         <span class="comment">// Is this aliasable?</span>
00271         <span class="comment">//</span>
00272         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, <a class="code" href="../../d1/d2/cmp_8h.html#a137">CM_HARDWARE_PROFILE_STR_ALIASABLE</a>);
00273         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(entry,
00274                                  &amp;name,
00275                                  KeyValueFullInformation,
00276                                  valueBuffer,
00277                                  bufferLen,
00278                                  &amp;len);
00279 
00280         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status) &amp;&amp; (value-&gt;Type == REG_DWORD)) {
00281             <span class="keywordflow">if</span> (* (PULONG) ((PUCHAR) value + value-&gt;DataOffset)) {
00282                 TempProfile.<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html#o4">Flags</a> |= <a class="code" href="../../d1/d2/cmp_8h.html#a147">CM_HP_FLAGS_ALIASABLE</a>;
00283             }
00284 
00285         } <span class="keywordflow">else</span> {
00286             TempProfile.<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html#o4">Flags</a> |= <a class="code" href="../../d1/d2/cmp_8h.html#a147">CM_HP_FLAGS_ALIASABLE</a>;
00287         }
00288 
00289         <span class="comment">//</span>
00290         <span class="comment">// Is this pristine?</span>
00291         <span class="comment">//</span>
00292         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, <a class="code" href="../../d1/d2/cmp_8h.html#a139">CM_HARDWARE_PROFILE_STR_PRISTINE</a>);
00293         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(entry,
00294                                  &amp;name,
00295                                  KeyValueFullInformation,
00296                                  valueBuffer,
00297                                  bufferLen,
00298                                  &amp;len);
00299 
00300         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status) &amp;&amp; (value-&gt;Type == REG_DWORD)) {
00301             <span class="keywordflow">if</span> (* (PULONG) ((PUCHAR) value + value-&gt;DataOffset)) {
00302                 TempProfile.<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html#o4">Flags</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a149">CM_HP_FLAGS_PRISTINE</a>;
00303                 <span class="comment">// No other flags set;</span>
00304             }
00305         }
00306 
00307         <span class="comment">//</span>
00308         <span class="comment">// If we see a profile with the ID of zero (AKA an illegal)</span>
00309         <span class="comment">// ID for a hardware profile to possess, then we know that this</span>
00310         <span class="comment">// must be a pristine profile.</span>
00311         <span class="comment">//</span>
00312         <span class="keywordflow">if</span> (0 == TempProfile.<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html#o3">Id</a>) {
00313             TempProfile.<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html#o4">Flags</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a149">CM_HP_FLAGS_PRISTINE</a>;
00314             <span class="comment">// NO other flags set.</span>
00315 
00316             TempProfile.<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html#o2">PreferenceOrder</a> = -1; <span class="comment">// move to the end of the list.</span>
00317         }
00318 
00319 
00320         <span class="comment">//</span>
00321         <span class="comment">// Insert this new profile into the appropriate spot in the</span>
00322         <span class="comment">// profile array. Entries are sorted by preference order.</span>
00323         <span class="comment">//</span>
00324         <span class="keywordflow">for</span> (j=0; j &lt; (*ProfileList)-&gt;CurrentProfileCount; j++) {
00325             <span class="keywordflow">if</span> ((*ProfileList)-&gt;Profile[j].PreferenceOrder &gt;=
00326                 TempProfile.<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html#o2">PreferenceOrder</a>) {
00327 
00328                 <span class="comment">//</span>
00329                 <span class="comment">// Insert at position j.</span>
00330                 <span class="comment">//</span>
00331                 RtlMoveMemory(&amp;(*ProfileList)-&gt;Profile[j+1],
00332                               &amp;(*ProfileList)-&gt;Profile[j],
00333                               <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html">CM_HARDWARE_PROFILE</a>) *
00334                               ((*ProfileList)-&gt;MaxProfileCount-j-1));
00335                 <span class="keywordflow">break</span>;
00336             }
00337         }
00338         (*ProfileList)-&gt;Profile[j] = TempProfile;
00339         ++(*ProfileList)-&gt;CurrentProfileCount;
00340 
00341         ZwClose (entry);
00342     }
00343 
00344     <span class="comment">//</span>
00345     <span class="comment">// Open a handle to the ACPI Alias information</span>
00346     <span class="comment">//</span>
00347     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, <a class="code" href="../../d1/d2/cmp_8h.html#a129">CM_HARDWARE_PROFILE_STR_ACPI_ALIAS</a>);
00348     InitializeObjectAttributes (&amp;attributes,
00349                                 &amp;name,
00350                                 OBJ_CASE_INSENSITIVE,
00351                                 IDConfigDB,
00352                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00353     status = ZwOpenKey (&amp;acpiAlias,
00354                         KEY_READ,
00355                         &amp;attributes);
00356 
00357     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
00358         <span class="comment">//</span>
00359         <span class="comment">// So we don't have an alias table.  This is ok.</span>
00360         <span class="comment">//</span>
00361         status = STATUS_SUCCESS;
00362         acpiAlias = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00363         <span class="keywordflow">goto</span> Clean;
00364     }
00365 
00366     <span class="comment">//</span>
00367     <span class="comment">// Find the number of Acpi Alias Sub Keys</span>
00368     <span class="comment">//</span>
00369     status = ZwQueryKey (acpiAlias,
00370                          KeyFullInformation,
00371                          &amp;keyInfo,
00372                          <span class="keyword">sizeof</span> (keyInfo),
00373                          &amp;len);
00374 
00375     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
00376         <span class="keywordflow">goto</span> Clean;
00377     }
00378 
00379 
00380     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (0 &lt; keyInfo.SubKeys);
00381 
00382     * AliasList = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a> (
00383                         <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00384                         <span class="keyword">sizeof</span> (<a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html">CM_HARDWARE_PROFILE_LIST</a>) +
00385                         (<span class="keyword">sizeof</span> (<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html">CM_HARDWARE_PROFILE</a>) * (keyInfo.SubKeys - 1)));
00386 
00387     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> == *AliasList) {
00388         status = STATUS_INSUFFICIENT_RESOURCES;
00389         <span class="keywordflow">goto</span> Clean;
00390     }
00391 
00392     (*AliasList)-&gt;MaxAliasCount =
00393         (*AliasList)-&gt;CurrentAliasCount = keyInfo.SubKeys;
00394 
00395     <span class="comment">//</span>
00396     <span class="comment">// Iterrate the alias entries</span>
00397     <span class="comment">//</span>
00398     <span class="keywordflow">for</span> (i = 0; i &lt; keyInfo.SubKeys; i++) {
00399 
00400         <span class="comment">//</span>
00401         <span class="comment">// Get the first key in the list.</span>
00402         <span class="comment">//</span>
00403         status = ZwEnumerateKey (acpiAlias,
00404                                  i,
00405                                  KeyBasicInformation,
00406                                  basicInfo,
00407                                  bufferLen - <span class="keyword">sizeof</span> (UNICODE_NULL), <span class="comment">// term 0</span>
00408                                  &amp;len);
00409 
00410         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
00411             <span class="comment">//</span>
00412             <span class="comment">// This should never happen.</span>
00413             <span class="comment">//</span>
00414             <span class="keywordflow">break</span>;
00415         }
00416 
00417         basicInfo-&gt;Name [basicInfo-&gt;NameLength/<span class="keyword">sizeof</span>(WCHAR)] = 0;
00418         name.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) basicInfo-&gt;NameLength;
00419         name.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) basicInfo-&gt;NameLength + <span class="keyword">sizeof</span> (UNICODE_NULL);
00420         name.Buffer = basicInfo-&gt;Name;
00421 
00422         InitializeObjectAttributes (&amp;attributes,
00423                                     &amp;name,
00424                                     OBJ_CASE_INSENSITIVE,
00425                                     acpiAlias,
00426                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00427         status = ZwOpenKey (&amp;entry,
00428                             KEY_READ,
00429                             &amp;attributes);
00430         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
00431             <span class="keywordflow">break</span>;
00432         }
00433 
00434         <span class="comment">//</span>
00435         <span class="comment">// Extract The Profile number to which this alias refers.</span>
00436         <span class="comment">//</span>
00437         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, <a class="code" href="../../d1/d2/cmp_8h.html#a136">CM_HARDWARE_PROFILE_STR_PROFILE_NUMBER</a>);
00438         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(entry,
00439                                  &amp;name,
00440                                  KeyValueFullInformation,
00441                                  valueBuffer,
00442                                  bufferLen,
00443                                  &amp;len);
00444 
00445         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status) || (value-&gt;Type != REG_DWORD)) {
00446             status = STATUS_REGISTRY_CORRUPT;
00447             ZwClose (entry);
00448             <span class="keywordflow">goto</span> Clean;
00449         }
00450         (*AliasList)-&gt;Alias[i].ProfileNumber =
00451             * (PULONG) ((PUCHAR) value + value-&gt;DataOffset);
00452 
00453         <span class="comment">//</span>
00454         <span class="comment">// Extract The Docking State.</span>
00455         <span class="comment">//</span>
00456         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, <a class="code" href="../../d1/d2/cmp_8h.html#a131">CM_HARDWARE_PROFILE_STR_DOCKING_STATE</a>);
00457         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(entry,
00458                                  &amp;name,
00459                                  KeyValueFullInformation,
00460                                  valueBuffer,
00461                                  bufferLen,
00462                                  &amp;len);
00463 
00464         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status) || (value-&gt;Type != REG_DWORD)) {
00465             status = STATUS_REGISTRY_CORRUPT;
00466             ZwClose (entry);
00467             <span class="keywordflow">goto</span> Clean;
00468         }
00469         (*AliasList)-&gt;Alias[i].DockState =
00470             * (PULONG) ((PUCHAR) value + value-&gt;DataOffset);
00471 
00472 
00473         <span class="comment">//</span>
00474         <span class="comment">// Find the SerialNumber</span>
00475         <span class="comment">//</span>
00476         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, <a class="code" href="../../d1/d2/cmp_8h.html#a135">CM_HARDWARE_PROFILE_STR_ACPI_SERIAL_NUMBER</a>);
00477         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(entry,
00478                                  &amp;name,
00479                                  KeyValueFullInformation,
00480                                  valueBuffer,
00481                                  bufferLen,
00482                                  &amp;len);
00483 
00484         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status) || (value-&gt;Type != REG_BINARY)) {
00485             status = STATUS_REGISTRY_CORRUPT;
00486             ZwClose (entry);
00487             <span class="keywordflow">goto</span> Clean;
00488         }
00489 
00490         (*AliasList)-&gt;Alias[i].SerialLength = value-&gt;DataLength;
00491         (*AliasList)-&gt;Alias[i].SerialNumber =
00492                     (value-&gt;DataLength) ?
00493                     <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, value-&gt;DataLength) :
00494                     0;
00495 
00496         <span class="keywordflow">if</span> (value-&gt;DataLength &amp;&amp; (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> == (*AliasList)-&gt;Alias[i].SerialNumber)) {
00497 
00498             status = STATUS_INSUFFICIENT_RESOURCES;
00499             ZwClose (entry);
00500             <span class="keywordflow">goto</span> Clean;
00501         }
00502 
00503         <span class="keywordflow">if</span> (value-&gt;DataLength) {
00504             RtlCopyMemory ((*AliasList)-&gt;Alias[i].SerialNumber,
00505                            (PUCHAR) value + value-&gt;DataOffset,
00506                            value-&gt;DataLength);
00507         }
00508 
00509         ZwClose (entry);
00510     }
00511 
00512 Clean:
00513     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> != acpiAlias) {
00514         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (acpiAlias);
00515     }
00516     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> != profiles) {
00517         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (profiles);
00518     }
00519 
00520     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
00521         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> != *ProfileList) {
00522             <span class="keywordflow">for</span> (i = 0; i &lt; (*ProfileList)-&gt;CurrentProfileCount; i++) {
00523                 <span class="keywordflow">if</span> ((*ProfileList)-&gt;Profile[i].FriendlyName) {
00524                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> ((*ProfileList)-&gt;Profile[i].FriendlyName);
00525                 }
00526             }
00527             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (*ProfileList);
00528             *ProfileList = 0;
00529         }
00530         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> != *AliasList) {
00531             <span class="keywordflow">for</span> (i = 0; i &lt; (*AliasList)-&gt;CurrentAliasCount; i++) {
00532                 <span class="keywordflow">if</span> ((*AliasList)-&gt;Alias[i].SerialNumber) {
00533                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> ((*AliasList)-&gt;Alias[i].SerialNumber);
00534                 }
00535             }
00536             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (*AliasList);
00537             *AliasList = 0;
00538         }
00539     }
00540     <span class="keywordflow">return</span> status;
00541 }
00542 
00543 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00544"></a><a class="code" href="../../d6/d2/hwprofil_8c.html#a5">00544</a> <a class="code" href="../../d6/d2/hwprofil_8c.html#a5">CmpAddAcpiAliasEntry</a> (
00545     IN HANDLE                       IDConfigDB,
00546     IN <a class="code" href="../../d9/d0/struct__PROFILE__ACPI__DOCKING__STATE.html">PPROFILE_ACPI_DOCKING_STATE</a>  NewDockState,
00547     IN ULONG                        ProfileNumber,
00548     IN PWCHAR                       nameBuffer,
00549     IN PVOID                        valueBuffer,
00550     IN ULONG                        valueBufferLength,
00551     IN BOOLEAN                      PreventDuplication
00552     )
00553 <span class="comment">/*++</span>
00554 <span class="comment">Routine Description:</span>
00555 <span class="comment">    Set the Acpi Alais entry.</span>
00556 <span class="comment"></span>
00557 <span class="comment"></span>
00558 <span class="comment">    Routine Description:</span>
00559 <span class="comment">    Create an alias entry in the IDConfigDB database for the given</span>
00560 <span class="comment">    hardware profile.</span>
00561 <span class="comment"></span>
00562 <span class="comment">    Create the "AcpiAlias" key if it does not exist.</span>
00563 <span class="comment"></span>
00564 <span class="comment">Parameters:</span>
00565 <span class="comment"></span>
00566 <span class="comment">    IDConfigDB - Pointer to "..\CurrentControlSet\Control\IDConfigDB"</span>
00567 <span class="comment"></span>
00568 <span class="comment">    NewDockState - The new docking state for which this alias points.</span>
00569 <span class="comment"></span>
00570 <span class="comment">    ProfileNumber -The profile number to which this alias points.</span>
00571 <span class="comment"></span>
00572 <span class="comment">    nameBuffer - a temp scratch space for writing things.</span>
00573 <span class="comment">                (assumed to be at least 128 WCHARS)</span>
00574 <span class="comment"></span>
00575 <span class="comment">--*/</span>
00576 {
00577     OBJECT_ATTRIBUTES attributes;
00578     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>        status = STATUS_SUCCESS;
00579     ANSI_STRING     ansiString;
00580     UNICODE_STRING  name;
00581     HANDLE          aliasKey = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00582     HANDLE          aliasEntry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00583     ULONG           value;
00584     ULONG           disposition;
00585     ULONG           aliasNumber = 0;
00586     ULONG           len;
00587     PKEY_VALUE_FULL_INFORMATION   keyInfo;
00588 
00589     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a> ();
00590 
00591     keyInfo = (PKEY_VALUE_FULL_INFORMATION) valueBuffer;
00592 
00593     <span class="comment">//</span>
00594     <span class="comment">// Find the Alias Key or Create it if it does not already exist.</span>
00595     <span class="comment">//</span>
00596     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name,<a class="code" href="../../d1/d2/cmp_8h.html#a129">CM_HARDWARE_PROFILE_STR_ACPI_ALIAS</a>);
00597 
00598     InitializeObjectAttributes (&amp;attributes,
00599                                 &amp;name,
00600                                 OBJ_CASE_INSENSITIVE,
00601                                 IDConfigDB,
00602                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00603 
00604     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a> (&amp;aliasKey,
00605                         KEY_READ | KEY_WRITE,
00606                         &amp;attributes);
00607 
00608     <span class="keywordflow">if</span> (STATUS_OBJECT_NAME_NOT_FOUND == status) {
00609         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a> (&amp;aliasKey,
00610                               KEY_READ | KEY_WRITE,
00611                               &amp;attributes,
00612                               0, <span class="comment">// no title</span>
00613                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <span class="comment">// no class</span>
00614                               0, <span class="comment">// no options</span>
00615                               &amp;disposition);
00616     }
00617 
00618     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
00619         aliasKey = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00620         <span class="keywordflow">goto</span> Exit;
00621     }
00622 
00623     <span class="comment">//</span>
00624     <span class="comment">// Create an entry key</span>
00625     <span class="comment">//</span>
00626 
00627     <span class="keywordflow">while</span> (aliasNumber &lt; 200) {
00628         aliasNumber++;
00629 
00630         swprintf (nameBuffer, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"%04d"</span>, aliasNumber);
00631         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, nameBuffer);
00632 
00633         InitializeObjectAttributes(&amp;attributes,
00634                                    &amp;name,
00635                                    OBJ_CASE_INSENSITIVE,
00636                                    aliasKey,
00637                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00638 
00639         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a> (&amp;aliasEntry,
00640                             KEY_READ | KEY_WRITE,
00641                             &amp;attributes);
00642 
00643         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
00644 
00645             <span class="keywordflow">if</span> (PreventDuplication) {
00646                 <span class="comment">//</span>
00647                 <span class="comment">// If we have a matching DockingState, SerialNumber, and</span>
00648                 <span class="comment">// Profile Number, then we should not make this alias</span>
00649                 <span class="comment">//</span>
00650 
00651                 <span class="comment">//</span>
00652                 <span class="comment">// Extract The DockingState to which this alias refers.</span>
00653                 <span class="comment">//</span>
00654                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, <a class="code" href="../../d1/d2/cmp_8h.html#a131">CM_HARDWARE_PROFILE_STR_DOCKING_STATE</a>);
00655                 status = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(aliasEntry,
00656                                          &amp;name,
00657                                          KeyValueFullInformation,
00658                                          valueBuffer,
00659                                          valueBufferLength,
00660                                          &amp;len);
00661 
00662                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status) || (keyInfo-&gt;Type != REG_DWORD)) {
00663                     status = STATUS_REGISTRY_CORRUPT;
00664                     <span class="keywordflow">goto</span> Exit;
00665                 }
00666 
00667                 <span class="keywordflow">if</span> (NewDockState-&gt;DockingState !=
00668                     * (PULONG) ((PUCHAR) keyInfo + keyInfo-&gt;DataOffset)) {
00669                     <span class="comment">//</span>
00670                     <span class="comment">// Not a dupe</span>
00671                     <span class="comment">//</span>
00672 
00673                     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (aliasEntry);
00674                     aliasEntry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00675                     <span class="keywordflow">continue</span>;
00676                 }
00677 
00678                 <span class="comment">//</span>
00679                 <span class="comment">// Extract the SerialNumber</span>
00680                 <span class="comment">//</span>
00681                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, <a class="code" href="../../d1/d2/cmp_8h.html#a135">CM_HARDWARE_PROFILE_STR_ACPI_SERIAL_NUMBER</a>);
00682                 status = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(aliasEntry,
00683                                          &amp;name,
00684                                          KeyValueFullInformation,
00685                                          valueBuffer,
00686                                          valueBufferLength,
00687                                          &amp;len);
00688 
00689                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status) || (keyInfo-&gt;Type != REG_BINARY)) {
00690                     status = STATUS_REGISTRY_CORRUPT;
00691                     <span class="keywordflow">goto</span> Exit;
00692                 }
00693 
00694                 <span class="keywordflow">if</span> (NewDockState-&gt;SerialLength != keyInfo-&gt;DataLength) {
00695                     <span class="comment">//</span>
00696                     <span class="comment">// Not a dupe</span>
00697                     <span class="comment">//</span>
00698 
00699                     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (aliasEntry);
00700                     aliasEntry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00701                     <span class="keywordflow">continue</span>;
00702                 }
00703 
00704                 <span class="keywordflow">if</span> (!RtlEqualMemory (NewDockState-&gt;SerialNumber,
00705                                      ((PUCHAR) keyInfo + keyInfo-&gt;DataOffset),
00706                                      NewDockState-&gt;SerialLength)) {
00707                     <span class="comment">//</span>
00708                     <span class="comment">// Not a dupe</span>
00709                     <span class="comment">//</span>
00710 
00711                     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (aliasEntry);
00712                     aliasEntry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00713                     <span class="keywordflow">continue</span>;
00714                 }
00715 
00716                 status = STATUS_SUCCESS;
00717                 <span class="keywordflow">goto</span> Exit;
00718 
00719             }
00720 
00721         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (STATUS_OBJECT_NAME_NOT_FOUND == status) {
00722             status = STATUS_SUCCESS;
00723             <span class="keywordflow">break</span>;
00724 
00725         } <span class="keywordflow">else</span> {
00726             <span class="keywordflow">break</span>;
00727         }
00728 
00729     }
00730     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
00731         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a18">CML_BUGCHECK</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a27">CMS_INIT</a>) {
00732             KdPrint((<span class="stringliteral">"CM: cmpCreateAcpiAliasEntry error finding new set %08lx\n"</span>,
00733                      status));
00734         }
00735         aliasEntry = 0;
00736         <span class="keywordflow">goto</span> Exit;
00737     }
00738 
00739     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a> (&amp;aliasEntry,
00740                           KEY_READ | KEY_WRITE,
00741                           &amp;attributes,
00742                           0,
00743                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00744                           0,
00745                           &amp;disposition);
00746 
00747     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
00748         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a18">CML_BUGCHECK</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a27">CMS_INIT</a>) {
00749             KdPrint((<span class="stringliteral">"CM: cmpCreateAcpiAliasEntry error creating new set %08lx\n"</span>,
00750                      status));
00751         }
00752         aliasEntry = 0;
00753         <span class="keywordflow">goto</span> Exit;
00754     }
00755 
00756     <span class="comment">//</span>
00757     <span class="comment">// Write the Docking State;</span>
00758     <span class="comment">//</span>
00759     value = NewDockState-&gt;DockingState;
00760     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, <a class="code" href="../../d1/d2/cmp_8h.html#a131">CM_HARDWARE_PROFILE_STR_DOCKING_STATE</a>);
00761     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a> (aliasEntry,
00762                             &amp;name,
00763                             0,
00764                             REG_DWORD,
00765                             &amp;value,
00766                             <span class="keyword">sizeof</span> (value));
00767 
00768     <span class="comment">//</span>
00769     <span class="comment">// Write the Serial Number</span>
00770     <span class="comment">//</span>
00771     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, <a class="code" href="../../d1/d2/cmp_8h.html#a135">CM_HARDWARE_PROFILE_STR_ACPI_SERIAL_NUMBER</a>);
00772     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a> (aliasEntry,
00773                             &amp;name,
00774                             0,
00775                             REG_BINARY,
00776                             NewDockState-&gt;SerialNumber,
00777                             NewDockState-&gt;SerialLength);
00778 
00779     <span class="comment">//</span>
00780     <span class="comment">// Write the Profile Number</span>
00781     <span class="comment">//</span>
00782     value = ProfileNumber;
00783     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, <a class="code" href="../../d1/d2/cmp_8h.html#a136">CM_HARDWARE_PROFILE_STR_PROFILE_NUMBER</a>);
00784     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a> (aliasEntry,
00785                             &amp;name,
00786                             0,
00787                             REG_DWORD,
00788                             &amp;value,
00789                             <span class="keyword">sizeof</span> (value));
00790 
00791 Exit:
00792 
00793     <span class="keywordflow">if</span> (aliasKey) {
00794         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (aliasKey);
00795     }
00796 
00797     <span class="keywordflow">if</span> (aliasEntry) {
00798         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (aliasEntry);
00799     }
00800 
00801     <span class="keywordflow">return</span> status;
00802 }
00803 
00804 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00805"></a><a class="code" href="../../d6/d2/hwprofil_8c.html#a6">00805</a> <a class="code" href="../../d6/d2/hwprofil_8c.html#a6">CmSetAcpiHwProfile</a> (
00806     IN <a class="code" href="../../d9/d0/struct__PROFILE__ACPI__DOCKING__STATE.html">PPROFILE_ACPI_DOCKING_STATE</a> NewDockState,
00807     IN PCM_ACPI_SELECTION_ROUTINE  Select,
00808     IN PVOID Context,
00809     OUT PHANDLE NewProfile,
00810     OUT PBOOLEAN ProfileChanged
00811     )
00812 <span class="comment">/*++</span>
00813 <span class="comment">Routine Description:</span>
00814 <span class="comment"></span>
00815 <span class="comment">    The ACPI docking state of the machine has changed.</span>
00816 <span class="comment"></span>
00817 <span class="comment">    Based on the new change calculate the new HW Profile(s) consitent with the</span>
00818 <span class="comment">    new ACPI docking state.</span>
00819 <span class="comment"></span>
00820 <span class="comment">    Pass the list of known profiles to the callers selection routine.</span>
00821 <span class="comment"></span>
00822 <span class="comment">    Set the new current profile.</span>
00823 <span class="comment"></span>
00824 <span class="comment">    Patch up any ACPI alias entries if a new profile for this ACPI state has</span>
00825 <span class="comment">    been used.</span>
00826 <span class="comment"></span>
00827 <span class="comment">Arguments:</span>
00828 <span class="comment"></span>
00829 <span class="comment">    NewDockStateArray - The list of possible Docking States that we might enter.</span>
00830 <span class="comment"></span>
00831 <span class="comment">    Select - Call back to select which profile to enter, given the list of</span>
00832 <span class="comment">             possible profiles.</span>
00833 <span class="comment"></span>
00834 <span class="comment">--*/</span>
00835 {
00836     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>        status = STATUS_SUCCESS;
00837     HANDLE          IDConfigDB = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00838     HANDLE          HardwareProfile = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00839     HANDLE          currentInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00840     HANDLE          currentSymLink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00841     HANDLE          parent = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00842     WCHAR           nameBuffer[128];
00843     UNICODE_STRING  name;
00844     UCHAR           valueBuffer[256];
00845     ULONG           len;
00846     ULONG           i;
00847     ULONG           selectedElement;
00848     ULONG           profileNum;
00849     ULONG           currentDockingState;
00850     ULONG           currentProfileNumber;
00851     ULONG           disposition;
00852     ULONG           flags;
00853     PWCHAR          currentAcpiSN = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00854     <a class="code" href="../../d7/d3/struct__CM__HARDWARE__PROFILE__ACPI__ALIAS__LIST.html">PCM_HARDWARE_PROFILE_ACPI_ALIAS_LIST</a>  AliasList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00855     <a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html">PCM_HARDWARE_PROFILE_LIST</a>             ProfileList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00856     PKEY_VALUE_FULL_INFORMATION           value;
00857     OBJECT_ATTRIBUTES                     attributes;
00858 
00859     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a> ();
00860 
00861     *ProfileChanged = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00862 
00863     value = (PKEY_VALUE_FULL_INFORMATION) valueBuffer;
00864 
00865     <span class="comment">//</span>
00866     <span class="comment">// Open The Hardware Profile Database</span>
00867     <span class="comment">//</span>
00868     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, <a class="code" href="../../d1/d2/cmp_8h.html#a125">CM_HARDWARE_PROFILE_STR_DATABASE</a>);
00869     InitializeObjectAttributes (&amp;attributes,
00870                                 &amp;name,
00871                                 OBJ_CASE_INSENSITIVE,
00872                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00873                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00874 
00875     status = ZwOpenKey (&amp;IDConfigDB,
00876                         KEY_READ,
00877                         &amp;attributes);
00878 
00879     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
00880         IDConfigDB = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00881         <span class="keywordflow">goto</span> Clean;
00882     }
00883 
00884     <span class="comment">//</span>
00885     <span class="comment">// Obtain the total list of profiles</span>
00886     <span class="comment">//</span>
00887     status = <a class="code" href="../../d6/d2/hwprofil_8c.html#a2">CmpGetAcpiProfileInformation</a> (IDConfigDB,
00888                                            &amp;ProfileList,
00889                                            &amp;AliasList,
00890                                            nameBuffer,
00891                                            valueBuffer,
00892                                            <span class="keyword">sizeof</span> (valueBuffer));
00893 
00894     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
00895         <span class="keywordflow">goto</span> Clean;
00896     }
00897 
00898     <span class="comment">//</span>
00899     <span class="comment">// Determine the current Dock information.</span>
00900     <span class="comment">//</span>
00901     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, <a class="code" href="../../d1/d2/cmp_8h.html#a127">CM_HARDWARE_PROFILE_STR_CCS_CURRENT</a>);
00902     InitializeObjectAttributes (&amp;attributes,
00903                                 &amp;name,
00904                                 OBJ_CASE_INSENSITIVE,
00905                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00906                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00907 
00908     status = ZwOpenKey (&amp;HardwareProfile,
00909                         KEY_READ,
00910                         &amp;attributes);
00911     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
00912         HardwareProfile = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00913         <span class="keywordflow">goto</span> Clean;
00914     }
00915     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, <a class="code" href="../../d1/d2/cmp_8h.html#a142">CM_HARDWARE_PROFILE_STR_CURRENT_DOCK_INFO</a>);
00916     InitializeObjectAttributes (&amp;attributes,
00917                                 &amp;name,
00918                                 OBJ_CASE_INSENSITIVE,
00919                                 IDConfigDB,
00920                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00921 
00922     status = ZwOpenKey (&amp;currentInfo,
00923                         KEY_READ,
00924                         &amp;attributes);
00925     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
00926         currentInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00927         <span class="keywordflow">goto</span> Clean;
00928     }
00929 
00930     <span class="comment">//</span>
00931     <span class="comment">// The current Docking State</span>
00932     <span class="comment">//</span>
00933     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, <a class="code" href="../../d1/d2/cmp_8h.html#a131">CM_HARDWARE_PROFILE_STR_DOCKING_STATE</a>);
00934     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a> (currentInfo,
00935                               &amp;name,
00936                               KeyValueFullInformation,
00937                               valueBuffer,
00938                               <span class="keyword">sizeof</span> (valueBuffer),
00939                               &amp;len);
00940 
00941     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status) || (value-&gt;Type != REG_DWORD)) {
00942         status = STATUS_REGISTRY_CORRUPT;
00943         <span class="keywordflow">goto</span> Clean;
00944     }
00945     currentDockingState = * (PULONG) ((PUCHAR) value + value-&gt;DataOffset);
00946 
00947     <span class="comment">//</span>
00948     <span class="comment">// The current ACPI Serial Number</span>
00949     <span class="comment">//</span>
00950     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, <a class="code" href="../../d1/d2/cmp_8h.html#a135">CM_HARDWARE_PROFILE_STR_ACPI_SERIAL_NUMBER</a>);
00951     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(currentInfo,
00952                              &amp;name,
00953                              KeyValueFullInformation,
00954                              valueBuffer,
00955                              <span class="keyword">sizeof</span> (valueBuffer),
00956                              &amp;len);
00957 
00958     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status) &amp;&amp; (value-&gt;Type == REG_BINARY)) {
00959 
00960         currentAcpiSN = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, value-&gt;DataLength);
00961 
00962         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> == currentAcpiSN) {
00963             status = STATUS_INSUFFICIENT_RESOURCES;
00964             <span class="keywordflow">goto</span> Clean;
00965         }
00966         RtlCopyMemory (currentAcpiSN,
00967                        (PUCHAR) value + value-&gt;DataOffset,
00968                        value-&gt;DataLength);
00969     } <span class="keywordflow">else</span> {
00970         currentAcpiSN = 0;
00971     }
00972 
00973     <span class="comment">//</span>
00974     <span class="comment">// The current Profile Number</span>
00975     <span class="comment">//</span>
00976     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;name, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"CurrentConfig"</span>);
00977     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(IDConfigDB,
00978                              &amp;name,
00979                              KeyValueFullInformation,
00980                              valueBuffer,
00981                              <span class="keyword">sizeof</span> (valueBuffer),
00982                              &amp;len);
00983 
00984     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) || (value-&gt;Type != REG_DWORD)) {
00985         status = STATUS_REGISTRY_CORRUPT;
00986         <span class="keywordflow">goto</span> Clean;
00987     }
00988     currentProfileNumber = *(PULONG)((PUCHAR)value + value-&gt;DataOffset);
00989 
00990     <span class="comment">//</span>
00991     <span class="comment">// Filter the current list of hardware profiles based on the current</span>
00992     <span class="comment">// docking state, the new acpi state, and the acpi alias tables</span>
00993     <span class="comment">//</span>
00994     status = <a class="code" href="../../d6/d2/hwprofil_8c.html#a3">CmpFilterAcpiDockingState</a> (NewDockState,
00995                                         currentDockingState,
00996                                         currentAcpiSN,
00997                                         currentProfileNumber,
00998                                         ProfileList,
00999                                         AliasList);
01000 
01001     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
01002         <span class="keywordflow">goto</span> Clean;
01003     }
01004 
01005     <span class="comment">//</span>
01006     <span class="comment">// Allow the caller a chance to select from the filtered list.</span>
01007     <span class="comment">//</span>
01008     status = Select (ProfileList, &amp;selectedElement, Context);
01009 
01010     <span class="comment">//</span>
01011     <span class="comment">// If the user selected -1 then he is not interested in selecting any of</span>
01012     <span class="comment">// the profiles.</span>
01013     <span class="comment">//</span>
01014     <span class="keywordflow">if</span> (-1 == selectedElement) {
01015         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (STATUS_MORE_PROCESSING_REQUIRED == status);
01016         <span class="keywordflow">goto</span> Clean;
01017     }
01018 
01019     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
01020         <span class="keywordflow">goto</span> Clean;
01021     }
01022 
01023     <span class="comment">//</span>
01024     <span class="comment">// Fine! We have finally made the new selection.</span>
01025     <span class="comment">// Set it.</span>
01026     <span class="comment">//</span>
01027 
01028     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, <a class="code" href="../../d1/d2/cmp_8h.html#a126">CM_HARDWARE_PROFILE_STR_CCS_HWPROFILE</a>);
01029     InitializeObjectAttributes (&amp;attributes,
01030                                 &amp;name,
01031                                 OBJ_CASE_INSENSITIVE,
01032                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01033                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01034     status = ZwOpenKey (&amp;parent, KEY_READ, &amp;attributes);
01035     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
01036         parent = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01037         <span class="keywordflow">goto</span> Clean;
01038     }
01039 
01040     <span class="comment">//</span>
01041     <span class="comment">// How did we get here?</span>
01042     <span class="comment">//</span>
01043     flags = ProfileList-&gt;<a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html#o2">Profile</a>[selectedElement].<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html#o4">Flags</a>;
01044     profileNum = ProfileList-&gt;<a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html#o2">Profile</a>[selectedElement].<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html#o3">Id</a>;
01045 
01046     <span class="comment">//</span>
01047     <span class="comment">// Check for duplicate</span>
01048     <span class="comment">//</span>
01049     <span class="keywordflow">if</span> (flags &amp; <a class="code" href="../../d1/d2/cmp_8h.html#a150">CM_HP_FLAGS_DUPLICATE</a>) {
01050         <span class="comment">//</span>
01051         <span class="comment">// If there is a duplicate then we need to adjust the pnp</span>
01052         <span class="comment">// bios alias table.</span>
01053         <span class="comment">//</span>
01054         <span class="comment">// This happens if we booted PnP bios detected docked, and then</span>
01055         <span class="comment">// we received a set state for ACPI as docked, then we have the</span>
01056         <span class="comment">// potential for duplicates.  See Comment in CmpFilterAcpiDockingState</span>
01057         <span class="comment">// for details.</span>
01058         <span class="comment">//</span>
01059         <span class="comment">// We need to find any pnp bios alias entries that match the current</span>
01060         <span class="comment">// state and point them to the duplicate entry.</span>
01061         <span class="comment">//</span>
01062 
01063         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (flags &amp; <a class="code" href="../../d1/d2/cmp_8h.html#a148">CM_HP_FLAGS_TRUE_MATCH</a>);
01064         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (!(flags &amp; <a class="code" href="../../d1/d2/cmp_8h.html#a149">CM_HP_FLAGS_PRISTINE</a>));
01065 
01066         status = <a class="code" href="../../d6/d2/hwprofil_8c.html#a4">CmpMoveBiosAliasTable</a> (IDConfigDB,
01067                                         currentInfo,
01068                                         currentProfileNumber,
01069                                         profileNum,
01070                                         nameBuffer,
01071                                         valueBuffer,
01072                                         <span class="keyword">sizeof</span> (valueBuffer));
01073 
01074         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
01075             <span class="keywordflow">goto</span> Clean;
01076         }
01077     }
01078 
01079     <span class="keywordflow">if</span> ((flags &amp; <a class="code" href="../../d1/d2/cmp_8h.html#a149">CM_HP_FLAGS_PRISTINE</a>) || (profileNum != currentProfileNumber)){
01080         <span class="comment">//</span>
01081         <span class="comment">// The profile Number Changed or will change.</span>
01082         <span class="comment">//</span>
01083         *ProfileChanged = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01084 
01085         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (currentInfo);
01086         ZwClose (currentInfo);
01087         currentInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01088 
01089         <span class="keywordflow">if</span> (flags &amp; <a class="code" href="../../d1/d2/cmp_8h.html#a149">CM_HP_FLAGS_PRISTINE</a>) {
01090             <span class="comment">//</span>
01091             <span class="comment">// If the selected profile is pristine then we need to clone.</span>
01092             <span class="comment">//</span>
01093             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (!(flags &amp; <a class="code" href="../../d1/d2/cmp_8h.html#a148">CM_HP_FLAGS_TRUE_MATCH</a>));
01094             status = <a class="code" href="../../d6/d2/hwprofil_8c.html#a7">CmpCloneHwProfile</a> (IDConfigDB,
01095                                         parent,
01096                                         HardwareProfile,
01097                                         profileNum,
01098                                         NewDockState-&gt;DockingState,
01099                                         &amp;HardwareProfile,
01100                                         &amp;profileNum);
01101             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
01102                 HardwareProfile = 0;
01103                 <span class="keywordflow">goto</span> Clean;
01104             }
01105         } <span class="keywordflow">else</span> {
01106             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (HardwareProfile);
01107             ZwClose (HardwareProfile);
01108 
01109             <span class="comment">//</span>
01110             <span class="comment">// Open the new profile</span>
01111             <span class="comment">//</span>
01112             swprintf (nameBuffer, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"%04d\0"</span>, profileNum);
01113             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, nameBuffer);
01114             InitializeObjectAttributes (&amp;attributes,
01115                                         &amp;name,
01116                                         OBJ_CASE_INSENSITIVE,
01117                                         parent,
01118                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01119             status = ZwOpenKey (&amp;HardwareProfile, KEY_READ, &amp;attributes);
01120             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
01121                 HardwareProfile = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01122                 <span class="keywordflow">goto</span> Clean;
01123             }
01124         }
01125 
01126         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (currentProfileNumber != profileNum);
01127 
01128         <span class="comment">//</span>
01129         <span class="comment">// Open the current info for the profile.</span>
01130         <span class="comment">//</span>
01131         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, <a class="code" href="../../d1/d2/cmp_8h.html#a142">CM_HARDWARE_PROFILE_STR_CURRENT_DOCK_INFO</a>);
01132         InitializeObjectAttributes (&amp;attributes,
01133                                     &amp;name,
01134                                     OBJ_CASE_INSENSITIVE,
01135                                     IDConfigDB,
01136                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01137 
01138         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a> (&amp;currentInfo,
01139                               KEY_READ | KEY_WRITE,
01140                               &amp;attributes,
01141                               0,
01142                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01143                               REG_OPTION_VOLATILE,
01144                               &amp;disposition);
01145 
01146         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
01147             currentInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01148             <span class="keywordflow">goto</span> Clean;
01149         }
01150 
01151         <span class="comment">//</span>
01152         <span class="comment">// Set CurrentConfig in the Database</span>
01153         <span class="comment">//</span>
01154         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;name, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"CurrentConfig"</span>);
01155         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(IDConfigDB,
01156                                  &amp;name,
01157                                  0,
01158                                  REG_DWORD,
01159                                  &amp;profileNum,
01160                                  <span class="keyword">sizeof</span> (profileNum));
01161 
01162          <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01163             status = STATUS_REGISTRY_CORRUPT;
01164             <span class="keywordflow">goto</span> Clean;
01165         }
01166     }
01167 
01168     <span class="comment">//</span>
01169     <span class="comment">// Write the new Docking State to the current Info key</span>
01170     <span class="comment">//</span>
01171     i = NewDockState-&gt;DockingState;
01172     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, <a class="code" href="../../d1/d2/cmp_8h.html#a131">CM_HARDWARE_PROFILE_STR_DOCKING_STATE</a>);
01173     status = ZwSetValueKey (currentInfo,
01174                             &amp;name,
01175                             0,
01176                             REG_DWORD,
01177                             &amp;i,
01178                             <span class="keyword">sizeof</span> (ULONG));
01179 
01180     <span class="comment">//</span>
01181     <span class="comment">// Write the new ACPI information to the current Info key</span>
01182     <span class="comment">//</span>
01183     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, <a class="code" href="../../d1/d2/cmp_8h.html#a135">CM_HARDWARE_PROFILE_STR_ACPI_SERIAL_NUMBER</a>);
01184     status = ZwSetValueKey (currentInfo,
01185                             &amp;name,
01186                             0,
01187                             REG_BINARY,
01188                             NewDockState-&gt;SerialNumber,
01189                             NewDockState-&gt;SerialLength);
01190 
01191     <span class="keywordflow">if</span> (!(flags &amp; <a class="code" href="../../d1/d2/cmp_8h.html#a148">CM_HP_FLAGS_TRUE_MATCH</a>)) {
01192         <span class="comment">//</span>
01193         <span class="comment">// Add the alias entry for this profile.</span>
01194         <span class="comment">//</span>
01195         status = <a class="code" href="../../d6/d2/hwprofil_8c.html#a5">CmpAddAcpiAliasEntry</a> (IDConfigDB,
01196                                        NewDockState,
01197                                        profileNum,
01198                                        nameBuffer,
01199                                        valueBuffer,
01200                                        <span class="keyword">sizeof</span> (valueBuffer),
01201                                        <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>); <span class="comment">// Don't Prevent Duplication</span>
01202     }
01203 
01204     <span class="keywordflow">if</span> (profileNum != currentProfileNumber) {
01205         <span class="comment">//</span>
01206         <span class="comment">// Move the symbolic link.</span>
01207         <span class="comment">//</span>
01208         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;name, <a class="code" href="../../d1/d2/cmp_8h.html#a127">CM_HARDWARE_PROFILE_STR_CCS_CURRENT</a>);
01209         InitializeObjectAttributes(&amp;attributes,
01210                                    &amp;name,
01211                                    OBJ_CASE_INSENSITIVE | OBJ_OPENLINK,
01212                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01213                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01214 
01215         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a>(&amp;currentSymLink,
01216                              KEY_CREATE_LINK,
01217                              &amp;attributes,
01218                              0,
01219                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01220                              REG_OPTION_OPEN_LINK,
01221                              &amp;disposition);
01222 
01223         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (STATUS_SUCCESS == status);
01224         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (REG_OPENED_EXISTING_KEY == disposition);
01225 
01226         swprintf (nameBuffer,
01227                   <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Hardware Profiles\\%04d"</span>,
01228                   profileNum);
01229         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, nameBuffer);
01230         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a> (currentSymLink,
01231                                 &amp;<a class="code" href="../../d8/d9/cmapi_8c.html#a6">CmSymbolicLinkValueName</a>,
01232                                 0,
01233                                 REG_LINK,
01234                                 name.Buffer,
01235                                 name.Length);
01236 
01237         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (STATUS_SUCCESS == status);
01238     }
01239 
01240 
01241 Clean:
01242     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
01243         <span class="comment">// NB more process required is not a success code.</span>
01244         *NewProfile = HardwareProfile;
01245     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> != HardwareProfile) {
01246         ZwClose (HardwareProfile);
01247     }
01248 
01249     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> != IDConfigDB) {
01250         ZwClose (IDConfigDB);
01251     }
01252     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> != currentInfo) {
01253         ZwClose (currentInfo);
01254     }
01255     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> != parent) {
01256         ZwClose (parent);
01257     }
01258     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> != currentAcpiSN) {
01259         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (currentAcpiSN);
01260     }
01261     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> != ProfileList) {
01262         <span class="keywordflow">for</span> (i = 0; i &lt; ProfileList-&gt;<a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html#o1">CurrentProfileCount</a>; i++) {
01263             <span class="keywordflow">if</span> (ProfileList-&gt;<a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html#o2">Profile</a>[i].<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html#o1">FriendlyName</a>) {
01264                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ProfileList-&gt;<a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html#o2">Profile</a>[i].<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html#o1">FriendlyName</a>);
01265             }
01266         }
01267         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ProfileList);
01268     }
01269     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> != AliasList) {
01270         <span class="keywordflow">for</span> (i = 0; i &lt; AliasList-&gt;<a class="code" href="../../d7/d3/struct__CM__HARDWARE__PROFILE__ACPI__ALIAS__LIST.html#o1">CurrentAliasCount</a>; i++) {
01271             <span class="keywordflow">if</span> (AliasList-&gt;<a class="code" href="../../d7/d3/struct__CM__HARDWARE__PROFILE__ACPI__ALIAS__LIST.html#o2">Alias</a>[i].<a class="code" href="../../d6/d3/struct__CM__HARDWARE__PROFILE__ACPI__ALIAS.html#o3">SerialNumber</a>) {
01272                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (AliasList-&gt;<a class="code" href="../../d7/d3/struct__CM__HARDWARE__PROFILE__ACPI__ALIAS__LIST.html#o2">Alias</a>[i].<a class="code" href="../../d6/d3/struct__CM__HARDWARE__PROFILE__ACPI__ALIAS.html#o3">SerialNumber</a>);
01273             }
01274         }
01275         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (AliasList);
01276     }
01277 
01278     <span class="keywordflow">return</span> status;
01279 }
01280 
01281 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01282"></a><a class="code" href="../../d6/d2/hwprofil_8c.html#a3">01282</a> <a class="code" href="../../d6/d2/hwprofil_8c.html#a3">CmpFilterAcpiDockingState</a> (
01283     IN     <a class="code" href="../../d9/d0/struct__PROFILE__ACPI__DOCKING__STATE.html">PPROFILE_ACPI_DOCKING_STATE</a>  NewDockingState,
01284     IN     ULONG                        CurrentDockState,
01285     IN     PWCHAR                       CurrentAcpiSN,
01286     IN     ULONG                        CurrentProfileNumber,
01287     IN OUT <a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html">PCM_HARDWARE_PROFILE_LIST</a>    ProfileList,
01288     IN OUT <a class="code" href="../../d7/d3/struct__CM__HARDWARE__PROFILE__ACPI__ALIAS__LIST.html">PCM_HARDWARE_PROFILE_ACPI_ALIAS_LIST</a> AliasList
01289     )
01290 <span class="comment">/*++</span>
01291 <span class="comment">Routine Description:</span>
01292 <span class="comment">    Given the new state of things and the current state of things,</span>
01293 <span class="comment">    prune the given list of profiles.</span>
01294 <span class="comment"></span>
01295 <span class="comment">--*/</span>
01296 {
01297     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status = STATUS_SUCCESS;
01298     ULONG i = 0;
01299     ULONG j;
01300     ULONG len;
01301     ULONG mask = <a class="code" href="../../d6/d7/profiles_8h.html#a6">HW_PROFILE_DOCKSTATE_UNDOCKED</a> | <a class="code" href="../../d6/d7/profiles_8h.html#a7">HW_PROFILE_DOCKSTATE_DOCKED</a>;
01302     ULONG flags;
01303     <a class="code" href="../../d6/d3/struct__CM__HARDWARE__PROFILE__ACPI__ALIAS.html">PCM_HARDWARE_PROFILE_ACPI_ALIAS</a> alias;
01304     BOOLEAN trueMatch = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01305     BOOLEAN dupDetect = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01306     BOOLEAN currentListed = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01307     BOOLEAN keepCurrent = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01308 
01309     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a> ();
01310 
01311     <span class="comment">//</span>
01312     <span class="comment">// Check for duplicate:</span>
01313     <span class="comment">//</span>
01314     <span class="comment">// If the user boots undocked, and then hot docks.  We will generate</span>
01315     <span class="comment">// a profile alias for the pnp reported undocked state [A], and one for the</span>
01316     <span class="comment">// ACPI reported docked state [B}.  If the use subsequently reboots docked,</span>
01317     <span class="comment">// then we will create a third pnp reported docked state [C] profile alias.</span>
01318     <span class="comment">// {C] is really a duplicate of [B}, but we wont know this until such time</span>
01319     <span class="comment">// as the ACPI state for {B] is reported.</span>
01320     <span class="comment">//</span>
01321     <span class="comment">// The same can happen for undocked scenerios.</span>
01322     <span class="comment">//</span>
01323     <span class="comment">// Detection: If the Current Dock State is the same as</span>
01324     <span class="comment">// NewDockingState.DockingState then there is a potential for a duplicate.</span>
01325     <span class="comment">// In order to also have a duplicate we must have an acpi already pointing</span>
01326     <span class="comment">// to a profile different than the current one.</span>
01327     <span class="comment">// This must also be the first ACPI change since we booted, therefore</span>
01328     <span class="comment">// CurrentAcpiSn Should be Zero.</span>
01329     <span class="comment">// In other words there must be at least one true match and none of the</span>
01330     <span class="comment">// true matches can point to the current profile.</span>
01331     <span class="comment">//</span>
01332 
01333     <span class="keywordflow">if</span> (AliasList) {
01334         <span class="keywordflow">while</span> (i &lt; AliasList-&gt;CurrentAliasCount) {
01335             alias = &amp;AliasList-&gt;Alias[i];
01336 
01337             <span class="keywordflow">if</span> (((alias-&gt;<a class="code" href="../../d6/d3/struct__CM__HARDWARE__PROFILE__ACPI__ALIAS.html#o1">DockState</a> &amp; mask) != 0) &amp;&amp;
01338                 ((alias-&gt;<a class="code" href="../../d6/d3/struct__CM__HARDWARE__PROFILE__ACPI__ALIAS.html#o1">DockState</a> &amp; mask) !=
01339                  (NewDockingState-&gt;DockingState &amp; mask))) {
01340 
01341                 <span class="comment">//</span>
01342                 <span class="comment">// This alias claims to be docked or undocked, but does not</span>
01343                 <span class="comment">// match the current state.  Therefore skip it.</span>
01344                 <span class="comment">//</span>
01345                 ;
01346 
01347             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (alias-&gt;<a class="code" href="../../d6/d3/struct__CM__HARDWARE__PROFILE__ACPI__ALIAS.html#o2">SerialLength</a> != NewDockingState-&gt;SerialLength) {
01348                 <span class="comment">//</span>
01349                 <span class="comment">// This alias has an incompatible serial number</span>
01350                 <span class="comment">//</span>
01351                 ;
01352 
01353             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (alias-&gt;<a class="code" href="../../d6/d3/struct__CM__HARDWARE__PROFILE__ACPI__ALIAS.html#o2">SerialLength</a> ==
01354                        RtlCompareMemory (NewDockingState-&gt;SerialNumber,
01355                                          alias-&gt;<a class="code" href="../../d6/d3/struct__CM__HARDWARE__PROFILE__ACPI__ALIAS.html#o3">SerialNumber</a>,
01356                                          alias-&gt;<a class="code" href="../../d6/d3/struct__CM__HARDWARE__PROFILE__ACPI__ALIAS.html#o2">SerialLength</a>)) {
01357                 <span class="comment">//</span>
01358                 <span class="comment">// NB RtlCompareMemory can work with zero length memory</span>
01359                 <span class="comment">// addresses.  This is a requirement here.</span>
01360                 <span class="comment">//</span>
01361 
01362 
01363 
01364                 <span class="comment">//</span>
01365                 <span class="comment">// This alias matches so mark the profile.</span>
01366                 <span class="comment">//</span>
01367                 <span class="keywordflow">for</span> (j = 0; j &lt; ProfileList-&gt;CurrentProfileCount; j++) {
01368                     <span class="keywordflow">if</span> (ProfileList-&gt;Profile[j].Id == alias-&gt;<a class="code" href="../../d6/d3/struct__CM__HARDWARE__PROFILE__ACPI__ALIAS.html#o0">ProfileNumber</a>) {
01369 
01370                         <span class="comment">//</span>
01371                         <span class="comment">// Alias entries should never point to a pristine profile</span>
01372                         <span class="comment">//</span>
01373                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (!(ProfileList-&gt;Profile[j].Flags &amp;
01374                                   <a class="code" href="../../d1/d2/cmp_8h.html#a149">CM_HP_FLAGS_PRISTINE</a>));
01375 
01376                         ProfileList-&gt;Profile[j].Flags |= <a class="code" href="../../d1/d2/cmp_8h.html#a148">CM_HP_FLAGS_TRUE_MATCH</a>;
01377                         trueMatch = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01378                     }
01379                     <span class="keywordflow">if</span> ((CurrentDockState == NewDockingState-&gt;DockingState) &amp;&amp;
01380                         (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> == CurrentAcpiSN)) {
01381                         <span class="comment">//</span>
01382                         <span class="comment">// The dock state did not change during this acpi</span>
01383                         <span class="comment">// event; therefore, we might just have a duplicate</span>
01384                         <span class="comment">// on our hands.</span>
01385                         <span class="comment">//</span>
01386                         dupDetect = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01387                     }
01388                     <span class="keywordflow">if</span> (alias-&gt;<a class="code" href="../../d6/d3/struct__CM__HARDWARE__PROFILE__ACPI__ALIAS.html#o0">ProfileNumber</a> == CurrentProfileNumber) {
01389                         <span class="comment">//</span>
01390                         <span class="comment">// There exists an entry in the acpi alias table that</span>
01391                         <span class="comment">// if chosen would result in no change of Hardware</span>
01392                         <span class="comment">// Profile.  Therefore, we should chose this one, and</span>
01393                         <span class="comment">// ignore the duplicate.</span>
01394                         <span class="comment">//</span>
01395                         currentListed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01396                     }
01397                 }
01398             }
01399             i++;
01400         }
01401     }
01402 
01403     <span class="keywordflow">if</span> ((!dupDetect) &amp;&amp;
01404         (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> == CurrentAcpiSN) &amp;&amp;
01405         (!trueMatch) &amp;&amp;
01406         (CurrentDockState == NewDockingState-&gt;DockingState)) {
01407 
01408         <span class="comment">//</span>
01409         <span class="comment">// (1) The docking state did not change,</span>
01410         <span class="comment">// (2) the current profile has not yet, on this boot, been marked with</span>
01411         <span class="comment">//     an ACPI serial number.</span>
01412         <span class="comment">// (3) There was no Alias match.</span>
01413         <span class="comment">//</span>
01414         <span class="comment">// Therefore we should keep the current profile regardless of it being</span>
01415         <span class="comment">// aliasable.</span>
01416         <span class="comment">//</span>
01417 
01418         keepCurrent = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01419         trueMatch = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;  <span class="comment">// prevent pristine from being listed.</span>
01420     }
01421 
01422     i = 0;
01423     <span class="keywordflow">while</span> (i &lt; ProfileList-&gt;CurrentProfileCount) {
01424 
01425         flags = ProfileList-&gt;Profile[i].Flags;
01426 
01427         <span class="keywordflow">if</span> (dupDetect) {
01428             <span class="keywordflow">if</span> (flags &amp; <a class="code" href="../../d1/d2/cmp_8h.html#a148">CM_HP_FLAGS_TRUE_MATCH</a>) {
01429                 <span class="keywordflow">if</span> (currentListed) {
01430                     <span class="keywordflow">if</span> (ProfileList-&gt;Profile[i].Id == CurrentProfileNumber) {
01431                         <span class="comment">//</span>
01432                         <span class="comment">// Let this one live.  This results in no change of</span>
01433                         <span class="comment">// profile number.</span>
01434                         <span class="comment">//</span>
01435                         i++;
01436                         <span class="keywordflow">continue</span>;
01437                     }
01438                     <span class="comment">//</span>
01439                     <span class="comment">// Bounce any true matches that do not result in no change</span>
01440                     <span class="comment">// of profile.</span>
01441                     <span class="comment">//</span>
01442                     ;
01443 
01444                 } <span class="keywordflow">else</span> {
01445                     <span class="comment">//</span>
01446                     <span class="comment">// We did not find the current one listed so we definately</span>
01447                     <span class="comment">// have a duplicate.</span>
01448                     <span class="comment">//</span>
01449                     <span class="comment">// Mark it as such. and list it live.</span>
01450                     <span class="comment">//</span>
01451                     ProfileList-&gt;Profile[i].Flags |= <a class="code" href="../../d1/d2/cmp_8h.html#a150">CM_HP_FLAGS_DUPLICATE</a>;
01452                     i++;
01453                     <span class="keywordflow">continue</span>;
01454                 }
01455             }
01456             <span class="comment">//</span>
01457             <span class="comment">// Bounce all non True matches in a duplicate detected situation.</span>
01458             <span class="comment">//</span>
01459             ;
01460 
01461         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((flags &amp; <a class="code" href="../../d1/d2/cmp_8h.html#a149">CM_HP_FLAGS_PRISTINE</a>) &amp;&amp; !trueMatch) {
01462             <span class="comment">//</span>
01463             <span class="comment">// Leave this one in the list</span>
01464             <span class="comment">//</span>
01465             i++;
01466             <span class="keywordflow">continue</span>;
01467 
01468         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (flags &amp; <a class="code" href="../../d1/d2/cmp_8h.html#a147">CM_HP_FLAGS_ALIASABLE</a>) {
01469             <span class="comment">//</span>
01470             <span class="comment">// Leave this one in the list</span>
01471             <span class="comment">//</span>
01472             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (! (flags &amp; <a class="code" href="../../d1/d2/cmp_8h.html#a149">CM_HP_FLAGS_PRISTINE</a>));
01473             i++;
01474             <span class="keywordflow">continue</span>;
01475 
01476         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (flags &amp; <a class="code" href="../../d1/d2/cmp_8h.html#a148">CM_HP_FLAGS_TRUE_MATCH</a>) {
01477             <span class="comment">//</span>
01478             <span class="comment">// Leave this one in the list</span>
01479             <span class="comment">//</span>
01480             i++;
01481             <span class="keywordflow">continue</span>;
01482 
01483         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (keepCurrent &amp;&amp;
01484                    (ProfileList-&gt;Profile[i].Id == CurrentProfileNumber)) {
01485             <span class="comment">//</span>
01486             <span class="comment">// Leave this one in the list</span>
01487             <span class="comment">//</span>
01488             i++;
01489             <span class="keywordflow">continue</span>;
01490         }
01491 
01492         <span class="comment">//</span>
01493         <span class="comment">// discard this profile by (1) shifting remaining profiles in</span>
01494         <span class="comment">//   array to fill in the space of this discarded profile</span>
01495         <span class="comment">//   and (2) decrementing profile count</span>
01496         <span class="comment">//</span>
01497         len = ProfileList-&gt;CurrentProfileCount - i - 1;
01498         <span class="keywordflow">if</span> (0 &lt; len) {
01499             RtlMoveMemory(&amp;ProfileList-&gt;Profile[i],
01500                           &amp;ProfileList-&gt;Profile[i+1],
01501                           <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html">CM_HARDWARE_PROFILE</a>) * len);
01502         }
01503 
01504         --ProfileList-&gt;CurrentProfileCount;
01505     }
01506 
01507     <span class="keywordflow">return</span> status;
01508 }
01509 
01510 
01511 
01512 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01513"></a><a class="code" href="../../d6/d2/hwprofil_8c.html#a4">01513</a> <a class="code" href="../../d6/d2/hwprofil_8c.html#a4">CmpMoveBiosAliasTable</a> (
01514     IN HANDLE   IDConfigDB,
01515     IN HANDLE   CurrentInfo,
01516     IN ULONG    CurrentProfileNumber,
01517     IN ULONG    NewProfileNumber,
01518     IN PWCHAR   nameBuffer,
01519     IN PCHAR    valueBuffer,
01520     IN ULONG    bufferLen
01521     )
01522 <span class="comment">/*++</span>
01523 <span class="comment">Routine Description:</span>
01524 <span class="comment">    Search the Alias table for bios entries which match the current</span>
01525 <span class="comment">    docking state, and point from current profile number to new profile number.</span>
01526 <span class="comment"></span>
01527 <span class="comment"></span>
01528 <span class="comment">    Assumption: If the profile is cloned (therefore created by</span>
01529 <span class="comment">    CmpCloneHwProfile, and we have just moved the bios table to point</span>
01530 <span class="comment">    away from this entry, then we *should* be able to safely delete</span>
01531 <span class="comment">    the old hardware profile key.</span>
01532 <span class="comment">    (in both IDConfigDB\HardwareProfiles and CCS\HardwareProfiles</span>
01533 <span class="comment"></span>
01534 <span class="comment"></span>
01535 <span class="comment">--*/</span>
01536 {
01537     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>        status = STATUS_SUCCESS;
01538     HANDLE          alias = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01539     HANDLE          entry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01540     HANDLE          hwprofile = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01541     UNICODE_STRING  name;
01542     ULONG           currentDockId;
01543     ULONG           currentSerialNumber;
01544     ULONG           len;
01545     ULONG           i;
01546     OBJECT_ATTRIBUTES           attributes;
01547     KEY_FULL_INFORMATION        keyInfo;
01548     PKEY_BASIC_INFORMATION      basicInfo;
01549     PKEY_VALUE_FULL_INFORMATION value;
01550 
01551     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a> ();
01552 
01553     value = (PKEY_VALUE_FULL_INFORMATION) valueBuffer;
01554     basicInfo = (PKEY_BASIC_INFORMATION) valueBuffer;
01555 
01556     <span class="comment">//</span>
01557     <span class="comment">// Extract the current Serial Number and DockID</span>
01558     <span class="comment">//</span>
01559     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, <a class="code" href="../../d1/d2/cmp_8h.html#a134">CM_HARDWARE_PROFILE_STR_SERIAL_NUMBER</a>);
01560     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(CurrentInfo,
01561                              &amp;name,
01562                              KeyValueFullInformation,
01563                              valueBuffer,
01564                              bufferLen,
01565                              &amp;len);
01566     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status) || (value-&gt;Type != REG_DWORD)) {
01567         status = STATUS_REGISTRY_CORRUPT;
01568         <span class="keywordflow">goto</span> Clean;
01569     }
01570     currentSerialNumber = * (PULONG) ((PUCHAR) value + value-&gt;DataOffset);
01571 
01572     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, <a class="code" href="../../d1/d2/cmp_8h.html#a133">CM_HARDWARE_PROFILE_STR_DOCKID</a>);
01573     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(CurrentInfo,
01574                              &amp;name,
01575                              KeyValueFullInformation,
01576                              valueBuffer,
01577                              bufferLen,
01578                              &amp;len);
01579     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status) || (value-&gt;Type != REG_DWORD)) {
01580         status = STATUS_REGISTRY_CORRUPT;
01581         <span class="keywordflow">goto</span> Clean;
01582     }
01583     currentDockId = * (PULONG) ((PUCHAR) value + value-&gt;DataOffset);
01584 
01585     <span class="comment">//</span>
01586     <span class="comment">// Open a handle to the Alias information</span>
01587     <span class="comment">//</span>
01588     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, <a class="code" href="../../d1/d2/cmp_8h.html#a128">CM_HARDWARE_PROFILE_STR_ALIAS</a>);
01589     InitializeObjectAttributes (&amp;attributes,
01590                                 &amp;name,
01591                                 OBJ_CASE_INSENSITIVE,
01592                                 IDConfigDB,
01593                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01594     status = ZwOpenKey (&amp;alias,
01595                         KEY_READ,
01596                         &amp;attributes);
01597 
01598     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
01599         <span class="comment">//</span>
01600         <span class="comment">// So we don't have an alias table.  This is ok, albeit a bit strange</span>
01601         <span class="comment">//</span>
01602         status = STATUS_SUCCESS;
01603         alias = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01604         <span class="keywordflow">goto</span> Clean;
01605     }
01606 
01607 
01608     status = ZwQueryKey (alias,
01609                          KeyFullInformation,
01610                          &amp;keyInfo,
01611                          <span class="keyword">sizeof</span> (keyInfo),
01612                          &amp;len);
01613 
01614     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
01615         <span class="keywordflow">goto</span> Clean;
01616     }
01617     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (0 &lt; keyInfo.SubKeys);
01618 
01619     <span class="comment">//</span>
01620     <span class="comment">// Iterrate the alias entries</span>
01621     <span class="comment">//</span>
01622     <span class="keywordflow">for</span> (i = 0; i &lt; keyInfo.SubKeys; i++) {
01623 
01624         <span class="comment">//</span>
01625         <span class="comment">// Get the first key in the list.</span>
01626         <span class="comment">//</span>
01627         status = ZwEnumerateKey (alias,
01628                                  i,
01629                                  KeyBasicInformation,
01630                                  basicInfo,
01631                                  bufferLen - <span class="keyword">sizeof</span> (UNICODE_NULL), <span class="comment">// term 0</span>
01632                                  &amp;len);
01633 
01634         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
01635             <span class="comment">//</span>
01636             <span class="comment">// This should never happen.</span>
01637             <span class="comment">//</span>
01638             <span class="keywordflow">break</span>;
01639         }
01640 
01641         basicInfo-&gt;Name [basicInfo-&gt;NameLength/<span class="keyword">sizeof</span>(WCHAR)] = 0;
01642         name.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) basicInfo-&gt;NameLength;
01643         name.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) basicInfo-&gt;NameLength + <span class="keyword">sizeof</span> (UNICODE_NULL);
01644         name.Buffer = basicInfo-&gt;Name;
01645 
01646         InitializeObjectAttributes (&amp;attributes,
01647                                     &amp;name,
01648                                     OBJ_CASE_INSENSITIVE,
01649                                     alias,
01650                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01651         status = ZwOpenKey (&amp;entry,
01652                             KEY_READ | KEY_WRITE,
01653                             &amp;attributes);
01654         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
01655             <span class="keywordflow">break</span>;
01656         }
01657 
01658         <span class="comment">//</span>
01659         <span class="comment">// Extract The Profile number to which this alias refers.</span>
01660         <span class="comment">//</span>
01661         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, <a class="code" href="../../d1/d2/cmp_8h.html#a136">CM_HARDWARE_PROFILE_STR_PROFILE_NUMBER</a>);
01662         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(entry,
01663                                  &amp;name,
01664                                  KeyValueFullInformation,
01665                                  valueBuffer,
01666                                  bufferLen,
01667                                  &amp;len);
01668 
01669         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status) || (value-&gt;Type != REG_DWORD)) {
01670             status = STATUS_REGISTRY_CORRUPT;
01671             <span class="keywordflow">goto</span> Clean;
01672         }
01673 
01674         <span class="keywordflow">if</span> (CurrentProfileNumber != *(PULONG)((PUCHAR)value + value-&gt;DataOffset)) {
01675 
01676             <span class="comment">//</span>
01677             <span class="comment">// Not a match</span>
01678             <span class="comment">//</span>
01679             ZwClose (entry);
01680             entry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01681             <span class="keywordflow">continue</span>;
01682         }
01683 
01684         <span class="comment">//</span>
01685         <span class="comment">// Compare the Dock ID</span>
01686         <span class="comment">//</span>
01687         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, <a class="code" href="../../d1/d2/cmp_8h.html#a133">CM_HARDWARE_PROFILE_STR_DOCKID</a>);
01688         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(entry,
01689                                  &amp;name,
01690                                  KeyValueFullInformation,
01691                                  valueBuffer,
01692                                  bufferLen,
01693                                  &amp;len);
01694         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status) || (value-&gt;Type != REG_DWORD)) {
01695             status = STATUS_REGISTRY_CORRUPT;
01696             <span class="keywordflow">goto</span> Clean;
01697         }
01698         <span class="keywordflow">if</span> (currentDockId != * (PULONG) ((PUCHAR) value + value-&gt;DataOffset)) {
01699             <span class="comment">//</span>
01700             <span class="comment">// Not a match</span>
01701             <span class="comment">//</span>
01702             ZwClose (entry);
01703             entry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01704             <span class="keywordflow">continue</span>;
01705         }
01706 
01707         <span class="comment">//</span>
01708         <span class="comment">// Compare the SerialNumber</span>
01709         <span class="comment">//</span>
01710         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, <a class="code" href="../../d1/d2/cmp_8h.html#a134">CM_HARDWARE_PROFILE_STR_SERIAL_NUMBER</a>);
01711         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(entry,
01712                                  &amp;name,
01713                                  KeyValueFullInformation,
01714                                  valueBuffer,
01715                                  bufferLen,
01716                                  &amp;len);
01717         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status) || (value-&gt;Type != REG_DWORD)) {
01718             status = STATUS_REGISTRY_CORRUPT;
01719             <span class="keywordflow">goto</span> Clean;
01720         }
01721         <span class="keywordflow">if</span> (currentSerialNumber != *(PULONG)((PUCHAR)value + value-&gt;DataOffset)) {
01722             <span class="comment">//</span>
01723             <span class="comment">// Not a match</span>
01724             <span class="comment">//</span>
01725             ZwClose (entry);
01726             entry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01727             <span class="keywordflow">continue</span>;
01728         }
01729 
01730         <span class="comment">//</span>
01731         <span class="comment">// This must be a match.</span>
01732         <span class="comment">// move the profile number</span>
01733         <span class="comment">//</span>
01734 
01735         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, <a class="code" href="../../d1/d2/cmp_8h.html#a136">CM_HARDWARE_PROFILE_STR_PROFILE_NUMBER</a>);
01736         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a> (entry,
01737                                 &amp;name,
01738                                 0,
01739                                 REG_DWORD,
01740                                 &amp;NewProfileNumber,
01741                                 <span class="keyword">sizeof</span> (NewProfileNumber));
01742 
01743         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (STATUS_SUCCESS == status);
01744 
01745         ZwClose (entry);
01746         entry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01747 
01748         <span class="comment">//</span>
01749         <span class="comment">// We most likely have left a dangling profile here.</span>
01750         <span class="comment">// Try to attempt to clean it up.</span>
01751         <span class="comment">//</span>
01752         <span class="comment">// If this profile is cloned then we created it and can therefore</span>
01753         <span class="comment">// get rid of it.</span>
01754         <span class="comment">//</span>
01755 
01756         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, <a class="code" href="../../d1/d2/cmp_8h.html#a130">CM_HARDWARE_PROFILE_STR_HARDWARE_PROFILES</a>);
01757         InitializeObjectAttributes (&amp;attributes,
01758                                     &amp;name,
01759                                     OBJ_CASE_INSENSITIVE,
01760                                     IDConfigDB,
01761                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01762         status = ZwOpenKey (&amp;hwprofile, KEY_READ | KEY_WRITE, &amp;attributes);
01763         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
01764             hwprofile = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01765             status = STATUS_REGISTRY_CORRUPT;
01766             <span class="keywordflow">goto</span> Clean;
01767         }
01768 
01769         swprintf (nameBuffer, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"%04d\0"</span>, CurrentProfileNumber);
01770         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, nameBuffer);
01771         InitializeObjectAttributes (&amp;attributes,
01772                                     &amp;name,
01773                                     OBJ_CASE_INSENSITIVE,
01774                                     hwprofile,
01775                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01776         status = ZwOpenKey (&amp;entry, KEY_ALL_ACCESS, &amp;attributes);
01777         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
01778             entry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01779             status = STATUS_REGISTRY_CORRUPT;
01780             <span class="keywordflow">goto</span> Clean;
01781         }
01782 
01783         <span class="comment">//</span>
01784         <span class="comment">// Test for the Cloned Bit.</span>
01785         <span class="comment">//</span>
01786 
01787         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, <a class="code" href="../../d1/d2/cmp_8h.html#a138">CM_HARDWARE_PROFILE_STR_CLONED</a>);
01788         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(entry,
01789                                  &amp;name,
01790                                  KeyValueFullInformation,
01791                                  valueBuffer,
01792                                  bufferLen,
01793                                  &amp;len);
01794 
01795         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status) || (value-&gt;Type != REG_DWORD)) {
01796             status = STATUS_REGISTRY_CORRUPT;
01797             <span class="keywordflow">goto</span> Clean;
01798         }
01799 
01800         <span class="keywordflow">if</span> (*(PULONG)((PUCHAR)value + value-&gt;DataOffset)) {
01801             <span class="comment">//</span>
01802             <span class="comment">// We cloned this one.</span>
01803             <span class="comment">//</span>
01804             status = ZwDeleteKey (entry);
01805             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status));
01806 
01807             ZwClose (entry);
01808             ZwClose (hwprofile);
01809             entry = hwprofile = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01810 
01811             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, <a class="code" href="../../d1/d2/cmp_8h.html#a126">CM_HARDWARE_PROFILE_STR_CCS_HWPROFILE</a>);
01812             InitializeObjectAttributes (&amp;attributes,
01813                                         &amp;name,
01814                                         OBJ_CASE_INSENSITIVE,
01815                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01816                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01817             status = ZwOpenKey (&amp;hwprofile, KEY_READ | KEY_WRITE, &amp;attributes);
01818             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
01819                 hwprofile = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01820                 status = STATUS_REGISTRY_CORRUPT;
01821                 <span class="keywordflow">goto</span> Clean;
01822             }
01823 
01824             swprintf (nameBuffer, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"%04d\0"</span>, CurrentProfileNumber);
01825 
01826             status = <a class="code" href="../../d6/d2/hwprofil_8c.html#a1">CmDeleteKeyRecursive</a> (hwprofile,
01827                                            nameBuffer,
01828                                            valueBuffer,
01829                                            bufferLen,
01830                                            <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01831 
01832             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status));
01833             ZwClose (hwprofile);
01834             hwprofile = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01835 
01836         } <span class="keywordflow">else</span> {
01837             <span class="comment">//</span>
01838             <span class="comment">// We didn't clone this one.</span>
01839             <span class="comment">// don't do anything else.</span>
01840             <span class="comment">//</span>
01841             ZwClose (entry);
01842             ZwClose (hwprofile);
01843             entry = hwprofile = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01844         }
01845 
01846         <a class="code" href="../../d1/d2/cmp_8h.html#a126">CM_HARDWARE_PROFILE_STR_CCS_HWPROFILE</a>;
01847 
01848 
01849 
01850     }
01851 
01852 Clean:
01853 
01854     <span class="keywordflow">if</span> (alias) {
01855         ZwClose (alias);
01856     }
01857     <span class="keywordflow">if</span> (entry) {
01858         ZwClose (entry);
01859     }
01860     <span class="keywordflow">if</span> (hwprofile) {
01861         ZwClose (hwprofile);
01862     }
01863 
01864     <span class="keywordflow">return</span> status;
01865 }
01866 
01867 
01868 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01869"></a><a class="code" href="../../d6/d2/hwprofil_8c.html#a7">01869</a> <a class="code" href="../../d6/d2/hwprofil_8c.html#a7">CmpCloneHwProfile</a> (
01870     IN HANDLE IDConfigDB,
01871     IN HANDLE Parent,
01872     IN HANDLE OldProfile,
01873     IN ULONG  OldProfileNumber,
01874     IN USHORT DockingState,
01875     OUT PHANDLE NewProfile,
01876     OUT PULONG  NewProfileNumber
01877     )
01878 <span class="comment">/*++</span>
01879 <span class="comment">Routine Description</span>
01880 <span class="comment"></span>
01881 <span class="comment">    The given hardware profile key needs cloning.</span>
01882 <span class="comment">    Clone the key and then return the new profile.</span>
01883 <span class="comment"></span>
01884 <span class="comment">Return:</span>
01885 <span class="comment"></span>
01886 <span class="comment">    STATUS_SUCCESS - if the profile has been cloned, in which case the new</span>
01887 <span class="comment">        profile key has been opened for read / write privs.  The old profile</span>
01888 <span class="comment">        will be closed.</span>
01889 <span class="comment"></span>
01890 <span class="comment">    &lt;unsuccessful&gt; - for a given error.  NewProfile is invalid and the Old</span>
01891 <span class="comment">        Profile has also been closed.</span>
01892 <span class="comment"></span>
01893 <span class="comment"></span>
01894 <span class="comment">                (Copied lovingly from CmpCloneControlSet)</span>
01895 <span class="comment"></span>
01896 <span class="comment"></span>
01897 <span class="comment">--*/</span>
01898 {
01899     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
01900     UNICODE_STRING newProfileName;
01901     UNICODE_STRING name;
01902     UNICODE_STRING friendlyName;
01903     UNICODE_STRING guidStr;
01904     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a> oldProfileKey;
01905     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a> newProfileKey;
01906     OBJECT_ATTRIBUTES attributes;
01907     PSECURITY_DESCRIPTOR security;
01908     ULONG securityLength;
01909     WCHAR nameBuffer [64];
01910     HANDLE IDConfigDBEntry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01911     ULONG disposition;
01912     ULONG value;
01913     <a class="code" href="../../d5/d8/ex_8h.html#a172">UUID</a>  uuid;
01914     PKEY_BASIC_INFORMATION keyBasicInfo;
01915     PKEY_FULL_INFORMATION keyFullInfo;
01916     PKEY_VALUE_FULL_INFORMATION keyValueInfo;
01917     ULONG  length, profileSubKeys, i;
01918     UCHAR  valueBuffer[256];
01919     HANDLE hardwareProfiles=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01920     HANDLE profileEntry=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01921 
01922     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a> ();
01923 
01924     keyFullInfo  = (PKEY_FULL_INFORMATION)  valueBuffer;
01925     keyBasicInfo = (PKEY_BASIC_INFORMATION) valueBuffer;
01926     keyValueInfo = (PKEY_VALUE_FULL_INFORMATION) valueBuffer;
01927 
01928     *NewProfile = 0;
01929     *NewProfileNumber = OldProfileNumber;
01930 
01931     <span class="comment">//</span>
01932     <span class="comment">// Find the new profile number.</span>
01933     <span class="comment">//</span>
01934 
01935     <span class="keywordflow">while</span> (*NewProfileNumber &lt; 200) {
01936         (*NewProfileNumber)++;
01937 
01938         swprintf (nameBuffer, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"%04d"</span>, *NewProfileNumber);
01939         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;newProfileName, nameBuffer);
01940 
01941         InitializeObjectAttributes(&amp;attributes,
01942                                    &amp;newProfileName,
01943                                    OBJ_CASE_INSENSITIVE,
01944                                    Parent,
01945                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01946 
01947         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a> (NewProfile,
01948                             KEY_READ | KEY_WRITE,
01949                             &amp;attributes);
01950 
01951         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
01952             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (*NewProfile);
01953 
01954         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (STATUS_OBJECT_NAME_NOT_FOUND == status) {
01955             status = STATUS_SUCCESS;
01956             <span class="keywordflow">break</span>;
01957 
01958         } <span class="keywordflow">else</span> {
01959             <span class="keywordflow">break</span>;
01960         }
01961 
01962     }
01963     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
01964         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a18">CML_BUGCHECK</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a27">CMS_INIT</a>) {
01965             KdPrint((<span class="stringliteral">"CM: CmpCloneHwProfile error finding new profile key %08lx\n"</span>, status));
01966         }
01967         <span class="keywordflow">goto</span> Exit;
01968     }
01969 
01970     <span class="comment">//</span>
01971     <span class="comment">// Get the security descriptor from the old key to create the new clone one.</span>
01972     <span class="comment">//</span>
01973 
01974     status = <a class="code" href="../../d9/d1/obse_8c.html#a2">NtQuerySecurityObject</a> (OldProfile,
01975                                     DACL_SECURITY_INFORMATION,
01976                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01977                                     0,
01978                                     &amp;securityLength);
01979 
01980     <span class="keywordflow">if</span> (STATUS_BUFFER_TOO_SMALL == status) {
01981 
01982         security = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, securityLength);
01983 
01984         <span class="keywordflow">if</span> (security != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01985             status = <a class="code" href="../../d9/d1/obse_8c.html#a2">NtQuerySecurityObject</a>(OldProfile,
01986                                            DACL_SECURITY_INFORMATION,
01987                                            security,
01988                                            securityLength,
01989                                            &amp;securityLength);
01990             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
01991                 <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a18">CML_BUGCHECK</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a27">CMS_INIT</a>) {
01992                     KdPrint((<span class="stringliteral">"CM: CmpCloneHwProfile"</span>
01993                              <span class="stringliteral">" - NtQuerySecurityObject failed %08lx\n"</span>, status));
01994                 }
01995                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(security);
01996                 security=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01997             }
01998         }
01999     } <span class="keywordflow">else</span> {
02000         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a18">CML_BUGCHECK</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a27">CMS_INIT</a>) {
02001             KdPrint((<span class="stringliteral">"CM: CmpCloneHwProfile"</span>
02002                      <span class="stringliteral">" - NtQuerySecurityObject returned %08lx\n"</span>, status));
02003         }
02004         security=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02005     }
02006 
02007     <span class="comment">//</span>
02008     <span class="comment">// Create the new key</span>
02009     <span class="comment">//</span>
02010     InitializeObjectAttributes  (&amp;attributes,
02011                                  &amp;newProfileName,
02012                                  OBJ_CASE_INSENSITIVE,
02013                                  Parent,
02014                                  security);
02015 
02016     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a> (NewProfile,
02017                           KEY_READ | KEY_WRITE,
02018                           &amp;attributes,
02019                           0,
02020                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02021                           0,
02022                           &amp;disposition);
02023 
02024     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> != security) {
02025         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (security);
02026     }
02027     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
02028         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a18">CML_BUGCHECK</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a27">CMS_INIT</a>) {
02029             KdPrint((<span class="stringliteral">"CM: CmpCloneHwProfile couldn't create Clone %08lx\n"</span>,status));
02030         }
02031         <span class="keywordflow">goto</span> Exit;
02032     }
02033 
02034     <span class="comment">//</span>
02035     <span class="comment">// Check to make sure the key was created.  If it already exists,</span>
02036     <span class="comment">// something is wrong.</span>
02037     <span class="comment">//</span>
02038     <span class="keywordflow">if</span> (disposition != REG_CREATED_NEW_KEY) {
02039         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a18">CML_BUGCHECK</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a27">CMS_INIT</a>) {
02040         <span class="comment">//  KdPrint(("CM: CmpCloneHwProfile: Clone tree already exists!\n"));</span>
02041         }
02042 
02043         <span class="comment">//</span>
02044         <span class="comment">// WARNNOTE:</span>
02045         <span class="comment">//      If somebody somehow managed to create a key in our way,</span>
02046         <span class="comment">//      they'll thwart duplication of the prestine.  Tough luck.</span>
02047         <span class="comment">//      Claim it worked and go on.</span>
02048         <span class="comment">//</span>
02049         status = STATUS_SUCCESS;
02050         <span class="keywordflow">goto</span> Exit;
02051     }
02052 
02053     <span class="comment">//</span>
02054     <span class="comment">// Create the IDConfigDB Entry</span>
02055     <span class="comment">//</span>
02056     swprintf (nameBuffer, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Hardware Profiles\\%04d"</span>, *NewProfileNumber);
02057     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, nameBuffer);
02058 
02059     InitializeObjectAttributes  (&amp;attributes,
02060                                  &amp;name,
02061                                  OBJ_CASE_INSENSITIVE,
02062                                  IDConfigDB,
02063                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02064 
02065     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a> (&amp;IDConfigDBEntry,
02066                           KEY_READ | KEY_WRITE,
02067                           &amp;attributes,
02068                           0,
02069                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02070                           0,
02071                           &amp;disposition);
02072 
02073     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
02074         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a18">CML_BUGCHECK</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a27">CMS_INIT</a>) {
02075             KdPrint((<span class="stringliteral">"CM: CmpCloneHwProfile couldn't create Clone %08lx\n"</span>,status));
02076         }
02077         IDConfigDBEntry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02078         <span class="keywordflow">goto</span> Exit;
02079     }
02080 
02081     <span class="comment">//</span>
02082     <span class="comment">// Determine the next PreferenceOrder for the new profile.  (The</span>
02083     <span class="comment">// PrefenceOrder for the new profile will be incrementally next from the</span>
02084     <span class="comment">// greatest PreferenceOrder value of all the current profiles; assumes</span>
02085     <span class="comment">// current set of PreferenceOrder values is incremental)</span>
02086     <span class="comment">//</span>
02087 
02088     <span class="comment">//</span>
02089     <span class="comment">// Open the Hardware Profiles key</span>
02090     <span class="comment">//</span>
02091     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, <a class="code" href="../../d1/d2/cmp_8h.html#a130">CM_HARDWARE_PROFILE_STR_HARDWARE_PROFILES</a>);
02092 
02093     InitializeObjectAttributes (&amp;attributes,
02094                                 &amp;name,
02095                                 OBJ_CASE_INSENSITIVE,
02096                                 IDConfigDB,
02097                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02098     status = ZwOpenKey (&amp;hardwareProfiles,
02099                         KEY_READ,
02100                         &amp;attributes);
02101     
02102     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
02103         hardwareProfiles = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02104         <span class="keywordflow">goto</span> Exit;
02105     }
02106 
02107     <span class="comment">//</span>
02108     <span class="comment">// Find the number of profile Sub Keys</span>
02109     <span class="comment">//</span>
02110     status = ZwQueryKey (hardwareProfiles,
02111                          KeyFullInformation,
02112                          valueBuffer,
02113                          <span class="keyword">sizeof</span> (valueBuffer),
02114                          &amp;length);
02115 
02116     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
02117         <span class="keywordflow">goto</span> Exit;
02118     }
02119 
02120     <span class="comment">//</span>
02121     <span class="comment">// At very least, the Pristine and the new profile key we just created,</span>
02122     <span class="comment">// should be there. </span>
02123     <span class="comment">//</span>
02124     profileSubKeys = keyFullInfo-&gt;SubKeys;
02125     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (1 &lt; profileSubKeys);
02126 
02127     <span class="comment">//</span>
02128     <span class="comment">// Initialize the highest PreferenceOrder value found to -1.</span>
02129     <span class="comment">//</span>
02130     value = -1;
02131 
02132     <span class="comment">//</span>
02133     <span class="comment">// Iterrate the profiles</span>
02134     <span class="comment">//</span>
02135     <span class="keywordflow">for</span> (i = 0; i &lt; profileSubKeys; i++) {
02136     
02137         <span class="comment">//</span>
02138         <span class="comment">// Enumerate all profile subkeys, noting their PreferenceOrder values.</span>
02139         <span class="comment">//</span>
02140         status = ZwEnumerateKey (hardwareProfiles,
02141                                  i,
02142                                  KeyBasicInformation,
02143                                  valueBuffer,
02144                                  <span class="keyword">sizeof</span>(valueBuffer) - <span class="keyword">sizeof</span> (UNICODE_NULL), <span class="comment">//term 0</span>
02145                                  &amp;length);
02146         <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02147             <span class="keywordflow">break</span>;
02148         }
02149         
02150         <span class="comment">//</span>
02151         <span class="comment">// Zero-terminate the subkey name just in case.</span>
02152         <span class="comment">//</span>
02153         keyBasicInfo-&gt;Name[keyBasicInfo-&gt;NameLength/<span class="keyword">sizeof</span>(WCHAR)] = 0;
02154 
02155         <span class="comment">//</span>
02156         <span class="comment">// If this is the Pristine, or the NewProfile key, ignore it.</span>
02157         <span class="comment">//</span>
02158         <span class="keywordflow">if</span> ((!_wtoi(keyBasicInfo-&gt;Name)) || 
02159             ((ULONG)(_wtoi(keyBasicInfo-&gt;Name)) == *NewProfileNumber)) {
02160             <span class="keywordflow">continue</span>;
02161         }
02162         
02163         <span class="comment">//</span>
02164         <span class="comment">// Open this profile key</span>
02165         <span class="comment">//</span>
02166         name.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) keyBasicInfo-&gt;NameLength;
02167         name.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) keyBasicInfo-&gt;NameLength + <span class="keyword">sizeof</span> (UNICODE_NULL);
02168         name.Buffer = keyBasicInfo-&gt;Name;
02169 
02170         InitializeObjectAttributes (&amp;attributes,
02171                                     &amp;name,
02172                                     OBJ_CASE_INSENSITIVE,
02173                                     hardwareProfiles,
02174                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02175         status = ZwOpenKey (&amp;profileEntry,
02176                             KEY_READ,
02177                             &amp;attributes);
02178         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
02179             profileEntry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02180             <span class="keywordflow">continue</span>;
02181         }
02182 
02183         <span class="comment">//</span>
02184         <span class="comment">// Extract The PreferenceOrder value for this Profile.</span>
02185         <span class="comment">//</span>
02186         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, <a class="code" href="../../d1/d2/cmp_8h.html#a140">CM_HARDWARE_PROFILE_STR_PREFERENCE_ORDER</a>);
02187         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(profileEntry,
02188                                  &amp;name,
02189                                  KeyValueFullInformation,
02190                                  valueBuffer,
02191                                  <span class="keyword">sizeof</span>(valueBuffer),
02192                                  &amp;length);
02193 
02194         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status) || (keyValueInfo-&gt;Type != REG_DWORD)) {
02195             <span class="comment">//</span>
02196             <span class="comment">// No PreferenceOrder; continue on as best we can</span>
02197             <span class="comment">//</span>
02198             ZwClose(profileEntry);
02199             profileEntry=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02200             <span class="keywordflow">continue</span>;
02201         }
02202 
02203         <span class="comment">//</span>
02204         <span class="comment">// If this is a the highest PreferenceOrder so far, reassign value to</span>
02205         <span class="comment">// this PreferenceOrder, OR assign it this valid PreferenceOrder if</span>
02206         <span class="comment">// value is still unassigned.</span>
02207         <span class="comment">//</span>
02208         <span class="keywordflow">if</span> (((*(PULONG) ((PUCHAR)keyValueInfo + keyValueInfo-&gt;DataOffset)) &gt; value) ||
02209             (value == -1)) {
02210             value = (* (PULONG) ((PUCHAR)keyValueInfo + keyValueInfo-&gt;DataOffset));
02211         }
02212         
02213         ZwClose(profileEntry);
02214         profileEntry=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02215     }
02216 
02217     <span class="comment">//</span>
02218     <span class="comment">// Increment value one above the greatest PreferenceOrder found.</span>
02219     <span class="comment">// (If no other profiles were found, (value+=1) == 0, the most preferred</span>
02220     <span class="comment">// profile) </span>
02221     <span class="comment">//</span>
02222     value += 1;
02223 
02224     <span class="comment">//</span>
02225     <span class="comment">// Give the new profile a preference order.</span>
02226     <span class="comment">//</span>
02227     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, <a class="code" href="../../d1/d2/cmp_8h.html#a140">CM_HARDWARE_PROFILE_STR_PREFERENCE_ORDER</a>);
02228     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a> (IDConfigDBEntry,
02229                             &amp;name,
02230                             0,
02231                             REG_DWORD,
02232                             &amp;value,
02233                             <span class="keyword">sizeof</span> (value));
02234 
02235     <span class="comment">//</span>
02236     <span class="comment">// Give the new profile a friendly name, based on the DockingState</span>
02237     <span class="comment">//</span>
02238     status = <a class="code" href="../../d6/d2/hwprofil_8c.html#a8">CmpCreateHwProfileFriendlyName</a>(IDConfigDB,
02239                                             DockingState,
02240                                             *NewProfileNumber,
02241                                             &amp;friendlyName);
02242 
02243     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02244         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, <a class="code" href="../../d1/d2/cmp_8h.html#a141">CM_HARDWARE_PROFILE_STR_FRIENDLY_NAME</a>);
02245         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a> (IDConfigDBEntry,
02246                                 &amp;name,
02247                                 0,
02248                                 REG_SZ,
02249                                 friendlyName.Buffer,
02250                                 friendlyName.Length + <span class="keyword">sizeof</span>(UNICODE_NULL));
02251         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;friendlyName);
02252     }
02253 
02254     <span class="comment">//</span>
02255     <span class="comment">// Set the aliasable flag on the new "cloned profile" to be false</span>
02256     <span class="comment">//</span>
02257     value = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02258     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, <a class="code" href="../../d1/d2/cmp_8h.html#a137">CM_HARDWARE_PROFILE_STR_ALIASABLE</a>);
02259     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a> (IDConfigDBEntry,
02260                             &amp;name,
02261                             0,
02262                             REG_DWORD,
02263                             &amp;value,
02264                             <span class="keyword">sizeof</span> (value));
02265 
02266     <span class="comment">//</span>
02267     <span class="comment">// Set the cloned profile on the new "cloned profile" to be true;</span>
02268     <span class="comment">//</span>
02269     value = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02270     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, <a class="code" href="../../d1/d2/cmp_8h.html#a138">CM_HARDWARE_PROFILE_STR_CLONED</a>);
02271     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a> (IDConfigDBEntry,
02272                             &amp;name,
02273                             0,
02274                             REG_DWORD,
02275                             &amp;value,
02276                             <span class="keyword">sizeof</span> (value));
02277 
02278     <span class="comment">//</span>
02279     <span class="comment">// Set the HwProfileGuid for the brand new profile</span>
02280     <span class="comment">//</span>
02281 
02282     status = <a class="code" href="../../d5/d8/ex_8h.html#a324">ExUuidCreate</a> (&amp;uuid);
02283     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
02284 
02285         status = <a class="code" href="../../d1/d7/guid_8c.html#a2">RtlStringFromGUID</a> (&amp;uuid, &amp;guidStr);
02286         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
02287             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, <a class="code" href="../../d1/d2/cmp_8h.html#a143">CM_HARDWARE_PROFILE_STR_HW_PROFILE_GUID</a>);
02288 
02289             status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a> (IDConfigDBEntry,
02290                                     &amp;name,
02291                                     0,
02292                                     REG_SZ,
02293                                     guidStr.Buffer,
02294                                     guidStr.MaximumLength);
02295 
02296             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;guidStr);
02297         } <span class="keywordflow">else</span> {
02298             <span class="comment">//</span>
02299             <span class="comment">// What's a fella to do?</span>
02300             <span class="comment">// let's just go on.</span>
02301             <span class="comment">//</span>
02302             status = STATUS_SUCCESS;
02303         }
02304 
02305     } <span class="keywordflow">else</span> {
02306         <span class="comment">//</span>
02307         <span class="comment">// let's just go on.</span>
02308         <span class="comment">//</span>
02309         status = STATUS_SUCCESS;
02310     }
02311 
02312 
02313     <span class="comment">//</span>
02314     <span class="comment">// Clone the key</span>
02315     <span class="comment">//</span>
02316     <span class="comment">// (Copied lovingly from CmpCloneControlSet)</span>
02317     <span class="comment">//</span>
02318     <span class="comment">//</span>
02319     status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a> (OldProfile,
02320                                         KEY_READ,
02321                                         <a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>,
02322                                         <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
02323                                         (PVOID *)(&amp;oldProfileKey),
02324                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02325 
02326     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02327         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a18">CML_BUGCHECK</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a27">CMS_INIT</a>) {
02328             KdPrint((<span class="stringliteral">"CM: CmpCloneHWProfile: couldn't reference CurrentHandle %08lx\n"</span>,
02329                      status));
02330         }
02331         <span class="keywordflow">goto</span> Exit;
02332     }
02333 
02334     <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a> (*NewProfile,
02335                                KEY_WRITE,
02336                                <a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>,
02337                                <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
02338                                (PVOID *)(&amp;newProfileKey),
02339                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02340 
02341     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02342         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a18">CML_BUGCHECK</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a27">CMS_INIT</a>) {
02343             KdPrint((<span class="stringliteral">"CM: CmpCloneHWProfile: couldn't reference CurrentHandle %08lx\n"</span>,
02344                      status));
02345         }
02346         <span class="keywordflow">goto</span> Exit;
02347     }
02348 
02349     <a class="code" href="../../d0/d3/cmsubs3_8c.html#a4">CmpLockRegistryExclusive</a>();
02350 
02351     <span class="comment">//</span>
02352     <span class="comment">// Note: This copy tree command does not copy the values in the</span>
02353     <span class="comment">// root keys.  We are relying on this, since the values stored there</span>
02354     <span class="comment">// are things like "pristine" which we do not wish to have moved to the</span>
02355     <span class="comment">// new tree.</span>
02356     <span class="comment">//</span>
02357     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d2/cmp_8h.html#a118">CmpCopyTree</a>(oldProfileKey-&gt;KeyControlBlock-&gt;KeyHive,
02358                     oldProfileKey-&gt;KeyControlBlock-&gt;KeyCell,
02359                     newProfileKey-&gt;KeyControlBlock-&gt;KeyHive,
02360                     newProfileKey-&gt;KeyControlBlock-&gt;KeyCell)) {
02361         <span class="comment">//</span>
02362         <span class="comment">// Set the max subkey name property for the new target key.</span>
02363         <span class="comment">//</span>
02364         newProfileKey-&gt;KeyControlBlock-&gt;KeyNode-&gt;MaxNameLen = 
02365             oldProfileKey-&gt;KeyControlBlock-&gt;KeyNode-&gt;MaxNameLen;
02366         status = STATUS_SUCCESS;
02367     } <span class="keywordflow">else</span> {
02368         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a18">CML_BUGCHECK</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a27">CMS_INIT</a>) {
02369             KdPrint((<span class="stringliteral">"CM: CmpCloneHwProfile: tree copy failed.\n"</span>));
02370         }
02371         status = STATUS_REGISTRY_CORRUPT;
02372     }
02373     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
02374 
02375 
02376 Exit:
02377     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (OldProfile);
02378     <span class="keywordflow">if</span> (IDConfigDBEntry) {
02379         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (IDConfigDBEntry);
02380     }
02381     <span class="keywordflow">if</span> (hardwareProfiles) {
02382         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (hardwareProfiles);
02383     }
02384     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
02385         <span class="keywordflow">if</span> (*NewProfile) {
02386             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (*NewProfile);
02387         }
02388     }    
02389 
02390     <span class="keywordflow">return</span> status;
02391 }
02392 
02393 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02394"></a><a class="code" href="../../d6/d2/hwprofil_8c.html#a1">02394</a> <a class="code" href="../../d6/d2/hwprofil_8c.html#a1">CmDeleteKeyRecursive</a>(
02395     HANDLE  hKeyRoot,
02396     PWSTR   Key,
02397     PVOID   TemporaryBuffer,
02398     ULONG   LengthTemporaryBuffer,
02399     BOOLEAN ThisKeyToo
02400     )
02401 <span class="comment">/*++</span>
02402 <span class="comment"></span>
02403 <span class="comment">Routine Description:</span>
02404 <span class="comment"></span>
02405 <span class="comment">    Routine to recursively delete all subkeys under the given</span>
02406 <span class="comment">    key, including the key given.</span>
02407 <span class="comment"></span>
02408 <span class="comment">Arguments:</span>
02409 <span class="comment"></span>
02410 <span class="comment">    hKeyRoot:    Handle to root relative to which the key to be deleted is</span>
02411 <span class="comment">                 specified.</span>
02412 <span class="comment"></span>
02413 <span class="comment">    Key:         Root relative path of the key which is to be recursively deleted.</span>
02414 <span class="comment"></span>
02415 <span class="comment">    ThisKeyToo:  Whether after deletion of all subkeys, this key itself is to</span>
02416 <span class="comment">                 be deleted.</span>
02417 <span class="comment"></span>
02418 <span class="comment">Return Value:</span>
02419 <span class="comment"></span>
02420 <span class="comment">    Status is returned.</span>
02421 <span class="comment"></span>
02422 <span class="comment">--*/</span>
02423 {
02424     ULONG ResultLength;
02425     PKEY_BASIC_INFORMATION KeyInfo;
02426     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02427     UNICODE_STRING UnicodeString;
02428     OBJECT_ATTRIBUTES Obja;
02429     PWSTR SubkeyName;
02430     HANDLE hKey;
02431 
02432     <span class="comment">//</span>
02433     <span class="comment">// Initialize</span>
02434     <span class="comment">//</span>
02435 
02436     KeyInfo = (PKEY_BASIC_INFORMATION)TemporaryBuffer;
02437 
02438     <span class="comment">//</span>
02439     <span class="comment">// Open the key</span>
02440     <span class="comment">//</span>
02441 
02442     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;UnicodeString,<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>);
02443 
02444     InitializeObjectAttributes(&amp;Obja,
02445                                &amp;UnicodeString,
02446                                OBJ_CASE_INSENSITIVE,
02447                                hKeyRoot,
02448                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02449 
02450     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwOpenKey(&amp;hKey,KEY_ALL_ACCESS,&amp;Obja);
02451     <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
02452         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02453     }
02454 
02455     <span class="comment">//</span>
02456     <span class="comment">// Enumerate all subkeys of the current key. if any exist they should</span>
02457     <span class="comment">// be deleted first.  since deleting the subkey affects the subkey</span>
02458     <span class="comment">// index, we always enumerate on subkeyindex 0</span>
02459     <span class="comment">//</span>
02460     <span class="keywordflow">while</span>(1) {
02461         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwEnumerateKey(
02462                     hKey,
02463                     0,
02464                     KeyBasicInformation,
02465                     TemporaryBuffer,
02466                     LengthTemporaryBuffer,
02467                     &amp;ResultLength
02468                     );
02469         <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02470             <span class="keywordflow">break</span>;
02471         }
02472 
02473         <span class="comment">//</span>
02474         <span class="comment">// Zero-terminate the subkey name just in case.</span>
02475         <span class="comment">//</span>
02476         KeyInfo-&gt;Name[KeyInfo-&gt;NameLength/<span class="keyword">sizeof</span>(WCHAR)] = 0;
02477 
02478         <span class="comment">//</span>
02479         <span class="comment">// Make a duplicate of the subkey name because the name is</span>
02480         <span class="comment">// in TemporaryBuffer, which might get clobbered by recursive</span>
02481         <span class="comment">// calls to this routine.</span>
02482         <span class="comment">//</span>
02483         SubkeyName = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
02484                                      ((wcslen (KeyInfo-&gt;Name) + 1) *
02485                                       sizeof (WCHAR)));
02486         <span class="keywordflow">if</span> (!SubkeyName) {
02487             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
02488             <span class="keywordflow">break</span>;
02489         }
02490         wcscpy(SubkeyName, KeyInfo-&gt;Name);
02491         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d2/hwprofil_8c.html#a1">CmDeleteKeyRecursive</a>( hKey,
02492                                        SubkeyName,
02493                                        TemporaryBuffer,
02494                                        LengthTemporaryBuffer,
02495                                        <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02496         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(SubkeyName);
02497         <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02498             <span class="keywordflow">break</span>;
02499         }
02500     }
02501 
02502     <span class="comment">//</span>
02503     <span class="comment">// Check the status, if the status is anything other than</span>
02504     <span class="comment">// STATUS_NO_MORE_ENTRIES we failed in deleting some subkey,</span>
02505     <span class="comment">// so we cannot delete this key too</span>
02506     <span class="comment">//</span>
02507 
02508     <span class="keywordflow">if</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_NO_MORE_ENTRIES) {
02509         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
02510     }
02511 
02512     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02513         ZwClose(hKey);
02514         <span class="keywordflow">return</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02515     }
02516 
02517     <span class="comment">//</span>
02518     <span class="comment">// else delete the current key if asked to do so</span>
02519     <span class="comment">//</span>
02520     <span class="keywordflow">if</span>( ThisKeyToo ) {
02521         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwDeleteKey (hKey);
02522     }
02523 
02524     ZwClose(hKey);
02525     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02526 }
02527 
02528 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02529"></a><a class="code" href="../../d6/d2/hwprofil_8c.html#a8">02529</a> <a class="code" href="../../d6/d2/hwprofil_8c.html#a8">CmpCreateHwProfileFriendlyName</a> (
02530     IN HANDLE           IDConfigDB,
02531     IN ULONG            DockingState,
02532     IN ULONG            NewProfileNumber,
02533     OUT PUNICODE_STRING FriendlyName
02534     )
02535 <span class="comment">/*++</span>
02536 <span class="comment"></span>
02537 <span class="comment">Routine Description:</span>
02538 <span class="comment"></span>
02539 <span class="comment">    Create a new FriendlyName for a new Hardware Profile, given the DockState.</span>
02540 <span class="comment">    If a new profile name based on the DockState cannot be created, an attempt</span>
02541 <span class="comment">    is made to create a default FriendlyName based on NewProfileNumber.  If</span>
02542 <span class="comment">    successful, a unicode string with the new profile friendlyName is created.</span>
02543 <span class="comment">    It is the responsibility of the caller to free this using</span>
02544 <span class="comment">    RtlFreeUnicodeString.  If unsuccesful, no string is returned.</span>
02545 <span class="comment"></span>
02546 <span class="comment">Arguments:</span>
02547 <span class="comment"></span>
02548 <span class="comment">    IDConfigDB:       Handle to the IDConfigDB registry key.</span>
02549 <span class="comment"></span>
02550 <span class="comment">    DockingState:     The Docking State of the profile for which the new</span>
02551 <span class="comment">                      FriendlyName is being created.  This should be one of:</span>
02552 <span class="comment">                      HW_PROFILE_DOCKSTATE_DOCKED,</span>
02553 <span class="comment">                      HW_PROFILE_DOCKSTATE_UNDOCKED, or</span>
02554 <span class="comment">                      HW_PROFILE_DOCKSTATE_UNKNOWN</span>
02555 <span class="comment"></span>
02556 <span class="comment">    NewProfileNumber: The number of the new profile being created.  If unable to</span>
02557 <span class="comment">                      create a DockState specific FriendlyName, this value will</span>
02558 <span class="comment">                      be used to create a (not-so) FriendlyName.</span>
02559 <span class="comment"></span>
02560 <span class="comment">    FriendlyName:     Supplies a unicode string to receive the FriendlyName for this</span>
02561 <span class="comment">                      new profile.  The caller is expected to free this with</span>
02562 <span class="comment">                      RtlFreeUnicodeString.</span>
02563 <span class="comment"></span>
02564 <span class="comment">Return:</span>
02565 <span class="comment"></span>
02566 <span class="comment">    NTSTATUS code.    Currently returns STATUS_SUCCESS, or STATUS_UNSUCCESSFUL.</span>
02567 <span class="comment"></span>
02568 <span class="comment">Notes:</span>
02569 <span class="comment"></span>
02570 <span class="comment">    The new FriendlyName is generated from the DockState and appropriate</span>
02571 <span class="comment">    counter, and may not necessarily be unique among the existing Hardware</span>
02572 <span class="comment">    Profiles.</span>
02573 <span class="comment"></span>
02574 <span class="comment">    The naming scheme used here (including the localized strings in the kernel</span>
02575 <span class="comment">    message table) should be kept in sync with that provided to the user through</span>
02576 <span class="comment">    the Hardware Profile control panel applet.</span>
02577 <span class="comment"></span>
02578 <span class="comment">--*/</span>
02579 {
02580     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
02581     ANSI_STRING       ansiString;
02582     UNICODE_STRING    unicodeString;
02583     UNICODE_STRING    labelName, keyName;
02584     PMESSAGE_RESOURCE_ENTRY messageEntry;
02585     PLDR_DATA_TABLE_ENTRY dataTableEntry;
02586     ULONG             messageId;
02587     UCHAR             valueBuffer[256];
02588     WCHAR             friendlyNameBuffer[<a class="code" href="../../d9/d0/cmdata_8h.html#a2">MAX_FRIENDLY_NAME_LENGTH</a>/<span class="keyword">sizeof</span>(WCHAR)];
02589     PKEY_VALUE_FULL_INFORMATION  keyValueInfo;
02590     ULONG             length, index;
02591     HANDLE            hardwareProfiles=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02592     OBJECT_ATTRIBUTES attributes;
02593 
02594     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a> ();
02595 
02596     <span class="comment">//</span>
02597     <span class="comment">// Make sure we were given a place to put the FriendlyName</span>
02598     <span class="comment">//</span>
02599     <span class="keywordflow">if</span> (!FriendlyName) {
02600         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
02601     }
02602 
02603     <span class="comment">//</span>
02604     <span class="comment">// If we don't have a handle to IDConfigDB, try to assign a default</span>
02605     <span class="comment">// FriendlyName on the way out.</span>
02606     <span class="comment">//</span>
02607     <span class="keywordflow">if</span> (!IDConfigDB) {
02608         status = STATUS_INVALID_PARAMETER;
02609         <span class="keywordflow">goto</span> Exit;
02610     }
02611 
02612     <span class="comment">//</span>
02613     <span class="comment">// Determine the appropriate message to use, based on the DockState.</span>
02614     <span class="comment">//</span>
02615     <span class="keywordflow">if</span> ((DockingState &amp; <a class="code" href="../../d6/d7/profiles_8h.html#a8">HW_PROFILE_DOCKSTATE_UNKNOWN</a>) == <a class="code" href="../../d6/d7/profiles_8h.html#a8">HW_PROFILE_DOCKSTATE_UNKNOWN</a>){
02616         messageId = HARDWARE_PROFILE_UNKNOWN_STRING;
02617         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;labelName, <a class="code" href="../../d1/d2/cmp_8h.html#a146">CM_HARDWARE_PROFILE_STR_UNKNOWN</a>);
02618     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (DockingState &amp; <a class="code" href="../../d6/d7/profiles_8h.html#a7">HW_PROFILE_DOCKSTATE_DOCKED</a>) {
02619         messageId = HARDWARE_PROFILE_DOCKED_STRING;
02620         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;labelName, <a class="code" href="../../d1/d2/cmp_8h.html#a144">CM_HARDWARE_PROFILE_STR_DOCKED</a>);
02621     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (DockingState &amp; <a class="code" href="../../d6/d7/profiles_8h.html#a6">HW_PROFILE_DOCKSTATE_UNDOCKED</a>) {
02622         messageId = HARDWARE_PROFILE_UNDOCKED_STRING;
02623         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;labelName, <a class="code" href="../../d1/d2/cmp_8h.html#a145">CM_HARDWARE_PROFILE_STR_UNDOCKED</a>);
02624     } <span class="keywordflow">else</span> {
02625         messageId = HARDWARE_PROFILE_UNKNOWN_STRING;
02626         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;labelName, <a class="code" href="../../d1/d2/cmp_8h.html#a146">CM_HARDWARE_PROFILE_STR_UNKNOWN</a>);
02627     }
02628 
02629     <span class="comment">//</span>
02630     <span class="comment">// Find the message entry in the kernel's own message table.  KeLoaderBlock</span>
02631     <span class="comment">// is available when we're creating hardware profiles during system</span>
02632     <span class="comment">// initialization only; for profiles created thereafter, use the the first</span>
02633     <span class="comment">// entry of the PsLoadedModuleList to get the image base of the kernel.</span>
02634     <span class="comment">//</span>
02635     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/ke_8h.html#a130">KeLoaderBlock</a>) {
02636         dataTableEntry = CONTAINING_RECORD(<a class="code" href="../../d4/d9/ke_8h.html#a130">KeLoaderBlock</a>-&gt;<a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html#o0">LoadOrderListHead</a>.Flink,
02637                                            LDR_DATA_TABLE_ENTRY,
02638                                            InLoadOrderLinks);
02639     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>.Flink) {
02640         dataTableEntry = CONTAINING_RECORD(<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>.Flink,
02641                                            LDR_DATA_TABLE_ENTRY,
02642                                            InLoadOrderLinks);
02643     } <span class="keywordflow">else</span> {
02644         status = STATUS_UNSUCCESSFUL;
02645         <span class="keywordflow">goto</span> Exit;
02646     }
02647 
02648     status = <a class="code" href="../../d0/d8/message_8c.html#a1">RtlFindMessage</a>(dataTableEntry-&gt;DllBase,
02649                             (ULONG_PTR)11, <span class="comment">// RT_MESSAGETABLE</span>
02650                             MAKELANGID(LANG_NEUTRAL,SUBLANG_SYS_DEFAULT), <span class="comment">// System default language</span>
02651                             messageId,
02652                             &amp;messageEntry);
02653 
02654     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02655         <span class="keywordflow">goto</span> Exit;
02656     }
02657 
02658     <span class="keywordflow">if</span>(!(messageEntry-&gt;Flags &amp; MESSAGE_RESOURCE_UNICODE)) {
02659         <span class="comment">//</span>
02660         <span class="comment">// If the message is not unicode, convert to unicode.</span>
02661         <span class="comment">// Let the conversion routine allocate the buffer.</span>
02662         <span class="comment">//</span>
02663         <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(&amp;ansiString,messageEntry-&gt;Text);
02664         status = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;unicodeString,&amp;ansiString,<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02665     } <span class="keywordflow">else</span> {
02666         <span class="comment">//</span>
02667         <span class="comment">// Message is already unicode. Make a copy.</span>
02668         <span class="comment">//</span>
02669         status = <a class="code" href="../../d6/d6/nls_8c.html#a47">RtlCreateUnicodeString</a>(&amp;unicodeString,(PWSTR)messageEntry-&gt;Text);
02670     }
02671 
02672     <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02673         <span class="keywordflow">goto</span> Exit;
02674     }
02675 
02676     <span class="comment">//</span>
02677     <span class="comment">// Strip the trailing CRLF.</span>
02678     <span class="comment">//</span>
02679     <span class="keywordflow">if</span> (unicodeString.Length  &gt; 2 * <span class="keyword">sizeof</span>(WCHAR)) {
02680         unicodeString.Length -= 2 * <span class="keyword">sizeof</span>(WCHAR);
02681         unicodeString.Buffer[unicodeString.Length / <span class="keyword">sizeof</span>(WCHAR)] = UNICODE_NULL;
02682     }
02683 
02684     <span class="comment">//</span>
02685     <span class="comment">// Check that the size of the label, with any numeric tag that may</span>
02686     <span class="comment">// potentially be added (up to 4 digits, preceded by a space) is not too</span>
02687     <span class="comment">// big.</span>
02688     <span class="comment">//</span>
02689     <span class="keywordflow">if</span> ((unicodeString.Length + 5*<span class="keyword">sizeof</span>(WCHAR) + <span class="keyword">sizeof</span>(UNICODE_NULL)) &gt;
02690         <a class="code" href="../../d9/d0/cmdata_8h.html#a2">MAX_FRIENDLY_NAME_LENGTH</a>) {
02691         status = STATUS_UNSUCCESSFUL;
02692         <span class="keywordflow">goto</span> Clean;
02693     }
02694 
02695     <span class="comment">//</span>
02696     <span class="comment">// Open the Hardware Profiles key.</span>
02697     <span class="comment">//</span>
02698     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;keyName, <a class="code" href="../../d1/d2/cmp_8h.html#a130">CM_HARDWARE_PROFILE_STR_HARDWARE_PROFILES</a>);
02699     InitializeObjectAttributes(&amp;attributes,
02700                                &amp;keyName,
02701                                OBJ_CASE_INSENSITIVE,
02702                                IDConfigDB,
02703                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02704     status = ZwOpenKey(&amp;hardwareProfiles,
02705                        KEY_READ,
02706                        &amp;attributes);
02707     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02708         hardwareProfiles = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02709         <span class="keywordflow">goto</span> Clean;
02710     }
02711 
02712     <span class="comment">//</span>
02713     <span class="comment">// Retrieve the counter of FriendlyNames we have previously assigned, based</span>
02714     <span class="comment">// on this DockState.</span>
02715     <span class="comment">//</span>
02716     keyValueInfo = (PKEY_VALUE_FULL_INFORMATION) valueBuffer;
02717     status = ZwQueryValueKey(hardwareProfiles,
02718                              &amp;labelName,
02719                              KeyValueFullInformation,
02720                              valueBuffer,
02721                              <span class="keyword">sizeof</span>(valueBuffer),
02722                              &amp;length);
02723 
02724     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; (keyValueInfo-&gt;Type == REG_DWORD)) {
02725         <span class="comment">//</span>
02726         <span class="comment">// Increment the counter.</span>
02727         <span class="comment">//</span>
02728         index = (* (PULONG) ((PUCHAR)keyValueInfo + keyValueInfo-&gt;DataOffset));
02729         index++;
02730     } <span class="keywordflow">else</span> {
02731         <span class="comment">//</span>
02732         <span class="comment">// Missing or invalid counter value; start the counter at "1".</span>
02733         <span class="comment">//</span>
02734         index = 1;
02735     }               
02736 
02737     <span class="comment">//</span>
02738     <span class="comment">// Update the counter in the registry.</span>
02739     <span class="comment">//</span>
02740     status = ZwSetValueKey(hardwareProfiles,
02741                            &amp;labelName,
02742                            0,
02743                            REG_DWORD,
02744                            &amp;index,
02745                            <span class="keyword">sizeof</span>(index));
02746     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02747         <span class="keywordflow">goto</span> Clean;
02748     }
02749 
02750     <span class="comment">//</span>
02751     <span class="comment">// Copy the FriendlyName, adding the index if necessary.</span>
02752     <span class="comment">//</span>
02753     <span class="keywordflow">if</span> ((messageId == HARDWARE_PROFILE_UNKNOWN_STRING) || (index &gt; 1)) {
02754         swprintf(friendlyNameBuffer, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"%s %u"</span>,
02755                  unicodeString.Buffer, index);
02756     } <span class="keywordflow">else</span> {
02757         wcscpy(friendlyNameBuffer, unicodeString.Buffer);
02758     }
02759 
02760  Clean:
02761 
02762     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;unicodeString);
02763 
02764     <span class="keywordflow">if</span> (hardwareProfiles!=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02765         ZwClose(hardwareProfiles);
02766     }
02767 
02768  Exit:
02769 
02770     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02771         <span class="comment">//</span>
02772         <span class="comment">// If we failed to assign a counter-based FriendlyName for whatever</span>
02773         <span class="comment">// reason, give the new profile a new (not so) friendly name as a last</span>
02774         <span class="comment">// resort.</span>
02775         <span class="comment">//</span>
02776         swprintf (friendlyNameBuffer, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"%04d"</span>, NewProfileNumber);
02777         status = STATUS_SUCCESS;
02778     }
02779 
02780     <span class="comment">//</span>
02781     <span class="comment">// Create the unicode string to return to the caller.</span>
02782     <span class="comment">//</span>
02783     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d6/nls_8c.html#a47">RtlCreateUnicodeString</a>(FriendlyName, (PWSTR)friendlyNameBuffer)) {
02784         status = STATUS_UNSUCCESSFUL;
02785     }
02786 
02787     <span class="keywordflow">return</span> status;
02788 
02789 } <span class="comment">// CmpCreateHwProfileFriendlyName</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:18 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
