<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: hivemap.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>hivemap.c File Reference</h1><code>#include "<a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>"</code><br>

<p>
<a href="../../d8/d0/hivemap_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d1/hivemap_8c.html#a6">HvpBuildMapAndCopy</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, PVOID Image, <a class="el" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> TailDisplay OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d1/hivemap_8c.html#a7">HvpInitMap</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d1/hivemap_8c.html#a8">HvpEnlistBinInMap</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, ULONG Length, <a class="el" href="../../d7/d4/struct__HBIN.html">PHBIN</a> <a class="el" href="../../d9/d0/hivechek_8c.html#a6">Bin</a>, ULONG <a class="el" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> TailDisplay OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d1/hivemap_8c.html#a9">HvpBuildMap</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, PVOID Image, <a class="el" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> TailDisplay OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d1/hivemap_8c.html#a10">HvpEnlistFreeCells</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d7/d4/struct__HBIN.html">PHBIN</a> <a class="el" href="../../d9/d0/hivechek_8c.html#a6">Bin</a>, ULONG BinOffset, <a class="el" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> TailDisplay OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d1/hivemap_8c.html#a11">HvpCleanMap</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d1/hivemap_8c.html#a12">HvpFreeMap</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d1/d8/struct__HMAP__DIRECTORY.html">PHMAP_DIRECTORY</a> Dir, ULONG <a class="el" href="../../d5/d2/config_2ia64_2initia64_8c.html#a14">Start</a>, ULONG <a class="el" href="../../d5/d2/config_2ia64_2initia64_8c.html#a15">End</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d1/hivemap_8c.html#a13">HvpAllocateMap</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d1/d8/struct__HMAP__DIRECTORY.html">PHMAP_DIRECTORY</a> Dir, ULONG <a class="el" href="../../d5/d2/config_2ia64_2initia64_8c.html#a14">Start</a>, ULONG <a class="el" href="../../d5/d2/config_2ia64_2initia64_8c.html#a15">End</a>)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap>struct {</td></tr>

<tr><td class="memItemLeft" nowrap>&nbsp;&nbsp;&nbsp;<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;&nbsp;&nbsp;<a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a></td></tr>

<tr><td class="memItemLeft" nowrap>&nbsp;&nbsp;&nbsp;ULONG&nbsp;&nbsp;&nbsp;<a class="el" href="../../d7/d1/hivemap_8c.html#a1">Status</a></td></tr>

<tr><td class="memItemLeft" nowrap>&nbsp;&nbsp;&nbsp;ULONG&nbsp;&nbsp;&nbsp;<a class="el" href="../../d7/d1/hivemap_8c.html#a2">Space</a></td></tr>

<tr><td class="memItemLeft" nowrap>&nbsp;&nbsp;&nbsp;<a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;&nbsp;&nbsp;<a class="el" href="../../d7/d1/hivemap_8c.html#a3">MapPoint</a></td></tr>

<tr><td class="memItemLeft" nowrap>&nbsp;&nbsp;&nbsp;<a class="el" href="../../d7/d4/struct__HBIN.html">PHBIN</a>&nbsp;&nbsp;&nbsp;<a class="el" href="../../d7/d1/hivemap_8c.html#a4">BinPoint</a></td></tr>

<tr><td class="memItemLeft" nowrap valign=top>}&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d1/hivemap_8c.html#a5">HvCheckHiveDebug</a></td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a13" doxytag="hivemap.c::HvpAllocateMap" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN HvpAllocateMap           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d1/d8/struct__HMAP__DIRECTORY.html">PHMAP_DIRECTORY</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Dir</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Start</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>End</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00853">853</a> of file <a class="el" href="../../d8/d0/hivemap_8c-source.html">hivemap.c</a>.
<p>
References <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00597">_HHIVE::Allocate</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00447">_HMAP_DIRECTORY::Directory</a>, <a class="el" href="../../d0/d1/config_2i386_2init386_8c-source.html#l00050">End</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d1/config_2i386_2init386_8c-source.html#l00049">Start</a>, <a class="el" href="../../d5/d0/genmips_8c-source.html#l00109">t()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d9/hivebin_8c-source.html#l00046">HvpAddBin()</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00047">HvpBuildMapAndCopy()</a>, and <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00304">HvpInitMap()</a>.
<p>
<pre class="fragment"><div>00861                    :
00862 
00863     Sweeps through <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> directory Dir points to and allocates Tables.
00864     Will allocate <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>-th through <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>-th entries, INCLUSIVE.
00865 
00866     Does NOT clean up when <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> of memory, call <a class="code" href="../../d6/d0/hive_8h.html#a16">HvpFreeMap</a> to <span class="keywordflow">do</span> that.
00867 Arguments:
00868 
00869     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block of interest
00870 
00871     Dir - supplies address of an <a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">HMAP_DIRECTORY</a> structure
00872 
00873     <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> - index of first map table pointer to allocate <span class="keywordflow">for</span>
00874 
00875     <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> - index of last map table pointer to allocate <span class="keywordflow">for</span>
00876 
00877 Return Value:
00878 
00879     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> worked
00880 
00881     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - insufficient memory
00882 
00883 --*/
00884 {
00885     ULONG   i;
00886     PVOID   <a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>;
00887 
00888     <span class="keywordflow">for</span> (i = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>; i &lt;= <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>; i++) {
00889         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Dir-&gt;<a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html#o0">Directory</a>[i] == NULL);
00890         <a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> = (PVOID)((<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<span class="keyword">sizeof</span>(<a class="code" href="../../d3/d8/struct__HMAP__TABLE.html">HMAP_TABLE</a>), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>));
00891         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00892             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00893         }
00894         RtlZeroMemory(t, <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d8/struct__HMAP__TABLE.html">HMAP_TABLE</a>));
00895         Dir-&gt;<a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html#o0">Directory</a>[i] = (<a class="code" href="../../d3/d8/struct__HMAP__TABLE.html">PHMAP_TABLE</a>)<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>;
00896     }
00897     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00898 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="hivemap.c::HvpBuildMap" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS HvpBuildMap           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Image</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> TailDisplay&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00536">536</a> of file <a class="el" href="../../d8/d0/hivemap_8c-source.html">hivemap.c</a>.
<p>
References <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00136">Bin</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00248">CML_FLOW</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00258">CMS_HIVE</a>, <a class="el" href="../../d2/d9/tdisp_8c-source.html#l00009">ErrorExit()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00193">_HBIN::FileOffset</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00187">HBIN_SIGNATURE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00122">HBLOCK_SIZE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00751">HvpCleanMap()</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00437">HvpEnlistBinInMap()</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00304">HvpInitMap()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00033">Offset</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00192">_HBIN::Signature</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00194">_HBIN::Size</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/hiveinit_8c-source.html#l00158">HvInitializeHive()</a>.
<p>
<pre class="fragment"><div>00543                    :
00544 
00545     Creates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> map <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a> storage of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive, and inits
00546     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> map <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">volatile</span> storage.
00547 
00548     Following fields in hive must already be filled in:
00549 
00550          Allocate, Free
00551 
00552     Will initialize Storage structure of <a class="code" href="../../d7/d7/struct__HHIVE.html">HHIVE</a>.
00553 
00554 Arguments:
00555 
00556     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - Pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure to build map <span class="keywordflow">for</span>.
00557 
00558     Image - pointer to in memory image of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive
00559 
00560 Return Value:
00561 
00562     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> worked
00563     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - either hive <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> corrupt or no memory <span class="keywordflow">for</span> map
00564 
00565 --*/
00566 {
00567     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>           <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
00568     ULONG           <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
00569     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00570     ULONG           Length;
00571 
00572 
00573     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_HIVE) {
00574         KdPrint((<span class="stringliteral">"HvpBuildMap:\n"</span>));
00575         KdPrint((<span class="stringliteral">"\tHive=%08lx"</span>,Hive));
00576     }
00577 
00578     <span class="comment">//</span>
00579     <span class="comment">// Init the map</span>
00580     <span class="comment">//</span>
00581     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/hivemap_8c.html#a7">HvpInitMap</a>(Hive);
00582 
00583     <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
00584         <span class="comment">//</span>
00585         <span class="comment">// just return failure; HvpInitMap took care of cleanup</span>
00586         <span class="comment">//</span>
00587         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00588     }
00589 
00590     <span class="comment">//</span>
00591     <span class="comment">// Fill in the map</span>
00592     <span class="comment">//</span>
00593     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = 0;
00594     <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)Image;
00595     Length = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Length;
00596 
00597     <span class="keywordflow">while</span> (<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> &lt; (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)((PUCHAR)(Image) + Length)) {
00598 
00599         <span class="comment">//</span>
00600         <span class="comment">// Check the validity of the bin header</span>
00601         <span class="comment">//</span>
00602         <span class="keywordflow">if</span> ( (<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a> &gt; Length)                       ||
00603              (<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a> &lt; <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>)                  ||
00604              (<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o0">Signature</a> != <a class="code" href="../../d0/d1/hivedata_8h.html#a24">HBIN_SIGNATURE</a>)         ||
00605              (<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a> != <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>)) {
00606             <span class="comment">//</span>
00607             <span class="comment">// Bin is bogus</span>
00608             <span class="comment">//</span>
00609             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_REGISTRY_CORRUPT;
00610             <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.Hive = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
00611             <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.Status = 0xA001;
00612             <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.Space = Length;
00613             <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.MapPoint = <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
00614             <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.BinPoint = <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
00615             <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
00616         }
00617 
00618         <span class="comment">//</span>
00619         <span class="comment">// enlist this bin</span>
00620         <span class="comment">//</span>
00621         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/hivemap_8c.html#a8">HvpEnlistBinInMap</a>(Hive, Length, Bin, Offset, TailDisplay);
00622 
00623         <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
00624             <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
00625         }
00626 
00627         <span class="comment">//</span>
00628         <span class="comment">// the next bin</span>
00629         <span class="comment">//</span>
00630         <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> += <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>;
00631 
00632         <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)((ULONG_PTR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> + <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>);
00633     }
00634 
00635     <span class="keywordflow">return</span> STATUS_SUCCESS;
00636 
00637 
00638 <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>:
00639     <span class="comment">//</span>
00640     <span class="comment">// Clean up the directory table</span>
00641     <span class="comment">//</span>
00642     <a class="code" href="../../d7/d1/hivemap_8c.html#a11">HvpCleanMap</a>( Hive );
00643 
00644     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00645 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="hivemap.c::HvpBuildMapAndCopy" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS HvpBuildMapAndCopy           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Image</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> TailDisplay&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00047">47</a> of file <a class="el" href="../../d8/d0/hivemap_8c-source.html">hivemap.c</a>.
<p>
References <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00597">_HHIVE::Allocate</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00605">_HHIVE::BaseBlock</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00136">Bin</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00423">_HMAP_ENTRY::BinAddress</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00417">_HMAP_ENTRY::BlockAddress</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00248">CML_FLOW</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00258">CMS_HIVE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00609">_HHIVE::DirtyAlloc</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00607">_HHIVE::DirtyVector</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00193">_HBIN::FileOffset</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00598">_HHIVE::Free</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00187">HBIN_SIGNATURE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00122">HBLOCK_SIZE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00413">HMAP_NEWALLOC</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00129">HSECTOR_SIZE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00132">HTABLE_SLOTS</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00853">HvpAllocateMap()</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00649">HvpEnlistFreeCells()</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00807">HvpFreeMap()</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00285">HvpGetCellMap()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00344">_HBASE_BLOCK::Length</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00200">_HBIN::MemAlloc</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00033">Offset</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00617">_HHIVE::ReadOnly</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00049">ROUND_UP</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l00219">RtlInitializeBitMap()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00192">_HBIN::Signature</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00194">_HBIN::Size</a>, <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d5/d0/genmips_8c-source.html#l00109">t()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d2/d1/cmp_8h-source.html#l00378">VALIDATE_CELL_MAP</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/hiveinit_8c-source.html#l00158">HvInitializeHive()</a>.
<p>
<pre class="fragment"><div>00054                    :
00055 
00056     Creates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> map <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a> storage of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive, and inits
00057     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> map <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">volatile</span> storage.
00058 
00059     Following fields in hive must already be filled in:
00060 
00061          Allocate, Free
00062 
00063     Will initialize Storage structure of <a class="code" href="../../d7/d7/struct__HHIVE.html">HHIVE</a>.
00064 
00065     The difference between <span class="keyword">this</span> routine and <a class="code" href="../../d6/d0/hive_8h.html#a22">HvpBuildMapAndCopy</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> that
00066     <span class="keyword">this</span> routine will create a <span class="stringliteral">"sparse"</span> map.  As <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> copies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SourceImage
00067     to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> newly allocated memory <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> destination, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> will avoid
00068     allocating space <span class="keywordflow">for</span> HBINs that contain nothing but free space.  The
00069     HBLOCKs in these HBINs will be marked as discarded, and <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>
00070     will allocate memory <span class="keywordflow">for</span> them <span class="keywordflow">if</span> necessary.
00071 
00072 Arguments:
00073 
00074     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - Pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure to build map <span class="keywordflow">for</span>.
00075 
00076     Image - pointer to flat memory image of original hive.
00077 
00078 Return Value:
00079 
00080     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> worked
00081     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - either hive <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> corrupt or no memory <span class="keywordflow">for</span> map
00082 
00083 --*/
00084 {
00085     <a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>    BaseBlock;
00086     ULONG           Length;
00087     ULONG           MapSlots;
00088     ULONG           Tables;
00089     <a class="code" href="../../d3/d8/struct__HMAP__TABLE.html">PHMAP_TABLE</a>     <a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00090     <a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">PHMAP_DIRECTORY</a> d = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00091     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>           <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
00092     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>           NewBins;
00093     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>           CurrentBin;
00094     ULONG           <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
00095     ULONG_PTR        Address;
00096     <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a>     Me;
00097     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00098     PULONG          Vector;
00099     ULONG           <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00100 
00101 
00102     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_HIVE) {
00103         KdPrint((<span class="stringliteral">"HvpBuildMap:\n"</span>));
00104         KdPrint((<span class="stringliteral">"\tHive=%08lx"</span>,Hive));
00105     }
00106 
00107 
00108     <span class="comment">//</span>
00109     <span class="comment">// Compute size of data region to be mapped</span>
00110     <span class="comment">//</span>
00111     BaseBlock = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>;
00112     Length = BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o9">Length</a>;
00113     <span class="keywordflow">if</span> ((Length % <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>) != 0 ) {
00114         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_REGISTRY_CORRUPT;
00115         <span class="keywordflow">goto</span> ErrorExit1;
00116     }
00117     MapSlots = Length / <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
00118     <span class="keywordflow">if</span>( MapSlots &gt; 0 ) {
00119         Tables = (MapSlots-1) / <a class="code" href="../../d0/d1/hivedata_8h.html#a17">HTABLE_SLOTS</a>;
00120     } <span class="keywordflow">else</span> {
00121         Tables = 0;
00122     }
00123 
00124     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Length = Length;
00125 
00126     <span class="comment">//</span>
00127     <span class="comment">// allocate dirty vector if one is not already present (from HvpRecoverData)</span>
00128     <span class="comment">//</span>
00129 
00130     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00131         Vector = (PULONG)((<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>(Length/HSECTOR_SIZE/8,<span class="keyword">sizeof</span>(ULONG)), <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>));
00132         <span class="keywordflow">if</span> (Vector == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00133             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
00134             <span class="keywordflow">goto</span> ErrorExit1;
00135         }
00136         RtlZeroMemory(Vector, Length / HSECTOR_SIZE / 8);
00137         <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a26">RtlInitializeBitMap</a>(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>, Vector, Length / HSECTOR_SIZE);
00138         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o11">DirtyAlloc</a> = (Length/<a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>/8);
00139     }
00140 
00141     <span class="comment">//</span>
00142     <span class="comment">// allocate and build structure for map</span>
00143     <span class="comment">//</span>
00144     <span class="keywordflow">if</span> (Tables == 0) {
00145 
00146         <span class="comment">//</span>
00147         <span class="comment">// Just 1 table, no need for directory</span>
00148         <span class="comment">//</span>
00149         <a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<span class="keyword">sizeof</span>(<a class="code" href="../../d3/d8/struct__HMAP__TABLE.html">HMAP_TABLE</a>), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00150         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00151             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00152             <span class="keywordflow">goto</span> ErrorExit1;
00153         }
00154         RtlZeroMemory(t, <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d8/struct__HMAP__TABLE.html">HMAP_TABLE</a>));
00155         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Map =
00156             (<a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">PHMAP_DIRECTORY</a>)&amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].SmallDir);
00157         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].SmallDir = <a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>;
00158 
00159     } <span class="keywordflow">else</span> {
00160 
00161         <span class="comment">//</span>
00162         <span class="comment">// Need directory and multiple tables</span>
00163         <span class="comment">//</span>
00164         d = (<a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">PHMAP_DIRECTORY</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<span class="keyword">sizeof</span>(<a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">HMAP_DIRECTORY</a>), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00165         <span class="keywordflow">if</span> (d == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00166             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00167             <span class="keywordflow">goto</span> ErrorExit1;
00168         }
00169         RtlZeroMemory(d, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">HMAP_DIRECTORY</a>));
00170 
00171         <span class="comment">//</span>
00172         <span class="comment">// Allocate tables and fill in dir</span>
00173         <span class="comment">//</span>
00174         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d1/hivemap_8c.html#a13">HvpAllocateMap</a>(Hive, d, 0, Tables) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00175             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00176             <span class="keywordflow">goto</span> ErrorExit2;
00177         }
00178         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Map = d;
00179         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].SmallDir = 0;
00180     }
00181 
00182     <span class="comment">//</span>
00183     <span class="comment">// Now we have to allocate the memory for the HBINs and fill in</span>
00184     <span class="comment">// the map appropriately.  We are careful never to allocate less</span>
00185     <span class="comment">// than a page to avoid fragmenting pool.  As long as the page</span>
00186     <span class="comment">// size is a multiple of HBLOCK_SIZE (a fairly good assumption as</span>
00187     <span class="comment">// long as HBLOCK_SIZE is 4k) this strategy will prevent pool</span>
00188     <span class="comment">// fragmentation.</span>
00189     <span class="comment">//</span>
00190     <span class="comment">// If we come across an HBIN that is entirely composed of a freed</span>
00191     <span class="comment">// HCELL, then we do not allocate memory, but mark its HBLOCKs in</span>
00192     <span class="comment">// the map as not present.  HvAllocateCell will allocate memory for</span>
00193     <span class="comment">// the bin when it is needed.</span>
00194     <span class="comment">//</span>
00195     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = 0;
00196     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = 0;
00197     <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)Image;
00198 
00199     <span class="keywordflow">while</span> (<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> &lt; (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)((PUCHAR)(Image) + Length)) {
00200 
00201         <span class="keywordflow">if</span> ( (<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a> &gt; (Length-<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>))               ||
00202              (<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o0">Signature</a> != <a class="code" href="../../d0/d1/hivedata_8h.html#a24">HBIN_SIGNATURE</a>)         ||
00203              (<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a> != (<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>+<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>))
00204            )
00205         {
00206             <span class="comment">//</span>
00207             <span class="comment">// Bin is bogus</span>
00208             <span class="comment">//</span>
00209             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_REGISTRY_CORRUPT;
00210             <span class="keywordflow">goto</span> ErrorExit2;
00211         }
00212 
00213         <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> += <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>;
00214         <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> &lt; <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) &amp;&amp;
00215             (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> + Length - <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> &gt; <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>)) {
00216 
00217             <span class="comment">//</span>
00218             <span class="comment">// We haven't accumulated enough bins to fill up a page</span>
00219             <span class="comment">// yet, and there are still bins left, so group this one</span>
00220             <span class="comment">// in with the next one.</span>
00221             <span class="comment">//</span>
00222             <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)((ULONG_PTR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> + <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>);
00223 
00224             <span class="keywordflow">continue</span>;
00225 
00226         }
00227 
00228         <span class="comment">//</span>
00229         <span class="comment">// We now have a series of HBINs to group together in one</span>
00230         <span class="comment">// chunk of memory.</span>
00231         <span class="comment">//</span>
00232         NewBins = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00233         <span class="keywordflow">if</span> (NewBins==<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00234             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00235             <span class="keywordflow">goto</span> ErrorExit2;        <span class="comment">//fixfix</span>
00236         }
00237         RtlCopyMemory(NewBins,
00238                       (PUCHAR)Image+Offset,
00239                       Size);
00240         NewBins-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o5">MemAlloc</a> = <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00241 
00242         <span class="comment">//</span>
00243         <span class="comment">// create map entries for each block/page in bin</span>
00244         <span class="comment">//</span>
00245         Address = (ULONG_PTR)NewBins;
00246         <span class="keywordflow">do</span> {
00247             CurrentBin = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)Address;
00248             <span class="keywordflow">do</span> {
00249                 Me = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(Hive, Offset);
00250                 <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Me,Hive,Offset);
00251                 Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o0">BlockAddress</a> = Address;
00252                 Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> = (ULONG_PTR)CurrentBin;
00253 
00254                 <span class="keywordflow">if</span> (CurrentBin == NewBins) {
00255                     Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> |= <a class="code" href="../../d0/d1/hivedata_8h.html#a35">HMAP_NEWALLOC</a>;
00256                 } <span class="keywordflow">else</span> {
00257                     CurrentBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o5">MemAlloc</a> = 0;
00258                 }
00259                 Address += <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
00260                 <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> += <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
00261             } <span class="keywordflow">while</span> ( Address &lt; ((ULONG_PTR)CurrentBin + CurrentBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a> ));
00262 
00263             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00264 
00265                 <span class="comment">//</span>
00266                 <span class="comment">// add free cells in the bin to the appropriate free lists</span>
00267                 <span class="comment">//</span>
00268                 <span class="keywordflow">if</span> ( ! <a class="code" href="../../d7/d1/hivemap_8c.html#a10">HvpEnlistFreeCells</a>(Hive,
00269                                           CurrentBin,
00270                                           CurrentBin-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o1">FileOffset</a>,
00271                                           TailDisplay
00272                                           )) {
00273                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_REGISTRY_CORRUPT;
00274                     <span class="keywordflow">goto</span> ErrorExit2;
00275                 }
00276 
00277             }
00278 
00279         } <span class="keywordflow">while</span> ( Address &lt; (ULONG_PTR)NewBins + <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> );
00280 
00281         <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)((ULONG_PTR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> + <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>);
00282         <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = 0;
00283     }
00284 
00285     <span class="keywordflow">return</span> STATUS_SUCCESS;
00286 
00287 
00288 ErrorExit2:
00289     <span class="keywordflow">if</span> (d != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00290 
00291         <span class="comment">//</span>
00292         <span class="comment">// directory was built and allocated, so clean it up</span>
00293         <span class="comment">//</span>
00294 
00295         <a class="code" href="../../d7/d1/hivemap_8c.html#a12">HvpFreeMap</a>(Hive, d, 0, Tables);
00296         (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(d, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">HMAP_DIRECTORY</a>));
00297     }
00298 
00299 ErrorExit1:
00300     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00301 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="hivemap.c::HvpCleanMap" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID HvpCleanMap           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Hive</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00751">751</a> of file <a class="el" href="../../d8/d0/hivemap_8c-source.html">hivemap.c</a>.
<p>
References <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00598">_HHIVE::Free</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00122">HBLOCK_SIZE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00132">HTABLE_SLOTS</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00807">HvpFreeMap()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>.
<p>
Referenced by <a class="el" href="../../d7/d0/hiveload_8c-source.html#l00100">HvLoadHive()</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00536">HvpBuildMap()</a>, and <a class="el" href="../../d7/d0/hiveload_8c-source.html#l00311">HvpReadFileImageAndBuildMap()</a>.
<p>
<pre class="fragment"><div>00756                    :
00757 
00758     Cleans all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> map allocations <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> stable storage
00759 
00760   Arguments:
00761 
00762     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - Pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure to build map <span class="keywordflow">for</span>.
00763 
00764 Return Value:
00765 
00766     None
00767 --*/
00768 {
00769     ULONG           Length;
00770     ULONG           MapSlots;
00771     ULONG           Tables;
00772     <a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">PHMAP_DIRECTORY</a> d = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00773 
00774     <span class="comment">//</span>
00775     <span class="comment">// Compute MapSlots and Tables based on the Length</span>
00776     <span class="comment">//</span>
00777     Length = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Length;
00778     MapSlots = Length / <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
00779     <span class="keywordflow">if</span>( MapSlots &gt; 0 ) {
00780         Tables = (MapSlots-1) / <a class="code" href="../../d0/d1/hivedata_8h.html#a17">HTABLE_SLOTS</a>;
00781     } <span class="keywordflow">else</span> {
00782         Tables = 0;
00783     }
00784 
00785     <span class="keywordflow">if</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].SmallDir == 0 ) {
00786         <span class="comment">//</span>
00787         <span class="comment">// directory was built and allocated, so clean it up</span>
00788         <span class="comment">//</span>
00789 
00790         d = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Map;
00791         <span class="keywordflow">if</span>( d != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00792             <a class="code" href="../../d7/d1/hivemap_8c.html#a12">HvpFreeMap</a>(Hive, d, 0, Tables);
00793             (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(d, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">HMAP_DIRECTORY</a>));
00794         }
00795     } <span class="keywordflow">else</span> {
00796         <span class="comment">//</span>
00797         <span class="comment">// no directory, just a smalldir</span>
00798         <span class="comment">//</span>
00799         (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].SmallDir, <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d8/struct__HMAP__TABLE.html">HMAP_TABLE</a>));
00800     }
00801     
00802     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].SmallDir = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00803     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Map = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00804 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="hivemap.c::HvpEnlistBinInMap" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS HvpEnlistBinInMap           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d4/struct__HBIN.html">PHBIN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Bin</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Offset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> TailDisplay&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00437">437</a> of file <a class="el" href="../../d8/d0/hivemap_8c-source.html">hivemap.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00136">Bin</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00423">_HMAP_ENTRY::BinAddress</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00417">_HMAP_ENTRY::BlockAddress</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00249">CML_BIN</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00248">CML_FLOW</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00269">CMS_BIN_MAP</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00258">CMS_HIVE</a>, <a class="el" href="../../d2/d9/tdisp_8c-source.html#l00009">ErrorExit()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00122">HBLOCK_SIZE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00413">HMAP_NEWALLOC</a>, <a class="el" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00649">HvpEnlistFreeCells()</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00285">HvpGetCellMap()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00200">_HBIN::MemAlloc</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00033">Offset</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00617">_HHIVE::ReadOnly</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00194">_HBIN::Size</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d2/d1/cmp_8h-source.html#l00378">VALIDATE_CELL_MAP</a>.
<p>
Referenced by <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00536">HvpBuildMap()</a>, <a class="el" href="../../d7/d0/hiveload_8c-source.html#l00311">HvpReadFileImageAndBuildMap()</a>, and <a class="el" href="../../d7/d0/hiveload_8c-source.html#l00847">HvpRecoverData()</a>.
<p>
<pre class="fragment"><div>00446                    :
00447 
00448     Creates map entries and enlist free cells <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified bin 
00449 
00450 Arguments:
00451 
00452     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - Pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target map
00453 
00454     Length - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive image
00455 
00456     <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bin to be enlisted
00457 
00458     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> offset within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>
00459 
00460     TailDisplay - array containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tail ends of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> free cell lists - optional
00461 
00462 Return Value:
00463 
00464     STATUS_SUCCESS - <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> worked
00465     STATUS_REGISTRY_CORRUPT - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bin <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> inconsistent
00466 
00467 --*/
00468 {
00469     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00470     ULONG           BinOffset;
00471     ULONG_PTR       Address;
00472     <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a>     Me;
00473 
00474     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_HIVE) {
00475         KdPrint((<span class="stringliteral">"HvpEnlistBinInMap:\n"</span>));
00476         KdPrint((<span class="stringliteral">"\tHive=%08lx\t Offset=%08lx"</span>,Hive,Offset));
00477     }
00478 
00479     <span class="comment">//</span>
00480     <span class="comment">// memory was allocated for this bin</span>
00481     <span class="comment">//</span>
00482     <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o5">MemAlloc</a> = <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>;
00483     
00484     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BIN, CMS_BIN_MAP) {
00485         KdPrint((<span class="stringliteral">"HvpEnlistBinInMap: BinAddress = 0x%08lx\t Size = 0x%lx\n"</span>, Bin, <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>));
00486     }
00487 
00488     <span class="comment">//</span>
00489     <span class="comment">// create map entries for each block/page in bin</span>
00490     <span class="comment">//</span>
00491     BinOffset = <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
00492     <span class="keywordflow">for</span> (Address = (ULONG_PTR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
00493          Address &lt; ((ULONG_PTR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> + <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>);
00494          Address += <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>
00495         )
00496     {
00497         Me = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(Hive, Offset);
00498         <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Me,Hive,Offset);
00499         Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o0">BlockAddress</a> = Address;
00500         Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> = (ULONG_PTR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
00501         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> == BinOffset) {
00502             Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> |= <a class="code" href="../../d0/d1/hivedata_8h.html#a35">HMAP_NEWALLOC</a>;
00503         }
00504         <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> += <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
00505     }
00506 
00507     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00508 
00509         <span class="comment">//</span>
00510         <span class="comment">// add free cells in the bin to the appropriate free lists</span>
00511         <span class="comment">//</span>
00512         <span class="keywordflow">if</span> ( ! <a class="code" href="../../d7/d1/hivemap_8c.html#a10">HvpEnlistFreeCells</a>(Hive, Bin, BinOffset,TailDisplay)) {
00513             <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.Hive = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
00514             <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.Status = 0xA002;
00515             <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.Space = Length;
00516             <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.MapPoint = BinOffset;
00517             <a class="code" href="../../d7/d0/cmdat2_8c.html#a35">HvCheckHiveDebug</a>.BinPoint = <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
00518             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_REGISTRY_CORRUPT;
00519             <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
00520         }
00521 
00522     }
00523 
00524     <span class="comment">//</span>
00525     <span class="comment">// logical consistency check</span>
00526     <span class="comment">//</span>
00527     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Offset == (BinOffset + <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>));
00528 
00529     <span class="keywordflow">return</span> STATUS_SUCCESS;
00530 
00531 <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>:
00532     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00533 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="hivemap.c::HvpEnlistFreeCells" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN HvpEnlistFreeCells           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d4/struct__HBIN.html">PHBIN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Bin</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BinOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> TailDisplay&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00649">649</a> of file <a class="el" href="../../d8/d0/hivemap_8c-source.html">hivemap.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00136">Bin</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00143">HCELL_PAD</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00947">HvpEnlistFreeCell()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00164">_HCELL::Size</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00194">_HBIN::Size</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00047">HvpBuildMapAndCopy()</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00437">HvpEnlistBinInMap()</a>, <a class="el" href="../../d7/d0/hiveload_8c-source.html#l00847">HvpRecoverData()</a>, and <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01584">HvRefreshHive()</a>.
<p>
<pre class="fragment"><div>00657                    :
00658 
00659     Scan through <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cells in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bin, locating <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> free ones.
00660     Enlist them in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive's free list set.
00661 
00662     N.B.    <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> MUST already be mapped when <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called.
00663 
00664 Arguments:
00665 
00666     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure map <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being built <span class="keywordflow">for</span>
00667 
00668     <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> - pointer to bin to enlist cells from
00669 
00670     BinOffset - offset of <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> in image
00671 
00672 Return Value:
00673 
00674     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - registry <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> corrupt
00675 
00676     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> worked
00677 
00678 --*/
00679 {
00680     <a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>  p;
00681     ULONG   celloffset;
00682     ULONG   size;
00683     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> cellindex;
00684 
00685     <span class="comment">// PERFNOTE -- Keep this in mind as a possible optimization for NT6.</span>
00686     <span class="comment">// Since now the hive is loaded in chunks of bins, we can drop the </span>
00687     <span class="comment">// bins that are entirely free!!!!!!</span>
00688     <span class="comment">//</span>
00689 
00690     <span class="comment">//</span>
00691     <span class="comment">// Scan all the cells in the bin, total free and allocated, check</span>
00692     <span class="comment">// for impossible pointers.</span>
00693     <span class="comment">//</span>
00694     celloffset = <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d4/struct__HBIN.html">HBIN</a>);
00695     p = (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((PUCHAR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> + <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d4/struct__HBIN.html">HBIN</a>));
00696 
00697     <span class="keywordflow">while</span> (p &lt; (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((PUCHAR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> + <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>)) {
00698 
00699         <span class="comment">//</span>
00700         <span class="comment">// if free cell, check it out, add it to free list for hive</span>
00701         <span class="comment">//</span>
00702         <span class="keywordflow">if</span> (p-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a> &gt;= 0) {
00703 
00704             size = (ULONG)p-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a>;
00705 
00706             <span class="keywordflow">if</span> ( (size &gt; <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>)               ||
00707                  ( (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)(size + (PUCHAR)p) &gt;
00708                    (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((PUCHAR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> + <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>) ) ||
00709                  ((size % <a class="code" href="../../d0/d1/hivedata_8h.html#a20">HCELL_PAD</a>(Hive)) != 0) ||
00710                  (size == 0) )
00711             {
00712                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00713             }
00714 
00715 
00716             <span class="comment">//</span>
00717             <span class="comment">// cell is free, and is not obviously corrupt, add to free list</span>
00718             <span class="comment">//</span>
00719             celloffset = (ULONG)((PUCHAR)p - (PUCHAR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>);
00720             cellindex = BinOffset + celloffset;
00721 
00722             <span class="comment">//</span>
00723             <span class="comment">// Enlist this free cell, but do not coalesce with the next free cell</span>
00724             <span class="comment">// as we haven't gotten that far yet.</span>
00725             <span class="comment">//</span>
00726             <a class="code" href="../../d8/d0/hivecell_8c.html#a18">HvpEnlistFreeCell</a>(Hive, cellindex, size, Stable, FALSE,TailDisplay);
00727 
00728         } <span class="keywordflow">else</span> {
00729 
00730             size = (ULONG)(p-&gt;<a class="code" href="../../d8/d4/struct__HCELL.html#o0">Size</a> * -1);
00731 
00732             <span class="keywordflow">if</span> ( (size &gt; <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>)               ||
00733                  ( (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)(size + (PUCHAR)p) &gt;
00734                    (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((PUCHAR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> + <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>) ) ||
00735                  ((size % <a class="code" href="../../d0/d1/hivedata_8h.html#a20">HCELL_PAD</a>(Hive)) != 0) ||
00736                  (size == 0) )
00737             {
00738                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00739             }
00740 
00741         }
00742 
00743         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(size &gt;= 0);
00744         p = (<a class="code" href="../../d8/d4/struct__HCELL.html">PHCELL</a>)((PUCHAR)p + size);
00745     }
00746 
00747     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00748 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="hivemap.c::HvpFreeMap" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID HvpFreeMap           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d1/d8/struct__HMAP__DIRECTORY.html">PHMAP_DIRECTORY</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Dir</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Start</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>End</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00807">807</a> of file <a class="el" href="../../d8/d0/hivemap_8c-source.html">hivemap.c</a>.
<p>
References <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00447">_HMAP_DIRECTORY::Directory</a>, <a class="el" href="../../d0/d1/config_2i386_2init386_8c-source.html#l00050">End</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00598">_HHIVE::Free</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00133">HDIRECTORY_SLOTS</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d0/d1/config_2i386_2init386_8c-source.html#l00049">Start</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/hivefree_8c-source.html#l00034">HvFreeHive()</a>, <a class="el" href="../../d3/d0/hivefree_8c-source.html#l00160">HvFreeHivePartial()</a>, <a class="el" href="../../d8/d9/hivebin_8c-source.html#l00046">HvpAddBin()</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00047">HvpBuildMapAndCopy()</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00751">HvpCleanMap()</a>, and <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00304">HvpInitMap()</a>.
<p>
<pre class="fragment"><div>00815                    :
00816 
00817     Sweeps through <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> directory Dir points to and frees Tables.
00818     Will free <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>-th through <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>-th entries, INCLUSIVE.
00819 
00820 Arguments:
00821 
00822     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block of interest
00823 
00824     Dir - supplies address of an <a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">HMAP_DIRECTORY</a> structure
00825 
00826     <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> - index of first map table pointer to clean up
00827 
00828     <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> - index of last map table pointer to clean up
00829 
00830 Return Value:
00831 
00832     NONE.
00833 
00834 --*/
00835 {
00836     ULONG   i;
00837 
00838     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> &gt;= <a class="code" href="../../d0/d1/hivedata_8h.html#a18">HDIRECTORY_SLOTS</a>) {
00839         <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a18">HDIRECTORY_SLOTS</a> - 1;
00840     }
00841 
00842     <span class="keywordflow">for</span> (i = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>; i &lt;= <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>; i++) {
00843         <span class="keywordflow">if</span> (Dir-&gt;<a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html#o0">Directory</a>[i] != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00844             (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(Dir-&gt;<a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html#o0">Directory</a>[i], <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d8/struct__HMAP__TABLE.html">HMAP_TABLE</a>));
00845             Dir-&gt;<a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html#o0">Directory</a>[i] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00846         }
00847     }
00848     <span class="keywordflow">return</span>;
00849 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="hivemap.c::HvpInitMap" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS HvpInitMap           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Hive</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00304">304</a> of file <a class="el" href="../../d8/d0/hivemap_8c-source.html">hivemap.c</a>.
<p>
References <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00597">_HHIVE::Allocate</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00605">_HHIVE::BaseBlock</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00248">CML_FLOW</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00258">CMS_HIVE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00609">_HHIVE::DirtyAlloc</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00607">_HHIVE::DirtyVector</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00598">_HHIVE::Free</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00122">HBLOCK_SIZE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00129">HSECTOR_SIZE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00132">HTABLE_SLOTS</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00853">HvpAllocateMap()</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00807">HvpFreeMap()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00344">_HBASE_BLOCK::Length</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00049">ROUND_UP</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l00219">RtlInitializeBitMap()</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d5/d0/genmips_8c-source.html#l00109">t()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00536">HvpBuildMap()</a>, and <a class="el" href="../../d7/d0/hiveload_8c-source.html#l00311">HvpReadFileImageAndBuildMap()</a>.
<p>
<pre class="fragment"><div>00309                    :
00310 
00311     Initialize <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> map <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a> <a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a> storage of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive.
00312 
00313     Following fields in hive must already be filled in:
00314 
00315          Allocate, Free
00316 
00317     Will initialize Storage structure of <a class="code" href="../../d7/d7/struct__HHIVE.html">HHIVE</a>.
00318 
00319 Arguments:
00320 
00321     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - Pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure to build map <span class="keywordflow">for</span>.
00322 
00323 Return Value:
00324 
00325     STATUS_SUCCESS - <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> worked
00326     STATUS_xxx - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> errorneous status
00327 
00328 --*/
00329 {
00330     <a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>    BaseBlock;
00331     ULONG           Length;
00332     ULONG           MapSlots;
00333     ULONG           Tables;
00334     <a class="code" href="../../d3/d8/struct__HMAP__TABLE.html">PHMAP_TABLE</a>     <a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00335     <a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">PHMAP_DIRECTORY</a> d = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00336     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00337     PULONG          Vector;
00338 
00339     
00340     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_FLOW, CMS_HIVE) {
00341         KdPrint((<span class="stringliteral">"HvpInitMap:\n"</span>));
00342         KdPrint((<span class="stringliteral">"\tHive=%08lx"</span>,Hive));
00343     }
00344 
00345     <span class="comment">//</span>
00346     <span class="comment">// Compute size of data region to be mapped</span>
00347     <span class="comment">//</span>
00348     BaseBlock = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>;
00349     Length = BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o9">Length</a>;
00350     <span class="keywordflow">if</span> ((Length % <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>) != 0) {
00351         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_REGISTRY_CORRUPT;
00352         <span class="keywordflow">goto</span> ErrorExit1;
00353     }
00354     MapSlots = Length / <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
00355     <span class="keywordflow">if</span>( MapSlots &gt; 0 ) {
00356         Tables = (MapSlots-1) / <a class="code" href="../../d0/d1/hivedata_8h.html#a17">HTABLE_SLOTS</a>;
00357     } <span class="keywordflow">else</span> {
00358         Tables = 0;
00359     }
00360 
00361     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Length = Length;
00362 
00363     <span class="comment">//</span>
00364     <span class="comment">// allocate dirty vector if one is not already present (from HvpRecoverData)</span>
00365     <span class="comment">//</span>
00366 
00367     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00368         Vector = (PULONG)((<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>(Length/HSECTOR_SIZE/8,<span class="keyword">sizeof</span>(ULONG)), <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>));
00369         <span class="keywordflow">if</span> (Vector == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00370             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
00371             <span class="keywordflow">goto</span> ErrorExit1;
00372         }
00373         RtlZeroMemory(Vector, Length / HSECTOR_SIZE / 8);
00374         <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a26">RtlInitializeBitMap</a>(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>, Vector, Length / HSECTOR_SIZE);
00375         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o11">DirtyAlloc</a> = (Length/<a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>/8);
00376     }
00377 
00378     <span class="comment">//</span>
00379     <span class="comment">// allocate and build structure for map</span>
00380     <span class="comment">//</span>
00381     <span class="keywordflow">if</span> (Tables == 0) {
00382 
00383         <span class="comment">//</span>
00384         <span class="comment">// Just 1 table, no need for directory</span>
00385         <span class="comment">//</span>
00386         <a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<span class="keyword">sizeof</span>(<a class="code" href="../../d3/d8/struct__HMAP__TABLE.html">HMAP_TABLE</a>), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00387         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00388             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00389             <span class="keywordflow">goto</span> ErrorExit1;
00390         }
00391         RtlZeroMemory(t, <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d8/struct__HMAP__TABLE.html">HMAP_TABLE</a>));
00392         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Map =
00393             (<a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">PHMAP_DIRECTORY</a>)&amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].SmallDir);
00394         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].SmallDir = <a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>;
00395 
00396     } <span class="keywordflow">else</span> {
00397 
00398         <span class="comment">//</span>
00399         <span class="comment">// Need directory and multiple tables</span>
00400         <span class="comment">//</span>
00401         d = (<a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">PHMAP_DIRECTORY</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<span class="keyword">sizeof</span>(<a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">HMAP_DIRECTORY</a>), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00402         <span class="keywordflow">if</span> (d == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00403             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00404             <span class="keywordflow">goto</span> ErrorExit1;
00405         }
00406         RtlZeroMemory(d, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">HMAP_DIRECTORY</a>));
00407 
00408         <span class="comment">//</span>
00409         <span class="comment">// Allocate tables and fill in dir</span>
00410         <span class="comment">//</span>
00411         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d1/hivemap_8c.html#a13">HvpAllocateMap</a>(Hive, d, 0, Tables) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00412             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00413             <span class="keywordflow">goto</span> ErrorExit2;
00414         }
00415         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Map = d;
00416         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].SmallDir = 0;
00417     }
00418 
00419     <span class="keywordflow">return</span> STATUS_SUCCESS;
00420 
00421 ErrorExit2:
00422     <span class="keywordflow">if</span> (d != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00423 
00424         <span class="comment">//</span>
00425         <span class="comment">// directory was built and allocated, so clean it up</span>
00426         <span class="comment">//</span>
00427 
00428         <a class="code" href="../../d7/d1/hivemap_8c.html#a12">HvpFreeMap</a>(Hive, d, 0, Tables);
00429         (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(d, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">HMAP_DIRECTORY</a>));
00430     }
00431 
00432 ErrorExit1:
00433     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00434 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a4" doxytag="hivemap.c::BinPoint" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d7/d4/struct__HBIN.html">PHBIN</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a4">BinPoint</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00043">43</a> of file <a class="el" href="../../d8/d0/hivemap_8c-source.html">hivemap.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="hivemap.c::Hive" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00039">39</a> of file <a class="el" href="../../d8/d0/hivemap_8c-source.html">hivemap.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="hivemap.c::HvCheckHiveDebug" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> struct { ... }   <a class="el" href="../../d7/d1/hivemap_8c.html#a5">HvCheckHiveDebug</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="hivemap.c::MapPoint" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a3">MapPoint</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00042">42</a> of file <a class="el" href="../../d8/d0/hivemap_8c-source.html">hivemap.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="hivemap.c::Space" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d2/d9/ps2_8c.html#a136">Space</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00041">41</a> of file <a class="el" href="../../d8/d0/hivemap_8c-source.html">hivemap.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="hivemap.c::Status" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d2/d1/cttoken_8c.html#a18">Status</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00040">40</a> of file <a class="el" href="../../d8/d0/hivemap_8c-source.html">hivemap.c</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:05 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
