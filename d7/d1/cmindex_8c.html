<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: cmindex.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>cmindex.c File Reference</h1><code>#include "<a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>"</code><br>

<p>
<a href="../../d8/d0/cmindex_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d1/cmindex_8c.html#a2">CmpFindSubKeyInRoot</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a27">Index</a>, PUNICODE_STRING SearchName, <a class="el" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> Child)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d1/cmindex_8c.html#a3">CmpFindSubKeyInLeaf</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a27">Index</a>, ULONG IndexHint, PUNICODE_STRING SearchName, <a class="el" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> Child)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d1/cmindex_8c.html#a4">CmpCompareInIndex</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, PUNICODE_STRING SearchName, ULONG <a class="el" href="../../d6/d0/cmdat_8c.html#a5">Count</a>, <a class="el" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a27">Index</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> Child)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d1/cmindex_8c.html#a5">CmpDoCompareKeyName</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, PUNICODE_STRING SearchName, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d1/cmindex_8c.html#a6">CmpDoFindSubKeyByNumber</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a27">Index</a>, ULONG Number)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d1/cmindex_8c.html#a7">CmpAddToLeaf</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> LeafCell, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> NewKey, PUNICODE_STRING <a class="el" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d1/cmindex_8c.html#a8">CmpSelectLeaf</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> ParentKey, PUNICODE_STRING <a class="el" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a77">HSTORAGE_TYPE</a> Type, <a class="el" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> *RootPointer)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d1/cmindex_8c.html#a9">CmpSplitLeaf</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> RootCell, ULONG RootSelect, <a class="el" href="../../d0/d1/hivedata_8h.html#a77">HSTORAGE_TYPE</a> Type)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d1/cmindex_8c.html#a10">CmpFindSubKeyByName</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Parent, PUNICODE_STRING SearchName)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d1/cmindex_8c.html#a11">CmpFindSubKeyByNumber</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Node, ULONG Number)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d1/cmindex_8c.html#a12">CmpAddSubKey</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> Parent, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> Child)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d1/cmindex_8c.html#a13">CmpMarkIndexDirty</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ParentKey, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> TargetKey)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d1/cmindex_8c.html#a14">CmpRemoveSubKey</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ParentKey, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> TargetKey)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d1/cmindex_8c.html#a0">CmpHintHits</a> = 0</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d1/cmindex_8c.html#a1">CmpHintMisses</a> = 0</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a12" doxytag="cmindex.c::CmpAddSubKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpAddSubKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Parent</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Child</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00895">895</a> of file <a class="el" href="../../d8/d0/cmindex_8c-source.html">cmindex.c</a>.
<p>
References <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00597">_HHIVE::Allocate</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00376">_CM_INDEX::Cell</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00373">CM_KEY_FAST_LEAF</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00372">CM_KEY_INDEX_LEAF</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00371">CM_KEY_INDEX_ROOT</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00408">CM_MAX_FAST_INDEX</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00396">CM_MAX_INDEX</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01087">CmpAddToLeaf()</a>, <a class="el" href="../../d0/d1/cmname_8c-source.html#l00121">CmpCompressedNameSize()</a>, <a class="el" href="../../d0/d1/cmname_8c-source.html#l00151">CmpCopyCompressedName()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01257">CmpSelectLeaf()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00268">CMS_INDEX</a>, <a class="el" href="../../d2/d9/tdisp_8c-source.html#l00009">ErrorExit()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00450">_CM_KEY_NODE::Flags</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00598">_HHIVE::Free</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00386">HvAllocateCell()</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00688">HvFreeCell()</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00135">HvGetCellType</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00440">KEY_COMP_NAME</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00383">_CM_KEY_FAST_INDEX::List</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00477">_CM_KEY_NODE::Name</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00475">_CM_KEY_NODE::NameLength</a>, <a class="el" href="../../d0/d2/rtreplac_8c-source.html#l00045">NewName</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00107">PHCELL_INDEX</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00454">_CM_KEY_NODE::SubKeyCounts</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00457">_CM_KEY_NODE::SubKeyLists</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00369">UseFastIndex</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00251">CmpCopySyncTree2()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l01252">CmpCreateLinkNode()</a>, <a class="el" href="../../d4/d1/cmparse2_8c-source.html#l00033">CmpDoCreate()</a>, and <a class="el" href="../../d0/d4/edithive_8c-source.html#l00625">EhCreateChild()</a>.
<p>
<pre class="fragment"><div>00902                    :
00903 
00904     Add a <span class="keyword">new</span> child subkey to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subkey index <span class="keywordflow">for</span> a cell.  The
00905     child MUST NOT already be present (bugcheck <span class="keywordflow">if</span> so.)
00906 
00907     NOTE:   We expect Parent to already be marked dirty.
00908             We will mark stuff in Index dirty
00909 
00910 Arguments:
00911 
00912     Hive - pointer to hive control structure <span class="keywordflow">for</span> hive of interest
00913 
00914     Parent - cell of key that will be parent of <span class="keyword">new</span> key
00915 
00916     Child - <span class="keyword">new</span> key to put in Paren't sub key list
00917 
00918 Return Value:
00919 
00920     TRUE - it worked
00921 
00922     FALSE - resource problem
00923 
00924 --*/
00925 {
00926     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>    pcell;
00927     HCELL_INDEX     WorkCell;
00928     <a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>   Index;
00929     <a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html">PCM_KEY_FAST_INDEX</a> FastIndex;
00930     UNICODE_STRING  NewName;
00931     HCELL_INDEX     LeafCell;
00932     PHCELL_INDEX    RootPointer = NULL;
00933     ULONG           cleanup = 0;
00934     ULONG           Type;
00935     BOOLEAN         IsCompressed;
00936     ULONG           i;
00937 
00938     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_INDEX) {
00939         KdPrint((<span class="stringliteral">"CmpAddSubKey:\n\t"</span>));
00940         KdPrint((<span class="stringliteral">"Hive=%08lx Parent=%08lx Child=%08lx\n"</span>,Hive,Parent,Child));
00941     }
00942 
00943     <span class="comment">//</span>
00944     <span class="comment">// build a name string</span>
00945     <span class="comment">//</span>
00946     pcell = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, Child);
00947     <span class="keywordflow">if</span> (pcell-&gt;Flags &amp; KEY_COMP_NAME) {
00948         IsCompressed = TRUE;
00949         <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.Length = <a class="code" href="../../d9/d1/cmname_8c.html#a2">CmpCompressedNameSize</a>(pcell-&gt;Name, pcell-&gt;NameLength);
00950         <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.MaximumLength = <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.Length;
00951         <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.Buffer = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.Length, FALSE);
00952         if (<a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.Buffer==NULL) {
00953             <span class="keywordflow">return</span>(FALSE);
00954         }
00955         <a class="code" href="../../d1/d2/cmp_8h.html#a318">CmpCopyCompressedName</a>(<a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.Buffer,
00956                               <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.MaximumLength,
00957                               pcell-&gt;Name,
00958                               pcell-&gt;NameLength);
00959     } <span class="keywordflow">else</span> {
00960         IsCompressed = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00961         <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.Length = pcell-&gt;NameLength;
00962         <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.MaximumLength = pcell-&gt;NameLength;
00963         <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.Buffer = &amp;(pcell-&gt;Name[0]);
00964     }
00965 
00966     pcell = (<a class="code" href="../../d9/d0/cmdata_8h.html#a79">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, Parent);
00967 
00968     Type = <a class="code" href="../../d0/d1/hivedata_8h.html#a19">HvGetCellType</a>(Child);
00969 
00970     <span class="keywordflow">if</span> (pcell-&gt;SubKeyCounts[Type] == 0) {
00971 
00972         ULONG Signature;
00973 
00974         <span class="comment">//</span>
00975         <span class="comment">// we must allocate a leaf</span>
00976         <span class="comment">//</span>
00977         WorkCell = <a class="code" href="../../d8/d0/hivecell_8c.html#a16">HvAllocateCell</a>(Hive, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html">CM_KEY_FAST_INDEX</a>), Type);
00978         <span class="keywordflow">if</span> (WorkCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00979             <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
00980         }
00981         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, WorkCell);
00982         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Signature = <a class="code" href="../../d9/d0/cmdata_8h.html#a17">UseFastIndex</a>(Hive) ? <a class="code" href="../../d9/d0/cmdata_8h.html#a20">CM_KEY_FAST_LEAF</a> : <a class="code" href="../../d9/d0/cmdata_8h.html#a19">CM_KEY_INDEX_LEAF</a>;
00983         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Count = 0;
00984         pcell-&gt;SubKeyLists[Type] = WorkCell;
00985         cleanup = 1;
00986     } <span class="keywordflow">else</span> {
00987 
00988         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, pcell-&gt;SubKeyLists[Type]);
00989         <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Signature == <a class="code" href="../../d9/d0/cmdata_8h.html#a20">CM_KEY_FAST_LEAF</a>) &amp;&amp;
00990             (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Count &gt;= (<a class="code" href="../../d9/d0/cmdata_8h.html#a23">CM_MAX_FAST_INDEX</a>))) {
00991 
00992             <span class="comment">//</span>
00993             <span class="comment">// We must change fast index to a slow index to accomodate</span>
00994             <span class="comment">// growth.</span>
00995             <span class="comment">//</span>
00996 
00997             FastIndex = (<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html">PCM_KEY_FAST_INDEX</a>)<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00998             <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Count; i++) {
00999                 <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;List[i] = FastIndex-&gt;List[i].Cell;
01000             }
01001             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Signature = <a class="code" href="../../d9/d0/cmdata_8h.html#a19">CM_KEY_INDEX_LEAF</a>;
01002 
01003         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Signature == <a class="code" href="../../d9/d0/cmdata_8h.html#a19">CM_KEY_INDEX_LEAF</a>) &amp;&amp;
01004                    (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Count &gt;= (<a class="code" href="../../d9/d0/cmdata_8h.html#a21">CM_MAX_INDEX</a> - 1) )) {
01005             <span class="comment">//</span>
01006             <span class="comment">// We must change flat entry to a root/leaf tree</span>
01007             <span class="comment">//</span>
01008             WorkCell = <a class="code" href="../../d8/d0/hivecell_8c.html#a16">HvAllocateCell</a>(
01009                          Hive,
01010                          <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">CM_KEY_INDEX</a>) + <span class="keyword">sizeof</span>(HCELL_INDEX), <span class="comment">// allow for 2</span>
01011                          Type
01012                          );
01013             <span class="keywordflow">if</span> (WorkCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01014                 <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
01015             }
01016 
01017             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, WorkCell);
01018             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Signature = <a class="code" href="../../d9/d0/cmdata_8h.html#a18">CM_KEY_INDEX_ROOT</a>;
01019             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Count = 1;
01020             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;List[0] = pcell-&gt;SubKeyLists[Type];
01021             pcell-&gt;SubKeyLists[Type] = WorkCell;
01022             cleanup = 2;
01023 
01024         }
01025     }
01026     LeafCell = pcell-&gt;SubKeyLists[Type];
01027 
01028     <span class="comment">//</span>
01029     <span class="comment">// LeafCell is target for add, or perhaps root</span>
01030     <span class="comment">// Index is pointer to fast leaf, slow Leaf or Root, whichever applies</span>
01031     <span class="comment">//</span>
01032     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Signature == <a class="code" href="../../d9/d0/cmdata_8h.html#a18">CM_KEY_INDEX_ROOT</a>) {
01033         LeafCell = <a class="code" href="../../d7/d1/cmindex_8c.html#a8">CmpSelectLeaf</a>(Hive, pcell, &amp;NewName, Type, &amp;RootPointer);
01034         <span class="keywordflow">if</span> (LeafCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01035             <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
01036         }
01037     }
01038 
01039     <span class="comment">//</span>
01040     <span class="comment">// Add new cell to Leaf, update pointers</span>
01041     <span class="comment">//</span>
01042     LeafCell = <a class="code" href="../../d7/d1/cmindex_8c.html#a7">CmpAddToLeaf</a>(Hive, LeafCell, Child, &amp;NewName);
01043 
01044     <span class="keywordflow">if</span> (LeafCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01045         <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
01046     }
01047 
01048     pcell-&gt;SubKeyCounts[Type] += 1;
01049 
01050     <span class="keywordflow">if</span> (RootPointer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01051         *RootPointer = LeafCell;
01052     } <span class="keywordflow">else</span> {
01053         pcell-&gt;SubKeyLists[Type] = LeafCell;
01054     }
01055 
01056     <span class="keywordflow">if</span> (IsCompressed) {
01057         (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(<a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.Buffer, <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.Length);
01058     }
01059 
01060     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01061 
01062 
01063 
01064 <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>:
01065     <span class="keywordflow">if</span> (IsCompressed) {
01066         (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(<a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.Buffer, <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>.Length);
01067     }
01068 
01069     <span class="keywordflow">switch</span> (cleanup) {
01070     <span class="keywordflow">case</span> 1:
01071         <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(Hive, pcell-&gt;SubKeyLists[Type]);
01072         pcell-&gt;SubKeyLists[Type] = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01073         <span class="keywordflow">break</span>;
01074 
01075     <span class="keywordflow">case</span> 2:
01076         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, pcell-&gt;SubKeyLists[Type]);
01077         pcell-&gt;SubKeyLists[Type] = <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;List[0];
01078         <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(Hive, pcell-&gt;SubKeyLists[Type]);
01079         <span class="keywordflow">break</span>;
01080     }
01081 
01082     <span class="keywordflow">return</span>  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01083 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="cmindex.c::CmpAddToLeaf" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> CmpAddToLeaf           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LeafCell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>NewKey</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>NewName</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01087">1087</a> of file <a class="el" href="../../d8/d0/cmindex_8c-source.html">cmindex.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00376">_CM_INDEX::Cell</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00373">CM_KEY_FAST_LEAF</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00372">CM_KEY_INDEX_LEAF</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00615">CmpCompareInIndex()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00475">CmpFindSubKeyInLeaf()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00268">CMS_INDEX</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00382">_CM_KEY_FAST_INDEX::Count</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00388">_CM_KEY_INDEX::Count</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00335">HvGetCellSize()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00117">HvMarkCellDirty()</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l01295">HvReallocateCell()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00389">_CM_KEY_INDEX::List</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00383">_CM_KEY_FAST_INDEX::List</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00094">List</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00377">_CM_INDEX::NameHint</a>, <a class="el" href="../../d0/d2/rtreplac_8c-source.html#l00045">NewName</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00387">_CM_KEY_INDEX::Signature</a>, <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00895">CmpAddSubKey()</a>.
<p>
<pre class="fragment"><div>01095                    :
01096 
01097     Insert a <span class="keyword">new</span> subkey into a Leaf index. Supports both fast and slow
01098     leaf indexes and will determine which sort of index <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given leaf <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>.
01099 
01100     NOTE:   We expect Root to already be marked dirty by caller <span class="keywordflow">if</span> non <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>.
01101             We expect Leaf to always be marked dirty by caller.
01102 
01103 Arguments:
01104 
01105     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> hive of interest
01106 
01107     LeafCell - cell of index leaf node we are to add entry too
01108 
01109     NewKey - cell of KEY_NODE we are to add
01110 
01111     <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a> - pointer to unicode string with name to we are to add
01112 
01113 Return Value:
01114 
01115     <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a> - some resource problem
01116 
01117     Else - cell of Leaf index when are done, caller <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> expected to
01118             set <span class="keyword">this</span> into Root index or <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> body.
01119 
01120 --*/
01121 {
01122     <a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>   Leaf;
01123     <a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html">PCM_KEY_FAST_INDEX</a> FastLeaf;
01124     ULONG           <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
01125     ULONG           OldSize;
01126     ULONG           freecount;
01127     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>     NewCell;
01128     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>     Child;
01129     ULONG           Select;
01130     LONG            Result;
01131     ULONG           EntrySize;
01132     ULONG           i;
01133 
01134     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_INDEX) {
01135         KdPrint((<span class="stringliteral">"CmpAddToLeaf:\n\t"</span>));
01136         KdPrint((<span class="stringliteral">"Hive=%08lx LeafCell=%08lx NewKey=%08lx\n"</span>,Hive,LeafCell,NewKey));
01137     }
01138 
01139     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(Hive, LeafCell)) {
01140         <span class="keywordflow">return</span> <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01141     }
01142 
01143     <span class="comment">//</span>
01144     <span class="comment">// compute number free slots left in the leaf</span>
01145     <span class="comment">//</span>
01146     Leaf = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, LeafCell);
01147     <span class="keywordflow">if</span> (Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o0">Signature</a> == <a class="code" href="../../d9/d0/cmdata_8h.html#a19">CM_KEY_INDEX_LEAF</a>) {
01148         FastLeaf = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01149         EntrySize = <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>);
01150     } <span class="keywordflow">else</span> {
01151         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o0">Signature</a> == CM_KEY_FAST_LEAF);
01152         FastLeaf = (<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html">PCM_KEY_FAST_INDEX</a>)Leaf;
01153         EntrySize = <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__CM__INDEX.html">CM_INDEX</a>);
01154     }
01155     OldSize = <a class="code" href="../../d8/d0/hivecell_8c.html#a15">HvGetCellSize</a>(Hive, Leaf);
01156     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = OldSize - ((EntrySize * Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a>) +
01157               FIELD_OFFSET(<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">CM_KEY_INDEX</a>, List));
01158     freecount = <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> / EntrySize;
01159 
01160     <span class="comment">//</span>
01161     <span class="comment">// grow the leaf if it isn't big enough</span>
01162     <span class="comment">//</span>
01163     NewCell = LeafCell;
01164     <span class="keywordflow">if</span> (freecount &lt; 1) {
01165         <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = OldSize + OldSize / 2;
01166         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> &lt; (OldSize + EntrySize)) {
01167             <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = OldSize + EntrySize;
01168         }
01169         NewCell = <a class="code" href="../../d8/d0/hivecell_8c.html#a20">HvReallocateCell</a>(Hive, LeafCell, Size);
01170         <span class="keywordflow">if</span> (NewCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01171             <span class="keywordflow">return</span> <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01172         }
01173         Leaf = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, NewCell);
01174         <span class="keywordflow">if</span> (FastLeaf != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01175             FastLeaf = (<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html">PCM_KEY_FAST_INDEX</a>)Leaf;
01176         }
01177     }
01178 
01179     <span class="comment">//</span>
01180     <span class="comment">// Find where to put the new entry</span>
01181     <span class="comment">//</span>
01182     Select = <a class="code" href="../../d7/d1/cmindex_8c.html#a3">CmpFindSubKeyInLeaf</a>(Hive, Leaf, (ULONG)-1, NewName, &amp;Child);
01183     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Child == HCELL_NIL);
01184 
01185     <span class="comment">//</span>
01186     <span class="comment">// Select is the index in List of the entry nearest where the</span>
01187     <span class="comment">// new entry should go.</span>
01188     <span class="comment">// Decide wether the new entry goes before or after Offset entry,</span>
01189     <span class="comment">// and then ripple copy and set.</span>
01190     <span class="comment">// If Select == Count, then the leaf is empty, so simply set our entry</span>
01191     <span class="comment">//</span>
01192     <span class="keywordflow">if</span> (Select != Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a>) {
01193 
01194         Result = <a class="code" href="../../d7/d1/cmindex_8c.html#a4">CmpCompareInIndex</a>(Hive,
01195                                    NewName,
01196                                    Select,
01197                                    Leaf,
01198                                    &amp;Child);
01199         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Result != 0);
01200 
01201         <span class="comment">//</span>
01202         <span class="comment">// Result &lt; 0 - NewName/NewKey less than selected key, insert before</span>
01203         <span class="comment">//        &gt; 0 - NewName/NewKey greater than selected key, insert after</span>
01204         <span class="comment">//</span>
01205         <span class="keywordflow">if</span> (Result &gt; 0) {
01206             Select++;
01207         }
01208 
01209         <span class="keywordflow">if</span> (Select != Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a>) {
01210 
01211             <span class="comment">//</span>
01212             <span class="comment">// ripple copy to make space and insert</span>
01213             <span class="comment">//</span>
01214 
01215             <span class="keywordflow">if</span> (FastLeaf != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01216                 RtlMoveMemory((PVOID)&amp;(FastLeaf-&gt;<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html#o2">List</a>[Select+1]),
01217                               (PVOID)&amp;(FastLeaf-&gt;<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html#o2">List</a>[Select]),
01218                               <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__CM__INDEX.html">CM_INDEX</a>)*(FastLeaf-&gt;<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html#o1">Count</a> - Select));
01219             } <span class="keywordflow">else</span> {
01220                 RtlMoveMemory((PVOID)&amp;(Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o2">List</a>[Select+1]),
01221                               (PVOID)&amp;(Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o2">List</a>[Select]),
01222                               <span class="keyword">sizeof</span>(HCELL_INDEX)*(Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a> - Select));
01223             }
01224         }
01225     }
01226     <span class="keywordflow">if</span> (FastLeaf != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01227         FastLeaf-&gt;<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html#o2">List</a>[Select].<a class="code" href="../../d2/d4/struct__CM__INDEX.html#o0">Cell</a> = NewKey;
01228         FastLeaf-&gt;<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html#o2">List</a>[Select].<a class="code" href="../../d2/d4/struct__CM__INDEX.html#o1">NameHint</a>[0] = 0;
01229         FastLeaf-&gt;<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html#o2">List</a>[Select].<a class="code" href="../../d2/d4/struct__CM__INDEX.html#o1">NameHint</a>[1] = 0;
01230         FastLeaf-&gt;<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html#o2">List</a>[Select].<a class="code" href="../../d2/d4/struct__CM__INDEX.html#o1">NameHint</a>[2] = 0;
01231         FastLeaf-&gt;<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html#o2">List</a>[Select].<a class="code" href="../../d2/d4/struct__CM__INDEX.html#o1">NameHint</a>[3] = 0;
01232         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>-&gt;Length/<span class="keyword">sizeof</span>(WCHAR) &lt; 4) {
01233             i = <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>-&gt;Length/<span class="keyword">sizeof</span>(WCHAR);
01234         } <span class="keywordflow">else</span> {
01235             i = 4;
01236         }
01237         <span class="keywordflow">do</span> {
01238             <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>-&gt;Buffer[i-1] &gt; (UCHAR)-1) {
01239                 <span class="comment">//</span>
01240                 <span class="comment">// Can't compress this name. Leave NameHint[0]==0</span>
01241                 <span class="comment">// to force the name to be looked up in the key.</span>
01242                 <span class="comment">//</span>
01243                 <span class="keywordflow">break</span>;
01244             }
01245             FastLeaf-&gt;<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html#o2">List</a>[Select].<a class="code" href="../../d2/d4/struct__CM__INDEX.html#o1">NameHint</a>[i-1] = (UCHAR)<a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>-&gt;Buffer[i-1];
01246             i--;
01247         } <span class="keywordflow">while</span> ( i&gt;0 );
01248     } <span class="keywordflow">else</span> {
01249         Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o2">List</a>[Select] = NewKey;
01250     }
01251     Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a> += 1;
01252     <span class="keywordflow">return</span> NewCell;
01253 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="cmindex.c::CmpCompareInIndex" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LONG CmpCompareInIndex           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>SearchName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Count</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Index</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Child</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00615">615</a> of file <a class="el" href="../../d8/d0/cmindex_8c-source.html">cmindex.c</a>.
<p>
References <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00376">_CM_INDEX::Cell</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00373">CM_KEY_FAST_LEAF</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00722">CmpDoCompareKeyName()</a>, <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00051">Count</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00383">_CM_KEY_FAST_INDEX::List</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00377">_CM_INDEX::NameHint</a>, and <a class="el" href="../../d7/d5/nls_8c-source.html#l01178">RtlUpcaseUnicodeChar()</a>.
<p>
Referenced by <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01087">CmpAddToLeaf()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00475">CmpFindSubKeyInLeaf()</a>, and <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00266">CmpFindSubKeyInRoot()</a>.
<p>
<pre class="fragment"><div>00624                    :
00625 
00626     Do a compare of a name in an index. This routine handles both
00627     fast leafs and slow ones.
00628 
00629 Arguments:
00630 
00631     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> hive of interest
00632 
00633     SearchName - pointer to name of key we are searching <span class="keywordflow">for</span>
00634 
00635     <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> - supplies index that we are searching at.
00636 
00637     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> - Supplies pointer to either a <a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">CM_KEY_INDEX</a> or
00638             a <a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html">CM_KEY_FAST_INDEX</a>. This routine will determine which
00639             <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of index <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> passed.
00640 
00641     Child - pointer to variable to receive hcell_index of found key
00642             <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a> <span class="keywordflow">if</span> result != 0
00643 
00644 Return Value:
00645 
00646     0 = SearchName == <a class="code" href="../../d8/d3/rtvbatcr_8c.html#a3">KeyName</a> (of Cell)
00647 
00648     &lt; 0 = SearchName &lt; <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>
00649 
00650     &gt; 0 = SearchName &gt; <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>
00651 
00652 --*/
00653 {
00654     <a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html">PCM_KEY_FAST_INDEX</a> FastIndex;
00655     LONG Result;
00656     ULONG i;
00657     WCHAR c1;
00658     WCHAR c2;
00659     ULONG HintLength;
00660     ULONG ValidChars;
00661     ULONG NameLength;
00662     <a class="code" href="../../d2/d4/struct__CM__INDEX.html">PCM_INDEX</a> Hint;
00663 
00664     *Child = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00665     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Signature == <a class="code" href="../../d9/d0/cmdata_8h.html#a20">CM_KEY_FAST_LEAF</a>) {
00666         FastIndex = (<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html">PCM_KEY_FAST_INDEX</a>)<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00667         Hint = &amp;FastIndex-&gt;<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html#o2">List</a>[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>];
00668 
00669         <span class="comment">//</span>
00670         <span class="comment">// Compute the number of valid characters in the hint to compare.</span>
00671         <span class="comment">//</span>
00672         HintLength = 4;
00673         <span class="keywordflow">for</span> (i=0;i&lt;4;i++) {
00674             <span class="keywordflow">if</span> (Hint-&gt;<a class="code" href="../../d2/d4/struct__CM__INDEX.html#o1">NameHint</a>[i] == 0) {
00675                 HintLength = i;
00676                 <span class="keywordflow">break</span>;
00677             }
00678         }
00679         NameLength = SearchName-&gt;Length / <span class="keyword">sizeof</span>(WCHAR);
00680         <span class="keywordflow">if</span> (NameLength &lt; HintLength) {
00681             ValidChars = NameLength;
00682         } <span class="keywordflow">else</span> {
00683             ValidChars = HintLength;
00684         }
00685         <span class="keywordflow">for</span> (i=0; i&lt;ValidChars; i++) {
00686             c1 = SearchName-&gt;Buffer[i];
00687             c2 = FastIndex-&gt;<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html#o2">List</a>[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>].<a class="code" href="../../d2/d4/struct__CM__INDEX.html#o1">NameHint</a>[i];
00688             Result = (LONG)<a class="code" href="../../d6/d6/nls_8c.html#a33">RtlUpcaseUnicodeChar</a>(c1) -
00689                      (LONG)<a class="code" href="../../d6/d6/nls_8c.html#a33">RtlUpcaseUnicodeChar</a>(c2);
00690             <span class="keywordflow">if</span> (Result != 0) {
00691 
00692                 <span class="comment">//</span>
00693                 <span class="comment">// We have found a mismatched character in the hint,</span>
00694                 <span class="comment">// we can now tell which direction to go.</span>
00695                 <span class="comment">//</span>
00696                 <span class="keywordflow">return</span>(Result);
00697             }
00698         }
00699 
00700         <span class="comment">//</span>
00701         <span class="comment">// We have compared all the available characters without a</span>
00702         <span class="comment">// discrepancy. Go ahead and do the actual comparison now.</span>
00703         <span class="comment">//</span>
00704         Result = <a class="code" href="../../d7/d1/cmindex_8c.html#a5">CmpDoCompareKeyName</a>(Hive,SearchName,FastIndex-&gt;<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html#o2">List</a>[Count].<a class="code" href="../../d2/d4/struct__CM__INDEX.html#o0">Cell</a>);
00705         <span class="keywordflow">if</span> (Result == 0) {
00706             *Child = Hint-&gt;<a class="code" href="../../d2/d4/struct__CM__INDEX.html#o0">Cell</a>;
00707         }
00708     } <span class="keywordflow">else</span> {
00709         <span class="comment">//</span>
00710         <span class="comment">// This is just a normal old slow index.</span>
00711         <span class="comment">//</span>
00712         Result = <a class="code" href="../../d7/d1/cmindex_8c.html#a5">CmpDoCompareKeyName</a>(Hive,SearchName,<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;List[Count]);
00713         <span class="keywordflow">if</span> (Result == 0) {
00714             *Child = <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;List[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>];
00715         }
00716     }
00717     <span class="keywordflow">return</span>(Result);
00718 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="cmindex.c::CmpDoCompareKeyName" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LONG CmpDoCompareKeyName           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>SearchName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Cell</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00722">722</a> of file <a class="el" href="../../d8/d0/cmindex_8c-source.html">cmindex.c</a>.
<p>
References <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d0/d1/cmname_8c-source.html#l00195">CmpCompareCompressedName()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00450">_CM_KEY_NODE::Flags</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00440">KEY_COMP_NAME</a>, <a class="el" href="../../d9/d9/rtbatcr_8c-source.html#l00059">KeyName</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00477">_CM_KEY_NODE::Name</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00475">_CM_KEY_NODE::NameLength</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01520">RtlCompareUnicodeString()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00615">CmpCompareInIndex()</a>, and <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01257">CmpSelectLeaf()</a>.
<p>
<pre class="fragment"><div>00729                    :
00730 
00731     Do a compare of a name with a key.
00732 
00733 Arguments:
00734 
00735     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> hive of interest
00736 
00737     SearchName - pointer to name of key we are searching <span class="keywordflow">for</span>
00738 
00739     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> - cell of key we are to compare with
00740 
00741 Return Value:
00742 
00743     0 = SearchName == <a class="code" href="../../d8/d3/rtvbatcr_8c.html#a3">KeyName</a> (of Cell)
00744 
00745     &lt; 0 = SearchName &lt; <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>
00746 
00747     &gt; 0 = SearchName &gt; <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>
00748 
00749 --*/
00750 {
00751     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>    Pcan;
00752     UNICODE_STRING  <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>;
00753 
00754     Pcan = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, Cell);
00755     <span class="keywordflow">if</span> (Pcan-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a32">KEY_COMP_NAME</a>) {
00756         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d2/cmp_8h.html#a319">CmpCompareCompressedName</a>(SearchName,
00757                                         Pcan-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>,
00758                                         Pcan-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>));
00759     } <span class="keywordflow">else</span> {
00760         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Buffer = &amp;(Pcan-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>[0]);
00761         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Length = Pcan-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>;
00762         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.MaximumLength = <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Length;
00763         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d6/nls_8c.html#a41">RtlCompareUnicodeString</a>(SearchName,
00764                                         &amp;KeyName,
00765                                         TRUE));
00766     }
00767 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="cmindex.c::CmpDoFindSubKeyByNumber" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> CmpDoFindSubKeyByNumber           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Index</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Number</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00833">833</a> of file <a class="el" href="../../d8/d0/cmindex_8c-source.html">cmindex.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00376">_CM_INDEX::Cell</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00373">CM_KEY_FAST_LEAF</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00371">CM_KEY_INDEX_ROOT</a>, <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00051">Count</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00388">_CM_KEY_INDEX::Count</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00389">_CM_KEY_INDEX::List</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00383">_CM_KEY_FAST_INDEX::List</a>, and <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00387">_CM_KEY_INDEX::Signature</a>.
<p>
Referenced by <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00771">CmpFindSubKeyByNumber()</a>.
<p>
<pre class="fragment"><div>00840                    :
00841 
00842     Helper <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/cmindex_8c.html#a11">CmpFindSubKeyByNumber</a>,
00843     Find <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Number'th entry in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> index, starting from 0.
00844 
00845 Arguments:
00846 
00847     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> hive of interest
00848 
00849     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> - root or leaf of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> index
00850 
00851     Number - ordinal of child key to <span class="keywordflow">return</span>
00852 
00853 Return Value:
00854 
00855     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> of requested entry.
00856 
00857 --*/
00858 {
00859     ULONG           i;
00860     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>     LeafCell;
00861     <a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>   Leaf;
00862     <a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html">PCM_KEY_FAST_INDEX</a> FastIndex;
00863 
00864     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Signature == <a class="code" href="../../d9/d0/cmdata_8h.html#a18">CM_KEY_INDEX_ROOT</a>) {
00865         <span class="comment">//</span>
00866         <span class="comment">// step through root, till we find the right leaf</span>
00867         <span class="comment">//</span>
00868         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Count; i++) {
00869             LeafCell = <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;List[i];
00870             Leaf = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, LeafCell);
00871             <span class="keywordflow">if</span> (Number &lt; Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a>) {
00872                 <span class="keywordflow">if</span> (Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o0">Signature</a> == <a class="code" href="../../d9/d0/cmdata_8h.html#a20">CM_KEY_FAST_LEAF</a>) {
00873                     FastIndex = (<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html">PCM_KEY_FAST_INDEX</a>)Leaf;
00874                     <span class="keywordflow">return</span> (FastIndex-&gt;<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html#o2">List</a>[Number].<a class="code" href="../../d2/d4/struct__CM__INDEX.html#o0">Cell</a>);
00875                 } <span class="keywordflow">else</span> {
00876                     <span class="keywordflow">return</span> (Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o2">List</a>[Number]);
00877                 }
00878             } <span class="keywordflow">else</span> {
00879                 Number = Number - Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a>;
00880             }
00881         }
00882         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FALSE);
00883     }
00884     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Number &lt; Index-&gt;Count);
00885     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Signature == <a class="code" href="../../d9/d0/cmdata_8h.html#a20">CM_KEY_FAST_LEAF</a>) {
00886         FastIndex = (<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html">PCM_KEY_FAST_INDEX</a>)<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00887         <span class="keywordflow">return</span>(FastIndex-&gt;<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html#o2">List</a>[Number].<a class="code" href="../../d2/d4/struct__CM__INDEX.html#o0">Cell</a>);
00888     } <span class="keywordflow">else</span> {
00889         <span class="keywordflow">return</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;List[Number]);
00890     }
00891 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="cmindex.c::CmpFindSubKeyByName" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> CmpFindSubKeyByName           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Parent</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>SearchName</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00186">186</a> of file <a class="el" href="../../d8/d0/cmindex_8c-source.html">cmindex.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00373">CM_KEY_FAST_LEAF</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00372">CM_KEY_INDEX_LEAF</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00371">CM_KEY_INDEX_ROOT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00475">CmpFindSubKeyInLeaf()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00266">CmpFindSubKeyInRoot()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00181">CmpHintHits</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00182">CmpHintMisses</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00268">CMS_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l01453">HvIsCellAllocated()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00387">_CM_KEY_INDEX::Signature</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00629">_HHIVE::StorageTypeCount</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00454">_CM_KEY_NODE::SubKeyCounts</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00457">_CM_KEY_NODE::SubKeyLists</a>, and <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00470">_CM_KEY_NODE::WorkVar</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/cmcontrl_8c-source.html#l00050">CmGetSystemControlValues()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00251">CmpCopySyncTree2()</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l01082">CmpFindControlSet()</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00333">CmpFindDrivers()</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00108">CmpFindNLSData()</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l01284">CmpFindProfileOption()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00145">CmpParseKey()</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00744">CmpSortDriverList()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01648">CmpSyncSubKeysAfterDelete()</a>, and <a class="el" href="../../d6/d9/cmcontrl_8c-source.html#l00256">CmpWalkPath()</a>.
<p>
<pre class="fragment"><div>00193                    :
00194 
00195     Find <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> child cell (either subkey or value) specified by name.
00196 
00197 Arguments:
00198 
00199     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> hive of interest
00200 
00201     Parent - cell of key body which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> parent of child of interest
00202 
00203     SearchName - name of child of interest
00204 
00205 Return Value:
00206 
00207     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a7">matching</a> child key, or <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a> <span class="keywordflow">if</span> none.
00208 
00209 --*/
00210 {
00211     <a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>   IndexRoot;
00212     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>     Child;
00213     ULONG           i;
00214     ULONG           FoundIndex;
00215 
00216     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_INDEX) {
00217         KdPrint((<span class="stringliteral">"CmpFindSubKeyByName:\n\t"</span>));
00218         KdPrint((<span class="stringliteral">"Hive=%08lx Parent=%08lx SearchName=%08lx\n"</span>, Hive, Parent, SearchName));
00219     }
00220 
00221     <span class="comment">//</span>
00222     <span class="comment">// Try first the Stable, then the Volatile store.  Assumes that</span>
00223     <span class="comment">// all Volatile refs in Stable space are zeroed out at boot.</span>
00224     <span class="comment">//</span>
00225     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o20">StorageTypeCount</a>; i++) {
00226         <span class="keywordflow">if</span> (Parent-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[i] != 0) {
00227             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d8/d0/hivecell_8c.html#a21">HvIsCellAllocated</a>(Hive, Parent-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[i]));
00228             IndexRoot = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, Parent-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[i]);
00229 
00230             <span class="keywordflow">if</span> (IndexRoot-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o0">Signature</a> == <a class="code" href="../../d9/d0/cmdata_8h.html#a18">CM_KEY_INDEX_ROOT</a>) {
00231                 <a class="code" href="../../d7/d1/cmindex_8c.html#a2">CmpFindSubKeyInRoot</a>(Hive, IndexRoot, SearchName, &amp;Child);
00232                 <span class="keywordflow">if</span> (Child == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00233                     <span class="keywordflow">continue</span>;
00234                 }
00235                 IndexRoot = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, Child);
00236             }
00237             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((IndexRoot-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o0">Signature</a> == CM_KEY_INDEX_LEAF) ||
00238                    (IndexRoot-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o0">Signature</a> == CM_KEY_FAST_LEAF));
00239 
00240             FoundIndex = <a class="code" href="../../d7/d1/cmindex_8c.html#a3">CmpFindSubKeyInLeaf</a>(Hive,
00241                                              IndexRoot,
00242                                              Parent-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o15">WorkVar</a>,
00243                                              SearchName,
00244                                              &amp;Child);
00245             <span class="keywordflow">if</span> (Child != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00246                 <span class="comment">//</span>
00247                 <span class="comment">// WorkVar is used as a hint for the last successful lookup</span>
00248                 <span class="comment">// to improve our locality when similar keys are opened</span>
00249                 <span class="comment">// repeatedly.</span>
00250                 <span class="comment">//</span>
00251                 <span class="keywordflow">if</span> (FoundIndex == Parent-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o15">WorkVar</a>) {
00252                     <a class="code" href="../../d7/d1/cmindex_8c.html#a0">CmpHintHits</a>++;
00253                 } <span class="keywordflow">else</span> {
00254                     <a class="code" href="../../d7/d1/cmindex_8c.html#a1">CmpHintMisses</a>++;
00255                 }
00256                 Parent-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o15">WorkVar</a> = FoundIndex;
00257                 <span class="keywordflow">return</span> Child;
00258             }
00259         }
00260     }
00261     <span class="keywordflow">return</span> <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00262 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="cmindex.c::CmpFindSubKeyByNumber" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> CmpFindSubKeyByNumber           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Node</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Number</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00771">771</a> of file <a class="el" href="../../d8/d0/cmindex_8c-source.html">cmindex.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00833">CmpDoFindSubKeyByNumber()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00268">CMS_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00629">_HHIVE::StorageTypeCount</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00454">_CM_KEY_NODE::SubKeyCounts</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00457">_CM_KEY_NODE::SubKeyLists</a>, and <a class="el" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>.
<p>
Referenced by <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00285">CmEnumerateKey()</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00210">CmpCheckRegistry2()</a>, <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l00251">CmpCopySyncTree2()</a>, <a class="el" href="../../d4/d2/cmtredel_8c-source.html#l00034">CmpDeleteTree()</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00333">CmpFindDrivers()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01545">CmpFindMatchingDescriptorCell()</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l01284">CmpFindProfileOption()</a>, and <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01648">CmpSyncSubKeysAfterDelete()</a>.
<p>
<pre class="fragment"><div>00778                    :
00779 
00780     Find <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Number'th entry in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> index, starting from 0.
00781 
00782 Arguments:
00783 
00784     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> hive of interest
00785 
00786     Node - pointer to key body which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> parent of child of interest
00787 
00788     Number - ordinal of child key to <span class="keywordflow">return</span>
00789 
00790 Return Value:
00791 
00792     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a7">matching</a> child key, or <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a> <span class="keywordflow">if</span> none.
00793 
00794 --*/
00795 {
00796     <a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>   <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00797 
00798     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_INDEX) {
00799         KdPrint((<span class="stringliteral">"CmpFindSubKeyByNumber:\n\t"</span>));
00800         KdPrint((<span class="stringliteral">"Hive=%08lx Node=%08lx Number=%08lx\n"</span>,Hive,Node,Number));
00801     }
00802 
00803     <span class="keywordflow">if</span> (Number &lt; Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>]) {
00804 
00805         <span class="comment">//</span>
00806         <span class="comment">// It's in the stable set</span>
00807         <span class="comment">//</span>
00808         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[Stable]);
00809         <span class="keywordflow">return</span> (<a class="code" href="../../d7/d1/cmindex_8c.html#a6">CmpDoFindSubKeyByNumber</a>(Hive, Index, Number));
00810 
00811     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o20">StorageTypeCount</a> &gt; <a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>) {
00812 
00813         <span class="comment">//</span>
00814         <span class="comment">// It's in the volatile set</span>
00815         <span class="comment">//</span>
00816         Number = Number - Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>];
00817         <span class="keywordflow">if</span> (Number &lt; Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>]) {
00818 
00819             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[Volatile]);
00820             <span class="keywordflow">return</span> (<a class="code" href="../../d7/d1/cmindex_8c.html#a6">CmpDoFindSubKeyByNumber</a>(Hive, Index, Number));
00821 
00822         }
00823     }
00824 
00825     <span class="comment">//</span>
00826     <span class="comment">// It's nowhere</span>
00827     <span class="comment">//</span>
00828     <span class="keywordflow">return</span> <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00829 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="cmindex.c::CmpFindSubKeyInLeaf" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG CmpFindSubKeyInLeaf           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Index</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>IndexHint</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>SearchName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Child</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00475">475</a> of file <a class="el" href="../../d8/d0/cmindex_8c-source.html">cmindex.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00373">CM_KEY_FAST_LEAF</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00372">CM_KEY_INDEX_LEAF</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00615">CmpCompareInIndex()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00268">CMS_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01087">CmpAddToLeaf()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00186">CmpFindSubKeyByName()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01608">CmpMarkIndexDirty()</a>, and <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01714">CmpRemoveSubKey()</a>.
<p>
<pre class="fragment"><div>00484                    :
00485 
00486     Find a named key in a leaf index, <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> exists. The supplied index
00487     may be either a fast index or a slow one.
00488 
00489 Arguments:
00490 
00491     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> hive of interest
00492 
00493     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> - pointer to leaf block
00494 
00495     HintIndex - Supplies hint <span class="keywordflow">for</span> first key to check.
00496 
00497     SearchName - pointer to name of key of interest
00498 
00499     Child - pointer to variable to receive hcell_index of found key
00500             <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a> <span class="keywordflow">if</span> none found
00501 
00502 Return Value:
00503 
00504     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> in <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> of last cell.  If Child != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>, <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> offset in
00505     list at which Child was found.  Else, <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> offset of last place
00506     we looked.
00507 
00508 --*/
00509 {
00510     ULONG       High;
00511     ULONG       Low;
00512     ULONG       CanCount;
00513     LONG        Result;
00514 
00515     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_INDEX) {
00516         KdPrint((<span class="stringliteral">"CmpFindSubKeyInLeaf:\n\t"</span>));
00517         KdPrint((<span class="stringliteral">"Hive=%08lx Index=%08lx SearchName=%08lx\n"</span>,Hive,Index,SearchName));
00518     }
00519 
00520     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Signature == CM_KEY_INDEX_LEAF) ||
00521            (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Signature == CM_KEY_FAST_LEAF));
00522 
00523     High = <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Count - 1;
00524     Low = 0;
00525     <span class="keywordflow">if</span> (HintIndex &lt; High) {
00526         CanCount = HintIndex;
00527     } <span class="keywordflow">else</span> {
00528         CanCount = High/2;
00529     }
00530 
00531     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Count == 0) {
00532         *Child = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00533         <span class="keywordflow">return</span> 0;
00534     }
00535 
00536     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00537 
00538         <span class="comment">//</span>
00539         <span class="comment">// Compute where to look next, get correct pointer, do compare</span>
00540         <span class="comment">//</span>
00541         Result = <a class="code" href="../../d7/d1/cmindex_8c.html#a4">CmpCompareInIndex</a>(Hive,
00542                                    SearchName,
00543                                    CanCount,
00544                                    Index,
00545                                    Child);
00546 
00547         <span class="keywordflow">if</span> (Result == 0) {
00548 
00549             <span class="comment">//</span>
00550             <span class="comment">// SearchName == KeyName</span>
00551             <span class="comment">//</span>
00552             <span class="keywordflow">return</span> CanCount;
00553         }
00554 
00555         <span class="keywordflow">if</span> (Result &lt; 0) {
00556 
00557             <span class="comment">//</span>
00558             <span class="comment">// SearchName &lt; KeyName</span>
00559             <span class="comment">//</span>
00560             High = CanCount;
00561 
00562         } <span class="keywordflow">else</span> {
00563 
00564             <span class="comment">//</span>
00565             <span class="comment">// SearchName &gt; KeyName</span>
00566             <span class="comment">//</span>
00567             Low = CanCount;
00568         }
00569 
00570         <span class="keywordflow">if</span> ((High - Low) &lt;= 1) {
00571             <span class="keywordflow">break</span>;
00572         }
00573         CanCount = ((High-Low)/2)+Low;
00574     }
00575 
00576     <span class="comment">//</span>
00577     <span class="comment">// If we get here, High - Low = 1 or High == Low</span>
00578     <span class="comment">// Simply look first at Low, then at High</span>
00579     <span class="comment">//</span>
00580     Result = <a class="code" href="../../d7/d1/cmindex_8c.html#a4">CmpCompareInIndex</a>(Hive,
00581                                SearchName,
00582                                Low,
00583                                Index,
00584                                Child);
00585     <span class="keywordflow">if</span> (Result == 0) {
00586 
00587         <span class="comment">//</span>
00588         <span class="comment">// found it</span>
00589         <span class="comment">//</span>
00590         <span class="keywordflow">return</span> Low;
00591     }
00592 
00593     <span class="keywordflow">if</span> (Result &lt; 0) {
00594 
00595         <span class="comment">//</span>
00596         <span class="comment">// does not exist, under</span>
00597         <span class="comment">//</span>
00598         <span class="keywordflow">return</span> Low;
00599     }
00600 
00601     <span class="comment">//</span>
00602     <span class="comment">// see if High matches, we will return High as the</span>
00603     <span class="comment">// closest key regardless.</span>
00604     <span class="comment">//</span>
00605     Result = <a class="code" href="../../d7/d1/cmindex_8c.html#a4">CmpCompareInIndex</a>(Hive,
00606                                SearchName,
00607                                High,
00608                                Index,
00609                                Child);
00610     <span class="keywordflow">return</span> High;
00611 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="cmindex.c::CmpFindSubKeyInRoot" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG CmpFindSubKeyInRoot           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Index</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>SearchName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Child</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00266">266</a> of file <a class="el" href="../../d8/d0/cmindex_8c-source.html">cmindex.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00373">CM_KEY_FAST_LEAF</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00372">CM_KEY_INDEX_LEAF</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00371">CM_KEY_INDEX_ROOT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00615">CmpCompareInIndex()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00268">CMS_INDEX</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00388">_CM_KEY_INDEX::Count</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00387">_CM_KEY_INDEX::Signature</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00186">CmpFindSubKeyByName()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01608">CmpMarkIndexDirty()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01714">CmpRemoveSubKey()</a>, and <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01257">CmpSelectLeaf()</a>.
<p>
<pre class="fragment"><div>00274                    :
00275 
00276     Find <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> leaf index that would contain a key, <span class="keywordflow">if</span> there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> one.
00277 
00278 Arguments:
00279 
00280     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> hive of interest
00281 
00282     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> - pointer to root index block
00283 
00284     SearchName - pointer to name of key of interest
00285 
00286     Child - pointer to variable to receive hcell_index of found leaf index
00287             block, <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a> <span class="keywordflow">if</span> none.  Non <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a> does not necessarily mean
00288             <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> present, call FindSubKeyInLeaf to decide that.
00289 
00290 Return Value:
00291 
00292     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> in <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> of last Leaf <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> entry examined.  If Child != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>,
00293     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> entry that matched, <span class="keywordflow">else</span>, index <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keywordflow">for</span> last entry we looked
00294     at.  (Target Leaf will be <span class="keyword">this</span> value plus or minus 1)
00295 
00296 --*/
00297 {
00298     ULONG           High;
00299     ULONG           Low;
00300     ULONG           CanCount;
00301     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>     LeafCell;
00302     <a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>   Leaf;
00303     LONG            Result;
00304 
00305     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_INDEX) {
00306         KdPrint((<span class="stringliteral">"CmpFindSubKeyInRoot:\n\t"</span>));
00307         KdPrint((<span class="stringliteral">"Hive=%08lx Index=%08lx SearchName=%08lx\n"</span>,Hive,Index,SearchName));
00308     }
00309 
00310 
00311     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Count != 0);
00312     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Signature == CM_KEY_INDEX_ROOT);
00313 
00314     High = <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Count - 1;
00315     Low = 0;
00316 
00317     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00318 
00319         <span class="comment">//</span>
00320         <span class="comment">// Compute where to look next, get correct pointer, do compare</span>
00321         <span class="comment">//</span>
00322         CanCount = ((High-Low)/2)+Low;
00323         LeafCell = <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;List[CanCount];
00324         Leaf = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, LeafCell);
00325 
00326         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o0">Signature</a> == CM_KEY_INDEX_LEAF) ||
00327                (Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o0">Signature</a> == CM_KEY_FAST_LEAF));
00328         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a> != 0);
00329 
00330         Result = <a class="code" href="../../d7/d1/cmindex_8c.html#a4">CmpCompareInIndex</a>(Hive,
00331                                    SearchName,
00332                                    Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a>-1,
00333                                    Leaf,
00334                                    Child);
00335 
00336         <span class="keywordflow">if</span> (Result == 0) {
00337 
00338             <span class="comment">//</span>
00339             <span class="comment">// SearchName == KeyName of last key in leaf, so</span>
00340             <span class="comment">//  this is our leaf</span>
00341             <span class="comment">//</span>
00342             *Child = LeafCell;
00343             <span class="keywordflow">return</span> CanCount;
00344         }
00345 
00346         <span class="keywordflow">if</span> (Result &lt; 0) {
00347 
00348             <span class="comment">//</span>
00349             <span class="comment">// SearchName &lt; KeyName, so this may still be our leaf</span>
00350             <span class="comment">//</span>
00351             Result = <a class="code" href="../../d7/d1/cmindex_8c.html#a4">CmpCompareInIndex</a>(Hive,
00352                                        SearchName,
00353                                        0,
00354                                        Leaf,
00355                                        Child);
00356 
00357             <span class="keywordflow">if</span> (Result &gt;= 0) {
00358 
00359                 <span class="comment">//</span>
00360                 <span class="comment">// we know from above that SearchName is less than</span>
00361                 <span class="comment">// last key in leaf.</span>
00362                 <span class="comment">// since it is also &gt;= first key in leaf, it must</span>
00363                 <span class="comment">// reside in leaf somewhere, and we are done</span>
00364                 <span class="comment">//</span>
00365                 *Child = LeafCell;
00366                 <span class="keywordflow">return</span> CanCount;
00367             }
00368 
00369             High = CanCount;
00370 
00371         } <span class="keywordflow">else</span> {
00372 
00373             <span class="comment">//</span>
00374             <span class="comment">// SearchName &gt; KeyName</span>
00375             <span class="comment">//</span>
00376             Low = CanCount;
00377         }
00378 
00379         <span class="keywordflow">if</span> ((High - Low) &lt;= 1) {
00380             <span class="keywordflow">break</span>;
00381         }
00382     }
00383 
00384     <span class="comment">//</span>
00385     <span class="comment">// If we get here, High - Low = 1 or High == Low</span>
00386     <span class="comment">//</span>
00387     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((High - Low == 1) || (High == Low));
00388     LeafCell = <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;List[Low];
00389     Leaf = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, LeafCell);
00390     Result = <a class="code" href="../../d7/d1/cmindex_8c.html#a4">CmpCompareInIndex</a>(Hive,
00391                                SearchName,
00392                                Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a>-1,
00393                                Leaf,
00394                                Child);
00395 
00396     <span class="keywordflow">if</span> (Result == 0) {
00397 
00398         <span class="comment">//</span>
00399         <span class="comment">// found it</span>
00400         <span class="comment">//</span>
00401         *Child = LeafCell;
00402         <span class="keywordflow">return</span> Low;
00403     }
00404 
00405     <span class="keywordflow">if</span> (Result &lt; 0) {
00406 
00407         <span class="comment">//</span>
00408         <span class="comment">// SearchName &lt; KeyName, so this may still be our leaf</span>
00409         <span class="comment">//</span>
00410         Result = <a class="code" href="../../d7/d1/cmindex_8c.html#a4">CmpCompareInIndex</a>(Hive,
00411                                    SearchName,
00412                                    0,
00413                                    Leaf,
00414                                    Child);
00415 
00416         <span class="keywordflow">if</span> (Result &gt;= 0) {
00417 
00418             <span class="comment">//</span>
00419             <span class="comment">// we know from above that SearchName is less than</span>
00420             <span class="comment">// last key in leaf.</span>
00421             <span class="comment">// since it is also &gt;= first key in leaf, it must</span>
00422             <span class="comment">// reside in leaf somewhere, and we are done</span>
00423             <span class="comment">//</span>
00424             *Child = LeafCell;
00425             <span class="keywordflow">return</span> Low;
00426         }
00427 
00428         <span class="comment">//</span>
00429         <span class="comment">// does not exist, but belongs in Low or Leaf below low</span>
00430         <span class="comment">//</span>
00431         *Child = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00432         <span class="keywordflow">return</span> Low;
00433     }
00434 
00435     <span class="comment">//</span>
00436     <span class="comment">// see if High matches</span>
00437     <span class="comment">//</span>
00438     LeafCell = <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;List[High];
00439     Leaf = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, LeafCell);
00440     Result = <a class="code" href="../../d7/d1/cmindex_8c.html#a4">CmpCompareInIndex</a>(Hive,
00441                                SearchName,
00442                                Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a> - 1,
00443                                Leaf,
00444                                Child);
00445     <span class="keywordflow">if</span> (Result == 0) {
00446 
00447         <span class="comment">//</span>
00448         <span class="comment">// found it</span>
00449         <span class="comment">//</span>
00450         *Child = LeafCell;
00451         <span class="keywordflow">return</span> High;
00452 
00453     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Result &lt; 0) {
00454 
00455         <span class="comment">//</span>
00456         <span class="comment">// Clearly greater than low, or we wouldn't be here.</span>
00457         <span class="comment">// So regardless of whether it's below the start</span>
00458         <span class="comment">// of this leaf, it would be in this leaf if it were</span>
00459         <span class="comment">// where, so report this leaf.</span>
00460         <span class="comment">//</span>
00461         *Child = LeafCell;
00462         <span class="keywordflow">return</span> High;
00463 
00464     }
00465 
00466     <span class="comment">//</span>
00467     <span class="comment">// Off the high end</span>
00468     <span class="comment">//</span>
00469     *Child = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00470     <span class="keywordflow">return</span> High;
00471 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="cmindex.c::CmpMarkIndexDirty" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpMarkIndexDirty           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ParentKey</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetKey</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01608">1608</a> of file <a class="el" href="../../d8/d0/cmindex_8c-source.html">cmindex.c</a>.
<p>
References <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00597">_HHIVE::Allocate</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00373">CM_KEY_FAST_LEAF</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00372">CM_KEY_INDEX_LEAF</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00371">CM_KEY_INDEX_ROOT</a>, <a class="el" href="../../d0/d1/cmname_8c-source.html#l00121">CmpCompressedNameSize()</a>, <a class="el" href="../../d0/d1/cmname_8c-source.html#l00151">CmpCopyCompressedName()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00475">CmpFindSubKeyInLeaf()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00266">CmpFindSubKeyInRoot()</a>, <a class="el" href="../../d2/d9/tdisp_8c-source.html#l00009">ErrorExit()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00450">_CM_KEY_NODE::Flags</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00598">_HHIVE::Free</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l01453">HvIsCellAllocated()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00117">HvMarkCellDirty()</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00440">KEY_COMP_NAME</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00477">_CM_KEY_NODE::Name</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00475">_CM_KEY_NODE::NameLength</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00629">_HHIVE::StorageTypeCount</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00454">_CM_KEY_NODE::SubKeyCounts</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00457">_CM_KEY_NODE::SubKeyLists</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00470">_CM_KEY_NODE::WorkVar</a>.
<p>
Referenced by <a class="el" href="../../d4/d2/cmtredel_8c-source.html#l00245">CmpMarkKeyDirty()</a>, and <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01870">CmpMarkKeyParentDirty()</a>.
<p>
<pre class="fragment"><div>01615                    :
01616 
01617     Mark as dirty relevent cells of a subkey index.  The Leaf that
01618     points to TargetKey, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Root index block, <span class="keywordflow">if</span> applicable,
01619     will be marked dirty.  This call assumes we are setting up
01620     <span class="keywordflow">for</span> a subkey <span class="keyword">delete</span>.
01621 
01622 Arguments:
01623 
01624     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> hive of interest
01625 
01626     ParentKey - key from whose subkey list <span class="keyword">delete</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be performed
01627 
01628     TargetKey - key being deleted
01629 
01630 Return Value:
01631 
01632     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> worked, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> didn'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>, some resource problem
01633 
01634 --*/
01635 {
01636     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>    pcell;
01637     ULONG           i;
01638     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>     IndexCell;
01639     <a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>   <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01640     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>     Child = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01641     UNICODE_STRING  SearchName;
01642     BOOLEAN         IsCompressed;
01643 
01644     pcell = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, TargetKey);
01645     <span class="keywordflow">if</span> (pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a32">KEY_COMP_NAME</a>) {
01646         IsCompressed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01647         SearchName.Length = <a class="code" href="../../d1/d2/cmp_8h.html#a320">CmpCompressedNameSize</a>(pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>, pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>);
01648         SearchName.MaximumLength = SearchName.Length;
01649         SearchName.Buffer = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(SearchName.Length, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01650         <span class="keywordflow">if</span> (SearchName.Buffer==<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01651             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01652         }
01653         <a class="code" href="../../d1/d2/cmp_8h.html#a318">CmpCopyCompressedName</a>(SearchName.Buffer,
01654                               SearchName.MaximumLength,
01655                               pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>,
01656                               pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>);
01657     } <span class="keywordflow">else</span> {
01658         IsCompressed = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01659         SearchName.Length = pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>;
01660         SearchName.MaximumLength = pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>;
01661         SearchName.Buffer = &amp;(pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>[0]);
01662     }
01663 
01664     pcell = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, ParentKey);
01665 
01666     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o20">StorageTypeCount</a>; i++) {
01667         <span class="keywordflow">if</span> (pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[i] != 0) {
01668             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d8/d0/hivecell_8c.html#a21">HvIsCellAllocated</a>(Hive, pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[i]));
01669             IndexCell = pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[i];
01670             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, IndexCell);
01671 
01672             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Signature == <a class="code" href="../../d9/d0/cmdata_8h.html#a18">CM_KEY_INDEX_ROOT</a>) {
01673 
01674                 <span class="comment">//</span>
01675                 <span class="comment">// target even in index?</span>
01676                 <span class="comment">//</span>
01677                 <a class="code" href="../../d7/d1/cmindex_8c.html#a2">CmpFindSubKeyInRoot</a>(Hive, Index, &amp;SearchName, &amp;Child);
01678                 <span class="keywordflow">if</span> (Child == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01679                     <span class="keywordflow">continue</span>;
01680                 }
01681 
01682                 <span class="comment">//</span>
01683                 <span class="comment">// mark root dirty</span>
01684                 <span class="comment">//</span>
01685                 <span class="keywordflow">if</span> (! <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(Hive, IndexCell)) {
01686                     <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
01687                 }
01688 
01689                 IndexCell = Child;
01690                 <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, Child);
01691             }
01692             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Signature == CM_KEY_INDEX_LEAF) ||
01693                    (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Signature == CM_KEY_FAST_LEAF));
01694 
01695             <a class="code" href="../../d7/d1/cmindex_8c.html#a3">CmpFindSubKeyInLeaf</a>(Hive, Index, pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o15">WorkVar</a>, &amp;SearchName, &amp;Child);
01696             <span class="keywordflow">if</span> (Child != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01697                 <span class="keywordflow">if</span> (IsCompressed) {
01698                     (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(SearchName.Buffer, SearchName.Length);
01699                 }
01700                 <span class="keywordflow">return</span>(<a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(Hive, IndexCell));
01701             }
01702         }
01703     }
01704 
01705 <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>:
01706     <span class="keywordflow">if</span> (IsCompressed) {
01707         (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(SearchName.Buffer, SearchName.Length);
01708     }
01709     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01710 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="cmindex.c::CmpRemoveSubKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpRemoveSubKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ParentKey</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetKey</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01714">1714</a> of file <a class="el" href="../../d8/d0/cmindex_8c-source.html">cmindex.c</a>.
<p>
References <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00597">_HHIVE::Allocate</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00373">CM_KEY_FAST_LEAF</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00372">CM_KEY_INDEX_LEAF</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00371">CM_KEY_INDEX_ROOT</a>, <a class="el" href="../../d0/d1/cmname_8c-source.html#l00121">CmpCompressedNameSize()</a>, <a class="el" href="../../d0/d1/cmname_8c-source.html#l00151">CmpCopyCompressedName()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00475">CmpFindSubKeyInLeaf()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00266">CmpFindSubKeyInRoot()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00388">_CM_KEY_INDEX::Count</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00382">_CM_KEY_FAST_INDEX::Count</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00450">_CM_KEY_NODE::Flags</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00598">_HHIVE::Free</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00688">HvFreeCell()</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00135">HvGetCellType</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l01453">HvIsCellAllocated()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00440">KEY_COMP_NAME</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00389">_CM_KEY_INDEX::List</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00383">_CM_KEY_FAST_INDEX::List</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00477">_CM_KEY_NODE::Name</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00475">_CM_KEY_NODE::NameLength</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00387">_CM_KEY_INDEX::Signature</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00454">_CM_KEY_NODE::SubKeyCounts</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00457">_CM_KEY_NODE::SubKeyLists</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00470">_CM_KEY_NODE::WorkVar</a>.
<p>
Referenced by <a class="el" href="../../d4/d2/cmtredel_8c-source.html#l00140">CmpFreeKeyByCell()</a>.
<p>
<pre class="fragment"><div>01721                    :
01722 
01723     Remove <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subkey TargetKey refers to from ParentKey's list.
01724 
01725     NOTE:   Assumes that caller has marked relevent cells dirty,
01726             see <a class="code" href="../../d7/d1/cmindex_8c.html#a13">CmpMarkIndexDirty</a>.
01727 
01728 Arguments:
01729 
01730     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> hive of interest
01731 
01732     ParentKey - key from whose subkey list <span class="keyword">delete</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be performed
01733 
01734     TargetKey - key being deleted
01735 
01736 Return Value:
01737 
01738     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> worked, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> didn'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>, some resource problem
01739 
01740 --*/
01741 {
01742     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>    pcell;
01743     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>     LeafCell;
01744     <a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>   Leaf;
01745     <a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html">PCM_KEY_FAST_INDEX</a> FastIndex;
01746     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>     RootCell = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01747     <a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>   Root = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01748     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>     Child;
01749     ULONG           Type;
01750     ULONG           RootSelect;
01751     ULONG           LeafSelect;
01752     UNICODE_STRING  SearchName;
01753     BOOLEAN         IsCompressed;
01754     WCHAR           CompressedBuffer[50];
01755 
01756     pcell = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, TargetKey);
01757     <span class="keywordflow">if</span> (pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a32">KEY_COMP_NAME</a>) {
01758         IsCompressed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01759         SearchName.Length = <a class="code" href="../../d1/d2/cmp_8h.html#a320">CmpCompressedNameSize</a>(pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>, pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>);
01760         SearchName.MaximumLength = SearchName.Length;
01761         <span class="keywordflow">if</span> (SearchName.MaximumLength &gt; <span class="keyword">sizeof</span>(CompressedBuffer)) {
01762             SearchName.Buffer = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(SearchName.Length, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01763             <span class="keywordflow">if</span> (SearchName.Buffer==<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01764                 <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01765             }
01766         } <span class="keywordflow">else</span> {
01767             SearchName.Buffer = CompressedBuffer;
01768         }
01769         <a class="code" href="../../d1/d2/cmp_8h.html#a318">CmpCopyCompressedName</a>(SearchName.Buffer,
01770                               SearchName.MaximumLength,
01771                               pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>,
01772                               pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>);
01773     } <span class="keywordflow">else</span> {
01774         IsCompressed = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01775         SearchName.Length = pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>;
01776         SearchName.MaximumLength = pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>;
01777         SearchName.Buffer = &amp;(pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>[0]);
01778     }
01779 
01780     pcell = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, ParentKey);
01781     Type = <a class="code" href="../../d0/d1/hivedata_8h.html#a19">HvGetCellType</a>(TargetKey);
01782 
01783     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[Type] != 0);
01784     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d8/d0/hivecell_8c.html#a21">HvIsCellAllocated</a>(Hive, pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[Type]));
01785 
01786     LeafCell = pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[Type];
01787     Leaf = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, LeafCell);
01788 
01789     <span class="keywordflow">if</span> (Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o0">Signature</a> == <a class="code" href="../../d9/d0/cmdata_8h.html#a18">CM_KEY_INDEX_ROOT</a>) {
01790         RootSelect = <a class="code" href="../../d7/d1/cmindex_8c.html#a2">CmpFindSubKeyInRoot</a>(Hive, Leaf, &amp;SearchName, &amp;Child);
01791 
01792         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Child != FALSE);
01793 
01794         Root = Leaf;
01795         RootCell = LeafCell;
01796         LeafCell = Child;
01797         Leaf = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, LeafCell);
01798 
01799     }
01800 
01801     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o0">Signature</a> == CM_KEY_INDEX_LEAF) ||
01802            (Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o0">Signature</a> == CM_KEY_FAST_LEAF));
01803 
01804     LeafSelect = <a class="code" href="../../d7/d1/cmindex_8c.html#a3">CmpFindSubKeyInLeaf</a>(Hive, Leaf, pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o15">WorkVar</a>, &amp;SearchName, &amp;Child);
01805 
01806     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Child != HCELL_NIL);
01807 
01808     <span class="comment">//</span>
01809     <span class="comment">// Leaf points to Index Leaf block</span>
01810     <span class="comment">// Child is Index Leaf block cell</span>
01811     <span class="comment">// LeafSelect is Index for List[]</span>
01812     <span class="comment">//</span>
01813     pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[Type] -= 1;
01814 
01815     Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a> -= 1;
01816     <span class="keywordflow">if</span> (Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a> == 0) {
01817 
01818         <span class="comment">//</span>
01819         <span class="comment">// Empty Leaf, drop it.</span>
01820         <span class="comment">//</span>
01821         <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(Hive, LeafCell);
01822 
01823         <span class="keywordflow">if</span> (Root != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01824 
01825             Root-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a> -= 1;
01826             <span class="keywordflow">if</span> (Root-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a> == 0) {
01827 
01828                 <span class="comment">//</span>
01829                 <span class="comment">// Root is empty, free it too.</span>
01830                 <span class="comment">//</span>
01831                 <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(Hive, RootCell);
01832                 pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[Type] = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01833 
01834             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (RootSelect &lt; (ULONG)(Root-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a>)) {
01835 
01836                 <span class="comment">//</span>
01837                 <span class="comment">// Middle entry, squeeze root</span>
01838                 <span class="comment">//</span>
01839                 RtlMoveMemory(
01840                     (PVOID)&amp;(Root-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o2">List</a>[RootSelect]),
01841                     (PVOID)&amp;(Root-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o2">List</a>[RootSelect+1]),
01842                     (Root-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a> - RootSelect) * <span class="keyword">sizeof</span>(HCELL_INDEX)
01843                     );
01844             }
01845             <span class="comment">//</span>
01846             <span class="comment">// Else RootSelect == last entry, so decrementing count</span>
01847             <span class="comment">// was all we needed to do</span>
01848             <span class="comment">//</span>
01849 
01850         } <span class="keywordflow">else</span> {
01851 
01852             pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[Type] = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01853 
01854         }
01855 
01856     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (LeafSelect &lt; (ULONG)(Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a>)) {
01857 
01858         <span class="keywordflow">if</span> (Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o0">Signature</a> == <a class="code" href="../../d9/d0/cmdata_8h.html#a19">CM_KEY_INDEX_LEAF</a>) {
01859             RtlMoveMemory((PVOID)&amp;(Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o2">List</a>[LeafSelect]),
01860                           (PVOID)&amp;(Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o2">List</a>[LeafSelect+1]),
01861                           (Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a> - LeafSelect) * <span class="keyword">sizeof</span>(HCELL_INDEX));
01862         } <span class="keywordflow">else</span> {
01863             FastIndex = (<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html">PCM_KEY_FAST_INDEX</a>)Leaf;
01864             RtlMoveMemory((PVOID)&amp;(FastIndex-&gt;<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html#o2">List</a>[LeafSelect]),
01865                           (PVOID)&amp;(FastIndex-&gt;<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html#o2">List</a>[LeafSelect+1]),
01866                           (FastIndex-&gt;<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html#o1">Count</a> - LeafSelect) * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__CM__INDEX.html">CM_INDEX</a>));
01867         }
01868     }
01869     <span class="comment">//</span>
01870     <span class="comment">// Else LeafSelect == last entry, so decrementing count was enough</span>
01871     <span class="comment">//</span>
01872 
01873     <span class="keywordflow">if</span> ((IsCompressed) &amp;&amp;
01874         (SearchName.MaximumLength &gt; <span class="keyword">sizeof</span>(CompressedBuffer))) {
01875         (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(SearchName.Buffer, SearchName.Length);
01876     }
01877     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01878 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="cmindex.c::CmpSelectLeaf" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> CmpSelectLeaf           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ParentKey</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>NewName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a77">HSTORAGE_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Type</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>RootPointer</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01257">1257</a> of file <a class="el" href="../../d8/d0/cmindex_8c-source.html">cmindex.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00371">CM_KEY_INDEX_ROOT</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00396">CM_MAX_INDEX</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00722">CmpDoCompareKeyName()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00266">CmpFindSubKeyInRoot()</a>, <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01472">CmpSplitLeaf()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00268">CMS_INDEX</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00388">_CM_KEY_INDEX::Count</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00117">HvMarkCellDirty()</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00389">_CM_KEY_INDEX::List</a>, <a class="el" href="../../d0/d2/rtreplac_8c-source.html#l00045">NewName</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00457">_CM_KEY_NODE::SubKeyLists</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00895">CmpAddSubKey()</a>.
<p>
<pre class="fragment"><div>01266                    :
01267 
01268     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> called <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subkey index <span class="keywordflow">for</span> a cell <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> NOT
01269     simply a single Leaf index block.
01270 
01271     It selects <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Leaf index block to which a <span class="keyword">new</span> entry <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be
01272     added.  It may create <span class="keyword">this</span> block by splitting an existing Leaf
01273     block.
01274 
01275 Arguments:
01276 
01277     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> hive of interest
01278 
01279     ParentKey - mapped pointer to parent key
01280 
01281     <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a> - pointer to unicode string naming entry to add
01282 
01283     Type - <a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a> or <a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>, describes Child's storage
01284 
01285     RootPointer - pointer to variable to receive address of <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>
01286                 that points to Leaf block returned as function argument.
01287                 Used <span class="keywordflow">for</span> updates.
01288 
01289 Return Value:
01290 
01291     <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a> - resource problem
01292 
01293     Else, cell index of Leaf index block to add entry to
01294 
01295 --*/
01296 {
01297     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>     LeafCell;
01298     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>     WorkCell;
01299     <a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>   <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01300     <a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>   Leaf;
01301     ULONG           RootSelect;
01302     LONG            Result;
01303 
01304     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_INDEX) {
01305         KdPrint((<span class="stringliteral">"CmpSelectLeaf:\n\t"</span>));
01306         KdPrint((<span class="stringliteral">"Hive=%08lx ParentKey=%08lx\n"</span>, Hive, ParentKey));
01307     }
01308 
01309 
01310     <span class="comment">//</span>
01311     <span class="comment">// Force root to always be dirty, since we'll either grow it or edit it,</span>
01312     <span class="comment">// and it needs to be marked dirty for BOTH cases.  (Edit may not</span>
01313     <span class="comment">// occur until after we leave</span>
01314     <span class="comment">//</span>
01315     <span class="keywordflow">if</span> (! <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(Hive, ParentKey-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[Type])) {
01316         <span class="keywordflow">return</span> <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01317     }
01318 
01319     <span class="comment">//</span>
01320     <span class="comment">// must find the proper leaf</span>
01321     <span class="comment">//</span>
01322     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, ParentKey-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[Type]);
01323     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Signature == CM_KEY_INDEX_ROOT);
01324 
01325     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01326 
01327         RootSelect = <a class="code" href="../../d7/d1/cmindex_8c.html#a2">CmpFindSubKeyInRoot</a>(Hive, Index, NewName, &amp;LeafCell);
01328 
01329         <span class="keywordflow">if</span> (LeafCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01330 
01331             <span class="comment">//</span>
01332             <span class="comment">// Leaf of interest is somewhere near RootSelect</span>
01333             <span class="comment">//</span>
01334             <span class="comment">// . Always use lowest order leaf we can get away with</span>
01335             <span class="comment">// . Never split a leaf if there's one with space we can use</span>
01336             <span class="comment">// . When we split a leaf, we have to repeat search</span>
01337             <span class="comment">//</span>
01338             <span class="comment">// If (NewKey is below lowest key in selected)</span>
01339             <span class="comment">//    If there's a Leaf below selected with space</span>
01340             <span class="comment">//       use the leaf below</span>
01341             <span class="comment">//    else</span>
01342             <span class="comment">//       use the leaf (split it if not enough space)</span>
01343             <span class="comment">// Else</span>
01344             <span class="comment">//    must be above highest key in selected, less than</span>
01345             <span class="comment">//      lowest key in Leaf to right of selected</span>
01346             <span class="comment">//       if space in selected</span>
01347             <span class="comment">//          use selected</span>
01348             <span class="comment">//       else if space in leaf above selected</span>
01349             <span class="comment">//          use leaf above</span>
01350             <span class="comment">//       else</span>
01351             <span class="comment">//          split selected</span>
01352             <span class="comment">//</span>
01353             LeafCell = <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;List[RootSelect];
01354             Leaf = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, LeafCell);
01355             WorkCell = Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o2">List</a>[0];
01356             Result = <a class="code" href="../../d7/d1/cmindex_8c.html#a5">CmpDoCompareKeyName</a>(Hive, NewName, WorkCell);
01357             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Result != 0);
01358 
01359             <span class="keywordflow">if</span> (Result &lt; 0) {
01360 
01361                 <span class="comment">//</span>
01362                 <span class="comment">// new is off the left end of Selected</span>
01363                 <span class="comment">//</span>
01364                 <span class="keywordflow">if</span> (RootSelect &gt; 0) {
01365 
01366                     <span class="comment">//</span>
01367                     <span class="comment">// there's a Leaf to the left, try to use it</span>
01368                     <span class="comment">//</span>
01369                     LeafCell = <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;List[RootSelect-1];
01370                     Leaf = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, LeafCell);
01371 
01372                     <span class="keywordflow">if</span> (Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a> &lt; (<a class="code" href="../../d9/d0/cmdata_8h.html#a21">CM_MAX_INDEX</a> - 1)) {
01373                         RootSelect--;
01374                         *RootPointer = &amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;List[RootSelect]);
01375                         <span class="keywordflow">break</span>;
01376                     }
01377 
01378                 } <span class="keywordflow">else</span> {
01379                     <span class="comment">//</span>
01380                     <span class="comment">// new key is off the left end of the leftmost leaf.</span>
01381                     <span class="comment">// Use the leftmost leaf, if there's enough room</span>
01382                     <span class="comment">//</span>
01383                     LeafCell = <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;List[0];
01384                     Leaf = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, LeafCell);
01385                     <span class="keywordflow">if</span> (Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a> &lt; (<a class="code" href="../../d9/d0/cmdata_8h.html#a21">CM_MAX_INDEX</a> - 1)) {
01386                         *RootPointer = &amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;List[0]);
01387                         <span class="keywordflow">break</span>;
01388                     }
01389                 }
01390 
01391                 <span class="comment">//</span>
01392                 <span class="comment">// else fall to split case</span>
01393                 <span class="comment">//</span>
01394 
01395             } <span class="keywordflow">else</span> {
01396 
01397                 <span class="comment">//</span>
01398                 <span class="comment">// since new key is not in a Leaf, and is not off</span>
01399                 <span class="comment">// the left end of the ResultSelect Leaf, it must</span>
01400                 <span class="comment">// be off the right end.</span>
01401                 <span class="comment">//</span>
01402                 LeafCell = <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;List[RootSelect];
01403                 Leaf = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, LeafCell);
01404 
01405                 <span class="keywordflow">if</span> (Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a> &lt; (<a class="code" href="../../d9/d0/cmdata_8h.html#a21">CM_MAX_INDEX</a> - 1)) {
01406                     *RootPointer = &amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;List[RootSelect]);
01407                     <span class="keywordflow">break</span>;
01408                 }
01409 
01410                 <span class="comment">//</span>
01411                 <span class="comment">// No space, see if there's a leaf to the rigth</span>
01412                 <span class="comment">// and if it has space</span>
01413                 <span class="comment">//</span>
01414                 <span class="keywordflow">if</span> (RootSelect &lt; (ULONG)(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Count - 1)) {
01415 
01416                     LeafCell = <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;List[RootSelect+1];
01417                     Leaf = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, LeafCell);
01418 
01419                     <span class="keywordflow">if</span> (Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a> &lt; (<a class="code" href="../../d9/d0/cmdata_8h.html#a21">CM_MAX_INDEX</a> - 1)) {
01420                         *RootPointer = &amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;List[RootSelect+1]);
01421                         <span class="keywordflow">break</span>;
01422                     }
01423                 }
01424 
01425                 <span class="comment">//</span>
01426                 <span class="comment">// fall to split case</span>
01427                 <span class="comment">//</span>
01428             }
01429 
01430         } <span class="keywordflow">else</span> {   <span class="comment">// LeafCell != HCELL_NIL</span>
01431 
01432             <span class="comment">//</span>
01433             <span class="comment">// Since newkey cannot already be in tree, it must be</span>
01434             <span class="comment">// greater than the bottom of Leaf and less than the top,</span>
01435             <span class="comment">// therefore it must go in Leaf.  If no space, split it.</span>
01436             <span class="comment">//</span>
01437             Leaf = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, LeafCell);
01438             <span class="keywordflow">if</span> (Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a> &lt; (<a class="code" href="../../d9/d0/cmdata_8h.html#a21">CM_MAX_INDEX</a> - 1)) {
01439 
01440                 *RootPointer = &amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;List[RootSelect]);
01441                 <span class="keywordflow">break</span>;
01442             }
01443 
01444             <span class="comment">//</span>
01445             <span class="comment">// fall to split case</span>
01446             <span class="comment">//</span>
01447         }
01448 
01449         <span class="comment">//</span>
01450         <span class="comment">// either no neigbor, or no space in neighbor, so split</span>
01451         <span class="comment">//</span>
01452         WorkCell = <a class="code" href="../../d7/d1/cmindex_8c.html#a9">CmpSplitLeaf</a>(
01453                         Hive,
01454                         ParentKey-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[Type],       <span class="comment">// root cell</span>
01455                         RootSelect,
01456                         Type
01457                         );
01458         <span class="keywordflow">if</span> (WorkCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01459             <span class="keywordflow">return</span> <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01460         }
01461 
01462         ParentKey-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[Type] = WorkCell;
01463         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, WorkCell);
01464         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Signature == CM_KEY_INDEX_ROOT);
01465 
01466     } <span class="comment">// while(true)</span>
01467     <span class="keywordflow">return</span> LeafCell;
01468 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="cmindex.c::CmpSplitLeaf" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> CmpSplitLeaf           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>RootCell</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>RootSelect</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a77">HSTORAGE_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Type</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01472">1472</a> of file <a class="el" href="../../d8/d0/cmindex_8c-source.html">cmindex.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00372">CM_KEY_INDEX_LEAF</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00268">CMS_INDEX</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00388">_CM_KEY_INDEX::Count</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00386">HvAllocateCell()</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00688">HvFreeCell()</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00335">HvGetCellSize()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00117">HvMarkCellDirty()</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l01295">HvReallocateCell()</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00094">List</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00389">_CM_KEY_INDEX::List</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00387">_CM_KEY_INDEX::Signature</a>, <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d8/d0/cmindex_8c-source.html#l01257">CmpSelectLeaf()</a>.
<p>
<pre class="fragment"><div>01480                    :
01481 
01482     Split <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Leaf index block specified by RootSelect, causing both
01483     of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> split <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> Leaf blocks to appear in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Root index block
01484     specified by RootCell.
01485 
01486     Caller <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> expected to have marked old root cell dirty.
01487 
01488 Arguments:
01489 
01490     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> hive of interest
01491 
01492     RootCell - cell of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Root index block of index being grown
01493 
01494     RootSelect - indicates which child of Root to split
01495 
01496     Type - <a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a> or <a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>
01497 
01498 Return Value:
01499 
01500     <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a> - some resource problem
01501 
01502     Else - cell of <span class="keyword">new</span> (e.g. reallocated) Root index block
01503 
01504 --*/
01505 {
01506     <a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>   Root;
01507     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>     LeafCell;
01508     <a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>   Leaf;
01509     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>     NewLeafCell;
01510     <a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>   NewLeaf;
01511     ULONG           <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
01512     ULONG           freecount;
01513     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>          OldCount;
01514     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>          KeepCount;
01515     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>          NewCount;
01516 
01517     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_INDEX) {
01518         KdPrint((<span class="stringliteral">"CmpSplitLeaf:\n\t"</span>));
01519         KdPrint((<span class="stringliteral">"Hive=%08lx RootCell=%08lx RootSelect\n"</span>, Hive, RootCell, RootSelect));
01520     }
01521 
01522     <span class="comment">//</span>
01523     <span class="comment">// allocate new Leaf index block</span>
01524     <span class="comment">//</span>
01525     Root = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, RootCell);
01526     LeafCell = Root-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o2">List</a>[RootSelect];
01527     Leaf = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, LeafCell);
01528     OldCount = Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a>;
01529 
01530     KeepCount = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(OldCount / 2);     <span class="comment">// # of entries to keep in org. Leaf</span>
01531     NewCount = (OldCount - KeepCount);      <span class="comment">// # of entries to move</span>
01532 
01533     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = (<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>) * NewCount) +
01534             FIELD_OFFSET(<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">CM_KEY_INDEX</a>, List) + 1;   <span class="comment">// +1 to assure room for add</span>
01535 
01536     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(Hive, LeafCell)) {
01537         <span class="keywordflow">return</span> <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01538     }
01539 
01540     NewLeafCell = <a class="code" href="../../d8/d0/hivecell_8c.html#a16">HvAllocateCell</a>(Hive, Size, Type);
01541     <span class="keywordflow">if</span> (NewLeafCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01542         <span class="keywordflow">return</span> <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01543     }
01544     NewLeaf = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, NewLeafCell);
01545     NewLeaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o0">Signature</a> = <a class="code" href="../../d9/d0/cmdata_8h.html#a19">CM_KEY_INDEX_LEAF</a>;
01546 
01547 
01548     <span class="comment">//</span>
01549     <span class="comment">// compute number of free slots left in the root</span>
01550     <span class="comment">//</span>
01551     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = <a class="code" href="../../d8/d0/hivecell_8c.html#a15">HvGetCellSize</a>(Hive, Root);
01552     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> - ((<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>) * Root-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a>) +
01553               FIELD_OFFSET(<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">CM_KEY_INDEX</a>, List));
01554     freecount = <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> / <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>);
01555 
01556 
01557     <span class="comment">//</span>
01558     <span class="comment">// grow the root if it isn't big enough</span>
01559     <span class="comment">//</span>
01560     <span class="keywordflow">if</span> (freecount &lt; 1) {
01561         <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = <a class="code" href="../../d8/d0/hivecell_8c.html#a15">HvGetCellSize</a>(Hive, Root) + <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>);
01562         RootCell = <a class="code" href="../../d8/d0/hivecell_8c.html#a20">HvReallocateCell</a>(Hive, RootCell, Size);
01563         <span class="keywordflow">if</span> (RootCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01564             <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(Hive, NewLeafCell);
01565             <span class="keywordflow">return</span> <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01566         }
01567         Root = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, RootCell);
01568     }
01569 
01570 
01571     <span class="comment">//</span>
01572     <span class="comment">// copy data from one Leaf to the other</span>
01573     <span class="comment">//</span>
01574     RtlMoveMemory(
01575         (PVOID)&amp;(NewLeaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o2">List</a>[0]),
01576         (PVOID)&amp;(Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o2">List</a>[KeepCount]),
01577         <span class="keyword">sizeof</span>(HCELL_INDEX) * NewCount
01578         );
01579 
01580     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeepCount != 0);
01581     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(NewCount  != 0);
01582 
01583     Leaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a> = KeepCount;
01584     NewLeaf-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a> = NewCount;
01585 
01586 
01587     <span class="comment">//</span>
01588     <span class="comment">// make an open slot in the root</span>
01589     <span class="comment">//</span>
01590     <span class="keywordflow">if</span> (RootSelect &lt; (ULONG)(Root-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a>-1)) {
01591         RtlMoveMemory(
01592             (PVOID)&amp;(Root-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o2">List</a>[RootSelect+2]),
01593             (PVOID)&amp;(Root-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o2">List</a>[RootSelect+1]),
01594             (Root-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a> - (RootSelect + 1)) * <span class="keyword">sizeof</span>(HCELL_INDEX)
01595             );
01596     }
01597 
01598     <span class="comment">//</span>
01599     <span class="comment">// update the root</span>
01600     <span class="comment">//</span>
01601     Root-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o1">Count</a> += 1;
01602     Root-&gt;<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html#o2">List</a>[RootSelect+1] = NewLeafCell;
01603     <span class="keywordflow">return</span> RootCell;
01604 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a0" doxytag="cmindex.c::CmpHintHits" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d7/d1/cmindex_8c.html#a0">CmpHintHits</a> = 0          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00181">181</a> of file <a class="el" href="../../d8/d0/cmindex_8c-source.html">cmindex.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00186">CmpFindSubKeyByName()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="cmindex.c::CmpHintMisses" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d7/d1/cmindex_8c.html#a1">CmpHintMisses</a> = 0          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00182">182</a> of file <a class="el" href="../../d8/d0/cmindex_8c-source.html">cmindex.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d0/cmindex_8c-source.html#l00186">CmpFindSubKeyByName()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:08 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
