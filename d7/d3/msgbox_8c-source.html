<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: msgbox.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>msgbox.c</h1><a href="../../d6/d4/msgbox_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: msgbox.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* This module contains the MessageBox API and related functions.</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 10-23-90 DarrinM     Created.</span>
00010 <span class="comment">* 02-08-91 IanJa       HWND revalidation added</span>
00011 <span class="comment">\***************************************************************************/</span>
00012 
00013 <span class="preprocessor">#include "<a class="code" href="../../d7/d3/w32_2ntuser_2client_2precomp_8h.html">precomp.h</a>"</span>
00014 <span class="preprocessor">#pragma hdrstop</span>
00015 <span class="preprocessor"></span>
00016 <span class="comment">//</span>
00017 <span class="comment">// Dimension constants  --  D.U. == dialog units</span>
00018 <span class="comment">//</span>
<a name="l00019"></a><a class="code" href="../../d6/d4/msgbox_8c.html#a0">00019</a> <span class="preprocessor">#define DU_OUTERMARGIN    7</span>
<a name="l00020"></a><a class="code" href="../../d6/d4/msgbox_8c.html#a1">00020</a> <span class="preprocessor"></span><span class="preprocessor">#define DU_INNERMARGIN    10</span>
00021 <span class="preprocessor"></span>
<a name="l00022"></a><a class="code" href="../../d6/d4/msgbox_8c.html#a2">00022</a> <span class="preprocessor">#define DU_BTNGAP         4   // D.U. of space between buttons</span>
<a name="l00023"></a><a class="code" href="../../d6/d4/msgbox_8c.html#a3">00023</a> <span class="preprocessor"></span><span class="preprocessor">#define DU_BTNHEIGHT      14  // D.U. of button height</span>
00024 <span class="preprocessor"></span><span class="comment">// This is used only in kernel\inctlpan.c, so move it there</span>
00025 <span class="comment">//</span>
00026 <span class="comment">// #define DU_BTNWIDTH       50  // D.U. of button width, minimum</span>
00027 <span class="comment">//</span>
00028 
00029 LPBYTE <a class="code" href="../../d6/d4/msgbox_8c.html#a12">MB_UpdateDlgHdr</a>(LPDLGTEMPLATE lpDlgTmp, <span class="keywordtype">long</span> lStyle, <span class="keywordtype">long</span> lExtendedStyle, BYTE bItemCount,
00030            <span class="keywordtype">int</span> iX, <span class="keywordtype">int</span> iY, <span class="keywordtype">int</span> iCX, <span class="keywordtype">int</span> iCY, LPWSTR lpszCaption, <span class="keywordtype">int</span> iCaptionLen);
00031 LPBYTE <a class="code" href="../../d6/d4/msgbox_8c.html#a13">MB_UpdateDlgItem</a>(LPDLGITEMTEMPLATE lpDlgItem, <span class="keywordtype">int</span> iCtrlId, <span class="keywordtype">long</span> lStyle, <span class="keywordtype">long</span> lExtendedStyle,
00032            <span class="keywordtype">int</span> iX, <span class="keywordtype">int</span> iY, <span class="keywordtype">int</span> iCX, <span class="keywordtype">int</span> iCY, LPWSTR lpszText, UINT wTextLen,
00033            <span class="keywordtype">int</span> iControlClass);
00034 <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>   <a class="code" href="../../d6/d4/msgbox_8c.html#a14">MB_GetIconOrdNum</a>(UINT rgBits);
00035 LPBYTE <a class="code" href="../../d6/d4/msgbox_8c.html#a15">MB_AddPushButtons</a>(
00036     LPDLGITEMTEMPLATE lpDlgTmp,
00037     <a class="code" href="../../d7/d9/struct__MSGBOXDATA.html">LPMSGBOXDATA</a>      lpmb,
00038     UINT wLEdge,
00039     UINT wBEdge,
00040     DWORD dwStyleMsg);
00041 <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d6/d4/msgbox_8c.html#a16">MB_FindDlgTemplateSize</a>( <a class="code" href="../../d7/d9/struct__MSGBOXDATA.html">LPMSGBOXDATA</a> lpmb );
00042 <span class="keywordtype">int</span> <a class="code" href="../../d6/d4/msgbox_8c.html#a17">MessageBoxWorker</a>(<a class="code" href="../../d7/d9/struct__MSGBOXDATA.html">LPMSGBOXDATA</a> pMsgBoxParams);
00043 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d6/d4/msgbox_8c.html#a18">EndTaskModalDialog</a>(HWND hwndDlg);
00044 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d6/d4/msgbox_8c.html#a19">StartTaskModalDialog</a>(HWND hwndDlg);
00045 
00046 <span class="preprocessor">#ifdef _JANUS_</span>
00047 <span class="preprocessor"></span>
00048 <span class="comment">// the definition for message file</span>
00049 <span class="preprocessor">#include "strid.h"</span>
00050 <span class="preprocessor">#include "imagehlp.h"</span>
00051 
00052 <span class="comment">// constant strings</span>
00053 CONST WCHAR szEMIKey[] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Control\\Error Message Instrument\\"</span>;
00054 CONST WCHAR szEMIEnable[] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"EnableLogging"</span>;
00055 CONST WCHAR szEMISeverity[] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"LogSeverity"</span>;
00056 CONST WCHAR szDMREnable[] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"EnableDefaultReply"</span>;
00057 CONST WCHAR szUnknown[] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Unknown"</span>;
00058 CONST WCHAR szEventKey[] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Services\\EventLog\\Application\\Error Instrument\\"</span>;
00059 CONST WCHAR szEventMsgFile[] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"EventMessageFile"</span>;
00060 CONST WCHAR szEventType[] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"TypesSupported"</span>;
00061 
00062 <span class="preprocessor">#define TITLE_SIZE          64</span>
00063 <span class="preprocessor"></span><span class="preprocessor">#define DATETIME_SIZE       32</span>
00064 <span class="preprocessor"></span>
00065 <span class="preprocessor">#define EMI_SEVERITY_ALL          0</span>
00066 <span class="preprocessor"></span><span class="preprocessor">#define EMI_SEVERITY_USER         1</span>
00067 <span class="preprocessor"></span><span class="preprocessor">#define EMI_SEVERITY_INFORMATION  2</span>
00068 <span class="preprocessor"></span><span class="preprocessor">#define EMI_SEVERITY_QUESTION     3</span>
00069 <span class="preprocessor"></span><span class="preprocessor">#define EMI_SEVERITY_WARNING      4</span>
00070 <span class="preprocessor"></span><span class="preprocessor">#define EMI_SEVERITY_ERROR        5</span>
00071 <span class="preprocessor"></span><span class="preprocessor">#define EMI_SEVERITY_MAX_VALUE    5</span>
00072 <span class="preprocessor"></span>
00073 <span class="comment">// element of error message</span>
00074 PVOID gpReturnAddr = 0;
00075 HANDLE gdwEMIThreadID = 0;
00076 <span class="keyword">typedef</span> <span class="keyword">struct </span>_ERROR_ELEMENT {
00077     WCHAR       <a class="code" href="../../d7/d7/uclient_8c.html#a2">ProcessName</a>[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
00078     WCHAR       WindowTitle[TITLE_SIZE];
00079     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>       dwStyle;
00080     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>       dwErrorCode;
00081     WCHAR       CallerModuleName[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
00082     PVOID       BaseAddr;
00083     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>       dwImageSize;
00084     PVOID       ReturnAddr;
00085     LPWSTR      lpszCaption;
00086     LPWSTR      lpszText;
00087 } ERROR_ELEMENT, *LPERROR_ELEMENT;
00088 
00089 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> ErrorMessageInst(<a class="code" href="../../d7/d9/struct__MSGBOXDATA.html">LPMSGBOXDATA</a> pMsgBoxParams);
00090 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> InitInstrument(LPDWORD lpEMIControl);
00091 
00092 <span class="comment">// eventlog stuff</span>
00093 FARPROC <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a7">gfnRegisterEventSource</a>;
00094 FARPROC <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a8">gfnDeregisterEventSource</a>;
00095 FARPROC <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a9">gfnReportEvent</a>;
00096 FARPROC gfnGetTokenInformation;
00097 FARPROC gfnOpenProcessToken;
00098 FARPROC gfnOpenThreadToken;
00099 HANDLE <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a14">gEventSource</a>;
00100 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> CreateLogSource();
00101 HANDLE RegisterLogSource(LPWSTR lpszSource);
00102 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> LogMessageBox(LPERROR_ELEMENT lpErrEle);
00103 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> GetUserSid(PTOKEN_USER *ppTokenUser);
00104 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> GetTokenHandle(PHANDLE pTokenHandle);
00105 
00106 <span class="preprocessor">#define EMIGETRETURNADDRESS()                                    \</span>
00107 <span class="preprocessor">{                                                                \</span>
00108 <span class="preprocessor">    if (gfEMIEnable) {                                           \</span>
00109 <span class="preprocessor">        if (InterlockedCompareExchangePointer(&amp;gdwEMIThreadID,   \</span>
00110 <span class="preprocessor">                                              GETTHREADID(),     \</span>
00111 <span class="preprocessor">                                              0)                 \</span>
00112 <span class="preprocessor">             == 0) {                                             \</span>
00113 <span class="preprocessor">            gpReturnAddr = _ReturnAddress();                     \</span>
00114 <span class="preprocessor">        }                                                        \</span>
00115 <span class="preprocessor">    }                                                            \</span>
00116 <span class="preprocessor">}</span>
00117 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00118"></a><a class="code" href="../../d6/d4/msgbox_8c.html#a4">00118</a> <span class="preprocessor"></span><span class="preprocessor">#define EMIGETRETURNADDRESS()</span>
00119 <span class="preprocessor"></span><span class="preprocessor">#endif //_JANUS_</span>
00120 <span class="preprocessor"></span>
00121 
00122 
<a name="l00123"></a><a class="code" href="../../d6/d4/msgbox_8c.html#a5">00123</a> <span class="preprocessor">#define MB_MASKSHIFT    4</span>
00124 <span class="preprocessor"></span>
<a name="l00125"></a><a class="code" href="../../d6/d4/msgbox_8c.html#a7">00125</a> CONST WCHAR <a class="code" href="../../d6/d4/msgbox_8c.html#a7">szEmpty</a>[] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">""</span>;
<a name="l00126"></a><a class="code" href="../../d6/d4/msgbox_8c.html#a8">00126</a> WCHAR <a class="code" href="../../d6/d4/msgbox_8c.html#a8">szERROR</a>[10];
<a name="l00127"></a><a class="code" href="../../d6/d4/msgbox_8c.html#a9">00127</a> ATOM <a class="code" href="../../d6/d4/msgbox_8c.html#a9">atomBwlProp</a>;
<a name="l00128"></a><a class="code" href="../../d6/d4/msgbox_8c.html#a10">00128</a> ATOM <a class="code" href="../../d6/d4/msgbox_8c.html#a10">atomMsgBoxCallback</a>;
00129 
00130 <span class="comment">/***************************************************************************\</span>
00131 <span class="comment">* SendHelpMessage</span>
00132 <span class="comment">*</span>
00133 <span class="comment">*</span>
00134 <span class="comment">\***************************************************************************/</span>
00135 
<a name="l00136"></a><a class="code" href="../../d6/d4/msgbox_8c.html#a20">00136</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d4/msgbox_8c.html#a20">SendHelpMessage</a>(
00137     HWND   hwnd,
00138     <span class="keywordtype">int</span>    iType,
00139     <span class="keywordtype">int</span>    iCtrlId,
00140     HANDLE hItemHandle,
00141     DWORD  dwContextId,
00142     MSGBOXCALLBACK lpfnCallback)
00143 {
00144     HELPINFO    HelpInfo;
00145     <span class="keywordtype">long</span>        lValue;
00146 
00147     HelpInfo.cbSize = <span class="keyword">sizeof</span>(HELPINFO);
00148     HelpInfo.iContextType = iType;
00149     HelpInfo.iCtrlId = iCtrlId;
00150     HelpInfo.hItemHandle = hItemHandle;
00151     HelpInfo.dwContextId = dwContextId;
00152 
00153     lValue = <a class="code" href="../../d6/d0/usercli_8h.html#a217">NtUserGetMessagePos</a>();
00154     HelpInfo.MousePos.x = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a7">GET_X_LPARAM</a>(lValue);
00155     HelpInfo.MousePos.y = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a8">GET_Y_LPARAM</a>(lValue);
00156 
00157     <span class="comment">// Check if there is an app supplied callback.</span>
00158     <span class="keywordflow">if</span>(lpfnCallback != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00159         <span class="keywordflow">if</span> (IsWOWProc(lpfnCallback)) {
00160             (*pfnWowMsgBoxIndirectCallback)(PtrToUlong(lpfnCallback), &amp;HelpInfo);
00161         } <span class="keywordflow">else</span> {
00162             (*lpfnCallback)(&amp;HelpInfo);
00163         }
00164     } <span class="keywordflow">else</span> {
00165         <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(hwnd, WM_HELP, 0, (LPARAM)&amp;HelpInfo);
00166     }
00167 }
00168 
00169 
00170 <span class="comment">/***************************************************************************\</span>
00171 <span class="comment">* ServiceMessageBox</span>
00172 <span class="comment">*</span>
00173 <span class="comment">*</span>
00174 <span class="comment">\***************************************************************************/</span>
00175 
<a name="l00176"></a><a class="code" href="../../d6/d4/msgbox_8c.html#a11">00176</a> CONST <span class="keywordtype">int</span> <a class="code" href="../../d6/d4/msgbox_8c.html#a11">aidReturn</a>[] = { 0, 0, IDABORT, IDCANCEL, IDIGNORE, IDNO, IDOK, IDRETRY, IDYES };
00177 
<a name="l00178"></a><a class="code" href="../../d6/d4/msgbox_8c.html#a21">00178</a> <span class="keywordtype">int</span> <a class="code" href="../../d6/d4/msgbox_8c.html#a21">ServiceMessageBox</a>(
00179     LPCWSTR pText,
00180     LPCWSTR pCaption,
00181     UINT wType)
00182 {
00183     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00184     ULONG_PTR Parameters[3];
00185     ULONG Response = ResponseNotHandled;
00186     UNICODE_STRING Text, Caption;
00187 
00188     <span class="comment">/*</span>
00189 <span class="comment">     * For Terminal Services we must decided the session in which this message</span>
00190 <span class="comment">     * box should be displayed.  We do this by looking at the impersonation token</span>
00191 <span class="comment">     * and use the session on which the client is running.</span>
00192 <span class="comment">     */</span>
00193     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/inc_2user_8h.html#a882">ISTS</a>()) {
00194         HANDLE      TokenHandle;
00195         <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00196         ULONG       ClientSessionId;
00197         ULONG       ProcessSessionId;
00198         ULONG       ReturnLength;
00199         BOOLEAN     bResult;
00200 
00201         <span class="comment">/*</span>
00202 <span class="comment">         * Obtain access to the impersonation token if it's present.</span>
00203 <span class="comment">         */</span>
00204         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d3/tokenopn_8c.html#a3">NtOpenThreadToken</a> (
00205             GetCurrentThread(),
00206             TOKEN_ADJUST_PRIVILEGES | TOKEN_QUERY,
00207             <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00208             &amp;TokenHandle
00209             );
00210         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
00211             <span class="comment">/*</span>
00212 <span class="comment">             * Query the Session ID out of the Token</span>
00213 <span class="comment">             */</span>
00214             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a> (
00215                 TokenHandle,
00216                 TokenSessionId,
00217                 (PVOID)&amp;ClientSessionId,
00218                 <span class="keyword">sizeof</span>(ClientSessionId),
00219                 &amp;ReturnLength
00220                 );
00221             CloseHandle(TokenHandle);
00222             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00223                 <span class="comment">/*</span>
00224 <span class="comment">                 * Get the process session Id.  Use the Kernel32 API first because</span>
00225 <span class="comment">                 * the PEB is writable in case someone is hacking it.</span>
00226 <span class="comment">                 */</span>
00227                 <span class="keywordflow">if</span> (!ProcessIdToSessionId(<a class="code" href="../../d4/d1/userk_8h.html#a19">GetCurrentProcessId</a>(), &amp;ProcessSessionId)) {
00228                     ProcessSessionId = NtCurrentPeb()-&gt;SessionId;
00229                 }
00230 
00231                 <span class="keywordflow">if</span> (ClientSessionId != ProcessSessionId)
00232                 {
00233                     <span class="comment">/*</span>
00234 <span class="comment">                     * Make sure WinSta.Dll is loaded</span>
00235 <span class="comment">                     */</span>
00236                     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/clglobal_8c.html#a69">ghinstWinStaDll</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00237                         <a class="code" href="../../d1/d8/clglobal_8c.html#a69">ghinstWinStaDll</a> = LoadLibrary(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"winsta.dll"</span>);
00238 
00239                         <span class="comment">/*</span>
00240 <span class="comment">                         * Get the function pointer if WinSta.Dll loaded.</span>
00241 <span class="comment">                         */</span>
00242                         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/clglobal_8c.html#a69">ghinstWinStaDll</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00243                             <a class="code" href="../../d1/d8/clglobal_8c.html#a68">gfnWinStationSendMessageW</a> = GetProcAddress(<a class="code" href="../../d1/d8/clglobal_8c.html#a69">ghinstWinStaDll</a>, <span class="stringliteral">"WinStationSendMessageW"</span>);
00244                         }
00245                     }
00246 
00247                     <span class="comment">/*</span>
00248 <span class="comment">                     * This message box was intended for session other than the</span>
00249 <span class="comment">                     * one on which this process is running.  Forward it to the</span>
00250 <span class="comment">                     * right session with WinStationSendMessage().</span>
00251 <span class="comment">                     */</span>
00252                     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/clglobal_8c.html#a68">gfnWinStationSendMessageW</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00253 
00254                         <span class="comment">/*</span>
00255 <span class="comment">                         * Handle case where Caption or Title is NULL</span>
00256 <span class="comment">                         */</span>
00257                         <span class="keywordflow">if</span> (pCaption == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00258                             pCaption = <a class="code" href="../../d6/d4/msgbox_8c.html#a7">szEmpty</a>;
00259                         <span class="keywordflow">if</span> (pText == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00260                             pText = <a class="code" href="../../d6/d4/msgbox_8c.html#a7">szEmpty</a>;
00261 
00262                         bResult = (BOOLEAN)<a class="code" href="../../d8/d6/ntuser_2client_2globals_8h.html#a79">gfnWinStationSendMessageW</a>(
00263                                       SERVERNAME_CURRENT,
00264                                       ClientSessionId,
00265                                       pCaption,
00266                                       wcslen( pCaption ) * <span class="keyword">sizeof</span>( WCHAR ),
00267                                       pText,
00268                                       wcslen( pText ) * <span class="keyword">sizeof</span>( WCHAR ),
00269                                       wType,
00270                                       -1,           <span class="comment">// Wait forever</span>
00271                                       &amp;Response,
00272                                       <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>         <span class="comment">// always wait</span>
00273                                   );
00274                         <span class="keywordflow">if</span> (bResult != <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)
00275                             Response = <a class="code" href="../../d6/d4/msgbox_8c.html#a11">aidReturn</a>[ResponseNotHandled];
00276                         <span class="keywordflow">else</span> {
00277                             <span class="keywordflow">if</span> (Response == IDTIMEOUT || Response == IDERROR) {
00278                                 Response = <a class="code" href="../../d6/d4/msgbox_8c.html#a11">aidReturn</a>[ResponseNotHandled];
00279                             }
00280                         }
00281 
00282                         <span class="keywordflow">return</span> (<span class="keywordtype">int</span>)Response;
00283                     }
00284                 }
00285             }
00286         }
00287     }
00288 
00289     <span class="comment">/*</span>
00290 <span class="comment">     * MessageBox is for this session, go call CSR.</span>
00291 <span class="comment">     */</span>
00292     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Text, pText);
00293     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Caption, pCaption);
00294     Parameters[0] = (ULONG_PTR)&amp;Text;
00295     Parameters[1] = (ULONG_PTR)&amp;Caption;
00296     Parameters[2] = wType;
00297 
00298     <span class="comment">/*</span>
00299 <span class="comment">     * Compatibility: Pass the override bit to make sure this box always shows</span>
00300 <span class="comment">     */</span>
00301     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d8/ex_2harderr_8c.html#a11">NtRaiseHardError</a>(STATUS_SERVICE_NOTIFICATION | HARDERROR_OVERRIDE_ERRORMODE,
00302                               <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a2">ARRAY_SIZE</a>(Parameters),
00303                               3,
00304                               Parameters,
00305                               OptionOk,
00306                               &amp;Response);
00307 
00308     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00309         RIPNTERR0(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>, RIP_VERBOSE, <span class="stringliteral">""</span>);
00310     }
00311 
00312     <span class="keywordflow">return</span> <a class="code" href="../../d6/d4/msgbox_8c.html#a11">aidReturn</a>[Response];
00313 }
00314 
00315 
00316 <span class="comment">/***************************************************************************\</span>
00317 <span class="comment">* MessageBox (API)</span>
00318 <span class="comment">*</span>
00319 <span class="comment">* History:</span>
00320 <span class="comment">* 11-20-90 DarrinM      Ported from Win 3.0 sources.</span>
00321 <span class="comment">\***************************************************************************/</span>
00322 
<a name="l00323"></a><a class="code" href="../../d6/d4/msgbox_8c.html#a22">00323</a> <span class="keywordtype">int</span> <a class="code" href="../../d6/d4/msgbox_8c.html#a22">MessageBoxA</a>(
00324     HWND hwndOwner,
00325     LPCSTR lpszText,
00326     LPCSTR lpszCaption,
00327     UINT wStyle)
00328 {
00329     <a class="code" href="../../d6/d4/msgbox_8c.html#a4">EMIGETRETURNADDRESS</a>();
00330     <span class="keywordflow">return</span> <a class="code" href="../../d6/d4/msgbox_8c.html#a24">MessageBoxExA</a>(hwndOwner, lpszText, lpszCaption, wStyle, 0);
00331 }
00332 
<a name="l00333"></a><a class="code" href="../../d6/d4/msgbox_8c.html#a23">00333</a> <span class="keywordtype">int</span> <a class="code" href="../../d6/d4/msgbox_8c.html#a23">MessageBoxW</a>(
00334     HWND hwndOwner,
00335     LPCWSTR lpszText,
00336     LPCWSTR lpszCaption,
00337     UINT wStyle)
00338 {
00339     <a class="code" href="../../d6/d4/msgbox_8c.html#a4">EMIGETRETURNADDRESS</a>();
00340     <span class="keywordflow">return</span> <a class="code" href="../../d6/d4/msgbox_8c.html#a25">MessageBoxExW</a>(hwndOwner, lpszText, lpszCaption, wStyle, 0);
00341 }
00342 
00343 
00344 <span class="comment">/***************************************************************************\</span>
00345 <span class="comment">* MessageBoxEx (API)</span>
00346 <span class="comment">*</span>
00347 <span class="comment">* History:</span>
00348 <span class="comment">* 11-20-90 DarrinM      Ported from Win 3.0 sources.</span>
00349 <span class="comment">\***************************************************************************/</span>
00350 
<a name="l00351"></a><a class="code" href="../../d6/d4/msgbox_8c.html#a24">00351</a> <span class="keywordtype">int</span> <a class="code" href="../../d6/d4/msgbox_8c.html#a24">MessageBoxExA</a>(
00352     HWND hwndOwner,
00353     LPCSTR lpszText,
00354     LPCSTR lpszCaption,
00355     UINT wStyle,
00356     WORD wLanguageId)
00357 {
00358     <span class="keywordtype">int</span> retval;
00359     LPWSTR lpwszText = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00360     LPWSTR lpwszCaption = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00361 
00362     <span class="keywordflow">if</span> (lpszText) {
00363         <span class="keywordflow">if</span> (!MBToWCS(lpszText, -1, &amp;lpwszText, -1, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>))
00364             <span class="keywordflow">return</span> 0;
00365     }
00366 
00367     <span class="keywordflow">if</span> (lpszCaption) {
00368         <span class="keywordflow">if</span> (!MBToWCS(lpszCaption, -1, &amp;lpwszCaption, -1, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
00369             <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(lpwszText);
00370             <span class="keywordflow">return</span> 0;
00371         }
00372     }
00373 
00374     <a class="code" href="../../d6/d4/msgbox_8c.html#a4">EMIGETRETURNADDRESS</a>();
00375     retval = <a class="code" href="../../d6/d4/msgbox_8c.html#a25">MessageBoxExW</a>(hwndOwner,
00376                            lpwszText,
00377                            lpwszCaption,
00378                            wStyle,
00379                            wLanguageId);
00380 
00381     <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(lpwszText);
00382     <span class="keywordflow">if</span> (lpwszCaption)
00383         <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(lpwszCaption);
00384 
00385     <span class="keywordflow">return</span> retval;
00386 }
00387 
<a name="l00388"></a><a class="code" href="../../d6/d4/msgbox_8c.html#a25">00388</a> <span class="keywordtype">int</span> <a class="code" href="../../d6/d4/msgbox_8c.html#a25">MessageBoxExW</a>(
00389     HWND hwndOwner,
00390     LPCWSTR lpszText,
00391     LPCWSTR lpszCaption,
00392     UINT wStyle,
00393     WORD wLanguageId)
00394 {
00395     <a class="code" href="../../d7/d9/struct__MSGBOXDATA.html">MSGBOXDATA</a>  MsgBoxParams;
00396 
00397 
00398 <span class="preprocessor">#if DBG</span>
00399 <span class="preprocessor"></span>    <span class="comment">/*</span>
00400 <span class="comment">     * MB_USERICON is valid for MessageBoxIndirect only.</span>
00401 <span class="comment">     * MessageBoxWorker validates the other style bits</span>
00402 <span class="comment">     */</span>
00403     <span class="keywordflow">if</span> (wStyle &amp; MB_USERICON) {
00404         RIPMSG0(RIP_WARNING, <span class="stringliteral">"MessageBoxExW: Invalid flag: MB_USERICON"</span>);
00405     }
00406 <span class="preprocessor">#endif</span>
00407 <span class="preprocessor"></span>
00408     RtlZeroMemory(&amp;MsgBoxParams, <span class="keyword">sizeof</span>(MsgBoxParams));
00409     MsgBoxParams.cbSize           = <span class="keyword">sizeof</span>(MSGBOXPARAMS);
00410     MsgBoxParams.hwndOwner        = hwndOwner;
00411     MsgBoxParams.hInstance        = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00412     MsgBoxParams.lpszText         = lpszText;
00413     MsgBoxParams.lpszCaption      = lpszCaption;
00414     MsgBoxParams.dwStyle          = wStyle;
00415     MsgBoxParams.wLanguageId      = wLanguageId;
00416 
00417     <a class="code" href="../../d6/d4/msgbox_8c.html#a4">EMIGETRETURNADDRESS</a>();
00418     <span class="keywordflow">return</span> <a class="code" href="../../d6/d4/msgbox_8c.html#a17">MessageBoxWorker</a>(&amp;MsgBoxParams);
00419 }
00420 
00421 <span class="comment">/**************************************************************************\</span>
00422 <span class="comment">* MessageBoxIndirect (API)</span>
00423 <span class="comment">*</span>
00424 <span class="comment">* 09-30-94 FritzS  Created</span>
00425 <span class="comment">\**************************************************************************/</span>
00426 
<a name="l00427"></a><a class="code" href="../../d6/d4/msgbox_8c.html#a26">00427</a> <span class="keywordtype">int</span> <a class="code" href="../../d6/d4/msgbox_8c.html#a26">MessageBoxIndirectA</a>(
00428     CONST MSGBOXPARAMSA *lpmbp)
00429 {
00430     <span class="keywordtype">int</span> retval;
00431     <a class="code" href="../../d7/d9/struct__MSGBOXDATA.html">MSGBOXDATA</a>  MsgBoxParams;
00432     LPWSTR lpwszText = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00433     LPWSTR lpwszCaption = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00434 
00435     <span class="keywordflow">if</span> (lpmbp-&gt;cbSize != <span class="keyword">sizeof</span>(MSGBOXPARAMS)) {
00436         RIPMSG0(RIP_WARNING, <span class="stringliteral">"MessageBoxIndirect: Invalid cbSize"</span>);
00437     }
00438 
00439     RtlZeroMemory(&amp;MsgBoxParams, <span class="keyword">sizeof</span>(MsgBoxParams));
00440     RtlCopyMemory(&amp;MsgBoxParams, lpmbp, <span class="keyword">sizeof</span>(MSGBOXPARAMS));
00441 
00442     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a98">IS_PTR</a>(MsgBoxParams.lpszText)) {
00443         <span class="keywordflow">if</span> (!MBToWCS((LPSTR)MsgBoxParams.lpszText, -1, &amp;lpwszText, -1, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>))
00444             <span class="keywordflow">return</span> 0;
00445         MsgBoxParams.lpszText = lpwszText;
00446     }
00447     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a98">IS_PTR</a>(MsgBoxParams.lpszCaption)) {
00448         <span class="keywordflow">if</span> (!MBToWCS((LPSTR)MsgBoxParams.lpszCaption, -1, &amp;lpwszCaption, -1, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
00449             <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(lpwszText);
00450             <span class="keywordflow">return</span> 0;
00451         }
00452         MsgBoxParams.lpszCaption = lpwszCaption;
00453     }
00454 
00455     <a class="code" href="../../d6/d4/msgbox_8c.html#a4">EMIGETRETURNADDRESS</a>();
00456     retval = <a class="code" href="../../d6/d4/msgbox_8c.html#a17">MessageBoxWorker</a>(&amp;MsgBoxParams);
00457 
00458     <span class="keywordflow">if</span> (lpwszText)
00459         <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(lpwszText);
00460     <span class="keywordflow">if</span> (lpwszCaption)
00461         <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(lpwszCaption);
00462 
00463     <span class="keywordflow">return</span> retval;
00464 }
00465 
<a name="l00466"></a><a class="code" href="../../d6/d4/msgbox_8c.html#a27">00466</a> <span class="keywordtype">int</span> <a class="code" href="../../d6/d4/msgbox_8c.html#a27">MessageBoxIndirectW</a>(
00467     CONST MSGBOXPARAMSW *lpmbp)
00468 {
00469     <a class="code" href="../../d7/d9/struct__MSGBOXDATA.html">MSGBOXDATA</a>  MsgBoxParams;
00470 
00471     <span class="keywordflow">if</span> (lpmbp-&gt;cbSize != <span class="keyword">sizeof</span>(MSGBOXPARAMS)) {
00472         RIPMSG0(RIP_WARNING, <span class="stringliteral">"MessageBoxIndirect: Invalid cbSize"</span>);
00473     }
00474 
00475     RtlZeroMemory(&amp;MsgBoxParams, <span class="keyword">sizeof</span>(MsgBoxParams));
00476     RtlCopyMemory(&amp;MsgBoxParams, lpmbp, <span class="keyword">sizeof</span>(MSGBOXPARAMS));
00477 
00478     <a class="code" href="../../d6/d4/msgbox_8c.html#a4">EMIGETRETURNADDRESS</a>();
00479     <span class="keywordflow">return</span> <a class="code" href="../../d6/d4/msgbox_8c.html#a17">MessageBoxWorker</a>(&amp;MsgBoxParams);
00480 }
00481 
00482 <span class="comment">/***************************************************************************\</span>
00483 <span class="comment">* MessageBoxWorker (API)</span>
00484 <span class="comment">*</span>
00485 <span class="comment">* History:</span>
00486 <span class="comment">* 03-10-93 JohnL      Created</span>
00487 <span class="comment">\***************************************************************************/</span>
00488 
<a name="l00489"></a><a class="code" href="../../d6/d4/msgbox_8c.html#a17">00489</a> <span class="keywordtype">int</span> <a class="code" href="../../d6/d4/msgbox_8c.html#a17">MessageBoxWorker</a>(
00490     <a class="code" href="../../d7/d9/struct__MSGBOXDATA.html">LPMSGBOXDATA</a> pMsgBoxParams)
00491 {
00492     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>  dwStyle = pMsgBoxParams-&gt;dwStyle;
00493     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>   wBtnCnt;
00494     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>   wDefButton;
00495     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>   i;
00496     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>   wBtnBeg;
00497     WCHAR  szErrorBuf[64];
00498     LPWSTR apstrButton[4];
00499     <span class="keywordtype">int</span>    aidButton[4];
00500     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>   fCancel = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00501     <span class="keywordtype">int</span>    retValue;
00502     <a class="code" href="../../d7/d0/structtagMBSTRING.html">MBSTRING</a>* pMBString;
00503 
00504 <span class="preprocessor">#if DBG</span>
00505 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (dwStyle &amp; ~MB_VALID) {
00506         RIPMSG2(RIP_WARNING, <span class="stringliteral">"MessageBoxWorker: Invalid flags, %#lx &amp; ~%#lx != 0"</span>,
00507               dwStyle, MB_VALID);
00508     }
00509 <span class="preprocessor">#endif</span>
00510 <span class="preprocessor"></span>
00511 <span class="preprocessor">#ifdef _JANUS_</span>
00512 <span class="preprocessor"></span>    <span class="comment">/*</span>
00513 <span class="comment">     * Error message instrument start here</span>
00514 <span class="comment">     * Check EMI enable</span>
00515 <span class="comment">     */</span>
00516 
00517     <span class="keywordflow">if</span> (gfEMIEnable) {
00518         <span class="keywordflow">if</span> (!ErrorMessageInst(pMsgBoxParams))
00519             RIPMSG0(RIP_WARNING, <span class="stringliteral">"MessageBoxWorker: Fail to instrument error msg"</span>);
00520     };
00521 
00522     <span class="comment">/*</span>
00523 <span class="comment">     * Default Message Return: on unattended systems the default button</span>
00524 <span class="comment">     * can be returned automatically without putting up the message box</span>
00525 <span class="comment">     */</span>
00526 
00527     <span class="keywordflow">if</span> (gfDMREnable) {
00528         <span class="comment">/*</span>
00529 <span class="comment">         * validate the style and default button as in the main code path</span>
00530 <span class="comment">         */</span>
00531 
00532         <span class="comment">/*</span>
00533 <span class="comment">         * Validate the "type" of message box requested.</span>
00534 <span class="comment">         */</span>
00535         <span class="keywordflow">if</span> ((dwStyle &amp; MB_TYPEMASK) &gt; MB_LASTVALIDTYPE) {
00536             RIPERR0(ERROR_INVALID_MSGBOX_STYLE, RIP_VERBOSE, <span class="stringliteral">""</span>);
00537             <span class="keywordflow">return</span> 0;
00538         }
00539 
00540         wBtnCnt = <a class="code" href="../../d1/d8/clglobal_8c.html#a18">mpTypeCcmd</a>[dwStyle &amp; MB_TYPEMASK] +
00541                                 ((dwStyle &amp; MB_HELP) ? 1 : 0);
00542 
00543         <span class="comment">/*</span>
00544 <span class="comment">         * Set the default button value</span>
00545 <span class="comment">         */</span>
00546         wDefButton = (dwStyle &amp; (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)MB_DEFMASK) / (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)(MB_DEFMASK &amp; (MB_DEFMASK &gt;&gt; 3));
00547 
00548         <span class="keywordflow">if</span> (wDefButton &gt;= wBtnCnt)   <span class="comment">/* Check if valid */</span>
00549             wDefButton = 0;          <span class="comment">/* Set the first button if error */</span>
00550 
00551         <span class="comment">/*</span>
00552 <span class="comment">         * return the default button</span>
00553 <span class="comment">         */</span>
00554         <span class="keywordflow">return</span> aidButton[ wDefButton ];
00555     }
00556 <span class="preprocessor">#endif // _JANUS_</span>
00557 <span class="preprocessor"></span>
00558     <span class="comment">/*</span>
00559 <span class="comment">     * If lpszCaption is NULL, then use "Error!" string as the caption</span>
00560 <span class="comment">     * string.</span>
00561 <span class="comment">     * LATER: IanJa localize according to wLanguageId</span>
00562 <span class="comment">     */</span>
00563     <span class="keywordflow">if</span> (pMsgBoxParams-&gt;lpszCaption == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00564         <span class="comment">/*</span>
00565 <span class="comment">         * Load the default error string if we haven't done it yet</span>
00566 <span class="comment">         */</span>
00567         <span class="keywordflow">if</span> (*<a class="code" href="../../d6/d4/msgbox_8c.html#a8">szERROR</a> == 0) {
00568             <a class="code" href="../../d4/d9/clres_8c.html#a42">LoadStringW</a>(<a class="code" href="../../d1/d8/clglobal_8c.html#a6">hmodUser</a>, <a class="code" href="../../d6/d0/usercli_8h.html#a157">STR_ERROR</a>, <a class="code" href="../../d6/d4/msgbox_8c.html#a8">szERROR</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a2">ARRAY_SIZE</a>(<a class="code" href="../../d6/d4/msgbox_8c.html#a8">szERROR</a>));
00569         }
00570         <span class="keywordflow">if</span> (pMsgBoxParams-&gt;<a class="code" href="../../d7/d9/struct__MSGBOXDATA.html#o2">wLanguageId</a> == 0) {
00571             pMsgBoxParams-&gt;lpszCaption = <a class="code" href="../../d6/d4/msgbox_8c.html#a8">szERROR</a>;
00572         } <span class="keywordflow">else</span> {
00573             <a class="code" href="../../d6/d0/usercli_8h.html#a427">LoadStringOrError</a>(<a class="code" href="../../d1/d8/clglobal_8c.html#a6">hmodUser</a>,
00574                                  <a class="code" href="../../d6/d0/usercli_8h.html#a157">STR_ERROR</a>,
00575                                  szErrorBuf,
00576                                  <span class="keyword">sizeof</span>(szErrorBuf)/<span class="keyword">sizeof</span>(WCHAR),
00577                                  pMsgBoxParams-&gt;<a class="code" href="../../d7/d9/struct__MSGBOXDATA.html#o2">wLanguageId</a>);
00578 
00579             <span class="comment">/*</span>
00580 <span class="comment">             *  If it didn't find the string, use the default language</span>
00581 <span class="comment">             */</span>
00582             <span class="keywordflow">if</span> (*szErrorBuf) {
00583                pMsgBoxParams-&gt;lpszCaption = szErrorBuf;
00584             } <span class="keywordflow">else</span> {
00585                pMsgBoxParams-&gt;lpszCaption = <a class="code" href="../../d6/d4/msgbox_8c.html#a8">szERROR</a>;
00586 
00587                RIPMSG1(RIP_WARNING, <span class="stringliteral">"MessageBoxWorker: STR_ERROR string resource for language %#lx not found"</span>,
00588                       pMsgBoxParams-&gt;<a class="code" href="../../d7/d9/struct__MSGBOXDATA.html#o2">wLanguageId</a>);
00589             }
00590         }
00591     }
00592 
00593     <span class="comment">/*</span>
00594 <span class="comment">     * MB_SERVICE_NOTIFICATION had to be redefined because</span>
00595 <span class="comment">     * Win95 defined MB_TOPMOST using the same value.</span>
00596 <span class="comment">     * So for old apps, we map it to the new value</span>
00597 <span class="comment">     */</span>
00598 
00599     <span class="keywordflow">if</span>((dwStyle &amp; MB_TOPMOST) &amp;&amp; (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a16">GetClientInfo</a>()-&gt;dwExpWinVer &lt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a101">VER40</a>)) {
00600         dwStyle &amp;= ~MB_TOPMOST;
00601         dwStyle |= MB_SERVICE_NOTIFICATION;
00602         pMsgBoxParams-&gt;dwStyle = dwStyle;
00603 
00604         RIPMSG1(RIP_WARNING, <span class="stringliteral">"MessageBoxWorker: MB_SERVICE_NOTIFICATION flag mapped. New dwStyle:%#lx"</span>, dwStyle);
00605     }
00606 
00607     <span class="comment">/*</span>
00608 <span class="comment">     * For backward compatiblity, use MB_SERVICE_NOTIFICATION if</span>
00609 <span class="comment">     * it's going to the default desktop.</span>
00610 <span class="comment">     */</span>
00611     <span class="keywordflow">if</span> (dwStyle &amp; (MB_DEFAULT_DESKTOP_ONLY | MB_SERVICE_NOTIFICATION)) {
00612 
00613         <span class="comment">/*</span>
00614 <span class="comment">         * Allow services to put up popups without getting</span>
00615 <span class="comment">         * access to the current desktop.</span>
00616 <span class="comment">         */</span>
00617         <span class="keywordflow">if</span> (pMsgBoxParams-&gt;hwndOwner != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00618             RIPERR0(ERROR_INVALID_PARAMETER, RIP_VERBOSE, <span class="stringliteral">""</span>);
00619             <span class="keywordflow">return</span> 0;
00620         }
00621 
00622         <span class="keywordflow">return</span> <a class="code" href="../../d6/d4/msgbox_8c.html#a21">ServiceMessageBox</a>(pMsgBoxParams-&gt;lpszText,
00623                                  pMsgBoxParams-&gt;lpszCaption,
00624                                  dwStyle &amp; ~MB_SERVICE_NOTIFICATION);
00625     }
00626 
00627     <span class="comment">/*</span>
00628 <span class="comment">     * Make sure we have a valid window handle.</span>
00629 <span class="comment">     */</span>
00630     <span class="keywordflow">if</span> (pMsgBoxParams-&gt;hwndOwner &amp;&amp; !<a class="code" href="../../d3/d9/client_2wow_8c.html#a11">IsWindow</a>(pMsgBoxParams-&gt;hwndOwner)) {
00631         RIPERR0(ERROR_INVALID_WINDOW_HANDLE, RIP_VERBOSE, <span class="stringliteral">""</span>);
00632         <span class="keywordflow">return</span> 0;
00633     }
00634 
00635     <span class="comment">/*</span>
00636 <span class="comment">     * Validate the "type" of message box requested.</span>
00637 <span class="comment">     */</span>
00638     <span class="keywordflow">if</span> ((dwStyle &amp; MB_TYPEMASK) &gt; MB_LASTVALIDTYPE) {
00639         RIPERR0(ERROR_INVALID_MSGBOX_STYLE, RIP_VERBOSE, <span class="stringliteral">""</span>);
00640         <span class="keywordflow">return</span> 0;
00641     }
00642 
00643     wBtnCnt = <a class="code" href="../../d1/d8/clglobal_8c.html#a18">mpTypeCcmd</a>[dwStyle &amp; MB_TYPEMASK] +
00644                             ((dwStyle &amp; MB_HELP) ? 1 : 0);
00645 
00646     <span class="comment">/*</span>
00647 <span class="comment">     * Set the default button value</span>
00648 <span class="comment">     */</span>
00649     wDefButton = (dwStyle &amp; (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)MB_DEFMASK) / (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)(MB_DEFMASK &amp; (MB_DEFMASK &gt;&gt; 3));
00650 
00651     <span class="keywordflow">if</span> (wDefButton &gt;= wBtnCnt)   <span class="comment">/* Check if valid */</span>
00652         wDefButton = 0;          <span class="comment">/* Set the first button if error */</span>
00653 
00654     <span class="comment">/*</span>
00655 <span class="comment">     * Calculate the strings to use in the message box</span>
00656 <span class="comment">     */</span>
00657     wBtnBeg = <a class="code" href="../../d1/d8/clglobal_8c.html#a19">mpTypeIich</a>[dwStyle &amp; (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)MB_TYPEMASK];
00658     <span class="keywordflow">for</span> (i=0; i&lt;wBtnCnt; i++) {
00659 
00660         pMBString = &amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o38">MBStrings</a>[<a class="code" href="../../d1/d8/clglobal_8c.html#a20">SEBbuttons</a>[wBtnBeg + i]];
00661         <span class="comment">/*</span>
00662 <span class="comment">         * Pick up the string for the button.</span>
00663 <span class="comment">         */</span>
00664         <span class="keywordflow">if</span> (pMsgBoxParams-&gt;<a class="code" href="../../d7/d9/struct__MSGBOXDATA.html#o2">wLanguageId</a> == 0) {
00665             apstrButton[i] = pMBString-&gt;<a class="code" href="../../d7/d0/structtagMBSTRING.html#o0">szName</a>;
00666         } <span class="keywordflow">else</span> {
00667             WCHAR szButtonBuf[64];
00668             <span class="comment">// LATER is it possible to have button text greater than 64 chars</span>
00669 
00670            <span class="comment">/*</span>
00671 <span class="comment">            *  BUG: gpsi-&gt;wMaxBtnSize might be too short for the length of this string...</span>
00672 <span class="comment">            */</span>
00673             <a class="code" href="../../d6/d0/usercli_8h.html#a427">LoadStringOrError</a>(<a class="code" href="../../d1/d8/clglobal_8c.html#a6">hmodUser</a>,
00674                     pMBString-&gt;<a class="code" href="../../d7/d0/structtagMBSTRING.html#o2">uStr</a>,
00675                     szButtonBuf,
00676                     <span class="keyword">sizeof</span>(szButtonBuf)/<span class="keyword">sizeof</span>(WCHAR),
00677                     pMsgBoxParams-&gt;<a class="code" href="../../d7/d9/struct__MSGBOXDATA.html#o2">wLanguageId</a>);
00678 
00679             <span class="comment">/*</span>
00680 <span class="comment">             *  If it didn't find the string, use the default language.</span>
00681 <span class="comment">             */</span>
00682             <span class="keywordflow">if</span> (*szButtonBuf) {
00683                apstrButton[i] = <a class="code" href="../../d1/d0/inc_2user_8h.html#a1222">TextAlloc</a>(szButtonBuf);
00684             } <span class="keywordflow">else</span> {
00685                apstrButton[i] = <a class="code" href="../../d1/d0/inc_2user_8h.html#a1222">TextAlloc</a>(pMBString-&gt;<a class="code" href="../../d7/d0/structtagMBSTRING.html#o0">szName</a>);
00686 
00687                RIPMSG2(RIP_WARNING, <span class="stringliteral">"MessageBoxWorker: string resource %#lx for language %#lx not found"</span>,
00688                       pMBString-&gt;<a class="code" href="../../d7/d0/structtagMBSTRING.html#o2">uStr</a>,
00689                       pMsgBoxParams-&gt;<a class="code" href="../../d7/d9/struct__MSGBOXDATA.html#o2">wLanguageId</a>);
00690             }
00691         }
00692         aidButton[i] = pMBString-&gt;<a class="code" href="../../d7/d0/structtagMBSTRING.html#o1">uID</a>;
00693         <span class="keywordflow">if</span> (aidButton[i] == IDCANCEL) {
00694             fCancel = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00695         }
00696     }
00697 
00698     <span class="comment">/*</span>
00699 <span class="comment">     * Hackery: There are some apps that use MessageBox as initial error</span>
00700 <span class="comment">     * indicators, such as mplay32, and we want this messagebox to be</span>
00701 <span class="comment">     * visible regardless of waht was specified in the StartupInfo-&gt;wShowWindow</span>
00702 <span class="comment">     * field.  ccMail for instance starts all of its embedded objects hidden</span>
00703 <span class="comment">     * but on win 3.1 the error message would show because they don't have</span>
00704 <span class="comment">     * the startup info.</span>
00705 <span class="comment">     */</span>
00706     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a283">NtUserModifyUserStartupInfoFlags</a>(STARTF_USESHOWWINDOW, 0);
00707 
00708     pMsgBoxParams-&gt;<a class="code" href="../../d7/d9/struct__MSGBOXDATA.html#o3">pidButton</a>      = aidButton;
00709     pMsgBoxParams-&gt;<a class="code" href="../../d7/d9/struct__MSGBOXDATA.html#o4">ppszButtonText</a> = apstrButton;
00710     pMsgBoxParams-&gt;<a class="code" href="../../d7/d9/struct__MSGBOXDATA.html#o6">DefButton</a>      = wDefButton;
00711     pMsgBoxParams-&gt;<a class="code" href="../../d7/d9/struct__MSGBOXDATA.html#o5">cButtons</a>       = wBtnCnt;
00712     pMsgBoxParams-&gt;<a class="code" href="../../d7/d9/struct__MSGBOXDATA.html#o7">CancelId</a>      = ((dwStyle &amp; MB_TYPEMASK) == 0) ? IDOK : (fCancel ? IDCANCEL : 0);
00713     retValue = <a class="code" href="../../d1/d0/inc_2user_8h.html#a1145">SoftModalMessageBox</a>(pMsgBoxParams);
00714 
00715     <span class="keywordflow">if</span> (pMsgBoxParams-&gt;<a class="code" href="../../d7/d9/struct__MSGBOXDATA.html#o2">wLanguageId</a> != 0) {
00716         <span class="keywordflow">for</span> (i=0; i&lt;wBtnCnt; i++)
00717            <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(apstrButton[i]);
00718     }
00719 
00720     <span class="keywordflow">return</span> retValue;
00721 }
00722 
<a name="l00723"></a><a class="code" href="../../d6/d4/msgbox_8c.html#a6">00723</a> <span class="preprocessor">#define MAX_RES_STRING  256</span>
00724 <span class="preprocessor"></span>
00725 <span class="comment">/***************************************************************************\</span>
00726 <span class="comment">*</span>
00727 <span class="comment">*  SoftModalMessageBox()</span>
00728 <span class="comment">*</span>
00729 <span class="comment">\***************************************************************************/</span>
<a name="l00730"></a><a class="code" href="../../d1/d0/inc_2user_8h.html#a1145">00730</a> <span class="keywordtype">int</span>  <a class="code" href="../../d1/d0/inc_2user_8h.html#a1145">SoftModalMessageBox</a>(<a class="code" href="../../d7/d9/struct__MSGBOXDATA.html">LPMSGBOXDATA</a> lpmb) {
00731     LPBYTE              lpDlgTmp;
00732     <span class="keywordtype">int</span>                 cyIcon, cxIcon;
00733     <span class="keywordtype">int</span>                 cxButtons;
00734     <span class="keywordtype">int</span>                 cxMBMax;
00735     <span class="keywordtype">int</span>                 cxText, cyText, xText;
00736     <span class="keywordtype">int</span>                 cxBox, cyBox;
00737     <span class="keywordtype">int</span>                 cxFoo, cxCaption;
00738     <span class="keywordtype">int</span>                 xMB, yMB;
00739     HDC                 hdc;
00740     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>               wIconOrdNum;
00741     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>               wCaptionLen;
00742     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>               wTextLen;
00743     WORD                OrdNum[2];  <span class="comment">// Must be an array or WORDs</span>
00744     RECT                rc;
00745     RECT                rcWork;
00746     HCURSOR             hcurOld;
00747     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>               dwStyleMsg, dwStyleText;
00748     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>               dwExStyleMsg = 0;
00749     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>               dwStyleDlg;
00750     HWND                hwndOwner;
00751     LPWSTR              lpsz;
00752     <span class="keywordtype">int</span>                 iRetVal     = 0;
00753     HICON               hIcon;
00754     HGLOBAL             hTemplate   = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00755     HGLOBAL             hCaption    = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00756     HGLOBAL             hText       = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00757     HINSTANCE           hInstMsg    = lpmb-&gt;hInstance;
00758     SIZE                size;
00759     HFONT               hFontOld    = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00760     <span class="keywordtype">int</span>                 cntMBox;
00761     <a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a>            pMonitor;
00762 
00763     <a class="code" href="../../d1/d0/inc_2user_8h.html#a848">ConnectIfNecessary</a>();
00764 
00765     dwStyleMsg = lpmb-&gt;dwStyle;
00766 
00767     <span class="comment">//</span>
00768     <span class="comment">// This code is disabled since Mirroring will take care of this.</span>
00769     <span class="comment">//</span>
00770 <span class="preprocessor">#ifndef USE_MIRRORING</span>
00771 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (dwStyleMsg &amp; MB_RTLREADING) {
00772         dwExStyleMsg |= WS_EX_RTLREADING;
00773     }
00774 <span class="preprocessor">#endif</span>
00775 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (dwStyleMsg &amp; MB_RIGHT) {
00776         dwExStyleMsg |= WS_EX_RIGHT;
00777     }
00778 
00779     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a98">IS_PTR</a>(lpmb-&gt;lpszCaption)) {
00780 
00781         <span class="comment">// won't ever be NULL because MessageBox sticks "Error!" in in that case</span>
00782         <span class="keywordflow">if</span> (hInstMsg &amp;&amp; (hCaption = LocalAlloc(LPTR, <a class="code" href="../../d6/d4/msgbox_8c.html#a6">MAX_RES_STRING</a> * <span class="keyword">sizeof</span>(WCHAR)))) {
00783             lpsz = (LPWSTR) hCaption;
00784             LoadString(hInstMsg, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a99">PTR_TO_ID</a>(lpmb-&gt;lpszCaption), lpsz, <a class="code" href="../../d6/d4/msgbox_8c.html#a6">MAX_RES_STRING</a>);
00785         } <span class="keywordflow">else</span>
00786             lpsz = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00787 
00788         lpmb-&gt;lpszCaption = lpsz ? lpsz : <a class="code" href="../../d6/d4/msgbox_8c.html#a7">szEmpty</a>;
00789     }
00790 
00791     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a98">IS_PTR</a>(lpmb-&gt;lpszText)) {
00792         <span class="comment">// NULL not allowed</span>
00793         <span class="keywordflow">if</span> (hInstMsg &amp;&amp; (hText = LocalAlloc(LPTR, <a class="code" href="../../d6/d4/msgbox_8c.html#a6">MAX_RES_STRING</a> * <span class="keyword">sizeof</span>(WCHAR)))) {
00794             lpsz = (LPWSTR) hText;
00795             LoadString(hInstMsg, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a99">PTR_TO_ID</a>(lpmb-&gt;lpszText), lpsz, <a class="code" href="../../d6/d4/msgbox_8c.html#a6">MAX_RES_STRING</a>);
00796         } <span class="keywordflow">else</span>
00797             lpsz = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00798 
00799         lpmb-&gt;lpszText = lpsz ? lpsz : <a class="code" href="../../d6/d4/msgbox_8c.html#a7">szEmpty</a>;
00800     }
00801 
00802 <span class="preprocessor">#ifdef USE_MIRRORING</span>
00803 <span class="preprocessor"></span>    <span class="comment">//</span>
00804     <span class="comment">// Mirroring of MessageBox'es is only enabled if :-</span>
00805     <span class="comment">//</span>
00806     <span class="comment">// * MB_RTLREADING style has been specified in the MessageBox styles OR</span>
00807     <span class="comment">// * The first two code points of the MessageBox text are Right-To-Left</span>
00808     <span class="comment">//   marks (RLMs = U+200f).</span>
00809     <span class="comment">// The feature of enable RTL mirroring if two consecutive RLMs are found</span>
00810     <span class="comment">// in the MB text is to acheive a no-code-change for localization of</span>
00811     <span class="comment">// of MessageBoxes for BiDi Apps.  [samera]</span>
00812     <span class="comment">//</span>
00813     <span class="keywordflow">if</span> ((dwStyleMsg &amp; MB_RTLREADING) ||
00814             (lpmb-&gt;lpszText != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; (lpmb-&gt;lpszText[0] == <a class="code" href="../../d6/d0/usercli_8h.html#a259">UNICODE_RLM</a>) &amp;&amp;
00815             (lpmb-&gt;lpszText[1] == <a class="code" href="../../d6/d0/usercli_8h.html#a259">UNICODE_RLM</a>))) {
00816         <span class="comment">//</span>
00817         <span class="comment">// Set Mirroring so that MessageBox and its child controls</span>
00818         <span class="comment">// get mirrored. Otherwise, the message box and its child controls</span>
00819         <span class="comment">// are Left-To-Right.</span>
00820         <span class="comment">//</span>
00821         dwExStyleMsg |= WS_EX_LAYOUTRTL;
00822 
00823         <span class="comment">//</span>
00824         <span class="comment">// And turn off any conflicting flags.</span>
00825         <span class="comment">//</span>
00826         dwExStyleMsg &amp;= ~WS_EX_RIGHT;
00827         <span class="keywordflow">if</span> (dwStyleMsg &amp; MB_RTLREADING) {
00828             dwStyleMsg &amp;= ~MB_RTLREADING;
00829             dwStyleMsg ^= MB_RIGHT;
00830         }
00831     }
00832 <span class="preprocessor">#endif</span>
00833 <span class="preprocessor"></span>
00834 
00835     <span class="keywordflow">if</span> ((dwStyleMsg &amp; MB_ICONMASK) == MB_USERICON)
00836         hIcon = LoadIcon(hInstMsg, lpmb-&gt;lpszIcon);
00837     <span class="keywordflow">else</span>
00838         hIcon = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00839 
00840     <span class="comment">// For compatibility reasons, we still allow the message box to come up.</span>
00841     hwndOwner = lpmb-&gt;hwndOwner;
00842 
00843     <span class="comment">// For PowerBuilder4.0, we must make their messageboxes owned popups. Or, else</span>
00844     <span class="comment">// they get WM_ACTIVATEAPP and they install multiple keyboard hooks and get into</span>
00845     <span class="comment">// infinite loop later.</span>
00846     <span class="comment">// Bug #15896 -- WIN95B -- 2/17/95 -- SANKAR --</span>
00847     <span class="keywordflow">if</span>(!hwndOwner)
00848       {
00849         WCHAR pwszLibFileName[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
00850         <span class="keyword">static</span> WCHAR szPB040[] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"PB040"</span>;  <span class="comment">// Module name of PowerBuilder4.0</span>
00851         WCHAR *pw1;
00852 
00853         <span class="comment">//Is this a win3.1 or older app?</span>
00854         <span class="keywordflow">if</span>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a16">GetClientInfo</a>()-&gt;dwExpWinVer &lt;= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a102">VER31</a>)
00855           {
00856             <span class="keywordflow">if</span> (GetModuleFileName(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, pwszLibFileName, <span class="keyword">sizeof</span>(pwszLibFileName)/<span class="keyword">sizeof</span>(WCHAR)) == 0) <span class="keywordflow">goto</span> getthedc;
00857             pw1 = pwszLibFileName + wcslen(pwszLibFileName) - 1;
00858             <span class="keywordflow">while</span> (pw1 &gt; pwszLibFileName) {
00859                 <span class="keywordflow">if</span> (*pw1 == TEXT(<span class="charliteral">'.'</span>)) *pw1-- = 0;
00860                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*pw1 == TEXT(<span class="charliteral">':'</span>)) {pw1++; <span class="keywordflow">break</span>;}
00861                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*pw1 == TEXT(<span class="charliteral">'\\'</span>)) {pw1++; <span class="keywordflow">break</span>;}
00862                 <span class="keywordflow">else</span> pw1--;
00863             }
00864             <span class="comment">// Is this the PowerBuilder 4.0 module?</span>
00865             <span class="keywordflow">if</span>(!_wcsicmp(pw1, szPB040))
00866                 hwndOwner = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a199">NtUserGetForegroundWindow</a>(); <span class="comment">// Make the MsgBox owned.</span>
00867           }
00868       }
00869 getthedc:
00870     <span class="comment">// Check if we're out of cache DCs until robustness...</span>
00871     <span class="keywordflow">if</span> (!(hdc = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a251">NtUserGetDCEx</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, DCX_WINDOW | DCX_CACHE))) {
00872 
00873         <span class="comment">/*</span>
00874 <span class="comment">         * The above call might fail for TIF_RESTRICTED processes</span>
00875 <span class="comment">         * so check for the DC from the owner window</span>
00876 <span class="comment">         */</span>
00877         <span class="keywordflow">if</span> (!(hdc = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a251">NtUserGetDCEx</a>(hwndOwner, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, DCX_WINDOW | DCX_CACHE)))
00878             <span class="keywordflow">goto</span> SMB_Exit;
00879     }
00880 
00881     <span class="comment">// Figure out the types and dimensions of buttons</span>
00882 
00883     cxButtons = (lpmb-&gt;<a class="code" href="../../d7/d9/struct__MSGBOXDATA.html#o5">cButtons</a> * <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o16">wMaxBtnSize</a>) + ((lpmb-&gt;<a class="code" href="../../d7/d9/struct__MSGBOXDATA.html#o5">cButtons</a> - 1) * <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a852">XPixFromXDU</a>(<a class="code" href="../../d6/d4/msgbox_8c.html#a2">DU_BTNGAP</a>, <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;cxMsgFontChar));
00884 
00885     <span class="comment">// Ditto for the icon, if there is one.  If not, cxIcon &amp; cyIcon are 0.</span>
00886 
00887     <span class="keywordflow">if</span> (wIconOrdNum = <a class="code" href="../../d6/d4/msgbox_8c.html#a14">MB_GetIconOrdNum</a>(dwStyleMsg)) {
00888         cxIcon = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXICON) + <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a852">XPixFromXDU</a>(<a class="code" href="../../d6/d4/msgbox_8c.html#a1">DU_INNERMARGIN</a>, <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;cxMsgFontChar);
00889         cyIcon = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYICON);
00890     } <span class="keywordflow">else</span>
00891         cxIcon = cyIcon = 0;
00892 
00893     hFontOld = SelectObject(hdc, <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;hCaptionFont);
00894 
00895     <span class="comment">// Find the max between the caption text and the buttons</span>
00896     wCaptionLen = wcslen(lpmb-&gt;lpszCaption);
00897     GetTextExtentPoint(hdc, lpmb-&gt;lpszCaption, wCaptionLen, &amp;size);
00898     cxCaption = size.cx + 2*<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXSIZE);
00899 
00900     <span class="comment">//</span>
00901     <span class="comment">// The max width of the message box is 5/8 of the work area for most</span>
00902     <span class="comment">// countries.  We will then try 6/8 and 7/8 if it won't fit.  Then</span>
00903     <span class="comment">// we will use whole screen.</span>
00904     <span class="comment">//</span>
00905     pMonitor = <a class="code" href="../../d6/d0/usercli_8h.html#a762">GetDialogMonitor</a>(hwndOwner, MONITOR_DEFAULTTOPRIMARY);
00906     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;rcWork, &amp;pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>);
00907     cxMBMax = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a141">MultDiv</a>(rcWork.right - rcWork.left, 5, 8);
00908 
00909     cxFoo = 2*<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a852">XPixFromXDU</a>(<a class="code" href="../../d6/d4/msgbox_8c.html#a0">DU_OUTERMARGIN</a>, <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;cxMsgFontChar);
00910 
00911     SelectObject(hdc, <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;hMsgFont);
00912 
00913     <span class="comment">//</span>
00914     <span class="comment">// If the text doesn't fit in 5/8, try 7/8 of the screen</span>
00915     <span class="comment">//</span>
00916 ReSize:
00917     <span class="comment">//</span>
00918     <span class="comment">// The message box is as big as needed to hold the caption/text/buttons,</span>
00919     <span class="comment">// but not bigger than the maximum width.</span>
00920     <span class="comment">//</span>
00921 
00922     cxBox = cxMBMax - 2*<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXFIXEDFRAME);
00923 
00924     <span class="comment">// Ask DrawText for the right cx and cy</span>
00925     rc.left     = 0;
00926     rc.top      = 0;
00927     rc.right    = cxBox - cxFoo - cxIcon;
00928     rc.bottom   = rcWork.bottom - rcWork.top;
00929     cyText = <a class="code" href="../../d5/d2/rtl_2drawtext_8c.html#a51">DrawTextExW</a>(hdc, (LPWSTR)lpmb-&gt;lpszText, -1, &amp;rc,
00930                 DT_CALCRECT | DT_WORDBREAK | DT_EXPANDTABS |
00931                 DT_NOPREFIX | DT_EXTERNALLEADING | DT_EDITCONTROL, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00932     <span class="comment">//</span>
00933     <span class="comment">// Make sure we have enough width to hold the buttons, in addition to</span>
00934     <span class="comment">// the icon+text.  Always force the buttons.  If they don't fit, it's</span>
00935     <span class="comment">// because the working area is small.</span>
00936     <span class="comment">//</span>
00937     <span class="comment">//</span>
00938     <span class="comment">// The buttons are centered underneath the icon/text.</span>
00939     <span class="comment">//</span>
00940     cxText = rc.right - rc.left + cxIcon + cxFoo;
00941     cxBox = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(cxBox, <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(cxText, cxCaption));
00942     cxBox = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(cxBox, cxButtons + cxFoo);
00943     cxText = cxBox - cxFoo - cxIcon;
00944 
00945     <span class="comment">//</span>
00946     <span class="comment">// Now we know the text width for sure.  Really calculate how high the</span>
00947     <span class="comment">// text will be.</span>
00948     <span class="comment">//</span>
00949     rc.left     = 0;
00950     rc.top      = 0;
00951     rc.right    = cxText;
00952     rc.bottom   = rcWork.bottom - rcWork.top;
00953     cyText      = <a class="code" href="../../d5/d2/rtl_2drawtext_8c.html#a51">DrawTextExW</a>(hdc, (LPWSTR)lpmb-&gt;lpszText, -1, &amp;rc, DT_CALCRECT | DT_WORDBREAK
00954         | DT_EXPANDTABS | DT_NOPREFIX | DT_EXTERNALLEADING | DT_EDITCONTROL, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00955 
00956     <span class="comment">// Find the window size.</span>
00957     cxBox += 2*<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXFIXEDFRAME);
00958     cyBox = 2*<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYFIXEDFRAME) + <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYCAPTION) + <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a853">YPixFromYDU</a>(2*<a class="code" href="../../d6/d4/msgbox_8c.html#a0">DU_OUTERMARGIN</a> +
00959         <a class="code" href="../../d6/d4/msgbox_8c.html#a1">DU_INNERMARGIN</a> + <a class="code" href="../../d6/d4/msgbox_8c.html#a3">DU_BTNHEIGHT</a>, <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;cyMsgFontChar);
00960 
00961     cyBox += <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(cyIcon, cyText);
00962 
00963     <span class="comment">//</span>
00964     <span class="comment">// If the message box doesn't fit on the working area, we'll try wider</span>
00965     <span class="comment">// sizes successively:  6/8 of work then 7/8 of screen.</span>
00966     <span class="comment">//</span>
00967     <span class="keywordflow">if</span> (cyBox &gt; rcWork.bottom - rcWork.top)
00968     {
00969         <span class="keywordtype">int</span> cxTemp;
00970 
00971         cxTemp = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a141">MultDiv</a>(rcWork.right - rcWork.left, 6, 8);
00972 
00973         <span class="keywordflow">if</span> (cxMBMax == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a141">MultDiv</a>(rcWork.right - rcWork.left, 5, 8))
00974         {
00975             cxMBMax = cxTemp;
00976             <span class="keywordflow">goto</span> ReSize;
00977         }
00978         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cxMBMax == cxTemp)
00979         {
00980             <span class="comment">// then let's try with rcMonitor</span>
00981             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;rcWork, &amp;pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>);
00982             cxMBMax = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a141">MultDiv</a>(rcWork.right - rcWork.left, 7, 8);
00983             <span class="keywordflow">goto</span> ReSize;
00984         }
00985     }
00986 
00987     <span class="keywordflow">if</span> (hFontOld)
00988         SelectFont(hdc, hFontOld);
00989     <a class="code" href="../../d6/d0/usercli_8h.html#a211">NtUserReleaseDC</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, hdc);
00990 
00991     <span class="comment">// Find the window position</span>
00992     cntMBox = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a16">GetClientInfo</a>()-&gt;pDeskInfo-&gt;cntMBox;
00993 
00994     xMB = (rcWork.left + rcWork.right - cxBox) / 2 + (cntMBox * <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXSIZE));
00995     xMB = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(xMB, rcWork.left);
00996     yMB = (rcWork.top + rcWork.bottom - cyBox) / 2 + (cntMBox * <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYSIZE));
00997     yMB = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(yMB, rcWork.top);
00998 
00999     <span class="comment">// Bottom, right justify if we're going off the screen--but leave a</span>
01000     <span class="comment">// little gap</span>
01001 
01002     <span class="keywordflow">if</span> (xMB + cxBox &gt; rcWork.right)
01003         xMB = rcWork.right - <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXEDGE) - cxBox;
01004 
01005     <span class="comment">//</span>
01006     <span class="comment">// Pin to the working area.  If it won't fit, then pin to the screen</span>
01007     <span class="comment">// height.  Bottom justify it at least if too big even for that, so</span>
01008     <span class="comment">// that the buttons are visible.</span>
01009     <span class="comment">//</span>
01010     <span class="keywordflow">if</span> (yMB + cyBox &gt; rcWork.bottom) {
01011         yMB = rcWork.bottom - <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYEDGE) - cyBox;
01012         <span class="keywordflow">if</span> (yMB &lt; rcWork.top) {
01013             yMB = pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.bottom - <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYEDGE) - cyBox;
01014         }
01015     }
01016 
01017     wTextLen = wcslen(lpmb-&gt;lpszText);
01018 
01019     <span class="comment">// Find out the memory required for the Dlg template and try to alloc it</span>
01020     hTemplate = LocalAlloc(<a class="code" href="../../d2/d3/ldrsnap_8c.html#a22">LMEM_ZEROINIT</a>, <a class="code" href="../../d6/d4/msgbox_8c.html#a16">MB_FindDlgTemplateSize</a>(lpmb));
01021 
01022     <span class="keywordflow">if</span> (!hTemplate)
01023         <span class="keywordflow">goto</span> SMB_Exit;
01024 
01025     lpDlgTmp = (LPBYTE) hTemplate;
01026 
01027     <span class="comment">//</span>
01028     <span class="comment">// Setup the dialog style for the message box</span>
01029     <span class="comment">//</span>
01030     dwStyleDlg = WS_POPUPWINDOW | WS_CAPTION | DS_ABSALIGN | DS_NOIDLEMSG |
01031                  DS_SETFONT | DS_3DLOOK;
01032 
01033     <span class="keywordflow">if</span> ((dwStyleMsg &amp; MB_MODEMASK) == MB_SYSTEMMODAL)
01034         dwStyleDlg |= DS_SYSMODAL | DS_SETFOREGROUND;
01035     <span class="keywordflow">else</span>
01036         dwStyleDlg |= DS_MODALFRAME | WS_SYSMENU;
01037 
01038     <span class="keywordflow">if</span> (dwStyleMsg &amp; MB_SETFOREGROUND)
01039         dwStyleDlg |= DS_SETFOREGROUND;
01040 
01041     <span class="comment">// Add the Header of the Dlg Template</span>
01042     <span class="comment">// BOGUS !!!  don't ADD bools</span>
01043     lpDlgTmp = <a class="code" href="../../d6/d4/msgbox_8c.html#a12">MB_UpdateDlgHdr</a>((LPDLGTEMPLATE) lpDlgTmp, dwStyleDlg, dwExStyleMsg,
01044         (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>) (lpmb-&gt;<a class="code" href="../../d7/d9/struct__MSGBOXDATA.html#o5">cButtons</a> + (wIconOrdNum != 0) + (lpmb-&gt;lpszText != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)),
01045         xMB, yMB, cxBox, cyBox, (LPWSTR)lpmb-&gt;lpszCaption, wCaptionLen);
01046 
01047     <span class="comment">//</span>
01048     <span class="comment">// Center the buttons</span>
01049     <span class="comment">//</span>
01050 
01051     cxFoo = (cxBox - 2*<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXFIXEDFRAME) - cxButtons) / 2;
01052 
01053     lpDlgTmp = <a class="code" href="../../d6/d4/msgbox_8c.html#a15">MB_AddPushButtons</a>((LPDLGITEMTEMPLATE)lpDlgTmp, lpmb, cxFoo,
01054         cyBox - <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYCAPTION) - (2 * <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYFIXEDFRAME)) -
01055         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a853">YPixFromYDU</a>(<a class="code" href="../../d6/d4/msgbox_8c.html#a0">DU_OUTERMARGIN</a>, <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;cyMsgFontChar), dwStyleMsg);
01056 
01057     <span class="comment">// Add Icon, if any, to the Dlg template</span>
01058     <span class="comment">//</span>
01059     <span class="comment">// The icon is always top justified.  If the text is shorter than the</span>
01060     <span class="comment">// height of the icon, we center it.  Otherwise the text will start at</span>
01061     <span class="comment">// the top.</span>
01062     <span class="comment">//</span>
01063     <span class="keywordflow">if</span> (wIconOrdNum) {
01064         OrdNum[0] = 0xFFFF;  <span class="comment">// To indicate that an Ordinal number follows</span>
01065         OrdNum[1] = (WORD) wIconOrdNum;
01066 
01067         lpDlgTmp = <a class="code" href="../../d6/d4/msgbox_8c.html#a13">MB_UpdateDlgItem</a>((LPDLGITEMTEMPLATE)lpDlgTmp, IDUSERICON,        <span class="comment">// Control Id</span>
01068             SS_ICON | WS_GROUP | WS_CHILD | WS_VISIBLE, 0,
01069             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a852">XPixFromXDU</a>(<a class="code" href="../../d6/d4/msgbox_8c.html#a0">DU_OUTERMARGIN</a>, <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;cxMsgFontChar),   <span class="comment">// X co-ordinate</span>
01070             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a853">YPixFromYDU</a>(<a class="code" href="../../d6/d4/msgbox_8c.html#a0">DU_OUTERMARGIN</a>, <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;cyMsgFontChar),   <span class="comment">// Y co-ordinate</span>
01071             0,  0,          <span class="comment">// For Icons, CX and CY are ignored, can be zero</span>
01072             OrdNum,         <span class="comment">// Ordinal number of Icon</span>
01073             <span class="keyword">sizeof</span>(OrdNum)/<span class="keyword">sizeof</span>(WCHAR), <span class="comment">// Length of OrdNum</span>
01074             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a62">STATICCODE</a>);
01075     }
01076 
01077     <span class="comment">// Add the Text of the Message to the Dlg Template</span>
01078     <span class="keywordflow">if</span> (lpmb-&gt;lpszText) {
01079         <span class="comment">//</span>
01080         <span class="comment">// Center the text if shorter than the icon.</span>
01081         <span class="comment">//</span>
01082         <span class="keywordflow">if</span> (cyText &gt;= cyIcon)
01083             cxFoo = 0;
01084         <span class="keywordflow">else</span>
01085             cxFoo = (cyIcon - cyText) / 2;
01086 
01087         dwStyleText = SS_NOPREFIX | WS_GROUP | WS_CHILD | WS_VISIBLE | SS_EDITCONTROL;
01088         <span class="keywordflow">if</span> (dwStyleMsg &amp; MB_RIGHT) {
01089             dwStyleText |= SS_RIGHT;
01090             xText = cxBox - (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXSIZE) + cxText);
01091         } <span class="keywordflow">else</span> {
01092             dwStyleText |= SS_LEFT;
01093             xText = cxIcon + <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a852">XPixFromXDU</a>(<a class="code" href="../../d6/d4/msgbox_8c.html#a1">DU_INNERMARGIN</a>, <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;cxMsgFontChar);
01094         }
01095 
01096         <a class="code" href="../../d6/d4/msgbox_8c.html#a13">MB_UpdateDlgItem</a>((LPDLGITEMTEMPLATE)lpDlgTmp, -1, dwStyleText, dwExStyleMsg, xText,
01097             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a853">YPixFromYDU</a>(<a class="code" href="../../d6/d4/msgbox_8c.html#a0">DU_OUTERMARGIN</a>, <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;cyMsgFontChar) + cxFoo,
01098             cxText, cyText,
01099             (LPWSTR)lpmb-&gt;lpszText, wTextLen, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a62">STATICCODE</a>);
01100     }
01101 
01102     <span class="comment">// The dialog template is ready</span>
01103 
01104     <span class="comment">//</span>
01105     <span class="comment">// Set the normal cursor</span>
01106     <span class="comment">//</span>
01107     hcurOld = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a224">NtUserSetCursor</a>(LoadCursor(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, IDC_ARROW));
01108 
01109     lpmb-&gt;lpszIcon = (LPWSTR) hIcon;  <span class="comment">// BUGBUG - How to diff this from a resource?</span>
01110 
01111     <span class="keywordflow">if</span> (!(lpmb-&gt;dwStyle &amp; MB_USERICON))
01112     {
01113         <span class="keywordtype">int</span> wBeep = (LOWORD(lpmb-&gt;dwStyle &amp; MB_ICONMASK)) &gt;&gt; <a class="code" href="../../d6/d4/msgbox_8c.html#a5">MB_MASKSHIFT</a>;
01114         <span class="keywordflow">if</span> (wBeep &lt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a932">USER_SOUND_MAX</a>) {
01115             <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a174">NtUserCallOneParam</a>(wBeep, SFI_PLAYEVENTSOUND);
01116         }
01117     }
01118 
01119     iRetVal = (<span class="keywordtype">int</span>)<a class="code" href="../../d6/d0/usercli_8h.html#a751">InternalDialogBox</a>(<a class="code" href="../../d1/d8/clglobal_8c.html#a6">hmodUser</a>, hTemplate, hwndOwner,
01120         <a class="code" href="../../d6/d4/msgbox_8c.html#a33">MB_DlgProcW</a>, (LPARAM) lpmb, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01121 
01122     <span class="comment">//</span>
01123     <span class="comment">// Fix up return value</span>
01124     <span class="keywordflow">if</span> (iRetVal == -1)
01125         iRetVal = 0;                <span class="comment">/* Messagebox should also return error */</span>
01126 
01127      <span class="comment">//</span>
01128      <span class="comment">// If the messagebox contains only OK button, then its ID is changed as</span>
01129      <span class="comment">// IDCANCEL in MB_DlgProc; So, we must change it back to IDOK irrespective</span>
01130      <span class="comment">// of whether ESC is pressed or Carriage return is pressed;</span>
01131      <span class="comment">//</span>
01132     <span class="keywordflow">if</span> (((dwStyleMsg &amp; MB_TYPEMASK) == MB_OK) &amp;&amp; iRetVal)
01133         iRetVal = IDOK;
01134 
01135 
01136     <span class="comment">//</span>
01137     <span class="comment">// Restore the previous cursor</span>
01138     <span class="comment">//</span>
01139     <span class="keywordflow">if</span> (hcurOld)
01140         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a224">NtUserSetCursor</a>(hcurOld);
01141 
01142 SMB_Exit:
01143     <span class="keywordflow">if</span> (hTemplate)
01144         <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(hTemplate);
01145 
01146     <span class="keywordflow">if</span> (hCaption) {
01147         <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(hCaption);
01148     }
01149 
01150     <span class="keywordflow">if</span> (hText) {
01151         <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(hText);
01152     }
01153 
01154     <span class="keywordflow">return</span>(iRetVal);
01155 }
01156 
01157 <span class="comment">/***************************************************************************\</span>
01158 <span class="comment">* MB_CopyToClipboard</span>
01159 <span class="comment">*</span>
01160 <span class="comment">* Called in response to WM_COPY, it will save the title, message and button's</span>
01161 <span class="comment">* texts to the clipboard in CF_UNICODETEXT format.</span>
01162 <span class="comment">*</span>
01163 <span class="comment">*   ---------------------------</span>
01164 <span class="comment">*   Caption</span>
01165 <span class="comment">*   ---------------------------</span>
01166 <span class="comment">*   Text</span>
01167 <span class="comment">*   ---------------------------</span>
01168 <span class="comment">*   Button1   ...   ButtonN</span>
01169 <span class="comment">*   ---------------------------</span>
01170 <span class="comment">*</span>
01171 <span class="comment">*</span>
01172 <span class="comment">* History:</span>
01173 <span class="comment">* 08-03-97 MCostea      Created</span>
01174 <span class="comment">\***************************************************************************/</span>
01175 
<a name="l01176"></a><a class="code" href="../../d6/d4/msgbox_8c.html#a29">01176</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d4/msgbox_8c.html#a29">MB_CopyToClipboard</a>(
01177     HWND hwndDlg)
01178 {
01179     LPCWSTR lpszRead;
01180     LPWSTR  lpszAll, lpszWrite;
01181     HANDLE  hData;
01182     <span class="keyword">static</span>  WCHAR   szLine[] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"---------------------------\r\n"</span>;
01183     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>    cBufSize, i, cWrote;
01184     <a class="code" href="../../d7/d9/struct__MSGBOXDATA.html">LPMSGBOXDATA</a> lpmb;
01185 
01186     <span class="keywordflow">if</span> (!(lpmb = (<a class="code" href="../../d7/d9/struct__MSGBOXDATA.html">LPMSGBOXDATA</a>)<a class="code" href="../../d5/d9/cltxt_8h.html#a11">GetWindowLongPtr</a>(hwndDlg, GWLP_USERDATA)))
01187         <span class="keywordflow">return</span>;
01188 
01189     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a17">OpenClipboard</a>(hwndDlg))
01190         <span class="keywordflow">return</span>;
01191 
01192     <span class="comment">/*</span>
01193 <span class="comment">     * Calculate the buffer size:</span>
01194 <span class="comment">     *      - the message text can be all \n, that will become \r\n</span>
01195 <span class="comment">     *      - there are a few extra \r\n (that's why 8)</span>
01196 <span class="comment">     */</span>
01197     cBufSize =  (lpmb-&gt;lpszCaption ? wcslen(lpmb-&gt;lpszCaption) : 0) +
01198                 (lpmb-&gt;lpszText ? 2*wcslen(lpmb-&gt;lpszText) : 0) +
01199                 4*<span class="keyword">sizeof</span>(szLine) +
01200                 lpmb-&gt;<a class="code" href="../../d7/d9/struct__MSGBOXDATA.html#o5">cButtons</a> * <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o16">wMaxBtnSize</a> +
01201                 8;
01202 
01203     cBufSize *= <span class="keyword">sizeof</span>(WCHAR);
01204 
01205     <span class="keywordflow">if</span> (!(hData = <a class="code" href="../../d6/d0/usercli_8h.html#a3">UserGlobalAlloc</a>(<a class="code" href="../../d8/d6/ntuser_2client_2globals_8h.html#a0">LHND</a>, (LONG)(cBufSize))) ) {
01206         <span class="keywordflow">goto</span> CloseClip;
01207     }
01208 
01209     <a class="code" href="../../d6/d0/usercli_8h.html#a4">USERGLOBALLOCK</a>(hData, lpszAll);
01210     UserAssert(lpszAll);
01211 
01212     cWrote = wsprintf(lpszAll, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"%s%s\r\n%s"</span>,
01213                                 szLine,
01214                                 lpmb-&gt;lpszCaption ? lpmb-&gt;lpszCaption : <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">""</span>,
01215                                 szLine);
01216 
01217     lpszWrite = lpszAll + cWrote;
01218     lpszRead = lpmb-&gt;lpszText;
01219     <span class="comment">/*</span>
01220 <span class="comment">     * Change \n to \r\n in the text</span>
01221 <span class="comment">     */</span>
01222     <span class="keywordflow">for</span> (i = 0; *lpszRead; i++) {
01223 
01224         <span class="keywordflow">if</span> (*lpszRead == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\n'</span>)
01225             *lpszWrite++ = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\r'</span>;
01226 
01227         *lpszWrite++ = *lpszRead++;
01228     }
01229 
01230     cWrote = wsprintf(lpszWrite, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\r\n%s"</span>, szLine);
01231     lpszWrite += cWrote;
01232 
01233     <span class="comment">/*</span>
01234 <span class="comment">     * Remove &amp; from the button texts</span>
01235 <span class="comment">     */</span>
01236     <span class="keywordflow">for</span> (i = 0; i&lt;lpmb-&gt;<a class="code" href="../../d7/d9/struct__MSGBOXDATA.html#o5">cButtons</a>; i++) {
01237 
01238         lpszRead = lpmb-&gt;<a class="code" href="../../d7/d9/struct__MSGBOXDATA.html#o4">ppszButtonText</a>[i];
01239         <span class="keywordflow">while</span> (*lpszRead) {
01240             <span class="keywordflow">if</span> (*lpszRead != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'&amp;'</span>) {
01241                 *lpszWrite++ = *lpszRead;
01242             }
01243             lpszRead++;
01244         }
01245         *lpszWrite++ = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">' '</span>;
01246         *lpszWrite++ = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">' '</span>;
01247         *lpszWrite++ = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">' '</span>;
01248     }
01249     wsprintf(lpszWrite, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\r\n%s\0"</span>, szLine);
01250 
01251     <a class="code" href="../../d6/d0/usercli_8h.html#a1">USERGLOBALUNLOCK</a>(hData);
01252 
01253     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a130">NtUserEmptyClipboard</a>();
01254     <span class="comment">/*</span>
01255 <span class="comment">     * If we just called EmptyClipboard in the context of a 16 bit</span>
01256 <span class="comment">     * app then we also have to tell WOW to nix its 16 handle copy of</span>
01257 <span class="comment">     * clipboard data.  WOW does its own clipboard caching because</span>
01258 <span class="comment">     * some 16 bit apps use clipboard data even after the clipboard</span>
01259 <span class="comment">     * has been emptied.  See the note in the server code.</span>
01260 <span class="comment">     *</span>
01261 <span class="comment">     * Note: this is another place (besides client\editec.c) where</span>
01262 <span class="comment">     * EmptyClipboard is called* for a 16 bit app not going through WOW.</span>
01263 <span class="comment">     * If we added others we might want to move this into EmptyClipboard</span>
01264 <span class="comment">     * and have two versions.</span>
01265 <span class="comment">     */</span>
01266     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a16">GetClientInfo</a>()-&gt;CI_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a114">CI_16BIT</a>) {
01267         <a class="code" href="../../d8/d6/ntuser_2client_2globals_8h.html#a62">pfnWowEmptyClipBoard</a>();
01268     }
01269 
01270     <a class="code" href="../../d3/d8/client_8c.html#a43">SetClipboardData</a>(CF_UNICODETEXT, hData);
01271 
01272 CloseClip:
01273     <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a129">NtUserCloseClipboard</a>();
01274 
01275 }
01276 
01277 <span class="comment">/***************************************************************************\</span>
01278 <span class="comment">* MB_UpdateDlgHdr</span>
01279 <span class="comment">*</span>
01280 <span class="comment">* History:</span>
01281 <span class="comment">* 11-20-90 DarrinM      Ported from Win 3.0 sources.</span>
01282 <span class="comment">\***************************************************************************/</span>
01283 
<a name="l01284"></a><a class="code" href="../../d6/d4/msgbox_8c.html#a12">01284</a> LPBYTE <a class="code" href="../../d6/d4/msgbox_8c.html#a12">MB_UpdateDlgHdr</a>(
01285     LPDLGTEMPLATE lpDlgTmp,
01286     <span class="keywordtype">long</span> lStyle,
01287     <span class="keywordtype">long</span> lExtendedStyle,
01288     BYTE bItemCount,
01289     <span class="keywordtype">int</span> iX,
01290     <span class="keywordtype">int</span> iY,
01291     <span class="keywordtype">int</span> iCX,
01292     <span class="keywordtype">int</span> iCY,
01293     LPWSTR lpszCaption,
01294     <span class="keywordtype">int</span> cchCaptionLen)
01295 {
01296     LPTSTR lpStr;
01297     RECT rc;
01298 
01299     <span class="comment">/*</span>
01300 <span class="comment">     * Adjust the rectangle dimensions.</span>
01301 <span class="comment">     */</span>
01302     rc.left     = iX + <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXFIXEDFRAME);
01303     rc.top      = iY + <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYFIXEDFRAME);
01304     rc.right    = iX + iCX - <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXFIXEDFRAME);
01305     rc.bottom   = iY + iCY - <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYFIXEDFRAME);
01306 
01307 
01308     <span class="comment">/*</span>
01309 <span class="comment">     * Adjust for the caption.</span>
01310 <span class="comment">     */</span>
01311     rc.top += <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYCAPTION);
01312 
01313     lpDlgTmp-&gt;style = lStyle;
01314     lpDlgTmp-&gt;dwExtendedStyle = lExtendedStyle;
01315     lpDlgTmp-&gt;cdit = bItemCount;
01316     lpDlgTmp-&gt;x  = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a854">XDUFromXPix</a>(rc.left, <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;cxMsgFontChar);
01317     lpDlgTmp-&gt;y  = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a855">YDUFromYPix</a>(rc.top, <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;cyMsgFontChar);
01318     lpDlgTmp-&gt;cx = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a854">XDUFromXPix</a>(rc.right - rc.left, <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;cxMsgFontChar);
01319     lpDlgTmp-&gt;cy = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a855">YDUFromYPix</a>(rc.bottom - rc.top, <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;cyMsgFontChar);
01320 
01321     <span class="comment">/*</span>
01322 <span class="comment">     * Move pointer to variable length fields.  No menu resource for</span>
01323 <span class="comment">     * message box, a zero window class (means dialog box class).</span>
01324 <span class="comment">     */</span>
01325     lpStr = (LPWSTR)(lpDlgTmp + 1);
01326     *lpStr++ = 0;                           <span class="comment">// Menu</span>
01327     lpStr = (LPWSTR)<a class="code" href="../../d6/d0/usercli_8h.html#a123">NextWordBoundary</a>(lpStr);
01328     *lpStr++ = 0;                           <span class="comment">// Class</span>
01329     lpStr = (LPWSTR)<a class="code" href="../../d6/d0/usercli_8h.html#a123">NextWordBoundary</a>(lpStr);
01330 
01331     <span class="comment">/*</span>
01332 <span class="comment">     * NOTE: iCaptionLen may be less than the length of the Caption string;</span>
01333 <span class="comment">     * So, DO NOT USE lstrcpy();</span>
01334 <span class="comment">     */</span>
01335     RtlCopyMemory(lpStr, lpszCaption, cchCaptionLen*<span class="keyword">sizeof</span>(WCHAR));
01336     lpStr += cchCaptionLen;
01337     *lpStr++ = TEXT(<span class="charliteral">'\0'</span>);                <span class="comment">// Null terminate the caption str</span>
01338 
01339     <span class="comment">/*</span>
01340 <span class="comment">     * Font height of 0x7FFF means use the message box font</span>
01341 <span class="comment">     */</span>
01342     *lpStr++ = 0x7FFF;
01343 
01344     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a124">NextDWordBoundary</a>(lpStr);
01345 }
01346 
01347 <span class="comment">/***************************************************************************\</span>
01348 <span class="comment">* MB_AddPushButtons</span>
01349 <span class="comment">*</span>
01350 <span class="comment">* History:</span>
01351 <span class="comment">* 11-20-90 DarrinM      Ported from Win 3.0 sources.</span>
01352 <span class="comment">\***************************************************************************/</span>
01353 
<a name="l01354"></a><a class="code" href="../../d6/d4/msgbox_8c.html#a15">01354</a> LPBYTE <a class="code" href="../../d6/d4/msgbox_8c.html#a15">MB_AddPushButtons</a>(
01355     LPDLGITEMTEMPLATE  lpDlgTmp,
01356     <a class="code" href="../../d7/d9/struct__MSGBOXDATA.html">LPMSGBOXDATA</a>       lpmb,
01357     UINT               wLEdge,
01358     UINT               wBEdge,
01359     DWORD              dwStyleMsg)
01360 {
01361     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>   wYValue;
01362     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>   i;
01363     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>   wHeight;
01364     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>   wCount = lpmb-&gt;<a class="code" href="../../d7/d9/struct__MSGBOXDATA.html#o5">cButtons</a>;
01365 <span class="preprocessor">#ifdef USE_MIRRORING</span>
01366 <span class="preprocessor"></span>    UNREFERENCED_PARAMETER(dwStyleMsg);
01367 <span class="preprocessor">#endif</span>
01368 <span class="preprocessor"></span>
01369     wHeight = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a853">YPixFromYDU</a>(<a class="code" href="../../d6/d4/msgbox_8c.html#a3">DU_BTNHEIGHT</a>, <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;cyMsgFontChar);
01370 
01371     wYValue = wBEdge - wHeight;         <span class="comment">// Y co-ordinate for push buttons</span>
01372 
01373 <span class="preprocessor">#ifndef USE_MIRRORING</span>
01374 <span class="preprocessor"></span>    <span class="comment">/*</span>
01375 <span class="comment">     * Since USE_MIRRORING is enabled now, this code is disabled</span>
01376 <span class="comment">     * since Mirroring will take care of this. [samera]</span>
01377 <span class="comment">     */</span>
01378     <span class="keywordflow">if</span> ((dwStyleMsg &amp; MB_RTLREADING) &amp;&amp; (wCount &gt; 1)) {
01379         wLEdge += ((wCount-1) *
01380                    (<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o16">wMaxBtnSize</a> + <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a852">XPixFromXDU</a>(<a class="code" href="../../d6/d4/msgbox_8c.html#a2">DU_BTNGAP</a>, <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;cxMsgFontChar)));
01381     }
01382 <span class="preprocessor">#endif</span>
01383 <span class="preprocessor"></span>
01384     <span class="keywordflow">for</span> (i = 0; i &lt; wCount; i++) {
01385 
01386         lpDlgTmp = (LPDLGITEMTEMPLATE)<a class="code" href="../../d6/d4/msgbox_8c.html#a13">MB_UpdateDlgItem</a>(
01387                 lpDlgTmp,                       <span class="comment">/* Ptr to template */</span>
01388                 lpmb-&gt;<a class="code" href="../../d7/d9/struct__MSGBOXDATA.html#o3">pidButton</a>[i],             <span class="comment">/* Control Id */</span>
01389                 WS_TABSTOP | WS_CHILD | WS_VISIBLE | (i == 0 ? WS_GROUP : 0) |
01390                 ((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)i == lpmb-&gt;<a class="code" href="../../d7/d9/struct__MSGBOXDATA.html#o6">DefButton</a> ? BS_DEFPUSHBUTTON : BS_PUSHBUTTON),
01391                 0,
01392                 wLEdge,                         <span class="comment">/* X co-ordinate */</span>
01393                 wYValue,                        <span class="comment">/* Y co-ordinate */</span>
01394                 <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o16">wMaxBtnSize</a>,              <span class="comment">/* CX */</span>
01395                 wHeight,                        <span class="comment">/* CY */</span>
01396                 lpmb-&gt;<a class="code" href="../../d7/d9/struct__MSGBOXDATA.html#o4">ppszButtonText</a>[i],        <span class="comment">/* String for button */</span>
01397                 (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)wcslen(lpmb-&gt;<a class="code" href="../../d7/d9/struct__MSGBOXDATA.html#o4">ppszButtonText</a>[i]),<span class="comment">/* Length */</span>
01398                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a60">BUTTONCODE</a>);
01399 
01400         <span class="comment">/*</span>
01401 <span class="comment">         * Get the X co-ordinate for the next Push button</span>
01402 <span class="comment">         */</span>
01403 <span class="preprocessor">#ifndef USE_MIRRORING</span>
01404 <span class="preprocessor"></span>        <span class="comment">/*</span>
01405 <span class="comment">         * Since USE_MIRRORING is enabled now, this code is disabled</span>
01406 <span class="comment">         * since Mirroring will take care of this. [samera]</span>
01407 <span class="comment">         */</span>
01408         <span class="keywordflow">if</span> (dwStyleMsg &amp; MB_RTLREADING)
01409             wLEdge -= <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o16">wMaxBtnSize</a> + <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a852">XPixFromXDU</a>(<a class="code" href="../../d6/d4/msgbox_8c.html#a2">DU_BTNGAP</a>, <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;cxMsgFontChar);
01410         <span class="keywordflow">else</span>
01411 <span class="preprocessor">#endif</span>
01412 <span class="preprocessor"></span>            wLEdge += <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o16">wMaxBtnSize</a> + <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a852">XPixFromXDU</a>(<a class="code" href="../../d6/d4/msgbox_8c.html#a2">DU_BTNGAP</a>, <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;cxMsgFontChar);
01413     }
01414 
01415     <span class="keywordflow">return</span> (LPBYTE)lpDlgTmp;
01416 }
01417 
01418 <span class="comment">/***************************************************************************\</span>
01419 <span class="comment">* MB_UpdateDlgItem</span>
01420 <span class="comment">*</span>
01421 <span class="comment">* History:</span>
01422 <span class="comment">* 11-20-90 DarrinM      Ported from Win 3.0 sources.</span>
01423 <span class="comment">\***************************************************************************/</span>
01424 
<a name="l01425"></a><a class="code" href="../../d6/d4/msgbox_8c.html#a13">01425</a> LPBYTE <a class="code" href="../../d6/d4/msgbox_8c.html#a13">MB_UpdateDlgItem</a>(
01426     LPDLGITEMTEMPLATE lpDlgItem,
01427     <span class="keywordtype">int</span> iCtrlId,
01428     <span class="keywordtype">long</span> lStyle,
01429     <span class="keywordtype">long</span> lExtendedStyle,
01430     <span class="keywordtype">int</span> iX,
01431     <span class="keywordtype">int</span> iY,
01432     <span class="keywordtype">int</span> iCX,
01433     <span class="keywordtype">int</span> iCY,
01434     LPWSTR lpszText,
01435     UINT cchTextLen,
01436     <span class="keywordtype">int</span> iControlClass)
01437 {
01438     LPWSTR lpStr;
01439     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fIsOrdNum;
01440 
01441 
01442     lpDlgItem-&gt;x        = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a854">XDUFromXPix</a>(iX, <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;cxMsgFontChar);
01443     lpDlgItem-&gt;y        = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a855">YDUFromYPix</a>(iY, <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;cyMsgFontChar);
01444     lpDlgItem-&gt;cx       = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a854">XDUFromXPix</a>(iCX,<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;cxMsgFontChar);
01445     lpDlgItem-&gt;cy       = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a855">YDUFromYPix</a>(iCY,<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;cyMsgFontChar);
01446     lpDlgItem-&gt;id       = (WORD)iCtrlId;
01447     lpDlgItem-&gt;style    = lStyle;
01448     lpDlgItem-&gt;dwExtendedStyle = lExtendedStyle;
01449 
01450     <span class="comment">/*</span>
01451 <span class="comment">     * We have to avoid the following nasty rounding off problem:</span>
01452 <span class="comment">     * (e.g) If iCX=192 and cxSysFontChar=9, then cx becomes 85; When the</span>
01453 <span class="comment">     * static text is drawn, from 85 dlg units we get 191 pixels; So, the text</span>
01454 <span class="comment">     * is truncated;</span>
01455 <span class="comment">     * So, to avoid this, check if this is a static text and if so,</span>
01456 <span class="comment">     * add one more dialog unit to cx and cy;</span>
01457 <span class="comment">     * --Fix for Bug #4481 --SANKAR-- 09-29-89--</span>
01458 <span class="comment">     */</span>
01459 
01460     <span class="comment">/*</span>
01461 <span class="comment">     * Also, make sure we only do this to static text items.  davidds</span>
01462 <span class="comment">     */</span>
01463 
01464     <span class="comment">/*</span>
01465 <span class="comment">     * Now static text uses SS_NOPREFIX = 0x80;</span>
01466 <span class="comment">     * So, test the lStyle field only with 0x0F instead of 0xFF;</span>
01467 <span class="comment">     * Fix for Bugs #5933 and 5935 --SANKAR-- 11-28-89</span>
01468 <span class="comment">     */</span>
01469     <span class="keywordflow">if</span> (iControlClass == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a62">STATICCODE</a> &amp;&amp;
01470          (((lStyle &amp; 0x0F) == SS_LEFT) || ((lStyle &amp; 0x0F) == SS_RIGHT))) {
01471 
01472         <span class="comment">/*</span>
01473 <span class="comment">         * This is static text</span>
01474 <span class="comment">         */</span>
01475         lpDlgItem-&gt;cx++;
01476         lpDlgItem-&gt;cy++;
01477     }
01478 
01479     <span class="comment">/*</span>
01480 <span class="comment">     * Move ptr to the variable fields</span>
01481 <span class="comment">     */</span>
01482     lpStr = (LPWSTR)(lpDlgItem + 1);
01483 
01484     <span class="comment">/*</span>
01485 <span class="comment">     * Store the Control Class value</span>
01486 <span class="comment">     */</span>
01487     *lpStr++ = 0xFFFF;
01488     *lpStr++ = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)iControlClass;
01489     lpStr = (LPWSTR)<a class="code" href="../../d6/d0/usercli_8h.html#a123">NextWordBoundary</a>(lpStr);        <span class="comment">// WORD-align lpszText</span>
01490 
01491     <span class="comment">/*</span>
01492 <span class="comment">     * Check if the String contains Ordinal number or not</span>
01493 <span class="comment">     */</span>
01494     fIsOrdNum = ((*lpszText == 0xFFFF) &amp;&amp; (cchTextLen == <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)/<span class="keyword">sizeof</span>(WCHAR)));
01495 
01496     <span class="comment">/*</span>
01497 <span class="comment">     * NOTE: cchTextLen may be less than the length of lpszText.  So,</span>
01498 <span class="comment">     * DO NOT USE lstrcpy() for the copy.</span>
01499 <span class="comment">     */</span>
01500     RtlCopyMemory(lpStr, lpszText, cchTextLen*<span class="keyword">sizeof</span>(WCHAR));
01501     lpStr = lpStr + cchTextLen;
01502     <span class="keywordflow">if</span> (!fIsOrdNum) {
01503         *lpStr = TEXT(<span class="charliteral">'\0'</span>);    <span class="comment">// NULL terminate the string</span>
01504         lpStr = (LPWSTR)<a class="code" href="../../d6/d0/usercli_8h.html#a123">NextWordBoundary</a>(lpStr + 1);
01505     }
01506 
01507     *lpStr++ = 0;           <span class="comment">// sizeof control data (there is none)</span>
01508 
01509     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a124">NextDWordBoundary</a>(lpStr);
01510 }
01511 
01512 
01513 <span class="comment">/***************************************************************************\</span>
01514 <span class="comment">* MB_FindDlgTemplateSize</span>
01515 <span class="comment">*</span>
01516 <span class="comment">* This routine computes the amount of memory that will be needed for the</span>
01517 <span class="comment">* messagebox's dialog template structure.  The dialog template has several</span>
01518 <span class="comment">* required and optional records.  The dialog manager expects each record to</span>
01519 <span class="comment">* be DWORD aligned so any necessary padding is also accounted for.</span>
01520 <span class="comment">*</span>
01521 <span class="comment">* (header - required)</span>
01522 <span class="comment">* DLGTEMPLATE (header) + 1 menu byte + 1 pad + 1 class byte + 1 pad</span>
01523 <span class="comment">* szCaption + 0 term + DWORD alignment</span>
01524 <span class="comment">*</span>
01525 <span class="comment">* (static icon control - optional)</span>
01526 <span class="comment">* DLGITEMTEMPLATE + 1 class byte + 1 pad + (0xFF00 + icon ordinal # [szText]) +</span>
01527 <span class="comment">* UINT alignment + 1 control data length byte (0) + DWORD alignment</span>
01528 <span class="comment">*</span>
01529 <span class="comment">* (pushbutton controls - variable, but at least one required)</span>
01530 <span class="comment">* DLGITEMTEMPLATE + 1 class byte + 1 pad + length of button text +</span>
01531 <span class="comment">* UINT alignment + 1 control data length byte (0) + DWORD alignment</span>
01532 <span class="comment">*</span>
01533 <span class="comment">* (static text control - optional)</span>
01534 <span class="comment">* DLGITEMTEMPLATE + 1 class byte + 1 pad + length of text +</span>
01535 <span class="comment">* UINT alignment + 1 control data length byte (0) + DWORD alignment</span>
01536 <span class="comment">*</span>
01537 <span class="comment">* History:</span>
01538 <span class="comment">* 11-20-90 DarrinM      Ported from Win 3.0 sources.</span>
01539 <span class="comment">\***************************************************************************/</span>
01540 
<a name="l01541"></a><a class="code" href="../../d6/d4/msgbox_8c.html#a16">01541</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d6/d4/msgbox_8c.html#a16">MB_FindDlgTemplateSize</a>( <a class="code" href="../../d7/d9/struct__MSGBOXDATA.html">LPMSGBOXDATA</a>   lpmb )
01542 {
01543     ULONG_PTR cbLen;
01544     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> cbT;
01545     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> i;
01546     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> wCount;
01547 
01548     wCount = lpmb-&gt;<a class="code" href="../../d7/d9/struct__MSGBOXDATA.html#o5">cButtons</a>;
01549 
01550     <span class="comment">/*</span>
01551 <span class="comment">     * Start with dialog header's size.</span>
01552 <span class="comment">     */</span>
01553     cbLen = (ULONG_PTR)<a class="code" href="../../d6/d0/usercli_8h.html#a123">NextWordBoundary</a>(<span class="keyword">sizeof</span>(DLGTEMPLATE) + <span class="keyword">sizeof</span>(WCHAR));
01554     cbLen = (ULONG_PTR)<a class="code" href="../../d6/d0/usercli_8h.html#a123">NextWordBoundary</a>(cbLen + <span class="keyword">sizeof</span>(WCHAR));
01555     cbLen += wcslen(lpmb-&gt;lpszCaption) * <span class="keyword">sizeof</span>(WCHAR) + <span class="keyword">sizeof</span>(WCHAR);
01556     cbLen += <span class="keyword">sizeof</span>(WORD);                   <span class="comment">// Font height</span>
01557     cbLen = (ULONG_PTR)<a class="code" href="../../d6/d0/usercli_8h.html#a124">NextDWordBoundary</a>(cbLen);
01558 
01559     <span class="comment">/*</span>
01560 <span class="comment">     * Check if an Icon is present.</span>
01561 <span class="comment">     */</span>
01562     <span class="keywordflow">if</span> (lpmb-&gt;dwStyle &amp; MB_ICONMASK)
01563         cbLen += (ULONG_PTR)<a class="code" href="../../d6/d0/usercli_8h.html#a124">NextDWordBoundary</a>(<span class="keyword">sizeof</span>(DLGITEMTEMPLATE) + 7 * <span class="keyword">sizeof</span>(WCHAR));
01564 
01565     <span class="comment">/*</span>
01566 <span class="comment">     * Find the number of buttons in the msg box.</span>
01567 <span class="comment">     */</span>
01568     <span class="keywordflow">for</span> (i = 0; i &lt; wCount; i++) {
01569         cbLen = (ULONG_PTR)<a class="code" href="../../d6/d0/usercli_8h.html#a123">NextWordBoundary</a>(cbLen + <span class="keyword">sizeof</span>(DLGITEMTEMPLATE) +
01570                 (2 * <span class="keyword">sizeof</span>(WCHAR)));
01571         cbT = (wcslen(lpmb-&gt;<a class="code" href="../../d7/d9/struct__MSGBOXDATA.html#o4">ppszButtonText</a>[i]) + 1) * <span class="keyword">sizeof</span>(WCHAR);
01572         cbLen = (ULONG_PTR)<a class="code" href="../../d6/d0/usercli_8h.html#a123">NextWordBoundary</a>(cbLen + cbT);
01573         cbLen += <span class="keyword">sizeof</span>(WCHAR);
01574         cbLen = (ULONG_PTR)<a class="code" href="../../d6/d0/usercli_8h.html#a124">NextDWordBoundary</a>(cbLen);
01575     }
01576 
01577     <span class="comment">/*</span>
01578 <span class="comment">     * Add in the space required for the text message (if there is one).</span>
01579 <span class="comment">     */</span>
01580     <span class="keywordflow">if</span> (lpmb-&gt;lpszText != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01581         cbLen = (ULONG_PTR)<a class="code" href="../../d6/d0/usercli_8h.html#a123">NextWordBoundary</a>(cbLen + <span class="keyword">sizeof</span>(DLGITEMTEMPLATE) +
01582                 (2 * <span class="keyword">sizeof</span>(WCHAR)));
01583         cbT = (wcslen(lpmb-&gt;lpszText) + 1) * <span class="keyword">sizeof</span>(WCHAR);
01584         cbLen = (ULONG_PTR)<a class="code" href="../../d6/d0/usercli_8h.html#a123">NextWordBoundary</a>(cbLen + cbT);
01585         cbLen += <span class="keyword">sizeof</span>(WCHAR);
01586         cbLen = (ULONG_PTR)<a class="code" href="../../d6/d0/usercli_8h.html#a124">NextDWordBoundary</a>(cbLen);
01587     }
01588 
01589     <span class="keywordflow">return</span> (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)cbLen;
01590 }
01591 
01592 <span class="comment">/***************************************************************************\</span>
01593 <span class="comment">* MB_GetIconOrdNum</span>
01594 <span class="comment">*</span>
01595 <span class="comment">* History:</span>
01596 <span class="comment">* 11-20-90 DarrinM      Ported from Win 3.0 sources.</span>
01597 <span class="comment">\***************************************************************************/</span>
01598 
<a name="l01599"></a><a class="code" href="../../d6/d4/msgbox_8c.html#a14">01599</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d6/d4/msgbox_8c.html#a14">MB_GetIconOrdNum</a>(
01600     UINT rgBits)
01601 {
01602     <span class="keywordflow">switch</span> (rgBits &amp; MB_ICONMASK) {
01603     <span class="keywordflow">case</span> MB_USERICON:
01604     <span class="keywordflow">case</span> MB_ICONHAND:
01605         <span class="keywordflow">return</span> PtrToUlong(IDI_HAND);
01606 
01607     <span class="keywordflow">case</span> MB_ICONQUESTION:
01608         <span class="keywordflow">return</span> PtrToUlong(IDI_QUESTION);
01609 
01610     <span class="keywordflow">case</span> MB_ICONEXCLAMATION:
01611         <span class="keywordflow">return</span> PtrToUlong(IDI_EXCLAMATION);
01612 
01613     <span class="keywordflow">case</span> MB_ICONASTERISK:
01614         <span class="keywordflow">return</span> PtrToUlong(IDI_ASTERISK);
01615     }
01616 
01617     <span class="keywordflow">return</span> 0;
01618 }
01619 
01620 <span class="comment">/***************************************************************************\</span>
01621 <span class="comment">* MB_GetString</span>
01622 <span class="comment">*</span>
01623 <span class="comment">* History:</span>
01624 <span class="comment">*  1-24-95 JerrySh      Created.</span>
01625 <span class="comment">\***************************************************************************/</span>
01626 
<a name="l01627"></a><a class="code" href="../../d1/d0/inc_2user_8h.html#a1144">01627</a> LPWSTR <a class="code" href="../../d1/d0/inc_2user_8h.html#a1144">MB_GetString</a>(
01628     UINT wBtn)
01629 {
01630     <span class="keywordflow">if</span> (wBtn &lt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a880">MAX_SEB_STYLES</a>)
01631         <span class="keywordflow">return</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a406">GETGPSIMBPSTR</a>(wBtn);
01632 
01633     RIPMSG1(RIP_ERROR, <span class="stringliteral">"Invalid wBtn: %d"</span>, wBtn);
01634 
01635     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01636 }
01637 
01638 <span class="comment">/***************************************************************************\</span>
01639 <span class="comment">* MB_DlgProc</span>
01640 <span class="comment">*</span>
01641 <span class="comment">* Returns: TRUE  - message processed</span>
01642 <span class="comment">*          FALSE - message not processed</span>
01643 <span class="comment">*</span>
01644 <span class="comment">* History:</span>
01645 <span class="comment">* 11-20-90 DarrinM      Ported from Win 3.0 sources.</span>
01646 <span class="comment">\***************************************************************************/</span>
01647 
<a name="l01648"></a><a class="code" href="../../d6/d4/msgbox_8c.html#a31">01648</a> INT_PTR <a class="code" href="../../d6/d4/msgbox_8c.html#a31">MB_DlgProcWorker</a>(
01649     HWND hwndDlg,
01650     UINT wMsg,
01651     WPARAM wParam,
01652     LPARAM lParam,
01653     BOOL fAnsi)
01654 {
01655     HWND hwndT;
01656     <span class="keywordtype">int</span> iCount;
01657     <a class="code" href="../../d7/d9/struct__MSGBOXDATA.html">LPMSGBOXDATA</a> lpmb;
01658     HWND hwndOwner;
01659     PVOID lpfnCallback;
01660     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
01661 
01662     <span class="keywordflow">switch</span> (wMsg) {
01663     <span class="keywordflow">case</span> WM_CTLCOLORDLG:
01664     <span class="keywordflow">case</span> WM_CTLCOLORSTATIC:
01665         <span class="keywordflow">if</span> ((pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hwndDlg)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01666             <span class="keywordflow">return</span> 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
01667         <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a610">DefWindowProcWorker</a>(pwnd, WM_CTLCOLORMSGBOX,
01668                                    wParam, lParam, fAnsi);
01669 
01670     <span class="keywordflow">case</span> WM_INITDIALOG:
01671 
01672         lpmb = (<a class="code" href="../../d7/d9/struct__MSGBOXDATA.html">LPMSGBOXDATA</a>)lParam;
01673         <a class="code" href="../../d5/d9/cltxt_8h.html#a12">SetWindowLongPtr</a>(hwndDlg, GWLP_USERDATA, (ULONG_PTR)lParam);
01674 
01675         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a175">NtUserCallHwnd</a>(hwndDlg, SFI_SETMSGBOX);
01676 
01677         <span class="comment">/*</span>
01678 <span class="comment">         * Create the message box atoms, if we haven't done it yet</span>
01679 <span class="comment">         */</span>
01680         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d4/msgbox_8c.html#a9">atomBwlProp</a> == 0) {
01681             <a class="code" href="../../d6/d4/msgbox_8c.html#a9">atomBwlProp</a> = AddAtomW(<a class="code" href="../../d6/d0/usercli_8h.html#a257">WINDOWLIST_PROP_NAME</a>);
01682             <a class="code" href="../../d6/d4/msgbox_8c.html#a10">atomMsgBoxCallback</a> = AddAtomW(<a class="code" href="../../d6/d0/usercli_8h.html#a258">MSGBOX_CALLBACK</a>);
01683 
01684             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d4/msgbox_8c.html#a9">atomBwlProp</a> == 0 || <a class="code" href="../../d6/d4/msgbox_8c.html#a10">atomMsgBoxCallback</a> == 0) {
01685                 RIPMSG0(RIP_WARNING, <span class="stringliteral">"MB_DlgProcWorker: AddAtomW failed.  Out of memory?"</span>);
01686             }
01687         }
01688 
01689         <span class="keywordflow">if</span> (lpmb-&gt;dwStyle &amp; MB_HELP) {
01690             <a class="code" href="../../d6/d0/usercli_8h.html#a220">NtUserSetWindowContextHelpId</a>(hwndDlg, lpmb-&gt;dwContextHelpId);
01691             <span class="comment">//See if there is an app supplied callback.</span>
01692             <span class="keywordflow">if</span>(lpmb-&gt;lpfnMsgBoxCallback)
01693                 <a class="code" href="../../d0/d8/ntcftxt_8h.html#a29">SetProp</a>(hwndDlg, <a class="code" href="../../d6/d1/userrtl_8h.html#a0">MAKEINTATOM</a>(<a class="code" href="../../d6/d4/msgbox_8c.html#a10">atomMsgBoxCallback</a>),
01694                             lpmb-&gt;lpfnMsgBoxCallback);
01695         }
01696 
01697         <span class="keywordflow">if</span> (lpmb-&gt;dwStyle &amp; MB_TOPMOST)
01698             <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a115">NtUserSetWindowPos</a>(hwndDlg, HWND_TOPMOST, 0, 0, 0, 0, SWP_NOMOVE | SWP_NOSIZE);
01699 
01700         <span class="keywordflow">if</span> (lpmb-&gt;dwStyle &amp; MB_USERICON) {
01701             <a class="code" href="../../d5/d9/cltxt_8h.html#a18">SendDlgItemMessage</a>(hwndDlg, IDUSERICON, STM_SETICON, (WPARAM)(lpmb-&gt;lpszIcon), 0);
01702             iCount = ALERT_SYSTEM_WARNING;
01703         } <span class="keywordflow">else</span> {
01704             <span class="comment">/*</span>
01705 <span class="comment">             * Generate an alert notification</span>
01706 <span class="comment">             */</span>
01707             <span class="keywordflow">switch</span> (lpmb-&gt;dwStyle &amp; MB_ICONMASK) {
01708             <span class="keywordflow">case</span> MB_ICONWARNING:
01709                 iCount = ALERT_SYSTEM_WARNING;
01710                 <span class="keywordflow">break</span>;
01711 
01712             <span class="keywordflow">case</span> MB_ICONQUESTION:
01713                 iCount = ALERT_SYSTEM_QUERY;
01714                 <span class="keywordflow">break</span>;
01715 
01716             <span class="keywordflow">case</span> MB_ICONERROR:
01717                 iCount = ALERT_SYSTEM_ERROR;
01718                 <span class="keywordflow">break</span>;
01719 
01720             <span class="keywordflow">case</span> MB_ICONINFORMATION:
01721             <span class="keywordflow">default</span>:
01722                 iCount = ALERT_SYSTEM_INFORMATIONAL;
01723                 <span class="keywordflow">break</span>;
01724             }
01725         }
01726 
01727         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a405">FWINABLE</a>()) {
01728             <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a12">NotifyWinEvent</a>(EVENT_SYSTEM_ALERT, hwndDlg, OBJID_ALERT, iCount);
01729         }
01730 
01731 <span class="preprocessor">#ifdef LATER</span>
01732 <span class="preprocessor"></span><span class="comment">// darrinm - 06/17/91</span>
01733 <span class="comment">// SYSMODAL dialogs are history for now.</span>
01734 
01735         <span class="comment">/*</span>
01736 <span class="comment">         * Check if the Dialog box is a Sys Modal Dialog Box</span>
01737 <span class="comment">         */</span>
01738         <span class="keywordflow">if</span> (GetWindowLong(hwndDlg, GWL_STYLE) &amp; DS_SYSMODAL, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)
01739             <a class="code" href="../../d3/d0/user32_8def.html#a17">SetSysModalWindow</a>(hwndDlg);
01740 <span class="preprocessor">#endif</span>
01741 <span class="preprocessor"></span>
01742         <span class="keywordflow">if</span> ((lpmb-&gt;hwndOwner == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01743                 ((lpmb-&gt;dwStyle &amp; MB_MODEMASK) == MB_TASKMODAL)) {
01744             <a class="code" href="../../d6/d4/msgbox_8c.html#a19">StartTaskModalDialog</a>(hwndDlg);
01745         }
01746 
01747         <span class="comment">/*</span>
01748 <span class="comment">         * Set focus on the default button</span>
01749 <span class="comment">         */</span>
01750         hwndT = <a class="code" href="../../d3/d9/client_2wow_8c.html#a12">GetWindow</a>(hwndDlg, GW_CHILD);
01751         iCount = lpmb-&gt;<a class="code" href="../../d7/d9/struct__MSGBOXDATA.html#o6">DefButton</a>;
01752         <span class="keywordflow">while</span> (iCount--)
01753             hwndT = <a class="code" href="../../d3/d9/client_2wow_8c.html#a12">GetWindow</a>(hwndT, GW_HWNDNEXT);
01754 
01755         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a225">NtUserSetFocus</a>(hwndT);
01756 
01757         <span class="comment">//</span>
01758         <span class="comment">// If this dialogbox does not contain a IDCANCEL button, then</span>
01759         <span class="comment">// remove the CLOSE command from the system menu.</span>
01760         <span class="comment">// Bug #4445, --SANKAR-- 09-13-89 --</span>
01761         <span class="comment">//</span>
01762         <span class="keywordflow">if</span> (lpmb-&gt;<a class="code" href="../../d7/d9/struct__MSGBOXDATA.html#o7">CancelId</a> == 0)
01763         {
01764             HMENU hMenu;
01765             <span class="keywordflow">if</span> (hMenu = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a202">NtUserGetSystemMenu</a>(hwndDlg, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>))
01766                 <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a154">NtUserDeleteMenu</a>(hMenu, SC_CLOSE, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)MF_BYCOMMAND);
01767         }
01768 
01769         <span class="keywordflow">if</span> ((lpmb-&gt;dwStyle &amp; MB_TYPEMASK) == MB_OK)
01770         {
01771             <span class="comment">//</span>
01772             <span class="comment">// Make the ID of OK button to be CANCEL, because we want</span>
01773             <span class="comment">// the ESC to terminate the dialogbox; GetDlgItem32() will</span>
01774             <span class="comment">// not fail, because this is MB_OK messagebox!</span>
01775             <span class="comment">//</span>
01776 
01777             hwndDlg = <a class="code" href="../../d3/d9/client_2wow_8c.html#a6">GetDlgItem</a>(hwndDlg, IDOK);
01778 
01779             <span class="keywordflow">if</span> (hwndDlg != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01780             <span class="comment">//    hwndDlg-&gt;hMenu = (HMENU)IDCANCEL;</span>
01781                 <a class="code" href="../../d5/d9/cltxt_8h.html#a12">SetWindowLongPtr</a>(hwndDlg, GWLP_ID, IDCANCEL);
01782             } <span class="keywordflow">else</span> {
01783                 RIPMSG0(RIP_WARNING, <span class="stringliteral">"MB_DlgProcWorker - IDOK control not found"</span>);
01784             }
01785         }
01786 
01787         <span class="comment">/*</span>
01788 <span class="comment">         * We have changed the input focus</span>
01789 <span class="comment">         */</span>
01790         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01791 
01792     <span class="keywordflow">case</span> WM_HELP:
01793         <span class="comment">// When user hits an F1 key, it results in this message.</span>
01794         <span class="comment">// It is possible that this MsgBox has a callback instead of a</span>
01795         <span class="comment">// parent. So, we must behave as if the user hit the HELP button.</span>
01796 
01797         <span class="keywordflow">goto</span>  MB_GenerateHelp;
01798 
01799     <span class="keywordflow">case</span> WM_COMMAND:
01800         <span class="keywordflow">switch</span> (LOWORD(wParam)) {
01801         <span class="keywordflow">case</span> IDOK:
01802         <span class="keywordflow">case</span> IDCANCEL:
01803            <span class="comment">//</span>
01804            <span class="comment">// Check if a control exists with the given ID; This</span>
01805            <span class="comment">// check is needed because DlgManager returns IDCANCEL</span>
01806            <span class="comment">// blindly when ESC is pressed even if a button with</span>
01807            <span class="comment">// IDCANCEL is not present.</span>
01808            <span class="comment">// Bug #4445 --SANKAR--09-13-1989--</span>
01809            <span class="comment">//</span>
01810            <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d9/client_2wow_8c.html#a6">GetDlgItem</a>(hwndDlg, LOWORD(wParam)))
01811               <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01812 
01813 
01814            <span class="comment">// else FALL THRO....This is intentional.</span>
01815         <span class="keywordflow">case</span> IDABORT:
01816         <span class="keywordflow">case</span> IDIGNORE:
01817         <span class="keywordflow">case</span> IDNO:
01818         <span class="keywordflow">case</span> IDRETRY:
01819         <span class="keywordflow">case</span> IDYES:
01820         <span class="keywordflow">case</span> IDTRYAGAIN:
01821         <span class="keywordflow">case</span> IDCONTINUE:
01822            <a class="code" href="../../d6/d4/msgbox_8c.html#a18">EndTaskModalDialog</a>(hwndDlg);
01823            <a class="code" href="../../d2/d9/dlgend_8c.html#a0">EndDialog</a>(hwndDlg, LOWORD(wParam));
01824              <span class="keywordflow">break</span>;
01825         <span class="keywordflow">case</span> IDHELP:
01826 MB_GenerateHelp:
01827                 <span class="comment">// Generate the WM_HELP message and send it to owner or callback</span>
01828            hwndOwner = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01829 
01830            <span class="comment">// Check if there is an app supplied callback for this MsgBox</span>
01831            <span class="keywordflow">if</span>(!(lpfnCallback = (PVOID)<a class="code" href="../../d5/d9/cltxt_8h.html#a27">GetProp</a>(hwndDlg,
01832                                   <a class="code" href="../../d6/d1/userrtl_8h.html#a0">MAKEINTATOM</a>(<a class="code" href="../../d6/d4/msgbox_8c.html#a10">atomMsgBoxCallback</a>)))) {
01833                <span class="comment">// If not, see if we need to inform the parent.</span>
01834                hwndOwner = <a class="code" href="../../d3/d9/client_2wow_8c.html#a12">GetWindow</a>(hwndDlg, GW_OWNER);
01835 <span class="preprocessor">#ifdef LATER</span>
01836 <span class="preprocessor"></span>               <span class="comment">// Chicagoism</span>
01837                <span class="keywordflow">if</span> (hwndOwner &amp;&amp; hwndOwner == <a class="code" href="../../d3/d9/client_2wow_8c.html#a4">GetDesktopWindow</a>())
01838                    hwndOwner = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01839 <span class="preprocessor">#endif</span>
01840 <span class="preprocessor"></span>           }
01841 
01842                 <span class="comment">// See if we need to generate the Help message or call back.</span>
01843            <span class="keywordflow">if</span> (hwndOwner || lpfnCallback) {
01844                <a class="code" href="../../d6/d4/msgbox_8c.html#a20">SendHelpMessage</a>(hwndOwner, HELPINFO_WINDOW, IDHELP,
01845                    hwndDlg, <a class="code" href="../../d6/d0/usercli_8h.html#a221">NtUserGetWindowContextHelpId</a>(hwndDlg), lpfnCallback);
01846            }
01847            <span class="keywordflow">break</span>;
01848 
01849         <span class="keywordflow">default</span>:
01850             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01851             <span class="keywordflow">break</span>;
01852         }
01853         <span class="keywordflow">break</span>;
01854 
01855     <span class="keywordflow">case</span> WM_COPY:
01856         <a class="code" href="../../d6/d4/msgbox_8c.html#a29">MB_CopyToClipboard</a>(hwndDlg);
01857         <span class="keywordflow">break</span>;
01858 
01859     <span class="keywordflow">default</span>:
01860         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01861     }
01862 
01863     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01864 }
01865 
<a name="l01866"></a><a class="code" href="../../d6/d0/usercli_8h.html#a592">01866</a> INT_PTR WINAPI <a class="code" href="../../d6/d0/usercli_8h.html#a592">MB_DlgProcA</a>(
01867     HWND hwnd,
01868     UINT message,
01869     WPARAM wParam,
01870     LPARAM lParam)
01871 {
01872     <span class="keywordflow">return</span> <a class="code" href="../../d6/d4/msgbox_8c.html#a31">MB_DlgProcWorker</a>(hwnd, message, wParam, lParam, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01873 }
01874 
<a name="l01875"></a><a class="code" href="../../d6/d0/usercli_8h.html#a593">01875</a> INT_PTR WINAPI <a class="code" href="../../d6/d0/usercli_8h.html#a593">MB_DlgProcW</a>(
01876     HWND hwnd,
01877     UINT message,
01878     WPARAM wParam,
01879     LPARAM lParam)
01880 {
01881     <span class="keywordflow">return</span> <a class="code" href="../../d6/d4/msgbox_8c.html#a31">MB_DlgProcWorker</a>(hwnd, message, wParam, lParam, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01882 }
01883 
01884 
01885 <span class="comment">/***************************************************************************\</span>
01886 <span class="comment">* StartTaskModalDialog</span>
01887 <span class="comment">*</span>
01888 <span class="comment">* History:</span>
01889 <span class="comment">* 11-20-90 DarrinM      Ported from Win 3.0 sources.</span>
01890 <span class="comment">\***************************************************************************/</span>
01891 
<a name="l01892"></a><a class="code" href="../../d6/d4/msgbox_8c.html#a19">01892</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d4/msgbox_8c.html#a19">StartTaskModalDialog</a>(
01893     HWND hwndDlg)
01894 {
01895     <span class="keywordtype">int</span> cHwnd;
01896     HWND *phwnd;
01897     HWND *phwndList, *phwndEnd;
01898     HWND hwnd;
01899     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
01900 
01901     <span class="comment">/*</span>
01902 <span class="comment">     * Get the hwnd list.  It is returned in a block of memory</span>
01903 <span class="comment">     * allocated with LocalAlloc.</span>
01904 <span class="comment">     */</span>
01905     <span class="keywordflow">if</span> ((cHwnd = <a class="code" href="../../d4/d1/userk_8h.html#a1157">BuildHwndList</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, GetCurrentThreadId(), &amp;phwndList)) == 0) {
01906         <span class="keywordflow">return</span>;
01907     }
01908     <span class="comment">/*</span>
01909 <span class="comment">     * If atomBwlProp couldn't be added in WM_INITDIALOG processing, SetProp will fail</span>
01910 <span class="comment">     * and we need to free the hwndList as EndTaskModalDialog will not be able to do that</span>
01911 <span class="comment">     * MCostea 226543</span>
01912 <span class="comment">     */</span>
01913     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d8/ntcftxt_8h.html#a29">SetProp</a>(hwndDlg, <a class="code" href="../../d6/d1/userrtl_8h.html#a0">MAKEINTATOM</a>(<a class="code" href="../../d6/d4/msgbox_8c.html#a9">atomBwlProp</a>), (HANDLE)phwndList)) {
01914         <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(phwndList);
01915         <span class="keywordflow">return</span>;
01916     }
01917 
01918     phwndEnd = phwndList + cHwnd;
01919     <span class="keywordflow">for</span> (phwnd = phwndList; phwnd &lt; phwndEnd; phwnd++) {
01920         <span class="keywordflow">if</span> ((hwnd = *phwnd) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || (pwnd = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(hwnd)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01921             <span class="keywordflow">continue</span>;
01922 
01923         <span class="comment">/*</span>
01924 <span class="comment">         * if the window belongs to the current task and is enabled, disable</span>
01925 <span class="comment">         * it.  All other windows are NULL'd out, to prevent their being</span>
01926 <span class="comment">         * enabled later</span>
01927 <span class="comment">         */</span>
01928         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a651">WFDISABLED</a>) &amp;&amp; <a class="code" href="../../d6/d0/usercli_8h.html#a16">DIFFWOWHANDLE</a>(hwnd, hwndDlg)) {
01929             <a class="code" href="../../d6/d0/usercli_8h.html#a216">NtUserEnableWindow</a>(hwnd, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01930         } <span class="keywordflow">else</span> {
01931             *phwnd = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01932         }
01933     }
01934 }
01935 
01936 
01937 <span class="comment">/***************************************************************************\</span>
01938 <span class="comment">* EndTaskModalDialog</span>
01939 <span class="comment">*</span>
01940 <span class="comment">* History:</span>
01941 <span class="comment">* 11-20-90 DarrinM      Ported from Win 3.0 sources.</span>
01942 <span class="comment">\***************************************************************************/</span>
01943 
<a name="l01944"></a><a class="code" href="../../d6/d4/msgbox_8c.html#a18">01944</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d4/msgbox_8c.html#a18">EndTaskModalDialog</a>(
01945     HWND hwndDlg)
01946 {
01947     HWND *phwnd;
01948     HWND *phwndList;
01949     HWND hwnd;
01950 
01951     phwndList = (HWND *)<a class="code" href="../../d5/d9/cltxt_8h.html#a27">GetProp</a>(hwndDlg, <a class="code" href="../../d6/d1/userrtl_8h.html#a0">MAKEINTATOM</a>(<a class="code" href="../../d6/d4/msgbox_8c.html#a9">atomBwlProp</a>));
01952 
01953     <span class="keywordflow">if</span> (phwndList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01954         <span class="keywordflow">return</span>;
01955 
01956     <a class="code" href="../../d0/d8/ntcftxt_8h.html#a26">RemoveProp</a>(hwndDlg, <a class="code" href="../../d6/d1/userrtl_8h.html#a0">MAKEINTATOM</a>(<a class="code" href="../../d6/d4/msgbox_8c.html#a9">atomBwlProp</a>));
01957 
01958     <span class="keywordflow">for</span> (phwnd = phwndList; *phwnd != (HWND)1; phwnd++) {
01959         <span class="keywordflow">if</span> ((hwnd = *phwnd) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01960             <a class="code" href="../../d6/d0/usercli_8h.html#a216">NtUserEnableWindow</a>(hwnd, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01961         }
01962     }
01963 
01964     <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(phwndList);
01965 }
01966 
01967 <span class="preprocessor">#ifdef _JANUS_</span>
01968 <span class="preprocessor"></span><span class="comment">/***************************************************************************\</span>
01969 <span class="comment">* ErrorMessageInst</span>
01970 <span class="comment">*</span>
01971 <span class="comment">* Instrument routine for recording error msg</span>
01972 <span class="comment">*</span>
01973 <span class="comment">* Returns: TRUE  - Instrument error msg Success</span>
01974 <span class="comment">*          FALSE - Fail</span>
01975 <span class="comment">*</span>
01976 <span class="comment">* History:</span>
01977 <span class="comment">*   8-5-98 Chienho      Created</span>
01978 <span class="comment">\***************************************************************************/</span>
01979 
01980 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> ErrorMessageInst(
01981      <a class="code" href="../../d7/d9/struct__MSGBOXDATA.html">LPMSGBOXDATA</a> pMsgBoxParams)
01982 {
01983     ERROR_ELEMENT ErrEle;
01984     WCHAR *pwcs;
01985     PVOID ImageBase;
01986     PIMAGE_NT_HEADERS NtHeaders;
01987     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> rc;
01988 
01989     <span class="comment">/*</span>
01990 <span class="comment">     * Check if the MessageBox style is within the logged severity level</span>
01991 <span class="comment">     */</span>
01992     <span class="keywordflow">switch</span> (pMsgBoxParams-&gt;dwStyle &amp; MB_ICONMASK) {
01993     <span class="keywordflow">case</span> MB_ICONHAND:
01994         <span class="comment">/*</span>
01995 <span class="comment">         * when EMI is enabled, we at least log error messages</span>
01996 <span class="comment">         */</span>
01997         <span class="keywordflow">break</span>;
01998     <span class="keywordflow">case</span> MB_ICONEXCLAMATION:
01999         <span class="keywordflow">if</span> (gdwEMIControl &gt; EMI_SEVERITY_WARNING) {
02000             rc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02001             <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>;
02002         }
02003         <span class="keywordflow">break</span>;
02004     <span class="keywordflow">case</span> MB_ICONQUESTION:
02005         <span class="keywordflow">if</span> (gdwEMIControl &gt; EMI_SEVERITY_QUESTION) {
02006             rc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02007             <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>;
02008         }
02009         <span class="keywordflow">break</span>;
02010     <span class="keywordflow">case</span> MB_ICONASTERISK:
02011         <span class="keywordflow">if</span> (gdwEMIControl &gt; EMI_SEVERITY_INFORMATION) {
02012             rc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02013             <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>;
02014         }
02015         <span class="keywordflow">break</span>;
02016     <span class="keywordflow">case</span> MB_USERICON:
02017         <span class="keywordflow">if</span> (gdwEMIControl &gt; EMI_SEVERITY_USER) {
02018             rc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02019             <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>;
02020         }
02021         <span class="keywordflow">break</span>;
02022     <span class="keywordflow">default</span>:
02023         <span class="keywordflow">if</span> (gdwEMIControl &gt; EMI_SEVERITY_ALL) {
02024             rc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02025             <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>;
02026         }
02027         <span class="keywordflow">break</span>;
02028     }
02029 
02030     <span class="keywordflow">if</span> (gdwEMIThreadID != <a class="code" href="../../d6/d0/usercli_8h.html#a14">GETTHREADID</a>()) {
02031         rc = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02032         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>;
02033     }
02034     RtlZeroMemory(&amp;ErrEle, <span class="keyword">sizeof</span>(ErrEle));
02035 
02036     <span class="comment">/*</span>
02037 <span class="comment">     * get last error first, check with FormatMessage???</span>
02038 <span class="comment">     */</span>
02039     ErrEle.dwErrorCode = GetLastError();
02040 
02041     <span class="comment">/*</span>
02042 <span class="comment">     * get return address</span>
02043 <span class="comment">     */</span>
02044 
02045     ErrEle.ReturnAddr = gpReturnAddr;
02046 
02047     <span class="comment">/*</span>
02048 <span class="comment">     * get the process image name</span>
02049 <span class="comment">     */</span>
02050     <span class="keywordflow">if</span> (GetModuleFileName(NULL, ErrEle.ProcessName, MAX_PATH)) {
02051         pwcs = wcsrchr(ErrEle.ProcessName, TEXT(<span class="charliteral">'\\'</span>));
02052         <span class="keywordflow">if</span> (pwcs) {
02053             pwcs++;
02054             lstrcpy(ErrEle.ProcessName, pwcs);
02055         }
02056     } <span class="keywordflow">else</span> {
02057         lstrcpy(ErrEle.ProcessName, szUnknown);
02058     }
02059 
02060     <span class="comment">/*</span>
02061 <span class="comment">     * get the window title</span>
02062 <span class="comment">     */</span>
02063     GetWindowTextW(pMsgBoxParams-&gt;hwndOwner, ErrEle.WindowTitle, TITLE_SIZE);
02064     <span class="keywordflow">if</span> (!(*(ErrEle.WindowTitle))) {
02065         lstrcpy(ErrEle.WindowTitle, szUnknown);
02066     }
02067 
02068     <span class="comment">/*</span>
02069 <span class="comment">     * get messagebox data</span>
02070 <span class="comment">     */</span>
02071     ErrEle.lpszText = (LPWSTR)pMsgBoxParams-&gt;lpszText;
02072     ErrEle.lpszCaption = (LPWSTR)pMsgBoxParams-&gt;lpszCaption;
02073     ErrEle.dwStyle = pMsgBoxParams-&gt;dwStyle;
02074 
02075     <span class="comment">/*</span>
02076 <span class="comment">     * resolve the module name of caller</span>
02077 <span class="comment">     */</span>
02078     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d4/pctohdr_8c.html#a1">RtlPcToFileHeader</a>((PVOID)ErrEle.ReturnAddr, &amp;ImageBase)) {
02079         RIPMSG0(RIP_WARNING, <span class="stringliteral">"ErrorMessageInst: Can't find Caller"</span>);
02080         ErrEle.BaseAddr = (PVOID)-1;
02081         ErrEle.dwImageSize = -1;
02082         lstrcpy(ErrEle.CallerModuleName, szUnknown);
02083     } <span class="keywordflow">else</span> {
02084         ErrEle.BaseAddr = ImageBase;
02085         <span class="keywordflow">if</span> (GetModuleFileName((HMODULE)ImageBase, ErrEle.CallerModuleName, MAX_PATH)) {
02086             pwcs = wcsrchr(ErrEle.CallerModuleName, TEXT(<span class="charliteral">'\\'</span>));
02087             <span class="keywordflow">if</span> (pwcs) {
02088                 pwcs++;
02089                 lstrcpy(ErrEle.CallerModuleName, pwcs);
02090             }
02091         } <span class="keywordflow">else</span> {
02092             lstrcpy(ErrEle.CallerModuleName, szUnknown);
02093         }
02094         NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(ImageBase);
02095         <span class="keywordflow">if</span> (NtHeaders == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02096             ErrEle.dwImageSize = -1;
02097         } <span class="keywordflow">else</span> {
02098             ErrEle.dwImageSize = NtHeaders-&gt;OptionalHeader.SizeOfImage;
02099         }
02100     }
02101     <span class="comment">/*</span>
02102 <span class="comment">     * Register the event if we haven't done so already.</span>
02103 <span class="comment">     * Since RegisterEventSource is supported by a service, we must not hold</span>
02104 <span class="comment">     * any locks while making this call. Hence we might have several threads</span>
02105 <span class="comment">     * registering the event simultaneously.</span>
02106 <span class="comment">     */</span>
02107 
02108     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a14">gEventSource</a>) {
02109         <a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a14">gEventSource</a> = RegisterLogSource(L<span class="stringliteral">"Error Instrument"</span>);
02110         <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a14">gEventSource</a>) {
02111             ErrEle.dwErrorCode = GetLastError();
02112             rc = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02113         }
02114     }
02115 
02116     <span class="comment">/*</span>
02117 <span class="comment">     * report event</span>
02118 <span class="comment">     */</span>
02119     <span class="keywordflow">if</span>(<a class="code" href="../../d4/d6/ntuser_2server_2globals_8c.html#a14">gEventSource</a>) {
02120        rc = LogMessageBox(&amp;ErrEle);
02121     }
02122 
02123     <span class="comment">/*</span>
02124 <span class="comment">     * allow to process another event log again</span>
02125 <span class="comment">     */</span>
02126 
02127     InterlockedExchangePointer(&amp;gdwEMIThreadID, 0);
02128 
02129 <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>:
02130     <span class="keywordflow">return</span> rc;
02131 }
02132 
02133 <span class="comment">/***************************************************************************\</span>
02134 <span class="comment">* InitInstrument</span>
02135 <span class="comment">*</span>
02136 <span class="comment">* Returns: TRUE  - Initialization Success</span>
02137 <span class="comment">*          FALSE - Initialization Fail</span>
02138 <span class="comment">*</span>
02139 <span class="comment">\***************************************************************************/</span>
02140 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> InitInstrument(
02141     LPDWORD lpEMIControl)
02142 {
02143     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02144     HKEY hKeyEMI = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02145     UNICODE_STRING UnicodeStringEMIKey;
02146     UNICODE_STRING UnicodeStringEnable;
02147     UNICODE_STRING UnicodeStringStyle;
02148     OBJECT_ATTRIBUTES ObjA;
02149     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> EMIEnable = 0; <span class="comment">//means disable</span>
02150     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> EMISeverity;
02151     <span class="keyword">struct </span>{
02152         KEY_VALUE_PARTIAL_INFORMATION;
02153         LARGE_INTEGER;
02154     } EMIValueInfo;
02155     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwDisposition;
02156 
02157     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeStringEMIKey, szEMIKey);
02158     InitializeObjectAttributes(&amp;ObjA, &amp;UnicodeStringEMIKey, OBJ_CASE_INSENSITIVE, NULL, NULL);
02159 
02160     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(&amp;hKeyEMI, KEY_READ, &amp;ObjA);
02161     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02162         <span class="comment">/*</span>
02163 <span class="comment">         * Key doesn't exist, assume disable</span>
02164 <span class="comment">         */</span>
02165         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02166     }
02167 
02168     <span class="comment">/*</span>
02169 <span class="comment">     * read the logging enable and setting</span>
02170 <span class="comment">     */</span>
02171     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeStringEnable, szEMIEnable);
02172     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(hKeyEMI,
02173                      &amp;UnicodeStringEnable,
02174                      KeyValuePartialInformation,
02175                      &amp;EMIValueInfo,
02176                      <span class="keyword">sizeof</span>(EMIValueInfo),
02177                      &amp;dwDisposition);
02178 
02179     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02180 
02181         RtlCopyMemory(&amp;EMIEnable, &amp;EMIValueInfo.Data, <span class="keyword">sizeof</span>(EMIEnable));
02182 
02183         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeStringStyle, szEMISeverity);
02184         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(hKeyEMI,
02185                          &amp;UnicodeStringStyle,
02186                          KeyValuePartialInformation,
02187                          &amp;EMIValueInfo,
02188                          <span class="keyword">sizeof</span>(EMIValueInfo),
02189                          &amp;dwDisposition);
02190 
02191         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02192             RtlCopyMemory(&amp;EMISeverity, &amp;EMIValueInfo.Data, <span class="keyword">sizeof</span>(EMISeverity));
02193             <span class="comment">/*</span>
02194 <span class="comment">             * Validate data</span>
02195 <span class="comment">             */</span>
02196             <span class="keywordflow">if</span> (EMISeverity &gt; EMI_SEVERITY_MAX_VALUE) {
02197                 EMISeverity = EMI_SEVERITY_MAX_VALUE;
02198             }
02199         } <span class="keywordflow">else</span> {
02200             <span class="comment">/*</span>
02201 <span class="comment">             * default severity for instrument</span>
02202 <span class="comment">             */</span>
02203             EMISeverity = EMI_SEVERITY_WARNING;
02204         }
02205         *lpEMIControl = EMISeverity;
02206     }
02207 
02208     <span class="comment">/*</span>
02209 <span class="comment">     * read default message reply enable</span>
02210 <span class="comment">     */</span>
02211     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeStringEnable, szDMREnable);
02212     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(hKeyEMI,
02213                      &amp;UnicodeStringEnable,
02214                      KeyValuePartialInformation,
02215                      &amp;EMIValueInfo,
02216                      <span class="keyword">sizeof</span>(EMIValueInfo),
02217                      &amp;dwDisposition);
02218 
02219     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02220         RtlCopyMemory(&amp;gfDMREnable, &amp;EMIValueInfo.Data, <span class="keyword">sizeof</span>(gfDMREnable));
02221     }
02222 
02223     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hKeyEMI);
02224 
02225     <span class="keywordflow">if</span> (EMIEnable) {
02226 
02227           <span class="comment">/*</span>
02228 <span class="comment">           * add eventlog file</span>
02229 <span class="comment">           */</span>
02230           <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(CreateLogSource())) {
02231               <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02232           }
02233     }
02234     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02235 }
02236 
02237 <span class="comment">/***************************************************************************\</span>
02238 <span class="comment">* CreateLogSource</span>
02239 <span class="comment">*</span>
02240 <span class="comment">* Create the event source for eventlog</span>
02241 <span class="comment">* Return : NTSTATUS</span>
02242 <span class="comment">*</span>
02243 <span class="comment">\***************************************************************************/</span>
02244 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> CreateLogSource()
02245 {
02246     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02247     UNICODE_STRING UnicodeStringEventKey;
02248     OBJECT_ATTRIBUTES ObjA;
02249     HKEY hKeyEvent = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02250     UNICODE_STRING UnicodeString;
02251     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwDisposition;
02252 
02253 
02254     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeStringEventKey, szEventKey);
02255     InitializeObjectAttributes(&amp;ObjA, &amp;UnicodeStringEventKey, OBJ_CASE_INSENSITIVE, NULL, NULL);
02256 
02257     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(&amp;hKeyEvent, KEY_READ, &amp;ObjA))) {
02258 
02259         <span class="keyword">struct </span>{
02260             KEY_VALUE_PARTIAL_INFORMATION KeyInfo;
02261             WCHAR awchMsgFileName[256];
02262         } MsgFile;
02263 
02264         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, szEventMsgFile);
02265 
02266         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(hKeyEvent,
02267                                  &amp;UnicodeString,
02268                                  KeyValuePartialInformation,
02269                                  &amp;MsgFile,
02270                                  <span class="keyword">sizeof</span> MsgFile,
02271                                  &amp;dwDisposition);
02272         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02273             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = lstrcmpi((LPWSTR)MsgFile.KeyInfo.Data, L<span class="stringliteral">"%SystemRoot%\\System32\\user32.dll"</span>);
02274         }
02275         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(hKeyEvent);
02276     }
02277 
02278     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02279 }
02280 
02281 <span class="comment">/***************************************************************************\</span>
02282 <span class="comment">* RegisterLogSource</span>
02283 <span class="comment">*</span>
02284 <span class="comment">* Get eventlog apis from advapi32.dll and register the event source</span>
02285 <span class="comment">* Return : HANDLE of event source</span>
02286 <span class="comment">*</span>
02287 <span class="comment">\***************************************************************************/</span>
02288 HANDLE RegisterLogSource(
02289     LPWSTR lpszSourceName)
02290 {
02291     <span class="comment">/*</span>
02292 <span class="comment">     * If we haven't already dynamically linked to advadpi32.dll, do it now.</span>
02293 <span class="comment">     */</span>
02294     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a7">gfnRegisterEventSource</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02295         HINSTANCE hAdvApi;
02296         FARPROC fnRegisterEventSource;
02297         FARPROC fnDeregisterEventSource;
02298         FARPROC fnReportEvent;
02299         FARPROC fnGetTokenInformation;
02300         FARPROC fnOpenProcessToken;
02301         FARPROC fnOpenThreadToken;
02302 
02303         <span class="comment">/*</span>
02304 <span class="comment">         * Try to load the DLL and function pointers.</span>
02305 <span class="comment">         */</span>
02306         <span class="keywordflow">if</span> ((hAdvApi = LoadLibrary(L<span class="stringliteral">"advapi32.dll"</span>)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02307             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02308         }
02309         fnRegisterEventSource = GetProcAddress(hAdvApi, <span class="stringliteral">"RegisterEventSourceW"</span>);
02310         fnDeregisterEventSource = GetProcAddress(hAdvApi, <span class="stringliteral">"DeregisterEventSource"</span>);
02311         fnReportEvent = GetProcAddress(hAdvApi, <span class="stringliteral">"ReportEventW"</span>);
02312         fnGetTokenInformation = GetProcAddress(hAdvApi, <span class="stringliteral">"GetTokenInformation"</span>);
02313         fnOpenProcessToken = GetProcAddress(hAdvApi, <span class="stringliteral">"OpenProcessToken"</span>);
02314         fnOpenThreadToken = GetProcAddress(hAdvApi, <span class="stringliteral">"OpenThreadToken"</span>);
02315         <span class="keywordflow">if</span> (!fnRegisterEventSource || !fnDeregisterEventSource || !fnReportEvent ||
02316             !fnGetTokenInformation || !fnOpenProcessToken || !fnOpenThreadToken) {
02317             FreeLibrary(hAdvApi);
02318             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02319         }
02320 
02321         <span class="comment">/*</span>
02322 <span class="comment">         * Update the global function pointers if they're not set already.</span>
02323 <span class="comment">         */</span>
02324         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a7">gfnRegisterEventSource</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02325             <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a9">gfnReportEvent</a> = fnReportEvent;
02326             <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a8">gfnDeregisterEventSource</a> = fnDeregisterEventSource;
02327             gfnGetTokenInformation = fnGetTokenInformation;
02328             gfnOpenProcessToken = fnOpenProcessToken;
02329             gfnOpenThreadToken = fnOpenThreadToken;
02330             <span class="comment">// This must be last since we test it above</span>
02331             <a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a7">gfnRegisterEventSource</a> = fnRegisterEventSource;
02332             ghAdvApi = hAdvApi;
02333             hAdvApi = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02334         }
02335 
02336         <span class="comment">/*</span>
02337 <span class="comment">         * If another thread beat us to it, free the library.</span>
02338 <span class="comment">         */</span>
02339         <span class="keywordflow">if</span> (hAdvApi) {
02340             FreeLibrary(hAdvApi);
02341         }
02342     }
02343 
02344     <span class="comment">/*</span>
02345 <span class="comment">     * Let's be paranoid and verify we loaded everything correctly.</span>
02346 <span class="comment">     */</span>
02347     UserAssert(gfnRegisterEventSource != NULL);
02348     UserAssert(gfnDeregisterEventSource != NULL);
02349     UserAssert(gfnReportEvent != NULL);
02350     UserAssert(gfnGetTokenInformation != NULL);
02351     UserAssert(gfnOpenProcessToken != NULL);
02352     UserAssert(gfnOpenThreadToken != NULL);
02353 
02354     <span class="comment">/*</span>
02355 <span class="comment">     * Call the real function.</span>
02356 <span class="comment">     */</span>
02357     <span class="keywordflow">return</span> (HANDLE)<a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a7">gfnRegisterEventSource</a>(NULL, lpszSourceName);
02358 }
02359 <span class="comment">/***************************************************************************\</span>
02360 <span class="comment">* LogMessageBox</span>
02361 <span class="comment">*</span>
02362 <span class="comment">* Output error message record into eventlog</span>
02363 <span class="comment">*</span>
02364 <span class="comment">\***************************************************************************/</span>
02365 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> LogMessageBox(
02366     LPERROR_ELEMENT lpErrEle)
02367 {
02368 
02369     LPWSTR      lps[8];
02370     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>       dwData[2];
02371     WCHAR       BaseAddress[19];
02372     WCHAR       ImageSize[19];
02373     WCHAR       ReturnAddress[19];
02374     PTOKEN_USER pTokenUser = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02375     PSID        pSid = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02376     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>        rc;
02377 
02378     lps[0] = lpErrEle-&gt;ProcessName;
02379     lps[1] = lpErrEle-&gt;WindowTitle;
02380     lps[2] = lpErrEle-&gt;lpszCaption;
02381     lps[3] = lpErrEle-&gt;lpszText;
02382     lps[4] = lpErrEle-&gt;CallerModuleName;
02383     wsprintf(BaseAddress, L<span class="stringliteral">"%-#16p"</span>, lpErrEle-&gt;BaseAddr);
02384     lps[5] = BaseAddress;
02385     wsprintf(ImageSize, L<span class="stringliteral">"%-#16lX"</span>, lpErrEle-&gt;dwImageSize);
02386     lps[6] = ImageSize;
02387     wsprintf(ReturnAddress, L<span class="stringliteral">"%-#16p"</span>, lpErrEle-&gt;ReturnAddr);
02388     lps[7] = ReturnAddress;
02389 
02390     dwData[0] = lpErrEle-&gt;dwStyle;
02391     dwData[1] = lpErrEle-&gt;dwErrorCode;
02392 
02393     <span class="keywordflow">if</span>( GetUserSid(&amp;pTokenUser) )
02394         pSid = pTokenUser-&gt;User.Sid;
02395 
02396     UserAssert(gEventSource != NULL);
02397     rc = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)<a class="code" href="../../d7/d8/w32_2ntuser_2server_2harderr_8c.html#a9">gfnReportEvent</a>(gEventSource, EVENTLOG_INFORMATION_TYPE, 0,
02398             STATUS_LOG_ERROR_MSG, pSid, <span class="keyword">sizeof</span>(lps) / <span class="keyword">sizeof</span>(*lps),
02399             <span class="keyword">sizeof</span>(dwData), lps, dwData);
02400 
02401     <span class="keywordflow">if</span>( pTokenUser ) {
02402 
02403         VirtualFree( pTokenUser, 0, MEM_RELEASE );
02404     }
02405 
02406     <span class="keywordflow">return</span> rc;
02407 }
02408 
02409 <span class="comment">/***************************************************************************\</span>
02410 <span class="comment">* GetUserSid</span>
02411 <span class="comment">*</span>
02412 <span class="comment">*  Well, actually it gets a pointer to a newly allocated TOKEN_USER,</span>
02413 <span class="comment">*  which contains a SID, somewhere.</span>
02414 <span class="comment">*  Caller must remember to free it when it's been used.</span>
02415 <span class="comment">*</span>
02416 <span class="comment">* History:</span>
02417 <span class="comment">*   10-16-98 Chienho      stole from spooler</span>
02418 <span class="comment">*</span>
02419 <span class="comment">\***************************************************************************/</span>
02420 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> GetUserSid(
02421      PTOKEN_USER *ppTokenUser)
02422 {
02423     HANDLE      TokenHandle;
02424     PTOKEN_USER pTokenUser = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02425     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>       cbTokenUser = 0;
02426     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>       cbNeeded;
02427     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>        bRet = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02428 
02429     <span class="keywordflow">if</span> ( !GetTokenHandle( &amp;TokenHandle) ) {
02430         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02431     }
02432 
02433     bRet = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)gfnGetTokenInformation( TokenHandle,
02434                                          TokenUser,
02435                                          pTokenUser,
02436                                          cbTokenUser,
02437                                          &amp;cbNeeded);
02438 
02439     <span class="comment">/* We've passed a NULL pointer and 0 for the amount of memory</span>
02440 <span class="comment">     * allocated.  We expect to fail with bRet = FALSE and</span>
02441 <span class="comment">     * GetLastError = ERROR_INSUFFICIENT_BUFFER. If we do not</span>
02442 <span class="comment">     * have these conditions we will return FALSE</span>
02443 <span class="comment">     */</span>
02444 
02445     <span class="keywordflow">if</span> ( !bRet &amp;&amp; (GetLastError() == ERROR_INSUFFICIENT_BUFFER) ) {
02446 
02447         pTokenUser = VirtualAlloc(NULL, cbNeeded, MEM_COMMIT, PAGE_READWRITE);
02448 
02449         <span class="keywordflow">if</span> ( pTokenUser == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
02450 
02451             <span class="keywordflow">goto</span> GetUserSidDone;
02452         }
02453 
02454         cbTokenUser = cbNeeded;
02455 
02456         bRet = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)gfnGetTokenInformation( TokenHandle,
02457                                              TokenUser,
02458                                              pTokenUser,
02459                                              cbTokenUser,
02460                                              &amp;cbNeeded );
02461 
02462     } <span class="keywordflow">else</span> {
02463 
02464         <span class="comment">/*</span>
02465 <span class="comment">         * Any other case -- return FALSE</span>
02466 <span class="comment">         */</span>
02467         bRet = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02468     }
02469 
02470 GetUserSidDone:
02471     <span class="keywordflow">if</span> ( bRet == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ) {
02472 
02473         *ppTokenUser  = pTokenUser;
02474 
02475     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( pTokenUser ) {
02476 
02477         VirtualFree( pTokenUser, 0, MEM_RELEASE );
02478     }
02479 
02480     CloseHandle( TokenHandle );
02481 
02482     <span class="keywordflow">return</span> bRet;
02483 }
02484 
02485 <span class="comment">/***************************************************************************\</span>
02486 <span class="comment">* GetTokenHandle</span>
02487 <span class="comment">*</span>
02488 <span class="comment">* Get handle of token for current thread</span>
02489 <span class="comment">*</span>
02490 <span class="comment">\***************************************************************************/</span>
02491 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
02492 GetTokenHandle(
02493     PHANDLE pTokenHandle
02494     )
02495 {
02496     <span class="keywordflow">if</span> (!gfnOpenThreadToken(GetCurrentThread(),
02497                             TOKEN_ADJUST_PRIVILEGES | TOKEN_QUERY,
02498                             TRUE,
02499                             pTokenHandle)) {
02500 
02501         <span class="keywordflow">if</span> (GetLastError() == ERROR_NO_TOKEN) {
02502 
02503             <span class="comment">/* This means we are not impersonating anybody.</span>
02504 <span class="comment">             * Instead, lets get the token out of the process.</span>
02505 <span class="comment">             */</span>
02506 
02507             <span class="keywordflow">if</span> (!gfnOpenProcessToken(GetCurrentProcess(),
02508                                      TOKEN_ADJUST_PRIVILEGES | TOKEN_QUERY,
02509                                      pTokenHandle)) {
02510 
02511                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02512             }
02513 
02514         } <span class="keywordflow">else</span>
02515 
02516             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02517     }
02518 
02519     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02520 }
02521 
02522 <span class="preprocessor">#endif //_JANUS_</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:53 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
