<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: tokenopn.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>tokenopn.c File Reference</h1><code>#include "<a class="el" href="../../d7/d5/sep_8h-source.html">sep.h</a>"</code><br>
<code>#include "seopaque.h"</code><br>
<code>#include "<a class="el" href="../../d9/d2/tokenp_8h-source.html">tokenp.h</a>"</code><br>

<p>
<a href="../../d8/d2/tokenopn_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d3/tokenopn_8c.html#a0">SepCreateImpersonationTokenDacl</a> (IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a> <a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a>, IN PACCESS_TOKEN <a class="el" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a>, OUT PACL *Acl)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d3/tokenopn_8c.html#a1">NtOpenProcessToken</a> (IN HANDLE ProcessHandle, IN ACCESS_MASK DesiredAccess, OUT PHANDLE TokenHandle)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d3/tokenopn_8c.html#a2">SepOpenTokenOfThread</a> (IN HANDLE <a class="el" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>, IN BOOLEAN OpenAsSelf, OUT PACCESS_TOKEN *<a class="el" href="../../d2/d1/cttoken_8c.html#a28">Token</a>, OUT <a class="el" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> *Thread, OUT PBOOLEAN CopyOnOpen, OUT PBOOLEAN EffectiveOnly, OUT PSECURITY_IMPERSONATION_LEVEL ImpersonationLevel)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d3/tokenopn_8c.html#a3">NtOpenThreadToken</a> (IN HANDLE <a class="el" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>, IN ACCESS_MASK DesiredAccess, IN BOOLEAN OpenAsSelf, OUT PHANDLE TokenHandle)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a1" doxytag="tokenopn.c::NtOpenProcessToken" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtOpenProcessToken           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>TokenHandle</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d2/tokenopn_8c-source.html#l00178">178</a> of file <a class="el" href="../../d8/d2/tokenopn_8c-source.html">tokenopn.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00367">ObOpenObjectByPointer()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01564">ProbeForWriteHandle</a>, <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l00492">PsOpenTokenOfProcess()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01212">SepTokenObjectType</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>.
<p>
Referenced by <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00129">CheckRestricted()</a>, <a class="el" href="../../d0/d4/edithive_8c-source.html#l00988">EhpAttachSecurity()</a>, <a class="el" href="../../d5/d2/rtsetsec_8c-source.html#l00273">GetMySid()</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00879">InitializeRestrictedStuff()</a>, <a class="el" href="../../d3/d9/server_2exitwin_8c-source.html#l01865">InternalCreateCallbackThread()</a>, <a class="el" href="../../d8/d5/ttokend_8c-source.html#l00322">main()</a>, <a class="el" href="../../d3/d8/uipriv_8c-source.html#l00148">OpenAppropriateToken()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00639">RtlAdjustPrivilege()</a>, <a class="el" href="../../d5/d7/seurtl_8c-source.html#l01624">RtlCreateUserSecurityObject()</a>, <a class="el" href="../../d5/d7/seurtl_8c-source.html#l01860">RtlDefaultNpAcl()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l03446">RtlImpersonateSelf()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l08795">RtlpGetDefaultsSubjectContext()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l10195">RtlpSetSecurityObject()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l03544">RtlpValidOwnerSubjectContext()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l07648">TestTokenAssignPrimary()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l07982">TestTokenImpersonation()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00167">TestTokenInitialize()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l01276">TestTokenOpenPrimary()</a>.
<p>
<pre class="fragment"><div>00186                    :
00187 
00188     Open a token object associated with a process and <span class="keywordflow">return</span> a handle
00189     that may be used to access that token.
00190 
00191 Arguments:
00192 
00193     ProcessHandle - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process whose token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be
00194         opened.
00195 
00196     DesiredAccess - Is an access mask indicating which access types
00197         are desired to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token.  These access types are reconciled
00198         with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Discretionary Access Control list of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token to
00199         determine whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> accesses will be granted or denied.
00200 
00201     TokenHandle - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> newly opened token.
00202 
00203 Return Value:
00204 
00205     STATUS_SUCCESS - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation was successful.
00206 
00207 --*/
00208 {
00209 
00210     PVOID <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
00211     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00212     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00213 
00214     HANDLE LocalHandle;
00215 
00216     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00217 
00218     PreviousMode = KeGetPreviousMode();
00219 
00220     <span class="comment">//</span>
00221     <span class="comment">//  Probe parameters</span>
00222     <span class="comment">//</span>
00223 
00224     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00225 
00226         <span class="keywordflow">try</span> {
00227 
00228             <a class="code" href="../../d5/d8/ex_8h.html#a35">ProbeForWriteHandle</a>(TokenHandle);
00229 
00230         } except(EXCEPTION_EXECUTE_HANDLER) {
00231             <span class="keywordflow">return</span> GetExceptionCode();
00232         }  <span class="comment">// end_try</span>
00233 
00234     } <span class="comment">//end_if</span>
00235 
00236 
00237     <span class="comment">//</span>
00238     <span class="comment">// Valdiate access to the process and obtain a pointer to the</span>
00239     <span class="comment">// process's token.  If successful, this will cause the token's</span>
00240     <span class="comment">// reference count to be incremented.</span>
00241     <span class="comment">//</span>
00242 
00243     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d5/ps_2security_8c.html#a4">PsOpenTokenOfProcess</a>( ProcessHandle, ((PACCESS_TOKEN *)&amp;Token));
00244 
00245     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00246         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00247     }
00248 
00249     <span class="comment">//</span>
00250     <span class="comment">//  Now try to open the token for the specified desired access</span>
00251     <span class="comment">//</span>
00252 
00253     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a3">ObOpenObjectByPointer</a>(
00254                  (PVOID)Token,         <span class="comment">// Object</span>
00255                  0,                    <span class="comment">// HandleAttributes</span>
00256                  NULL,                 <span class="comment">// AccessState</span>
00257                  DesiredAccess,        <span class="comment">// DesiredAccess</span>
00258                  SepTokenObjectType,   <span class="comment">// ObjectType</span>
00259                  PreviousMode,         <span class="comment">// AccessMode</span>
00260                  &amp;LocalHandle          <span class="comment">// Handle</span>
00261                  );
00262 
00263     <span class="comment">//</span>
00264     <span class="comment">//  And decrement the reference count of the token to counter</span>
00265     <span class="comment">//  the action performed by PsOpenTokenOfProcess().  If the open</span>
00266     <span class="comment">//  was successful, the handle will have caused the token's</span>
00267     <span class="comment">//  reference count to have been incremented.</span>
00268     <span class="comment">//</span>
00269 
00270     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00271 
00272     <span class="comment">//</span>
00273     <span class="comment">//  Return the new handle</span>
00274     <span class="comment">//</span>
00275 
00276     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00277 
00278         <span class="keywordflow">try</span> {
00279 
00280             *TokenHandle = LocalHandle;
00281 
00282         } except(EXCEPTION_EXECUTE_HANDLER) {
00283 
00284             <span class="keywordflow">return</span> GetExceptionCode();
00285 
00286         }
00287     }
00288 
00289     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00290 
00291 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="tokenopn.c::NtOpenThreadToken" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtOpenThreadToken           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ThreadHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>OpenAsSelf</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>TokenHandle</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d2/tokenopn_8c-source.html#l00458">458</a> of file <a class="el" href="../../d8/d2/tokenopn_8c-source.html">tokenopn.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d2/d0/obinsert_8c-source.html#l00029">ObInsertObject()</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00367">ObOpenObjectByPointer()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00126">PrimaryToken</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01564">ProbeForWriteHandle</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00810">PsDereferencePrimaryToken</a>, <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l00888">PsDisableImpersonation()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l00650">PsImpersonateClient()</a>, <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l00028">PsReferencePrimaryToken()</a>, <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l00990">PsRestoreImpersonation()</a>, <a class="el" href="../../d0/d8/ntos_8h-source.html#l00089">PsThreadType</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00038">PTOKEN</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01945">RtlCreateSecurityDescriptor()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l02543">RtlSetDaclSecurityDescriptor()</a>, <a class="el" href="../../d8/d2/tokenopn_8c-source.html#l00049">SepCreateImpersonationTokenDacl()</a>, <a class="el" href="../../d7/d2/tokendup_8c-source.html#l00362">SepDuplicateToken()</a>, <a class="el" href="../../d8/d2/tokenopn_8c-source.html#l00294">SepOpenTokenOfThread()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01212">SepTokenObjectType</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00138">ThreadHandle</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d9/server_2exitwin_8c-source.html#l02001">IsPrivileged()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00639">RtlAdjustPrivilege()</a>, <a class="el" href="../../d5/d7/seurtl_8c-source.html#l01860">RtlDefaultNpAcl()</a>, <a class="el" href="../../d5/d7/seurtl_8c-source.html#l00818">RtlNewSecurityGrantedAccess()</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00765">SepServerTestAnonymous()</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00831">SepServerTestIdentification()</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00893">SepServerTestImpersonation()</a>, <a class="el" href="../../d7/d3/msgbox_8c-source.html#l00178">ServiceMessageBox()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l07982">TestTokenImpersonation()</a>.
<p>
<pre class="fragment"><div>00468                    :
00469 
00470 Open a token object associated with a thread and <span class="keywordflow">return</span> a handle that
00471 may be used to access that token.
00472 
00473 Arguments:
00474 
00475     <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a> - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread whose token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be opened.
00476 
00477     DesiredAccess - Is an access mask indicating which access types
00478         are desired to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token.  These access types are reconciled
00479         with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Discretionary Access Control list of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token to
00480         determine whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> accesses will be granted or denied.
00481 
00482     OpenAsSelf - Is a <span class="keywordtype">boolean</span> value indicating whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access should
00483         be <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> <span class="keyword">using</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> calling thread's current security context, which
00484         may be that of a client <span class="keywordflow">if</span> impersonating, or <span class="keyword">using</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller's
00485         process-level security context.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00486         caller's current context should be used un-modified.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of
00487         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request should be fulfilled <span class="keyword">using</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process
00488         level security context.
00489 
00490         This parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> necessary to allow a server process to open
00491         a client's token when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client specified IDENTIFICATION level
00492         impersonation.  In <span class="keyword">this</span> <span class="keywordflow">case</span>, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller would not be able to
00493         open <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client's token <span class="keyword">using</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client's context (because you
00494         can't create executive level objects <span class="keyword">using</span> IDENTIFICATION level
00495         impersonation).
00496 
00497     TokenHandle - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> newly opened token.
00498 
00499 Return Value:
00500 
00501     STATUS_SUCCESS - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation was successful.
00502 
00503     STATUS_NO_TOKEN - Indicates an attempt has been <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> to open a
00504         token associated with a thread that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not currently
00505         impersonating a client.
00506 
00507     STATUS_CANT_OPEN_ANONYMOUS - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client requested anonymous
00508         impersonation level.  An anonymous token can not be openned.
00509 
00510 --*/
00511 {
00512 
00513     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00514     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00515 
00516     PVOID <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
00517     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> NewToken = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00518     BOOLEAN CopyOnOpen;
00519     BOOLEAN EffectiveOnly;
00520     SECURITY_IMPERSONATION_LEVEL ImpersonationLevel;
00521     SE_IMPERSONATION_STATE DisabledImpersonationState;
00522     BOOLEAN RestoreImpersonationState = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00523 
00524     HANDLE LocalHandle;
00525     SECURITY_DESCRIPTOR SecurityDescriptor;
00526     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
00527     PACL NewAcl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00528     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
00529     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> OriginalThread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00530     PACCESS_TOKEN <a class="code" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a>;
00531     <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">SECURITY_SUBJECT_CONTEXT</a> SubjectSecurityContext;
00532 
00533     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00534 
00535     PreviousMode = KeGetPreviousMode();
00536 
00537     <span class="comment">//</span>
00538     <span class="comment">//  Probe parameters</span>
00539     <span class="comment">//</span>
00540 
00541     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00542 
00543         <span class="keywordflow">try</span> {
00544 
00545             <a class="code" href="../../d5/d8/ex_8h.html#a35">ProbeForWriteHandle</a>(TokenHandle);
00546 
00547         } except(EXCEPTION_EXECUTE_HANDLER) {
00548             <span class="keywordflow">return</span> GetExceptionCode();
00549         }  <span class="comment">// end_try</span>
00550 
00551     } <span class="comment">//end_if</span>
00552 
00553     <span class="comment">//</span>
00554     <span class="comment">// Valdiate access to the thread and obtain a pointer to the</span>
00555     <span class="comment">// thread's token (if there is one).  If successful, this will</span>
00556     <span class="comment">// cause the token's reference count to be incremented.</span>
00557     <span class="comment">//</span>
00558     <span class="comment">// This routine disabled impersonation as necessary to properly</span>
00559     <span class="comment">// honor the OpenAsSelf flag.</span>
00560     <span class="comment">//</span>
00561 
00562     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d3/tokenopn_8c.html#a2">SepOpenTokenOfThread</a>( ThreadHandle,
00563                                   OpenAsSelf,
00564                                   ((PACCESS_TOKEN *)&amp;Token),
00565                                   &amp;OriginalThread,
00566                                   &amp;CopyOnOpen,
00567                                   &amp;EffectiveOnly,
00568                                   &amp;ImpersonationLevel
00569                                   );
00570 
00571     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00572         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00573     }
00574 
00575 
00576     <span class="comment">//</span>
00577     <span class="comment">//  The token was successfully referenced.</span>
00578     <span class="comment">//</span>
00579 
00580     <span class="comment">//</span>
00581     <span class="comment">// We need to create and/or open a token object, so disable impersonation</span>
00582     <span class="comment">// if necessary.</span>
00583     <span class="comment">//</span>
00584 
00585     <span class="keywordflow">if</span> (OpenAsSelf) {
00586          RestoreImpersonationState = <a class="code" href="../../d6/d5/ps_2security_8c.html#a7">PsDisableImpersonation</a>(
00587                                          <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>(),
00588                                          &amp;DisabledImpersonationState
00589                                          );
00590     }
00591 
00592     <span class="comment">//</span>
00593     <span class="comment">//  If the CopyOnOpen flag is not set, then the token can be</span>
00594     <span class="comment">//  opened directly.  Otherwise, the token must be duplicated,</span>
00595     <span class="comment">//  and a handle to the duplicate returned.</span>
00596     <span class="comment">//</span>
00597 
00598     <span class="keywordflow">if</span> (CopyOnOpen) {
00599 
00600         <span class="comment">//</span>
00601         <span class="comment">// Create the new security descriptor for the token.</span>
00602         <span class="comment">//</span>
00603         <span class="comment">// We must obtain the correct SID to put into the Dacl.  Do this</span>
00604         <span class="comment">// by finding the process associated with the passed thread</span>
00605         <span class="comment">// and grabbing the User SID out of that process's token.</span>
00606         <span class="comment">// If we just use the current SubjectContext, we'll get the</span>
00607         <span class="comment">// SID of whoever is calling us, which isn't what we want.</span>
00608         <span class="comment">//</span>
00609 
00610         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00611                      ThreadHandle,
00612                      THREAD_ALL_ACCESS,
00613                      PsThreadType,
00614                      KernelMode,
00615                      (PVOID)&amp;Thread,
00616                      NULL
00617                      );
00618 
00619         <span class="comment">//</span>
00620         <span class="comment">// Verify that the handle is still pointer to the same thread\</span>
00621         <span class="comment">// BUGBUG: wrong error code.</span>
00622         <span class="comment">//</span>
00623 
00624         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) &amp;&amp; (Thread != OriginalThread)) {
00625             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OBJECT_TYPE_MISMATCH;
00626         }
00627 
00628         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00629 
00630             <a class="code" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a> = <a class="code" href="../../d6/d5/ps_2security_8c.html#a0">PsReferencePrimaryToken</a>(Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o28">ThreadsProcess</a>);
00631 
00632             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d3/tokenopn_8c.html#a0">SepCreateImpersonationTokenDacl</a>(
00633                          (PTOKEN)Token,
00634                          PrimaryToken,
00635                          &amp;NewAcl
00636                          );
00637 
00638             <a class="code" href="../../d1/d9/ps_8h.html#a24">PsDereferencePrimaryToken</a>( PrimaryToken );
00639 
00640             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00641 
00642                 <span class="keywordflow">if</span> (NewAcl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00643 
00644                     <span class="comment">//</span>
00645                     <span class="comment">// There exist tokens that either do not have security descriptors at all,</span>
00646                     <span class="comment">// or have security descriptors, but do not have DACLs.  In either case, do</span>
00647                     <span class="comment">// nothing.</span>
00648                     <span class="comment">//</span>
00649 
00650                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a53">RtlCreateSecurityDescriptor</a> ( &amp;SecurityDescriptor, SECURITY_DESCRIPTOR_REVISION );
00651                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ));
00652 
00653                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a60">RtlSetDaclSecurityDescriptor</a> (
00654                                  &amp;SecurityDescriptor,
00655                                  TRUE,
00656                                  NewAcl,
00657                                  FALSE
00658                                  );
00659 
00660                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ));
00661                 }
00662 
00663                 InitializeObjectAttributes(
00664                     &amp;ObjectAttributes,
00665                     NULL,
00666                     0L,
00667                     NULL,
00668                     NewAcl == NULL ? NULL : &amp;SecurityDescriptor
00669                     );
00670 
00671                 <span class="comment">//</span>
00672                 <span class="comment">// Open a copy of the token</span>
00673                 <span class="comment">//</span>
00674 
00675                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d3/tokenp_8h.html#a27">SepDuplicateToken</a>(
00676                              (PTOKEN)Token,        <span class="comment">// ExistingToken</span>
00677                              &amp;ObjectAttributes,    <span class="comment">// ObjectAttributes</span>
00678                              EffectiveOnly,        <span class="comment">// EffectiveOnly</span>
00679                              TokenImpersonation,   <span class="comment">// TokenType</span>
00680                              ImpersonationLevel,   <span class="comment">// ImpersonationLevel</span>
00681                              KernelMode,           <span class="comment">// RequestorMode must be kernel mode</span>
00682                              &amp;NewToken
00683                              );
00684 
00685                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00686 
00687                     <span class="comment">//</span>
00688                     <span class="comment">// Reference the token so it doesn't go away</span>
00689                     <span class="comment">//</span>
00690 
00691                     <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(NewToken);
00692 
00693                     <span class="comment">//</span>
00694                     <span class="comment">//  Insert the new token</span>
00695                     <span class="comment">//</span>
00696 
00697                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d1/obinsert_8c.html#a0">ObInsertObject</a>( NewToken,
00698                                              NULL,
00699                                              DesiredAccess,
00700                                              0,
00701                                              (PVOID *)NULL,
00702                                              &amp;LocalHandle
00703                                              );
00704                 }
00705             }
00706         }
00707 
00708 
00709     } <span class="keywordflow">else</span> {
00710 
00711         <span class="comment">//</span>
00712         <span class="comment">// We do not have to modify the security on the token in the static case,</span>
00713         <span class="comment">// because in all the places in the system where impersonation takes place</span>
00714         <span class="comment">// over a secure transport (e.g., LPC), CopyOnOpen is set.  The only reason</span>
00715         <span class="comment">// we'be be here is if the impersonation is taking place because someone did</span>
00716         <span class="comment">// an NtSetInformationThread and passed in a token.</span>
00717         <span class="comment">//</span>
00718         <span class="comment">// In that case, we absolutely do not want to give the caller guaranteed</span>
00719         <span class="comment">// access, because that would allow anyone who has access to a thread to</span>
00720         <span class="comment">// impersonate any of that thread's clients for any access.</span>
00721         <span class="comment">//</span>
00722 
00723         <span class="comment">//</span>
00724         <span class="comment">//  Open the existing token</span>
00725         <span class="comment">//</span>
00726 
00727         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a3">ObOpenObjectByPointer</a>(
00728                      (PVOID)Token,         <span class="comment">// Object</span>
00729                      0,                    <span class="comment">// HandleAttributes</span>
00730                      NULL,                 <span class="comment">// AccessState</span>
00731                      DesiredAccess,        <span class="comment">// DesiredAccess</span>
00732                      SepTokenObjectType,   <span class="comment">// ObjectType</span>
00733                      PreviousMode,         <span class="comment">// AccessMode</span>
00734                      &amp;LocalHandle          <span class="comment">// Handle</span>
00735                      );
00736     }
00737 
00738     <span class="keywordflow">if</span> (NewAcl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00739         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( NewAcl );
00740     }
00741 
00742     <span class="keywordflow">if</span> (RestoreImpersonationState) {
00743         <a class="code" href="../../d6/d5/ps_2security_8c.html#a8">PsRestoreImpersonation</a>(
00744             <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>(),
00745             &amp;DisabledImpersonationState
00746             );
00747     }
00748 
00749     <span class="comment">//</span>
00750     <span class="comment">//  And decrement the reference count of the existing token to counter</span>
00751     <span class="comment">//  the action performed by PsOpenTokenOfThread.  If the open</span>
00752     <span class="comment">//  was successful, the handle will have caused the token's</span>
00753     <span class="comment">//  reference count to have been incremented.</span>
00754     <span class="comment">//</span>
00755 
00756     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Token );
00757 
00758     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) &amp;&amp; CopyOnOpen) {
00759 
00760         <span class="comment">//</span>
00761         <span class="comment">// Assign the newly duplicated token to the thread.</span>
00762         <span class="comment">//</span>
00763 
00764         <a class="code" href="../../d6/d5/ps_2security_8c.html#a6">PsImpersonateClient</a>( Thread,
00765                              NewToken,
00766                              FALSE,  <span class="comment">// turn off CopyOnOpen flag</span>
00767                              EffectiveOnly,
00768                              ImpersonationLevel
00769                              );
00770 
00771     }
00772 
00773     <span class="comment">//</span>
00774     <span class="comment">// We've impersonated the token so let go of oure reference</span>
00775     <span class="comment">//</span>
00776 
00777     <span class="keywordflow">if</span> (NewToken != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00778         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( NewToken );
00779     }
00780 
00781     <span class="keywordflow">if</span> (CopyOnOpen &amp;&amp; (Thread != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00782 
00783         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Thread );
00784     }
00785 
00786     <span class="keywordflow">if</span> (OriginalThread != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00787         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(OriginalThread);
00788     }
00789 
00790     <span class="comment">//</span>
00791     <span class="comment">//  Return the new handle</span>
00792     <span class="comment">//</span>
00793 
00794     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00795         <span class="keywordflow">try</span> { *TokenHandle = LocalHandle; }
00796             except(EXCEPTION_EXECUTE_HANDLER) { <span class="keywordflow">return</span> GetExceptionCode(); }
00797     }
00798 
00799     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00800 
00801 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="tokenopn.c::SepCreateImpersonationTokenDacl" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS SepCreateImpersonationTokenDacl           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d3/tokenp_8h.html#a15">PTOKEN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Token</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PACCESS_TOKEN&nbsp;</td>
          <td class="mdname" nowrap> <em>PrimaryToken</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PACL *&nbsp;</td>
          <td class="mdname" nowrap> <em>Acl</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d2/tokenopn_8c-source.html#l00049">49</a> of file <a class="el" href="../../d8/d2/tokenopn_8c-source.html">tokenopn.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00126">PrimaryToken</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00038">PTOKEN</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l01607">RtlAddAccessAllowedAce()</a>, <a class="el" href="../../d3/d3/acledit_8c-source.html#l00099">RtlCreateAcl()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01630">SeAliasAdminsSid</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00540">SeLengthSid</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01628">SeLocalSystemSid</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01631">SeRestrictedSid</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>.
<p>
Referenced by <a class="el" href="../../d8/d2/tokenopn_8c-source.html#l00458">NtOpenThreadToken()</a>.
<p>
<pre class="fragment"><div>00056                    :
00057 
00058     This routine modifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DACL protecting <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> passed token to allow
00059     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current user (described by the PrimaryToken parameter) full access.
00060     This permits callers of <a class="code" href="../../d7/d3/tokenopn_8c.html#a3">NtOpenThreadToken</a> to call with OpenAsSelf==<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
00061     and succeed.
00062 
00063     The <span class="keyword">new</span> DACL placed on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> token <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> as follows:
00064 
00065     ACE 0 - <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a> gets TOKEN_ALL_ACCESS
00066 
00067     ACE 1 - Client gets TOKEN_ALL_ACCESS
00068 
00069     ACE 2 - Admins gets TOKEN_ALL_ACCESS
00070 
00071     ACE 3 - System gets TOKEN_ALL_ACCESS
00072 
00073     ACE 4 - <a class="code" href="../../d6/d9/restrfil_8c.html#a5">Restricted</a> gets TOKEN_ALL_ACCESS
00074 
00075 
00076 Arguments:
00077 
00078     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> - The token whose protection <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be modified.
00079 
00080     <a class="code" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a> - <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> representing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subject to be granted access.
00081 
00082     Acl - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> modified ACL, allocated <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> of <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>.
00083 
00084 
00085 Return Value:
00086 
00087 
00088 --*/
00089 
00090 {
00091     PSID ServerUserSid;
00092     PSID ClientUserSid;
00093     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00094     ULONG AclLength;
00095     PACL NewDacl;
00096     PSECURITY_DESCRIPTOR OldDescriptor;
00097     BOOLEAN MemoryAllocated;
00098     PACL OldDacl;
00099     BOOLEAN DaclPresent;
00100     BOOLEAN DaclDefaulted;
00101 
00102     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00103 
00104     ServerUserSid = ((<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)<a class="code" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a>)-&gt;UserAndGroups[0].Sid;
00105 
00106     ClientUserSid = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroups[0].Sid;
00107 
00108     <span class="comment">//</span>
00109     <span class="comment">// Compute how much space we'll need for the new DACL.</span>
00110     <span class="comment">//</span>
00111 
00112     AclLength = 5 * <span class="keyword">sizeof</span>( ACCESS_ALLOWED_ACE ) - 5 * <span class="keyword">sizeof</span>( ULONG ) +
00113                 <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( ServerUserSid ) + <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( SeLocalSystemSid ) +
00114                 <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( ClientUserSid ) + <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( SeAliasAdminsSid ) +
00115                 <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( SeRestrictedSid ) + <span class="keyword">sizeof</span>( ACL );
00116 
00117     NewDacl = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( PagedPool, AclLength );
00118 
00119     <span class="keywordflow">if</span> (NewDacl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00120 
00121         *Acl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00122         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00123     }
00124 
00125     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a6">RtlCreateAcl</a>( NewDacl, AclLength, ACL_REVISION2 );
00126     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ));
00127 
00128     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a16">RtlAddAccessAllowedAce</a> (
00129                  NewDacl,
00130                  ACL_REVISION2,
00131                  TOKEN_ALL_ACCESS,
00132                  ServerUserSid
00133                  );
00134     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ));
00135 
00136     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a16">RtlAddAccessAllowedAce</a> (
00137                  NewDacl,
00138                  ACL_REVISION2,
00139                  TOKEN_ALL_ACCESS,
00140                  ClientUserSid
00141                  );
00142     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ));
00143 
00144     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a16">RtlAddAccessAllowedAce</a> (
00145                  NewDacl,
00146                  ACL_REVISION2,
00147                  TOKEN_ALL_ACCESS,
00148                  SeAliasAdminsSid
00149                  );
00150     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ));
00151 
00152     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a16">RtlAddAccessAllowedAce</a> (
00153                  NewDacl,
00154                  ACL_REVISION2,
00155                  TOKEN_ALL_ACCESS,
00156                  SeLocalSystemSid
00157                  );
00158     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ));
00159 
00160     <span class="keywordflow">if</span>(ARGUMENT_PRESENT(((PTOKEN)PrimaryToken)-&gt;RestrictedSids) ||
00161        ARGUMENT_PRESENT(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;RestrictedSids)) {
00162         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a16">RtlAddAccessAllowedAce</a> (
00163                      NewDacl,
00164                      ACL_REVISION2,
00165                      TOKEN_ALL_ACCESS,
00166                      SeRestrictedSid
00167                      );
00168         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ));
00169     }
00170 
00171     *Acl = NewDacl;
00172     <span class="keywordflow">return</span> STATUS_SUCCESS;
00173 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="tokenopn.c::SepOpenTokenOfThread" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS SepOpenTokenOfThread           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ThreadHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>OpenAsSelf</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PACCESS_TOKEN *&nbsp;</td>
          <td class="mdname" nowrap> <em>Token</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>Thread</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>CopyOnOpen</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>EffectiveOnly</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PSECURITY_IMPERSONATION_LEVEL&nbsp;</td>
          <td class="mdname" nowrap> <em>ImpersonationLevel</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d2/tokenopn_8c-source.html#l00294">294</a> of file <a class="el" href="../../d8/d2/tokenopn_8c-source.html">tokenopn.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00840">PsDereferenceImpersonationToken</a>, <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l00888">PsDisableImpersonation()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l00097">PsReferenceImpersonationToken()</a>, <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l00990">PsRestoreImpersonation()</a>, <a class="el" href="../../d0/d8/ntos_8h-source.html#l00089">PsThreadType</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00138">ThreadHandle</a>, and <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>.
<p>
Referenced by <a class="el" href="../../d8/d2/tokenopn_8c-source.html#l00458">NtOpenThreadToken()</a>.
<p>
<pre class="fragment"><div>00306                    :
00307 
00308     This function does <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread specific processing of
00309     an <a class="code" href="../../d7/d3/tokenopn_8c.html#a3">NtOpenThreadToken</a>() service.
00310 
00311     The service validates that the handle has appropriate access
00312     to reference the thread.  If so, it goes on to increment
00313     the reference count of the token object to prevent it from
00314     going away while the rest of the NtOpenThreadToken() request
00315     is processed.
00316 
00317     NOTE: If this call completes successfully, the caller is responsible
00318           for decrementing the reference count of the target token.
00319           This must be done using PsDereferenceImpersonationToken().
00320 
00321 Arguments:
00322 
00323     ThreadHandle - Supplies a handle to a thread object.
00324 
00325     OpenAsSelf - Is a <span class="keywordtype">boolean</span> value indicating whether the access should
00326         be made using the calling thread's current security context, which
00327         may be that of a client (if impersonating), or using the caller's
00328         process-level security context.  A value of FALSE indicates the
00329         caller's current context should be used un-modified.  A value of
00330         TRUE indicates the request should be fulfilled using the process
00331         level security context.
00332 
00333     Token - If successful, receives a pointer to the thread's token
00334         object.
00335 
00336     CopyOnOpen - The current value of the Thread-&gt;Client-&gt;CopyOnOpen field.
00337 
00338     EffectiveOnly - The current value of the Thread-&gt;Client-&gt;EffectiveOnly field.
00339 
00340     ImpersonationLevel - The current value of the Thread-&gt;Client-&gt;ImpersonationLevel
00341         field.
00342 
00343 Return Value:
00344 
00345     STATUS_SUCCESS - Indicates the call completed successfully.
00346 
00347     STATUS_NO_TOKEN - Indicates the referenced thread is not currently
00348         impersonating a client.
00349 
00350     STATUS_CANT_OPEN_ANONYMOUS - Indicates the client requested anonymous
00351         impersonation level.  An anonymous token can not be openned.
00352 
00353     status may also be any value returned by an attemp the reference
00354     the thread object for THREAD_QUERY_INFORMATION access.
00355 
00356 --*/
00357 
00358 {
00359 
00360     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00361         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00362 
00363     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>
00364         PreviousMode;
00365 
00366     SE_IMPERSONATION_STATE
00367         DisabledImpersonationState;
00368 
00369     BOOLEAN
00370         RestoreImpersonationState = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00371 
00372     PreviousMode = KeGetPreviousMode();
00373 
00374 
00375     <span class="comment">//</span>
00376     <span class="comment">// Disable impersonation if necessary</span>
00377     <span class="comment">//</span>
00378 
00379     <span class="keywordflow">if</span> (OpenAsSelf) {
00380          RestoreImpersonationState = <a class="code" href="../../d6/d5/ps_2security_8c.html#a7">PsDisableImpersonation</a>(
00381                                          <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>(),
00382                                          &amp;DisabledImpersonationState
00383                                          );
00384     }
00385 
00386     <span class="comment">//</span>
00387     <span class="comment">//  Make sure the handle grants the appropriate access to the specified</span>
00388     <span class="comment">//  thread.</span>
00389     <span class="comment">//</span>
00390 
00391     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00392                  ThreadHandle,
00393                  THREAD_QUERY_INFORMATION,
00394                  PsThreadType,
00395                  PreviousMode,
00396                  (PVOID *)Thread,
00397                  NULL
00398                  );
00399 
00400 
00401 
00402 
00403     <span class="keywordflow">if</span> (RestoreImpersonationState) {
00404         <a class="code" href="../../d6/d5/ps_2security_8c.html#a8">PsRestoreImpersonation</a>(
00405             <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>(),
00406             &amp;DisabledImpersonationState
00407             );
00408     }
00409 
00410     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00411         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00412     }
00413 
00414     <span class="comment">//</span>
00415     <span class="comment">//  Reference the impersonation token, if there is one</span>
00416     <span class="comment">//</span>
00417 
00418     (*Token) = <a class="code" href="../../d6/d5/ps_2security_8c.html#a1">PsReferenceImpersonationToken</a>( *Thread,
00419                                               CopyOnOpen,
00420                                               EffectiveOnly,
00421                                               ImpersonationLevel
00422                                               );
00423 
00424 
00425 
00426 
00427     <span class="comment">//</span>
00428     <span class="comment">// Make sure there is a token</span>
00429     <span class="comment">//</span>
00430 
00431     <span class="keywordflow">if</span> ((*Token) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00432         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( *Thread );
00433         (*Thread) = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00434         <span class="keywordflow">return</span> STATUS_NO_TOKEN;
00435     }
00436 
00437 
00438     <span class="comment">//</span>
00439     <span class="comment">//  Make sure the ImpersonationLevel is high enough to allow</span>
00440     <span class="comment">//  the token to be openned.</span>
00441     <span class="comment">//</span>
00442 
00443     <span class="keywordflow">if</span> ((*ImpersonationLevel) &lt;= SecurityAnonymous) {
00444         <a class="code" href="../../d1/d9/ps_8h.html#a26">PsDereferenceImpersonationToken</a>( (*Token) );
00445         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( *Thread );
00446         (*Thread) = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00447         (*Token) = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00448         <span class="keywordflow">return</span> STATUS_CANT_OPEN_ANONYMOUS;
00449     }
00450 
00451 
00452     <span class="keywordflow">return</span> STATUS_SUCCESS;
00453 
00454 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:47 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
