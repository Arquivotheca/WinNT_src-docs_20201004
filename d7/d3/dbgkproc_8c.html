<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: dbgkproc.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>dbgkproc.c File Reference</h1><code>#include "<a class="el" href="../../d6/d2/dbgkp_8h-source.html">dbgkp.h</a>"</code><br>

<p>
<a href="../../d8/d2/dbgkproc_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d3/dbgkproc_8c.html#a0">DbgkpSuspendProcess</a> (IN BOOLEAN CreateDeleteLockHeld)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d3/dbgkproc_8c.html#a1">DbgkpResumeProcess</a> (IN BOOLEAN CreateDeleteLockHeld)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>HANDLE&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d3/dbgkproc_8c.html#a2">DbgkpSectionHandleToFileHandle</a> (IN HANDLE SectionHandle)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d3/dbgkproc_8c.html#a3">DbgkCreateThread</a> (PVOID StartAddress)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d3/dbgkproc_8c.html#a4">DbgkExitThread</a> (NTSTATUS ExitStatus)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d3/dbgkproc_8c.html#a5">DbgkExitProcess</a> (NTSTATUS ExitStatus)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d3/dbgkproc_8c.html#a6">DbgkMapViewOfSection</a> (IN HANDLE SectionHandle, IN PVOID BaseAddress, IN ULONG SectionOffset, IN ULONG_PTR ViewSize)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d3/dbgkproc_8c.html#a7">DbgkUnMapViewOfSection</a> (IN PVOID BaseAddress)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a3" doxytag="dbgkproc.c::DbgkCreateThread" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID DbgkCreateThread           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>StartAddress</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d2/dbgkproc_8c-source.html#l00211">211</a> of file <a class="el" href="../../d8/d2/dbgkproc_8c-source.html">dbgkproc.c</a>.
<p>
References <a class="el" href="../../d2/d8/ps_8h-source.html#l00239">_EPROCESS::CreateProcessReported</a>, <a class="el" href="../../d8/d2/dbgkproc_8c-source.html#l00136">DbgkpSectionHandleToFileHandle()</a>, <a class="el" href="../../d7/d2/dbgkport_8c-source.html#l00031">DbgkpSendApiMessage()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00431">_ETHREAD::DeadThread</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00199">_EPROCESS::DebugPort</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d1/rtload_8c-source.html#l00047">FileName</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00769">IMAGE_ADDRESSING_MODE_32BIT</a>, <a class="el" href="../../d1/d9/ps_8h.html#a69">IMAGE_INFO</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00757">_IMAGE_INFO::ImageAddressingMode</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00763">_IMAGE_INFO::ImageBase</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00766">_IMAGE_INFO::ImageSectionNumber</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00764">_IMAGE_INFO::ImageSelector</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00765">_IMAGE_INFO::ImageSize</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l01721">MmGetFileNameForSection()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00166">_EPROCESS::Pcb</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00755">_IMAGE_INFO::Properties</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l02396">PsCallImageNotifyRoutines()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00880">PsImageNotifyEnabled</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l01966">PsLockProcess()</a>, <a class="el" href="../../d1/d9/ps_8h.html#a155a91">PsLockWaitForever</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00576">PsNtDllPathName</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00577">PsSystemDllBase</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l02250">PsUnlockProcess()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00082">RtlAnsiStringToUnicodeString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01215">RtlFreeUnicodeString()</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00029">RtlImageNtHeader()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00247">_EPROCESS::SectionBaseAddress</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00240">_EPROCESS::SectionHandle</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00174">_EPROCESS::UniqueProcessId</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00756">_KPROCESS::UserTime</a>, and <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00582">ZwOpenFile()</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l01800">PspUserThreadStartup()</a>.
<p>
<pre class="fragment"><div>00217                    :
00218 
00219     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called when a <span class="keyword">new</span> thread begins to execute. If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00220     thread has an associated <a class="code" href="../../d8/d7/udbgk_8c.html#a0">DebugPort</a>, then a message <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> sent thru <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00221     port.
00222 
00223     If <span class="keyword">this</span> thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first thread in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process, then <span class="keyword">this</span> event
00224     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> translated into a CreateProcessInfo message.
00225 
00226     If a message <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> sent, then <span class="keywordflow">while</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> awaiting a reply,
00227     all other threads in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process are suspended.
00228 
00229 Arguments:
00230 
00231     StartAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> start address <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00232         starting.
00233 
00234 Return Value:
00235 
00236     None.
00237 
00238 --*/
00239 
00240 {
00241     PVOID Port;
00242     DBGKM_APIMSG m;
00243     PDBGKM_CREATE_THREAD CreateThreadArgs;
00244     PDBGKM_CREATE_PROCESS CreateProcessArgs;
00245     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
00246     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
00247     PDBGKM_LOAD_DLL LoadDllArgs;
00248     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00249     OBJECT_ATTRIBUTES Obja;
00250     IO_STATUS_BLOCK IoStatusBlock;
00251     PIMAGE_NT_HEADERS NtHeaders;
00252 
00253     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00254 
00255     Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
00256 
00257     Port = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;HideFromDebugger ? <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> : Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o18">DebugPort</a>;
00258 
00259     <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d9/ps_8h.html#a72">PsImageNotifyEnabled</a> &amp;&amp; !Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>.<a class="code" href="../../d5/d7/struct__KPROCESS.html#o5">UserTime</a>) {
00260         <a class="code" href="../../d2/d1/struct__IMAGE__INFO.html">IMAGE_INFO</a> ImageInfo;
00261         PIMAGE_NT_HEADERS NtHeaders;
00262         ANSI_STRING <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>;
00263         UNICODE_STRING UnicodeFileName;
00264         PUNICODE_STRING pUnicodeFileName;
00265 
00266         <span class="comment">//</span>
00267         <span class="comment">// notification of main .exe</span>
00268         <span class="comment">//</span>
00269         ImageInfo.<a class="code" href="../../d2/d1/struct__IMAGE__INFO.html#o0">Properties</a> = 0;
00270         ImageInfo.<a class="code" href="../../d2/d1/struct__IMAGE__INFO.html#o1">ImageAddressingMode</a> = <a class="code" href="../../d1/d9/ps_8h.html#a23">IMAGE_ADDRESSING_MODE_32BIT</a>;
00271         ImageInfo.<a class="code" href="../../d2/d1/struct__IMAGE__INFO.html#o5">ImageBase</a> = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o48">SectionBaseAddress</a>;
00272         ImageInfo.<a class="code" href="../../d2/d1/struct__IMAGE__INFO.html#o7">ImageSize</a> = 0;
00273 
00274         <span class="keywordflow">try</span> {
00275             NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o48">SectionBaseAddress</a>);
00276     
00277             <span class="keywordflow">if</span> ( NtHeaders ) {
00278                 ImageInfo.<a class="code" href="../../d2/d1/struct__IMAGE__INFO.html#o7">ImageSize</a> = NtHeaders-&gt;OptionalHeader.SizeOfImage;
00279                 }
00280             }
00281         except(EXCEPTION_EXECUTE_HANDLER) {
00282             ImageInfo.<a class="code" href="../../d2/d1/struct__IMAGE__INFO.html#o7">ImageSize</a> = 0;
00283         }
00284         ImageInfo.<a class="code" href="../../d2/d1/struct__IMAGE__INFO.html#o6">ImageSelector</a> = 0;
00285         ImageInfo.<a class="code" href="../../d2/d1/struct__IMAGE__INFO.html#o8">ImageSectionNumber</a> = 0;
00286 
00287         pUnicodeFileName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00288         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d5/sectsup_8c.html#a23">MmGetFileNameForSection</a>(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o46">SectionHandle</a>, (PSTRING)&amp;FileName);
00289         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
00290             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;UnicodeFileName,&amp;FileName,TRUE);
00291             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>.Buffer);
00292             <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
00293                 pUnicodeFileName = &amp;UnicodeFileName;
00294                 }
00295             }
00296         <a class="code" href="../../d2/d8/ps_2create_8c.html#a28">PsCallImageNotifyRoutines</a>(
00297                     pUnicodeFileName,
00298                     Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o7">UniqueProcessId</a>,
00299                     &amp;ImageInfo
00300                     );
00301         <span class="keywordflow">if</span> ( pUnicodeFileName ) {
00302             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(pUnicodeFileName);
00303             }
00304 
00305         <span class="comment">//</span>
00306         <span class="comment">// and of ntdll.dll</span>
00307         <span class="comment">//</span>
00308         ImageInfo.<a class="code" href="../../d2/d1/struct__IMAGE__INFO.html#o0">Properties</a> = 0;
00309         ImageInfo.<a class="code" href="../../d2/d1/struct__IMAGE__INFO.html#o1">ImageAddressingMode</a> = <a class="code" href="../../d1/d9/ps_8h.html#a23">IMAGE_ADDRESSING_MODE_32BIT</a>;
00310         ImageInfo.<a class="code" href="../../d2/d1/struct__IMAGE__INFO.html#o5">ImageBase</a> = <a class="code" href="../../d1/d9/ps_8h.html#a51">PsSystemDllBase</a>;
00311         ImageInfo.<a class="code" href="../../d2/d1/struct__IMAGE__INFO.html#o7">ImageSize</a> = 0;
00312 
00313         <span class="keywordflow">try</span> {
00314             NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(PsSystemDllBase);
00315             <span class="keywordflow">if</span> ( NtHeaders ) {
00316                 ImageInfo.<a class="code" href="../../d2/d1/struct__IMAGE__INFO.html#o7">ImageSize</a> = NtHeaders-&gt;OptionalHeader.SizeOfImage;
00317                 }
00318             }
00319         except(EXCEPTION_EXECUTE_HANDLER) {
00320             ImageInfo.<a class="code" href="../../d2/d1/struct__IMAGE__INFO.html#o7">ImageSize</a> = 0;
00321             }
00322 
00323         ImageInfo.<a class="code" href="../../d2/d1/struct__IMAGE__INFO.html#o6">ImageSelector</a> = 0;
00324         ImageInfo.<a class="code" href="../../d2/d1/struct__IMAGE__INFO.html#o8">ImageSectionNumber</a> = 0;
00325 
00326         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeFileName,L<span class="stringliteral">"\\SystemRoot\\System32\\ntdll.dll"</span>);
00327         <a class="code" href="../../d2/d8/ps_2create_8c.html#a28">PsCallImageNotifyRoutines</a>(
00328                     &amp;UnicodeFileName,
00329                     Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o7">UniqueProcessId</a>,
00330                     &amp;ImageInfo
00331                     );
00332         }
00333 
00334 
00335     <span class="keywordflow">if</span> ( !Port ) {
00336 
00337         <span class="keywordflow">return</span>;
00338     }
00339 
00340     Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00341 
00342     <span class="keywordflow">if</span> ( Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o24">DeadThread</a> ) {
00343         <span class="keywordflow">return</span>;
00344     }
00345 
00346     <span class="comment">//</span>
00347     <span class="comment">// To determine if this should be turned into a create process,</span>
00348     <span class="comment">// all threads in the process are suspended. The process list</span>
00349     <span class="comment">// is then examined to see if the curent thread is the only thread</span>
00350     <span class="comment">// on the list. If so, this becomes a create process message</span>
00351     <span class="comment">//</span>
00352 
00353     <a class="code" href="../../d2/d8/ps_2create_8c.html#a22">PsLockProcess</a>(Process,KernelMode,PsLockWaitForever);
00354 
00355     <span class="comment">//</span>
00356     <span class="comment">// If we are doing a debug attach, then the create process has</span>
00357     <span class="comment">// already occured. If this is the case, then the process has</span>
00358     <span class="comment">// accumulated some time, so set reported to true</span>
00359     <span class="comment">//</span>
00360 
00361     <span class="keywordflow">if</span> ( Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>.<a class="code" href="../../d5/d7/struct__KPROCESS.html#o5">UserTime</a> ) {
00362         Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o45">CreateProcessReported</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00363         }
00364 
00365     <span class="keywordflow">if</span> ( Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o45">CreateProcessReported</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ) {
00366 
00367         <span class="comment">//</span>
00368         <span class="comment">// This is a create process</span>
00369         <span class="comment">//</span>
00370 
00371         Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o45">CreateProcessReported</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00372 
00373         CreateThreadArgs = &amp;m.u.CreateProcessInfo.InitialThread;
00374         CreateThreadArgs-&gt;SubSystemKey = 0;
00375 
00376         CreateProcessArgs = &amp;m.u.CreateProcessInfo;
00377         CreateProcessArgs-&gt;SubSystemKey = 0;
00378         CreateProcessArgs-&gt;FileHandle = <a class="code" href="../../d7/d3/dbgkproc_8c.html#a2">DbgkpSectionHandleToFileHandle</a>(
00379                                             Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o46">SectionHandle</a>
00380                                             );
00381         CreateProcessArgs-&gt;BaseOfImage = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o48">SectionBaseAddress</a>;
00382         CreateThreadArgs-&gt;StartAddress = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00383         CreateProcessArgs-&gt;DebugInfoFileOffset = 0;
00384         CreateProcessArgs-&gt;DebugInfoSize = 0;
00385 
00386         <span class="keywordflow">try</span> {
00387             NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o48">SectionBaseAddress</a>);
00388             <span class="keywordflow">if</span> ( NtHeaders ) {
00389                 CreateThreadArgs-&gt;StartAddress = (PVOID)(
00390                     NtHeaders-&gt;OptionalHeader.ImageBase +
00391                     NtHeaders-&gt;OptionalHeader.AddressOfEntryPoint);
00392 
00393                 CreateProcessArgs-&gt;DebugInfoFileOffset = NtHeaders-&gt;FileHeader.PointerToSymbolTable;
00394                 CreateProcessArgs-&gt;DebugInfoSize = NtHeaders-&gt;FileHeader.NumberOfSymbols;
00395                 }
00396             }
00397         except(EXCEPTION_EXECUTE_HANDLER) {
00398             CreateThreadArgs-&gt;StartAddress = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00399             CreateProcessArgs-&gt;DebugInfoFileOffset = 0;
00400             CreateProcessArgs-&gt;DebugInfoSize = 0;
00401         }
00402 
00403         DBGKM_FORMAT_API_MSG(m,DbgKmCreateProcessApi,<span class="keyword">sizeof</span>(*CreateProcessArgs));
00404 
00405         <a class="code" href="../../d2/d8/ps_2create_8c.html#a23">PsUnlockProcess</a>(Process);
00406 
00407         <a class="code" href="../../d6/d3/dbgkport_8c.html#a1">DbgkpSendApiMessage</a>(&amp;m,Port,FALSE);
00408         ZwClose(CreateProcessArgs-&gt;FileHandle);
00409 
00410         LoadDllArgs = &amp;m.u.LoadDll;
00411         LoadDllArgs-&gt;BaseOfDll = <a class="code" href="../../d1/d9/ps_8h.html#a51">PsSystemDllBase</a>;
00412         LoadDllArgs-&gt;DebugInfoFileOffset = 0;
00413         LoadDllArgs-&gt;DebugInfoSize = 0;
00414 
00415         <span class="keywordflow">try</span> {
00416             NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(PsSystemDllBase);
00417             <span class="keywordflow">if</span> ( NtHeaders ) {
00418                 LoadDllArgs-&gt;DebugInfoFileOffset = NtHeaders-&gt;FileHeader.PointerToSymbolTable;
00419                 LoadDllArgs-&gt;DebugInfoSize = NtHeaders-&gt;FileHeader.NumberOfSymbols;
00420                 }
00421             }
00422         except(EXCEPTION_EXECUTE_HANDLER) {
00423             LoadDllArgs-&gt;DebugInfoFileOffset = 0;
00424             LoadDllArgs-&gt;DebugInfoSize = 0;
00425         }
00426 
00427         <span class="comment">//</span>
00428         <span class="comment">// Send load dll section for NT dll !</span>
00429         <span class="comment">//</span>
00430 
00431         InitializeObjectAttributes(
00432             &amp;Obja,
00433             &amp;PsNtDllPathName,
00434             OBJ_CASE_INSENSITIVE,
00435             NULL,
00436             NULL
00437             );
00438 
00439         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a33">ZwOpenFile</a>(
00440                     &amp;LoadDllArgs-&gt;FileHandle,
00441                     (ACCESS_MASK)(GENERIC_READ | SYNCHRONIZE),
00442                     &amp;Obja,
00443                     &amp;IoStatusBlock,
00444                     FILE_SHARE_DELETE | FILE_SHARE_READ | FILE_SHARE_WRITE,
00445                     FILE_SYNCHRONOUS_IO_NONALERT
00446                     );
00447 
00448         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
00449             DBGKM_FORMAT_API_MSG(m,DbgKmLoadDllApi,<span class="keyword">sizeof</span>(*LoadDllArgs));
00450             <a class="code" href="../../d6/d3/dbgkport_8c.html#a1">DbgkpSendApiMessage</a>(&amp;m,Port,TRUE);
00451         }
00452         ZwClose(LoadDllArgs-&gt;FileHandle);
00453 
00454     } <span class="keywordflow">else</span> {
00455 
00456         CreateThreadArgs = &amp;m.u.CreateThread;
00457         CreateThreadArgs-&gt;SubSystemKey = 0;
00458         CreateThreadArgs-&gt;StartAddress = StartAddress;
00459 
00460         DBGKM_FORMAT_API_MSG(m,DbgKmCreateThreadApi,<span class="keyword">sizeof</span>(*CreateThreadArgs));
00461 
00462         <a class="code" href="../../d2/d8/ps_2create_8c.html#a23">PsUnlockProcess</a>(Process);
00463 
00464         <a class="code" href="../../d6/d3/dbgkport_8c.html#a1">DbgkpSendApiMessage</a>(&amp;m,Port,TRUE);
00465     }
00466 
00467 
00468 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="dbgkproc.c::DbgkExitProcess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID DbgkExitProcess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">NTSTATUS&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ExitStatus</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d2/dbgkproc_8c-source.html#l00528">528</a> of file <a class="el" href="../../d8/d2/dbgkproc_8c-source.html">dbgkproc.c</a>.
<p>
References <a class="el" href="../../d7/d2/dbgkport_8c-source.html#l00031">DbgkpSendApiMessage()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00199">_EPROCESS::DebugPort</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l00153">KeQuerySystemTime()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, and <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00690">PspExitThread()</a>.
<p>
<pre class="fragment"><div>00534                    :
00535 
00536     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called when a process terminates. The address
00537     space of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> still intact, but no threads exist in
00538     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process.
00539 
00540 Arguments:
00541 
00542     ExitStatus - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ExitStatus of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exiting process.
00543 
00544 Return Value:
00545 
00546     None.
00547 
00548 --*/
00549 
00550 {
00551     PVOID Port;
00552     DBGKM_APIMSG m;
00553     PDBGKM_EXIT_PROCESS args;
00554     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
00555 
00556     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00557 
00558     Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
00559     Port = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;HideFromDebugger ? <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> : Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o18">DebugPort</a>;
00560 
00561     <span class="keywordflow">if</span> ( !Port ) {
00562         <span class="keywordflow">return</span>;
00563     }
00564 
00565     <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;DeadThread ) {
00566         <span class="keywordflow">return</span>;
00567     }
00568 
00569     <span class="comment">//</span>
00570     <span class="comment">// this ensures that other timed lockers of the process will bail</span>
00571     <span class="comment">// since this call is done while holding the process lock, and lock duration</span>
00572     <span class="comment">// is controlled by debugger</span>
00573     <span class="comment">//</span>
00574     <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a>(&amp;<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;ExitTime);
00575 
00576     args = &amp;m.u.ExitProcess;
00577     args-&gt;ExitStatus = ExitStatus;
00578 
00579     DBGKM_FORMAT_API_MSG(m,DbgKmExitProcessApi,<span class="keyword">sizeof</span>(*args));
00580 
00581     <a class="code" href="../../d6/d3/dbgkport_8c.html#a1">DbgkpSendApiMessage</a>(&amp;m,Port,FALSE);
00582 
00583 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="dbgkproc.c::DbgkExitThread" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID DbgkExitThread           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">NTSTATUS&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ExitStatus</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d2/dbgkproc_8c-source.html#l00471">471</a> of file <a class="el" href="../../d8/d2/dbgkproc_8c-source.html">dbgkproc.c</a>.
<p>
References <a class="el" href="../../d8/d2/dbgkproc_8c-source.html#l00086">DbgkpResumeProcess()</a>, <a class="el" href="../../d7/d2/dbgkport_8c-source.html#l00031">DbgkpSendApiMessage()</a>, <a class="el" href="../../d8/d2/dbgkproc_8c-source.html#l00036">DbgkpSuspendProcess()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00199">_EPROCESS::DebugPort</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00690">PspExitThread()</a>.
<p>
<pre class="fragment"><div>00477                    :
00478 
00479     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called when a <span class="keyword">new</span> thread terminates. At <span class="keyword">this</span>
00480     point, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread will no longer execute in user-mode. No other
00481     <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a> processing has occured.
00482 
00483     If a message <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> sent, then <span class="keywordflow">while</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> awaiting a reply,
00484     all other threads in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process are suspended.
00485 
00486 Arguments:
00487 
00488     ExitStatus - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ExitStatus of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exiting thread.
00489 
00490 Return Value:
00491 
00492     None.
00493 
00494 --*/
00495 
00496 {
00497     PVOID Port;
00498     DBGKM_APIMSG m;
00499     PDBGKM_EXIT_THREAD args;
00500     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
00501 
00502     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00503 
00504     Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
00505     Port = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;HideFromDebugger ? <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> : Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o18">DebugPort</a>;
00506 
00507     <span class="keywordflow">if</span> ( !Port ) {
00508         <span class="keywordflow">return</span>;
00509     }
00510 
00511     <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;DeadThread ) {
00512         <span class="keywordflow">return</span>;
00513     }
00514 
00515     args = &amp;m.u.ExitThread;
00516     args-&gt;ExitStatus = ExitStatus;
00517 
00518     DBGKM_FORMAT_API_MSG(m,DbgKmExitThreadApi,<span class="keyword">sizeof</span>(*args));
00519 
00520     <a class="code" href="../../d7/d3/dbgkproc_8c.html#a0">DbgkpSuspendProcess</a>(TRUE);
00521 
00522     <a class="code" href="../../d6/d3/dbgkport_8c.html#a1">DbgkpSendApiMessage</a>(&amp;m,Port,FALSE);
00523 
00524     <a class="code" href="../../d7/d3/dbgkproc_8c.html#a1">DbgkpResumeProcess</a>(TRUE);
00525 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="dbgkproc.c::DbgkMapViewOfSection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID DbgkMapViewOfSection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>SectionHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>BaseAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SectionOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>ViewSize</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d2/dbgkproc_8c-source.html#l00586">586</a> of file <a class="el" href="../../d8/d2/dbgkproc_8c-source.html">dbgkproc.c</a>.
<p>
References <a class="el" href="../../d8/d2/dbgkproc_8c-source.html#l00136">DbgkpSectionHandleToFileHandle()</a>, <a class="el" href="../../d7/d2/dbgkport_8c-source.html#l00031">DbgkpSendApiMessage()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00199">_EPROCESS::DebugPort</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00029">RtlImageNtHeader()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d4/d4/mapview_8c-source.html#l00199">NtMapViewOfSection()</a>.
<p>
<pre class="fragment"><div>00595                    :
00596 
00597     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current process successfully
00598     maps a view of an image section. If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process has an associated
00599     debug port, then a load dll message <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> sent.
00600 
00601 Arguments:
00602 
00603     SectionHandle - Supplies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section mapped by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00604         process.
00605 
00606     BaseAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base address of where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00607         mapped in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current process address space.
00608 
00609     SectionOffset - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> offset in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00610         processes mapped view begins.
00611 
00612     ViewSize - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mapped view.
00613 
00614 Return Value:
00615 
00616     None.
00617 
00618 --*/
00619 
00620 {
00621 
00622     PVOID Port;
00623     DBGKM_APIMSG m;
00624     PDBGKM_LOAD_DLL LoadDllArgs;
00625     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
00626     PIMAGE_NT_HEADERS NtHeaders;
00627 
00628     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00629 
00630     Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
00631 
00632     Port = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;HideFromDebugger ? <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> : Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o18">DebugPort</a>;
00633 
00634     <span class="keywordflow">if</span> ( !Port || KeGetPreviousMode() == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a> ) {
00635         <span class="keywordflow">return</span>;
00636     }
00637 
00638     LoadDllArgs = &amp;m.u.LoadDll;
00639     LoadDllArgs-&gt;FileHandle = <a class="code" href="../../d7/d3/dbgkproc_8c.html#a2">DbgkpSectionHandleToFileHandle</a>(SectionHandle);
00640     LoadDllArgs-&gt;BaseOfDll = BaseAddress;
00641     LoadDllArgs-&gt;DebugInfoFileOffset = 0;
00642     LoadDllArgs-&gt;DebugInfoSize = 0;
00643 
00644     <span class="keywordflow">try</span> {
00645         NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(BaseAddress);
00646         <span class="keywordflow">if</span> ( NtHeaders ) {
00647             LoadDllArgs-&gt;DebugInfoFileOffset = NtHeaders-&gt;FileHeader.PointerToSymbolTable;
00648             LoadDllArgs-&gt;DebugInfoSize = NtHeaders-&gt;FileHeader.NumberOfSymbols;
00649             }
00650         }
00651     except(EXCEPTION_EXECUTE_HANDLER) {
00652         LoadDllArgs-&gt;DebugInfoFileOffset = 0;
00653         LoadDllArgs-&gt;DebugInfoSize = 0;
00654     }
00655 
00656     DBGKM_FORMAT_API_MSG(m,DbgKmLoadDllApi,<span class="keyword">sizeof</span>(*LoadDllArgs));
00657 
00658     <a class="code" href="../../d6/d3/dbgkport_8c.html#a1">DbgkpSendApiMessage</a>(&amp;m,Port,TRUE);
00659     ZwClose(LoadDllArgs-&gt;FileHandle);
00660 
00661 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="dbgkproc.c::DbgkpResumeProcess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID DbgkpResumeProcess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN BOOLEAN&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>CreateDeleteLockHeld</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d2/dbgkproc_8c-source.html#l00086">86</a> of file <a class="el" href="../../d8/d2/dbgkproc_8c-source.html">dbgkproc.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d0/d1/thredobj_8c-source.html#l02190">KeThawAllThreads()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l01966">PsLockProcess()</a>, <a class="el" href="../../d1/d9/ps_8h.html#a155a91">PsLockWaitForever</a>, and <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l02250">PsUnlockProcess()</a>.
<p>
Referenced by <a class="el" href="../../d8/d2/dbgkproc_8c-source.html#l00471">DbgkExitThread()</a>, and <a class="el" href="../../d7/d2/dbgkport_8c-source.html#l00031">DbgkpSendApiMessage()</a>.
<p>
<pre class="fragment"><div>00092                    :
00093 
00094     This function causes all threads in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> calling process except <span class="keywordflow">for</span>
00095     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> calling thread to resume.
00096 
00097 Arguments:
00098 
00099     CreateDeleteLockHeld - Supplies a flag that specifies whether or not
00100         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> holding <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process create <span class="keyword">delete</span> lock.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00101         caller holds <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lock, than <span class="keyword">this</span> function will not aquire <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00102         lock before suspending <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process.
00103 
00104 Return Value:
00105 
00106     None.
00107 
00108 --*/
00109 
00110 {
00111 
00112     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
00113 
00114     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00115 
00116     Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
00117     <span class="comment">//</span>
00118     <span class="comment">// Thaw the execution of all threads in the current process, but</span>
00119     <span class="comment">// the calling thread.</span>
00120     <span class="comment">//</span>
00121 
00122     <span class="keywordflow">if</span> ( !CreateDeleteLockHeld ) {
00123         <a class="code" href="../../d2/d8/ps_2create_8c.html#a22">PsLockProcess</a>(Process,KernelMode,PsLockWaitForever);
00124         }
00125 
00126     <a class="code" href="../../d9/d1/thredobj_8c.html#a28">KeThawAllThreads</a>();
00127 
00128     <span class="keywordflow">if</span> ( !CreateDeleteLockHeld ) {
00129         <a class="code" href="../../d2/d8/ps_2create_8c.html#a23">PsUnlockProcess</a>(Process);
00130         }
00131 
00132     <span class="keywordflow">return</span>;
00133 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="dbgkproc.c::DbgkpSectionHandleToFileHandle" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> HANDLE DbgkpSectionHandleToFileHandle           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>SectionHandle</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d2/dbgkproc_8c-source.html#l00136">136</a> of file <a class="el" href="../../d8/d2/dbgkproc_8c-source.html">dbgkproc.c</a>.
<p>
References <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d3/d1/rtload_8c-source.html#l00047">FileName</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l01721">MmGetFileNameForSection()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00082">RtlAnsiStringToUnicodeString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01215">RtlFreeUnicodeString()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00582">ZwOpenFile()</a>.
<p>
Referenced by <a class="el" href="../../d8/d2/dbgkproc_8c-source.html#l00211">DbgkCreateThread()</a>, and <a class="el" href="../../d8/d2/dbgkproc_8c-source.html#l00586">DbgkMapViewOfSection()</a>.
<p>
<pre class="fragment"><div>00142                    :
00143 
00144     This function Opens a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> associated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> processes
00145     section. The <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> opened such that <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> can be dupped all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> way to
00146     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d9/icmui_8def.html#a6">UI</a> where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d9/icmui_8def.html#a6">UI</a> can either map <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> or read <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> to get
00147     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> debug info.
00148 
00149 Arguments:
00150 
00151     SectionHandle - Supplies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section whose associated <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>
00152         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be opened.
00153 
00154 Return Value:
00155 
00156     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> - The <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> could not be opened.
00157 
00158     NON-<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> - Returns a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> associated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified
00159         section.
00160 
00161 --*/
00162 
00163 {
00164     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00165     ANSI_STRING <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>;
00166     UNICODE_STRING UnicodeFileName;
00167     OBJECT_ATTRIBUTES Obja;
00168     IO_STATUS_BLOCK IoStatusBlock;
00169     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00170 
00171     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00172 
00173     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d5/sectsup_8c.html#a23">MmGetFileNameForSection</a>(SectionHandle, (PSTRING)&amp;FileName);
00174     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
00175         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00176         }
00177 
00178     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;UnicodeFileName,&amp;FileName,TRUE);
00179     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>.Buffer);
00180     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
00181         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00182         }
00183 
00184     InitializeObjectAttributes(
00185         &amp;Obja,
00186         &amp;UnicodeFileName,
00187         OBJ_CASE_INSENSITIVE,
00188         NULL,
00189         NULL
00190         );
00191 
00192     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a33">ZwOpenFile</a>(
00193                 &amp;Handle,
00194                 (ACCESS_MASK)(GENERIC_READ | SYNCHRONIZE),
00195                 &amp;Obja,
00196                 &amp;IoStatusBlock,
00197                 FILE_SHARE_DELETE | FILE_SHARE_READ | FILE_SHARE_WRITE,
00198                 FILE_SYNCHRONOUS_IO_NONALERT
00199                 );
00200     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;UnicodeFileName);
00201     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
00202         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00203         }
00204     <span class="keywordflow">else</span> {
00205         <span class="keywordflow">return</span> <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00206         }
00207 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="dbgkproc.c::DbgkpSuspendProcess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID DbgkpSuspendProcess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN BOOLEAN&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>CreateDeleteLockHeld</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d2/dbgkproc_8c-source.html#l00036">36</a> of file <a class="el" href="../../d8/d2/dbgkproc_8c-source.html">dbgkproc.c</a>.
<p>
References <a class="el" href="../../d0/d1/thredobj_8c-source.html#l00757">KeFreezeAllThreads()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l01966">PsLockProcess()</a>, <a class="el" href="../../d1/d9/ps_8h.html#a155a91">PsLockWaitForever</a>, and <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l02250">PsUnlockProcess()</a>.
<p>
Referenced by <a class="el" href="../../d8/d2/dbgkproc_8c-source.html#l00471">DbgkExitThread()</a>, and <a class="el" href="../../d7/d2/dbgkport_8c-source.html#l00031">DbgkpSendApiMessage()</a>.
<p>
<pre class="fragment"><div>00042                    :
00043 
00044     This function causes all threads in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> calling process except <span class="keywordflow">for</span>
00045     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> calling thread to suspend.
00046 
00047 Arguments:
00048 
00049     CreateDeleteLockHeld - Supplies a flag that specifies whether or not
00050         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> holding <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process create <span class="keyword">delete</span> lock.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00051         caller holds <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lock, than <span class="keyword">this</span> function will not aquire <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00052         lock before suspending <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process.
00053 
00054 Return Value:
00055 
00056     None.
00057 
00058 --*/
00059 
00060 {
00061     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
00062 
00063     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00064 
00065     Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
00066 
00067     <span class="comment">//</span>
00068     <span class="comment">// Freeze the execution of all threads in the current process, but</span>
00069     <span class="comment">// the calling thread.</span>
00070     <span class="comment">//</span>
00071     <span class="keywordflow">if</span> ( !CreateDeleteLockHeld ) {
00072         <a class="code" href="../../d2/d8/ps_2create_8c.html#a22">PsLockProcess</a>(Process,KernelMode,PsLockWaitForever);
00073         }
00074 
00075     <a class="code" href="../../d9/d1/thredobj_8c.html#a9">KeFreezeAllThreads</a>();
00076 
00077     <span class="keywordflow">if</span> ( !CreateDeleteLockHeld ) {
00078         <a class="code" href="../../d2/d8/ps_2create_8c.html#a23">PsUnlockProcess</a>(Process);
00079         }
00080 
00081 
00082     <span class="keywordflow">return</span>;
00083 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="dbgkproc.c::DbgkUnMapViewOfSection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID DbgkUnMapViewOfSection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>BaseAddress</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d2/dbgkproc_8c-source.html#l00664">664</a> of file <a class="el" href="../../d8/d2/dbgkproc_8c-source.html">dbgkproc.c</a>.
<p>
References <a class="el" href="../../d7/d2/dbgkport_8c-source.html#l00031">DbgkpSendApiMessage()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00199">_EPROCESS::DebugPort</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d5/d8/umapview_8c-source.html#l00090">MmUnmapViewOfSection()</a>.
<p>
<pre class="fragment"><div>00670                    :
00671 
00672     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current process successfully
00673     un maps a view of an image section. If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process has an associated
00674     debug port, then an <span class="stringliteral">"unmap view of section"</span> message <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> sent.
00675 
00676 Arguments:
00677 
00678     BaseAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section being
00679         unmapped.
00680 
00681 Return Value:
00682 
00683     None.
00684 
00685 --*/
00686 
00687 {
00688 
00689     PVOID Port;
00690     DBGKM_APIMSG m;
00691     PDBGKM_UNLOAD_DLL UnloadDllArgs;
00692     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
00693 
00694     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00695 
00696     Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
00697 
00698     Port = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;HideFromDebugger ? <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> : Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o18">DebugPort</a>;
00699 
00700     <span class="keywordflow">if</span> ( !Port || KeGetPreviousMode() == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a> ) {
00701         <span class="keywordflow">return</span>;
00702     }
00703 
00704     UnloadDllArgs = &amp;m.u.UnloadDll;
00705     UnloadDllArgs-&gt;BaseAddress = BaseAddress;
00706 
00707     DBGKM_FORMAT_API_MSG(m,DbgKmUnloadDllApi,<span class="keyword">sizeof</span>(*UnloadDllArgs));
00708 
00709     <a class="code" href="../../d6/d3/dbgkport_8c.html#a1">DbgkpSendApiMessage</a>(&amp;m,Port,TRUE);
00710 
00711 }
}
</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:23 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
