<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: cmwrapr.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>cmwrapr.c File Reference</h1><code>#include "<a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>"</code><br>

<p>
<a href="../../d8/d2/cmwrapr_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d3/cmwrapr_8c.html#a0">MAX_FILE_IO</a>&nbsp;&nbsp;&nbsp;0x10000</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d3/cmwrapr_8c.html#a1">CmpIoFileRead</a>&nbsp;&nbsp;&nbsp;1</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d3/cmwrapr_8c.html#a2">CmpIoFileWrite</a>&nbsp;&nbsp;&nbsp;2</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d3/cmwrapr_8c.html#a3">CmpIoFileSetSize</a>&nbsp;&nbsp;&nbsp;3</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d3/cmwrapr_8c.html#a4">CmpIoFileFlush</a>&nbsp;&nbsp;&nbsp;4</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d3/cmwrapr_8c.html#a11">CmpAllocate</a> (ULONG <a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>, BOOLEAN UseForIo)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d3/cmwrapr_8c.html#a12">CmpFree</a> (PVOID MemoryBlock, ULONG GlobalQuotaSize)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d3/cmwrapr_8c.html#a13">CmpDoFileSetSize</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, ULONG FileType, ULONG FileSize)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d3/cmwrapr_8c.html#a14">CmpCreateEvent</a> (IN EVENT_TYPE eventType, OUT PHANDLE eventHandle, OUT <a class="el" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> *event)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d3/cmwrapr_8c.html#a15">CmpFileRead</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, ULONG FileType, PULONG FileOffset, PVOID DataBuffer, ULONG DataLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d3/cmwrapr_8c.html#a16">CmpFileWrite</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, ULONG FileType, <a class="el" href="../../d0/d1/hivedata_8h.html#a66">PCMP_OFFSET_ARRAY</a> offsetArray, ULONG offsetArrayCount, PULONG FileOffset)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d3/cmwrapr_8c.html#a17">CmpFileFlush</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, ULONG FileType)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d3/cmwrapr_8c.html#a5">perftouchbuffer</a> = 0</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d3/cmwrapr_8c.html#a6">CmpNoWrite</a></td></tr>

<tr><td class="memItemLeft" nowrap>struct {</td></tr>

<tr><td class="memItemLeft" nowrap>&nbsp;&nbsp;&nbsp;ULONG&nbsp;&nbsp;&nbsp;<a class="el" href="../../d7/d3/cmwrapr_8c.html#a7">Action</a></td></tr>

<tr><td class="memItemLeft" nowrap>&nbsp;&nbsp;&nbsp;HANDLE&nbsp;&nbsp;&nbsp;<a class="el" href="../../d7/d3/cmwrapr_8c.html#a8">Handle</a></td></tr>

<tr><td class="memItemLeft" nowrap>&nbsp;&nbsp;&nbsp;NTSTATUS&nbsp;&nbsp;&nbsp;<a class="el" href="../../d7/d3/cmwrapr_8c.html#a9">Status</a></td></tr>

<tr><td class="memItemLeft" nowrap valign=top>}&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d3/cmwrapr_8c.html#a10">CmRegistryIODebug</a></td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a4" doxytag="cmwrapr.c::CmpIoFileFlush" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CmpIoFileFlush&nbsp;&nbsp;&nbsp;4          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00049">49</a> of file <a class="el" href="../../d8/d2/cmwrapr_8c-source.html">cmwrapr.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00772">CmpFileFlush()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="cmwrapr.c::CmpIoFileRead" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CmpIoFileRead&nbsp;&nbsp;&nbsp;1          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00046">46</a> of file <a class="el" href="../../d8/d2/cmwrapr_8c-source.html">cmwrapr.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00351">CmpFileRead()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="cmwrapr.c::CmpIoFileSetSize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CmpIoFileSetSize&nbsp;&nbsp;&nbsp;3          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00048">48</a> of file <a class="el" href="../../d8/d2/cmwrapr_8c-source.html">cmwrapr.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00227">CmpDoFileSetSize()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="cmwrapr.c::CmpIoFileWrite" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CmpIoFileWrite&nbsp;&nbsp;&nbsp;2          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00047">47</a> of file <a class="el" href="../../d8/d2/cmwrapr_8c-source.html">cmwrapr.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00516">CmpFileWrite()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="cmwrapr.c::MAX_FILE_IO" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MAX_FILE_IO&nbsp;&nbsp;&nbsp;0x10000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00044">44</a> of file <a class="el" href="../../d8/d2/cmwrapr_8c-source.html">cmwrapr.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00351">CmpFileRead()</a>, and <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00516">CmpFileWrite()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a11" doxytag="cmwrapr.c::CmpAllocate" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID CmpAllocate           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Size</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>UseForIo</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00062">62</a> of file <a class="el" href="../../d8/d2/cmwrapr_8c-source.html">cmwrapr.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00247">CML_MINOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d6/d0/cmgquota_8c-source.html#l00204">CmpClaimGlobalQuota()</a>, <a class="el" href="../../d6/d0/cmgquota_8c-source.html#l00265">CmpReleaseGlobalQuota()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00264">CMS_POOL</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a178">PagedPoolCacheAligned</a>, <a class="el" href="../../d6/d1/ppc_2getcalr_8c-source.html#l00038">RtlGetCallersAddress()</a>, and <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>.
<p>
Referenced by <a class="el" href="../../d9/d0/cminit_8c-source.html#l00471">CmpInitializeHive()</a>.
<p>
<pre class="fragment"><div>00068                    :
00069 
00070     This routine makes more memory available to a hive.
00071 
00072     It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> environment specific.
00073 
00074 Arguments:
00075 
00076     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> - amount of space caller wants
00077 
00078     UseForIo - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> object allocated will be target of I/O,
00079                <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> not.
00080 
00081 Return Value:
00082 
00083     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <span class="keywordflow">if</span> <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>, address of allocated block <span class="keywordflow">if</span> not.
00084 
00085 --*/
00086 {
00087     PVOID   result;
00088     ULONG   pooltype;
00089 <span class="preprocessor">#if DBG</span>
00090 <span class="preprocessor"></span>    PVOID   Caller;
00091     PVOID   CallerCaller;
00092     <a class="code" href="../../d5/d2/ppc_2getcalr_8c.html#a0">RtlGetCallersAddress</a>(&amp;Caller, &amp;CallerCaller);
00093 <span class="preprocessor">#endif</span>
00094 <span class="preprocessor"></span>
00095     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d2/cmp_8h.html#a247">CmpClaimGlobalQuota</a>(Size) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00096         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00097     }
00098 
00099     pooltype = (UseForIo) ? <a class="code" href="../../d5/d8/ex_8h.html#a329a178">PagedPoolCacheAligned</a> : <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>;
00100     result = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
00101                 pooltype,
00102                 Size,
00103                 CM_POOL_TAG
00104                 );
00105 
00106 <span class="preprocessor">#if DBG</span>
00107 <span class="preprocessor"></span>    <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MINOR, CMS_POOL) {
00108         KdPrint((<span class="stringliteral">"**CmpAllocate: allocate:%08lx, "</span>, Size));
00109         KdPrint((<span class="stringliteral">"type:%d, at:%08lx  "</span>, PagedPool, result));
00110         KdPrint((<span class="stringliteral">"c:%08lx  cc:%08lx\n"</span>, Caller, CallerCaller));
00111     }
00112 <span class="preprocessor">#endif</span>
00113 <span class="preprocessor"></span>
00114     <span class="keywordflow">if</span> (result == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00115         <a class="code" href="../../d1/d2/cmp_8h.html#a248">CmpReleaseGlobalQuota</a>(Size);
00116     }
00117 
00118     <span class="keywordflow">return</span> result;
00119 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="cmwrapr.c::CmpCreateEvent" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmpCreateEvent           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN EVENT_TYPE&nbsp;</td>
          <td class="mdname" nowrap> <em>eventType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>eventHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>event</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00313">313</a> of file <a class="el" href="../../d8/d2/cmwrapr_8c-source.html">cmwrapr.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>.
<p>
Referenced by <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00351">CmpFileRead()</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00516">CmpFileWrite()</a>, and <a class="el" href="../../d9/d0/cminit_8c-source.html#l00046">CmpOpenHiveFiles()</a>.
<p>
<pre class="fragment"><div>00318 {
00319     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00320     OBJECT_ATTRIBUTES obja;
00321 
00322     InitializeObjectAttributes( &amp;obja, NULL, OBJ_CASE_INSENSITIVE | OBJ_KERNEL_HANDLE, NULL, NULL );
00323     status = ZwCreateEvent(
00324         eventHandle,
00325         EVENT_ALL_ACCESS,
00326         &amp;obja,
00327         eventType,
00328         FALSE);
00329     
00330     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00331         <span class="keywordflow">return</span> status;
00332     }
00333     
00334     status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00335         *eventHandle,
00336         EVENT_ALL_ACCESS,
00337         NULL,
00338         KernelMode,
00339         event,
00340         NULL);
00341     
00342     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00343         ZwClose(*eventHandle);
00344         <span class="keywordflow">return</span> status;
00345     }
00346     <span class="keywordflow">return</span> status;
00347 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="cmwrapr.c::CmpDoFileSetSize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmpDoFileSetSize           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>FileType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>FileSize</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00227">227</a> of file <a class="el" href="../../d8/d2/cmwrapr_8c-source.html">cmwrapr.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00360">ASSERT_PASSIVE_LEVEL</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00048">CmpIoFileSetSize</a>, <a class="el" href="../../d7/d0/cmdat2_8c.html#a20">CmRegistryIODebug</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00650">_CMHIVE::FileHandles</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l10281">IoSetThreadHardErrorMode()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00861">ZwSetInformationFile()</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00509">CmpFileSetSize()</a>, <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00115">CmpWorker()</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00323">CmpWorkerCommand()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00775">HvpDoWriteHive()</a>, and <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01433">HvWriteHive()</a>.
<p>
<pre class="fragment"><div>00234                    :
00235 
00236     This routine sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  It must not <span class="keywordflow">return</span> until
00237     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> guaranteed.
00238 
00239     It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> environment specific.
00240 
00241     Must be running in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cmp worker thread.
00242 
00243 Arguments:
00244 
00245     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> we are doing I/O <span class="keywordflow">for</span>
00246 
00247     FileType - which supporting <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> to use
00248 
00249     FileSize - 32 bit value to set <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>'s size to
00250 
00251 Return Value:
00252 
00253     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>
00254     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> success
00255 
00256 --*/
00257 {
00258     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> CmHive;
00259     HANDLE  FileHandle;
00260     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00261     FILE_END_OF_FILE_INFORMATION FileInfo;
00262     IO_STATUS_BLOCK IoStatus;
00263     BOOLEAN oldFlag;
00264 
00265     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FIELD_OFFSET(<a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, Hive) == 0);
00266 
00267     CmHive = (<a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>)<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
00268     FileHandle = CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o1">FileHandles</a>[FileType];
00269     <span class="keywordflow">if</span> (FileHandle == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00270         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00271     }
00272 
00273     <span class="comment">//</span>
00274     <span class="comment">// disable hard error popups, to avoid self deadlock on bogus devices</span>
00275     <span class="comment">//</span>
00276     oldFlag = <a class="code" href="../../d4/d6/iosubs_8c.html#a108">IoSetThreadHardErrorMode</a>(FALSE);
00277 
00278     FileInfo.EndOfFile.HighPart = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00279     FileInfo.EndOfFile.LowPart  = FileSize;
00280 
00281     <a class="code" href="../../d1/d2/cmp_8h.html#a63">ASSERT_PASSIVE_LEVEL</a>();
00282 
00283     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a39">ZwSetInformationFile</a>(
00284                 FileHandle,
00285                 &amp;IoStatus,
00286                 (PVOID)&amp;FileInfo,
00287                 <span class="keyword">sizeof</span>(FILE_END_OF_FILE_INFORMATION),
00288                 FileEndOfFileInformation
00289                 );
00290 
00291     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00292         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IoStatus.Status == Status);
00293     } <span class="keywordflow">else</span> {
00294         
00295         <span class="comment">//</span>
00296         <span class="comment">// set debugging info</span>
00297         <span class="comment">//</span>
00298         <a class="code" href="../../d7/d0/cmdat2_8c.html#a20">CmRegistryIODebug</a>.Action = <a class="code" href="../../d7/d3/cmwrapr_8c.html#a3">CmpIoFileSetSize</a>;
00299         <a class="code" href="../../d7/d0/cmdat2_8c.html#a20">CmRegistryIODebug</a>.Handle = FileHandle;
00300         <a class="code" href="../../d7/d0/cmdat2_8c.html#a20">CmRegistryIODebug</a>.Status = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00301         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"CmpFileSetSize:\tHandle=%08lx  NewLength=%08lx  \n"</span>, FileHandle, FileSize);
00302     }
00303 
00304     <span class="comment">//</span>
00305     <span class="comment">// restore hard error popups mode</span>
00306     <span class="comment">//</span>
00307     <a class="code" href="../../d4/d6/iosubs_8c.html#a108">IoSetThreadHardErrorMode</a>(oldFlag);
00308 
00309     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00310 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="cmwrapr.c::CmpFileFlush" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpFileFlush           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>FileType</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00772">772</a> of file <a class="el" href="../../d8/d2/cmwrapr_8c-source.html">cmwrapr.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00360">ASSERT_PASSIVE_LEVEL</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00049">CmpIoFileFlush</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00025">CmpNoWrite</a>, <a class="el" href="../../d7/d0/cmdat2_8c.html#a20">CmRegistryIODebug</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00259">CMS_IO</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00650">_CMHIVE::FileHandles</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d0/cminit_8c-source.html#l00471">CmpInitializeHive()</a>, and <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01261">CmpSaveKeyByFileCopy()</a>.
<p>
<pre class="fragment"><div>00778                    :
00779 
00780     This routine performs a flush on a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> handle.
00781 
00782 Arguments:
00783 
00784     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> we are doing I/O <span class="keywordflow">for</span>
00785 
00786     FileType - which supporting <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> to use
00787 
00788 Return Value:
00789 
00790     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>
00791     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> success
00792 
00793 --*/
00794 {
00795     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00796     IO_STATUS_BLOCK IoStatus;
00797     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> CmHive;
00798     HANDLE  FileHandle;
00799 
00800     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FIELD_OFFSET(<a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, Hive) == 0);
00801     CmHive = (<a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>)<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
00802     FileHandle = CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o1">FileHandles</a>[FileType];
00803     <span class="keywordflow">if</span> (FileHandle == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00804         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00805     }
00806 
00807     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d9/cmapi_8c.html#a0">CmpNoWrite</a>) {
00808         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00809     }
00810 
00811     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_IO) {
00812         KdPrint((<span class="stringliteral">"CmpFileFlush:\n\tHandle = %08lx\n"</span>, FileHandle));
00813     }
00814 
00815     <a class="code" href="../../d1/d2/cmp_8h.html#a63">ASSERT_PASSIVE_LEVEL</a>();
00816 
00817     status = ZwFlushBuffersFile(
00818                 FileHandle,
00819                 &amp;IoStatus
00820                 );
00821 
00822     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00823         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IoStatus.Status == status);
00824         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00825     } <span class="keywordflow">else</span> {
00826         <span class="comment">//</span>
00827         <span class="comment">// set debugging info</span>
00828         <span class="comment">//</span>
00829         <a class="code" href="../../d7/d0/cmdat2_8c.html#a20">CmRegistryIODebug</a>.Action = <a class="code" href="../../d7/d3/cmwrapr_8c.html#a4">CmpIoFileFlush</a>;
00830         <a class="code" href="../../d7/d0/cmdat2_8c.html#a20">CmRegistryIODebug</a>.Handle = FileHandle;
00831         <a class="code" href="../../d7/d0/cmdat2_8c.html#a20">CmRegistryIODebug</a>.Status = status;
00832         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"CmpFileFlush:\tFailure1: status = %08lx  IoStatus = %08lx\n"</span>,status,IoStatus.Status);
00833         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00834     }
00835     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00836 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="cmwrapr.c::CmpFileRead" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpFileRead           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>FileType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>FileOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>DataBuffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>DataLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00351">351</a> of file <a class="el" href="../../d8/d2/cmwrapr_8c-source.html">cmwrapr.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00360">ASSERT_PASSIVE_LEVEL</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00313">CmpCreateEvent()</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00046">CmpIoFileRead</a>, <a class="el" href="../../d7/d0/cmdat2_8c.html#a20">CmRegistryIODebug</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00259">CMS_IO</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00275">CMS_IO_ERROR</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00650">_CMHIVE::FileHandles</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00044">MAX_FILE_IO</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00033">Offset</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d0/cminit_8c-source.html#l00471">CmpInitializeHive()</a>, and <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00115">CmpWorker()</a>.
<p>
<pre class="fragment"><div>00360                    :
00361 
00362     This routine reads in a buffer from a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00363 
00364     It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> environment specific.
00365 
00366     NOTE:   We assume <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> opened <span class="keywordflow">for</span> asynchronous access,
00367             and that we, and not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IO system, are keeping <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00368             offset pointer.
00369 
00370     NOTE:   Only 32bit offsets are supported, even though <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> underlying
00371             IO system on NT supports 64 bit offsets.
00372 
00373 Arguments:
00374 
00375     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> we are doing I/O <span class="keywordflow">for</span>
00376 
00377     FileType - which supporting <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> to use
00378 
00379     FileOffset - pointer to variable providing 32bit offset on input,
00380                  and receiving <span class="keyword">new</span> 32bit offset on output.
00381 
00382     DataBuffer - pointer to buffer
00383 
00384     DataLength - length of buffer
00385 
00386 Return Value:
00387 
00388     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>
00389     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> success
00390 
00391 --*/
00392 {
00393     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00394     LARGE_INTEGER   <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
00395     IO_STATUS_BLOCK IoStatus;
00396     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> CmHive;
00397     HANDLE  FileHandle;
00398     ULONG LengthToRead;
00399     HANDLE eventHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00400     <a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> eventObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00401 
00402     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FIELD_OFFSET(<a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, Hive) == 0);
00403     CmHive = (<a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>)<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
00404     FileHandle = CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o1">FileHandles</a>[FileType];
00405     <span class="keywordflow">if</span> (FileHandle == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00406         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00407     }
00408 
00409     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_IO) {
00410         KdPrint((<span class="stringliteral">"CmpFileRead:\n"</span>));
00411         KdPrint((<span class="stringliteral">"\tHandle=%08lx  Offset=%08lx  "</span>, FileHandle, *FileOffset));
00412         KdPrint((<span class="stringliteral">"Buffer=%08lx  Length=%08lx\n"</span>, DataBuffer, DataLength));
00413     }
00414 
00415     <span class="comment">//</span>
00416     <span class="comment">// Detect attempt to read off end of 2gig file (this should be irrelevent)</span>
00417     <span class="comment">//</span>
00418     <span class="keywordflow">if</span> ((0xffffffff - *FileOffset) &lt; DataLength) {
00419         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_IO_ERROR) KdPrint(("CmpFileRead: runoff\n"));
00420         return FALSE;
00421     }
00422 
00423     status = CmpCreateEvent(
00424         SynchronizationEvent,
00425         &amp;eventHandle,
00426         &amp;eventObject);
00427     if (!NT_SUCCESS(status))
00428         return FALSE;
00429 
00430     <span class="comment">//</span>
00431     <span class="comment">// We'd really like to just call the filesystems and have them do</span>
00432     <span class="comment">// the right thing.  But the filesystem will attempt to lock our</span>
00433     <span class="comment">// entire buffer into memory, and that may fail for large requests.</span>
00434     <span class="comment">// So we split our reads into 64k chunks and call the filesystem for</span>
00435     <span class="comment">// each one.</span>
00436     <span class="comment">//</span>
00437     ASSERT_PASSIVE_LEVEL();
00438     while (DataLength &gt; 0) {
00439 
00440         <span class="comment">//</span>
00441         <span class="comment">// Convert ULONG to Large</span>
00442         <span class="comment">//</span>
00443         <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>.LowPart = *FileOffset;
00444         <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>.HighPart = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00445 
00446         <span class="comment">//</span>
00447         <span class="comment">// trim request down if necessary.</span>
00448         <span class="comment">//</span>
00449         <span class="keywordflow">if</span> (DataLength &gt; <a class="code" href="../../d7/d3/cmwrapr_8c.html#a0">MAX_FILE_IO</a>) {
00450             LengthToRead = <a class="code" href="../../d7/d3/cmwrapr_8c.html#a0">MAX_FILE_IO</a>;
00451         } <span class="keywordflow">else</span> {
00452             LengthToRead = DataLength;
00453         }
00454 
00455         status = ZwReadFile(
00456                     FileHandle,
00457                     eventHandle,
00458                     NULL,               <span class="comment">// apcroutine</span>
00459                     NULL,               <span class="comment">// apccontext</span>
00460                     &amp;IoStatus,
00461                     DataBuffer,
00462                     LengthToRead,
00463                     &amp;Offset,
00464                     NULL                <span class="comment">// key</span>
00465                     );
00466 
00467         <span class="keywordflow">if</span> (STATUS_PENDING == status) {
00468             status = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(eventObject, Executive,
00469                                            KernelMode, FALSE, NULL);
00470             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(STATUS_SUCCESS == status);
00471             status = IoStatus.Status;
00472         }
00473 
00474         <span class="comment">//</span>
00475         <span class="comment">// adjust offsets</span>
00476         <span class="comment">//</span>
00477         *FileOffset = <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>.LowPart + LengthToRead;
00478         DataLength -= LengthToRead;
00479         (PUCHAR)DataBuffer += LengthToRead;
00480 
00481         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00482             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IoStatus.Status == status);
00483             <span class="keywordflow">if</span> (IoStatus.Information != LengthToRead) {
00484                 <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_IO_ERROR) {
00485                     KdPrint((<span class="stringliteral">"CmpFileRead:\n\t"</span>));
00486                     KdPrint((<span class="stringliteral">"Failure1: status = %08lx  "</span>, status));
00487                     KdPrint((<span class="stringliteral">"IoInformation = %08lx\n"</span>, IoStatus.Information));
00488                 }
00489                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(eventObject);
00490                 ZwClose(eventHandle);
00491                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00492             }
00493         } <span class="keywordflow">else</span> {
00494             <span class="comment">//</span>
00495             <span class="comment">// set debugging info</span>
00496             <span class="comment">//</span>
00497             <a class="code" href="../../d7/d0/cmdat2_8c.html#a20">CmRegistryIODebug</a>.Action = <a class="code" href="../../d7/d3/cmwrapr_8c.html#a1">CmpIoFileRead</a>;
00498             <a class="code" href="../../d7/d0/cmdat2_8c.html#a20">CmRegistryIODebug</a>.Handle = FileHandle;
00499             <a class="code" href="../../d7/d0/cmdat2_8c.html#a20">CmRegistryIODebug</a>.Status = status;
00500             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"CmpFileRead:\tFailure2: status = %08lx  IoStatus = %08lx\n"</span>, status, IoStatus.Status);
00501 
00502             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(eventObject);
00503             ZwClose(eventHandle);
00504             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00505         }
00506 
00507     }
00508     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(eventObject);
00509     ZwClose(eventHandle);
00510     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00511 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="cmwrapr.c::CmpFileWrite" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpFileWrite           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>FileType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a66">PCMP_OFFSET_ARRAY</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>offsetArray</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>offsetArrayCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>FileOffset</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00516">516</a> of file <a class="el" href="../../d8/d2/cmwrapr_8c-source.html">cmwrapr.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00360">ASSERT_PASSIVE_LEVEL</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00313">CmpCreateEvent()</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00047">CmpIoFileWrite</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00025">CmpNoWrite</a>, <a class="el" href="../../d7/d0/cmdat2_8c.html#a20">CmRegistryIODebug</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00259">CMS_IO</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00275">CMS_IO_ERROR</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00650">_CMHIVE::FileHandles</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00395">KeWaitForMultipleObjects()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00044">MAX_FILE_IO</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00033">Offset</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00024">perftouchbuffer</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d0/cminit_8c-source.html#l00471">CmpInitializeHive()</a>, and <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01261">CmpSaveKeyByFileCopy()</a>.
<p>
<pre class="fragment"><div>00525                    :
00526 
00527     This routine writes an array of buffers <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> to a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00528 
00529     It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> environment specific.
00530 
00531     NOTE:   We assume <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> opened <span class="keywordflow">for</span> asynchronous access,
00532             and that we, and not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IO system, are keeping <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00533             offset pointer.
00534 
00535     NOTE:   Only 32bit offsets are supported, even though <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> underlying
00536             IO system on NT supports 64 bit offsets.
00537 
00538 Arguments:
00539 
00540     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> we are doing I/O <span class="keywordflow">for</span>
00541 
00542     FileType - which supporting <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> to use
00543 
00544     offsetArray - array of structures where each structure holds a 32bit offset
00545                   into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> and pointer <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> a buffer written to that
00546                   <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> offset.
00547 
00548     offsetArrayCount - number of elements in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> offsetArray.
00549 
00550     FileOffset - returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> offset after <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last write to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00551 
00552 Return Value:
00553 
00554     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>
00555     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> success
00556 
00557 --*/
00558 {
00559     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00560     LARGE_INTEGER   <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
00561     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> CmHive;
00562     HANDLE  FileHandle;
00563     ULONG LengthToWrite;
00564     LONG WaitBufferCount = 0;
00565     LONG idx;
00566     ULONG arrayCount = 0;
00567     PVOID       DataBuffer;
00568     ULONG       DataLength;
00569     HANDLE eventHandles[MAXIMUM_WAIT_OBJECTS];
00570     <a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> eventObjects[MAXIMUM_WAIT_OBJECTS];
00571     <a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html">KWAIT_BLOCK</a> waitBlockArray[MAXIMUM_WAIT_OBJECTS];
00572     IO_STATUS_BLOCK IoStatus[MAXIMUM_WAIT_OBJECTS];
00573     BOOLEAN ret_val = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00574 
00575     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d9/cmapi_8c.html#a0">CmpNoWrite</a>) {
00576         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00577     }
00578 
00579     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FIELD_OFFSET(<a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, Hive) == 0);
00580     CmHive = (<a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>)<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
00581     FileHandle = CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o1">FileHandles</a>[FileType];
00582     <span class="keywordflow">if</span> (FileHandle == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00583         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00584     }
00585 
00586     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_IO) {
00587         KdPrint((<span class="stringliteral">"CmpFileWrite:\n"</span>));
00588         KdPrint((<span class="stringliteral">"\tHandle=%08lx  "</span>, FileHandle));
00589     }
00590 
00591     <span class="keywordflow">for</span> (idx = 0; idx &lt; MAXIMUM_WAIT_OBJECTS; idx++) {
00592         eventHandles[idx] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00593     }
00594 
00595     <span class="comment">// Bring pages being written into memory first to allow disk to write</span>
00596     <span class="comment">// buffer contiguously.</span>
00597     <span class="keywordflow">for</span> (idx = 0; (ULONG) idx &lt; offsetArrayCount; idx++) {
00598         <span class="keywordtype">char</span> * start = offsetArray[idx].DataBuffer;
00599         <span class="keywordtype">char</span> * end = (<span class="keywordtype">char</span> *) start + offsetArray[idx].DataLength;
00600         <span class="keywordflow">while</span> (start &lt; end) {
00601             <span class="comment">// perftouchbuffer globally declared so that compiler won't try</span>
00602             <span class="comment">// to remove it and this loop (if its smart enough?).</span>
00603             <a class="code" href="../../d7/d3/cmwrapr_8c.html#a5">perftouchbuffer</a> += (ULONG) *start;
00604             start += <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
00605         }
00606     }
00607 
00608     <span class="comment">//</span>
00609     <span class="comment">// We'd really like to just call the filesystems and have them do</span>
00610     <span class="comment">// the right thing.  But the filesystem will attempt to lock our</span>
00611     <span class="comment">// entire buffer into memory, and that may fail for large requests.</span>
00612     <span class="comment">// So we split our reads into 64k chunks and call the filesystem for</span>
00613     <span class="comment">// each one.</span>
00614     <span class="comment">//</span>
00615     <a class="code" href="../../d1/d2/cmp_8h.html#a63">ASSERT_PASSIVE_LEVEL</a>();
00616     arrayCount = 0;
00617     DataLength = 0;
00618     <span class="comment">// This outer loop is hit more than once if the MAXIMUM_WAIT_OBJECTS limit</span>
00619     <span class="comment">// is hit before the offset array is drained.</span>
00620     <span class="keywordflow">while</span> (arrayCount &lt; offsetArrayCount) {
00621         WaitBufferCount = 0;
00622 
00623         <span class="comment">// This loop fills the wait buffer.</span>
00624         <span class="keywordflow">while</span> ((arrayCount &lt; offsetArrayCount) &amp;&amp;
00625                (WaitBufferCount &lt; MAXIMUM_WAIT_OBJECTS)) {
00626 
00627             <span class="comment">// If data length isn't zero than the wait buffer filled before the</span>
00628             <span class="comment">// buffer in the last offsetArray element was sent to write file.</span>
00629             <span class="keywordflow">if</span> (DataLength == 0) {
00630                 *FileOffset = offsetArray[arrayCount].FileOffset;
00631                 DataBuffer =  offsetArray[arrayCount].DataBuffer;
00632                 DataLength =  offsetArray[arrayCount].DataLength;
00633                 <span class="comment">//</span>
00634                 <span class="comment">// Detect attempt to read off end of 2gig file</span>
00635                 <span class="comment">// (this should be irrelevent)</span>
00636                 <span class="comment">//</span>
00637                 <span class="keywordflow">if</span> ((0xffffffff - *FileOffset) &lt; DataLength) {
00638                     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_IO_ERROR) KdPrint(("CmpFileWrite: runoff\n"));
00639                     goto Error_Exit;
00640                 }
00641             }
00642             <span class="comment">// else still more to write out of last buffer.</span>
00643 
00644             while ((DataLength &gt; 0) &amp;&amp; (WaitBufferCount &lt; MAXIMUM_WAIT_OBJECTS)) {
00645 
00646                 <span class="comment">//</span>
00647                 <span class="comment">// Convert ULONG to Large</span>
00648                 <span class="comment">//</span>
00649                 <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>.LowPart = *FileOffset;
00650                 <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>.HighPart = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00651 
00652                 <span class="comment">//</span>
00653                 <span class="comment">// trim request down if necessary.</span>
00654                 <span class="comment">//</span>
00655                 <span class="keywordflow">if</span> (DataLength &gt; <a class="code" href="../../d7/d3/cmwrapr_8c.html#a0">MAX_FILE_IO</a>) {
00656                     LengthToWrite = <a class="code" href="../../d7/d3/cmwrapr_8c.html#a0">MAX_FILE_IO</a>;
00657                 } <span class="keywordflow">else</span> {
00658                     LengthToWrite = DataLength;
00659                 }
00660 
00661                 <span class="comment">// Previously created events are reused.</span>
00662                 <span class="keywordflow">if</span> (eventHandles[WaitBufferCount] == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00663                     status = <a class="code" href="../../d7/d3/cmwrapr_8c.html#a14">CmpCreateEvent</a>(SynchronizationEvent,
00664                                             &amp;eventHandles[WaitBufferCount],
00665                                             &amp;eventObjects[WaitBufferCount]);
00666                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00667                         <span class="comment">// Make sure we don't try to clean this up.</span>
00668                         eventHandles[WaitBufferCount] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00669                         <span class="keywordflow">goto</span> Error_Exit;
00670                     }
00671                 }
00672                         
00673                 status = ZwWriteFile(FileHandle,
00674                                      eventHandles[WaitBufferCount],
00675                                      NULL,               <span class="comment">// apcroutine</span>
00676                                      NULL,               <span class="comment">// apccontext</span>
00677                                      &amp;IoStatus[WaitBufferCount],
00678                                      DataBuffer,
00679                                      LengthToWrite,
00680                                      &amp;Offset,
00681                                      NULL);
00682                         
00683                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00684                     <span class="keywordflow">goto</span> Error_Exit;
00685                 }
00686 
00687                 WaitBufferCount++;
00688                 
00689                 <span class="comment">//</span>
00690                 <span class="comment">// adjust offsets</span>
00691                 <span class="comment">//</span>
00692                 *FileOffset = <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>.LowPart + LengthToWrite;
00693                 DataLength -= LengthToWrite;
00694                 (PUCHAR)DataBuffer += LengthToWrite;
00695             } <span class="comment">// while (DataLength &gt; 0 &amp;&amp; WaitBufferCount &lt; MAXIMUM_WAIT_OBJECTS)</span>
00696             
00697             arrayCount++;
00698             
00699         } <span class="comment">// while (arrayCount &lt; offsetArrayCount &amp;&amp; </span>
00700           <span class="comment">//        WaitBufferCount &lt; MAXIMUM_WAIT_OBJECTS)</span>
00701 
00702         status = <a class="code" href="../../d1/d7/wait_8c.html#a3">KeWaitForMultipleObjects</a>(WaitBufferCount, 
00703                                           eventObjects,
00704                                           WaitAll,
00705                                           Executive,
00706                                           KernelMode, 
00707                                           FALSE, 
00708                                           NULL,
00709                                           waitBlockArray);
00710         
00711         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))
00712             <span class="keywordflow">goto</span> Error_Exit;
00713         
00714         <span class="keywordflow">for</span> (idx = 0; idx &lt; WaitBufferCount; idx++) {
00715             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IoStatus[idx].Status)) {
00716                 ret_val = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00717                 <span class="keywordflow">goto</span> Done;
00718             }
00719         }
00720         
00721         <span class="comment">// There may still be more to do if the last element held a big buffer</span>
00722         <span class="comment">// and the wait buffer filled before it was all sent to the file.</span>
00723         <span class="keywordflow">if</span> (DataLength &gt; 0) {
00724             arrayCount--;
00725         }
00726 
00727     } <span class="comment">// while (arrayCount &lt; offsetArrayCount)</span>
00728 
00729     ret_val = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00730 
00731     <span class="keywordflow">goto</span> Done;
00732 Error_Exit:
00733     <span class="comment">//</span>
00734     <span class="comment">// set debugging info</span>
00735     <span class="comment">//</span>
00736     <a class="code" href="../../d7/d0/cmdat2_8c.html#a20">CmRegistryIODebug</a>.Action = <a class="code" href="../../d7/d3/cmwrapr_8c.html#a2">CmpIoFileWrite</a>;
00737     <a class="code" href="../../d7/d0/cmdat2_8c.html#a20">CmRegistryIODebug</a>.Handle = FileHandle;
00738     <a class="code" href="../../d7/d0/cmdat2_8c.html#a20">CmRegistryIODebug</a>.Status = status;
00739     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"CmpFileWrite: error exiting %d\n"</span>, status);
00740     <span class="comment">//</span>
00741     <span class="comment">// if WaitBufferCount &gt; 0 then we have successfully issued</span>
00742     <span class="comment">// some I/Os, but not all of them. This is an error, but we</span>
00743     <span class="comment">// cannot return from this routine until all the successfully</span>
00744     <span class="comment">// issued I/Os have completed.</span>
00745     <span class="comment">//</span>
00746     <span class="keywordflow">if</span> (WaitBufferCount &gt; 0) {
00747         status = <a class="code" href="../../d1/d7/wait_8c.html#a3">KeWaitForMultipleObjects</a>(WaitBufferCount, 
00748                                           eventObjects,
00749                                           WaitAll,
00750                                           Executive,
00751                                           KernelMode, 
00752                                           FALSE, 
00753                                           NULL,
00754                                           waitBlockArray);
00755     }
00756 
00757 
00758     ret_val = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00759 Done:
00760     idx = 0;
00761     <span class="comment">// Clean up open event handles and objects.</span>
00762     <span class="keywordflow">while</span> ((idx &lt; MAXIMUM_WAIT_OBJECTS) &amp;&amp; (eventHandles[idx] != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00763         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(eventObjects[idx]);
00764         ZwClose(eventHandles[idx]);
00765         idx++;
00766     }
00767     <span class="keywordflow">return</span> ret_val;
00768 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="cmwrapr.c::CmpFree" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpFree           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>MemoryBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>GlobalQuotaSize</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00186">186</a> of file <a class="el" href="../../d8/d2/cmwrapr_8c-source.html">cmwrapr.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00247">CML_MINOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d6/d0/cmgquota_8c-source.html#l00265">CmpReleaseGlobalQuota()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00264">CMS_POOL</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, and <a class="el" href="../../d6/d1/ppc_2getcalr_8c-source.html#l00038">RtlGetCallersAddress()</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01490">CmpDestroyTemporaryHive()</a>, <a class="el" href="../../d9/d0/cminit_8c-source.html#l00471">CmpInitializeHive()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l04077">CmpValidateAlternate()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l02293">CmReplaceKey()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l02079">CmUnloadKey()</a>, <a class="el" href="../../d0/d4/edithive_8c-source.html#l00124">EhCloseHive()</a>, <a class="el" href="../../d3/d0/hivefree_8c-source.html#l00034">HvFreeHive()</a>, <a class="el" href="../../d3/d0/hivefree_8c-source.html#l00160">HvFreeHivePartial()</a>, and <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01433">HvWriteHive()</a>.
<p>
<pre class="fragment"><div>00192                    :
00193 
00194     This routine frees memory that has been allocated by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry.
00195 
00196     It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> environment specific
00197 
00198 
00199 Arguments:
00200 
00201     MemoryBlock - supplies address of memory object to free
00202 
00203     GlobalQuotaSize - amount of global quota to release
00204 
00205 Return Value:
00206 
00207     NONE
00208 
00209 --*/
00210 {
00211 <span class="preprocessor">#if DBG</span>
00212 <span class="preprocessor"></span>    PVOID   Caller;
00213     PVOID   CallerCaller;
00214     <a class="code" href="../../d5/d2/ppc_2getcalr_8c.html#a0">RtlGetCallersAddress</a>(&amp;Caller, &amp;CallerCaller);
00215     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MINOR, CMS_POOL) {
00216         KdPrint((<span class="stringliteral">"**FREEING:%08lx c,cc:%08lx,%08lx\n"</span>, MemoryBlock, Caller, CallerCaller));
00217     }
00218 <span class="preprocessor">#endif</span>
00219 <span class="preprocessor"></span>    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(GlobalQuotaSize &gt; 0);
00220     <a class="code" href="../../d1/d2/cmp_8h.html#a248">CmpReleaseGlobalQuota</a>(GlobalQuotaSize);
00221     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(MemoryBlock);
00222     <span class="keywordflow">return</span>;
00223 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a7" doxytag="cmwrapr.c::Action" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d9/d3/rules_8c.html#a7">Action</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00052">52</a> of file <a class="el" href="../../d8/d2/cmwrapr_8c-source.html">cmwrapr.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="cmwrapr.c::CmpNoWrite" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d6/d3/cmwraper_8c.html#a4">CmpNoWrite</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00038">38</a> of file <a class="el" href="../../d8/d2/cmwrapr_8c-source.html">cmwrapr.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="cmwrapr.c::CmRegistryIODebug" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> struct { ... }   <a class="el" href="../../d7/d3/cmwrapr_8c.html#a10">CmRegistryIODebug</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="cmwrapr.c::Handle" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> HANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00053">53</a> of file <a class="el" href="../../d8/d2/cmwrapr_8c-source.html">cmwrapr.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="cmwrapr.c::perftouchbuffer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d7/d3/cmwrapr_8c.html#a5">perftouchbuffer</a> = 0          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00024">24</a> of file <a class="el" href="../../d8/d2/cmwrapr_8c-source.html">cmwrapr.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00516">CmpFileWrite()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="cmwrapr.c::Status" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS <a class="el" href="../../d2/d1/cttoken_8c.html#a18">Status</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00054">54</a> of file <a class="el" href="../../d8/d2/cmwrapr_8c-source.html">cmwrapr.c</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:12 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
