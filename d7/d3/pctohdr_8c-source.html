<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: pctohdr.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>pctohdr.c</h1><a href="../../d6/d4/pctohdr_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1992  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    pctohdr.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements code to locate the file header for an image or</span>
00012 <span class="comment">    dll given a PC value that lies within the image.</span>
00013 <span class="comment"></span>
00014 <span class="comment">    N.B. This routine is conditionalized for user mode and kernel mode.</span>
00015 <span class="comment"></span>
00016 <span class="comment">Author:</span>
00017 <span class="comment"></span>
00018 <span class="comment">    Steve Wood (stevewo) 18-Aug-1989</span>
00019 <span class="comment"></span>
00020 <span class="comment">Environment:</span>
00021 <span class="comment"></span>
00022 <span class="comment">    User Mode or Kernel Mode</span>
00023 <span class="comment"></span>
00024 <span class="comment">Revision History:</span>
00025 <span class="comment"></span>
00026 <span class="comment">--*/</span>
00027 
00028 <span class="preprocessor">#if defined(NTOS_KERNEL_RUNTIME)</span>
00029 <span class="preprocessor"></span><span class="preprocessor">#include "<a class="code" href="../../d9/d8/ntos_8h.html">ntos.h</a>"</span>
00030 <span class="preprocessor">#else</span>
00031 <span class="preprocessor"></span><span class="preprocessor">#include &lt;nt.h&gt;</span>
00032 <span class="preprocessor">#include &lt;ntrtl.h&gt;</span>
00033 <span class="preprocessor">#include &lt;nturtl.h&gt;</span>
00034 <span class="preprocessor">#endif</span>
00035 <span class="preprocessor"></span>
00036 <span class="preprocessor">#if !defined(NTOS_KERNEL_RUNTIME)</span>
<a name="l00037"></a><a class="code" href="../../d6/d4/pctohdr_8c.html#a0">00037</a> <span class="preprocessor"></span><span class="keyword">extern</span> PVOID <a class="code" href="../../d8/d2/ldrinit_8c.html#a5">NtDllBase</a>;             <span class="comment">// defined in ntos\dll\ldrinit.c</span>
00038 <span class="preprocessor">#endif</span>
00039 <span class="preprocessor"></span>
00040 
00041 PVOID
<a name="l00042"></a><a class="code" href="../../d6/d4/pctohdr_8c.html#a1">00042</a> <a class="code" href="../../d6/d4/pctohdr_8c.html#a1">RtlPcToFileHeader</a>(
00043     IN PVOID PcValue,
00044     OUT PVOID *BaseOfImage
00045     )
00046 
00047 <span class="comment">/*++</span>
00048 <span class="comment"></span>
00049 <span class="comment">Routine Description:</span>
00050 <span class="comment"></span>
00051 <span class="comment">    This function returns the base of an image that contains the</span>
00052 <span class="comment">    specified PcValue. An image contains the PcValue if the PcValue</span>
00053 <span class="comment">    is within the ImageBase, and the ImageBase plus the size of the</span>
00054 <span class="comment">    virtual image.</span>
00055 <span class="comment"></span>
00056 <span class="comment">Arguments:</span>
00057 <span class="comment"></span>
00058 <span class="comment">    PcValue - Supplies a PcValue.  All of the modules mapped into the</span>
00059 <span class="comment">        calling processes address space are scanned to compute which</span>
00060 <span class="comment">        module contains the PcValue.</span>
00061 <span class="comment"></span>
00062 <span class="comment">    BaseOfImage - Returns the base address for the image containing the</span>
00063 <span class="comment">        PcValue.  This value must be added to any relative addresses in</span>
00064 <span class="comment">        the headers to locate portions of the image.</span>
00065 <span class="comment"></span>
00066 <span class="comment">Return Value:</span>
00067 <span class="comment"></span>
00068 <span class="comment">    NULL - No image was found that contains the PcValue.</span>
00069 <span class="comment"></span>
00070 <span class="comment">    NON-NULL - Returns the base address of the image that contain the</span>
00071 <span class="comment">        PcValue.</span>
00072 <span class="comment"></span>
00073 <span class="comment">--*/</span>
00074 
00075 {
00076 
00077 <span class="preprocessor">#if defined(NTOS_KERNEL_RUNTIME)</span>
00078 <span class="preprocessor"></span>
00079     <span class="keyword">extern</span> LIST_ENTRY <a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>;
00080     <span class="keyword">extern</span> KSPIN_LOCK <a class="code" href="../../d4/d4/alpha_2splocks_8c.html#a18">PsLoadedModuleSpinLock</a>;
00081 
00082     PVOID Base;
00083     ULONG_PTR Bounds;
00084     PLDR_DATA_TABLE_ENTRY Entry;
00085     PLIST_ENTRY Next;
00086     KIRQL OldIrql;
00087 
00088     <span class="comment">//</span>
00089     <span class="comment">// Acquire the loaded module list spinlock and scan the list for the</span>
00090     <span class="comment">// specified PC value if the list has been initialized.</span>
00091     <span class="comment">//</span>
00092 
00093     ExAcquireSpinLock(&amp;<a class="code" href="../../d4/d4/alpha_2splocks_8c.html#a18">PsLoadedModuleSpinLock</a>, &amp;OldIrql);
00094     Next = <a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>.Flink;
00095     <span class="keywordflow">if</span> (Next != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00096         <span class="keywordflow">while</span> (Next != &amp;<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>) {
00097             Entry = CONTAINING_RECORD(Next,
00098                                       LDR_DATA_TABLE_ENTRY,
00099                                       InLoadOrderLinks);
00100 
00101             Next = Next-&gt;Flink;
00102             Base = Entry-&gt;DllBase;
00103             Bounds = (ULONG_PTR)Base + Entry-&gt;SizeOfImage;
00104             <span class="keywordflow">if</span> (((ULONG_PTR)PcValue &gt;= (ULONG_PTR)Base) &amp;&amp; ((ULONG_PTR)PcValue &lt; Bounds)) {
00105                 ExReleaseSpinLock(&amp;<a class="code" href="../../d4/d4/alpha_2splocks_8c.html#a18">PsLoadedModuleSpinLock</a>, OldIrql);
00106                 *BaseOfImage = Base;
00107                 <span class="keywordflow">return</span> Base;
00108             }
00109         }
00110     }
00111 
00112     <span class="comment">//</span>
00113     <span class="comment">// Release the loaded module list spin lock and return NULL.</span>
00114     <span class="comment">//</span>
00115 
00116     ExReleaseSpinLock(&amp;<a class="code" href="../../d4/d4/alpha_2splocks_8c.html#a18">PsLoadedModuleSpinLock</a>, OldIrql);
00117     *BaseOfImage = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00118     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00119 
00120 <span class="preprocessor">#else</span>
00121 <span class="preprocessor"></span>
00122     PVOID Base;
00123     ULONG_PTR Bounds;
00124     PLDR_DATA_TABLE_ENTRY Entry;
00125     PLIST_ENTRY ModuleListHead;
00126     PLIST_ENTRY Next;
00127     PIMAGE_NT_HEADERS NtHeaders;
00128     PPEB Peb;
00129     PTEB Teb;
00130     MEMORY_BASIC_INFORMATION MemInfo;
00131     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
00132 
00133     <span class="comment">//</span>
00134     <span class="comment">// Acquire the Loader lock for the current process and scan the loaded</span>
00135     <span class="comment">// module list for the specified PC value if all the data structures</span>
00136     <span class="comment">// have been initialized.</span>
00137     <span class="comment">//</span>
00138 
00139     <span class="keywordflow">if</span> ( !RtlTryEnterCriticalSection((PRTL_CRITICAL_SECTION)NtCurrentPeb()-&gt;<a class="code" href="../../d8/d2/ldrinit_8c.html#a12">LoaderLock</a>) ) {
00140 
00141         <span class="comment">//</span>
00142         <span class="comment">// We could not get the loader lock, so call the system to find the image that</span>
00143         <span class="comment">// contains this pc</span>
00144         <span class="comment">//</span>
00145 
00146         st = <a class="code" href="../../d5/d3/queryvm_8c.html#a4">NtQueryVirtualMemory</a>(
00147                 NtCurrentProcess(),
00148                 PcValue,
00149                 MemoryBasicInformation,
00150                 (PVOID)&amp;MemInfo,
00151                 <span class="keyword">sizeof</span>(MemInfo),
00152                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00153                 );
00154         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
00155             MemInfo.AllocationBase = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;;
00156             }
00157         <span class="keywordflow">else</span> {
00158             <span class="keywordflow">if</span> ( MemInfo.Type == MEM_IMAGE ) {
00159                 <span class="keywordflow">try</span> {
00160                     *BaseOfImage = MemInfo.AllocationBase;
00161                     }
00162                 except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00163                     MemInfo.AllocationBase = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00164                     }
00165                 }
00166             <span class="keywordflow">else</span> {
00167                 MemInfo.AllocationBase = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;;
00168                 }
00169             }
00170         <span class="keywordflow">return</span> MemInfo.AllocationBase;
00171         }
00172 
00173     <span class="keywordflow">try</span> {
00174         Teb = NtCurrentTeb();
00175         <span class="keywordflow">if</span> (Teb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00176             Peb = Teb-&gt;ProcessEnvironmentBlock;
00177             <span class="keywordflow">if</span> (Peb-&gt;Ldr != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00178                 ModuleListHead = &amp;Peb-&gt;Ldr-&gt;InLoadOrderModuleList;
00179                 Next = ModuleListHead-&gt;Flink;
00180                 <span class="keywordflow">if</span> (Next != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00181                     <span class="keywordflow">while</span> (Next != ModuleListHead) {
00182                         Entry = CONTAINING_RECORD(Next,
00183                                                   LDR_DATA_TABLE_ENTRY,
00184                                                   InLoadOrderLinks);
00185 
00186                         Next = Next-&gt;Flink;
00187                         Base = Entry-&gt;DllBase;
00188                         NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(Base);
00189                         Bounds = (ULONG_PTR)Base + NtHeaders-&gt;OptionalHeader.SizeOfImage;
00190                         <span class="keywordflow">if</span> (((ULONG_PTR)PcValue &gt;= (ULONG_PTR)Base) &amp;&amp; ((ULONG_PTR)PcValue &lt; Bounds)) {
00191                             RtlLeaveCriticalSection((PRTL_CRITICAL_SECTION)NtCurrentPeb()-&gt;<a class="code" href="../../d8/d2/ldrinit_8c.html#a12">LoaderLock</a>);
00192                             *BaseOfImage = Base;
00193                             <span class="keywordflow">return</span> Base;
00194                         }
00195                     }
00196                 }
00197 
00198             } <span class="keywordflow">else</span> {
00199 
00200                 <span class="comment">//</span>
00201                 <span class="comment">//  ( Peb-&gt;Ldr == NULL )</span>
00202                 <span class="comment">//</span>
00203                 <span class="comment">//  If called during process intialization before the Ldr</span>
00204                 <span class="comment">//  module list has been setup, code executing must be in</span>
00205                 <span class="comment">//  NTDLL module.  If NtDllBase is non-NULL and the PcValue</span>
00206                 <span class="comment">//  falls into the NTDLL range, return a valid Base.  This</span>
00207                 <span class="comment">//  allows DbgPrint's during LdrpInitializeProcess to work</span>
00208                 <span class="comment">//  on RISC machines.</span>
00209                 <span class="comment">//</span>
00210 
00211                 <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d2/ldrinit_8c.html#a5">NtDllBase</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00212                     Base = <a class="code" href="../../d8/d2/ldrinit_8c.html#a5">NtDllBase</a>;
00213                     NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>( Base );
00214                     Bounds = (ULONG_PTR)Base + NtHeaders-&gt;OptionalHeader.SizeOfImage;
00215                     <span class="keywordflow">if</span> (((ULONG_PTR)PcValue &gt;= (ULONG_PTR)Base) &amp;&amp; ((ULONG_PTR)PcValue &lt; Bounds)) {
00216                         RtlLeaveCriticalSection((PRTL_CRITICAL_SECTION)NtCurrentPeb()-&gt;<a class="code" href="../../d8/d2/ldrinit_8c.html#a12">LoaderLock</a>);
00217                         *BaseOfImage = Base;
00218                         <span class="keywordflow">return</span> Base;
00219                     }
00220                 }
00221             }
00222         }
00223 
00224     } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00225         NOTHING;
00226     }
00227 
00228     <span class="comment">//</span>
00229     <span class="comment">// Release the Loader lock for the current process a return NULL.</span>
00230     <span class="comment">//</span>
00231 
00232     RtlLeaveCriticalSection((PRTL_CRITICAL_SECTION)NtCurrentPeb()-&gt;<a class="code" href="../../d8/d2/ldrinit_8c.html#a12">LoaderLock</a>);
00233     *BaseOfImage = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00234     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00235 
00236 <span class="preprocessor">#endif</span>
00237 <span class="preprocessor"></span>
00238 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:08 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
