<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: taskman.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>taskman.c</h1><a href="../../d6/d9/taskman_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: taskman.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* This module contains the core functions of the input sub-system</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 02-27-91 MikeHar      Created.</span>
00010 <span class="comment">* 02-23-92 MattFe       rewrote sleeptask</span>
00011 <span class="comment">* 09-07-93 DaveHart     Per-process nonpreemptive scheduler for</span>
00012 <span class="comment">*                       multiple WOW VDM support.</span>
00013 <span class="comment">\***************************************************************************/</span>
00014 
00015 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00016 <span class="preprocessor">#pragma hdrstop</span>
00017 <span class="preprocessor"></span>
00018 
00019 <span class="comment">/*</span>
00020 <span class="comment"> * WakeWowTask</span>
00021 <span class="comment"> *</span>
00022 <span class="comment"> * if needed the wowtask is woken by setting its event</span>
00023 <span class="comment"> * It is assumed that if any wow task is currently scheduled</span>
00024 <span class="comment"> * that it is a waste of time to wake the specified wow task</span>
00025 <span class="comment"> * since rescheduling will occur when the currently scheduled</span>
00026 <span class="comment"> * wow task enters xxxSleepTask</span>
00027 <span class="comment"> *</span>
00028 <span class="comment"> */</span>
00029 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00030"></a><a class="code" href="../../d4/d1/userk_8h.html#a1560">00030</a> <a class="code" href="../../d4/d1/userk_8h.html#a1560">WakeWowTask</a>(
00031    <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti
00032    )
00033 {
00034    <a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html">PWOWPROCESSINFO</a> pwpi;
00035 
00036    pwpi = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o6">pwpi</a>;
00037    <span class="keywordflow">if</span> (pwpi &amp;&amp; !pwpi-&gt;<a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html#o1">ptiScheduled</a>) {
00038        <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o35">pEventQueueServer</a>, <a class="code" href="../../d7/d8/exboosts_8h.html#a0">EVENT_INCREMENT</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00039        }
00040 }
00041 
00042 
00043 
00044 
00045 <span class="comment">/***************************************************************************\</span>
00046 <span class="comment">* InsertTask</span>
00047 <span class="comment">*</span>
00048 <span class="comment">* This function removes a task from its old location and inserts</span>
00049 <span class="comment">* in the proper prioritized location</span>
00050 <span class="comment">*</span>
00051 <span class="comment">* Find a place for this task such that it must be inserted</span>
00052 <span class="comment">* after any task with greater or equal priority and must be</span>
00053 <span class="comment">* before any task with higher priorty.  The higher the priority</span>
00054 <span class="comment">* the less urgent the task.</span>
00055 <span class="comment">*</span>
00056 <span class="comment">* History:</span>
00057 <span class="comment">* 19-Nov-1993 mikeke    Created</span>
00058 <span class="comment">\***************************************************************************/</span>
00059 
<a name="l00060"></a><a class="code" href="../../d4/d1/userk_8h.html#a1555">00060</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1555">InsertTask</a>(
00061     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppi,
00062     <a class="code" href="../../d0/d8/structtagTDB.html">PTDB</a> ptdbNew)
00063 {
00064     <a class="code" href="../../d0/d8/structtagTDB.html">PTDB</a> *pptdb;
00065     <a class="code" href="../../d0/d8/structtagTDB.html">PTDB</a> ptdb;
00066     <span class="keywordtype">int</span> nPriority;
00067     <a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html">PWOWPROCESSINFO</a> pwpi = ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o6">pwpi</a>;
00068 
00069     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00070 
00071     UserAssert(pwpi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00072 
00073     pptdb = &amp;pwpi-&gt;<a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html#o3">ptdbHead</a>;
00074     nPriority = ptdbNew-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o2">nPriority</a>;
00075 
00076     <span class="keywordflow">while</span> ((ptdb = *pptdb) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00077         <span class="comment">/*</span>
00078 <span class="comment">         * Remove it from it's old location</span>
00079 <span class="comment">         */</span>
00080         <span class="keywordflow">if</span> (ptdb == ptdbNew) {
00081             *pptdb = ptdbNew-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o0">ptdbNext</a>;
00082 
00083             <span class="comment">/*</span>
00084 <span class="comment">             * continue to search for the place to insert it</span>
00085 <span class="comment">             */</span>
00086             <span class="keywordflow">while</span> ((ptdb = *pptdb) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00087                 <span class="keywordflow">if</span> (nPriority &lt; ptdb-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o2">nPriority</a>) {
00088                     <span class="keywordflow">break</span>;
00089                 }
00090 
00091                 pptdb = &amp;(ptdb-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o0">ptdbNext</a>);
00092             }
00093             <span class="keywordflow">break</span>;
00094         }
00095 
00096         <span class="comment">/*</span>
00097 <span class="comment">         * if this is the place to insert continue to search for the</span>
00098 <span class="comment">         * place to delete it from</span>
00099 <span class="comment">         */</span>
00100         <span class="keywordflow">if</span> (nPriority &lt; ptdb-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o2">nPriority</a>) {
00101             <span class="keywordflow">do</span> {
00102                 <span class="keywordflow">if</span> (ptdb-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o0">ptdbNext</a> == ptdbNew) {
00103                     ptdb-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o0">ptdbNext</a> = ptdbNew-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o0">ptdbNext</a>;
00104                     <span class="keywordflow">break</span>;
00105                 }
00106                 ptdb = ptdb-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o0">ptdbNext</a>;
00107             } <span class="keywordflow">while</span> (ptdb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00108             <span class="keywordflow">break</span>;
00109         }
00110 
00111         pptdb = &amp;(ptdb-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o0">ptdbNext</a>);
00112     }
00113 
00114     <span class="comment">/*</span>
00115 <span class="comment">     * insert the new task</span>
00116 <span class="comment">     */</span>
00117     ptdbNew-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o0">ptdbNext</a> = *pptdb;
00118     *pptdb = ptdbNew;
00119 }
00120 
00121 
00122 <span class="comment">/***************************************************************************\</span>
00123 <span class="comment">* DestroyTask()</span>
00124 <span class="comment">*</span>
00125 <span class="comment">* History:</span>
00126 <span class="comment">* 02-27-91 MikeHar      Created.</span>
00127 <span class="comment">\***************************************************************************/</span>
00128 
<a name="l00129"></a><a class="code" href="../../d4/d1/userk_8h.html#a1194">00129</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1194">DestroyTask</a>(
00130     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppi,
00131     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiToRemove)
00132 {
00133     <a class="code" href="../../d0/d8/structtagTDB.html">PTDB</a> ptdbToRemove = ptiToRemove-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o22">ptdb</a>;
00134     <a class="code" href="../../d0/d8/structtagTDB.html">PTDB</a> ptdb;
00135     <a class="code" href="../../d0/d8/structtagTDB.html">PTDB</a>* pptdb;
00136     <a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html">PWOWPROCESSINFO</a> pwpi = ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o6">pwpi</a>;
00137 
00138     <span class="comment">// try to catch #150446</span>
00139     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00140     <a class="code" href="../../d4/d1/userk_8h.html#a159">BEGINATOMICCHECK</a>();
00141 
00142     UserAssert(pwpi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00143 
00144     <span class="keywordflow">if</span> (ptdbToRemove != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00145 
00146         <span class="keywordflow">if</span> (ptdbToRemove-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o6">TDB_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a374">TDBF_SETUP</a>) {
00147               <span class="comment">/*</span>
00148 <span class="comment">               * This means that the WoW app was a setup app (checked in SetAppCompatFlags).</span>
00149 <span class="comment">               * If so, the shell needs to be notified so it can clean up potential problems</span>
00150 <span class="comment">               * caused by bad calls to DDE, etc.   FritzS</span>
00151 <span class="comment">               */</span>
00152             <a class="code" href="../../d1/d3/structtagDESKTOPINFO.html">PDESKTOPINFO</a> pdeskinfo = <a class="code" href="../../d4/d1/userk_8h.html#a256">GETDESKINFO</a>(ptiToRemove);
00153             <span class="keywordflow">if</span> (pdeskinfo-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o5">spwndShell</a>) {
00154                 <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(pdeskinfo-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o5">spwndShell</a>, <a class="code" href="../../d4/d1/userk_8h.html#a375">DTM_SETUPAPPRAN</a>, 0, 0);
00155             }
00156         }
00157         <span class="comment">/*</span>
00158 <span class="comment">         * Remove the WOW per thread info</span>
00159 <span class="comment">         */</span>
00160         <span class="keywordflow">if</span> (ptdbToRemove-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o4">pwti</a>) {
00161             <a class="code" href="../../d8/d9/structtagWOWTHREADINFO.html">PWOWTHREADINFO</a> *ppwti = &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a27">gpwtiFirst</a>;
00162             <span class="keywordflow">while</span> (*ppwti != ptdbToRemove-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o4">pwti</a> &amp;&amp; (*ppwti)-&gt;<a class="code" href="../../d8/d9/structtagWOWTHREADINFO.html#o0">pwtiNext</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00163                 ppwti = &amp;((*ppwti)-&gt;pwtiNext);
00164             }
00165             <span class="keywordflow">if</span> (*ppwti == ptdbToRemove-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o4">pwti</a>) {
00166                  *ppwti = ptdbToRemove-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o4">pwti</a>-&gt;<a class="code" href="../../d8/d9/structtagWOWTHREADINFO.html#o0">pwtiNext</a>;
00167             }
00168             <a class="code" href="../../d4/d1/userk_8h.html#a367">CLOSE_PSEUDO_EVENT</a>(&amp;ptdbToRemove-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o4">pwti</a>-&gt;<a class="code" href="../../d8/d9/structtagWOWTHREADINFO.html#o4">pIdleEvent</a>);
00169             UserFreePool(ptdbToRemove-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o4">pwti</a>);
00170         }
00171 
00172         <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;nEvents -= ptdbToRemove-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o1">nEvents</a>;
00173 
00174         <span class="comment">/*</span>
00175 <span class="comment">         * remove it from any lists</span>
00176 <span class="comment">         */</span>
00177         pptdb = &amp;pwpi-&gt;<a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html#o3">ptdbHead</a>;
00178         <span class="keywordflow">while</span> ((ptdb = *pptdb) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00179             <span class="comment">/*</span>
00180 <span class="comment">             * Remove it from it's old location</span>
00181 <span class="comment">             */</span>
00182             <span class="keywordflow">if</span> (ptdb == ptdbToRemove) {
00183                 *pptdb = ptdb-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o0">ptdbNext</a>;
00184                 UserFreePool(ptdbToRemove);
00185                 UserAssert(ptiToRemove-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o22">ptdb</a> == ptdbToRemove);
00186                 ptiToRemove-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o22">ptdb</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00187                 <span class="keywordflow">break</span>;
00188             }
00189             pptdb = &amp;(ptdb-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o0">ptdbNext</a>);
00190         }
00191         UserAssert(ptdb == ptdbToRemove);  <span class="comment">// #150446 check that we actually found it</span>
00192     }
00193     <a class="code" href="../../d4/d1/userk_8h.html#a163">ENDATOMICCHECK</a>(); <span class="comment">// #150446</span>
00194 
00195     <span class="comment">/*</span>
00196 <span class="comment">     * If the task being destroyed is the active task, make nobody active.</span>
00197 <span class="comment">     * We will go through this code path for 32-bit threads that die while</span>
00198 <span class="comment">     * Win16 threads are waiting for a SendMessage reply from them.</span>
00199 <span class="comment">     */</span>
00200     <span class="keywordflow">if</span> (pwpi-&gt;<a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html#o1">ptiScheduled</a> == ptiToRemove) {
00201         pwpi-&gt;<a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html#o1">ptiScheduled</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00202         <a class="code" href="../../d4/d1/userk_8h.html#a1562">ExitWowCritSect</a>(ptiToRemove, pwpi);
00203 
00204         <span class="comment">/*</span>
00205 <span class="comment">         * If this active task was locked, remove lock so next guy can</span>
00206 <span class="comment">         * run.</span>
00207 <span class="comment">         */</span>
00208         pwpi-&gt;<a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html#o2">nTaskLock</a> = 0;
00209 
00210 
00211         <span class="comment">/*</span>
00212 <span class="comment">         * Wake next task with events, or wowexec to run the scheduler</span>
00213 <span class="comment">         */</span>
00214         <span class="keywordflow">if</span> (pwpi-&gt;<a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html#o3">ptdbHead</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00215             <a class="code" href="../../d0/d8/structtagTDB.html">PTDB</a> ptdb;
00216 
00217             <span class="keywordflow">for</span> (ptdb = pwpi-&gt;<a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html#o3">ptdbHead</a>; ptdb; ptdb = ptdb-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o0">ptdbNext</a>) {
00218                 <span class="keywordflow">if</span> (ptdb-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o1">nEvents</a> &gt; 0) {
00219                     <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(ptdb-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o3">pti</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o35">pEventQueueServer</a>,
00220                                <a class="code" href="../../d7/d8/exboosts_8h.html#a0">EVENT_INCREMENT</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00221                     <span class="keywordflow">break</span>;
00222                 }
00223             }
00224 
00225             <span class="keywordflow">if</span> (!ptdb) {
00226                 <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(pwpi-&gt;<a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html#o5">pEventWowExec</a>, <a class="code" href="../../d7/d8/exboosts_8h.html#a0">EVENT_INCREMENT</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00227             }
00228         }
00229     }
00230     UserAssert(ptiToRemove != pwpi-&gt;<a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html#o9">CSOwningThread</a>);
00231 
00232 }
00233 
00234 
00235 
00236 
00237 <span class="comment">/***************************************************************************\</span>
00238 <span class="comment">* xxxSleepTask</span>
00239 <span class="comment">*</span>
00240 <span class="comment">* This function puts this task to sleep and wakes the next (if any)</span>
00241 <span class="comment">* deserving task.</span>
00242 <span class="comment">*</span>
00243 <span class="comment">* BOOL   fInputIdle  - app is going idle, may do idle hooks</span>
00244 <span class="comment">* HANDLE hEvent      - if nonzero, WowExec's event (client side) for</span>
00245 <span class="comment">*                      virtual HW Interrupt HotPath.</span>
00246 <span class="comment">* History:</span>
00247 <span class="comment">* 02-27-91 MikeHar      Created.</span>
00248 <span class="comment">* 02-23-91 MattFe       rewrote</span>
00249 <span class="comment">* 12-17-93 Jonle        add wowexec hotpath for VirtualInterrupts</span>
00250 <span class="comment">\***************************************************************************/</span>
00251 
<a name="l00252"></a><a class="code" href="../../d4/d1/userk_8h.html#a1556">00252</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1556">xxxSleepTask</a>(
00253     BOOL   fInputIdle,
00254     HANDLE hEvent)
00255 {
00256     <a class="code" href="../../d0/d8/structtagTDB.html">PTDB</a> ptdb;
00257     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>     pti;
00258     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a>    ppi;
00259     <a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html">PWOWPROCESSINFO</a> pwpi;
00260     <a class="code" href="../../d4/d1/userk_8h.html#a871">PSMS</a>            psms;
00261     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00262     <span class="keywordtype">int</span>    nHandles;
00263     BOOLEAN bWaitedAtLeastOnce;
00264 
00265     <span class="comment">/*</span>
00266 <span class="comment">     * !!!</span>
00267 <span class="comment">     * ClearSendMessages assumes that this function does NOT leave the</span>
00268 <span class="comment">     * critical section when called with fInputIdle==FALSE and from a</span>
00269 <span class="comment">     * 32bit thread!</span>
00270 <span class="comment">     */</span>
00271 
00272     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00273 
00274     pti  = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00275     ppi  = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>;
00276     pwpi = ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o6">pwpi</a>;
00277 
00278     <span class="comment">/*</span>
00279 <span class="comment">     *  If this task has received a message from outside of the current</span>
00280 <span class="comment">     *  wow scheduler and hasn't yet replied to the message, the scheduler</span>
00281 <span class="comment">     *  will deadlock because the send\receive lock counts are updated</span>
00282 <span class="comment">     *  in ReplyMessage and not in receive message. Check for this</span>
00283 <span class="comment">     *  condition and do the DirectedSchedukeTask that normally occurs</span>
00284 <span class="comment">     *  in ReplyMessage. 16-Feb-1995 Jonle</span>
00285 <span class="comment">     */</span>
00286     psms = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o12">psmsCurrent</a>;
00287     <span class="keywordflow">if</span> (psms &amp;&amp; psms-&gt;ptiReceiver == pti &amp;&amp;
00288             psms-&gt;ptiSender &amp;&amp; !(psms-&gt;flags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a424">SMF_REPLY</a>) &amp;&amp;
00289             psms-&gt;flags &amp; (<a class="code" href="../../d4/d1/userk_8h.html#a435">SMF_RECEIVERBUSY</a> | <a class="code" href="../../d4/d1/userk_8h.html#a428">SMF_RECEIVEDMESSAGE</a>) &amp;&amp;
00290             psms-&gt;ptiSender-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a> &amp;&amp;
00291             (pwpi != psms-&gt;ptiSender-&gt;ppi-&gt;pwpi || !(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>)) ) {
00292         <a class="code" href="../../d4/d1/userk_8h.html#a1559">DirectedScheduleTask</a>(psms-&gt;ptiReceiver, psms-&gt;ptiSender, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, psms);
00293     }
00294 
00295 
00296     <span class="comment">/*</span>
00297 <span class="comment">     * return immediately if we are not 16 bit (don't have a pwpi)</span>
00298 <span class="comment">     */</span>
00299     <span class="keywordflow">if</span> (!(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>)) {
00300         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00301     }
00302 
00303 
00304     <span class="comment">/*</span>
00305 <span class="comment">     *  Deschedule the current task</span>
00306 <span class="comment">     */</span>
00307     <span class="keywordflow">if</span> (pti == pwpi-&gt;<a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html#o1">ptiScheduled</a>) {
00308         <a class="code" href="../../d4/d1/userk_8h.html#a1562">ExitWowCritSect</a>(pti, pwpi);
00309         <span class="keywordflow">if</span> (!pwpi-&gt;<a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html#o2">nTaskLock</a>) {
00310             pwpi-&gt;<a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html#o1">ptiScheduled</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00311             }
00312         }
00313     UserAssert(pti != pwpi-&gt;<a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html#o9">CSOwningThread</a>);
00314 
00315 
00316     <span class="comment">/*</span>
00317 <span class="comment">     *  If this is wowexec calling on WowWaitForMsgAndEvent</span>
00318 <span class="comment">     *  set up the WakeMask for all messages , and check for wake</span>
00319 <span class="comment">     *  bits set since the last time. Reinsert wowexec, at the end</span>
00320 <span class="comment">     *  of the list so other 16 bit tasks will be scheduled first.</span>
00321 <span class="comment">     */</span>
00322     <span class="keywordflow">if</span> (pwpi-&gt;<a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html#o6">hEventWowExecClient</a> == hEvent) {
00323         <a class="code" href="../../d4/d1/userk_8h.html#a1555">InsertTask</a>(ppi, pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o22">ptdb</a>);
00324         pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o4">fsWakeMask</a> = QS_ALLINPUT | QS_EVENT;
00325         <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o1">fsChangeBits</a> &amp; pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o4">fsWakeMask</a>) {
00326             pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o22">ptdb</a>-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o1">nEvents</a>++;
00327             <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;nEvents++;
00328         }
00329     }
00330 
00331 
00332     bWaitedAtLeastOnce = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00333 
00334     <span class="keywordflow">do</span> {
00335 
00336         <span class="comment">/*</span>
00337 <span class="comment">         * If nobody is Active look for the highest priority task with</span>
00338 <span class="comment">         * some events pending. if MsgWaitForMultiple call don't</span>
00339 <span class="comment">         * reschedule self</span>
00340 <span class="comment">         */</span>
00341 
00342         <span class="keywordflow">if</span> (pwpi-&gt;<a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html#o1">ptiScheduled</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00343 rescan:
00344             <span class="keywordflow">if</span> (pwpi-&gt;<a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html#o8">nRecvLock</a> &gt;= pwpi-&gt;<a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html#o7">nSendLock</a>) {
00345                 <span class="keywordflow">for</span> (ptdb = pwpi-&gt;<a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html#o3">ptdbHead</a>; ptdb; ptdb = ptdb-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o0">ptdbNext</a>) {
00346                     <span class="keywordflow">if</span> (ptdb-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o1">nEvents</a> &gt; 0 &amp;&amp;
00347                             !(hEvent == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a17">HEVENT_REMOVEME</a> &amp;&amp; ptdb-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o3">pti</a> == pti)) {
00348                         pwpi-&gt;<a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html#o1">ptiScheduled</a> = ptdb-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o3">pti</a>;
00349                         <span class="keywordflow">break</span>;
00350                     }
00351                 }
00352 
00353                 <span class="keywordflow">if</span> (bWaitedAtLeastOnce) {
00354                     <span class="comment">//</span>
00355                     <span class="comment">// If not first entry into sleep task avoid waiting</span>
00356                     <span class="comment">// more than needed, if the curr task is now scheduled.</span>
00357                     <span class="comment">//</span>
00358                     <span class="keywordflow">if</span> (pwpi-&gt;<a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html#o1">ptiScheduled</a> == pti) {
00359                         <span class="keywordflow">break</span>;
00360                     }
00361 
00362                 } <span class="keywordflow">else</span> {
00363                     <span class="comment">//</span>
00364                     <span class="comment">// On the first entry into sleep task input is going</span>
00365                     <span class="comment">// idle if no tasks are ready to run. Call the idle</span>
00366                     <span class="comment">// hook if there is one.</span>
00367                     <span class="comment">//</span>
00368                     <span class="keywordflow">if</span> (fInputIdle &amp;&amp;
00369                             pwpi-&gt;<a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html#o1">ptiScheduled</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
00370                             <a class="code" href="../../d6/d0/usercli_8h.html#a208">IsHooked</a>(pti, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a524">WHF_FOREGROUNDIDLE</a>)) {
00371 
00372                         <span class="comment">/*</span>
00373 <span class="comment">                         * Make this the active task so that no other</span>
00374 <span class="comment">                         * task will become active while we're calling</span>
00375 <span class="comment">                         * the hook.</span>
00376 <span class="comment">                         */</span>
00377                         pwpi-&gt;<a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html#o1">ptiScheduled</a> = pti;
00378                         <a class="code" href="../../d4/d1/userk_8h.html#a1521">xxxCallHook</a>(HC_ACTION, 0, 0, WH_FOREGROUNDIDLE);
00379 
00380                         <span class="comment">/*</span>
00381 <span class="comment">                         * Reset state so that no tasks are active.  We</span>
00382 <span class="comment">                         * then need to rescan the task list to see if</span>
00383 <span class="comment">                         * a task was scheduled during the call to the</span>
00384 <span class="comment">                         * hook.  Clear the input idle flag to ensure</span>
00385 <span class="comment">                         * that the hook won't be called again if there</span>
00386 <span class="comment">                         * are no tasks ready to run.</span>
00387 <span class="comment">                         */</span>
00388                         pwpi-&gt;<a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html#o1">ptiScheduled</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00389                         fInputIdle = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00390                         <span class="keywordflow">goto</span> rescan;
00391                     }
00392                 }
00393             }
00394 
00395 
00396             <span class="comment">/*</span>
00397 <span class="comment">             * If there is a task ready, wake it up.</span>
00398 <span class="comment">             */</span>
00399             <span class="keywordflow">if</span> (pwpi-&gt;<a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html#o1">ptiScheduled</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00400                 <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(pwpi-&gt;<a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html#o1">ptiScheduled</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o35">pEventQueueServer</a>,
00401                            <a class="code" href="../../d7/d8/exboosts_8h.html#a0">EVENT_INCREMENT</a>,
00402                            <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
00403                            );
00404 
00405             <span class="comment">/*</span>
00406 <span class="comment">             *  There is no one to wake up, but we may have to wake</span>
00407 <span class="comment">             *  wowexec to service virtual hardware interrupts</span>
00408 <span class="comment">             */</span>
00409             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ppi-&gt;W32PF_Flags &amp; W32PF_WAKEWOWEXEC) {
00410                 <span class="keywordflow">if</span> (pwpi-&gt;<a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html#o6">hEventWowExecClient</a> == hEvent) {
00411                     pwpi-&gt;<a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html#o1">ptiScheduled</a> = pti;
00412                     ppi-&gt;W32PF_Flags &amp;= ~W32PF_WAKEWOWEXEC;
00413                     <a class="code" href="../../d4/d1/userk_8h.html#a1555">InsertTask</a>(ppi, pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o22">ptdb</a>);
00414                     <a class="code" href="../../d4/d1/userk_8h.html#a1561">EnterWowCritSect</a>(pti, pwpi);
00415                     UserAssert(pti == pwpi-&gt;<a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html#o1">ptiScheduled</a>);
00416                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00417                 } <span class="keywordflow">else</span> {
00418                     <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(pwpi-&gt;<a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html#o5">pEventWowExec</a>, <a class="code" href="../../d7/d8/exboosts_8h.html#a0">EVENT_INCREMENT</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00419                 }
00420             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a806">TIF_SHAREDWOW</a>) &amp;&amp; !bWaitedAtLeastOnce) {
00421                 <span class="keywordflow">if</span> (pwpi-&gt;<a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html#o6">hEventWowExecClient</a> == hEvent) {
00422                     <span class="comment">/*</span>
00423 <span class="comment">                     * We have to call zzzWakeInputIdle only if this will</span>
00424 <span class="comment">                     * awake WowExec's thread and not other thread. Bug 44060.</span>
00425 <span class="comment">                     */</span>
00426                     <a class="code" href="../../d4/d1/userk_8h.html#a1636">zzzWakeInputIdle</a>(pti); <span class="comment">// need to DeferWinEventNotify() ?? IANJA ??</span>
00427                 }
00428             }
00429 
00430         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pwpi-&gt;<a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html#o2">nTaskLock</a> &gt; 0 &amp;&amp; pwpi-&gt;<a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html#o1">ptiScheduled</a> == pti
00431                    &amp;&amp; pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o22">ptdb</a>-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o1">nEvents</a> &gt; 0) {
00432              <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(pwpi-&gt;<a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html#o1">ptiScheduled</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o35">pEventQueueServer</a>,
00433                     <a class="code" href="../../d7/d8/exboosts_8h.html#a0">EVENT_INCREMENT</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00434         }
00435         <span class="comment">/*</span>
00436 <span class="comment">         *  return if we are a 32 bit thread, or if we were called by</span>
00437 <span class="comment">         *  MsgWaitForMultiple to exit the wow scheduler</span>
00438 <span class="comment">         */</span>
00439         <span class="keywordflow">if</span> (!(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>)) {
00440             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00441         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (hEvent == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a17">HEVENT_REMOVEME</a>) {
00442             <a class="code" href="../../d4/d1/userk_8h.html#a1555">InsertTask</a>(ppi, pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o22">ptdb</a>);
00443             <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o35">pEventQueueServer</a>);
00444             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00445         }
00446 
00447         <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o47">apEvent</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00448             pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o47">apEvent</a> = UserAllocPoolNonPaged(<a class="code" href="../../d4/d1/userk_8h.html#a368">POLL_EVENT_CNT</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>), TAG_EVENT);
00449             <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o47">apEvent</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00450                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00451         }
00452 
00453         <span class="comment">/*</span>
00454 <span class="comment">         * Wait for input to this thread.</span>
00455 <span class="comment">         */</span>
00456         pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o47">apEvent</a>[<a class="code" href="../../d4/d1/userk_8h.html#a372">IEV_TASK</a>] = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o35">pEventQueueServer</a>;
00457 
00458         <span class="comment">/*</span>
00459 <span class="comment">         * Add the WowExec, handle for virtual hw interrupts</span>
00460 <span class="comment">         */</span>
00461         <span class="keywordflow">if</span> (pwpi-&gt;<a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html#o6">hEventWowExecClient</a> == hEvent) {
00462             pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o47">apEvent</a>[<a class="code" href="../../d4/d1/userk_8h.html#a373">IEV_WOWEXEC</a>] = pwpi-&gt;<a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html#o5">pEventWowExec</a>;
00463             nHandles = 2;
00464         } <span class="keywordflow">else</span> {
00465             nHandles = 1;
00466         }
00467 
00468         <a class="code" href="../../d4/d1/userk_8h.html#a21">CheckForClientDeath</a>();
00469         <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
00470 
00471         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d7/wait_8c.html#a3">KeWaitForMultipleObjects</a>(nHandles,
00472                                           &amp;pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o47">apEvent</a>[<a class="code" href="../../d4/d1/userk_8h.html#a372">IEV_TASK</a>],
00473                                           WaitAny,
00474                                           <a class="code" href="../../d4/d9/ke_8h.html#a407a211">WrUserRequest</a>,
00475                                           <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>,
00476                                           <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00477                                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00478                                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00479 
00480         <a class="code" href="../../d4/d1/userk_8h.html#a21">CheckForClientDeath</a>();
00481 
00482         <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
00483 
00484         bWaitedAtLeastOnce = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00485 
00486         <span class="comment">// remember if we woke up for wowexec</span>
00487         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_WAIT_1) {
00488             ppi-&gt;W32PF_Flags |= W32PF_WAKEWOWEXEC;
00489         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_USER_APC) {
00490 
00491             <span class="comment">/*</span>
00492 <span class="comment">             * An alert was received.  This should only occur when the</span>
00493 <span class="comment">             * thread has been terminated.</span>
00494 <span class="comment">             * ClientDeliverUserApc() delivers User-mode APCs by calling back</span>
00495 <span class="comment">             * to the client and immediately returning without doing anything:</span>
00496 <span class="comment">             * KeUserModeCallback will automatically deliver any pending APCs.</span>
00497 <span class="comment">             */</span>
00498             UserAssert(<a class="code" href="../../d1/d9/ps_8h.html#a27">PsIsThreadTerminating</a>(<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()));
00499             <a class="code" href="../../d4/d1/userk_8h.html#a1928">ClientDeliverUserApc</a>();
00500         }
00501 
00502     } <span class="keywordflow">while</span> (pwpi-&gt;<a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html#o1">ptiScheduled</a> != pti);
00503 
00504 
00505     <span class="comment">/*</span>
00506 <span class="comment">     * We are the Active Task, reduce number of Events</span>
00507 <span class="comment">     * Place ourselves at the far end of tasks in the same priority</span>
00508 <span class="comment">     * so that next time we sleep someone else will run.</span>
00509 <span class="comment">     */</span>
00510     pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o22">ptdb</a>-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o1">nEvents</a>--;
00511     <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;nEvents--;
00512     UserAssert(<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;nEvents &gt;= 0);
00513 
00514     <a class="code" href="../../d4/d1/userk_8h.html#a1555">InsertTask</a>(ppi, pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o22">ptdb</a>);
00515 
00516     ppi-&gt;W32PF_Flags &amp;= ~W32PF_WAKEWOWEXEC;
00517 
00518     <a class="code" href="../../d4/d1/userk_8h.html#a1561">EnterWowCritSect</a>(pti, pwpi);
00519     UserAssert(pti == pwpi-&gt;<a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html#o1">ptiScheduled</a>);
00520 
00521 
00522 
00523     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00524 }
00525 
00526 
00527 
00528 <span class="comment">/***************************************************************************\</span>
00529 <span class="comment">* xxxUserYield</span>
00530 <span class="comment">*</span>
00531 <span class="comment">* Does exactly what Win3.1 UserYield does.</span>
00532 <span class="comment">*</span>
00533 <span class="comment">* History:</span>
00534 <span class="comment">* 10-19-92 Scottlu      Created.</span>
00535 <span class="comment">\***************************************************************************/</span>
00536 
<a name="l00537"></a><a class="code" href="../../d4/d1/userk_8h.html#a1557">00537</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1557">xxxUserYield</a>(
00538     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti)
00539 {
00540     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppi = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>;
00541 
00542     <span class="comment">/*</span>
00543 <span class="comment">     * Deal with any pending messages. Only call it this first time if</span>
00544 <span class="comment">     * this is the current running 16 bit app. In the case when starting</span>
00545 <span class="comment">     * up a 16 bit app, the starter calls UserYield() to yield to the new</span>
00546 <span class="comment">     * task, but at this time ppi-&gt;ptiScheduled is set to the new task.</span>
00547 <span class="comment">     * Receiving messages at this point would be bad!</span>
00548 <span class="comment">     */</span>
00549     <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>) {
00550         <span class="keywordflow">if</span> (pti == ppi-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o6">pwpi</a>-&gt;<a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html#o1">ptiScheduled</a>) {
00551             <a class="code" href="../../d4/d1/userk_8h.html#a502">xxxReceiveMessages</a>(pti);
00552         }
00553     } <span class="keywordflow">else</span> {
00554         <a class="code" href="../../d4/d1/userk_8h.html#a502">xxxReceiveMessages</a>(pti);
00555     }
00556 
00557     <span class="comment">/*</span>
00558 <span class="comment">     * If we are a 16 bit task</span>
00559 <span class="comment">     * Mark our task so it comes back some time.  Also, remove it and</span>
00560 <span class="comment">     * re-add it to the list so that we are the last task of our priority</span>
00561 <span class="comment">     * to run.</span>
00562 <span class="comment">     */</span>
00563     <span class="keywordflow">if</span> ((pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>) &amp;&amp; (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o22">ptdb</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00564        <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o22">ptdb</a>-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o1">nEvents</a> == 0) {
00565             pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o22">ptdb</a>-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o1">nEvents</a>++;
00566             <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;nEvents++;
00567         }
00568         <a class="code" href="../../d4/d1/userk_8h.html#a1555">InsertTask</a>(ppi, pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o22">ptdb</a>);
00569 
00570         <span class="comment">/*</span>
00571 <span class="comment">         * Sleep.  Return right away if there are no higher priority tasks</span>
00572 <span class="comment">         * in need of running.</span>
00573 <span class="comment">         */</span>
00574         <a class="code" href="../../d4/d1/userk_8h.html#a1556">xxxSleepTask</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00575 
00576         <span class="comment">/*</span>
00577 <span class="comment">         * Deal with any that arrived since we weren't executing.</span>
00578 <span class="comment">         */</span>
00579         <a class="code" href="../../d4/d1/userk_8h.html#a502">xxxReceiveMessages</a>(pti);
00580     }
00581 
00582 
00583     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00584 }
00585 
00586 
00587 <span class="comment">/***************************************************************************\</span>
00588 <span class="comment">* DirectedScheduleTask</span>
00589 <span class="comment">*</span>
00590 <span class="comment">* History:</span>
00591 <span class="comment">* 25-Jun-1992 mikeke    Created.</span>
00592 <span class="comment">\***************************************************************************/</span>
00593 
<a name="l00594"></a><a class="code" href="../../d4/d1/userk_8h.html#a1559">00594</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1559">DirectedScheduleTask</a>(
00595      <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiOld,
00596      <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiNew,
00597      BOOL bSendMsg,
00598      PSMS psms
00599      )
00600 {
00601     <a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html">PWOWPROCESSINFO</a> pwpiOld;
00602     <a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html">PWOWPROCESSINFO</a> pwpiNew;
00603 
00604     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00605 
00606     pwpiOld  = ptiOld-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o6">pwpi</a>;
00607     pwpiNew  = ptiNew-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o6">pwpi</a>;
00608 
00609 
00610     <span class="comment">/*</span>
00611 <span class="comment">     * If old task is 16 bit, reinsert the task in its wow scheduler list</span>
00612 <span class="comment">     * so that it is lowest in priority. Note that ptiOld is always the</span>
00613 <span class="comment">     * same as pwpiOld-&gt;ptiScheduled except when called from ReceiverDied.</span>
00614 <span class="comment">     */</span>
00615     <span class="keywordflow">if</span> (ptiOld-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>) {
00616 
00617         <span class="keywordflow">if</span> (pwpiOld-&gt;<a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html#o1">ptiScheduled</a> == ptiOld) {
00618             ptiOld-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o22">ptdb</a>-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o1">nEvents</a>++;
00619             <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;nEvents++;
00620             <a class="code" href="../../d4/d1/userk_8h.html#a1555">InsertTask</a>(ptiOld-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>, ptiOld-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o22">ptdb</a>);
00621             }
00622 
00623 
00624         <span class="comment">// Update the Send\Recv counts for interprocess scheduling in SleepTask</span>
00625 
00626         <span class="keywordflow">if</span> (pwpiOld != pwpiNew || !(ptiNew-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>)) {
00627             <span class="keywordflow">if</span> (bSendMsg) {
00628                 pwpiOld-&gt;<a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html#o7">nSendLock</a>++;
00629                 psms-&gt;flags |= <a class="code" href="../../d4/d1/userk_8h.html#a434">SMF_WOWSEND</a>;
00630                 }
00631             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pwpiOld-&gt;<a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html#o8">nRecvLock</a> &amp;&amp; psms-&gt;flags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a433">SMF_WOWRECEIVE</a>) {
00632                 pwpiOld-&gt;<a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html#o8">nRecvLock</a>--;
00633                 psms-&gt;flags &amp;= ~<a class="code" href="../../d4/d1/userk_8h.html#a433">SMF_WOWRECEIVE</a>;
00634                 }
00635             }
00636 
00637         }
00638 
00639 
00640     <span class="comment">/*</span>
00641 <span class="comment">     *  If the new task is 16 bit, reinsert into the wow scheduler list</span>
00642 <span class="comment">     *  so that it will run, if its a sendmsg raise priority of the receiver.</span>
00643 <span class="comment">     *  If its a reply and the sender is waiting for this psms or the sender</span>
00644 <span class="comment">     *  has a message to reply to raise priority of the sender.</span>
00645 <span class="comment">     */</span>
00646     <span class="keywordflow">if</span> (ptiNew-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>) {
00647         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bRaisePriority;
00648 
00649         ptiNew-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o22">ptdb</a>-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o1">nEvents</a>++;
00650         <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;nEvents++;
00651         bRaisePriority = bSendMsg || psms == ptiNew-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o11">psmsSent</a>;
00652 
00653         <span class="keywordflow">if</span> (bRaisePriority) {
00654             ptiNew-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o22">ptdb</a>-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o2">nPriority</a>--;
00655             }
00656 
00657         <a class="code" href="../../d4/d1/userk_8h.html#a1555">InsertTask</a>(ptiNew-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>, ptiNew-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o22">ptdb</a>);
00658 
00659         <span class="keywordflow">if</span> (bRaisePriority) {
00660             ptiNew-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o22">ptdb</a>-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o2">nPriority</a>++;
00661             <a class="code" href="../../d4/d1/userk_8h.html#a1560">WakeWowTask</a>(ptiNew);
00662             }
00663 
00664 
00665         <span class="comment">// Update the Send\Recv counts for interprocess scheduling in SleepTask</span>
00666 
00667         <span class="keywordflow">if</span> (pwpiOld != pwpiNew || !(ptiOld-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>)) {
00668             <span class="keywordflow">if</span> (bSendMsg) {
00669                 pwpiNew-&gt;<a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html#o8">nRecvLock</a>++;
00670                 psms-&gt;flags |= <a class="code" href="../../d4/d1/userk_8h.html#a433">SMF_WOWRECEIVE</a>;
00671                 }
00672             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pwpiNew-&gt;<a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html#o7">nSendLock</a> &amp;&amp; psms-&gt;flags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a434">SMF_WOWSEND</a>) {
00673                 pwpiNew-&gt;<a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html#o7">nSendLock</a>--;
00674                 psms-&gt;flags &amp;= ~<a class="code" href="../../d4/d1/userk_8h.html#a434">SMF_WOWSEND</a>;
00675                 }
00676             }
00677 
00678         }
00679 }
00680 
00681 
00682 
00683 
00684 <span class="comment">/***************************************************************************\</span>
00685 <span class="comment">* xxxDirectedYield</span>
00686 <span class="comment">*</span>
00687 <span class="comment">* History:</span>
00688 <span class="comment">* 09-17-92 JimA         Created.</span>
00689 <span class="comment">\***************************************************************************/</span>
00690 
<a name="l00691"></a><a class="code" href="../../d4/d1/userk_8h.html#a1558">00691</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1558">xxxDirectedYield</a>(
00692     DWORD dwThreadId)
00693 {
00694     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiOld;
00695     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiNew;
00696 
00697     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00698 
00699     ptiOld = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00700     <span class="keywordflow">if</span> (!(ptiOld-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>) || !ptiOld-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o6">pwpi</a>) {
00701          RIPMSG0(RIP_ERROR, <span class="stringliteral">"DirectedYield called from 32 bit thread!"</span>);
00702          <span class="keywordflow">return</span>;
00703          }
00704 
00705     <span class="comment">/*</span>
00706 <span class="comment">     *  If the old task is 16 bit, reinsert the task in its wow</span>
00707 <span class="comment">     *  scheduler list so that it is lowest in priority.</span>
00708 <span class="comment">     */</span>
00709     ptiOld-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o22">ptdb</a>-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o1">nEvents</a>++;
00710     <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;nEvents++;
00711     <a class="code" href="../../d4/d1/userk_8h.html#a1555">InsertTask</a>(ptiOld-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>, ptiOld-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o22">ptdb</a>);
00712 
00713     <span class="comment">/*</span>
00714 <span class="comment">     * -1 supports Win 3.1 OldYield mechanics</span>
00715 <span class="comment">     */</span>
00716     <span class="keywordflow">if</span> (dwThreadId != DY_OLDYIELD) {
00717 
00718         ptiNew = <a class="code" href="../../d4/d1/userk_8h.html#a1201">PtiFromThreadId</a>(dwThreadId);
00719         <span class="keywordflow">if</span> (ptiNew == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00720             <span class="keywordflow">return</span>;
00721 
00722         <span class="keywordflow">if</span> (ptiNew-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>) {
00723             ptiNew-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o22">ptdb</a>-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o1">nEvents</a>++;
00724             <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;nEvents++;
00725             ptiNew-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o22">ptdb</a>-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o2">nPriority</a>--;
00726             <a class="code" href="../../d4/d1/userk_8h.html#a1555">InsertTask</a>(ptiNew-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>, ptiNew-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o22">ptdb</a>);
00727             ptiNew-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o22">ptdb</a>-&gt;<a class="code" href="../../d0/d8/structtagTDB.html#o2">nPriority</a>++;
00728         }
00729     }
00730 
00731     <a class="code" href="../../d4/d1/userk_8h.html#a1556">xxxSleepTask</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00732 }
00733 
00734 
00735 <span class="comment">/***************************************************************************\</span>
00736 <span class="comment">* CurrentTaskLock</span>
00737 <span class="comment">*</span>
00738 <span class="comment">* Lock the current 16 bit task into the 16 bit scheduler</span>
00739 <span class="comment">*</span>
00740 <span class="comment">* Parameter:</span>
00741 <span class="comment">*   hlck    if NULL, lock the current 16 bit task and return a lock handle</span>
00742 <span class="comment">*           if valid lock handle, unlock the current task</span>
00743 <span class="comment">*</span>
00744 <span class="comment">* History:</span>
00745 <span class="comment">* 13-Apr-1992 jonpa      Created.</span>
00746 <span class="comment">\***************************************************************************/</span>
00747 <span class="preprocessor">#if 0 </span><span class="comment">/* WOW is not using this but they might some day */</span>
00748 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> CurrentTaskLock(
00749     DWORD hlck)
00750 {
00751     <a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html">PWOWPROCESSINFO</a> pwpi = <a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>()-&gt;pwpi;
00752 
00753     <span class="keywordflow">if</span> (!pwpi)
00754         <span class="keywordflow">return</span> 0;
00755 
00756     <span class="keywordflow">if</span> (hlck == 0) {
00757         pwpi-&gt;<a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html#o2">nTaskLock</a>++;
00758         <span class="keywordflow">return</span> ~(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)pwpi-&gt;<a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html#o1">ptiScheduled</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o22">ptdb</a>;
00759     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((~hlck) == (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)pwpi-&gt;<a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html#o1">ptiScheduled</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o22">ptdb</a>) {
00760         pwpi-&gt;<a class="code" href="../../d7/d9/structtagWOWPROCESSINFO.html#o2">nTaskLock</a>--;
00761     }
00762 
00763     <span class="keywordflow">return</span> 0;
00764 }
00765 <span class="preprocessor">#endif</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:57 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
