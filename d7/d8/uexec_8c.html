<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: uexec.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>uexec.c File Reference</h1><code>#include &lt;nt.h&gt;</code><br>
<code>#include &lt;ntrtl.h&gt;</code><br>
<code>#include &lt;nturtl.h&gt;</code><br>
<code>#include &lt;string.h&gt;</code><br>

<p>
<a href="../../d8/d7/uexec_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/uexec_8c.html#a1">main</a> (IN ULONG argc, IN PCH argv[], IN PCH envp[], IN ULONG DebugParameter OPTIONAL)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/uexec_8c.html#a0">MyHeap</a> = NULL</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a1" doxytag="uexec.c::main" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS main           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>argc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCH&nbsp;</td>
          <td class="mdname" nowrap> <em>argv</em>[], </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCH&nbsp;</td>
          <td class="mdname" nowrap> <em>envp</em>[], </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG DebugParameter&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/uexec_8c-source.html#l00030">30</a> of file <a class="el" href="../../d8/d7/uexec_8c-source.html">uexec.c</a>.
<p>
References <a class="el" href="../../d2/d0/bench_8c-source.html#l00050">CHAR</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d8/d7/uexec_8c-source.html#l00027">MyHeap</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d2/d1/psspnd_8c-source.html#l00138">NtResumeThread()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d2/d1/obwait_8c-source.html#l00282">NtWaitForSingleObject()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00022">RtlAllocateHeap</a>, <a class="el" href="../../d1/d1/rtlexec_8c-source.html#l00813">RtlCreateUserProcess()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>00036 {
00037     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00038     STRING ImagePathName;
00039     PCHAR PathVariable, *pp;
00040     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> ImageNameBuffer[ 128 ];
00041     RTL_USER_PROCESS_INFORMATION ProcessInformation;
00042     PRTL_USER_PROCESS_PARAMETERS ProcessParameters;
00043     ULONG i, CountBytes, envc, Bogus;
00044     PSTRING DstString;
00045     PCH Src, Dst;
00046     PCH Parameters[ RTL_USER_PROC_PARAMS_DEBUGFLAG+2 ];
00047 
00048     Parameters[ RTL_USER_PROC_PARAMS_IMAGEFILE ] =
00049          <span class="stringliteral">"Full Path Specification of Image File goes here"</span>;
00050 
00051     Parameters[ RTL_USER_PROC_PARAMS_CMDLINE ] =
00052          <span class="stringliteral">"Complete Command Line goes here"</span>;
00053 
00054     Parameters[ RTL_USER_PROC_PARAMS_DEBUGFLAG ] =
00055          <span class="stringliteral">"Debugging String goes here"</span>;
00056 
00057     Parameters[ RTL_USER_PROC_PARAMS_DEBUGFLAG+1 ] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00058 
00059     <a class="code" href="../../d7/d8/uexec_8c.html#a0">MyHeap</a> = RtlProcessHeap();
00060 
00061 <span class="preprocessor">#if DBG</span>
00062 <span class="preprocessor"></span>    <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"Entering UEXEC User Mode Test Program\n"</span> );
00063     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"argc = %ld\n"</span>, argc );
00064     <span class="keywordflow">for</span> (i=0; i&lt;=argc; i++) {
00065         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"argv[ %ld ]: %s\n"</span>,
00066                   i,
00067                   argv[ i ] ? argv[ i ] : <span class="stringliteral">"&lt;NULL&gt;"</span>
00068                 );
00069         }
00070     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"\n"</span> );
00071     <span class="keywordflow">for</span> (i=0; envp[i]; i++) {
00072         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"envp[ %ld ]: %s\n"</span>, i, envp[ i ] );
00073         }
00074 
00075 <span class="preprocessor">#endif</span>
00076 <span class="preprocessor"></span>
00077     PathVariable = <span class="stringliteral">"\\SystemRoot"</span>;
00078     <span class="keywordflow">if</span> (envp != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00079         pp = envp;
00080         <span class="keywordflow">while</span> (Src = *pp++) {
00081             <span class="keywordflow">if</span> (!_strnicmp( Src, <span class="stringliteral">"PATH="</span>, 5 )) {
00082                 PathVariable = Src+5;
00083                 <span class="keywordflow">break</span>;
00084                 }
00085             }
00086         }
00087 
00088     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"PATH=%s\n"</span>, PathVariable );
00089 
00090     ProcessParameters = (PRTL_USER_PROCESS_PARAMETERS)
00091                             <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>( MyHeap, 0, 2048 );
00092     ProcessParameters-&gt;MaximumLength = 2048;
00093 
00094     argv[ argc ] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00095     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = RtlVectorsToProcessParameters(
00096                 argv,
00097                 envp,
00098                 Parameters,
00099                 ProcessParameters
00100                 );
00101 
00102     ImagePathName.Buffer = ImageNameBuffer;
00103     ImagePathName.Length = 0;
00104     ImagePathName.MaximumLength = <span class="keyword">sizeof</span>( ImageNameBuffer );
00105     <span class="keywordflow">if</span> (RtlSearchPath( PathVariable, <span class="stringliteral">"uexec1.exe"</span>, NULL, &amp;ImagePathName )) {
00106         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d2/rtlexec_8c.html#a12">RtlCreateUserProcess</a>( &amp;ImagePathName,
00107                                        NULL,
00108                                        NULL,
00109                                        NULL,
00110                                        TRUE,
00111                                        NULL,
00112                                        NULL,
00113                                        ProcessParameters,
00114                                        &amp;ProcessInformation,
00115                                        NULL
00116                                      );
00117         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00118             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/psspnd_8c.html#a1">NtResumeThread</a>( ProcessInformation.Thread, &amp;Bogus );
00119             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00120 <span class="preprocessor">#if DBG</span>
00121 <span class="preprocessor"></span>                <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"UEXEC waiting for UEXEC1...\n"</span> );
00122 <span class="preprocessor">#endif</span>
00123 <span class="preprocessor"></span>                <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/obwait_8c.html#a4">NtWaitForSingleObject</a>( ProcessInformation.Process,
00124                                                 TRUE,
00125                                                 NULL
00126                                               );
00127                 }
00128             }
00129         }
00130     <span class="keywordflow">else</span> {
00131         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"UEXEC1.EXE not found in %s\n"</span>, PathVariable );
00132         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
00133         }
00134 
00135 <span class="preprocessor">#if DBG</span>
00136 <span class="preprocessor"></span>    <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"Leaving UEXEC User Mode Test Program\n"</span> );
00137 <span class="preprocessor">#endif</span>
00138 <span class="preprocessor"></span>
00139     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00140 }
</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a0" doxytag="uexec.c::MyHeap" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID <a class="el" href="../../d9/d9/urtl_8c.html#a0">MyHeap</a> = NULL          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/uexec_8c-source.html#l00027">27</a> of file <a class="el" href="../../d8/d7/uexec_8c-source.html">uexec.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d7/uexec_8c-source.html#l00030">main()</a>, and <a class="el" href="../../d0/d9/urtl_8c-source.html#l00080">VectorTest()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:51 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
