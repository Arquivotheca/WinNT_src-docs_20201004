<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: dll/resource.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>resource.c File Reference</h1><code>#include &lt;<a class="el" href="../../d0/d8/ntos_8h-source.html">ntos.h</a>&gt;</code><br>
<code>#include &lt;ntrtl.h&gt;</code><br>
<code>#include &lt;nturtl.h&gt;</code><br>
<code>#include &lt;<a class="el" href="../../d4/d8/heap_8h-source.html">heap.h</a>&gt;</code><br>
<code>#include "<a class="el" href="../../d0/d2/ldrp_8h-source.html">ldrp.h</a>"</code><br>

<p>
<a href="../../d8/d7/dll_2resource_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/dll_2resource_8c.html#a0">DESIRED_EVENT_ACCESS</a>&nbsp;&nbsp;&nbsp;(EVENT_QUERY_STATE | EVENT_MODIFY_STATE | SYNCHRONIZE)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/dll_2resource_8c.html#a1">DESIRED_SEMAPHORE_ACCESS</a>&nbsp;&nbsp;&nbsp;(SEMAPHORE_QUERY_STATE | SEMAPHORE_MODIFY_STATE | SYNCHRONIZE)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/dll_2resource_8c.html#a2">MAX_SPIN_COUNT</a>&nbsp;&nbsp;&nbsp;0x00ffffff</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/dll_2resource_8c.html#a3">PREALLOCATE_EVENT_MASK</a>&nbsp;&nbsp;&nbsp;0x80000000</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/dll_2resource_8c.html#a10">RtlDumpResource</a> (IN PRTL_RESOURCE <a class="el" href="../../d4/d0/tex_8c.html#a21">Resource</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/dll_2resource_8c.html#a11">RtlpInitDeferedCriticalSection</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PRTL_CRITICAL_SECTION_DEBUG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/dll_2resource_8c.html#a12">RtlpChainDebugInfo</a> (IN PVOID BaseAddress, IN ULONG <a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/dll_2resource_8c.html#a13">RtlpAllocateDebugInfo</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/dll_2resource_8c.html#a14">RtlpFreeDebugInfo</a> (IN PVOID DebugInfo)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/dll_2resource_8c.html#a15">RtlpCreateCriticalSectionSem</a> (IN PRTL_CRITICAL_SECTION CriticalSection)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/dll_2resource_8c.html#a16">NtdllOkayToLockRoutine</a> (IN PVOID Lock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/dll_2resource_8c.html#a17">RtlInitializeResource</a> (IN PRTL_RESOURCE <a class="el" href="../../d4/d0/tex_8c.html#a21">Resource</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/dll_2resource_8c.html#a18">RtlAcquireResourceShared</a> (IN PRTL_RESOURCE <a class="el" href="../../d4/d0/tex_8c.html#a21">Resource</a>, IN BOOLEAN Wait)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/dll_2resource_8c.html#a19">RtlAcquireResourceExclusive</a> (IN PRTL_RESOURCE <a class="el" href="../../d4/d0/tex_8c.html#a21">Resource</a>, IN BOOLEAN Wait)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/dll_2resource_8c.html#a20">RtlReleaseResource</a> (IN PRTL_RESOURCE <a class="el" href="../../d4/d0/tex_8c.html#a21">Resource</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/dll_2resource_8c.html#a21">RtlConvertSharedToExclusive</a> (IN PRTL_RESOURCE <a class="el" href="../../d4/d0/tex_8c.html#a21">Resource</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/dll_2resource_8c.html#a22">RtlConvertExclusiveToShared</a> (IN PRTL_RESOURCE <a class="el" href="../../d4/d0/tex_8c.html#a21">Resource</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/dll_2resource_8c.html#a23">RtlDeleteResource</a> (IN PRTL_RESOURCE <a class="el" href="../../d4/d0/tex_8c.html#a21">Resource</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/dll_2resource_8c.html#a24">RtlInitializeCriticalSection</a> (IN PRTL_CRITICAL_SECTION CriticalSection)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/dll_2resource_8c.html#a25">RtlEnableEarlyCriticalSectionEventCreation</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/dll_2resource_8c.html#a26">RtlInitializeCriticalSectionAndSpinCount</a> (IN PRTL_CRITICAL_SECTION CriticalSection, ULONG SpinCount)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/dll_2resource_8c.html#a27">RtlSetCriticalSectionSpinCount</a> (IN PRTL_CRITICAL_SECTION CriticalSection, ULONG SpinCount)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/dll_2resource_8c.html#a28">RtlpCheckDeferedCriticalSection</a> (IN PRTL_CRITICAL_SECTION CriticalSection)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/dll_2resource_8c.html#a29">RtlDeleteCriticalSection</a> (IN PRTL_CRITICAL_SECTION CriticalSection)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>void&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/dll_2resource_8c.html#a30">RtlpWaitForCriticalSection</a> (IN PRTL_CRITICAL_SECTION CriticalSection)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>void&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/dll_2resource_8c.html#a31">RtlpUnWaitCriticalSection</a> (IN PRTL_CRITICAL_SECTION CriticalSection)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>void&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/dll_2resource_8c.html#a32">RtlpNotOwnerCriticalSection</a> (IN PRTL_CRITICAL_SECTION CriticalSection)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>void&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/dll_2resource_8c.html#a33">RtlCheckForOrphanedCriticalSections</a> (IN HANDLE hThread)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/dll_2resource_8c.html#a4">LdrpShutdownInProgress</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>HANDLE&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/dll_2resource_8c.html#a5">LdrpShutdownThreadId</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>RTL_CRITICAL_SECTION&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/dll_2resource_8c.html#a6">DeferedCriticalSection</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>RTL_CRITICAL_SECTION_DEBUG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/dll_2resource_8c.html#a7">RtlpStaticDebugInfo</a> [64]</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PRTL_CRITICAL_SECTION_DEBUG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/dll_2resource_8c.html#a8">RtlpDebugInfoFreeList</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d8/dll_2resource_8c.html#a9">RtlpCritSectInitialized</a></td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="dll/resource.c::DESIRED_EVENT_ACCESS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DESIRED_EVENT_ACCESS&nbsp;&nbsp;&nbsp;(EVENT_QUERY_STATE | EVENT_MODIFY_STATE | SYNCHRONIZE)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00038">38</a> of file <a class="el" href="../../d8/d7/dll_2resource_8c-source.html">dll/resource.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01266">RtlInitializeCriticalSectionAndSpinCount()</a>, and <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01412">RtlpCreateCriticalSectionSem()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="dll/resource.c::DESIRED_SEMAPHORE_ACCESS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DESIRED_SEMAPHORE_ACCESS&nbsp;&nbsp;&nbsp;(SEMAPHORE_QUERY_STATE | SEMAPHORE_MODIFY_STATE | SYNCHRONIZE)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00041">41</a> of file <a class="el" href="../../d8/d7/dll_2resource_8c-source.html">dll/resource.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00247">RtlInitializeResource()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="dll/resource.c::MAX_SPIN_COUNT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MAX_SPIN_COUNT&nbsp;&nbsp;&nbsp;0x00ffffff          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01236">1236</a> of file <a class="el" href="../../d8/d7/dll_2resource_8c-source.html">dll/resource.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01266">RtlInitializeCriticalSectionAndSpinCount()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="dll/resource.c::PREALLOCATE_EVENT_MASK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PREALLOCATE_EVENT_MASK&nbsp;&nbsp;&nbsp;0x80000000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01237">1237</a> of file <a class="el" href="../../d8/d7/dll_2resource_8c-source.html">dll/resource.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01266">RtlInitializeCriticalSectionAndSpinCount()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a16" doxytag="dll/resource.c::NtdllOkayToLockRoutine" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN NtdllOkayToLockRoutine           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Lock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00236">236</a> of file <a class="el" href="../../d8/d7/dll_2resource_8c-source.html">dll/resource.c</a>.
<p>
<pre class="fragment"><div>00239 {
00240     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00241 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="dll/resource.c::RtlAcquireResourceExclusive" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN RtlAcquireResourceExclusive           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PRTL_RESOURCE&nbsp;</td>
          <td class="mdname" nowrap> <em>Resource</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Wait</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00515">515</a> of file <a class="el" href="../../d8/d7/dll_2resource_8c-source.html">dll/resource.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l02294">_ERESOURCE::ContentionCount</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d2/d1/obwait_8c-source.html#l00282">NtWaitForSingleObject()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/tex_8c-source.html#l01561">Resource</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00029">RtlImageNtHeader()</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00369">RtlpTimeout</a>, <a class="el" href="../../d6/d8/alpha_2exdsptch_8c-source.html#l00603">RtlRaiseException()</a>, <a class="el" href="../../d0/d9/ppc_2exdsptch_8c-source.html#l00563">RtlRaiseStatus()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>00522                    :
00523 
00524     The routine acquires <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource <span class="keywordflow">for</span> exclusive access.  Upon <span class="keywordflow">return</span> from
00525     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> acquired <span class="keywordflow">for</span> exclusive access.
00526 
00527 Arguments:
00528 
00529     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource to acquire
00530 
00531     Wait - Indicates <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> call <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allowed to wait <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource
00532         to become available <span class="keywordflow">for</span> must <span class="keywordflow">return</span> immediately
00533 
00534 Return Value:
00535 
00536     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> acquired and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise
00537 
00538 --*/
00539 
00540 {
00541     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00542     ULONG TimeoutCount = 0;
00543     PLARGE_INTEGER TimeoutTime = &amp;<a class="code" href="../../d9/d2/ldrp_8h.html#a32">RtlpTimeout</a>;
00544 
00545     <span class="comment">//</span>
00546     <span class="comment">//  Loop until the resource is ours or exit if we cannot wait.</span>
00547     <span class="comment">//</span>
00548 
00549     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00550 
00551         <span class="comment">//</span>
00552         <span class="comment">//  Enter the critical section</span>
00553         <span class="comment">//</span>
00554 
00555         RtlEnterCriticalSection(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;CriticalSection);
00556 
00557         <span class="comment">//</span>
00558         <span class="comment">//  If there are no shared users and it is not currently acquired for</span>
00559         <span class="comment">//  exclusive use then we can acquire the resource for exclusive</span>
00560         <span class="comment">//  access.  We also can acquire it if the resource indicates exclusive</span>
00561         <span class="comment">//  access but there isn't currently an owner.</span>
00562         <span class="comment">//</span>
00563 
00564         <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive == 0)
00565 
00566                 ||
00567 
00568             ((<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive == -1) &amp;&amp;
00569              (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;ExclusiveOwnerThread == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>))) {
00570 
00571             <span class="comment">//</span>
00572             <span class="comment">//  The resource is ours, so indicate that we have it and</span>
00573             <span class="comment">//  exit the critical section</span>
00574             <span class="comment">//</span>
00575 
00576             <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive = -1;
00577 
00578             <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;ExclusiveOwnerThread = NtCurrentTeb()-&gt;ClientId.UniqueThread;
00579 
00580             RtlLeaveCriticalSection(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;CriticalSection);
00581 
00582             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00583 
00584         }
00585 
00586         <span class="comment">//</span>
00587         <span class="comment">//  Otherwise check to see if we already have exclusive access to the</span>
00588         <span class="comment">//  resource and can simply recusively acquire it again.</span>
00589         <span class="comment">//</span>
00590 
00591         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;ExclusiveOwnerThread == NtCurrentTeb()-&gt;ClientId.UniqueThread) {
00592 
00593             <span class="comment">//</span>
00594             <span class="comment">//  The resource is ours (recusively) so indicate that we have it</span>
00595             <span class="comment">//  and exit the critial section</span>
00596             <span class="comment">//</span>
00597 
00598             <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive -= 1;
00599 
00600             RtlLeaveCriticalSection(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;CriticalSection);
00601 
00602             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00603 
00604         }
00605 
00606         <span class="comment">//</span>
00607         <span class="comment">//  Check if we are allowed to wait or must return immedately, and</span>
00608         <span class="comment">//  indicate that we didn't acquire the resource</span>
00609         <span class="comment">//</span>
00610 
00611         <span class="keywordflow">if</span> (!Wait) {
00612 
00613             RtlLeaveCriticalSection(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;CriticalSection);
00614 
00615             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00616 
00617         }
00618 
00619         <span class="comment">//</span>
00620         <span class="comment">//  Otherwise we need to wait to acquire the resource.</span>
00621         <span class="comment">//  To wait we will increment the number of waiting exclusive,</span>
00622         <span class="comment">//  release the lock, and wait on the exclusive semaphore</span>
00623         <span class="comment">//</span>
00624 
00625         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfWaitingExclusive += 1;
00626         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;DebugInfo-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o7">ContentionCount</a>++;
00627 
00628         RtlLeaveCriticalSection(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;CriticalSection);
00629 
00630 rewait:
00631         <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;Flags &amp; RTL_RESOURCE_FLAG_LONG_TERM ) {
00632             TimeoutTime = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00633         }
00634         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/obwait_8c.html#a4">NtWaitForSingleObject</a>(
00635                     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;ExclusiveSemaphore,
00636                     FALSE,
00637                     TimeoutTime
00638                     );
00639         <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_TIMEOUT ) {
00640             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"RTL: Acquire Exclusive Sem Timeout %d (2 minutes)\n"</span>,TimeoutCount);
00641             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"RTL: Resource at %p\n"</span>,Resource);
00642             TimeoutCount++;
00643             <span class="keywordflow">if</span> ( TimeoutCount &gt; 2 ) {
00644                 PIMAGE_NT_HEADERS NtHeaders;
00645 
00646                 <span class="comment">//</span>
00647                 <span class="comment">// If the image is a Win32 image, then raise an exception and try to get to the</span>
00648                 <span class="comment">// uae popup</span>
00649                 <span class="comment">//</span>
00650 
00651                 NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(NtCurrentPeb()-&gt;ImageBaseAddress);
00652 
00653                 <span class="keywordflow">if</span> (NtHeaders-&gt;OptionalHeader.Subsystem == IMAGE_SUBSYSTEM_WINDOWS_CUI ||
00654                     NtHeaders-&gt;OptionalHeader.Subsystem == IMAGE_SUBSYSTEM_WINDOWS_GUI) {
00655                     EXCEPTION_RECORD ExceptionRecord;
00656 
00657                     ExceptionRecord.ExceptionCode = STATUS_POSSIBLE_DEADLOCK;
00658                     ExceptionRecord.ExceptionFlags = 0;
00659                     ExceptionRecord.ExceptionRecord = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00660                     ExceptionRecord.ExceptionAddress = (PVOID)<a class="code" href="../../d5/d9/alpha_2exdsptch_8c.html#a17">RtlRaiseException</a>;
00661                     ExceptionRecord.NumberParameters = 1;
00662                     ExceptionRecord.ExceptionInformation[0] = (ULONG_PTR)<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>;
00663                     <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a9">RtlRaiseException</a>(&amp;ExceptionRecord);
00664                     }
00665                 <span class="keywordflow">else</span> {
00666                     DbgBreakPoint();
00667                     }
00668                 }
00669             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"RTL: Re-Waiting\n"</span>);
00670             <span class="keywordflow">goto</span> rewait;
00671         }
00672         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
00673             <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(Status);
00674             }
00675     }
00676 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="dll/resource.c::RtlAcquireResourceShared" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN RtlAcquireResourceShared           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PRTL_RESOURCE&nbsp;</td>
          <td class="mdname" nowrap> <em>Resource</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Wait</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00350">350</a> of file <a class="el" href="../../d8/d7/dll_2resource_8c-source.html">dll/resource.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l02294">_ERESOURCE::ContentionCount</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d2/d1/obwait_8c-source.html#l00282">NtWaitForSingleObject()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/tex_8c-source.html#l01561">Resource</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00029">RtlImageNtHeader()</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00369">RtlpTimeout</a>, <a class="el" href="../../d6/d8/alpha_2exdsptch_8c-source.html#l00603">RtlRaiseException()</a>, <a class="el" href="../../d0/d9/ppc_2exdsptch_8c-source.html#l00563">RtlRaiseStatus()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>00357                    :
00358 
00359     The routine acquires <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource <span class="keywordflow">for</span> shared access.  Upon <span class="keywordflow">return</span> from
00360     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> acquired <span class="keywordflow">for</span> shared access.
00361 
00362 Arguments:
00363 
00364     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource to acquire
00365 
00366     Wait - Indicates <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> call <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allowed to wait <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource
00367         to become available <span class="keywordflow">for</span> must <span class="keywordflow">return</span> immediately
00368 
00369 Return Value:
00370 
00371     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> acquired and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise
00372 
00373 --*/
00374 
00375 {
00376     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00377     ULONG TimeoutCount = 0;
00378     PLARGE_INTEGER TimeoutTime = &amp;<a class="code" href="../../d9/d2/ldrp_8h.html#a32">RtlpTimeout</a>;
00379     <span class="comment">//</span>
00380     <span class="comment">//  Enter the critical section</span>
00381     <span class="comment">//</span>
00382 
00383     RtlEnterCriticalSection(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;CriticalSection);
00384 
00385     <span class="comment">//</span>
00386     <span class="comment">//  If it is not currently acquired for exclusive use then we can acquire</span>
00387     <span class="comment">//  the resource for shared access.  Note that this can potentially</span>
00388     <span class="comment">//  starve an exclusive waiter however, this is necessary given the</span>
00389     <span class="comment">//  ability to recursively acquire the resource shared.  Otherwise we</span>
00390     <span class="comment">//  might/will reach a deadlock situation where a thread tries to acquire</span>
00391     <span class="comment">//  the resource recusively shared but is blocked by an exclusive waiter.</span>
00392     <span class="comment">//</span>
00393     <span class="comment">//  The test to reanable not starving an exclusive waiter is:</span>
00394     <span class="comment">//</span>
00395     <span class="comment">//      if ((Resource-&gt;NumberOfWaitingExclusive == 0) &amp;&amp;</span>
00396     <span class="comment">//          (Resource-&gt;NumberOfActive &gt;= 0)) {</span>
00397     <span class="comment">//</span>
00398 
00399     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive &gt;= 0) {
00400 
00401         <span class="comment">//</span>
00402         <span class="comment">//  The resource is ours, so indicate that we have it and</span>
00403         <span class="comment">//  exit the critical section</span>
00404         <span class="comment">//</span>
00405 
00406         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive += 1;
00407 
00408         RtlLeaveCriticalSection(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;CriticalSection);
00409 
00410     <span class="comment">//</span>
00411     <span class="comment">//  Otherwise check to see if this thread is the one currently holding</span>
00412     <span class="comment">//  exclusive access to the resource.  And if it is then we change</span>
00413     <span class="comment">//  this shared request to an exclusive recusive request and grant</span>
00414     <span class="comment">//  access to the resource.</span>
00415     <span class="comment">//</span>
00416 
00417     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;ExclusiveOwnerThread == NtCurrentTeb()-&gt;ClientId.UniqueThread) {
00418 
00419         <span class="comment">//</span>
00420         <span class="comment">//  The resource is ours (recusively) so indicate that we have it</span>
00421         <span class="comment">//  and exit the critial section</span>
00422         <span class="comment">//</span>
00423 
00424         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive -= 1;
00425 
00426         RtlLeaveCriticalSection(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;CriticalSection);
00427 
00428     <span class="comment">//</span>
00429     <span class="comment">//  Otherwise we'll have to wait for access.</span>
00430     <span class="comment">//</span>
00431 
00432     } <span class="keywordflow">else</span> {
00433 
00434         <span class="comment">//</span>
00435         <span class="comment">//  Check if we are allowed to wait or must return immedately, and</span>
00436         <span class="comment">//  indicate that we didn't acquire the resource</span>
00437         <span class="comment">//</span>
00438 
00439         <span class="keywordflow">if</span> (!Wait) {
00440 
00441             RtlLeaveCriticalSection(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;CriticalSection);
00442 
00443             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00444 
00445         }
00446 
00447         <span class="comment">//</span>
00448         <span class="comment">//  Otherwise we need to wait to acquire the resource.</span>
00449         <span class="comment">//  To wait we will increment the number of waiting shared,</span>
00450         <span class="comment">//  release the lock, and wait on the shared semaphore</span>
00451         <span class="comment">//</span>
00452 
00453         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfWaitingShared += 1;
00454         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;DebugInfo-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o7">ContentionCount</a>++;
00455 
00456         RtlLeaveCriticalSection(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;CriticalSection);
00457 
00458 rewait:
00459         <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;Flags &amp; RTL_RESOURCE_FLAG_LONG_TERM ) {
00460             TimeoutTime = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00461         }
00462         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/obwait_8c.html#a4">NtWaitForSingleObject</a>(
00463                     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;SharedSemaphore,
00464                     FALSE,
00465                     TimeoutTime
00466                     );
00467         <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_TIMEOUT ) {
00468             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"RTL: Acquire Shared Sem Timeout %d(2 minutes)\n"</span>,TimeoutCount);
00469             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"RTL: Resource at %p\n"</span>,Resource);
00470             TimeoutCount++;
00471             <span class="keywordflow">if</span> ( TimeoutCount &gt; 2 ) {
00472                 PIMAGE_NT_HEADERS NtHeaders;
00473 
00474                 <span class="comment">//</span>
00475                 <span class="comment">// If the image is a Win32 image, then raise an exception and try to get to the</span>
00476                 <span class="comment">// uae popup</span>
00477                 <span class="comment">//</span>
00478 
00479                 NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(NtCurrentPeb()-&gt;ImageBaseAddress);
00480 
00481                 <span class="keywordflow">if</span> (NtHeaders-&gt;OptionalHeader.Subsystem == IMAGE_SUBSYSTEM_WINDOWS_CUI ||
00482                     NtHeaders-&gt;OptionalHeader.Subsystem == IMAGE_SUBSYSTEM_WINDOWS_GUI) {
00483                     EXCEPTION_RECORD ExceptionRecord;
00484 
00485                     ExceptionRecord.ExceptionCode = STATUS_POSSIBLE_DEADLOCK;
00486                     ExceptionRecord.ExceptionFlags = 0;
00487                     ExceptionRecord.ExceptionRecord = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00488                     ExceptionRecord.ExceptionAddress = (PVOID)<a class="code" href="../../d5/d9/alpha_2exdsptch_8c.html#a17">RtlRaiseException</a>;
00489                     ExceptionRecord.NumberParameters = 1;
00490                     ExceptionRecord.ExceptionInformation[0] = (ULONG_PTR)<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>;
00491                     <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a9">RtlRaiseException</a>(&amp;ExceptionRecord);
00492                     }
00493                 <span class="keywordflow">else</span> {
00494                     DbgBreakPoint();
00495                     }
00496                 }
00497             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"RTL: Re-Waiting\n"</span>);
00498             <span class="keywordflow">goto</span> rewait;
00499         }
00500         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
00501             <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(Status);
00502             }
00503     }
00504 
00505     <span class="comment">//</span>
00506     <span class="comment">//  Now the resource is ours, for shared access</span>
00507     <span class="comment">//</span>
00508 
00509     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00510 
00511 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a33" doxytag="dll/resource.c::RtlCheckForOrphanedCriticalSections" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> void RtlCheckForOrphanedCriticalSections           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>hThread</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01788">1788</a> of file <a class="el" href="../../d8/d7/dll_2resource_8c-source.html">dll/resource.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00031">LdrpShutdownInProgress</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l02706">NtQueryInformationThread()</a>, <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00102">NtReadVirtualMemory()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00371">RtlCriticalSectionList</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00372">RtlCriticalSectionLock</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>01793                    :
01794 
01795     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called from kernel32's ExitThread and TerminateThread
01796     in an effort to track calls that kill threads <span class="keywordflow">while</span> they own
01797     critical sections.
01798 
01799 Arguments:
01800 
01801     hThread     -- thread to be killed
01802 
01803 Return Value:
01804 
01805     None.
01806 
01807 --*/
01808 {
01809     <span class="comment">//</span>
01810     <span class="comment">// This whole routine should be called only on checked builds.</span>
01811     <span class="comment">// It is a stub in the free build, so that a checked kernel32.dll</span>
01812     <span class="comment">// can bind against a free ntdll.dll</span>
01813     <span class="comment">//</span>
01814 <span class="preprocessor">#if DBG</span>
01815 <span class="preprocessor"></span>    <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01816     THREAD_BASIC_INFORMATION ThreadInfo;
01817     PLIST_ENTRY Entry;
01818     PRTL_CRITICAL_SECTION_DEBUG DebugInfo;
01819     PRTL_CRITICAL_SECTION CriticalSection;
01820     BOOLEAN OrphanAboutToHappen;
01821     RTL_CRITICAL_SECTION CritSectCopy;
01822 
01823     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d2/ldrinit_8c.html#a0">LdrpShutdownInProgress</a>) {
01824         <span class="comment">//</span>
01825         <span class="comment">// In the middle of shutting down the process</span>
01826         <span class="comment">//</span>
01827         <span class="keywordflow">return</span>;
01828     }
01829 
01830     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/psquery_8c.html#a20">NtQueryInformationThread</a>(
01831                             hThread,
01832                             ThreadBasicInformation,
01833                             &amp;ThreadInfo,
01834                             <span class="keyword">sizeof</span>(ThreadInfo),
01835                             NULL
01836                             );
01837     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01838         <span class="keywordflow">return</span>;
01839     }
01840 
01841     OrphanAboutToHappen = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01842 
01843     RtlEnterCriticalSection( &amp;RtlCriticalSectionLock );
01844 
01845     <span class="keywordflow">for</span> (Entry = <a class="code" href="../../d9/d2/ldrp_8h.html#a34">RtlCriticalSectionList</a>.Flink;
01846          Entry != &amp;<a class="code" href="../../d9/d2/ldrp_8h.html#a34">RtlCriticalSectionList</a>;
01847          Entry = Entry-&gt;Flink) {
01848 
01849         DebugInfo = CONTAINING_RECORD(Entry,
01850                                       RTL_CRITICAL_SECTION_DEBUG,
01851                                       ProcessLocksList);
01852 
01853         CriticalSection = DebugInfo-&gt;CriticalSection;
01854 
01855         <span class="keywordflow">if</span> (CriticalSection == &amp;<a class="code" href="../../d9/d2/ldrp_8h.html#a35">RtlCriticalSectionLock</a> ||
01856             CriticalSection == NtCurrentPeb()-&gt;LoaderLock) {
01857             <span class="comment">//</span>
01858             <span class="comment">// Skip these critsects.</span>
01859             <span class="comment">//</span>
01860             <span class="keywordflow">continue</span>;
01861         }
01862 
01863         <span class="comment">//</span>
01864         <span class="comment">// Call NtReadVirtualMemory() and make a copy of the critsect.</span>
01865         <span class="comment">// This won't AV and break to the debugger if the critsect's</span>
01866         <span class="comment">// memory has been freed without an RtlDeleteCriticalSection call.</span>
01867         <span class="comment">//</span>
01868         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d5/readwrt_8c.html#a9">NtReadVirtualMemory</a>(NtCurrentProcess(),
01869                                      CriticalSection,
01870                                      &amp;CritSectCopy,
01871                                      <span class="keyword">sizeof</span>(CritSectCopy),
01872                                      NULL);
01873         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) || CritSectCopy.DebugInfo != DebugInfo) {
01874             <span class="comment">//</span>
01875             <span class="comment">// Error reading the contents of the critsect.  The critsect</span>
01876             <span class="comment">// has probably been decommitted without a call to</span>
01877             <span class="comment">// RtlDeleteCriticalSection.  Ignore it.</span>
01878             <span class="comment">//</span>
01879             <span class="comment">// You might think the entry could be deleted from the list,</span>
01880             <span class="comment">// but it can't... there may be another RTL_CRITICAL_SECTION</span>
01881             <span class="comment">// out there that is truly allocated, and who DebugInfo pointer</span>
01882             <span class="comment">// points at this DebugInfo.  In that case, when that critsect</span>
01883             <span class="comment">// is deleted, the RtlCriticalSectionList is corrupted.</span>
01884             <span class="comment">//</span>
01885         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (CritSectCopy.OwningThread == ThreadInfo.ClientId.UniqueThread
01886                    &amp;&amp; CritSectCopy.LockCount != -1) {
01887             <span class="comment">//</span>
01888             <span class="comment">// The thread is about to die with a critical section locked.</span>
01889             <span class="comment">//</span>
01890             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"NTDLL:  Pid.Tid %x.%x Critsec %p about to be orphaned when owning thread is terminated.\n"</span>,
01891                      NtCurrentTeb()-&gt;ClientId.UniqueProcess,
01892                      NtCurrentTeb()-&gt;ClientId.UniqueThread,
01893                      CriticalSection);
01894             OrphanAboutToHappen = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01895         }
01896     }
01897 
01898     <span class="keywordflow">if</span> (OrphanAboutToHappen) {
01899 <span class="preprocessor">#if i386</span>
01900 <span class="preprocessor"></span>        _asm {  <span class="keywordtype">int</span> 3 }
01901 <span class="preprocessor">#else</span>
01902 <span class="preprocessor"></span>        DbgBreakPoint();
01903 <span class="preprocessor">#endif</span>
01904 <span class="preprocessor"></span>    }
01905 
01906     RtlLeaveCriticalSection( &amp;RtlCriticalSectionLock );
01907 <span class="preprocessor">#endif</span>
01908 <span class="preprocessor"></span>}
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="dll/resource.c::RtlConvertExclusiveToShared" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlConvertExclusiveToShared           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PRTL_RESOURCE&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Resource</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01061">1061</a> of file <a class="el" href="../../d8/d7/dll_2resource_8c-source.html">dll/resource.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d3/d5/semphore_8c-source.html#l00494">NtReleaseSemaphore()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/tex_8c-source.html#l01561">Resource</a>, <a class="el" href="../../d0/d9/ppc_2exdsptch_8c-source.html#l00563">RtlRaiseStatus()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
<pre class="fragment"><div>01067                    :
01068 
01069     This routine converts a resource acquired <span class="keywordflow">for</span> exclusive access into
01070     one acquired <span class="keywordflow">for</span> shared access.  Upon <span class="keywordflow">return</span> from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a>
01071     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> acquired <span class="keywordflow">for</span> shared access
01072 
01073 Arguments:
01074 
01075     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource to acquire <span class="keywordflow">for</span> shared access, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>
01076         must already be acquired <span class="keywordflow">for</span> exclusive access
01077 
01078 Return Value:
01079 
01080     None
01081 
01082 --*/
01083 
01084 {
01085     LONG PreviousCount;
01086     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01087 
01088     <span class="comment">//</span>
01089     <span class="comment">//  Enter the critical section</span>
01090     <span class="comment">//</span>
01091 
01092     RtlEnterCriticalSection(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;CriticalSection);
01093 
01094     <span class="comment">//</span>
01095     <span class="comment">//  If there is only one shared user (it's us) and we can acquire the</span>
01096     <span class="comment">//  resource for exclusive access.</span>
01097     <span class="comment">//</span>
01098 
01099     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive == -1) {
01100 
01101         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;ExclusiveOwnerThread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01102 
01103         <span class="comment">//</span>
01104         <span class="comment">//  Check to see if there are waiting shared, who should now get the</span>
01105         <span class="comment">//  resource along with us</span>
01106         <span class="comment">//</span>
01107 
01108         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfWaitingShared &gt; 0) {
01109 
01110             <span class="comment">//</span>
01111             <span class="comment">//  Set the new state to indicate that all of the shared requesters</span>
01112             <span class="comment">//  have access including us, and there are no more waiting shared</span>
01113             <span class="comment">//  requesters, and then release all of the shared requsters</span>
01114             <span class="comment">//</span>
01115 
01116             <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive = <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfWaitingShared + 1;
01117 
01118             <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfWaitingShared = 0;
01119 
01120             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d6/semphore_8c.html#a7">NtReleaseSemaphore</a>(
01121                          <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;SharedSemaphore,
01122                          <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive - 1,
01123                          &amp;PreviousCount
01124                          );
01125             <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
01126                 <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(Status);
01127                 }
01128 
01129         } <span class="keywordflow">else</span> {
01130 
01131             <span class="comment">//</span>
01132             <span class="comment">//  There is no one waiting for shared access so it's only ours</span>
01133             <span class="comment">//</span>
01134 
01135             <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive = 1;
01136 
01137         }
01138 
01139         RtlLeaveCriticalSection(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;CriticalSection);
01140 
01141         <span class="keywordflow">return</span>;
01142 
01143     }
01144 
01145     <span class="comment">//</span>
01146     <span class="comment">//  The resource is not currently acquired for exclusive, or we've</span>
01147     <span class="comment">//  recursively acquired it, so this must be a spurious call</span>
01148     <span class="comment">//</span>
01149 
01150 <span class="preprocessor">#if DBG</span>
01151 <span class="preprocessor"></span>    <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"NTDLL:  Failed error - SHARED_RESOURCE_CONV_ERROR\n"</span>);
01152     DbgBreakPoint();
01153 <span class="preprocessor">#endif</span>
01154 <span class="preprocessor"></span>}

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="dll/resource.c::RtlConvertSharedToExclusive" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlConvertSharedToExclusive           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PRTL_RESOURCE&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Resource</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00851">851</a> of file <a class="el" href="../../d8/d7/dll_2resource_8c-source.html">dll/resource.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l02294">_ERESOURCE::ContentionCount</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d2/d1/obwait_8c-source.html#l00282">NtWaitForSingleObject()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/tex_8c-source.html#l01561">Resource</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00029">RtlImageNtHeader()</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00369">RtlpTimeout</a>, <a class="el" href="../../d6/d8/alpha_2exdsptch_8c-source.html#l00603">RtlRaiseException()</a>, <a class="el" href="../../d0/d9/ppc_2exdsptch_8c-source.html#l00563">RtlRaiseStatus()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>00857                    :
00858 
00859     This routine converts a resource acquired <span class="keywordflow">for</span> shared access into
00860     one acquired <span class="keywordflow">for</span> exclusive access.  Upon <span class="keywordflow">return</span> from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a>
00861     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> acquired <span class="keywordflow">for</span> exclusive access
00862 
00863 Arguments:
00864 
00865     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource to acquire <span class="keywordflow">for</span> shared access, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>
00866         must already be acquired <span class="keywordflow">for</span> shared access
00867 
00868 Return Value:
00869 
00870     None
00871 
00872 --*/
00873 
00874 {
00875     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00876     ULONG TimeoutCount = 0;
00877 
00878     <span class="comment">//</span>
00879     <span class="comment">//  Enter the critical section</span>
00880     <span class="comment">//</span>
00881 
00882     RtlEnterCriticalSection(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;CriticalSection);
00883 
00884     <span class="comment">//</span>
00885     <span class="comment">//  If there is only one shared user (it's us) and we can acquire the</span>
00886     <span class="comment">//  resource for exclusive access.</span>
00887     <span class="comment">//</span>
00888 
00889     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive == 1) {
00890 
00891         <span class="comment">//</span>
00892         <span class="comment">//  The resource is ours, so indicate that we have it and</span>
00893         <span class="comment">//  exit the critical section, and return</span>
00894         <span class="comment">//</span>
00895 
00896         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive = -1;
00897 
00898         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;ExclusiveOwnerThread = NtCurrentTeb()-&gt;ClientId.UniqueThread;
00899 
00900         RtlLeaveCriticalSection(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;CriticalSection);
00901 
00902         <span class="keywordflow">return</span>;
00903     }
00904 
00905     <span class="comment">//</span>
00906     <span class="comment">//  If the resource is currently acquired exclusive and it's us then</span>
00907     <span class="comment">//  we already have exclusive access</span>
00908     <span class="comment">//</span>
00909 
00910     <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive &lt; 0) &amp;&amp;
00911         (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;ExclusiveOwnerThread == NtCurrentTeb()-&gt;ClientId.UniqueThread)) {
00912 
00913         <span class="comment">//</span>
00914         <span class="comment">//  We already have exclusive access to the resource so we'll just</span>
00915         <span class="comment">//  exit the critical section and return</span>
00916         <span class="comment">//</span>
00917 
00918         RtlLeaveCriticalSection(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;CriticalSection);
00919 
00920         <span class="keywordflow">return</span>;
00921     }
00922 
00923     <span class="comment">//</span>
00924     <span class="comment">//  If the resource is acquired by more than one shared then we need</span>
00925     <span class="comment">//  to wait to get exclusive access to the resource</span>
00926     <span class="comment">//</span>
00927 
00928     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive &gt; 1) {
00929 
00930         <span class="comment">//</span>
00931         <span class="comment">//  To wait we will decrement the fact that we have the resource for</span>
00932         <span class="comment">//  shared, and then loop waiting on the exclusive lock, and then</span>
00933         <span class="comment">//  testing to see if we can get exclusive access to the resource</span>
00934         <span class="comment">//</span>
00935 
00936         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive -= 1;
00937 
00938         <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00939 
00940             <span class="comment">//</span>
00941             <span class="comment">//  Increment the number of waiting exclusive, exit and critical</span>
00942             <span class="comment">//  section and wait on the exclusive semaphore</span>
00943             <span class="comment">//</span>
00944 
00945             <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfWaitingExclusive += 1;
00946             <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;DebugInfo-&gt;<a class="code" href="../../d6/d4/struct__ERESOURCE.html#o7">ContentionCount</a>++;
00947 
00948             RtlLeaveCriticalSection(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;CriticalSection);
00949 rewait:
00950         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/obwait_8c.html#a4">NtWaitForSingleObject</a>(
00951                     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;ExclusiveSemaphore,
00952                     FALSE,
00953                     &amp;RtlpTimeout
00954                     );
00955         <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_TIMEOUT ) {
00956             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"RTL: Convert Exclusive Sem Timeout %d (2 minutes)\n"</span>,TimeoutCount);
00957             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"RTL: Resource at %p\n"</span>,Resource);
00958             TimeoutCount++;
00959             <span class="keywordflow">if</span> ( TimeoutCount &gt; 2 ) {
00960                 PIMAGE_NT_HEADERS NtHeaders;
00961 
00962                 <span class="comment">//</span>
00963                 <span class="comment">// If the image is a Win32 image, then raise an exception and try to get to the</span>
00964                 <span class="comment">// uae popup</span>
00965                 <span class="comment">//</span>
00966 
00967                 NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(NtCurrentPeb()-&gt;ImageBaseAddress);
00968 
00969                 <span class="keywordflow">if</span> (NtHeaders-&gt;OptionalHeader.Subsystem == IMAGE_SUBSYSTEM_WINDOWS_CUI ||
00970                     NtHeaders-&gt;OptionalHeader.Subsystem == IMAGE_SUBSYSTEM_WINDOWS_GUI) {
00971                     EXCEPTION_RECORD ExceptionRecord;
00972 
00973                     ExceptionRecord.ExceptionCode = STATUS_POSSIBLE_DEADLOCK;
00974                     ExceptionRecord.ExceptionFlags = 0;
00975                     ExceptionRecord.ExceptionRecord = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00976                     ExceptionRecord.ExceptionAddress = (PVOID)<a class="code" href="../../d5/d9/alpha_2exdsptch_8c.html#a17">RtlRaiseException</a>;
00977                     ExceptionRecord.NumberParameters = 1;
00978                     ExceptionRecord.ExceptionInformation[0] = (ULONG_PTR)<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>;
00979                     <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a9">RtlRaiseException</a>(&amp;ExceptionRecord);
00980                     }
00981                 <span class="keywordflow">else</span> {
00982                     DbgBreakPoint();
00983                     }
00984                 }
00985             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"RTL: Re-Waiting\n"</span>);
00986             <span class="keywordflow">goto</span> rewait;
00987         }
00988             <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
00989                 <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(Status);
00990                 }
00991 
00992             <span class="comment">//</span>
00993             <span class="comment">//  Enter the critical section</span>
00994             <span class="comment">//</span>
00995 
00996             RtlEnterCriticalSection(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;CriticalSection);
00997 
00998             <span class="comment">//</span>
00999             <span class="comment">//  If there are no shared users and it is not currently acquired</span>
01000             <span class="comment">//  for exclusive use then we can acquire the resource for</span>
01001             <span class="comment">//  exclusive access.  We can also acquire it if the resource</span>
01002             <span class="comment">//  indicates exclusive access but there isn't currently an owner</span>
01003             <span class="comment">//</span>
01004 
01005             <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive == 0)
01006 
01007                     ||
01008 
01009                 ((<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive == -1) &amp;&amp;
01010                  (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;ExclusiveOwnerThread == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>))) {
01011 
01012                 <span class="comment">//</span>
01013                 <span class="comment">//  The resource is ours, so indicate that we have it and</span>
01014                 <span class="comment">//  exit the critical section and return.</span>
01015                 <span class="comment">//</span>
01016 
01017                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive = -1;
01018 
01019                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;ExclusiveOwnerThread = NtCurrentTeb()-&gt;ClientId.UniqueThread;
01020 
01021                 RtlLeaveCriticalSection(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;CriticalSection);
01022 
01023                 <span class="keywordflow">return</span>;
01024             }
01025 
01026             <span class="comment">//</span>
01027             <span class="comment">//  Otherwise check to see if we already have exclusive access to</span>
01028             <span class="comment">//  the resource and can simply recusively acquire it again.</span>
01029             <span class="comment">//</span>
01030 
01031             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;ExclusiveOwnerThread == NtCurrentTeb()-&gt;ClientId.UniqueThread) {
01032 
01033                 <span class="comment">//</span>
01034                 <span class="comment">//  The resource is ours (recusively) so indicate that we have</span>
01035                 <span class="comment">//  it and exit the critical section and return.</span>
01036                 <span class="comment">//</span>
01037 
01038                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive -= 1;
01039 
01040                 RtlLeaveCriticalSection(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;CriticalSection);
01041 
01042                 <span class="keywordflow">return</span>;
01043             }
01044         }
01045 
01046     }
01047 
01048     <span class="comment">//</span>
01049     <span class="comment">//  The resource is not currently acquired for shared so this is a</span>
01050     <span class="comment">//  spurious call</span>
01051     <span class="comment">//</span>
01052 
01053 <span class="preprocessor">#if DBG</span>
01054 <span class="preprocessor"></span>    <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"NTDLL:  Failed error - SHARED_RESOURCE_CONV_ERROR\n"</span>);
01055     DbgBreakPoint();
01056 <span class="preprocessor">#endif</span>
01057 <span class="preprocessor"></span>}

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a29" doxytag="dll/resource.c::RtlDeleteCriticalSection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlDeleteCriticalSection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PRTL_CRITICAL_SECTION&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>CriticalSection</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01474">1474</a> of file <a class="el" href="../../d8/d7/dll_2resource_8c-source.html">dll/resource.c</a>.
<p>
References <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00372">RtlCriticalSectionLock</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00188">RtlpFreeDebugInfo()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d8/d5/consrv_8h.html#a77">UnProtectHandle()</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00789">AllocateConsole()</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01051">DestroyConsole()</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01378">FreeInputHandle()</a>, <a class="el" href="../../d8/d9/imminit_8c-source.html#l00067">ImmDllInitialize()</a>, <a class="el" href="../../d8/d6/lpcsvr_8c-source.html#l00463">RtlCreateLpcServer()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01158">RtlDeleteResource()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l03259">RtlpDebugPageHeapDestroy()</a>, <a class="el" href="../../d1/d9/rtl_2atom_8c-source.html#l00100">RtlpDestroyLockAtomTable()</a>, and <a class="el" href="../../d7/d7/clinit_8c-source.html#l00059">UserClientDllInitialize()</a>.
<p>
<pre class="fragment"><div>01480                    :
01481 
01482     This routine deletes (i.e., uninitializes) the input critical
01483     section variable
01484 
01485 
01486 Arguments:
01487 
01488     CriticalSection - Supplies the resource variable being deleted
01489 
01490 Return Value:
01491 
01492     TBD - Status of semaphore close.
01493 
01494 --*/
01495 
01496 {
01497     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01498     PRTL_CRITICAL_SECTION_DEBUG DebugInfo;
01499 
01500     <span class="keywordflow">if</span> ( CriticalSection-&gt;LockSemaphore ) {
01501 <span class="preprocessor">#if DBG</span>
01502 <span class="preprocessor"></span>        <a class="code" href="../../d8/d5/consrv_8h.html#a77">UnProtectHandle</a>( CriticalSection-&gt;LockSemaphore );
01503 <span class="preprocessor">#endif // DBG</span>
01504 <span class="preprocessor"></span>        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( CriticalSection-&gt;LockSemaphore );
01505         }
01506     <span class="keywordflow">else</span> {
01507         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01508         }
01509 
01510     <span class="comment">//</span>
01511     <span class="comment">// Remove critical section from the list</span>
01512     <span class="comment">//</span>
01513 
01514     RtlEnterCriticalSection( &amp;RtlCriticalSectionLock );
01515     <span class="keywordflow">try</span> {
01516         DebugInfo = CriticalSection-&gt;DebugInfo;
01517         <span class="keywordflow">if</span> (DebugInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01518             RemoveEntryList( &amp;DebugInfo-&gt;ProcessLocksList );
01519             RtlZeroMemory( DebugInfo, <span class="keyword">sizeof</span>( *DebugInfo ) );
01520             }
01521         }
01522     finally {
01523         RtlLeaveCriticalSection( &amp;RtlCriticalSectionLock );
01524         }
01525     <span class="keywordflow">if</span> (DebugInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01526         <a class="code" href="../../d7/d8/dll_2resource_8c.html#a14">RtlpFreeDebugInfo</a>( DebugInfo );
01527         }
01528     RtlZeroMemory( CriticalSection,
01529                    FIELD_OFFSET(RTL_CRITICAL_SECTION, SpinCount) + <span class="keyword">sizeof</span>(ULONG) );
01530 
01531     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01532 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="dll/resource.c::RtlDeleteResource" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlDeleteResource           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PRTL_RESOURCE&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Resource</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01158">1158</a> of file <a class="el" href="../../d8/d7/dll_2resource_8c-source.html">dll/resource.c</a>.
<p>
References <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d5/d9/tex_8c-source.html#l01561">Resource</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01474">RtlDeleteCriticalSection()</a>, and <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00188">RtlpFreeDebugInfo()</a>.
<p>
<pre class="fragment"><div>01164                    :
01165 
01166     This routine deletes (i.e., uninitializes) the input resource variable
01167 
01168 
01169 Arguments:
01170 
01171     Resource - Supplies the resource variable being deleted
01172 
01173 Return Value:
01174 
01175     None
01176 
01177 --*/
01178 
01179 {
01180     <a class="code" href="../../d7/d8/dll_2resource_8c.html#a29">RtlDeleteCriticalSection</a>( &amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;CriticalSection );
01181     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;SharedSemaphore);
01182     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;ExclusiveSemaphore);
01183 
01184     <a class="code" href="../../d7/d8/dll_2resource_8c.html#a14">RtlpFreeDebugInfo</a>( <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;DebugInfo );
01185     RtlZeroMemory( Resource, <span class="keyword">sizeof</span>( *Resource ) );
01186 
01187     <span class="keywordflow">return</span>;
01188 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="dll/resource.c::RtlDumpResource" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlDumpResource           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PRTL_RESOURCE&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Resource</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01193">1193</a> of file <a class="el" href="../../d8/d7/dll_2resource_8c-source.html">dll/resource.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, and <a class="el" href="../../d5/d9/tex_8c-source.html#l01561">Resource</a>.
<p>
<pre class="fragment"><div>01197 {
01198     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Resource @ %lx\n"</span>, Resource);
01199 
01200     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">" NumberOfWaitingShared = %lx\n"</span>, <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfWaitingShared);
01201     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">" NumberOfWaitingExclusive = %lx\n"</span>, <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfWaitingExclusive);
01202 
01203     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">" NumberOfActive = %lx\n"</span>, <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive);
01204 
01205     <span class="keywordflow">return</span>;
01206 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="dll/resource.c::RtlEnableEarlyCriticalSectionEventCreation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlEnableEarlyCriticalSectionEventCreation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01240">1240</a> of file <a class="el" href="../../d8/d7/dll_2resource_8c-source.html">dll/resource.c</a>.
<p>
<pre class="fragment"><div>01245                    :
01246 
01247     This routine marks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PEB of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> calling process so critical section events
01248     are created at critical section creation time rather than at contetion time.
01249     This allows critical processes not to have to worry about error paths later
01250     on at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> expense of extra <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> consumed.
01251 
01252 Arguments:
01253 
01254     None
01255 
01256 Return Value:
01257 
01258     None
01259 
01260 --*/
01261 {
01262     NtCurrentPeb ()-&gt;NtGlobalFlag |= FLG_CRITSEC_EVENT_CREATION;
01263 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="dll/resource.c::RtlInitializeCriticalSection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlInitializeCriticalSection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PRTL_CRITICAL_SECTION&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>CriticalSection</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01210">1210</a> of file <a class="el" href="../../d8/d7/dll_2resource_8c-source.html">dll/resource.c</a>.
<p>
References <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01266">RtlInitializeCriticalSectionAndSpinCount()</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00789">AllocateConsole()</a>, <a class="el" href="../../d9/d8/dllinit_8c-source.html#l00470">ConDllInitialize()</a>, <a class="el" href="../../d8/d9/imminit_8c-source.html#l00019">ImmInitializeGlobals()</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00561">InheritIoHandleTable()</a>, <a class="el" href="../../d1/d4/ntcon_2conime_2conime_8c-source.html#l00109">InitConsoleIME()</a>, <a class="el" href="../../d3/d0/client_2cmdline_8c-source.html#l00039">InitExeName()</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01335">InitializeInputHandle()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00575">LdrpForkProcess()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00616">LdrpInitializeProcess()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l01997">RtlpDebugPageHeapCreate()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l03458">RtlpDebugPageHeapGetProcessHeaps()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l04819">RtlpDphInitializeDelayedFreeQueue()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l05078">RtlpDphTargetDllsLogicInitialize()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l05694">RtlpInitializeEventCache()</a>, <a class="el" href="../../d1/d9/rtl_2atom_8c-source.html#l00056">RtlpInitializeLockAtomTable()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l05256">RtlpInitializeTimerThreadPool()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l02751">RtlpInitializeWaitThreadPool()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l01965">RtlpInitializeWorkerThreadPool()</a>, <a class="el" href="../../d7/d7/clinit_8c-source.html#l00059">UserClientDllInitialize()</a>, and <a class="el" href="../../d1/d6/server_2server_8c-source.html#l00192">UserServerDllInitialization()</a>.
<p>
<pre class="fragment"><div>01216                    :
01217 
01218     This routine initializes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input critial section variable
01219 
01220 Arguments:
01221 
01222     CriticalSection - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource variable being initialized
01223 
01224 Return Value:
01225 
01226     TBD - <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> of semaphore creation.
01227 
01228 --*/
01229 
01230 {
01231     <span class="keywordflow">return</span> <a class="code" href="../../d7/d8/dll_2resource_8c.html#a26">RtlInitializeCriticalSectionAndSpinCount</a>(CriticalSection,0);
01232 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="dll/resource.c::RtlInitializeCriticalSectionAndSpinCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlInitializeCriticalSectionAndSpinCount           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PRTL_CRITICAL_SECTION&nbsp;</td>
          <td class="mdname" nowrap> <em>CriticalSection</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SpinCount</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01266">1266</a> of file <a class="el" href="../../d8/d7/dll_2resource_8c-source.html">dll/resource.c</a>.
<p>
References <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00038">DESIRED_EVENT_ACCESS</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01236">MAX_SPIN_COUNT</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d1/d7/ex_2event_8c-source.html#l00180">NtCreateEvent()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01237">PREALLOCATE_EVENT_MASK</a>, <a class="el" href="../../d5/d7/ex_8c-source.html#l00464">ProtectHandle()</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00371">RtlCriticalSectionList</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00372">RtlCriticalSectionLock</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00151">RtlpAllocateDebugInfo()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00118">RtlpCritSectInitialized</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d8/d5/consrv_8h.html#a77">UnProtectHandle()</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00737">ConServerDllInitialization()</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00057">InitializeConsoleHandleTable()</a>, <a class="el" href="../../d7/d1/output_8c-source.html#l02631">InitializeScrollBuffer()</a>, <a class="el" href="../../d8/d6/lpcsvr_8c-source.html#l00463">RtlCreateLpcServer()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01210">RtlInitializeCriticalSection()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00247">RtlInitializeResource()</a>, and <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00211">RtlpInitDeferedCriticalSection()</a>.
<p>
<pre class="fragment"><div>01273                    :
01274 
01275     This routine initializes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input critial section variable
01276 
01277 Arguments:
01278 
01279     CriticalSection - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource variable being initialized
01280 
01281 Return Value:
01282 
01283     TBD - <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> of semaphore creation.
01284 
01285 --*/
01286 
01287 {
01288     PRTL_CRITICAL_SECTION_DEBUG DebugInfo;
01289     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01290 
01291     <span class="comment">//</span>
01292     <span class="comment">//  Initialize the lock fields, the count indicates how many are waiting</span>
01293     <span class="comment">//  to enter or are in the critical section, LockSemaphore is the object</span>
01294     <span class="comment">//  to wait on when entering the critical section.  SpinLock is used</span>
01295     <span class="comment">//  for the add interlock instruction. Recursion count is the number of</span>
01296     <span class="comment">//  times the critical section has been recursively entered.</span>
01297     <span class="comment">//</span>
01298 
01299     CriticalSection-&gt;LockCount = -1;
01300     CriticalSection-&gt;RecursionCount = 0;
01301     CriticalSection-&gt;OwningThread = 0;
01302     CriticalSection-&gt;LockSemaphore = 0;
01303     <span class="keywordflow">if</span> ( NtCurrentPeb()-&gt;NumberOfProcessors &gt; 1 ) {
01304         CriticalSection-&gt;SpinCount = SpinCount &amp; <a class="code" href="../../d7/d8/dll_2resource_8c.html#a2">MAX_SPIN_COUNT</a>;
01305         }
01306     <span class="keywordflow">else</span> {
01307         CriticalSection-&gt;SpinCount = 0;
01308         }
01309 
01310     <span class="keywordflow">if</span> ( ( SpinCount &amp; <a class="code" href="../../d7/d8/dll_2resource_8c.html#a3">PREALLOCATE_EVENT_MASK</a> ) ||
01311          ( NtCurrentPeb ()-&gt;NtGlobalFlag &amp; FLG_CRITSEC_EVENT_CREATION ) ) {
01312         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d8/ex_2event_8c.html#a5">NtCreateEvent</a>(
01313                     &amp;CriticalSection-&gt;LockSemaphore,
01314                     DESIRED_EVENT_ACCESS,
01315                     NULL,
01316                     SynchronizationEvent,
01317                     FALSE
01318                     );
01319         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
01320             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01321             }
01322 <span class="preprocessor">#if DBG</span>
01323 <span class="preprocessor"></span>        <a class="code" href="../../d4/d1/userk_8h.html#a966">ProtectHandle</a>(CriticalSection-&gt;LockSemaphore);
01324 <span class="preprocessor">#endif // DBG</span>
01325 <span class="preprocessor"></span>        }
01326 
01327     <span class="comment">//</span>
01328     <span class="comment">// Initialize debugging information.</span>
01329     <span class="comment">//</span>
01330 
01331     DebugInfo = (PRTL_CRITICAL_SECTION_DEBUG)<a class="code" href="../../d7/d8/dll_2resource_8c.html#a13">RtlpAllocateDebugInfo</a>();
01332     <span class="keywordflow">if</span> (DebugInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01333         <span class="keywordflow">if</span> (CriticalSection-&gt;LockSemaphore) {
01334 <span class="preprocessor">#if DBG</span>
01335 <span class="preprocessor"></span>            <a class="code" href="../../d8/d5/consrv_8h.html#a77">UnProtectHandle</a>( CriticalSection-&gt;LockSemaphore );
01336 <span class="preprocessor">#endif // DBG</span>
01337 <span class="preprocessor"></span>            <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( CriticalSection-&gt;LockSemaphore );
01338             CriticalSection-&gt;LockSemaphore = 0;
01339             }
01340         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01341     }
01342 
01343     DebugInfo-&gt;Type = RTL_CRITSECT_TYPE;
01344     DebugInfo-&gt;ContentionCount = 0;
01345     DebugInfo-&gt;EntryCount = 0;
01346 
01347     <span class="comment">//</span>
01348     <span class="comment">// If the critical section lock itself is not being initialized, then</span>
01349     <span class="comment">// synchronize the insert of the critical section in the process locks</span>
01350     <span class="comment">// list. Otherwise, insert the critical section with no synchronization.</span>
01351     <span class="comment">//</span>
01352 
01353     <span class="keywordflow">if</span> ((CriticalSection != &amp;<a class="code" href="../../d9/d2/ldrp_8h.html#a35">RtlCriticalSectionLock</a>) &amp;&amp;
01354          (<a class="code" href="../../d7/d8/dll_2resource_8c.html#a9">RtlpCritSectInitialized</a> != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
01355         RtlEnterCriticalSection(&amp;RtlCriticalSectionLock);
01356         InsertTailList(&amp;RtlCriticalSectionList, &amp;DebugInfo-&gt;ProcessLocksList);
01357         RtlLeaveCriticalSection(&amp;RtlCriticalSectionLock );
01358 
01359     } <span class="keywordflow">else</span> {
01360         InsertTailList(&amp;RtlCriticalSectionList, &amp;DebugInfo-&gt;ProcessLocksList);
01361     }
01362 
01363     DebugInfo-&gt;CriticalSection = CriticalSection;
01364     CriticalSection-&gt;DebugInfo = DebugInfo;
01365 <span class="preprocessor">#if i386</span>
01366 <span class="preprocessor"></span>    DebugInfo-&gt;CreatorBackTraceIndex = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)RtlLogStackBackTrace();
01367 <span class="preprocessor">#endif // i386</span>
01368 <span class="preprocessor"></span>
01369     <span class="keywordflow">return</span> STATUS_SUCCESS;
01370 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="dll/resource.c::RtlInitializeResource" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlInitializeResource           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PRTL_RESOURCE&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Resource</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00247">247</a> of file <a class="el" href="../../d8/d7/dll_2resource_8c-source.html">dll/resource.c</a>.
<p>
References <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00041">DESIRED_SEMAPHORE_ACCESS</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d3/d5/semphore_8c-source.html#l00123">NtCreateSemaphore()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/tex_8c-source.html#l01561">Resource</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01266">RtlInitializeCriticalSectionAndSpinCount()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00151">RtlpAllocateDebugInfo()</a>, <a class="el" href="../../d0/d9/ppc_2exdsptch_8c-source.html#l00563">RtlRaiseStatus()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
<pre class="fragment"><div>00253                    :
00254 
00255     This routine initializes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input resource variable
00256 
00257 Arguments:
00258 
00259     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource variable being initialized
00260 
00261 Return Value:
00262 
00263     None
00264 
00265 --*/
00266 
00267 {
00268     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00269     PRTL_RESOURCE_DEBUG ResourceDebugInfo;
00270 
00271     <span class="comment">//</span>
00272     <span class="comment">//  Initialize the lock fields, the count indicates how many are waiting</span>
00273     <span class="comment">//  to enter or are in the critical section, LockSemaphore is the object</span>
00274     <span class="comment">//  to wait on when entering the critical section.  SpinLock is used</span>
00275     <span class="comment">//  for the add interlock instruction.</span>
00276     <span class="comment">//</span>
00277 
00278     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d8/dll_2resource_8c.html#a26">RtlInitializeCriticalSectionAndSpinCount</a>( &amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;CriticalSection, 1000 );
00279     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ){
00280         <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(Status);
00281         }
00282 
00283     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;CriticalSection.DebugInfo-&gt;Type = RTL_RESOURCE_TYPE;
00284     ResourceDebugInfo = (PRTL_RESOURCE_DEBUG)
00285         <a class="code" href="../../d7/d8/dll_2resource_8c.html#a13">RtlpAllocateDebugInfo</a>();
00286 
00287     <span class="keywordflow">if</span> (ResourceDebugInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00288         <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(STATUS_NO_MEMORY);
00289         }
00290 
00291     ResourceDebugInfo-&gt;ContentionCount = 0;
00292     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;DebugInfo = ResourceDebugInfo;
00293 
00294     <span class="comment">//</span>
00295     <span class="comment">//  Initialize flags so there is a default value.</span>
00296     <span class="comment">//  (Some apps may set RTL_RESOURCE_FLAGS_LONG_TERM to affect timeouts.)</span>
00297     <span class="comment">//</span>
00298 
00299     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;Flags = 0;
00300 
00301 
00302     <span class="comment">//</span>
00303     <span class="comment">//  Initialize the shared and exclusive waiting counters and semaphore.</span>
00304     <span class="comment">//  The counters indicate how many are waiting for access to the resource</span>
00305     <span class="comment">//  and the semaphores are used to wait on the resource.  Note that</span>
00306     <span class="comment">//  the semaphores can also indicate the number waiting for a resource</span>
00307     <span class="comment">//  however there is a race condition in the alogrithm on the acquire</span>
00308     <span class="comment">//  side if count if not updated before the critical section is exited.</span>
00309     <span class="comment">//</span>
00310 
00311     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d6/semphore_8c.html#a4">NtCreateSemaphore</a>(
00312                  &amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;SharedSemaphore,
00313                  DESIRED_SEMAPHORE_ACCESS,
00314                  NULL,
00315                  0,
00316                  MAXLONG
00317                  );
00318     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ){
00319         <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(Status);
00320         }
00321 
00322     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfWaitingShared = 0;
00323 
00324     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d6/semphore_8c.html#a4">NtCreateSemaphore</a>(
00325                  &amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;ExclusiveSemaphore,
00326                  DESIRED_SEMAPHORE_ACCESS,
00327                  NULL,
00328                  0,
00329                  MAXLONG
00330                  );
00331     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ){
00332         <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(Status);
00333         }
00334 
00335     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfWaitingExclusive = 0;
00336 
00337     <span class="comment">//</span>
00338     <span class="comment">//  Initialize the current state of the resource</span>
00339     <span class="comment">//</span>
00340 
00341     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive = 0;
00342 
00343     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;ExclusiveOwnerThread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00344 
00345     <span class="keywordflow">return</span>;
00346 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="dll/resource.c::RtlpAllocateDebugInfo" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID RtlpAllocateDebugInfo           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00151">151</a> of file <a class="el" href="../../d8/d7/dll_2resource_8c-source.html">dll/resource.c</a>.
<p>
References <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00051">DeferedCriticalSection</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00224">HEAP_GRANULARITY</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00022">RtlAllocateHeap</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00121">RtlpChainDebugInfo()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00118">RtlpCritSectInitialized</a>, and <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00117">RtlpDebugInfoFreeList</a>.
<p>
Referenced by <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01266">RtlInitializeCriticalSectionAndSpinCount()</a>, and <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00247">RtlInitializeResource()</a>.
<p>
<pre class="fragment"><div>00152 {
00153     PRTL_CRITICAL_SECTION_DEBUG p;
00154     PPEB Peb;
00155 
00156 
00157     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d8/dll_2resource_8c.html#a9">RtlpCritSectInitialized</a>) {
00158         RtlEnterCriticalSection(&amp;DeferedCriticalSection);
00159         }
00160     <span class="keywordflow">try</span> {
00161         p = <a class="code" href="../../d7/d8/dll_2resource_8c.html#a8">RtlpDebugInfoFreeList</a>;
00162         <span class="keywordflow">if</span> (p == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00163             Peb = NtCurrentPeb();
00164             p = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(Peb-&gt;ProcessHeap,0,PAGE_SIZE-HEAP_GRANULARITY);
00165             <span class="keywordflow">if</span> ( !p ) {
00166                 KdPrint(( <span class="stringliteral">"NTDLL: Unable to allocate debug information from heap\n"</span>));
00167                 }
00168             <span class="keywordflow">else</span> {
00169                 p = <a class="code" href="../../d7/d8/dll_2resource_8c.html#a12">RtlpChainDebugInfo</a>( p, PAGE_SIZE-HEAP_GRANULARITY );
00170                 }
00171             }
00172 
00173         <span class="keywordflow">if</span> (p != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00174             <a class="code" href="../../d7/d8/dll_2resource_8c.html#a8">RtlpDebugInfoFreeList</a> = *(PRTL_CRITICAL_SECTION_DEBUG *)p;
00175             }
00176         }
00177     finally {
00178         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d8/dll_2resource_8c.html#a9">RtlpCritSectInitialized</a>) {
00179             RtlLeaveCriticalSection(&amp;DeferedCriticalSection);
00180             }
00181         }
00182 
00183     <span class="keywordflow">return</span> p;
00184 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="dll/resource.c::RtlpChainDebugInfo" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PRTL_CRITICAL_SECTION_DEBUG RtlpChainDebugInfo           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>BaseAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Size</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00121">121</a> of file <a class="el" href="../../d8/d7/dll_2resource_8c-source.html">dll/resource.c</a>.
<p>
References <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>.
<p>
Referenced by <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00151">RtlpAllocateDebugInfo()</a>, and <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00211">RtlpInitDeferedCriticalSection()</a>.
<p>
<pre class="fragment"><div>00125 {
00126     PRTL_CRITICAL_SECTION_DEBUG p, p1;
00127 
00128     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> / <span class="keyword">sizeof</span>( RTL_CRITICAL_SECTION_DEBUG )) {
00129         p = (PRTL_CRITICAL_SECTION_DEBUG)BaseAddress + <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> - 1;
00130         *(PRTL_CRITICAL_SECTION_DEBUG *)p = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00131         <span class="keywordflow">while</span> (--<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>) {
00132             p1 = p - 1;
00133             *(PRTL_CRITICAL_SECTION_DEBUG *)p1 = p;
00134             p = p1;
00135             }
00136         }
00137 
00138     <span class="keywordflow">return</span> p;
00139 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a28" doxytag="dll/resource.c::RtlpCheckDeferedCriticalSection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlpCheckDeferedCriticalSection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PRTL_CRITICAL_SECTION&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>CriticalSection</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01456">1456</a> of file <a class="el" href="../../d8/d7/dll_2resource_8c-source.html">dll/resource.c</a>.
<p>
References <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00051">DeferedCriticalSection</a>, and <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01412">RtlpCreateCriticalSectionSem()</a>.
<p>
Referenced by <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01675">RtlpUnWaitCriticalSection()</a>, and <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01544">RtlpWaitForCriticalSection()</a>.
<p>
<pre class="fragment"><div>01459 {
01460     RtlEnterCriticalSection(&amp;DeferedCriticalSection);
01461     <span class="keywordflow">try</span> {
01462         <span class="keywordflow">if</span> ( !CriticalSection-&gt;LockSemaphore ) {
01463             <a class="code" href="../../d7/d8/dll_2resource_8c.html#a15">RtlpCreateCriticalSectionSem</a>(CriticalSection);
01464             }
01465         }
01466     finally {
01467         RtlLeaveCriticalSection(&amp;DeferedCriticalSection);
01468         }
01469     <span class="keywordflow">return</span>;
01470 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="dll/resource.c::RtlpCreateCriticalSectionSem" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlpCreateCriticalSectionSem           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PRTL_CRITICAL_SECTION&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>CriticalSection</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01412">1412</a> of file <a class="el" href="../../d8/d7/dll_2resource_8c-source.html">dll/resource.c</a>.
<p>
References <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00038">DESIRED_EVENT_ACCESS</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d1/d7/ex_2event_8c-source.html#l00180">NtCreateEvent()</a>, <a class="el" href="../../d8/d5/delay_8c-source.html#l00033">NtDelayExecution()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/ex_8c-source.html#l00464">ProtectHandle()</a>, <a class="el" href="../../d0/d9/ppc_2exdsptch_8c-source.html#l00563">RtlRaiseStatus()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01456">RtlpCheckDeferedCriticalSection()</a>, and <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00211">RtlpInitDeferedCriticalSection()</a>.
<p>
<pre class="fragment"><div>01415 {
01416     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01417     LARGE_INTEGER tmo = {(ULONG)   -100000, -1};         <span class="comment">// Start at 1/100th of a second</span>
01418     LONGLONG max_tmo  = (LONGLONG) -10000000 * 60 * 3; <span class="comment">// Wait for a max of 3 minutes</span>
01419 
01420     <span class="comment">//</span>
01421     <span class="comment">// Loop trying to create the event on failure.</span>
01422     <span class="comment">//</span>
01423     <span class="keywordflow">while</span> (1) {
01424         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d8/ex_2event_8c.html#a5">NtCreateEvent</a>(
01425                     &amp;CriticalSection-&gt;LockSemaphore,
01426                     DESIRED_EVENT_ACCESS,
01427                     NULL,
01428                     SynchronizationEvent,
01429                     FALSE
01430                 );
01431 
01432         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
01433            <span class="keywordflow">break</span>;
01434         } <span class="keywordflow">else</span> { 
01435             <span class="keywordflow">if</span> ( tmo.QuadPart &lt; max_tmo ) {
01436                 KdPrint(( <span class="stringliteral">"NTDLL: Warning. Unable to allocate lock semaphore for Cs %p. Status %x raising\n"</span>, CriticalSection,Status ));
01437                 InterlockedDecrement(&amp;CriticalSection-&gt;LockCount);
01438                 <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(Status);
01439             }
01440             KdPrint(( <span class="stringliteral">"NTDLL: Warning. Unable to allocate lock semaphore for Cs %p. Status %x retrying\n"</span>, CriticalSection,Status ));
01441 
01442             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d6/delay_8c.html#a0">NtDelayExecution</a> (FALSE, &amp;tmo);
01443             <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
01444                 InterlockedDecrement(&amp;CriticalSection-&gt;LockCount);
01445                 <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(Status);
01446             }
01447             tmo.QuadPart *= 2;
01448         }
01449     }
01450 <span class="preprocessor">#if DBG</span>
01451 <span class="preprocessor"></span>    <a class="code" href="../../d4/d1/userk_8h.html#a966">ProtectHandle</a>(CriticalSection-&gt;LockSemaphore);
01452 <span class="preprocessor">#endif // DBG</span>
01453 <span class="preprocessor"></span>}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="dll/resource.c::RtlpFreeDebugInfo" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlpFreeDebugInfo           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DebugInfo</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00188">188</a> of file <a class="el" href="../../d8/d7/dll_2resource_8c-source.html">dll/resource.c</a>.
<p>
References <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00051">DeferedCriticalSection</a>, and <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00117">RtlpDebugInfoFreeList</a>.
<p>
Referenced by <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01474">RtlDeleteCriticalSection()</a>, and <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01158">RtlDeleteResource()</a>.
<p>
<pre class="fragment"><div>00191 {
00192     RtlEnterCriticalSection(&amp;DeferedCriticalSection);
00193     <span class="keywordflow">try</span> {
00194         RtlZeroMemory( DebugInfo, <span class="keyword">sizeof</span>( RTL_CRITICAL_SECTION_DEBUG ) );
00195         *(PRTL_CRITICAL_SECTION_DEBUG *)DebugInfo = <a class="code" href="../../d7/d8/dll_2resource_8c.html#a8">RtlpDebugInfoFreeList</a>;
00196         <a class="code" href="../../d7/d8/dll_2resource_8c.html#a8">RtlpDebugInfoFreeList</a> = (PRTL_CRITICAL_SECTION_DEBUG)DebugInfo;
00197         }
00198     finally {
00199         RtlLeaveCriticalSection(&amp;DeferedCriticalSection);
00200         }
00201 
00202     <span class="keywordflow">return</span>;
00203 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="dll/resource.c::RtlpInitDeferedCriticalSection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlpInitDeferedCriticalSection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00575">LdrpForkProcess()</a>, and <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00616">LdrpInitializeProcess()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a32" doxytag="dll/resource.c::RtlpNotOwnerCriticalSection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> void RtlpNotOwnerCriticalSection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PRTL_CRITICAL_SECTION&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>CriticalSection</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01717">1717</a> of file <a class="el" href="../../d8/d7/dll_2resource_8c-source.html">dll/resource.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00031">LdrpShutdownInProgress</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00389">LdrpShutdownThreadId</a>, and <a class="el" href="../../d0/d9/ppc_2exdsptch_8c-source.html#l00563">RtlRaiseStatus()</a>.
<p>
<pre class="fragment"><div>01720 {
01721     BOOLEAN CsIsLoaderLock;
01722 
01723     <span class="comment">//</span>
01724     <span class="comment">// critical sections are disabled during exit process so that</span>
01725     <span class="comment">// apps that are not carefull during shutdown don't hang</span>
01726     <span class="comment">//</span>
01727 
01728     CsIsLoaderLock = (CriticalSection == NtCurrentPeb()-&gt;LoaderLock);
01729 
01730     <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d2/ldrinit_8c.html#a0">LdrpShutdownInProgress</a> &amp;&amp;
01731         ((!CsIsLoaderLock) ||
01732          (CsIsLoaderLock &amp;&amp; <a class="code" href="../../d9/d2/ldrp_8h.html#a47">LdrpShutdownThreadId</a> == NtCurrentTeb()-&gt;ClientId.UniqueThread) ) ) {
01733         <span class="keywordflow">return</span>;
01734         }
01735 
01736     <span class="keywordflow">if</span> (NtCurrentPeb()-&gt;BeingDebugged) {
01737         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"NTDLL: Calling thread (%X) not owner of CritSect: %p  Owner ThreadId: %X\n"</span>,
01738                   NtCurrentTeb()-&gt;ClientId.UniqueThread,
01739                   CriticalSection,
01740                   CriticalSection-&gt;OwningThread
01741                 );
01742 <span class="preprocessor">#if i386</span>
01743 <span class="preprocessor"></span>        _asm {  <span class="keywordtype">int</span> 3 }
01744 <span class="preprocessor">#else</span>
01745 <span class="preprocessor"></span>        DbgBreakPoint();
01746 <span class="preprocessor">#endif</span>
01747 <span class="preprocessor"></span>        }
01748     <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>( STATUS_RESOURCE_NOT_OWNED );
01749 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a31" doxytag="dll/resource.c::RtlpUnWaitCriticalSection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> void RtlpUnWaitCriticalSection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PRTL_CRITICAL_SECTION&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>CriticalSection</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01675">1675</a> of file <a class="el" href="../../d8/d7/dll_2resource_8c-source.html">dll/resource.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d1/d7/ex_2event_8c-source.html#l00748">NtSetEvent()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01456">RtlpCheckDeferedCriticalSection()</a>, and <a class="el" href="../../d0/d9/ppc_2exdsptch_8c-source.html#l00563">RtlRaiseStatus()</a>.
<p>
<pre class="fragment"><div>01678 {
01679     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
01680 
01681 <span class="preprocessor">#if 0</span>
01682 <span class="preprocessor"></span>    <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"NTDLL: Releasing CritSect: %p  ThreadId: %X\n"</span>,
01683               CriticalSection, CriticalSection-&gt;OwningThread
01684             );
01685 <span class="preprocessor">#endif</span>
01686 <span class="preprocessor"></span>
01687     <span class="keywordflow">if</span> ( !CriticalSection-&gt;LockSemaphore ) {
01688         <a class="code" href="../../d7/d8/dll_2resource_8c.html#a28">RtlpCheckDeferedCriticalSection</a>(CriticalSection);
01689         }
01690 
01691 <span class="preprocessor">#if DBG</span>
01692 <span class="preprocessor"></span>    <span class="comment">//</span>
01693     <span class="comment">// Sneaky trick here to catch sleazy apps (csrss) that erroneously call</span>
01694     <span class="comment">// NtSetEvent on an event that happens to be somebody else's</span>
01695     <span class="comment">// critical section. Only allow setting a protected handle if the low</span>
01696     <span class="comment">// bit of PreviousState is set.</span>
01697     <span class="comment">//</span>
01698     st = <a class="code" href="../../d0/d8/ex_2event_8c.html#a10">NtSetEvent</a>( CriticalSection-&gt;LockSemaphore,
01699                      (PLONG)1
01700                      );
01701 <span class="preprocessor">#else</span>
01702 <span class="preprocessor"></span>    st = <a class="code" href="../../d0/d8/ex_2event_8c.html#a10">NtSetEvent</a>( CriticalSection-&gt;LockSemaphore,
01703                      NULL
01704                      );
01705 <span class="preprocessor">#endif</span>
01706 <span class="preprocessor"></span>
01707     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
01708         <span class="keywordflow">return</span>;
01709         }
01710     <span class="keywordflow">else</span> {
01711         <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(st);
01712         }
01713 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a30" doxytag="dll/resource.c::RtlpWaitForCriticalSection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> void RtlpWaitForCriticalSection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PRTL_CRITICAL_SECTION&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>CriticalSection</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01544">1544</a> of file <a class="el" href="../../d8/d7/dll_2resource_8c-source.html">dll/resource.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00031">LdrpShutdownInProgress</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00389">LdrpShutdownThreadId</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d2/d1/obwait_8c-source.html#l00282">NtWaitForSingleObject()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00029">RtlImageNtHeader()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01456">RtlpCheckDeferedCriticalSection()</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00369">RtlpTimeout</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00368">RtlpTimoutDisable</a>, <a class="el" href="../../d6/d8/alpha_2exdsptch_8c-source.html#l00603">RtlRaiseException()</a>, <a class="el" href="../../d0/d9/ppc_2exdsptch_8c-source.html#l00563">RtlRaiseStatus()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>01547 {
01548     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
01549     ULONG TimeoutCount = 0;
01550     PLARGE_INTEGER TimeoutTime;
01551     BOOLEAN CsIsLoaderLock;
01552 
01553     <span class="comment">//</span>
01554     <span class="comment">// critical sections are disabled during exit process so that</span>
01555     <span class="comment">// apps that are not carefull during shutdown don't hang</span>
01556     <span class="comment">//</span>
01557 
01558     CsIsLoaderLock = (CriticalSection == NtCurrentPeb()-&gt;LoaderLock);
01559     NtCurrentTeb()-&gt;WaitingOnLoaderLock = (ULONG)CsIsLoaderLock;
01560 
01561     <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d2/ldrinit_8c.html#a0">LdrpShutdownInProgress</a> &amp;&amp;
01562         ((!CsIsLoaderLock) ||
01563          (CsIsLoaderLock &amp;&amp; <a class="code" href="../../d9/d2/ldrp_8h.html#a47">LdrpShutdownThreadId</a> == NtCurrentTeb()-&gt;ClientId.UniqueThread) ) ) {
01564 
01565         <span class="comment">//</span>
01566         <span class="comment">// slimey reinitialization of the critical section with the count biased by one</span>
01567         <span class="comment">// this is how the critical section would normally look to the thread coming out</span>
01568         <span class="comment">// of this function. Note that the semaphore handle is leaked, but since the</span>
01569         <span class="comment">// app is exiting, it's ok</span>
01570         <span class="comment">//</span>
01571 
01572         CriticalSection-&gt;LockCount = 0;
01573         CriticalSection-&gt;RecursionCount = 0;
01574         CriticalSection-&gt;OwningThread = 0;
01575         CriticalSection-&gt;LockSemaphore = 0;
01576 
01577         NtCurrentTeb()-&gt;WaitingOnLoaderLock = 0;
01578 
01579         <span class="keywordflow">return</span>;
01580 
01581         }
01582 
01583     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a31">RtlpTimoutDisable</a>) {
01584         TimeoutTime = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01585         }
01586     <span class="keywordflow">else</span> {
01587         TimeoutTime = &amp;<a class="code" href="../../d9/d2/ldrp_8h.html#a32">RtlpTimeout</a>;
01588         }
01589 
01590     <span class="keywordflow">if</span> ( !CriticalSection-&gt;LockSemaphore ) {
01591         <a class="code" href="../../d7/d8/dll_2resource_8c.html#a28">RtlpCheckDeferedCriticalSection</a>(CriticalSection);
01592         }
01593 
01594     CriticalSection-&gt;DebugInfo-&gt;EntryCount++;
01595     <span class="keywordflow">while</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ) {
01596 
01597         CriticalSection-&gt;DebugInfo-&gt;ContentionCount++;
01598 
01599 <span class="preprocessor">#if 0</span>
01600 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"NTDLL: Waiting for CritSect: %p  owned by ThreadId: %X  Count: %u  Level: %u\n"</span>,
01601                   CriticalSection,
01602                   CriticalSection-&gt;OwningThread,
01603                   CriticalSection-&gt;LockCount,
01604                   CriticalSection-&gt;RecursionCount
01605                 );
01606 <span class="preprocessor">#endif</span>
01607 <span class="preprocessor"></span>
01608         st = <a class="code" href="../../d1/d2/obwait_8c.html#a4">NtWaitForSingleObject</a>( CriticalSection-&gt;LockSemaphore,
01609                                     FALSE,
01610                                     TimeoutTime
01611                                   );
01612         <span class="keywordflow">if</span> ( st == STATUS_TIMEOUT ) {
01613             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"RTL: Enter Critical Section Timeout (2 minutes) %d\n"</span>,
01614                       TimeoutCount
01615                     );
01616             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"RTL: Pid.Tid %x.%x, owner tid %x Critical Section %p - ContentionCount == %lu\n"</span>,
01617                     NtCurrentTeb()-&gt;ClientId.UniqueProcess,
01618                     NtCurrentTeb()-&gt;ClientId.UniqueThread,
01619                     CriticalSection-&gt;OwningThread,
01620                     CriticalSection, CriticalSection-&gt;DebugInfo-&gt;ContentionCount
01621                     );
01622             TimeoutCount++;
01623             <span class="keywordflow">if</span> ( TimeoutCount &gt; 2 &amp;&amp; CriticalSection != NtCurrentPeb()-&gt;LoaderLock ) {
01624                 PIMAGE_NT_HEADERS NtHeaders;
01625 
01626                 <span class="comment">//</span>
01627                 <span class="comment">// If the image is a Win32 image, then raise an exception and try to get to the</span>
01628                 <span class="comment">// uae popup</span>
01629                 <span class="comment">//</span>
01630 
01631                 NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(NtCurrentPeb()-&gt;ImageBaseAddress);
01632 
01633                 <span class="keywordflow">if</span> (NtHeaders-&gt;OptionalHeader.Subsystem == IMAGE_SUBSYSTEM_WINDOWS_CUI ||
01634                     NtHeaders-&gt;OptionalHeader.Subsystem == IMAGE_SUBSYSTEM_WINDOWS_GUI) {
01635                     EXCEPTION_RECORD ExceptionRecord;
01636 
01637                     ExceptionRecord.ExceptionCode = STATUS_POSSIBLE_DEADLOCK;
01638                     ExceptionRecord.ExceptionFlags = 0;
01639                     ExceptionRecord.ExceptionRecord = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01640                     ExceptionRecord.ExceptionAddress = (PVOID)<a class="code" href="../../d5/d9/alpha_2exdsptch_8c.html#a17">RtlRaiseException</a>;
01641                     ExceptionRecord.NumberParameters = 1;
01642                     ExceptionRecord.ExceptionInformation[0] = (ULONG_PTR)CriticalSection;
01643                     <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a9">RtlRaiseException</a>(&amp;ExceptionRecord);
01644                     }
01645                 <span class="keywordflow">else</span> {
01646                     DbgBreakPoint();
01647                     }
01648                 }
01649             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"RTL: Re-Waiting\n"</span>);
01650             }
01651         <span class="keywordflow">else</span> {
01652             <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
01653                 <span class="comment">//</span>
01654                 <span class="comment">// If some errant thread calls SetEvent on a bogus handle</span>
01655                 <span class="comment">// which happens to match the handle we are using in the critical</span>
01656                 <span class="comment">// section, everything gets really messed up since two threads</span>
01657                 <span class="comment">// now own the lock at the same time. ASSERT that no other thread</span>
01658                 <span class="comment">// owns the lock if we have been granted ownership.</span>
01659                 <span class="comment">//</span>
01660                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(CriticalSection-&gt;OwningThread == 0);
01661                 <span class="keywordflow">if</span> ( CsIsLoaderLock ) {
01662                     CriticalSection-&gt;OwningThread = NtCurrentTeb()-&gt;ClientId.UniqueThread;
01663                     NtCurrentTeb()-&gt;WaitingOnLoaderLock = 0;
01664                     }
01665                 <span class="keywordflow">return</span>;
01666                 }
01667             <span class="keywordflow">else</span> {
01668                 <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(st);
01669                 }
01670             }
01671     }
01672 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="dll/resource.c::RtlReleaseResource" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlReleaseResource           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PRTL_RESOURCE&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Resource</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00680">680</a> of file <a class="el" href="../../d8/d7/dll_2resource_8c-source.html">dll/resource.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d3/d5/semphore_8c-source.html#l00494">NtReleaseSemaphore()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/tex_8c-source.html#l01561">Resource</a>, <a class="el" href="../../d0/d9/ppc_2exdsptch_8c-source.html#l00563">RtlRaiseStatus()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
<pre class="fragment"><div>00686                    :
00687 
00688     This routine release <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input resource.  The resource can have been
00689     acquired <span class="keywordflow">for</span> either shared or exclusive access.
00690 
00691 Arguments:
00692 
00693     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource to release
00694 
00695 Return Value:
00696 
00697     None.
00698 
00699 --*/
00700 
00701 {
00702     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00703     LONG PreviousCount;
00704 
00705     <span class="comment">//</span>
00706     <span class="comment">//  Enter the critical section</span>
00707     <span class="comment">//</span>
00708 
00709     RtlEnterCriticalSection(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;CriticalSection);
00710 
00711     <span class="comment">//</span>
00712     <span class="comment">//  Test if the resource is acquired for shared or exclusive access</span>
00713     <span class="comment">//</span>
00714 
00715     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive &gt; 0) {
00716 
00717         <span class="comment">//</span>
00718         <span class="comment">//  Releasing shared access to the resource, so decrement</span>
00719         <span class="comment">//  the number of shared users</span>
00720         <span class="comment">//</span>
00721 
00722         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive -= 1;
00723 
00724         <span class="comment">//</span>
00725         <span class="comment">//  If the resource is now available and there is a waiting</span>
00726         <span class="comment">//  exclusive user then give the resource to the waiting thread</span>
00727         <span class="comment">//</span>
00728 
00729         <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive == 0) &amp;&amp;
00730             (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfWaitingExclusive &gt; 0)) {
00731 
00732             <span class="comment">//</span>
00733             <span class="comment">//  Set the resource state to exclusive (but not owned),</span>
00734             <span class="comment">//  decrement the number of waiting exclusive, and release</span>
00735             <span class="comment">//  one exclusive waiter</span>
00736             <span class="comment">//</span>
00737 
00738             <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive = -1;
00739             <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;ExclusiveOwnerThread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00740 
00741             <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfWaitingExclusive -= 1;
00742 
00743             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d6/semphore_8c.html#a7">NtReleaseSemaphore</a>(
00744                          <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;ExclusiveSemaphore,
00745                          1,
00746                          &amp;PreviousCount
00747                          );
00748             <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
00749                 <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(Status);
00750                 }
00751         }
00752 
00753     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive &lt; 0) {
00754 
00755         <span class="comment">//</span>
00756         <span class="comment">//  Releasing exclusive access to the resource, so increment the</span>
00757         <span class="comment">//  number of active by one.  And continue testing only</span>
00758         <span class="comment">//  if the resource is now available.</span>
00759         <span class="comment">//</span>
00760 
00761         <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive += 1;
00762 
00763         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive == 0) {
00764 
00765             <span class="comment">//</span>
00766             <span class="comment">//  The resource is now available.  Remove ourselves as the</span>
00767             <span class="comment">//  owner thread</span>
00768             <span class="comment">//</span>
00769 
00770             <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;ExclusiveOwnerThread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00771 
00772             <span class="comment">//</span>
00773             <span class="comment">//  If there is another waiting exclusive then give the resource</span>
00774             <span class="comment">//  to it.</span>
00775             <span class="comment">//</span>
00776 
00777             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfWaitingExclusive &gt; 0) {
00778 
00779                 <span class="comment">//</span>
00780                 <span class="comment">//  Set the resource to exclusive, and its owner undefined.</span>
00781                 <span class="comment">//  Decrement the number of waiting exclusive and release one</span>
00782                 <span class="comment">//  exclusive waiter</span>
00783                 <span class="comment">//</span>
00784 
00785                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive = -1;
00786                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfWaitingExclusive -= 1;
00787 
00788                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d6/semphore_8c.html#a7">NtReleaseSemaphore</a>(
00789                              <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;ExclusiveSemaphore,
00790                              1,
00791                              &amp;PreviousCount
00792                              );
00793                 <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
00794                     <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(Status);
00795                     }
00796 
00797             <span class="comment">//</span>
00798             <span class="comment">//  Check to see if there are waiting shared, who should now get</span>
00799             <span class="comment">//  the resource</span>
00800             <span class="comment">//</span>
00801 
00802             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfWaitingShared &gt; 0) {
00803 
00804                 <span class="comment">//</span>
00805                 <span class="comment">//  Set the new state to indicate that all of the shared</span>
00806                 <span class="comment">//  requesters have access and there are no more waiting</span>
00807                 <span class="comment">//  shared requesters, and then release all of the shared</span>
00808                 <span class="comment">//  requsters</span>
00809                 <span class="comment">//</span>
00810 
00811                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive = <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfWaitingShared;
00812 
00813                 <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfWaitingShared = 0;
00814 
00815                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d6/semphore_8c.html#a7">NtReleaseSemaphore</a>(
00816                              <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;SharedSemaphore,
00817                              <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;NumberOfActive,
00818                              &amp;PreviousCount
00819                              );
00820                 <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
00821                     <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(Status);
00822                     }
00823             }
00824         }
00825 
00826 <span class="preprocessor">#if DBG</span>
00827 <span class="preprocessor"></span>    } <span class="keywordflow">else</span> {
00828 
00829         <span class="comment">//</span>
00830         <span class="comment">//  The resource isn't current acquired, there is nothing to release</span>
00831         <span class="comment">//  so tell the user the mistake</span>
00832         <span class="comment">//</span>
00833 
00834 
00835         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"NTDLL - Resource released too many times %lx\n"</span>, Resource);
00836         DbgBreakPoint();
00837 <span class="preprocessor">#endif</span>
00838 <span class="preprocessor"></span>    }
00839 
00840     <span class="comment">//</span>
00841     <span class="comment">//  Exit the critical section, and return to the caller</span>
00842     <span class="comment">//</span>
00843 
00844     RtlLeaveCriticalSection(&amp;<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>-&gt;CriticalSection);
00845 
00846     <span class="keywordflow">return</span>;
00847 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a27" doxytag="dll/resource.c::RtlSetCriticalSectionSpinCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG RtlSetCriticalSectionSpinCount           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PRTL_CRITICAL_SECTION&nbsp;</td>
          <td class="mdname" nowrap> <em>CriticalSection</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SpinCount</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01374">1374</a> of file <a class="el" href="../../d8/d7/dll_2resource_8c-source.html">dll/resource.c</a>.
<p>
<pre class="fragment"><div>01381                    :
01382 
01383     This routine initializes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input critial section variable
01384 
01385 Arguments:
01386 
01387     CriticalSection - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource variable being initialized
01388 
01389 Return Value:
01390 
01391     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> previous critical section spin count
01392 
01393 --*/
01394 
01395 {
01396     ULONG OldSpinCount;
01397 
01398     OldSpinCount = (ULONG)CriticalSection-&gt;SpinCount;
01399 
01400     <span class="keywordflow">if</span> ( NtCurrentPeb()-&gt;NumberOfProcessors &gt; 1 ) {
01401         CriticalSection-&gt;SpinCount = SpinCount;
01402         }
01403     <span class="keywordflow">else</span> {
01404         CriticalSection-&gt;SpinCount = 0;
01405         }
01406 
01407     <span class="keywordflow">return</span> OldSpinCount;
01408 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a6" doxytag="dll/resource.c::DeferedCriticalSection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> RTL_CRITICAL_SECTION <a class="el" href="../../d7/d8/dll_2resource_8c.html#a6">DeferedCriticalSection</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00051">51</a> of file <a class="el" href="../../d8/d7/dll_2resource_8c-source.html">dll/resource.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00151">RtlpAllocateDebugInfo()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01456">RtlpCheckDeferedCriticalSection()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00188">RtlpFreeDebugInfo()</a>, and <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00211">RtlpInitDeferedCriticalSection()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="dll/resource.c::LdrpShutdownInProgress" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d7/d8/dll_2resource_8c.html#a4">LdrpShutdownInProgress</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00046">46</a> of file <a class="el" href="../../d8/d7/dll_2resource_8c-source.html">dll/resource.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="dll/resource.c::LdrpShutdownThreadId" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> HANDLE <a class="el" href="../../d7/d8/dll_2resource_8c.html#a5">LdrpShutdownThreadId</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00047">47</a> of file <a class="el" href="../../d8/d7/dll_2resource_8c-source.html">dll/resource.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l01462">LdrShutdownProcess()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01717">RtlpNotOwnerCriticalSection()</a>, and <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01544">RtlpWaitForCriticalSection()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="dll/resource.c::RtlpCritSectInitialized" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d7/d8/dll_2resource_8c.html#a9">RtlpCritSectInitialized</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00118">118</a> of file <a class="el" href="../../d8/d7/dll_2resource_8c-source.html">dll/resource.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01266">RtlInitializeCriticalSectionAndSpinCount()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00151">RtlpAllocateDebugInfo()</a>, and <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00211">RtlpInitDeferedCriticalSection()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="dll/resource.c::RtlpDebugInfoFreeList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PRTL_CRITICAL_SECTION_DEBUG <a class="el" href="../../d7/d8/dll_2resource_8c.html#a8">RtlpDebugInfoFreeList</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00117">117</a> of file <a class="el" href="../../d8/d7/dll_2resource_8c-source.html">dll/resource.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00151">RtlpAllocateDebugInfo()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00188">RtlpFreeDebugInfo()</a>, and <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00211">RtlpInitDeferedCriticalSection()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="dll/resource.c::RtlpStaticDebugInfo" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> RTL_CRITICAL_SECTION_DEBUG <a class="el" href="../../d7/d8/dll_2resource_8c.html#a7">RtlpStaticDebugInfo</a>[64]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00116">116</a> of file <a class="el" href="../../d8/d7/dll_2resource_8c-source.html">dll/resource.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00211">RtlpInitDeferedCriticalSection()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:29 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
