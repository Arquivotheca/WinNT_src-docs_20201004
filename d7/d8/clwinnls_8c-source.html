<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: clwinnls.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>clwinnls.c</h1><a href="../../d6/d9/clwinnls_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: clwinnls.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* This module contains all the code for the NT 3.x IMM API functions.</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 11-Jan-1995 wkwok      Created.</span>
00010 <span class="comment">* 07-May-1996 takaok     Cleaned up.</span>
00011 <span class="comment">\***************************************************************************/</span>
00012 
00013 <span class="preprocessor">#include "<a class="code" href="../../d8/d3/w32_2ntuser_2imm_2precomp_8h.html">precomp.h</a>"</span>
00014 <span class="preprocessor">#pragma hdrstop</span>
00015 <span class="preprocessor"></span>
00016 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d9/clwinnls_8c.html#a1">CheckCountry</a>();
00017 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d9/clwinnls_8c.html#a2">ImmEnableIME</a>( HWND hwnd, BOOL fEnable );
00018 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d9/clwinnls_8c.html#a3">IMPGetIMEWorker</a>( HKL hkl, LPIMEPROW lpImeProW );
00019 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d6/d9/clwinnls_8c.html#a4">ConvertImeProWtoA</a>( LPIMEPROA lpImeProA, LPIMEPROW lpImeProW );
00020 LRESULT <a class="code" href="../../d6/d9/clwinnls_8c.html#a5">SendIMEMessageAll</a>( HWND hwndApp, HANDLE lParam, BOOL fAnsi );
00021 
<a name="l00022"></a><a class="code" href="../../d6/d9/clwinnls_8c.html#a6">00022</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d9/clwinnls_8c.html#a6">ImmWINNLSEnableIME</a>(
00023     HWND  hwndApp,
00024     BOOL  bFlag)
00025 {
00026     <span class="keywordflow">if</span> ( ! <a class="code" href="../../d6/d9/clwinnls_8c.html#a1">CheckCountry</a>() ) {
00027         SetLastError( ERROR_CALL_NOT_IMPLEMENTED );
00028         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00029     }
00030     <span class="keywordflow">return</span> <a class="code" href="../../d6/d9/clwinnls_8c.html#a2">ImmEnableIME</a>( hwndApp, bFlag );
00031 }
00032 
00033 <span class="comment">//</span>
00034 <span class="comment">// returns the "enable/disable" state of the</span>
00035 <span class="comment">// caller thread's default input context.</span>
00036 <span class="comment">//</span>
<a name="l00037"></a><a class="code" href="../../d6/d9/clwinnls_8c.html#a7">00037</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d9/clwinnls_8c.html#a7">ImmWINNLSGetEnableStatus</a>(
00038     HWND hwndApp)
00039 {
00040     <span class="keywordflow">if</span> ( ! <a class="code" href="../../d6/d9/clwinnls_8c.html#a1">CheckCountry</a>() ) {
00041         SetLastError( ERROR_CALL_NOT_IMPLEMENTED );
00042         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00043     }
00044 
00045     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d0/immcli_8h.html#a72">ImmGetSaveContext</a>(hwndApp, <a class="code" href="../../d8/d0/immstruc_8h.html#a14">IGSC_WINNLSCHECK</a>) != <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a>);
00046 }
00047 
00048 
<a name="l00049"></a><a class="code" href="../../d6/d9/clwinnls_8c.html#a8">00049</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> WINAPI <a class="code" href="../../d6/d9/clwinnls_8c.html#a8">ImmWINNLSGetIMEHotkey</a>(
00050     HWND hwndIme)
00051 {
00052     UNREFERENCED_PARAMETER(hwndIme);
00053 
00054     <span class="comment">//</span>
00055     <span class="comment">// Win95/NT3.51 behavior, i.e. always return 0.</span>
00056     <span class="comment">//</span>
00057     <span class="keywordflow">return</span> 0;
00058 }
00059 
00060 
00061 <span class="comment">/***************************************************************************\</span>
00062 <span class="comment">*</span>
00063 <span class="comment">*         IME APIs</span>
00064 <span class="comment">*</span>
00065 <span class="comment">\***************************************************************************/</span>
00066 
<a name="l00067"></a><a class="code" href="../../d6/d9/clwinnls_8c.html#a9">00067</a> LRESULT WINAPI <a class="code" href="../../d6/d9/clwinnls_8c.html#a9">ImmSendIMEMessageExW</a>(
00068     HWND   hwndApp,
00069     LPARAM lParam)
00070 {
00071     <span class="keywordflow">return</span> <a class="code" href="../../d6/d9/clwinnls_8c.html#a5">SendIMEMessageAll</a>( hwndApp, (HANDLE)lParam, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00072 }
00073 
<a name="l00074"></a><a class="code" href="../../d6/d9/clwinnls_8c.html#a10">00074</a> LRESULT WINAPI <a class="code" href="../../d6/d9/clwinnls_8c.html#a10">ImmSendIMEMessageExA</a>(
00075     HWND   hwndApp,
00076     LPARAM lParam)
00077 {
00078     <span class="keywordflow">return</span> <a class="code" href="../../d6/d9/clwinnls_8c.html#a5">SendIMEMessageAll</a>( hwndApp, (HANDLE)lParam, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00079 }
00080 
<a name="l00081"></a><a class="code" href="../../d6/d9/clwinnls_8c.html#a5">00081</a> LRESULT <a class="code" href="../../d6/d9/clwinnls_8c.html#a5">SendIMEMessageAll</a>(
00082     HWND hwndApp,
00083     HANDLE hMemImeStruct,
00084     BOOL fAnsi )
00085 {
00086     HWND <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>;
00087     LPIMESTRUCT lpIme;
00088     LRESULT lResult;
00089 
00090 <span class="preprocessor">#ifdef LATER</span>
00091 <span class="preprocessor"></span>  <span class="comment">// Need for MSTEST30a(32bit)...</span>
00092   <span class="comment">// If different process of hWnd in SendIMEMessageEx, then we should be inter-send messag</span>
00093 on <span class="keyword">this</span>.
00094     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>() != pti) {
00095         HWND hDefIMEWnd = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a4">ImmGetDefaultIMEWnd</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>);
00096         <span class="keywordflow">if</span> (hDefIMEWnd)
00097             <span class="keywordflow">return</span> <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(hDefIMEWnd,WM_CONVERTREQUESTEX,(WPARAM)<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>,lParam);
00098     }
00099 <span class="preprocessor">#endif</span>
00100 <span class="preprocessor"></span>
00101     <span class="comment">//</span>
00102     <span class="comment">// the passed handle must be the handle of</span>
00103     <span class="comment">// global memory block.</span>
00104     <span class="comment">//</span>
00105     lpIme = (LPIMESTRUCT)GlobalLock( hMemImeStruct );
00106     <span class="keywordflow">if</span> ( lpIme == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00107         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00108     }
00109 
00110     <span class="keywordflow">if</span> ( ! <a class="code" href="../../d6/d9/clwinnls_8c.html#a1">CheckCountry</a>( ) ) {
00111 
00112         lpIme-&gt;wParam = IME_RS_INVALID;
00113         GlobalUnlock( hMemImeStruct );
00114         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00115     }
00116 
00117     <span class="comment">//</span>
00118     <span class="comment">// We don't need to handle if it's non-IME layout</span>
00119     <span class="comment">//</span>
00120     <span class="keywordflow">if</span> ( ! <a class="code" href="../../d4/d1/layout_8c.html#a20">ImmIsIME</a>( <a class="code" href="../../d3/d8/client_8c.html#a154">GetKeyboardLayout</a>(0) ) ) {
00121 
00122         lpIme-&gt;wParam = IME_RS_INVALID;
00123         GlobalUnlock( hMemImeStruct );
00124         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00125     }
00126 
00127     <span class="comment">//</span>
00128     <span class="comment">// check if the initialize of IMM has been done.</span>
00129     <span class="comment">//</span>
00130     <span class="keywordflow">if</span> ( !<a class="code" href="../../d3/d9/client_2wow_8c.html#a11">IsWindow</a>(<a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a4">ImmGetDefaultIMEWnd</a>(hwndApp)) ) {
00131         <span class="comment">//</span>
00132         <span class="comment">// for Win3.1/Win95 compatibility</span>
00133         <span class="comment">// we need to return TRUE here.</span>
00134         <span class="comment">//</span>
00135         <span class="comment">// PPT4 calls SendImeMessage at the very</span>
00136         <span class="comment">// early stage of initialization. If we</span>
00137         <span class="comment">// return FALSE here, it thinks IME is</span>
00138         <span class="comment">// not available.</span>
00139         <span class="comment">//</span>
00140         <span class="keywordflow">if</span> ( lpIme-&gt;fnc == 0x07 )  <span class="comment">// IME_GETVERSION</span>
00141             <span class="comment">//</span>
00142             <span class="comment">// Excel5.0J calls this function at the early stage</span>
00143             <span class="comment">// and we need to return version number.</span>
00144             <span class="comment">//</span>
00145             lResult = IMEVER_31;
00146         <span class="keywordflow">else</span>
00147             lResult = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00148 
00149         GlobalUnlock( hMemImeStruct );
00150         <span class="keywordflow">return</span> lResult;
00151     }
00152 
00153     <span class="comment">//</span>
00154     <span class="comment">// caller may give us NULL window handle...</span>
00155     <span class="comment">//</span>
00156     <span class="keywordflow">if</span> ( !<a class="code" href="../../d3/d9/client_2wow_8c.html#a11">IsWindow</a>(hwndApp) ) {
00157         <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a> = <a class="code" href="../../d3/d8/winmgrc_8c.html#a11">GetFocus</a>();
00158     } <span class="keywordflow">else</span> {
00159         <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a> = hwndApp;
00160     }
00161 
00162     lResult = <a class="code" href="../../d2/d5/transsub_8c.html#a24">TranslateIMESubFunctions</a>( <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, lpIme, fAnsi );
00163     GlobalUnlock( hMemImeStruct );
00164 
00165     <span class="keywordflow">return</span> lResult;
00166 }
00167 
00168 
00169 <span class="comment">/***************************************************************************\</span>
00170 <span class="comment">*</span>
00171 <span class="comment">*        IMP APIs</span>
00172 <span class="comment">*</span>
00173 <span class="comment">\***************************************************************************/</span>
00174 
00175 
<a name="l00176"></a><a class="code" href="../../d6/d9/clwinnls_8c.html#a11">00176</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d6/d9/clwinnls_8c.html#a11">ImmIMPGetIMEW</a>(
00177     HWND hwndApp,
00178     LPIMEPROW lpImeProW)
00179 {
00180     UNREFERENCED_PARAMETER(hwndApp);
00181 
00182     <span class="keywordflow">if</span> ( ! <a class="code" href="../../d6/d9/clwinnls_8c.html#a1">CheckCountry</a>() ) {
00183         SetLastError( ERROR_CALL_NOT_IMPLEMENTED );
00184         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00185     }
00186     <span class="keywordflow">return</span> <a class="code" href="../../d6/d9/clwinnls_8c.html#a3">IMPGetIMEWorker</a>( <a class="code" href="../../d3/d8/client_8c.html#a154">GetKeyboardLayout</a>(0), lpImeProW );
00187 
00188 }
00189 
<a name="l00190"></a><a class="code" href="../../d6/d9/clwinnls_8c.html#a12">00190</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d6/d9/clwinnls_8c.html#a12">ImmIMPGetIMEA</a>(
00191     HWND hwndApp,
00192     LPIMEPROA lpImeProA)
00193 {
00194     IMEPROW ImeProW;
00195 
00196     UNREFERENCED_PARAMETER(hwndApp);
00197 
00198     <span class="keywordflow">if</span> ( ! <a class="code" href="../../d6/d9/clwinnls_8c.html#a1">CheckCountry</a>() ) {
00199         SetLastError( ERROR_CALL_NOT_IMPLEMENTED );
00200         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00201     }
00202     <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d9/clwinnls_8c.html#a3">IMPGetIMEWorker</a>( <a class="code" href="../../d3/d8/client_8c.html#a154">GetKeyboardLayout</a>(0), &amp;ImeProW ) ) {
00203         <a class="code" href="../../d6/d9/clwinnls_8c.html#a4">ConvertImeProWtoA</a>( lpImeProA, &amp;ImeProW );
00204         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00205     }
00206     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00207 }
00208 
<a name="l00209"></a><a class="code" href="../../d6/d9/clwinnls_8c.html#a4">00209</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d6/d9/clwinnls_8c.html#a4">ConvertImeProWtoA</a>( LPIMEPROA lpImeProA, LPIMEPROW lpImeProW )
00210 {
00211     lpImeProA-&gt;hWnd = lpImeProW-&gt;hWnd;
00212     lpImeProA-&gt;InstDate = lpImeProW-&gt;InstDate;
00213     lpImeProA-&gt;wVersion = lpImeProW-&gt;wVersion;
00214 
00215     WideCharToMultiByte( CP_ACP, 0,
00216                          lpImeProW-&gt;szDescription, -1,
00217                          lpImeProA-&gt;szDescription, <span class="keyword">sizeof</span>(lpImeProA-&gt;szName),
00218                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00219 
00220     WideCharToMultiByte( CP_ACP, 0,
00221                          lpImeProW-&gt;szName, -1,
00222                          lpImeProA-&gt;szName, <span class="keyword">sizeof</span>(lpImeProA-&gt;szName),
00223                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00224 
00225     lpImeProA-&gt;szOptions[0] = <span class="charliteral">'\0'</span>;
00226 }
00227 
<a name="l00228"></a><a class="code" href="../../d6/d9/clwinnls_8c.html#a0">00228</a> DATETIME   <a class="code" href="../../d6/d9/clwinnls_8c.html#a0">CleanDate</a> = {0};
00229 
<a name="l00230"></a><a class="code" href="../../d6/d9/clwinnls_8c.html#a3">00230</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d9/clwinnls_8c.html#a3">IMPGetIMEWorker</a>( HKL hkl, LPIMEPROW lpImeProW )
00231 {
00232     <a class="code" href="../../d0/d8/structtagIMEINFOEX.html">IMEINFOEX</a> iiex;
00233 
00234     <span class="keywordflow">if</span> ( <a class="code" href="../../d9/d0/immuser_8h.html#a47">ImmGetImeInfoEx</a>( &amp;iiex, <a class="code" href="../../d8/d0/immstruc_8h.html#a75a52">ImeInfoExKeyboardLayout</a>, (PVOID)&amp;hkl) ) {
00235 
00236         lpImeProW-&gt;hWnd = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00237         lpImeProW-&gt;InstDate = <a class="code" href="../../d6/d9/clwinnls_8c.html#a0">CleanDate</a>;
00238         lpImeProW-&gt;wVersion = iiex.<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o7">dwImeWinVersion</a>;
00239         lstrcpynW( lpImeProW-&gt;szDescription, iiex.<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o8">wszImeDescription</a>, 50 );
00240         lstrcpynW( lpImeProW-&gt;szName, iiex.<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o9">wszImeFile</a>, 80 );
00241         lstrcpynW( lpImeProW-&gt;szOptions, TEXT(<span class="stringliteral">""</span>), 1 );
00242 
00243         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00244     }
00245 
00246     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00247 }
00248 
00249 
<a name="l00250"></a><a class="code" href="../../d6/d9/clwinnls_8c.html#a13">00250</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d6/d9/clwinnls_8c.html#a13">ImmIMPQueryIMEW</a>(
00251     LPIMEPROW lpImeProW)
00252 {
00253     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fResult = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00254     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> numLayouts = 0;
00255     HKL *phklRoot = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00256     HKL *phkl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00257 
00258     <span class="keywordflow">if</span> ( ! <a class="code" href="../../d6/d9/clwinnls_8c.html#a1">CheckCountry</a>() ) {
00259         SetLastError( ERROR_CALL_NOT_IMPLEMENTED );
00260         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00261     }
00262 
00263     <span class="comment">//</span>
00264     <span class="comment">// get the number of keyboard layouts available</span>
00265     <span class="comment">//</span>
00266     numLayouts = GetKeyboardLayoutList( 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00267     <span class="keywordflow">if</span> ( numLayouts &gt; 0 ) {
00268         <span class="comment">//</span>
00269         <span class="comment">// allocate the buffer for the array of layouts.</span>
00270         <span class="comment">// +1 for a NULL sentinel</span>
00271         <span class="comment">//</span>
00272         phklRoot = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a22">ImmLocalAlloc</a>( 0, (numLayouts+1) * <span class="keyword">sizeof</span>(HKL) );
00273         <span class="keywordflow">if</span> ( phklRoot != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00274             <span class="comment">//</span>
00275             <span class="comment">// get the keyboard layouts</span>
00276             <span class="comment">//</span>
00277             <span class="keywordflow">if</span> ( GetKeyboardLayoutList( numLayouts, phklRoot ) == numLayouts ) {
00278                 <span class="comment">//</span>
00279                 <span class="comment">// put a NULL sentinel at the end of the buffer</span>
00280                 <span class="comment">//</span>
00281                 *(phklRoot+numLayouts) = (HKL)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00282 
00283                 <span class="keywordflow">if</span> ( lpImeProW-&gt;szName[0] == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span> ) {
00284                 <span class="comment">//</span>
00285                 <span class="comment">// This is the first call of IMPQueryIME</span>
00286                 <span class="comment">// We will start at the first layout.</span>
00287                 <span class="comment">//</span>
00288                     phkl = phklRoot;
00289 
00290                 } <span class="keywordflow">else</span> {
00291                 <span class="comment">//</span>
00292                 <span class="comment">// The caller specifies the name of IME.</span>
00293                 <span class="comment">// We will start at the next layout.</span>
00294                 <span class="comment">// Note this assumes that the order of keyboard  layouts</span>
00295                 <span class="comment">// returned by GetKeyboardLayoutList() is not changed</span>
00296                 <span class="comment">// between calls. ( Though actually there is no such</span>
00297                 <span class="comment">// guarantee, we ignore the chance of the changing</span>
00298                 <span class="comment">// the list of keyboard layouts for now. )</span>
00299                 <span class="comment">//</span>
00300                     <a class="code" href="../../d0/d8/structtagIMEINFOEX.html">IMEINFOEX</a> iiex;
00301                     <span class="comment">//</span>
00302                     <span class="comment">// Let's retrieve the corresponding hkl</span>
00303                     <span class="comment">// from the IME filename specified by the caller.</span>
00304                     <span class="comment">//</span>
00305                     <span class="keywordflow">if</span> ( <a class="code" href="../../d9/d0/immuser_8h.html#a47">ImmGetImeInfoEx</a>( &amp;iiex,
00306                                          <a class="code" href="../../d8/d0/immstruc_8h.html#a75a54">ImeInfoExImeFileName</a>,
00307                                          (PVOID)lpImeProW-&gt;szName ) ) {
00308                         <span class="comment">//</span>
00309                         <span class="comment">// let phkl point to the next hkl</span>
00310                         <span class="comment">//</span>
00311                         phkl = phklRoot;
00312                         <span class="keywordflow">while</span> ( *phkl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00313                             <span class="keywordflow">if</span> ( *phkl++ == iiex.<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o0">hkl</a> ) {
00314                                 <span class="keywordflow">break</span>;
00315                             }
00316                         }
00317                     }
00318                 }
00319                 <span class="keywordflow">if</span> ( phkl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00320                     <span class="keywordflow">while</span> ( *phkl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00321                         <span class="comment">//</span>
00322                         <span class="comment">// IMPGetIMEWorker will return FALSE if</span>
00323                         <span class="comment">// the hkl specified is a non-IME layout.</span>
00324                         <span class="comment">//</span>
00325                         <span class="keywordflow">if</span> ( fResult = <a class="code" href="../../d6/d9/clwinnls_8c.html#a3">IMPGetIMEWorker</a>(*phkl++, lpImeProW) ) {
00326                             <span class="keywordflow">break</span>;
00327                         }
00328                     }
00329                 }
00330             }
00331             <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>( phklRoot );
00332         }
00333     }
00334     <span class="keywordflow">return</span> fResult;
00335 }
00336 
<a name="l00337"></a><a class="code" href="../../d6/d9/clwinnls_8c.html#a14">00337</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d6/d9/clwinnls_8c.html#a14">ImmIMPQueryIMEA</a>(
00338     LPIMEPROA lpImeProA)
00339 {
00340 
00341     IMEPROW    ImeProW;
00342 
00343     <span class="keywordflow">if</span> ( ! <a class="code" href="../../d6/d9/clwinnls_8c.html#a1">CheckCountry</a>() ) {
00344         SetLastError( ERROR_CALL_NOT_IMPLEMENTED );
00345         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00346     }
00347 
00348     <span class="keywordflow">if</span> ( lpImeProA-&gt;szName[0] != <span class="charliteral">'\0'</span> ) {
00349     <span class="comment">//</span>
00350     <span class="comment">// Convert MultiByteString(szName) to UnicodeString</span>
00351     <span class="comment">//</span>
00352         <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> i;
00353 
00354         i = MultiByteToWideChar( CP_ACP, (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)MB_PRECOMPOSED,
00355                                  lpImeProA-&gt;szName,
00356                                  -1,
00357                                  ImeProW.szName,
00358                                  (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)<span class="keyword">sizeof</span>(ImeProW.szName)/<span class="keyword">sizeof</span>(WCHAR));
00359         <span class="keywordflow">if</span> ( i == 0 ) {
00360             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00361         }
00362 
00363     } <span class="keywordflow">else</span> {
00364         ImeProW.szName[0] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00365     }
00366 
00367     <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d9/clwinnls_8c.html#a13">ImmIMPQueryIMEW</a>( &amp;ImeProW ) ) {
00368         <a class="code" href="../../d6/d9/clwinnls_8c.html#a4">ConvertImeProWtoA</a>( lpImeProA, &amp;ImeProW );
00369         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00370     }
00371     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00372 }
00373 
<a name="l00374"></a><a class="code" href="../../d6/d9/clwinnls_8c.html#a15">00374</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d6/d9/clwinnls_8c.html#a15">ImmIMPSetIMEW</a>(
00375     HWND hwndApp,
00376     LPIMEPROW lpImeProW)
00377 {
00378     <a class="code" href="../../d0/d8/structtagIMEINFOEX.html">IMEINFOEX</a> iiex;
00379     HKL hkl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00380 
00381     UNREFERENCED_PARAMETER(hwndApp);
00382 
00383     <span class="keywordflow">if</span> ( ! <a class="code" href="../../d6/d9/clwinnls_8c.html#a1">CheckCountry</a>() ) {
00384         SetLastError( ERROR_CALL_NOT_IMPLEMENTED );
00385         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00386     }
00387 
00388     <span class="keywordflow">if</span> ( lpImeProW-&gt;szName[0] != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span> ) {
00389     <span class="comment">//</span>
00390     <span class="comment">// IME name is specified. Switch to the IME specified.</span>
00391     <span class="comment">//</span>
00392         <span class="keywordflow">if</span> ( <a class="code" href="../../d9/d0/immuser_8h.html#a47">ImmGetImeInfoEx</a>(&amp;iiex,<a class="code" href="../../d8/d0/immstruc_8h.html#a75a54">ImeInfoExImeFileName</a>,(PVOID)lpImeProW-&gt;szName) ) {
00393             hkl = iiex.<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o0">hkl</a>;
00394         }
00395     } <span class="keywordflow">else</span> {
00396     <span class="comment">//</span>
00397     <span class="comment">// IME name is not specified. Switch to a non-IME layout</span>
00398     <span class="comment">//</span>
00399         <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> numLayouts;
00400         HKL   *phkl;
00401         HKL   *phklRoot;
00402 
00403         numLayouts = GetKeyboardLayoutList( 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00404         <span class="keywordflow">if</span> ( numLayouts &gt; 0 ) {
00405             phkl = phklRoot = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a22">ImmLocalAlloc</a>( 0, (numLayouts + 1) * <span class="keyword">sizeof</span>(HKL) );
00406             <span class="keywordflow">if</span> ( phkl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00407                 <span class="keywordflow">if</span> ( GetKeyboardLayoutList( numLayouts, phkl ) == numLayouts ) {
00408                     *(phklRoot+numLayouts) = (HKL)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00409                     <span class="keywordflow">while</span> ( *phkl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00410                         <span class="keywordflow">if</span> ( ! <a class="code" href="../../d4/d1/layout_8c.html#a20">ImmIsIME</a>( *phkl ) ) {
00411                             hkl = *phkl;
00412                             <span class="keywordflow">break</span>;
00413                         }
00414                         phkl++;
00415                     }
00416                     <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>( phklRoot );
00417                 }
00418             }
00419         }
00420     }
00421 
00422     <span class="keywordflow">if</span> ( hkl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; <a class="code" href="../../d3/d8/client_8c.html#a154">GetKeyboardLayout</a>(0) != hkl ) {
00423         HWND hwndFocus;
00424 
00425         hwndFocus = <a class="code" href="../../d3/d8/winmgrc_8c.html#a11">GetFocus</a>();
00426         <span class="keywordflow">if</span> ( hwndFocus != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00427             <a class="code" href="../../d0/d8/ntcftxt_8h.html#a20">PostMessage</a>( hwndFocus,
00428                          WM_INPUTLANGCHANGEREQUEST,
00429                          DEFAULT_CHARSET,
00430                          (LPARAM)hkl);
00431             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00432         }
00433     }
00434     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00435 }
00436 
<a name="l00437"></a><a class="code" href="../../d6/d9/clwinnls_8c.html#a16">00437</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d6/d9/clwinnls_8c.html#a16">ImmIMPSetIMEA</a>(
00438     HWND hwndApp,
00439     LPIMEPROA lpImeProA)
00440 {
00441     IMEPROW ImeProW;
00442 
00443     UNREFERENCED_PARAMETER(hwndApp);
00444 
00445     <span class="keywordflow">if</span> ( ! <a class="code" href="../../d6/d9/clwinnls_8c.html#a1">CheckCountry</a>() ) {
00446         SetLastError( ERROR_CALL_NOT_IMPLEMENTED );
00447         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00448     }
00449 
00450     <span class="keywordflow">if</span> ( lpImeProA-&gt;szName[0] != <span class="charliteral">'\0'</span> ) {
00451     <span class="comment">//</span>
00452     <span class="comment">// Convert MultiByteString(szName) to UnicodeString</span>
00453     <span class="comment">//</span>
00454         <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> i;
00455 
00456         i = MultiByteToWideChar( CP_ACP, (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)MB_PRECOMPOSED,
00457                                  lpImeProA-&gt;szName,
00458                                  -1,
00459                                  ImeProW.szName,
00460                                  (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)<span class="keyword">sizeof</span>(ImeProW.szName)/<span class="keyword">sizeof</span>(WCHAR));
00461         <span class="keywordflow">if</span> ( i == 0 ) {
00462             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00463         }
00464 
00465     } <span class="keywordflow">else</span> {
00466         ImeProW.szName[0] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00467     }
00468     <span class="keywordflow">return</span> <a class="code" href="../../d6/d9/clwinnls_8c.html#a15">ImmIMPSetIMEW</a>(hwndApp, &amp;ImeProW);
00469 }
00470 
00471 <span class="comment">//</span>
00472 <span class="comment">// if the "enable/disable" state of the default input context</span>
00473 <span class="comment">// of the caller thread is same as the state specified by</span>
00474 <span class="comment">// fEnalble parameter, this function does nothing but returns</span>
00475 <span class="comment">// the current "enable/disable" state.</span>
00476 <span class="comment">//</span>
00477 <span class="comment">// if fEnable is FALSE, this function disables the default</span>
00478 <span class="comment">// input context of caller thread.</span>
00479 <span class="comment">//</span>
00480 <span class="comment">// if fEnable is TRUE, this function enables the default</span>
00481 <span class="comment">// input context of caller thread.</span>
00482 <span class="comment">//</span>
00483 <span class="comment">//</span>
<a name="l00484"></a><a class="code" href="../../d6/d9/clwinnls_8c.html#a2">00484</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d9/clwinnls_8c.html#a2">ImmEnableIME</a>(
00485     HWND hwnd,
00486     BOOL fEnable
00487     )
00488 {
00489     HIMC hImc;
00490     <a class="code" href="../../d3/d0/structtagCLIENTIMC.html">PCLIENTIMC</a> pClientImc;
00491     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fCurrentState;
00492     HWND hwndFocus;
00493     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fImeInitialized;
00494 
00495     <span class="comment">//</span>
00496     <span class="comment">// Get the caller thread's default input context</span>
00497     <span class="comment">//</span>
00498     hImc = (HIMC)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a287">NtUserGetThreadState</a>(UserThreadStateDefaultInputContext);
00499     <span class="keywordflow">if</span> ( hImc == <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a> ) {
00500         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00501     }
00502     pClientImc = <a class="code" href="../../d9/d0/immuser_8h.html#a43">ImmLockClientImc</a>( hImc );
00503     <span class="keywordflow">if</span> ( pClientImc == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00504         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00505     }
00506 
00507     <span class="comment">//</span>
00508     <span class="comment">// we will return the curren t"enable/disable" state of the input context</span>
00509     <span class="comment">//</span>
00510     fCurrentState =  <a class="code" href="../../d4/d0/immcli_8h.html#a21">TestICF</a>(pClientImc, <a class="code" href="../../d8/d0/immstruc_8h.html#a11">IMCF_WINNLSDISABLE</a>) ? <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00511 
00512     <span class="comment">//</span>
00513     <span class="comment">// if the current thread (caller thread) doesn't have the focus window,</span>
00514     <span class="comment">// UI windows will not be updated. When we're called later, we will end</span>
00515     <span class="comment">// up to just return the fCurrentState without calling ImmSetActiveContext.</span>
00516     <span class="comment">// To avoid that, the "same status" check below is disabled...</span>
00517 
00518     <span class="keywordflow">if</span> ( (fCurrentState &amp;&amp; fEnable) || (!fCurrentState &amp;&amp; !fEnable) ) {
00519        <a class="code" href="../../d9/d0/immuser_8h.html#a44">ImmUnlockClientImc</a>( pClientImc );
00520         <span class="comment">//</span>
00521         <span class="comment">// nothing has been changed. return the current state</span>
00522         <span class="comment">//</span>
00523         <span class="keywordflow">return</span> fCurrentState;
00524     }
00525 
00526 
00527     <span class="keywordflow">if</span> ( ! <a class="code" href="../../d3/d9/client_2wow_8c.html#a11">IsWindow</a>(hwnd) ) {
00528         hwndFocus = <a class="code" href="../../d3/d8/winmgrc_8c.html#a11">GetFocus</a>();
00529     } <span class="keywordflow">else</span> {
00530         hwndFocus = hwnd;
00531     }
00532 
00533     <span class="comment">//</span>
00534     <span class="comment">// check if the initialize of IMM has been done.</span>
00535     <span class="comment">//</span>
00536     <span class="keywordflow">if</span> ( <a class="code" href="../../d3/d9/client_2wow_8c.html#a11">IsWindow</a>(<a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a4">ImmGetDefaultIMEWnd</a>(hwndFocus)) ) {
00537         fImeInitialized = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00538     } <span class="keywordflow">else</span> {
00539         fImeInitialized = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00540     }
00541 
00542     <span class="keywordflow">if</span> ( fImeInitialized ) {
00543         <span class="keywordflow">if</span> ( ! fEnable ) {
00544         <span class="comment">//</span>
00545         <span class="comment">// we're going to disable the target IMC</span>
00546         <span class="comment">//</span>
00547             <span class="comment">//</span>
00548             <span class="comment">// make the target IMC non-active</span>
00549             <span class="comment">//</span>
00550             <a class="code" href="../../d9/d0/immuser_8h.html#a36">ImmSetActiveContext</a>( hwndFocus, hImc, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00551 
00552         } <span class="keywordflow">else</span> {
00553         <span class="comment">//</span>
00554         <span class="comment">// we're going to enable the target IMC</span>
00555         <span class="comment">//</span>
00556             <span class="comment">//</span>
00557             <span class="comment">// make NULL context non-active</span>
00558             <span class="comment">//</span>
00559             <a class="code" href="../../d9/d0/immuser_8h.html#a36">ImmSetActiveContext</a>( hwndFocus, <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00560         }
00561     }
00562 
00563     <span class="comment">//</span>
00564     <span class="comment">// update the state of the input context</span>
00565     <span class="comment">//</span>
00566     <span class="keywordflow">if</span> ( fEnable )
00567         <a class="code" href="../../d4/d0/immcli_8h.html#a20">ClrICF</a>( pClientImc, <a class="code" href="../../d8/d0/immstruc_8h.html#a11">IMCF_WINNLSDISABLE</a> );
00568     <span class="keywordflow">else</span>
00569         <a class="code" href="../../d4/d0/immcli_8h.html#a19">SetICF</a>( pClientImc, <a class="code" href="../../d8/d0/immstruc_8h.html#a11">IMCF_WINNLSDISABLE</a> );
00570     <a class="code" href="../../d9/d0/immuser_8h.html#a44">ImmUnlockClientImc</a>( pClientImc );
00571 
00572 
00573     <span class="keywordflow">if</span> ( fImeInitialized ) {
00574         <span class="keywordflow">if</span> ( fEnable ) {
00575         <span class="comment">//</span>
00576         <span class="comment">// we're going to enable the target IMC</span>
00577         <span class="comment">//</span>
00578             <span class="comment">//</span>
00579             <span class="comment">// make the target IMC active</span>
00580             <span class="comment">//</span>
00581             <a class="code" href="../../d9/d0/immuser_8h.html#a36">ImmSetActiveContext</a>( hwndFocus, hImc, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00582         } <span class="keywordflow">else</span> {
00583         <span class="comment">//</span>
00584         <span class="comment">// we're going to disable the target IMC</span>
00585         <span class="comment">//</span>
00586             <span class="comment">//</span>
00587             <span class="comment">// make NULL context active</span>
00588             <span class="comment">//</span>
00589             <a class="code" href="../../d9/d0/immuser_8h.html#a36">ImmSetActiveContext</a>( hwndFocus, <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00590         }
00591     }
00592 
00593     <span class="comment">//</span>
00594     <span class="comment">// the return value is previous state</span>
00595     <span class="comment">//</span>
00596     <span class="keywordflow">return</span> fCurrentState;
00597 }
00598 
<a name="l00599"></a><a class="code" href="../../d6/d9/clwinnls_8c.html#a1">00599</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d9/clwinnls_8c.html#a1">CheckCountry</a>()
00600 {
00601     WORD LangId;
00602 
00603     LangId = PRIMARYLANGID(LANGIDFROMLCID(GetSystemDefaultLCID()));
00604     <span class="keywordflow">if</span> ( LangId == LANG_JAPANESE || LangId == LANG_KOREAN ) {
00605         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00606     }
00607     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00608 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:26 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
